```diff
diff --git a/assets/latest_carrier_id/carrier_list.pb b/assets/latest_carrier_id/carrier_list.pb
index 9b2500a5..344cfcd7 100644
Binary files a/assets/latest_carrier_id/carrier_list.pb and b/assets/latest_carrier_id/carrier_list.pb differ
diff --git a/assets/latest_carrier_id/carrier_list.textpb b/assets/latest_carrier_id/carrier_list.textpb
index b14127b1..7d8ed008 100644
--- a/assets/latest_carrier_id/carrier_list.textpb
+++ b/assets/latest_carrier_id/carrier_list.textpb
@@ -437,7 +437,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -493,7 +493,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -8585,7 +8585,7 @@ carrier_id {
   carrier_name: "United Wireless"
   carrier_attribute {
     mccmnc_tuple: "311650"
-    spn: "unitedwireless"
+    spn: "United Wireless"
   }
 }
 carrier_id {
@@ -10966,7 +10966,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -12213,6 +12212,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -12620,4 +12626,4 @@ carrier_id {
   }
   parent_canonical_id: 1779
 }
-version: 134217768
+version: 134217769
diff --git a/assets/sdk28_carrier_id/carrier_list.pb b/assets/sdk28_carrier_id/carrier_list.pb
index 4b526f19..c5ee573f 100644
Binary files a/assets/sdk28_carrier_id/carrier_list.pb and b/assets/sdk28_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk28_carrier_id/carrier_list.textpb b/assets/sdk28_carrier_id/carrier_list.textpb
index 326a3efa..7e18290d 100644
--- a/assets/sdk28_carrier_id/carrier_list.textpb
+++ b/assets/sdk28_carrier_id/carrier_list.textpb
@@ -756,7 +756,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -812,7 +812,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11948,7 +11948,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -13379,6 +13378,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -13621,4 +13627,4 @@ carrier_id {
   }
   parent_canonical_id: 2023
 }
-version: 48
+version: 49
diff --git a/assets/sdk29_carrier_id/carrier_list.pb b/assets/sdk29_carrier_id/carrier_list.pb
index 521b0eef..0df750ff 100644
Binary files a/assets/sdk29_carrier_id/carrier_list.pb and b/assets/sdk29_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk29_carrier_id/carrier_list.textpb b/assets/sdk29_carrier_id/carrier_list.textpb
index 9173b00b..9dad2821 100644
--- a/assets/sdk29_carrier_id/carrier_list.textpb
+++ b/assets/sdk29_carrier_id/carrier_list.textpb
@@ -744,7 +744,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -800,7 +800,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11764,7 +11764,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -13285,6 +13284,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -13526,4 +13532,4 @@ carrier_id {
   }
   parent_canonical_id: 2023
 }
-version: 16777272
+version: 16777273
diff --git a/assets/sdk30_carrier_id/carrier_list.pb b/assets/sdk30_carrier_id/carrier_list.pb
index 512dff2f..0207cd93 100644
Binary files a/assets/sdk30_carrier_id/carrier_list.pb and b/assets/sdk30_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk30_carrier_id/carrier_list.textpb b/assets/sdk30_carrier_id/carrier_list.textpb
index 2a84e88c..e8ab920a 100644
--- a/assets/sdk30_carrier_id/carrier_list.textpb
+++ b/assets/sdk30_carrier_id/carrier_list.textpb
@@ -744,7 +744,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -800,7 +800,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11742,7 +11742,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -13267,6 +13266,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -13528,4 +13534,4 @@ carrier_id {
   }
   parent_canonical_id: 2023
 }
-version: 33554506
+version: 33554507
diff --git a/assets/sdk31_carrier_id/carrier_list.pb b/assets/sdk31_carrier_id/carrier_list.pb
index f4220a59..e8587e4f 100644
Binary files a/assets/sdk31_carrier_id/carrier_list.pb and b/assets/sdk31_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk31_carrier_id/carrier_list.textpb b/assets/sdk31_carrier_id/carrier_list.textpb
index 71fdab6d..5d69a904 100644
--- a/assets/sdk31_carrier_id/carrier_list.textpb
+++ b/assets/sdk31_carrier_id/carrier_list.textpb
@@ -514,7 +514,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -570,7 +570,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11426,7 +11426,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -12994,6 +12993,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -13295,4 +13301,4 @@ carrier_id {
   }
   parent_canonical_id: 1894
 }
-version: 50331698
+version: 50331699
diff --git a/assets/sdk33_carrier_id/carrier_list.pb b/assets/sdk33_carrier_id/carrier_list.pb
index a223e2f4..c0ef6c8a 100644
Binary files a/assets/sdk33_carrier_id/carrier_list.pb and b/assets/sdk33_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk33_carrier_id/carrier_list.textpb b/assets/sdk33_carrier_id/carrier_list.textpb
index 1ea05b9c..349055a2 100644
--- a/assets/sdk33_carrier_id/carrier_list.textpb
+++ b/assets/sdk33_carrier_id/carrier_list.textpb
@@ -458,7 +458,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -514,7 +514,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11147,7 +11147,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -12742,6 +12741,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -13118,4 +13124,4 @@ carrier_id {
   }
   parent_canonical_id: 2560
 }
-version: 100663336
+version: 100663337
diff --git a/assets/sdk34_carrier_id/carrier_list.pb b/assets/sdk34_carrier_id/carrier_list.pb
index 8fd4240a..31eeb48f 100644
Binary files a/assets/sdk34_carrier_id/carrier_list.pb and b/assets/sdk34_carrier_id/carrier_list.pb differ
diff --git a/assets/sdk34_carrier_id/carrier_list.textpb b/assets/sdk34_carrier_id/carrier_list.textpb
index 292aeedb..b1c9637b 100644
--- a/assets/sdk34_carrier_id/carrier_list.textpb
+++ b/assets/sdk34_carrier_id/carrier_list.textpb
@@ -436,7 +436,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 451
-  carrier_name: "Etisalat"
+  carrier_name: "e& UAE"
   carrier_attribute {
     mccmnc_tuple: "42402"
   }
@@ -492,7 +492,7 @@ carrier_id {
 }
 carrier_id {
   canonical_id: 492
-  carrier_name: "Localstar Holding Pty. Ltd."
+  carrier_name: "Pivotel"
   carrier_attribute {
     mccmnc_tuple: "50588"
   }
@@ -11005,7 +11005,6 @@ carrier_id {
   carrier_name: "OptimERA Wireless"
   carrier_attribute {
     mccmnc_tuple: "313380"
-    spn: "OptimERA"
   }
 }
 carrier_id {
@@ -12266,6 +12265,13 @@ carrier_id {
     spn: "Field Mobile"
   }
 }
+carrier_id {
+  canonical_id: 2648
+  carrier_name: "Phoenix"
+  carrier_attribute {
+    mccmnc_tuple: "25097"
+  }
+}
 carrier_id {
   canonical_id: 10000
   carrier_name: "Tracfone-ATT"
@@ -12673,4 +12679,4 @@ carrier_id {
   }
   parent_canonical_id: 1779
 }
-version: 117440552
+version: 117440553
diff --git a/src/com/android/providers/telephony/TelephonyProvider.java b/src/com/android/providers/telephony/TelephonyProvider.java
index b350ba10..9e1c189d 100644
--- a/src/com/android/providers/telephony/TelephonyProvider.java
+++ b/src/com/android/providers/telephony/TelephonyProvider.java
@@ -377,10 +377,15 @@ public class TelephonyProvider extends ContentProvider
      */
     private static final int  RIL_RADIO_TECHNOLOGY_NR = 20;
 
+    /**
+     * 3GPP NB-IOT (Narrowband Internet of Things) over Non-Terrestrial-Networks technology.
+     */
+    private static final int RIL_RADIO_TECHNOLOGY_NB_IOT_NTN = 21;
+
     /**
      * The number of the radio technologies.
      */
-    private static final int NEXT_RIL_RADIO_TECHNOLOGY = 21;
+    private static final int NEXT_RIL_RADIO_TECHNOLOGY = 22;
 
     private static final Map<String, Integer> MVNO_TYPE_STRING_MAP;
 
@@ -734,6 +739,12 @@ public class TelephonyProvider extends ContentProvider
             return DATABASE_VERSION;
         }
         XmlResourceParser parser = r.getXml(com.android.internal.R.xml.apns);
+
+        if (parser == null) {
+            loge("Null parser");
+            return DATABASE_VERSION;
+        }
+
         try {
             XmlUtils.beginDocument(parser, "apns");
             int publicversion = Integer.parseInt(parser.getAttributeValue(null, "version"));
@@ -1019,6 +1030,24 @@ public class TelephonyProvider extends ContentProvider
             }
         }
 
+        @Override
+        public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {
+            String msg = "dbh.onDowngrade: TelephonyProvider database downgraded from version "
+                    + oldVersion + " to " + newVersion + ". Some user settings might be lost!";
+            loge(msg);
+            mLocalLog.log(msg);
+
+            try {
+                // Delete the database entirely so it can be rebuilt from scratch.
+                db.execSQL("DROP TABLE IF EXISTS " + CARRIERS_TABLE);
+                db.execSQL("DROP TABLE IF EXISTS " + SIMINFO_TABLE);
+                onCreate(db);
+            } catch (SQLiteException e) {
+                loge("Failed to recreate the table " + CARRIERS_TABLE + " and " + SIMINFO_TABLE
+                        + ". e=" + e);
+            }
+        }
+
         @Override
         public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
             if (DBG) {
@@ -5917,6 +5946,8 @@ public class TelephonyProvider extends ContentProvider
                 return (int) TelephonyManager.NETWORK_TYPE_BITMASK_LTE_CA;
             case RIL_RADIO_TECHNOLOGY_NR:
                 return (int) TelephonyManager.NETWORK_TYPE_BITMASK_NR;
+            case RIL_RADIO_TECHNOLOGY_NB_IOT_NTN:
+                return (int) TelephonyManager.NETWORK_TYPE_BITMASK_NB_IOT_NTN;
             default:
                 return (int) TelephonyManager.NETWORK_TYPE_BITMASK_UNKNOWN;
         }
diff --git a/tests/src/com/android/providers/telephony/SmsProviderTest.java b/tests/src/com/android/providers/telephony/SmsProviderTest.java
index 3381400b..ea1ea6d9 100644
--- a/tests/src/com/android/providers/telephony/SmsProviderTest.java
+++ b/tests/src/com/android/providers/telephony/SmsProviderTest.java
@@ -44,10 +44,13 @@ import android.util.Log;
 import androidx.test.core.app.ApplicationProvider;
 import androidx.test.filters.SmallTest;
 
+import com.android.internal.telephony.ISms;
+
 import junit.framework.TestCase;
 
 import org.junit.Test;
 import org.mockito.Mock;
+import org.mockito.Mockito;
 import org.mockito.MockitoAnnotations;
 
 import java.util.ArrayList;
@@ -77,6 +80,8 @@ public class SmsProviderTest extends TestCase {
 
     private int notifyChangeCount;
 
+    private final UserHandle mMyUserHandle = UserHandle.of(UserHandle.myUserId());
+
     private final String mFakePdu = "123abc";
     private final String mFakeAddress = "FakeAddress";
     private final String mFakeOriginatingAddr = "FakeDisplayAddress";
@@ -98,6 +103,7 @@ public class SmsProviderTest extends TestCase {
         MockitoAnnotations.initMocks(this);
         mSmsProviderTestable = new SmsProviderTestable();
         mContext = spy(ApplicationProvider.getApplicationContext());
+        TelephonyManager.setupISmsForTest(Mockito.mock(ISms.class));
 
         when(mContext.getSystemService(eq(Context.APP_OPS_SERVICE)))
                 .thenReturn(mock(AppOpsManager.class));
@@ -144,19 +150,20 @@ public class SmsProviderTest extends TestCase {
         Log.d(TAG, "MockContextWithProvider: Add SmsProvider to mResolver");
         notifyChangeCount = 0;
 
+        int subid = SmsManager.getDefaultSmsSubscriptionId();
+
         when(mContext.getSystemService(SubscriptionManager.class)).thenReturn(mSubscriptionManager);
         List<SubscriptionInfo> subscriptionInfoList = new ArrayList<>();
         SubscriptionInfo subscriptionInfo1 = new SubscriptionInfo.Builder()
-                .setId(SmsManager.getDefaultSmsSubscriptionId())
+                .setId(subid)
                 .setSimSlotIndex(0)
                 .build();
         subscriptionInfoList.add(subscriptionInfo1);
         // Return subscriptions associated with SYSTEM user.
         doReturn(subscriptionInfoList).when(mSubscriptionManager)
-                .getSubscriptionInfoListAssociatedWithUser(UserHandle.SYSTEM);
-        doReturn(true).when(mSubscriptionManager).isSubscriptionAssociatedWithUser(
-                SubscriptionManager.getDefaultSmsSubscriptionId(),
-                UserHandle.of(UserHandle.USER_SYSTEM));
+                .getSubscriptionInfoListAssociatedWithUser(mMyUserHandle);
+        doReturn(true).when(mSubscriptionManager).isSubscriptionAssociatedWithUser(subid,
+                mMyUserHandle);
     }
 
     @Override
diff --git a/tests/src/com/android/providers/telephony/TelephonyDatabaseHelperTest.java b/tests/src/com/android/providers/telephony/TelephonyDatabaseHelperTest.java
index 6c7f2833..cfc89707 100644
--- a/tests/src/com/android/providers/telephony/TelephonyDatabaseHelperTest.java
+++ b/tests/src/com/android/providers/telephony/TelephonyDatabaseHelperTest.java
@@ -54,7 +54,7 @@ import java.util.List;
  *    runtest --path tests/src/com/android/providers/telephony/TelephonyDatabaseHelperTest.java
  */
 @RunWith(JUnit4.class)
-public final class TelephonyDatabaseHelperTest {
+public final class TelephonyDatabaseHelperTest extends TelephonyTestBase {
 
     private final static String TAG = TelephonyDatabaseHelperTest.class.getSimpleName();
 
@@ -812,6 +812,30 @@ public final class TelephonyDatabaseHelperTest {
                 Telephony.SimInfo.COLUMN_IS_SATELLITE_PROVISIONED_FOR_NON_IP_DATAGRAM));
     }
 
+    @Test
+    public void databaseHelperOnDowngrade_dropTable() throws Exception {
+        Log.d(TAG, "databaseHelperOnUpgrade_hasIsSatelliteProvisionedField");
+        replaceInstance(TelephonyProvider.class, "s_apnSourceServiceExists", null, false);
+        // (5 << 16 | 6) is the first upgrade trigger in onUpgrade
+        SQLiteDatabase db = mInMemoryDbHelper.getWritableDatabase();
+        mHelper.onUpgrade(db, (4 << 16), TelephonyProvider.getVersion(mContext));
+
+        final int insertId = 1;
+        final String IdKey = "_id";
+        ContentValues contentValues = new ContentValues();
+        contentValues.put(Carriers.INFRASTRUCTURE_BITMASK, ApnSetting.INFRASTRUCTURE_CELLULAR);
+        contentValues.put(IdKey, insertId);
+        db.insert("carriers", null, contentValues);
+        Cursor cursor = db.query("carriers", null, null, null, null, null, null);
+        assertEquals(1, cursor.getCount());
+        cursor.close();
+
+        int downgradeVersion = TelephonyProvider.getVersion(mContext) - (1 << 16);
+        mHelper.onDowngrade(db, TelephonyProvider.getVersion(mContext), downgradeVersion);
+        cursor = db.query("carriers", null, null, null, null, null, null);
+        assertEquals(0, cursor.getCount());
+    }
+
     /**
      * Helper for an in memory DB used to test the TelephonyProvider#DatabaseHelper.
      *
diff --git a/tests/src/com/android/providers/telephony/TelephonyTestBase.java b/tests/src/com/android/providers/telephony/TelephonyTestBase.java
new file mode 100644
index 00000000..279b9802
--- /dev/null
+++ b/tests/src/com/android/providers/telephony/TelephonyTestBase.java
@@ -0,0 +1,102 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.providers.telephony;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Rule;
+import org.mockito.junit.MockitoJUnit;
+import org.mockito.junit.MockitoRule;
+
+import java.lang.reflect.Field;
+import java.util.HashMap;
+import java.util.Iterator;
+import java.util.LinkedList;
+
+/**
+ * Helper class to load Mockito Resources into a test.
+ */
+public class TelephonyTestBase {
+    @Rule public final MockitoRule mocks = MockitoJUnit.rule();
+
+    private final HashMap<InstanceKey, Object> mOldInstances = new HashMap<>();
+    private final LinkedList<InstanceKey> mInstanceKeys = new LinkedList<>();
+
+    @Before
+    public void setUp() throws Exception {
+    }
+
+    @After
+    public void tearDown() throws Exception {
+        restoreInstances();
+    }
+
+    protected synchronized void replaceInstance(final Class c, final String instanceName,
+            final Object obj, final Object newValue)
+            throws Exception {
+        Field field = c.getDeclaredField(instanceName);
+        field.setAccessible(true);
+
+        InstanceKey key = new InstanceKey(c, instanceName, obj);
+        if (!mOldInstances.containsKey(key)) {
+            mOldInstances.put(key, field.get(obj));
+            mInstanceKeys.add(key);
+        }
+        field.set(obj, newValue);
+    }
+
+    private synchronized void restoreInstances() throws Exception {
+        Iterator<InstanceKey> it = mInstanceKeys.descendingIterator();
+
+        while (it.hasNext()) {
+            InstanceKey key = it.next();
+            Field field = key.mClass.getDeclaredField(key.mInstName);
+            field.setAccessible(true);
+            field.set(key.mObj, mOldInstances.get(key));
+        }
+
+        mInstanceKeys.clear();
+        mOldInstances.clear();
+    }
+
+    private static class InstanceKey {
+        public final Class mClass;
+        public final String mInstName;
+        public final Object mObj;
+        InstanceKey(final Class c, final String instName, final Object obj) {
+            mClass = c;
+            mInstName = instName;
+            mObj = obj;
+        }
+
+        @Override
+        public int hashCode() {
+            return (mClass.getName().hashCode() * 31 + mInstName.hashCode()) * 31;
+        }
+
+        @Override
+        public boolean equals(Object obj) {
+            if (obj == null || obj.getClass() != getClass()) {
+                return false;
+            }
+
+            InstanceKey other = (InstanceKey) obj;
+            return (other.mClass == mClass && other.mInstName.equals(mInstName)
+                    && other.mObj == mObj);
+        }
+    }
+}
```

