```diff
diff --git a/Android.bp b/Android.bp
index 7cf38a3..4219f0b 100644
--- a/Android.bp
+++ b/Android.bp
@@ -1,76 +1,20 @@
 // This file is generated by cargo_embargo.
-// Do not modify this file after the first "rust_*" or "genrule" module
-// because the changes will be overridden on upgrade.
-// Content before the first "rust_*" or "genrule" module is preserved.
-
-// WARNING! This crate has a change in dependency structure that is not yet
-// reflected on crates.io. This means that the automated update tool will
-// not be able to handle the next update, and it will need to be performed
-// manually - openssl-error and openssl-macros will need to be imported,
-// and the applied patch will need to be rebased one directory down to apply
-// to only the openssl crate if it is not yet upstreamed at that point.
-//
-// Even if upstreamed, cargo2android.py will likely never run correctly on
-// this package without modification because boringssl does not intend to
-// publish "bssl-sys" on crates.io, since it needs to match the exact local
-// version of boringssl.
+// Do not modify this file because the changes will be overridden on upgrade.
 
 package {
     default_applicable_licenses: ["external_rust_crates_openssl_license"],
+    default_team: "trendy_team_android_rust",
 }
 
-// Added automatically by a large-scale-change that took the approach of
-// 'apply every license found to every target'. While this makes sure we respect
-// every license restriction, it may not be entirely correct.
-//
-// e.g. GPL in an MIT project might only apply to the contrib/ directory.
-//
-// Please consider splitting the single license below into multiple licenses,
-// taking care not to lose any license_kind information, and overriding the
-// default license using the 'licenses: [...]' property on targets as needed.
-//
-// For unused files, consider creating a 'fileGroup' with "//visibility:private"
-// to attach the license to, and including a comment whether the files may be
-// used in the current project.
-// See: http://go/android-license-faq
 license {
     name: "external_rust_crates_openssl_license",
     visibility: [":__subpackages__"],
-    license_kinds: [
-        "SPDX-license-identifier-Apache-2.0",
-        "SPDX-license-identifier-BSD",
-        "SPDX-license-identifier-MIT",
-        "SPDX-license-identifier-OpenSSL",
-    ],
-    license_text: [
-        "LICENSE",
-    ],
+    license_kinds: ["SPDX-license-identifier-Apache-2.0"],
+    license_text: ["LICENSE"],
 }
 
 rust_library {
     name: "libopenssl",
-    visibility: [
-        ":__subpackages__",
-        "//packages/modules/Virtualization/android/virtualizationservice",
-        "//packages/modules/Virtualization/guest/authfs",
-        "//packages/modules/Virtualization/guest/authfs/src/fsverity/metadata",
-        "//packages/modules/Virtualization/guest/microdroid_manager",
-        "//packages/modules/Virtualization/guest/pvmfw/avb",
-        "//packages/modules/Virtualization/libs/apkverify",
-        "//packages/modules/Virtualization/libs/dice/driver",
-        "//packages/modules/Virtualization/libs/libclient_vm_csr",
-        "//packages/modules/Virtualization/libs/libvm_payload",
-        "//packages/modules/Virtualization/tests/authfs",
-        "//system/authgraph/boringssl",
-        "//system/keymint/boringssl",
-        "//system/security/keystore2/tests",
-        "//system/software_defined_vehicle/core_services/service_authn",
-        "//system/software_defined_vehicle/core_services/service_discovery/sdv_sd_agent",
-        "//system/software_defined_vehicle/core_services/vsidl/middleware/rpc/transport/grpc",
-        "//tools/netsim",
-        "//tools/security/remote_provisioning/hwtrust",
-        "//vendor:__subpackages__",
-    ],
     host_supported: true,
     crate_name: "openssl",
     cargo_env_compat: true,
@@ -91,10 +35,39 @@ rust_library {
     aliases: ["openssl_sys:ffi"],
     apex_available: [
         "//apex_available:platform",
+        "com.android.configinfrastructure",
         "com.android.virt",
     ],
     product_available: true,
     vendor_available: true,
+    min_sdk_version: "29",
+    visibility: [
+        ":__subpackages__",
+        "//external/rust/android-crates-io/crates/tokio-openssl",
+        "//packages/modules/ConfigInfrastructure/aconfigd",
+        "//packages/modules/Virtualization/android/virtualizationservice",
+        "//packages/modules/Virtualization/guest/authfs",
+        "//packages/modules/Virtualization/guest/authfs/src/fsverity/metadata",
+        "//packages/modules/Virtualization/guest/microdroid_manager",
+        "//packages/modules/Virtualization/guest/pvmfw/avb",
+        "//packages/modules/Virtualization/libs/apkverify",
+        "//packages/modules/Virtualization/libs/dice/driver",
+        "//packages/modules/Virtualization/libs/libclient_vm_csr",
+        "//packages/modules/Virtualization/libs/libvm_payload",
+        "//packages/modules/Virtualization/tests/authfs",
+        "//system/authgraph/boringssl",
+        "//system/keymint/boringssl",
+        "//system/security/keystore2/tests",
+        "//system/software_defined_vehicle/core_services/crypto_rpc",
+        "//system/software_defined_vehicle/core_services/sdv_comms/sdk",
+        "//system/software_defined_vehicle/core_services/service_authn",
+        "//system/software_defined_vehicle/core_services/service_discovery/sdv_sd_agent",
+        "//system/software_defined_vehicle/core_services/service_discovery/vvmtruststore",
+        "//system/software_defined_vehicle/core_services/vsidl/middleware/rpc/transport/grpc",
+        "//tools/netsim",
+        "//tools/security/remote_provisioning/hwtrust",
+        "//vendor:__subpackages__",
+    ],
 }
 
 rust_library_host_rlib {
@@ -119,3 +92,9 @@ rust_library_host_rlib {
     proc_macros: ["libopenssl_macros"],
     aliases: ["openssl_sys:ffi"],
 }
+
+dirgroup {
+    name: "trusty_dirgroup_external_rust_crates_openssl",
+    visibility: ["//trusty/vendor/google/aosp/scripts"],
+    dirs: ["."],
+}
diff --git a/cargo_embargo.json b/cargo_embargo.json
index 0505b35..f34c11b 100644
--- a/cargo_embargo.json
+++ b/cargo_embargo.json
@@ -1,8 +1,10 @@
 {
   "apex_available": [
     "//apex_available:platform",
+    "com.android.configinfrastructure",
     "com.android.virt"
   ],
+  "min_sdk_version": "29",
   "extra_cfg": ["boringssl"],
   "features": [
     "unstable_boringssl"
@@ -16,27 +18,37 @@
   "module_visibility": {
     "libopenssl": [
         ":__subpackages__",
+        "//external/rust/crates/tokio-openssl",
+        "//packages/modules/ConfigInfrastructure/aconfigd",
+        "//packages/modules/Virtualization/android/virtualizationservice",
+        "//packages/modules/Virtualization/guest/authfs",
+        "//packages/modules/Virtualization/guest/authfs/src/fsverity/metadata",
+        "//packages/modules/Virtualization/guest/microdroid_manager",
+        "//packages/modules/Virtualization/guest/pvmfw/avb",
         "//packages/modules/Virtualization/libs/apkverify",
-        "//packages/modules/Virtualization/authfs",
-        "//packages/modules/Virtualization/service_vm/client_vm_csr",
-        "//packages/modules/Virtualization/virtualizationservice",
-        "//system/security/keystore2/tests",
-        "//system/authgraph/boringssl",
         "//packages/modules/Virtualization/libs/dice/driver",
-        "//packages/modules/Virtualization/authfs/src/fsverity/metadata",
-        "//tools/security/remote_provisioning/hwtrust",
-        "//packages/modules/Virtualization/pvmfw/avb",
-        "//packages/modules/Virtualization/microdroid_manager",
+        "//packages/modules/Virtualization/libs/libclient_vm_csr",
+        "//packages/modules/Virtualization/libs/libvm_payload",
+        "//packages/modules/Virtualization/tests/authfs",
+        "//system/authgraph/boringssl",
         "//system/keymint/boringssl",
-        "//tools/netsim",
-        "//packages/modules/Virtualization/vm_payload",
+        "//system/security/keystore2/tests",
+        "//system/software_defined_vehicle/core_services/crypto_rpc",
+        "//system/software_defined_vehicle/core_services/sdv_comms/sdk",
+        "//system/software_defined_vehicle/core_services/service_authn",
         "//system/software_defined_vehicle/core_services/service_discovery/sdv_sd_agent",
+        "//system/software_defined_vehicle/core_services/service_discovery/vvmtruststore",
         "//system/software_defined_vehicle/core_services/vsidl/middleware/rpc/transport/grpc",
-        "//system/software_defined_vehicle/core_services/service_authn",
+        "//tools/netsim",
+        "//tools/security/remote_provisioning/hwtrust",
         "//vendor:__subpackages__"
     ]
   },
   "variants": [
+    {
+      "generate_androidbp": false,
+      "generate_rulesmk": true
+    },
     {
       "module_name_overrides": {
         "libopenssl_sys": "libbssl_sys"
diff --git a/patches/0008-Enable-set_alpn_select_callback-for-BoringSSL.patch b/patches/0008-Enable-set_alpn_select_callback-for-BoringSSL.patch
new file mode 100644
index 0000000..1cea028
--- /dev/null
+++ b/patches/0008-Enable-set_alpn_select_callback-for-BoringSSL.patch
@@ -0,0 +1,95 @@
+From ef81d97a30ce0277be9eba813131f07f9328e3a6 Mon Sep 17 00:00:00 2001
+From: Viktoriia Kovalova <vkovalova@google.com>
+Date: Wed, 13 Nov 2024 15:42:48 +0000
+Subject: [PATCH] Enable set_alpn_select_callback for BoringSSL
+
+---
+ src/ssl/callbacks.rs |  4 ++--
+ src/ssl/mod.rs       | 21 ++++++++++++++-------
+ 2 files changed, 16 insertions(+), 9 deletions(-)
+
+diff --git a/src/ssl/callbacks.rs b/src/ssl/callbacks.rs
+index ccf53085..f7e51a5d 100644
+--- a/src/ssl/callbacks.rs
++++ b/src/ssl/callbacks.rs
+@@ -19,7 +19,7 @@ use crate::dh::Dh;
+ use crate::ec::EcKey;
+ use crate::error::ErrorStack;
+ use crate::pkey::Params;
+-#[cfg(any(ossl102, libressl261))]
++#[cfg(any(ossl102, libressl261, boringssl))]
+ use crate::ssl::AlpnError;
+ use crate::ssl::{
+     try_get_session_ctx_index, SniError, Ssl, SslAlert, SslContext, SslContextRef, SslRef,
+@@ -178,7 +178,7 @@ where
+     }
+ }
+ 
+-#[cfg(any(ossl102, libressl261))]
++#[cfg(any(ossl102, libressl261, boringssl))]
+ pub extern "C" fn raw_alpn_select<F>(
+     ssl: *mut ffi::SSL,
+     out: *mut *const c_uchar,
+diff --git a/src/ssl/mod.rs b/src/ssl/mod.rs
+index d9b2a724..f5a696ab 100644
+--- a/src/ssl/mod.rs
++++ b/src/ssl/mod.rs
+@@ -602,17 +602,17 @@ impl SslAlert {
+ 
+ /// An error returned from an ALPN selection callback.
+ ///
+-/// Requires OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
+-#[cfg(any(ossl102, libressl261))]
++/// Requires BoringSSL or OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
++#[cfg(any(ossl102, libressl261, boringssl))]
+ #[derive(Debug, Copy, Clone, PartialEq, Eq)]
+ pub struct AlpnError(c_int);
+ 
+-#[cfg(any(ossl102, libressl261))]
++#[cfg(any(ossl102, libressl261, boringssl))]
+ impl AlpnError {
+     /// Terminate the handshake with a fatal alert.
+     ///
+-    /// Requires OpenSSL 1.1.0 or newer.
+-    #[cfg(ossl110)]
++    /// Requires BoringSSL or OpenSSL 1.1.0 or newer.
++    #[cfg(any(ossl110, boringssl))]
+     pub const ALERT_FATAL: AlpnError = AlpnError(ffi::SSL_TLSEXT_ERR_ALERT_FATAL);
+ 
+     /// Do not select a protocol, but continue the handshake.
+@@ -1267,23 +1267,30 @@ impl SslContextBuilder {
+     /// of those protocols on success. The [`select_next_proto`] function implements the standard
+     /// protocol selection algorithm.
+     ///
+-    /// Requires OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
++    /// Requires BoringSSL or OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
+     ///
+     /// [`SslContextBuilder::set_alpn_protos`]: struct.SslContextBuilder.html#method.set_alpn_protos
+     /// [`select_next_proto`]: fn.select_next_proto.html
+     #[corresponds(SSL_CTX_set_alpn_select_cb)]
+-    #[cfg(any(ossl102, libressl261))]
++    #[cfg(any(ossl102, libressl261, boringssl))]
+     pub fn set_alpn_select_callback<F>(&mut self, callback: F)
+     where
+         F: for<'a> Fn(&mut SslRef, &'a [u8]) -> Result<&'a [u8], AlpnError> + 'static + Sync + Send,
+     {
+         unsafe {
+             self.set_ex_data(SslContext::cached_ex_index::<F>(), callback);
++            #[cfg(not(boringssl))]
+             ffi::SSL_CTX_set_alpn_select_cb__fixed_rust(
+                 self.as_ptr(),
+                 Some(callbacks::raw_alpn_select::<F>),
+                 ptr::null_mut(),
+             );
++            #[cfg(boringssl)]
++            ffi::SSL_CTX_set_alpn_select_cb(
++                self.as_ptr(),
++                Some(callbacks::raw_alpn_select::<F>),
++                ptr::null_mut(),
++            );
+         }
+     }
+ 
+-- 
+2.47.0.277.g8800431eea-goog
+
diff --git a/rules.mk b/rules.mk
new file mode 100644
index 0000000..3ad7aa4
--- /dev/null
+++ b/rules.mk
@@ -0,0 +1,25 @@
+# This file is generated by cargo_embargo.
+# Do not modify this file after the LOCAL_DIR line
+# because the changes will be overridden on upgrade.
+# Content before the first line starting with LOCAL_DIR is preserved.
+
+LOCAL_DIR := $(GET_LOCAL_DIR)
+MODULE := $(LOCAL_DIR)
+MODULE_CRATE_NAME := openssl
+MODULE_RUST_CRATE_TYPES := rlib
+MODULE_SRCS := $(LOCAL_DIR)/src/lib.rs
+MODULE_RUST_EDITION := 2018
+MODULE_RUSTFLAGS += \
+	--cfg 'feature="unstable_boringssl"' \
+	--cfg 'boringssl'
+
+MODULE_LIBRARY_DEPS := \
+	$(call FIND_CRATE,bitflags) \
+	$(call FIND_CRATE,cfg-if) \
+	$(call FIND_CRATE,foreign-types) \
+	$(call FIND_CRATE,libc) \
+	$(call FIND_CRATE,once_cell) \
+	$(call FIND_CRATE,openssl-macros) \
+	$(call FIND_CRATE,openssl-sys)
+
+include make/library.mk
diff --git a/src/ssl/callbacks.rs b/src/ssl/callbacks.rs
index c6414fb..2fa2a32 100644
--- a/src/ssl/callbacks.rs
+++ b/src/ssl/callbacks.rs
@@ -20,7 +20,7 @@ use crate::dh::Dh;
 use crate::ec::EcKey;
 use crate::error::ErrorStack;
 use crate::pkey::Params;
-#[cfg(any(ossl102, libressl261))]
+#[cfg(any(ossl102, libressl261, boringssl))]
 use crate::ssl::AlpnError;
 use crate::ssl::{
     try_get_session_ctx_index, SniError, Ssl, SslAlert, SslContext, SslContextRef, SslRef,
@@ -178,7 +178,7 @@ where
     }
 }
 
-#[cfg(any(ossl102, libressl261))]
+#[cfg(any(ossl102, libressl261, boringssl))]
 pub extern "C" fn raw_alpn_select<F>(
     ssl: *mut ffi::SSL,
     out: *mut *const c_uchar,
diff --git a/src/ssl/mod.rs b/src/ssl/mod.rs
index 2ff9dac..776b26c 100644
--- a/src/ssl/mod.rs
+++ b/src/ssl/mod.rs
@@ -602,17 +602,17 @@ impl SslAlert {
 
 /// An error returned from an ALPN selection callback.
 ///
-/// Requires OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
-#[cfg(any(ossl102, libressl261))]
+/// Requires BoringSSL or OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
+#[cfg(any(ossl102, libressl261, boringssl))]
 #[derive(Debug, Copy, Clone, PartialEq, Eq)]
 pub struct AlpnError(c_int);
 
-#[cfg(any(ossl102, libressl261))]
+#[cfg(any(ossl102, libressl261, boringssl))]
 impl AlpnError {
     /// Terminate the handshake with a fatal alert.
     ///
-    /// Requires OpenSSL 1.1.0 or newer.
-    #[cfg(ossl110)]
+    /// Requires BoringSSL or OpenSSL 1.1.0 or newer.
+    #[cfg(any(ossl110, boringssl))]
     pub const ALERT_FATAL: AlpnError = AlpnError(ffi::SSL_TLSEXT_ERR_ALERT_FATAL);
 
     /// Do not select a protocol, but continue the handshake.
@@ -1267,23 +1267,30 @@ impl SslContextBuilder {
     /// of those protocols on success. The [`select_next_proto`] function implements the standard
     /// protocol selection algorithm.
     ///
-    /// Requires OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
+    /// Requires BoringSSL or OpenSSL 1.0.2 or LibreSSL 2.6.1 or newer.
     ///
     /// [`SslContextBuilder::set_alpn_protos`]: struct.SslContextBuilder.html#method.set_alpn_protos
     /// [`select_next_proto`]: fn.select_next_proto.html
     #[corresponds(SSL_CTX_set_alpn_select_cb)]
-    #[cfg(any(ossl102, libressl261))]
+    #[cfg(any(ossl102, libressl261, boringssl))]
     pub fn set_alpn_select_callback<F>(&mut self, callback: F)
     where
         F: for<'a> Fn(&mut SslRef, &'a [u8]) -> Result<&'a [u8], AlpnError> + 'static + Sync + Send,
     {
         unsafe {
             self.set_ex_data(SslContext::cached_ex_index::<F>(), callback);
+            #[cfg(not(boringssl))]
             ffi::SSL_CTX_set_alpn_select_cb__fixed_rust(
                 self.as_ptr(),
                 Some(callbacks::raw_alpn_select::<F>),
                 ptr::null_mut(),
             );
+            #[cfg(boringssl)]
+            ffi::SSL_CTX_set_alpn_select_cb(
+                self.as_ptr(),
+                Some(callbacks::raw_alpn_select::<F>),
+                ptr::null_mut(),
+            );
         }
     }
 
```

