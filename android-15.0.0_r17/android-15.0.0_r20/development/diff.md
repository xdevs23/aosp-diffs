```diff
diff --git a/build/sdk.atree b/build/sdk.atree
index c5510fe83..4b3ea9aee 100644
--- a/build/sdk.atree
+++ b/build/sdk.atree
@@ -44,7 +44,7 @@ ${OUT_DIR}/target/common/obj/PACKAGING/android_jar_intermediates/android.jar
 ${OUT_DIR}/target/common/obj/PACKAGING/android_jar_intermediates/android-stubs-src.jar  platforms/${PLATFORM_NAME}/android-stubs-src.jar
 
 # core-for-system-modules.jar for building system modules
-${OUT_DIR}/target/common/obj/JAVA_LIBRARIES/core-current-stubs-for-system-modules_intermediates/classes.jar    platforms/${PLATFORM_NAME}/core-for-system-modules.jar
+${OUT_DIR}/target/common/obj/JAVA_LIBRARIES/core-current-stubs-for-system-modules-exportable_intermediates/classes.jar    platforms/${PLATFORM_NAME}/core-for-system-modules.jar
 
 # optional API files.
 development/build/optional.json                                                               platforms/${PLATFORM_NAME}/optional/optional.json
diff --git a/build/tools/sdk-preprocess-files.mk b/build/tools/sdk-preprocess-files.mk
index b05bcd5ad..dcbbdaabc 100644
--- a/build/tools/sdk-preprocess-files.mk
+++ b/build/tools/sdk-preprocess-files.mk
@@ -82,7 +82,7 @@ ALL_SDK_FILES += $(android_jar_src_target)
 
 # ===== SDK for system modules =====
 # A subset of the public SDK to convert to system modules for use with javac -source 9 -target 9
-ALL_SDK_FILES += $(call intermediates-dir-for,JAVA_LIBRARIES,core-current-stubs-for-system-modules,,COMMON)/classes.jar
+ALL_SDK_FILES += $(call intermediates-dir-for,JAVA_LIBRARIES,core-current-stubs-for-system-modules-exportable,,COMMON)/classes.jar
 
 # ====================================================
 
diff --git a/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java b/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
index a7d0cc487..a5e066412 100644
--- a/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
+++ b/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
@@ -21,6 +21,7 @@ import android.hardware.input.InputManager;
 import android.hardware.input.InputManagerGlobal;
 import android.os.SystemClock;
 import android.util.SparseArray;
+import android.view.Display;
 import android.view.IWindowManager;
 import android.view.MotionEvent;
 
@@ -38,21 +39,22 @@ public abstract class MonkeyMotionEvent extends MonkeyEvent {
     private float mYPrecision;
     private int mDeviceId;
     private int mSource;
-    private int mFlags;
     private int mEdgeFlags;
+    private int mDisplayId;
 
     //If true, this is an intermediate step (more verbose logging, only)
     private boolean mIntermediateNote;
 
-    protected MonkeyMotionEvent(int type, int source, int action) {
+    protected MonkeyMotionEvent(int type, int source, int action, int display) {
         super(type);
         mSource = source;
         mDownTime = -1;
         mEventTime = -1;
         mAction = action;
-        mPointers = new SparseArray<MotionEvent.PointerCoords>();
+        mPointers = new SparseArray<>();
         mXPrecision = 1;
         mYPrecision = 1;
+        mDisplayId = display;
     }
 
     public MonkeyMotionEvent addPointer(int id, float x, float y) {
@@ -123,23 +125,25 @@ public abstract class MonkeyMotionEvent extends MonkeyEvent {
     }
 
     /**
-     * 
+     *
      * @return instance of a motion event
      */
     private MotionEvent getEvent() {
         int pointerCount = mPointers.size();
-        int[] pointerIds = new int[pointerCount];
         MotionEvent.PointerCoords[] pointerCoords = new MotionEvent.PointerCoords[pointerCount];
+        MotionEvent.PointerProperties[] pointerProperties
+                = new MotionEvent.PointerProperties[pointerCount];
         for (int i = 0; i < pointerCount; i++) {
-            pointerIds[i] = mPointers.keyAt(i);
             pointerCoords[i] = mPointers.valueAt(i);
+            pointerProperties[i] = new MotionEvent.PointerProperties();
+            pointerProperties[i].id = mPointers.keyAt(i);
         }
 
-        MotionEvent ev = MotionEvent.obtain(mDownTime,
+        return MotionEvent.obtain(mDownTime,
                 mEventTime < 0 ? SystemClock.uptimeMillis() : mEventTime,
-                mAction, pointerCount, pointerIds, pointerCoords,
-                mMetaState, mXPrecision, mYPrecision, mDeviceId, mEdgeFlags, mSource, mFlags);
-        return ev;
+                mAction, pointerCount, pointerProperties, pointerCoords,
+                mMetaState, 0 /*buttonState*/, mXPrecision, mYPrecision, mDeviceId, mEdgeFlags,
+                mSource, mDisplayId, 0 /*flags*/);
     }
 
     public MotionEvent getMotionEventForInjection() {
diff --git a/cmds/monkey/src/com/android/commands/monkey/MonkeyTouchEvent.java b/cmds/monkey/src/com/android/commands/monkey/MonkeyTouchEvent.java
index a9fb12838..1b27a6f3f 100644
--- a/cmds/monkey/src/com/android/commands/monkey/MonkeyTouchEvent.java
+++ b/cmds/monkey/src/com/android/commands/monkey/MonkeyTouchEvent.java
@@ -16,6 +16,7 @@
 
 package com.android.commands.monkey;
 
+import android.view.Display;
 import android.view.InputDevice;
 
 
@@ -24,7 +25,8 @@ import android.view.InputDevice;
  */
 public class MonkeyTouchEvent extends MonkeyMotionEvent {
     public MonkeyTouchEvent(int action) {
-        super(MonkeyEvent.EVENT_TYPE_TOUCH, InputDevice.SOURCE_TOUCHSCREEN, action);
+        super(MonkeyEvent.EVENT_TYPE_TOUCH, InputDevice.SOURCE_TOUCHSCREEN, action,
+                Display.DEFAULT_DISPLAY);
     }
 
     @Override
diff --git a/cmds/monkey/src/com/android/commands/monkey/MonkeyTrackballEvent.java b/cmds/monkey/src/com/android/commands/monkey/MonkeyTrackballEvent.java
index 960e40ead..3885e7422 100644
--- a/cmds/monkey/src/com/android/commands/monkey/MonkeyTrackballEvent.java
+++ b/cmds/monkey/src/com/android/commands/monkey/MonkeyTrackballEvent.java
@@ -16,6 +16,7 @@
 
 package com.android.commands.monkey;
 
+import android.view.Display;
 import android.view.InputDevice;
 
 /**
@@ -23,7 +24,8 @@ import android.view.InputDevice;
  */
 public class MonkeyTrackballEvent extends MonkeyMotionEvent {
     public MonkeyTrackballEvent(int action) {
-        super(MonkeyEvent.EVENT_TYPE_TRACKBALL, InputDevice.SOURCE_TRACKBALL, action);
+        super(MonkeyEvent.EVENT_TYPE_TRACKBALL, InputDevice.SOURCE_TRACKBALL, action,
+                Display.INVALID_DISPLAY);
     }
 
     @Override
diff --git a/python-packages/fetchartifact/fetchartifact/__init__.py b/python-packages/fetchartifact/fetchartifact/__init__.py
index a514c1704..87c804fd0 100644
--- a/python-packages/fetchartifact/fetchartifact/__init__.py
+++ b/python-packages/fetchartifact/fetchartifact/__init__.py
@@ -23,6 +23,7 @@ from typing import cast
 from aiohttp import ClientSession
 
 _DEFAULT_QUERY_URL_BASE = "https://androidbuildinternal.googleapis.com"
+DEFAULT_CHUNK_SIZE = 16 * 1024 * 1024
 
 
 def _logger() -> Logger:
@@ -87,7 +88,7 @@ async def fetch_artifact_chunked(
     build_id: str,
     artifact_name: str,
     session: ClientSession,
-    chunk_size: int = 16 * 1024 * 1024,
+    chunk_size: int = DEFAULT_CHUNK_SIZE,
     query_url_base: str = _DEFAULT_QUERY_URL_BASE,
 ) -> AsyncIterable[bytes]:
     """Fetches an artifact from the build server.
@@ -104,9 +105,78 @@ async def fetch_artifact_chunked(
     Returns:
         Async iterable bytes of the artifact contents.
     """
-    download_url = _make_download_url(target, build_id, artifact_name, query_url_base)
-    _logger().debug("Beginning download from %s", download_url)
-    async with session.get(download_url) as response:
-        response.raise_for_status()
-        async for chunk in response.content.iter_chunked(chunk_size):
-            yield chunk
+    downloader = ArtifactDownloader(target, build_id, artifact_name, query_url_base)
+    async for chunk in downloader.download(session, chunk_size):
+        yield chunk
+
+
+class ArtifactDownloader:
+    """Similar to fetch_artifact_chunked but can be subclassed to report progress."""
+
+    def __init__(
+        self,
+        target: str,
+        build_id: str,
+        artifact_name: str,
+        query_url_base: str = _DEFAULT_QUERY_URL_BASE,
+    ) -> None:
+        self.target = target
+        self.build_id = build_id
+        self.artifact_name = artifact_name
+        self.query_url_base = query_url_base
+
+    async def download(
+        self, session: ClientSession, chunk_size: int = DEFAULT_CHUNK_SIZE
+    ) -> AsyncIterable[bytes]:
+        """Fetches an artifact from the build server.
+
+        Once the Content-Length of the artifact is known, on_artifact_size will be
+        called. If no Content-Length header is present, on_artifact_size will not be
+        called.
+
+        After each chunk is yielded, after_chunk will be called.
+
+        Args:
+            session: The aiohttp ClientSession to use. If omitted, one will be created
+                and destroyed for every call.
+            chunk_size: The number of bytes to attempt to download before yielding and
+                reporting progress.
+
+        Returns:
+            Async iterable bytes of the artifact contents.
+        """
+        download_url = _make_download_url(
+            self.target, self.build_id, self.artifact_name, self.query_url_base
+        )
+        _logger().debug("Beginning download from %s", download_url)
+        async with session.get(download_url) as response:
+            response.raise_for_status()
+            try:
+                self.on_artifact_size(int(response.headers["Content-Length"]))
+            except KeyError:
+                pass
+
+            async for chunk in response.content.iter_chunked(chunk_size):
+                yield chunk
+                self.after_chunk(len(chunk))
+
+    def on_artifact_size(self, size: int) -> None:
+        """Called once the artifact's Content-Length is known.
+
+        This can be overridden in a subclass to enable progress reporting.
+
+        If the artifact headers do not report the Content-Length, this function will not
+        be called.
+
+        Args:
+            size: The Content-Length of the artifact.
+        """
+
+    def after_chunk(self, size: int) -> None:
+        """Called after each chunk is yielded.
+
+        This can be overridden in a subclass to enable progress reporting.
+
+        Args:
+            size: The size of the chunk.
+        """
diff --git a/python-packages/fetchartifact/tests/test_fetchartifact.py b/python-packages/fetchartifact/tests/test_fetchartifact.py
index ad65d993b..b24855007 100644
--- a/python-packages/fetchartifact/tests/test_fetchartifact.py
+++ b/python-packages/fetchartifact/tests/test_fetchartifact.py
@@ -21,7 +21,7 @@ from aiohttp import ClientResponseError, ClientSession
 from aiohttp.test_utils import TestClient
 from aiohttp.web import Application, Request, Response
 
-from fetchartifact import fetch_artifact, fetch_artifact_chunked
+from fetchartifact import ArtifactDownloader, fetch_artifact, fetch_artifact_chunked
 
 TEST_BUILD_ID = "1234"
 TEST_TARGET = "linux"
@@ -93,6 +93,38 @@ async def test_failure_raises(android_ci_client: TestClient) -> None:
             pass
 
 
+class TestDownloader(ArtifactDownloader):
+    """Downloader which tracks calls to on_artifact_size and after_chunk."""
+
+    def __init__(self, target: str, build_id: str, artifact_name: str) -> None:
+        super().__init__(target, build_id, artifact_name, query_url_base="")
+        self.reported_content_length: int | None = None
+        self.reported_chunk_sizes: list[int] = []
+
+    def on_artifact_size(self, size: int) -> None:
+        super().on_artifact_size(size)
+        assert self.reported_content_length is None
+        self.reported_content_length = size
+
+    def after_chunk(self, size: int) -> None:
+        super().after_chunk(size)
+        self.reported_chunk_sizes.append(size)
+
+
+async def test_downloader_progress_reports(android_ci_client: TestClient) -> None:
+    """Tests that progress is reported when using ArtifactDownloader."""
+    downloader = TestDownloader(TEST_TARGET, TEST_BUILD_ID, TEST_ARTIFACT_NAME)
+
+    assert [b"Hell", b"o, w", b"orld", b"!"] == [
+        chunk
+        async for chunk in downloader.download(
+            cast(ClientSession, android_ci_client), chunk_size=4
+        )
+    ]
+    assert downloader.reported_content_length == len(TEST_RESPONSE.decode("utf-8"))
+    assert downloader.reported_chunk_sizes == [4, 4, 4, 1]
+
+
 @pytest.mark.requires_network
 async def test_real_artifact() -> None:
     """Tests with a real artifact. Requires an internet connection."""
diff --git a/samples/AconfigDemo/aconfig_demo_flags.aconfig b/samples/AconfigDemo/aconfig_demo_flags.aconfig
index b835747aa..803dfa4cc 100644
--- a/samples/AconfigDemo/aconfig_demo_flags.aconfig
+++ b/samples/AconfigDemo/aconfig_demo_flags.aconfig
@@ -146,3 +146,59 @@ flag {
     purpose: PURPOSE_BUGFIX
   }
 }
+flag {
+    name: "pc_test_1"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_2"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_3"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_4"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_5"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_6"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "pc_test_7"
+    namespace: "core_experiments_team_internal"
+    description: "A test flag to verify saturation improvements"
+    bug: "336778457"
+    is_fixed_read_only: false
+}
+flag {
+    name: "one_stage_rollback_test_flag"
+    namespace: "gantry"
+    description: "A test flag to verify one stage rollback"
+    bug: "303703498"
+    is_fixed_read_only: false
+}
\ No newline at end of file
diff --git a/samples/CubeLiveWallpaper/AndroidManifest.xml b/samples/CubeLiveWallpaper/AndroidManifest.xml
index 8a7d527e8..49af049c8 100644
--- a/samples/CubeLiveWallpaper/AndroidManifest.xml
+++ b/samples/CubeLiveWallpaper/AndroidManifest.xml
@@ -33,6 +33,7 @@
         <service
             android:label="@string/wallpaper_cube1"
             android:name=".cube1.CubeWallpaper1"
+            android:exported="true"
             android:permission="android.permission.BIND_WALLPAPER">
             <intent-filter>
                 <action android:name="android.service.wallpaper.WallpaperService" />
@@ -43,6 +44,7 @@
         <service
             android:label="@string/wallpaper_cube2"
             android:name=".cube2.CubeWallpaper2"
+            android:exported="true"
             android:permission="android.permission.BIND_WALLPAPER">
             <intent-filter>
                 <action android:name="android.service.wallpaper.WallpaperService" />
diff --git a/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml b/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml
index dd0dcaa2e..83296ef9c 100644
--- a/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml
+++ b/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml
@@ -32,6 +32,12 @@
                 <category android:name="android.intent.category.LAUNCHER" />
             </intent-filter>
         </activity>
+        <activity
+            android:name="com.android.compose.animation.scene.demo.NestedSharedElementActivity"
+            android:theme="@style/Theme.SceneTransitionLayoutDemo"
+            android:windowSoftInputMode="adjustResize"
+            android:exported="true">
+        </activity>
 
         <profileable android:shell="true" />
     </application>
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt
index 0149efdd1..460969654 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt
@@ -21,6 +21,7 @@ import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.fillMaxSize
 import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.overscroll
 import androidx.compose.foundation.shape.CircleShape
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.ArrowBack
@@ -73,7 +74,8 @@ fun SceneScope.Bouncer(
 
         VerticalGrid(
             columns = 3,
-            Modifier.align(Alignment.BottomCenter)
+            Modifier.overscroll(verticalOverscrollEffect)
+                .align(Alignment.BottomCenter)
                 .padding(bottom = 100.dp)
                 .element(Bouncer.Elements.Content),
             horizontalSpacing = gridSpacing,
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt
index dbc1ecbea..a2ad24020 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt
@@ -64,22 +64,24 @@ import kotlin.math.tanh
 data class DemoConfiguration(
     val notificationsInLockscreen: Int = 2,
     val notificationsInShade: Int = 10,
+    val quickSettingsRows: Int = 4,
     val interactiveNotifications: Boolean = false,
     val showMediaPlayer: Boolean = true,
     val isFullscreen: Boolean = false,
     val canChangeSceneOrOverlays: Boolean = true,
     val transitionInterceptionThreshold: Float = 0.05f,
-    val springConfigurations: DemoSpringConfigurations = DemoSpringConfigurations.presets[1],
+    val springConfigurations: DemoSpringConfigurations = DemoSpringConfigurations.presets[0],
     val useOverscrollSpec: Boolean = true,
     val overscrollProgressConverter: DemoOverscrollProgress = Tanh(maxProgress = 0.2f, tilt = 3f),
-    val enableInterruptions: Boolean = true,
     val lsToShadeRequiresFullSwipe: ToggleableState = ToggleableState.Indeterminate,
     val enableOverlays: Boolean = false,
+    val transitionBorder: Boolean = true,
 ) {
     companion object {
         val Saver = run {
             val notificationsInLockscreenKey = "notificationsInLockscreen"
             val notificationsInShadeKey = "notificationsInShade"
+            val quickSettingsRowsKey = "quickSettingsRows"
             val interactiveNotificationsKey = "interactiveNotifications"
             val showMediaPlayerKey = "showMediaPlayer"
             val isFullscreenKey = "isFullscreen"
@@ -88,14 +90,16 @@ data class DemoConfiguration(
             val springConfigurationsKey = "springConfigurations"
             val useOverscrollSpec = "useOverscrollSpec"
             val overscrollProgress = "overscrollProgress"
-            val enableInterruptions = "enableInterruptions"
             val lsToShadeRequiresFullSwipe = "lsToShadeRequiresFullSwipe"
+            val enableOverlays = "enableOverlays"
+            val transitionBorder = "transitionBorder"
 
             mapSaver(
                 save = {
                     mapOf(
                         notificationsInLockscreenKey to it.notificationsInLockscreen,
                         notificationsInShadeKey to it.notificationsInShade,
+                        quickSettingsRowsKey to it.quickSettingsRows,
                         interactiveNotificationsKey to it.interactiveNotifications,
                         showMediaPlayerKey to it.showMediaPlayer,
                         isFullscreenKey to it.isFullscreen,
@@ -104,14 +108,16 @@ data class DemoConfiguration(
                         springConfigurationsKey to it.springConfigurations.save(),
                         useOverscrollSpec to it.useOverscrollSpec,
                         overscrollProgress to it.overscrollProgressConverter.save(),
-                        enableInterruptions to it.enableInterruptions,
                         lsToShadeRequiresFullSwipe to it.lsToShadeRequiresFullSwipe,
+                        enableOverlays to it.enableOverlays,
+                        transitionBorder to it.transitionBorder,
                     )
                 },
                 restore = {
                     DemoConfiguration(
                         notificationsInLockscreen = it[notificationsInLockscreenKey] as Int,
                         notificationsInShade = it[notificationsInShadeKey] as Int,
+                        quickSettingsRows = it[quickSettingsRowsKey] as Int,
                         interactiveNotifications = it[interactiveNotificationsKey] as Boolean,
                         showMediaPlayer = it[showMediaPlayerKey] as Boolean,
                         isFullscreen = it[isFullscreenKey] as Boolean,
@@ -123,9 +129,10 @@ data class DemoConfiguration(
                         useOverscrollSpec = it[useOverscrollSpec] as Boolean,
                         overscrollProgressConverter =
                             it[overscrollProgress].restoreOverscrollProgress(),
-                        enableInterruptions = it[enableInterruptions] as Boolean,
                         lsToShadeRequiresFullSwipe =
                             it[lsToShadeRequiresFullSwipe] as ToggleableState,
+                        enableOverlays = it[enableOverlays] as Boolean,
+                        transitionBorder = it[transitionBorder] as Boolean,
                     )
                 },
             )
@@ -151,14 +158,24 @@ data class DemoSpringConfigurations(
         val presets =
             listOf(
                 DemoSpringConfigurations(
-                    name = "Fast",
+                    name = "Default",
+                    systemUiSprings =
+                        SpringConfiguration(
+                            Spring.StiffnessMediumLow,
+                            Spring.DampingRatioLowBouncy,
+                        ),
+                    notificationSprings =
+                        SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioLowBouncy),
+                ),
+                DemoSpringConfigurations(
+                    name = "NotBouncy Fast",
                     systemUiSprings =
                         SpringConfiguration(Spring.StiffnessMedium, Spring.DampingRatioNoBouncy),
                     notificationSprings =
                         SpringConfiguration(Spring.StiffnessMedium, Spring.DampingRatioNoBouncy),
                 ),
                 DemoSpringConfigurations(
-                    name = "Normal",
+                    name = "NotBouncy Normal",
                     systemUiSprings =
                         SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioNoBouncy),
                     notificationSprings =
@@ -336,19 +353,6 @@ fun DemoConfigurationDialog(
                     },
                 )
 
-                // Interruptions.
-                Checkbox(
-                    label = "Interruptions",
-                    checked = configuration.enableInterruptions,
-                    onCheckedChange = {
-                        onConfigurationChange(
-                            configuration.copy(
-                                enableInterruptions = !configuration.enableInterruptions
-                            )
-                        )
-                    },
-                )
-
                 // Can change scene.
                 Checkbox(
                     label = "Can change scene or overlays",
@@ -373,6 +377,17 @@ fun DemoConfigurationDialog(
                     },
                 )
 
+                // Transition border.
+                Checkbox(
+                    label = "Transition border",
+                    checked = configuration.transitionBorder,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(transitionBorder = !configuration.transitionBorder)
+                        )
+                    },
+                )
+
                 Text(text = "Springs", style = MaterialTheme.typography.titleMedium)
 
                 SpringsPicker(
@@ -462,6 +477,16 @@ fun DemoConfigurationDialog(
                     },
                 )
 
+                Text(text = "Quick Settings", style = MaterialTheme.typography.titleMedium)
+
+                Counter(
+                    "# quick settings rows",
+                    configuration.quickSettingsRows,
+                    onValueChange = {
+                        onConfigurationChange(configuration.copy(quickSettingsRows = it))
+                    },
+                )
+
                 Text(text = "Lockscreen", style = MaterialTheme.typography.titleMedium)
 
                 // Whether the LS => Shade transition requires a full distance swipe to be
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoContainerRevealHaptics.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoContainerRevealHaptics.kt
new file mode 100644
index 000000000..ab61e8ed2
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoContainerRevealHaptics.kt
@@ -0,0 +1,28 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.ui.hapticfeedback.HapticFeedback
+import androidx.compose.ui.hapticfeedback.HapticFeedbackType
+import com.android.compose.animation.scene.reveal.ContainerRevealHaptics
+
+class DemoContainerRevealHaptics(private val hapticFeedback: HapticFeedback) :
+    ContainerRevealHaptics {
+    override fun onRevealThresholdCrossed(revealed: Boolean) {
+        hapticFeedback.performHapticFeedback(HapticFeedbackType.GestureThresholdActivate)
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt
deleted file mode 100644
index 9fe8df27f..000000000
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt
+++ /dev/null
@@ -1,58 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.android.compose.animation.scene.demo
-
-import androidx.compose.foundation.gestures.Orientation
-import androidx.compose.ui.unit.Density
-import androidx.compose.ui.unit.IntOffset
-import androidx.compose.ui.unit.IntSize
-import androidx.compose.ui.unit.LayoutDirection
-import com.android.compose.animation.scene.SwipeSource
-import com.android.compose.animation.scene.SwipeSourceDetector
-
-/** A [SwipeSource] for the left or right half of the device. */
-enum class HorizontalHalfScreen(private val onResolve: (LayoutDirection) -> Resolved) :
-    SwipeSource {
-    Left(onResolve = { Resolved.Left }),
-    Right(onResolve = { Resolved.Right }),
-    Start(onResolve = { if (it == LayoutDirection.Ltr) Resolved.Left else Resolved.Right }),
-    End(onResolve = { if (it == LayoutDirection.Ltr) Resolved.Right else Resolved.Left });
-
-    override fun resolve(layoutDirection: LayoutDirection): SwipeSource.Resolved {
-        return onResolve(layoutDirection)
-    }
-
-    enum class Resolved : SwipeSource.Resolved {
-        Left,
-        Right,
-    }
-}
-
-object HorizontalHalfScreenDetector : SwipeSourceDetector {
-    override fun source(
-        layoutSize: IntSize,
-        position: IntOffset,
-        density: Density,
-        orientation: Orientation,
-    ): SwipeSource.Resolved {
-        return if (position.x < layoutSize.width / 2) {
-            HorizontalHalfScreen.Resolved.Left
-        } else {
-            HorizontalHalfScreen.Resolved.Right
-        }
-    }
-}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt
index e2cc555bf..14ba1d39b 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt
@@ -32,7 +32,6 @@ import com.android.compose.animation.scene.ElementKey
 import com.android.compose.animation.scene.SceneKey
 import com.android.compose.animation.scene.SceneScope
 import com.android.compose.animation.scene.Swipe
-import com.android.compose.animation.scene.SwipeDirection
 import com.android.compose.animation.scene.UserAction
 import com.android.compose.animation.scene.UserActionResult
 import com.android.compose.grid.VerticalGrid
@@ -44,17 +43,14 @@ object Launcher {
     ): Map<UserAction, UserActionResult> {
         return buildList {
                 if (configuration.enableOverlays) {
+                    add(Swipe.Down to UserActionResult.ShowOverlay(Overlays.Notifications))
                     add(
-                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.Start) to
+                        Swipe.Down(fromSource = SceneContainerEdge.TopEnd) to
                             UserActionResult.ShowOverlay(Overlays.QuickSettings)
                     )
-                    add(
-                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.End) to
-                            UserActionResult.ShowOverlay(Overlays.Notifications)
-                    )
                 } else {
                     add(Swipe.Down to shadeScene)
-                    add(Swipe(SwipeDirection.Down, pointerCount = 2) to Scenes.QuickSettings)
+                    add(Swipe.Down(pointerCount = 2) to Scenes.QuickSettings)
                 }
             }
             .toMap()
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt
index 77fbf8c4e..d118ace20 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt
@@ -39,7 +39,6 @@ import com.android.compose.animation.scene.ElementKey
 import com.android.compose.animation.scene.SceneKey
 import com.android.compose.animation.scene.SceneScope
 import com.android.compose.animation.scene.Swipe
-import com.android.compose.animation.scene.SwipeDirection
 import com.android.compose.animation.scene.UserAction
 import com.android.compose.animation.scene.UserActionResult
 
@@ -53,19 +52,10 @@ object Lockscreen {
     ): Map<UserAction, UserActionResult> {
         return buildList {
                 if (configuration.enableOverlays) {
+                    add(Swipe.Down to UserActionResult.ShowOverlay(Overlays.Notifications))
                     add(
-                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.Start) to
-                            UserActionResult.ShowOverlay(
-                                Overlays.QuickSettings,
-                                requiresFullDistanceSwipe = requiresFullDistanceSwipeToShade,
-                            )
-                    )
-                    add(
-                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.End) to
-                            UserActionResult.ShowOverlay(
-                                Overlays.Notifications,
-                                requiresFullDistanceSwipe = requiresFullDistanceSwipeToShade,
-                            )
+                        Swipe.Down(fromSource = SceneContainerEdge.TopEnd) to
+                            UserActionResult.ShowOverlay(Overlays.QuickSettings)
                     )
                 } else {
                     add(
@@ -89,7 +79,7 @@ object Lockscreen {
                 )
 
                 if (fastSwipeToQuickSettings) {
-                    add(Swipe(SwipeDirection.Down, pointerCount = 2) to Scenes.QuickSettings)
+                    add(Swipe.Down(pointerCount = 2) to Scenes.QuickSettings)
                 }
             }
             .toMap()
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementActivity.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementActivity.kt
new file mode 100644
index 000000000..f7437471a
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementActivity.kt
@@ -0,0 +1,29 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import android.os.Bundle
+import androidx.activity.ComponentActivity
+import androidx.activity.compose.setContent
+
+class NestedSharedElementActivity : ComponentActivity() {
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+        setContent { NestedSharedElementDemo() }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementDemo.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementDemo.kt
new file mode 100644
index 000000000..f077fc872
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NestedSharedElementDemo.kt
@@ -0,0 +1,145 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.background
+import androidx.compose.foundation.border
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.shape.CircleShape
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ContentScope
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.MutableSceneTransitionLayoutState
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.SceneTransitionLayout
+import com.android.compose.animation.scene.transitions
+
+object ParentSTL {
+    object Scenes {
+        val Left = SceneKey("Left")
+        val Right = SceneKey("Right")
+    }
+}
+
+object ChildSTL {
+    object Scenes {
+        val Top = SceneKey("Red")
+        val Bottom = SceneKey("Red")
+    }
+}
+
+object Elements {
+    val Shared = ElementKey("Shared")
+}
+
+@Composable
+fun NestedSharedElementDemo(modifier: Modifier = Modifier) {
+    Column(modifier) {
+        val state = remember {
+            MutableSceneTransitionLayoutState(
+                ParentSTL.Scenes.Left,
+                transitions {
+                    from(ParentSTL.Scenes.Left, to = ParentSTL.Scenes.Right) { spec = tween(500) }
+                },
+            )
+        }
+        val childState = remember {
+            MutableSceneTransitionLayoutState(
+                ChildSTL.Scenes.Top,
+                transitions {
+                    from(ChildSTL.Scenes.Top, to = ChildSTL.Scenes.Bottom) { spec = tween(500) }
+                },
+            )
+        }
+        val scope = rememberCoroutineScope()
+        SceneTransitionLayout(
+            state,
+            Modifier.padding(16.dp)
+                .border(3.dp, Color.Blue)
+                .clickable {
+                    val targetScene =
+                        when (state.currentScene) {
+                            ParentSTL.Scenes.Left -> ParentSTL.Scenes.Right
+                            else -> ParentSTL.Scenes.Left
+                        }
+                    state.setTargetScene(targetScene, scope)
+                }
+                .padding(16.dp),
+        ) {
+            scene(ParentSTL.Scenes.Right) {
+                Box(Modifier.fillMaxSize()) {
+                    SharedElement(Modifier.size(30.dp).align(Alignment.TopEnd))
+                }
+            }
+
+            scene(ParentSTL.Scenes.Left) {
+                Box(Modifier.fillMaxSize()) {
+                    ChildSTL(
+                        childState,
+                        Modifier.align(Alignment.Center).fillMaxSize(fraction = 0.5f),
+                    )
+                }
+            }
+        }
+    }
+}
+
+@Composable
+private fun ContentScope.ChildSTL(
+    state: MutableSceneTransitionLayoutState,
+    modifier: Modifier = Modifier,
+) {
+    val scope = rememberCoroutineScope()
+    NestedSceneTransitionLayout(
+        state,
+        modifier.border(3.dp, Color.Red).clickable {
+            val targetScene =
+                when (state.currentScene) {
+                    ChildSTL.Scenes.Top -> ChildSTL.Scenes.Bottom
+                    else -> ChildSTL.Scenes.Top
+                }
+            state.setTargetScene(targetScene, scope)
+        },
+    ) {
+        scene(ChildSTL.Scenes.Top) {
+            Box(Modifier.fillMaxSize()) { SharedElement(Modifier.size(100.dp)) }
+        }
+        scene(ChildSTL.Scenes.Bottom) {
+            Box(Modifier.fillMaxSize()) {
+                SharedElement(Modifier.align(Alignment.BottomStart).size(60.dp))
+            }
+        }
+    }
+}
+
+@Composable
+private fun SceneScope.SharedElement(modifier: Modifier = Modifier) {
+    Box(modifier.element(Elements.Shared).background(Color.Green, CircleShape))
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt
index cf0b6aeb2..00aef1a04 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt
@@ -16,11 +16,10 @@
 
 package com.android.compose.animation.scene.demo
 
+import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.Column
-import androidx.compose.foundation.layout.PaddingValues
 import androidx.compose.runtime.Composable
 import androidx.compose.ui.Modifier
-import androidx.compose.ui.unit.dp
 import com.android.compose.animation.scene.Back
 import com.android.compose.animation.scene.ElementKey
 import com.android.compose.animation.scene.SceneScope
@@ -29,7 +28,6 @@ import com.android.compose.animation.scene.UserActionResult
 
 object NotificationShade {
     object Elements {
-        val Root = ElementKey("NotificationShadeRoot")
         val Content = ElementKey("NotificationShadeContent")
     }
 
@@ -37,7 +35,8 @@ object NotificationShade {
         mapOf(
             Back to UserActionResult.HideOverlay(Overlays.Notifications),
             Swipe.Up to UserActionResult.HideOverlay(Overlays.Notifications),
-            Swipe.Left to UserActionResult.ReplaceByOverlay(Overlays.QuickSettings),
+            Swipe.Down(fromSource = SceneContainerEdge.TopEnd) to
+                UserActionResult.ReplaceByOverlay(Overlays.QuickSettings),
         )
 }
 
@@ -46,12 +45,10 @@ fun SceneScope.NotificationShade(
     notificationList: @Composable SceneScope.() -> Unit,
     modifier: Modifier = Modifier,
 ) {
-    PartialShade(
-        modifier.element(NotificationShade.Elements.Root),
-
-        // The notification list already applies some padding.
-        innerPadding = PaddingValues(0.dp),
-    ) {
-        Column(Modifier.element(NotificationShade.Elements.Content)) { notificationList() }
+    PartialShade(modifier) {
+        Column(Modifier.element(NotificationShade.Elements.Content)) {
+            // Don't resize the notifications during the reveal.
+            Box(Modifier.noResizeDuringTransitions()) { notificationList() }
+        }
     }
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt
index 81e624041..4287f1f81 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt
@@ -19,12 +19,14 @@ package com.android.compose.animation.scene.demo
 import androidx.compose.foundation.background
 import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.BoxScope
-import androidx.compose.foundation.layout.PaddingValues
 import androidx.compose.foundation.layout.fillMaxWidth
 import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.rememberScrollState
 import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.foundation.verticalScroll
 import androidx.compose.runtime.Composable
 import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
 import androidx.compose.ui.geometry.Offset
 import androidx.compose.ui.geometry.Size
 import androidx.compose.ui.graphics.Color
@@ -43,6 +45,7 @@ import com.android.compose.modifiers.thenIf
 
 object PartialShade {
     object Elements {
+        val Root = ElementKey("PartialShadeRoot", placeAllCopies = true)
         val Background =
             ElementKey("PartialShadeBackground", contentPicker = LowestZIndexContentPicker)
     }
@@ -65,30 +68,31 @@ object PartialShade {
 @Composable
 fun SceneScope.PartialShade(
     modifier: Modifier = Modifier,
-    outerPadding: PaddingValues = PaddingValues(16.dp),
-    innerPadding: PaddingValues = PaddingValues(16.dp),
     content: @Composable BoxScope.() -> Unit,
 ) {
     val isSplitShade = shouldUseSplitScenes(calculateWindowSizeClass())
 
+    val shape =
+        if (isSplitShade) PartialShade.Shapes.SplitBackground else PartialShade.Shapes.Background
     Box(
-        modifier.fillMaxWidth(if (isSplitShade) 0.5f else 1f).thenIf(isSplitShade) {
-            Modifier.padding(outerPadding)
-        }
+        modifier
+            .fillMaxWidth(if (isSplitShade) 0.5f else 1f)
+            .thenIf(isSplitShade) { Modifier.padding(16.dp) }
+            .element(PartialShade.Elements.Root)
+            .clip(shape)
     ) {
         val backgroundColor = PartialShade.Colors.Background
         Box(
             Modifier.element(PartialShade.Elements.Background)
                 .matchParentSize()
                 .thenIf(!isSplitShade) { Modifier.then(ExtraBackgroundElement(backgroundColor)) }
-                .background(
-                    backgroundColor,
-                    if (isSplitShade) PartialShade.Shapes.SplitBackground
-                    else PartialShade.Shapes.Background,
-                )
+                .background(backgroundColor)
         )
 
-        Box(Modifier.padding(innerPadding), content = content)
+        Box(
+            Modifier.verticalNestedScrollToScene().verticalScroll(rememberScrollState()),
+            content = content,
+        )
     }
 }
 
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt
index e4a8491df..86b84839a 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt
@@ -18,6 +18,8 @@ package com.android.compose.animation.scene.demo
 
 import androidx.compose.foundation.ExperimentalFoundationApi
 import androidx.compose.foundation.background
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.gestures.Orientation
 import androidx.compose.foundation.layout.Arrangement
 import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.Column
@@ -28,7 +30,7 @@ import androidx.compose.foundation.layout.fillMaxWidth
 import androidx.compose.foundation.layout.height
 import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.layout.size
-import androidx.compose.foundation.pager.PagerState
+import androidx.compose.foundation.overscroll
 import androidx.compose.foundation.rememberScrollState
 import androidx.compose.foundation.shape.CircleShape
 import androidx.compose.foundation.shape.RoundedCornerShape
@@ -57,9 +59,9 @@ import com.android.compose.animation.scene.NestedScrollBehavior
 import com.android.compose.animation.scene.SceneKey
 import com.android.compose.animation.scene.SceneScope
 import com.android.compose.animation.scene.Swipe
-import com.android.compose.animation.scene.SwipeDirection
 import com.android.compose.animation.scene.UserAction
 import com.android.compose.animation.scene.UserActionResult
+import com.android.compose.animation.scene.effect.rememberOffsetOverscrollEffect
 
 object QuickSettings {
     /**
@@ -80,8 +82,8 @@ object QuickSettings {
         return mapOf(
             Back to shadeScene,
             Swipe.Up to shadeScene,
-            Swipe(SwipeDirection.Up, pointerCount = 2) to fastSwipeUpScene,
-            Swipe(SwipeDirection.Up, fromSource = Edge.Bottom) to fastSwipeUpScene,
+            Swipe.Up(pointerCount = 2) to fastSwipeUpScene,
+            Swipe.Up(fromSource = Edge.Bottom) to fastSwipeUpScene,
         )
     }
 
@@ -115,10 +117,7 @@ object QuickSettings {
 @Composable
 @OptIn(ExperimentalFoundationApi::class)
 fun SceneScope.QuickSettings(
-    pagerState: PagerState,
-    tiles: List<QuickSettingsTileViewModel>,
-    nGridRows: Int,
-    nGridColumns: Int,
+    qsPager: @Composable SceneScope.() -> Unit,
     mediaPlayer: (@Composable SceneScope.() -> Unit)?,
     onSettingsButtonClicked: () -> Unit,
     onPowerButtonClicked: () -> Unit,
@@ -130,9 +129,12 @@ fun SceneScope.QuickSettings(
         CompositionLocalProvider(LocalContentColor provides Color.White) {
             val scrollState = rememberScrollState()
 
+            val offsetOverscrollEffect = rememberOffsetOverscrollEffect(Orientation.Vertical)
             Column(
-                Modifier.verticalNestedScrollToScene(topBehavior = NestedScrollBehavior.EdgeAlways)
-                    .verticalScroll(scrollState)
+                Modifier.overscroll(verticalOverscrollEffect)
+                    .overscroll(offsetOverscrollEffect)
+                    .verticalNestedScrollToScene(topBehavior = NestedScrollBehavior.EdgeAlways)
+                    .verticalScroll(scrollState, overscrollEffect = offsetOverscrollEffect)
                     .padding(vertical = QuickSettings.Dimensions.Padding)
             ) {
                 val horizontalPaddingModifier = QuickSettings.Modifiers.HorizontalPadding
@@ -143,14 +145,12 @@ fun SceneScope.QuickSettings(
                     horizontalPaddingModifier.padding(top = QuickSettings.Dimensions.Padding)
                 )
 
-                QuickSettingsPager(
-                    pagerState = pagerState,
-                    tiles = tiles,
-                    nRows = nGridRows,
-                    nColumns = nGridColumns,
+                Box(
                     Modifier.padding(top = QuickSettings.Dimensions.Padding)
-                        .element(QuickSettings.Elements.ExpandedGrid),
-                )
+                        .element(QuickSettings.Elements.ExpandedGrid)
+                ) {
+                    qsPager()
+                }
 
                 if (mediaPlayer != null) {
                     Box(horizontalPaddingModifier) { mediaPlayer() }
@@ -172,6 +172,8 @@ fun SceneScope.QuickSettings(
                 onPowerButtonClicked,
                 Modifier.align(Alignment.BottomCenter)
                     .element(QuickSettings.Elements.FooterActions)
+                    // Intercepts touches, prevents the scrollable container behind from scrolling.
+                    .clickable(interactionSource = null, indication = null) { /* do nothing */ }
                     .background(Color.Black, QuickSettings.Shapes.FooterActionsBackground)
                     .padding(
                         top = QuickSettings.Dimensions.FooterActionsPadding,
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt
index e222bac92..fa4ae4a4e 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt
@@ -16,10 +16,15 @@
 
 package com.android.compose.animation.scene.demo
 
+import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.padding
 import androidx.compose.material3.MaterialTheme
 import androidx.compose.runtime.Composable
 import androidx.compose.ui.Modifier
+import androidx.compose.ui.unit.dp
+import androidx.compose.ui.zIndex
 import com.android.compose.animation.scene.Back
 import com.android.compose.animation.scene.ElementKey
 import com.android.compose.animation.scene.SceneScope
@@ -28,7 +33,6 @@ import com.android.compose.animation.scene.UserActionResult
 
 object QuickSettingsShade {
     object Elements {
-        val Root = ElementKey("QuickSettingsShadeContentRoot")
         val Content = ElementKey("QuickSettingsShadeContent")
     }
 
@@ -36,21 +40,30 @@ object QuickSettingsShade {
         mapOf(
             Back to UserActionResult.HideOverlay(Overlays.QuickSettings),
             Swipe.Up to UserActionResult.HideOverlay(Overlays.QuickSettings),
-            Swipe.Right to UserActionResult.ReplaceByOverlay(Overlays.Notifications),
+            Swipe.Down(fromSource = SceneContainerEdge.TopStart) to
+                UserActionResult.ReplaceByOverlay(Overlays.Notifications),
         )
 }
 
 @Composable
 fun SceneScope.QuickSettingsShade(
+    qsPager: @Composable SceneScope.() -> Unit,
     mediaPlayer: @Composable (SceneScope.() -> Unit)?,
     modifier: Modifier = Modifier,
 ) {
-    PartialShade(modifier.element(QuickSettingsShade.Elements.Root)) {
+    PartialShade(modifier) {
         Column(Modifier.element(QuickSettingsShade.Elements.Content)) {
-            Clock(MaterialTheme.colorScheme.onSurfaceVariant)
+            val horizontalPaddingModifier = Modifier.padding(horizontal = 16.dp)
+
+            Clock(MaterialTheme.colorScheme.onSurfaceVariant, horizontalPaddingModifier)
+
             if (mediaPlayer != null) {
-                mediaPlayer()
+                // Ensure that the media player is above the QS tiles when they fade in.
+                Box(horizontalPaddingModifier.zIndex(1f)) { mediaPlayer() }
             }
+
+            Spacer(Modifier.padding(top = 16.dp))
+            qsPager()
         }
     }
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt
index 8e12f36dd..5fc6fd730 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt
@@ -14,16 +14,17 @@
  * limitations under the License.
  */
 
-@file:OptIn(ExperimentalFoundationApi::class)
-
 package com.android.compose.animation.scene.demo
 
 import androidx.compose.animation.core.Animatable
 import androidx.compose.animation.core.AnimationVector1D
 import androidx.compose.animation.core.VectorConverter
 import androidx.compose.animation.core.VisibilityThreshold
-import androidx.compose.foundation.ExperimentalFoundationApi
+import androidx.compose.foundation.OverscrollEffect
 import androidx.compose.foundation.background
+import androidx.compose.foundation.gestures.FlingBehavior
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.foundation.gestures.ScrollableDefaults
 import androidx.compose.foundation.layout.Box
 import androidx.compose.foundation.layout.Column
 import androidx.compose.foundation.layout.Row
@@ -32,6 +33,7 @@ import androidx.compose.foundation.layout.fillMaxSize
 import androidx.compose.foundation.layout.height
 import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.layout.width
+import androidx.compose.foundation.overscroll
 import androidx.compose.foundation.shape.RoundedCornerShape
 import androidx.compose.material3.LocalContentColor
 import androidx.compose.material3.LocalTextStyle
@@ -68,7 +70,6 @@ import androidx.compose.ui.unit.LayoutDirection
 import androidx.compose.ui.unit.dp
 import com.android.compose.animation.scene.Back
 import com.android.compose.animation.scene.ElementKey
-import com.android.compose.animation.scene.NestedScrollBehavior
 import com.android.compose.animation.scene.SceneKey
 import com.android.compose.animation.scene.SceneScope
 import com.android.compose.animation.scene.Swipe
@@ -77,6 +78,7 @@ import com.android.compose.animation.scene.UserActionResult
 import com.android.compose.animation.scene.ValueKey
 import com.android.compose.animation.scene.animateElementFloatAsState
 import com.android.compose.animation.scene.animateSceneFloatAsState
+import com.android.compose.animation.scene.effect.rememberOffsetOverscrollEffect
 import com.android.compose.modifiers.thenIf
 import com.android.compose.nestedscroll.LargeTopAppBarNestedScrollConnection
 import com.android.compose.nestedscroll.PriorityNestedScrollConnection
@@ -137,7 +139,7 @@ object Shade {
 
 @Composable
 fun SceneScope.Shade(
-    notificationList: @Composable SceneScope.() -> Unit,
+    notificationList: @Composable SceneScope.(OverscrollEffect?) -> Unit,
     mediaPlayer: (@Composable SceneScope.() -> Unit)?,
     quickSettingsTiles: List<QuickSettingsTileViewModel>,
     nQuickSettingsColumns: Int,
@@ -210,16 +212,16 @@ private fun SceneScope.ShadeLayout(
                 { background() },
                 { underScrim() },
                 {
+                    val flingBehavior = ScrollableDefaults.flingBehavior()
                     Box(
-                        Modifier.verticalNestedScrollToScene(
-                                topBehavior = NestedScrollBehavior.EdgeWithPreview
-                            )
+                        Modifier.verticalNestedScrollToScene()
                             .nestedScroll(
                                 remember(
                                     scrimOffset,
                                     underScrimHeight,
                                     density,
                                     scrimMinTopPadding,
+                                    flingBehavior,
                                 ) {
                                     scrimNestedScrollConnection(
                                         scrimOffset = { scrimOffset.value },
@@ -227,6 +229,7 @@ private fun SceneScope.ShadeLayout(
                                         underScrimHeight = { underScrimHeight.value },
                                         density = density,
                                         scrimMinTopPadding = scrimMinTopPadding,
+                                        flingBehavior = flingBehavior,
                                     )
                                 }
                             )
@@ -320,12 +323,14 @@ private fun scrimNestedScrollConnection(
     underScrimHeight: () -> Float,
     density: Density,
     scrimMinTopPadding: Dp,
+    flingBehavior: FlingBehavior,
 ): PriorityNestedScrollConnection {
     return LargeTopAppBarNestedScrollConnection(
         height = scrimOffset,
         onHeightChanged = onScrimOffsetChange,
         minHeight = { minScrimOffset(density, underScrimHeight(), scrimMinTopPadding) },
         maxHeight = { 0f },
+        flingBehavior = flingBehavior,
     )
 }
 
@@ -390,12 +395,19 @@ private fun SceneScope.UnderScrim(
 
 @Composable
 private fun SceneScope.Scrim(
-    notificationList: @Composable SceneScope.() -> Unit,
+    notificationList: @Composable SceneScope.(OverscrollEffect?) -> Unit,
     shouldPunchHoleBehindScrim: Boolean,
     scrimMinTopPadding: Dp,
     modifier: Modifier = Modifier,
 ) {
-    Box(modifier.element(Shade.Elements.Scrim).clip(Shade.Shapes.Scrim)) {
+    val overscrollEffect = rememberOffsetOverscrollEffect(Orientation.Vertical)
+    Box(
+        modifier
+            .overscroll(verticalOverscrollEffect)
+            .overscroll(overscrollEffect)
+            .element(Shade.Elements.Scrim)
+            .clip(Shade.Shapes.Scrim)
+    ) {
         if (shouldPunchHoleBehindScrim) {
             Spacer(
                 Modifier.fillMaxSize().drawBehind {
@@ -419,7 +431,7 @@ private fun SceneScope.Scrim(
                 .fillMaxSize(),
             propagateMinConstraints = true,
         ) {
-            notificationList()
+            notificationList(overscrollEffect)
         }
     }
 }
@@ -454,32 +466,34 @@ fun SceneScope.ShadeTime(scale: Float, modifier: Modifier = Modifier) {
         val layoutResult = remember(measurer, style) { measurer.measure("10:36", style = style) }
         val layoutDirection = LocalLayoutDirection.current
 
-        Spacer(
-            Modifier.layout { measurable, _ ->
-                    // Layout this element with the *target* size/scale of the element in this
-                    // scene.
-                    val width = ceil(layoutResult.size.width * scale).roundToInt()
-                    val height = ceil(layoutResult.size.height * scale).roundToInt()
-                    measurable.measure(Constraints.fixed(width, height)).run {
-                        layout(width, height) { place(0, 0) }
-                    }
-                }
-                .drawBehind {
-                    val topLeft: Offset
-                    val pivot: Offset
-                    if (layoutDirection == LayoutDirection.Ltr) {
-                        topLeft = Offset.Zero
-                        pivot = Offset.Zero
-                    } else {
-                        topLeft = Offset(size.width - layoutResult.size.width, 0f)
-                        pivot = Offset(size.width, 0f)
+        Box {
+            Spacer(
+                Modifier.layout { measurable, _ ->
+                        // Layout this element with the *target* size/scale of the element in this
+                        // scene.
+                        val width = ceil(layoutResult.size.width * scale).roundToInt()
+                        val height = ceil(layoutResult.size.height * scale).roundToInt()
+                        measurable.measure(Constraints.fixed(width, height)).run {
+                            layout(width, height) { place(0, 0) }
+                        }
                     }
-
-                    scale(animatedScale, pivot = pivot) {
-                        drawText(layoutResult, color = color, topLeft = topLeft)
+                    .drawBehind {
+                        val topLeft: Offset
+                        val pivot: Offset
+                        if (layoutDirection == LayoutDirection.Ltr) {
+                            topLeft = Offset.Zero
+                            pivot = Offset.Zero
+                        } else {
+                            topLeft = Offset(size.width - layoutResult.size.width, 0f)
+                            pivot = Offset(size.width, 0f)
+                        }
+
+                        scale(animatedScale, pivot = pivot) {
+                            drawText(layoutResult, color = color, topLeft = topLeft)
+                        }
                     }
-                }
-        )
+            )
+        }
     }
 }
 
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitEdgeDetector.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitEdgeDetector.kt
new file mode 100644
index 000000000..d95b888f7
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitEdgeDetector.kt
@@ -0,0 +1,108 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.ui.unit.Density
+import androidx.compose.ui.unit.Dp
+import androidx.compose.ui.unit.IntOffset
+import androidx.compose.ui.unit.IntSize
+import androidx.compose.ui.unit.LayoutDirection
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.FixedSizeEdgeDetector
+import com.android.compose.animation.scene.SwipeSource
+import com.android.compose.animation.scene.SwipeSourceDetector
+
+/**
+ * The edge of a [SceneContainer]. It differs from a standard [Edge] by splitting the top edge into
+ * top-left and top-right.
+ */
+enum class SceneContainerEdge(private val resolveEdge: (LayoutDirection) -> Resolved) :
+    SwipeSource {
+    TopLeft(resolveEdge = { Resolved.TopLeft }),
+    TopRight(resolveEdge = { Resolved.TopRight }),
+    TopStart(
+        resolveEdge = { if (it == LayoutDirection.Ltr) Resolved.TopLeft else Resolved.TopRight }
+    ),
+    TopEnd(
+        resolveEdge = { if (it == LayoutDirection.Ltr) Resolved.TopRight else Resolved.TopLeft }
+    ),
+    Bottom(resolveEdge = { Resolved.Bottom }),
+    Left(resolveEdge = { Resolved.Left }),
+    Right(resolveEdge = { Resolved.Right }),
+    Start(resolveEdge = { if (it == LayoutDirection.Ltr) Resolved.Left else Resolved.Right }),
+    End(resolveEdge = { if (it == LayoutDirection.Ltr) Resolved.Right else Resolved.Left });
+
+    override fun resolve(layoutDirection: LayoutDirection): Resolved {
+        return resolveEdge(layoutDirection)
+    }
+
+    enum class Resolved : SwipeSource.Resolved {
+        TopLeft,
+        TopRight,
+        Bottom,
+        Left,
+        Right,
+    }
+}
+
+/**
+ * A [SwipeSourceDetector] that detects edges similarly to [FixedSizeEdgeDetector], except that the
+ * top edge is split in two: top-left and top-right. The split point between the two is dynamic and
+ * may change during runtime.
+ *
+ * Callers who need to detect the start and end edges based on the layout direction (LTR vs RTL)
+ * should subscribe to [SceneContainerEdge.TopStart] and [SceneContainerEdge.TopEnd] instead. These
+ * will be resolved at runtime to [SceneContainerEdge.Resolved.TopLeft] and
+ * [SceneContainerEdge.Resolved.TopRight] appropriately. Similarly, [SceneContainerEdge.Start] and
+ * [SceneContainerEdge.End] will be resolved appropriately to [SceneContainerEdge.Resolved.Left] and
+ * [SceneContainerEdge.Resolved.Right].
+ *
+ * @param topEdgeSplitFraction A function which returns the fraction between [0..1] (i.e.,
+ *   percentage) of screen width to consider the split point between "top-left" and "top-right"
+ *   edges. It is called on each source detection event.
+ * @param edgeSize The fixed size of each edge.
+ */
+class SplitEdgeDetector(val topEdgeSplitFraction: () -> Float, val edgeSize: Dp) :
+    SwipeSourceDetector {
+
+    private val fixedEdgeDetector = FixedSizeEdgeDetector(edgeSize)
+
+    override fun source(
+        layoutSize: IntSize,
+        position: IntOffset,
+        density: Density,
+        orientation: Orientation,
+    ): SceneContainerEdge.Resolved? {
+        val fixedEdge = fixedEdgeDetector.source(layoutSize, position, density, orientation)
+        return when (fixedEdge) {
+            Edge.Resolved.Top -> {
+                val topEdgeSplitFraction = topEdgeSplitFraction()
+                require(topEdgeSplitFraction in 0f..1f) {
+                    "topEdgeSplitFraction must return a value between 0.0 and 1.0"
+                }
+                val isLeftSide = position.x < layoutSize.width * topEdgeSplitFraction
+                if (isLeftSide) SceneContainerEdge.Resolved.TopLeft
+                else SceneContainerEdge.Resolved.TopRight
+            }
+            Edge.Resolved.Left -> SceneContainerEdge.Resolved.Left
+            Edge.Resolved.Bottom -> SceneContainerEdge.Resolved.Bottom
+            Edge.Resolved.Right -> SceneContainerEdge.Resolved.Right
+            null -> null
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt
index e84eb5a38..b11a5e694 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt
@@ -18,6 +18,7 @@ package com.android.compose.animation.scene.demo
 
 import android.content.Context
 import androidx.activity.compose.BackHandler
+import androidx.compose.foundation.OverscrollEffect
 import androidx.compose.foundation.background
 import androidx.compose.foundation.border
 import androidx.compose.foundation.clickable
@@ -70,11 +71,13 @@ import androidx.compose.runtime.setValue
 import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.draw.clip
+import androidx.compose.ui.graphics.Color
 import androidx.compose.ui.graphics.toComposeRect
 import androidx.compose.ui.graphics.vector.ImageVector
 import androidx.compose.ui.platform.LocalConfiguration
 import androidx.compose.ui.platform.LocalContext
 import androidx.compose.ui.platform.LocalDensity
+import androidx.compose.ui.platform.LocalHapticFeedback
 import androidx.compose.ui.platform.testTag
 import androidx.compose.ui.semantics.semantics
 import androidx.compose.ui.semantics.testTagsAsResourceId
@@ -169,7 +172,6 @@ class MutableSceneTransitionLayoutSaver(
     private val sceneSaver: Scenes.SceneSaver,
     private val transitions: SceneTransitions,
     private val canChangeScene: (SceneKey) -> Boolean,
-    private val enableInterruptions: Boolean,
 ) : Saver<MutableSceneTransitionLayoutState, String> {
     override fun SaverScope.save(state: MutableSceneTransitionLayoutState): String {
         val currentScene = state.transitionState.currentScene
@@ -182,7 +184,6 @@ class MutableSceneTransitionLayoutSaver(
             currentScene,
             transitions,
             canChangeScene = canChangeScene,
-            enableInterruptions = enableInterruptions,
         )
     }
 }
@@ -219,8 +220,8 @@ fun SystemUi(
         launcherColumns = 4
     }
 
-    val notificationCount =
-        max(configuration.notificationsInLockscreen, configuration.notificationsInShade)
+    val notificationCountInLockscreen = configuration.notificationsInLockscreen
+    val notificationCount = max(notificationCountInLockscreen, configuration.notificationsInShade)
     val interactiveNotifications = configuration.interactiveNotifications
     val notificationSprings = configuration.springConfigurations.notificationSprings
     val notificationTextMeasurer = rememberTextMeasurer(cacheSize = notificationCount * 2)
@@ -228,12 +229,14 @@ fun SystemUi(
         remember(
             interactiveNotifications,
             notificationCount,
+            notificationCountInLockscreen,
             notificationSprings,
             notificationTextMeasurer,
         ) {
             notifications(
                 interactiveNotifications,
                 notificationCount,
+                notificationCountInLockscreen,
                 notificationSprings,
                 notificationTextMeasurer,
             )
@@ -248,19 +251,22 @@ fun SystemUi(
     var showConfigurationDialog by remember { mutableStateOf(false) }
 
     val nQuickSettingsColumns =
-        when (windowSizeClass.widthSizeClass) {
-            WindowWidthSizeClass.Compact -> 2
-            WindowWidthSizeClass.Medium,
-            WindowWidthSizeClass.Expanded ->
-                when (windowSizeClass.heightSizeClass) {
-                    // Phone landscape.
-                    WindowHeightSizeClass.Compact -> 2
-                    else -> 3
-                }
-            else -> error("Unknown size class: ${windowSizeClass.widthSizeClass}")
+        if (configuration.enableOverlays) {
+            2
+        } else {
+            when (windowSizeClass.widthSizeClass) {
+                WindowWidthSizeClass.Compact -> 2
+                WindowWidthSizeClass.Medium,
+                WindowWidthSizeClass.Expanded ->
+                    when (windowSizeClass.heightSizeClass) {
+                        // Phone landscape.
+                        WindowHeightSizeClass.Compact -> 2
+                        else -> 3
+                    }
+                else -> error("Unknown size class: ${windowSizeClass.widthSizeClass}")
+            }
         }
-
-    val nQuickSettingsRow = 4
+    val nQuickSettingsRow = configuration.quickSettingsRows
     val nQuickSettingsSplitShadeRows = nQuickSettingsColumns
 
     // The state of the quick settings pager in the phone (one column) layout.
@@ -273,11 +279,17 @@ fun SystemUi(
     val quickSettingsPagerState = rememberPagerState { nQuickSettingsPages }
 
     val springConfiguration = configuration.springConfigurations.systemUiSprings
+    val hapticFeedback = LocalHapticFeedback.current
+    val revealHaptics = remember(hapticFeedback) { DemoContainerRevealHaptics(hapticFeedback) }
     val transitions =
         remember(quickSettingsPagerState, springConfiguration, configuration) {
-            systemUiTransitions(quickSettingsPagerState, springConfiguration, configuration)
+            systemUiTransitions(
+                quickSettingsPagerState,
+                springConfiguration,
+                configuration,
+                revealHaptics,
+            )
         }
-    val enableInterruptions = configuration.enableInterruptions
 
     val sceneSaver =
         remember(lockscreenScene, shadeScene) { Scenes.SceneSaver(lockscreenScene, shadeScene) }
@@ -303,22 +315,11 @@ fun SystemUi(
         }
 
     val stateSaver =
-        remember(sceneSaver, transitions, canChangeScene, enableInterruptions) {
-            MutableSceneTransitionLayoutSaver(
-                sceneSaver,
-                transitions,
-                canChangeScene,
-                enableInterruptions,
-            )
+        remember(sceneSaver, transitions, canChangeScene) {
+            MutableSceneTransitionLayoutSaver(sceneSaver, transitions, canChangeScene)
         }
     val layoutState =
-        rememberSaveable(
-            transitions,
-            canChangeScene,
-            enableInterruptions,
-            configuration,
-            saver = stateSaver,
-        ) {
+        rememberSaveable(transitions, canChangeScene, configuration, saver = stateSaver) {
             val initialScene =
                 initialScene?.let {
                     Scenes.ensureCorrectScene(
@@ -335,7 +336,6 @@ fun SystemUi(
                 canShowOverlay = { configuration.canChangeSceneOrOverlays },
                 canHideOverlay = { configuration.canChangeSceneOrOverlays },
                 canReplaceOverlay = { _, _ -> configuration.canChangeSceneOrOverlays },
-                enableInterruptions = enableInterruptions,
             )
         }
 
@@ -371,8 +371,18 @@ fun SystemUi(
     }
 
     @Composable
-    fun SceneScope.NotificationList(maxNotificationCount: Int) {
-        NotificationList(notifications, maxNotificationCount, configuration)
+    fun SceneScope.NotificationList(
+        maxNotificationCount: Int,
+        isScrollable: Boolean = true,
+        overscrollEffect: OverscrollEffect? = null,
+    ) {
+        NotificationList(
+            notifications = notifications,
+            maxNotificationCount = maxNotificationCount,
+            demoConfiguration = configuration,
+            isScrollable = isScrollable,
+            overscrollEffect = overscrollEffect,
+        )
     }
 
     if (showConfigurationDialog) {
@@ -431,7 +441,19 @@ fun SystemUi(
 
         Box(
             Modifier.thenIf(!configuration.isFullscreen) {
-                    Modifier.padding(3.dp).border(1.dp, borderColor, shape).clip(shape)
+                    Modifier.padding(3.dp)
+                        .then(
+                            if (configuration.transitionBorder) {
+                                Modifier.border(
+                                    5.dp,
+                                    if (layoutState.isTransitioning()) Color.Red else Color.Green,
+                                    shape,
+                                )
+                            } else {
+                                Modifier.border(1.dp, borderColor, shape)
+                            }
+                        )
+                        .clip(shape)
                 }
                 .background(MaterialTheme.colorScheme.surfaceVariant)
         ) {
@@ -451,6 +473,15 @@ fun SystemUi(
                         null
                     }
 
+                val qsPager: (@Composable SceneScope.() -> Unit) = {
+                    QuickSettingsPager(
+                        pagerState = quickSettingsPagerState,
+                        tiles = quickSettingsTiles,
+                        nRows = nQuickSettingsRow,
+                        nColumns = nQuickSettingsColumns,
+                    )
+                }
+
                 // SceneTransitionLayout can only be bound to one SceneTransitionLayoutState, so
                 // make sure we recompose it fully when we create a new state object.
                 key(layoutState) {
@@ -463,8 +494,16 @@ fun SystemUi(
                             Modifier.semantics { testTagsAsResourceId = true }
                                 .testTag("SystemUiSceneTransitionLayout"),
                         swipeSourceDetector =
-                            if (configuration.enableOverlays) HorizontalHalfScreenDetector
-                            else DefaultEdgeDetector,
+                            if (configuration.enableOverlays) {
+                                remember {
+                                    SplitEdgeDetector(
+                                        topEdgeSplitFraction = { 0.5f },
+                                        edgeSize = 60.dp,
+                                    )
+                                }
+                            } else {
+                                DefaultEdgeDetector
+                            },
                     ) {
                         scene(Scenes.Launcher, Launcher.userActions(shadeScene, configuration)) {
                             Launcher(launcherColumns)
@@ -552,10 +591,7 @@ fun SystemUi(
                             ),
                         ) {
                             QuickSettings(
-                                quickSettingsPagerState,
-                                quickSettingsTiles,
-                                nQuickSettingsRow,
-                                nQuickSettingsColumns,
+                                qsPager,
                                 mediaPlayer,
                                 ::onSettingsButtonClicked,
                                 ::onPowerButtonClicked,
@@ -566,9 +602,10 @@ fun SystemUi(
                             Shade.userActions(isLockscreenDismissed, lockscreenScene),
                         ) {
                             Shade(
-                                notificationList = {
+                                notificationList = { overscrollEffect ->
                                     NotificationList(
-                                        maxNotificationCount = configuration.notificationsInShade
+                                        maxNotificationCount = configuration.notificationsInShade,
+                                        overscrollEffect = overscrollEffect,
                                     )
                                 },
                                 mediaPlayer,
@@ -599,6 +636,14 @@ fun SystemUi(
                             AlwaysOnDisplay(Modifier.clickable { onChangeScene(lockscreenScene) })
                         }
 
+                        overlay(
+                            Overlays.QuickSettings,
+                            userActions = QuickSettingsShade.UserActions,
+                            alignment = Alignment.TopEnd,
+                        ) {
+                            QuickSettingsShade(qsPager, mediaPlayer)
+                        }
+
                         overlay(
                             Overlays.Notifications,
                             userActions = NotificationShade.UserActions,
@@ -607,18 +652,12 @@ fun SystemUi(
                             NotificationShade(
                                 notificationList = {
                                     NotificationList(
-                                        maxNotificationCount = configuration.notificationsInShade
+                                        maxNotificationCount = configuration.notificationsInShade,
+                                        isScrollable = false,
                                     )
                                 }
                             )
                         }
-                        overlay(
-                            Overlays.QuickSettings,
-                            userActions = QuickSettingsShade.UserActions,
-                            alignment = Alignment.TopStart,
-                        ) {
-                            QuickSettingsShade(mediaPlayer)
-                        }
                     }
                 }
             }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt
index 799978227..ac91118de 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt
@@ -29,17 +29,23 @@ import com.android.compose.animation.scene.content.state.TransitionState
 import com.android.compose.animation.scene.demo.Overlays
 import com.android.compose.animation.scene.demo.Scenes
 import com.android.compose.animation.scene.demo.SpringConfiguration
+import com.android.compose.animation.scene.demo.transitions.QuickSettingsToNotificationShadeFadeProgress
+import com.android.compose.animation.scene.demo.transitions.ToNotificationShadeStartFadeProgress
 import com.android.compose.animation.scene.demo.transitions.ToShadeScrimFadeEndFraction
 import com.android.compose.animation.scene.demo.transitions.ToSplitShadeOpaqueBackgroundProgress
 
 fun notifications(
     isInteractive: Boolean,
     n: Int,
+    nInLockscreen: Int,
     springConfiguration: SpringConfiguration,
     textMeasurer: TextMeasurer,
 ): List<NotificationViewModel> {
     val transitions = NotificationContent.transitions(springConfiguration)
-    return List(n) { notification(isInteractive, it + 1, transitions, textMeasurer) }
+    return List(n) { i ->
+        val shownInLockscreen = i <= nInLockscreen - 1
+        notification(isInteractive, i + 1, transitions, textMeasurer, shownInLockscreen)
+    }
 }
 
 private fun notification(
@@ -47,13 +53,17 @@ private fun notification(
     i: Int,
     transitions: SceneTransitions,
     textMeasurer: TextMeasurer,
-    key: MovableElementKey =
+    shownInLockscreen: Boolean,
+): NotificationViewModel {
+    val key =
         MovableElementKey(
             "Notification:$i",
             identity = NotificationIdentity(),
-            contentPicker = NotificationContentPicker,
-        ),
-): NotificationViewModel {
+            contentPicker =
+                if (shownInLockscreen) NotificationThatCanBeOnLockscreenPicker
+                else NotificationOnlyInShadePicker,
+        )
+
     return object : NotificationViewModel {
         override val key: MovableElementKey = key
         override val state: MutableSceneTransitionLayoutState =
@@ -70,7 +80,20 @@ private fun notification(
     }
 }
 
-private object NotificationContentPicker : StaticElementContentPicker {
+private object NotificationOnlyInShadePicker : StaticElementContentPicker {
+    override val contents = setOf(Scenes.Shade, Scenes.SplitShade, Overlays.Notifications)
+
+    override fun contentDuringTransition(
+        element: ElementKey,
+        transition: TransitionState.Transition,
+        fromContentZIndex: Float,
+        toContentZIndex: Float,
+    ): ContentKey {
+        return pickSingleContentIn(contents, transition, element)
+    }
+}
+
+private object NotificationThatCanBeOnLockscreenPicker : StaticElementContentPicker {
     override val contents =
         setOf(
             Scenes.Lockscreen,
@@ -86,29 +109,72 @@ private object NotificationContentPicker : StaticElementContentPicker {
         fromContentZIndex: Float,
         toContentZIndex: Float,
     ): ContentKey {
-        return when {
-            transition.isTransitioning(from = Scenes.Lockscreen, to = Scenes.Shade) -> Scenes.Shade
-            transition.isTransitioning(from = Scenes.Shade, to = Scenes.Lockscreen) -> {
+        fun handleLockscreenShadeTransition(
+            lockscreen: ContentKey,
+            shade: ContentKey,
+            toShadeOpaqueProgress: Float,
+        ): ContentKey? {
+            if (transition.isTransitioning(from = lockscreen, to = shade)) {
+                return shade
+            }
+
+            if (transition.isTransitioning(from = shade, to = lockscreen)) {
                 // From Shade to Lockscreen the shared element animation is disabled, so we first
                 // show the notification in the shade/scrim as long as the scrim is opaque, then we
                 // show them in the lockscreen once the scrim fades out.
-                if (transition.progress < 1f - ToShadeScrimFadeEndFraction) {
-                    Scenes.Shade
+                return if (transition.progress < 1f - toShadeOpaqueProgress) {
+                    shade
                 } else {
-                    Scenes.Lockscreen
+                    lockscreen
                 }
             }
-            transition.isTransitioning(from = Scenes.SplitLockscreen, to = Scenes.SplitShade) ->
-                Scenes.SplitShade
-            transition.isTransitioning(from = Scenes.SplitShade, to = Scenes.SplitLockscreen) -> {
-                if (transition.progress < 1f - ToSplitShadeOpaqueBackgroundProgress) {
-                    Scenes.SplitShade
-                } else {
-                    Scenes.SplitLockscreen
-                }
+
+            return null
+        }
+
+        fun handleNotificationToQsOverLockscreen(): ContentKey? {
+            if (
+                !transition.isTransitioningBetween(
+                    Overlays.QuickSettings,
+                    Overlays.Notifications,
+                ) ||
+                    (transition.currentScene != Scenes.Lockscreen &&
+                        transition.currentScene != Scenes.SplitLockscreen)
+            ) {
+                return null
+            }
+
+            return if (
+                transition.progressTo(Overlays.Notifications) >=
+                    QuickSettingsToNotificationShadeFadeProgress
+            ) {
+                Overlays.Notifications
+            } else {
+                transition.currentScene
             }
-            transition.isTransitioningFromOrTo(Overlays.Notifications) -> Overlays.Notifications
-            else -> pickSingleContentIn(contents, transition, element)
         }
+
+        return handleLockscreenShadeTransition(
+            Scenes.Lockscreen,
+            Scenes.Shade,
+            ToShadeScrimFadeEndFraction,
+        )
+            ?: handleLockscreenShadeTransition(
+                Scenes.SplitLockscreen,
+                Scenes.SplitShade,
+                ToSplitShadeOpaqueBackgroundProgress,
+            )
+            ?: handleLockscreenShadeTransition(
+                Scenes.Lockscreen,
+                Overlays.Notifications,
+                ToNotificationShadeStartFadeProgress,
+            )
+            ?: handleLockscreenShadeTransition(
+                Scenes.SplitLockscreen,
+                Overlays.Notifications,
+                ToNotificationShadeStartFadeProgress,
+            )
+            ?: handleNotificationToQsOverLockscreen()
+            ?: pickSingleContentIn(contents, transition, element)
     }
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt
index 075f6cfa1..783b37717 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt
@@ -33,7 +33,6 @@ import androidx.compose.ui.unit.Dp
 import androidx.compose.ui.unit.dp
 import com.android.compose.animation.scene.MovableElementKey
 import com.android.compose.animation.scene.MutableSceneTransitionLayoutState
-import com.android.compose.animation.scene.NestedScrollBehavior
 import com.android.compose.animation.scene.SceneKey
 import com.android.compose.animation.scene.SceneScope
 import com.android.compose.animation.scene.SceneTransitionLayout
@@ -106,20 +105,16 @@ internal fun SceneScope.Notification(
                     Modifier.fillMaxWidth()
                         .notificationClip(remember { Path() }, { topRadius }, { bottomRadius })
                         .thenIf(isInteractive) {
-                            Modifier.verticalNestedScrollToScene(
-                                    topBehavior = NestedScrollBehavior.EdgeWithPreview,
-                                    bottomBehavior = NestedScrollBehavior.EdgeWithPreview,
+                            Modifier.verticalNestedScrollToScene().clickable {
+                                viewModel.state.setTargetScene(
+                                    when (viewModel.state.transitionState.currentScene) {
+                                        Notification.Scenes.Expanded ->
+                                            Notification.Scenes.Collapsed
+                                        else -> Notification.Scenes.Expanded
+                                    },
+                                    coroutineScope,
                                 )
-                                .clickable {
-                                    viewModel.state.setTargetScene(
-                                        when (viewModel.state.transitionState.currentScene) {
-                                            Notification.Scenes.Expanded ->
-                                                Notification.Scenes.Collapsed
-                                            else -> Notification.Scenes.Expanded
-                                        },
-                                        coroutineScope,
-                                    )
-                                }
+                            }
                         }
                         .background(backgroundColor),
                 ) {
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt
index d5b5e5e66..52b2f7d4b 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt
@@ -16,12 +16,14 @@
 
 package com.android.compose.animation.scene.demo.notification
 
+import androidx.compose.foundation.OverscrollEffect
 import androidx.compose.foundation.layout.Arrangement
 import androidx.compose.foundation.layout.Column
 import androidx.compose.foundation.layout.fillMaxWidth
 import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.rememberScrollState
 import androidx.compose.foundation.verticalScroll
+import androidx.compose.foundation.withoutVisualEffect
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.LaunchedEffect
 import androidx.compose.runtime.key
@@ -36,6 +38,7 @@ import com.android.compose.animation.scene.SceneTransitionLayoutState
 import com.android.compose.animation.scene.demo.DemoConfiguration
 import com.android.compose.animation.scene.demo.Scenes
 import com.android.compose.animation.scene.observableTransitionState
+import com.android.compose.modifiers.thenIf
 import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.flow.combine
 import kotlinx.coroutines.flow.filter
@@ -57,6 +60,8 @@ fun SceneScope.NotificationList(
     maxNotificationCount: Int?,
     demoConfiguration: DemoConfiguration,
     modifier: Modifier = Modifier,
+    isScrollable: Boolean = true,
+    overscrollEffect: OverscrollEffect? = null,
 ) {
     if (demoConfiguration.interactiveNotifications) {
         ExpandFirstNotificationWhenSwipingFromLockscreenToShade(notifications)
@@ -66,9 +71,15 @@ fun SceneScope.NotificationList(
     // SceneTransitionLayout bounds.
     // TODO(b/291025415): Make sure everything still works when using `LazyColumn` instead of a
     // scrollable `Column`.
-    val scrollState = rememberScrollState()
+    val scrollState = if (isScrollable) rememberScrollState() else null
+
     Column(
-        modifier.verticalScroll(scrollState).fillMaxWidth().padding(16.dp),
+        modifier
+            .thenIf(scrollState != null) {
+                Modifier.verticalScroll(scrollState!!, overscrollEffect?.withoutVisualEffect())
+            }
+            .fillMaxWidth()
+            .padding(16.dp),
         verticalArrangement = Arrangement.spacedBy(2.dp),
     ) {
         val n = maxNotificationCount ?: notifications.size
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt
index 9977edada..5a5e9fb25 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt
@@ -24,8 +24,6 @@ import com.android.compose.animation.scene.demo.Scenes
 
 fun SceneTransitionsBuilder.bouncerTransitions(configuration: DemoConfiguration) {
     if (configuration.useOverscrollSpec) {
-        overscroll(Scenes.Bouncer, Orientation.Vertical) {
-            translate(Bouncer.Elements.Content, y = { absoluteDistance })
-        }
+        overscrollDisabled(Scenes.Bouncer, Orientation.Vertical)
     }
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt
index d59cc8e2e..e10d63c06 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt
@@ -48,13 +48,9 @@ fun SceneTransitionsBuilder.lockscreenTransitions(configuration: DemoConfigurati
     if (configuration.useOverscrollSpec) {
         overscrollDisabled(Scenes.Lockscreen, Orientation.Vertical)
 
-        overscroll(Scenes.StubStart, Orientation.Horizontal) {
-            translate(Stub.Elements.TextStart, x = { absoluteDistance })
-        }
+        overscrollDisabled(Scenes.StubStart, Orientation.Horizontal)
 
-        overscroll(Scenes.StubEnd, Orientation.Horizontal) {
-            translate(Stub.Elements.TextEnd, x = { absoluteDistance })
-        }
+        overscrollDisabled(Scenes.StubEnd, Orientation.Horizontal)
     }
 }
 
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt
index e5c37aa2a..a2ae635c9 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt
@@ -18,35 +18,46 @@ package com.android.compose.animation.scene.demo.transitions
 
 import androidx.compose.animation.core.tween
 import androidx.compose.foundation.gestures.Orientation
-import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.BaseTransitionBuilder
 import com.android.compose.animation.scene.SceneTransitionsBuilder
 import com.android.compose.animation.scene.TransitionBuilder
-import com.android.compose.animation.scene.demo.NotificationShade
 import com.android.compose.animation.scene.demo.Overlays
+import com.android.compose.animation.scene.demo.PartialShade
 import com.android.compose.animation.scene.demo.notification.NotificationList
+import com.android.compose.animation.scene.reveal.ContainerRevealHaptics
+import com.android.compose.animation.scene.reveal.verticalContainerReveal
 
-fun SceneTransitionsBuilder.notificationShadeTransitions() {
+fun SceneTransitionsBuilder.notificationShadeTransitions(revealHaptics: ContainerRevealHaptics) {
     to(Overlays.Notifications) {
         spec = tween(500)
-        toNotificationShade()
+        toNotificationShade(revealHaptics)
+        sharedElement(
+            NotificationList.Elements.Notifications,
+            elevateInContent = Overlays.Notifications,
+        )
     }
 
     from(Overlays.Notifications) {
         spec = tween(500)
-        reversed { toNotificationShade() }
+        reversed { toNotificationShade(revealHaptics) }
         sharedElement(NotificationList.Elements.Notifications, enabled = false)
     }
 
-    overscroll(Overlays.Notifications, Orientation.Vertical) {
-        translate(NotificationShade.Elements.Root, y = { absoluteDistance })
-    }
+    overscrollDisabled(Overlays.Notifications, Orientation.Vertical)
 
-    overscroll(Overlays.Notifications, Orientation.Horizontal) {
-        translate(NotificationShade.Elements.Root, x = { absoluteDistance })
-    }
+    overscrollDisabled(Overlays.Notifications, Orientation.Horizontal)
+}
+
+val ToNotificationShadeStartFadeProgress = 0.5f
+
+private fun TransitionBuilder.toNotificationShade(revealHaptics: ContainerRevealHaptics) {
+    verticalContainerReveal(PartialShade.Elements.Root, revealHaptics)
 }
 
-private fun TransitionBuilder.toNotificationShade() {
-    translate(NotificationShade.Elements.Root, Edge.Top)
-    fractionRange(start = 0.5f) { fade(NotificationList.Elements.Notifications) }
+fun BaseTransitionBuilder.notifyStlThatShadeDoesNotResizeDuringThisTransition() {
+    // Let STL know that the shade and its background are not expected to change during this
+    // transition. This allows better handling of the size during interruptions. See
+    // b/290930950#comment22 for details.
+    scaleSize(PartialShade.Elements.Root, width = 1f, height = 1f)
+    scaleSize(PartialShade.Elements.Background, width = 1f, height = 1f)
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt
index ee83dd86e..713ebad89 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt
@@ -18,41 +18,61 @@ package com.android.compose.animation.scene.demo.transitions
 
 import androidx.compose.animation.core.tween
 import androidx.compose.foundation.gestures.Orientation
-import com.android.compose.animation.scene.Edge
 import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.and
 import com.android.compose.animation.scene.demo.Clock
 import com.android.compose.animation.scene.demo.MediaPlayer
-import com.android.compose.animation.scene.demo.NotificationShade
 import com.android.compose.animation.scene.demo.Overlays
 import com.android.compose.animation.scene.demo.PartialShade
-import com.android.compose.animation.scene.demo.QuickSettingsShade
+import com.android.compose.animation.scene.demo.QuickSettings
+import com.android.compose.animation.scene.demo.QuickSettingsGrid
+import com.android.compose.animation.scene.demo.Scenes
 import com.android.compose.animation.scene.demo.notification.NotificationList
+import com.android.compose.animation.scene.inContent
+import com.android.compose.animation.scene.or
+import com.android.compose.animation.scene.reveal.ContainerRevealHaptics
+import com.android.compose.animation.scene.reveal.verticalContainerReveal
 
-fun SceneTransitionsBuilder.quickSettingsShadeTransitions() {
+val QuickSettingsToNotificationShadeFadeProgress = 0.5f
+
+fun SceneTransitionsBuilder.quickSettingsShadeTransitions(revealHaptics: ContainerRevealHaptics) {
     to(Overlays.QuickSettings) {
         spec = tween(500)
-        translate(QuickSettingsShade.Elements.Root, Edge.Top)
+
+        sharedElement(MediaPlayer.Elements.MediaPlayer, elevateInContent = Overlays.QuickSettings)
+        sharedElement(Clock.Elements.Clock, elevateInContent = Overlays.QuickSettings)
+
+        verticalContainerReveal(PartialShade.Elements.Root, revealHaptics)
     }
 
     from(Overlays.QuickSettings, to = Overlays.Notifications) {
         spec = tween(500)
 
-        anchoredTranslate(NotificationShade.Elements.Content, PartialShade.Elements.Background)
-        anchoredTranslate(QuickSettingsShade.Elements.Content, PartialShade.Elements.Background)
+        // Don't share the notifications with lockscreen when replacing the notification shade with
+        // the QS one.
+        sharedElement(NotificationList.Elements.Notifications, enabled = false)
+
+        // Elevate the media player so that they are not clipped when shared with the split
+        // lockscreen.
+        sharedElement(MediaPlayer.Elements.MediaPlayer, elevateInContent = Overlays.QuickSettings)
+        sharedElement(Clock.Elements.Clock, elevateInContent = Overlays.QuickSettings)
 
-        fractionRange(end = 0.5f) {
+        fractionRange(end = QuickSettingsToNotificationShadeFadeProgress) {
             fade(MediaPlayer.Elements.MediaPlayer)
             fade(Clock.Elements.Clock)
+            fade(QuickSettingsGrid.Elements.Tiles)
+            fade(QuickSettings.Elements.PagerIndicators)
+            fade(
+                NotificationList.Elements.Notifications and
+                    (inContent(Scenes.Lockscreen) or inContent(Scenes.SplitLockscreen))
+            )
+        }
+        fractionRange(start = QuickSettingsToNotificationShadeFadeProgress) {
+            fade(NotificationList.Elements.Notifications and inContent(Overlays.Notifications))
         }
-
-        fractionRange(start = 0.5f) { fade(NotificationList.Elements.Notifications) }
     }
 
-    overscroll(Overlays.QuickSettings, Orientation.Vertical) {
-        translate(QuickSettingsShade.Elements.Root, y = { absoluteDistance })
-    }
+    overscrollDisabled(Overlays.QuickSettings, Orientation.Vertical)
 
-    overscroll(Overlays.QuickSettings, Orientation.Horizontal) {
-        translate(QuickSettingsShade.Elements.Root, x = { absoluteDistance })
-    }
+    overscrollDisabled(Overlays.QuickSettings, Orientation.Horizontal)
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt
index e586324ed..4d3e2e76f 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt
@@ -56,10 +56,6 @@ fun SceneTransitionsBuilder.quickSettingsTransitions(configuration: DemoConfigur
     }
 
     if (configuration.useOverscrollSpec) {
-        overscroll(Scenes.QuickSettings, Orientation.Vertical) {
-            translate(QuickSettings.Elements.BrightnessSlider, y = { absoluteDistance })
-            translate(QuickSettings.Elements.ExpandedGrid, y = { absoluteDistance })
-            translate(MediaPlayer.Elements.MediaPlayer, y = { absoluteDistance })
-        }
+        overscrollDisabled(Scenes.QuickSettings, Orientation.Vertical)
     }
 }
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt
index 60638bd4b..950e8ac3f 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt
@@ -19,7 +19,7 @@ package com.android.compose.animation.scene.demo.transitions
 import androidx.compose.animation.core.tween
 import androidx.compose.foundation.gestures.Orientation
 import androidx.compose.foundation.pager.PagerState
-import androidx.compose.ui.unit.IntSize
+import com.android.compose.animation.scene.ContentKey
 import com.android.compose.animation.scene.Edge
 import com.android.compose.animation.scene.SceneTransitionsBuilder
 import com.android.compose.animation.scene.TransitionBuilder
@@ -42,7 +42,8 @@ fun SceneTransitionsBuilder.shadeTransitions(
     val swipeDistance =
         object : UserActionDistance {
             override fun UserActionDistanceScope.absoluteDistance(
-                fromSceneSize: IntSize,
+                fromContent: ContentKey,
+                toContent: ContentKey,
                 orientation: Orientation,
             ): Float {
                 val distance = Shade.Elements.Scrim.targetOffset(Scenes.Shade)?.y ?: return 0f
@@ -87,7 +88,8 @@ fun SceneTransitionsBuilder.shadeTransitions(
     val qsSwipeDistance =
         object : UserActionDistance {
             override fun UserActionDistanceScope.absoluteDistance(
-                fromSceneSize: IntSize,
+                fromContent: ContentKey,
+                toContent: ContentKey,
                 orientation: Orientation,
             ): Float {
                 val scrimOffsetInShade =
@@ -157,9 +159,7 @@ fun SceneTransitionsBuilder.shadeTransitions(
     }
 
     if (configuration.useOverscrollSpec) {
-        overscroll(Scenes.Shade, Orientation.Vertical) {
-            translate(Shade.Elements.Scrim, y = { absoluteDistance })
-        }
+        overscrollDisabled(Scenes.Shade, Orientation.Vertical)
     }
 }
 
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt
index 89dfc41f6..2d7f8a103 100644
--- a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt
@@ -25,12 +25,14 @@ import com.android.compose.animation.scene.content.state.TransitionState
 import com.android.compose.animation.scene.demo.DemoConfiguration
 import com.android.compose.animation.scene.demo.Scenes
 import com.android.compose.animation.scene.demo.SpringConfiguration
+import com.android.compose.animation.scene.reveal.ContainerRevealHaptics
 import com.android.compose.animation.scene.transitions
 
 fun systemUiTransitions(
     qsPagerState: PagerState,
     springConfiguration: SpringConfiguration,
     configuration: DemoConfiguration,
+    revealHaptics: ContainerRevealHaptics,
 ) = transitions {
     interruptionHandler = DemoInterruptionHandler
     defaultSwipeSpec =
@@ -48,8 +50,8 @@ fun systemUiTransitions(
     lockscreenTransitions(configuration)
     bouncerTransitions(configuration)
     launcherTransitions()
-    notificationShadeTransitions()
-    quickSettingsShadeTransitions()
+    notificationShadeTransitions(revealHaptics)
+    quickSettingsShadeTransitions(revealHaptics)
 }
 
 object DemoInterruptionHandler : InterruptionHandler {
diff --git a/samples/VirtualDeviceManager/Android.bp b/samples/VirtualDeviceManager/Android.bp
index dcabd03d2..c24d173f6 100644
--- a/samples/VirtualDeviceManager/Android.bp
+++ b/samples/VirtualDeviceManager/Android.bp
@@ -59,6 +59,7 @@ android_app {
     min_sdk_version: "34",
     srcs: [
         "demos/src/**/*.java",
+        "demos/src/**/*.kt",
     ],
     resource_dirs: [
         "demos/res",
diff --git a/samples/VirtualDeviceManager/README.md b/samples/VirtualDeviceManager/README.md
index 1f4f11c8f..1d1e8a136 100644
--- a/samples/VirtualDeviceManager/README.md
+++ b/samples/VirtualDeviceManager/README.md
@@ -318,6 +318,32 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
     adb shell am force-stop com.example.android.vdmdemo.host
     ```
 
+-   **Display timeout**: Whether to keep the displays always awake or to put
+    them to sleep after a timeout. Run the commands below to enable this
+    functionality. \
+    *Changing this will recreate the virtual device.*
+
+    ```shell
+    adb shell device_config put virtual_devices android.companion.virtualdevice.flags.device_aware_display_power true
+    adb shell am force-stop com.example.android.vdmdemo.host
+    ```
+
+-   **Enable client brightness**: Whether to propagate any brightness changes
+    from the virtual display to the client's display. Run the commands below to
+    enable this functionality. \
+    *This can be changed dynamically but only applies to newly created
+    displays.*
+
+    ```shell
+    adb shell device_config put virtual_devices android.companion.virtualdevice.flags.device_aware_display_power true
+    adb shell am force-stop com.example.android.vdmdemo.host
+    ```
+
+#### Audio
+
+-   **Use AudioPolicy.updateMixingRules**: Updates the dynamic AudiPolicy mixing rules
+    instead of unregistering and re-registering the AudioPolicy.
+
 #### Input method
 
 Note: The virtual keyboard acts like a physically connected keyboard to the host
@@ -390,6 +416,17 @@ keyboard** are forwarded to the activity streamed on the focused display.
 **Externally connected mouse** events are also forwarded to the relevant
 display, if the mouse pointer is currently positioned on a streamed display.
 
+### Power
+
+The power menu button acts as a "virtual power button". It will toggle the state
+of the virtual device and all its displays between ON and OFF.
+Run the commands below on the host device to enable this functionality.
+
+```shell
+adb shell device_config put virtual_devices android.companion.virtual.flags.device_aware_display_power true
+adb shell am force-stop com.example.android.vdmdemo.host
+```
+
 <!-- LINT.ThenChange(README.md) -->
 <!-- LINT.IfChange(demos) -->
 
@@ -435,6 +472,9 @@ display, if the mouse pointer is currently positioned on a streamed display.
 -   **Stylus**: A simple drawing activity that reacts on stylus input events.
     Use together with the simulated stylus input feature of the host app.
 
+-   **Recorder**: A simple activity that can start multiple audio recorders.
+    This helps test audio recording permissions and concurrent recordings.
+
 The demo activity depends on whether the **Display Category** Host preference is
 enabled or not. If enabled, it becomes equivalent to the **Home** demo activity,
 which showcases implicit intent handling.
@@ -443,7 +483,9 @@ which showcases implicit intent handling.
 
 ## SDK Version
 
-### Beyond Android 15
+### Android 16 / Baklava
+
+-   Added support for custom power management.
 
 -   Added support for custom system windows (like status bar) and insets.
 
@@ -461,6 +503,8 @@ which showcases implicit intent handling.
 
 ### Android 15 / Vanilla Ice Cream / SDK level 35
 
+-   Added support for virtual camera.
+
 -   Added support for virtual stylus input.
 
 -   Added support for cross-device clipboard.
diff --git a/samples/VirtualDeviceManager/client/res/drawable/power.xml b/samples/VirtualDeviceManager/client/res/drawable/power.xml
new file mode 100644
index 000000000..6b292e7f0
--- /dev/null
+++ b/samples/VirtualDeviceManager/client/res/drawable/power.xml
@@ -0,0 +1,10 @@
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960"
+    android:tint="?attr/colorControlNormal">
+    <path
+        android:fillColor="@android:color/white"
+        android:pathData="M480,880Q397,880 324,848.5Q251,817 197,763Q143,709 111.5,636Q80,563 80,480Q80,396 111.5,323.5Q143,251 197,197L253,253Q209,297 184.5,355Q160,413 160,480Q160,614 253,707Q346,800 480,800Q614,800 707,707Q800,614 800,480Q800,413 775.5,355Q751,297 707,253L763,197Q817,251 848.5,323.5Q880,396 880,480Q880,563 848.5,636Q817,709 763,763Q709,817 636,848.5Q563,880 480,880ZM440,520L440,80L520,80L520,520L440,520Z"/>
+</vector>
diff --git a/samples/VirtualDeviceManager/client/res/menu/options.xml b/samples/VirtualDeviceManager/client/res/menu/options.xml
index d1c02c437..076f29909 100644
--- a/samples/VirtualDeviceManager/client/res/menu/options.xml
+++ b/samples/VirtualDeviceManager/client/res/menu/options.xml
@@ -7,5 +7,10 @@
         android:icon="@drawable/input"
         android:title="@string/input"
         app:showAsAction="always" />
+    <item
+        android:id="@+id/power"
+        android:icon="@drawable/power"
+        android:title="@string/power"
+        app:showAsAction="always" />
 </menu>
 <!-- LINT.ThenChange(/samples/VirtualDeviceManager/README.md:client_options) -->
diff --git a/samples/VirtualDeviceManager/client/res/values/strings.xml b/samples/VirtualDeviceManager/client/res/values/strings.xml
index 36965fd12..dd94b498c 100644
--- a/samples/VirtualDeviceManager/client/res/values/strings.xml
+++ b/samples/VirtualDeviceManager/client/res/values/strings.xml
@@ -8,4 +8,5 @@
     <string name="display_fullscreen" translatable="false">Fullscreen</string>
     <string name="display_close" translatable="false">Close</string>
     <string name="input" translatable="false">Input</string>
+    <string name="power" translatable="false">Power</string>
 </resources>
diff --git a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
index 854f7cfd0..9df418a82 100644
--- a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
+++ b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
@@ -26,6 +26,7 @@ import android.view.Menu;
 import android.view.MenuInflater;
 import android.view.MenuItem;
 import android.view.View;
+import android.view.WindowManager;
 import android.view.inputmethod.InputMethodManager;
 
 import androidx.activity.result.ActivityResultLauncher;
@@ -40,6 +41,7 @@ import com.example.android.vdmdemo.common.ConnectionManager;
 import com.example.android.vdmdemo.common.DpadFragment;
 import com.example.android.vdmdemo.common.NavTouchpadFragment;
 import com.example.android.vdmdemo.common.RemoteEventProto.DeviceCapabilities;
+import com.example.android.vdmdemo.common.RemoteEventProto.DeviceState;
 import com.example.android.vdmdemo.common.RemoteEventProto.InputDeviceType;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
 import com.example.android.vdmdemo.common.RemoteIo;
@@ -67,6 +69,8 @@ public class MainActivity extends Hilt_MainActivity {
     @Inject AudioPlayer mAudioPlayer;
     @Inject AudioRecorder mAudioRecorder;
 
+    private boolean mPowerOn = false;
+
     private final Consumer<RemoteEvent> mRemoteEventConsumer = this::processRemoteEvent;
     private DisplayAdapter mDisplayAdapter;
     private InputMethodManager mInputMethodManager;
@@ -209,6 +213,7 @@ public class MainActivity extends Hilt_MainActivity {
     public boolean onOptionsItemSelected(MenuItem item) {
         switch (item.getItemId()) {
             case R.id.input -> toggleInputVisibility();
+            case R.id.power -> togglePowerState();
             default -> {
                 return super.onOptionsItemSelected(item);
             }
@@ -235,6 +240,10 @@ public class MainActivity extends Hilt_MainActivity {
                 mInputMethodManager.hideSoftInputFromWindow(
                         getWindow().getDecorView().getWindowToken(), 0);
             }
+        } else if (event.hasDeviceState()) {
+            mPowerOn = event.getDeviceState().getPowerOn();
+        } else if (event.hasBrightnessEvent()) {
+            runOnUiThread(() -> setBrightness(event.getBrightnessEvent().getBrightness()));
         }
     }
 
@@ -246,6 +255,20 @@ public class MainActivity extends Hilt_MainActivity {
         requireViewById(R.id.rotary_fragment_container).setVisibility(visibility);
     }
 
+    private void togglePowerState() {
+        mPowerOn = !mPowerOn;
+        mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                .setDeviceState(DeviceState.newBuilder().setPowerOn(mPowerOn))
+                .build());
+
+    }
+
+    private void setBrightness(float brightness) {
+        WindowManager.LayoutParams layout = getWindow().getAttributes();
+        layout.screenBrightness = brightness;
+        getWindow().setAttributes(layout);
+    }
+
     private static boolean hasRecordAudioPermission(Context context) {
         return ContextCompat.checkSelfPermission(context, android.Manifest.permission.RECORD_AUDIO)
                 == PackageManager.PERMISSION_GRANTED;
diff --git a/samples/VirtualDeviceManager/common/proto/remote_event.proto b/samples/VirtualDeviceManager/common/proto/remote_event.proto
index 537af6810..88e496e10 100644
--- a/samples/VirtualDeviceManager/common/proto/remote_event.proto
+++ b/samples/VirtualDeviceManager/common/proto/remote_event.proto
@@ -21,16 +21,18 @@ package com.example.android.vdmdemo.common;
 option java_outer_classname = "RemoteEventProto";
 option java_package = "com.example.android.vdmdemo.common";
 
-// Next ID: 19
+// Next ID: 24
 message RemoteEvent {
   int32 display_id = 1;
 
   oneof event {
     DeviceCapabilities device_capabilities = 2;
+    DeviceState device_state = 22;
     StartStreaming start_streaming = 3;
     StopStreaming stop_streaming = 4;
     DisplayCapabilities display_capabilities = 5;
     DisplayRotation display_rotation = 6;
+    BrightnessEvent brightness_event = 23;
     EncodedFrame display_frame = 7;
     SensorConfiguration sensor_configuration = 8;
     RemoteInputEvent input_event = 9;
@@ -57,6 +59,10 @@ message DeviceCapabilities {
   bool supports_audio_output = 4;
 }
 
+message DeviceState {
+  bool power_on = 1;
+}
+
 message DisplayRotation {
   int32 rotation_degrees = 1;
 }
@@ -111,6 +117,10 @@ message DisplayCapabilities {
   int32 density_dpi = 3;
 }
 
+message BrightnessEvent {
+  float brightness = 1;
+}
+
 message EncodedFrame {
   bytes frame_data = 1;
   int32 frame_index = 2;
diff --git a/samples/VirtualDeviceManager/demos/AndroidManifest.xml b/samples/VirtualDeviceManager/demos/AndroidManifest.xml
index ab5fc50a4..234a146c8 100644
--- a/samples/VirtualDeviceManager/demos/AndroidManifest.xml
+++ b/samples/VirtualDeviceManager/demos/AndroidManifest.xml
@@ -137,6 +137,11 @@
             android:exported="false"
             android:label="@string/turn_screen_on_show_when_locked_activity" />
 
+        <activity
+            android:name=".RecorderDemoActivity"
+            android:exported="true"
+            android:label="@string/recorder_demo" />
+
     </application>
     <!-- LINT.ThenChange(/samples/VirtualDeviceManager/README.md:demos) -->
 </manifest>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
index df0701744..942fadce0 100644
--- a/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
+++ b/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
@@ -69,4 +69,11 @@
         android:onClick="onDemoSelected"
         android:text="@string/stylus_demo" />
 
+    <Button
+        android:id="@+id/recorder_demo"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onDemoSelected"
+        android:text="@string/recorder_demo" />
+
 </LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/recorder_demo_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/recorder_demo_activity.xml
new file mode 100644
index 000000000..f6e65195e
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/res/layout/recorder_demo_activity.xml
@@ -0,0 +1,25 @@
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="wrap_content"
+    android:layout_height="match_parent"
+    android:layout_gravity="center"
+    android:gravity="center"
+    android:orientation="vertical"
+    android:padding="10dp">
+
+    <Button
+        android:id="@+id/first_recorder_button"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:layout_margin="20dp"
+        android:onClick="onFirstButtonClick"
+        android:text="@string/start_record" />
+
+    <Button
+        android:id="@+id/second_recorder_button"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:layout_margin="20dp"
+        android:onClick="onSecondButtonClick"
+        android:text="@string/start_record" />
+
+</LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/values/strings.xml b/samples/VirtualDeviceManager/demos/res/values/strings.xml
index adc209ae9..845297c21 100644
--- a/samples/VirtualDeviceManager/demos/res/values/strings.xml
+++ b/samples/VirtualDeviceManager/demos/res/values/strings.xml
@@ -10,6 +10,7 @@
     <string name="permissions_demo" translatable="false">VDM Permissions Demo</string>
     <string name="latency_demo" translatable="false">VDM Latency Demo</string>
     <string name="stylus_demo" translatable="false">VDM Stylus Demo</string>
+    <string name="recorder_demo" translatable="false">VDM Recorder Demo</string>
 
     <string name="start_opted_out_activity" translatable="false">Start opted out activity</string>
     <string name="start_blocked_activity" translatable="false">Start blocked activity</string>
@@ -47,4 +48,7 @@
     <string name="vibrate" translatable="false">Vibrate</string>
     <string name="perform_haptic_feedback" translatable="false">Perform haptic feedback</string>
     <string name="ringtone_vibration" translatable="false">Ringtone vibration</string>
+
+    <string name="start_record" translatable="false">Start record</string>
+    <string name="stop_record" translatable="false">Stop record</string>
 </resources>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
index 3e9924770..4b73050ec 100644
--- a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
@@ -47,6 +47,7 @@ public class MainActivity extends AppCompatActivity {
             case R.id.vibration_demo -> startActivity(
                     new Intent(this, VibrationDemoActivity.class));
             case R.id.stylus_demo -> startActivity(new Intent(this, StylusDemoActivity.class));
+            case R.id.recorder_demo -> startActivity(new Intent(this, RecorderDemoActivity.class));
         }
     }
 }
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/RecorderDemoActivity.kt b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/RecorderDemoActivity.kt
new file mode 100644
index 000000000..e19594add
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/RecorderDemoActivity.kt
@@ -0,0 +1,226 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.example.android.vdmdemo.demos
+
+import android.Manifest
+import android.annotation.SuppressLint
+import android.content.pm.PackageManager
+import android.graphics.Color
+import android.media.AudioFormat
+import android.media.AudioManager
+import android.media.AudioRecord
+import android.media.AudioRecordingConfiguration
+import android.media.MediaRecorder
+import android.os.Bundle
+import android.util.Log
+import android.view.View
+import android.widget.Button
+import androidx.appcompat.app.AppCompatActivity
+import androidx.core.app.ActivityCompat
+import androidx.core.content.ContextCompat
+
+/**
+ * Demo activity for testing starting and stopping multiple (NUMBER_OF_RECORDERS) recordings. Does
+ * not read nor use the data from the AudioRecorder(s).
+ */
+class RecorderDemoActivity :
+    AppCompatActivity(), ActivityCompat.OnRequestPermissionsResultCallback {
+
+    private var audioManager: AudioManager? = null
+
+    private val recorders = MutableList<AudioRecord?>(NUMBER_OF_RECORDERS) { null }
+
+    private val audioRecordingCallback =
+        object : AudioManager.AudioRecordingCallback() {
+            override fun onRecordingConfigChanged(configs: List<AudioRecordingConfiguration>) {
+                super.onRecordingConfigChanged(configs)
+                Log.d(TAG, "onRecordingConfigChanged with configs: ${configs.map { toLog(it) }}")
+            }
+        }
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+        setContentView(R.layout.recorder_demo_activity)
+
+        audioManager = getSystemService(AudioManager::class.java)
+        audioManager?.registerAudioRecordingCallback(audioRecordingCallback, null)
+    }
+
+    override fun onDestroy() {
+        super.onDestroy()
+
+        for (i in 0 until recorders.size) {
+            recorders[i]?.run {
+                stop()
+                release()
+            }
+            recorders[i] = null
+        }
+        audioManager?.unregisterAudioRecordingCallback(audioRecordingCallback)
+    }
+
+    fun onFirstButtonClick(view: View) {
+        onButtonClick(view as Button, 0 /* first recorder index */)
+    }
+
+    fun onSecondButtonClick(view: View) {
+        onButtonClick(view as Button, 1 /* second recorder index */)
+    }
+
+    private fun onButtonClick(button: Button, index: Int) {
+        if (index < 0 || index > recorders.size) {
+            Log.w(TAG, "Recorder index ($index) out of range (0 - $NUMBER_OF_RECORDERS).")
+            return
+        }
+
+        if (recorders[index] == null) {
+            recorders[index] = createRecorder(index)
+        }
+
+        // can still be null if no permissions are granted
+        recorders[index]?.let {
+            if (toggleRecording(it)) {
+                button.setText(R.string.stop_record)
+                button.setBackgroundColor(Color.RED)
+            } else {
+                button.setText(R.string.start_record)
+                button.setBackgroundColor(Color.GRAY)
+            }
+        }
+    }
+
+    @SuppressLint("MissingPermission")
+    private fun createRecorder(index: Int): AudioRecord? {
+        if (index < 0 || index > RECORDERS_SETTINGS.size) {
+            Log.w(
+                TAG,
+                "Settings for recorder index ($index) out of range (0 - ${RECORDERS_SETTINGS.size}).",
+            )
+            return null
+        }
+
+        if (
+            ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) !=
+                PackageManager.PERMISSION_GRANTED
+        ) {
+            Log.i("TAG", "Requesting RECORD_AUDIO permission from the user...")
+            ActivityCompat.requestPermissions(
+                this,
+                arrayOf(Manifest.permission.RECORD_AUDIO),
+                PERMISSIONS_REQUEST_CODE,
+            )
+            return null
+        } else {
+            with(RECORDERS_SETTINGS[index]) {
+                return AudioRecord(
+                    source,
+                    sampleRate,
+                    channels,
+                    encoding,
+                    AudioRecord.getMinBufferSize(sampleRate, channels, encoding),
+                )
+            }
+        }
+    }
+
+    // Start to record if the AudioRecord is stopped
+    // or stops the recording if the AudioRecord is recording
+    // Returns true if now active and recording, false otherwise
+    private fun toggleRecording(recorder: AudioRecord): Boolean {
+        if (recorder.state != AudioRecord.STATE_INITIALIZED) {
+            Log.w(TAG, "Recorder $recorder is not initialized!")
+            return false
+        }
+
+        if (recorder.recordingState == AudioRecord.RECORDSTATE_RECORDING) {
+            Log.d(TAG, "Stop recording for recorder: $recorder")
+            recorder.stop()
+            return false
+        } else {
+            Log.d(TAG, "Start recording for recorder: $recorder")
+            recorder.startRecording()
+            return true
+        }
+    }
+
+    override fun onRequestPermissionsResult(
+        requestCode: Int,
+        permissions: Array<String>,
+        grantResults: IntArray,
+    ) {
+        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
+
+        if (requestCode == PERMISSIONS_REQUEST_CODE) {
+            if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
+                Log.i("TAG", "RECORD_AUDIO permission granted!")
+            } else {
+                Log.w("TAG", "RECORD_AUDIO permission NOT granted!")
+            }
+        }
+    }
+
+    @SuppressLint("MissingPermission")
+    private fun toLog(config: AudioRecordingConfiguration) =
+        with(config) {
+            "AudioRecordingConfiguration: $this has " +
+                "audioSource: ${this.audioSource} audioDevice: ${this.audioDevice} " +
+                "clientAudioSource: ${this.clientAudioSource} " +
+                "clientAudioSessionId: ${this.clientAudioSessionId} " +
+                "clientEffects: ${this.clientEffects} effects: ${this.effects} " +
+                "isClientSilenced: ${this.isClientSilenced} format: ${this.format}"
+        }
+
+    data class RecorderSettings(
+        val source: Int,
+        val sampleRate: Int,
+        val channels: Int,
+        val encoding: Int,
+    )
+
+    private companion object {
+        const val TAG = "RecorderDemoActivity"
+
+        const val PERMISSIONS_REQUEST_CODE = 99
+        const val NUMBER_OF_RECORDERS = 2
+
+        // some defaults for easy instantiation of AudioRecorder objects
+        const val FIRST_RECORDER_SOURCE = MediaRecorder.AudioSource.MIC
+        const val FIRST_RECORDER_SAMPLE_RATE: Int = 8000
+        const val FIRST_RECORDER_CHANNELS: Int = AudioFormat.CHANNEL_IN_MONO
+        const val FIRST_RECORDER_AUDIO_ENCODING: Int = AudioFormat.ENCODING_PCM_16BIT
+
+        const val SECOND_RECORDER_SOURCE = MediaRecorder.AudioSource.MIC
+        const val SECOND_RECORDER_SAMPLE_RATE: Int = 48000
+        const val SECOND_RECORDER_CHANNELS: Int = AudioFormat.CHANNEL_IN_STEREO
+        const val SECOND_RECORDER_AUDIO_ENCODING: Int = AudioFormat.ENCODING_PCM_16BIT
+
+        private val RECORDERS_SETTINGS =
+            listOf(
+                RecorderSettings(
+                    FIRST_RECORDER_SOURCE,
+                    FIRST_RECORDER_SAMPLE_RATE,
+                    FIRST_RECORDER_CHANNELS,
+                    FIRST_RECORDER_AUDIO_ENCODING,
+                ),
+                RecorderSettings(
+                    SECOND_RECORDER_SOURCE,
+                    SECOND_RECORDER_SAMPLE_RATE,
+                    SECOND_RECORDER_CHANNELS,
+                    SECOND_RECORDER_AUDIO_ENCODING,
+                ),
+            )
+    }
+}
diff --git a/samples/VirtualDeviceManager/host/AndroidManifest.xml b/samples/VirtualDeviceManager/host/AndroidManifest.xml
index 3da57d216..b88d2807f 100644
--- a/samples/VirtualDeviceManager/host/AndroidManifest.xml
+++ b/samples/VirtualDeviceManager/host/AndroidManifest.xml
@@ -36,6 +36,9 @@
     <uses-permission
         android:name="android.permission.ADD_TRUSTED_DISPLAY"
         tools:ignore="ProtectedPermissions" />
+    <uses-permission
+        android:name="android.permission.ADD_MIRROR_DISPLAY"
+        tools:ignore="ProtectedPermissions" />
     <uses-permission
         android:name="android.permission.SUBSCRIBE_TO_KEYGUARD_LOCKED_STATE"
         tools:ignore="ProtectedPermissions" />
@@ -104,13 +107,5 @@
                 android:name="android.view.im"
                 android:resource="@xml/proxy_ime" />
         </service>
-        <service
-            android:name=".NotificationListener"
-            android:exported="false"
-            android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE">
-            <intent-filter>
-                <action android:name="android.service.notification.NotificationListenerService" />
-            </intent-filter>
-        </service>
     </application>
 </manifest>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/host/res/values/arrays.xml b/samples/VirtualDeviceManager/host/res/values/arrays.xml
index 3a9fcd3e5..74c78b3aa 100644
--- a/samples/VirtualDeviceManager/host/res/values/arrays.xml
+++ b/samples/VirtualDeviceManager/host/res/values/arrays.xml
@@ -20,4 +20,15 @@
         <item>1</item>
         <item>2</item>
     </string-array>
-</resources>
\ No newline at end of file
+
+    <string-array translatable="false" name="display_timeout_labels">
+        <item>Always ON</item>
+        <item>5s</item>
+        <item>1m23s</item>
+    </string-array>
+    <string-array translatable="false" name="display_timeouts">
+        <item>0</item>
+        <item>5000</item>
+        <item>123000</item>
+    </string-array>
+</resources>
diff --git a/samples/VirtualDeviceManager/host/res/values/strings.xml b/samples/VirtualDeviceManager/host/res/values/strings.xml
index 0ec16347f..f231a0ea3 100644
--- a/samples/VirtualDeviceManager/host/res/values/strings.xml
+++ b/samples/VirtualDeviceManager/host/res/values/strings.xml
@@ -50,12 +50,15 @@
     <string name="pref_enable_display_rotation" translatable="false">enable_display_rotation</string>
     <string name="pref_enable_display_category" translatable="false">enable_display_category</string>
     <string name="pref_always_unlocked_device" translatable="false">always_unlocked_device</string>
+    <string name="pref_display_timeout" translatable="false">display_timeout</string>
+    <string name="pref_enable_client_brightness" translatable="false">enable_client_brightness</string>
     <string name="pref_show_pointer_icon" translatable="false">show_pointer_icon</string>
     <string name="pref_enable_custom_home" translatable="false">enable_custom_home</string>
     <string name="pref_enable_custom_status_bar" translatable="false">enable_custom_status_bar</string>
     <string name="pref_display_ime_policy" translatable="false">display_ime_policy</string>
     <string name="pref_enable_client_native_ime" translatable="false">enable_client_native_ime</string>
     <string name="pref_record_encoder_output" translatable="false">record_encoder_output</string>
+    <string name="pref_enable_update_audio_policy_mixes" translatable="false">enable_update_mixing_rules</string>
 
     <string name="internal_pref_home_displays_supported" translatable="false">home_displays_supported</string>
     <string name="internal_pref_mirror_displays_supported" translatable="false">mirror_displays_supported</string>
diff --git a/samples/VirtualDeviceManager/host/res/xml/preferences.xml b/samples/VirtualDeviceManager/host/res/xml/preferences.xml
index 16945c3f8..e20bef348 100644
--- a/samples/VirtualDeviceManager/host/res/xml/preferences.xml
+++ b/samples/VirtualDeviceManager/host/res/xml/preferences.xml
@@ -94,6 +94,32 @@
             android:summary="Show a custom status bar on the remote displays."
             android:defaultValue="false"
             app:iconSpaceReserved="false" />
+        <ListPreference
+            android:key="@string/pref_display_timeout"
+            android:title="Display timeout"
+            android:entries="@array/display_timeout_labels"
+            android:entryValues="@array/display_timeouts"
+            android:defaultValue="0"
+            app:useSimpleSummaryProvider="true"
+            app:iconSpaceReserved="false" />
+        <SwitchPreferenceCompat
+            android:key="@string/pref_enable_client_brightness"
+            android:title="Enable client brightness"
+            android:summary="Propagate the virtual display brightness changes to the client display"
+            android:defaultValue="false"
+            app:iconSpaceReserved="false" />
+    </PreferenceCategory>
+
+    <PreferenceCategory
+        android:key="audio"
+        android:title="Audio"
+        app:iconSpaceReserved="false">
+    <SwitchPreferenceCompat
+        android:key="@string/pref_enable_update_audio_policy_mixes"
+        android:title="Use AudioPolicy.updateMixingRules"
+        android:summary="Updates the dynamic AudiPolicy mixing rules instead of unregistering and registering the AudioPolicy."
+        android:defaultValue="true"
+        app:iconSpaceReserved="false" />
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioInjector.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioInjector.java
index ed3549898..058b1adb0 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioInjector.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioInjector.java
@@ -18,6 +18,7 @@ package com.example.android.vdmdemo.host;
 
 import static android.media.AudioTrack.STATE_INITIALIZED;
 
+import android.annotation.SuppressLint;
 import android.content.Context;
 import android.media.AudioFormat;
 import android.media.AudioManager;
@@ -26,9 +27,12 @@ import android.media.AudioTrack;
 import android.media.audiopolicy.AudioMix;
 import android.media.audiopolicy.AudioMixingRule;
 import android.media.audiopolicy.AudioPolicy;
+import android.os.SystemClock;
 import android.util.Log;
+import android.util.Pair;
 
 import androidx.annotation.GuardedBy;
+import androidx.core.os.BuildCompat;
 
 import com.example.android.vdmdemo.common.RemoteEventProto;
 import com.example.android.vdmdemo.common.RemoteEventProto.AudioFrame;
@@ -39,8 +43,8 @@ import com.google.common.collect.ImmutableSet;
 import dagger.hilt.android.qualifiers.ApplicationContext;
 
 import java.util.ArrayList;
+import java.util.Collections;
 import java.util.List;
-import java.util.Set;
 import java.util.function.Consumer;
 
 import javax.inject.Inject;
@@ -59,6 +63,8 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
                     .setEncoding(AudioFormat.ENCODING_PCM_16BIT)
                     .build();
 
+    @Inject
+    PreferenceController mPreferenceController;
     private final Object mLock = new Object();
 
     @GuardedBy("mLock")
@@ -69,12 +75,14 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
     @GuardedBy("mLock")
     private ImmutableSet<Integer> mReroutedUids = ImmutableSet.of();
     private AudioPolicy mAudioPolicy;
+    private AudioMix mUidAudioMix;
     private final Context mApplicationContext;
     private Context mDeviceContext;
     private AudioManager mAudioManager;
 
     private final AudioManager.AudioRecordingCallback mAudioRecordingCallback =
             new AudioManager.AudioRecordingCallback() {
+                @SuppressLint("MissingPermission")
                 @Override
                 public void onRecordingConfigChanged(List<AudioRecordingConfiguration> configs) {
                     super.onRecordingConfigChanged(configs);
@@ -174,15 +182,17 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
      * Setup the AudioInjector
      */
     public void start(int deviceId, int audioSessionId) {
+        Log.d(TAG, "AudioInjector start with deviceId " + deviceId
+                + " and audioSessionId " + audioSessionId);
         mDeviceContext = mApplicationContext.createDeviceContext(deviceId)
                 .createDeviceContext(deviceId);
         mRecordingSessionId = audioSessionId;
-        mAudioManager = mDeviceContext.getSystemService(AudioManager.class);
-
         mRemoteIo.addMessageConsumer(this);
-        mAudioManager.registerAudioRecordingCallback(mAudioRecordingCallback, null);
-        synchronized (mLock) {
-            updateAudioPolicies(mReroutedUids);
+
+        mAudioManager = mDeviceContext.getSystemService(AudioManager.class);
+        if (mAudioManager != null) {
+            mAudioManager.registerAudioRecordingCallback(mAudioRecordingCallback, null);
+            registerAudioPolicy(ImmutableSet.of());
         }
     }
 
@@ -190,25 +200,20 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
      * Stop the AudioInjector
      */
     public void stop() {
+        Log.d(TAG, "AudioInjector stop.");
         synchronized (mLock) {
             if (mIsPlaying) {
                 mIsPlaying = false;
                 mRemoteIo.sendMessage(RemoteEvent.newBuilder().setStopAudioInput(
                         RemoteEventProto.StopAudioInput.newBuilder().build()).build());
             }
-            for (AudioTrack audioTrack : mAudioTracks) {
-                audioTrack.stop();
-                audioTrack.release();
-            }
-            mAudioTracks.clear();
+
+            closeAndReleaseAllTracks();
+            mRemoteIo.removeMessageConsumer(this);
 
             if (mAudioManager != null) {
-                mRemoteIo.removeMessageConsumer(this);
                 mAudioManager.unregisterAudioRecordingCallback(mAudioRecordingCallback);
-
-                if (mAudioPolicy != null) {
-                    mAudioManager.unregisterAudioPolicy(mAudioPolicy);
-                }
+                unregisterAudioPolicy();
                 mAudioManager = null;
             }
         }
@@ -230,12 +235,10 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
     /**
      * @param updatedUids uids that are now relevant to the AudioInjector
      */
-    public void updateVdmUids(Set<Integer> updatedUids) {
+    public void updateVdmUids(ImmutableSet<Integer> updatedUids) {
         synchronized (mLock) {
             if (mAudioPolicy == null) {
-                Log.e(
-                        TAG,
-                        "Not updating AudioPolicy - no audio policy configured");
+                Log.e(TAG, "Not updating AudioPolicy - no audio policy configured");
                 return;
             }
 
@@ -248,27 +251,77 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
         }
     }
 
-    private void updateAudioPolicies(Set<Integer> updatedUids) {
-        synchronized (mLock) {
-            for (AudioTrack audioTrack : mAudioTracks) {
-                audioTrack.stop();
-                audioTrack.release();
-            }
-            mAudioTracks.clear();
+    @SuppressLint("MissingPermission")
+    @GuardedBy("mLock")
+    private void updateAudioPolicies(ImmutableSet<Integer> updatedUids) {
+        long startUpdateTimeMs = SystemClock.uptimeMillis();
+
+        Log.d(TAG, "Started updateAudioPolicies. Already reroutedUids: "
+                + mReroutedUids + " -> updatedUids: " + updatedUids);
 
+        if (BuildCompat.isAtLeastV() && mPreferenceController.getBoolean(
+                R.string.pref_enable_update_audio_policy_mixes)) {
             if (mAudioPolicy != null) {
-                mAudioManager.unregisterAudioPolicy(mAudioPolicy);
+                // we have an audio policy, so we just need to update the uid audio mix
+                if (updatedUids.isEmpty()) {
+                    if (mUidAudioMix != null) {
+                        mAudioPolicy.detachMixes(Collections.singletonList(mUidAudioMix));
+                        mUidAudioMix = null;
+                        mReroutedUids = ImmutableSet.of();
+                    }
+
+                    Log.d(TAG, "Detached UID audio mixes since updatedUids set is empty in "
+                            + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+                } else {
+                    if (mUidAudioMix != null) {
+                        // we have an uid audio mix to update
+                        Pair<AudioMix, AudioMixingRule> update =
+                                Pair.create(mUidAudioMix, createUidMixingRule(updatedUids));
+                        mReroutedUids = ImmutableSet.copyOf(updatedUids);
+                        mAudioPolicy.updateMixingRules(Collections.singletonList(update));
+
+                        Log.d(TAG, "Updated AudioPolicy mixes in "
+                                + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+                    } else {
+                        // no uid audio mix so add one to the policy
+                        AudioMix uidAudioMix = getUidAudioMix(updatedUids);
+                        if (uidAudioMix != null) {
+                            mAudioPolicy.attachMixes(Collections.singletonList(uidAudioMix));
+                            mUidAudioMix = uidAudioMix;
+                            mReroutedUids = ImmutableSet.copyOf(updatedUids);
+
+                            Log.d(TAG, "Attached UID audio mix since there was none previous in "
+                                    + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+                        }
+                    }
+                }
+            } else {
+                // no audio policy set, shouldn't reach here, so register the full policy
+                registerAudioPolicy(updatedUids);
             }
+        } else {
+            synchronized (mLock) {
+                closeAndReleaseAllTracks();
+
+                unregisterAudioPolicy();
+                registerAudioPolicy(updatedUids);
 
-            mReroutedUids = ImmutableSet.copyOf(updatedUids);
-            registerAudioPolicy();
+                Log.d(TAG, "Unregistered / re-registered full AudioPolicy in "
+                        + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+            }
         }
     }
 
-    private void registerAudioPolicy() {
+    @SuppressLint("MissingPermission")
+    private void registerAudioPolicy(ImmutableSet<Integer> uids) {
         synchronized (mLock) {
+            if (mAudioPolicy != null) {
+                Log.w(TAG, "AudioInjector AudioPolicy is already registered.");
+                return;
+            }
+
             AudioMix sessionIdAudioMix = getSessionIdAudioMix(mRecordingSessionId);
-            AudioMix uidAudioMix = getUidAudioMix(mReroutedUids);
+            AudioMix uidAudioMix = getUidAudioMix(uids);
 
             AudioPolicy.Builder audioPolicyBuilder = new AudioPolicy.Builder(mDeviceContext)
                     .addMix(sessionIdAudioMix);
@@ -283,17 +336,34 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
             }
 
             mAudioPolicy = audioPolicy;
+            mUidAudioMix = uidAudioMix;
+            mReroutedUids = ImmutableSet.copyOf(uids);
+
             addAudioTrack(mAudioPolicy.createAudioTrackSource(sessionIdAudioMix));
             if (uidAudioMix != null) {
                 addAudioTrack(mAudioPolicy.createAudioTrackSource(uidAudioMix));
             }
+
+            Log.i(TAG, "Registered AudioInjector audio policy successfully.");
         }
     }
 
+    @SuppressLint("MissingPermission")
+    private void unregisterAudioPolicy() {
+        if (mAudioPolicy != null) {
+            mAudioManager.unregisterAudioPolicy(mAudioPolicy);
+            mReroutedUids = ImmutableSet.of();
+            mUidAudioMix = null;
+            mAudioPolicy = null;
+        }
+
+        Log.i(TAG, "Unregistered AudioInjector audio policy done.");
+    }
+
     private void addAudioTrack(AudioTrack audioTrack) {
         synchronized (mLock) {
             if (audioTrack.getState() != STATE_INITIALIZED) {
-                throw new IllegalStateException("set an uninitialized AudioTrack.");
+                throw new IllegalStateException("Set an uninitialized AudioTrack.");
             }
 
             if (mIsPlaying) {
@@ -303,6 +373,14 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
         }
     }
 
+    private void closeAndReleaseAllTracks() {
+        for (AudioTrack audioTrack : mAudioTracks) {
+            audioTrack.stop();
+            audioTrack.release();
+        }
+        mAudioTracks.clear();
+    }
+
     private static AudioMix getSessionIdAudioMix(int sessionId) {
         AudioMixingRule sessionIdMixingRule =
                 new AudioMixingRule.Builder()
@@ -322,15 +400,16 @@ public final class AudioInjector implements Consumer<RemoteEvent> {
             return null;
         }
 
-        AudioMixingRule.Builder uidMixingRule = new AudioMixingRule.Builder()
-                .setTargetMixRole(AudioMixingRule.MIX_ROLE_INJECTOR);
-        for (Integer reroutedUid : reroutedUids) {
-            uidMixingRule.addMixRule(AudioMixingRule.RULE_MATCH_UID, reroutedUid);
-        }
-
-        return new AudioMix.Builder(uidMixingRule.build())
+        return new AudioMix.Builder(createUidMixingRule(reroutedUids))
                 .setRouteFlags(AudioMix.ROUTE_FLAG_LOOP_BACK)
                 .setFormat(AUDIO_FORMAT_IN)
                 .build();
     }
+
+    private static AudioMixingRule createUidMixingRule(ImmutableSet<Integer> uids) {
+        AudioMixingRule.Builder builder = new AudioMixingRule.Builder().setTargetMixRole(
+                AudioMixingRule.MIX_ROLE_INJECTOR);
+        uids.forEach(uid -> builder.addMixRule(AudioMixingRule.RULE_MATCH_UID, uid));
+        return builder.build();
+    }
 }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioStreamer.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioStreamer.java
index f557c6524..ed107ac92 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioStreamer.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/AudioStreamer.java
@@ -19,6 +19,7 @@ package com.example.android.vdmdemo.host;
 import static com.google.common.collect.Iterables.getOnlyElement;
 import static com.google.common.util.concurrent.Uninterruptibles.joinUninterruptibly;
 
+import android.annotation.SuppressLint;
 import android.content.Context;
 import android.media.AudioDeviceInfo;
 import android.media.AudioFormat;
@@ -29,10 +30,13 @@ import android.media.AudioRecord;
 import android.media.audiopolicy.AudioMix;
 import android.media.audiopolicy.AudioMixingRule;
 import android.media.audiopolicy.AudioPolicy;
+import android.os.SystemClock;
 import android.util.Log;
+import android.util.Pair;
 
 import androidx.annotation.GuardedBy;
 import androidx.annotation.Nullable;
+import androidx.core.os.BuildCompat;
 
 import com.example.android.vdmdemo.common.RemoteEventProto.AudioFrame;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
@@ -46,6 +50,7 @@ import dagger.hilt.android.qualifiers.ApplicationContext;
 
 import java.util.Arrays;
 import java.util.Collection;
+import java.util.Collections;
 import java.util.List;
 import java.util.Objects;
 import java.util.Set;
@@ -78,10 +83,13 @@ final class AudioStreamer {
     private AudioManager mAudioManager;
     private int mPlaybackSessionId;
 
+    @Inject
+    PreferenceController mPreferenceController;
+
     private final Object mLock = new Object();
 
     @GuardedBy("mLock")
-    private AudioPolicy mAudioPolicy;
+    private AudioPolicy mAudioSessionPolicy;
 
     @GuardedBy("mLock")
     private AudioMix mSessionIdAudioMix;
@@ -99,7 +107,7 @@ final class AudioStreamer {
     private AudioDeviceInfo mRemoteSubmixDevice;
 
     @GuardedBy("mLock")
-    private AudioRecord mGhostRecord;
+    private AudioRecord mHostRecord;
 
     private ImmutableSet<Integer> mReroutedUids = ImmutableSet.of();
 
@@ -114,26 +122,25 @@ final class AudioStreamer {
                                 c -> STREAMING_PLAYER_STATES.contains(c.getPlayerState())
                                         && (mReroutedUids.contains(c.getClientUid())
                                         || c.getSessionId() == mPlaybackSessionId));
-                        if (mAudioPolicy == null) {
-                            Log.d(
-                                    TAG,
-                                    "There's no active audio policy, ignoring playback "
+
+                        if (mAudioSessionPolicy == null) {
+                            Log.d(TAG, "There's no active audio policy, ignoring playback "
                                             + "config callback");
                             return;
                         }
 
                         if (mSessionIdAudioMix != null && shouldStream
                                 && mStreamingThread == null) {
+                            Log.d(TAG, "Send StartAudio RemoteEvent to remote device.");
                             mRemoteIo.sendMessage(
                                     RemoteEvent.newBuilder()
                                             .setStartAudio(StartAudio.newBuilder())
                                             .build());
-                            mStreamingThread =
-                                    new StreamingThread(
-                                            mAudioPolicy.createAudioRecordSink(mSessionIdAudioMix),
-                                            mRemoteIo);
+                            // reuse the same AudioRecord that is kept alive and recording
+                            mStreamingThread = new StreamingThread(mHostRecord, mRemoteIo);
                             mStreamingThread.start();
                         } else if (!shouldStream && mStreamingThread != null) {
+                            Log.d(TAG, "Send StopAudio RemoteEvent to remote device.");
                             mRemoteIo.sendMessage(
                                     RemoteEvent.newBuilder()
                                             .setStopAudio(StopAudio.newBuilder())
@@ -153,57 +160,32 @@ final class AudioStreamer {
     }
 
     public void start(int deviceId, int audioSessionId) {
+        Log.d(TAG, "AudioStreamer start with deviceId " + deviceId + " and audioSessionId "
+                + audioSessionId);
         mDeviceContext = mApplicationContext.createDeviceContext(deviceId)
                 .createDeviceContext(deviceId);
-        mPlaybackSessionId = audioSessionId;
 
         mAudioManager = mDeviceContext.getSystemService(AudioManager.class);
-
-        mAudioManager.registerAudioPlaybackCallback(mAudioPlaybackCallback, null);
-        synchronized (mLock) {
-            updateAudioPolicies(mReroutedUids);
+        if (mAudioManager != null) {
+            mAudioManager.registerAudioPlaybackCallback(mAudioPlaybackCallback, null);
+            registerAudioPolicies(audioSessionId, ImmutableSet.of());
         }
     }
 
-    private void registerAudioPolicy() {
-        AudioMixingRule mixingRule =
-                new AudioMixingRule.Builder()
-                        .addMixRule(AudioMixingRule.RULE_MATCH_AUDIO_SESSION_ID, mPlaybackSessionId)
-                        .build();
-        AudioMix audioMix =
-                new AudioMix.Builder(mixingRule)
-                        .setRouteFlags(AudioMix.ROUTE_FLAG_LOOP_BACK)
-                        .setFormat(AUDIO_FORMAT)
-                        .build();
-
+    private void registerAudioPolicies(int audioSessionId, ImmutableSet<Integer> uids) {
         synchronized (mLock) {
-            if (mAudioPolicy != null) {
-                Log.w(TAG, "AudioPolicy is already registered");
-                return;
-            }
-            mAudioPolicy = new AudioPolicy.Builder(mApplicationContext).addMix(audioMix).build();
-            int ret = mAudioManager.registerAudioPolicy(mAudioPolicy);
-            if (ret != AudioManager.SUCCESS) {
-                Log.e(TAG, "Failed to register audio policy, error code " + ret);
-                mAudioPolicy = null;
-                return;
+            // order is important, the Session ID audio policy creates
+            // the remote submix audio device used in the uid policy
+            if (registerSessionPolicy(audioSessionId)) {
+                registerUidPolicy(uids);
             }
+        }
+    }
 
-            // This is a hacky way to determine audio device associated with audio mix.
-            // once audio record for the policy is initialized, audio policy manager
-            // will create remote submix instance so we can compare devices before and after
-            // to determine which device corresponds to this particular mix.
-            // The ghost audio record needs to be kept alive, releasing it would cause
-            // destruction of remote submix instances and potential problems when updating the
-            // UID-based render policy pointing to the remote submix device.
-            List<AudioDeviceInfo> preexistingRemoteSubmixDevices = getRemoteSubmixDevices();
-            mGhostRecord = mAudioPolicy.createAudioRecordSink(audioMix);
-            mGhostRecord.startRecording();
-            mRemoteSubmixDevice = getNewRemoteSubmixAudioDevice(preexistingRemoteSubmixDevices);
-            mSessionIdAudioMix = audioMix;
-            if (!mReroutedUids.isEmpty()) {
-                registerUidPolicy(mReroutedUids);
-            }
+    private void unregisterAudioPolicies() {
+        synchronized (mLock) {
+            unregisterUidPolicy();
+            unregisterSessionPolicy();
         }
     }
 
@@ -223,14 +205,14 @@ final class AudioStreamer {
             Log.e(TAG, "There's more than 1 new remote submix device");
             return null;
         }
-        if (newDevices.size() == 0) {
+        if (newDevices.isEmpty()) {
             Log.e(TAG, "Didn't find new remote submix device");
             return null;
         }
         return getOnlyElement(newDevices);
     }
 
-    public void updateVdmUids(Set<Integer> uids) {
+    public void updateVdmUids(ImmutableSet<Integer> uids) {
         Log.w(TAG, "Updating mixing rule to reroute uids " + uids);
         synchronized (mLock) {
             if (mRemoteSubmixDevice == null) {
@@ -247,80 +229,182 @@ final class AudioStreamer {
         }
     }
 
-    // TODO(b/293611855) Use finer grained audio policy + mix controls once bugs are addressed
-    // This shouldn't unregister all audio policies just to re-register them again.
-    // That's inefficient and leads to audio leaks. But this is the most correct way to do this at
-    // this time.
+    @SuppressLint("MissingPermission")
     @GuardedBy("mLock")
-    private void updateAudioPolicies(Set<Integer> uids) {
-        // TODO(b/293279299) Use Flagged API
-        // if (com.android.media.audio.flags.Flags.FLAG_AUDIO_POLICY_UPDATE_MIXING_RULES_API &&
-        // uidAudioMix != null && (!reroutedUids.isEmpty() && !uids.isEmpty())) {
-        //   Pair<AudioMix, AudioMixingRule> update = Pair.create(uidAudioMix,
-        // createUidMixingRule(uids));
-        //   uidAudioPolicy.updateMixingRules(Collections.singletonList(update));
-        //   return;
-        // }
-
-        if (mAudioPolicy != null) {
-            mAudioManager.unregisterAudioPolicy(mAudioPolicy);
-            mAudioPolicy = null;
+    private void updateAudioPolicies(ImmutableSet<Integer> uids) {
+        long startUpdateTimeMs = SystemClock.uptimeMillis();
+
+        Log.d(TAG, "Started updateAudioPolicies. Already rerouted uids: "
+                + mReroutedUids + " -> updated uids: " + uids);
+
+        if (BuildCompat.isAtLeastV() && mPreferenceController.getBoolean(
+                R.string.pref_enable_update_audio_policy_mixes)) {
+            if (mUidAudioPolicy != null && mUidAudioMix != null && !mReroutedUids.isEmpty()) {
+                if (uids.isEmpty()) {
+                    unregisterUidPolicy();
+
+                    Log.d(TAG, "Unregistered UID AudioPolicy since uid set is empty in "
+                            + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+                } else {
+                    Pair<AudioMix, AudioMixingRule> update =
+                            Pair.create(mUidAudioMix, createUidMixingRule(uids));
+                    mReroutedUids = ImmutableSet.copyOf(uids);
+                    mUidAudioPolicy.updateMixingRules(Collections.singletonList(update));
+
+                    Log.d(TAG, "Updated UID AudioPolicy mixes in "
+                            + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+                }
+            } else {
+                registerUidPolicy(uids);
+
+                Log.d(TAG, "Registered UID AudioPolicy since there was none previous in "
+                        + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
+            }
+        } else {
+            // Legacy and inefficient way to unregister the UID audio policy and then just
+            // re-register it again. Leads to audio leaks.
+            synchronized (mLock) {
+                unregisterUidPolicy();
+                registerUidPolicy(uids);
+            }
+
+            Log.d(TAG, "Unregistered / re-registered UID AudioPolicy in "
+                    + (SystemClock.uptimeMillis() - startUpdateTimeMs) + "ms.");
         }
-        if (mUidAudioPolicy != null) {
-            mAudioManager.unregisterAudioPolicy(mUidAudioPolicy);
-            mUidAudioPolicy = null;
+    }
+
+    @SuppressLint("MissingPermission")
+    @GuardedBy("mLock")
+    // returns true if successfully registered, false otherwise
+    private boolean registerSessionPolicy(int audioSessionId) {
+        AudioMixingRule mixingRule = new AudioMixingRule.Builder()
+                .addMixRule(AudioMixingRule.RULE_MATCH_AUDIO_SESSION_ID, audioSessionId)
+                .build();
+
+        AudioMix audioMix = new AudioMix.Builder(mixingRule)
+                .setRouteFlags(AudioMix.ROUTE_FLAG_LOOP_BACK)
+                .setFormat(AUDIO_FORMAT)
+                .build();
+
+        synchronized (mLock) {
+            if (mAudioSessionPolicy != null) {
+                Log.w(TAG, "MediaSession AudioPolicy is already registered.");
+                return false;
+            }
+
+            AudioPolicy sessionPolicy = new AudioPolicy.Builder(mApplicationContext)
+                    .addMix(audioMix)
+                    .build();
+
+            int ret = mAudioManager.registerAudioPolicy(sessionPolicy);
+            if (ret != AudioManager.SUCCESS) {
+                Log.e(TAG, "Failed to register media session audio policy, error code " + ret);
+                return false;
+            }
+
+            mAudioSessionPolicy = sessionPolicy;
+            mSessionIdAudioMix = audioMix;
+            mPlaybackSessionId = audioSessionId;
+
+            // This is a hacky way to determine audio device associated with audio mix.
+            // once audio record for the policy is initialized, audio policy manager
+            // will create remote submix instance so we can compare devices before and after
+            // to determine which device corresponds to this particular mix.
+            // The audio record needs to be kept alive, releasing it would cause
+            // destruction of remote submix instances and potential problems when updating the
+            // UID-based render policy pointing to the remote submix device.
+            List<AudioDeviceInfo> preexistingRemoteSubmixDevices = getRemoteSubmixDevices();
+            // The AudioRecord is tied to the session audio policy and its assigned audio mix,
+            // It is created with the session policy and is always recording
+            // as long as the policy exists.
+            mHostRecord = mAudioSessionPolicy.createAudioRecordSink(audioMix);
+            mHostRecord.startRecording();
+
+            mRemoteSubmixDevice = getNewRemoteSubmixAudioDevice(preexistingRemoteSubmixDevices);
         }
 
-        mReroutedUids = ImmutableSet.copyOf(uids);
-        registerAudioPolicy();
+        Log.i(TAG, "Registered MediaSession audio policy successfully.");
+        return true;
     }
 
+    @SuppressLint("MissingPermission")
     @GuardedBy("mLock")
     private void registerUidPolicy(ImmutableSet<Integer> uids) {
-        mUidAudioMix =
-                new AudioMix.Builder(createUidMixingRule(uids))
+        // we can't create an UID audio policy with no uids to redirect
+        // nor without a remote submix device created by the media session policy
+        if (uids.isEmpty() || mRemoteSubmixDevice == null) {
+            return;
+        }
+
+        AudioMix uidAudioMix = new AudioMix.Builder(createUidMixingRule(uids))
                         .setRouteFlags(AudioMix.ROUTE_FLAG_RENDER)
                         .setDevice(mRemoteSubmixDevice)
                         .setFormat(AUDIO_FORMAT)
                         .build();
+
         AudioPolicy uidPolicy = new AudioPolicy.Builder(mApplicationContext)
-                .addMix(mUidAudioMix)
+                .addMix(uidAudioMix)
                 .build();
+
         int ret = mAudioManager.registerAudioPolicy(uidPolicy);
         if (ret != AudioManager.SUCCESS) {
-            Log.e(TAG, "Error " + ret + " while trying to register UID policy");
+            Log.e(TAG, "Failed to register UID audio policy, error code " + ret);
             return;
         }
 
+        mUidAudioMix = uidAudioMix;
         mUidAudioPolicy = uidPolicy;
         mReroutedUids = ImmutableSet.copyOf(uids);
+
+        Log.d(TAG, "Registered UID audio policy successfully.");
+    }
+
+    @SuppressLint("MissingPermission")
+    @GuardedBy("mLock")
+    private void unregisterUidPolicy() {
+        if (mUidAudioPolicy != null) {
+            mAudioManager.unregisterAudioPolicy(mUidAudioPolicy);
+            mUidAudioPolicy = null;
+            mUidAudioMix = null;
+            mReroutedUids = ImmutableSet.of();
+        }
+
+        Log.d(TAG, "Unregistered UID audio policy done.");
     }
 
+    @SuppressLint("MissingPermission")
+    @GuardedBy("mLock")
+    private void unregisterSessionPolicy() {
+        if (mAudioSessionPolicy != null) {
+            // The AudioRecord is tied to the session audio policy
+            if (mHostRecord != null) {
+                mHostRecord.stop();
+                mHostRecord.release();
+                mHostRecord = null;
+            }
+
+            mAudioManager.unregisterAudioPolicy(mAudioSessionPolicy);
+            mPlaybackSessionId = 0;
+            mAudioSessionPolicy = null;
+            mSessionIdAudioMix = null;
+            mRemoteSubmixDevice = null;
+        }
+
+        Log.i(TAG, "Unregistered MediaSession audio policy done.");
+    }
     public void stop() {
+        Log.d(TAG, "AudioStreamer stop.");
         synchronized (mLock) {
             if (mStreamingThread != null) {
                 mStreamingThread.stopStreaming();
                 joinUninterruptibly(mStreamingThread);
                 mStreamingThread = null;
             }
+
             if (mAudioManager != null) {
-                if (mUidAudioPolicy != null) {
-                    mAudioManager.unregisterAudioPolicy(mUidAudioPolicy);
-                    mUidAudioPolicy = null;
-                }
-                if (mAudioPolicy != null) {
-                    mAudioManager.unregisterAudioPolicy(mAudioPolicy);
-                    mAudioPolicy = null;
-                }
+                unregisterAudioPolicies();
                 mAudioManager.unregisterAudioPlaybackCallback(mAudioPlaybackCallback);
             }
-
-            if (mGhostRecord != null) {
-                mGhostRecord.stop();
-                mGhostRecord.release();
-                mGhostRecord = null;
-            }
-
         }
     }
 
@@ -348,6 +432,9 @@ final class AudioStreamer {
                         SAMPLE_RATE,
                         AudioFormat.CHANNEL_OUT_STEREO,
                         AudioFormat.ENCODING_PCM_16BIT);
+        // Max safe number of AudioRecord buffers in which to expect silence
+        // when stopping and flushing the AudioRecord
+        private static final int MAX_FLUSH_BUFFERS = 64;
         private final RemoteIo mRemoteIo;
         private final AudioRecord mAudioRecord;
         private final AtomicBoolean mIsRunning = new AtomicBoolean(true);
@@ -368,7 +455,12 @@ final class AudioStreamer {
                 return;
             }
 
-            mAudioRecord.startRecording();
+            // we expect an active and already recording AudioRecord
+            if (mAudioRecord.getRecordingState() != AudioRecord.RECORDSTATE_RECORDING) {
+                Log.e(TAG, "Audio record is not recording");
+                return;
+            }
+
             byte[] buffer = new byte[BUFFER_SIZE];
             while (mIsRunning.get()) {
                 int ret = mAudioRecord.read(buffer, 0, buffer.length, AudioRecord.READ_BLOCKING);
@@ -377,16 +469,38 @@ final class AudioStreamer {
                     continue;
                 }
 
-                mRemoteIo.sendMessage(
-                        RemoteEvent.newBuilder()
-                                .setAudioFrame(
-                                        AudioFrame.newBuilder()
-                                                .setData(ByteString.copyFrom(buffer, 0, ret)))
-                                .build());
+                if (mIsRunning.get()) {
+                    mRemoteIo.sendMessage(RemoteEvent.newBuilder().setAudioFrame(
+                            AudioFrame.newBuilder().setData(
+                                    ByteString.copyFrom(buffer, 0, ret))).build());
+                } else {
+                    // Streaming ended, we just need to "flush" the remaining unneeded data
+                    // from the AudioRecord, since the AudioRecord might be reused later
+                    // There is no straightforward API to do this on the AudioRecord,
+                    // so simulate this by reading enough data until we get silence (buffer full
+                    // of zeros) or for safety a reasonable number of buffers has passed
+                    int i = 0;
+                    while (i++ < MAX_FLUSH_BUFFERS && !isSilence(buffer)) {
+                        mAudioRecord.read(buffer, 0, buffer.length, AudioRecord.READ_BLOCKING);
+                    }
+                    Log.d(TAG, "Flushed " + i + " AudioRecord buffers.");
+                    // Note: we already send the stop play RemoteEvent since we prioritize
+                    // low latency for the user input, the alternative is to continue sending
+                    // the rest of the audio data and only stop the actual remote playback here
+                }
             }
+            // we only stop the streaming and not the AudioRecord recording
+            // which is owned by the AudioStreamer
             Log.d(TAG, "Stopping audio streaming");
-            mAudioRecord.stop();
-            mAudioRecord.release();
+        }
+
+        private static boolean isSilence(byte[] buffer) {
+            for (byte b : buffer) {
+                if (b != 0) {
+                    return false;
+                }
+            }
+            return true;
         }
 
         void stopStreaming() {
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
index 4b13574f7..29536423e 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
@@ -41,6 +41,8 @@ import androidx.core.content.ContextCompat;
 
 import dagger.hilt.android.AndroidEntryPoint;
 
+import java.util.function.Consumer;
+
 import javax.inject.Inject;
 
 /**
@@ -55,6 +57,7 @@ public class MainActivity extends Hilt_MainActivity {
     private Button mHomeDisplayButton = null;
     private Button mMirrorDisplayButton = null;
     private LauncherAdapter mLauncherAdapter = null;
+    private final Consumer<Boolean> mVirtualDeviceListener = this::updateLauncherVisibility;
 
     private final ActivityResultLauncher<String> mRequestPermissionLauncher =
             registerForActivityResult(new RequestPermission(), isGranted -> {
@@ -75,8 +78,7 @@ public class MainActivity extends Hilt_MainActivity {
                 public void onServiceConnected(ComponentName className, IBinder binder) {
                     Log.i(TAG, "Connected to VDM Service");
                     mVdmService = ((VdmService.LocalBinder) binder).getService();
-                    mVdmService.setVirtualDeviceListener(
-                            MainActivity.this::updateLauncherVisibility);
+                    mVdmService.addVirtualDeviceListener(mVirtualDeviceListener);
                     updateLauncherVisibility(mVdmService.isVirtualDeviceActive());
                 }
 
@@ -100,12 +102,8 @@ public class MainActivity extends Hilt_MainActivity {
 
         mHomeDisplayButton = requireViewById(R.id.create_home_display);
         mHomeDisplayButton.setVisibility(View.GONE);
-        mHomeDisplayButton.setEnabled(
-                mPreferenceController.getBoolean(R.string.internal_pref_home_displays_supported));
         mMirrorDisplayButton = requireViewById(R.id.create_mirror_display);
         mMirrorDisplayButton.setVisibility(View.GONE);
-        mMirrorDisplayButton.setEnabled(
-                mPreferenceController.getBoolean(R.string.internal_pref_mirror_displays_supported));
 
         mLauncherAdapter = new LauncherAdapter(this, mPreferenceController);
         mLauncher = requireViewById(R.id.app_grid);
@@ -171,7 +169,7 @@ public class MainActivity extends Hilt_MainActivity {
     protected void onStop() {
         super.onStop();
         if (mVdmService != null) {
-            mVdmService.setVirtualDeviceListener(null);
+            mVdmService.removeVirtualDeviceListener(mVirtualDeviceListener);
         }
         unbindService(mServiceConnection);
     }
@@ -205,9 +203,14 @@ public class MainActivity extends Hilt_MainActivity {
                         mLauncher.setVisibility(visibility);
                     }
                     if (mHomeDisplayButton != null) {
+                        mHomeDisplayButton.setEnabled(
+                                mPreferenceController.getBoolean(
+                                        R.string.internal_pref_home_displays_supported));
                         mHomeDisplayButton.setVisibility(visibility);
                     }
                     if (mMirrorDisplayButton != null) {
+                        mMirrorDisplayButton.setEnabled(
+                                VdmCompat.isMirrorDisplaySupported(this, mPreferenceController));
                         mMirrorDisplayButton.setVisibility(visibility);
                     }
                 });
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/NotificationListener.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/NotificationListener.java
deleted file mode 100644
index 4e10a399b..000000000
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/NotificationListener.java
+++ /dev/null
@@ -1,53 +0,0 @@
-/*
- * Copyright (C) 2023 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.host;
-
-import android.app.PendingIntent;
-import android.content.Intent;
-import android.service.notification.NotificationListenerService;
-import android.service.notification.StatusBarNotification;
-import android.util.Log;
-
-/** NotificationListenerService to forward notifications shown on the host to the client. */
-public final class NotificationListener extends NotificationListenerService {
-
-    private static final String TAG = "VdmHost";
-
-    @Override
-    public void onNotificationRemoved(
-            StatusBarNotification notification,
-            NotificationListenerService.RankingMap rankingMap,
-            int reason) {
-
-        if (reason == NotificationListenerService.REASON_LOCKDOWN) {
-            Intent lockdownIntent = new Intent(this, VdmService.class);
-            lockdownIntent.setAction(VdmService.ACTION_LOCKDOWN);
-            PendingIntent pendingIntentLockdown =
-                    PendingIntent.getService(this, 0, lockdownIntent, PendingIntent.FLAG_IMMUTABLE);
-
-            try {
-                Log.i(
-                        TAG,
-                        "Notification removed due to lockdown. Sending lockdown "
-                        + "Intent to VdmService");
-                pendingIntentLockdown.send();
-            } catch (PendingIntent.CanceledException e) {
-                Log.e(TAG, "Error sending lockdown Intent", e);
-            }
-        }
-    }
-}
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
index d52766aff..17fe60248 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
@@ -16,6 +16,8 @@
 
 package com.example.android.vdmdemo.host;
 
+import static android.Manifest.permission.ADD_ALWAYS_UNLOCKED_DISPLAY;
+import static android.Manifest.permission.ADD_TRUSTED_DISPLAY;
 import static android.os.Build.VERSION.SDK_INT;
 import static android.os.Build.VERSION_CODES.TIRAMISU;
 import static android.os.Build.VERSION_CODES.UPSIDE_DOWN_CAKE;
@@ -25,6 +27,7 @@ import android.companion.AssociationRequest;
 import android.companion.virtual.flags.Flags;
 import android.content.Context;
 import android.content.SharedPreferences;
+import android.content.pm.PackageManager;
 import android.util.ArrayMap;
 import android.util.Log;
 
@@ -65,13 +68,14 @@ final class PreferenceController {
                     .withDefaultValue(AssociationRequest.DEVICE_PROFILE_APP_STREAMING),
 
             new BoolRule(R.string.pref_hide_from_recents, UPSIDE_DOWN_CAKE)
-                    .withDefaultValue(true),
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
             new BoolRule(R.string.pref_enable_cross_device_clipboard,
-                    VANILLA_ICE_CREAM, Flags::crossDeviceClipboard),
+                    VANILLA_ICE_CREAM, Flags::crossDeviceClipboard)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
-            new BoolRule(R.string.pref_enable_custom_activity_policy,
-                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+            // TODO(b/379277747): Change to BAKLAVA
+            new BoolRule(R.string.pref_enable_custom_activity_policy, VANILLA_ICE_CREAM,
                     Flags::dynamicPolicy,
                     android.companion.virtualdevice.flags.Flags::activityControlApi),
 
@@ -88,28 +92,48 @@ final class PreferenceController {
             new BoolRule(R.string.pref_enable_display_category, UPSIDE_DOWN_CAKE),
 
             new BoolRule(R.string.pref_always_unlocked_device, TIRAMISU)
-                    .withDefaultValue(true),
+                    .withRequiredPermissions(ADD_ALWAYS_UNLOCKED_DISPLAY),
+
+            new BoolRule(R.string.pref_show_pointer_icon, TIRAMISU)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
-            new BoolRule(R.string.pref_show_pointer_icon, TIRAMISU),
+            new BoolRule(R.string.pref_enable_custom_home, VANILLA_ICE_CREAM, Flags::vdmCustomHome)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
-            new BoolRule(R.string.pref_enable_custom_home, VANILLA_ICE_CREAM, Flags::vdmCustomHome),
+            // TODO(b/379277747): Change to BAKLAVA
+            new BoolRule(R.string.pref_enable_custom_status_bar, VANILLA_ICE_CREAM,
+                    android.companion.virtualdevice.flags.Flags::statusBarAndInsets)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
-            new BoolRule(R.string.pref_enable_custom_status_bar,
-                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
-                    android.companion.virtualdevice.flags.Flags::statusBarAndInsets),
+            // TODO(b/379277747): Change to BAKLAVA
+            new StringRule(R.string.pref_display_timeout, VANILLA_ICE_CREAM,
+                    android.companion.virtualdevice.flags.Flags::deviceAwareDisplayPower,
+                    android.companion.virtualdevice.flags.Flags::displayPowerManagerApis)
+                    .withDefaultValue(String.valueOf(0)),
+
+            // TODO(b/379277747): Change to BAKLAVA
+            new StringRule(R.string.pref_enable_client_brightness, VANILLA_ICE_CREAM,
+                    android.companion.virtualdevice.flags.Flags::deviceAwareDisplayPower,
+                    android.companion.virtualdevice.flags.Flags::displayPowerManagerApis),
 
             new StringRule(R.string.pref_display_ime_policy, VANILLA_ICE_CREAM, Flags::vdmCustomIme)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY)
                     .withDefaultValue(String.valueOf(0)),
 
             new BoolRule(R.string.pref_enable_client_native_ime,
-                    VANILLA_ICE_CREAM, Flags::vdmCustomIme),
+                    VANILLA_ICE_CREAM, Flags::vdmCustomIme)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
             new BoolRule(R.string.pref_record_encoder_output, TIRAMISU),
 
+            new BoolRule(R.string.pref_enable_update_audio_policy_mixes, VANILLA_ICE_CREAM)
+                    .withDefaultValue(true),
+
             // Internal-only switches not exposed in the settings page.
             // All of these are booleans acting as switches, while the above ones may be any type.
 
-            new InternalBoolRule(R.string.internal_pref_home_displays_supported, TIRAMISU),
+            new InternalBoolRule(R.string.internal_pref_home_displays_supported, TIRAMISU)
+                    .withRequiredPermissions(ADD_TRUSTED_DISPLAY),
 
             new InternalBoolRule(R.string.internal_pref_mirror_displays_supported,
                     VANILLA_ICE_CREAM),
@@ -117,12 +141,14 @@ final class PreferenceController {
             new InternalBoolRule(R.string.internal_pref_virtual_stylus_supported,
                     VANILLA_ICE_CREAM, Flags::virtualStylus),
 
+            // TODO(b/379277747): Change to BAKLAVA
             new InternalBoolRule(R.string.internal_pref_virtual_rotary_supported,
-                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    VANILLA_ICE_CREAM,
                     android.companion.virtualdevice.flags.Flags::virtualRotary),
 
+            // TODO(b/379277747): Change to BAKLAVA
             new InternalBoolRule(R.string.internal_pref_display_rotation_supported,
-                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    VANILLA_ICE_CREAM,
                     android.companion.virtualdevice.flags.Flags::virtualDisplayRotationApi)
     );
     // LINT.ThenChange(/samples/VirtualDeviceManager/README.md:host_options)
@@ -138,11 +164,7 @@ final class PreferenceController {
     PreferenceController(@ApplicationContext Context context) {
         mContext = context;
         mSharedPreferences = PreferenceManager.getDefaultSharedPreferences(mContext);
-
-        SharedPreferences.Editor editor = mSharedPreferences.edit();
-        RULES.forEach(r -> r.evaluate(mContext, mSharedPreferences, editor));
-        editor.commit();
-
+        evaluate();
         mSharedPreferences.registerOnSharedPreferenceChangeListener(mPreferenceChangeListener);
     }
 
@@ -179,6 +201,12 @@ final class PreferenceController {
         RULES.forEach(r -> r.evaluate(mContext, preferenceManager));
     }
 
+    void evaluate() {
+        SharedPreferences.Editor editor = mSharedPreferences.edit();
+        RULES.forEach(r -> r.evaluate(mContext, mSharedPreferences, editor));
+        editor.commit();
+    }
+
     boolean getBoolean(@StringRes int resId) {
         return mSharedPreferences.getBoolean(mContext.getString(resId), false);
     }
@@ -207,6 +235,7 @@ final class PreferenceController {
         final int mMinSdk;
         final BooleanSupplier[] mRequiredFlags;
 
+        protected String[] mRequiredPermissions = null;
         protected T mDefaultValue;
 
         PrefRule(@StringRes int key, T defaultValue, int minSdk, BooleanSupplier... requiredFlags) {
@@ -218,7 +247,7 @@ final class PreferenceController {
 
         void evaluate(Context context, SharedPreferences prefs, SharedPreferences.Editor editor) {
             String preferenceName = context.getString(mKey);
-            if (!prefs.contains(preferenceName) || !isSatisfied(preferenceName)) {
+            if (!prefs.contains(preferenceName) || !isSatisfied(context, preferenceName)) {
                 reset(context, editor);
             }
         }
@@ -227,7 +256,7 @@ final class PreferenceController {
             String preferenceName = context.getString(mKey);
             Preference preference = preferenceManager.findPreference(preferenceName);
             if (preference != null) {
-                boolean enabled = isSatisfied(preferenceName);
+                boolean enabled = isSatisfied(context, preferenceName);
                 if (preference.isEnabled() != enabled) {
                     preference.setEnabled(enabled);
                 }
@@ -236,7 +265,15 @@ final class PreferenceController {
 
         protected abstract void reset(Context context, SharedPreferences.Editor editor);
 
-        protected boolean isSatisfied(String preferenceName) {
+        protected boolean isSatisfied(Context context, String preferenceName) {
+            if (mRequiredPermissions != null) {
+                for (String requiredPermission : mRequiredPermissions) {
+                    if (context.checkCallingOrSelfPermission(requiredPermission)
+                            != PackageManager.PERMISSION_GRANTED) {
+                        return false;
+                    }
+                }
+            }
             try {
                 return isSdkVersionSatisfied()
                         && Arrays.stream(mRequiredFlags).allMatch(BooleanSupplier::getAsBoolean);
@@ -254,6 +291,11 @@ final class PreferenceController {
             mDefaultValue = defaultValue;
             return this;
         }
+
+        PrefRule<T> withRequiredPermissions(String... permissions) {
+            mRequiredPermissions = permissions;
+            return this;
+        }
     }
 
     private static class BoolRule extends PrefRule<Boolean> {
@@ -275,7 +317,7 @@ final class PreferenceController {
         @Override
         void evaluate(Context context, SharedPreferences prefs, SharedPreferences.Editor editor) {
             String preferenceName = context.getString(mKey);
-            editor.putBoolean(preferenceName, isSatisfied(preferenceName));
+            editor.putBoolean(preferenceName, isSatisfied(context, preferenceName));
         }
     }
 
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
index d1e5fb0fa..076a627d2 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
@@ -16,11 +16,14 @@
 
 package com.example.android.vdmdemo.host;
 
+import static android.Manifest.permission.ADD_TRUSTED_DISPLAY;
+
 import android.annotation.SuppressLint;
 import android.app.ActivityOptions;
 import android.companion.virtual.VirtualDeviceManager.VirtualDevice;
 import android.content.Context;
 import android.content.Intent;
+import android.content.pm.PackageManager;
 import android.graphics.Point;
 import android.graphics.PointF;
 import android.hardware.display.DisplayManager;
@@ -58,6 +61,8 @@ import android.view.Surface;
 import androidx.annotation.IntDef;
 
 import com.example.android.vdmdemo.common.RemoteEventProto;
+import com.example.android.vdmdemo.common.RemoteEventProto.BrightnessEvent;
+import com.example.android.vdmdemo.common.RemoteEventProto.DeviceState;
 import com.example.android.vdmdemo.common.RemoteEventProto.DisplayCapabilities;
 import com.example.android.vdmdemo.common.RemoteEventProto.DisplayRotation;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
@@ -72,6 +77,7 @@ import java.lang.annotation.Retention;
 import java.lang.annotation.RetentionPolicy;
 import java.util.Collections;
 import java.util.Set;
+import java.util.concurrent.Executors;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.function.Consumer;
 
@@ -87,6 +93,9 @@ class RemoteDisplay implements AutoCloseable {
                     | DisplayManager.VIRTUAL_DISPLAY_FLAG_PUBLIC
                     | DisplayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY;
 
+    private static final float DEFAULT_CLIENT_BRIGHTNESS = 0.3f;
+    private static final float DIM_CLIENT_BRIGHTNESS = 0.15f;
+
     static final int DISPLAY_TYPE_APP = 0;
     static final int DISPLAY_TYPE_HOME = 1;
     static final int DISPLAY_TYPE_MIRROR = 2;
@@ -118,6 +127,31 @@ class RemoteDisplay implements AutoCloseable {
     private VirtualStylus mStylus;
     private VirtualRotaryEncoder mRotary;
 
+    // DisplayManager.DisplayListener#onDisplayChanged along with Display#getState() can also be
+    // used to detect power events instead of using VirtualDisplay.Callback.
+    private final VirtualDisplay.Callback mVirtualDisplayCallback = new VirtualDisplay.Callback() {
+        @Override
+        public void onPaused() {
+            Log.v(TAG, "VirtualDisplay paused");
+            mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                    .setDeviceState(DeviceState.newBuilder().setPowerOn(false))
+                    .build());
+        }
+
+        @Override
+        public void onResumed() {
+            Log.v(TAG, "VirtualDisplay resumed");
+            mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                    .setDeviceState(DeviceState.newBuilder().setPowerOn(true))
+                    .build());
+        }
+
+        @Override
+        public void onStopped() {
+            Log.v(TAG, "VirtualDisplay stopped");
+        }
+    };
+
     @SuppressLint("WrongConstant")
     RemoteDisplay(
             Context context,
@@ -142,6 +176,10 @@ class RemoteDisplay implements AutoCloseable {
         if (mDisplayType == DISPLAY_TYPE_MIRROR) {
             flags &= ~DisplayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY;
         }
+        if (mContext.checkCallingOrSelfPermission(ADD_TRUSTED_DISPLAY)
+                == PackageManager.PERMISSION_DENIED) {
+            flags &= ~DisplayManager.VIRTUAL_DISPLAY_FLAG_TRUSTED;
+        }
 
         Set<String> displayCategories;
         if (mPreferenceController.getBoolean(R.string.pref_enable_display_category)) {
@@ -156,6 +194,18 @@ class RemoteDisplay implements AutoCloseable {
                         .setDisplayCategories(displayCategories)
                         .setFlags(flags);
 
+        if (mPreferenceController.getBoolean(R.string.pref_enable_client_brightness)) {
+            virtualDisplayBuilder
+                    .setDefaultBrightness(DEFAULT_CLIENT_BRIGHTNESS)
+                    .setDimBrightness(DIM_CLIENT_BRIGHTNESS)
+                    .setBrightnessListener(
+                            Executors.newSingleThreadExecutor(), this::onBrightnessChanged);
+        } else {
+            mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                    .setBrightnessEvent(BrightnessEvent.newBuilder().setBrightness(-1f))
+                    .build());
+        }
+
         if (mDisplayType == DISPLAY_TYPE_HOME) {
             virtualDisplayBuilder = VdmCompat.setHomeSupported(virtualDisplayBuilder, flags);
         }
@@ -163,8 +213,8 @@ class RemoteDisplay implements AutoCloseable {
         mVirtualDisplay =
                 virtualDevice.createVirtualDisplay(
                         virtualDisplayBuilder.build(),
-                        /* executor= */ Runnable::run,
-                        /* callback= */ null);
+                        Runnable::run,
+                        mVirtualDisplayCallback);
 
         VdmCompat.setDisplayImePolicy(
                 mVirtualDevice,
@@ -279,6 +329,13 @@ class RemoteDisplay implements AutoCloseable {
         }
     }
 
+    private void onBrightnessChanged(float brightness) {
+        Log.v(TAG, "VirtualDisplay brightness changed to " + brightness);
+        mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                .setBrightnessEvent(BrightnessEvent.newBuilder().setBrightness(brightness))
+                .build());
+    }
+
     void processRemoteEvent(RemoteEvent event) {
         if (event.getDisplayId() != mRemoteDisplayId) {
             return;
@@ -338,11 +395,10 @@ class RemoteDisplay implements AutoCloseable {
                 break;
             case DEVICE_TYPE_ROTARY_ENCODER:
                 processRotaryEvent(remoteEventToVirtualRotaryEncoderEvent(inputEvent));
+                break;
             default:
-                Log.e(
-                        TAG,
-                        "processInputEvent got an invalid input device type: "
-                                + inputEvent.getDeviceType().getNumber());
+                Log.e(TAG, "processInputEvent got an invalid input device type: "
+                        + inputEvent.getDeviceType().getNumber());
                 break;
         }
     }
@@ -362,10 +418,8 @@ class RemoteDisplay implements AutoCloseable {
                 processRotaryEvent(motionEventToVirtualRotaryEncoderEvent((MotionEvent) event));
                 break;
             default:
-                Log.e(
-                        TAG,
-                        "processInputEvent got an invalid input device type: "
-                                + deviceType.getNumber());
+                Log.e(TAG, "processInputEvent got an invalid input device type: "
+                        + deviceType.getNumber());
                 break;
         }
     }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RunningVdmUidsTracker.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RunningVdmUidsTracker.java
index 60cdd40a7..5a61510c7 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RunningVdmUidsTracker.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RunningVdmUidsTracker.java
@@ -26,6 +26,8 @@ import android.util.Log;
 import androidx.annotation.GuardedBy;
 import androidx.annotation.NonNull;
 
+import com.google.common.collect.ImmutableSet;
+
 import java.util.Collection;
 import java.util.Collections;
 import java.util.HashMap;
@@ -70,7 +72,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
 
         observers.put(R.string.pref_enable_client_audio, b -> {
             synchronized (mLock) {
-                updateVdmUids(mRunningVdmUids);
+                updateVdmUids(ImmutableSet.copyOf(mRunningVdmUids));
             }
         });
 
@@ -86,7 +88,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
             return;
         }
 
-        final Set<Integer> updatedUids;
+        final ImmutableSet<Integer> updatedUids;
         synchronized (mLock) {
             HashSet<Integer> displayUidSet =
                     mDisplayIdToRunningUids.computeIfAbsent(displayId, k -> new HashSet<>());
@@ -95,7 +97,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
                     mDisplayIdToRunningUids.values().stream()
                             .flatMap(Collection::stream)
                             .collect(Collectors.toSet());
-            updatedUids = mRunningVdmUids;
+            updatedUids = ImmutableSet.copyOf(mRunningVdmUids);
         }
 
         updateVdmUids(updatedUids);
@@ -104,7 +106,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
     @Override
     public void onDisplayEmpty(int displayId) {
         Set<Integer> uidsBefore;
-        Set<Integer> uidsAfter;
+        ImmutableSet<Integer> uidsAfter;
         synchronized (mLock) {
             uidsBefore = mRunningVdmUids;
             mDisplayIdToRunningUids.remove(displayId);
@@ -112,7 +114,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
                     mDisplayIdToRunningUids.values().stream()
                             .flatMap(Collection::stream)
                             .collect(Collectors.toSet());
-            uidsAfter = mRunningVdmUids;
+            uidsAfter = ImmutableSet.copyOf(mRunningVdmUids);
         }
 
         if (!uidsAfter.equals(uidsBefore)) {
@@ -120,7 +122,7 @@ final class RunningVdmUidsTracker implements ActivityListener {
         }
     }
 
-    private void updateVdmUids(Set<Integer> uids) {
+    private void updateVdmUids(ImmutableSet<Integer> uids) {
         if (mPreferenceController.getBoolean(R.string.pref_enable_client_audio)) {
             mAudioStreamer.updateVdmUids(uids);
             mAudioInjector.updateVdmUids(uids);
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/SettingsActivity.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/SettingsActivity.java
index 3cc1aaf62..a03e98139 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/SettingsActivity.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/SettingsActivity.java
@@ -46,6 +46,12 @@ public class SettingsActivity extends Hilt_SettingsActivity {
 
         @Inject PreferenceController mPreferenceController;
 
+        @Override
+        public void onResume() {
+            super.onResume();
+            mPreferenceController.evaluate(getPreferenceManager());
+        }
+
         @Override
         public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
             setPreferencesFromResource(R.xml.preferences, rootKey);
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmCompat.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmCompat.java
index 6d0897d9b..d8a081dd2 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmCompat.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmCompat.java
@@ -16,11 +16,16 @@
 
 package com.example.android.vdmdemo.host;
 
+import static android.Manifest.permission.ADD_MIRROR_DISPLAY;
+
+import android.companion.AssociationRequest;
 import android.companion.virtual.VirtualDeviceManager.VirtualDevice;
-import android.companion.virtual.flags.Flags;
+import android.companion.virtualdevice.flags.Flags;
 import android.content.Context;
+import android.content.pm.PackageManager;
 import android.hardware.display.VirtualDisplayConfig;
 import android.hardware.input.InputManager;
+import android.os.Build;
 import android.view.InputDevice;
 
 import androidx.core.os.BuildCompat;
@@ -34,7 +39,7 @@ public class VdmCompat {
 
     static VirtualDisplayConfig.Builder setHomeSupported(
             VirtualDisplayConfig.Builder builder, int flags) {
-        if (BuildCompat.isAtLeastV() && Flags.vdmCustomHome()) {
+        if (BuildCompat.isAtLeastV() && android.companion.virtual.flags.Flags.vdmCustomHome()) {
             return builder.setHomeSupported(true);
         } else {
             return builder.setFlags(flags | VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS);
@@ -61,4 +66,18 @@ public class VdmCompat {
         }
         return true;
     }
+
+    static boolean isMirrorDisplaySupported(Context context,
+            PreferenceController preferenceController) {
+        if (!preferenceController.getBoolean(R.string.internal_pref_mirror_displays_supported)) {
+            return false;
+        }
+        // TODO: replace with isAtLeastB once available.
+        if (Flags.enableLimitedVdmRole()) {
+            return context.checkCallingOrSelfPermission(ADD_MIRROR_DISPLAY)
+                    == PackageManager.PERMISSION_GRANTED;
+        }
+        return preferenceController.getString(R.string.pref_device_profile)
+                .equals(AssociationRequest.DEVICE_PROFILE_APP_STREAMING);
+    }
 }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
index 31411e3c6..bcf115d6c 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
@@ -67,6 +67,7 @@ import androidx.annotation.Nullable;
 import androidx.core.os.BuildCompat;
 
 import com.example.android.vdmdemo.common.ConnectionManager;
+import com.example.android.vdmdemo.common.RemoteEventProto;
 import com.example.android.vdmdemo.common.RemoteEventProto.DeviceCapabilities;
 import com.example.android.vdmdemo.common.RemoteEventProto.DisplayChangeEvent;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
@@ -77,6 +78,8 @@ import com.google.common.util.concurrent.MoreExecutors;
 
 import dagger.hilt.android.AndroidEntryPoint;
 
+import java.time.Duration;
+import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.HashMap;
 import java.util.Map;
@@ -100,8 +103,6 @@ public final class VdmService extends Hilt_VdmService {
 
     private static final String ACTION_STOP = "com.example.android.vdmdemo.host.VdmService.STOP";
 
-    public static final String ACTION_LOCKDOWN =
-            "com.example.android.vdmdemo.host.VdmService.LOCKDOWN";
     private int mRecordingAudioSessionId;
     private int mPlaybackAudioSessionId;
 
@@ -142,7 +143,7 @@ public final class VdmService extends Hilt_VdmService {
     private DisplayManager mDisplayManager;
     private KeyguardManager mKeyguardManager;
     private VirtualDeviceManager mVirtualDeviceManager;
-    private Consumer<Boolean> mLocalVirtualDeviceLifecycleListener;
+    private ArrayList<Consumer<Boolean>> mLocalVirtualDeviceLifecycleListeners = new ArrayList<>();
 
     private VirtualDeviceManager.VirtualDeviceListener mVirtualDeviceListener;
 
@@ -284,11 +285,6 @@ public final class VdmService extends Hilt_VdmService {
             return START_NOT_STICKY;
         }
 
-        if (intent != null && ACTION_LOCKDOWN.equals(intent.getAction())) {
-            lockdown();
-            return START_STICKY;
-        }
-
         NotificationChannel notificationChannel =
                 new NotificationChannel(
                         CHANNEL_ID, "VDM Service Channel", NotificationManager.IMPORTANCE_LOW);
@@ -365,12 +361,14 @@ public final class VdmService extends Hilt_VdmService {
         closeVirtualDevice();
         mRemoteIo.removeMessageConsumer(mRemoteEventConsumer);
         mDisplayManager.unregisterDisplayListener(mDisplayListener);
-        mAudioStreamer.stop();
-        mAudioInjector.stop();
     }
 
-    void setVirtualDeviceListener(Consumer<Boolean> listener) {
-        mLocalVirtualDeviceLifecycleListener = listener;
+    void addVirtualDeviceListener(Consumer<Boolean> listener) {
+        mLocalVirtualDeviceLifecycleListeners.add(listener);
+    }
+
+    void removeVirtualDeviceListener(Consumer<Boolean> listener) {
+        mLocalVirtualDeviceLifecycleListeners.remove(listener);
     }
 
     private void processRemoteEvent(RemoteEvent event) {
@@ -397,48 +395,83 @@ public final class VdmService extends Hilt_VdmService {
             mDisplayRepository.removeDisplayByRemoteId(event.getDisplayId());
         } else if (event.hasDisplayChangeEvent() && event.getDisplayChangeEvent().getFocused()) {
             mInputController.setFocusedRemoteDisplayId(event.getDisplayId());
+        } else if (event.hasDeviceState() && Flags.deviceAwareDisplayPower()
+                && mVirtualDevice != null) {
+            if (event.getDeviceState().getPowerOn()) {
+                mVirtualDevice.wakeUp();
+            } else {
+                mVirtualDevice.goToSleep();
+            }
         }
     }
 
     private void handleAudioCapabilities() {
         if (mPreferenceController.getBoolean(R.string.pref_enable_client_audio)) {
+            openAudio();
+        } else {
+            closeAudio();
+        }
+    }
+
+    private void openAudio() {
+        AudioManager audioManager = getSystemService(AudioManager.class);
+        if (audioManager != null) {
+            // Assuming one playback session id and one recording session id per host (for now)
+            // Reuse them if already initialized
+            if (mPlaybackAudioSessionId == 0) {
+                mPlaybackAudioSessionId = audioManager.generateAudioSessionId();
+            }
+            if (mRecordingAudioSessionId == 0) {
+                mRecordingAudioSessionId = audioManager.generateAudioSessionId();
+            }
+
             if (mVirtualDevice != null) {
                 if (mDeviceCapabilities.getSupportsAudioOutput()) {
                     mAudioStreamer.start(mVirtualDevice.getDeviceId(), mPlaybackAudioSessionId);
+                } else {
+                    mAudioStreamer.stop();
                 }
+
                 if (mDeviceCapabilities.getSupportsAudioInput()) {
                     mAudioInjector.start(mVirtualDevice.getDeviceId(), mRecordingAudioSessionId);
+                } else {
+                    mAudioInjector.stop();
                 }
             }
-        } else {
-            mAudioStreamer.stop();
-            mAudioInjector.stop();
         }
     }
 
+    private void closeAudio() {
+        mAudioStreamer.stop();
+        mAudioInjector.stop();
+    }
+
     private void associateAndCreateVirtualDevice() {
         CompanionDeviceManager cdm =
                 Objects.requireNonNull(getSystemService(CompanionDeviceManager.class));
         RoleManager rm = Objects.requireNonNull(getSystemService(RoleManager.class));
         final String deviceProfile = mPreferenceController.getString(R.string.pref_device_profile);
+        AssociationInfo existingAssociation = null;
         for (AssociationInfo associationInfo : cdm.getMyAssociations()) {
-            if (!Objects.equals(associationInfo.getDeviceProfile(), deviceProfile)
-                    || !Objects.equals(associationInfo.getPackageName(), getPackageName())
-                    || associationInfo.getDisplayName() == null
-                    || !Objects.equals(
-                    associationInfo.getDisplayName().toString(),
-                    mDeviceCapabilities.getDeviceName())) {
-                continue;
-            }
-            // It is possible that the role was revoked but the CDM association remained.
-            if (!rm.isRoleHeld(deviceProfile)) {
-                cdm.disassociate(associationInfo.getId());
-                break;
+            if (rm.isRoleHeld(deviceProfile)
+                    && Objects.equals(associationInfo.getPackageName(), getPackageName())
+                    && Objects.equals(associationInfo.getDeviceProfile(), deviceProfile)
+                    && associationInfo.getDisplayName() != null
+                    && Objects.equals(associationInfo.getDisplayName().toString(),
+                            mDeviceCapabilities.getDeviceName())) {
+                Log.d(TAG, "Reusing association " + associationInfo.getDisplayName() + " for "
+                        + deviceProfile);
+                existingAssociation = associationInfo;
             } else {
-                createVirtualDevice(associationInfo);
-                return;
+                Log.d(TAG, "Removing association " + associationInfo.getDisplayName() + " / "
+                        + associationInfo.getDeviceProfile());
+                cdm.disassociate(associationInfo.getId());
             }
         }
+        if (existingAssociation != null) {
+            createVirtualDevice(existingAssociation);
+            return;
+        }
 
         @SuppressLint("MissingPermission")
         AssociationRequest.Builder associationRequest =
@@ -477,15 +510,18 @@ public final class VdmService extends Hilt_VdmService {
     }
 
     private void createVirtualDevice(AssociationInfo associationInfo) {
+        Log.d(TAG, "VdmService createVirtualDevice name: "
+                + mDeviceCapabilities.getDeviceName() + " with association: " + associationInfo);
+
         VirtualDeviceParams.Builder virtualDeviceBuilder =
                 new VirtualDeviceParams.Builder()
                         .setName("VirtualDevice - " + mDeviceCapabilities.getDeviceName());
 
-        AudioManager audioManager = getSystemService(AudioManager.class);
-        mPlaybackAudioSessionId = audioManager.generateAudioSessionId();
-        mRecordingAudioSessionId = audioManager.generateAudioSessionId();
+        mPreferenceController.evaluate();
 
         if (mPreferenceController.getBoolean(R.string.pref_enable_client_audio)) {
+            openAudio();
+
             virtualDeviceBuilder.setDevicePolicy(POLICY_TYPE_AUDIO, DEVICE_POLICY_CUSTOM)
                     .setAudioPlaybackSessionId(mPlaybackAudioSessionId)
                     .setAudioRecordingSessionId(mRecordingAudioSessionId);
@@ -506,6 +542,14 @@ public final class VdmService extends Hilt_VdmService {
             }
         }
 
+        if (Flags.deviceAwareDisplayPower()) {
+            int displayTimeout = Integer.parseInt(
+                    mPreferenceController.getString(R.string.pref_display_timeout));
+            virtualDeviceBuilder
+                    .setDimDuration(Duration.ofMillis(displayTimeout / 2))
+                    .setScreenOffTimeout(Duration.ofMillis(displayTimeout));
+        }
+
         if (mPreferenceController.getBoolean(R.string.pref_hide_from_recents)) {
             virtualDeviceBuilder.setDevicePolicy(POLICY_TYPE_RECENTS, DEVICE_POLICY_CUSTOM);
         }
@@ -584,24 +628,26 @@ public final class VdmService extends Hilt_VdmService {
         }
 
         Log.i(TAG, "Created virtual device");
-        if (mLocalVirtualDeviceLifecycleListener != null) {
-            mLocalVirtualDeviceLifecycleListener.accept(true);
+        for (Consumer<Boolean> listener : mLocalVirtualDeviceLifecycleListeners) {
+            listener.accept(true);
         }
-    }
-
-    private void lockdown() {
-        Log.i(TAG, "Initiating Lockdown.");
-        mDisplayRepository.clear();
+        mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                .setDeviceState(RemoteEventProto.DeviceState.newBuilder().setPowerOn(true))
+                .build());
     }
 
     private synchronized void closeVirtualDevice() {
-        if (mLocalVirtualDeviceLifecycleListener != null) {
-            mLocalVirtualDeviceLifecycleListener.accept(false);
+        for (Consumer<Boolean> listener : mLocalVirtualDeviceLifecycleListeners) {
+            listener.accept(false);
         }
+
         if (mRemoteSensorManager != null) {
             mRemoteSensorManager.close();
             mRemoteSensorManager = null;
         }
+
+        closeAudio();
+
         if (mVirtualDevice != null) {
             Log.i(TAG, "Closing virtual device");
             mDisplayRepository.clear();
@@ -694,7 +740,7 @@ public final class VdmService extends Hilt_VdmService {
         observers.put(R.string.pref_display_ime_policy,
                 s -> {
                     if (mVirtualDevice != null) {
-                        int policy = Integer.valueOf((String) s);
+                        int policy = Integer.parseInt((String) s);
                         Arrays.stream(mDisplayRepository.getDisplayIds()).forEach(
                                 displayId -> mVirtualDevice.setDisplayImePolicy(displayId, policy));
                     }
@@ -705,6 +751,7 @@ public final class VdmService extends Hilt_VdmService {
         observers.put(R.string.pref_always_unlocked_device, v -> recreateVirtualDevice());
         observers.put(R.string.pref_enable_client_native_ime, v -> recreateVirtualDevice());
         observers.put(R.string.pref_enable_custom_home, v -> recreateVirtualDevice());
+        observers.put(R.string.pref_display_timeout, v -> recreateVirtualDevice());
         observers.put(R.string.pref_enable_display_category, v -> recreateVirtualDevice());
 
         return observers;
diff --git a/scripts/cargo2rulesmk.py b/scripts/cargo2rulesmk.py
index 722484983..fcd7c209a 100755
--- a/scripts/cargo2rulesmk.py
+++ b/scripts/cargo2rulesmk.py
@@ -718,48 +718,55 @@ class Runner(object):
                 sys.exit("ERROR: cannot find cargo in " + self.args.cargo_bin)
             print("INFO: using cargo in " + self.args.cargo_bin)
             return
-        # TODO(perlarsen): try getting cargo from $RUST_BINDIR set in envsetup.sh
+
         # We have only tested this on Linux.
         if platform.system() != "Linux":
             sys.exit(
                 "ERROR: this script has only been tested on Linux with cargo."
             )
+
         # Assuming that this script is in development/scripts
-        linux_dir = os.path.join(
-            TOP_DIR, "prebuilts", "rust", "linux-x86"
+        env_setup_sh = os.path.join(
+            TOP_DIR, "trusty/vendor/google/aosp/scripts/envsetup.sh"
         )
-        if not os.path.isdir(linux_dir):
-            sys.exit("ERROR: cannot find directory " + linux_dir)
-        rust_version = self.find_rust_version(linux_dir)
-        if self.args.verbose:
-            print(f"### INFO: using prebuilt rust version {rust_version}")
-        cargo_bin = os.path.join(linux_dir, rust_version, "bin")
-        self.cargo_path = os.path.join(cargo_bin, "cargo")
+        if not os.path.exists(env_setup_sh):
+            sys.exit("ERROR: missing " + env_setup_sh)
+        rust_version = self.find_rust_version(env_setup_sh)
+        self.cargo_path =  os.path.join(
+            TOP_DIR, f"prebuilts/rust/linux-x86/{rust_version}/bin/cargo"
+        )
+
         if not os.path.isfile(self.cargo_path):
             sys.exit(
-                "ERROR: cannot find cargo in "
-                + cargo_bin
-                + "; please try --cargo_bin= flag."
+                "ERROR: no cargo at "
+                + self.cargo_path
+                + "; consider using the --cargo_bin= flag."
             )
-        return
-
-    def find_rust_version(self, linux_dir):
-        """find newest prebuilt rust version."""
-        # find the newest (largest) version number in linux_dir.
-        rust_version = (0, 0, 0)  # the prebuilt version to use
-        version_pat = re.compile(r"([0-9]+)\.([0-9]+)\.([0-9]+)$")
-        for dir_name in os.listdir(linux_dir):
-            result = version_pat.match(dir_name)
-            if not result:
-                continue
-            version = (
-                int(result.group(1)),
-                int(result.group(2)),
-                int(result.group(3)),
-            )
-            if version > rust_version:
-                rust_version = version
-        return ".".join(str(ver) for ver in rust_version)
+
+        if self.args.verbose:
+            print(f"### INFO: using cargo from {self.cargo_path}")
+
+    def find_rust_version(self, env_setup_sh):
+        """find the Rust version used by Trusty from envsetup.sh"""
+
+        version_pat = re.compile(r"prebuilts/rust/linux-x86/([0-9]+\.[0-9]+\..+)/bin")
+
+        with open(env_setup_sh) as fh:
+            for line in fh.readlines():
+                if line.lstrip().startswith("export RUST_BINDIR"):
+                    if not (result := version_pat.search(line)):
+                        sys.exit("ERROR: failed to parse rust version "
+                                 + "from RUST_BINDIR in envsetup.sh: "
+                                 + line
+                        )
+                    version = result.group(1)
+
+                    if self.args.verbose:
+                        print(f"### INFO: using rust version {version}")
+
+                    return version
+
+        sys.exit("ERROR: failed to parse {env_setup_sh}; is RUST_BINDIR exported?")
 
     def find_out_files(self):
         # list1 has build.rs output for normal crates
diff --git a/sdk/build_tools_source.prop_template b/sdk/build_tools_source.prop_template
index 63cca10ef..551dc96db 100644
--- a/sdk/build_tools_source.prop_template
+++ b/sdk/build_tools_source.prop_template
@@ -1,3 +1,3 @@
 Pkg.UserSrc=false
-Pkg.Revision=${PLATFORM_SDK_VERSION}.0.0
-#Pkg.Revision=35.0.0 rc4
+#Pkg.Revision=${PLATFORM_SDK_VERSION}.0.0
+Pkg.Revision=36.0.0 rc1
diff --git a/sdk/plat_tools_source.prop_template b/sdk/plat_tools_source.prop_template
index 9f633ab82..dc3a2fe99 100644
--- a/sdk/plat_tools_source.prop_template
+++ b/sdk/plat_tools_source.prop_template
@@ -1,2 +1,2 @@
 Pkg.UserSrc=false
-Pkg.Revision=35.0.2
+Pkg.Revision=36.0.0
diff --git a/sdk/sdk_files_NOTICE.txt b/sdk/sdk_files_NOTICE.txt
index 7e9633f78..ef8ea8e58 100644
--- a/sdk/sdk_files_NOTICE.txt
+++ b/sdk/sdk_files_NOTICE.txt
@@ -4680,7 +4680,7 @@ Introduction
   encourage you to use the following text:
 
    """  
-    Portions of this software are copyright  <year> The FreeType
+    Portions of this software are copyright  <year> The FreeType
     Project (www.freetype.org).  All rights reserved.
    """
 
@@ -12421,7 +12421,6 @@ Notices for file(s):
 ------------------------------------------------------------
 
    Copyright (c) 2006-2009, The Android Open Source Project
-   Copyright 2006, Brian Swetland <swetland@frotz.net>
 
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
@@ -13555,7 +13554,7 @@ Notices for file(s):
  *   limitations under the License.
  */
 
-W3C SOFTWARE NOTICE AND LICENSE
+W3C SOFTWARE NOTICE AND LICENSE
 http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231
 
 This work (and included software, documentation such as READMEs, or other
diff --git a/tools/cargo_embargo/Android.bp b/tools/cargo_embargo/Android.bp
index 25a47c6d5..0d4a5c3f9 100644
--- a/tools/cargo_embargo/Android.bp
+++ b/tools/cargo_embargo/Android.bp
@@ -38,6 +38,7 @@ rust_defaults {
 
 rust_binary_host {
     name: "cargo_embargo",
+    required: ["bpfmt"],
     defaults: ["cargo_embargo.defaults"],
 }
 
diff --git a/tools/cargo_embargo/README.md b/tools/cargo_embargo/README.md
index 74b56c53b..264a7f442 100644
--- a/tools/cargo_embargo/README.md
+++ b/tools/cargo_embargo/README.md
@@ -85,6 +85,8 @@ These options may all be specified at the top level of the config file, or overr
 | `module_blocklist`         | list of strings           | `[]`                                                        | Modules in this list will not be generated.                                                                                                                                 |
 | `module_visibility`        | string => list of strings | `{}`                                                        | Modules name => Soong "visibility" property.                                                                                                                                |
 | `run_cargo`                | boolean                   | `true`                                                      | Whether to run the cargo build and parse its output, rather than just figuring things out from the cargo metadata.                                                          |
+| `generate_androidbp`       | boolean                   | `true`                                                      | Whether to generate Android build rules in an `Android.bp` file.                                                                                                            |
+| `generate_rulesmk`         | boolean                   | `false`                                                     | Whether to generate Trusty build rules in `rules.mk` and `Android.bp` files.                                                                                                |
 
 Of particular note, it is preferable to set `run_cargo` to `false` where possible as it is
 significantly faster. However, this may miss important details in more complicated cases, such as
@@ -100,6 +102,8 @@ specified outside of a package.
 | ----------------------- | ------------------------- | ------- | ----------- | ------------------------------------------------------------------------------------------------------------------ |
 | `add_toplevel_block`    | path                      | -       | no          | File with content to append to the end of the generated Android.bp.                                                |
 | `patch`                 | path                      | -       | no          | Patch file to apply after Android.bp is generated.                                                                 |
+| `rulesmk_patch`         | path                      | -       | no          | Patch file to apply after rules.mk is generated.                                                                   |
+| `license_text`          | list of paths             | -       | no          | Files to use for `license_text` in `license` module.                                                               |
 | `alloc`                 | boolean                   | `false` | yes         | Link against `alloc`. Only valid if `no_std` is also true.                                                         |
 | `device_supported`      | boolean                   | `true`  | yes         | Whether to compile for device. Defaults to true.                                                                   |
 | `host_supported`        | boolean                   | `true`  | yes         | Whether to compile for host. Defaults to true.                                                                     |
diff --git a/tools/cargo_embargo/src/cargo/cargo_out.rs b/tools/cargo_embargo/src/cargo/cargo_out.rs
index ee28cee46..4b6e441f2 100644
--- a/tools/cargo_embargo/src/cargo/cargo_out.rs
+++ b/tools/cargo_embargo/src/cargo/cargo_out.rs
@@ -431,6 +431,8 @@ impl Crate {
                 _ if arg.starts_with("--deny=") => {}
                 _ if arg.starts_with("-W") => {}
                 _ if arg.starts_with("--warn=") => {}
+                _ if arg.starts_with("--allow=deprecated") => {}
+                _ if arg.starts_with("--allow=unexpected_cfgs") => {}
 
                 arg => bail!("unsupported rustc argument: {arg:?}"),
             }
diff --git a/tools/cargo_embargo/src/config.rs b/tools/cargo_embargo/src/config.rs
index e64eb6d75..1b6bc43fa 100644
--- a/tools/cargo_embargo/src/config.rs
+++ b/tools/cargo_embargo/src/config.rs
@@ -325,10 +325,10 @@ pub struct VariantConfig {
     /// from the cargo metadata.
     #[serde(default = "default_true", skip_serializing_if = "is_true")]
     pub run_cargo: bool,
-    /// Generate an Android.bp build file for this variant if true.
+    /// Generate Android build rules at Android.bp for this variant if true.
     #[serde(default = "default_true", skip_serializing_if = "is_true")]
     pub generate_androidbp: bool,
-    /// Generate a rules.mk build file for this variant if true.
+    /// Generate Trusty build rules at rules.mk and Android.bp if true.
     #[serde(default, skip_serializing_if = "is_false")]
     pub generate_rulesmk: bool,
 }
@@ -379,7 +379,7 @@ pub struct PackageConfig {
     /// `license_text` to use for `license` module, overriding the `license_file` given by the
     /// package or the default "LICENSE".
     #[serde(skip_serializing_if = "Option::is_none")]
-    pub license_text: Option<String>,
+    pub license_text: Option<Vec<String>>,
 }
 
 impl PackageConfig {
diff --git a/tools/cargo_embargo/src/main.rs b/tools/cargo_embargo/src/main.rs
index 93f837a7b..8094dce99 100644
--- a/tools/cargo_embargo/src/main.rs
+++ b/tools/cargo_embargo/src/main.rs
@@ -332,7 +332,7 @@ fn run_embargo(args: &Args, config_filename: &Path, intermediates_dir: &Path) ->
         .to_str()
         .ok_or(anyhow!("Failed to convert intermediate dir path to string"))?
         .to_string()
-        + "target.tmp/**/build/*/out/*";
+        + "/target.tmp/**/build/*/out/*";
 
     let cfg = Config::from_file(config_filename)?;
     let crates = make_all_crates(args, &cfg, intermediates_dir)?;
@@ -575,8 +575,9 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
 /// Skips initial comment lines, then returns all lines before the first line
 /// starting with `rust_`, `genrule {`, or `LOCAL_DIR`.
 ///
-/// If `path` could not be read, return a placeholder license TODO line.
-fn read_license_header(path: &Path) -> Result<String> {
+/// If `path` could not be read and a license is required, return a
+/// placeholder license TODO line.
+fn read_license_header(path: &Path, require_license: bool) -> Result<String> {
     // Keep the old license header.
     match std::fs::read_to_string(path) {
         Ok(s) => Ok(s
@@ -590,7 +591,12 @@ fn read_license_header(path: &Path) -> Result<String> {
             .collect::<Vec<&str>>()
             .join("\n")),
         Err(e) if e.kind() == std::io::ErrorKind::NotFound => {
-            Ok("// DO NOT SUBMIT: Add license before submitting.\n".to_string())
+            let placeholder = if require_license {
+                "// DO NOT SUBMIT: Add license before submitting.\n"
+            } else {
+                ""
+            };
+            Ok(placeholder.to_string())
         }
         Err(e) => Err(anyhow!("error when reading {path:?}: {e}")),
     }
@@ -648,6 +654,10 @@ fn write_build_files(
             )?;
         }
     }
+    if !mk_contents.is_empty() {
+        // If rules.mk is generated, then make it accessible via dirgroup.
+        bp_contents += &generate_android_bp_for_rules_mk(package_name)?;
+    }
 
     let def = PackageConfig::default();
     let package_cfg = cfg.package.get(package_name).unwrap_or(&def);
@@ -661,8 +671,9 @@ fn write_build_files(
         let package_header = generate_android_bp_package_header(
             package_name,
             package_cfg,
-            read_license_header(&output_path)?.trim(),
+            read_license_header(&output_path, true)?.trim(),
             crates,
+            &cfg.variants.first().unwrap().module_name_overrides,
         )?;
         let bp_contents = package_header + &bp_contents;
         write_format_android_bp(&output_path, &bp_contents, package_cfg.patch.as_deref())?;
@@ -673,7 +684,7 @@ fn write_build_files(
             + "# Do not modify this file after the LOCAL_DIR line\n"
             + "# because the changes will be overridden on upgrade.\n"
             + "# Content before the first line starting with LOCAL_DIR is preserved.\n"
-            + read_license_header(&output_path)?.trim()
+            + read_license_header(&output_path, false)?.trim()
             + "\n"
             + &mk_contents;
         File::create(&output_path)?.write_all(mk_contents.as_bytes())?;
@@ -690,14 +701,26 @@ fn generate_android_bp_package_header(
     package_cfg: &PackageConfig,
     license_header: &str,
     crates: &[Vec<Crate>],
+    module_name_overrides: &BTreeMap<String, String>,
 ) -> Result<String> {
     let crates = crates.iter().flatten().collect::<Vec<_>>();
     if let Some(first) = crates.first() {
         if let Some(license) = first.license.as_ref() {
             if crates.iter().all(|c| c.license.as_ref() == Some(license)) {
                 let mut modules = Vec::new();
-                let license = choose_license(license);
-                let license_name = format!("external_rust_crates_{}_license", package_name);
+                let licenses = choose_licenses(license)?;
+
+                let default_license_name = format!("external_rust_crates_{}_license", package_name);
+
+                let license_name = match override_module_name(
+                    &default_license_name,
+                    &[],
+                    module_name_overrides,
+                    &RENAME_MAP,
+                ) {
+                    Some(x) => x,
+                    None => default_license_name,
+                };
 
                 let mut package_module = BpModule::new("package".to_string());
                 package_module.props.set("default_team", "trendy_team_android_rust");
@@ -707,15 +730,17 @@ fn generate_android_bp_package_header(
                 let mut license_module = BpModule::new("license".to_string());
                 license_module.props.set("name", license_name);
                 license_module.props.set("visibility", vec![":__subpackages__"]);
-                license_module
-                    .props
-                    .set("license_kinds", vec![format!("SPDX-license-identifier-{}", license)]);
-                let license_text = package_cfg
-                    .license_text
-                    .as_deref()
-                    .unwrap_or_else(|| first.license_file.as_deref().unwrap_or("LICENSE"))
-                    .to_string();
-                license_module.props.set("license_text", vec![license_text]);
+                license_module.props.set(
+                    "license_kinds",
+                    licenses
+                        .into_iter()
+                        .map(|license| format!("SPDX-license-identifier-{}", license))
+                        .collect::<Vec<_>>(),
+                );
+                let license_text = package_cfg.license_text.clone().unwrap_or_else(|| {
+                    vec![first.license_file.as_deref().unwrap_or("LICENSE").to_string()]
+                });
+                license_module.props.set("license_text", license_text);
                 modules.push(license_module);
 
                 let mut bp_contents = "// This file is generated by cargo_embargo.\n".to_owned()
@@ -739,24 +764,58 @@ fn generate_android_bp_package_header(
         + "\n")
 }
 
-/// Given an SPDX license expression that may offer a choice between several licenses, choose one to
-/// use.
-fn choose_license(license: &str) -> &str {
-    match license {
-        "MIT OR Apache-2.0" => "Apache-2.0",
-        "Apache-2.0 OR MIT" => "Apache-2.0",
-        "MIT/Apache-2.0" => "Apache-2.0",
-        "Apache-2.0/MIT" => "Apache-2.0",
-        "Apache-2.0 or BSD-3-Clause" => "Apache-2.0",
-        "Zlib OR Apache-2.0 OR MIT" => "Apache-2.0",
-        "MIT OR LGPL-3.0-or-later" => "MIT",
-        "Apache-2.0 / MIT" => "Apache-2.0",
-        "Unlicense OR MIT" => "MIT",
-        "BSD-3-Clause OR MIT OR Apache-2.0" => "Apache-2.0",
-        "BSD-2-Clause OR Apache-2.0 OR MIT" => "Apache-2.0",
-        "Apache-2.0 WITH LLVM-exception OR Apache-2.0 OR MIT" => "Apache-2.0",
-        _ => license,
-    }
+/// Given an SPDX license expression that may offer a choice between several licenses, choose one or
+/// more to use.
+fn choose_licenses(license: &str) -> Result<Vec<&str>> {
+    Ok(match license {
+        // Variations on "MIT OR Apache-2.0"
+        "MIT OR Apache-2.0" => vec!["Apache-2.0"],
+        "Apache-2.0 OR MIT" => vec!["Apache-2.0"],
+        "MIT/Apache-2.0" => vec!["Apache-2.0"],
+        "Apache-2.0/MIT" => vec!["Apache-2.0"],
+        "Apache-2.0 / MIT" => vec!["Apache-2.0"],
+
+        // Variations on "BSD-* OR Apache-2.0"
+        "Apache-2.0 OR BSD-3-Clause" => vec!["Apache-2.0"],
+        "Apache-2.0 or BSD-3-Clause" => vec!["Apache-2.0"],
+        "BSD-3-Clause OR Apache-2.0" => vec!["Apache-2.0"],
+
+        // Variations on "BSD-* OR MIT OR Apache-2.0"
+        "BSD-3-Clause OR MIT OR Apache-2.0" => vec!["Apache-2.0"],
+        "BSD-2-Clause OR Apache-2.0 OR MIT" => vec!["Apache-2.0"],
+
+        // Variations on "Zlib OR MIT OR Apache-2.0"
+        "Zlib OR Apache-2.0 OR MIT" => vec!["Apache-2.0"],
+        "MIT OR Apache-2.0 OR Zlib" => vec!["Apache-2.0"],
+
+        // Variations on "Apache-2.0 OR *"
+        "Apache-2.0 OR BSL-1.0" => vec!["Apache-2.0"],
+        "Apache-2.0 WITH LLVM-exception OR Apache-2.0 OR MIT" => vec!["Apache-2.0"],
+
+        // Variations on "Unlicense OR MIT"
+        "Unlicense OR MIT" => vec!["MIT"],
+        "Unlicense/MIT" => vec!["MIT"],
+
+        // Multiple licenses.
+        "(MIT OR Apache-2.0) AND Unicode-DFS-2016" => vec!["Apache-2.0", "Unicode-DFS-2016"],
+        "MIT AND BSD-3-Clause" => vec!["BSD-3-Clause", "MIT"],
+        // Usually we interpret "/" as "OR", but in the case of libfuzzer-sys, closer
+        // inspection of the terms indicates the correct interpretation is "(MIT OR APACHE) AND NCSA".
+        "MIT/Apache-2.0/NCSA" => vec!["Apache-2.0", "NCSA"],
+
+        // Other cases.
+        "MIT OR LGPL-3.0-or-later" => vec!["MIT"],
+        "MIT/BSD-3-Clause" => vec!["MIT"],
+
+        "LGPL-2.1-only OR BSD-2-Clause" => vec!["BSD-2-Clause"],
+        _ => {
+            // If there is whitespace, it is probably an SPDX expression.
+            if license.contains(char::is_whitespace) {
+                bail!("Unrecognized license: {license}");
+            }
+            vec![license]
+        }
+    })
 }
 
 /// Generates and returns a Soong Blueprint for the given set of crates, for a single variant of a
@@ -867,19 +926,37 @@ fn generate_rules_mk(
     })
 }
 
+/// Generates and returns a Soong Blueprint for a Trusty rules.mk
+fn generate_android_bp_for_rules_mk(package_name: &str) -> Result<String> {
+    let mut bp_contents = String::new();
+
+    let mut m = BpModule::new("dirgroup".to_string());
+    m.props.set("name", format!("trusty_dirgroup_external_rust_crates_{}", package_name));
+    m.props.set("dirs", vec!["."]);
+    m.props.set("visibility", vec!["//trusty/vendor/google/aosp/scripts"]);
+
+    m.write(&mut bp_contents)?;
+    bp_contents += "\n";
+
+    Ok(bp_contents)
+}
+
 /// Apply patch from `patch_path` to file `output_path`.
 ///
 /// Warns but still returns ok if the patch did not cleanly apply,
 fn apply_patch_file(output_path: &Path, patch_path: &Path) -> Result<()> {
     let patch_output = Command::new("patch")
         .arg("-s")
+        .arg("--no-backup-if-mismatch")
         .arg(output_path)
         .arg(patch_path)
         .output()
         .context("Running patch")?;
     if !patch_output.status.success() {
+        let stdout = String::from_utf8(patch_output.stdout)?;
+        let stderr = String::from_utf8(patch_output.stderr)?;
         // These errors will cause the cargo_embargo command to fail, but not yet!
-        return Err(anyhow!("failed to apply patch {patch_path:?}"));
+        bail!("failed to apply patch {patch_path:?}:\n\nout:\n{stdout}\n\nerr:\n{stderr}");
     }
     Ok(())
 }
@@ -1346,8 +1423,14 @@ mod tests {
             let package_name = &crates[0][0].package_name;
             let def = PackageConfig::default();
             let package_cfg = cfg.package.get(package_name).unwrap_or(&def);
-            let mut output =
-                generate_android_bp_package_header(package_name, package_cfg, "", &crates).unwrap();
+            let mut output = generate_android_bp_package_header(
+                package_name,
+                package_cfg,
+                "",
+                &crates,
+                &cfg.variants.first().unwrap().module_name_overrides,
+            )
+            .unwrap();
             for (variant_index, variant_cfg) in cfg.variants.iter().enumerate() {
                 let variant_crates = &crates[variant_index];
                 let package_name = &variant_crates[0].package_name;
diff --git a/tools/external_crates/Cargo.toml b/tools/external_crates/Cargo.toml
index cfcb6d71a..0ac4befcf 100644
--- a/tools/external_crates/Cargo.toml
+++ b/tools/external_crates/Cargo.toml
@@ -1,10 +1,11 @@
 [workspace]
 members = [
-    "crate_health",
+    "crate_tool",
     "google_metadata",
     "license_checker",
     "name_and_version",
     "name_and_version_proc_macros",
     "rooted_path",
+    "test_mapping",
 ]
 resolver = "2"
diff --git a/tools/external_crates/cargo_embargo.json b/tools/external_crates/cargo_embargo.json
index c2983b374..cd5d7e733 100644
--- a/tools/external_crates/cargo_embargo.json
+++ b/tools/external_crates/cargo_embargo.json
@@ -18,7 +18,8 @@
   "tests": true,
   "workspace": true,
   "workspace_excludes": [
-    "crate_health",
-    "license_checker"
+    "crate_tool",
+    "license_checker",
+    "test_mapping"
   ]
 }
diff --git a/tools/external_crates/crate_health/src/crate_type.rs b/tools/external_crates/crate_health/src/crate_type.rs
deleted file mode 100644
index 195de4b87..000000000
--- a/tools/external_crates/crate_health/src/crate_type.rs
+++ /dev/null
@@ -1,300 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{
-    fs::{read_dir, remove_dir_all},
-    path::Path,
-    process::{Command, Output},
-};
-
-use anyhow::{anyhow, Context, Result};
-use cargo::{
-    core::{Manifest, SourceId},
-    util::toml::read_manifest,
-    Config,
-};
-use name_and_version::{IsUpgradableTo, NameAndVersionRef, NamedAndVersioned};
-use rooted_path::RootedPath;
-use semver::Version;
-
-use crate::{copy_dir, ensure_exists_and_empty, generate_android_bps, CrateError};
-
-#[derive(Debug)]
-pub struct Crate {
-    manifest: Manifest,
-
-    path: RootedPath,
-
-    patch_output: Vec<(String, Output)>,
-    generate_android_bp_output: Option<Output>,
-    android_bp_diff: Option<Output>,
-}
-
-impl NamedAndVersioned for Crate {
-    fn name(&self) -> &str {
-        self.manifest.name().as_str()
-    }
-    fn version(&self) -> &Version {
-        self.manifest.version()
-    }
-    fn key(&self) -> NameAndVersionRef {
-        NameAndVersionRef::new(self.name(), self.version())
-    }
-}
-
-impl IsUpgradableTo for Crate {}
-
-impl Crate {
-    pub fn new(manifest: Manifest, path: RootedPath) -> Crate {
-        Crate {
-            manifest,
-            path,
-            patch_output: Vec::new(),
-            generate_android_bp_output: None,
-            android_bp_diff: None,
-        }
-    }
-    pub fn from(cargo_toml: RootedPath) -> Result<Crate> {
-        let manifest_dir =
-            cargo_toml.with_same_root(cargo_toml.rel().parent().ok_or(anyhow!(
-                "Failed to get parent directory of manifest at {}",
-                cargo_toml
-            ))?)?;
-        let source_id = SourceId::for_path(manifest_dir.abs())?;
-        let (manifest, _nested) =
-            read_manifest(cargo_toml.as_ref(), source_id, &Config::default()?)?;
-        match manifest {
-            cargo::core::EitherManifest::Real(r) => Ok(Crate::new(r, manifest_dir)),
-            cargo::core::EitherManifest::Virtual(_) => {
-                Err(anyhow!(CrateError::VirtualCrate(cargo_toml.as_ref().to_path_buf())))
-            }
-        }
-    }
-
-    pub fn description(&self) -> &str {
-        self.manifest.metadata().description.as_deref().unwrap_or("")
-    }
-    pub fn license(&self) -> Option<&str> {
-        self.manifest.metadata().license.as_deref()
-    }
-    pub fn license_file(&self) -> Option<&str> {
-        self.manifest.metadata().license_file.as_deref()
-    }
-    pub fn repository(&self) -> Option<&str> {
-        self.manifest.metadata().repository.as_deref()
-    }
-    pub fn path(&self) -> &RootedPath {
-        &self.path
-    }
-    pub fn android_bp(&self) -> RootedPath {
-        self.path.join("Android.bp").unwrap()
-    }
-    pub fn cargo_embargo_json(&self) -> RootedPath {
-        self.path.join("cargo_embargo.json").unwrap()
-    }
-    pub fn staging_path(&self) -> RootedPath {
-        self.path
-            .with_same_root("out/rust-crate-temporary-build")
-            .unwrap()
-            .join(self.staging_dir_name())
-            .unwrap()
-    }
-    pub fn patch_dir(&self) -> RootedPath {
-        self.staging_path().join("patches").unwrap()
-    }
-    pub fn staging_dir_name(&self) -> String {
-        if let Some(dirname) = self.path.rel().file_name().and_then(|x| x.to_str()) {
-            if dirname == self.name() {
-                return dirname.to_string();
-            }
-        }
-        format!("{}-{}", self.name(), self.version())
-    }
-
-    pub fn is_migration_denied(&self) -> bool {
-        const MIGRATION_DENYLIST: &[&str] = &[
-            "external/rust/crates/openssl/", // It's complicated.
-            "external/rust/cxx/",            // It's REALLY complicated.
-        ];
-        MIGRATION_DENYLIST.iter().any(|prefix| self.path().rel().starts_with(prefix))
-    }
-
-    pub fn is_android_bp_healthy(&self) -> bool {
-        self.android_bp().abs().exists()
-            && self.cargo_embargo_json().abs().exists()
-            && self.generate_android_bp_success()
-            && self.android_bp_unchanged()
-    }
-    pub fn patch_success(&self) -> bool {
-        self.patch_output.iter().all(|output| output.1.status.success())
-    }
-    pub fn generate_android_bp_success(&self) -> bool {
-        self.generate_android_bp_output.as_ref().is_some_and(|output| output.status.success())
-    }
-    pub fn android_bp_unchanged(&self) -> bool {
-        self.android_bp_diff.as_ref().is_some_and(|output| output.status.success())
-    }
-
-    // Make a clean copy of the crate in out/
-    pub fn stage_crate(&self) -> Result<()> {
-        let staging_path = self.staging_path();
-        ensure_exists_and_empty(&staging_path)?;
-        remove_dir_all(&staging_path).context(format!("Failed to remove {}", staging_path))?;
-        copy_dir(self.path(), &staging_path).context(format!(
-            "Failed to copy {} to {}",
-            self.path(),
-            self.staging_path()
-        ))?;
-        if staging_path.join(".git")?.abs().is_dir() {
-            remove_dir_all(staging_path.join(".git")?)
-                .with_context(|| "Failed to remove .git".to_string())?;
-        }
-        Ok(())
-    }
-
-    pub fn generate_android_bp(&mut self) -> Result<()> {
-        let (_, output) = generate_android_bps([&*self].into_iter())?
-            .into_iter()
-            .next()
-            .ok_or(anyhow!("Failed to get next element"))?;
-        self.set_generate_android_bp_output(output);
-        Ok(())
-    }
-
-    pub fn diff_android_bp(&mut self) -> Result<()> {
-        self.set_diff_output(
-            diff_android_bp(
-                &self.android_bp().rel(),
-                &self.staging_path().join("Android.bp")?.rel(),
-                &self.path.root(),
-            )
-            .context("Failed to diff Android.bp".to_string())?,
-        );
-        Ok(())
-    }
-
-    pub fn apply_patches(&mut self) -> Result<()> {
-        let patch_dir = self.patch_dir();
-        if patch_dir.abs().exists() {
-            for entry in
-                read_dir(&patch_dir).context(format!("Failed to read_dir {}", patch_dir))?
-            {
-                let entry = entry?;
-                if entry.file_name() == "Android.bp.patch"
-                    || entry.file_name() == "Android.bp.diff"
-                    || entry.file_name() == "rules.mk.diff"
-                {
-                    continue;
-                }
-                let entry_path = entry.path();
-                let output = Command::new("patch")
-                    .args(["-p1", "-l", "--no-backup-if-mismatch", "-i"])
-                    .arg(&entry_path)
-                    .current_dir(self.staging_path())
-                    .output()?;
-                self.patch_output.push((
-                    String::from_utf8_lossy(entry.file_name().as_encoded_bytes()).to_string(),
-                    output,
-                ));
-            }
-        }
-        Ok(())
-    }
-
-    pub fn android_bp_diff(&self) -> Option<&Output> {
-        self.android_bp_diff.as_ref()
-    }
-    pub fn generate_android_bp_output(&self) -> Option<&Output> {
-        self.generate_android_bp_output.as_ref()
-    }
-    pub fn set_generate_android_bp_output(&mut self, cargo_embargo_output: Output) {
-        self.generate_android_bp_output.replace(cargo_embargo_output);
-    }
-    pub fn set_diff_output(&mut self, diff_output: Output) {
-        self.android_bp_diff.replace(diff_output);
-    }
-    pub fn patch_output(&self) -> &Vec<(String, Output)> {
-        &self.patch_output
-    }
-}
-
-#[cfg(test)]
-mod tests {
-    use std::{
-        fs::{create_dir, write},
-        path::PathBuf,
-    };
-
-    use super::*;
-    use anyhow::anyhow;
-    use tempfile::tempdir;
-
-    fn write_test_manifest(temp_crate_dir: &Path, name: &str, version: &str) -> Result<RootedPath> {
-        let cargo_toml: PathBuf = [temp_crate_dir, &Path::new("Cargo.toml")].iter().collect();
-        let cargo_toml = RootedPath::new("/", cargo_toml.strip_prefix("/")?)?;
-        write(&cargo_toml, format!("[package]\nname = \"{}\"\nversion = \"{}\"\n", name, version))?;
-        let lib_rs: PathBuf = [temp_crate_dir, &Path::new("src/lib.rs")].iter().collect();
-        create_dir(lib_rs.parent().ok_or(anyhow!("Failed to get parent"))?)?;
-        write(lib_rs.as_path(), "// foo")?;
-        Ok(cargo_toml)
-    }
-
-    #[test]
-    fn test_from_and_properties() -> Result<()> {
-        let temp_crate_dir = tempdir()?;
-        let cargo_toml = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
-        let krate = Crate::from(cargo_toml)?;
-        assert_eq!(krate.name(), "foo");
-        assert_eq!(krate.version().to_string(), "1.2.0");
-        assert_eq!(krate.android_bp().abs(), temp_crate_dir.path().join("Android.bp"));
-        assert_eq!(
-            krate.cargo_embargo_json().abs(),
-            temp_crate_dir.path().join("cargo_embargo.json")
-        );
-        Ok(())
-    }
-
-    #[test]
-    fn test_from_error() -> Result<()> {
-        let temp_crate_dir = tempdir()?;
-        let cargo_toml = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
-        assert!(Crate::from(cargo_toml.join("blah")?).is_err());
-        Ok(())
-    }
-}
-
-pub fn diff_android_bp(
-    a: &impl AsRef<Path>,
-    b: &impl AsRef<Path>,
-    root: &impl AsRef<Path>,
-) -> Result<Output> {
-    Ok(Command::new("diff")
-        .args([
-            "-u",
-            "-w",
-            "-B",
-            "-I",
-            r#"default_team: "trendy_team_android_rust""#,
-            "-I",
-            "// has rustc warnings",
-            "-I",
-            "This file is generated by",
-            "-I",
-            "cargo_pkg_version:",
-        ])
-        .arg(a.as_ref())
-        .arg(b.as_ref())
-        .current_dir(root)
-        .output()?)
-}
diff --git a/tools/external_crates/crate_health/src/main.rs b/tools/external_crates/crate_health/src/main.rs
deleted file mode 100644
index 17a4a4a32..000000000
--- a/tools/external_crates/crate_health/src/main.rs
+++ /dev/null
@@ -1,114 +0,0 @@
-// Copyright (C) 2024 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{collections::BTreeSet, path::PathBuf};
-
-use anyhow::Result;
-use clap::{Parser, Subcommand};
-use crate_health::{default_repo_root, maybe_build_cargo_embargo, ManagedRepo};
-use rooted_path::RootedPath;
-
-#[derive(Parser)]
-struct Cli {
-    #[command(subcommand)]
-    command: Cmd,
-
-    // The path to the Android source repo.
-    #[arg(long, default_value_os_t=default_repo_root().unwrap_or(PathBuf::from(".")))]
-    repo_root: PathBuf,
-
-    /// Rebuild cargo_embargo and bpfmt, even if they are already present in the out directory.
-    #[arg(long, default_value_t = false)]
-    rebuild_cargo_embargo: bool,
-
-    /// Print command output in case of error, and full diffs.
-    #[arg(long, default_value_t = false)]
-    verbose: bool,
-}
-
-#[derive(Subcommand)]
-enum Cmd {
-    /// Check the health of a crate, and whether it is safe to migrate.
-    MigrationHealth {
-        /// The crate names. Also the directory names in external/rust/crates.
-        crates: Vec<String>,
-
-        /// Don't pin the crate version for the specified crates when checking health.
-        #[arg(long, value_parser = parse_crate_list, required=false, default_value="")]
-        unpinned: BTreeSet<String>,
-    },
-    /// Migrate crates from external/rust/crates to the monorepo.
-    Migrate {
-        /// The crate names. Also the directory names in external/rust/crates.
-        crates: Vec<String>,
-
-        /// Add the specified crates with unpinned versions.
-        #[arg(long, value_parser = parse_crate_list, required=false, default_value="")]
-        unpinned: BTreeSet<String>,
-    },
-    /// Import a crate and its dependencies into the monorepo.
-    Import {
-        /// The crate name.
-        crate_name: String,
-    },
-    /// Regenerate a crate directory.
-    Regenerate {
-        /// The crate names.
-        crates: Vec<String>,
-    },
-    /// Regenerate all crates
-    RegenerateAll {},
-    /// Run pre-upload checks.
-    PreuploadCheck {
-        /// List of changed files
-        files: Vec<String>,
-    },
-    /// Try to fix problems with license files.
-    FixLicenses {},
-    /// Fix up METADATA files
-    FixMetadata {},
-}
-
-fn parse_crate_list(arg: &str) -> Result<BTreeSet<String>> {
-    Ok(arg.split(',').map(|k| k.to_string()).collect())
-}
-
-fn main() -> Result<()> {
-    let args = Cli::parse();
-
-    maybe_build_cargo_embargo(&args.repo_root, args.rebuild_cargo_embargo)?;
-
-    let managed_repo =
-        ManagedRepo::new(RootedPath::new(args.repo_root, "external/rust/android-crates-io")?);
-
-    match args.command {
-        Cmd::MigrationHealth { crates, unpinned } => {
-            for crate_name in &crates {
-                managed_repo.migration_health(
-                    crate_name,
-                    args.verbose,
-                    unpinned.contains(crate_name),
-                )?;
-            }
-            Ok(())
-        }
-        Cmd::Migrate { crates, unpinned } => managed_repo.migrate(crates, args.verbose, &unpinned),
-        Cmd::Regenerate { crates } => managed_repo.regenerate(crates.iter(), true),
-        Cmd::RegenerateAll {} => managed_repo.regenerate_all(true),
-        Cmd::PreuploadCheck { files } => managed_repo.preupload_check(&files),
-        Cmd::Import { crate_name } => managed_repo.import(&crate_name),
-        Cmd::FixLicenses {} => managed_repo.fix_licenses(),
-        Cmd::FixMetadata {} => managed_repo.fix_metadata(),
-    }
-}
diff --git a/tools/external_crates/crate_health/src/managed_repo.rs b/tools/external_crates/crate_health/src/managed_repo.rs
deleted file mode 100644
index 4df3c3114..000000000
--- a/tools/external_crates/crate_health/src/managed_repo.rs
+++ /dev/null
@@ -1,748 +0,0 @@
-// Copyright (C) 2024 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{
-    collections::BTreeSet,
-    fs::{create_dir, read_dir, remove_dir_all, remove_file, rename, write},
-    os::unix::fs::symlink,
-    path::Path,
-    process::Command,
-    str::from_utf8,
-};
-
-use anyhow::{anyhow, Result};
-use glob::glob;
-use google_metadata::GoogleMetadata;
-use itertools::Itertools;
-use license_checker::find_licenses;
-use name_and_version::{NameAndVersion, NameAndVersionMap, NameAndVersionRef, NamedAndVersioned};
-use rooted_path::RootedPath;
-use semver::Version;
-use spdx::Licensee;
-
-use crate::{
-    cargo_embargo_autoconfig, copy_dir, most_restrictive_type, update_module_license_files, Crate,
-    CrateCollection, PseudoCrate, VersionMatch,
-};
-
-pub struct ManagedRepo {
-    path: RootedPath,
-    pseudo_crate: PseudoCrate,
-}
-
-impl ManagedRepo {
-    pub fn new(path: RootedPath) -> ManagedRepo {
-        let pseudo_crate = PseudoCrate::new(path.join("pseudo_crate").unwrap());
-        ManagedRepo { path, pseudo_crate }
-    }
-    pub fn contains(&self, crate_name: &str) -> bool {
-        self.managed_dir_for(crate_name).abs().exists()
-    }
-    pub fn managed_dir(&self) -> RootedPath {
-        self.path.join("crates").unwrap()
-    }
-    pub fn managed_dir_for(&self, crate_name: &str) -> RootedPath {
-        self.managed_dir().join(crate_name).unwrap()
-    }
-    pub fn vendored_dir_for(&self, crate_name: &str) -> RootedPath {
-        self.pseudo_crate.get_path().join("vendor").unwrap().join(crate_name).unwrap()
-    }
-    pub fn legacy_dir_for(&self, crate_name: &str) -> RootedPath {
-        self.path.with_same_root("external/rust/crates").unwrap().join(crate_name).unwrap()
-    }
-    pub fn new_cc(&self) -> CrateCollection {
-        CrateCollection::new(self.path.root())
-    }
-    pub fn vendored_crates(&self) -> Result<CrateCollection> {
-        let mut cc = self.new_cc();
-        cc.add_from(self.pseudo_crate.get_path().join("vendor")?.rel())?;
-        Ok(cc)
-    }
-    pub fn migration_health(
-        &self,
-        crate_name: &str,
-        verbose: bool,
-        unpinned: bool,
-    ) -> Result<Version> {
-        if self.contains(crate_name) {
-            return Err(anyhow!("Crate {} already exists in {}/crates", crate_name, self.path));
-        }
-
-        let mut cc = self.new_cc();
-        cc.add_from(self.legacy_dir_for(crate_name).rel())?;
-        if cc.map_field().len() != 1 {
-            return Err(anyhow!(
-                "Expected a single crate version for {}, but found {}. Crates with multiple versions are not supported yet.",
-                crate_name,
-                cc.map_field().len()
-            ));
-        }
-
-        let krate = cc.map_field_mut().values_mut().next().unwrap();
-        println!("Found {} v{} in {}", krate.name(), krate.version(), krate.path());
-        krate.stage_crate()?;
-        krate.generate_android_bp()?;
-        krate.diff_android_bp()?;
-        if !krate.is_android_bp_healthy() {
-            let mut show_cargo_embargo_results = true;
-            if krate.is_migration_denied() {
-                println!("This crate is on the migration denylist");
-                show_cargo_embargo_results = false;
-            }
-            if !krate.android_bp().abs().exists() {
-                println!("There is no Android.bp file in {}", krate.path());
-                show_cargo_embargo_results = false;
-            }
-            if !krate.cargo_embargo_json().abs().exists() {
-                show_cargo_embargo_results = false;
-                println!("There is no cargo_embargo.json file in {}", krate.path());
-            }
-            if show_cargo_embargo_results {
-                if !krate.generate_android_bp_success() {
-                    println!(
-                        "cargo_embargo execution did not succeed for {}",
-                        krate.staging_path(),
-                    );
-                    if verbose {
-                        println!(
-                            "stdout:\n{}\nstderr:\n{}",
-                            from_utf8(
-                                &krate
-                                    .generate_android_bp_output()
-                                    .ok_or(anyhow!("cargo_embargo output not found"))?
-                                    .stdout
-                            )?,
-                            from_utf8(
-                                &krate
-                                    .generate_android_bp_output()
-                                    .ok_or(anyhow!("cargo_embargo output not found"))?
-                                    .stderr
-                            )?,
-                        );
-                    }
-                } else if !krate.android_bp_unchanged() {
-                    println!(
-                        "Running cargo_embargo on {} produced changes to the Android.bp file",
-                        krate.path()
-                    );
-                    if verbose {
-                        println!(
-                            "{}",
-                            from_utf8(
-                                &krate
-                                    .android_bp_diff()
-                                    .ok_or(anyhow!("No Android.bp diff found"))?
-                                    .stdout
-                            )?
-                        );
-                    }
-                }
-            }
-            println!("The crate is UNHEALTHY");
-            return Err(anyhow!("Crate {} is unhealthy", crate_name));
-        }
-
-        if unpinned {
-            self.pseudo_crate.add_unpinned(krate)?;
-        } else {
-            self.pseudo_crate.add(krate)?;
-        }
-        self.pseudo_crate.vendor()?;
-
-        let mut source = self.new_cc();
-        source.add_from(self.legacy_dir_for(crate_name).rel())?;
-
-        let dest = self.vendored_crates()?;
-
-        let mut version_match = VersionMatch::new(source, dest)?;
-
-        version_match.stage_crates()?;
-        version_match.copy_customizations()?;
-        version_match.apply_patches()?;
-        version_match.generate_android_bps()?;
-        version_match.diff_android_bps()?;
-
-        self.pseudo_crate.remove(krate)?;
-        self.pseudo_crate.vendor()?;
-
-        let compatible_pairs = version_match.compatible_pairs().collect::<Vec<_>>();
-        if compatible_pairs.len() != 1 {
-            return Err(anyhow!("Couldn't find a compatible version to migrate to",));
-        }
-        let pair = compatible_pairs.first().unwrap();
-        let version = pair.dest.version().clone();
-        if pair.source.version() != pair.dest.version() {
-            println!(
-                "Source and destination versions are different: {} -> {}",
-                pair.source.version(),
-                pair.dest.version()
-            );
-        }
-        if !pair.dest.patch_success() {
-            println!("Patches did not apply successfully to the migrated crate");
-            if verbose {
-                for output in pair.dest.patch_output() {
-                    if !output.1.status.success() {
-                        println!(
-                            "Failed to apply {}\nstdout:\n{}\nstderr:\n:{}",
-                            output.0,
-                            from_utf8(&output.1.stdout)?,
-                            from_utf8(&output.1.stderr)?
-                        );
-                    }
-                }
-            }
-        }
-        if !pair.dest.generate_android_bp_success() {
-            println!("cargo_embargo execution did not succeed for the migrated crate");
-        } else if !pair.dest.android_bp_unchanged() {
-            println!("Running cargo_embargo for the migrated crate produced changes to the Android.bp file");
-            if verbose {
-                println!(
-                    "{}",
-                    from_utf8(
-                        &pair
-                            .dest
-                            .android_bp_diff()
-                            .ok_or(anyhow!("No Android.bp diff found"))?
-                            .stdout
-                    )?
-                );
-            }
-        }
-
-        let mut diff_cmd = Command::new("diff");
-        diff_cmd.args(["-u", "-r", "-w", "--no-dereference"]);
-        if !verbose {
-            diff_cmd.arg("-q");
-        }
-        let diff_status = diff_cmd
-            .args(IGNORED_FILES.iter().map(|ignored| format!("--exclude={}", ignored)))
-            .args(["-I", r#"default_team: "trendy_team_android_rust""#])
-            .arg(pair.source.path().rel())
-            .arg(pair.dest.staging_path().rel())
-            .current_dir(self.path.root())
-            .spawn()?
-            .wait()?;
-        if !diff_status.success() {
-            println!(
-                "Found differences between {} and {}",
-                pair.source.path(),
-                pair.dest.staging_path()
-            );
-        }
-        if verbose {
-            println!("All diffs:");
-            Command::new("diff")
-                .args(["-u", "-r", "-w", "-q", "--no-dereference"])
-                .arg(pair.source.path().rel())
-                .arg(pair.dest.staging_path().rel())
-                .current_dir(self.path.root())
-                .spawn()?
-                .wait()?;
-        }
-
-        if !pair.dest.patch_success()
-            || !pair.dest.generate_android_bp_success()
-            || !pair.dest.android_bp_unchanged()
-        {
-            println!("The crate is UNHEALTHY");
-            return Err(anyhow!("Crate {} is unhealthy", crate_name));
-        }
-
-        if diff_status.success() {
-            println!("The crate is healthy");
-            return Ok(version);
-        }
-
-        if unpinned {
-            println!("The crate was added with an unpinned version, and diffs were found which must be inspected manually");
-            return Ok(version);
-        }
-
-        println!("The crate is UNHEALTHY");
-        Err(anyhow!("Crate {} is unhealthy", crate_name))
-    }
-    pub fn migrate<T: AsRef<str>>(
-        &self,
-        crates: Vec<T>,
-        verbose: bool,
-        unpinned: &BTreeSet<String>,
-    ) -> Result<()> {
-        for crate_name in &crates {
-            let crate_name = crate_name.as_ref();
-            let version =
-                self.migration_health(crate_name, verbose, unpinned.contains(crate_name))?;
-            let src_dir = self.legacy_dir_for(crate_name);
-
-            let monorepo_crate_dir = self.managed_dir();
-            if !monorepo_crate_dir.abs().exists() {
-                create_dir(monorepo_crate_dir)?;
-            }
-            copy_dir(src_dir, self.managed_dir_for(crate_name))?;
-            if unpinned.contains(crate_name) {
-                self.pseudo_crate.add_unpinned(&NameAndVersionRef::new(crate_name, &version))?;
-            } else {
-                self.pseudo_crate.add(&NameAndVersionRef::new(crate_name, &version))?;
-            }
-        }
-
-        self.regenerate(crates.iter(), false)?;
-
-        for crate_name in &crates {
-            let crate_name = crate_name.as_ref();
-            let src_dir = self.legacy_dir_for(crate_name);
-            for entry in glob(
-                src_dir
-                    .abs()
-                    .join("*.bp")
-                    .to_str()
-                    .ok_or(anyhow!("Failed to convert path *.bp to str"))?,
-            )? {
-                remove_file(entry?)?;
-            }
-            remove_file(src_dir.join("cargo_embargo.json")?)?;
-            let test_mapping = src_dir.join("TEST_MAPPING")?;
-            if test_mapping.abs().exists() {
-                remove_file(test_mapping)?;
-            }
-            write(
-                src_dir.join("Android.bp")?,
-                format!("// This crate has been migrated to {}.\n", self.path),
-            )?;
-        }
-
-        Ok(())
-    }
-    pub fn import(&self, crate_name: &str) -> Result<()> {
-        let new_deps = self.add_crate_and_dependencies(crate_name)?;
-
-        for dep in &new_deps {
-            println!("Sprinkling Android glitter on {}", dep);
-
-            if self.contains(dep) {
-                return Err(anyhow!(
-                    "Crate {} already exists at {}",
-                    dep,
-                    self.managed_dir_for(dep)
-                ));
-            }
-            if self.legacy_dir_for(dep).abs().exists() {
-                return Err(anyhow!(
-                    "Legacy crate {} already exists at {}",
-                    dep,
-                    self.legacy_dir_for(dep)
-                ));
-            }
-
-            let vendored_dir = self.vendored_dir_for(dep);
-            let managed_dir = self.managed_dir_for(dep);
-            copy_dir(vendored_dir.abs(), managed_dir.abs())?;
-
-            // TODO: Copy to a temp dir, because otherwise we might run cargo and create/modify Cargo.lock.
-            let output = cargo_embargo_autoconfig(&managed_dir)?;
-            if !output.status.success() {
-                // TODO: Maybe just write a default cargo_embargo.json if cargo_embargo fails horribly.
-                // There is one pathological crate out there (unarray) where the version published
-                // to crates.io doesn't compile, and cargo_embargo relies on at least being
-                // able to compile successfully. In such case, we may need to do:
-                //  write(managed_dir.abs().join("cargo_embargo.json"), "{}")?;
-                return Err(anyhow!(
-                    "Failed to generate cargo_embargo.json:\nSTDOUT:\n{}\nSTDERR:\n{}",
-                    from_utf8(&output.stdout)?,
-                    from_utf8(&output.stderr)?
-                ));
-            }
-
-            let krate = Crate::from(managed_dir.join("Cargo.toml")?)?;
-
-            let licenses = find_licenses(krate.path().abs(), krate.name(), krate.license())?;
-
-            if !licenses.unsatisfied.is_empty() && licenses.satisfied.is_empty() {
-                let mut satisfied = false;
-                // Sometimes multiple crates live in a single GitHub repo. A common case
-                // is a crate with an associated proc_macro crate. In such cases, the individual
-                // crates are in subdirectories with license files at root of the repo, and
-                // the license files don't get distributed with the crates.
-                // So, if we didn't find a license file, try to guess the URL of the appropriate
-                // license file and download it. This is incredibly hacky, and only supports
-                // the most common case, which is LICENSE-APACHE.
-                if licenses.unsatisfied.len() == 1 {
-                    let req = licenses.unsatisfied.first().unwrap();
-                    if let Some(repository) = krate.repository() {
-                        if *req == Licensee::parse("Apache-2.0").unwrap().into_req() {
-                            let url = format!("{}/master/LICENSE-APACHE", repository);
-                            let body = reqwest::blocking::get(
-                                url.replace("github.com", "raw.githubusercontent.com"),
-                            )?
-                            .text()?;
-                            write(krate.path().abs().join("LICENSE"), body)?;
-                            let patch_dir = krate.path().abs().join("patches");
-                            create_dir(&patch_dir)?;
-                            let output = Command::new("diff")
-                                .args(["-u", "/dev/null", "LICENSE"])
-                                .current_dir(krate.path().abs())
-                                .output()?;
-                            write(patch_dir.join("LICENSE.patch"), output.stdout)?;
-                            satisfied = true;
-                        }
-                    }
-                }
-                if !satisfied {
-                    return Err(anyhow!(
-                        "Could not find license files for all licenses. Missing {}",
-                        licenses.unsatisfied.iter().join(", ")
-                    ));
-                }
-            }
-
-            // If there's a single applicable license file, symlink it to LICENSE.
-            if licenses.satisfied.len() == 1 && licenses.unsatisfied.is_empty() {
-                let license_file = krate.path().join("LICENSE")?;
-                if !license_file.abs().exists() {
-                    symlink(
-                        licenses.satisfied.iter().next().unwrap().1.file_name().unwrap(),
-                        license_file,
-                    )?;
-                }
-            }
-
-            update_module_license_files(&krate.path().abs(), &licenses)?;
-
-            let metadata = GoogleMetadata::init(
-                krate.path().join("METADATA")?,
-                krate.name(),
-                krate.version().to_string(),
-                krate.description(),
-                most_restrictive_type(&licenses),
-            )?;
-            metadata.write()?;
-
-            // Workaround. Our logic for crate health assumes the crate isn't healthy if there's
-            // no Android.bp. So create an empty one.
-            write(krate.path().abs().join("Android.bp"), "")?;
-
-            // TODO: Create TEST_MAPPING
-        }
-
-        self.regenerate(new_deps.iter(), true)?;
-
-        Ok(())
-    }
-    pub fn regenerate<T: AsRef<str>>(
-        &self,
-        crates: impl Iterator<Item = T>,
-        update_metadata: bool,
-    ) -> Result<()> {
-        let version_match = self.stage(crates)?;
-        if update_metadata {
-            version_match.update_metadata()?;
-        }
-
-        for pair in version_match.pairs() {
-            let source_version = NameAndVersion::from(&pair.source.key());
-            let pair = pair.to_compatible().ok_or(anyhow!(
-                "No compatible vendored crate found for {} v{}",
-                source_version.name(),
-                source_version.version()
-            ))?;
-
-            if !pair.dest.staging_path().abs().exists() {
-                return Err(anyhow!("Staged crate not found at {}", pair.dest.staging_path()));
-            }
-            let android_crate_dir = self.managed_dir_for(pair.source.name());
-            remove_dir_all(&android_crate_dir)?;
-            rename(pair.dest.staging_path(), &android_crate_dir)?;
-        }
-
-        self.pseudo_crate.regenerate_crate_list()?;
-
-        Ok(())
-    }
-    pub fn regenerate_all(&self, update_metadata: bool) -> Result<()> {
-        self.regenerate(self.pseudo_crate.deps()?.keys().map(|k| k.as_str()), update_metadata)
-    }
-    pub fn stage<T: AsRef<str>>(
-        &self,
-        crates: impl Iterator<Item = T>,
-    ) -> Result<VersionMatch<CrateCollection>> {
-        let mut cc = self.new_cc();
-        for crate_name in crates {
-            let crate_name = crate_name.as_ref();
-            let android_crate_dir = self.managed_dir_for(crate_name);
-            if !android_crate_dir.abs().exists() {
-                return Err(anyhow!("Crate {} not found in {}", crate_name, self.managed_dir()));
-            }
-
-            // Source
-            cc.add_from(android_crate_dir.rel())?;
-            let num_versions = cc.get_versions(crate_name).count();
-            if num_versions != 1 {
-                return Err(anyhow!(
-                    "Expected a single crate version for {}, but found {}. Crates with multiple versions are not supported yet.",
-                    crate_name,
-                    num_versions
-                ));
-            }
-        }
-
-        self.pseudo_crate.vendor()?;
-
-        // Dest
-        let dest = self.vendored_crates()?;
-
-        let mut version_match = VersionMatch::new(cc, dest)?;
-
-        version_match.stage_crates()?;
-        version_match.copy_customizations()?;
-        version_match.apply_patches()?;
-        version_match.generate_android_bps()?;
-        version_match.diff_android_bps()?;
-
-        for pair in version_match.pairs() {
-            let source_version = NameAndVersion::from(&pair.source.key());
-            let pair = pair.to_compatible().ok_or(anyhow!(
-                "No compatible vendored crate found for {} v{}",
-                source_version.name(),
-                source_version.version(),
-            ))?;
-
-            if !pair.dest.patch_success() {
-                for (patch, output) in pair.dest.patch_output() {
-                    if !output.status.success() {
-                        return Err(anyhow!(
-                            "Failed to patch {} with {}\nstdout:\n{}\nstderr:\n{}",
-                            pair.dest.name(),
-                            patch,
-                            from_utf8(&output.stdout)?,
-                            from_utf8(&output.stderr)?
-                        ));
-                    }
-                }
-            }
-            if !pair.dest.generate_android_bp_success() {
-                if let Some(output) = pair.dest.generate_android_bp_output() {
-                    return Err(anyhow!(
-                        "cargo_embargo execution failed for {}:\nstdout:\n{}\nstderr:\n:{}",
-                        pair.dest.name(),
-                        from_utf8(&output.stdout)?,
-                        from_utf8(&output.stderr)?
-                    ));
-                }
-            }
-        }
-
-        Ok(version_match)
-    }
-    pub fn preupload_check(&self, files: &[String]) -> Result<()> {
-        let deps = self.pseudo_crate.deps()?.keys().cloned().collect::<BTreeSet<_>>();
-
-        let mut managed_dirs = BTreeSet::new();
-        for entry in read_dir(self.managed_dir())? {
-            let entry = entry?;
-            if entry.path().is_dir() {
-                managed_dirs.insert(
-                    entry.file_name().into_string().map_err(|e| {
-                        anyhow!("Failed to convert {} to string", e.to_string_lossy())
-                    })?,
-                );
-            }
-        }
-
-        if deps != managed_dirs {
-            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match directories in {}\nDirectories not in Cargo.toml: {}\nCargo.toml deps with no directory: {}",
-                self.managed_dir(), managed_dirs.difference(&deps).join(", "), deps.difference(&managed_dirs).join(", ")));
-        }
-
-        let crate_list = self.pseudo_crate.read_crate_list()?;
-        if deps.iter().ne(crate_list.iter()) {
-            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match deps in crate-list.txt\nCargo.toml: {}\ncrate-list.txt: {}",
-                deps.iter().join(", "), crate_list.iter().join(", ")));
-        }
-
-        let changed_android_crates = files
-            .iter()
-            .filter_map(|file| {
-                let path = Path::new(file);
-                let components = path.components().collect::<Vec<_>>();
-                if path.starts_with("crates/") && components.len() > 2 {
-                    Some(components[1].as_os_str().to_string_lossy().to_string())
-                } else {
-                    None
-                }
-            })
-            .collect::<BTreeSet<_>>();
-
-        let version_match = self.stage(changed_android_crates.iter())?;
-
-        for pair in version_match.pairs() {
-            println!("Checking {}", pair.source.name());
-            let source_version = NameAndVersion::from(&pair.source.key());
-            let pair = pair.to_compatible().ok_or(anyhow!(
-                "No compatible vendored crate found for {} v{}",
-                source_version.name(),
-                source_version.version()
-            ))?;
-
-            let diff_status = Command::new("diff")
-                .args(["-u", "-r", "-w", "--no-dereference"])
-                .arg(pair.dest.staging_path().rel())
-                .arg(self.managed_dir_for(pair.source.name()).rel())
-                .current_dir(self.path.root())
-                .spawn()?
-                .wait()?;
-            if !diff_status.success() {
-                return Err(anyhow!(
-                    "Found differences between {} and {}",
-                    pair.source.path(),
-                    pair.dest.staging_path()
-                ));
-            }
-        }
-
-        Ok(())
-    }
-    // TODO: Run "cargo tree" for android targets as well. By default
-    // it runs it for the host target.
-    fn add_crate_and_dependencies(&self, crate_name: &str) -> Result<BTreeSet<String>> {
-        let mut cc = self.new_cc();
-        cc.add_from("external/rust/crates")?;
-        let unmigrated_crates =
-            cc.map_field().keys().map(|nv| nv.name().to_string()).collect::<BTreeSet<_>>();
-
-        let migrated_crates = self.pseudo_crate.deps()?.keys().cloned().collect::<BTreeSet<_>>();
-
-        let mut pending_deps = BTreeSet::from([crate_name.to_string()]);
-        let mut added_deps = BTreeSet::new();
-        while !pending_deps.is_empty() {
-            let cur_dep = pending_deps.pop_first().unwrap();
-            println!("Adding {}", cur_dep);
-            self.pseudo_crate.add_unversioned(&cur_dep)?;
-            // TODO: Try not to do "cargo vendor" so often.
-            self.pseudo_crate.vendor()?;
-            added_deps.insert(cur_dep.clone());
-            for new_dep in self.pseudo_crate.deps_of(&cur_dep)? {
-                if !added_deps.contains(&new_dep)
-                    && !migrated_crates.contains(&new_dep)
-                    && !unmigrated_crates.contains(&new_dep)
-                {
-                    println!("  Depends on {}", new_dep);
-                    pending_deps.insert(new_dep);
-                }
-            }
-        }
-        self.pseudo_crate.vendor()?;
-        Ok(added_deps)
-    }
-    pub fn fix_licenses(&self) -> Result<()> {
-        let mut cc = self.new_cc();
-        cc.add_from(self.managed_dir().rel())?;
-
-        for krate in cc.map_field().values() {
-            println!("{} = \"={}\"", krate.name(), krate.version());
-            let state = find_licenses(krate.path().abs(), krate.name(), krate.license())?;
-            if !state.unsatisfied.is_empty() {
-                println!("{:?}", state);
-            } else {
-                // For now, just update MODULE_LICENSE_*
-                update_module_license_files(&krate.path().abs(), &state)?;
-            }
-        }
-
-        Ok(())
-    }
-    pub fn fix_metadata(&self) -> Result<()> {
-        let mut cc = self.new_cc();
-        cc.add_from(self.managed_dir().rel())?;
-
-        for krate in cc.map_field().values() {
-            println!("{} = \"={}\"", krate.name(), krate.version());
-            let mut metadata = GoogleMetadata::try_from(krate.path().join("METADATA")?)?;
-            metadata.set_version_and_urls(krate.name(), krate.version().to_string())?;
-            metadata.migrate_archive();
-            metadata.migrate_homepage();
-            metadata.remove_deprecated_url();
-            metadata.write()?;
-        }
-
-        Ok(())
-    }
-}
-
-// Files that are ignored when migrating a crate to the monorepo.
-static IGNORED_FILES: &[&str] = &[
-    ".appveyor.yml",
-    ".bazelci",
-    ".bazelignore",
-    ".bazelrc",
-    ".bazelversion",
-    ".buildkite",
-    ".cargo",
-    ".cargo-checksum.json",
-    ".cargo_vcs_info.json",
-    ".circleci",
-    ".cirrus.yml",
-    ".clang-format",
-    ".clang-tidy",
-    ".clippy.toml",
-    ".clog.toml",
-    ".clog.toml",
-    ".codecov.yaml",
-    ".codecov.yml",
-    ".editorconfig",
-    ".gcloudignore",
-    ".gdbinit",
-    ".git",
-    ".git-blame-ignore-revs",
-    ".git-ignore-revs",
-    ".gitallowed",
-    ".gitattributes",
-    ".github",
-    ".gitignore",
-    ".idea",
-    ".ignore",
-    ".istanbul.yml",
-    ".mailmap",
-    ".md-inc.toml",
-    ".mdl-style.rb",
-    ".mdlrc",
-    ".pylintrc",
-    ".pylintrc-examples",
-    ".pylintrc-tests",
-    ".reuse",
-    ".rspec",
-    ".rustfmt.toml",
-    ".shellcheckrc",
-    ".standard-version",
-    ".tarpaulin.toml",
-    ".tokeignore",
-    ".travis.yml",
-    ".versionrc",
-    ".vim",
-    ".vscode",
-    ".yapfignore",
-    ".yardopts",
-    "BUILD",
-    "Cargo.lock",
-    "Cargo.lock.saved",
-    "Cargo.toml.orig",
-    "OWNERS",
-    // Deprecated config file for rules.mk.
-    "cargo2rulesmk.json",
-    // cargo_embargo intermediates.
-    "Android.bp.orig",
-    "cargo.metadata",
-    "cargo.out",
-    "target.tmp",
-];
diff --git a/tools/external_crates/crate_health/src/migration.rs b/tools/external_crates/crate_health/src/migration.rs
deleted file mode 100644
index a4eb1c567..000000000
--- a/tools/external_crates/crate_health/src/migration.rs
+++ /dev/null
@@ -1,97 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{
-    fs::{copy, read_link},
-    os::unix::fs::symlink,
-    process::Output,
-};
-
-use anyhow::{anyhow, Context, Result};
-use glob::glob;
-
-use crate::{copy_dir, crate_type::diff_android_bp, CompatibleVersionPair, Crate};
-
-static CUSTOMIZATIONS: &[&str] = &[
-    "*.bp",
-    "*.mk",
-    "cargo_embargo.json",
-    "patches",
-    "METADATA",
-    "TEST_MAPPING",
-    "MODULE_LICENSE_*",
-];
-
-static SYMLINKS: &[&str] = &["LICENSE", "NOTICE"];
-
-impl<'a> CompatibleVersionPair<'a, Crate> {
-    pub fn copy_customizations(&self) -> Result<()> {
-        let dest_dir = self.dest.staging_path();
-        for pattern in CUSTOMIZATIONS {
-            let full_pattern = self.source.path().join(pattern)?;
-            for entry in glob(
-                full_pattern
-                    .abs()
-                    .to_str()
-                    .ok_or(anyhow!("Failed to convert path {} to str", full_pattern))?,
-            )? {
-                let entry = entry?;
-                let filename = entry
-                    .file_name()
-                    .context(format!("Failed to get file name for {}", entry.display()))?
-                    .to_os_string();
-                if entry.is_dir() {
-                    copy_dir(&entry, &dest_dir.join(filename)?).context(format!(
-                        "Failed to copy {} to {}",
-                        entry.display(),
-                        dest_dir
-                    ))?;
-                } else {
-                    let dest_file = dest_dir.join(&filename)?;
-                    if dest_file.abs().exists() {
-                        return Err(anyhow!("Destination file {} exists", dest_file));
-                    }
-                    copy(&entry, dest_dir.join(filename)?).context(format!(
-                        "Failed to copy {} to {}",
-                        entry.display(),
-                        dest_dir
-                    ))?;
-                }
-            }
-        }
-        for link in SYMLINKS {
-            let src_path = self.source.path().join(link)?;
-            if src_path.abs().is_symlink() {
-                let dest = read_link(src_path)?;
-                if dest.exists() {
-                    return Err(anyhow!(
-                        "Can't symlink {} -> {} because destination exists",
-                        link,
-                        dest.display(),
-                    ));
-                }
-                symlink(dest, dest_dir.join(link)?)?;
-            }
-        }
-        Ok(())
-    }
-    pub fn diff_android_bps(&self) -> Result<Output> {
-        diff_android_bp(
-            &self.source.android_bp().rel(),
-            &self.dest.staging_path().join("Android.bp")?.rel(),
-            &self.source.path().root(),
-        )
-        .context("Failed to diff Android.bp".to_string())
-    }
-}
diff --git a/tools/external_crates/crate_health/src/pseudo_crate.rs b/tools/external_crates/crate_health/src/pseudo_crate.rs
deleted file mode 100644
index f414d8987..000000000
--- a/tools/external_crates/crate_health/src/pseudo_crate.rs
+++ /dev/null
@@ -1,172 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{
-    collections::{BTreeMap, BTreeSet},
-    fs::{create_dir, read, write},
-    io::BufRead,
-    process::Command,
-    str::from_utf8,
-};
-
-use anyhow::{anyhow, Context, Result};
-use itertools::Itertools;
-use name_and_version::NamedAndVersioned;
-use rooted_path::RootedPath;
-use serde::Serialize;
-use tinytemplate::TinyTemplate;
-
-use crate::{ensure_exists_and_empty, RunQuiet};
-
-static CARGO_TOML_TEMPLATE: &str = include_str!("templates/Cargo.toml.template");
-
-#[derive(Serialize)]
-struct Dep {
-    name: String,
-    version: String,
-}
-
-#[derive(Serialize)]
-struct CargoToml {
-    deps: Vec<Dep>,
-}
-
-pub struct PseudoCrate {
-    path: RootedPath,
-}
-
-impl PseudoCrate {
-    pub fn new(path: RootedPath) -> PseudoCrate {
-        PseudoCrate { path }
-    }
-    pub fn init<'a>(
-        &self,
-        crates: impl Iterator<Item = &'a (impl NamedAndVersioned + 'a)>,
-        exact_version: bool,
-    ) -> Result<()> {
-        if self.path.abs().exists() {
-            return Err(anyhow!("Can't init pseudo-crate because {} already exists", self.path));
-        }
-        ensure_exists_and_empty(&self.path)?;
-
-        let mut deps = Vec::new();
-        for krate in crates {
-            // Special cases:
-            // * libsqlite3-sys is a sub-crate of rusqlite
-            // * remove_dir_all has a version not known by crates.io (b/313489216)
-            if krate.name() != "libsqlite3-sys" {
-                deps.push(Dep {
-                    name: krate.name().to_string(),
-                    version: format!(
-                        "{}{}",
-                        if exact_version { "=" } else { "" },
-                        if krate.name() == "remove_dir_all"
-                            && krate.version().to_string() == "0.7.1"
-                        {
-                            "0.7.0".to_string()
-                        } else {
-                            krate.version().to_string()
-                        }
-                    ),
-                });
-            }
-        }
-
-        let mut tt = TinyTemplate::new();
-        tt.add_template("cargo_toml", CARGO_TOML_TEMPLATE)?;
-        write(self.path.join("Cargo.toml")?, tt.render("cargo_toml", &CargoToml { deps })?)?;
-
-        create_dir(self.path.join("src")?).context("Failed to create src dir")?;
-        write(self.path.join("src/lib.rs")?, "// Nothing")
-            .context("Failed to create src/lib.rs")?;
-
-        self.vendor()
-    }
-    pub fn get_path(&self) -> &RootedPath {
-        &self.path
-    }
-    fn add_internal(&self, crate_and_version_str: &str) -> Result<()> {
-        Command::new("cargo")
-            .args(["add", crate_and_version_str])
-            .current_dir(&self.path)
-            .run_quiet_and_expect_success()?;
-        Ok(())
-    }
-    pub fn add(&self, krate: &impl NamedAndVersioned) -> Result<()> {
-        self.add_internal(format!("{}@={}", krate.name(), krate.version()).as_str())
-    }
-    pub fn add_unpinned(&self, krate: &impl NamedAndVersioned) -> Result<()> {
-        self.add_internal(format!("{}@{}", krate.name(), krate.version()).as_str())
-    }
-    pub fn add_unversioned(&self, crate_name: &str) -> Result<()> {
-        self.add_internal(crate_name)
-    }
-    pub fn remove(&self, krate: &impl NamedAndVersioned) -> Result<()> {
-        Command::new("cargo")
-            .args(["remove", krate.name()])
-            .current_dir(&self.path)
-            .run_quiet_and_expect_success()?;
-        Ok(())
-    }
-    pub fn vendor(&self) -> Result<()> {
-        Command::new("cargo")
-            .args(["vendor"])
-            .current_dir(&self.path)
-            .run_quiet_and_expect_success()?;
-        Ok(())
-    }
-    pub fn deps(&self) -> Result<BTreeMap<String, String>> {
-        let output = Command::new("cargo")
-            .args(["tree", "--depth=1", "--prefix=none"])
-            .current_dir(&self.path)
-            .run_quiet_and_expect_success()?;
-        let mut deps = BTreeMap::new();
-        for line in from_utf8(&output.stdout)?.lines().skip(1) {
-            let words = line.split(' ').collect::<Vec<_>>();
-            if words.len() < 2 {
-                return Err(anyhow!(
-                    "Failed to parse crate name and version from cargo tree: {}",
-                    line
-                ));
-            }
-            let version = words[1]
-                .strip_prefix('v')
-                .ok_or(anyhow!("Failed to parse version: {}", words[1]))?;
-            deps.insert(words[0].to_string(), version.to_string());
-        }
-        Ok(deps)
-    }
-    pub fn deps_of(&self, crate_name: &str) -> Result<BTreeSet<String>> {
-        let mut deps = BTreeSet::new();
-        let output = Command::new("cargo")
-            .args(["tree", "--prefix", "none"])
-            .current_dir(self.get_path().abs().join("vendor").join(crate_name))
-            .run_quiet_and_expect_success()?;
-        for line in from_utf8(&output.stdout)?.lines() {
-            deps.insert(line.split_once(' ').unwrap().0.to_string());
-        }
-        Ok(deps)
-    }
-    pub fn regenerate_crate_list(&self) -> Result<()> {
-        write(self.path.join("crate-list.txt")?, format!("{}\n", self.deps()?.keys().join("\n")))?;
-        Ok(())
-    }
-    pub fn read_crate_list(&self) -> Result<Vec<String>> {
-        let mut lines = Vec::new();
-        for line in read(self.path.join("crate-list.txt")?)?.lines() {
-            lines.push(line?);
-        }
-        Ok(lines)
-    }
-}
diff --git a/tools/external_crates/crate_health/src/templates/Cargo.toml.template b/tools/external_crates/crate_health/src/templates/Cargo.toml.template
deleted file mode 100644
index 206cfad21..000000000
--- a/tools/external_crates/crate_health/src/templates/Cargo.toml.template
+++ /dev/null
@@ -1,10 +0,0 @@
-[package]
-name = "android-pseudo-crate"
-version = "0.1.0"
-edition = "2021"
-publish = false
-license = "Apache-2.0"
-
-[dependencies]
-{{ for crate in deps }}{crate.name} = "{crate.version}"
-{{ endfor }}
diff --git a/tools/external_crates/crate_health/src/version_match.rs b/tools/external_crates/crate_health/src/version_match.rs
deleted file mode 100644
index 7cf8f3ffd..000000000
--- a/tools/external_crates/crate_health/src/version_match.rs
+++ /dev/null
@@ -1,328 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{collections::BTreeMap, path::Path};
-
-use anyhow::{anyhow, Result};
-use google_metadata::GoogleMetadata;
-use name_and_version::{NameAndVersion, NameAndVersionMap, NamedAndVersioned};
-
-use crate::{generate_android_bps, CrateCollection};
-
-#[derive(Debug)]
-pub struct VersionPair<'a, T> {
-    pub source: &'a T,
-    pub dest: Option<&'a T>,
-}
-
-#[derive(Debug)]
-pub struct CompatibleVersionPair<'a, T> {
-    pub source: &'a T,
-    pub dest: &'a T,
-}
-
-impl<'a, T> VersionPair<'a, T> {
-    pub fn to_compatible(self) -> Option<CompatibleVersionPair<'a, T>> {
-        self.dest.map(|dest| CompatibleVersionPair { source: self.source, dest })
-    }
-}
-
-pub struct VersionMatch<CollectionType: NameAndVersionMap> {
-    source: CollectionType,
-    dest: CollectionType,
-    compatibility: BTreeMap<NameAndVersion, Option<NameAndVersion>>,
-}
-
-impl<CollectionType: NameAndVersionMap> VersionMatch<CollectionType> {
-    pub fn new(source: CollectionType, dest: CollectionType) -> Result<Self> {
-        let mut vm = VersionMatch { source, dest, compatibility: BTreeMap::new() };
-
-        for nv in vm.dest.map_field().keys() {
-            vm.compatibility.insert_or_error(nv.to_owned(), None)?;
-        }
-
-        for nv in vm.source.map_field().keys() {
-            let compatibility = if let Some(dest_nv) = vm.dest.get_version_upgradable_from(nv) {
-                vm.compatibility.map_field_mut().remove(dest_nv).ok_or(anyhow!(
-                    "Destination crate version {} {} expected but not found",
-                    dest_nv.name(),
-                    dest_nv.version()
-                ))?;
-                Some(dest_nv.clone())
-            } else {
-                None
-            };
-            vm.compatibility.insert_or_error(nv.to_owned(), compatibility)?;
-        }
-
-        Ok(vm)
-    }
-    pub fn is_superfluous(&self, dest: &dyn NamedAndVersioned) -> bool {
-        self.dest.map_field().contains_key(dest)
-            && self.compatibility.get(dest).is_some_and(|compatibility| compatibility.is_none())
-    }
-    pub fn get_compatible_version(
-        &self,
-        source: &dyn NamedAndVersioned,
-    ) -> Option<&NameAndVersion> {
-        self.compatibility.get(source).and_then(|compatibility| compatibility.as_ref())
-    }
-    pub fn get_compatible_item(
-        &self,
-        source: &dyn NamedAndVersioned,
-    ) -> Option<&CollectionType::Value> {
-        self.get_compatible_version(source).map(|nv| self.dest.map_field().get(nv).unwrap())
-    }
-    pub fn get_compatible_item_mut(
-        &mut self,
-        source: &dyn NamedAndVersioned,
-    ) -> Option<&mut CollectionType::Value> {
-        let nv = self.get_compatible_version(source)?.clone();
-        self.dest.map_field_mut().get_mut(&nv)
-    }
-
-    pub fn superfluous(&self) -> impl Iterator<Item = (&NameAndVersion, &CollectionType::Value)> {
-        self.dest.map_field().iter().filter(|(nv, _val)| {
-            self.compatibility.get(*nv).is_some_and(|compatibility| compatibility.is_none())
-        })
-    }
-    pub fn pairs(&self) -> impl Iterator<Item = VersionPair<CollectionType::Value>> {
-        self.source
-            .map_field()
-            .iter()
-            .map(|(nv, source)| VersionPair { source, dest: self.get_compatible_item(nv) })
-    }
-    pub fn compatible_pairs(
-        &self,
-    ) -> impl Iterator<Item = CompatibleVersionPair<CollectionType::Value>> {
-        self.pairs().filter_map(
-            |pair: VersionPair<'_, <CollectionType as NameAndVersionMap>::Value>| {
-                pair.to_compatible()
-            },
-        )
-    }
-}
-
-impl VersionMatch<CrateCollection> {
-    pub fn copy_customizations(&self) -> Result<()> {
-        for pair in self.compatible_pairs() {
-            pair.copy_customizations()?;
-        }
-        Ok(())
-    }
-    pub fn stage_crates(&mut self) -> Result<()> {
-        for pair in self.compatible_pairs() {
-            pair.dest.stage_crate()?;
-        }
-        Ok(())
-    }
-    pub fn apply_patches(&mut self) -> Result<()> {
-        let (s, d, c) = (&self.source, &mut self.dest, &self.compatibility);
-        for source_key in s.map_field().keys() {
-            if let Some(dest_crate) = c.get(source_key).and_then(|compatibility| {
-                compatibility.as_ref().and_then(|dest_key| d.map_field_mut().get_mut(dest_key))
-            }) {
-                dest_crate.apply_patches()?
-            }
-        }
-        Ok(())
-    }
-    pub fn generate_android_bps(&mut self) -> Result<()> {
-        let results = generate_android_bps(self.compatible_pairs().map(|pair| pair.dest))?;
-        for (nv, output) in results.into_iter() {
-            self.dest
-                .map_field_mut()
-                .get_mut(&nv)
-                .ok_or(anyhow!("Failed to get crate {} {}", nv.name(), nv.version()))?
-                .set_generate_android_bp_output(output);
-        }
-        Ok(())
-    }
-
-    pub fn diff_android_bps(&mut self) -> Result<()> {
-        let mut results = BTreeMap::new();
-        for pair in self.compatible_pairs() {
-            results.insert_or_error(NameAndVersion::from(pair.dest), pair.diff_android_bps()?)?;
-        }
-        for (nv, output) in results.into_iter() {
-            self.dest
-                .map_field_mut()
-                .get_mut(&nv)
-                .ok_or(anyhow!("Failed to get crate {} {}", nv.name(), nv.version()))?
-                .set_diff_output(output);
-        }
-        Ok(())
-    }
-
-    pub fn update_metadata(&self) -> Result<()> {
-        for pair in self.compatible_pairs() {
-            let mut metadata =
-                GoogleMetadata::try_from(pair.dest.staging_path().join(Path::new("METADATA"))?)?;
-            let mut writeback = false;
-            writeback |= metadata.migrate_homepage();
-            writeback |= metadata.migrate_archive();
-            writeback |= metadata.remove_deprecated_url();
-            if pair.source.version() != pair.dest.version() {
-                metadata.set_date_to_today()?;
-                metadata.set_version_and_urls(pair.dest.name(), pair.dest.version().to_string())?;
-                writeback |= true;
-            }
-            if writeback {
-                metadata.write()?;
-            }
-        }
-        Ok(())
-    }
-}
-
-#[cfg(test)]
-mod tests {
-    use super::*;
-    use anyhow::Result;
-    use itertools::assert_equal;
-    use std::collections::BTreeMap;
-
-    fn try_name_version_map_from_iter<'a, ValueType>(
-        nvs: impl IntoIterator<Item = (&'a str, &'a str, ValueType)>,
-    ) -> Result<BTreeMap<NameAndVersion, ValueType>, name_and_version::Error> {
-        let mut test_map = BTreeMap::new();
-        for (name, version, val) in nvs {
-            test_map.insert_or_error(NameAndVersion::try_from_str(name, version)?, val)?;
-        }
-        Ok(test_map)
-    }
-
-    #[test]
-    fn test_version_map() -> Result<()> {
-        let source = try_name_version_map_from_iter([
-            ("equal", "2.3.4", "equal src".to_string()),
-            ("compatible", "1.2.3", "compatible src".to_string()),
-            ("incompatible", "1.1.1", "incompatible src".to_string()),
-            ("downgrade", "2.2.2", "downgrade src".to_string()),
-            ("missing", "1.0.0", "missing src".to_string()),
-        ])?;
-        let dest = try_name_version_map_from_iter([
-            ("equal", "2.3.4", "equal dest".to_string()),
-            ("compatible", "1.2.4", "compatible dest".to_string()),
-            ("incompatible", "2.0.0", "incompatible dest".to_string()),
-            ("downgrade", "2.2.1", "downgrade dest".to_string()),
-            ("superfluous", "1.0.0", "superfluous dest".to_string()),
-        ])?;
-
-        let equal = NameAndVersion::try_from_str("equal", "2.3.4")?;
-        let compatible_old = NameAndVersion::try_from_str("compatible", "1.2.3")?;
-        let incompatible_old = NameAndVersion::try_from_str("incompatible", "1.1.1")?;
-        let downgrade_old = NameAndVersion::try_from_str("downgrade", "2.2.2")?;
-        let missing = NameAndVersion::try_from_str("missing", "1.0.0")?;
-
-        let compatible_new = NameAndVersion::try_from_str("compatible", "1.2.4")?;
-        let incompatible_new = NameAndVersion::try_from_str("incompatible", "2.0.0")?;
-        let downgrade_new = NameAndVersion::try_from_str("downgrade", "2.2.1")?;
-        let superfluous = NameAndVersion::try_from_str("superfluous", "1.0.0")?;
-
-        let mut version_match = VersionMatch::new(source, dest)?;
-        assert_eq!(
-            version_match.compatibility,
-            BTreeMap::from([
-                (downgrade_new.clone(), None),
-                (downgrade_old.clone(), None),
-                (equal.clone(), Some(equal.clone())),
-                (compatible_old.clone(), Some(compatible_new.clone())),
-                (incompatible_old.clone(), None),
-                (incompatible_new.clone(), None),
-                (missing.clone(), None),
-                (superfluous.clone(), None),
-            ])
-        );
-
-        // assert!(version_match.has_compatible(&equal));
-        assert_eq!(version_match.get_compatible_version(&equal), Some(&equal));
-        assert_eq!(version_match.get_compatible_item(&equal), Some(&"equal dest".to_string()));
-        assert_eq!(
-            version_match.get_compatible_item_mut(&equal),
-            Some(&mut "equal dest".to_string())
-        );
-        assert!(!version_match.is_superfluous(&equal));
-
-        // assert!(version_match.has_compatible(&compatible_old));
-        assert_eq!(version_match.get_compatible_version(&compatible_old), Some(&compatible_new));
-        assert_eq!(
-            version_match.get_compatible_item(&compatible_old),
-            Some(&"compatible dest".to_string())
-        );
-        assert_eq!(
-            version_match.get_compatible_item_mut(&compatible_old),
-            Some(&mut "compatible dest".to_string())
-        );
-        assert!(!version_match.is_superfluous(&compatible_old));
-        assert!(!version_match.is_superfluous(&compatible_new));
-
-        // assert!(!version_match.has_compatible(&incompatible_old));
-        assert!(version_match.get_compatible_version(&incompatible_old).is_none());
-        assert!(version_match.get_compatible_item(&incompatible_old).is_none());
-        assert!(version_match.get_compatible_item_mut(&incompatible_old).is_none());
-        assert!(!version_match.is_superfluous(&incompatible_old));
-        assert!(version_match.is_superfluous(&incompatible_new));
-
-        // assert!(!version_match.has_compatible(&downgrade_old));
-        assert!(version_match.get_compatible_version(&downgrade_old).is_none());
-        assert!(version_match.get_compatible_item(&downgrade_old).is_none());
-        assert!(version_match.get_compatible_item_mut(&downgrade_old).is_none());
-        assert!(!version_match.is_superfluous(&downgrade_old));
-        assert!(version_match.is_superfluous(&downgrade_new));
-
-        // assert!(!version_match.has_compatible(&missing));
-        assert!(version_match.get_compatible_version(&missing).is_none());
-        assert!(version_match.get_compatible_item(&missing).is_none());
-        assert!(version_match.get_compatible_item_mut(&missing).is_none());
-        assert!(!version_match.is_superfluous(&missing));
-
-        // assert!(!version_match.has_compatible(&superfluous));
-        assert!(version_match.get_compatible_version(&superfluous).is_none());
-        assert!(version_match.get_compatible_item(&superfluous).is_none());
-        assert!(version_match.get_compatible_item_mut(&superfluous).is_none());
-        assert!(version_match.is_superfluous(&superfluous));
-
-        assert_equal(
-            version_match.superfluous().map(|(nv, _dest)| nv),
-            [&downgrade_new, &incompatible_new, &superfluous],
-        );
-
-        assert_equal(
-            version_match.pairs().map(|x| x.source),
-            ["compatible src", "downgrade src", "equal src", "incompatible src", "missing src"],
-        );
-        assert_equal(
-            version_match.pairs().map(|x| x.dest),
-            [
-                Some(&"compatible dest".to_string()),
-                None,
-                Some(&"equal dest".to_string()),
-                None,
-                None,
-            ],
-        );
-
-        assert_equal(
-            version_match.compatible_pairs().map(|x| x.source),
-            ["compatible src", "equal src"],
-        );
-        assert_equal(
-            version_match.compatible_pairs().map(|x| x.dest),
-            ["compatible dest", "equal dest"],
-        );
-
-        Ok(())
-    }
-}
diff --git a/tools/external_crates/crate_health/Cargo.toml b/tools/external_crates/crate_tool/Cargo.toml
similarity index 70%
rename from tools/external_crates/crate_health/Cargo.toml
rename to tools/external_crates/crate_tool/Cargo.toml
index 4c12fb5f6..29b663570 100644
--- a/tools/external_crates/crate_health/Cargo.toml
+++ b/tools/external_crates/crate_tool/Cargo.toml
@@ -1,5 +1,5 @@
 [package]
-name = "crate_health"
+name = "crate_tool"
 version = "0.1.0"
 edition = "2021"
 
@@ -8,20 +8,23 @@ edition = "2021"
 [dependencies]
 anyhow = "1"
 cargo = "0.76"
+cfg-expr = "0.17"
 chrono = "0.4"
 clap = { version = "4.4.6", features = ["derive"] }
+crates-index = "3.2.0"
 glob = "0.3"
 itertools = "0.11"
 num_cpus = "1"
+owning_ref = "0.4"
 protobuf = "3"
-reqwest = { version = "0.12.5", features = ["blocking"] }
+reqwest = { version = "0.12.5", features = ["blocking", "gzip"] }
 semver = "1"
-serde = { version = "1", features = ["derive"] }
+# TODO: Unpin once https://github.com/serde-rs/serde/issues/2844 is resolved.
+serde = { version = "=1.0.210", features = ["derive"] }
 serde_json = "1"
 spdx = "0.10"
 thiserror = "1"
 threadpool = "1"
-tinytemplate = "1.2"
 walkdir = "2"
 whoami = "1"
 google_metadata = { path = "../google_metadata"}
@@ -29,6 +32,7 @@ license_checker = { path = "../license_checker" }
 name_and_version = { path = "../name_and_version" }
 name_and_version_proc_macros = { path = "../name_and_version_proc_macros" }
 rooted_path = { path = "../rooted_path" }
+test_mapping = { path = "../test_mapping" }
 
 [build-dependencies]
 protobuf-codegen = "3"
diff --git a/tools/external_crates/crate_health/src/android_bp.rs b/tools/external_crates/crate_tool/src/android_bp.rs
similarity index 60%
rename from tools/external_crates/crate_health/src/android_bp.rs
rename to tools/external_crates/crate_tool/src/android_bp.rs
index 2e94cda87..2c51a1163 100644
--- a/tools/external_crates/crate_health/src/android_bp.rs
+++ b/tools/external_crates/crate_tool/src/android_bp.rs
@@ -13,46 +13,18 @@
 // limitations under the License.
 
 use std::{
-    collections::BTreeMap,
     env,
     ffi::OsString,
-    fs::{copy, remove_file, rename},
+    fs::{remove_file, rename},
     path::Path,
     process::{Command, Output},
-    sync::mpsc::channel,
+    time::{Duration, SystemTime},
 };
 
-use anyhow::{anyhow, Context, Result};
-use name_and_version::{NameAndVersion, NameAndVersionMap, NamedAndVersioned};
+use anyhow::{Context, Result};
 use rooted_path::RootedPath;
-use threadpool::ThreadPool;
 
-use crate::Crate;
-
-pub fn generate_android_bps<'a, T: Iterator<Item = &'a Crate>>(
-    crates: T,
-) -> Result<BTreeMap<NameAndVersion, Output>> {
-    let pool = ThreadPool::new(std::cmp::max(num_cpus::get(), 32));
-    let (tx, rx) = channel();
-
-    let mut num_crates = 0;
-    for krate in crates {
-        num_crates += 1;
-        let tx = tx.clone();
-        let crate_name = krate.name().to_string();
-        let crate_version = krate.version().clone();
-        let staging_path = krate.staging_path();
-        pool.execute(move || {
-            tx.send((crate_name, crate_version, run_cargo_embargo(&staging_path)))
-                .expect("Failed to send");
-        });
-    }
-    let mut results = BTreeMap::new();
-    for (crate_name, crate_version, result) in rx.iter().take(num_crates) {
-        results.insert_or_error(NameAndVersion::new(crate_name, crate_version), result?)?;
-    }
-    Ok(results)
-}
+use crate::SuccessOrError;
 
 fn add_bpfmt_to_path(repo_root: impl AsRef<Path>) -> Result<OsString> {
     let host_bin = repo_root.as_ref().join("prebuilts/build-tools/linux-x86/bin");
@@ -67,14 +39,14 @@ fn add_bpfmt_to_path(repo_root: impl AsRef<Path>) -> Result<OsString> {
     Ok(new_path)
 }
 
-fn run_cargo_embargo(staging_path: &RootedPath) -> Result<Output> {
+pub fn run_cargo_embargo(staging_path: &RootedPath) -> Result<Output> {
     maybe_build_cargo_embargo(&staging_path.root(), false)?;
     let new_path = add_bpfmt_to_path(staging_path.root())?;
 
     let cargo_lock = staging_path.join("Cargo.lock")?;
     let saved_cargo_lock = staging_path.join("Cargo.lock.saved")?;
     if cargo_lock.abs().exists() {
-        copy(&cargo_lock, &saved_cargo_lock)?;
+        rename(&cargo_lock, &saved_cargo_lock)?;
     }
 
     let mut cmd =
@@ -113,23 +85,25 @@ pub fn cargo_embargo_autoconfig(path: &RootedPath) -> Result<Output> {
 }
 
 pub fn maybe_build_cargo_embargo(repo_root: &impl AsRef<Path>, force_rebuild: bool) -> Result<()> {
-    if !force_rebuild && repo_root.as_ref().join("out/host/linux-x86/bin/cargo_embargo").exists() {
-        Ok(())
-    } else {
+    let cargo_embargo = repo_root.as_ref().join("out/host/linux-x86/bin/cargo_embargo");
+    if force_rebuild
+        || !cargo_embargo.exists()
+        || SystemTime::now().duration_since(cargo_embargo.metadata()?.modified()?)?
+            > Duration::from_secs(14 * 24 * 60 * 60)
+    {
         println!("Rebuilding cargo_embargo");
-        build_cargo_embargo(repo_root)
+        return build_cargo_embargo(repo_root);
     }
+    Ok(())
 }
 
 pub fn build_cargo_embargo(repo_root: &impl AsRef<Path>) -> Result<()> {
-    let status = Command::new("/usr/bin/bash")
+    Command::new("/usr/bin/bash")
         .args(["-c", "source build/envsetup.sh && lunch aosp_cf_x86_64_phone-trunk_staging-eng && m cargo_embargo"])
-        .env_remove("OUT_DIR").current_dir(repo_root).spawn().context("Failed to spawn build of cargo embargo")?.wait().context("Failed to wait on child process building cargo embargo")?;
-    match status.success() {
-        true => Ok(()),
-        false => Err(anyhow!(
-            "Building cargo embargo failed with exit code {}",
-            status.code().map(|code| { format!("{}", code) }).unwrap_or("(unknown)".to_string())
-        )),
-    }
+        .env_remove("OUT_DIR")
+        .current_dir(repo_root)
+        .spawn().context("Failed to spawn build of cargo embargo")?
+        .wait().context("Failed to wait on child process building cargo embargo")?
+        .success_or_error().context("Failed to build_cargo_embargo")?;
+    Ok(())
 }
diff --git a/tools/external_crates/crate_health/src/crate_collection.rs b/tools/external_crates/crate_tool/src/crate_collection.rs
similarity index 85%
rename from tools/external_crates/crate_health/src/crate_collection.rs
rename to tools/external_crates/crate_tool/src/crate_collection.rs
index e143f3441..f1255f331 100644
--- a/tools/external_crates/crate_health/src/crate_collection.rs
+++ b/tools/external_crates/crate_tool/src/crate_collection.rs
@@ -21,15 +21,15 @@ use std::{
     path::{Path, PathBuf},
 };
 
-use anyhow::Result;
+use anyhow::{anyhow, Result};
 use semver::Version;
 use walkdir::WalkDir;
 
-use crate::{Crate, CrateError};
+use crate::{crate_type::Crate, CrateError};
 
 use std::collections::BTreeMap;
 
-#[derive(NameAndVersionMap)]
+#[derive(NameAndVersionMap, Debug)]
 pub struct CrateCollection {
     crates: BTreeMap<NameAndVersion, Crate>,
     repo_root: PathBuf,
@@ -45,7 +45,11 @@ impl CrateCollection {
             if entry.file_name() == "Cargo.toml" {
                 match Crate::from(RootedPath::new(
                     self.repo_root.clone(),
-                    entry.path().strip_prefix(&self.repo_root)?,
+                    entry
+                        .path()
+                        .parent()
+                        .ok_or(anyhow!("Failed to get parent of {}", entry.path().display()))?
+                        .strip_prefix(&self.repo_root)?,
                 )?) {
                     Ok(krate) => self.crates.insert_or_error(
                         NameAndVersion::new(krate.name().to_string(), krate.version().clone()),
diff --git a/tools/external_crates/crate_tool/src/crate_type.rs b/tools/external_crates/crate_tool/src/crate_type.rs
new file mode 100644
index 000000000..d98415d7f
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/crate_type.rs
@@ -0,0 +1,126 @@
+// Copyright (C) 2023 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use anyhow::{anyhow, Result};
+use cargo::{
+    core::{Manifest, SourceId},
+    util::toml::read_manifest,
+    Config,
+};
+use name_and_version::{NameAndVersionRef, NamedAndVersioned};
+use rooted_path::RootedPath;
+use semver::Version;
+
+use crate::CrateError;
+
+#[derive(Debug, Clone)]
+pub struct Crate {
+    manifest: Manifest,
+    path: RootedPath,
+}
+
+impl NamedAndVersioned for Crate {
+    fn name(&self) -> &str {
+        self.manifest.name().as_str()
+    }
+    fn version(&self) -> &Version {
+        self.manifest.version()
+    }
+    fn key(&self) -> NameAndVersionRef {
+        NameAndVersionRef::new(self.name(), self.version())
+    }
+}
+
+impl Crate {
+    pub fn new(manifest: Manifest, path: RootedPath) -> Crate {
+        Crate { manifest, path }
+    }
+    pub fn from(manifest_dir: RootedPath) -> Result<Crate> {
+        let source_id = SourceId::for_path(manifest_dir.abs())?;
+        let (manifest, _nested) = read_manifest(
+            manifest_dir.join("Cargo.toml").unwrap().as_ref(),
+            source_id,
+            &Config::default()?,
+        )?;
+        match manifest {
+            cargo::core::EitherManifest::Real(r) => Ok(Crate::new(r, manifest_dir)),
+            cargo::core::EitherManifest::Virtual(_) => {
+                Err(anyhow!(CrateError::VirtualCrate(manifest_dir.as_ref().to_path_buf())))
+            }
+        }
+    }
+
+    pub fn description(&self) -> &str {
+        self.manifest.metadata().description.as_deref().unwrap_or("")
+    }
+    pub fn license(&self) -> Option<&str> {
+        self.manifest.metadata().license.as_deref()
+    }
+    pub fn repository(&self) -> Option<&str> {
+        self.manifest.metadata().repository.as_deref()
+    }
+    pub fn path(&self) -> &RootedPath {
+        &self.path
+    }
+
+    pub fn is_migration_denied(&self) -> bool {
+        const MIGRATION_DENYLIST: &[&str] = &[
+            "external/rust/crates/openssl/", // It's complicated.
+            "external/rust/cxx/",            // It's REALLY complicated.
+        ];
+        MIGRATION_DENYLIST.iter().any(|prefix| self.path().rel().starts_with(prefix))
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use std::{
+        fs::{create_dir, write},
+        path::Path,
+    };
+
+    use super::*;
+    use anyhow::anyhow;
+    use tempfile::tempdir;
+
+    fn write_test_manifest(temp_crate_dir: &Path, name: &str, version: &str) -> Result<RootedPath> {
+        let temp_crate_dir = RootedPath::new("/", temp_crate_dir.strip_prefix("/")?)?;
+        write(
+            temp_crate_dir.join("Cargo.toml")?,
+            format!("[package]\nname = \"{}\"\nversion = \"{}\"\n", name, version),
+        )?;
+        let lib_rs = temp_crate_dir.join("src/lib.rs")?;
+        create_dir(lib_rs.abs().parent().ok_or(anyhow!("Failed to get parent"))?)?;
+        write(lib_rs, "// foo")?;
+        Ok(temp_crate_dir)
+    }
+
+    #[test]
+    fn test_from_and_properties() -> Result<()> {
+        let temp_crate_dir = tempdir()?;
+        let manifest_dir = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
+        let krate = Crate::from(manifest_dir)?;
+        assert_eq!(krate.name(), "foo");
+        assert_eq!(krate.version().to_string(), "1.2.0");
+        Ok(())
+    }
+
+    #[test]
+    fn test_from_error() -> Result<()> {
+        let temp_crate_dir = tempdir()?;
+        let manifest_dir = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
+        assert!(Crate::from(manifest_dir.join("blah")?).is_err());
+        Ok(())
+    }
+}
diff --git a/tools/external_crates/crate_tool/src/crates_io.rs b/tools/external_crates/crate_tool/src/crates_io.rs
new file mode 100644
index 000000000..6ebd02b20
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/crates_io.rs
@@ -0,0 +1,219 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use anyhow::{anyhow, Result};
+use cfg_expr::{
+    targets::{Arch, Family, Os},
+    Predicate, TargetPredicate,
+};
+use crates_index::{http, Crate, Dependency, DependencyKind, SparseIndex, Version};
+use reqwest::blocking::Client;
+use semver::VersionReq;
+use std::{
+    cell::RefCell,
+    collections::{HashMap, HashSet},
+};
+
+pub struct CratesIoIndex {
+    fetcher: Box<dyn CratesIoFetcher>,
+}
+
+impl CratesIoIndex {
+    pub fn new() -> Result<CratesIoIndex> {
+        Ok(CratesIoIndex {
+            fetcher: Box::new(OnlineFetcher {
+                index: crates_index::SparseIndex::new_cargo_default()?,
+                client: reqwest::blocking::ClientBuilder::new().gzip(true).build()?,
+                fetched: RefCell::new(HashSet::new()),
+            }),
+        })
+    }
+    pub fn new_offline() -> Result<CratesIoIndex> {
+        Ok(CratesIoIndex {
+            fetcher: Box::new(OfflineFetcher {
+                index: crates_index::SparseIndex::new_cargo_default()?,
+            }),
+        })
+    }
+    pub fn get_crate(&self, crate_name: impl AsRef<str>) -> Result<Crate> {
+        self.fetcher.fetch(crate_name.as_ref())
+    }
+}
+
+pub trait CratesIoFetcher {
+    fn fetch(&self, crate_name: &str) -> Result<Crate>;
+}
+
+pub struct OnlineFetcher {
+    index: SparseIndex,
+    client: Client,
+    // Keep track of crates we have fetched, to avoid fetching them multiple times.
+    fetched: RefCell<HashSet<String>>,
+}
+
+pub struct OfflineFetcher {
+    index: SparseIndex,
+}
+
+impl CratesIoFetcher for OnlineFetcher {
+    fn fetch(&self, crate_name: &str) -> Result<Crate> {
+        // Adapted from https://github.com/frewsxcv/rust-crates-index/blob/master/examples/sparse_http_reqwest.rs
+
+        let mut fetched = self.fetched.borrow_mut();
+        if fetched.contains(crate_name) {
+            return Ok(self.index.crate_from_cache(crate_name.as_ref())?);
+        }
+        let req = self.index.make_cache_request(crate_name)?.body(())?;
+        let req = http::Request::from_parts(req.into_parts().0, vec![]);
+        let req: reqwest::blocking::Request = req.try_into()?;
+        let res = self.client.execute(req)?;
+        let mut builder = http::Response::builder().status(res.status()).version(res.version());
+        builder
+            .headers_mut()
+            .ok_or(anyhow!("Failed to get headers"))?
+            .extend(res.headers().iter().map(|(k, v)| (k.clone(), v.clone())));
+        let body = res.bytes()?;
+        let res = builder.body(body.to_vec())?;
+        let res = self
+            .index
+            .parse_cache_response(crate_name, res, true)?
+            .ok_or(anyhow!("Crate not found"))?;
+        fetched.insert(crate_name.to_string());
+        Ok(res)
+    }
+}
+impl CratesIoFetcher for OfflineFetcher {
+    fn fetch(&self, crate_name: &str) -> Result<Crate> {
+        Ok(self.index.crate_from_cache(crate_name.as_ref())?)
+    }
+}
+
+/// Filter versions by those that are "safe", meaning not yanked or pre-release.
+pub trait SafeVersions {
+    // Versions of the crate that aren't yanked or pre-release.
+    fn safe_versions(&self) -> impl DoubleEndedIterator<Item = &Version>;
+    // Versions of the crate greater than 'version'.
+    fn versions_gt(&self, version: &semver::Version) -> impl DoubleEndedIterator<Item = &Version> {
+        self.safe_versions().filter(|v| {
+            semver::Version::parse(v.version()).map_or(false, |parsed| parsed.gt(version))
+        })
+    }
+    // Get a specific version of a crate.
+    fn get_version(&self, version: &semver::Version) -> Option<&Version> {
+        self.safe_versions().find(|v| {
+            semver::Version::parse(v.version()).map_or(false, |parsed| parsed.eq(version))
+        })
+    }
+}
+impl SafeVersions for Crate {
+    fn safe_versions(&self) -> impl DoubleEndedIterator<Item = &Version> {
+        self.versions().iter().filter(|v| {
+            !v.is_yanked()
+                && semver::Version::parse(v.version()).map_or(false, |parsed| parsed.pre.is_empty())
+        })
+    }
+}
+
+/// Filter dependencies for those likely to be relevant to Android.
+pub trait AndroidDependencies {
+    fn android_deps(&self) -> impl DoubleEndedIterator<Item = &Dependency>;
+    fn android_version_reqs_by_name(&self) -> HashMap<&str, &str> {
+        self.android_deps().map(|dep| (dep.crate_name(), dep.requirement())).collect()
+    }
+    fn android_deps_with_version_reqs(
+        &self,
+    ) -> impl DoubleEndedIterator<Item = (&Dependency, VersionReq)> {
+        self.android_deps().filter_map(|dep| {
+            VersionReq::parse(dep.requirement()).map_or(None, |req| Some((dep, req)))
+        })
+    }
+}
+impl AndroidDependencies for Version {
+    fn android_deps(&self) -> impl DoubleEndedIterator<Item = &Dependency> {
+        self.dependencies().iter().filter(|dep| {
+            dep.kind() == DependencyKind::Normal && !dep.is_optional() && dep.is_android()
+        })
+    }
+}
+
+/// Dependencies that are likely to be relevant to Android.
+/// Unconditional dependencies (without a target cfg string) are always relevant.
+/// Conditional dependencies are relevant if they are for Unix, Android, or Linux, and for an architecture we care about (Arm, RISC-V, or X86)
+pub trait IsAndroid {
+    /// Returns true if this dependency is likely to be relevant to Android.
+    fn is_android(&self) -> bool;
+}
+impl IsAndroid for Dependency {
+    fn is_android(&self) -> bool {
+        self.target().map_or(true, is_android)
+    }
+}
+fn is_android(target: &str) -> bool {
+    let expr = cfg_expr::Expression::parse(target);
+    if expr.is_err() {
+        return false;
+    }
+    let expr = expr.unwrap();
+    expr.eval(|pred| match pred {
+        Predicate::Target(target_predicate) => match target_predicate {
+            TargetPredicate::Family(family) => *family == Family::unix,
+            TargetPredicate::Os(os) => *os == Os::android || *os == Os::linux,
+            TargetPredicate::Arch(arch) => {
+                [Arch::arm, Arch::aarch64, Arch::riscv32, Arch::riscv64, Arch::x86, Arch::x86_64]
+                    .contains(arch)
+            }
+            _ => true,
+        },
+        _ => true,
+    })
+}
+
+pub trait DependencyChanges {
+    fn is_new_dep(&self, base_deps: &HashMap<&str, &str>) -> bool;
+    fn is_changed_dep(&self, base_deps: &HashMap<&str, &str>) -> bool;
+}
+
+impl DependencyChanges for Dependency {
+    fn is_new_dep(&self, base_deps: &HashMap<&str, &str>) -> bool {
+        !base_deps.contains_key(self.crate_name())
+    }
+
+    fn is_changed_dep(&self, base_deps: &HashMap<&str, &str>) -> bool {
+        let base_dep = base_deps.get(self.crate_name());
+        base_dep.is_none() || base_dep.is_some_and(|base_req| *base_req != self.requirement())
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+    #[test]
+    fn test_android_cfgs() {
+        assert!(!is_android("asmjs-unknown-emscripten"), "Parse error");
+        assert!(!is_android("cfg(windows)"));
+        assert!(is_android("cfg(unix)"));
+        assert!(!is_android(r#"cfg(target_os = "redox")"#));
+        assert!(!is_android(r#"cfg(target_arch = "wasm32")"#));
+        assert!(is_android(r#"cfg(any(target_os = "linux", target_os = "android"))"#));
+        assert!(is_android(
+            r#"cfg(any(all(target_arch = "arm", target_pointer_width = "32"), target_arch = "mips", target_arch = "powerpc"))"#
+        ));
+        assert!(!is_android(
+            r#"cfg(all(target_arch = "wasm32", target_vendor = "unknown", target_os = "unknown"))"#
+        ));
+        assert!(is_android("cfg(tracing_unstable)"));
+        assert!(is_android(r#"cfg(any(unix, target_os = "wasi"))"#));
+        assert!(is_android(r#"cfg(not(all(target_arch = "arm", target_os = "none")))"#))
+    }
+}
diff --git a/tools/external_crates/crate_health/src/lib.rs b/tools/external_crates/crate_tool/src/lib.rs
similarity index 60%
rename from tools/external_crates/crate_health/src/lib.rs
rename to tools/external_crates/crate_tool/src/lib.rs
index 4775cf430..e0ca11f22 100644
--- a/tools/external_crates/crate_health/src/lib.rs
+++ b/tools/external_crates/crate_tool/src/lib.rs
@@ -15,37 +15,26 @@
 use std::env::current_dir;
 use std::fs::{create_dir_all, remove_dir_all};
 use std::path::{Path, PathBuf};
-use std::process::{Command, Output};
+use std::process::{Command, ExitStatus, Output};
 use std::str::from_utf8;
 
 use anyhow::{anyhow, Context, Result};
 use semver::Version;
 use thiserror::Error;
 
-pub use self::crate_type::{diff_android_bp, Crate};
-mod crate_type;
-
-pub use self::crate_collection::CrateCollection;
-mod crate_collection;
-
-mod migration;
-
-pub use self::pseudo_crate::PseudoCrate;
-mod pseudo_crate;
-
-pub use self::version_match::{CompatibleVersionPair, VersionMatch, VersionPair};
-mod version_match;
-
-pub use self::android_bp::{
-    build_cargo_embargo, cargo_embargo_autoconfig, generate_android_bps, maybe_build_cargo_embargo,
-};
 mod android_bp;
-
-pub use self::license::{most_restrictive_type, update_module_license_files};
+mod crate_collection;
+mod crate_type;
+mod crates_io;
 mod license;
+mod managed_crate;
+mod managed_repo;
+mod patch;
+mod pseudo_crate;
+mod upgradable;
 
+pub use self::android_bp::maybe_build_cargo_embargo;
 pub use self::managed_repo::ManagedRepo;
-mod managed_repo;
 
 #[derive(Error, Debug)]
 pub enum CrateError {
@@ -81,21 +70,52 @@ pub trait RunQuiet {
 }
 impl RunQuiet for Command {
     fn run_quiet_and_expect_success(&mut self) -> Result<Output> {
-        let output = self.output().context(format!("Failed to run {:?}", self))?;
-        if !output.status.success() {
-            return Err(anyhow!(
-                "Exit status {} for {:?}\nSTDOUT:\n{}\nSTDERR:\n{}",
-                output
-                    .status
-                    .code()
-                    .map(|code| { format!("{}", code) })
-                    .unwrap_or("(unknown)".to_string()),
-                self,
-                from_utf8(&output.stdout)?,
-                from_utf8(&output.stderr)?
-            ));
+        self.output()
+            .context(format!("Failed to run {:?}", self))?
+            .success_or_error()
+            .context(format!("Failed to run {:?}", self))
+    }
+}
+
+pub trait SuccessOrError {
+    fn success_or_error(self) -> Result<Self>
+    where
+        Self: std::marker::Sized;
+}
+impl SuccessOrError for ExitStatus {
+    fn success_or_error(self) -> Result<Self> {
+        if !self.success() {
+            let exit_code =
+                self.code().map(|code| format!("{}", code)).unwrap_or("(unknown)".to_string());
+            Err(anyhow!("Process failed with exit code {}", exit_code))
+        } else {
+            Ok(self)
+        }
+    }
+}
+impl SuccessOrError for Output {
+    fn success_or_error(self) -> Result<Self> {
+        (&self).success_or_error()?;
+        Ok(self)
+    }
+}
+impl SuccessOrError for &Output {
+    fn success_or_error(self) -> Result<Self> {
+        if !self.status.success() {
+            let exit_code = self
+                .status
+                .code()
+                .map(|code| format!("{}", code))
+                .unwrap_or("(unknown)".to_string());
+            Err(anyhow!(
+                "Process failed with exit code {}\nstdout:\n{}\nstderr:\n{}",
+                exit_code,
+                from_utf8(&self.stdout)?,
+                from_utf8(&self.stderr)?
+            ))
+        } else {
+            Ok(self)
         }
-        Ok(output)
     }
 }
 
diff --git a/tools/external_crates/crate_health/src/license.rs b/tools/external_crates/crate_tool/src/license.rs
similarity index 100%
rename from tools/external_crates/crate_health/src/license.rs
rename to tools/external_crates/crate_tool/src/license.rs
diff --git a/tools/external_crates/crate_tool/src/main.rs b/tools/external_crates/crate_tool/src/main.rs
new file mode 100644
index 000000000..af36c62c0
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/main.rs
@@ -0,0 +1,250 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::{BTreeMap, BTreeSet},
+    path::PathBuf,
+};
+
+use anyhow::Result;
+use clap::{Args, Parser, Subcommand};
+use crate_tool::{default_repo_root, maybe_build_cargo_embargo, ManagedRepo};
+use rooted_path::RootedPath;
+use semver::Version;
+
+#[derive(Parser)]
+struct Cli {
+    #[command(subcommand)]
+    command: Cmd,
+
+    // The path to the Android source repo.
+    #[arg(long, default_value_os_t=default_repo_root().unwrap_or(PathBuf::from(".")))]
+    android_root: PathBuf,
+
+    // The path to the crate monorepo, relative to the Android source repo.
+    #[arg(long, default_value_os_t=PathBuf::from("external/rust/android-crates-io"))]
+    managed_repo_path: PathBuf,
+
+    /// Rebuild cargo_embargo and bpfmt, even if they are already present in the out directory.
+    #[arg(long, default_value_t = false)]
+    rebuild_cargo_embargo: bool,
+
+    /// Print command output in case of error, and full diffs.
+    #[arg(long, default_value_t = false)]
+    verbose: bool,
+
+    /// Don't make network requests to crates.io. Only check the local cache.
+    #[arg(long, default_value_t = false)]
+    offline: bool,
+}
+
+#[derive(Subcommand)]
+enum Cmd {
+    /// Check the health of a crate, and whether it is safe to migrate.
+    MigrationHealth {
+        #[command(flatten)]
+        crates: MigrationCrateList,
+    },
+    /// Migrate crates from external/rust/crates to the monorepo.
+    Migrate {
+        #[command(flatten)]
+        crates: MigrationCrateList,
+    },
+    /// Analyze a crate to see if it can be imported.
+    #[command(hide = true)]
+    AnalyzeImport {
+        /// The crate name.
+        crate_name: String,
+    },
+    /// Import a crate and its dependencies into the monorepo.
+    #[command(hide = true)]
+    Import {
+        /// The crate name.
+        crate_name: String,
+
+        /// The crate version.
+        version: String,
+
+        /// Run "cargo_embargo autoconfig"
+        #[arg(long, default_value_t = false)]
+        autoconfig: bool,
+    },
+    /// Regenerate crates from vendored code by applying patches, running cargo_embargo, etc.
+    Regenerate {
+        #[command(flatten)]
+        crates: CrateList,
+    },
+    /// Run pre-upload checks.
+    PreuploadCheck {
+        /// List of changed files
+        files: Vec<String>,
+    },
+    /// Fix problems with license files.
+    FixLicenses {
+        #[command(flatten)]
+        crates: CrateList,
+    },
+    /// Fix up METADATA files.
+    FixMetadata {
+        #[command(flatten)]
+        crates: CrateList,
+    },
+    /// Recontextualize patch files.
+    RecontextualizePatches {
+        #[command(flatten)]
+        crates: CrateList,
+    },
+    /// Find crates with a newer version on crates.io
+    UpdatableCrates {},
+    /// Analyze possible updates for a crate and try to identify potential problems.
+    AnalyzeUpdates { crate_name: String },
+    /// Suggest crate updates.
+    SuggestUpdates {
+        /// Don't exclude crates that have patches.
+        #[arg(long, default_value_t = false)]
+        patches: bool,
+    },
+    /// Update a crate to the specified version.
+    Update {
+        /// The crate name.
+        crate_name: String,
+
+        /// The crate version.
+        version: String,
+    },
+    /// Try suggested crate updates and see which ones succeed.
+    ///
+    /// Take about 15 minutes per crate, so suggested use is to tee to a file and let it run overnight:
+    ///
+    /// ./android_cargo.py run --bin crate_tool -- try-updates | tee crate-updates
+    TryUpdates {},
+    /// Initialize a new managed repo.
+    Init {},
+    /// Update TEST_MAPPING files.
+    #[command(hide = true)]
+    TestMapping {
+        #[command(flatten)]
+        crates: CrateList,
+    },
+}
+
+#[derive(Args)]
+struct CrateList {
+    /// The crate names.
+    crates: Vec<String>,
+
+    /// All crates.
+    #[arg(long, default_value_t = false)]
+    all: bool,
+
+    /// Comma-separated list of crates to exclude from --all.
+    #[arg(long, value_parser = CrateList::parse_crate_list, required=false, default_value="")]
+    exclude: BTreeSet<String>,
+}
+
+impl CrateList {
+    fn to_list(&self, managed_repo: &ManagedRepo) -> Result<Vec<String>> {
+        Ok(if self.all {
+            managed_repo.all_crate_names()?.difference(&self.exclude).cloned().collect::<Vec<_>>()
+        } else {
+            self.crates.clone()
+        })
+    }
+    pub fn parse_crate_list(arg: &str) -> Result<BTreeSet<String>> {
+        Ok(arg.split(',').map(|k| k.to_string()).collect())
+    }
+}
+
+#[derive(Args)]
+struct MigrationCrateList {
+    /// The crate names. Also the directory names in external/rust/crates.
+    crates: Vec<String>,
+
+    /// Don't pin the crate version for the specified crates when checking health or migrating.
+    /// Specified as a comma-separated list of crate names.
+    #[arg(long, value_parser = CrateList::parse_crate_list, required=false, default_value="")]
+    unpinned: BTreeSet<String>,
+
+    /// For crates with multiple versions, use the specified version.
+    /// Specified as a comma-separated list of <crate_name>=<version>.
+    #[arg(long, value_parser = MigrationCrateList::parse_crate_versions, required=false, default_value="")]
+    versions: BTreeMap<String, Version>,
+}
+
+impl MigrationCrateList {
+    pub fn parse_crate_versions(arg: &str) -> Result<BTreeMap<String, Version>> {
+        Ok(arg
+            .split(',')
+            .filter(|k| !k.is_empty())
+            .map(|nv| nv.split_once("=").unwrap())
+            .map(|(crate_name, version)| (crate_name.to_string(), Version::parse(version).unwrap()))
+            .collect())
+    }
+}
+
+fn main() -> Result<()> {
+    let args = Cli::parse();
+
+    maybe_build_cargo_embargo(&args.android_root, args.rebuild_cargo_embargo)?;
+
+    let managed_repo = ManagedRepo::new(
+        RootedPath::new(args.android_root, args.managed_repo_path)?,
+        args.offline,
+    )?;
+
+    match args.command {
+        Cmd::MigrationHealth { crates } => {
+            for crate_name in &crates.crates {
+                if let Err(e) = managed_repo.migration_health(
+                    crate_name,
+                    args.verbose,
+                    crates.unpinned.contains(crate_name),
+                    crates.versions.get(crate_name),
+                ) {
+                    println!("Crate {} error: {}", crate_name, e);
+                }
+            }
+            Ok(())
+        }
+        Cmd::Migrate { crates } => {
+            managed_repo.migrate(crates.crates, args.verbose, &crates.unpinned, &crates.versions)
+        }
+        Cmd::Regenerate { crates } => {
+            managed_repo.regenerate(crates.to_list(&managed_repo)?.into_iter(), true)
+        }
+        Cmd::PreuploadCheck { files } => managed_repo.preupload_check(&files),
+        Cmd::AnalyzeImport { crate_name } => managed_repo.analyze_import(&crate_name),
+        Cmd::Import { crate_name, version, autoconfig } => {
+            managed_repo.import(&crate_name, &version, autoconfig)
+        }
+        Cmd::FixLicenses { crates } => {
+            managed_repo.fix_licenses(crates.to_list(&managed_repo)?.into_iter())
+        }
+        Cmd::FixMetadata { crates } => {
+            managed_repo.fix_metadata(crates.to_list(&managed_repo)?.into_iter())
+        }
+        Cmd::RecontextualizePatches { crates } => {
+            managed_repo.recontextualize_patches(crates.to_list(&managed_repo)?.into_iter())
+        }
+        Cmd::UpdatableCrates {} => managed_repo.updatable_crates(),
+        Cmd::AnalyzeUpdates { crate_name } => managed_repo.analyze_updates(crate_name),
+        Cmd::SuggestUpdates { patches } => managed_repo.suggest_updates(patches).map(|_x| ()),
+        Cmd::Update { crate_name, version } => managed_repo.update(crate_name, version),
+        Cmd::TryUpdates {} => managed_repo.try_updates(),
+        Cmd::Init {} => managed_repo.init(),
+        Cmd::TestMapping { crates } => {
+            managed_repo.fix_test_mapping(crates.to_list(&managed_repo)?.into_iter())
+        }
+    }
+}
diff --git a/tools/external_crates/crate_tool/src/managed_crate.rs b/tools/external_crates/crate_tool/src/managed_crate.rs
new file mode 100644
index 000000000..f8a86a27c
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/managed_crate.rs
@@ -0,0 +1,501 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::HashMap,
+    fs::{copy, read_dir, read_link, read_to_string, remove_dir_all, rename, write},
+    os::unix::fs::symlink,
+    path::PathBuf,
+    process::{Command, Output},
+    str::from_utf8,
+    sync::LazyLock,
+};
+
+use anyhow::{anyhow, ensure, Context, Result};
+use glob::glob;
+use google_metadata::GoogleMetadata;
+use license_checker::find_licenses;
+use name_and_version::NamedAndVersioned;
+use rooted_path::RootedPath;
+use semver::Version;
+use test_mapping::TestMapping;
+
+use crate::{
+    android_bp::run_cargo_embargo,
+    copy_dir,
+    crate_type::Crate,
+    ensure_exists_and_empty,
+    license::update_module_license_files,
+    patch::Patch,
+    pseudo_crate::{CargoVendorClean, PseudoCrate},
+    SuccessOrError,
+};
+
+#[derive(Debug)]
+pub struct ManagedCrate<State: ManagedCrateState> {
+    android_crate: Crate,
+    extra: State,
+}
+
+#[derive(Debug)]
+pub struct New {}
+#[derive(Debug)]
+pub struct Vendored {
+    vendored_crate: Crate,
+}
+#[derive(Debug)]
+pub struct Staged {
+    vendored_crate: Crate,
+    patch_output: Vec<(String, Output)>,
+    cargo_embargo_output: Output,
+    android_bp_diff: Output,
+}
+pub trait ManagedCrateState {}
+impl ManagedCrateState for New {}
+impl ManagedCrateState for Vendored {}
+impl ManagedCrateState for Staged {}
+
+static CUSTOMIZATIONS: &[&str] = &[
+    "*.bp",
+    "*.bp.fragment",
+    "*.mk",
+    "cargo_embargo.json",
+    "patches",
+    "METADATA",
+    "TEST_MAPPING",
+    "MODULE_LICENSE_*",
+    "README.android",
+];
+
+static SYMLINKS: &[&str] = &["LICENSE", "NOTICE"];
+
+static DELETIONS: LazyLock<HashMap<&str, &[&str]>> = LazyLock::new(|| {
+    HashMap::from([
+        ("libbpf-sys", ["elfutils", "zlib", "libbpf"].as_slice()),
+        ("libusb1-sys", ["libusb"].as_slice()),
+    ])
+});
+
+impl<State: ManagedCrateState> ManagedCrate<State> {
+    pub fn name(&self) -> &str {
+        self.android_crate.name()
+    }
+    pub fn android_version(&self) -> &Version {
+        self.android_crate.version()
+    }
+    pub fn android_crate_path(&self) -> &RootedPath {
+        self.android_crate.path()
+    }
+    pub fn android_bp(&self) -> RootedPath {
+        self.android_crate_path().join("Android.bp").unwrap()
+    }
+    pub fn cargo_embargo_json(&self) -> RootedPath {
+        self.android_crate_path().join("cargo_embargo.json").unwrap()
+    }
+    pub fn staging_path(&self) -> RootedPath {
+        self.android_crate
+            .path()
+            .with_same_root("out/rust-crate-temporary-build")
+            .unwrap()
+            .join(self.name())
+            .unwrap()
+    }
+    fn patch_dir(&self) -> RootedPath {
+        self.android_crate_path().join("patches").unwrap()
+    }
+    pub fn patches(&self) -> Result<Vec<PathBuf>> {
+        let mut patches = Vec::new();
+        let patch_dir = self.patch_dir();
+        if patch_dir.abs().exists() {
+            for entry in
+                read_dir(&patch_dir).context(format!("Failed to read_dir {}", patch_dir))?
+            {
+                let entry = entry?;
+                if entry.file_name() == "Android.bp.patch"
+                    || entry.file_name() == "Android.bp.diff"
+                    || entry.file_name() == "rules.mk.diff"
+                {
+                    continue;
+                }
+                patches.push(entry.path());
+            }
+        }
+
+        Ok(patches)
+    }
+    pub fn recontextualize_patches(&self) -> Result<()> {
+        let output = Command::new("git")
+            .args(["status", "--porcelain", "."])
+            .current_dir(self.android_crate_path())
+            .output()?
+            .success_or_error()?;
+        if !output.stdout.is_empty() {
+            return Err(anyhow!(
+                "Crate directory {} has uncommitted changes",
+                self.android_crate_path()
+            ));
+        }
+        let mut new_patch_contents = Vec::new();
+        for patch in self.patches()? {
+            println!("Recontextualizing {}", patch.display());
+            // Patch files can be in many different formats, and patch is very
+            // forgiving. We might be able to use "git apply -R --directory=crates/foo"
+            // once we have everything in the same format.
+            Command::new("patch")
+                .args(["-R", "-p1", "-l", "--reject-file=-", "--no-backup-if-mismatch", "-i"])
+                .arg(&patch)
+                .current_dir(self.android_crate_path())
+                .spawn()?
+                .wait()?
+                .success_or_error()?;
+            Command::new("git")
+                .args(["add", "."])
+                .current_dir(self.android_crate_path())
+                .spawn()?
+                .wait()?
+                .success_or_error()?;
+            let output = Command::new("git")
+                .args([
+                    "diff",
+                    format!("--relative=crates/{}", self.name()).as_str(),
+                    "-p",
+                    "--stat",
+                    "-R",
+                    "--staged",
+                    ".",
+                ])
+                .current_dir(self.android_crate_path())
+                .output()?
+                .success_or_error()?;
+            Command::new("git")
+                .args(["restore", "--staged", "."])
+                .current_dir(self.android_crate_path())
+                .spawn()?
+                .wait()?
+                .success_or_error()?;
+            Command::new("git")
+                .args(["restore", "."])
+                .current_dir(self.android_crate_path())
+                .spawn()?
+                .wait()?
+                .success_or_error()?;
+            Command::new("git")
+                .args(["clean", "-f", "."])
+                .current_dir(self.android_crate_path())
+                .spawn()?
+                .wait()?
+                .success_or_error()?;
+            let patch_contents = read_to_string(&patch)?;
+            let parsed = Patch::parse(&patch_contents);
+            new_patch_contents.push((patch, parsed.reassemble(&output.stdout)));
+        }
+        for (path, contents) in new_patch_contents {
+            write(path, contents)?;
+        }
+        Ok(())
+    }
+    pub fn fix_licenses(&self) -> Result<()> {
+        println!("{} = \"={}\"", self.name(), self.android_version());
+        let state =
+            find_licenses(self.android_crate_path(), self.name(), self.android_crate.license())?;
+        if !state.unsatisfied.is_empty() {
+            println!("{:?}", state);
+        } else {
+            // For now, just update MODULE_LICENSE_*
+            update_module_license_files(self.android_crate_path(), &state)?;
+        }
+        Ok(())
+    }
+    pub fn fix_metadata(&self) -> Result<()> {
+        println!("{} = \"={}\"", self.name(), self.android_version());
+        let mut metadata = GoogleMetadata::try_from(self.android_crate_path().join("METADATA")?)?;
+        metadata.set_version_and_urls(self.name(), self.android_version().to_string())?;
+        metadata.migrate_archive();
+        metadata.migrate_homepage();
+        metadata.remove_deprecated_url();
+        metadata.write()?;
+        Ok(())
+    }
+    pub fn fix_test_mapping(&self) -> Result<()> {
+        let mut tm = TestMapping::read(self.android_crate_path().clone())?;
+        println!("{}", self.name());
+        if tm.fix_import_paths() || tm.add_new_tests_to_postsubmit()? {
+            tm.write()?;
+        }
+        Ok(())
+    }
+}
+
+impl ManagedCrate<New> {
+    pub fn new(android_crate: Crate) -> Self {
+        ManagedCrate { android_crate, extra: New {} }
+    }
+    pub fn into_legacy(self) -> ManagedCrate<Vendored> {
+        ManagedCrate {
+            android_crate: self.android_crate.clone(),
+            extra: Vendored { vendored_crate: self.android_crate },
+        }
+    }
+    fn into_vendored(
+        self,
+        pseudo_crate: &PseudoCrate<CargoVendorClean>,
+    ) -> Result<ManagedCrate<Vendored>> {
+        let vendored_crate =
+            Crate::from(pseudo_crate.vendored_dir_for(self.android_crate.name())?.clone())?;
+        Ok(ManagedCrate { android_crate: self.android_crate, extra: Vendored { vendored_crate } })
+    }
+    pub fn stage(
+        self,
+        pseudo_crate: &PseudoCrate<CargoVendorClean>,
+    ) -> Result<ManagedCrate<Staged>> {
+        self.into_vendored(pseudo_crate)?.stage()
+    }
+    pub fn regenerate(
+        self,
+        update_metadata: bool,
+        pseudo_crate: &PseudoCrate<CargoVendorClean>,
+    ) -> Result<ManagedCrate<Staged>> {
+        self.into_vendored(pseudo_crate)?.regenerate(update_metadata)
+    }
+}
+
+impl ManagedCrate<Vendored> {
+    pub fn stage(self) -> Result<ManagedCrate<Staged>> {
+        self.copy_to_staging()?;
+
+        // Workaround. When checking the health of a legacy crate, there is no separate vendored crate,
+        // so we just have self.android_crate and self.vendored_crate point to the same directory.
+        // In this case, there is no need to copy Android customizations into the clean vendored copy
+        // or apply the patches.
+        if self.android_crate.path() != self.extra.vendored_crate.path() {
+            self.copy_customizations()?;
+        }
+
+        let patch_output = if self.android_crate.path() != self.extra.vendored_crate.path() {
+            self.apply_patches()?
+        } else {
+            Vec::new()
+        };
+
+        let cargo_embargo_output = run_cargo_embargo(&self.staging_path())?;
+        let android_bp_diff = self.diff_android_bp()?;
+
+        Ok(ManagedCrate {
+            android_crate: self.android_crate,
+            extra: Staged {
+                vendored_crate: self.extra.vendored_crate,
+                patch_output,
+                cargo_embargo_output,
+                android_bp_diff,
+            },
+        })
+    }
+    fn copy_to_staging(&self) -> Result<()> {
+        let staging_path = self.staging_path();
+        ensure_exists_and_empty(&staging_path)?;
+        remove_dir_all(&staging_path).context(format!("Failed to remove {}", staging_path))?;
+        copy_dir(self.extra.vendored_crate.path(), &staging_path).context(format!(
+            "Failed to copy {} to {}",
+            self.extra.vendored_crate.path(),
+            self.staging_path()
+        ))?;
+        if staging_path.join(".git")?.abs().is_dir() {
+            remove_dir_all(staging_path.join(".git")?)
+                .with_context(|| "Failed to remove .git".to_string())?;
+        }
+        Ok(())
+    }
+    fn copy_customizations(&self) -> Result<()> {
+        let dest_dir = self.staging_path();
+        for pattern in CUSTOMIZATIONS {
+            let full_pattern = self.android_crate.path().join(pattern)?;
+            for entry in glob(
+                full_pattern
+                    .abs()
+                    .to_str()
+                    .ok_or(anyhow!("Failed to convert path {} to str", full_pattern))?,
+            )? {
+                let entry = entry?;
+                let filename = entry
+                    .file_name()
+                    .context(format!("Failed to get file name for {}", entry.display()))?
+                    .to_os_string();
+                if entry.is_dir() {
+                    copy_dir(&entry, &dest_dir.join(filename)?).context(format!(
+                        "Failed to copy {} to {}",
+                        entry.display(),
+                        dest_dir
+                    ))?;
+                } else {
+                    let dest_file = dest_dir.join(&filename)?;
+                    if dest_file.abs().exists() {
+                        return Err(anyhow!("Destination file {} exists", dest_file));
+                    }
+                    copy(&entry, dest_dir.join(filename)?).context(format!(
+                        "Failed to copy {} to {}",
+                        entry.display(),
+                        dest_dir
+                    ))?;
+                }
+            }
+        }
+        for link in SYMLINKS {
+            let src_path = self.android_crate.path().join(link)?;
+            if src_path.abs().is_symlink() {
+                let dest = read_link(src_path)?;
+                if dest.exists() {
+                    return Err(anyhow!(
+                        "Can't symlink {} -> {} because destination exists",
+                        link,
+                        dest.display(),
+                    ));
+                }
+                symlink(dest, dest_dir.join(link)?)?;
+            }
+        }
+        for deletion in *DELETIONS.get(self.name()).unwrap_or(&[].as_slice()) {
+            let dir = self.staging_path().join(deletion)?;
+            ensure!(dir.abs().is_dir(), "{dir} is not a directory");
+            remove_dir_all(dir)?;
+        }
+        Ok(())
+    }
+    fn apply_patches(&self) -> Result<Vec<(String, Output)>> {
+        let mut patch_output = Vec::new();
+        for patch in self.patches()? {
+            let output = Command::new("patch")
+                .args(["-p1", "-l", "--no-backup-if-mismatch", "-i"])
+                .arg(&patch)
+                .current_dir(self.staging_path())
+                .output()?;
+            patch_output.push((
+                String::from_utf8_lossy(patch.file_name().unwrap().as_encoded_bytes()).to_string(),
+                output,
+            ));
+        }
+        Ok(patch_output)
+    }
+    fn diff_android_bp(&self) -> Result<Output> {
+        Ok(Command::new("diff")
+            .args([
+                "-u",
+                "-w",
+                "-B",
+                "-I",
+                r#"default_team: "trendy_team_android_rust""#,
+                "-I",
+                "// has rustc warnings",
+                "-I",
+                "This file is generated by",
+                "-I",
+                "cargo_pkg_version:",
+            ])
+            .arg(self.android_bp().rel())
+            .arg(self.staging_path().join("Android.bp")?.rel())
+            .current_dir(self.android_crate.path().root())
+            .output()?)
+    }
+    pub fn regenerate(self, update_metadata: bool) -> Result<ManagedCrate<Staged>> {
+        let staged = self.stage()?;
+        staged.check_staged()?;
+        if !staged.staging_path().abs().exists() {
+            return Err(anyhow!("Staged crate not found at {}", staged.staging_path()));
+        }
+        if update_metadata {
+            let mut metadata =
+                GoogleMetadata::try_from(staged.staging_path().join("METADATA").unwrap())?;
+            let mut writeback = false;
+            writeback |= metadata.migrate_homepage();
+            writeback |= metadata.migrate_archive();
+            writeback |= metadata.remove_deprecated_url();
+            let vendored_version = staged.extra.vendored_crate.version();
+            if staged.android_crate.version() != vendored_version {
+                metadata.set_date_to_today()?;
+                metadata.set_version_and_urls(staged.name(), vendored_version.to_string())?;
+                writeback |= true;
+            }
+            if writeback {
+                metadata.write()?;
+            }
+        }
+
+        let android_crate_dir = staged.android_crate.path();
+        remove_dir_all(android_crate_dir)?;
+        rename(staged.staging_path(), android_crate_dir)?;
+
+        Ok(staged)
+    }
+}
+
+impl ManagedCrate<Staged> {
+    pub fn vendored_version(&self) -> &Version {
+        self.extra.vendored_crate.version()
+    }
+    pub fn check_staged(&self) -> Result<()> {
+        if !self.patch_success() {
+            for (patch, output) in self.patch_output() {
+                if !output.status.success() {
+                    return Err(anyhow!(
+                        "Failed to patch {} with {}\nstdout:\n{}\nstderr:\n{}",
+                        self.name(),
+                        patch,
+                        from_utf8(&output.stdout)?,
+                        from_utf8(&output.stderr)?
+                    ));
+                }
+            }
+        }
+        self.cargo_embargo_output()
+            .success_or_error()
+            .context(format!("cargo_embargo execution failed for {}", self.name()))?;
+
+        Ok(())
+    }
+    pub fn diff_staged(&self) -> Result<()> {
+        let diff_status = Command::new("diff")
+            .args(["-u", "-r", "-w", "--no-dereference"])
+            .arg(self.staging_path().rel())
+            .arg(self.android_crate.path().rel())
+            .current_dir(self.extra.vendored_crate.path().root())
+            .spawn()?
+            .wait()?;
+        if !diff_status.success() {
+            return Err(anyhow!(
+                "Found differences between {} and {}",
+                self.android_crate.path(),
+                self.staging_path()
+            ));
+        }
+
+        Ok(())
+    }
+    pub fn patch_success(&self) -> bool {
+        self.extra.patch_output.iter().all(|output| output.1.status.success())
+    }
+    pub fn patch_output(&self) -> &Vec<(String, Output)> {
+        &self.extra.patch_output
+    }
+    pub fn android_bp_diff(&self) -> &Output {
+        &self.extra.android_bp_diff
+    }
+    pub fn cargo_embargo_output(&self) -> &Output {
+        &self.extra.cargo_embargo_output
+    }
+    pub fn cargo_embargo_success(&self) -> bool {
+        self.extra.cargo_embargo_output.status.success()
+    }
+    pub fn android_bp_unchanged(&self) -> bool {
+        self.extra.android_bp_diff.status.success()
+    }
+}
diff --git a/tools/external_crates/crate_tool/src/managed_repo.rs b/tools/external_crates/crate_tool/src/managed_repo.rs
new file mode 100644
index 000000000..4980104c4
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/managed_repo.rs
@@ -0,0 +1,956 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::{BTreeMap, BTreeSet},
+    env,
+    fs::{create_dir, create_dir_all, read_dir, remove_file, write},
+    os::unix::fs::symlink,
+    path::Path,
+    process::Command,
+    str::from_utf8,
+};
+
+use anyhow::{anyhow, Context, Result};
+use crates_index::DependencyKind;
+use glob::glob;
+use google_metadata::GoogleMetadata;
+use itertools::Itertools;
+use license_checker::find_licenses;
+use name_and_version::{NameAndVersionMap, NameAndVersionRef, NamedAndVersioned};
+use rooted_path::RootedPath;
+use semver::Version;
+use spdx::Licensee;
+
+use crate::{
+    android_bp::cargo_embargo_autoconfig,
+    copy_dir,
+    crate_collection::CrateCollection,
+    crate_type::Crate,
+    crates_io::{AndroidDependencies, CratesIoIndex, DependencyChanges, SafeVersions},
+    license::{most_restrictive_type, update_module_license_files},
+    managed_crate::ManagedCrate,
+    pseudo_crate::{CargoVendorDirty, PseudoCrate},
+    upgradable::{IsUpgradableTo, MatchesRelaxed},
+    SuccessOrError,
+};
+
+pub struct ManagedRepo {
+    path: RootedPath,
+    crates_io: CratesIoIndex,
+}
+
+impl ManagedRepo {
+    pub fn new(path: RootedPath, offline: bool) -> Result<ManagedRepo> {
+        Ok(ManagedRepo {
+            path,
+            crates_io: if offline { CratesIoIndex::new_offline()? } else { CratesIoIndex::new()? },
+        })
+    }
+    fn pseudo_crate(&self) -> PseudoCrate<CargoVendorDirty> {
+        PseudoCrate::new(self.path.join("pseudo_crate").unwrap())
+    }
+    fn contains(&self, crate_name: &str) -> bool {
+        self.managed_dir_for(crate_name).abs().exists()
+    }
+    fn managed_dir(&self) -> RootedPath {
+        self.path.join("crates").unwrap()
+    }
+    fn managed_dir_for(&self, crate_name: &str) -> RootedPath {
+        self.managed_dir().join(crate_name).unwrap()
+    }
+    fn legacy_dir_for(&self, crate_name: &str, version: Option<&Version>) -> Result<RootedPath> {
+        match version {
+            Some(v) => {
+                let cc = self.legacy_crates_for(crate_name)?;
+                let nv = NameAndVersionRef::new(crate_name, v);
+                Ok(cc
+                    .map_field()
+                    .get(&nv as &dyn NamedAndVersioned)
+                    .ok_or(anyhow!("Failed to find crate {} v{}", crate_name, v))?
+                    .path()
+                    .clone())
+            }
+            None => {
+                Ok(self.path.with_same_root("external/rust/crates").unwrap().join(crate_name)?)
+            }
+        }
+    }
+    fn legacy_crates_for(&self, crate_name: &str) -> Result<CrateCollection> {
+        let mut cc = self.new_cc();
+        cc.add_from(format!("external/rust/crates/{}", crate_name))?;
+        Ok(cc)
+    }
+    fn legacy_crates(&self) -> Result<CrateCollection> {
+        let mut cc = self.new_cc();
+        cc.add_from("external/rust/crates")?;
+        Ok(cc)
+    }
+    fn new_cc(&self) -> CrateCollection {
+        CrateCollection::new(self.path.root())
+    }
+    fn managed_crate_for(
+        &self,
+        crate_name: &str,
+    ) -> Result<ManagedCrate<crate::managed_crate::New>> {
+        Ok(ManagedCrate::new(Crate::from(self.managed_dir_for(crate_name))?))
+    }
+    pub fn all_crate_names(&self) -> Result<BTreeSet<String>> {
+        let mut managed_dirs = BTreeSet::new();
+        if self.managed_dir().abs().exists() {
+            for entry in read_dir(self.managed_dir())? {
+                let entry = entry?;
+                if entry.path().is_dir() {
+                    managed_dirs.insert(entry.file_name().into_string().map_err(|e| {
+                        anyhow!("Failed to convert {} to string", e.to_string_lossy())
+                    })?);
+                }
+            }
+        }
+        Ok(managed_dirs)
+    }
+    pub fn migration_health(
+        &self,
+        crate_name: &str,
+        verbose: bool,
+        unpinned: bool,
+        version: Option<&Version>,
+    ) -> Result<Version> {
+        if self.contains(crate_name) {
+            return Err(anyhow!("Crate {} already exists in {}/crates", crate_name, self.path));
+        }
+
+        let cc = self.legacy_crates_for(crate_name)?;
+        let krate = match version {
+            Some(v) => {
+                let nv = NameAndVersionRef::new(crate_name, v);
+                match cc.map_field().get(&nv as &dyn NamedAndVersioned) {
+                    Some(k) => k,
+                    None => {
+                        return Err(anyhow!("Did not find crate {} v{}", crate_name, v));
+                    }
+                }
+            }
+            None => {
+                if cc.map_field().len() != 1 {
+                    return Err(anyhow!(
+                        "Expected a single crate version for {}, but found {}. Specify a version with --versions={}=<version>",
+                        crate_name,
+                        cc.get_versions(crate_name).map(|(nv, _)| nv.version()).join(", "),
+                        crate_name
+                    ));
+                }
+                cc.map_field().values().next().unwrap()
+            }
+        };
+        println!("Found {} v{} in {}", krate.name(), krate.version(), krate.path());
+
+        let mut healthy_self_contained = true;
+        if krate.is_migration_denied() {
+            println!("This crate is on the migration denylist");
+            healthy_self_contained = false;
+        }
+
+        let mc = ManagedCrate::new(Crate::from(krate.path().clone())?).into_legacy();
+        if !mc.android_bp().abs().exists() {
+            println!("There is no Android.bp file in {}", krate.path());
+            healthy_self_contained = false;
+        }
+        if !mc.cargo_embargo_json().abs().exists() {
+            println!("There is no cargo_embargo.json file in {}", krate.path());
+            healthy_self_contained = false;
+        }
+        if healthy_self_contained {
+            let mc = mc.stage()?;
+            if !mc.cargo_embargo_success() {
+                println!("cargo_embargo execution did not succeed for {}", mc.staging_path(),);
+                if verbose {
+                    println!(
+                        "stdout:\n{}\nstderr:\n{}",
+                        from_utf8(&mc.cargo_embargo_output().stdout)?,
+                        from_utf8(&mc.cargo_embargo_output().stderr)?,
+                    );
+                }
+                healthy_self_contained = false;
+            } else if !mc.android_bp_unchanged() {
+                println!(
+                    "Running cargo_embargo on {} produced changes to the Android.bp file",
+                    mc.staging_path()
+                );
+                if verbose {
+                    println!("{}", from_utf8(&mc.android_bp_diff().stdout)?);
+                }
+                healthy_self_contained = false;
+            }
+        }
+
+        if !healthy_self_contained {
+            println!("Crate {} is UNHEALTHY", crate_name);
+            return Err(anyhow!("Crate {} is unhealthy", crate_name));
+        }
+
+        let pseudo_crate = self.pseudo_crate();
+        if unpinned {
+            pseudo_crate.cargo_add_unpinned(krate)
+        } else {
+            pseudo_crate.cargo_add(krate)
+        }
+        .inspect_err(|_e| {
+            let _ = pseudo_crate.remove(krate.name());
+        })?;
+        let pseudo_crate = pseudo_crate.vendor()?;
+
+        let mc = ManagedCrate::new(Crate::from(krate.path().clone())?).stage(&pseudo_crate)?;
+
+        pseudo_crate.remove(krate.name())?;
+
+        let version = mc.vendored_version().clone();
+        if mc.android_version() != mc.vendored_version() {
+            println!(
+                "Source and destination versions are different: {} -> {}",
+                mc.android_version(),
+                mc.vendored_version()
+            );
+        }
+        if !mc.patch_success() {
+            println!("Patches did not apply successfully to the migrated crate");
+            if verbose {
+                for output in mc.patch_output() {
+                    if !output.1.status.success() {
+                        println!(
+                            "Failed to apply {}\nstdout:\n{}\nstderr:\n:{}",
+                            output.0,
+                            from_utf8(&output.1.stdout)?,
+                            from_utf8(&output.1.stderr)?
+                        );
+                    }
+                }
+            }
+        }
+        if !mc.cargo_embargo_success() {
+            println!("cargo_embargo execution did not succeed for the migrated crate");
+            if verbose {
+                println!(
+                    "stdout:\n{}\nstderr:\n{}",
+                    from_utf8(&mc.cargo_embargo_output().stdout)?,
+                    from_utf8(&mc.cargo_embargo_output().stderr)?,
+                );
+            }
+        } else if !mc.android_bp_unchanged() {
+            println!("Running cargo_embargo for the migrated crate produced changes to the Android.bp file");
+            if verbose {
+                println!("{}", from_utf8(&mc.android_bp_diff().stdout)?);
+            }
+        }
+
+        let mut diff_cmd = Command::new("diff");
+        diff_cmd.args(["-u", "-r", "-w", "--no-dereference"]);
+        if !verbose {
+            diff_cmd.arg("-q");
+        }
+        let diff_status = diff_cmd
+            .args(IGNORED_FILES.iter().map(|ignored| format!("--exclude={}", ignored)))
+            .args(["-I", r#"default_team: "trendy_team_android_rust""#])
+            .arg(mc.android_crate_path().rel())
+            .arg(mc.staging_path().rel())
+            .current_dir(self.path.root())
+            .spawn()?
+            .wait()?;
+        if !diff_status.success() {
+            println!(
+                "Found differences between {} and {}",
+                mc.android_crate_path(),
+                mc.staging_path()
+            );
+        }
+        if verbose {
+            println!("All diffs:");
+            Command::new("diff")
+                .args(["-u", "-r", "-w", "-q", "--no-dereference"])
+                .arg(mc.android_crate_path().rel())
+                .arg(mc.staging_path().rel())
+                .current_dir(self.path.root())
+                .spawn()?
+                .wait()?;
+        }
+
+        // Patching and running cargo_embargo *must* succeed. But if we are migrating with a version change,
+        // there could be some changes to the Android.bp.
+        if !mc.patch_success()
+            || !mc.cargo_embargo_success()
+            || (!mc.android_bp_unchanged() && !unpinned)
+        {
+            println!("Crate {} is UNHEALTHY", crate_name);
+            return Err(anyhow!("Crate {} is unhealthy", crate_name));
+        }
+
+        if diff_status.success() && mc.android_bp_unchanged() {
+            println!("Crate {} is healthy", crate_name);
+            return Ok(version);
+        }
+
+        if unpinned {
+            println!("The crate was added with an unpinned version, and diffs were found which must be inspected manually");
+            return Ok(version);
+        }
+
+        println!("Crate {} is UNHEALTHY", crate_name);
+        Err(anyhow!("Crate {} is unhealthy", crate_name))
+    }
+    pub fn migrate<T: AsRef<str>>(
+        &self,
+        crates: Vec<T>,
+        verbose: bool,
+        unpinned: &BTreeSet<String>,
+        versions: &BTreeMap<String, Version>,
+    ) -> Result<()> {
+        let pseudo_crate = self.pseudo_crate();
+        for crate_name in &crates {
+            let crate_name = crate_name.as_ref();
+            let version = self.migration_health(
+                crate_name,
+                verbose,
+                unpinned.contains(crate_name),
+                versions.get(crate_name),
+            )?;
+            let src_dir = self.legacy_dir_for(
+                crate_name,
+                if unpinned.contains(crate_name) { None } else { Some(&version) },
+            )?;
+
+            let monorepo_crate_dir = self.managed_dir();
+            if !monorepo_crate_dir.abs().exists() {
+                create_dir(monorepo_crate_dir)?;
+            }
+            copy_dir(src_dir, self.managed_dir_for(crate_name))?;
+            if unpinned.contains(crate_name) {
+                pseudo_crate.cargo_add_unpinned(&NameAndVersionRef::new(crate_name, &version))?;
+            } else {
+                pseudo_crate.cargo_add(&NameAndVersionRef::new(crate_name, &version))?;
+            }
+        }
+
+        self.regenerate(crates.iter(), false)?;
+
+        for crate_name in &crates {
+            let crate_name = crate_name.as_ref();
+            let src_dir = self.legacy_dir_for(
+                crate_name,
+                if unpinned.contains(crate_name) { None } else { versions.get(crate_name) },
+            )?;
+            for entry in glob(
+                src_dir
+                    .abs()
+                    .join("*.bp")
+                    .to_str()
+                    .ok_or(anyhow!("Failed to convert path *.bp to str"))?,
+            )? {
+                remove_file(entry?)?;
+            }
+            remove_file(src_dir.join("cargo_embargo.json")?)?;
+            let test_mapping = src_dir.join("TEST_MAPPING")?;
+            if test_mapping.abs().exists() {
+                remove_file(test_mapping)?;
+            }
+            write(
+                src_dir.join("Android.bp")?,
+                format!("// This crate has been migrated to {}.\n", self.path),
+            )?;
+        }
+
+        Ok(())
+    }
+    pub fn analyze_import(&self, crate_name: &str) -> Result<()> {
+        if self.contains(crate_name) {
+            println!("Crate already imported at {}", self.managed_dir_for(crate_name));
+            return Ok(());
+        }
+        let legacy_dir = self.legacy_dir_for(crate_name, None)?;
+        if legacy_dir.abs().exists() {
+            println!("Legacy crate already imported at {}", legacy_dir);
+            return Ok(());
+        }
+
+        let mut managed_crates = self.new_cc();
+        managed_crates.add_from(self.managed_dir().rel())?;
+        let legacy_crates = self.legacy_crates()?;
+
+        let cio_crate = self.crates_io.get_crate(crate_name)?;
+
+        for version in cio_crate.versions() {
+            println!("Version {}", version.version());
+            let mut found_problems = false;
+            for (dep, req) in version.android_deps_with_version_reqs() {
+                println!("Found dep {}", dep.crate_name());
+                let cc = if managed_crates.contains_name(dep.crate_name()) {
+                    &managed_crates
+                } else {
+                    &legacy_crates
+                };
+                if !cc.contains_name(dep.crate_name()) {
+                    found_problems = true;
+                    println!(
+                        "  Dep {} {} has not been imported to Android",
+                        dep.crate_name(),
+                        dep.requirement()
+                    );
+                    // This is a no-op because our dependency code only considers normal deps anyway.
+                    // TODO: Fix the deps code.
+                    if matches!(dep.kind(), DependencyKind::Dev) {
+                        println!("    But this is a dev dependency, probably only needed if you want to run the tests");
+                    }
+                    if dep.is_optional() {
+                        println!("    But this is an optional dependency, used by the following features: {}", dep.features().join(", "));
+                    }
+                    continue;
+                }
+                let versions = cc.get_versions(dep.crate_name()).collect::<Vec<_>>();
+                let has_matching_version =
+                    versions.iter().any(|(nv, _)| req.matches_relaxed(nv.version()));
+                if !has_matching_version {
+                    found_problems = true;
+                }
+                if !has_matching_version || versions.len() > 1 {
+                    if has_matching_version {
+                        println!("  Dep {} has multiple versions available. You may need to override the default choice in cargo_embargo.json", dep.crate_name());
+                    }
+                    for (_, dep_crate) in versions {
+                        println!(
+                            "  Dep {} {} is {}satisfied by v{} at {}",
+                            dep.crate_name(),
+                            dep.requirement(),
+                            if req.matches_relaxed(dep_crate.version()) { "" } else { "not " },
+                            dep_crate.version(),
+                            dep_crate.path()
+                        );
+                    }
+                }
+            }
+            if !found_problems {
+                println!("  No problems found with this version.")
+            }
+        }
+        Ok(())
+    }
+    pub fn import(&self, crate_name: &str, version: &str, autoconfig: bool) -> Result<()> {
+        if self.contains(crate_name) {
+            return Err(anyhow!("Crate already imported at {}", self.managed_dir_for(crate_name)));
+        }
+        let legacy_dir = self.legacy_dir_for(crate_name, None)?;
+        if legacy_dir.abs().exists() {
+            return Err(anyhow!("Legacy crate already imported at {}", legacy_dir));
+        }
+
+        let pseudo_crate = self.pseudo_crate();
+        let version = Version::parse(version)?;
+        let nv = NameAndVersionRef::new(crate_name, &version);
+        pseudo_crate.cargo_add(&nv)?;
+        let pseudo_crate = pseudo_crate.vendor()?;
+
+        let vendored_dir = pseudo_crate.vendored_dir_for(crate_name)?;
+        let managed_dir = self.managed_dir_for(crate_name);
+        println!("Creating {} from vendored crate", managed_dir);
+        copy_dir(vendored_dir, &managed_dir)?;
+
+        println!("Sprinkling Android glitter on {}:", crate_name);
+
+        let krate = Crate::from(managed_dir.clone())?;
+
+        println!("  Finding license files");
+        let licenses = find_licenses(krate.path().abs(), krate.name(), krate.license())?;
+
+        if !licenses.unsatisfied.is_empty() && licenses.satisfied.is_empty() {
+            let mut satisfied = false;
+            // Sometimes multiple crates live in a single GitHub repo. A common case
+            // is a crate with an associated proc_macro crate. In such cases, the individual
+            // crates are in subdirectories with license files at root of the repo, and
+            // the license files don't get distributed with the crates.
+            // So, if we didn't find a license file, try to guess the URL of the appropriate
+            // license file and download it. This is incredibly hacky, and only supports
+            // the most common case, which is LICENSE-APACHE.
+            if licenses.unsatisfied.len() == 1 {
+                let req = licenses.unsatisfied.first().unwrap();
+                if let Some(repository) = krate.repository() {
+                    if *req == Licensee::parse("Apache-2.0").unwrap().into_req() {
+                        let url = format!("{}/master/LICENSE-APACHE", repository);
+                        let body = reqwest::blocking::get(
+                            url.replace("github.com", "raw.githubusercontent.com"),
+                        )?
+                        .text()?;
+                        write(krate.path().abs().join("LICENSE"), body)?;
+                        let patch_dir = krate.path().abs().join("patches");
+                        create_dir(&patch_dir)?;
+                        let output = Command::new("diff")
+                            .args(["-u", "/dev/null", "LICENSE"])
+                            .current_dir(krate.path().abs())
+                            .output()?;
+                        write(patch_dir.join("LICENSE.patch"), output.stdout)?;
+                        satisfied = true;
+                    }
+                }
+            }
+            if !satisfied {
+                return Err(anyhow!(
+                    "Could not find license files for all licenses. Missing {}",
+                    licenses.unsatisfied.iter().join(", ")
+                ));
+            }
+        }
+
+        // If there's a single applicable license file, symlink it to LICENSE.
+        if licenses.satisfied.len() == 1 && licenses.unsatisfied.is_empty() {
+            let license_file = krate.path().join("LICENSE")?;
+            if !license_file.abs().exists() {
+                symlink(
+                    licenses.satisfied.iter().next().unwrap().1.file_name().unwrap(),
+                    license_file,
+                )?;
+            }
+        }
+
+        update_module_license_files(&krate.path().abs(), &licenses)?;
+
+        println!("  Creating METADATA");
+        let metadata = GoogleMetadata::init(
+            krate.path().join("METADATA")?,
+            krate.name(),
+            krate.version().to_string(),
+            krate.description(),
+            most_restrictive_type(&licenses),
+        )?;
+        metadata.write()?;
+
+        println!("  Creating cargo_embargo.json and Android.bp");
+        if autoconfig {
+            // TODO: Copy to a temp dir, because otherwise we might run cargo and create/modify Cargo.lock.
+            cargo_embargo_autoconfig(&managed_dir)?
+                .success_or_error()
+                .context("Failed to generate cargo_embargo.json with 'cargo_embargo autoconfig'")?;
+        } else {
+            write(krate.path().abs().join("cargo_embargo.json"), "{}")?;
+        }
+        // Workaround. Our logic for crate health assumes the crate isn't healthy if there's
+        // no Android.bp. So create an empty one.
+        write(krate.path().abs().join("Android.bp"), "")?;
+
+        self.regenerate([&crate_name].iter(), true)?;
+        println!("Please edit {} and run 'regenerate' for this crate", managed_dir);
+
+        // TODO: Create TEST_MAPPING
+
+        Ok(())
+    }
+    pub fn regenerate<T: AsRef<str>>(
+        &self,
+        crates: impl Iterator<Item = T>,
+        update_metadata: bool,
+    ) -> Result<()> {
+        let pseudo_crate = self.pseudo_crate().vendor()?;
+        for crate_name in crates {
+            let mc = self.managed_crate_for(crate_name.as_ref())?;
+            // TODO: Don't give up if there's a failure.
+            mc.regenerate(update_metadata, &pseudo_crate)?;
+        }
+
+        pseudo_crate.regenerate_crate_list()?;
+
+        Ok(())
+    }
+    pub fn stage<T: AsRef<str>>(&self, crates: impl Iterator<Item = T>) -> Result<()> {
+        let pseudo_crate = self.pseudo_crate().vendor()?;
+        for crate_name in crates {
+            let mc = self.managed_crate_for(crate_name.as_ref())?.stage(&pseudo_crate)?;
+            // TODO: Don't give up if there's a failure.
+            mc.check_staged()?;
+        }
+        Ok(())
+    }
+    pub fn preupload_check(&self, files: &[String]) -> Result<()> {
+        let pseudo_crate = self.pseudo_crate().vendor()?;
+        let deps = pseudo_crate.deps().keys().cloned().collect::<BTreeSet<_>>();
+
+        let managed_dirs = self.all_crate_names()?;
+
+        if deps != managed_dirs {
+            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match directories in {}\nDirectories not in Cargo.toml: {}\nCargo.toml deps with no directory: {}",
+                self.managed_dir(), managed_dirs.difference(&deps).join(", "), deps.difference(&managed_dirs).join(", ")));
+        }
+
+        let crate_list = pseudo_crate.read_crate_list()?;
+        if deps.iter().ne(crate_list.iter()) {
+            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match deps in crate-list.txt\nCargo.toml: {}\ncrate-list.txt: {}",
+                deps.iter().join(", "), crate_list.iter().join(", ")));
+        }
+
+        // Per https://android.googlesource.com/platform/tools/repohooks/,
+        // the REPO_PATH environment variable is the path of the git repo relative to the
+        // root of the Android source tree.
+        let prefix = self.path.rel().strip_prefix(env::var("REPO_PATH")?)?;
+        let changed_android_crates = files
+            .iter()
+            .filter_map(|file| Path::new(file).strip_prefix(prefix).ok())
+            .filter_map(|path| {
+                let components = path.components().collect::<Vec<_>>();
+                if path.starts_with("crates/") && components.len() > 2 {
+                    Some(components[1].as_os_str().to_string_lossy().to_string())
+                } else {
+                    None
+                }
+            })
+            .collect::<BTreeSet<_>>();
+
+        for crate_name in changed_android_crates {
+            println!("Checking {}", crate_name);
+            let mc = self.managed_crate_for(&crate_name)?.stage(&pseudo_crate)?;
+            mc.diff_staged()?;
+        }
+        Ok(())
+    }
+    pub fn fix_licenses<T: AsRef<str>>(&self, crates: impl Iterator<Item = T>) -> Result<()> {
+        for crate_name in crates {
+            self.managed_crate_for(crate_name.as_ref())?.fix_licenses()?;
+        }
+        Ok(())
+    }
+    pub fn fix_metadata<T: AsRef<str>>(&self, crates: impl Iterator<Item = T>) -> Result<()> {
+        for crate_name in crates {
+            self.managed_crate_for(crate_name.as_ref())?.fix_metadata()?;
+        }
+        Ok(())
+    }
+    pub fn recontextualize_patches<T: AsRef<str>>(
+        &self,
+        crates: impl Iterator<Item = T>,
+    ) -> Result<()> {
+        for crate_name in crates {
+            let mc = self.managed_crate_for(crate_name.as_ref())?;
+            mc.recontextualize_patches()?;
+        }
+        Ok(())
+    }
+    pub fn updatable_crates(&self) -> Result<()> {
+        let mut cc = self.new_cc();
+        cc.add_from(self.managed_dir().rel())?;
+
+        for krate in cc.map_field().values() {
+            let cio_crate = self.crates_io.get_crate(krate.name())?;
+            let upgrades =
+                cio_crate.versions_gt(krate.version()).map(|v| v.version()).collect::<Vec<_>>();
+            if !upgrades.is_empty() {
+                println!(
+                    "{} v{}:\n  {}",
+                    krate.name(),
+                    krate.version(),
+                    upgrades
+                        .iter()
+                        .chunks(10)
+                        .into_iter()
+                        .map(|mut c| { c.join(", ") })
+                        .join(",\n  ")
+                );
+            }
+        }
+        Ok(())
+    }
+    pub fn analyze_updates(&self, crate_name: impl AsRef<str>) -> Result<()> {
+        let mut managed_crates = self.new_cc();
+        managed_crates.add_from(self.managed_dir().rel())?;
+        let legacy_crates = self.legacy_crates()?;
+
+        let krate = self.managed_crate_for(crate_name.as_ref())?;
+        println!("Analyzing updates to {} v{}", krate.name(), krate.android_version());
+        let patches = krate.patches()?;
+        if !patches.is_empty() {
+            println!("This crate has patches, so expect a fun time trying to update it:");
+            for patch in patches {
+                println!(
+                    "  {}",
+                    Path::new(patch.file_name().ok_or(anyhow!("No file name"))?).display()
+                );
+            }
+        }
+
+        let cio_crate = self.crates_io.get_crate(crate_name)?;
+
+        let base_version = cio_crate.get_version(krate.android_version()).ok_or(anyhow!(
+            "{} v{} not found in crates.io",
+            krate.name(),
+            krate.android_version()
+        ))?;
+        let base_deps = base_version.android_version_reqs_by_name();
+
+        let mut newer_versions = cio_crate.versions_gt(krate.android_version()).peekable();
+        if newer_versions.peek().is_none() {
+            println!("There are no newer versions of this crate.");
+        }
+        for version in newer_versions {
+            println!("Version {}", version.version());
+            let mut found_problems = false;
+            let parsed_version = semver::Version::parse(version.version())?;
+            if !krate.android_version().is_upgradable_to(&parsed_version) {
+                found_problems = true;
+                if !krate.android_version().is_upgradable_to_relaxed(&parsed_version) {
+                    println!("  Not semver-compatible, even by relaxed standards");
+                } else {
+                    println!("  Semver-compatible, but only by relaxed standards since major version is 0");
+                }
+            }
+            // Check to see if the update has any missing dependencies.
+            // We try to be a little clever about this in the following ways:
+            // * Only consider deps that are likely to be relevant to Android. For example, ignore Windows-only deps.
+            // * If a dep is missing, but the same dep exists for the current version of the crate, it's probably not actually necessary.
+            // * Use relaxed version requirements, treating 0.x and 0.y as compatible, even though they aren't according to semver rules.
+            for (dep, req) in version.android_deps_with_version_reqs() {
+                let cc = if managed_crates.contains_name(dep.crate_name()) {
+                    &managed_crates
+                } else {
+                    &legacy_crates
+                };
+                if !cc.contains_name(dep.crate_name()) {
+                    found_problems = true;
+                    println!(
+                        "  Dep {} {} has not been imported to Android",
+                        dep.crate_name(),
+                        dep.requirement()
+                    );
+                    if !dep.is_new_dep(&base_deps) {
+                        println!("    But the current version has the same dependency, and it seems to work");
+                    } else {
+                        continue;
+                    }
+                }
+                for (_, dep_crate) in cc.get_versions(dep.crate_name()) {
+                    if !req.matches_relaxed(dep_crate.version()) {
+                        found_problems = true;
+                        println!(
+                            "  Dep {} {} is not satisfied by v{} at {}",
+                            dep.crate_name(),
+                            dep.requirement(),
+                            dep_crate.version(),
+                            dep_crate.path()
+                        );
+                        if !dep.is_changed_dep(&base_deps) {
+                            println!("    But the current version has the same dependency and it seems to work.")
+                        }
+                    }
+                }
+            }
+            if !found_problems {
+                println!("  No problems found with this version.")
+            }
+        }
+
+        Ok(())
+    }
+    pub fn suggest_updates(&self, consider_patched_crates: bool) -> Result<Vec<(String, String)>> {
+        let mut suggestions = Vec::new();
+        let mut managed_crates = self.new_cc();
+        managed_crates.add_from(self.managed_dir().rel())?;
+        let legacy_crates = self.legacy_crates()?;
+
+        for krate in managed_crates.map_field().values() {
+            let cio_crate = self.crates_io.get_crate(krate.name())?;
+
+            let base_version = cio_crate.get_version(krate.version());
+            if base_version.is_none() {
+                println!(
+                    "Skipping crate {} v{} because it was not found in crates.io",
+                    krate.name(),
+                    krate.version()
+                );
+                continue;
+            }
+            let base_version = base_version.unwrap();
+            let base_deps = base_version.android_version_reqs_by_name();
+
+            let patch_dir = krate.path().join("patches").unwrap();
+            if patch_dir.abs().exists() && !consider_patched_crates {
+                println!(
+                    "Skipping crate {} v{} because it has patches",
+                    krate.name(),
+                    krate.version()
+                );
+                continue;
+            }
+
+            for version in cio_crate.versions_gt(krate.version()).rev() {
+                let parsed_version = semver::Version::parse(version.version())?;
+                if !krate.version().is_upgradable_to_relaxed(&parsed_version) {
+                    continue;
+                }
+                if !version.android_deps_with_version_reqs().any(|(dep, req)| {
+                    if !dep.is_changed_dep(&base_deps) {
+                        return false;
+                    }
+                    let cc = if managed_crates.contains_name(dep.crate_name()) {
+                        &managed_crates
+                    } else {
+                        &legacy_crates
+                    };
+                    for (_, dep_crate) in cc.get_versions(dep.crate_name()) {
+                        if req.matches_relaxed(dep_crate.version()) {
+                            return false;
+                        }
+                    }
+                    true
+                }) {
+                    println!(
+                        "Upgrade crate {} v{} to {}",
+                        krate.name(),
+                        krate.version(),
+                        version.version()
+                    );
+                    suggestions.push((krate.name().to_string(), version.version().to_string()));
+                    break;
+                }
+            }
+        }
+        Ok(suggestions)
+    }
+    pub fn update(&self, crate_name: impl AsRef<str>, version: impl AsRef<str>) -> Result<()> {
+        let pseudo_crate = self.pseudo_crate();
+        let version = Version::parse(version.as_ref())?;
+        let nv = NameAndVersionRef::new(crate_name.as_ref(), &version);
+        pseudo_crate.remove(&crate_name)?;
+        pseudo_crate.cargo_add(&nv)?;
+        self.regenerate([&crate_name].iter(), true)?;
+        Ok(())
+    }
+    pub fn try_updates(&self) -> Result<()> {
+        let output = Command::new("git")
+            .args(["status", "--porcelain", "."])
+            .current_dir(&self.path)
+            .output()?
+            .success_or_error()?;
+        if !output.stdout.is_empty() {
+            return Err(anyhow!("Crate repo {} has uncommitted changes", self.path));
+        }
+
+        for (crate_name, version) in self.suggest_updates(true)? {
+            println!("Trying to update {} to {}", crate_name, version);
+            Command::new("git")
+                .args(["restore", "."])
+                .current_dir(&self.path)
+                .output()?
+                .success_or_error()?;
+            Command::new("git")
+                .args(["clean", "-f", "."])
+                .current_dir(&self.path)
+                .output()?
+                .success_or_error()?;
+            if let Err(e) = self.update(&crate_name, &version) {
+                println!("Updating {} to {} failed: {}", crate_name, version, e);
+                continue;
+            }
+            let build_result = Command::new("/usr/bin/bash")
+                .args(["-c", "source build/envsetup.sh && lunch aosp_husky-trunk_staging-eng && cd external/rust && mm"])
+                .env_remove("OUT_DIR")
+                .current_dir(self.path.root())
+                .spawn().context("Failed to spawn mm")?
+                .wait().context("Failed to wait on mm")?
+                .success_or_error();
+            if let Err(e) = build_result {
+                println!("Faild to build {} {}: {}", crate_name, version, e);
+                continue;
+            }
+            println!("Update {} to {} succeeded", crate_name, version);
+        }
+        Ok(())
+    }
+    pub fn init(&self) -> Result<()> {
+        if self.path.abs().exists() {
+            return Err(anyhow!("{} already exists", self.path));
+        }
+        create_dir_all(&self.path).context(format!("Failed to create {}", self.path))?;
+        let crates_dir = self.path.join("crates")?;
+        create_dir_all(&crates_dir).context(format!("Failed to create {}", crates_dir))?;
+        self.pseudo_crate().init()?;
+        Ok(())
+    }
+    pub fn fix_test_mapping<T: AsRef<str>>(&self, crates: impl Iterator<Item = T>) -> Result<()> {
+        for crate_name in crates {
+            let mc = self.managed_crate_for(crate_name.as_ref())?;
+            mc.fix_test_mapping()?;
+        }
+        Ok(())
+    }
+}
+
+// Files that are ignored when migrating a crate to the monorepo.
+static IGNORED_FILES: &[&str] = &[
+    ".appveyor.yml",
+    ".bazelci",
+    ".bazelignore",
+    ".bazelrc",
+    ".bazelversion",
+    ".buildkite",
+    ".cargo",
+    ".cargo-checksum.json",
+    ".cargo_vcs_info.json",
+    ".circleci",
+    ".cirrus.yml",
+    ".clang-format",
+    ".clang-tidy",
+    ".clippy.toml",
+    ".clog.toml",
+    ".clog.toml",
+    ".codecov.yaml",
+    ".codecov.yml",
+    ".editorconfig",
+    ".envrc",
+    ".gcloudignore",
+    ".gdbinit",
+    ".git",
+    ".git-blame-ignore-revs",
+    ".git-ignore-revs",
+    ".gitallowed",
+    ".gitattributes",
+    ".github",
+    ".gitignore",
+    ".idea",
+    ".ignore",
+    ".istanbul.yml",
+    ".mailmap",
+    ".md-inc.toml",
+    ".mdl-style.rb",
+    ".mdlrc",
+    ".pylintrc",
+    ".pylintrc-examples",
+    ".pylintrc-tests",
+    ".reuse",
+    ".rspec",
+    ".rustfmt.toml",
+    ".shellcheckrc",
+    ".standard-version",
+    ".tarpaulin.toml",
+    ".tokeignore",
+    ".travis.yml",
+    ".versionrc",
+    ".vim",
+    ".vscode",
+    ".yapfignore",
+    ".yardopts",
+    "BUILD",
+    "Cargo.lock",
+    "Cargo.lock.saved",
+    "Cargo.toml.orig",
+    "OWNERS",
+    // Deprecated config file for rules.mk.
+    "cargo2rulesmk.json",
+    // cargo_embargo intermediates.
+    "Android.bp.orig",
+    "cargo.metadata",
+    "cargo.out",
+    "target.tmp",
+];
diff --git a/tools/external_crates/crate_tool/src/patch.rs b/tools/external_crates/crate_tool/src/patch.rs
new file mode 100644
index 000000000..4db754e36
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/patch.rs
@@ -0,0 +1,86 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+/// A parser to extract the header and footer for patch files we are going
+/// to recontextualize.
+
+pub struct Patch<'a> {
+    // The header of the patch, not including the diff stats and the immediately preceding "---", if present.
+    pub header: &'a str,
+    pub footer: &'a str,
+}
+
+impl<'a> Patch<'a> {
+    pub fn parse(contents: &'a str) -> Self {
+        // The format for patch files is not formally specified, and the GNU patch
+        // program is very forgiving about what it accepts. "git apply" is much
+        // less forgiving.
+        //
+        // Empirically, our patch files consist of:
+        // * An optional header, which we want to preserve if present.
+        // * Some optional diff stats, separated from the header by "---", which want
+        //   to replace with new stats by running "git diff -p --stat"
+        // * Unified diffs for one or more files, which we are going to replace.
+        //   If generated by git, the diffs will begin with "diff --git", but this may not be present.
+        // * An optional footer, starting with "-- ", if the patch was generated by
+        //   "git format-patch", which we want to preserve if present.
+        let (header_and_stat, remainder) = contents.split_once("diff --git").unwrap_or(("", ""));
+        if header_and_stat.trim().is_empty() {
+            Patch { header: "", footer: "" }
+        } else {
+            let header = match header_and_stat.rfind("\n---\n") {
+                Some(stat_sep) => &header_and_stat[..stat_sep],
+                None => header_and_stat,
+            };
+            let footer = match remainder.rfind("-- \n") {
+                Some(footer_sep) => &remainder[footer_sep..],
+                None => "",
+            };
+            Patch { header, footer }
+        }
+    }
+    /// Generate a new diff file from the output of "git diff -p --stat".
+    pub fn reassemble(&self, new_diff: &[u8]) -> Vec<u8> {
+        [self.header.as_bytes(), b"\n---\n", new_diff, self.footer.as_bytes()].concat()
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn test_ahash() {
+        let contents = include_str!("testdata/ahash.patch");
+        let parsed = Patch::parse(contents);
+        assert_eq!(parsed.header, include_str!("testdata/ahash.header"));
+        assert_eq!(parsed.footer, include_str!("testdata/ahash.footer"));
+    }
+
+    #[test]
+    fn test_mls_rs_core() {
+        let contents = include_str!("testdata/mls_rs_core.patch");
+        let parsed = Patch::parse(contents);
+        assert_eq!(parsed.header, include_str!("testdata/mls_rs_core.header"));
+        assert!(parsed.footer.is_empty());
+    }
+
+    #[test]
+    fn test_crossbeam_utils() {
+        let contents = include_str!("testdata/crossbeam-utils.patch");
+        let parsed = Patch::parse(contents);
+        assert!(parsed.header.is_empty());
+        assert!(parsed.footer.is_empty());
+    }
+}
diff --git a/tools/external_crates/crate_tool/src/pseudo_crate.rs b/tools/external_crates/crate_tool/src/pseudo_crate.rs
new file mode 100644
index 000000000..485b3cab6
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/pseudo_crate.rs
@@ -0,0 +1,218 @@
+// Copyright (C) 2023 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    cell::OnceCell,
+    collections::BTreeMap,
+    fs::{read, write},
+    io::BufRead,
+    process::Command,
+    str::from_utf8,
+};
+
+use anyhow::{anyhow, Context, Result};
+use itertools::Itertools;
+use name_and_version::{NameAndVersionMap, NamedAndVersioned};
+use rooted_path::RootedPath;
+use semver::Version;
+
+use crate::{crate_collection::CrateCollection, ensure_exists_and_empty, RunQuiet};
+
+pub struct PseudoCrate<State: PseudoCrateState> {
+    path: RootedPath,
+    extra: State,
+}
+
+#[derive(Debug)]
+pub struct CargoVendorClean {
+    crates: OnceCell<CrateCollection>,
+    deps: OnceCell<BTreeMap<String, Version>>,
+}
+#[derive(Debug)]
+pub struct CargoVendorDirty {}
+
+pub trait PseudoCrateState {}
+impl PseudoCrateState for CargoVendorDirty {}
+impl PseudoCrateState for CargoVendorClean {}
+
+impl<State: PseudoCrateState> PseudoCrate<State> {
+    pub fn get_path(&self) -> &RootedPath {
+        &self.path
+    }
+    pub fn read_crate_list(&self) -> Result<Vec<String>> {
+        let mut lines = Vec::new();
+        for line in read(self.path.join("crate-list.txt")?)?.lines() {
+            lines.push(line?);
+        }
+        Ok(lines)
+    }
+}
+
+impl PseudoCrate<CargoVendorClean> {
+    pub fn regenerate_crate_list(&self) -> Result<()> {
+        write(self.path.join("crate-list.txt")?, format!("{}\n", self.deps().keys().join("\n")))?;
+        Ok(())
+    }
+    fn version_of(&self, crate_name: &str) -> Result<Version> {
+        self.deps()
+            .get(crate_name)
+            .cloned()
+            .ok_or(anyhow!("Crate {} not found in Cargo.toml", crate_name))
+    }
+    pub fn deps(&self) -> &BTreeMap<String, Version> {
+        self.extra.deps.get_or_init(|| {
+            let output = Command::new("cargo")
+                .args(["tree", "--depth=1", "--prefix=none"])
+                .current_dir(&self.path)
+                .run_quiet_and_expect_success()
+                .unwrap();
+            let mut deps = BTreeMap::new();
+            for line in from_utf8(&output.stdout).unwrap().lines().skip(1) {
+                let words = line.split(' ').collect::<Vec<_>>();
+                if words.len() < 2 {
+                    panic!("Failed to parse crate name and version from cargo tree: {}", line);
+                }
+                let version = words[1]
+                    .strip_prefix('v')
+                    .ok_or(anyhow!("Failed to parse version: {}", words[1]))
+                    .unwrap();
+                deps.insert(words[0].to_string(), Version::parse(version).unwrap());
+            }
+            deps
+        })
+    }
+    pub fn vendored_dir_for(&self, crate_name: &str) -> Result<&RootedPath> {
+        let version = self.version_of(crate_name)?;
+        for (nv, krate) in self.crates().get_versions(crate_name) {
+            if *nv.version() == version {
+                return Ok(krate.path());
+            }
+        }
+        Err(anyhow!("Couldn't find vendored directory for {} v{}", crate_name, version.to_string()))
+    }
+    fn crates(&self) -> &CrateCollection {
+        self.extra.crates.get_or_init(|| {
+            Command::new("cargo")
+                .args(["vendor", "--versioned-dirs"])
+                .current_dir(&self.path)
+                .run_quiet_and_expect_success()
+                .unwrap();
+            let mut crates = CrateCollection::new(self.path.root());
+            crates.add_from(self.get_path().join("vendor").unwrap()).unwrap();
+            crates
+        })
+    }
+    fn mark_dirty(self) -> PseudoCrate<CargoVendorDirty> {
+        PseudoCrate { path: self.path, extra: CargoVendorDirty {} }
+    }
+    #[allow(dead_code)]
+    pub fn cargo_add(
+        self,
+        krate: &impl NamedAndVersioned,
+    ) -> Result<PseudoCrate<CargoVendorDirty>> {
+        let dirty = self.mark_dirty();
+        dirty.cargo_add(krate)?;
+        Ok(dirty)
+    }
+    #[allow(dead_code)]
+    pub fn cargo_add_unpinned(
+        self,
+        krate: &impl NamedAndVersioned,
+    ) -> Result<PseudoCrate<CargoVendorDirty>> {
+        let dirty: PseudoCrate<CargoVendorDirty> = self.mark_dirty();
+        dirty.cargo_add_unpinned(krate)?;
+        Ok(dirty)
+    }
+    #[allow(dead_code)]
+    pub fn cargo_add_unversioned(self, crate_name: &str) -> Result<PseudoCrate<CargoVendorDirty>> {
+        let dirty: PseudoCrate<CargoVendorDirty> = self.mark_dirty();
+        dirty.cargo_add_unversioned(crate_name)?;
+        Ok(dirty)
+    }
+    pub fn remove(self, crate_name: &str) -> Result<PseudoCrate<CargoVendorDirty>> {
+        let dirty: PseudoCrate<CargoVendorDirty> = self.mark_dirty();
+        dirty.remove(crate_name)?;
+        Ok(dirty)
+    }
+}
+
+impl PseudoCrate<CargoVendorDirty> {
+    pub fn new(path: RootedPath) -> Self {
+        PseudoCrate { path, extra: CargoVendorDirty {} }
+    }
+    pub fn init(&self) -> Result<()> {
+        if self.path.abs().exists() {
+            return Err(anyhow!("Can't init pseudo-crate because {} already exists", self.path));
+        }
+        ensure_exists_and_empty(&self.path)?;
+
+        write(
+            self.path.join("Cargo.toml")?,
+            r#"[package]
+name = "android-pseudo-crate"
+version = "0.1.0"
+edition = "2021"
+publish = false
+license = "Apache-2.0"
+
+[dependencies]
+"#,
+        )?;
+        write(self.path.join("crate-list.txt")?, "")?;
+        write(self.path.join(".gitignore")?, "target/\nvendor/\n")?;
+
+        ensure_exists_and_empty(&self.path.join("src")?)?;
+        write(self.path.join("src/lib.rs")?, "// Nothing")
+            .context("Failed to create src/lib.rs")?;
+
+        Ok(())
+    }
+    fn add_internal(&self, crate_and_version_str: &str, crate_name: &str) -> Result<()> {
+        if let Err(e) = Command::new("cargo")
+            .args(["add", crate_and_version_str])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()
+        {
+            self.remove(crate_name).with_context(|| {
+                format!("Failed to remove {} after failing to add it: {}", crate_name, e)
+            })?;
+            return Err(e);
+        }
+        Ok(())
+    }
+    pub fn cargo_add(&self, krate: &impl NamedAndVersioned) -> Result<()> {
+        self.add_internal(format!("{}@={}", krate.name(), krate.version()).as_str(), krate.name())
+    }
+    pub fn cargo_add_unpinned(&self, krate: &impl NamedAndVersioned) -> Result<()> {
+        self.add_internal(format!("{}@{}", krate.name(), krate.version()).as_str(), krate.name())
+    }
+    pub fn cargo_add_unversioned(&self, crate_name: &str) -> Result<()> {
+        self.add_internal(crate_name, crate_name)
+    }
+    pub fn remove(&self, crate_name: impl AsRef<str>) -> Result<()> {
+        Command::new("cargo")
+            .args(["remove", crate_name.as_ref()])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()?;
+        Ok(())
+    }
+    // Mark the crate clean. Ironically, we don't actually need to run "cargo vendor"
+    // immediately thanks to LazyCell.
+    pub fn vendor(self) -> Result<PseudoCrate<CargoVendorClean>> {
+        Ok(PseudoCrate {
+            path: self.path,
+            extra: CargoVendorClean { crates: OnceCell::new(), deps: OnceCell::new() },
+        })
+    }
+}
diff --git a/tools/external_crates/crate_tool/src/testdata/ahash.footer b/tools/external_crates/crate_tool/src/testdata/ahash.footer
new file mode 100644
index 000000000..f7ce14005
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/ahash.footer
@@ -0,0 +1,3 @@
+-- 
+2.38.1.584.g0f3c55d4c2-goog
+
diff --git a/tools/external_crates/crate_tool/src/testdata/ahash.header b/tools/external_crates/crate_tool/src/testdata/ahash.header
new file mode 100644
index 000000000..0ef928287
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/ahash.header
@@ -0,0 +1,17 @@
+From fff15380539c659ccdb03fcc192eb95578b1feb5 Mon Sep 17 00:00:00 2001
+From: Jeff Vander Stoep <jeffv@google.com>
+Date: Thu, 1 Dec 2022 11:29:41 +0100
+Subject: [PATCH] Use /dev/urandom instead of getrandom()
+
+To generate the ahash crate's default hash keys, use /dev/urandom
+instead of getrandom() to avoid blocking boot on systems where the
+entropy pool isn't initialized in time and where the use case of this
+crate doesn't actually require cryptographic randomness.
+
+If opening or reading from /dev/urandom fails, fall back to getrandom().
+
+Note that std::collections::HashMap doesn't block for randomness either,
+for the same reason.  So this change just makes ahash work like HashMap.
+
+Bug: 185934601
+Change-Id: Ieaf4bcfde5664d0b5d845234d0c2139d89c4153c
\ No newline at end of file
diff --git a/tools/external_crates/crate_tool/src/testdata/ahash.patch b/tools/external_crates/crate_tool/src/testdata/ahash.patch
new file mode 100644
index 000000000..a46f1b768
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/ahash.patch
@@ -0,0 +1,55 @@
+From fff15380539c659ccdb03fcc192eb95578b1feb5 Mon Sep 17 00:00:00 2001
+From: Jeff Vander Stoep <jeffv@google.com>
+Date: Thu, 1 Dec 2022 11:29:41 +0100
+Subject: [PATCH] Use /dev/urandom instead of getrandom()
+
+To generate the ahash crate's default hash keys, use /dev/urandom
+instead of getrandom() to avoid blocking boot on systems where the
+entropy pool isn't initialized in time and where the use case of this
+crate doesn't actually require cryptographic randomness.
+
+If opening or reading from /dev/urandom fails, fall back to getrandom().
+
+Note that std::collections::HashMap doesn't block for randomness either,
+for the same reason.  So this change just makes ahash work like HashMap.
+
+Bug: 185934601
+Change-Id: Ieaf4bcfde5664d0b5d845234d0c2139d89c4153c
+---
+ src/random_state.rs | 13 ++++++++++++-
+ 1 file changed, 12 insertions(+), 1 deletion(-)
+
+diff --git a/src/random_state.rs b/src/random_state.rs
+index e885fa4..5b85726 100644
+--- a/src/random_state.rs
++++ b/src/random_state.rs
+@@ -48,6 +48,15 @@ pub(crate) const PI2: [u64; 4] = [
+     0x3f84_d5b5_b547_0917,
+ ];
+ 
++#[cfg(all(feature = "runtime-rng", not(all(feature = "compile-time-rng", test))))]
++fn read_urandom(dest: &mut [u8]) -> Result<(), std::io::Error> {
++    use std::fs::File;
++    use std::io::Read;
++
++    let mut f = File::open("/dev/urandom")?;
++    f.read_exact(dest)
++}
++
+ cfg_if::cfg_if! {
+     if #[cfg(all(feature = "compile-time-rng", any(test, fuzzing)))] {
+         #[inline]
+@@ -78,7 +87,9 @@ cfg_if::cfg_if! {
+ 
+             SEEDS.get_or_init(|| {
+                 let mut result: [u8; 64] = [0; 64];
+-                getrandom::getrandom(&mut result).expect("getrandom::getrandom() failed.");
++                if read_urandom(&mut result).is_err() {
++                    getrandom::getrandom(&mut result).expect("getrandom::getrandom() failed.");
++                }
+                 Box::new(result.convert())
+             })
+         }
+-- 
+2.38.1.584.g0f3c55d4c2-goog
+
diff --git a/tools/external_crates/crate_tool/src/testdata/crossbeam-utils.patch b/tools/external_crates/crate_tool/src/testdata/crossbeam-utils.patch
new file mode 100644
index 000000000..3306735da
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/crossbeam-utils.patch
@@ -0,0 +1,103 @@
+--- a/tests/sharded_lock.rs
++++ b/tests/sharded_lock.rs
+@@ -46,6 +46,8 @@ fn frob() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn arc_poison_wr() {
+     let arc = Arc::new(ShardedLock::new(1));
+     let arc2 = arc.clone();
+@@ -58,6 +60,8 @@ fn arc_poison_wr() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn arc_poison_ww() {
+     let arc = Arc::new(ShardedLock::new(1));
+     assert!(!arc.is_poisoned());
+@@ -72,6 +76,8 @@ fn arc_poison_ww() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn arc_no_poison_rr() {
+     let arc = Arc::new(ShardedLock::new(1));
+     let arc2 = arc.clone();
+@@ -84,6 +90,8 @@ fn arc_no_poison_rr() {
+     assert_eq!(*lock, 1);
+ }
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn arc_no_poison_sl() {
+     let arc = Arc::new(ShardedLock::new(1));
+     let arc2 = arc.clone();
+@@ -135,6 +143,8 @@ fn arc() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn arc_access_in_unwind() {
+     let arc = Arc::new(ShardedLock::new(1));
+     let arc2 = arc.clone();
+@@ -211,6 +221,8 @@ fn test_into_inner_drop() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn test_into_inner_poison() {
+     let m = Arc::new(ShardedLock::new(NonCopy(10)));
+     let m2 = m.clone();
+@@ -235,6 +247,8 @@ fn test_get_mut() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn test_get_mut_poison() {
+     let m = Arc::new(ShardedLock::new(NonCopy(10)));
+     let m2 = m.clone();
+--- a/tests/thread.rs
++++ b/tests/thread.rs
+@@ -9,6 +9,8 @@ const THREADS: usize = 10;
+ const SMALL_STACK_SIZE: usize = 20;
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn join() {
+     let counter = AtomicUsize::new(0);
+     thread::scope(|scope| {
+@@ -64,6 +66,8 @@ fn counter_builder() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn counter_panic() {
+     let counter = AtomicUsize::new(0);
+     let result = thread::scope(|scope| {
+@@ -84,6 +88,8 @@ fn counter_panic() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn panic_twice() {
+     let result = thread::scope(|scope| {
+         scope.spawn(|_| {
+@@ -108,6 +114,8 @@ fn panic_twice() {
+ }
+ 
+ #[test]
++// Android aborts on panic and this test relies on stack unwinding.
++#[cfg(not(target_os = "android"))]
+ fn panic_many() {
+     let result = thread::scope(|scope| {
+         scope.spawn(|_| panic!("deliberate panic #1"));
diff --git a/tools/external_crates/crate_tool/src/testdata/mls_rs_core.header b/tools/external_crates/crate_tool/src/testdata/mls_rs_core.header
new file mode 100644
index 000000000..8886dfd54
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/mls_rs_core.header
@@ -0,0 +1,7 @@
+Add license files not present in the downloaded crates
+
+The Apache-2.0 and MIT licenses found here are from:
+
+https://github.com/awslabs/mls-rs/blob/main/LICENSE-apache
+https://github.com/awslabs/mls-rs/blob/main/LICENSE-mit
+
diff --git a/tools/external_crates/crate_tool/src/testdata/mls_rs_core.patch b/tools/external_crates/crate_tool/src/testdata/mls_rs_core.patch
new file mode 100644
index 000000000..90dedde26
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/testdata/mls_rs_core.patch
@@ -0,0 +1,204 @@
+Add license files not present in the downloaded crates
+
+The Apache-2.0 and MIT licenses found here are from:
+
+https://github.com/awslabs/mls-rs/blob/main/LICENSE-apache
+https://github.com/awslabs/mls-rs/blob/main/LICENSE-mit
+
+diff --git a/LICENSE-apache b/LICENSE-apache
+new file mode 100644
+index 0000000..831fbc5
+--- /dev/null
++++ b/LICENSE-apache
+@@ -0,0 +1,176 @@
++                                 Apache License
++                           Version 2.0, January 2004
++                        http://www.apache.org/licenses/
++
++   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
++
++   1. Definitions.
++
++      "License" shall mean the terms and conditions for use, reproduction,
++      and distribution as defined by Sections 1 through 9 of this document.
++
++      "Licensor" shall mean the copyright owner or entity authorized by
++      the copyright owner that is granting the License.
++
++      "Legal Entity" shall mean the union of the acting entity and all
++      other entities that control, are controlled by, or are under common
++      control with that entity. For the purposes of this definition,
++      "control" means (i) the power, direct or indirect, to cause the
++      direction or management of such entity, whether by contract or
++      otherwise, or (ii) ownership of fifty percent (50%) or more of the
++      outstanding shares, or (iii) beneficial ownership of such entity.
++
++      "You" (or "Your") shall mean an individual or Legal Entity
++      exercising permissions granted by this License.
++
++      "Source" form shall mean the preferred form for making modifications,
++      including but not limited to software source code, documentation
++      source, and configuration files.
++
++      "Object" form shall mean any form resulting from mechanical
++      transformation or translation of a Source form, including but
++      not limited to compiled object code, generated documentation,
++      and conversions to other media types.
++
++      "Work" shall mean the work of authorship, whether in Source or
++      Object form, made available under the License, as indicated by a
++      copyright notice that is included in or attached to the work
++      (an example is provided in the Appendix below).
++
++      "Derivative Works" shall mean any work, whether in Source or Object
++      form, that is based on (or derived from) the Work and for which the
++      editorial revisions, annotations, elaborations, orother modifications
++      represent, as a whole, an original work of authorship. For the purposes
++      of this License, Derivative Works shall not include works that remain
++      separable from, or merely link (or bind by name) to the interfaces of,
++      the Work and Derivative Works thereof.
++
++      "Contribution" shall mean any work of authorship, including
++      the original version of the Work and any modifications or additions
++      to that Work or Derivative Works thereof, that is intentionally
++      submitted to Licensor for inclusion in the Work by the copyright owner
++      or by an individual or Legal Entity authorized to submit on behalf of
++      the copyright owner. For the purposes of this definition, "submitted"
++      means any form of electronic, verbal, or written communication sent
++      to the Licensor or its representatives, including but not limited to
++      communication on electronic mailing lists, source code control systems,
++      and issue tracking systems that are managed by, or on behalf of, the
++      Licensor for the purpose of discussing and improving the Work, but
++      excluding communication that is conspicuously marked or otherwise
++      designated in writing by the copyright owner as "Not a Contribution."
++
++      "Contributor" shall mean Licensor and any individual or Legal Entity
++      on behalf of whom a Contribution has been received by Licensor and
++      subsequently incorporated within the Work.
++
++   2. Grant of Copyright License. Subject to the terms and conditions of
++      this License, each Contributor hereby grants to You a perpetual,
++      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
++      copyright license to reproduce, prepare Derivative Works of,
++      publicly display, publicly perform, sublicense, and distribute the
++      Work and such Derivative Works in Source or Object form.
++
++   3. Grant of Patent License. Subject to the terms and conditions of
++      this License, each Contributor hereby grants to You a perpetual,
++      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
++      (except as stated in this section) patent license to make, have made,
++      use, offer to sell, sell, import, and otherwise transfer the Work,
++      where such license applies only to those patent claims licensable
++      by such Contributor that are necessarily infringed by their
++      Contribution(s) alone or by combination of their Contribution(s)
++      with the Work to which such Contribution(s) was submitted. If You
++      institute patent litigation against any entity (including a
++      cross-claim or counterclaim in a lawsuit) alleging that the Work
++      or a Contribution incorporated within the Work constitutes direct
++      or contributory patent infringement, then any patent licenses
++      granted to You under this License for that Work shall terminate
++      as of the date such litigation is filed.
++
++   4. Redistribution. You may reproduce and distribute copies of the
++      Work or Derivative Works thereof in any medium, with or without
++      modifications, and in Source or Object form, provided that You
++      meet the following conditions:
++
++      (a) You must give any other recipients of the Work or
++          Derivative Works a copy of this License; and
++
++      (b) You must cause any modified files to carry prominent notices
++          stating that You changed the files; and
++
++      (c) You must retain, in the Source form of any Derivative Works
++          that You distribute, all copyright, patent, trademark, and
++          attribution notices from the Source form of the Work,
++          excluding those notices that do not pertain to any part of
++          the Derivative Works; and
++
++      (d) If the Work includes a "NOTICE" text file as part of its
++          distribution, then any Derivative Works that You distribute must
++          include a readable copy of the attribution notices contained
++          within such NOTICE file, excluding those notices that do not
++          pertain to any part of the Derivative Works, in at least one
++          of the following places: within a NOTICE text file distributed
++          as part of the Derivative Works; within the Source form or
++          documentation, if provided along with the Derivative Works; or,
++          within a display generated by the Derivative Works, if and
++          wherever such third-party notices normally appear. The contents
++          of the NOTICE file are for informational purposes only and
++          do not modify the License. You may add Your own attribution
++          notices within Derivative Works that You distribute, alongside
++          or as an addendum to the NOTICE text from the Work, provided
++          that such additional attribution notices cannot be construed
++          as modifying the License.
++
++      You may add Your own copyright statement to Your modifications and
++      may provide additional or different license terms and conditions
++      for use, reproduction, or distribution of Your modifications, or
++      for any such Derivative Works as a whole, provided Your use,
++      reproduction, and distribution of the Work otherwise complies with
++      the conditions stated in this License.
++
++   5. Submission of Contributions. Unless You explicitly state otherwise,
++      any Contribution intentionally submitted for inclusion in the Work
++      by You to the Licensor shall be under the terms and conditions of
++      this License, without any additional terms or conditions.
++      Notwithstanding the above, nothing herein shall supersede or modify
++      the terms of any separate license agreement you may have executed
++      with Licensor regarding such Contributions.
++
++   6. Trademarks. This License does not grant permission to use the trade
++      names, trademarks, service marks, or product names of the Licensor,
++      except as required for reasonable and customary use in describing the
++      origin of the Work and reproducing the content of the NOTICE file.
++
++   7. Disclaimer of Warranty. Unless required by applicable law or
++      agreed to in writing, Licensor provides the Work (and each
++      Contributor provides its Contributions) on an "AS IS" BASIS,
++      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
++      implied, including, without limitation, any warranties or conditions
++      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
++      PARTICULAR PURPOSE. You are solely responsible for determining the
++      appropriateness of using or redistributing the Work and assume any
++      risks associated with Your exercise of permissions under this License.
++
++   8. Limitation of Liability. In no event and under no legal theory,
++      whether in tort (including negligence), contract, or otherwise,
++      unless required by applicable law (such as deliberate and grossly
++      negligent acts) or agreed to in writing, shall any Contributor be
++      liable to You for damages, including any direct, indirect, special,
++      incidental, or consequential damages of any character arising as a
++      result of this License or out of the use or inability to use the
++      Work (including but not limited to damages for loss of goodwill,
++      work stoppage, computer failure or malfunction, or any and all
++      other commercial damages or losses), even if such Contributor
++      has been advised of the possibility of such damages.
++
++   9. Accepting Warranty or Additional Liability. While redistributing
++      the Work or Derivative Works thereof, You may choose to offer,
++      and charge a fee for, acceptance of support, warranty, indemnity,
++      or other liability obligations and/or rights consistent with this
++      License. However, in accepting such obligations, You may act only
++      on Your own behalf and on Your sole responsibility, not on behalf
++      of any other Contributor, and only if You agree to indemnify,
++      defend, and hold each Contributor harmless for any liability
++      incurred by, or claims asserted against, such Contributor by reason
++      of your accepting any such warranty or additional liability.
++
++   END OF TERMS AND CONDITIONS
+diff --git a/LICENSE-mit b/LICENSE-mit
+new file mode 100644
+index 0000000..e547c4a
+--- /dev/null
++++ b/LICENSE-mit
+@@ -0,0 +1,9 @@
++MIT License
++
++Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
++
++Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including  without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to  the following conditions:
++
++The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
++
++THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN  NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE  SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
diff --git a/tools/external_crates/crate_tool/src/upgradable.rs b/tools/external_crates/crate_tool/src/upgradable.rs
new file mode 100644
index 000000000..1cf441c9f
--- /dev/null
+++ b/tools/external_crates/crate_tool/src/upgradable.rs
@@ -0,0 +1,110 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use semver::{Version, VersionReq};
+
+/// A trait for determining semver compatibility.
+pub trait IsUpgradableTo {
+    /// Returns true if the object version is semver-compatible with 'other'.
+    fn is_upgradable_to(&self, other: &Version) -> bool;
+    /// Returns true if the object version is semver-compatible with 'other', or if
+    /// both have a major version of 0 and the other version is greater.
+    fn is_upgradable_to_relaxed(&self, other: &Version) -> bool;
+}
+
+impl IsUpgradableTo for semver::Version {
+    fn is_upgradable_to(&self, other: &Version) -> bool {
+        VersionReq::parse(&self.to_string()).is_ok_and(|req| req.matches(other))
+    }
+    fn is_upgradable_to_relaxed(&self, other: &Version) -> bool {
+        VersionReq::parse(&self.to_string()).is_ok_and(|req| req.matches_relaxed(other))
+    }
+}
+
+/// A trait for relaxed semver compatibility. Major versions of 0 are treated as if they were non-zero.
+pub trait MatchesRelaxed {
+    /// Returns true if the version matches the req, but treats
+    /// major version of zero as if it were non-zero.
+    fn matches_relaxed(&self, version: &Version) -> bool;
+}
+impl MatchesRelaxed for VersionReq {
+    fn matches_relaxed(&self, version: &Version) -> bool {
+        if self.matches(version) {
+            return true;
+        }
+        if self.comparators.len() == 1 && self.comparators[0].major == 0 && version.major == 0 {
+            let mut fake_v = version.clone();
+            fake_v.major = 1;
+            let mut fake_req = self.clone();
+            fake_req.comparators[0].major = 1;
+            return fake_req.matches(&fake_v);
+        }
+        false
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    use anyhow::Result;
+
+    #[test]
+    fn test_is_upgradable() -> Result<()> {
+        let version = Version::parse("2.3.4")?;
+        let patch = Version::parse("2.3.5")?;
+        let minor = Version::parse("2.4.0")?;
+        let major = Version::parse("3.0.0")?;
+        let older = Version::parse("2.3.3")?;
+
+        // All have same behavior for is_upgradable_to_relaxed
+        assert!(version.is_upgradable_to(&patch), "Patch update");
+        assert!(version.is_upgradable_to_relaxed(&patch), "Patch update");
+
+        assert!(version.is_upgradable_to(&minor), "Minor version update");
+        assert!(version.is_upgradable_to_relaxed(&minor), "Minor version update");
+
+        assert!(!version.is_upgradable_to(&major), "Incompatible (major version) update");
+        assert!(!version.is_upgradable_to_relaxed(&major), "Incompatible (major version) update");
+
+        assert!(!version.is_upgradable_to(&older), "Downgrade");
+        assert!(!version.is_upgradable_to_relaxed(&older), "Downgrade");
+
+        Ok(())
+    }
+
+    #[test]
+    fn test_is_upgradable_major_zero() -> Result<()> {
+        let version = Version::parse("0.3.4")?;
+        let patch = Version::parse("0.3.5")?;
+        let minor = Version::parse("0.4.0")?;
+        let major = Version::parse("1.0.0")?;
+        let older = Version::parse("0.3.3")?;
+
+        assert!(version.is_upgradable_to(&patch), "Patch update");
+        assert!(version.is_upgradable_to_relaxed(&patch), "Patch update");
+
+        // Different behavior for minor version changes.
+        assert!(!version.is_upgradable_to(&minor), "Minor version update");
+        assert!(version.is_upgradable_to_relaxed(&minor), "Minor version update");
+
+        assert!(!version.is_upgradable_to(&major), "Incompatible (major version) update");
+        assert!(!version.is_upgradable_to_relaxed(&major), "Incompatible (major version) update");
+
+        assert!(!version.is_upgradable_to(&older), "Downgrade");
+        assert!(!version.is_upgradable_to_relaxed(&older), "Downgrade");
+
+        Ok(())
+    }
+}
diff --git a/tools/external_crates/google_metadata/src/lib.rs b/tools/external_crates/google_metadata/src/lib.rs
index 8c42806ba..6f2adce01 100644
--- a/tools/external_crates/google_metadata/src/lib.rs
+++ b/tools/external_crates/google_metadata/src/lib.rs
@@ -83,11 +83,11 @@ impl GoogleMetadata {
         let mut metadata = GoogleMetadata { path, metadata: MetaData::new() };
         let name = name.into();
         metadata.set_date_to_today()?;
+        metadata.metadata.set_name(name.clone());
         metadata.set_version_and_urls(&name, version)?;
         let third_party = metadata.metadata.third_party.mut_or_insert_default();
         third_party.set_homepage(crates_io_homepage(&name));
         third_party.set_license_type(license_type);
-        metadata.metadata.set_name(name);
         metadata.metadata.set_description(desc.into());
         Ok(metadata)
     }
diff --git a/tools/external_crates/license_checker/src/content_checker.rs b/tools/external_crates/license_checker/src/content_checker.rs
index 5dad7be7f..7fedd4556 100644
--- a/tools/external_crates/license_checker/src/content_checker.rs
+++ b/tools/external_crates/license_checker/src/content_checker.rs
@@ -71,6 +71,7 @@ static LICENSE_CONTENT_CLASSIFICATION: LazyLock<Vec<(LicenseReq, String)>> = Laz
         ("BSD-2-Clause", include_str!("licenses/BSD-2-Clause.txt")),
         ("BSD-3-Clause", include_str!("licenses/BSD-3-Clause.txt")),
         ("Unlicense", include_str!("licenses/Unlicense.txt")),
+        ("Zlib", include_str!("licenses/Zlib.txt")),
     ]
     .into_iter()
     .map(|(req, tokens)| {
diff --git a/tools/external_crates/license_checker/src/licenses/Zlib.txt b/tools/external_crates/license_checker/src/licenses/Zlib.txt
new file mode 100644
index 000000000..0c58b38f2
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/Zlib.txt
@@ -0,0 +1,17 @@
+This software is provided 'as-is', without any express or implied warranty. In
+no event will the authors be held liable for any damages arising from the use of
+this software.
+
+Permission is granted to anyone to use this software for any purpose, including
+commercial applications, and to alter it and redistribute it freely, subject to
+the following restrictions:
+
+1. The origin of this software must not be misrepresented; you must not claim
+   that you wrote the original software. If you use this software in a product,
+   an acknowledgment in the product documentation would be appreciated but is
+   not required.
+
+2. Altered source versions must be plainly marked as such, and must not be
+   misrepresented as being the original software.
+
+3. This notice may not be removed or altered from any source distribution.
\ No newline at end of file
diff --git a/tools/external_crates/name_and_version/src/lib.rs b/tools/external_crates/name_and_version/src/lib.rs
index d4cf7bb27..3d8e1c72b 100644
--- a/tools/external_crates/name_and_version/src/lib.rs
+++ b/tools/external_crates/name_and_version/src/lib.rs
@@ -17,9 +17,7 @@
 use semver::Version;
 use thiserror::Error;
 
-pub use self::name_and_version::{
-    IsUpgradableTo, NameAndVersion, NameAndVersionRef, NamedAndVersioned,
-};
+pub use self::name_and_version::{NameAndVersion, NameAndVersionRef, NamedAndVersioned};
 mod name_and_version;
 
 pub use self::name_and_version_map::{
diff --git a/tools/external_crates/name_and_version/src/name_and_version.rs b/tools/external_crates/name_and_version/src/name_and_version.rs
index 9327f9f93..6ed01dcc5 100644
--- a/tools/external_crates/name_and_version/src/name_and_version.rs
+++ b/tools/external_crates/name_and_version/src/name_and_version.rs
@@ -21,7 +21,7 @@ use std::{
     hash::{Hash, Hasher},
 };
 
-use semver::{BuildMetadata, Prerelease, Version, VersionReq};
+use semver::{BuildMetadata, Prerelease, Version};
 
 static MIN_VERSION: Version =
     Version { major: 0, minor: 0, patch: 0, pre: Prerelease::EMPTY, build: BuildMetadata::EMPTY };
@@ -133,19 +133,6 @@ impl<'a> Hash for (dyn NamedAndVersioned + 'a) {
     }
 }
 
-/// A trait for determining semver compatibility.
-pub trait IsUpgradableTo: NamedAndVersioned {
-    /// Returns true if the object version is semver-compatible with 'other'.
-    fn is_upgradable_to(&self, other: &impl NamedAndVersioned) -> bool {
-        self.name() == other.name()
-            && VersionReq::parse(&self.version().to_string())
-                .is_ok_and(|req| req.matches(other.version()))
-    }
-}
-
-impl IsUpgradableTo for NameAndVersion {}
-impl<'a> IsUpgradableTo for NameAndVersionRef<'a> {}
-
 #[cfg(test)]
 mod tests {
     use super::*;
@@ -153,48 +140,18 @@ mod tests {
     #[test]
     fn test_name_version_ref() -> Result<(), semver::Error> {
         let version = Version::parse("2.3.4")?;
-        let compat1 = Version::parse("2.3.5")?;
-        let compat2 = Version::parse("2.4.0")?;
-        let incompat = Version::parse("3.0.0")?;
-        let older = Version::parse("2.3.3")?;
         let nvp = NameAndVersionRef::new("foo", &version);
         assert_eq!(nvp.name(), "foo");
         assert_eq!(nvp.version().to_string(), "2.3.4");
-        assert!(nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &compat1)), "Patch update");
-        assert!(
-            nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &compat2)),
-            "Minor version update"
-        );
-        assert!(
-            !nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &incompat)),
-            "Incompatible (major version) update"
-        );
-        assert!(!nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &older)), "Downgrade");
-        assert!(!nvp.is_upgradable_to(&NameAndVersionRef::new("bar", &compat1)), "Different name");
         Ok(())
     }
 
     #[test]
     fn test_name_and_version() -> Result<(), semver::Error> {
         let version = Version::parse("2.3.4")?;
-        let compat1 = Version::parse("2.3.5")?;
-        let compat2 = Version::parse("2.4.0")?;
-        let incompat = Version::parse("3.0.0")?;
-        let older = Version::parse("2.3.3")?;
         let nvp = NameAndVersion::new("foo".to_string(), version);
         assert_eq!(nvp.name(), "foo");
         assert_eq!(nvp.version().to_string(), "2.3.4");
-        assert!(nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &compat1)), "Patch update");
-        assert!(
-            nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &compat2)),
-            "Minor version update"
-        );
-        assert!(
-            !nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &incompat)),
-            "Incompatible (major version) update"
-        );
-        assert!(!nvp.is_upgradable_to(&NameAndVersionRef::new("foo", &older)), "Downgrade");
-        assert!(!nvp.is_upgradable_to(&NameAndVersionRef::new("bar", &compat1)), "Different name");
         Ok(())
     }
 }
diff --git a/tools/external_crates/name_and_version/src/name_and_version_map.rs b/tools/external_crates/name_and_version/src/name_and_version_map.rs
index bfca3ac28..0fdf08668 100644
--- a/tools/external_crates/name_and_version/src/name_and_version_map.rs
+++ b/tools/external_crates/name_and_version/src/name_and_version_map.rs
@@ -19,7 +19,7 @@ use std::collections::{BTreeMap, HashSet};
 use itertools::Itertools;
 use semver::Version;
 
-use crate::{Error, IsUpgradableTo, NameAndVersion, NamedAndVersioned};
+use crate::{Error, NameAndVersion, NamedAndVersioned};
 
 /// A mapping from crate names and versions to some associated data.
 pub trait NameAndVersionMap {
@@ -48,20 +48,6 @@ pub trait NameAndVersionMap {
         &'a mut self,
         name: &'b str,
     ) -> Box<dyn Iterator<Item = (&'a NameAndVersion, &'a mut Self::Value)> + 'a>;
-    /// Get the highest version in the map that is semver-compatible with
-    /// a given crate and version.
-    fn get_version_upgradable_from<T: NamedAndVersioned + IsUpgradableTo>(
-        &self,
-        other: &T,
-    ) -> Option<&NameAndVersion> {
-        let mut best_version = None;
-        for (nv, _val) in self.get_versions(other.name()) {
-            if other.is_upgradable_to(nv) {
-                best_version.replace(nv);
-            }
-        }
-        best_version
-    }
     /// Returns an iterator over the map, filtered according to a predicate that acts on
     /// all the available versions for a crate.
     fn filter_versions<
@@ -253,12 +239,6 @@ mod tests {
         assert!(test_map.get_mut(&wrong_name).is_none());
         assert!(test_map.get_mut(&wrong_version).is_none());
 
-        assert_eq!(
-            test_map.get_version_upgradable_from(&NameAndVersion::try_from_str("foo", "1.2.2")?),
-            Some(&foo1)
-        );
-
-        // TOOD: Iter
         assert_equal(test_map.keys(), [&bar, &foo1, &foo2]);
 
         assert_equal(test_map.values(), ["bar", "foo v1", "foo v2"]);
diff --git a/tools/external_crates/rooted_path/src/lib.rs b/tools/external_crates/rooted_path/src/lib.rs
index 7c1748ca4..d29136d65 100644
--- a/tools/external_crates/rooted_path/src/lib.rs
+++ b/tools/external_crates/rooted_path/src/lib.rs
@@ -29,7 +29,7 @@ pub enum RootedPathError {
 }
 
 /// A path relative to a root.
-#[derive(Debug, PartialEq, Eq)]
+#[derive(Debug, PartialEq, Eq, Clone)]
 pub struct RootedPath {
     root: PathBuf,
     path: PathBuf,
diff --git a/tools/external_crates/test_mapping/Cargo.toml b/tools/external_crates/test_mapping/Cargo.toml
new file mode 100644
index 000000000..1e6bd66c7
--- /dev/null
+++ b/tools/external_crates/test_mapping/Cargo.toml
@@ -0,0 +1,13 @@
+[package]
+name = "test_mapping"
+version = "0.1.0"
+edition = "2021"
+
+[dependencies]
+android_bp = "0.3"
+json-strip-comments = "1"
+owning_ref = "0.4"
+serde = { version = "=1.0.210", features = ["derive"] }
+serde_json = "1"
+thiserror = "1.0"
+rooted_path = { path = "../rooted_path" }
\ No newline at end of file
diff --git a/tools/external_crates/test_mapping/src/blueprint.rs b/tools/external_crates/test_mapping/src/blueprint.rs
new file mode 100644
index 000000000..e3d23c3b3
--- /dev/null
+++ b/tools/external_crates/test_mapping/src/blueprint.rs
@@ -0,0 +1,202 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! Convenience methods for working with Android blueprint files.
+
+use std::{
+    collections::{BTreeSet, HashSet},
+    sync::LazyLock,
+};
+
+use android_bp::{BluePrint, Value};
+
+use crate::TestMappingError;
+
+/// Extract rust test rules from a blueprint file.
+pub(crate) trait RustTests {
+    /// Returns the names of all rust_test and rust_test_host rules.
+    fn rust_tests(&self) -> Result<BTreeSet<String>, TestMappingError>;
+}
+
+impl RustTests for BluePrint {
+    fn rust_tests(&self) -> Result<BTreeSet<String>, TestMappingError> {
+        let mut tests = BTreeSet::new();
+        for module in &self.modules {
+            if matches!(module.typ.as_str(), "rust_test" | "rust_test_host") {
+                let name = module
+                    .get_string("name")
+                    .ok_or(TestMappingError::RuleWithoutName(module.typ.clone()))?
+                    .clone();
+                if !EXCLUDED_TESTS.contains(name.as_str()) {
+                    tests.insert(name);
+                }
+            }
+        }
+        Ok(tests)
+    }
+}
+
+/// Finds all the rustlib dependencies mentioned in a blueprint file.
+pub(crate) trait RustDeps {
+    // Finds all the rustlibs mentioned in a blueprint file.
+    // This does a limited amount of evaluation, by doing concatenation and resolving
+    // identifiers. So you can have `common_rustlibs = ["foo", "bar"] and do
+    // rust_library { rustlibs = common_rustlibs + ["baz"] }`
+    fn rust_deps(&self) -> BTreeSet<String>;
+}
+
+impl RustDeps for BluePrint {
+    fn rust_deps(&self) -> BTreeSet<String> {
+        let mut rustlibs = BTreeSet::new();
+        for module in &self.modules {
+            if let Some(v) = module.get("rustlibs") {
+                match v {
+                    Value::Array(_) => rustlibs.extend(v.as_string_vec()),
+                    Value::ConcatExpr(_) => rustlibs.extend(v.eval(self)),
+                    _ => {
+                        println!("Only know how to handle Array and ConcatExpr");
+                    }
+                }
+            }
+        }
+        rustlibs
+    }
+}
+
+// Convenience accessor for arrays of strings.
+trait AsStringVec {
+    // Interpret a android_bp::Value as an array of strings, and convert it to
+    // an array of owned strings. Any element that isn't a string is skipped.
+    fn as_string_vec(&self) -> Vec<String>;
+}
+
+impl AsStringVec for Value {
+    fn as_string_vec(&self) -> Vec<String> {
+        if let Value::Array(vec) = self {
+            vec.iter()
+                .filter_map(|v| match v {
+                    Value::String(s) => Some(s.to_string()),
+                    _ => {
+                        println!("Array element is not a string");
+                        None
+                    }
+                })
+                .collect()
+        } else {
+            println!("Value is not an array");
+            vec![]
+        }
+    }
+}
+
+// Evaluate concatenations and resolve identifiers.
+trait EvalConcat {
+    // Evaluate a concatenation expression, resolving it into a single vector of strings.
+    // The elements being concatenated are assumed to be either identifiers or
+    // arrays of strings. Otherwise, they are skipped.
+    fn eval(&self, bp: &BluePrint) -> Vec<String>;
+}
+
+impl EvalConcat for Value {
+    fn eval(&self, bp: &BluePrint) -> Vec<String> {
+        let mut strings = Vec::new();
+        if let Value::ConcatExpr(expr) = self {
+            for term in expr {
+                match term {
+                    Value::Array(_) => strings.extend(term.as_string_vec()),
+                    Value::Ident(ident) => {
+                        if let Some(ident_val) = bp.variables.get(ident) {
+                            strings.extend(ident_val.as_string_vec());
+                        }
+                    }
+                    _ => {
+                        println!("Concat term is neither ident nor array");
+                    }
+                }
+            }
+        } else {
+            println!("Value is not a ConcatExpr");
+        }
+        strings
+    }
+}
+
+// Taken from update_crate_tests.py
+static EXCLUDED_TESTS: LazyLock<HashSet<&'static str>> = LazyLock::new(|| {
+    HashSet::from([
+        "ash_test_src_lib",
+        "ash_test_tests_constant_size_arrays",
+        "ash_test_tests_display",
+        "shared_library_test_src_lib",
+        "vulkano_test_src_lib",
+        // These are helper binaries for aidl_integration_test
+        // and aren't actually meant to run as individual tests.
+        "aidl_test_rust_client",
+        "aidl_test_rust_service",
+        "aidl_test_rust_service_async",
+        // This is a helper binary for AuthFsHostTest and shouldn't
+        // be run directly.
+        "open_then_run",
+        // TODO: Remove when b/198197213 is closed.
+        "diced_client_test",
+        "CoverageRustSmokeTest",
+        "libtrusty-rs-tests",
+        "terminal-size_test_src_lib",
+    ])
+});
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn rust_tests() -> Result<(), TestMappingError> {
+        let bp = BluePrint::parse(
+            r###"
+rust_test { name: "foo" }
+rust_test_host { name: "bar" }
+"###,
+        )
+        .expect("Blueprint parse error");
+        assert_eq!(bp.rust_tests()?, BTreeSet::from(["foo".to_string(), "bar".to_string()]));
+        Ok(())
+    }
+
+    #[test]
+    fn rust_deps() {
+        let bp = BluePrint::parse(
+            r###"
+rust_library { rustlibs: ["foo", "bar"] }
+rust_library { rustlibs: ["bar", "baz"] }
+"###,
+        )
+        .expect("Blueprint parse error");
+        assert_eq!(
+            bp.rust_deps(),
+            BTreeSet::from(["foo".to_string(), "bar".to_string(), "baz".to_string()])
+        );
+    }
+
+    #[test]
+    fn rust_deps_eval() {
+        let bp = BluePrint::parse(
+            r###"
+foo = ["foo"]
+rust_library { rustlibs: foo + ["bar"] }
+"###,
+        )
+        .expect("Blueprint parse error");
+        assert_eq!(bp.rust_deps(), BTreeSet::from(["foo".to_string(), "bar".to_string()]));
+    }
+}
diff --git a/tools/external_crates/test_mapping/src/json.rs b/tools/external_crates/test_mapping/src/json.rs
new file mode 100644
index 000000000..de199cab1
--- /dev/null
+++ b/tools/external_crates/test_mapping/src/json.rs
@@ -0,0 +1,171 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! Representation of a TEST_MAPPING JSON file.
+
+use std::collections::BTreeSet;
+
+use serde::{Deserialize, Serialize};
+
+use crate::TestMappingError;
+
+#[derive(Serialize, Deserialize, Default, Debug)]
+pub(crate) struct TestMappingJson {
+    #[serde(default, skip_serializing_if = "Vec::is_empty")]
+    pub imports: Vec<TestMappingPath>,
+    #[serde(default, skip_serializing_if = "Vec::is_empty")]
+    presubmit: Vec<TestMappingName>,
+    #[serde(default, skip_serializing_if = "Vec::is_empty", rename = "presubmit-rust")]
+    presubmit_rust: Vec<TestMappingName>,
+    #[serde(default, skip_serializing_if = "Vec::is_empty")]
+    postsubmit: Vec<TestMappingName>,
+}
+
+#[derive(Serialize, Deserialize, Debug, Clone, PartialEq, Eq, PartialOrd, Ord)]
+struct TestMappingName {
+    name: String,
+}
+
+#[derive(Serialize, Deserialize, Debug, Clone, PartialEq, Eq, PartialOrd, Ord)]
+pub(crate) struct TestMappingPath {
+    pub path: String,
+}
+
+impl TestMappingJson {
+    pub fn parse(mut contents: String) -> Result<TestMappingJson, TestMappingError> {
+        let contents = contents.as_mut_str();
+        // Comments are not part of the JSON spec (although they are often used), and Serde won't parse them.
+        json_strip_comments::strip(contents).map_err(TestMappingError::StripJsonCommentsError)?;
+        let parsed: TestMappingJson = serde_json::from_str(contents)?;
+        Ok(parsed)
+    }
+    pub fn is_empty(&self) -> bool {
+        self.imports.is_empty()
+            && self.presubmit.is_empty()
+            && self.presubmit_rust.is_empty()
+            && self.postsubmit.is_empty()
+    }
+    pub fn set_presubmits(&mut self, tests: &BTreeSet<String>) {
+        self.presubmit = tests.iter().map(|t| TestMappingName { name: t.to_string() }).collect();
+        self.presubmit_rust = self.presubmit.clone();
+    }
+    pub fn convert_postsubmit_tests(&mut self) -> bool {
+        let changed = !self.postsubmit.is_empty();
+        self.presubmit.append(&mut self.postsubmit.clone());
+        self.presubmit_rust.append(&mut self.postsubmit);
+        self.presubmit.sort();
+        self.presubmit.dedup();
+        self.presubmit_rust.sort();
+        self.presubmit_rust.dedup();
+        changed
+    }
+    pub fn add_new_tests_to_postsubmit(&mut self, tests: &BTreeSet<String>) -> bool {
+        let mut changed = false;
+        self.postsubmit.extend(tests.difference(&self.all_test_names()).map(|test_name| {
+            changed = true;
+            TestMappingName { name: test_name.to_string() }
+        }));
+        self.postsubmit.sort();
+        self.postsubmit.dedup();
+        changed
+    }
+    fn all_test_names(&self) -> BTreeSet<String> {
+        let mut tests = BTreeSet::new();
+        tests.extend(self.presubmit.iter().map(|t| t.name.clone()));
+        tests.extend(self.presubmit_rust.iter().map(|t| t.name.clone()));
+        tests.extend(self.postsubmit.iter().map(|t| t.name.clone()));
+        tests
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    static TEST_JSON: &str = r###"{
+  "imports": [
+    {
+      "path": "foo"
+    }
+  ],
+  "presubmit": [
+    {
+      "name": "bar"
+    }
+  ],
+  "presubmit-rust": [
+    {
+      "name": "baz"
+    }
+  ],
+  "postsubmit": [
+    {
+      "name": "qux"
+    }
+  ]
+}
+"###;
+
+    #[test]
+    fn parse() -> Result<(), TestMappingError> {
+        TestMappingJson::parse("{}".to_string())?;
+        TestMappingJson::parse("//comment\n{}".to_string())?;
+        TestMappingJson::parse(TEST_JSON.to_string())?;
+        assert!(TestMappingJson::parse("foo".to_string()).is_err());
+        Ok(())
+    }
+
+    #[test]
+    fn all_test_names() -> Result<(), TestMappingError> {
+        let json = TestMappingJson::parse(TEST_JSON.to_string())?;
+        assert_eq!(
+            json.all_test_names(),
+            BTreeSet::from(["bar".to_string(), "baz".to_string(), "qux".to_string()])
+        );
+        Ok(())
+    }
+
+    #[test]
+    fn set_presubmits() -> Result<(), TestMappingError> {
+        let mut json = TestMappingJson::parse(TEST_JSON.to_string())?;
+        json.set_presubmits(&BTreeSet::from(["asdf".to_string()]));
+        assert_eq!(json.presubmit, vec![TestMappingName { name: "asdf".to_string() }]);
+        assert_eq!(json.presubmit, json.presubmit_rust);
+        Ok(())
+    }
+
+    #[test]
+    fn add_new_tests_to_postsubmit() -> Result<(), TestMappingError> {
+        let mut json = TestMappingJson::parse(TEST_JSON.to_string())?;
+        assert!(!json.add_new_tests_to_postsubmit(&BTreeSet::from(["bar".to_string()])));
+        assert!(json
+            .add_new_tests_to_postsubmit(&BTreeSet::from(["bar".to_string(), "asdf".to_string()])));
+        assert_eq!(
+            json.postsubmit,
+            vec![
+                TestMappingName { name: "asdf".to_string() },
+                TestMappingName { name: "qux".to_string() }
+            ]
+        );
+        Ok(())
+    }
+
+    #[test]
+    fn is_empty() -> Result<(), TestMappingError> {
+        let json = TestMappingJson::parse(TEST_JSON.to_string())?;
+        assert!(!json.is_empty());
+        assert!(TestMappingJson::default().is_empty());
+        Ok(())
+    }
+}
diff --git a/tools/external_crates/test_mapping/src/lib.rs b/tools/external_crates/test_mapping/src/lib.rs
new file mode 100644
index 000000000..71eb7d0f5
--- /dev/null
+++ b/tools/external_crates/test_mapping/src/lib.rs
@@ -0,0 +1,169 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! Read, update, and write TEST_MAPPING files.
+
+mod blueprint;
+mod json;
+mod rdeps;
+
+use std::{
+    collections::BTreeSet,
+    fs::{read_to_string, remove_file, write},
+    io,
+    path::PathBuf,
+    str::Utf8Error,
+};
+
+use android_bp::BluePrint;
+use blueprint::RustTests;
+use json::{TestMappingJson, TestMappingPath};
+use rdeps::ReverseDeps;
+use rooted_path::RootedPath;
+use thiserror::Error;
+
+#[derive(Error, Debug)]
+pub enum TestMappingError {
+    #[error("Blueprint file {0} not found")]
+    BlueprintNotFound(PathBuf),
+    #[error("Blueprint parse error: {0}")]
+    BlueprintParseError(String),
+    #[error("Blueprint rule has no name")]
+    RuleWithoutName(String),
+
+    #[error("Error stripping JSON comments")]
+    StripJsonCommentsError(io::Error),
+    #[error("JSON parse error")]
+    JsonParseError(#[from] serde_json::Error),
+
+    #[error("IO error")]
+    IoError(#[from] io::Error),
+    #[error("Command output not UTF-8")]
+    Utf8Error(#[from] Utf8Error),
+    #[error("Failed to split grep output line {0} on '/'")]
+    GrepParseError(String),
+}
+
+#[derive(Debug)]
+pub struct TestMapping {
+    path: RootedPath,
+    json: TestMappingJson,
+    bp: BluePrint,
+}
+
+impl TestMapping {
+    /// Read the TEST_MAPPING file in the specified directory.
+    /// If there is no TEST_MAPPING file, a default value is returned.
+    /// Also reads the Android.bp in the directory, because we need that
+    /// information to update the TEST_MAPPING.
+    pub fn read(path: RootedPath) -> Result<TestMapping, TestMappingError> {
+        let bpfile = path.join("Android.bp").unwrap();
+        if !bpfile.abs().exists() {
+            return Err(TestMappingError::BlueprintNotFound(bpfile.rel().to_path_buf()));
+        }
+        let bp = BluePrint::from_file(bpfile)
+            .map_err(|e: String| TestMappingError::BlueprintParseError(e))?;
+        let test_mapping_path = path.join("TEST_MAPPING").unwrap();
+        let json = if path.abs().exists() {
+            TestMappingJson::parse(read_to_string(test_mapping_path)?)?
+        } else {
+            TestMappingJson::default()
+        };
+        Ok(TestMapping { path, json, bp })
+    }
+    /// Write the TEST_MAPPING file.
+    pub fn write(&self) -> Result<(), TestMappingError> {
+        if self.json.is_empty() && self.test_mapping().abs().exists() {
+            remove_file(self.test_mapping())?;
+        } else {
+            let mut contents = serde_json::to_string_pretty(&self.json)?;
+            contents.push('\n');
+            write(self.test_mapping(), contents)?;
+        }
+        Ok(())
+    }
+    /// Update the presubmit and presubmit_rust fields to the
+    /// set of test targets in the Android.bp file.
+    /// Since adding new tests directly to presubmits is discouraged,
+    /// It's preferable to use add_new_tests_to_postsubmit and
+    /// convert_postsubmit_tests instead.
+    pub fn update_presubmits(&mut self) -> Result<(), TestMappingError> {
+        self.json.set_presubmits(&self.bp.rust_tests()?);
+        Ok(())
+    }
+    /// Add tests that aren't already mentioned in TEST_MAPPING
+    /// as post-submit tests.
+    pub fn add_new_tests_to_postsubmit(&mut self) -> Result<bool, TestMappingError> {
+        Ok(self.json.add_new_tests_to_postsubmit(&self.bp.rust_tests()?))
+    }
+    /// Convert post-submit tests to run at presubmit.
+    pub fn convert_postsubmit_tests(&mut self) -> bool {
+        self.json.convert_postsubmit_tests()
+    }
+    /// Fix the import paths of TEST_MAPPING files to refer to the monorepo.
+    /// Essentially, replace external/rust/crates with external/rust/android-crates-io/crates.
+    pub fn fix_import_paths(&mut self) -> bool {
+        let mut changed = false;
+        for import in self.json.imports.iter_mut() {
+            if import.path.starts_with("external/rust/crates") {
+                let new_path = import
+                    .path
+                    .replace("external/rust/crates", "external/rust/android-crates-io/crates");
+                if self.path.with_same_root(new_path.clone()).unwrap().abs().exists() {
+                    import.path = new_path;
+                    changed = true;
+                }
+            }
+        }
+        changed
+    }
+    /// Update the imports section of TEST_MAPPING to contain all the
+    /// paths that depend on this crate.
+    pub fn update_imports(&mut self) -> Result<(), TestMappingError> {
+        let all_rdeps = ReverseDeps::for_repo(self.path.root());
+        let mut rdeps = BTreeSet::new();
+        for lib in self.libs()? {
+            if let Some(paths) = all_rdeps.get(lib.as_str()) {
+                rdeps.append(&mut paths.clone());
+            }
+        }
+        let self_path = self.path.rel().to_str().unwrap();
+        self.json.imports = rdeps
+            .iter()
+            .filter(|path| path.as_str() != self_path)
+            .map(|t| TestMappingPath { path: t.to_string() })
+            .collect();
+        Ok(())
+    }
+    fn test_mapping(&self) -> RootedPath {
+        self.path.join("TEST_MAPPING").unwrap()
+    }
+    fn libs(&self) -> Result<Vec<String>, TestMappingError> {
+        let mut libs = Vec::new();
+        for module in &self.bp.modules {
+            if matches!(
+                module.typ.as_str(),
+                "rust_library" | "rust_library_rlib" | "rust_library_host" | "rust_proc_macro"
+            ) {
+                libs.push(
+                    module
+                        .get_string("name")
+                        .ok_or(TestMappingError::RuleWithoutName(module.typ.clone()))?
+                        .clone(),
+                );
+            }
+        }
+        Ok(libs)
+    }
+}
diff --git a/tools/external_crates/test_mapping/src/rdeps.rs b/tools/external_crates/test_mapping/src/rdeps.rs
new file mode 100644
index 000000000..94b265000
--- /dev/null
+++ b/tools/external_crates/test_mapping/src/rdeps.rs
@@ -0,0 +1,95 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! Find reverse dependencies of Rust crates by searching blueprint files
+//! for rustlibs.
+
+use std::{
+    collections::{BTreeSet, HashMap},
+    path::{Path, PathBuf},
+    process::Command,
+    str::from_utf8,
+    sync::{LazyLock, Mutex},
+};
+
+use android_bp::BluePrint;
+use owning_ref::MutexGuardRef;
+
+use crate::{blueprint::RustDeps, TestMappingError};
+
+pub(crate) struct ReverseDeps {
+    // Mapping from Rust build rule target name => list of paths that depend on it.
+    rdeps: HashMap<String, BTreeSet<String>>,
+}
+
+impl ReverseDeps {
+    /// Returns a reverse dependency lookup for the Android source repo
+    /// at the specified absolute path. Each lookup is created once
+    /// and cached.
+    pub fn for_repo(
+        repo_root: &Path,
+    ) -> MutexGuardRef<'static, HashMap<PathBuf, ReverseDeps>, ReverseDeps> {
+        static RDEPS: LazyLock<Mutex<HashMap<PathBuf, ReverseDeps>>> =
+            LazyLock::new(|| Mutex::new(HashMap::new()));
+
+        RDEPS
+            .lock()
+            .unwrap()
+            .entry(repo_root.to_path_buf())
+            .or_insert_with(|| ReverseDeps::grep_and_parse(repo_root).unwrap());
+        MutexGuardRef::new(RDEPS.lock().unwrap()).map(|rdeps| rdeps.get(repo_root).unwrap())
+    }
+    /// Get the paths that depend on a rust library.
+    pub fn get(&self, name: &str) -> Option<&BTreeSet<String>> {
+        self.rdeps.get(name)
+    }
+    fn grep_and_parse<P: Into<PathBuf>>(repo_root: P) -> Result<ReverseDeps, TestMappingError> {
+        let repo_root = repo_root.into();
+        // Empirically, TEST_MAPPING files for 3rd party crates only
+        // have imports from external, packages, system, and tools.
+        let output = Command::new("grep")
+            .args([
+                "-r",
+                "-l",
+                "--include=*.bp",
+                "rustlibs",
+                "external",
+                "packages",
+                "system",
+                "tools",
+            ])
+            .current_dir(&repo_root)
+            .output()?;
+        let stdout = from_utf8(&output.stdout)?;
+        let mut rdeps = HashMap::new();
+        for line in stdout.lines() {
+            if EXCLUDED_PATHS.iter().any(|excluded| line.starts_with(excluded)) {
+                continue;
+            }
+            let (dir, _) =
+                line.rsplit_once('/').ok_or(TestMappingError::GrepParseError(line.to_string()))?;
+            if let Ok(bp) = BluePrint::from_file(repo_root.join(line)) {
+                for rustlib in bp.rust_deps() {
+                    rdeps.entry(rustlib).or_insert(BTreeSet::new()).insert(dir.to_string());
+                }
+            }
+        }
+        Ok(ReverseDeps { rdeps })
+    }
+}
+
+// Originally taken from update_crate_tests.py, but of the values in there, only external/crosvm
+// seems to exist.
+static EXCLUDED_PATHS: LazyLock<Vec<&'static str>> =
+    LazyLock::new(|| vec!["external/crosvm/", "development/tools/cargo_embargo/testdata/"]);
diff --git a/tools/mergetool/remerge3.sh b/tools/mergetool/remerge3.sh
index ec0fc2bbe..ef7b5eff4 100755
--- a/tools/mergetool/remerge3.sh
+++ b/tools/mergetool/remerge3.sh
@@ -106,13 +106,17 @@ while [[ "$1" =~ ^- ]]; do
   esac
 done
 
-IN_GIT_WORKTREE=false
+TRUST_EXIT_CODE=false
 if git rev-parse >/dev/null 2>/dev/null; then
-  IN_GIT_WORKTREE=true
+  case "$MERGETOOL" in
+    bc* | vim*)
+      TRUST_EXIT_CODE=true
+      ;;
+  esac
 fi
 
 readonly MERGETOOL
-readonly IN_GIT_WORKTREE
+readonly TRUST_EXIT_CODE
 
 FILES_UNFILTERED=()
 if [[ "${#}" -eq 0 ]]; then
@@ -140,16 +144,22 @@ printf '    %s\n' "${FILES[@]}"
 for file in "${FILES[@]}"; do
   echo
   echo "Merging '${file}'"
+
   mergetool "$file"
   exit_code="$?"
-  if [[ "$exit_code" -eq 0 ]]; then
-    if $IN_GIT_WORKTREE && [[ -n "$(git ls-files "$file")" ]]; then
+  if [[ "$exit_code" -ne 0 ]]; then
+    echo "Failed to merge '${file}'"
+  fi
+
+  if $TRUST_EXIT_CODE && [[ "$exit_code" -eq 0 ]]; then
+    if [[ -n "$(git ls-files "$file")" ]]; then
       xtrace git add "$file"
     fi
-  else
-    echo "Failed to merge '${file}'"
+    continue
   fi
   read -r -p "Continue merging other files? [Y/n]" -n 1 yn || exit
   echo
   [[ "$yn" == [nNqQ] ]] && exit "$exit_code"
 done
+
+exit 0
diff --git a/tools/motion/motion_test_watcher_app/angular.json b/tools/motion/motion_test_watcher_app/angular.json
index 1f9481776..283df25a6 100644
--- a/tools/motion/motion_test_watcher_app/angular.json
+++ b/tools/motion/motion_test_watcher_app/angular.json
@@ -97,5 +97,8 @@
         }
       }
     }
+  },
+  "cli": {
+    "analytics": false
   }
 }
diff --git a/tools/motion/motion_test_watcher_app/package-lock.json b/tools/motion/motion_test_watcher_app/package-lock.json
index a00257016..0e553402a 100644
--- a/tools/motion/motion_test_watcher_app/package-lock.json
+++ b/tools/motion/motion_test_watcher_app/package-lock.json
@@ -51,12 +51,12 @@
       }
     },
     "node_modules/@angular-devkit/architect": {
-      "version": "0.1801.1",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/architect/-/architect-0.1801.1.tgz",
-      "integrity": "sha512-7dIQ++D5PTzLgs4sEvi7pMpG4nY4CTnzLKbqKDI++fJKa7FEpVjje1tsr1r8ap8xD0QXr6sIxmQ4hdLeWwPhDQ==",
+      "version": "0.1802.5",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/architect/-/architect-0.1802.5.tgz",
+      "integrity": "sha512-c7sVoW85Yqj7IYvNKxtNSGS5I7gWpORorg/xxLZX3OkHWXDrwYbb5LN/2p5/Aytxyb0aXl4o5fFOu6CUwcaLUw==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/core": "18.1.1",
+        "@angular-devkit/core": "18.2.5",
         "rxjs": "7.8.1"
       },
       "engines": {
@@ -66,47 +66,47 @@
       }
     },
     "node_modules/@angular-devkit/build-angular": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/build-angular/-/build-angular-18.1.1.tgz",
-      "integrity": "sha512-sd/eOzitC8yN9xl/TbbuDxXL1LRZCX3gwKAddV1fJSrXJHEmDM7PhdQbNEPd2O58evMKSiMZK91WnYN0lhTZtw==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/build-angular/-/build-angular-18.2.5.tgz",
+      "integrity": "sha512-dIvb0AHoRIMM6tLuG4t6lDDslSAYP77wqytodsN317UzFOuuCPernXbO8NJs+QHxj09nPsem1T5vnvpO2E/PVQ==",
       "dev": true,
       "dependencies": {
         "@ampproject/remapping": "2.3.0",
-        "@angular-devkit/architect": "0.1801.1",
-        "@angular-devkit/build-webpack": "0.1801.1",
-        "@angular-devkit/core": "18.1.1",
-        "@angular/build": "18.1.1",
-        "@babel/core": "7.24.7",
-        "@babel/generator": "7.24.7",
+        "@angular-devkit/architect": "0.1802.5",
+        "@angular-devkit/build-webpack": "0.1802.5",
+        "@angular-devkit/core": "18.2.5",
+        "@angular/build": "18.2.5",
+        "@babel/core": "7.25.2",
+        "@babel/generator": "7.25.0",
         "@babel/helper-annotate-as-pure": "7.24.7",
         "@babel/helper-split-export-declaration": "7.24.7",
-        "@babel/plugin-transform-async-generator-functions": "7.24.7",
+        "@babel/plugin-transform-async-generator-functions": "7.25.0",
         "@babel/plugin-transform-async-to-generator": "7.24.7",
         "@babel/plugin-transform-runtime": "7.24.7",
-        "@babel/preset-env": "7.24.7",
-        "@babel/runtime": "7.24.7",
-        "@discoveryjs/json-ext": "0.5.7",
-        "@ngtools/webpack": "18.1.1",
+        "@babel/preset-env": "7.25.3",
+        "@babel/runtime": "7.25.0",
+        "@discoveryjs/json-ext": "0.6.1",
+        "@ngtools/webpack": "18.2.5",
         "@vitejs/plugin-basic-ssl": "1.1.0",
         "ansi-colors": "4.1.3",
-        "autoprefixer": "10.4.19",
+        "autoprefixer": "10.4.20",
         "babel-loader": "9.1.3",
         "browserslist": "^4.21.5",
         "copy-webpack-plugin": "12.0.2",
         "critters": "0.0.24",
         "css-loader": "7.1.2",
-        "esbuild-wasm": "0.21.5",
+        "esbuild-wasm": "0.23.0",
         "fast-glob": "3.3.2",
         "http-proxy-middleware": "3.0.0",
         "https-proxy-agent": "7.0.5",
-        "istanbul-lib-instrument": "6.0.2",
+        "istanbul-lib-instrument": "6.0.3",
         "jsonc-parser": "3.3.1",
         "karma-source-map-support": "1.4.0",
         "less": "4.2.0",
         "less-loader": "12.2.0",
         "license-webpack-plugin": "4.0.2",
         "loader-utils": "3.3.1",
-        "magic-string": "0.30.10",
+        "magic-string": "0.30.11",
         "mini-css-extract-plugin": "2.9.0",
         "mrmime": "2.0.0",
         "open": "10.1.0",
@@ -114,25 +114,24 @@
         "parse5-html-rewriting-stream": "7.0.0",
         "picomatch": "4.0.2",
         "piscina": "4.6.1",
-        "postcss": "8.4.38",
+        "postcss": "8.4.41",
         "postcss-loader": "8.1.1",
         "resolve-url-loader": "5.0.0",
         "rxjs": "7.8.1",
         "sass": "1.77.6",
-        "sass-loader": "14.2.1",
-        "semver": "7.6.2",
+        "sass-loader": "16.0.0",
+        "semver": "7.6.3",
         "source-map-loader": "5.0.0",
         "source-map-support": "0.5.21",
-        "terser": "5.29.2",
+        "terser": "5.31.6",
         "tree-kill": "1.2.2",
         "tslib": "2.6.3",
-        "undici": "6.19.2",
-        "vite": "5.3.2",
+        "vite": "5.4.6",
         "watchpack": "2.4.1",
-        "webpack": "5.92.1",
-        "webpack-dev-middleware": "7.2.1",
+        "webpack": "5.94.0",
+        "webpack-dev-middleware": "7.4.2",
         "webpack-dev-server": "5.0.4",
-        "webpack-merge": "5.10.0",
+        "webpack-merge": "6.0.1",
         "webpack-subresource-integrity": "5.1.0"
       },
       "engines": {
@@ -141,7 +140,7 @@
         "yarn": ">= 1.13.0"
       },
       "optionalDependencies": {
-        "esbuild": "0.21.5"
+        "esbuild": "0.23.0"
       },
       "peerDependencies": {
         "@angular/compiler-cli": "^18.0.0",
@@ -194,13 +193,19 @@
         }
       }
     },
+    "node_modules/@angular-devkit/build-angular/node_modules/tslib": {
+      "version": "2.6.3",
+      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.6.3.tgz",
+      "integrity": "sha512-xNvxJEOUiWPGhUuUdQgAJPKOOJfGnIyKySOc09XkKsgdUV/3E2zvwZYdejjmRgPCgcym1juLH3226yA7sEFJKQ==",
+      "dev": true
+    },
     "node_modules/@angular-devkit/build-webpack": {
-      "version": "0.1801.1",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/build-webpack/-/build-webpack-0.1801.1.tgz",
-      "integrity": "sha512-9qImQciytrf433+h1aAWMD/Qn9cx7amlLtHX9j6ToBMWxY3L9ZKzwlCZ3Q+d6VWs7QrN/X9j8VkJl913yuXeCQ==",
+      "version": "0.1802.5",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/build-webpack/-/build-webpack-0.1802.5.tgz",
+      "integrity": "sha512-6qkcrWBdkxojCVHGWcdJaz4G+7QTjFvmc+3g8xvLc9sYvJq1I059gfXhDnC0FxiA0MT4cY/26ECYWUHTD5CJLQ==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/architect": "0.1801.1",
+        "@angular-devkit/architect": "0.1802.5",
         "rxjs": "7.8.1"
       },
       "engines": {
@@ -214,12 +219,12 @@
       }
     },
     "node_modules/@angular-devkit/core": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/core/-/core-18.1.1.tgz",
-      "integrity": "sha512-YFzn/+8LezX7ZJhMQisvrqfkxJm6+JOtbWFj8K/luK0rTDmE8Z9n9r6kJ36FnHcLJ5MvvVaBc7n1v1wnzdqXpg==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/core/-/core-18.2.5.tgz",
+      "integrity": "sha512-r9TumPlJ8PvA2+yz4sp+bUHgtznaVKzhvXTN5qL1k4YP8LJ7iZWMR2FOP+HjukHZOTsenzmV9pszbogabqwoZQ==",
       "dev": true,
       "dependencies": {
-        "ajv": "8.16.0",
+        "ajv": "8.17.1",
         "ajv-formats": "3.0.1",
         "jsonc-parser": "3.3.1",
         "picomatch": "4.0.2",
@@ -241,14 +246,14 @@
       }
     },
     "node_modules/@angular-devkit/schematics": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/schematics/-/schematics-18.1.1.tgz",
-      "integrity": "sha512-r+DAvVvv+hOuhh19PefPOKa/zDkvzLHz/YOLGq/k1KfJRtNtjCKiDsXp1s6HSzYdJD1H10wnzUIh48uvxfwH5Q==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/schematics/-/schematics-18.2.5.tgz",
+      "integrity": "sha512-NUmz2UQ1Xl4cf4j1AgkwIfsCjBzAPgfeC3IBrD29hSOBE1Y3j6auqjBkvw50v6mbSPxESND995Xy13HpK1Xflw==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/core": "18.1.1",
+        "@angular-devkit/core": "18.2.5",
         "jsonc-parser": "3.3.1",
-        "magic-string": "0.30.10",
+        "magic-string": "0.30.11",
         "ora": "5.4.1",
         "rxjs": "7.8.1"
       },
@@ -259,9 +264,9 @@
       }
     },
     "node_modules/@angular/animations": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/animations/-/animations-18.1.1.tgz",
-      "integrity": "sha512-3BdB6lB7TT1BQFb8C3XyJ5A9YSrOx951NzcXnzFfTNiq1C+VeR455LtdNiDTPa9Vf5Df1cJb6ReJ1z17ztx+6Q==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/animations/-/animations-18.2.5.tgz",
+      "integrity": "sha512-IlXtW/Nj48ZzjHUzH1TykZcSR64ScJx39T3IHnjV2z/bVATzZ36JGoadQHdqpJNKBodYJNgtJCGLCbgAvGWY2g==",
       "peer": true,
       "dependencies": {
         "tslib": "^2.3.0"
@@ -270,41 +275,39 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "18.1.1"
+        "@angular/core": "18.2.5"
       }
     },
     "node_modules/@angular/build": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/build/-/build-18.1.1.tgz",
-      "integrity": "sha512-DbgFqpaZE6g8VZaPboB54cVuERlZV6SAkNPEaMT/53cnCxL4QdSQs1aT9Wy8G1Ksr4WI5AZMdPic/TVF0KBGGQ==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/build/-/build-18.2.5.tgz",
+      "integrity": "sha512-XWkmjzgeUga0SJ0lYSYcTuYOWTyqcln2mNfBp7Ae/GZ+/7+APbedsIZEiZGZwveOIyOpTM5wguNSoe9khDl5Ig==",
       "dev": true,
       "dependencies": {
         "@ampproject/remapping": "2.3.0",
-        "@angular-devkit/architect": "0.1801.1",
-        "@babel/core": "7.24.7",
+        "@angular-devkit/architect": "0.1802.5",
+        "@babel/core": "7.25.2",
         "@babel/helper-annotate-as-pure": "7.24.7",
         "@babel/helper-split-export-declaration": "7.24.7",
         "@babel/plugin-syntax-import-attributes": "7.24.7",
-        "@inquirer/confirm": "3.1.11",
+        "@inquirer/confirm": "3.1.22",
         "@vitejs/plugin-basic-ssl": "1.1.0",
-        "ansi-colors": "4.1.3",
         "browserslist": "^4.23.0",
         "critters": "0.0.24",
-        "esbuild": "0.21.5",
+        "esbuild": "0.23.0",
         "fast-glob": "3.3.2",
         "https-proxy-agent": "7.0.5",
-        "lmdb": "3.0.12",
-        "magic-string": "0.30.10",
+        "listr2": "8.2.4",
+        "lmdb": "3.0.13",
+        "magic-string": "0.30.11",
         "mrmime": "2.0.0",
-        "ora": "5.4.1",
         "parse5-html-rewriting-stream": "7.0.0",
         "picomatch": "4.0.2",
         "piscina": "4.6.1",
-        "rollup": "4.18.0",
+        "rollup": "4.20.0",
         "sass": "1.77.6",
-        "semver": "7.6.2",
-        "undici": "6.19.2",
-        "vite": "5.3.2",
+        "semver": "7.6.3",
+        "vite": "5.4.6",
         "watchpack": "2.4.1"
       },
       "engines": {
@@ -344,9 +347,9 @@
       }
     },
     "node_modules/@angular/cdk": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/cdk/-/cdk-18.1.1.tgz",
-      "integrity": "sha512-IaDjvRUgAoKnEeafrnBX+hjTR+1M3O3fV3AybBCjN4NuiPtuyOJiTMg0cTv6RbluJ/SenbT4MQq3tMpOsa9i4w==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/cdk/-/cdk-18.2.5.tgz",
+      "integrity": "sha512-HLg5cfrIrgNIJJ+0v3kLieHeLPJLFNOBO359holXOrKUPRG+XQ3CT8EzSvREFm1XkaSEsDC0+dnG0ouNhOPFpQ==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -360,26 +363,26 @@
       }
     },
     "node_modules/@angular/cli": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/cli/-/cli-18.1.1.tgz",
-      "integrity": "sha512-sRmc5meBLRQgFKq6te1UM4JPHWPERrg1pjYStft/qRKkOyvgpNzq3Ol6hN3zNb2ds2bAgjKhEAlOwSOZuw1cqQ==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/cli/-/cli-18.2.5.tgz",
+      "integrity": "sha512-97uNs0HsOdnMaTlNJKFjIBUXw0wz43uYvSSKmIpBt7eq1LaPLju1G/qpDIHx2YwhMClPrXXrW2H/xdvqZiIw+w==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/architect": "0.1801.1",
-        "@angular-devkit/core": "18.1.1",
-        "@angular-devkit/schematics": "18.1.1",
-        "@inquirer/prompts": "5.0.7",
-        "@listr2/prompt-adapter-inquirer": "2.0.13",
-        "@schematics/angular": "18.1.1",
+        "@angular-devkit/architect": "0.1802.5",
+        "@angular-devkit/core": "18.2.5",
+        "@angular-devkit/schematics": "18.2.5",
+        "@inquirer/prompts": "5.3.8",
+        "@listr2/prompt-adapter-inquirer": "2.0.15",
+        "@schematics/angular": "18.2.5",
         "@yarnpkg/lockfile": "1.1.0",
         "ini": "4.1.3",
         "jsonc-parser": "3.3.1",
-        "listr2": "8.2.3",
-        "npm-package-arg": "11.0.2",
-        "npm-pick-manifest": "9.0.1",
+        "listr2": "8.2.4",
+        "npm-package-arg": "11.0.3",
+        "npm-pick-manifest": "9.1.0",
         "pacote": "18.0.6",
         "resolve": "1.22.8",
-        "semver": "7.6.2",
+        "semver": "7.6.3",
         "symbol-observable": "4.0.0",
         "yargs": "17.7.2"
       },
@@ -393,9 +396,9 @@
       }
     },
     "node_modules/@angular/common": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/common/-/common-18.1.1.tgz",
-      "integrity": "sha512-qNfYAapvIi8JyQToSqbg3O5dRXaElv/yNp2evvBGn4UO/liHjdNV/DzgCdyKP7uVbYrR0W3bzj++SxVR3mrATQ==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/common/-/common-18.2.5.tgz",
+      "integrity": "sha512-m+KJrtbFXTE36jP/po6UAMeUR/enQxRHpVGLCRcIcE7VWVH1ZcOvoW1yqh2A6k+KxWXeajlq/Z04nnMhcoxMRw==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -403,14 +406,14 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "18.1.1",
+        "@angular/core": "18.2.5",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@angular/compiler": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/compiler/-/compiler-18.1.1.tgz",
-      "integrity": "sha512-Nc2GZhXXi3O2otZIWgOJoGZ+88+R6YXGc70dibEpMvmDjKfYpc4pBjuYzaGntdiTYAzVOVTTv09dwTP6YOpPRA==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/compiler/-/compiler-18.2.5.tgz",
+      "integrity": "sha512-vcqe9x4dGGAnMfPhEpcZyiSVgAiqJeK80LqP1vWoAmBR+HeOqAilSv6SflcLAtuTzwgzMMAvD2T+SMCgUvaqww==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -418,7 +421,7 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "18.1.1"
+        "@angular/core": "18.2.5"
       },
       "peerDependenciesMeta": {
         "@angular/core": {
@@ -427,12 +430,12 @@
       }
     },
     "node_modules/@angular/compiler-cli": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/compiler-cli/-/compiler-cli-18.1.1.tgz",
-      "integrity": "sha512-TMPrN4HLa5raxW133bY3AxH1Gar36nmy0ikttMeSotLSlC5Y4SCYaiMY7QaPytD1iEGvqAd/rP+YuXzOIuCM/w==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/compiler-cli/-/compiler-cli-18.2.5.tgz",
+      "integrity": "sha512-CCCtZobUTUfId/RTYtuDCw5R1oK0w65hdAUMRP1MdGmd8bb8DKJA86u1QCWwozL3rbXlIIX4ognQ6urQ43k/Gw==",
       "dev": true,
       "dependencies": {
-        "@babel/core": "7.24.7",
+        "@babel/core": "7.25.2",
         "@jridgewell/sourcemap-codec": "^1.4.14",
         "chokidar": "^3.0.0",
         "convert-source-map": "^1.5.1",
@@ -450,14 +453,14 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/compiler": "18.1.1",
+        "@angular/compiler": "18.2.5",
         "typescript": ">=5.4 <5.6"
       }
     },
     "node_modules/@angular/core": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/core/-/core-18.1.1.tgz",
-      "integrity": "sha512-/JFQ49fVIthZzdggl7FOCYAjaynbkRcCyiri85kAyTIvJ6aMSIiEKwJCw45WI5ICf2HtC9kz6dr0OKhMR6SeiA==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/core/-/core-18.2.5.tgz",
+      "integrity": "sha512-5BLVc5gXxzanQkADNS9WPsor3vNF5nQcyIHBi5VScErwM5vVZ7ATH1iZwaOg1ykDEVTFVhKDwD0X1aaqGDbhmQ==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -466,13 +469,13 @@
       },
       "peerDependencies": {
         "rxjs": "^6.5.3 || ^7.4.0",
-        "zone.js": "~0.14.0"
+        "zone.js": "~0.14.10"
       }
     },
     "node_modules/@angular/forms": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/forms/-/forms-18.1.1.tgz",
-      "integrity": "sha512-CceH57IKeH2Zq8QFFkcJMvBbjxVRCtqzAqSETfShWzrt+ITrz4c6EnUMbj30iz+ntn/R+qGAp3n/t0D7HtTS6Q==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/forms/-/forms-18.2.5.tgz",
+      "integrity": "sha512-ohKeH+EZCCIyGSiFYlraWLzssGAZc13P92cuYpXB62322PkcA5u0IT72mML9JWGKRqF2zteVsw4koWHVxXM5mA==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -480,70 +483,22 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "18.1.1",
-        "@angular/core": "18.1.1",
-        "@angular/platform-browser": "18.1.1",
+        "@angular/common": "18.2.5",
+        "@angular/core": "18.2.5",
+        "@angular/platform-browser": "18.2.5",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@angular/material": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/material/-/material-18.1.1.tgz",
-      "integrity": "sha512-9JdUEUZheMMk+Tu8oDLRdI2eXOeI9d2BjEZYkoDif4iB7TCldmcKJyTYXs3kSZz6B53vup/vgKJUPBHLkIDD+A==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/auto-init": "15.0.0-canary.7f224ddd4.0",
-        "@material/banner": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/card": "15.0.0-canary.7f224ddd4.0",
-        "@material/checkbox": "15.0.0-canary.7f224ddd4.0",
-        "@material/chips": "15.0.0-canary.7f224ddd4.0",
-        "@material/circular-progress": "15.0.0-canary.7f224ddd4.0",
-        "@material/data-table": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dialog": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/drawer": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/fab": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/floating-label": "15.0.0-canary.7f224ddd4.0",
-        "@material/form-field": "15.0.0-canary.7f224ddd4.0",
-        "@material/icon-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/image-list": "15.0.0-canary.7f224ddd4.0",
-        "@material/layout-grid": "15.0.0-canary.7f224ddd4.0",
-        "@material/line-ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/linear-progress": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu-surface": "15.0.0-canary.7f224ddd4.0",
-        "@material/notched-outline": "15.0.0-canary.7f224ddd4.0",
-        "@material/radio": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/segmented-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/select": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/slider": "15.0.0-canary.7f224ddd4.0",
-        "@material/snackbar": "15.0.0-canary.7f224ddd4.0",
-        "@material/switch": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-bar": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-scroller": "15.0.0-canary.7f224ddd4.0",
-        "@material/textfield": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/tooltip": "15.0.0-canary.7f224ddd4.0",
-        "@material/top-app-bar": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/material/-/material-18.2.5.tgz",
+      "integrity": "sha512-+Yz8ayKz1ALz2UvPrM33FHSUmrE0GKHn+Gg79l6NdC4eSrzAAYBVdLfQvCBWCgtdvs7IiegbCnnAJiqXVC1DDg==",
+      "dependencies": {
         "tslib": "^2.3.0"
       },
       "peerDependencies": {
         "@angular/animations": "^18.0.0 || ^19.0.0",
-        "@angular/cdk": "18.1.1",
+        "@angular/cdk": "18.2.5",
         "@angular/common": "^18.0.0 || ^19.0.0",
         "@angular/core": "^18.0.0 || ^19.0.0",
         "@angular/forms": "^18.0.0 || ^19.0.0",
@@ -552,9 +507,9 @@
       }
     },
     "node_modules/@angular/platform-browser": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/platform-browser/-/platform-browser-18.1.1.tgz",
-      "integrity": "sha512-9FG2+NSWJXo+zu/W7VQE0UpaWejbV62AXW7218FBZXOdkdID5oNxHf0QdJ3hCaIJw1dKZEG49BTq005d9yQbew==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/platform-browser/-/platform-browser-18.2.5.tgz",
+      "integrity": "sha512-PoX9idwnOpTJBlujzZ2nFGOsmCnZzOH7uNSWIR7trdoq0b1AFXfrxlCQ36qWamk7bbhJI4H28L8YTmKew/nXDA==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -562,9 +517,9 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/animations": "18.1.1",
-        "@angular/common": "18.1.1",
-        "@angular/core": "18.1.1"
+        "@angular/animations": "18.2.5",
+        "@angular/common": "18.2.5",
+        "@angular/core": "18.2.5"
       },
       "peerDependenciesMeta": {
         "@angular/animations": {
@@ -573,9 +528,9 @@
       }
     },
     "node_modules/@angular/platform-browser-dynamic": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/platform-browser-dynamic/-/platform-browser-dynamic-18.1.1.tgz",
-      "integrity": "sha512-+nnWGLz7dhkRbel8qGIgfQa5PoE4ZMl0ClDw8HR0R5T3w+v0K6trPSjWIPDHm5ex25RvuLNmoUGu29drlHN3Fw==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/platform-browser-dynamic/-/platform-browser-dynamic-18.2.5.tgz",
+      "integrity": "sha512-5u0IuAt1r5e2u2vSKhp3phnaf6hH89B/q7GErfPse1sdDfNI6wHVppxai28PAfAj9gwooJun6MjFWhJFLzS44A==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -583,16 +538,16 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "18.1.1",
-        "@angular/compiler": "18.1.1",
-        "@angular/core": "18.1.1",
-        "@angular/platform-browser": "18.1.1"
+        "@angular/common": "18.2.5",
+        "@angular/compiler": "18.2.5",
+        "@angular/core": "18.2.5",
+        "@angular/platform-browser": "18.2.5"
       }
     },
     "node_modules/@angular/router": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@angular/router/-/router-18.1.1.tgz",
-      "integrity": "sha512-XaPL+jzmanQa3y9JSMpyxcTqHTNLiGLW6yzcZ0hiKDRpCJ044cKLMK5Ruk84LfzvVDS//tGj46OYAwrPGmBFMg==",
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@angular/router/-/router-18.2.5.tgz",
+      "integrity": "sha512-OjZV1PTiSwT0ytmR0ykveLYzs4uQWf0EuIclZmWqM/bb8Q4P+gJl7/sya05nGnZsj6nHGOL0e/LhSZ3N+5p6qg==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -600,9 +555,9 @@
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "18.1.1",
-        "@angular/core": "18.1.1",
-        "@angular/platform-browser": "18.1.1",
+        "@angular/common": "18.2.5",
+        "@angular/core": "18.2.5",
+        "@angular/platform-browser": "18.2.5",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
@@ -620,30 +575,30 @@
       }
     },
     "node_modules/@babel/compat-data": {
-      "version": "7.24.9",
-      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.24.9.tgz",
-      "integrity": "sha512-e701mcfApCJqMMueQI0Fb68Amflj83+dvAvHawoBpAz+GDjCIyGHzNwnefjsWJ3xiYAqqiQFoWbspGYBdb2/ng==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.25.4.tgz",
+      "integrity": "sha512-+LGRog6RAsCJrrrg/IO6LGmpphNe5DiK30dGjCoxxeGv49B10/3XYGxPsAwrDlMFcFEvdAUavDT8r9k/hSyQqQ==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/core": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.24.7.tgz",
-      "integrity": "sha512-nykK+LEK86ahTkX/3TgauT0ikKoNCfKHEaZYTUVupJdTLzGNvrblu4u6fa7DhZONAltdf8e662t/abY8idrd/g==",
+      "version": "7.25.2",
+      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.25.2.tgz",
+      "integrity": "sha512-BBt3opiCOxUr9euZ5/ro/Xv8/V7yJ5bjYMqG/C1YAo8MIKAnumZalCN+msbci3Pigy4lIQfPUpfMM27HMGaYEA==",
       "dev": true,
       "dependencies": {
         "@ampproject/remapping": "^2.2.0",
         "@babel/code-frame": "^7.24.7",
-        "@babel/generator": "^7.24.7",
-        "@babel/helper-compilation-targets": "^7.24.7",
-        "@babel/helper-module-transforms": "^7.24.7",
-        "@babel/helpers": "^7.24.7",
-        "@babel/parser": "^7.24.7",
-        "@babel/template": "^7.24.7",
-        "@babel/traverse": "^7.24.7",
-        "@babel/types": "^7.24.7",
+        "@babel/generator": "^7.25.0",
+        "@babel/helper-compilation-targets": "^7.25.2",
+        "@babel/helper-module-transforms": "^7.25.2",
+        "@babel/helpers": "^7.25.0",
+        "@babel/parser": "^7.25.0",
+        "@babel/template": "^7.25.0",
+        "@babel/traverse": "^7.25.2",
+        "@babel/types": "^7.25.2",
         "convert-source-map": "^2.0.0",
         "debug": "^4.1.0",
         "gensync": "^1.0.0-beta.2",
@@ -674,12 +629,12 @@
       }
     },
     "node_modules/@babel/generator": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.24.7.tgz",
-      "integrity": "sha512-oipXieGC3i45Y1A41t4tAqpnEZWgB/lC6Ehh6+rOviR5XWpTtMmLN+fGjz9vOiNRt0p6RtO6DtD0pdU3vpqdSA==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.25.0.tgz",
+      "integrity": "sha512-3LEEcj3PVW8pW2R1SR1M89g/qrYk/m/mB/tLqn7dn4sbBUQyTqnlod+II2U4dqiGtUmkcnAmkMDralTFZttRiw==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.24.7",
+        "@babel/types": "^7.25.0",
         "@jridgewell/gen-mapping": "^0.3.5",
         "@jridgewell/trace-mapping": "^0.3.25",
         "jsesc": "^2.5.1"
@@ -714,12 +669,12 @@
       }
     },
     "node_modules/@babel/helper-compilation-targets": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.24.8.tgz",
-      "integrity": "sha512-oU+UoqCHdp+nWVDkpldqIQL/i/bvAv53tRqLG/s+cOXxe66zOYLU7ar/Xs3LdmBihrUMEUhwu6dMZwbNOYDwvw==",
+      "version": "7.25.2",
+      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.25.2.tgz",
+      "integrity": "sha512-U2U5LsSaZ7TAt3cfaymQ8WHh0pxvdHoEk6HVpaexxixjyEquMh0L0YNJNM6CTGKMXV1iksi0iZkGw4AcFkPaaw==",
       "dev": true,
       "dependencies": {
-        "@babel/compat-data": "^7.24.8",
+        "@babel/compat-data": "^7.25.2",
         "@babel/helper-validator-option": "^7.24.8",
         "browserslist": "^4.23.1",
         "lru-cache": "^5.1.1",
@@ -739,19 +694,17 @@
       }
     },
     "node_modules/@babel/helper-create-class-features-plugin": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/helper-create-class-features-plugin/-/helper-create-class-features-plugin-7.24.8.tgz",
-      "integrity": "sha512-4f6Oqnmyp2PP3olgUMmOwC3akxSm5aBYraQ6YDdKy7NcAMkDECHWG0DEnV6M2UAkERgIBhYt8S27rURPg7SxWA==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/helper-create-class-features-plugin/-/helper-create-class-features-plugin-7.25.4.tgz",
+      "integrity": "sha512-ro/bFs3/84MDgDmMwbcHgDa8/E6J3QKNTk4xJJnVeFtGE+tL0K26E3pNxhYz2b67fJpt7Aphw5XcploKXuCvCQ==",
       "dev": true,
       "dependencies": {
         "@babel/helper-annotate-as-pure": "^7.24.7",
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-function-name": "^7.24.7",
         "@babel/helper-member-expression-to-functions": "^7.24.8",
         "@babel/helper-optimise-call-expression": "^7.24.7",
-        "@babel/helper-replace-supers": "^7.24.7",
+        "@babel/helper-replace-supers": "^7.25.0",
         "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7",
-        "@babel/helper-split-export-declaration": "^7.24.7",
+        "@babel/traverse": "^7.25.4",
         "semver": "^6.3.1"
       },
       "engines": {
@@ -771,9 +724,9 @@
       }
     },
     "node_modules/@babel/helper-create-regexp-features-plugin": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-create-regexp-features-plugin/-/helper-create-regexp-features-plugin-7.24.7.tgz",
-      "integrity": "sha512-03TCmXy2FtXJEZfbXDTSqq1fRJArk7lX9DOFC/47VthYcxyIOx+eXQmdo6DOQvrbpIix+KfXwvuXdFDZHxt+rA==",
+      "version": "7.25.2",
+      "resolved": "https://registry.npmjs.org/@babel/helper-create-regexp-features-plugin/-/helper-create-regexp-features-plugin-7.25.2.tgz",
+      "integrity": "sha512-+wqVGP+DFmqwFD3EH6TMTfUNeqDehV3E/dl+Sd54eaXqm17tEUNbEIn4sVivVowbvUpOtIGxdo3GoXyDH9N/9g==",
       "dev": true,
       "dependencies": {
         "@babel/helper-annotate-as-pure": "^7.24.7",
@@ -812,43 +765,6 @@
         "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
       }
     },
-    "node_modules/@babel/helper-environment-visitor": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-environment-visitor/-/helper-environment-visitor-7.24.7.tgz",
-      "integrity": "sha512-DoiN84+4Gnd0ncbBOM9AZENV4a5ZiL39HYMyZJGZ/AZEykHYdJw0wW3kdcsh9/Kn+BRXHLkkklZ51ecPKmI1CQ==",
-      "dev": true,
-      "dependencies": {
-        "@babel/types": "^7.24.7"
-      },
-      "engines": {
-        "node": ">=6.9.0"
-      }
-    },
-    "node_modules/@babel/helper-function-name": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-function-name/-/helper-function-name-7.24.7.tgz",
-      "integrity": "sha512-FyoJTsj/PEUWu1/TYRiXTIHc8lbw+TDYkZuoE43opPS5TrI7MyONBE1oNvfguEXAD9yhQRrVBnXdXzSLQl9XnA==",
-      "dev": true,
-      "dependencies": {
-        "@babel/template": "^7.24.7",
-        "@babel/types": "^7.24.7"
-      },
-      "engines": {
-        "node": ">=6.9.0"
-      }
-    },
-    "node_modules/@babel/helper-hoist-variables": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-hoist-variables/-/helper-hoist-variables-7.24.7.tgz",
-      "integrity": "sha512-MJJwhkoGy5c4ehfoRyrJ/owKeMl19U54h27YYftT0o2teQ3FJ3nQUf/I3LlJsX4l3qlw7WRXUmiyajvHXoTubQ==",
-      "dev": true,
-      "dependencies": {
-        "@babel/types": "^7.24.7"
-      },
-      "engines": {
-        "node": ">=6.9.0"
-      }
-    },
     "node_modules/@babel/helper-member-expression-to-functions": {
       "version": "7.24.8",
       "resolved": "https://registry.npmjs.org/@babel/helper-member-expression-to-functions/-/helper-member-expression-to-functions-7.24.8.tgz",
@@ -876,16 +792,15 @@
       }
     },
     "node_modules/@babel/helper-module-transforms": {
-      "version": "7.24.9",
-      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.24.9.tgz",
-      "integrity": "sha512-oYbh+rtFKj/HwBQkFlUzvcybzklmVdVV3UU+mN7n2t/q3yGHbuVdNxyFvSBO1tfvjyArpHNcWMAzsSPdyI46hw==",
+      "version": "7.25.2",
+      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.25.2.tgz",
+      "integrity": "sha512-BjyRAbix6j/wv83ftcVJmBt72QtHI56C7JXZoG2xATiLpmoC7dpd8WnkikExHDVPpi/3qCmO6WY1EaXOluiecQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.24.7",
         "@babel/helper-module-imports": "^7.24.7",
         "@babel/helper-simple-access": "^7.24.7",
-        "@babel/helper-split-export-declaration": "^7.24.7",
-        "@babel/helper-validator-identifier": "^7.24.7"
+        "@babel/helper-validator-identifier": "^7.24.7",
+        "@babel/traverse": "^7.25.2"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -916,14 +831,14 @@
       }
     },
     "node_modules/@babel/helper-remap-async-to-generator": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-remap-async-to-generator/-/helper-remap-async-to-generator-7.24.7.tgz",
-      "integrity": "sha512-9pKLcTlZ92hNZMQfGCHImUpDOlAgkkpqalWEeftW5FBya75k8Li2ilerxkM/uBEj01iBZXcCIB/bwvDYgWyibA==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/helper-remap-async-to-generator/-/helper-remap-async-to-generator-7.25.0.tgz",
+      "integrity": "sha512-NhavI2eWEIz/H9dbrG0TuOicDhNexze43i5z7lEqwYm0WEZVTwnPpA0EafUTP7+6/W79HWIP2cTe3Z5NiSTVpw==",
       "dev": true,
       "dependencies": {
         "@babel/helper-annotate-as-pure": "^7.24.7",
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-wrap-function": "^7.24.7"
+        "@babel/helper-wrap-function": "^7.25.0",
+        "@babel/traverse": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -933,14 +848,14 @@
       }
     },
     "node_modules/@babel/helper-replace-supers": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-replace-supers/-/helper-replace-supers-7.24.7.tgz",
-      "integrity": "sha512-qTAxxBM81VEyoAY0TtLrx1oAEJc09ZK67Q9ljQToqCnA+55eNwCORaxlKyu+rNfX86o8OXRUSNUnrtsAZXM9sg==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/helper-replace-supers/-/helper-replace-supers-7.25.0.tgz",
+      "integrity": "sha512-q688zIvQVYtZu+i2PsdIu/uWGRpfxzr5WESsfpShfZECkO+d2o+WROWezCi/Q6kJ0tfPa5+pUGUlfx2HhrA3Bg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-member-expression-to-functions": "^7.24.7",
-        "@babel/helper-optimise-call-expression": "^7.24.7"
+        "@babel/helper-member-expression-to-functions": "^7.24.8",
+        "@babel/helper-optimise-call-expression": "^7.24.7",
+        "@babel/traverse": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1015,28 +930,27 @@
       }
     },
     "node_modules/@babel/helper-wrap-function": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/helper-wrap-function/-/helper-wrap-function-7.24.7.tgz",
-      "integrity": "sha512-N9JIYk3TD+1vq/wn77YnJOqMtfWhNewNE+DJV4puD2X7Ew9J4JvrzrFDfTfyv5EgEXVy9/Wt8QiOErzEmv5Ifw==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/helper-wrap-function/-/helper-wrap-function-7.25.0.tgz",
+      "integrity": "sha512-s6Q1ebqutSiZnEjaofc/UKDyC4SbzV5n5SrA2Gq8UawLycr3i04f1dX4OzoQVnexm6aOCh37SQNYlJ/8Ku+PMQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-function-name": "^7.24.7",
-        "@babel/template": "^7.24.7",
-        "@babel/traverse": "^7.24.7",
-        "@babel/types": "^7.24.7"
+        "@babel/template": "^7.25.0",
+        "@babel/traverse": "^7.25.0",
+        "@babel/types": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helpers": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.24.8.tgz",
-      "integrity": "sha512-gV2265Nkcz7weJJfvDoAEVzC1e2OTDpkGbEsebse8koXUJUXPsCMi7sRo/+SPMuMZ9MtUPnGwITTnQnU5YjyaQ==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.25.6.tgz",
+      "integrity": "sha512-Xg0tn4HcfTijTwfDwYlvVCl43V6h4KyVVX2aEm4qdO/PC6L2YvzLHFdmxhoeSA3eslcE6+ZVXHgWwopXYLNq4Q==",
       "dev": true,
       "dependencies": {
-        "@babel/template": "^7.24.7",
-        "@babel/types": "^7.24.8"
+        "@babel/template": "^7.25.0",
+        "@babel/types": "^7.25.6"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1058,10 +972,13 @@
       }
     },
     "node_modules/@babel/parser": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.24.8.tgz",
-      "integrity": "sha512-WzfbgXOkGzZiXXCqk43kKwZjzwx4oulxZi3nq2TYL9mOjQv6kYwul9mz6ID36njuL7Xkp6nJEfok848Zj10j/w==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.25.6.tgz",
+      "integrity": "sha512-trGdfBdbD0l1ZPmcJ83eNxB9rbEax4ALFTF7fN386TMYbeCQbyme5cOEXQhbGXKebwGaB/J52w1mrklMcbgy6Q==",
       "dev": true,
+      "dependencies": {
+        "@babel/types": "^7.25.6"
+      },
       "bin": {
         "parser": "bin/babel-parser.js"
       },
@@ -1070,13 +987,28 @@
       }
     },
     "node_modules/@babel/plugin-bugfix-firefox-class-in-computed-class-key": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-firefox-class-in-computed-class-key/-/plugin-bugfix-firefox-class-in-computed-class-key-7.24.7.tgz",
-      "integrity": "sha512-TiT1ss81W80eQsN+722OaeQMY/G4yTb4G9JrqeiDADs3N8lbPMGldWi9x8tyqCW5NLx1Jh2AvkE6r6QvEltMMQ==",
+      "version": "7.25.3",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-firefox-class-in-computed-class-key/-/plugin-bugfix-firefox-class-in-computed-class-key-7.25.3.tgz",
+      "integrity": "sha512-wUrcsxZg6rqBXG05HG1FPYgsP6EvwF4WpBbxIpWIIYnH8wG0gzx3yZY3dtEHas4sTAOGkbTsc9EGPxwff8lRoA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/traverse": "^7.25.3"
+      },
+      "engines": {
+        "node": ">=6.9.0"
+      },
+      "peerDependencies": {
+        "@babel/core": "^7.0.0"
+      }
+    },
+    "node_modules/@babel/plugin-bugfix-safari-class-field-initializer-scope": {
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-class-field-initializer-scope/-/plugin-bugfix-safari-class-field-initializer-scope-7.25.0.tgz",
+      "integrity": "sha512-Bm4bH2qsX880b/3ziJ8KD711LT7z4u8CFudmjqle65AZj/HNUFhEf90dqYv6O86buWvSBmeQDjv0Tn2aF/bIBA==",
+      "dev": true,
+      "dependencies": {
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1086,12 +1018,12 @@
       }
     },
     "node_modules/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression/-/plugin-bugfix-safari-id-destructuring-collision-in-function-expression-7.24.7.tgz",
-      "integrity": "sha512-unaQgZ/iRu/By6tsjMZzpeBZjChYfLYry6HrEXPoz3KmfF0sVBQ1l8zKMQ4xRGLWVsjuvB8nQfjNP/DcfEOCsg==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression/-/plugin-bugfix-safari-id-destructuring-collision-in-function-expression-7.25.0.tgz",
+      "integrity": "sha512-lXwdNZtTmeVOOFtwM/WDe7yg1PL8sYhRk/XH0FzbR2HDQ0xC+EnQ/JHeoMYSavtU115tnUk0q9CDyq8si+LMAA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1118,13 +1050,13 @@
       }
     },
     "node_modules/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly/-/plugin-bugfix-v8-static-class-fields-redefine-readonly-7.24.7.tgz",
-      "integrity": "sha512-utA4HuR6F4Vvcr+o4DnjL8fCOlgRFGbeeBEGNg3ZTrLFw6VWG5XmUrvcQ0FjIYMU2ST4XcR2Wsp7t9qOAPnxMg==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly/-/plugin-bugfix-v8-static-class-fields-redefine-readonly-7.25.0.tgz",
+      "integrity": "sha512-tggFrk1AIShG/RUQbEwt2Tr/E+ObkfwrPjR6BjbRvsx24+PSjK8zrq0GWPNCjo8qpRx4DuJzlcvWJqlm+0h3kw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/traverse": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1209,12 +1141,12 @@
       }
     },
     "node_modules/@babel/plugin-syntax-import-assertions": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-assertions/-/plugin-syntax-import-assertions-7.24.7.tgz",
-      "integrity": "sha512-Ec3NRUMoi8gskrkBe3fNmEQfxDvY8bgfQpz6jlk/41kX9eUjvpyqWU7PBP/pLAvMaSQjbMNKJmvX57jP+M6bPg==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-assertions/-/plugin-syntax-import-assertions-7.25.6.tgz",
+      "integrity": "sha512-aABl0jHw9bZ2karQ/uUD6XP4u0SG22SJrOHFoL6XB1R7dTovOP4TzTlsxOYC5yQ1pdscVK2JTUnF6QL3ARoAiQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1396,15 +1328,15 @@
       }
     },
     "node_modules/@babel/plugin-transform-async-generator-functions": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-generator-functions/-/plugin-transform-async-generator-functions-7.24.7.tgz",
-      "integrity": "sha512-o+iF77e3u7ZS4AoAuJvapz9Fm001PuD2V3Lp6OSE4FYQke+cSewYtnek+THqGRWyQloRCyvWL1OkyfNEl9vr/g==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-generator-functions/-/plugin-transform-async-generator-functions-7.25.0.tgz",
+      "integrity": "sha512-uaIi2FdqzjpAMvVqvB51S42oC2JEVgh0LDsGfZVDysWE8LrJtQC2jvKmOqEYThKyB7bDEb7BP1GYWDm7tABA0Q==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7",
-        "@babel/helper-remap-async-to-generator": "^7.24.7",
-        "@babel/plugin-syntax-async-generators": "^7.8.4"
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-remap-async-to-generator": "^7.25.0",
+        "@babel/plugin-syntax-async-generators": "^7.8.4",
+        "@babel/traverse": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1446,12 +1378,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-block-scoping": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoping/-/plugin-transform-block-scoping-7.24.7.tgz",
-      "integrity": "sha512-Nd5CvgMbWc+oWzBsuaMcbwjJWAcp5qzrbg69SZdHSP7AMY0AbWFqFO0WTFCA1jxhMCwodRwvRec8k0QUbZk7RQ==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoping/-/plugin-transform-block-scoping-7.25.0.tgz",
+      "integrity": "sha512-yBQjYoOjXlFv9nlXb3f1casSHOZkWr29NX+zChVanLg5Nc157CrbEX9D7hxxtTpuFy7Q0YzmmWfJxzvps4kXrQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1461,13 +1393,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-class-properties": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-properties/-/plugin-transform-class-properties-7.24.7.tgz",
-      "integrity": "sha512-vKbfawVYayKcSeSR5YYzzyXvsDFWU2mD8U5TFeXtbCPLFUqe7GyCgvO6XDHzje862ODrOwy6WCPmKeWHbCFJ4w==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-properties/-/plugin-transform-class-properties-7.25.4.tgz",
+      "integrity": "sha512-nZeZHyCWPfjkdU5pA/uHiTaDAFUEqkpzf1YoQT2NeSynCGYq9rxfyI3XpQbfx/a0hSnFH6TGlEXvae5Vi7GD8g==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-class-features-plugin": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-create-class-features-plugin": "^7.25.4",
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1494,18 +1426,16 @@
       }
     },
     "node_modules/@babel/plugin-transform-classes": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-classes/-/plugin-transform-classes-7.24.8.tgz",
-      "integrity": "sha512-VXy91c47uujj758ud9wx+OMgheXm4qJfyhj1P18YvlrQkNOSrwsteHk+EFS3OMGfhMhpZa0A+81eE7G4QC+3CA==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-classes/-/plugin-transform-classes-7.25.4.tgz",
+      "integrity": "sha512-oexUfaQle2pF/b6E0dwsxQtAol9TLSO88kQvym6HHBWFliV2lGdrPieX+WgMRLSJDVzdYywk7jXbLPuO2KLTLg==",
       "dev": true,
       "dependencies": {
         "@babel/helper-annotate-as-pure": "^7.24.7",
-        "@babel/helper-compilation-targets": "^7.24.8",
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-function-name": "^7.24.7",
+        "@babel/helper-compilation-targets": "^7.25.2",
         "@babel/helper-plugin-utils": "^7.24.8",
-        "@babel/helper-replace-supers": "^7.24.7",
-        "@babel/helper-split-export-declaration": "^7.24.7",
+        "@babel/helper-replace-supers": "^7.25.0",
+        "@babel/traverse": "^7.25.4",
         "globals": "^11.1.0"
       },
       "engines": {
@@ -1577,6 +1507,22 @@
         "@babel/core": "^7.0.0-0"
       }
     },
+    "node_modules/@babel/plugin-transform-duplicate-named-capturing-groups-regex": {
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-duplicate-named-capturing-groups-regex/-/plugin-transform-duplicate-named-capturing-groups-regex-7.25.0.tgz",
+      "integrity": "sha512-YLpb4LlYSc3sCUa35un84poXoraOiQucUTTu8X1j18JV+gNa8E0nyUf/CjZ171IRGr4jEguF+vzJU66QZhn29g==",
+      "dev": true,
+      "dependencies": {
+        "@babel/helper-create-regexp-features-plugin": "^7.25.0",
+        "@babel/helper-plugin-utils": "^7.24.8"
+      },
+      "engines": {
+        "node": ">=6.9.0"
+      },
+      "peerDependencies": {
+        "@babel/core": "^7.0.0"
+      }
+    },
     "node_modules/@babel/plugin-transform-dynamic-import": {
       "version": "7.24.7",
       "resolved": "https://registry.npmjs.org/@babel/plugin-transform-dynamic-import/-/plugin-transform-dynamic-import-7.24.7.tgz",
@@ -1642,14 +1588,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-function-name": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-function-name/-/plugin-transform-function-name-7.24.7.tgz",
-      "integrity": "sha512-U9FcnA821YoILngSmYkW6FjyQe2TyZD5pHt4EVIhmcTkrJw/3KqcrRSxuOo5tFZJi7TE19iDyI1u+weTI7bn2w==",
+      "version": "7.25.1",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-function-name/-/plugin-transform-function-name-7.25.1.tgz",
+      "integrity": "sha512-TVVJVdW9RKMNgJJlLtHsKDTydjZAbwIsn6ySBPQaEAUU5+gVvlJt/9nRmqVbsV/IBanRjzWoaAQKLoamWVOUuA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-compilation-targets": "^7.24.7",
-        "@babel/helper-function-name": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-compilation-targets": "^7.24.8",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/traverse": "^7.25.1"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1675,12 +1621,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-literals": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-literals/-/plugin-transform-literals-7.24.7.tgz",
-      "integrity": "sha512-vcwCbb4HDH+hWi8Pqenwnjy+UiklO4Kt1vfspcQYFhJdpthSnW8XvWGyDZWKNVrVbVViI/S7K9PDJZiUmP2fYQ==",
+      "version": "7.25.2",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-literals/-/plugin-transform-literals-7.25.2.tgz",
+      "integrity": "sha512-HQI+HcTbm9ur3Z2DkO+jgESMAMcYLuN/A7NRw9juzxAezN9AvqvUTnpKP/9kkYANz6u7dFlAyOu44ejuGySlfw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1754,15 +1700,15 @@
       }
     },
     "node_modules/@babel/plugin-transform-modules-systemjs": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-systemjs/-/plugin-transform-modules-systemjs-7.24.7.tgz",
-      "integrity": "sha512-GYQE0tW7YoaN13qFh3O1NCY4MPkUiAH3fiF7UcV/I3ajmDKEdG3l+UOcbAm4zUE3gnvUU+Eni7XrVKo9eO9auw==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-systemjs/-/plugin-transform-modules-systemjs-7.25.0.tgz",
+      "integrity": "sha512-YPJfjQPDXxyQWg/0+jHKj1llnY5f/R6a0p/vP4lPymxLu7Lvl4k2WMitqi08yxwQcCVUUdG9LCUj4TNEgAp3Jw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-hoist-variables": "^7.24.7",
-        "@babel/helper-module-transforms": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7",
-        "@babel/helper-validator-identifier": "^7.24.7"
+        "@babel/helper-module-transforms": "^7.25.0",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-validator-identifier": "^7.24.7",
+        "@babel/traverse": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1933,13 +1879,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-private-methods": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-methods/-/plugin-transform-private-methods-7.24.7.tgz",
-      "integrity": "sha512-COTCOkG2hn4JKGEKBADkA8WNb35TGkkRbI5iT845dB+NyqgO8Hn+ajPbSnIQznneJTa3d30scb6iz/DhH8GsJQ==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-methods/-/plugin-transform-private-methods-7.25.4.tgz",
+      "integrity": "sha512-ao8BG7E2b/URaUQGqN3Tlsg+M3KlHY6rJ1O1gXAEUnZoyNQnvKyH87Kfg+FoxSeyWUB8ISZZsC91C44ZuBFytw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-class-features-plugin": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-create-class-features-plugin": "^7.25.4",
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2165,13 +2111,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-unicode-sets-regex": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-sets-regex/-/plugin-transform-unicode-sets-regex-7.24.7.tgz",
-      "integrity": "sha512-2G8aAvF4wy1w/AGZkemprdGMRg5o6zPNhbHVImRz3lss55TYCBd6xStN19rt8XJHq20sqV0JbyWjOWwQRwV/wg==",
+      "version": "7.25.4",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-sets-regex/-/plugin-transform-unicode-sets-regex-7.25.4.tgz",
+      "integrity": "sha512-qesBxiWkgN1Q+31xUE9RcMk79eOXXDCv6tfyGMRSs4RGlioSg2WVyQAm07k726cSE56pa+Kb0y9epX2qaXzTvA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7"
+        "@babel/helper-create-regexp-features-plugin": "^7.25.2",
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2181,19 +2127,20 @@
       }
     },
     "node_modules/@babel/preset-env": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/preset-env/-/preset-env-7.24.7.tgz",
-      "integrity": "sha512-1YZNsc+y6cTvWlDHidMBsQZrZfEFjRIo/BZCT906PMdzOyXtSLTgqGdrpcuTDCXyd11Am5uQULtDIcCfnTc8fQ==",
+      "version": "7.25.3",
+      "resolved": "https://registry.npmjs.org/@babel/preset-env/-/preset-env-7.25.3.tgz",
+      "integrity": "sha512-QsYW7UeAaXvLPX9tdVliMJE7MD7M6MLYVTovRTIwhoYQVFHR1rM4wO8wqAezYi3/BpSD+NzVCZ69R6smWiIi8g==",
       "dev": true,
       "dependencies": {
-        "@babel/compat-data": "^7.24.7",
-        "@babel/helper-compilation-targets": "^7.24.7",
-        "@babel/helper-plugin-utils": "^7.24.7",
-        "@babel/helper-validator-option": "^7.24.7",
-        "@babel/plugin-bugfix-firefox-class-in-computed-class-key": "^7.24.7",
-        "@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": "^7.24.7",
+        "@babel/compat-data": "^7.25.2",
+        "@babel/helper-compilation-targets": "^7.25.2",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-validator-option": "^7.24.8",
+        "@babel/plugin-bugfix-firefox-class-in-computed-class-key": "^7.25.3",
+        "@babel/plugin-bugfix-safari-class-field-initializer-scope": "^7.25.0",
+        "@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": "^7.25.0",
         "@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining": "^7.24.7",
-        "@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": "^7.24.7",
+        "@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": "^7.25.0",
         "@babel/plugin-proposal-private-property-in-object": "7.21.0-placeholder-for-preset-env.2",
         "@babel/plugin-syntax-async-generators": "^7.8.4",
         "@babel/plugin-syntax-class-properties": "^7.12.13",
@@ -2214,29 +2161,30 @@
         "@babel/plugin-syntax-top-level-await": "^7.14.5",
         "@babel/plugin-syntax-unicode-sets-regex": "^7.18.6",
         "@babel/plugin-transform-arrow-functions": "^7.24.7",
-        "@babel/plugin-transform-async-generator-functions": "^7.24.7",
+        "@babel/plugin-transform-async-generator-functions": "^7.25.0",
         "@babel/plugin-transform-async-to-generator": "^7.24.7",
         "@babel/plugin-transform-block-scoped-functions": "^7.24.7",
-        "@babel/plugin-transform-block-scoping": "^7.24.7",
+        "@babel/plugin-transform-block-scoping": "^7.25.0",
         "@babel/plugin-transform-class-properties": "^7.24.7",
         "@babel/plugin-transform-class-static-block": "^7.24.7",
-        "@babel/plugin-transform-classes": "^7.24.7",
+        "@babel/plugin-transform-classes": "^7.25.0",
         "@babel/plugin-transform-computed-properties": "^7.24.7",
-        "@babel/plugin-transform-destructuring": "^7.24.7",
+        "@babel/plugin-transform-destructuring": "^7.24.8",
         "@babel/plugin-transform-dotall-regex": "^7.24.7",
         "@babel/plugin-transform-duplicate-keys": "^7.24.7",
+        "@babel/plugin-transform-duplicate-named-capturing-groups-regex": "^7.25.0",
         "@babel/plugin-transform-dynamic-import": "^7.24.7",
         "@babel/plugin-transform-exponentiation-operator": "^7.24.7",
         "@babel/plugin-transform-export-namespace-from": "^7.24.7",
         "@babel/plugin-transform-for-of": "^7.24.7",
-        "@babel/plugin-transform-function-name": "^7.24.7",
+        "@babel/plugin-transform-function-name": "^7.25.1",
         "@babel/plugin-transform-json-strings": "^7.24.7",
-        "@babel/plugin-transform-literals": "^7.24.7",
+        "@babel/plugin-transform-literals": "^7.25.2",
         "@babel/plugin-transform-logical-assignment-operators": "^7.24.7",
         "@babel/plugin-transform-member-expression-literals": "^7.24.7",
         "@babel/plugin-transform-modules-amd": "^7.24.7",
-        "@babel/plugin-transform-modules-commonjs": "^7.24.7",
-        "@babel/plugin-transform-modules-systemjs": "^7.24.7",
+        "@babel/plugin-transform-modules-commonjs": "^7.24.8",
+        "@babel/plugin-transform-modules-systemjs": "^7.25.0",
         "@babel/plugin-transform-modules-umd": "^7.24.7",
         "@babel/plugin-transform-named-capturing-groups-regex": "^7.24.7",
         "@babel/plugin-transform-new-target": "^7.24.7",
@@ -2245,7 +2193,7 @@
         "@babel/plugin-transform-object-rest-spread": "^7.24.7",
         "@babel/plugin-transform-object-super": "^7.24.7",
         "@babel/plugin-transform-optional-catch-binding": "^7.24.7",
-        "@babel/plugin-transform-optional-chaining": "^7.24.7",
+        "@babel/plugin-transform-optional-chaining": "^7.24.8",
         "@babel/plugin-transform-parameters": "^7.24.7",
         "@babel/plugin-transform-private-methods": "^7.24.7",
         "@babel/plugin-transform-private-property-in-object": "^7.24.7",
@@ -2256,7 +2204,7 @@
         "@babel/plugin-transform-spread": "^7.24.7",
         "@babel/plugin-transform-sticky-regex": "^7.24.7",
         "@babel/plugin-transform-template-literals": "^7.24.7",
-        "@babel/plugin-transform-typeof-symbol": "^7.24.7",
+        "@babel/plugin-transform-typeof-symbol": "^7.24.8",
         "@babel/plugin-transform-unicode-escapes": "^7.24.7",
         "@babel/plugin-transform-unicode-property-regex": "^7.24.7",
         "@babel/plugin-transform-unicode-regex": "^7.24.7",
@@ -2265,7 +2213,7 @@
         "babel-plugin-polyfill-corejs2": "^0.4.10",
         "babel-plugin-polyfill-corejs3": "^0.10.4",
         "babel-plugin-polyfill-regenerator": "^0.6.1",
-        "core-js-compat": "^3.31.0",
+        "core-js-compat": "^3.37.1",
         "semver": "^6.3.1"
       },
       "engines": {
@@ -2305,9 +2253,9 @@
       "dev": true
     },
     "node_modules/@babel/runtime": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.24.7.tgz",
-      "integrity": "sha512-UwgBRMjJP+xv857DCngvqXI3Iq6J4v0wXmwc6sapg+zyhbwmQX67LUEFrkK5tbyJ30jGuG3ZvWpBiB9LCy1kWw==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.25.0.tgz",
+      "integrity": "sha512-7dRy4DwXwtzBrPbZflqxnvfxLF8kdZXPkhymtDeFoFqE6ldzjQFgYTtYIFARcLEYDrqfBfYcZt1WqFxRoyC9Rw==",
       "dev": true,
       "dependencies": {
         "regenerator-runtime": "^0.14.0"
@@ -2317,33 +2265,30 @@
       }
     },
     "node_modules/@babel/template": {
-      "version": "7.24.7",
-      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.24.7.tgz",
-      "integrity": "sha512-jYqfPrU9JTF0PmPy1tLYHW4Mp4KlgxJD9l2nP9fD6yT/ICi554DmrWBAEYpIelzjHf1msDP3PxJIRt/nFNfBig==",
+      "version": "7.25.0",
+      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.25.0.tgz",
+      "integrity": "sha512-aOOgh1/5XzKvg1jvVz7AVrx2piJ2XBi227DHmbY6y+bM9H2FlN+IfecYu4Xl0cNiiVejlsCri89LUsbj8vJD9Q==",
       "dev": true,
       "dependencies": {
         "@babel/code-frame": "^7.24.7",
-        "@babel/parser": "^7.24.7",
-        "@babel/types": "^7.24.7"
+        "@babel/parser": "^7.25.0",
+        "@babel/types": "^7.25.0"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/traverse": {
-      "version": "7.24.8",
-      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.24.8.tgz",
-      "integrity": "sha512-t0P1xxAPzEDcEPmjprAQq19NWum4K0EQPjMwZQZbHt+GiZqvjCHjj755Weq1YRPVzBI+3zSfvScfpnuIecVFJQ==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.25.6.tgz",
+      "integrity": "sha512-9Vrcx5ZW6UwK5tvqsj0nGpp/XzqthkT0dqIc9g1AdtygFToNtTF67XzYS//dm+SAK9cp3B9R4ZO/46p63SCjlQ==",
       "dev": true,
       "dependencies": {
         "@babel/code-frame": "^7.24.7",
-        "@babel/generator": "^7.24.8",
-        "@babel/helper-environment-visitor": "^7.24.7",
-        "@babel/helper-function-name": "^7.24.7",
-        "@babel/helper-hoist-variables": "^7.24.7",
-        "@babel/helper-split-export-declaration": "^7.24.7",
-        "@babel/parser": "^7.24.8",
-        "@babel/types": "^7.24.8",
+        "@babel/generator": "^7.25.6",
+        "@babel/parser": "^7.25.6",
+        "@babel/template": "^7.25.0",
+        "@babel/types": "^7.25.6",
         "debug": "^4.3.1",
         "globals": "^11.1.0"
       },
@@ -2352,12 +2297,12 @@
       }
     },
     "node_modules/@babel/traverse/node_modules/@babel/generator": {
-      "version": "7.24.10",
-      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.24.10.tgz",
-      "integrity": "sha512-o9HBZL1G2129luEUlG1hB4N/nlYNWHnpwlND9eOMclRqqu1YDy2sSYVCFUZwl8I1Gxh+QSRrP2vD7EpUmFVXxg==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.25.6.tgz",
+      "integrity": "sha512-VPC82gr1seXOpkjAAKoLhP50vx4vGNlF4msF64dSFq1P8RfB+QAuJWGHPXXPc8QyfVWwwB/TNNU4+ayZmHNbZw==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.24.9",
+        "@babel/types": "^7.25.6",
         "@jridgewell/gen-mapping": "^0.3.5",
         "@jridgewell/trace-mapping": "^0.3.25",
         "jsesc": "^2.5.1"
@@ -2367,9 +2312,9 @@
       }
     },
     "node_modules/@babel/types": {
-      "version": "7.24.9",
-      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.24.9.tgz",
-      "integrity": "sha512-xm8XrMKz0IlUdocVbYJe0Z9xEgidU7msskG8BbhnTPK/HZ2z/7FP7ykqPgrUH+C+r414mNfNWam1f2vqOjqjYQ==",
+      "version": "7.25.6",
+      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.25.6.tgz",
+      "integrity": "sha512-/l42B1qxpG6RdfYf343Uw1vmDjeNhneUXtzhojE7pDgfpEypmRhI6j1kr17XCVv4Cgl9HdAiQY2x0GwKm7rWCw==",
       "dev": true,
       "dependencies": {
         "@babel/helper-string-parser": "^7.24.8",
@@ -2390,18 +2335,18 @@
       }
     },
     "node_modules/@discoveryjs/json-ext": {
-      "version": "0.5.7",
-      "resolved": "https://registry.npmjs.org/@discoveryjs/json-ext/-/json-ext-0.5.7.tgz",
-      "integrity": "sha512-dBVuXR082gk3jsFp7Rd/JI4kytwGHecnCoTtXFb7DB6CNHp4rg5k1bhg0nWdLGLnOV71lmDzGQaLMy8iPLY0pw==",
+      "version": "0.6.1",
+      "resolved": "https://registry.npmjs.org/@discoveryjs/json-ext/-/json-ext-0.6.1.tgz",
+      "integrity": "sha512-boghen8F0Q8D+0/Q1/1r6DUEieUJ8w2a1gIknExMSHBsJFOr2+0KUfHiVYBvucPwl3+RU5PFBK833FjFCh3BhA==",
       "dev": true,
       "engines": {
-        "node": ">=10.0.0"
+        "node": ">=14.17.0"
       }
     },
     "node_modules/@esbuild/aix-ppc64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
-      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.23.0.tgz",
+      "integrity": "sha512-3sG8Zwa5fMcA9bgqB8AfWPQ+HFke6uD3h1s3RIwUNK8EG7a4buxvuFTs3j1IMs2NXAk9F30C/FF4vxRgQCcmoQ==",
       "cpu": [
         "ppc64"
       ],
@@ -2411,13 +2356,13 @@
         "aix"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/android-arm": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
-      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.23.0.tgz",
+      "integrity": "sha512-+KuOHTKKyIKgEEqKbGTK8W7mPp+hKinbMBeEnNzjJGyFcWsfrXjSTNluJHCY1RqhxFurdD8uNXQDei7qDlR6+g==",
       "cpu": [
         "arm"
       ],
@@ -2427,13 +2372,13 @@
         "android"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/android-arm64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
-      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.23.0.tgz",
+      "integrity": "sha512-EuHFUYkAVfU4qBdyivULuu03FhJO4IJN9PGuABGrFy4vUuzk91P2d+npxHcFdpUnfYKy0PuV+n6bKIpHOB3prQ==",
       "cpu": [
         "arm64"
       ],
@@ -2443,13 +2388,13 @@
         "android"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/android-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
-      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.23.0.tgz",
+      "integrity": "sha512-WRrmKidLoKDl56LsbBMhzTTBxrsVwTKdNbKDalbEZr0tcsBgCLbEtoNthOW6PX942YiYq8HzEnb4yWQMLQuipQ==",
       "cpu": [
         "x64"
       ],
@@ -2459,13 +2404,13 @@
         "android"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/darwin-arm64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
-      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.23.0.tgz",
+      "integrity": "sha512-YLntie/IdS31H54Ogdn+v50NuoWF5BDkEUFpiOChVa9UnKpftgwzZRrI4J132ETIi+D8n6xh9IviFV3eXdxfow==",
       "cpu": [
         "arm64"
       ],
@@ -2475,13 +2420,13 @@
         "darwin"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/darwin-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
-      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.23.0.tgz",
+      "integrity": "sha512-IMQ6eme4AfznElesHUPDZ+teuGwoRmVuuixu7sv92ZkdQcPbsNHzutd+rAfaBKo8YK3IrBEi9SLLKWJdEvJniQ==",
       "cpu": [
         "x64"
       ],
@@ -2491,13 +2436,13 @@
         "darwin"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/freebsd-arm64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
-      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.23.0.tgz",
+      "integrity": "sha512-0muYWCng5vqaxobq6LB3YNtevDFSAZGlgtLoAc81PjUfiFz36n4KMpwhtAd4he8ToSI3TGyuhyx5xmiWNYZFyw==",
       "cpu": [
         "arm64"
       ],
@@ -2507,13 +2452,13 @@
         "freebsd"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/freebsd-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
-      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.23.0.tgz",
+      "integrity": "sha512-XKDVu8IsD0/q3foBzsXGt/KjD/yTKBCIwOHE1XwiXmrRwrX6Hbnd5Eqn/WvDekddK21tfszBSrE/WMaZh+1buQ==",
       "cpu": [
         "x64"
       ],
@@ -2523,13 +2468,13 @@
         "freebsd"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-arm": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
-      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.23.0.tgz",
+      "integrity": "sha512-SEELSTEtOFu5LPykzA395Mc+54RMg1EUgXP+iw2SJ72+ooMwVsgfuwXo5Fn0wXNgWZsTVHwY2cg4Vi/bOD88qw==",
       "cpu": [
         "arm"
       ],
@@ -2539,13 +2484,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-arm64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
-      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.23.0.tgz",
+      "integrity": "sha512-j1t5iG8jE7BhonbsEg5d9qOYcVZv/Rv6tghaXM/Ug9xahM0nX/H2gfu6X6z11QRTMT6+aywOMA8TDkhPo8aCGw==",
       "cpu": [
         "arm64"
       ],
@@ -2555,13 +2500,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-ia32": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
-      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.23.0.tgz",
+      "integrity": "sha512-P7O5Tkh2NbgIm2R6x1zGJJsnacDzTFcRWZyTTMgFdVit6E98LTxO+v8LCCLWRvPrjdzXHx9FEOA8oAZPyApWUA==",
       "cpu": [
         "ia32"
       ],
@@ -2571,13 +2516,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-loong64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
-      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.23.0.tgz",
+      "integrity": "sha512-InQwepswq6urikQiIC/kkx412fqUZudBO4SYKu0N+tGhXRWUqAx+Q+341tFV6QdBifpjYgUndV1hhMq3WeJi7A==",
       "cpu": [
         "loong64"
       ],
@@ -2587,13 +2532,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-mips64el": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
-      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.23.0.tgz",
+      "integrity": "sha512-J9rflLtqdYrxHv2FqXE2i1ELgNjT+JFURt/uDMoPQLcjWQA5wDKgQA4t/dTqGa88ZVECKaD0TctwsUfHbVoi4w==",
       "cpu": [
         "mips64el"
       ],
@@ -2603,13 +2548,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-ppc64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
-      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.23.0.tgz",
+      "integrity": "sha512-cShCXtEOVc5GxU0fM+dsFD10qZ5UpcQ8AM22bYj0u/yaAykWnqXJDpd77ublcX6vdDsWLuweeuSNZk4yUxZwtw==",
       "cpu": [
         "ppc64"
       ],
@@ -2619,13 +2564,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-riscv64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
-      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.23.0.tgz",
+      "integrity": "sha512-HEtaN7Y5UB4tZPeQmgz/UhzoEyYftbMXrBCUjINGjh3uil+rB/QzzpMshz3cNUxqXN7Vr93zzVtpIDL99t9aRw==",
       "cpu": [
         "riscv64"
       ],
@@ -2635,13 +2580,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-s390x": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
-      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.23.0.tgz",
+      "integrity": "sha512-WDi3+NVAuyjg/Wxi+o5KPqRbZY0QhI9TjrEEm+8dmpY9Xir8+HE/HNx2JoLckhKbFopW0RdO2D72w8trZOV+Wg==",
       "cpu": [
         "s390x"
       ],
@@ -2651,13 +2596,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/linux-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
-      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.23.0.tgz",
+      "integrity": "sha512-a3pMQhUEJkITgAw6e0bWA+F+vFtCciMjW/LPtoj99MhVt+Mfb6bbL9hu2wmTZgNd994qTAEw+U/r6k3qHWWaOQ==",
       "cpu": [
         "x64"
       ],
@@ -2667,13 +2612,13 @@
         "linux"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/netbsd-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
-      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.23.0.tgz",
+      "integrity": "sha512-cRK+YDem7lFTs2Q5nEv/HHc4LnrfBCbH5+JHu6wm2eP+d8OZNoSMYgPZJq78vqQ9g+9+nMuIsAO7skzphRXHyw==",
       "cpu": [
         "x64"
       ],
@@ -2683,13 +2628,29 @@
         "netbsd"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
+      }
+    },
+    "node_modules/@esbuild/openbsd-arm64": {
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.23.0.tgz",
+      "integrity": "sha512-suXjq53gERueVWu0OKxzWqk7NxiUWSUlrxoZK7usiF50C6ipColGR5qie2496iKGYNLhDZkPxBI3erbnYkU0rQ==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "openbsd"
+      ],
+      "engines": {
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/openbsd-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
-      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.23.0.tgz",
+      "integrity": "sha512-6p3nHpby0DM/v15IFKMjAaayFhqnXV52aEmv1whZHX56pdkK+MEaLoQWj+H42ssFarP1PcomVhbsR4pkz09qBg==",
       "cpu": [
         "x64"
       ],
@@ -2699,13 +2660,13 @@
         "openbsd"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/sunos-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
-      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.23.0.tgz",
+      "integrity": "sha512-BFelBGfrBwk6LVrmFzCq1u1dZbG4zy/Kp93w2+y83Q5UGYF1d8sCzeLI9NXjKyujjBBniQa8R8PzLFAUrSM9OA==",
       "cpu": [
         "x64"
       ],
@@ -2715,13 +2676,13 @@
         "sunos"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/win32-arm64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
-      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.23.0.tgz",
+      "integrity": "sha512-lY6AC8p4Cnb7xYHuIxQ6iYPe6MfO2CC43XXKo9nBXDb35krYt7KGhQnOkRGar5psxYkircpCqfbNDB4uJbS2jQ==",
       "cpu": [
         "arm64"
       ],
@@ -2731,13 +2692,13 @@
         "win32"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/win32-ia32": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
-      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.23.0.tgz",
+      "integrity": "sha512-7L1bHlOTcO4ByvI7OXVI5pNN6HSu6pUQq9yodga8izeuB1KcT2UkHaH6118QJwopExPn0rMHIseCTx1CRo/uNA==",
       "cpu": [
         "ia32"
       ],
@@ -2747,13 +2708,13 @@
         "win32"
       ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/@esbuild/win32-x64": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
-      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.23.0.tgz",
+      "integrity": "sha512-Arm+WgUFLUATuoxCJcahGuk6Yj9Pzxd6l11Zb/2aAuv5kWWvvfhLFo2fni4uSK5vzlUdCGZ/BdV5tH8klj8p8g==",
       "cpu": [
         "x64"
       ],
@@ -2762,44 +2723,20 @@
       "os": [
         "win32"
       ],
-      "engines": {
-        "node": ">=12"
-      }
-    },
-    "node_modules/@inquirer/checkbox": {
-      "version": "2.4.0",
-      "resolved": "https://registry.npmjs.org/@inquirer/checkbox/-/checkbox-2.4.0.tgz",
-      "integrity": "sha512-XHOCmntitRBD8SJcrv+6X9YakxO1wfsvezOnU5MBIXeTlSBRCVk9DOIrx6Cgi9BS3qkcy7oQb+fUGEKrP6xecQ==",
-      "dev": true,
-      "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "ansi-escapes": "^4.3.2",
-        "yoctocolors-cjs": "^2.1.2"
-      },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/checkbox/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+    "node_modules/@inquirer/checkbox": {
+      "version": "2.5.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/checkbox/-/checkbox-2.5.0.tgz",
+      "integrity": "sha512-sMgdETOfi2dUHT8r7TT1BTKOwNvdDGFDXYWtQ2J69SvlYNntk9I/gJe7r5yvMwwsuKnYbuRs3pNhx4tgNck5aA==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/figures": "^1.0.5",
+        "@inquirer/type": "^1.5.3",
         "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
         "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
@@ -2807,112 +2744,75 @@
       }
     },
     "node_modules/@inquirer/confirm": {
-      "version": "3.1.11",
-      "resolved": "https://registry.npmjs.org/@inquirer/confirm/-/confirm-3.1.11.tgz",
-      "integrity": "sha512-3wWw10VPxQP279FO4bzWsf8YjIAq7NdwATJ4xS2h1uwsXZu/RmtOVV95rZ7yllS1h/dzu+uLewjMAzNDEj8h2w==",
+      "version": "3.1.22",
+      "resolved": "https://registry.npmjs.org/@inquirer/confirm/-/confirm-3.1.22.tgz",
+      "integrity": "sha512-gsAKIOWBm2Q87CDfs9fEo7wJT3fwWIJfnDGMn9Qy74gBnNFOACDNfhUzovubbJjWnKLGBln7/NcSmZwj5DuEXg==",
       "dev": true,
       "dependencies": {
-        "@inquirer/core": "^8.2.4",
-        "@inquirer/type": "^1.3.3"
+        "@inquirer/core": "^9.0.10",
+        "@inquirer/type": "^1.5.2"
       },
       "engines": {
         "node": ">=18"
       }
     },
     "node_modules/@inquirer/core": {
-      "version": "8.2.4",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-8.2.4.tgz",
-      "integrity": "sha512-7vsXSfxtrrbwMTirfaKwPcjqJy7pzeuF/bP62yo1NQrRJ5HjmMlrhZml/Ljm9ODc1RnbhJlTeSnCkjtFddKjwA==",
+      "version": "9.2.1",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.2.1.tgz",
+      "integrity": "sha512-F2VBt7W/mwqEU4bL0RnHNZmC/OxzNx9cOYxHqnXX3MP6ruYvZUZAW9imgN9+h/uBT/oP8Gh888J2OZSbjSeWcg==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.3",
-        "@inquirer/type": "^1.3.3",
+        "@inquirer/figures": "^1.0.6",
+        "@inquirer/type": "^2.0.0",
         "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.9",
+        "@types/node": "^22.5.5",
         "@types/wrap-ansi": "^3.0.0",
         "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
         "cli-width": "^4.1.0",
         "mute-stream": "^1.0.0",
-        "picocolors": "^1.0.1",
         "signal-exit": "^4.1.0",
         "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0"
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/editor": {
-      "version": "2.1.15",
-      "resolved": "https://registry.npmjs.org/@inquirer/editor/-/editor-2.1.15.tgz",
-      "integrity": "sha512-UmtZnY36rGLS/4cCzvdRmk0xxsGgH2AsF0v1SSlBZ3C5JK/Bxm2gNW8fmUVzQ5vm8kpdWASXPapbUx4iV49ScA==",
+    "node_modules/@inquirer/core/node_modules/@inquirer/type": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/type/-/type-2.0.0.tgz",
+      "integrity": "sha512-XvJRx+2KR3YXyYtPUUy+qd9i7p+GO9Ko6VIIpWlBrpWwXDv8WLFeHTxz35CfQFUiBMLXlGHhGzys7lqit9gWag==",
       "dev": true,
       "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/type": "^1.5.0",
-        "external-editor": "^3.1.0"
+        "mute-stream": "^1.0.0"
       },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/editor/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+    "node_modules/@inquirer/editor": {
+      "version": "2.2.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/editor/-/editor-2.2.0.tgz",
+      "integrity": "sha512-9KHOpJ+dIL5SZli8lJ6xdaYLPPzB8xB9GZItg39MBybzhxA16vxmszmQFrRwbOA918WA2rvu8xhDEg/p6LXKbw==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
-        "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
-        "yoctocolors-cjs": "^2.1.2"
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3",
+        "external-editor": "^3.1.0"
       },
       "engines": {
         "node": ">=18"
       }
     },
     "node_modules/@inquirer/expand": {
-      "version": "2.1.15",
-      "resolved": "https://registry.npmjs.org/@inquirer/expand/-/expand-2.1.15.tgz",
-      "integrity": "sha512-aBnnrBw9vbFJROUlDCsbq8H/plX6JHfPwLmSphxaVqOR+b1hgLdw+oRhZkpcJhG2AZOlc8IKzGdZhji93gQg4w==",
-      "dev": true,
-      "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/type": "^1.5.0",
-        "yoctocolors-cjs": "^2.1.2"
-      },
-      "engines": {
-        "node": ">=18"
-      }
-    },
-    "node_modules/@inquirer/expand/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/expand/-/expand-2.3.0.tgz",
+      "integrity": "sha512-qnJsUcOGCSG1e5DTOErmv2BPQqrtT6uzqn1vI/aYGiPKq+FgslGZmtdnXbhuI7IlT7OByDoEEqdnhUnVR2hhLw==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
-        "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3",
         "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
@@ -2920,140 +2820,98 @@
       }
     },
     "node_modules/@inquirer/figures": {
-      "version": "1.0.4",
-      "resolved": "https://registry.npmjs.org/@inquirer/figures/-/figures-1.0.4.tgz",
-      "integrity": "sha512-R7Gsg6elpuqdn55fBH2y9oYzrU/yKrSmIsDX4ROT51vohrECFzTf2zw9BfUbOW8xjfmM2QbVoVYdTwhrtEKWSQ==",
+      "version": "1.0.6",
+      "resolved": "https://registry.npmjs.org/@inquirer/figures/-/figures-1.0.6.tgz",
+      "integrity": "sha512-yfZzps3Cso2UbM7WlxKwZQh2Hs6plrbjs1QnzQDZhK2DgyCo6D8AaHps9olkNcUFlcYERMqU3uJSp1gmy3s/qQ==",
       "dev": true,
       "engines": {
         "node": ">=18"
       }
     },
     "node_modules/@inquirer/input": {
-      "version": "2.2.2",
-      "resolved": "https://registry.npmjs.org/@inquirer/input/-/input-2.2.2.tgz",
-      "integrity": "sha512-VjkzYSVH0606nLi9HHiSb4QYs2idwRgneiMoFoTAIwQ1Qwx6OIDugOYLtLta3gP8AWZx7qUvgDtj+/SJuiiKuQ==",
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/input/-/input-2.3.0.tgz",
+      "integrity": "sha512-XfnpCStx2xgh1LIRqPXrTNEEByqQWoxsWYzNRSEUxJ5c6EQlhMogJ3vHKu8aXuTacebtaZzMAHwEL0kAflKOBw==",
       "dev": true,
       "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/type": "^1.5.0"
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3"
       },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/input/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+    "node_modules/@inquirer/number": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/number/-/number-1.1.0.tgz",
+      "integrity": "sha512-ilUnia/GZUtfSZy3YEErXLJ2Sljo/mf9fiKc08n18DdwdmDbOzRcTv65H1jjDvlsAuvdFXf4Sa/aL7iw/NanVA==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
-        "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
-        "yoctocolors-cjs": "^2.1.2"
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3"
       },
       "engines": {
         "node": ">=18"
       }
     },
     "node_modules/@inquirer/password": {
-      "version": "2.1.15",
-      "resolved": "https://registry.npmjs.org/@inquirer/password/-/password-2.1.15.tgz",
-      "integrity": "sha512-/JmiTtIcSYbZdPucEW5q2rhC71vGKPivm3LFqNDQEI6lJyffq7hlfKKFC+R1Qp19dMqkaG+O5L1XmcHpmlAUUQ==",
+      "version": "2.2.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/password/-/password-2.2.0.tgz",
+      "integrity": "sha512-5otqIpgsPYIshqhgtEwSspBQE40etouR8VIxzpJkv9i0dVHIpyhiivbkH9/dGiMLdyamT54YRdGJLfl8TFnLHg==",
       "dev": true,
       "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/type": "^1.5.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3",
         "ansi-escapes": "^4.3.2"
       },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/password/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
-      "dev": true,
-      "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
-        "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
-        "yoctocolors-cjs": "^2.1.2"
-      },
-      "engines": {
-        "node": ">=18"
-      }
-    },
     "node_modules/@inquirer/prompts": {
-      "version": "5.0.7",
-      "resolved": "https://registry.npmjs.org/@inquirer/prompts/-/prompts-5.0.7.tgz",
-      "integrity": "sha512-GFcigCxJTKCH3aECzMIu4FhgLJWnFvMXzpI4CCSoELWFtkOOU2P+goYA61+OKpGrB8fPE7q6n8zAXBSlZRrHjQ==",
+      "version": "5.3.8",
+      "resolved": "https://registry.npmjs.org/@inquirer/prompts/-/prompts-5.3.8.tgz",
+      "integrity": "sha512-b2BudQY/Si4Y2a0PdZZL6BeJtl8llgeZa7U2j47aaJSCeAl1e4UI7y8a9bSkO3o/ZbZrgT5muy/34JbsjfIWxA==",
       "dev": true,
       "dependencies": {
-        "@inquirer/checkbox": "^2.3.7",
-        "@inquirer/confirm": "^3.1.11",
-        "@inquirer/editor": "^2.1.11",
-        "@inquirer/expand": "^2.1.11",
-        "@inquirer/input": "^2.1.11",
-        "@inquirer/password": "^2.1.11",
-        "@inquirer/rawlist": "^2.1.11",
-        "@inquirer/select": "^2.3.7"
+        "@inquirer/checkbox": "^2.4.7",
+        "@inquirer/confirm": "^3.1.22",
+        "@inquirer/editor": "^2.1.22",
+        "@inquirer/expand": "^2.1.22",
+        "@inquirer/input": "^2.2.9",
+        "@inquirer/number": "^1.0.10",
+        "@inquirer/password": "^2.1.22",
+        "@inquirer/rawlist": "^2.2.4",
+        "@inquirer/search": "^1.0.7",
+        "@inquirer/select": "^2.4.7"
       },
       "engines": {
         "node": ">=18"
       }
     },
     "node_modules/@inquirer/rawlist": {
-      "version": "2.1.15",
-      "resolved": "https://registry.npmjs.org/@inquirer/rawlist/-/rawlist-2.1.15.tgz",
-      "integrity": "sha512-zwU6aWDMyuQNiY5Z0iYXkxi7pliRFXqUmiS7vG6lAGxqcbOSptYgIxGJnd3AU4Y91N0Tbt57+koJL0S2p6vSkA==",
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/rawlist/-/rawlist-2.3.0.tgz",
+      "integrity": "sha512-zzfNuINhFF7OLAtGHfhwOW2TlYJyli7lOUoJUXw/uyklcwalV6WRXBXtFIicN8rTRK1XTiPWB4UY+YuW8dsnLQ==",
       "dev": true,
       "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/type": "^1.5.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/type": "^1.5.3",
         "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
         "node": ">=18"
       }
     },
-    "node_modules/@inquirer/rawlist/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+    "node_modules/@inquirer/search": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/search/-/search-1.1.0.tgz",
+      "integrity": "sha512-h+/5LSj51dx7hp5xOn4QFnUaKeARwUCLs6mIhtkJ0JYPBLmEYjdHSYh7I6GrLg9LwpJ3xeX0FZgAG1q0QdCpVQ==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
-        "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/figures": "^1.0.5",
+        "@inquirer/type": "^1.5.3",
         "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
@@ -3061,39 +2919,15 @@
       }
     },
     "node_modules/@inquirer/select": {
-      "version": "2.4.0",
-      "resolved": "https://registry.npmjs.org/@inquirer/select/-/select-2.4.0.tgz",
-      "integrity": "sha512-iU1eRkHirVNs43zWk6anMIMKc7tCXlJ+I5DcpIV7JzMe+45TuPPOGGCgeGIkZ4xYJ3cXdFoh7GJpm84PNC8veg==",
-      "dev": true,
-      "dependencies": {
-        "@inquirer/core": "^9.0.3",
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "ansi-escapes": "^4.3.2",
-        "yoctocolors-cjs": "^2.1.2"
-      },
-      "engines": {
-        "node": ">=18"
-      }
-    },
-    "node_modules/@inquirer/select/node_modules/@inquirer/core": {
-      "version": "9.0.3",
-      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
-      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "version": "2.5.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/select/-/select-2.5.0.tgz",
+      "integrity": "sha512-YmDobTItPP3WcEI86GvPo+T2sRHkxxOq/kXmsBjHS5BVXUgvgZ5AfJjkvQvZr03T81NnI3KrrRuMzeuYUQRFOA==",
       "dev": true,
       "dependencies": {
-        "@inquirer/figures": "^1.0.4",
-        "@inquirer/type": "^1.5.0",
-        "@types/mute-stream": "^0.0.4",
-        "@types/node": "^20.14.11",
-        "@types/wrap-ansi": "^3.0.0",
+        "@inquirer/core": "^9.1.0",
+        "@inquirer/figures": "^1.0.5",
+        "@inquirer/type": "^1.5.3",
         "ansi-escapes": "^4.3.2",
-        "cli-spinners": "^2.9.2",
-        "cli-width": "^4.1.0",
-        "mute-stream": "^1.0.0",
-        "signal-exit": "^4.1.0",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0",
         "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
@@ -3101,9 +2935,9 @@
       }
     },
     "node_modules/@inquirer/type": {
-      "version": "1.5.0",
-      "resolved": "https://registry.npmjs.org/@inquirer/type/-/type-1.5.0.tgz",
-      "integrity": "sha512-L/UdayX9Z1lLN+itoTKqJ/X4DX5DaWu2Sruwt4XgZzMNv32x4qllbzMX4MbJlz0yxAQtU19UvABGOjmdq1u3qA==",
+      "version": "1.5.5",
+      "resolved": "https://registry.npmjs.org/@inquirer/type/-/type-1.5.5.tgz",
+      "integrity": "sha512-MzICLu4yS7V8AA61sANROZ9vT1H3ooca5dSmI1FjZkzq7o/koMsRfQSzRtFo+F3Ao4Sf1C0bpLKejpKB/+j6MA==",
       "dev": true,
       "dependencies": {
         "mute-stream": "^1.0.0"
@@ -3130,9 +2964,9 @@
       }
     },
     "node_modules/@isaacs/cliui/node_modules/ansi-regex": {
-      "version": "6.0.1",
-      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
-      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.1.0.tgz",
+      "integrity": "sha512-7HSX4QQb4CspciLpVFwyRe79O3xsIZDDLER21kERQ71oaPodF8jL725AgJMFAYbooIqolJoRLuM81SpeUkpkvA==",
       "dev": true,
       "engines": {
         "node": ">=12"
@@ -3292,9 +3126,9 @@
       }
     },
     "node_modules/@jsonjoy.com/json-pack": {
-      "version": "1.0.4",
-      "resolved": "https://registry.npmjs.org/@jsonjoy.com/json-pack/-/json-pack-1.0.4.tgz",
-      "integrity": "sha512-aOcSN4MeAtFROysrbqG137b7gaDDSmVrl5mpo6sT/w+kcXpWnzhMjmY/Fh/sDx26NBxyIE7MB1seqLeCAzy9Sg==",
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/@jsonjoy.com/json-pack/-/json-pack-1.1.0.tgz",
+      "integrity": "sha512-zlQONA+msXPPwHWZMKFVS78ewFczIll5lXiVPwFPCZUsrOKdxc2AvxU1HoNBmMRhqDZUR9HkC3UOm+6pME6Xsg==",
       "dev": true,
       "dependencies": {
         "@jsonjoy.com/base64": "^1.1.1",
@@ -3314,9 +3148,9 @@
       }
     },
     "node_modules/@jsonjoy.com/util": {
-      "version": "1.2.0",
-      "resolved": "https://registry.npmjs.org/@jsonjoy.com/util/-/util-1.2.0.tgz",
-      "integrity": "sha512-4B8B+3vFsY4eo33DMKyJPlQ3sBMpPFUZK2dr3O3rXrOGKKbYG44J0XSFkDo1VOQiri5HFEhIeVvItjR2xcazmg==",
+      "version": "1.3.0",
+      "resolved": "https://registry.npmjs.org/@jsonjoy.com/util/-/util-1.3.0.tgz",
+      "integrity": "sha512-Cebt4Vk7k1xHy87kHY7KSPLT77A7Ev7IfOblyLZhtYEhrdQ6fX4EoLq3xOQ3O/DRMEh2ok5nyC180E+ABS8Wmw==",
       "dev": true,
       "engines": {
         "node": ">=10.0"
@@ -3336,12 +3170,12 @@
       "dev": true
     },
     "node_modules/@listr2/prompt-adapter-inquirer": {
-      "version": "2.0.13",
-      "resolved": "https://registry.npmjs.org/@listr2/prompt-adapter-inquirer/-/prompt-adapter-inquirer-2.0.13.tgz",
-      "integrity": "sha512-nAl6teTt7EWSjttNavAnv3uFR3w3vPP3OTYmHyPNHzKhAj2NoBDHmbS3MGpvvO8KXXPASnHjEGrrKrdKTMKPnQ==",
+      "version": "2.0.15",
+      "resolved": "https://registry.npmjs.org/@listr2/prompt-adapter-inquirer/-/prompt-adapter-inquirer-2.0.15.tgz",
+      "integrity": "sha512-MZrGem/Ujjd4cPTLYDfCZK2iKKeiO/8OX13S6jqxldLs0Prf2aGqVlJ77nMBqMv7fzqgXEgjrNHLXcKR8l9lOg==",
       "dev": true,
       "dependencies": {
-        "@inquirer/type": "^1.3.3"
+        "@inquirer/type": "^1.5.1"
       },
       "engines": {
         "node": ">=18.0.0"
@@ -3351,9 +3185,9 @@
       }
     },
     "node_modules/@lmdb/lmdb-darwin-arm64": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-arm64/-/lmdb-darwin-arm64-3.0.12.tgz",
-      "integrity": "sha512-vgTwzNUD3Hy4aqtGhX2+nV/usI0mwy3hDRuTjs8VcK0BLiMVEpNQXgzwlWEgPmA8AAPloUgyOs2nK5clJF5oIg==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-arm64/-/lmdb-darwin-arm64-3.0.13.tgz",
+      "integrity": "sha512-uiKPB0Fv6WEEOZjruu9a6wnW/8jrjzlZbxXscMB8kuCJ1k6kHpcBnuvaAWcqhbI7rqX5GKziwWEdD+wi2gNLfA==",
       "cpu": [
         "arm64"
       ],
@@ -3364,9 +3198,9 @@
       ]
     },
     "node_modules/@lmdb/lmdb-darwin-x64": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-x64/-/lmdb-darwin-x64-3.0.12.tgz",
-      "integrity": "sha512-qOt0hAhj2ZLY6aEWu85rzt5zcyCAQITMhCMEPNlo1tuYekpVAdkQNiwXxEkCjBYvwTskvXuwXOOUpjuSc+aJnA==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-x64/-/lmdb-darwin-x64-3.0.13.tgz",
+      "integrity": "sha512-bEVIIfK5mSQoG1R19qA+fJOvCB+0wVGGnXHT3smchBVahYBdlPn2OsZZKzlHWfb1E+PhLBmYfqB5zQXFP7hJig==",
       "cpu": [
         "x64"
       ],
@@ -3377,9 +3211,9 @@
       ]
     },
     "node_modules/@lmdb/lmdb-linux-arm": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm/-/lmdb-linux-arm-3.0.12.tgz",
-      "integrity": "sha512-Ggd/UXpE+alMncbELCXA3OKpDj9bDBR3qVO7WRTxstloDglRAHfZmUJgTkeaNKjFO1JHqS7AKy0jba9XebZB1w==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm/-/lmdb-linux-arm-3.0.13.tgz",
+      "integrity": "sha512-Yml1KlMzOnXj/tnW7yX8U78iAzTk39aILYvCPbqeewAq1kSzl+w59k/fiVkTBfvDi/oW/5YRxL+Fq+Y1Fr1r2Q==",
       "cpu": [
         "arm"
       ],
@@ -3390,9 +3224,9 @@
       ]
     },
     "node_modules/@lmdb/lmdb-linux-arm64": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm64/-/lmdb-linux-arm64-3.0.12.tgz",
-      "integrity": "sha512-Qy4cFXFe9h1wAWMsojex8x1ifvw2kqiZv686YiRTdQEzAfc3vJASHFcD/QejHUCx7YHMYdnUoCS45rG2AiGDTQ==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm64/-/lmdb-linux-arm64-3.0.13.tgz",
+      "integrity": "sha512-afbVrsMgZ9dUTNUchFpj5VkmJRxvht/u335jUJ7o23YTbNbnpmXif3VKQGCtnjSh+CZaqm6N3CPG8KO3zwyZ1Q==",
       "cpu": [
         "arm64"
       ],
@@ -3403,9 +3237,9 @@
       ]
     },
     "node_modules/@lmdb/lmdb-linux-x64": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-x64/-/lmdb-linux-x64-3.0.12.tgz",
-      "integrity": "sha512-c+noT9IofktxktFllKHFmci8ka2SYGSLN17pj/KSl1hg7mmfAiGp4xxFxEwMLTb+SX95vP1DFiR++1I3WLVxvA==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-x64/-/lmdb-linux-x64-3.0.13.tgz",
+      "integrity": "sha512-vOtxu0xC0SLdQ2WRXg8Qgd8T32ak4SPqk5zjItRszrJk2BdeXqfGxBJbP7o4aOvSPSmSSv46Lr1EP4HXU8v7Kg==",
       "cpu": [
         "x64"
       ],
@@ -3416,9 +3250,9 @@
       ]
     },
     "node_modules/@lmdb/lmdb-win32-x64": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-win32-x64/-/lmdb-win32-x64-3.0.12.tgz",
-      "integrity": "sha512-CO3MFV8gUx16NU/CyyuumAKblESwvoGVA2XhQKZ976OTOxaTbb8F8D3f0iiZ4MYqsN74jIrFuCmXpPnpjbhfOQ==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-win32-x64/-/lmdb-win32-x64-3.0.13.tgz",
+      "integrity": "sha512-UCrMJQY/gJnOl3XgbWRZZUvGGBuKy6i0YNSptgMzHBjs+QYDYR1Mt/RLTOPy4fzzves65O1EDmlL//OzEqoLlA==",
       "cpu": [
         "x64"
       ],
@@ -3428,790 +3262,564 @@
         "win32"
       ]
     },
-    "node_modules/@material/animation": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/animation/-/animation-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-1GSJaPKef+7HRuV+HusVZHps64cmZuOItDbt40tjJVaikcaZvwmHlcTxRIqzcRoCdt5ZKHh3NoO7GB9Khg4Jnw==",
-      "dependencies": {
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/auto-init": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/auto-init/-/auto-init-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-t7ZGpRJ3ec0QDUO0nJu/SMgLW7qcuG2KqIsEYD1Ej8qhI2xpdR2ydSDQOkVEitXmKoGol1oq4nYSBjTlB65GqA==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-arm64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-arm64/-/msgpackr-extract-darwin-arm64-3.0.3.tgz",
+      "integrity": "sha512-QZHtlVgbAdy2zAqNA9Gu1UpIuI8Xvsd1v8ic6B2pZmeFnFcMWiPLfWXh7TVw4eGEZ/C9TH281KwhVoeQUKbyjw==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
     },
-    "node_modules/@material/banner": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/banner/-/banner-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-g9wBUZzYBizyBcBQXTIafnRUUPi7efU9gPJfzeGgkynXiccP/vh5XMmH+PBxl5v+4MlP/d4cZ2NUYoAN7UTqSA==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-x64/-/msgpackr-extract-darwin-x64-3.0.3.tgz",
+      "integrity": "sha512-mdzd3AVzYKuUmiWOQ8GNhl64/IoFGol569zNRdkLReh6LRLHOXxU4U8eq0JwaD8iFHdVGqSy4IjFL4reoWCDFw==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
     },
-    "node_modules/@material/base": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/base/-/base-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-I9KQOKXpLfJkP8MqZyr8wZIzdPHrwPjFvGd9zSK91/vPyE4hzHRJc/0njsh9g8Lm9PRYLbifXX+719uTbHxx+A==",
-      "dependencies": {
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm/-/msgpackr-extract-linux-arm-3.0.3.tgz",
+      "integrity": "sha512-fg0uy/dG/nZEXfYilKoRe7yALaNmHoYeIoJuJ7KJ+YyU2bvY8vPv27f7UKhGRpY6euFYqEVhxCFZgAUNQBM3nw==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/button": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/button/-/button-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-BHB7iyHgRVH+JF16+iscR+Qaic+p7LU1FOLgP8KucRlpF9tTwIxQA6mJwGRi5gUtcG+vyCmzVS+hIQ6DqT/7BA==",
-      "dependencies": {
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm64/-/msgpackr-extract-linux-arm64-3.0.3.tgz",
+      "integrity": "sha512-YxQL+ax0XqBJDZiKimS2XQaf+2wDGVa1enVRGzEvLLVFeqa5kx2bWbtcSXgsxjQB7nRqqIGFIcLteF/sHeVtQg==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/card": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/card/-/card-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-kt7y9/IWOtJTr3Z/AoWJT3ZLN7CLlzXhx2udCLP9ootZU2bfGK0lzNwmo80bv/pJfrY9ihQKCtuGTtNxUy+vIw==",
-      "dependencies": {
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-x64/-/msgpackr-extract-linux-x64-3.0.3.tgz",
+      "integrity": "sha512-cvwNfbP07pKUfq1uH+S6KJ7dT9K8WOE4ZiAcsrSes+UY55E/0jLYc+vq+DO7jlmqRb5zAggExKm0H7O/CBaesg==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/checkbox": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/checkbox/-/checkbox-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-rURcrL5O1u6hzWR+dNgiQ/n89vk6tdmdP3mZgnxJx61q4I/k1yijKqNJSLrkXH7Rto3bM5NRKMOlgvMvVd7UMQ==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@msgpackr-extract/msgpackr-extract-win32-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-win32-x64/-/msgpackr-extract-win32-x64-3.0.3.tgz",
+      "integrity": "sha512-x0fWaQtYp4E6sktbsdAqnehxDgEc/VwM7uLsRCYWaiGu0ykYdZPiS8zCWdnjHwyiumousxfBm4SO31eXqwEZhQ==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "win32"
+      ]
     },
-    "node_modules/@material/chips": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/chips/-/chips-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-AYAivV3GSk/T/nRIpH27sOHFPaSMrE3L0WYbnb5Wa93FgY8a0fbsFYtSH2QmtwnzXveg+B1zGTt7/xIIcynKdQ==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/checkbox": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "safevalues": "^0.3.4",
-        "tslib": "^2.1.0"
+    "node_modules/@ngtools/webpack": {
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@ngtools/webpack/-/webpack-18.2.5.tgz",
+      "integrity": "sha512-L0n4eHObeqEOYRfSP+e4SeF/dmwxOIFy9xYvYCOUwOLrW4b3+a1+kkT30pqyfL72LFtpf0cmUwaWEFIcWl5PCg==",
+      "dev": true,
+      "engines": {
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
+        "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
+        "yarn": ">= 1.13.0"
+      },
+      "peerDependencies": {
+        "@angular/compiler-cli": "^18.0.0",
+        "typescript": ">=5.4 <5.6",
+        "webpack": "^5.54.0"
       }
     },
-    "node_modules/@material/circular-progress": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/circular-progress/-/circular-progress-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-DJrqCKb+LuGtjNvKl8XigvyK02y36GRkfhMUYTcJEi3PrOE00bwXtyj7ilhzEVshQiXg6AHGWXtf5UqwNrx3Ow==",
+    "node_modules/@nodelib/fs.scandir": {
+      "version": "2.1.5",
+      "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
+      "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/progress-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "@nodelib/fs.stat": "2.0.5",
+        "run-parallel": "^1.1.9"
+      },
+      "engines": {
+        "node": ">= 8"
       }
     },
-    "node_modules/@material/data-table": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/data-table/-/data-table-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-/2WZsuBIq9z9RWYF5Jo6b7P6u0fwit+29/mN7rmAZ6akqUR54nXyNfoSNiyydMkzPlZZsep5KrSHododDhBZbA==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/checkbox": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/icon-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/linear-progress": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/select": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@nodelib/fs.stat": {
+      "version": "2.0.5",
+      "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
+      "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
+      "dev": true,
+      "engines": {
+        "node": ">= 8"
       }
     },
-    "node_modules/@material/density": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/density/-/density-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-o9EXmGKVpiQ6mHhyV3oDDzc78Ow3E7v8dlaOhgaDSXgmqaE8v5sIlLNa/LKSyUga83/fpGk3QViSGXotpQx0jA==",
+    "node_modules/@nodelib/fs.walk": {
+      "version": "1.2.8",
+      "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
+      "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
+      "dev": true,
       "dependencies": {
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/dialog": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/dialog/-/dialog-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-u0XpTlv1JqWC/bQ3DavJ1JguofTelLT2wloj59l3/1b60jv42JQ6Am7jU3I8/SIUB1MKaW7dYocXjDWtWJakLA==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/icon-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/dom": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/dom/-/dom-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-mQ1HT186GPQSkRg5S18i70typ5ZytfjL09R0gJ2Qg5/G+MLCGi7TAjZZSH65tuD/QGOjel4rDdWOTmYbPYV6HA==",
-      "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/drawer": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/drawer/-/drawer-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-qyO0W0KBftfH8dlLR0gVAgv7ZHNvU8ae11Ao6zJif/YxcvK4+gph1z8AO4H410YmC2kZiwpSKyxM1iQCCzbb4g==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "@nodelib/fs.scandir": "2.1.5",
+        "fastq": "^1.6.0"
+      },
+      "engines": {
+        "node": ">= 8"
       }
     },
-    "node_modules/@material/elevation": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/elevation/-/elevation-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-tV6s4/pUBECedaI36Yj18KmRCk1vfue/JP/5yYRlFNnLMRVISePbZaKkn/BHXVf+26I3W879+XqIGlDVdmOoMA==",
+    "node_modules/@npmcli/agent": {
+      "version": "2.2.2",
+      "resolved": "https://registry.npmjs.org/@npmcli/agent/-/agent-2.2.2.tgz",
+      "integrity": "sha512-OrcNPXdpSl9UX7qPVRWbmWMCSXrcDa2M9DvrbOTj7ao1S4PlqVFYv9/yLKMkrJKZ/V5A/kDBC690or307i26Og==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/fab": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/fab/-/fab-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-4h76QrzfZTcPdd+awDPZ4Q0YdSqsXQnS540TPtyXUJ/5G99V6VwGpjMPIxAsW0y+pmI9UkLL/srrMaJec+7r4Q==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "agent-base": "^7.1.0",
+        "http-proxy-agent": "^7.0.0",
+        "https-proxy-agent": "^7.0.1",
+        "lru-cache": "^10.0.1",
+        "socks-proxy-agent": "^8.0.3"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/feature-targeting": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/feature-targeting/-/feature-targeting-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-SAjtxYh6YlKZriU83diDEQ7jNSP2MnxKsER0TvFeyG1vX/DWsUyYDOIJTOEa9K1N+fgJEBkNK8hY55QhQaspew==",
-      "dependencies": {
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@npmcli/agent/node_modules/lru-cache": {
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
-    "node_modules/@material/floating-label": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/floating-label/-/floating-label-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-0KMo5ijjYaEHPiZ2pCVIcbaTS2LycvH9zEhEMKwPPGssBCX7iz5ffYQFk7e5yrQand1r3jnQQgYfHAwtykArnQ==",
+    "node_modules/@npmcli/fs": {
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/@npmcli/fs/-/fs-3.1.1.tgz",
+      "integrity": "sha512-q9CRWjpHCMIh5sVyefoD1cA7PkvILqCZsnSOEUUivORLjxCO/Irmue2DprETiNgEqktDBZaM1Bi+jrarx1XdCg==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "semver": "^7.3.5"
+      },
+      "engines": {
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/focus-ring": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/focus-ring/-/focus-ring-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-Jmg1nltq4J6S6A10EGMZnvufrvU3YTi+8R8ZD9lkSbun0Fm2TVdICQt/Auyi6An9zP66oQN6c31eqO6KfIPsDg==",
+    "node_modules/@npmcli/git": {
+      "version": "5.0.8",
+      "resolved": "https://registry.npmjs.org/@npmcli/git/-/git-5.0.8.tgz",
+      "integrity": "sha512-liASfw5cqhjNW9UFd+ruwwdEf/lbOAQjLL2XY2dFW/bkJheXDYZgOyul/4gVvEV4BWkTXjYGmDqMw9uegdbJNQ==",
+      "dev": true,
       "dependencies": {
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0"
+        "@npmcli/promise-spawn": "^7.0.0",
+        "ini": "^4.1.3",
+        "lru-cache": "^10.0.1",
+        "npm-pick-manifest": "^9.0.0",
+        "proc-log": "^4.0.0",
+        "promise-inflight": "^1.0.1",
+        "promise-retry": "^2.0.1",
+        "semver": "^7.3.5",
+        "which": "^4.0.0"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/form-field": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/form-field/-/form-field-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-fEPWgDQEPJ6WF7hNnIStxucHR9LE4DoDSMqCsGWS2Yu+NLZYLuCEecgR0UqQsl1EQdNRaFh8VH93KuxGd2hiPg==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/git/node_modules/isexe": {
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
+      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+      "dev": true,
+      "engines": {
+        "node": ">=16"
       }
     },
-    "node_modules/@material/icon-button": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/icon-button/-/icon-button-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-DcK7IL4ICY/DW+48YQZZs9g0U1kRaW0Wb0BxhvppDMYziHo/CTpFdle4gjyuTyRxPOdHQz5a97ru48Z9O4muTw==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@npmcli/git/node_modules/lru-cache": {
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
-    "node_modules/@material/image-list": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/image-list/-/image-list-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-voMjG2p80XbjL1B2lmF65zO5gEgJOVKClLdqh4wbYzYfwY/SR9c8eLvlYG7DLdFaFBl/7gGxD8TvvZ329HUFPw==",
+    "node_modules/@npmcli/git/node_modules/which": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
+      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
+      "dev": true,
       "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "isexe": "^3.1.1"
+      },
+      "bin": {
+        "node-which": "bin/which.js"
+      },
+      "engines": {
+        "node": "^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/layout-grid": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/layout-grid/-/layout-grid-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-veDABLxMn2RmvfnUO2RUmC1OFfWr4cU+MrxKPoDD2hl3l3eDYv5fxws6r5T1JoSyXoaN+oEZpheS0+M9Ure8Pg==",
+    "node_modules/@npmcli/installed-package-contents": {
+      "version": "2.1.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/installed-package-contents/-/installed-package-contents-2.1.0.tgz",
+      "integrity": "sha512-c8UuGLeZpm69BryRykLuKRyKFZYJsZSCT4aVY5ds4omyZqJ172ApzgfKJ5eV/r3HgLdUYgFVe54KSFVjKoe27w==",
+      "dev": true,
       "dependencies": {
-        "tslib": "^2.1.0"
+        "npm-bundled": "^3.0.0",
+        "npm-normalize-package-bin": "^3.0.0"
+      },
+      "bin": {
+        "installed-package-contents": "bin/index.js"
+      },
+      "engines": {
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/line-ripple": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/line-ripple/-/line-ripple-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-f60hVJhIU6I3/17Tqqzch1emUKEcfVVgHVqADbU14JD+oEIz429ZX9ksZ3VChoU3+eejFl+jVdZMLE/LrAuwpg==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/node-gyp": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/node-gyp/-/node-gyp-3.0.0.tgz",
+      "integrity": "sha512-gp8pRXC2oOxu0DUE1/M3bYtb1b3/DbJ5aM113+XJBgfXdussRAsX0YOrOhdd8WvnAR6auDBvJomGAkLKA5ydxA==",
+      "dev": true,
+      "engines": {
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/linear-progress": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/linear-progress/-/linear-progress-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-pRDEwPQielDiC9Sc5XhCXrGxP8wWOnAO8sQlMebfBYHYqy5hhiIzibezS8CSaW4MFQFyXmCmpmqWlbqGYRmiyg==",
+    "node_modules/@npmcli/package-json": {
+      "version": "5.2.1",
+      "resolved": "https://registry.npmjs.org/@npmcli/package-json/-/package-json-5.2.1.tgz",
+      "integrity": "sha512-f7zYC6kQautXHvNbLEWgD/uGu1+xCn9izgqBfgItWSx22U0ZDekxN08A1vM8cTxj/cRVe0Q94Ode+tdoYmIOOQ==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/progress-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/list": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/list/-/list-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-Is0NV91sJlXF5pOebYAtWLF4wU2MJDbYqztML/zQNENkQxDOvEXu3nWNb3YScMIYJJXvARO0Liur5K4yPagS1Q==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "@npmcli/git": "^5.0.0",
+        "glob": "^10.2.2",
+        "hosted-git-info": "^7.0.0",
+        "json-parse-even-better-errors": "^3.0.0",
+        "normalize-package-data": "^6.0.0",
+        "proc-log": "^4.0.0",
+        "semver": "^7.5.3"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/menu": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/menu/-/menu-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-D11QU1dXqLbh5X1zKlEhS3QWh0b5BPNXlafc5MXfkdJHhOiieb7LC9hMJhbrHtj24FadJ7evaFW/T2ugJbJNnQ==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu-surface": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/package-json/node_modules/brace-expansion": {
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
+      "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
+      "dev": true,
+      "dependencies": {
+        "balanced-match": "^1.0.0"
       }
     },
-    "node_modules/@material/menu-surface": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/menu-surface/-/menu-surface-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-7RZHvw0gbwppaAJ/Oh5SWmfAKJ62aw1IMB3+3MRwsb5PLoV666wInYa+zJfE4i7qBeOn904xqT2Nko5hY0ssrg==",
+    "node_modules/@npmcli/package-json/node_modules/glob": {
+      "version": "10.4.5",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
+      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "foreground-child": "^3.1.0",
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
+      },
+      "bin": {
+        "glob": "dist/esm/bin.mjs"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/@material/notched-outline": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/notched-outline/-/notched-outline-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-Yg2usuKB2DKlKIBISbie9BFsOVuffF71xjbxPbybvqemxqUBd+bD5/t6H1fLE+F8/NCu5JMigho4ewUU+0RCiw==",
+    "node_modules/@npmcli/package-json/node_modules/minimatch": {
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
+      "dev": true,
       "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/floating-label": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "brace-expansion": "^2.0.1"
+      },
+      "engines": {
+        "node": ">=16 || 14 >=14.17"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/@material/progress-indicator": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/progress-indicator/-/progress-indicator-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-UPbDjE5CqT+SqTs0mNFG6uFEw7wBlgYmh+noSkQ6ty/EURm8lF125dmi4dv4kW0+octonMXqkGtAoZwLIHKf/w==",
+    "node_modules/@npmcli/promise-spawn": {
+      "version": "7.0.2",
+      "resolved": "https://registry.npmjs.org/@npmcli/promise-spawn/-/promise-spawn-7.0.2.tgz",
+      "integrity": "sha512-xhfYPXoV5Dy4UkY0D+v2KkwvnDfiA/8Mt3sWCGI/hM03NsYIH8ZaG6QzS9x7pje5vHZBZJ2v6VRFVTWACnqcmQ==",
+      "dev": true,
       "dependencies": {
-        "tslib": "^2.1.0"
+        "which": "^4.0.0"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/radio": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/radio/-/radio-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-wR1X0Sr0KmQLu6+YOFKAI84G3L6psqd7Kys5kfb8WKBM36zxO5HQXC5nJm/Y0rdn22ixzsIz2GBo0MNU4V4k1A==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/promise-spawn/node_modules/isexe": {
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
+      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+      "dev": true,
+      "engines": {
+        "node": ">=16"
       }
     },
-    "node_modules/@material/ripple": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/ripple/-/ripple-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-JqOsWM1f4aGdotP0rh1vZlPZTg6lZgh39FIYHFMfOwfhR+LAikUJ+37ciqZuewgzXB6iiRO6a8aUH6HR5SJYPg==",
+    "node_modules/@npmcli/promise-spawn/node_modules/which": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
+      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
+      "dev": true,
       "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "isexe": "^3.1.1"
+      },
+      "bin": {
+        "node-which": "bin/which.js"
+      },
+      "engines": {
+        "node": "^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/rtl": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/rtl/-/rtl-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-UVf14qAtmPiaaZjuJtmN36HETyoKWmsZM/qn1L5ciR2URb8O035dFWnz4ZWFMmAYBno/L7JiZaCkPurv2ZNrGA==",
-      "dependencies": {
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/redact": {
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/@npmcli/redact/-/redact-2.0.1.tgz",
+      "integrity": "sha512-YgsR5jCQZhVmTJvjduTOIHph0L73pK8xwMVaDY0PatySqVM9AZj93jpoXYSJqfHFxFkN9dmqTw6OiqExsS3LPw==",
+      "dev": true,
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/segmented-button": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/segmented-button/-/segmented-button-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-LCnVRUSAhELTKI/9hSvyvIvQIpPpqF29BV+O9yM4WoNNmNWqTulvuiv7grHZl6Z+kJuxSg4BGbsPxxb9dXozPg==",
+    "node_modules/@npmcli/run-script": {
+      "version": "8.1.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/run-script/-/run-script-8.1.0.tgz",
+      "integrity": "sha512-y7efHHwghQfk28G2z3tlZ67pLG0XdfYbcVG26r7YIXALRsrVQcTq4/tdenSmdOrEsNahIYA/eh8aEVROWGFUDg==",
+      "dev": true,
       "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "@npmcli/node-gyp": "^3.0.0",
+        "@npmcli/package-json": "^5.0.0",
+        "@npmcli/promise-spawn": "^7.0.0",
+        "node-gyp": "^10.0.0",
+        "proc-log": "^4.0.0",
+        "which": "^4.0.0"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/select": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/select/-/select-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-WioZtQEXRpglum0cMSzSqocnhsGRr+ZIhvKb3FlaNrTaK8H3Y4QA7rVjv3emRtrLOOjaT6/RiIaUMTo9AGzWQQ==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/floating-label": "15.0.0-canary.7f224ddd4.0",
-        "@material/line-ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu-surface": "15.0.0-canary.7f224ddd4.0",
-        "@material/notched-outline": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@npmcli/run-script/node_modules/isexe": {
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
+      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+      "dev": true,
+      "engines": {
+        "node": ">=16"
       }
     },
-    "node_modules/@material/shape": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/shape/-/shape-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-8z8l1W3+cymObunJoRhwFPKZ+FyECfJ4MJykNiaZq7XJFZkV6xNmqAVrrbQj93FtLsECn9g4PjjIomguVn/OEw==",
+    "node_modules/@npmcli/run-script/node_modules/which": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
+      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
+      "dev": true,
       "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+        "isexe": "^3.1.1"
+      },
+      "bin": {
+        "node-which": "bin/which.js"
+      },
+      "engines": {
+        "node": "^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/@material/slider": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/slider/-/slider-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-QU/WSaSWlLKQRqOhJrPgm29wqvvzRusMqwAcrCh1JTrCl+xwJ43q5WLDfjYhubeKtrEEgGu9tekkAiYfMG7EBw==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
+    "node_modules/@pkgjs/parseargs": {
+      "version": "0.11.0",
+      "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
+      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
+      "dev": true,
+      "optional": true,
+      "engines": {
+        "node": ">=14"
       }
     },
-    "node_modules/@material/snackbar": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/snackbar/-/snackbar-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-sm7EbVKddaXpT/aXAYBdPoN0k8yeg9+dprgBUkrdqGzWJAeCkxb4fv2B3He88YiCtvkTz2KLY4CThPQBSEsMFQ==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/icon-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/switch": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/switch/-/switch-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-lEDJfRvkVyyeHWIBfoxYjJVl+WlEAE2kZ/+6OqB1FW0OV8ftTODZGhHRSzjVBA1/p4FPuhAtKtoK9jTpa4AZjA==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "safevalues": "^0.3.4",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/tab": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tab/-/tab-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-E1xGACImyCLurhnizyOTCgOiVezce4HlBFAI6YhJo/AyVwjN2Dtas4ZLQMvvWWqpyhITNkeYdOchwCC1mrz3AQ==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/focus-ring": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
-    },
-    "node_modules/@material/tab-bar": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tab-bar/-/tab-bar-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-p1Asb2NzrcECvAQU3b2SYrpyJGyJLQWR+nXTYzDKE8WOpLIRCXap2audNqD7fvN/A20UJ1J8U01ptrvCkwJ4eA==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-scroller": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-android-arm-eabi": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.20.0.tgz",
+      "integrity": "sha512-TSpWzflCc4VGAUJZlPpgAJE1+V60MePDQnBd7PPkpuEmOy8i87aL6tinFGKBFKuEDikYpig72QzdT3QPYIi+oA==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "android"
+      ]
     },
-    "node_modules/@material/tab-indicator": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tab-indicator/-/tab-indicator-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-h9Td3MPqbs33spcPS7ecByRHraYgU4tNCZpZzZXw31RypjKvISDv/PS5wcA4RmWqNGih78T7xg4QIGsZg4Pk4w==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-android-arm64": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.20.0.tgz",
+      "integrity": "sha512-u00Ro/nok7oGzVuh/FMYfNoGqxU5CPWz1mxV85S2w9LxHR8OoMQBuSk+3BKVIDYgkpeOET5yXkx90OYFc+ytpQ==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "android"
+      ]
     },
-    "node_modules/@material/tab-scroller": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tab-scroller/-/tab-scroller-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-LFeYNjQpdXecwECd8UaqHYbhscDCwhGln5Yh+3ctvcEgvmDPNjhKn/DL3sWprWvG8NAhP6sHMrsGhQFVdCWtTg==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-darwin-arm64": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.20.0.tgz",
+      "integrity": "sha512-uFVfvzvsdGtlSLuL0ZlvPJvl6ZmrH4CBwLGEFPe7hUmf7htGAN+aXo43R/V6LATyxlKVC/m6UsLb7jbG+LG39Q==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
     },
-    "node_modules/@material/textfield": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/textfield/-/textfield-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-AExmFvgE5nNF0UA4l2cSzPghtxSUQeeoyRjFLHLy+oAaE4eKZFrSy0zEpqPeWPQpEMDZk+6Y+6T3cOFYBeSvsw==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/floating-label": "15.0.0-canary.7f224ddd4.0",
-        "@material/line-ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/notched-outline": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-darwin-x64": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.20.0.tgz",
+      "integrity": "sha512-xbrMDdlev53vNXexEa6l0LffojxhqDTBeL+VUxuuIXys4x6xyvbKq5XqTXBCEUA8ty8iEJblHvFaWRJTk/icAQ==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
     },
-    "node_modules/@material/theme": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/theme/-/theme-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-hs45hJoE9yVnoVOcsN1jklyOa51U4lzWsEnQEuJTPOk2+0HqCQ0yv/q0InpSnm2i69fNSyZC60+8HADZGF8ugQ==",
-      "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.20.0.tgz",
+      "integrity": "sha512-jMYvxZwGmoHFBTbr12Xc6wOdc2xA5tF5F2q6t7Rcfab68TT0n+r7dgawD4qhPEvasDsVpQi+MgDzj2faOLsZjA==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/tokens": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tokens/-/tokens-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-r9TDoicmcT7FhUXC4eYMFnt9TZsz0G8T3wXvkKncLppYvZ517gPyD/1+yhuGfGOxAzxTrM66S/oEc1fFE2q4hw==",
-      "dependencies": {
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0"
-      }
+    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.20.0.tgz",
+      "integrity": "sha512-1asSTl4HKuIHIB1GcdFHNNZhxAYEdqML/MW4QmPS4G0ivbEcBr1JKlFLKsIRqjSwOBkdItn3/ZDlyvZ/N6KPlw==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/tooltip": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/tooltip/-/tooltip-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-8qNk3pmPLTnam3XYC1sZuplQXW9xLn4Z4MI3D+U17Q7pfNZfoOugGr+d2cLA9yWAEjVJYB0mj8Yu86+udo4N9w==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "safevalues": "^0.3.4",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-linux-arm64-gnu": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.20.0.tgz",
+      "integrity": "sha512-COBb8Bkx56KldOYJfMf6wKeYJrtJ9vEgBRAOkfw6Ens0tnmzPqvlpjZiLgkhg6cA3DGzCmLmmd319pmHvKWWlQ==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/top-app-bar": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/top-app-bar/-/top-app-bar-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-SARR5/ClYT4CLe9qAXakbr0i0cMY0V3V4pe3ElIJPfL2Z2c4wGR1mTR8m2LxU1MfGKK8aRoUdtfKaxWejp+eNA==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-linux-arm64-musl": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.20.0.tgz",
+      "integrity": "sha512-+it+mBSyMslVQa8wSPvBx53fYuZK/oLTu5RJoXogjk6x7Q7sz1GNRsXWjn6SwyJm8E/oMjNVwPhmNdIjwP135Q==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/touch-target": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/touch-target/-/touch-target-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-BJo/wFKHPYLGsRaIpd7vsQwKr02LtO2e89Psv0on/p0OephlNIgeB9dD9W+bQmaeZsZ6liKSKRl6wJWDiK71PA==",
-      "dependencies": {
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-linux-powerpc64le-gnu": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-powerpc64le-gnu/-/rollup-linux-powerpc64le-gnu-4.20.0.tgz",
+      "integrity": "sha512-yAMvqhPfGKsAxHN8I4+jE0CpLWD8cv4z7CK7BMmhjDuz606Q2tFKkWRY8bHR9JQXYcoLfopo5TTqzxgPUjUMfw==",
+      "cpu": [
+        "ppc64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@material/typography": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/typography/-/typography-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-kBaZeCGD50iq1DeRRH5OM5Jl7Gdk+/NOfKArkY4ksBZvJiStJ7ACAhpvb8MEGm4s3jvDInQFLsDq3hL+SA79sQ==",
-      "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.20.0.tgz",
+      "integrity": "sha512-qmuxFpfmi/2SUkAw95TtNq/w/I7Gpjurx609OOOV7U4vhvUhBcftcmXwl3rqAek+ADBwSjIC4IVNLiszoj3dPA==",
+      "cpu": [
+        "riscv64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-arm64": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-arm64/-/msgpackr-extract-darwin-arm64-3.0.3.tgz",
-      "integrity": "sha512-QZHtlVgbAdy2zAqNA9Gu1UpIuI8Xvsd1v8ic6B2pZmeFnFcMWiPLfWXh7TVw4eGEZ/C9TH281KwhVoeQUKbyjw==",
+    "node_modules/@rollup/rollup-linux-s390x-gnu": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.20.0.tgz",
+      "integrity": "sha512-I0BtGXddHSHjV1mqTNkgUZLnS3WtsqebAXv11D5BZE/gfw5KoyXSAXVqyJximQXNvNzUo4GKlCK/dIwXlz+jlg==",
       "cpu": [
-        "arm64"
+        "s390x"
       ],
       "dev": true,
       "optional": true,
       "os": [
-        "darwin"
+        "linux"
       ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-x64": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-x64/-/msgpackr-extract-darwin-x64-3.0.3.tgz",
-      "integrity": "sha512-mdzd3AVzYKuUmiWOQ8GNhl64/IoFGol569zNRdkLReh6LRLHOXxU4U8eq0JwaD8iFHdVGqSy4IjFL4reoWCDFw==",
+    "node_modules/@rollup/rollup-linux-x64-gnu": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.20.0.tgz",
+      "integrity": "sha512-y+eoL2I3iphUg9tN9GB6ku1FA8kOfmF4oUEWhztDJ4KXJy1agk/9+pejOuZkNFhRwHAOxMsBPLbXPd6mJiCwew==",
       "cpu": [
         "x64"
       ],
       "dev": true,
       "optional": true,
       "os": [
-        "darwin"
+        "linux"
       ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm/-/msgpackr-extract-linux-arm-3.0.3.tgz",
-      "integrity": "sha512-fg0uy/dG/nZEXfYilKoRe7yALaNmHoYeIoJuJ7KJ+YyU2bvY8vPv27f7UKhGRpY6euFYqEVhxCFZgAUNQBM3nw==",
+    "node_modules/@rollup/rollup-linux-x64-musl": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.20.0.tgz",
+      "integrity": "sha512-hM3nhW40kBNYUkZb/r9k2FKK+/MnKglX7UYd4ZUy5DJs8/sMsIbqWK2piZtVGE3kcXVNj3B2IrUYROJMMCikNg==",
       "cpu": [
-        "arm"
+        "x64"
       ],
       "dev": true,
       "optional": true,
@@ -4219,36 +3827,36 @@
         "linux"
       ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm64": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm64/-/msgpackr-extract-linux-arm64-3.0.3.tgz",
-      "integrity": "sha512-YxQL+ax0XqBJDZiKimS2XQaf+2wDGVa1enVRGzEvLLVFeqa5kx2bWbtcSXgsxjQB7nRqqIGFIcLteF/sHeVtQg==",
+    "node_modules/@rollup/rollup-win32-arm64-msvc": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.20.0.tgz",
+      "integrity": "sha512-psegMvP+Ik/Bg7QRJbv8w8PAytPA7Uo8fpFjXyCRHWm6Nt42L+JtoqH8eDQ5hRP7/XW2UiIriy1Z46jf0Oa1kA==",
       "cpu": [
         "arm64"
       ],
       "dev": true,
       "optional": true,
       "os": [
-        "linux"
+        "win32"
       ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-linux-x64": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-x64/-/msgpackr-extract-linux-x64-3.0.3.tgz",
-      "integrity": "sha512-cvwNfbP07pKUfq1uH+S6KJ7dT9K8WOE4ZiAcsrSes+UY55E/0jLYc+vq+DO7jlmqRb5zAggExKm0H7O/CBaesg==",
+    "node_modules/@rollup/rollup-win32-ia32-msvc": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.20.0.tgz",
+      "integrity": "sha512-GabekH3w4lgAJpVxkk7hUzUf2hICSQO0a/BLFA11/RMxQT92MabKAqyubzDZmMOC/hcJNlc+rrypzNzYl4Dx7A==",
       "cpu": [
-        "x64"
+        "ia32"
       ],
       "dev": true,
       "optional": true,
       "os": [
-        "linux"
+        "win32"
       ]
     },
-    "node_modules/@msgpackr-extract/msgpackr-extract-win32-x64": {
-      "version": "3.0.3",
-      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-win32-x64/-/msgpackr-extract-win32-x64-3.0.3.tgz",
-      "integrity": "sha512-x0fWaQtYp4E6sktbsdAqnehxDgEc/VwM7uLsRCYWaiGu0ykYdZPiS8zCWdnjHwyiumousxfBm4SO31eXqwEZhQ==",
+    "node_modules/@rollup/rollup-win32-x64-msvc": {
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.20.0.tgz",
+      "integrity": "sha512-aJ1EJSuTdGnM6qbVC4B5DSmozPTqIag9fSzXRNNo+humQLG89XpPgdt16Ia56ORD7s+H8Pmyx44uczDQ0yDzpg==",
       "cpu": [
         "x64"
       ],
@@ -4258,185 +3866,137 @@
         "win32"
       ]
     },
-    "node_modules/@ngtools/webpack": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@ngtools/webpack/-/webpack-18.1.1.tgz",
-      "integrity": "sha512-mjlfnWcHtBZJUJaVyffJZZL8U1o1XUQwrFIKeiFUeatLDsjtv8EbLW9Ed1v3eAJyVuaTNKpsdZma1XdxzeLONw==",
+    "node_modules/@schematics/angular": {
+      "version": "18.2.5",
+      "resolved": "https://registry.npmjs.org/@schematics/angular/-/angular-18.2.5.tgz",
+      "integrity": "sha512-tBXhk9OGT4U6VsBNbuCNl2ITDOF3NYdGrEieIHU+lHSkpJNGZUIGxCgXCETXkmXDq1pe4wFZSKelWjeqYDfX0g==",
       "dev": true,
+      "dependencies": {
+        "@angular-devkit/core": "18.2.5",
+        "@angular-devkit/schematics": "18.2.5",
+        "jsonc-parser": "3.3.1"
+      },
       "engines": {
         "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
-      },
-      "peerDependencies": {
-        "@angular/compiler-cli": "^18.0.0",
-        "typescript": ">=5.4 <5.6",
-        "webpack": "^5.54.0"
       }
     },
-    "node_modules/@nodelib/fs.scandir": {
-      "version": "2.1.5",
-      "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
-      "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
+    "node_modules/@sigstore/bundle": {
+      "version": "2.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/bundle/-/bundle-2.3.2.tgz",
+      "integrity": "sha512-wueKWDk70QixNLB363yHc2D2ItTgYiMTdPwK8D9dKQMR3ZQ0c35IxP5xnwQ8cNLoCgCRcHf14kE+CLIvNX1zmA==",
       "dev": true,
       "dependencies": {
-        "@nodelib/fs.stat": "2.0.5",
-        "run-parallel": "^1.1.9"
+        "@sigstore/protobuf-specs": "^0.3.2"
       },
       "engines": {
-        "node": ">= 8"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@nodelib/fs.stat": {
-      "version": "2.0.5",
-      "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
-      "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
+    "node_modules/@sigstore/core": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/@sigstore/core/-/core-1.1.0.tgz",
+      "integrity": "sha512-JzBqdVIyqm2FRQCulY6nbQzMpJJpSiJ8XXWMhtOX9eKgaXXpfNOF53lzQEjIydlStnd/eFtuC1dW4VYdD93oRg==",
       "dev": true,
       "engines": {
-        "node": ">= 8"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@nodelib/fs.walk": {
-      "version": "1.2.8",
-      "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
-      "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
+    "node_modules/@sigstore/protobuf-specs": {
+      "version": "0.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/protobuf-specs/-/protobuf-specs-0.3.2.tgz",
+      "integrity": "sha512-c6B0ehIWxMI8wiS/bj6rHMPqeFvngFV7cDU/MY+B16P9Z3Mp9k8L93eYZ7BYzSickzuqAQqAq0V956b3Ju6mLw==",
       "dev": true,
-      "dependencies": {
-        "@nodelib/fs.scandir": "2.1.5",
-        "fastq": "^1.6.0"
-      },
       "engines": {
-        "node": ">= 8"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/agent": {
-      "version": "2.2.2",
-      "resolved": "https://registry.npmjs.org/@npmcli/agent/-/agent-2.2.2.tgz",
-      "integrity": "sha512-OrcNPXdpSl9UX7qPVRWbmWMCSXrcDa2M9DvrbOTj7ao1S4PlqVFYv9/yLKMkrJKZ/V5A/kDBC690or307i26Og==",
+    "node_modules/@sigstore/sign": {
+      "version": "2.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/sign/-/sign-2.3.2.tgz",
+      "integrity": "sha512-5Vz5dPVuunIIvC5vBb0APwo7qKA4G9yM48kPWJT+OEERs40md5GoUR1yedwpekWZ4m0Hhw44m6zU+ObsON+iDA==",
       "dev": true,
       "dependencies": {
-        "agent-base": "^7.1.0",
-        "http-proxy-agent": "^7.0.0",
-        "https-proxy-agent": "^7.0.1",
-        "lru-cache": "^10.0.1",
-        "socks-proxy-agent": "^8.0.3"
+        "@sigstore/bundle": "^2.3.2",
+        "@sigstore/core": "^1.0.0",
+        "@sigstore/protobuf-specs": "^0.3.2",
+        "make-fetch-happen": "^13.0.1",
+        "proc-log": "^4.2.0",
+        "promise-retry": "^2.0.1"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/agent/node_modules/lru-cache": {
-      "version": "10.4.3",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
-      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
-      "dev": true
-    },
-    "node_modules/@npmcli/fs": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/@npmcli/fs/-/fs-3.1.1.tgz",
-      "integrity": "sha512-q9CRWjpHCMIh5sVyefoD1cA7PkvILqCZsnSOEUUivORLjxCO/Irmue2DprETiNgEqktDBZaM1Bi+jrarx1XdCg==",
+    "node_modules/@sigstore/tuf": {
+      "version": "2.3.4",
+      "resolved": "https://registry.npmjs.org/@sigstore/tuf/-/tuf-2.3.4.tgz",
+      "integrity": "sha512-44vtsveTPUpqhm9NCrbU8CWLe3Vck2HO1PNLw7RIajbB7xhtn5RBPm1VNSCMwqGYHhDsBJG8gDF0q4lgydsJvw==",
       "dev": true,
       "dependencies": {
-        "semver": "^7.3.5"
+        "@sigstore/protobuf-specs": "^0.3.2",
+        "tuf-js": "^2.2.1"
       },
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/git": {
-      "version": "5.0.8",
-      "resolved": "https://registry.npmjs.org/@npmcli/git/-/git-5.0.8.tgz",
-      "integrity": "sha512-liASfw5cqhjNW9UFd+ruwwdEf/lbOAQjLL2XY2dFW/bkJheXDYZgOyul/4gVvEV4BWkTXjYGmDqMw9uegdbJNQ==",
+    "node_modules/@sigstore/verify": {
+      "version": "1.2.1",
+      "resolved": "https://registry.npmjs.org/@sigstore/verify/-/verify-1.2.1.tgz",
+      "integrity": "sha512-8iKx79/F73DKbGfRf7+t4dqrc0bRr0thdPrxAtCKWRm/F0tG71i6O1rvlnScncJLLBZHn3h8M3c1BSUAb9yu8g==",
       "dev": true,
       "dependencies": {
-        "@npmcli/promise-spawn": "^7.0.0",
-        "ini": "^4.1.3",
-        "lru-cache": "^10.0.1",
-        "npm-pick-manifest": "^9.0.0",
-        "proc-log": "^4.0.0",
-        "promise-inflight": "^1.0.1",
-        "promise-retry": "^2.0.1",
-        "semver": "^7.3.5",
-        "which": "^4.0.0"
+        "@sigstore/bundle": "^2.3.2",
+        "@sigstore/core": "^1.1.0",
+        "@sigstore/protobuf-specs": "^0.3.2"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/git/node_modules/isexe": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
-      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+    "node_modules/@sindresorhus/merge-streams": {
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@sindresorhus/merge-streams/-/merge-streams-2.3.0.tgz",
+      "integrity": "sha512-LtoMMhxAlorcGhmFYI+LhPgbPZCkgP6ra1YL604EeF6U98pLlQ3iWIGMdWSC+vWmPBWBNgmDBAhnAobLROJmwg==",
       "dev": true,
       "engines": {
-        "node": ">=16"
-      }
-    },
-    "node_modules/@npmcli/git/node_modules/lru-cache": {
-      "version": "10.4.3",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
-      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
-      "dev": true
-    },
-    "node_modules/@npmcli/git/node_modules/which": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
-      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
-      "dev": true,
-      "dependencies": {
-        "isexe": "^3.1.1"
-      },
-      "bin": {
-        "node-which": "bin/which.js"
+        "node": ">=18"
       },
-      "engines": {
-        "node": "^16.13.0 || >=18.0.0"
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/@npmcli/installed-package-contents": {
-      "version": "2.1.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/installed-package-contents/-/installed-package-contents-2.1.0.tgz",
-      "integrity": "sha512-c8UuGLeZpm69BryRykLuKRyKFZYJsZSCT4aVY5ds4omyZqJ172ApzgfKJ5eV/r3HgLdUYgFVe54KSFVjKoe27w==",
-      "dev": true,
-      "dependencies": {
-        "npm-bundled": "^3.0.0",
-        "npm-normalize-package-bin": "^3.0.0"
-      },
-      "bin": {
-        "installed-package-contents": "bin/index.js"
-      },
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
+    "node_modules/@socket.io/component-emitter": {
+      "version": "3.1.2",
+      "resolved": "https://registry.npmjs.org/@socket.io/component-emitter/-/component-emitter-3.1.2.tgz",
+      "integrity": "sha512-9BCxFwvbGg/RsZK9tjXd8s4UcwR0MWeFQ1XEKIQVVvAGJyINdrqKMcTRyLoK8Rse1GjzLV9cwjWV1olXRWEXVA==",
+      "dev": true
     },
-    "node_modules/@npmcli/node-gyp": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/node-gyp/-/node-gyp-3.0.0.tgz",
-      "integrity": "sha512-gp8pRXC2oOxu0DUE1/M3bYtb1b3/DbJ5aM113+XJBgfXdussRAsX0YOrOhdd8WvnAR6auDBvJomGAkLKA5ydxA==",
+    "node_modules/@tufjs/canonical-json": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/@tufjs/canonical-json/-/canonical-json-2.0.0.tgz",
+      "integrity": "sha512-yVtV8zsdo8qFHe+/3kw81dSLyF7D576A5cCFCi4X7B39tWT7SekaEFUnvnWJHz+9qO7qJTah1JbrDjWKqFtdWA==",
       "dev": true,
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/package-json": {
-      "version": "5.2.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/package-json/-/package-json-5.2.0.tgz",
-      "integrity": "sha512-qe/kiqqkW0AGtvBjL8TJKZk/eBBSpnJkUWvHdQ9jM2lKHXRYYJuyNpJPlJw3c8QjC2ow6NZYiLExhUaeJelbxQ==",
+    "node_modules/@tufjs/models": {
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/@tufjs/models/-/models-2.0.1.tgz",
+      "integrity": "sha512-92F7/SFyufn4DXsha9+QfKnN03JGqtMFMXgSHbZOo8JG59WkTni7UzAouNQDf7AuP9OAMxVOPQcqG3sB7w+kkg==",
       "dev": true,
       "dependencies": {
-        "@npmcli/git": "^5.0.0",
-        "glob": "^10.2.2",
-        "hosted-git-info": "^7.0.0",
-        "json-parse-even-better-errors": "^3.0.0",
-        "normalize-package-data": "^6.0.0",
-        "proc-log": "^4.0.0",
-        "semver": "^7.5.3"
+        "@tufjs/canonical-json": "2.0.0",
+        "minimatch": "^9.0.4"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/@npmcli/package-json/node_modules/brace-expansion": {
+    "node_modules/@tufjs/models/node_modules/brace-expansion": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
       "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
@@ -4445,27 +4005,7 @@
         "balanced-match": "^1.0.0"
       }
     },
-    "node_modules/@npmcli/package-json/node_modules/glob": {
-      "version": "10.4.5",
-      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
-      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
-      "dev": true,
-      "dependencies": {
-        "foreground-child": "^3.1.0",
-        "jackspeak": "^3.1.2",
-        "minimatch": "^9.0.4",
-        "minipass": "^7.1.2",
-        "package-json-from-dist": "^1.0.0",
-        "path-scurry": "^1.11.1"
-      },
-      "bin": {
-        "glob": "dist/esm/bin.mjs"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/isaacs"
-      }
-    },
-    "node_modules/@npmcli/package-json/node_modules/minimatch": {
+    "node_modules/@tufjs/models/node_modules/minimatch": {
       "version": "9.0.5",
       "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
       "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
@@ -4480,580 +4020,102 @@
         "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/@npmcli/promise-spawn": {
-      "version": "7.0.2",
-      "resolved": "https://registry.npmjs.org/@npmcli/promise-spawn/-/promise-spawn-7.0.2.tgz",
-      "integrity": "sha512-xhfYPXoV5Dy4UkY0D+v2KkwvnDfiA/8Mt3sWCGI/hM03NsYIH8ZaG6QzS9x7pje5vHZBZJ2v6VRFVTWACnqcmQ==",
+    "node_modules/@types/body-parser": {
+      "version": "1.19.5",
+      "resolved": "https://registry.npmjs.org/@types/body-parser/-/body-parser-1.19.5.tgz",
+      "integrity": "sha512-fB3Zu92ucau0iQ0JMCFQE7b/dv8Ot07NI3KaZIkIUNXq82k4eBAqUaneXfleGY9JWskeS9y+u0nXMyspcuQrCg==",
       "dev": true,
       "dependencies": {
-        "which": "^4.0.0"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
+        "@types/connect": "*",
+        "@types/node": "*"
       }
     },
-    "node_modules/@npmcli/promise-spawn/node_modules/isexe": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
-      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+    "node_modules/@types/bonjour": {
+      "version": "3.5.13",
+      "resolved": "https://registry.npmjs.org/@types/bonjour/-/bonjour-3.5.13.tgz",
+      "integrity": "sha512-z9fJ5Im06zvUL548KvYNecEVlA7cVDkGUi6kZusb04mpyEFKCIZJvloCcmpmLaIahDpOQGHaHmG6imtPMmPXGQ==",
       "dev": true,
-      "engines": {
-        "node": ">=16"
+      "dependencies": {
+        "@types/node": "*"
       }
     },
-    "node_modules/@npmcli/promise-spawn/node_modules/which": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
-      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
+    "node_modules/@types/connect": {
+      "version": "3.4.38",
+      "resolved": "https://registry.npmjs.org/@types/connect/-/connect-3.4.38.tgz",
+      "integrity": "sha512-K6uROf1LD88uDQqJCktA4yzL1YYAK6NgfsI0v/mTgyPKWsX1CnJ0XPSDhViejru1GcRkLWb8RlzFYJRqGUbaug==",
       "dev": true,
       "dependencies": {
-        "isexe": "^3.1.1"
-      },
-      "bin": {
-        "node-which": "bin/which.js"
-      },
-      "engines": {
-        "node": "^16.13.0 || >=18.0.0"
+        "@types/node": "*"
       }
     },
-    "node_modules/@npmcli/redact": {
-      "version": "2.0.1",
-      "resolved": "https://registry.npmjs.org/@npmcli/redact/-/redact-2.0.1.tgz",
-      "integrity": "sha512-YgsR5jCQZhVmTJvjduTOIHph0L73pK8xwMVaDY0PatySqVM9AZj93jpoXYSJqfHFxFkN9dmqTw6OiqExsS3LPw==",
+    "node_modules/@types/connect-history-api-fallback": {
+      "version": "1.5.4",
+      "resolved": "https://registry.npmjs.org/@types/connect-history-api-fallback/-/connect-history-api-fallback-1.5.4.tgz",
+      "integrity": "sha512-n6Cr2xS1h4uAulPRdlw6Jl6s1oG8KrVilPN2yUITEs+K48EzMJJ3W1xy8K5eWuFvjp3R74AOIGSmp2UfBJ8HFw==",
       "dev": true,
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
+      "dependencies": {
+        "@types/express-serve-static-core": "*",
+        "@types/node": "*"
       }
     },
-    "node_modules/@npmcli/run-script": {
-      "version": "8.1.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/run-script/-/run-script-8.1.0.tgz",
-      "integrity": "sha512-y7efHHwghQfk28G2z3tlZ67pLG0XdfYbcVG26r7YIXALRsrVQcTq4/tdenSmdOrEsNahIYA/eh8aEVROWGFUDg==",
+    "node_modules/@types/cookie": {
+      "version": "0.4.1",
+      "resolved": "https://registry.npmjs.org/@types/cookie/-/cookie-0.4.1.tgz",
+      "integrity": "sha512-XW/Aa8APYr6jSVVA1y/DEIZX0/GMKLEVekNG727R8cs56ahETkRAy/3DR7+fJyh7oUgGwNQaRfXCun0+KbWY7Q==",
+      "dev": true
+    },
+    "node_modules/@types/cors": {
+      "version": "2.8.17",
+      "resolved": "https://registry.npmjs.org/@types/cors/-/cors-2.8.17.tgz",
+      "integrity": "sha512-8CGDvrBj1zgo2qE+oS3pOCyYNqCPryMWY2bGfwA0dcfopWGgxs+78df0Rs3rc9THP4JkOhLsAa+15VdpAqkcUA==",
       "dev": true,
       "dependencies": {
-        "@npmcli/node-gyp": "^3.0.0",
-        "@npmcli/package-json": "^5.0.0",
-        "@npmcli/promise-spawn": "^7.0.0",
-        "node-gyp": "^10.0.0",
-        "proc-log": "^4.0.0",
-        "which": "^4.0.0"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
+        "@types/node": "*"
       }
     },
-    "node_modules/@npmcli/run-script/node_modules/isexe": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/isexe/-/isexe-3.1.1.tgz",
-      "integrity": "sha512-LpB/54B+/2J5hqQ7imZHfdU31OlgQqx7ZicVlkm9kzg9/w8GKLEcFfJl/t7DCEDueOyBAD6zCCwTO6Fzs0NoEQ==",
+    "node_modules/@types/estree": {
+      "version": "1.0.5",
+      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.5.tgz",
+      "integrity": "sha512-/kYRxGDLWzHOB7q+wtSUQlFrtcdUccpfy+X+9iMBpHK8QLLhx2wIPYuS5DYtR9Wa/YlZAbIovy7qVdB1Aq6Lyw==",
+      "dev": true
+    },
+    "node_modules/@types/express": {
+      "version": "4.17.21",
+      "resolved": "https://registry.npmjs.org/@types/express/-/express-4.17.21.tgz",
+      "integrity": "sha512-ejlPM315qwLpaQlQDTjPdsUFSc6ZsP4AN6AlWnogPjQ7CVi7PYF3YVz+CY3jE2pwYf7E/7HlDAN0rV2GxTG0HQ==",
       "dev": true,
-      "engines": {
-        "node": ">=16"
+      "dependencies": {
+        "@types/body-parser": "*",
+        "@types/express-serve-static-core": "^4.17.33",
+        "@types/qs": "*",
+        "@types/serve-static": "*"
       }
     },
-    "node_modules/@npmcli/run-script/node_modules/which": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/which/-/which-4.0.0.tgz",
-      "integrity": "sha512-GlaYyEb07DPxYCKhKzplCWBJtvxZcZMrL+4UkrTSJHHPyZU4mYYTv3qaOe77H7EODLSSopAUFAc6W8U4yqvscg==",
+    "node_modules/@types/express-serve-static-core": {
+      "version": "4.19.5",
+      "resolved": "https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.5.tgz",
+      "integrity": "sha512-y6W03tvrACO72aijJ5uF02FRq5cgDR9lUxddQ8vyF+GvmjJQqbzDcJngEjURc+ZsG31VI3hODNZJ2URj86pzmg==",
       "dev": true,
       "dependencies": {
-        "isexe": "^3.1.1"
-      },
-      "bin": {
-        "node-which": "bin/which.js"
-      },
-      "engines": {
-        "node": "^16.13.0 || >=18.0.0"
+        "@types/node": "*",
+        "@types/qs": "*",
+        "@types/range-parser": "*",
+        "@types/send": "*"
       }
     },
-    "node_modules/@pkgjs/parseargs": {
-      "version": "0.11.0",
-      "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
-      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
+    "node_modules/@types/http-errors": {
+      "version": "2.0.4",
+      "resolved": "https://registry.npmjs.org/@types/http-errors/-/http-errors-2.0.4.tgz",
+      "integrity": "sha512-D0CFMMtydbJAegzOyHjtiKPLlvnm3iTZyZRSZoLq2mRhDdmLfIWOCYPfQJ4cu2erKghU++QvjcUjp/5h7hESpA==",
+      "dev": true
+    },
+    "node_modules/@types/http-proxy": {
+      "version": "1.17.15",
+      "resolved": "https://registry.npmjs.org/@types/http-proxy/-/http-proxy-1.17.15.tgz",
+      "integrity": "sha512-25g5atgiVNTIv0LBDTg1H74Hvayx0ajtJPLLcYE3whFv75J0pWNtOBzaXJQgDTmrX1bx5U9YC2w/n65BN1HwRQ==",
       "dev": true,
-      "optional": true,
-      "engines": {
-        "node": ">=14"
-      }
-    },
-    "node_modules/@rollup/rollup-android-arm-eabi": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.18.0.tgz",
-      "integrity": "sha512-Tya6xypR10giZV1XzxmH5wr25VcZSncG0pZIjfePT0OVBvqNEurzValetGNarVrGiq66EBVAFn15iYX4w6FKgQ==",
-      "cpu": [
-        "arm"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "android"
-      ]
-    },
-    "node_modules/@rollup/rollup-android-arm64": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.18.0.tgz",
-      "integrity": "sha512-avCea0RAP03lTsDhEyfy+hpfr85KfyTctMADqHVhLAF3MlIkq83CP8UfAHUssgXTYd+6er6PaAhx/QGv4L1EiA==",
-      "cpu": [
-        "arm64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "android"
-      ]
-    },
-    "node_modules/@rollup/rollup-darwin-arm64": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.18.0.tgz",
-      "integrity": "sha512-IWfdwU7KDSm07Ty0PuA/W2JYoZ4iTj3TUQjkVsO/6U+4I1jN5lcR71ZEvRh52sDOERdnNhhHU57UITXz5jC1/w==",
-      "cpu": [
-        "arm64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "darwin"
-      ]
-    },
-    "node_modules/@rollup/rollup-darwin-x64": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.18.0.tgz",
-      "integrity": "sha512-n2LMsUz7Ynu7DoQrSQkBf8iNrjOGyPLrdSg802vk6XT3FtsgX6JbE8IHRvposskFm9SNxzkLYGSq9QdpLYpRNA==",
-      "cpu": [
-        "x64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "darwin"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.18.0.tgz",
-      "integrity": "sha512-C/zbRYRXFjWvz9Z4haRxcTdnkPt1BtCkz+7RtBSuNmKzMzp3ZxdM28Mpccn6pt28/UWUCTXa+b0Mx1k3g6NOMA==",
-      "cpu": [
-        "arm"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.18.0.tgz",
-      "integrity": "sha512-l3m9ewPgjQSXrUMHg93vt0hYCGnrMOcUpTz6FLtbwljo2HluS4zTXFy2571YQbisTnfTKPZ01u/ukJdQTLGh9A==",
-      "cpu": [
-        "arm"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-arm64-gnu": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.18.0.tgz",
-      "integrity": "sha512-rJ5D47d8WD7J+7STKdCUAgmQk49xuFrRi9pZkWoRD1UeSMakbcepWXPF8ycChBoAqs1pb2wzvbY6Q33WmN2ftw==",
-      "cpu": [
-        "arm64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-arm64-musl": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.18.0.tgz",
-      "integrity": "sha512-be6Yx37b24ZwxQ+wOQXXLZqpq4jTckJhtGlWGZs68TgdKXJgw54lUUoFYrg6Zs/kjzAQwEwYbp8JxZVzZLRepQ==",
-      "cpu": [
-        "arm64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-powerpc64le-gnu": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-powerpc64le-gnu/-/rollup-linux-powerpc64le-gnu-4.18.0.tgz",
-      "integrity": "sha512-hNVMQK+qrA9Todu9+wqrXOHxFiD5YmdEi3paj6vP02Kx1hjd2LLYR2eaN7DsEshg09+9uzWi2W18MJDlG0cxJA==",
-      "cpu": [
-        "ppc64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.18.0.tgz",
-      "integrity": "sha512-ROCM7i+m1NfdrsmvwSzoxp9HFtmKGHEqu5NNDiZWQtXLA8S5HBCkVvKAxJ8U+CVctHwV2Gb5VUaK7UAkzhDjlg==",
-      "cpu": [
-        "riscv64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-s390x-gnu": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.18.0.tgz",
-      "integrity": "sha512-0UyyRHyDN42QL+NbqevXIIUnKA47A+45WyasO+y2bGJ1mhQrfrtXUpTxCOrfxCR4esV3/RLYyucGVPiUsO8xjg==",
-      "cpu": [
-        "s390x"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-x64-gnu": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.18.0.tgz",
-      "integrity": "sha512-xuglR2rBVHA5UsI8h8UbX4VJ470PtGCf5Vpswh7p2ukaqBGFTnsfzxUBetoWBWymHMxbIG0Cmx7Y9qDZzr648w==",
-      "cpu": [
-        "x64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-linux-x64-musl": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.18.0.tgz",
-      "integrity": "sha512-LKaqQL9osY/ir2geuLVvRRs+utWUNilzdE90TpyoX0eNqPzWjRm14oMEE+YLve4k/NAqCdPkGYDaDF5Sw+xBfg==",
-      "cpu": [
-        "x64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ]
-    },
-    "node_modules/@rollup/rollup-win32-arm64-msvc": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.18.0.tgz",
-      "integrity": "sha512-7J6TkZQFGo9qBKH0pk2cEVSRhJbL6MtfWxth7Y5YmZs57Pi+4x6c2dStAUvaQkHQLnEQv1jzBUW43GvZW8OFqA==",
-      "cpu": [
-        "arm64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ]
-    },
-    "node_modules/@rollup/rollup-win32-ia32-msvc": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.18.0.tgz",
-      "integrity": "sha512-Txjh+IxBPbkUB9+SXZMpv+b/vnTEtFyfWZgJ6iyCmt2tdx0OF5WhFowLmnh8ENGNpfUlUZkdI//4IEmhwPieNg==",
-      "cpu": [
-        "ia32"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ]
-    },
-    "node_modules/@rollup/rollup-win32-x64-msvc": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.18.0.tgz",
-      "integrity": "sha512-UOo5FdvOL0+eIVTgS4tIdbW+TtnBLWg1YBCcU2KWM7nuNwRz9bksDX1bekJJCpu25N1DVWaCwnT39dVQxzqS8g==",
-      "cpu": [
-        "x64"
-      ],
-      "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ]
-    },
-    "node_modules/@schematics/angular": {
-      "version": "18.1.1",
-      "resolved": "https://registry.npmjs.org/@schematics/angular/-/angular-18.1.1.tgz",
-      "integrity": "sha512-6nQUSuFSP7un5Bmm6/MpQXq3jnkdEYg2MUPv7JStsqnT1YYzUsDjkUv7Hsci0xQmeUAzVz3ueg4znviJoQxWdg==",
-      "dev": true,
-      "dependencies": {
-        "@angular-devkit/core": "18.1.1",
-        "@angular-devkit/schematics": "18.1.1",
-        "jsonc-parser": "3.3.1"
-      },
-      "engines": {
-        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
-        "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
-        "yarn": ">= 1.13.0"
-      }
-    },
-    "node_modules/@sigstore/bundle": {
-      "version": "2.3.2",
-      "resolved": "https://registry.npmjs.org/@sigstore/bundle/-/bundle-2.3.2.tgz",
-      "integrity": "sha512-wueKWDk70QixNLB363yHc2D2ItTgYiMTdPwK8D9dKQMR3ZQ0c35IxP5xnwQ8cNLoCgCRcHf14kE+CLIvNX1zmA==",
-      "dev": true,
-      "dependencies": {
-        "@sigstore/protobuf-specs": "^0.3.2"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sigstore/core": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/@sigstore/core/-/core-1.1.0.tgz",
-      "integrity": "sha512-JzBqdVIyqm2FRQCulY6nbQzMpJJpSiJ8XXWMhtOX9eKgaXXpfNOF53lzQEjIydlStnd/eFtuC1dW4VYdD93oRg==",
-      "dev": true,
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sigstore/protobuf-specs": {
-      "version": "0.3.2",
-      "resolved": "https://registry.npmjs.org/@sigstore/protobuf-specs/-/protobuf-specs-0.3.2.tgz",
-      "integrity": "sha512-c6B0ehIWxMI8wiS/bj6rHMPqeFvngFV7cDU/MY+B16P9Z3Mp9k8L93eYZ7BYzSickzuqAQqAq0V956b3Ju6mLw==",
-      "dev": true,
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sigstore/sign": {
-      "version": "2.3.2",
-      "resolved": "https://registry.npmjs.org/@sigstore/sign/-/sign-2.3.2.tgz",
-      "integrity": "sha512-5Vz5dPVuunIIvC5vBb0APwo7qKA4G9yM48kPWJT+OEERs40md5GoUR1yedwpekWZ4m0Hhw44m6zU+ObsON+iDA==",
-      "dev": true,
-      "dependencies": {
-        "@sigstore/bundle": "^2.3.2",
-        "@sigstore/core": "^1.0.0",
-        "@sigstore/protobuf-specs": "^0.3.2",
-        "make-fetch-happen": "^13.0.1",
-        "proc-log": "^4.2.0",
-        "promise-retry": "^2.0.1"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sigstore/tuf": {
-      "version": "2.3.4",
-      "resolved": "https://registry.npmjs.org/@sigstore/tuf/-/tuf-2.3.4.tgz",
-      "integrity": "sha512-44vtsveTPUpqhm9NCrbU8CWLe3Vck2HO1PNLw7RIajbB7xhtn5RBPm1VNSCMwqGYHhDsBJG8gDF0q4lgydsJvw==",
-      "dev": true,
-      "dependencies": {
-        "@sigstore/protobuf-specs": "^0.3.2",
-        "tuf-js": "^2.2.1"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sigstore/verify": {
-      "version": "1.2.1",
-      "resolved": "https://registry.npmjs.org/@sigstore/verify/-/verify-1.2.1.tgz",
-      "integrity": "sha512-8iKx79/F73DKbGfRf7+t4dqrc0bRr0thdPrxAtCKWRm/F0tG71i6O1rvlnScncJLLBZHn3h8M3c1BSUAb9yu8g==",
-      "dev": true,
-      "dependencies": {
-        "@sigstore/bundle": "^2.3.2",
-        "@sigstore/core": "^1.1.0",
-        "@sigstore/protobuf-specs": "^0.3.2"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@sindresorhus/merge-streams": {
-      "version": "2.3.0",
-      "resolved": "https://registry.npmjs.org/@sindresorhus/merge-streams/-/merge-streams-2.3.0.tgz",
-      "integrity": "sha512-LtoMMhxAlorcGhmFYI+LhPgbPZCkgP6ra1YL604EeF6U98pLlQ3iWIGMdWSC+vWmPBWBNgmDBAhnAobLROJmwg==",
-      "dev": true,
-      "engines": {
-        "node": ">=18"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
-    "node_modules/@socket.io/component-emitter": {
-      "version": "3.1.2",
-      "resolved": "https://registry.npmjs.org/@socket.io/component-emitter/-/component-emitter-3.1.2.tgz",
-      "integrity": "sha512-9BCxFwvbGg/RsZK9tjXd8s4UcwR0MWeFQ1XEKIQVVvAGJyINdrqKMcTRyLoK8Rse1GjzLV9cwjWV1olXRWEXVA==",
-      "dev": true
-    },
-    "node_modules/@tufjs/canonical-json": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/@tufjs/canonical-json/-/canonical-json-2.0.0.tgz",
-      "integrity": "sha512-yVtV8zsdo8qFHe+/3kw81dSLyF7D576A5cCFCi4X7B39tWT7SekaEFUnvnWJHz+9qO7qJTah1JbrDjWKqFtdWA==",
-      "dev": true,
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@tufjs/models": {
-      "version": "2.0.1",
-      "resolved": "https://registry.npmjs.org/@tufjs/models/-/models-2.0.1.tgz",
-      "integrity": "sha512-92F7/SFyufn4DXsha9+QfKnN03JGqtMFMXgSHbZOo8JG59WkTni7UzAouNQDf7AuP9OAMxVOPQcqG3sB7w+kkg==",
-      "dev": true,
-      "dependencies": {
-        "@tufjs/canonical-json": "2.0.0",
-        "minimatch": "^9.0.4"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/@tufjs/models/node_modules/brace-expansion": {
-      "version": "2.0.1",
-      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
-      "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
-      "dev": true,
-      "dependencies": {
-        "balanced-match": "^1.0.0"
-      }
-    },
-    "node_modules/@tufjs/models/node_modules/minimatch": {
-      "version": "9.0.5",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
-      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
-      "dev": true,
-      "dependencies": {
-        "brace-expansion": "^2.0.1"
-      },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/isaacs"
-      }
-    },
-    "node_modules/@types/body-parser": {
-      "version": "1.19.5",
-      "resolved": "https://registry.npmjs.org/@types/body-parser/-/body-parser-1.19.5.tgz",
-      "integrity": "sha512-fB3Zu92ucau0iQ0JMCFQE7b/dv8Ot07NI3KaZIkIUNXq82k4eBAqUaneXfleGY9JWskeS9y+u0nXMyspcuQrCg==",
-      "dev": true,
-      "dependencies": {
-        "@types/connect": "*",
-        "@types/node": "*"
-      }
-    },
-    "node_modules/@types/bonjour": {
-      "version": "3.5.13",
-      "resolved": "https://registry.npmjs.org/@types/bonjour/-/bonjour-3.5.13.tgz",
-      "integrity": "sha512-z9fJ5Im06zvUL548KvYNecEVlA7cVDkGUi6kZusb04mpyEFKCIZJvloCcmpmLaIahDpOQGHaHmG6imtPMmPXGQ==",
-      "dev": true,
-      "dependencies": {
-        "@types/node": "*"
-      }
-    },
-    "node_modules/@types/connect": {
-      "version": "3.4.38",
-      "resolved": "https://registry.npmjs.org/@types/connect/-/connect-3.4.38.tgz",
-      "integrity": "sha512-K6uROf1LD88uDQqJCktA4yzL1YYAK6NgfsI0v/mTgyPKWsX1CnJ0XPSDhViejru1GcRkLWb8RlzFYJRqGUbaug==",
-      "dev": true,
-      "dependencies": {
-        "@types/node": "*"
-      }
-    },
-    "node_modules/@types/connect-history-api-fallback": {
-      "version": "1.5.4",
-      "resolved": "https://registry.npmjs.org/@types/connect-history-api-fallback/-/connect-history-api-fallback-1.5.4.tgz",
-      "integrity": "sha512-n6Cr2xS1h4uAulPRdlw6Jl6s1oG8KrVilPN2yUITEs+K48EzMJJ3W1xy8K5eWuFvjp3R74AOIGSmp2UfBJ8HFw==",
-      "dev": true,
-      "dependencies": {
-        "@types/express-serve-static-core": "*",
-        "@types/node": "*"
-      }
-    },
-    "node_modules/@types/cookie": {
-      "version": "0.4.1",
-      "resolved": "https://registry.npmjs.org/@types/cookie/-/cookie-0.4.1.tgz",
-      "integrity": "sha512-XW/Aa8APYr6jSVVA1y/DEIZX0/GMKLEVekNG727R8cs56ahETkRAy/3DR7+fJyh7oUgGwNQaRfXCun0+KbWY7Q==",
-      "dev": true
-    },
-    "node_modules/@types/cors": {
-      "version": "2.8.17",
-      "resolved": "https://registry.npmjs.org/@types/cors/-/cors-2.8.17.tgz",
-      "integrity": "sha512-8CGDvrBj1zgo2qE+oS3pOCyYNqCPryMWY2bGfwA0dcfopWGgxs+78df0Rs3rc9THP4JkOhLsAa+15VdpAqkcUA==",
-      "dev": true,
-      "dependencies": {
-        "@types/node": "*"
-      }
-    },
-    "node_modules/@types/eslint": {
-      "version": "8.56.10",
-      "resolved": "https://registry.npmjs.org/@types/eslint/-/eslint-8.56.10.tgz",
-      "integrity": "sha512-Shavhk87gCtY2fhXDctcfS3e6FdxWkCx1iUZ9eEUbh7rTqlZT0/IzOkCOVt0fCjcFuZ9FPYfuezTBImfHCDBGQ==",
-      "dev": true,
-      "dependencies": {
-        "@types/estree": "*",
-        "@types/json-schema": "*"
-      }
-    },
-    "node_modules/@types/eslint-scope": {
-      "version": "3.7.7",
-      "resolved": "https://registry.npmjs.org/@types/eslint-scope/-/eslint-scope-3.7.7.tgz",
-      "integrity": "sha512-MzMFlSLBqNF2gcHWO0G1vP/YQyfvrxZ0bF+u7mzUdZ1/xK4A4sru+nraZz5i3iEIk1l1uyicaDVTB4QbbEkAYg==",
-      "dev": true,
-      "dependencies": {
-        "@types/eslint": "*",
-        "@types/estree": "*"
-      }
-    },
-    "node_modules/@types/estree": {
-      "version": "1.0.5",
-      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.5.tgz",
-      "integrity": "sha512-/kYRxGDLWzHOB7q+wtSUQlFrtcdUccpfy+X+9iMBpHK8QLLhx2wIPYuS5DYtR9Wa/YlZAbIovy7qVdB1Aq6Lyw==",
-      "dev": true
-    },
-    "node_modules/@types/express": {
-      "version": "4.17.21",
-      "resolved": "https://registry.npmjs.org/@types/express/-/express-4.17.21.tgz",
-      "integrity": "sha512-ejlPM315qwLpaQlQDTjPdsUFSc6ZsP4AN6AlWnogPjQ7CVi7PYF3YVz+CY3jE2pwYf7E/7HlDAN0rV2GxTG0HQ==",
-      "dev": true,
-      "dependencies": {
-        "@types/body-parser": "*",
-        "@types/express-serve-static-core": "^4.17.33",
-        "@types/qs": "*",
-        "@types/serve-static": "*"
-      }
-    },
-    "node_modules/@types/express-serve-static-core": {
-      "version": "4.19.5",
-      "resolved": "https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.5.tgz",
-      "integrity": "sha512-y6W03tvrACO72aijJ5uF02FRq5cgDR9lUxddQ8vyF+GvmjJQqbzDcJngEjURc+ZsG31VI3hODNZJ2URj86pzmg==",
-      "dev": true,
-      "dependencies": {
-        "@types/node": "*",
-        "@types/qs": "*",
-        "@types/range-parser": "*",
-        "@types/send": "*"
-      }
-    },
-    "node_modules/@types/http-errors": {
-      "version": "2.0.4",
-      "resolved": "https://registry.npmjs.org/@types/http-errors/-/http-errors-2.0.4.tgz",
-      "integrity": "sha512-D0CFMMtydbJAegzOyHjtiKPLlvnm3iTZyZRSZoLq2mRhDdmLfIWOCYPfQJ4cu2erKghU++QvjcUjp/5h7hESpA==",
-      "dev": true
-    },
-    "node_modules/@types/http-proxy": {
-      "version": "1.17.14",
-      "resolved": "https://registry.npmjs.org/@types/http-proxy/-/http-proxy-1.17.14.tgz",
-      "integrity": "sha512-SSrD0c1OQzlFX7pGu1eXxSEjemej64aaNPRhhVYUGqXh0BtldAAx37MG8btcumvpgKyZp1F5Gn3JkktdxiFv6w==",
-      "dev": true,
-      "dependencies": {
-        "@types/node": "*"
+      "dependencies": {
+        "@types/node": "*"
       }
     },
     "node_modules/@types/jasmine": {
@@ -5084,12 +4146,12 @@
       }
     },
     "node_modules/@types/node": {
-      "version": "20.14.11",
-      "resolved": "https://registry.npmjs.org/@types/node/-/node-20.14.11.tgz",
-      "integrity": "sha512-kprQpL8MMeszbz6ojB5/tU8PLN4kesnN8Gjzw349rDlNgsSzg90lAVj3llK99Dh7JON+t9AuscPPFW6mPbTnSA==",
+      "version": "22.7.0",
+      "resolved": "https://registry.npmjs.org/@types/node/-/node-22.7.0.tgz",
+      "integrity": "sha512-MOdOibwBs6KW1vfqz2uKMlxq5xAfAZ98SZjO8e3XnAbFnTJtAspqhWk7hrdSAs9/Y14ZWMiy7/MxMUzAOadYEw==",
       "dev": true,
       "dependencies": {
-        "undici-types": "~5.26.4"
+        "undici-types": "~6.19.2"
       }
     },
     "node_modules/@types/node-forge": {
@@ -5102,9 +4164,9 @@
       }
     },
     "node_modules/@types/qs": {
-      "version": "6.9.15",
-      "resolved": "https://registry.npmjs.org/@types/qs/-/qs-6.9.15.tgz",
-      "integrity": "sha512-uXHQKES6DQKKCLh441Xv/dwxOq1TVS3JPUMlEqoEglvlhR6Mxnlew/Xq/LRVHpLyk7iK3zODe1qYHIMltO7XGg==",
+      "version": "6.9.16",
+      "resolved": "https://registry.npmjs.org/@types/qs/-/qs-6.9.16.tgz",
+      "integrity": "sha512-7i+zxXdPD0T4cKDuxCUXJ4wHcsJLwENa6Z3dCu8cfCK743OGy5Nu1RmAGqDPsoTDINVEcdXKRvR/zre+P2Ku1A==",
       "dev": true
     },
     "node_modules/@types/range-parser": {
@@ -5165,9 +4227,9 @@
       "dev": true
     },
     "node_modules/@types/ws": {
-      "version": "8.5.11",
-      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-8.5.11.tgz",
-      "integrity": "sha512-4+q7P5h3SpJxaBft0Dzpbr6lmMaqh0Jr2tbhJZ/luAwvD7ohSCniYkwz/pLxuT2h0EOa6QADgJj1Ko+TzRfZ+w==",
+      "version": "8.5.12",
+      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-8.5.12.tgz",
+      "integrity": "sha512-3tPRkv1EtkDpzlgyKyI8pGsGZAGPEaXeu0DOj5DI25Ja91bdAYddYHbADRYVrZMRbfW+1l5YwXVDKohDJNQxkQ==",
       "dev": true,
       "dependencies": {
         "@types/node": "*"
@@ -5445,15 +4507,15 @@
       }
     },
     "node_modules/ajv": {
-      "version": "8.16.0",
-      "resolved": "https://registry.npmjs.org/ajv/-/ajv-8.16.0.tgz",
-      "integrity": "sha512-F0twR8U1ZU67JIEtekUcLkXkoO5mMMmgGD8sK/xUFzJ805jxHQl92hImFAqqXMyMYjSPOyUPAwHYhB72g5sTXw==",
+      "version": "8.17.1",
+      "resolved": "https://registry.npmjs.org/ajv/-/ajv-8.17.1.tgz",
+      "integrity": "sha512-B/gBuNg5SiMTrPkC+A2+cW0RszwxYmn6VYxB/inlBStS5nx6xHIt/ehKRhIMhqusl7a8LjQoZnjCs5vhwxOQ1g==",
       "dev": true,
       "dependencies": {
         "fast-deep-equal": "^3.1.3",
+        "fast-uri": "^3.0.1",
         "json-schema-traverse": "^1.0.0",
-        "require-from-string": "^2.0.2",
-        "uri-js": "^4.4.1"
+        "require-from-string": "^2.0.2"
       },
       "funding": {
         "type": "github",
@@ -5584,9 +4646,9 @@
       "dev": true
     },
     "node_modules/autoprefixer": {
-      "version": "10.4.19",
-      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.19.tgz",
-      "integrity": "sha512-BaENR2+zBZ8xXhM4pUaKUxlVdxZ0EZhjvbopwnXmxRUfqDmwSpC2lAi/QXvx7NRdPCo1WKEcEF6mV64si1z4Ew==",
+      "version": "10.4.20",
+      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.20.tgz",
+      "integrity": "sha512-XY25y5xSv/wEoqzDyXXME4AFfkZI0P23z6Fs3YgymDnKJkCGOnkL0iTxCa85UTqaSgfcqyf3UA6+c7wUvx/16g==",
       "dev": true,
       "funding": [
         {
@@ -5603,11 +4665,11 @@
         }
       ],
       "dependencies": {
-        "browserslist": "^4.23.0",
-        "caniuse-lite": "^1.0.30001599",
+        "browserslist": "^4.23.3",
+        "caniuse-lite": "^1.0.30001646",
         "fraction.js": "^4.3.7",
         "normalize-range": "^0.1.2",
-        "picocolors": "^1.0.0",
+        "picocolors": "^1.0.1",
         "postcss-value-parser": "^4.2.0"
       },
       "bin": {
@@ -5661,13 +4723,13 @@
       }
     },
     "node_modules/babel-plugin-polyfill-corejs3": {
-      "version": "0.10.4",
-      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-corejs3/-/babel-plugin-polyfill-corejs3-0.10.4.tgz",
-      "integrity": "sha512-25J6I8NGfa5YkCDogHRID3fVCadIR8/pGl1/spvCkzb6lVn6SR3ojpx9nOn9iEBcUsjY24AmdKm5khcfKdylcg==",
+      "version": "0.10.6",
+      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-corejs3/-/babel-plugin-polyfill-corejs3-0.10.6.tgz",
+      "integrity": "sha512-b37+KR2i/khY5sKmWNVQAnitvquQbNdWy6lJdsr0kmquCKEEUgMKK4SboVM3HtfnZilfjr4MMQ7vY58FVWDtIA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-define-polyfill-provider": "^0.6.1",
-        "core-js-compat": "^3.36.1"
+        "@babel/helper-define-polyfill-provider": "^0.6.2",
+        "core-js-compat": "^3.38.0"
       },
       "peerDependencies": {
         "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
@@ -5759,9 +4821,9 @@
       }
     },
     "node_modules/body-parser": {
-      "version": "1.20.2",
-      "resolved": "https://registry.npmjs.org/body-parser/-/body-parser-1.20.2.tgz",
-      "integrity": "sha512-ml9pReCu3M61kGlqoTm2umSXTlRTuGTx0bfYj+uIUKKYycG5NtSbeetV3faSU6R7ajOPw0g/J1PvK4qNy7s5bA==",
+      "version": "1.20.3",
+      "resolved": "https://registry.npmjs.org/body-parser/-/body-parser-1.20.3.tgz",
+      "integrity": "sha512-7rAxByjUMqQ3/bHJy7D6OGXvx/MMc4IqBn/X0fcM1QUcAItpZrBEYhWGem+tzXH90c+G01ypMcYJBO9Y30203g==",
       "dev": true,
       "dependencies": {
         "bytes": "3.1.2",
@@ -5772,7 +4834,7 @@
         "http-errors": "2.0.0",
         "iconv-lite": "0.4.24",
         "on-finished": "2.4.1",
-        "qs": "6.11.0",
+        "qs": "6.13.0",
         "raw-body": "2.5.2",
         "type-is": "~1.6.18",
         "unpipe": "1.0.0"
@@ -5836,9 +4898,9 @@
       }
     },
     "node_modules/browserslist": {
-      "version": "4.23.2",
-      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.23.2.tgz",
-      "integrity": "sha512-qkqSyistMYdxAcw+CzbZwlBy8AGmS/eEWs+sEV5TnLRGDOL+C5M2EnH6tlZyg0YoAxGJAFKh61En9BR941GnHA==",
+      "version": "4.24.0",
+      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.24.0.tgz",
+      "integrity": "sha512-Rmb62sR1Zpjql25eSanFGEhAxcFwfA1K0GuQcLoaJBAcENegrQut3hYdhXFF1obQfiDyqIW/cLM5HSJ/9k884A==",
       "dev": true,
       "funding": [
         {
@@ -5855,9 +4917,9 @@
         }
       ],
       "dependencies": {
-        "caniuse-lite": "^1.0.30001640",
-        "electron-to-chromium": "^1.4.820",
-        "node-releases": "^2.0.14",
+        "caniuse-lite": "^1.0.30001663",
+        "electron-to-chromium": "^1.5.28",
+        "node-releases": "^2.0.18",
         "update-browserslist-db": "^1.1.0"
       },
       "bin": {
@@ -6023,9 +5085,9 @@
       }
     },
     "node_modules/caniuse-lite": {
-      "version": "1.0.30001642",
-      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001642.tgz",
-      "integrity": "sha512-3XQ0DoRgLijXJErLSl+bLnJ+Et4KqV1PY6JJBGAFlsNsz31zeAIncyeZfLCabHK/jtSh+671RM9YMldxjUPZtA==",
+      "version": "1.0.30001663",
+      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001663.tgz",
+      "integrity": "sha512-o9C3X27GLKbLeTYZ6HBOLU1tsAcBZsLis28wrVzddShCS16RujjHp9GDHKZqrB3meE0YjhawvMFsGb/igqiPzA==",
       "dev": true,
       "funding": [
         {
@@ -6114,15 +5176,15 @@
       }
     },
     "node_modules/cli-cursor": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-4.0.0.tgz",
-      "integrity": "sha512-VGtlMu3x/4DOtIUwEkRezxUZ2lBacNJCHash0N0WeZDBS+7Ux1dm3XWAgWYxLJFMMdOeXMHXorshEFhbMSGelg==",
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-5.0.0.tgz",
+      "integrity": "sha512-aCj4O5wKyszjMmDT4tZj93kxyydN/K5zPWSCe6/0AV/AA1pqe5ZBIw0a2ZfPQV7lL5/yb5HsUreJ6UFAF1tEQw==",
       "dev": true,
       "dependencies": {
-        "restore-cursor": "^4.0.0"
+        "restore-cursor": "^5.0.0"
       },
       "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
@@ -6510,12 +5572,12 @@
       }
     },
     "node_modules/core-js-compat": {
-      "version": "3.37.1",
-      "resolved": "https://registry.npmjs.org/core-js-compat/-/core-js-compat-3.37.1.tgz",
-      "integrity": "sha512-9TNiImhKvQqSUkOvk/mMRZzOANTiEVC7WaBNhHcKM7x+/5E1l5NvsysR19zuDQScE8k+kfQXWRN3AtS/eOSHpg==",
+      "version": "3.38.1",
+      "resolved": "https://registry.npmjs.org/core-js-compat/-/core-js-compat-3.38.1.tgz",
+      "integrity": "sha512-JRH6gfXxGmrzF3tZ57lFx97YARxCXPaMzPo6jELZhv88pBH5VXpQ+y0znKGlFnzuaihqhLbefxSJxWJMPtfDzw==",
       "dev": true,
       "dependencies": {
-        "browserslist": "^4.23.0"
+        "browserslist": "^4.23.3"
       },
       "funding": {
         "type": "opencollective",
@@ -6772,12 +5834,12 @@
       }
     },
     "node_modules/debug": {
-      "version": "4.3.5",
-      "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.5.tgz",
-      "integrity": "sha512-pt0bNEmneDIvdL1Xsd9oDQ/wrQRkXDT4AUWlNZNPKvW5x/jyO9VFXkJUP07vQ2upmw5PlaITaPKc31jK13V+jg==",
+      "version": "4.3.7",
+      "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.7.tgz",
+      "integrity": "sha512-Er2nc/H7RrMXZBFCEim6TCmMk02Z8vLC2Rbi1KEBggpo0fS6l0S1nnapwmIi3yW/+GOJap1Krg4w0Hg80oCqgQ==",
       "dev": true,
       "dependencies": {
-        "ms": "2.1.2"
+        "ms": "^2.1.3"
       },
       "engines": {
         "node": ">=6.0"
@@ -7001,15 +6063,15 @@
       "dev": true
     },
     "node_modules/electron-to-chromium": {
-      "version": "1.4.829",
-      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.4.829.tgz",
-      "integrity": "sha512-5qp1N2POAfW0u1qGAxXEtz6P7bO1m6gpZr5hdf5ve6lxpLM7MpiM4jIPz7xcrNlClQMafbyUDDWjlIQZ1Mw0Rw==",
+      "version": "1.5.28",
+      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.28.tgz",
+      "integrity": "sha512-VufdJl+rzaKZoYVUijN13QcXVF5dWPZANeFTLNy+OSpHdDL5ynXTF35+60RSBbaQYB1ae723lQXHCrf4pyLsMw==",
       "dev": true
     },
     "node_modules/emoji-regex": {
-      "version": "10.3.0",
-      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-10.3.0.tgz",
-      "integrity": "sha512-QpLs9D9v9kArv4lfDEgg1X/gN5XLnf/A6l9cs8SPZLRZR3ZkY9+kwIQTxm+fsSej5UMYGE8fdoaZVIBlqG0XTw==",
+      "version": "10.4.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-10.4.0.tgz",
+      "integrity": "sha512-EC+0oUMY1Rqm4O6LLrgjtYDvcVYTy7chDnM4Q7030tP4Kwj3u/pR6gP9ygnp2CJMK5Gq+9Q2oqmrFJAz01DXjw==",
       "dev": true
     },
     "node_modules/emojis-list": {
@@ -7054,9 +6116,9 @@
       }
     },
     "node_modules/engine.io": {
-      "version": "6.5.5",
-      "resolved": "https://registry.npmjs.org/engine.io/-/engine.io-6.5.5.tgz",
-      "integrity": "sha512-C5Pn8Wk+1vKBoHghJODM63yk8MvrO9EWZUfkAt5HAqIgPE4/8FF0PEGHXtEd40l223+cE5ABWuPzm38PHFXfMA==",
+      "version": "6.6.1",
+      "resolved": "https://registry.npmjs.org/engine.io/-/engine.io-6.6.1.tgz",
+      "integrity": "sha512-NEpDCw9hrvBW+hVEOK4T7v0jFJ++KgtPl4jKFwsZVfG1XhS0dCrSb3VMb9gPAd7VAdW52VT1EnaNiU2vM8C0og==",
       "dev": true,
       "dependencies": {
         "@types/cookie": "^0.4.1",
@@ -7084,9 +6146,9 @@
       }
     },
     "node_modules/enhanced-resolve": {
-      "version": "5.17.0",
-      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.17.0.tgz",
-      "integrity": "sha512-dwDPwZL0dmye8Txp2gzFmA6sxALaSvdRDjPH0viLcKrtlOL3tw62nWWweVD1SdILDTJrbrL6tdWVN58Wo6U3eA==",
+      "version": "5.17.1",
+      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.17.1.tgz",
+      "integrity": "sha512-LMHl3dXhTcfv8gM4kEzIUeTQ+7fpdA0l2tUf34BddXPkz2A5xJ5L/Pchd5BL6rdccM9QGvu0sWZzK1Z1t4wwyg==",
       "dev": true,
       "dependencies": {
         "graceful-fs": "^4.2.4",
@@ -7129,6 +6191,18 @@
         "node": ">=6"
       }
     },
+    "node_modules/environment": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/environment/-/environment-1.1.0.tgz",
+      "integrity": "sha512-xUtoPkMggbz0MPyPiIWr1Kp4aeWJjDZ6SMvURhimjdZgsRuDplF5/s9hcgGhyXMhs+6vpnuoiZ2kFiu3FMnS8Q==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/err-code": {
       "version": "2.0.3",
       "resolved": "https://registry.npmjs.org/err-code/-/err-code-2.0.3.tgz",
@@ -7185,59 +6259,60 @@
       "dev": true
     },
     "node_modules/esbuild": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
-      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.23.0.tgz",
+      "integrity": "sha512-1lvV17H2bMYda/WaFb2jLPeHU3zml2k4/yagNMG8Q/YtfMjCwEUZa2eXXMgZTVSL5q1n4H7sQ0X6CdJDqqeCFA==",
       "dev": true,
       "hasInstallScript": true,
       "bin": {
         "esbuild": "bin/esbuild"
       },
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       },
       "optionalDependencies": {
-        "@esbuild/aix-ppc64": "0.21.5",
-        "@esbuild/android-arm": "0.21.5",
-        "@esbuild/android-arm64": "0.21.5",
-        "@esbuild/android-x64": "0.21.5",
-        "@esbuild/darwin-arm64": "0.21.5",
-        "@esbuild/darwin-x64": "0.21.5",
-        "@esbuild/freebsd-arm64": "0.21.5",
-        "@esbuild/freebsd-x64": "0.21.5",
-        "@esbuild/linux-arm": "0.21.5",
-        "@esbuild/linux-arm64": "0.21.5",
-        "@esbuild/linux-ia32": "0.21.5",
-        "@esbuild/linux-loong64": "0.21.5",
-        "@esbuild/linux-mips64el": "0.21.5",
-        "@esbuild/linux-ppc64": "0.21.5",
-        "@esbuild/linux-riscv64": "0.21.5",
-        "@esbuild/linux-s390x": "0.21.5",
-        "@esbuild/linux-x64": "0.21.5",
-        "@esbuild/netbsd-x64": "0.21.5",
-        "@esbuild/openbsd-x64": "0.21.5",
-        "@esbuild/sunos-x64": "0.21.5",
-        "@esbuild/win32-arm64": "0.21.5",
-        "@esbuild/win32-ia32": "0.21.5",
-        "@esbuild/win32-x64": "0.21.5"
+        "@esbuild/aix-ppc64": "0.23.0",
+        "@esbuild/android-arm": "0.23.0",
+        "@esbuild/android-arm64": "0.23.0",
+        "@esbuild/android-x64": "0.23.0",
+        "@esbuild/darwin-arm64": "0.23.0",
+        "@esbuild/darwin-x64": "0.23.0",
+        "@esbuild/freebsd-arm64": "0.23.0",
+        "@esbuild/freebsd-x64": "0.23.0",
+        "@esbuild/linux-arm": "0.23.0",
+        "@esbuild/linux-arm64": "0.23.0",
+        "@esbuild/linux-ia32": "0.23.0",
+        "@esbuild/linux-loong64": "0.23.0",
+        "@esbuild/linux-mips64el": "0.23.0",
+        "@esbuild/linux-ppc64": "0.23.0",
+        "@esbuild/linux-riscv64": "0.23.0",
+        "@esbuild/linux-s390x": "0.23.0",
+        "@esbuild/linux-x64": "0.23.0",
+        "@esbuild/netbsd-x64": "0.23.0",
+        "@esbuild/openbsd-arm64": "0.23.0",
+        "@esbuild/openbsd-x64": "0.23.0",
+        "@esbuild/sunos-x64": "0.23.0",
+        "@esbuild/win32-arm64": "0.23.0",
+        "@esbuild/win32-ia32": "0.23.0",
+        "@esbuild/win32-x64": "0.23.0"
       }
     },
     "node_modules/esbuild-wasm": {
-      "version": "0.21.5",
-      "resolved": "https://registry.npmjs.org/esbuild-wasm/-/esbuild-wasm-0.21.5.tgz",
-      "integrity": "sha512-L/FlOPMMFtw+6qPAbuPvJXdrOYOp9yx/PEwSrIZW0qghY4vgV003evdYDwqQ/9ENMQI0B6RMod9xT4FHtto6OQ==",
+      "version": "0.23.0",
+      "resolved": "https://registry.npmjs.org/esbuild-wasm/-/esbuild-wasm-0.23.0.tgz",
+      "integrity": "sha512-6jP8UmWy6R6TUUV8bMuC3ZyZ6lZKI56x0tkxyCIqWwRRJ/DgeQKneh/Oid5EoGoPFLrGNkz47ZEtWAYuiY/u9g==",
       "dev": true,
       "bin": {
         "esbuild": "bin/esbuild"
       },
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
     "node_modules/escalade": {
-      "version": "3.1.2",
-      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.1.2.tgz",
-      "integrity": "sha512-ErCHMCae19vR8vQGe50xIsVomy19rg6gFu3+r3jkEO46suLMWBksvVyoGgQV+jOfl84ZSOSlmv6Gxa89PmTGmA==",
+      "version": "3.2.0",
+      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
+      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
       "dev": true,
       "engines": {
         "node": ">=6"
@@ -7357,6 +6432,21 @@
         "url": "https://github.com/sindresorhus/execa?sponsor=1"
       }
     },
+    "node_modules/execa/node_modules/onetime": {
+      "version": "5.1.2",
+      "resolved": "https://registry.npmjs.org/onetime/-/onetime-5.1.2.tgz",
+      "integrity": "sha512-kbpaSSGJTWdAY5KPVeMOKXSrPtr8C8C7wodJbcsd51jRnmD+GZu8Y0VoU6Dm5Z4vWr0Ig/1NKuWRKf7j5aaYSg==",
+      "dev": true,
+      "dependencies": {
+        "mimic-fn": "^2.1.0"
+      },
+      "engines": {
+        "node": ">=6"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/execa/node_modules/signal-exit": {
       "version": "3.0.7",
       "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
@@ -7370,37 +6460,37 @@
       "dev": true
     },
     "node_modules/express": {
-      "version": "4.19.2",
-      "resolved": "https://registry.npmjs.org/express/-/express-4.19.2.tgz",
-      "integrity": "sha512-5T6nhjsT+EOMzuck8JjBHARTHfMht0POzlA60WV2pMD3gyXw2LZnZ+ueGdNxG+0calOJcWKbpFcuzLZ91YWq9Q==",
+      "version": "4.21.0",
+      "resolved": "https://registry.npmjs.org/express/-/express-4.21.0.tgz",
+      "integrity": "sha512-VqcNGcj/Id5ZT1LZ/cfihi3ttTn+NJmkli2eZADigjq29qTlWi/hAQ43t/VLPq8+UX06FCEx3ByOYet6ZFblng==",
       "dev": true,
       "dependencies": {
         "accepts": "~1.3.8",
         "array-flatten": "1.1.1",
-        "body-parser": "1.20.2",
+        "body-parser": "1.20.3",
         "content-disposition": "0.5.4",
         "content-type": "~1.0.4",
         "cookie": "0.6.0",
         "cookie-signature": "1.0.6",
         "debug": "2.6.9",
         "depd": "2.0.0",
-        "encodeurl": "~1.0.2",
+        "encodeurl": "~2.0.0",
         "escape-html": "~1.0.3",
         "etag": "~1.8.1",
-        "finalhandler": "1.2.0",
+        "finalhandler": "1.3.1",
         "fresh": "0.5.2",
         "http-errors": "2.0.0",
-        "merge-descriptors": "1.0.1",
+        "merge-descriptors": "1.0.3",
         "methods": "~1.1.2",
         "on-finished": "2.4.1",
         "parseurl": "~1.3.3",
-        "path-to-regexp": "0.1.7",
+        "path-to-regexp": "0.1.10",
         "proxy-addr": "~2.0.7",
-        "qs": "6.11.0",
+        "qs": "6.13.0",
         "range-parser": "~1.2.1",
         "safe-buffer": "5.2.1",
-        "send": "0.18.0",
-        "serve-static": "1.15.0",
+        "send": "0.19.0",
+        "serve-static": "1.16.2",
         "setprototypeof": "1.2.0",
         "statuses": "2.0.1",
         "type-is": "~1.6.18",
@@ -7429,14 +6519,23 @@
         "ms": "2.0.0"
       }
     },
+    "node_modules/express/node_modules/encodeurl": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
+      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
+      "dev": true,
+      "engines": {
+        "node": ">= 0.8"
+      }
+    },
     "node_modules/express/node_modules/finalhandler": {
-      "version": "1.2.0",
-      "resolved": "https://registry.npmjs.org/finalhandler/-/finalhandler-1.2.0.tgz",
-      "integrity": "sha512-5uXcUVftlQMFnWC9qu/svkWv3GTd2PfUhK/3PLkYNAe7FbqJMt3515HaxE6eRL74GdsriiwujiawdaB1BpEISg==",
+      "version": "1.3.1",
+      "resolved": "https://registry.npmjs.org/finalhandler/-/finalhandler-1.3.1.tgz",
+      "integrity": "sha512-6BN9trH7bp3qvnrRyzsBz+g3lZxTNZTbVO2EV1CS0WIcDbawYVdYvGflME/9QP0h0pYlCDBCTjYa9nZzMDpyxQ==",
       "dev": true,
       "dependencies": {
         "debug": "2.6.9",
-        "encodeurl": "~1.0.2",
+        "encodeurl": "~2.0.0",
         "escape-html": "~1.0.3",
         "on-finished": "2.4.1",
         "parseurl": "~1.3.3",
@@ -7510,6 +6609,12 @@
       "integrity": "sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==",
       "dev": true
     },
+    "node_modules/fast-uri": {
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/fast-uri/-/fast-uri-3.0.1.tgz",
+      "integrity": "sha512-MWipKbbYiYI0UC7cl8m/i/IWTqfC8YXsqjzybjddLsFjStroQzsHXkc73JutMvBiXmOvapk+axIl79ig5t55Bw==",
+      "dev": true
+    },
     "node_modules/fastq": {
       "version": "1.17.1",
       "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.17.1.tgz",
@@ -7636,9 +6741,9 @@
       "dev": true
     },
     "node_modules/follow-redirects": {
-      "version": "1.15.6",
-      "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.6.tgz",
-      "integrity": "sha512-wWN62YITEaOpSK584EZXJafH1AGpO8RVgElfkuXbTOrPX4fIfOyEpW/CsiNd8JdYrAoOvafRTOEnvsO++qCqFA==",
+      "version": "1.15.9",
+      "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.9.tgz",
+      "integrity": "sha512-gew4GsXizNgdoRyqmyfMHyAmXsZDk6mHkSxZFCzW9gwlbtOW44CDtYavM+y+72qD/Vq2l550kMF52DT8fOLJqQ==",
       "dev": true,
       "funding": [
         {
@@ -7656,9 +6761,9 @@
       }
     },
     "node_modules/foreground-child": {
-      "version": "3.2.1",
-      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.2.1.tgz",
-      "integrity": "sha512-PXUUyLqrR2XCWICfv6ukppP96sdFwWbNEnfEMt7jNsISjMsvaLNinAHNDYyvkyU+SZG2BTSbT5NjG+vZslfGTA==",
+      "version": "3.3.0",
+      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.3.0.tgz",
+      "integrity": "sha512-Ld2g8rrAyMYFXBhEqMz8ZAHBi4J4uS1i/CxGMDnjyFWddMXLVcDp051DZfu+t7+ab7Wv6SMqpWmyFIj5UbfFvg==",
       "dev": true,
       "dependencies": {
         "cross-spawn": "^7.0.0",
@@ -8231,9 +7336,9 @@
       ]
     },
     "node_modules/ignore": {
-      "version": "5.3.1",
-      "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.1.tgz",
-      "integrity": "sha512-5Fytz/IraMjqpwfd34ke28PTVMjZjJG2MPn5t7OE4eUCUNf8BAa7b5WUS9/Qvr6mwOQS7Mk6vdsMno5he+T8Xw==",
+      "version": "5.3.2",
+      "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.2.tgz",
+      "integrity": "sha512-hsBTNUqQTDwkWtcdYI2i06Y/nUBEsNEDJKjWdigLvegy8kDuJAS8uRlpkkcQpyEXL0Z/pjDy5HBmMjRCJ2gq+g==",
       "dev": true,
       "engines": {
         "node": ">= 4"
@@ -8289,9 +7394,9 @@
       }
     },
     "node_modules/immutable": {
-      "version": "4.3.6",
-      "resolved": "https://registry.npmjs.org/immutable/-/immutable-4.3.6.tgz",
-      "integrity": "sha512-Ju0+lEMyzMVZarkTn/gqRpdqd5dOPaz1mCZ0SH3JV6iFw81PldE/PEB1hWVEA288HPt4WXW8O7AWxB10M+03QQ==",
+      "version": "4.3.7",
+      "resolved": "https://registry.npmjs.org/immutable/-/immutable-4.3.7.tgz",
+      "integrity": "sha512-1hqclzwYwjRDFLjcFxOM5AYkkG0rpFPpr1RLPMEuGczoS7YA8gLhy8SWXYRAA/XwfEHpfo3cw5JGioS32fnMRw==",
       "dev": true
     },
     "node_modules/import-fresh": {
@@ -8395,9 +7500,9 @@
       }
     },
     "node_modules/is-core-module": {
-      "version": "2.15.0",
-      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.15.0.tgz",
-      "integrity": "sha512-Dd+Lb2/zvk9SKy1TGCt1wFJFo/MWBPMX5x7KcvLajWTGuomczdQX61PvY5yK6SVACwpoexWo81IfFyoKY2QnTA==",
+      "version": "2.15.1",
+      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.15.1.tgz",
+      "integrity": "sha512-z0vtXSwucUJtANQWldhbtbt7BnL0vxiFjIdDLAatwhDYty2bad6s+rijD6Ri4YuYJubLzIJLUidCh09e1djEVQ==",
       "dev": true,
       "dependencies": {
         "hasown": "^2.0.2"
@@ -8623,9 +7728,9 @@
       }
     },
     "node_modules/istanbul-lib-instrument": {
-      "version": "6.0.2",
-      "resolved": "https://registry.npmjs.org/istanbul-lib-instrument/-/istanbul-lib-instrument-6.0.2.tgz",
-      "integrity": "sha512-1WUsZ9R1lA0HtBSohTkm39WTPlNKSJ5iFk7UwqXkBLoHQT+hfqPsfsTDVuZdKGaBwn7din9bS7SsnoAr943hvw==",
+      "version": "6.0.3",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-instrument/-/istanbul-lib-instrument-6.0.3.tgz",
+      "integrity": "sha512-Vtgk7L/R2JHyyGW07spoFlB8/lpjiOLTjMdms6AFMraYt3BaJauod/NGrfnVG/y4Ix1JEuMRPDPEj2ua+zz1/Q==",
       "dev": true,
       "dependencies": {
         "@babel/core": "^7.23.9",
@@ -8865,9 +7970,9 @@
       ]
     },
     "node_modules/karma": {
-      "version": "6.4.3",
-      "resolved": "https://registry.npmjs.org/karma/-/karma-6.4.3.tgz",
-      "integrity": "sha512-LuucC/RE92tJ8mlCwqEoRWXP38UMAqpnq98vktmS9SznSoUPPUJQbc91dHcxcunROvfQjdORVA/YFviH+Xci9Q==",
+      "version": "6.4.4",
+      "resolved": "https://registry.npmjs.org/karma/-/karma-6.4.4.tgz",
+      "integrity": "sha512-LrtUxbdvt1gOpo3gxG+VAJlJAEMhbWlM4YrFQgql98FwF7+K8K12LYO4hnDdUkNjeztYrOXEMqgTajSWgmtI/w==",
       "dev": true,
       "dependencies": {
         "@colors/colors": "1.5.0",
@@ -9139,9 +8244,9 @@
       }
     },
     "node_modules/launch-editor": {
-      "version": "2.8.0",
-      "resolved": "https://registry.npmjs.org/launch-editor/-/launch-editor-2.8.0.tgz",
-      "integrity": "sha512-vJranOAJrI/llyWGRQqiDM+adrw+k83fvmmx3+nV47g3+36xM15jE+zyZ6Ffel02+xSvuM0b2GDRosXZkbb6wA==",
+      "version": "2.9.1",
+      "resolved": "https://registry.npmjs.org/launch-editor/-/launch-editor-2.9.1.tgz",
+      "integrity": "sha512-Gcnl4Bd+hRO9P9icCP/RVVT2o8SFlPXofuCxvA2SaZuH45whSvf5p8x5oih5ftLiVhEI4sp5xDY+R+b3zJBh5w==",
       "dev": true,
       "dependencies": {
         "picocolors": "^1.0.0",
@@ -9271,15 +8376,15 @@
       "dev": true
     },
     "node_modules/listr2": {
-      "version": "8.2.3",
-      "resolved": "https://registry.npmjs.org/listr2/-/listr2-8.2.3.tgz",
-      "integrity": "sha512-Lllokma2mtoniUOS94CcOErHWAug5iu7HOmDrvWgpw8jyQH2fomgB+7lZS4HWZxytUuQwkGOwe49FvwVaA85Xw==",
+      "version": "8.2.4",
+      "resolved": "https://registry.npmjs.org/listr2/-/listr2-8.2.4.tgz",
+      "integrity": "sha512-opevsywziHd3zHCVQGAj8zu+Z3yHNkkoYhWIGnq54RrCVwLz0MozotJEDnKsIBLvkfLGN6BLOyAeRrYI0pKA4g==",
       "dev": true,
       "dependencies": {
         "cli-truncate": "^4.0.0",
         "colorette": "^2.0.20",
         "eventemitter3": "^5.0.1",
-        "log-update": "^6.0.0",
+        "log-update": "^6.1.0",
         "rfdc": "^1.4.1",
         "wrap-ansi": "^9.0.0"
       },
@@ -9288,9 +8393,9 @@
       }
     },
     "node_modules/listr2/node_modules/ansi-regex": {
-      "version": "6.0.1",
-      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
-      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.1.0.tgz",
+      "integrity": "sha512-7HSX4QQb4CspciLpVFwyRe79O3xsIZDDLER21kERQ71oaPodF8jL725AgJMFAYbooIqolJoRLuM81SpeUkpkvA==",
       "dev": true,
       "engines": {
         "node": ">=12"
@@ -9350,9 +8455,9 @@
       }
     },
     "node_modules/lmdb": {
-      "version": "3.0.12",
-      "resolved": "https://registry.npmjs.org/lmdb/-/lmdb-3.0.12.tgz",
-      "integrity": "sha512-JnoEulTgveoC64vlYJ9sufGLuNkk6TcxSYpKxSC9aM42I61jIv3pQH0fgb6qW7HV0+FNqA3g1WCQQYfhfawGoQ==",
+      "version": "3.0.13",
+      "resolved": "https://registry.npmjs.org/lmdb/-/lmdb-3.0.13.tgz",
+      "integrity": "sha512-UGe+BbaSUQtAMZobTb4nHvFMrmvuAQKSeaqAX2meTEQjfsbpl5sxdHD8T72OnwD4GU9uwNhYXIVe4QGs8N9Zyw==",
       "dev": true,
       "hasInstallScript": true,
       "dependencies": {
@@ -9366,12 +8471,12 @@
         "download-lmdb-prebuilds": "bin/download-prebuilds.js"
       },
       "optionalDependencies": {
-        "@lmdb/lmdb-darwin-arm64": "3.0.12",
-        "@lmdb/lmdb-darwin-x64": "3.0.12",
-        "@lmdb/lmdb-linux-arm": "3.0.12",
-        "@lmdb/lmdb-linux-arm64": "3.0.12",
-        "@lmdb/lmdb-linux-x64": "3.0.12",
-        "@lmdb/lmdb-win32-x64": "3.0.12"
+        "@lmdb/lmdb-darwin-arm64": "3.0.13",
+        "@lmdb/lmdb-darwin-x64": "3.0.13",
+        "@lmdb/lmdb-linux-arm": "3.0.13",
+        "@lmdb/lmdb-linux-arm64": "3.0.13",
+        "@lmdb/lmdb-linux-x64": "3.0.13",
+        "@lmdb/lmdb-win32-x64": "3.0.13"
       }
     },
     "node_modules/loader-runner": {
@@ -9506,14 +8611,14 @@
       }
     },
     "node_modules/log-update": {
-      "version": "6.0.0",
-      "resolved": "https://registry.npmjs.org/log-update/-/log-update-6.0.0.tgz",
-      "integrity": "sha512-niTvB4gqvtof056rRIrTZvjNYE4rCUzO6X/X+kYjd7WFxXeJ0NwEFnRxX6ehkvv3jTwrXnNdtAak5XYZuIyPFw==",
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/log-update/-/log-update-6.1.0.tgz",
+      "integrity": "sha512-9ie8ItPR6tjY5uYJh8K/Zrv/RMZ5VOlOWvtZdEHYSTFKZfIBPQa9tOAEeAWhd+AnIneLJ22w5fjOYtoutpWq5w==",
       "dev": true,
       "dependencies": {
-        "ansi-escapes": "^6.2.0",
-        "cli-cursor": "^4.0.0",
-        "slice-ansi": "^7.0.0",
+        "ansi-escapes": "^7.0.0",
+        "cli-cursor": "^5.0.0",
+        "slice-ansi": "^7.1.0",
         "strip-ansi": "^7.1.0",
         "wrap-ansi": "^9.0.0"
       },
@@ -9525,21 +8630,24 @@
       }
     },
     "node_modules/log-update/node_modules/ansi-escapes": {
-      "version": "6.2.1",
-      "resolved": "https://registry.npmjs.org/ansi-escapes/-/ansi-escapes-6.2.1.tgz",
-      "integrity": "sha512-4nJ3yixlEthEJ9Rk4vPcdBRkZvQZlYyu8j4/Mqz5sgIkddmEnH2Yj2ZrnP9S3tQOvSNRUIgVNF/1yPpRAGNRig==",
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/ansi-escapes/-/ansi-escapes-7.0.0.tgz",
+      "integrity": "sha512-GdYO7a61mR0fOlAsvC9/rIHf7L96sBc6dEWzeOu+KAea5bZyQRPIpojrVoI4AXGJS/ycu/fBTdLrUkA4ODrvjw==",
       "dev": true,
+      "dependencies": {
+        "environment": "^1.0.0"
+      },
       "engines": {
-        "node": ">=14.16"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/log-update/node_modules/ansi-regex": {
-      "version": "6.0.1",
-      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
-      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.1.0.tgz",
+      "integrity": "sha512-7HSX4QQb4CspciLpVFwyRe79O3xsIZDDLER21kERQ71oaPodF8jL725AgJMFAYbooIqolJoRLuM81SpeUkpkvA==",
       "dev": true,
       "engines": {
         "node": ">=12"
@@ -9649,12 +8757,12 @@
       }
     },
     "node_modules/magic-string": {
-      "version": "0.30.10",
-      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.10.tgz",
-      "integrity": "sha512-iIRwTIf0QKV3UAnYK4PU8uiEc4SRh5jX0mwpIwETPpHdhVM4f53RSwS/vXvN1JhGX+Cs7B8qIq3d6AH49O5fAQ==",
+      "version": "0.30.11",
+      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.11.tgz",
+      "integrity": "sha512-+Wri9p0QHMy+545hKww7YAu5NyzF8iomPL/RQazugQ9+Ez4Ic3mERMd8ZTX5rfK944j+560ZJi8iAwgak1Ac7A==",
       "dev": true,
       "dependencies": {
-        "@jridgewell/sourcemap-codec": "^1.4.15"
+        "@jridgewell/sourcemap-codec": "^1.5.0"
       }
     },
     "node_modules/make-dir": {
@@ -9705,13 +8813,13 @@
       }
     },
     "node_modules/memfs": {
-      "version": "4.9.3",
-      "resolved": "https://registry.npmjs.org/memfs/-/memfs-4.9.3.tgz",
-      "integrity": "sha512-bsYSSnirtYTWi1+OPMFb0M048evMKyUYe0EbtuGQgq6BVQM1g1W8/KIUJCCvjgI/El0j6Q4WsmMiBwLUBSw8LA==",
+      "version": "4.12.0",
+      "resolved": "https://registry.npmjs.org/memfs/-/memfs-4.12.0.tgz",
+      "integrity": "sha512-74wDsex5tQDSClVkeK1vtxqYCAgCoXxx+K4NSHzgU/muYVYByFqa+0RnrPO9NM6naWm1+G9JmZ0p6QHhXmeYfA==",
       "dev": true,
       "dependencies": {
         "@jsonjoy.com/json-pack": "^1.0.3",
-        "@jsonjoy.com/util": "^1.1.2",
+        "@jsonjoy.com/util": "^1.3.0",
         "tree-dump": "^1.0.1",
         "tslib": "^2.0.0"
       },
@@ -9724,10 +8832,13 @@
       }
     },
     "node_modules/merge-descriptors": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-1.0.1.tgz",
-      "integrity": "sha512-cCi6g3/Zr1iqQi6ySbseM1Xvooa98N0w31jzUYrXPX2xqObmFGHJ0tQ5u74H3mVh7wLouTseZyYIq39g8cNp1w==",
-      "dev": true
+      "version": "1.0.3",
+      "resolved": "https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
+      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
+      "dev": true,
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
     },
     "node_modules/merge-stream": {
       "version": "2.0.0",
@@ -9754,9 +8865,9 @@
       }
     },
     "node_modules/micromatch": {
-      "version": "4.0.7",
-      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.7.tgz",
-      "integrity": "sha512-LPP/3KorzCwBxfeUuZmaR6bG2kdeHSbe0P2tY3FLRU4vYrjYz5hI4QZwV0njUx3jeuKe67YukQ1LSPZBKDqO/Q==",
+      "version": "4.0.8",
+      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
+      "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
       "dev": true,
       "dependencies": {
         "braces": "^3.0.3",
@@ -9820,6 +8931,18 @@
         "node": ">=6"
       }
     },
+    "node_modules/mimic-function": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/mimic-function/-/mimic-function-5.0.1.tgz",
+      "integrity": "sha512-VP79XUPxV2CigYP3jWwAUFSku2aKqBH7uTAapFWCBqutsbmDo96KY5o8uh6U+/YSIn5OxJnXp73beVkpqMIGhA==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/mini-css-extract-plugin": {
       "version": "2.9.0",
       "resolved": "https://registry.npmjs.org/mini-css-extract-plugin/-/mini-css-extract-plugin-2.9.0.tgz",
@@ -10048,9 +9171,9 @@
       }
     },
     "node_modules/ms": {
-      "version": "2.1.2",
-      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.2.tgz",
-      "integrity": "sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w==",
+      "version": "2.1.3",
+      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
+      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
       "dev": true
     },
     "node_modules/msgpackr": {
@@ -10247,9 +9370,9 @@
       }
     },
     "node_modules/node-gyp-build": {
-      "version": "4.8.1",
-      "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.1.tgz",
-      "integrity": "sha512-OSs33Z9yWr148JZcbZd5WiAXhh/n9z8TxQcdMhIOlpN9AhWpLfvVFO73+m77bBABQMaY9XSvIa+qk0jlI7Gcaw==",
+      "version": "4.8.2",
+      "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.2.tgz",
+      "integrity": "sha512-IRUxE4BVsHWXkV/SFOut4qTlagw2aM8T5/vnTsmrHJvVoKueJHRc/JaFND7QDDc61kLYUJ6qlZM3sqTSyx2dTw==",
       "dev": true,
       "optional": true,
       "bin": {
@@ -10341,9 +9464,9 @@
       }
     },
     "node_modules/node-releases": {
-      "version": "2.0.17",
-      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.17.tgz",
-      "integrity": "sha512-Ww6ZlOiEQfPfXM45v17oabk77Z7mg5bOt7AjDyzy7RjK9OrLrLC8dyZQoAPEOtFX9SaNf1Tdvr5gRJWdTJj7GA==",
+      "version": "2.0.18",
+      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.18.tgz",
+      "integrity": "sha512-d9VeXT4SJ7ZeOqGX6R5EM022wpL+eWPooLI+5UpWn2jCT1aosUQEhQP214x33Wkwx3JQMvIm+tIoVOdodFS40g==",
       "dev": true
     },
     "node_modules/nopt": {
@@ -10427,9 +9550,9 @@
       }
     },
     "node_modules/npm-package-arg": {
-      "version": "11.0.2",
-      "resolved": "https://registry.npmjs.org/npm-package-arg/-/npm-package-arg-11.0.2.tgz",
-      "integrity": "sha512-IGN0IAwmhDJwy13Wc8k+4PEbTPhpJnMtfR53ZbOyjkvmEcLS4nCwp6mvMWjS5sUjeiW3mpx6cHmuhKEu9XmcQw==",
+      "version": "11.0.3",
+      "resolved": "https://registry.npmjs.org/npm-package-arg/-/npm-package-arg-11.0.3.tgz",
+      "integrity": "sha512-sHGJy8sOC1YraBywpzQlIKBE4pBbGbiF95U6Auspzyem956E0+FtDtsx1ZxlOJkQCZ1AFXAY/yuvtFYrOxF+Bw==",
       "dev": true,
       "dependencies": {
         "hosted-git-info": "^7.0.0",
@@ -10454,9 +9577,9 @@
       }
     },
     "node_modules/npm-pick-manifest": {
-      "version": "9.0.1",
-      "resolved": "https://registry.npmjs.org/npm-pick-manifest/-/npm-pick-manifest-9.0.1.tgz",
-      "integrity": "sha512-Udm1f0l2nXb3wxDpKjfohwgdFUSV50UVwzEIpDXVsbDMXVIEF81a/i0UhuQbhrPMMmdiq3+YMFLFIRVLs3hxQw==",
+      "version": "9.1.0",
+      "resolved": "https://registry.npmjs.org/npm-pick-manifest/-/npm-pick-manifest-9.1.0.tgz",
+      "integrity": "sha512-nkc+3pIIhqHVQr085X9d2JzPzLyjzQS96zbruppqC9aZRm/x8xx6xhI98gHtsfELP2bE+loHq8ZaHFHhe+NauA==",
       "dev": true,
       "dependencies": {
         "npm-install-checks": "^6.0.0",
@@ -10569,15 +9692,15 @@
       }
     },
     "node_modules/onetime": {
-      "version": "5.1.2",
-      "resolved": "https://registry.npmjs.org/onetime/-/onetime-5.1.2.tgz",
-      "integrity": "sha512-kbpaSSGJTWdAY5KPVeMOKXSrPtr8C8C7wodJbcsd51jRnmD+GZu8Y0VoU6Dm5Z4vWr0Ig/1NKuWRKf7j5aaYSg==",
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/onetime/-/onetime-7.0.0.tgz",
+      "integrity": "sha512-VXJjc87FScF88uafS3JllDgvAm+c/Slfz06lorj2uAY34rlUu0Nt+v8wreiImcrgAjjIHp1rXpTDlLOGw29WwQ==",
       "dev": true,
       "dependencies": {
-        "mimic-fn": "^2.1.0"
+        "mimic-function": "^5.0.0"
       },
       "engines": {
-        "node": ">=6"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
@@ -10694,6 +9817,21 @@
         "node": ">=8"
       }
     },
+    "node_modules/ora/node_modules/onetime": {
+      "version": "5.1.2",
+      "resolved": "https://registry.npmjs.org/onetime/-/onetime-5.1.2.tgz",
+      "integrity": "sha512-kbpaSSGJTWdAY5KPVeMOKXSrPtr8C8C7wodJbcsd51jRnmD+GZu8Y0VoU6Dm5Z4vWr0Ig/1NKuWRKf7j5aaYSg==",
+      "dev": true,
+      "dependencies": {
+        "mimic-fn": "^2.1.0"
+      },
+      "engines": {
+        "node": ">=6"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/ora/node_modules/restore-cursor": {
       "version": "3.1.0",
       "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-3.1.0.tgz",
@@ -10996,9 +10134,9 @@
       "dev": true
     },
     "node_modules/path-to-regexp": {
-      "version": "0.1.7",
-      "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.7.tgz",
-      "integrity": "sha512-5DFkuoqlv1uYQKxy8omFBeJPQcdoE07Kv2sferDCrAq1ohOU+MSDswDIbnx3YAM60qIOnYa53wBhXW0EbMonrQ==",
+      "version": "0.1.10",
+      "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.10.tgz",
+      "integrity": "sha512-7lf7qcQidTku0Gu3YDPc8DJ1q7OOucfa/BSsIwjuh56VU7katFvuM8hULfkwB3Fns/rsVF7PwPKVw1sl5KQS9w==",
       "dev": true
     },
     "node_modules/path-type": {
@@ -11014,9 +10152,9 @@
       }
     },
     "node_modules/picocolors": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.0.1.tgz",
-      "integrity": "sha512-anP1Z8qwhkbmu7MFP5iTt+wQKXgwzf7zTyGlcdzabySa9vd0Xt392U0rVmz9poOaBj0uHJKyyo9/upk0HrEQew==",
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.0.tgz",
+      "integrity": "sha512-TQ92mBOW0l3LeMeyLV6mzy/kWr8lkd/hp3mTg7wYK7zJhuBStmGMBG0BdeDZS/dZx1IukaX6Bk11zcln25o1Aw==",
       "dev": true
     },
     "node_modules/picomatch": {
@@ -11066,9 +10204,9 @@
       }
     },
     "node_modules/postcss": {
-      "version": "8.4.38",
-      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.38.tgz",
-      "integrity": "sha512-Wglpdk03BSfXkHoQa3b/oulrotAkwrlLDRSOb9D0bN86FdRyE9lppSp33aHNPgBa0JKCoB+drFLZkQoRRYae5A==",
+      "version": "8.4.41",
+      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.41.tgz",
+      "integrity": "sha512-TesUflQ0WKZqAvg52PWL6kHgLKP6xB6heTOdoYM0Wt2UHyxNa4K25EZZMgKns3BH1RLVbZCREPpLY0rhnNoHVQ==",
       "dev": true,
       "funding": [
         {
@@ -11086,7 +10224,7 @@
       ],
       "dependencies": {
         "nanoid": "^3.3.7",
-        "picocolors": "^1.0.0",
+        "picocolors": "^1.0.1",
         "source-map-js": "^1.2.0"
       },
       "engines": {
@@ -11190,9 +10328,9 @@
       }
     },
     "node_modules/postcss-selector-parser": {
-      "version": "6.1.1",
-      "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.1.tgz",
-      "integrity": "sha512-b4dlw/9V8A71rLIDsSwVmak9z2DuBUB7CA1/wSdelNEzqsjoSPeADTWNO09lpH49Diy3/JIZ2bSPB1dI3LJCHg==",
+      "version": "6.1.2",
+      "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.2.tgz",
+      "integrity": "sha512-Q8qQfPiZ+THO/3ZrOrO0cJJKfpYCagtMUkXbnEfmgUjwXg6z/WBeOyS9APBBPCTSiDV+s4SwQGu8yFsiMRIudg==",
       "dev": true,
       "dependencies": {
         "cssesc": "^3.0.0",
@@ -11302,12 +10440,12 @@
       }
     },
     "node_modules/qs": {
-      "version": "6.11.0",
-      "resolved": "https://registry.npmjs.org/qs/-/qs-6.11.0.tgz",
-      "integrity": "sha512-MvjoMCJwEarSbUYk5O+nmoSzSutSsTwF85zcHPQ9OrlFoZOYIjaqBAJIqIXjptyD5vThxGq52Xu/MaJzRkIk4Q==",
+      "version": "6.13.0",
+      "resolved": "https://registry.npmjs.org/qs/-/qs-6.13.0.tgz",
+      "integrity": "sha512-+38qI9SOr8tfZ4QmJNplMUxqjbe7LKvvZgWdExBOmd+egZTtjLB67Gu0HRX3u/XOq7UU2Nx6nsjvS16Z9uwfpg==",
       "dev": true,
       "dependencies": {
-        "side-channel": "^1.0.4"
+        "side-channel": "^1.0.6"
       },
       "engines": {
         "node": ">=0.6"
@@ -11420,9 +10558,9 @@
       "dev": true
     },
     "node_modules/regenerate-unicode-properties": {
-      "version": "10.1.1",
-      "resolved": "https://registry.npmjs.org/regenerate-unicode-properties/-/regenerate-unicode-properties-10.1.1.tgz",
-      "integrity": "sha512-X007RyZLsCJVVrjgEFVpLUTZwyOZk3oiL75ZcuYjlIWd6rNJtOjkBwQc5AsRrpbKVkxN6sklw/k/9m2jJYOf8Q==",
+      "version": "10.2.0",
+      "resolved": "https://registry.npmjs.org/regenerate-unicode-properties/-/regenerate-unicode-properties-10.2.0.tgz",
+      "integrity": "sha512-DqHn3DwbmmPVzeKj9woBadqmXxLvQoQIwu7nopMc72ztvxVmVk2SBhSnx67zuye5TP+lJsb/TBQsjLKhnDf3MA==",
       "dev": true,
       "dependencies": {
         "regenerate": "^1.4.2"
@@ -11580,27 +10718,21 @@
       }
     },
     "node_modules/restore-cursor": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-4.0.0.tgz",
-      "integrity": "sha512-I9fPXU9geO9bHOt9pHHOhOkYerIMsmVaWB0rA2AI9ERh/+x/i7MV5HKBNrg+ljO5eoPVgCcnFuRjJ9uH6I/3eg==",
+      "version": "5.1.0",
+      "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-5.1.0.tgz",
+      "integrity": "sha512-oMA2dcrw6u0YfxJQXm342bFKX/E4sG9rbTzO9ptUcR/e8A33cHuvStiYOwH7fszkZlZ1z/ta9AAoPk2F4qIOHA==",
       "dev": true,
       "dependencies": {
-        "onetime": "^5.1.0",
-        "signal-exit": "^3.0.2"
+        "onetime": "^7.0.0",
+        "signal-exit": "^4.1.0"
       },
       "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/restore-cursor/node_modules/signal-exit": {
-      "version": "3.0.7",
-      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
-      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
-      "dev": true
-    },
     "node_modules/retry": {
       "version": "0.12.0",
       "resolved": "https://registry.npmjs.org/retry/-/retry-0.12.0.tgz",
@@ -11643,9 +10775,9 @@
       }
     },
     "node_modules/rollup": {
-      "version": "4.18.0",
-      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.18.0.tgz",
-      "integrity": "sha512-QmJz14PX3rzbJCN1SG4Xe/bAAX2a6NpCP8ab2vfu2GiUr8AQcr2nCV/oEO3yneFarB67zk8ShlIyWb2LGTb3Sg==",
+      "version": "4.20.0",
+      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.20.0.tgz",
+      "integrity": "sha512-6rbWBChcnSGzIlXeIdNIZTopKYad8ZG8ajhl78lGRLsI2rX8IkaotQhVas2Ma+GPxJav19wrSzvRvuiv0YKzWw==",
       "dev": true,
       "dependencies": {
         "@types/estree": "1.0.5"
@@ -11658,22 +10790,22 @@
         "npm": ">=8.0.0"
       },
       "optionalDependencies": {
-        "@rollup/rollup-android-arm-eabi": "4.18.0",
-        "@rollup/rollup-android-arm64": "4.18.0",
-        "@rollup/rollup-darwin-arm64": "4.18.0",
-        "@rollup/rollup-darwin-x64": "4.18.0",
-        "@rollup/rollup-linux-arm-gnueabihf": "4.18.0",
-        "@rollup/rollup-linux-arm-musleabihf": "4.18.0",
-        "@rollup/rollup-linux-arm64-gnu": "4.18.0",
-        "@rollup/rollup-linux-arm64-musl": "4.18.0",
-        "@rollup/rollup-linux-powerpc64le-gnu": "4.18.0",
-        "@rollup/rollup-linux-riscv64-gnu": "4.18.0",
-        "@rollup/rollup-linux-s390x-gnu": "4.18.0",
-        "@rollup/rollup-linux-x64-gnu": "4.18.0",
-        "@rollup/rollup-linux-x64-musl": "4.18.0",
-        "@rollup/rollup-win32-arm64-msvc": "4.18.0",
-        "@rollup/rollup-win32-ia32-msvc": "4.18.0",
-        "@rollup/rollup-win32-x64-msvc": "4.18.0",
+        "@rollup/rollup-android-arm-eabi": "4.20.0",
+        "@rollup/rollup-android-arm64": "4.20.0",
+        "@rollup/rollup-darwin-arm64": "4.20.0",
+        "@rollup/rollup-darwin-x64": "4.20.0",
+        "@rollup/rollup-linux-arm-gnueabihf": "4.20.0",
+        "@rollup/rollup-linux-arm-musleabihf": "4.20.0",
+        "@rollup/rollup-linux-arm64-gnu": "4.20.0",
+        "@rollup/rollup-linux-arm64-musl": "4.20.0",
+        "@rollup/rollup-linux-powerpc64le-gnu": "4.20.0",
+        "@rollup/rollup-linux-riscv64-gnu": "4.20.0",
+        "@rollup/rollup-linux-s390x-gnu": "4.20.0",
+        "@rollup/rollup-linux-x64-gnu": "4.20.0",
+        "@rollup/rollup-linux-x64-musl": "4.20.0",
+        "@rollup/rollup-win32-arm64-msvc": "4.20.0",
+        "@rollup/rollup-win32-ia32-msvc": "4.20.0",
+        "@rollup/rollup-win32-x64-msvc": "4.20.0",
         "fsevents": "~2.3.2"
       }
     },
@@ -11746,11 +10878,6 @@
       "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
       "dev": true
     },
-    "node_modules/safevalues": {
-      "version": "0.3.4",
-      "resolved": "https://registry.npmjs.org/safevalues/-/safevalues-0.3.4.tgz",
-      "integrity": "sha512-LRneZZRXNgjzwG4bDQdOTSbze3fHm1EAKN/8bePxnlEZiBmkYEDggaHbuvHI9/hoqHbGfsEA7tWS9GhYHZBBsw=="
-    },
     "node_modules/sass": {
       "version": "1.77.6",
       "resolved": "https://registry.npmjs.org/sass/-/sass-1.77.6.tgz",
@@ -11769,9 +10896,9 @@
       }
     },
     "node_modules/sass-loader": {
-      "version": "14.2.1",
-      "resolved": "https://registry.npmjs.org/sass-loader/-/sass-loader-14.2.1.tgz",
-      "integrity": "sha512-G0VcnMYU18a4N7VoNDegg2OuMjYtxnqzQWARVWCIVSZwJeiL9kg8QMsuIZOplsJgTzZLF6jGxI3AClj8I9nRdQ==",
+      "version": "16.0.0",
+      "resolved": "https://registry.npmjs.org/sass-loader/-/sass-loader-16.0.0.tgz",
+      "integrity": "sha512-n13Z+3rU9A177dk4888czcVFiC8CL9dii4qpXWUg3YIIgZEvi9TCFKjOQcbK0kJM7DJu9VucrZFddvNfYCPwtw==",
       "dev": true,
       "dependencies": {
         "neo-async": "^2.6.2"
@@ -11871,9 +10998,9 @@
       }
     },
     "node_modules/semver": {
-      "version": "7.6.2",
-      "resolved": "https://registry.npmjs.org/semver/-/semver-7.6.2.tgz",
-      "integrity": "sha512-FNAIBWCx9qcRhoHcgcJ0gvU7SN1lYU2ZXuSfl04bSC5OpvDHFyJCjdNHomPXxjQlCBU67YW64PzY7/VIEH7F2w==",
+      "version": "7.6.3",
+      "resolved": "https://registry.npmjs.org/semver/-/semver-7.6.3.tgz",
+      "integrity": "sha512-oVekP1cKtI+CTDvHWYFUcMtsK/00wmAEfyqKfNdARm8u1wNVhSgaX7A8d4UuIlUI5e84iEwOhs7ZPYRmzU9U6A==",
       "dev": true,
       "bin": {
         "semver": "bin/semver.js"
@@ -11883,9 +11010,9 @@
       }
     },
     "node_modules/send": {
-      "version": "0.18.0",
-      "resolved": "https://registry.npmjs.org/send/-/send-0.18.0.tgz",
-      "integrity": "sha512-qqWzuOjSFOuqPjFe4NOsMLafToQQwBSOEpS+FwEt3A2V3vKubTquT3vmLTQpFgMXp8AlFWFuP1qKaJZOtPpVXg==",
+      "version": "0.19.0",
+      "resolved": "https://registry.npmjs.org/send/-/send-0.19.0.tgz",
+      "integrity": "sha512-dW41u5VfLXu8SJh5bwRmyYUbAoSB3c9uQh6L8h/KtsFREPWpbX1lrljJo186Jc4nmci/sGUZ9a0a0J2zgfq2hw==",
       "dev": true,
       "dependencies": {
         "debug": "2.6.9",
@@ -11933,12 +11060,6 @@
         "node": ">=4"
       }
     },
-    "node_modules/send/node_modules/ms": {
-      "version": "2.1.3",
-      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
-      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
-      "dev": true
-    },
     "node_modules/send/node_modules/statuses": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.1.tgz",
@@ -12027,20 +11148,29 @@
       "dev": true
     },
     "node_modules/serve-static": {
-      "version": "1.15.0",
-      "resolved": "https://registry.npmjs.org/serve-static/-/serve-static-1.15.0.tgz",
-      "integrity": "sha512-XGuRDNjXUijsUL0vl6nSD7cwURuzEgglbOaFuZM9g3kwDXOWVTck0jLzjPzGD+TazWbboZYu52/9/XPdUgne9g==",
+      "version": "1.16.2",
+      "resolved": "https://registry.npmjs.org/serve-static/-/serve-static-1.16.2.tgz",
+      "integrity": "sha512-VqpjJZKadQB/PEbEwvFdO43Ax5dFBZ2UECszz8bQ7pi7wt//PWe1P6MN7eCnjsatYtBT6EuiClbjSWP2WrIoTw==",
       "dev": true,
       "dependencies": {
-        "encodeurl": "~1.0.2",
+        "encodeurl": "~2.0.0",
         "escape-html": "~1.0.3",
         "parseurl": "~1.3.3",
-        "send": "0.18.0"
+        "send": "0.19.0"
       },
       "engines": {
         "node": ">= 0.8.0"
       }
     },
+    "node_modules/serve-static/node_modules/encodeurl": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
+      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
+      "dev": true,
+      "engines": {
+        "node": ">= 0.8"
+      }
+    },
     "node_modules/set-function-length": {
       "version": "1.2.2",
       "resolved": "https://registry.npmjs.org/set-function-length/-/set-function-length-1.2.2.tgz",
@@ -12204,16 +11334,16 @@
       }
     },
     "node_modules/socket.io": {
-      "version": "4.7.5",
-      "resolved": "https://registry.npmjs.org/socket.io/-/socket.io-4.7.5.tgz",
-      "integrity": "sha512-DmeAkF6cwM9jSfmp6Dr/5/mfMwb5Z5qRrSXLpo3Fq5SqyU8CMF15jIN4ZhfSwu35ksM1qmHZDQ/DK5XTccSTvA==",
+      "version": "4.8.0",
+      "resolved": "https://registry.npmjs.org/socket.io/-/socket.io-4.8.0.tgz",
+      "integrity": "sha512-8U6BEgGjQOfGz3HHTYaC/L1GaxDCJ/KM0XTkJly0EhZ5U/du9uNEZy4ZgYzEzIqlx2CMm25CrCqr1ck899eLNA==",
       "dev": true,
       "dependencies": {
         "accepts": "~1.3.4",
         "base64id": "~2.0.0",
         "cors": "~2.8.5",
         "debug": "~4.3.2",
-        "engine.io": "~6.5.2",
+        "engine.io": "~6.6.0",
         "socket.io-adapter": "~2.5.2",
         "socket.io-parser": "~4.2.4"
       },
@@ -12293,9 +11423,9 @@
       }
     },
     "node_modules/source-map-js": {
-      "version": "1.2.0",
-      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.0.tgz",
-      "integrity": "sha512-itJW8lvSA0TXEphiRoawsCksnlf8SyvmFzIhltqAHluXd88pkCd+cXJVHTDwdCr0IzwptSm035IHQktUu1QUMg==",
+      "version": "1.2.1",
+      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
+      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
       "dev": true,
       "engines": {
         "node": ">=0.10.0"
@@ -12379,9 +11509,9 @@
       }
     },
     "node_modules/spdx-license-ids": {
-      "version": "3.0.18",
-      "resolved": "https://registry.npmjs.org/spdx-license-ids/-/spdx-license-ids-3.0.18.tgz",
-      "integrity": "sha512-xxRs31BqRYHwiMzudOrpSiHtZ8i/GeionCBDSilhYRj+9gIcI8wCZTlXZKu9vZIVqViP3dcp9qE5G6AlIaD+TQ==",
+      "version": "3.0.20",
+      "resolved": "https://registry.npmjs.org/spdx-license-ids/-/spdx-license-ids-3.0.20.tgz",
+      "integrity": "sha512-jg25NiDV/1fLtSgEgyvVyDunvaNHbuwF9lfNV17gSmPFAlYzdfNBlLtLzXTevwkPj7DhGbmN9VnmJIgLnhvaBw==",
       "dev": true
     },
     "node_modules/spdy": {
@@ -12512,9 +11642,9 @@
       }
     },
     "node_modules/string-width/node_modules/ansi-regex": {
-      "version": "6.0.1",
-      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
-      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.1.0.tgz",
+      "integrity": "sha512-7HSX4QQb4CspciLpVFwyRe79O3xsIZDDLER21kERQ71oaPodF8jL725AgJMFAYbooIqolJoRLuM81SpeUkpkvA==",
       "dev": true,
       "engines": {
         "node": ">=12"
@@ -12683,9 +11813,9 @@
       "dev": true
     },
     "node_modules/terser": {
-      "version": "5.29.2",
-      "resolved": "https://registry.npmjs.org/terser/-/terser-5.29.2.tgz",
-      "integrity": "sha512-ZiGkhUBIM+7LwkNjXYJq8svgkd+QK3UUr0wJqY4MieaezBSAIPgbSPZyIx0idM6XWK5CMzSWa8MJIzmRcB8Caw==",
+      "version": "5.31.6",
+      "resolved": "https://registry.npmjs.org/terser/-/terser-5.31.6.tgz",
+      "integrity": "sha512-PQ4DAriWzKj+qgehQ7LK5bQqCFNMmlhjR2PFFLuqGCpuCAauxemVBWwWOxo3UIwWQx8+Pr61Df++r76wDmkQBg==",
       "dev": true,
       "dependencies": {
         "@jridgewell/source-map": "^0.3.3",
@@ -12765,457 +11895,889 @@
       "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
       "dev": true
     },
-    "node_modules/terser-webpack-plugin/node_modules/schema-utils": {
-      "version": "3.3.0",
-      "resolved": "https://registry.npmjs.org/schema-utils/-/schema-utils-3.3.0.tgz",
-      "integrity": "sha512-pN/yOAvcC+5rQ5nERGuwrjLlYvLTbCibnZ1I7B1LaiAz9BRBlE9GMgE/eqV30P7aJQUf7Ddimy/RsbYO/GrVGg==",
+    "node_modules/terser-webpack-plugin/node_modules/schema-utils": {
+      "version": "3.3.0",
+      "resolved": "https://registry.npmjs.org/schema-utils/-/schema-utils-3.3.0.tgz",
+      "integrity": "sha512-pN/yOAvcC+5rQ5nERGuwrjLlYvLTbCibnZ1I7B1LaiAz9BRBlE9GMgE/eqV30P7aJQUf7Ddimy/RsbYO/GrVGg==",
+      "dev": true,
+      "dependencies": {
+        "@types/json-schema": "^7.0.8",
+        "ajv": "^6.12.5",
+        "ajv-keywords": "^3.5.2"
+      },
+      "engines": {
+        "node": ">= 10.13.0"
+      },
+      "funding": {
+        "type": "opencollective",
+        "url": "https://opencollective.com/webpack"
+      }
+    },
+    "node_modules/thingies": {
+      "version": "1.21.0",
+      "resolved": "https://registry.npmjs.org/thingies/-/thingies-1.21.0.tgz",
+      "integrity": "sha512-hsqsJsFMsV+aD4s3CWKk85ep/3I9XzYV/IXaSouJMYIoDlgyi11cBhsqYe9/geRfB0YIikBQg6raRaM+nIMP9g==",
+      "dev": true,
+      "engines": {
+        "node": ">=10.18"
+      },
+      "peerDependencies": {
+        "tslib": "^2"
+      }
+    },
+    "node_modules/thunky": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/thunky/-/thunky-1.1.0.tgz",
+      "integrity": "sha512-eHY7nBftgThBqOyHGVN+l8gF0BucP09fMo0oO/Lb0w1OF80dJv+lDVpXG60WMQvkcxAkNybKsrEIE3ZtKGmPrA==",
+      "dev": true
+    },
+    "node_modules/tmp": {
+      "version": "0.0.33",
+      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.0.33.tgz",
+      "integrity": "sha512-jRCJlojKnZ3addtTOjdIqoRuPEKBvNXcGYqzO6zWZX8KfKEpnGY5jfggJQ3EjKuu8D4bJRr0y+cYJFmYbImXGw==",
+      "dev": true,
+      "dependencies": {
+        "os-tmpdir": "~1.0.2"
+      },
+      "engines": {
+        "node": ">=0.6.0"
+      }
+    },
+    "node_modules/to-fast-properties": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
+      "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
+      "dev": true,
+      "engines": {
+        "node": ">=4"
+      }
+    },
+    "node_modules/to-regex-range": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
+      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
+      "dev": true,
+      "dependencies": {
+        "is-number": "^7.0.0"
+      },
+      "engines": {
+        "node": ">=8.0"
+      }
+    },
+    "node_modules/toidentifier": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
+      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
+      "dev": true,
+      "engines": {
+        "node": ">=0.6"
+      }
+    },
+    "node_modules/tree-dump": {
+      "version": "1.0.2",
+      "resolved": "https://registry.npmjs.org/tree-dump/-/tree-dump-1.0.2.tgz",
+      "integrity": "sha512-dpev9ABuLWdEubk+cIaI9cHwRNNDjkBBLXTwI4UCUFdQ5xXKqNXoK4FEciw/vxf+NQ7Cb7sGUyeUtORvHIdRXQ==",
+      "dev": true,
+      "engines": {
+        "node": ">=10.0"
+      },
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
+      },
+      "peerDependencies": {
+        "tslib": "2"
+      }
+    },
+    "node_modules/tree-kill": {
+      "version": "1.2.2",
+      "resolved": "https://registry.npmjs.org/tree-kill/-/tree-kill-1.2.2.tgz",
+      "integrity": "sha512-L0Orpi8qGpRG//Nd+H90vFB+3iHnue1zSSGmNOOCh1GLJ7rUKVwV2HvijphGQS2UmhUZewS9VgvxYIdgr+fG1A==",
+      "dev": true,
+      "bin": {
+        "tree-kill": "cli.js"
+      }
+    },
+    "node_modules/tslib": {
+      "version": "2.7.0",
+      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.7.0.tgz",
+      "integrity": "sha512-gLXCKdN1/j47AiHiOkJN69hJmcbGTHI0ImLmbYLHykhgeN0jVGola9yVjFgzCUklsZQMW55o+dW7IXv3RCXDzA=="
+    },
+    "node_modules/tuf-js": {
+      "version": "2.2.1",
+      "resolved": "https://registry.npmjs.org/tuf-js/-/tuf-js-2.2.1.tgz",
+      "integrity": "sha512-GwIJau9XaA8nLVbUXsN3IlFi7WmQ48gBUrl3FTkkL/XLu/POhBzfmX9hd33FNMX1qAsfl6ozO1iMmW9NC8YniA==",
+      "dev": true,
+      "dependencies": {
+        "@tufjs/models": "2.0.1",
+        "debug": "^4.3.4",
+        "make-fetch-happen": "^13.0.1"
+      },
+      "engines": {
+        "node": "^16.14.0 || >=18.0.0"
+      }
+    },
+    "node_modules/type-fest": {
+      "version": "0.21.3",
+      "resolved": "https://registry.npmjs.org/type-fest/-/type-fest-0.21.3.tgz",
+      "integrity": "sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==",
+      "dev": true,
+      "engines": {
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/type-is": {
+      "version": "1.6.18",
+      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
+      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
+      "dev": true,
+      "dependencies": {
+        "media-typer": "0.3.0",
+        "mime-types": "~2.1.24"
+      },
+      "engines": {
+        "node": ">= 0.6"
+      }
+    },
+    "node_modules/typed-assert": {
+      "version": "1.0.9",
+      "resolved": "https://registry.npmjs.org/typed-assert/-/typed-assert-1.0.9.tgz",
+      "integrity": "sha512-KNNZtayBCtmnNmbo5mG47p1XsCyrx6iVqomjcZnec/1Y5GGARaxPs6r49RnSPeUP3YjNYiU9sQHAtY4BBvnZwg==",
+      "dev": true
+    },
+    "node_modules/typescript": {
+      "version": "5.4.5",
+      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.4.5.tgz",
+      "integrity": "sha512-vcI4UpRgg81oIRUFwR0WSIHKt11nJ7SAVlYNIu+QpqeyXP+gpQJy/Z4+F0aGxSE4MqwjyXvW/TzgkLAx2AGHwQ==",
+      "dev": true,
+      "bin": {
+        "tsc": "bin/tsc",
+        "tsserver": "bin/tsserver"
+      },
+      "engines": {
+        "node": ">=14.17"
+      }
+    },
+    "node_modules/ua-parser-js": {
+      "version": "0.7.39",
+      "resolved": "https://registry.npmjs.org/ua-parser-js/-/ua-parser-js-0.7.39.tgz",
+      "integrity": "sha512-IZ6acm6RhQHNibSt7+c09hhvsKy9WUr4DVbeq9U8o71qxyYtJpQeDxQnMrVqnIFMLcQjHO0I9wgfO2vIahht4w==",
+      "dev": true,
+      "funding": [
+        {
+          "type": "opencollective",
+          "url": "https://opencollective.com/ua-parser-js"
+        },
+        {
+          "type": "paypal",
+          "url": "https://paypal.me/faisalman"
+        },
+        {
+          "type": "github",
+          "url": "https://github.com/sponsors/faisalman"
+        }
+      ],
+      "bin": {
+        "ua-parser-js": "script/cli.js"
+      },
+      "engines": {
+        "node": "*"
+      }
+    },
+    "node_modules/undici-types": {
+      "version": "6.19.8",
+      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-6.19.8.tgz",
+      "integrity": "sha512-ve2KP6f/JnbPBFyobGHuerC9g1FYGn/F8n1LWTwNxCEzd6IfqTwUQcNXgEtmmQ6DlRrC1hrSrBnCZPokRrDHjw==",
+      "dev": true
+    },
+    "node_modules/unicode-canonical-property-names-ecmascript": {
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/unicode-canonical-property-names-ecmascript/-/unicode-canonical-property-names-ecmascript-2.0.1.tgz",
+      "integrity": "sha512-dA8WbNeb2a6oQzAQ55YlT5vQAWGV9WXOsi3SskE3bcCdM0P4SDd+24zS/OCacdRq5BkdsRj9q3Pg6YyQoxIGqg==",
+      "dev": true,
+      "engines": {
+        "node": ">=4"
+      }
+    },
+    "node_modules/unicode-match-property-ecmascript": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/unicode-match-property-ecmascript/-/unicode-match-property-ecmascript-2.0.0.tgz",
+      "integrity": "sha512-5kaZCrbp5mmbz5ulBkDkbY0SsPOjKqVS35VpL9ulMPfSl0J0Xsm+9Evphv9CoIZFwre7aJoa94AY6seMKGVN5Q==",
+      "dev": true,
+      "dependencies": {
+        "unicode-canonical-property-names-ecmascript": "^2.0.0",
+        "unicode-property-aliases-ecmascript": "^2.0.0"
+      },
+      "engines": {
+        "node": ">=4"
+      }
+    },
+    "node_modules/unicode-match-property-value-ecmascript": {
+      "version": "2.2.0",
+      "resolved": "https://registry.npmjs.org/unicode-match-property-value-ecmascript/-/unicode-match-property-value-ecmascript-2.2.0.tgz",
+      "integrity": "sha512-4IehN3V/+kkr5YeSSDDQG8QLqO26XpL2XP3GQtqwlT/QYSECAwFztxVHjlbh0+gjJ3XmNLS0zDsbgs9jWKExLg==",
+      "dev": true,
+      "engines": {
+        "node": ">=4"
+      }
+    },
+    "node_modules/unicode-property-aliases-ecmascript": {
+      "version": "2.1.0",
+      "resolved": "https://registry.npmjs.org/unicode-property-aliases-ecmascript/-/unicode-property-aliases-ecmascript-2.1.0.tgz",
+      "integrity": "sha512-6t3foTQI9qne+OZoVQB/8x8rk2k1eVy1gRXhV3oFQ5T6R1dqQ1xtin3XqSlx3+ATBkliTaR/hHyJBm+LVPNM8w==",
+      "dev": true,
+      "engines": {
+        "node": ">=4"
+      }
+    },
+    "node_modules/unicorn-magic": {
+      "version": "0.1.0",
+      "resolved": "https://registry.npmjs.org/unicorn-magic/-/unicorn-magic-0.1.0.tgz",
+      "integrity": "sha512-lRfVq8fE8gz6QMBuDM6a+LO3IAzTi05H6gCVaUpir2E1Rwpo4ZUog45KpNXKC/Mn3Yb9UDuHumeFTo9iV/D9FQ==",
       "dev": true,
-      "dependencies": {
-        "@types/json-schema": "^7.0.8",
-        "ajv": "^6.12.5",
-        "ajv-keywords": "^3.5.2"
-      },
       "engines": {
-        "node": ">= 10.13.0"
+        "node": ">=18"
       },
       "funding": {
-        "type": "opencollective",
-        "url": "https://opencollective.com/webpack"
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/thingies": {
-      "version": "1.21.0",
-      "resolved": "https://registry.npmjs.org/thingies/-/thingies-1.21.0.tgz",
-      "integrity": "sha512-hsqsJsFMsV+aD4s3CWKk85ep/3I9XzYV/IXaSouJMYIoDlgyi11cBhsqYe9/geRfB0YIikBQg6raRaM+nIMP9g==",
+    "node_modules/unique-filename": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/unique-filename/-/unique-filename-3.0.0.tgz",
+      "integrity": "sha512-afXhuC55wkAmZ0P18QsVE6kp8JaxrEokN2HGIoIVv2ijHQd419H0+6EigAFcIzXeMIkcIkNBpB3L/DXB3cTS/g==",
       "dev": true,
-      "engines": {
-        "node": ">=10.18"
+      "dependencies": {
+        "unique-slug": "^4.0.0"
       },
-      "peerDependencies": {
-        "tslib": "^2"
+      "engines": {
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/thunky": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/thunky/-/thunky-1.1.0.tgz",
-      "integrity": "sha512-eHY7nBftgThBqOyHGVN+l8gF0BucP09fMo0oO/Lb0w1OF80dJv+lDVpXG60WMQvkcxAkNybKsrEIE3ZtKGmPrA==",
-      "dev": true
-    },
-    "node_modules/tmp": {
-      "version": "0.0.33",
-      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.0.33.tgz",
-      "integrity": "sha512-jRCJlojKnZ3addtTOjdIqoRuPEKBvNXcGYqzO6zWZX8KfKEpnGY5jfggJQ3EjKuu8D4bJRr0y+cYJFmYbImXGw==",
+    "node_modules/unique-slug": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/unique-slug/-/unique-slug-4.0.0.tgz",
+      "integrity": "sha512-WrcA6AyEfqDX5bWige/4NQfPZMtASNVxdmWR76WESYQVAACSgWcR6e9i0mofqqBxYFtL4oAxPIptY73/0YE1DQ==",
       "dev": true,
       "dependencies": {
-        "os-tmpdir": "~1.0.2"
+        "imurmurhash": "^0.1.4"
       },
       "engines": {
-        "node": ">=0.6.0"
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/to-fast-properties": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
-      "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
+    "node_modules/universalify": {
+      "version": "0.1.2",
+      "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.1.2.tgz",
+      "integrity": "sha512-rBJeI5CXAlmy1pV+617WB9J63U6XcazHHF2f2dbJix4XzpUF0RS3Zbj0FGIOCAva5P/d/GBOYaACQ1w+0azUkg==",
       "dev": true,
       "engines": {
-        "node": ">=4"
+        "node": ">= 4.0.0"
       }
     },
-    "node_modules/to-regex-range": {
-      "version": "5.0.1",
-      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
-      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
+    "node_modules/unpipe": {
+      "version": "1.0.0",
+      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
+      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
+      "dev": true,
+      "engines": {
+        "node": ">= 0.8"
+      }
+    },
+    "node_modules/update-browserslist-db": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.0.tgz",
+      "integrity": "sha512-EdRAaAyk2cUE1wOf2DkEhzxqOQvFOoRJFNS6NeyJ01Gp2beMRpBAINjM2iDXE3KCuKhwnvHIQCJm6ThL2Z+HzQ==",
       "dev": true,
+      "funding": [
+        {
+          "type": "opencollective",
+          "url": "https://opencollective.com/browserslist"
+        },
+        {
+          "type": "tidelift",
+          "url": "https://tidelift.com/funding/github/npm/browserslist"
+        },
+        {
+          "type": "github",
+          "url": "https://github.com/sponsors/ai"
+        }
+      ],
       "dependencies": {
-        "is-number": "^7.0.0"
+        "escalade": "^3.1.2",
+        "picocolors": "^1.0.1"
       },
-      "engines": {
-        "node": ">=8.0"
+      "bin": {
+        "update-browserslist-db": "cli.js"
+      },
+      "peerDependencies": {
+        "browserslist": ">= 4.21.0"
       }
     },
-    "node_modules/toidentifier": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
-      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
+    "node_modules/uri-js": {
+      "version": "4.4.1",
+      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
+      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
+      "dev": true,
+      "dependencies": {
+        "punycode": "^2.1.0"
+      }
+    },
+    "node_modules/uri-js/node_modules/punycode": {
+      "version": "2.3.1",
+      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
+      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
       "dev": true,
       "engines": {
-        "node": ">=0.6"
+        "node": ">=6"
       }
     },
-    "node_modules/tree-dump": {
+    "node_modules/util-deprecate": {
       "version": "1.0.2",
-      "resolved": "https://registry.npmjs.org/tree-dump/-/tree-dump-1.0.2.tgz",
-      "integrity": "sha512-dpev9ABuLWdEubk+cIaI9cHwRNNDjkBBLXTwI4UCUFdQ5xXKqNXoK4FEciw/vxf+NQ7Cb7sGUyeUtORvHIdRXQ==",
+      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
+      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
+      "dev": true
+    },
+    "node_modules/utils-merge": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
+      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
       "dev": true,
       "engines": {
-        "node": ">=10.0"
-      },
-      "funding": {
-        "type": "github",
-        "url": "https://github.com/sponsors/streamich"
-      },
-      "peerDependencies": {
-        "tslib": "2"
+        "node": ">= 0.4.0"
       }
     },
-    "node_modules/tree-kill": {
-      "version": "1.2.2",
-      "resolved": "https://registry.npmjs.org/tree-kill/-/tree-kill-1.2.2.tgz",
-      "integrity": "sha512-L0Orpi8qGpRG//Nd+H90vFB+3iHnue1zSSGmNOOCh1GLJ7rUKVwV2HvijphGQS2UmhUZewS9VgvxYIdgr+fG1A==",
+    "node_modules/uuid": {
+      "version": "8.3.2",
+      "resolved": "https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz",
+      "integrity": "sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==",
       "dev": true,
       "bin": {
-        "tree-kill": "cli.js"
+        "uuid": "dist/bin/uuid"
       }
     },
-    "node_modules/tslib": {
-      "version": "2.6.3",
-      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.6.3.tgz",
-      "integrity": "sha512-xNvxJEOUiWPGhUuUdQgAJPKOOJfGnIyKySOc09XkKsgdUV/3E2zvwZYdejjmRgPCgcym1juLH3226yA7sEFJKQ=="
+    "node_modules/validate-npm-package-license": {
+      "version": "3.0.4",
+      "resolved": "https://registry.npmjs.org/validate-npm-package-license/-/validate-npm-package-license-3.0.4.tgz",
+      "integrity": "sha512-DpKm2Ui/xN7/HQKCtpZxoRWBhZ9Z0kqtygG8XCgNQ8ZlDnxuQmWhj566j8fN4Cu3/JmbhsDo7fcAJq4s9h27Ew==",
+      "dev": true,
+      "dependencies": {
+        "spdx-correct": "^3.0.0",
+        "spdx-expression-parse": "^3.0.0"
+      }
     },
-    "node_modules/tuf-js": {
-      "version": "2.2.1",
-      "resolved": "https://registry.npmjs.org/tuf-js/-/tuf-js-2.2.1.tgz",
-      "integrity": "sha512-GwIJau9XaA8nLVbUXsN3IlFi7WmQ48gBUrl3FTkkL/XLu/POhBzfmX9hd33FNMX1qAsfl6ozO1iMmW9NC8YniA==",
+    "node_modules/validate-npm-package-name": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/validate-npm-package-name/-/validate-npm-package-name-5.0.1.tgz",
+      "integrity": "sha512-OljLrQ9SQdOUqTaQxqL5dEfZWrXExyyWsozYlAWFawPVNuD83igl7uJD2RTkNMbniIYgt8l81eCJGIdQF7avLQ==",
+      "dev": true,
+      "engines": {
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+      }
+    },
+    "node_modules/vary": {
+      "version": "1.1.2",
+      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
+      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
+      "dev": true,
+      "engines": {
+        "node": ">= 0.8"
+      }
+    },
+    "node_modules/vite": {
+      "version": "5.4.6",
+      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.6.tgz",
+      "integrity": "sha512-IeL5f8OO5nylsgzd9tq4qD2QqI0k2CQLGrWD0rCN0EQJZpBK5vJAx0I+GDkMOXxQX/OfFHMuLIx6ddAxGX/k+Q==",
       "dev": true,
       "dependencies": {
-        "@tufjs/models": "2.0.1",
-        "debug": "^4.3.4",
-        "make-fetch-happen": "^13.0.1"
+        "esbuild": "^0.21.3",
+        "postcss": "^8.4.43",
+        "rollup": "^4.20.0"
+      },
+      "bin": {
+        "vite": "bin/vite.js"
       },
       "engines": {
-        "node": "^16.14.0 || >=18.0.0"
+        "node": "^18.0.0 || >=20.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/vitejs/vite?sponsor=1"
+      },
+      "optionalDependencies": {
+        "fsevents": "~2.3.3"
+      },
+      "peerDependencies": {
+        "@types/node": "^18.0.0 || >=20.0.0",
+        "less": "*",
+        "lightningcss": "^1.21.0",
+        "sass": "*",
+        "sass-embedded": "*",
+        "stylus": "*",
+        "sugarss": "*",
+        "terser": "^5.4.0"
+      },
+      "peerDependenciesMeta": {
+        "@types/node": {
+          "optional": true
+        },
+        "less": {
+          "optional": true
+        },
+        "lightningcss": {
+          "optional": true
+        },
+        "sass": {
+          "optional": true
+        },
+        "sass-embedded": {
+          "optional": true
+        },
+        "stylus": {
+          "optional": true
+        },
+        "sugarss": {
+          "optional": true
+        },
+        "terser": {
+          "optional": true
+        }
       }
     },
-    "node_modules/type-fest": {
-      "version": "0.21.3",
-      "resolved": "https://registry.npmjs.org/type-fest/-/type-fest-0.21.3.tgz",
-      "integrity": "sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==",
+    "node_modules/vite/node_modules/@esbuild/aix-ppc64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
+      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
+      "cpu": [
+        "ppc64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "aix"
+      ],
       "engines": {
-        "node": ">=10"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
+        "node": ">=12"
       }
     },
-    "node_modules/type-is": {
-      "version": "1.6.18",
-      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
-      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
+    "node_modules/vite/node_modules/@esbuild/android-arm": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
+      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
+      "cpu": [
+        "arm"
+      ],
       "dev": true,
-      "dependencies": {
-        "media-typer": "0.3.0",
-        "mime-types": "~2.1.24"
-      },
+      "optional": true,
+      "os": [
+        "android"
+      ],
       "engines": {
-        "node": ">= 0.6"
+        "node": ">=12"
       }
     },
-    "node_modules/typed-assert": {
-      "version": "1.0.9",
-      "resolved": "https://registry.npmjs.org/typed-assert/-/typed-assert-1.0.9.tgz",
-      "integrity": "sha512-KNNZtayBCtmnNmbo5mG47p1XsCyrx6iVqomjcZnec/1Y5GGARaxPs6r49RnSPeUP3YjNYiU9sQHAtY4BBvnZwg==",
-      "dev": true
-    },
-    "node_modules/typescript": {
-      "version": "5.4.5",
-      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.4.5.tgz",
-      "integrity": "sha512-vcI4UpRgg81oIRUFwR0WSIHKt11nJ7SAVlYNIu+QpqeyXP+gpQJy/Z4+F0aGxSE4MqwjyXvW/TzgkLAx2AGHwQ==",
+    "node_modules/vite/node_modules/@esbuild/android-arm64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
+      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
+      "cpu": [
+        "arm64"
+      ],
       "dev": true,
-      "bin": {
-        "tsc": "bin/tsc",
-        "tsserver": "bin/tsserver"
-      },
+      "optional": true,
+      "os": [
+        "android"
+      ],
       "engines": {
-        "node": ">=14.17"
+        "node": ">=12"
       }
     },
-    "node_modules/ua-parser-js": {
-      "version": "0.7.38",
-      "resolved": "https://registry.npmjs.org/ua-parser-js/-/ua-parser-js-0.7.38.tgz",
-      "integrity": "sha512-fYmIy7fKTSFAhG3fuPlubeGaMoAd6r0rSnfEsO5nEY55i26KSLt9EH7PLQiiqPUhNqYIJvSkTy1oArIcXAbPbA==",
+    "node_modules/vite/node_modules/@esbuild/android-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
+      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
-      "funding": [
-        {
-          "type": "opencollective",
-          "url": "https://opencollective.com/ua-parser-js"
-        },
-        {
-          "type": "paypal",
-          "url": "https://paypal.me/faisalman"
-        },
-        {
-          "type": "github",
-          "url": "https://github.com/sponsors/faisalman"
-        }
+      "optional": true,
+      "os": [
+        "android"
       ],
       "engines": {
-        "node": "*"
+        "node": ">=12"
       }
     },
-    "node_modules/undici": {
-      "version": "6.19.2",
-      "resolved": "https://registry.npmjs.org/undici/-/undici-6.19.2.tgz",
-      "integrity": "sha512-JfjKqIauur3Q6biAtHJ564e3bWa8VvT+7cSiOJHFbX4Erv6CLGDpg8z+Fmg/1OI/47RA+GI2QZaF48SSaLvyBA==",
+    "node_modules/vite/node_modules/@esbuild/darwin-arm64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
+      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
+      "cpu": [
+        "arm64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ],
       "engines": {
-        "node": ">=18.17"
+        "node": ">=12"
       }
     },
-    "node_modules/undici-types": {
-      "version": "5.26.5",
-      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-5.26.5.tgz",
-      "integrity": "sha512-JlCMO+ehdEIKqlFxk6IfVoAUVmgz7cU7zD/h9XZ0qzeosSHmUJVOzSQvvYSYWXkFXC+IfLKSIffhv0sVZup6pA==",
-      "dev": true
+    "node_modules/vite/node_modules/@esbuild/darwin-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
+      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ],
+      "engines": {
+        "node": ">=12"
+      }
     },
-    "node_modules/unicode-canonical-property-names-ecmascript": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/unicode-canonical-property-names-ecmascript/-/unicode-canonical-property-names-ecmascript-2.0.0.tgz",
-      "integrity": "sha512-yY5PpDlfVIU5+y/BSCxAJRBIS1Zc2dDG3Ujq+sR0U+JjUevW2JhocOF+soROYDSaAezOzOKuyyixhD6mBknSmQ==",
+    "node_modules/vite/node_modules/@esbuild/freebsd-arm64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
+      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
+      "cpu": [
+        "arm64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "freebsd"
+      ],
       "engines": {
-        "node": ">=4"
+        "node": ">=12"
       }
     },
-    "node_modules/unicode-match-property-ecmascript": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/unicode-match-property-ecmascript/-/unicode-match-property-ecmascript-2.0.0.tgz",
-      "integrity": "sha512-5kaZCrbp5mmbz5ulBkDkbY0SsPOjKqVS35VpL9ulMPfSl0J0Xsm+9Evphv9CoIZFwre7aJoa94AY6seMKGVN5Q==",
+    "node_modules/vite/node_modules/@esbuild/freebsd-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
+      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
-      "dependencies": {
-        "unicode-canonical-property-names-ecmascript": "^2.0.0",
-        "unicode-property-aliases-ecmascript": "^2.0.0"
-      },
+      "optional": true,
+      "os": [
+        "freebsd"
+      ],
       "engines": {
-        "node": ">=4"
+        "node": ">=12"
       }
     },
-    "node_modules/unicode-match-property-value-ecmascript": {
-      "version": "2.1.0",
-      "resolved": "https://registry.npmjs.org/unicode-match-property-value-ecmascript/-/unicode-match-property-value-ecmascript-2.1.0.tgz",
-      "integrity": "sha512-qxkjQt6qjg/mYscYMC0XKRn3Rh0wFPlfxB0xkt9CfyTvpX1Ra0+rAmdX2QyAobptSEvuy4RtpPRui6XkV+8wjA==",
+    "node_modules/vite/node_modules/@esbuild/linux-arm": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
+      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
+      "cpu": [
+        "arm"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": ">=4"
+        "node": ">=12"
       }
     },
-    "node_modules/unicode-property-aliases-ecmascript": {
-      "version": "2.1.0",
-      "resolved": "https://registry.npmjs.org/unicode-property-aliases-ecmascript/-/unicode-property-aliases-ecmascript-2.1.0.tgz",
-      "integrity": "sha512-6t3foTQI9qne+OZoVQB/8x8rk2k1eVy1gRXhV3oFQ5T6R1dqQ1xtin3XqSlx3+ATBkliTaR/hHyJBm+LVPNM8w==",
+    "node_modules/vite/node_modules/@esbuild/linux-arm64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
+      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
+      "cpu": [
+        "arm64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": ">=4"
+        "node": ">=12"
       }
     },
-    "node_modules/unicorn-magic": {
-      "version": "0.1.0",
-      "resolved": "https://registry.npmjs.org/unicorn-magic/-/unicorn-magic-0.1.0.tgz",
-      "integrity": "sha512-lRfVq8fE8gz6QMBuDM6a+LO3IAzTi05H6gCVaUpir2E1Rwpo4ZUog45KpNXKC/Mn3Yb9UDuHumeFTo9iV/D9FQ==",
+    "node_modules/vite/node_modules/@esbuild/linux-ia32": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
+      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
+      "cpu": [
+        "ia32"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": ">=18"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
+        "node": ">=12"
       }
     },
-    "node_modules/unique-filename": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/unique-filename/-/unique-filename-3.0.0.tgz",
-      "integrity": "sha512-afXhuC55wkAmZ0P18QsVE6kp8JaxrEokN2HGIoIVv2ijHQd419H0+6EigAFcIzXeMIkcIkNBpB3L/DXB3cTS/g==",
+    "node_modules/vite/node_modules/@esbuild/linux-loong64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
+      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
+      "cpu": [
+        "loong64"
+      ],
       "dev": true,
-      "dependencies": {
-        "unique-slug": "^4.0.0"
-      },
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": ">=12"
       }
     },
-    "node_modules/unique-slug": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/unique-slug/-/unique-slug-4.0.0.tgz",
-      "integrity": "sha512-WrcA6AyEfqDX5bWige/4NQfPZMtASNVxdmWR76WESYQVAACSgWcR6e9i0mofqqBxYFtL4oAxPIptY73/0YE1DQ==",
+    "node_modules/vite/node_modules/@esbuild/linux-mips64el": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
+      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
+      "cpu": [
+        "mips64el"
+      ],
       "dev": true,
-      "dependencies": {
-        "imurmurhash": "^0.1.4"
-      },
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": ">=12"
       }
     },
-    "node_modules/universalify": {
-      "version": "0.1.2",
-      "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.1.2.tgz",
-      "integrity": "sha512-rBJeI5CXAlmy1pV+617WB9J63U6XcazHHF2f2dbJix4XzpUF0RS3Zbj0FGIOCAva5P/d/GBOYaACQ1w+0azUkg==",
+    "node_modules/vite/node_modules/@esbuild/linux-ppc64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
+      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
+      "cpu": [
+        "ppc64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": ">= 4.0.0"
+        "node": ">=12"
       }
     },
-    "node_modules/unpipe": {
-      "version": "1.0.0",
-      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
-      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
+    "node_modules/vite/node_modules/@esbuild/linux-riscv64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
+      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
+      "cpu": [
+        "riscv64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ],
       "engines": {
-        "node": ">= 0.8"
+        "node": ">=12"
       }
     },
-    "node_modules/update-browserslist-db": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.0.tgz",
-      "integrity": "sha512-EdRAaAyk2cUE1wOf2DkEhzxqOQvFOoRJFNS6NeyJ01Gp2beMRpBAINjM2iDXE3KCuKhwnvHIQCJm6ThL2Z+HzQ==",
+    "node_modules/vite/node_modules/@esbuild/linux-s390x": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
+      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
+      "cpu": [
+        "s390x"
+      ],
       "dev": true,
-      "funding": [
-        {
-          "type": "opencollective",
-          "url": "https://opencollective.com/browserslist"
-        },
-        {
-          "type": "tidelift",
-          "url": "https://tidelift.com/funding/github/npm/browserslist"
-        },
-        {
-          "type": "github",
-          "url": "https://github.com/sponsors/ai"
-        }
+      "optional": true,
+      "os": [
+        "linux"
       ],
-      "dependencies": {
-        "escalade": "^3.1.2",
-        "picocolors": "^1.0.1"
-      },
-      "bin": {
-        "update-browserslist-db": "cli.js"
-      },
-      "peerDependencies": {
-        "browserslist": ">= 4.21.0"
+      "engines": {
+        "node": ">=12"
       }
     },
-    "node_modules/uri-js": {
-      "version": "4.4.1",
-      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
-      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
+    "node_modules/vite/node_modules/@esbuild/linux-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
+      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
-      "dependencies": {
-        "punycode": "^2.1.0"
+      "optional": true,
+      "os": [
+        "linux"
+      ],
+      "engines": {
+        "node": ">=12"
       }
     },
-    "node_modules/uri-js/node_modules/punycode": {
-      "version": "2.3.1",
-      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
-      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
+    "node_modules/vite/node_modules/@esbuild/netbsd-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
+      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "netbsd"
+      ],
       "engines": {
-        "node": ">=6"
+        "node": ">=12"
       }
     },
-    "node_modules/util-deprecate": {
-      "version": "1.0.2",
-      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
-      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
-      "dev": true
-    },
-    "node_modules/utils-merge": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
-      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
+    "node_modules/vite/node_modules/@esbuild/openbsd-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
+      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "openbsd"
+      ],
       "engines": {
-        "node": ">= 0.4.0"
+        "node": ">=12"
       }
     },
-    "node_modules/uuid": {
-      "version": "8.3.2",
-      "resolved": "https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz",
-      "integrity": "sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==",
+    "node_modules/vite/node_modules/@esbuild/sunos-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
+      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
-      "bin": {
-        "uuid": "dist/bin/uuid"
+      "optional": true,
+      "os": [
+        "sunos"
+      ],
+      "engines": {
+        "node": ">=12"
       }
     },
-    "node_modules/validate-npm-package-license": {
-      "version": "3.0.4",
-      "resolved": "https://registry.npmjs.org/validate-npm-package-license/-/validate-npm-package-license-3.0.4.tgz",
-      "integrity": "sha512-DpKm2Ui/xN7/HQKCtpZxoRWBhZ9Z0kqtygG8XCgNQ8ZlDnxuQmWhj566j8fN4Cu3/JmbhsDo7fcAJq4s9h27Ew==",
+    "node_modules/vite/node_modules/@esbuild/win32-arm64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
+      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
+      "cpu": [
+        "arm64"
+      ],
       "dev": true,
-      "dependencies": {
-        "spdx-correct": "^3.0.0",
-        "spdx-expression-parse": "^3.0.0"
+      "optional": true,
+      "os": [
+        "win32"
+      ],
+      "engines": {
+        "node": ">=12"
       }
     },
-    "node_modules/validate-npm-package-name": {
-      "version": "5.0.1",
-      "resolved": "https://registry.npmjs.org/validate-npm-package-name/-/validate-npm-package-name-5.0.1.tgz",
-      "integrity": "sha512-OljLrQ9SQdOUqTaQxqL5dEfZWrXExyyWsozYlAWFawPVNuD83igl7uJD2RTkNMbniIYgt8l81eCJGIdQF7avLQ==",
+    "node_modules/vite/node_modules/@esbuild/win32-ia32": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
+      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
+      "cpu": [
+        "ia32"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "win32"
+      ],
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": ">=12"
       }
     },
-    "node_modules/vary": {
-      "version": "1.1.2",
-      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
-      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
+    "node_modules/vite/node_modules/@esbuild/win32-x64": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
+      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
+      "cpu": [
+        "x64"
+      ],
       "dev": true,
+      "optional": true,
+      "os": [
+        "win32"
+      ],
       "engines": {
-        "node": ">= 0.8"
+        "node": ">=12"
       }
     },
-    "node_modules/vite": {
-      "version": "5.3.2",
-      "resolved": "https://registry.npmjs.org/vite/-/vite-5.3.2.tgz",
-      "integrity": "sha512-6lA7OBHBlXUxiJxbO5aAY2fsHHzDr1q7DvXYnyZycRs2Dz+dXBWuhpWHvmljTRTpQC2uvGmUFFkSHF2vGo90MA==",
+    "node_modules/vite/node_modules/esbuild": {
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
+      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
       "dev": true,
-      "dependencies": {
-        "esbuild": "^0.21.3",
-        "postcss": "^8.4.38",
-        "rollup": "^4.13.0"
-      },
+      "hasInstallScript": true,
       "bin": {
-        "vite": "bin/vite.js"
+        "esbuild": "bin/esbuild"
       },
       "engines": {
-        "node": "^18.0.0 || >=20.0.0"
-      },
-      "funding": {
-        "url": "https://github.com/vitejs/vite?sponsor=1"
+        "node": ">=12"
       },
       "optionalDependencies": {
-        "fsevents": "~2.3.3"
-      },
-      "peerDependencies": {
-        "@types/node": "^18.0.0 || >=20.0.0",
-        "less": "*",
-        "lightningcss": "^1.21.0",
-        "sass": "*",
-        "stylus": "*",
-        "sugarss": "*",
-        "terser": "^5.4.0"
-      },
-      "peerDependenciesMeta": {
-        "@types/node": {
-          "optional": true
-        },
-        "less": {
-          "optional": true
-        },
-        "lightningcss": {
-          "optional": true
-        },
-        "sass": {
-          "optional": true
-        },
-        "stylus": {
-          "optional": true
+        "@esbuild/aix-ppc64": "0.21.5",
+        "@esbuild/android-arm": "0.21.5",
+        "@esbuild/android-arm64": "0.21.5",
+        "@esbuild/android-x64": "0.21.5",
+        "@esbuild/darwin-arm64": "0.21.5",
+        "@esbuild/darwin-x64": "0.21.5",
+        "@esbuild/freebsd-arm64": "0.21.5",
+        "@esbuild/freebsd-x64": "0.21.5",
+        "@esbuild/linux-arm": "0.21.5",
+        "@esbuild/linux-arm64": "0.21.5",
+        "@esbuild/linux-ia32": "0.21.5",
+        "@esbuild/linux-loong64": "0.21.5",
+        "@esbuild/linux-mips64el": "0.21.5",
+        "@esbuild/linux-ppc64": "0.21.5",
+        "@esbuild/linux-riscv64": "0.21.5",
+        "@esbuild/linux-s390x": "0.21.5",
+        "@esbuild/linux-x64": "0.21.5",
+        "@esbuild/netbsd-x64": "0.21.5",
+        "@esbuild/openbsd-x64": "0.21.5",
+        "@esbuild/sunos-x64": "0.21.5",
+        "@esbuild/win32-arm64": "0.21.5",
+        "@esbuild/win32-ia32": "0.21.5",
+        "@esbuild/win32-x64": "0.21.5"
+      }
+    },
+    "node_modules/vite/node_modules/postcss": {
+      "version": "8.4.47",
+      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.47.tgz",
+      "integrity": "sha512-56rxCq7G/XfB4EkXq9Egn5GCqugWvDFjafDOThIdMBsI15iqPqR5r15TfSr1YPYeEI19YeaXMCbY6u88Y76GLQ==",
+      "dev": true,
+      "funding": [
+        {
+          "type": "opencollective",
+          "url": "https://opencollective.com/postcss/"
         },
-        "sugarss": {
-          "optional": true
+        {
+          "type": "tidelift",
+          "url": "https://tidelift.com/funding/github/npm/postcss"
         },
-        "terser": {
-          "optional": true
+        {
+          "type": "github",
+          "url": "https://github.com/sponsors/ai"
         }
+      ],
+      "dependencies": {
+        "nanoid": "^3.3.7",
+        "picocolors": "^1.1.0",
+        "source-map-js": "^1.2.1"
+      },
+      "engines": {
+        "node": "^10 || ^12 || >=14"
       }
     },
     "node_modules/void-elements": {
@@ -13265,12 +12827,11 @@
       "dev": true
     },
     "node_modules/webpack": {
-      "version": "5.92.1",
-      "resolved": "https://registry.npmjs.org/webpack/-/webpack-5.92.1.tgz",
-      "integrity": "sha512-JECQ7IwJb+7fgUFBlrJzbyu3GEuNBcdqr1LD7IbSzwkSmIevTm8PF+wej3Oxuz/JFBUZ6O1o43zsPkwm1C4TmA==",
+      "version": "5.94.0",
+      "resolved": "https://registry.npmjs.org/webpack/-/webpack-5.94.0.tgz",
+      "integrity": "sha512-KcsGn50VT+06JH/iunZJedYGUJS5FGjow8wb9c0v5n1Om8O1g4L6LjtfxwlXIATopoQu+vOXXa7gYisWxCoPyg==",
       "dev": true,
       "dependencies": {
-        "@types/eslint-scope": "^3.7.3",
         "@types/estree": "^1.0.5",
         "@webassemblyjs/ast": "^1.12.1",
         "@webassemblyjs/wasm-edit": "^1.12.1",
@@ -13279,7 +12840,7 @@
         "acorn-import-attributes": "^1.9.5",
         "browserslist": "^4.21.10",
         "chrome-trace-event": "^1.0.2",
-        "enhanced-resolve": "^5.17.0",
+        "enhanced-resolve": "^5.17.1",
         "es-module-lexer": "^1.2.1",
         "eslint-scope": "5.1.1",
         "events": "^3.2.0",
@@ -13312,9 +12873,9 @@
       }
     },
     "node_modules/webpack-dev-middleware": {
-      "version": "7.2.1",
-      "resolved": "https://registry.npmjs.org/webpack-dev-middleware/-/webpack-dev-middleware-7.2.1.tgz",
-      "integrity": "sha512-hRLz+jPQXo999Nx9fXVdKlg/aehsw1ajA9skAneGmT03xwmyuhvF93p6HUKKbWhXdcERtGTzUCtIQr+2IQegrA==",
+      "version": "7.4.2",
+      "resolved": "https://registry.npmjs.org/webpack-dev-middleware/-/webpack-dev-middleware-7.4.2.tgz",
+      "integrity": "sha512-xOO8n6eggxnwYpy1NlzUKpvrjfJTvae5/D6WOK0S2LSo7vjmo5gCM1DbLUmFqrMTJP+W/0YZNctm7jasWvLuBA==",
       "dev": true,
       "dependencies": {
         "colorette": "^2.0.10",
@@ -13468,9 +13029,9 @@
       }
     },
     "node_modules/webpack-dev-server/node_modules/rimraf": {
-      "version": "5.0.9",
-      "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-5.0.9.tgz",
-      "integrity": "sha512-3i7b8OcswU6CpU8Ej89quJD4O98id7TtVM5U4Mybh84zQXdrFmDLouWBEEaD/QfO3gDDfH+AGFCGsR7kngzQnA==",
+      "version": "5.0.10",
+      "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-5.0.10.tgz",
+      "integrity": "sha512-l0OE8wL34P4nJH/H2ffoaniAokM2qSmrtXHmlpvYr5AVVX8msAyW0l8NVJFDxlSK4u3Uh/f41cQheDVdnYijwQ==",
       "dev": true,
       "dependencies": {
         "glob": "^10.3.7"
@@ -13478,25 +13039,22 @@
       "bin": {
         "rimraf": "dist/esm/bin.mjs"
       },
-      "engines": {
-        "node": "14 >=14.20 || 16 >=16.20 || >=18"
-      },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       }
     },
     "node_modules/webpack-merge": {
-      "version": "5.10.0",
-      "resolved": "https://registry.npmjs.org/webpack-merge/-/webpack-merge-5.10.0.tgz",
-      "integrity": "sha512-+4zXKdx7UnO+1jaN4l2lHVD+mFvnlZQP/6ljaJVb4SZiwIKeUnrT5l0gkT8z+n4hKpC+jpOv6O9R+gLtag7pSA==",
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/webpack-merge/-/webpack-merge-6.0.1.tgz",
+      "integrity": "sha512-hXXvrjtx2PLYx4qruKl+kyRSLc52V+cCvMxRjmKwoA+CBbbF5GfIBtR6kCvl0fYGqTUPKB+1ktVmTHqMOzgCBg==",
       "dev": true,
       "dependencies": {
         "clone-deep": "^4.0.1",
         "flat": "^5.0.2",
-        "wildcard": "^2.0.0"
+        "wildcard": "^2.0.1"
       },
       "engines": {
-        "node": ">=10.0.0"
+        "node": ">=18.0.0"
       }
     },
     "node_modules/webpack-sources": {
@@ -13904,9 +13462,9 @@
       }
     },
     "node_modules/zone.js": {
-      "version": "0.14.8",
-      "resolved": "https://registry.npmjs.org/zone.js/-/zone.js-0.14.8.tgz",
-      "integrity": "sha512-48uh7MnVp4/OQDuCHeFdXw5d8xwPqFTvlHgPJ1LBFb5GaustLSZV+YUH0to5ygNyGpqTsjpbpt141U/j3pCfqQ=="
+      "version": "0.14.10",
+      "resolved": "https://registry.npmjs.org/zone.js/-/zone.js-0.14.10.tgz",
+      "integrity": "sha512-YGAhaO7J5ywOXW6InXNlLmfU194F8lVgu7bRntUF3TiG8Y3nBK0x1UJJuHUP/e8IyihkjCYqhCScpSwnlaSRkQ=="
     }
   }
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/feature.ts b/tools/motion/motion_test_watcher_app/src/app/feature.ts
index 281eb7a70..38e11e14c 100644
--- a/tools/motion/motion_test_watcher_app/src/app/feature.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/feature.ts
@@ -1,57 +1,85 @@
 import { Derivate } from './feature_derivate';
-import { DataPoint, MotionGoldenFeature } from './golden';
+import {
+  DataPoint,
+  DataPointObject,
+  isNotFound,
+  MotionGoldenFeature,
+} from './golden';
 import {
   DataPointVisualization,
   LineGraphVisualization,
+  PROBE_COLORS,
   Visualization,
 } from './visualization';
 
-export interface Feature {
-  id: string;
-  name: string;
-  dataPoints: Array<DataPoint>;
-  visualization: Visualization;
-  derivates: Array<Derivate>;
-}
-
-export class RecordedFeature implements Feature {
+export class Feature {
   constructor(
-    private readonly featureData: MotionGoldenFeature,
-    readonly visualization: Visualization,
-    readonly derivates: Array<Derivate>,
+    readonly id: string,
+    readonly name: string,
+    readonly type: string,
+    readonly dataPoints: Array<DataPoint>,
   ) {}
 
-  get id(): string {
-    return this.featureData.name;
+  private _visualization: Visualization | undefined;
+
+  get visualization(): Visualization {
+    if (this._visualization === undefined) {
+      this._visualization = createVisualization(this);
+    }
+
+    return this._visualization;
   }
 
-  get name(): string {
-    return this.featureData.name;
+  private _subFeatures: Array<Feature> | undefined;
+
+  get subFeatures(): Array<Feature> {
+    if (this._subFeatures === undefined) {
+      this._subFeatures = createSubFeatures(this);
+    }
+
+    return this._subFeatures!!;
   }
 
-  get dataPoints(): Array<DataPoint> {
-    return this.featureData.data_points;
+  private _derivates: Array<Derivate> | undefined;
+
+  get derivates(): Array<Derivate> {
+    if (this._derivates === undefined) {
+      this._derivates = createDerivatives(this);
+    }
+    return this._derivates;
   }
 }
 
 export function recordedFeatureFactory(
   featureData: MotionGoldenFeature,
-): RecordedFeature {
-  const visualization = createVisualization(featureData);
-  const derivatives = createDerivatives(featureData);
-
-  return new RecordedFeature(featureData, visualization, derivatives);
+): Feature {
+  return new Feature(
+    featureData.name,
+    featureData.name,
+    featureData.type,
+    featureData.data_points,
+  );
 }
 
-function createVisualization(featureData: MotionGoldenFeature): Visualization {
-  const { name, type } = featureData;
+function createVisualization(feature: Feature): Visualization {
+  const { name, type } = feature;
+
+  let color: string | null = null;
+
+  if (name === 'input') {
+    color = PROBE_COLORS[0];
+  } else if (name === 'output_target') {
+    color = PROBE_COLORS[1];
+  } else if (name === 'output') {
+    color = PROBE_COLORS[2];
+  }
 
   if (name === 'alpha' && type === 'float') {
-    return new LineGraphVisualization(/* minValue */ 0, /*maxValue*/ 1);
+    return new LineGraphVisualization(/* minValue */ 0, /*maxValue*/ 1, color);
   }
 
   if (['float', 'int', 'dp'].includes(type)) {
-    const numericValues = featureData.data_points.filter(
+    const numericValues = feature.dataPoints.filter(
       (it): it is number => typeof it === 'number',
     );
     const minValue = Math.min(...numericValues) ?? 0;
@@ -61,16 +89,113 @@ function createVisualization(featureData: MotionGoldenFeature): Visualization {
       maxValue += 1;
     }
 
-    return new LineGraphVisualization(minValue, maxValue);
+    return new LineGraphVisualization(minValue, maxValue, color);
   }
 
   return new DataPointVisualization();
 }
 
-function createDerivatives(featureData: MotionGoldenFeature): Derivate[] {
-  const { name, type } = featureData;
+function createDerivatives(feature: Feature): Derivate[] {
+  const { name, type } = feature;
 
   const result: Derivate[] = [];
 
   return result;
 }
+
+function createSubFeatures(feature: Feature): Feature[] {
+  const { name, type } = feature;
+
+  switch (type) {
+    case 'intSize':
+    case 'dpSize':
+      return [
+        createSubFeature(feature, 'width', 'float', (point) => point['width']),
+        createSubFeature(
+          feature,
+          'height',
+          'float',
+          (point) => point['height'],
+        ),
+      ];
+    case 'intOffset':
+    case 'dpOffset':
+    case 'offset':
+      return [
+        createSubFeature(feature, 'x', 'float', (point) => point['x']),
+        createSubFeature(feature, 'y', 'float', (point) => point['y']),
+      ];
+
+    case 'animatedVisibilityTransitions':
+      return [
+        ...new Set(
+          feature.dataPoints.flatMap((it) =>
+            Object.keys(it as DataPointObject),
+          ),
+        ),
+      ]
+        .sort()
+        .map((it) =>
+          createSubFeature(
+            feature,
+            it,
+            'animatedVisibilityValues',
+            (point) => point[it],
+          ),
+        );
+
+    case 'animatedVisibilityValues':
+      return [
+        ...new Set(
+          feature.dataPoints.flatMap((it) =>
+            it ? 
+            Object.keys(it as DataPointObject) : [],
+          ),
+        ),
+      ]
+        .sort()
+        .flatMap((name) => {
+          let type: string;
+
+          switch (name) {
+            case 'alpha':
+              type = 'float';
+              break;
+            case 'slide':
+              type = 'intOffset';
+              break;
+            case 'scale':
+              type = 'float';
+              break;
+            case 'size':
+              type = 'intSize';
+              break;
+            default:
+              return [];
+          }
+
+          return [createSubFeature(feature, name, type, (point) => point[name])];
+        })
+  }
+
+  return [];
+}
+
+function createSubFeature(
+  parent: Feature,
+  key: string,
+  type: string,
+  extract: (dataPoint: DataPointObject) => DataPoint,
+): Feature {
+  return new Feature(
+    `${parent.id}::${key}`,
+    `${parent.name}[${key}]`,
+    type,
+    parent.dataPoints.map((it) => {
+      if (!isNotFound(it) && it instanceof Object)
+        return extract(it as DataPointObject);
+
+      return { type: 'not_found' };
+    }),
+  );
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts b/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts
index 87a925cdb..ee87305b1 100644
--- a/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts
@@ -5,18 +5,5 @@ import { Visualization } from './visualization';
 export interface Derivate {
   name: string;
 
-  create(feature: Feature): DerivedFeature;
-}
-
-export class DerivedFeature implements Feature {
-  constructor(
-    readonly id: string,
-    readonly name: string,
-
-    private readonly source: Feature,
-    readonly dataPoints: Array<DataPoint>,
-    readonly visualization: Visualization,
-
-    readonly derivates: Array<Derivate>,
-  ) {}
+  create(feature: Feature): Feature;
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss b/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss
index 97ebbb8e1..cd8697deb 100644
--- a/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss
@@ -3,7 +3,8 @@
 
 @mixin color($theme) {
   .golden-card {
-    background-color: mat.get-theme-color($theme, surface-container-low);
+    background-color: white; 
+    // mat.get-theme-color($theme, surface-container-low);
   }
 }
 
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
index 253f18bbc..48b4b7a61 100644
--- a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
@@ -5,6 +5,7 @@
 }
 
 .golden-card {
+  width: 800px;
   mat-card-title {
     margin: 16px;
   }
diff --git a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
index 8cf3b7ef0..57b16a6a8 100644
--- a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
@@ -57,7 +57,6 @@ export class TestOverviewComponent implements OnChanges, AfterViewInit {
 
   constructor() {
     this.dataSource.sortingDataAccessor = (data, sortHeaderIdstring) => {
-      console.log(sortHeaderIdstring);
       switch (sortHeaderIdstring) {
         case 'status':
           return data.result;
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/_graph-theme.scss b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/_graph-theme.scss
new file mode 100644
index 000000000..8beab8cdb
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/_graph-theme.scss
@@ -0,0 +1,20 @@
+@use "sass:map";
+@use "@angular/material" as mat;
+
+@mixin color($theme) {
+}
+
+@mixin typography($theme) {
+  .label {
+    font: mat.get-theme-typography($theme, label-large, font);
+  }
+}
+
+@mixin theme($theme) {
+  @if mat.theme-has($theme, color) {
+    @include color($theme);
+  }
+  @if mat.theme-has($theme, typography) {
+    @include typography($theme);
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
index 50e8fdc5b..17cc17524 100644
--- a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
@@ -15,4 +15,4 @@
   -->
 
 <div class="graph-container"><canvas #canvas></canvas></div>
-<div class="label" [style.left]="labelLeft">{{ feature.name }}</div>
+<div class="label">{{ feature.name }}</div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss
index 50d4e7d93..4cbde4b0e 100644
--- a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss
@@ -26,13 +26,14 @@
   margin-bottom: 8px;
   display: inline-block;
   padding: 4px 8px;
-  font-size: 12px;
+  left: -48px;
+  top: -96px;
 
   position: relative;
+  // transform: rotate(-90deg);
 }
 
 .graph-container {
-  position: absolute;
-  height: 64px;
+  position: relative;
   width: 100%;
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts
index 4ed67780e..7c40249ee 100644
--- a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts
@@ -59,7 +59,7 @@ export class GraphComponent implements OnChanges {
     }
 
     canvasElement.width = width;
-    canvasElement.height = 64;
+    canvasElement.height = this.feature.visualization.height;
     this._renderGraph();
   }
 
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss
index 4466853b4..8899ae64b 100644
--- a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss
@@ -17,12 +17,15 @@
 :host {
   display: flex;
   flex-direction: column;
+  padding-left: 24px;
+  padding-right: 24px;
 }
 
 .timeline {
   position: relative;
   display: flex;
   flex-grow: 1;
+
 }
 
 canvas {
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts
index e12cf0c3e..9795022c3 100644
--- a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts
@@ -100,7 +100,15 @@ export class TimelineViewComponent
         this.canvas?.nativeElement?.width ?? 1,
         this.recordedMotion.timeline,
       );
-      this.features = [...this.recordedMotion.features];
+
+      function recursiveFeatures(feature: Feature): Feature[] {
+        return [feature, ...feature.subFeatures.flatMap(it => recursiveFeatures(it))];
+      }
+
+      this.features = this.recordedMotion.features.flatMap((it) =>
+        recursiveFeatures(it),
+      );
+
 
       this._recordingInputDisposer.addListener(
         this.recordedMotion.videoSource,
diff --git a/tools/motion/motion_test_watcher_app/src/app/visualization.ts b/tools/motion/motion_test_watcher_app/src/app/visualization.ts
index c359d2f6d..eae186f0e 100644
--- a/tools/motion/motion_test_watcher_app/src/app/visualization.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/visualization.ts
@@ -3,6 +3,7 @@ import { DataPoint, isNotFound } from './golden';
 import { VisualTimeline } from './visual-timeline';
 
 export interface Visualization {
+  height: number;
   render(
     timeline: VisualTimeline,
     dataPoints: Array<DataPoint>,
@@ -10,7 +11,7 @@ export interface Visualization {
   ): void;
 }
 
-const PROBE_COLORS = [
+export const PROBE_COLORS = [
   '#E51C23',
   '#9C27B0',
   '#5677FC',
@@ -33,17 +34,24 @@ function lighten(hex: string): string {
 }
 
 export class LineGraphVisualization implements Visualization {
-  color: string = PROBE_COLORS[0];
-  fillColor: string = lighten(this.color);
+  color: string
+  fillColor: string 
+
+  height: number = 96
 
   constructor(
     public minValue: number,
     public maxValue: number,
+     color: string|null, 
   ) {
     checkArgument(
       minValue < maxValue,
       `minValue ${minValue} >= maxValue ${maxValue}`,
     );
+
+    this.color = color ?? PROBE_COLORS[0]
+    this.fillColor  = lighten(this.color);
+
   }
 
   render(
@@ -52,10 +60,12 @@ export class LineGraphVisualization implements Visualization {
     canvas: HTMLCanvasElement,
   ) {
     const cw = canvas.width;
-    const ch = 30;
+    const ch = 90;
 
     const ctx = checkNotNull(canvas.getContext('2d'));
     ctx.clearRect(0, 0, cw, canvas.height);
+    ctx.save();
+    ctx.translate(0, 5);
 
     const min = this.minValue;
     const max = this.maxValue;
@@ -72,30 +82,17 @@ export class LineGraphVisualization implements Visualization {
       }
       const end = i;
 
-      const bottomLineWidth = 2;
-      // solid bottom line
-      ctx.fillStyle = color;
-      ctx.arc(
-        timeline.frameToPx(start),
-        ch - bottomLineWidth / 2,
-        5,
-        0,
-        2 * Math.PI,
-      );
-      ctx.arc(
-        timeline.frameToPx(end - 1),
-        ch - bottomLineWidth / 2,
-        5,
-        0,
-        2 * Math.PI,
-      );
-      ctx.fill();
+      const bottomLineWidth = 1;
+
+      const mid = min <=0 && max >= 0 ? 0 : (min > 0) ? min : max
+
+      const midY = (1 - (mid - min) / (max - min)) * ch
 
       ctx.save();
       try {
         ctx.fillStyle = this.fillColor;
         ctx.beginPath();
-        ctx.moveTo(timeline.frameToPx(start), ch - bottomLineWidth);
+        ctx.moveTo(timeline.frameToPx(start), midY);
         for (let i = start; i < end; i++) {
           const value = dataPoints.at(i);
           if (typeof value !== 'number') {
@@ -106,26 +103,53 @@ export class LineGraphVisualization implements Visualization {
             (1 - (value - min) / (max - min)) * ch,
           );
         }
-        ctx.lineTo(timeline.frameToPx(end - 1), ch - bottomLineWidth);
+        ctx.lineTo(timeline.frameToPx(end - 1), midY);
         ctx.fill();
       } finally {
         ctx.restore();
       }
+      ctx.save();
+      try {
+        ctx.beginPath();
+        ctx.strokeStyle = color;
+        ctx.lineWidth = bottomLineWidth;
+
+        ctx.moveTo(timeline.frameToPx(start), midY);
+        ctx.lineTo(timeline.frameToPx(end - 1), midY);
+
+        ctx.stroke();
+      } finally {
+        ctx.restore();
+      }
 
-      ctx.beginPath();
-      ctx.strokeStyle = color;
-      ctx.lineWidth = bottomLineWidth;
+      ctx.fillStyle = color;
+
+      for (let i = start; i < end; i++) {
+        const value = dataPoints.at(i);
+        if (typeof value !== 'number') {
+          continue;
+        }
+        ctx.beginPath();
 
-      ctx.moveTo(timeline.frameToPx(start), ch - bottomLineWidth / 2);
-      ctx.lineTo(timeline.frameToPx(end - 1), ch - bottomLineWidth / 2);
+        ctx.arc(
+          timeline.frameToPx(i),
+          (1 - (value - min) / (max - min)) * ch,
+          2,
+          0,
+          2 * Math.PI,
+        );
+
+        ctx.fill();
+      }
 
-      ctx.stroke();
+      ctx.restore();
     }
   }
 }
 
 export class DataPointVisualization implements Visualization {
   color: string = PROBE_COLORS[0];
+  height: number = 32
 
   render(
     timeline: VisualTimeline,
diff --git a/tools/motion/motion_test_watcher_app/src/styles.scss b/tools/motion/motion_test_watcher_app/src/styles.scss
index 4fee8b693..0837edb56 100644
--- a/tools/motion/motion_test_watcher_app/src/styles.scss
+++ b/tools/motion/motion_test_watcher_app/src/styles.scss
@@ -1,6 +1,7 @@
 @use "@angular/material" as mat;
 @use "./app/test-overview/test-overview-theme" as test-overview;
 @use "./app/motion-golden/theme" as golden;
+@use "./app/timeline-view/graph/graph-theme" as graph;
 
 $theme: mat.define-theme(
   (
@@ -18,6 +19,7 @@ html {
   @include mat.all-component-themes($theme);
   @include test-overview.theme($theme);
   @include golden.theme($theme);
+  @include graph.theme($theme);
 }
 
 html,
diff --git a/tools/ndk/ndkabidump/__init__.py b/tools/ndk/ndkabidump/__init__.py
index 8a00256ee..269a87aa5 100644
--- a/tools/ndk/ndkabidump/__init__.py
+++ b/tools/ndk/ndkabidump/__init__.py
@@ -59,13 +59,20 @@ class Updater:
         prebuilts_project = self.src_dir / "prebuilts/abi-dumps"
         prebuilts_dir = prebuilts_project / "ndk"
         abi_out = self.build_dir / "soong/abi-dumps/ndk"
-        for dump in abi_out.glob("**/abi.stg"):
-            install_path = prebuilts_dir / dump.relative_to(abi_out)
-            install_dir = install_path.parent
-            if not install_dir.exists():
-                install_dir.mkdir(parents=True)
-            logger().info(f"Copying ABI dump {dump} to {install_path}")
-            shutil.copy2(dump, install_path)
+        for version_dir in abi_out.iterdir():
+            try:
+                int(version_dir.name)
+            except ValueError:
+                logger().info("Skipping %s because it is a preview API level", version_dir)
+                continue
+
+            for dump in version_dir.glob("**/abi.stg"):
+                install_path = prebuilts_dir / dump.relative_to(abi_out)
+                install_dir = install_path.parent
+                if not install_dir.exists():
+                    install_dir.mkdir(parents=True)
+                logger().info(f"Copying ABI dump {dump} to {install_path}")
+                shutil.copy2(dump, install_path)
 
     def run(self) -> None:
         """Runs the updater.
diff --git a/tools/winscope/package-lock.json b/tools/winscope/package-lock.json
index 9ec671036..fc619b6da 100644
--- a/tools/winscope/package-lock.json
+++ b/tools/winscope/package-lock.json
@@ -76,6 +76,7 @@
         "karma-webpack": "^5.0.0",
         "loader-utils": "^2.0.0",
         "madge": "^5.0.1",
+        "mp4box": "^0.5.3",
         "prettier": "^2.8.1",
         "prettier-plugin-organize-imports": "^3.2.1",
         "protobufjs-cli": "^1.1.2",
@@ -12144,6 +12145,12 @@
         "node": "*"
       }
     },
+    "node_modules/mp4box": {
+      "version": "0.5.3",
+      "resolved": "https://registry.npmjs.org/mp4box/-/mp4box-0.5.3.tgz",
+      "integrity": "sha512-RIvyFZdPDIg3+mL6vUdPBSyQRrEfKO3ryAeJ4xJJV7HBHQUH3KfLlZRzfSpBHCd/HqR63HfbrWQI/CwXDvYENQ==",
+      "dev": true
+    },
     "node_modules/ms": {
       "version": "2.1.2",
       "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.2.tgz",
@@ -27327,6 +27334,12 @@
         }
       }
     },
+    "mp4box": {
+      "version": "0.5.3",
+      "resolved": "https://registry.npmjs.org/mp4box/-/mp4box-0.5.3.tgz",
+      "integrity": "sha512-RIvyFZdPDIg3+mL6vUdPBSyQRrEfKO3ryAeJ4xJJV7HBHQUH3KfLlZRzfSpBHCd/HqR63HfbrWQI/CwXDvYENQ==",
+      "dev": true
+    },
     "ms": {
       "version": "2.1.2",
       "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.2.tgz",
diff --git a/tools/winscope/package.json b/tools/winscope/package.json
index 27980af9c..37ead5d3c 100644
--- a/tools/winscope/package.json
+++ b/tools/winscope/package.json
@@ -62,6 +62,7 @@
     "@angular-devkit/build-angular": "^14.0.0",
     "@angular/cli": "~14.0.0",
     "@angular/compiler-cli": "^14.0.0",
+    "@ephesoft/webpack.istanbul.loader": "~2.2.0",
     "@ngxs/devtools-plugin": "^3.7.4",
     "@types/chrome": "^0.0.204",
     "@types/dateformat": "^5.0.0",
@@ -83,7 +84,6 @@
     "html-webpack-plugin": "^5.5.0",
     "jasmine": "~4.3.0",
     "jasmine-core": "~4.1.0",
-    "@ephesoft/webpack.istanbul.loader": "~2.2.0",
     "karma": "~6.3.0",
     "karma-chrome-launcher": "~3.1.0",
     "karma-coverage-istanbul-reporter": "^3.0.3",
@@ -92,6 +92,7 @@
     "karma-webpack": "^5.0.0",
     "loader-utils": "^2.0.0",
     "madge": "^5.0.1",
+    "mp4box": "^0.5.3",
     "prettier": "^2.8.1",
     "prettier-plugin-organize-imports": "^3.2.1",
     "protobufjs-cli": "^1.1.2",
diff --git a/tools/winscope/protos/test/intdef_translation_test.proto b/tools/winscope/protos/test/intdef_translation_test.proto
index dc9c280b7..575a5c0ec 100644
--- a/tools/winscope/protos/test/intdef_translation_test.proto
+++ b/tools/winscope/protos/test/intdef_translation_test.proto
@@ -9,6 +9,7 @@ message RootMessage {
 
 message InputWindowInfoProto {
   optional int32 layoutParamsFlags = 1;
+  optional int32 inputConfig = 2;
 }
 
 /* represents WindowManager.LayoutParams */
diff --git a/tools/winscope/src/adb/winscope_proxy.py b/tools/winscope/src/adb/winscope_proxy.py
index 772b9470e..77646037a 100644
--- a/tools/winscope/src/adb/winscope_proxy.py
+++ b/tools/winscope/src/adb/winscope_proxy.py
@@ -40,7 +40,7 @@ from abc import abstractmethod
 from enum import Enum
 from http import HTTPStatus
 from http.server import HTTPServer, BaseHTTPRequestHandler
-from logging import DEBUG, INFO, WARNING
+from logging import DEBUG, INFO
 from tempfile import NamedTemporaryFile
 from typing import Callable
 
@@ -54,22 +54,26 @@ secret_token = None
 def create_argument_parser() -> argparse.ArgumentParser:
     parser = argparse.ArgumentParser(description='Proxy for go/winscope', prog='winscope_proxy')
 
-    parser.add_argument('--verbose', '-v', dest='loglevel', action='store_const', const=INFO)
-    parser.add_argument('--debug', '-d', dest='loglevel', action='store_const', const=DEBUG)
+    parser.add_argument('--info', '-i', dest='loglevel', action='store_const', const=INFO)
     parser.add_argument('--port', '-p', default=5544, action='store')
 
-    parser.set_defaults(loglevel=WARNING)
+    parser.set_defaults(loglevel=DEBUG)
 
     return parser
 
 # Keep in sync with ProxyConnection#VERSION in Winscope
-VERSION = '4.0.0'
+VERSION = '4.0.8'
 
 PERFETTO_TRACE_CONFIG_FILE = '/data/misc/perfetto-configs/winscope-proxy-trace.conf'
 PERFETTO_DUMP_CONFIG_FILE = '/data/misc/perfetto-configs/winscope-proxy-dump.conf'
 PERFETTO_TRACE_FILE = '/data/misc/perfetto-traces/winscope-proxy-trace.perfetto-trace'
 PERFETTO_DUMP_FILE = '/data/misc/perfetto-traces/winscope-proxy-dump.perfetto-trace'
 PERFETTO_UNIQUE_SESSION_NAME = 'winscope proxy perfetto tracing'
+PERFETTO_TRACING_SESSIONS_QUERY_START = """TRACING SESSIONS:
+
+ID      UID     STATE      BUF (#) KB   DUR (s)   #DS  STARTED  NAME
+===     ===     =====      ==========   =======   ===  =======  ====\n"""
+PERFETTO_TRACING_SESSIONS_QUERY_END = """\nNOTE: Some tracing sessions are not reported in the list above."""
 
 WINSCOPE_VERSION_HEADER = "Winscope-Proxy-Version"
 WINSCOPE_TOKEN_HEADER = "Winscope-Token"
@@ -93,6 +97,10 @@ WINSCOPE_STATUS = "/data/local/tmp/winscope_status"
 # Max interval between the client keep-alive requests in seconds
 KEEP_ALIVE_INTERVAL_S = 5
 
+# Perfetto's default timeout for getting an ACK from producer processes is 5s
+# We need to be sure that the timeout is longer than that with a good margin.
+COMMAND_TIMEOUT_S = 15
+
 class File:
     def __init__(self, file, filetype) -> None:
         self.file = file
@@ -187,13 +195,11 @@ class TraceConfig:
     def execute_optional_config_command(self, server, device_id, shell, command, config_key, config_value):
         process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                     stdin=subprocess.PIPE, start_new_session=True)
-        log.debug(f"Changing optional trace config on device {device_id} {config_key}:{config_value}")
         out, err = process.communicate(command.encode('utf-8'))
         if process.returncode != 0:
             raise AdbError(
                 f"Error executing command:\n {command}\n\n### OUTPUT ###{out.decode('utf-8')}\n{err.decode('utf-8')}")
-        log.debug(f"Optional trace config changed on device {device_id}")
-        server.respond(HTTPStatus.OK, b'', "text/plain")
+        log.debug(f"Optional trace config changed on device {device_id} {config_key}:{config_value}")
 
     def execute_perfetto_config_command(self, server, shell, command, trace_name):
         process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
@@ -202,8 +208,7 @@ class TraceConfig:
         if process.returncode != 0:
             raise AdbError(
                 f"Error executing command:\n {command}\n\n### OUTPUT ###{out.decode('utf-8')}\n{err.decode('utf-8')}")
-        log.debug(f'{trace_name} (perfetto) configured to start along the other perfetto traces.')
-        server.respond(HTTPStatus.OK, b'', "text/plain")
+        log.info(f'{trace_name} (perfetto) configured to start along the other perfetto traces.')
 
 
 class SurfaceFlingerTraceConfig(TraceConfig):
@@ -587,6 +592,7 @@ class TraceTarget:
         self.trace_start = trace_start
         self.trace_stop = trace_stop
         self.get_trace_config = get_trace_config
+        self.status_filename = WINSCOPE_STATUS + "_" + trace_name
 
 
 # Order of files matters as they will be expected in that order and decoded in that order
@@ -756,14 +762,6 @@ write_into_file: true
 unique_session_name: "{PERFETTO_UNIQUE_SESSION_NAME}"
 EOF
 
-if is_perfetto_tracing_session_running; then
-    perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop
-    echo 'Stopped already-running winscope perfetto session.'
-fi
-
-echo 'Concurrent Perfetto Sessions'
-perfetto --query | sed -n '/^TRACING SESSIONS:$/,$p'
-
 rm -f {PERFETTO_TRACE_FILE}
 perfetto --out {PERFETTO_TRACE_FILE} --txt --config {PERFETTO_TRACE_CONFIG_FILE} --detach=WINSCOPE-PROXY-TRACING-SESSION
 echo 'Started perfetto trace.'
@@ -933,7 +931,7 @@ class RequestRouter:
                              error.encode("utf-8"), 'text/txt')
 
     def _bad_token(self):
-        log.info("Bad token")
+        log.warning("Bad token")
         self.request.respond(HTTPStatus.FORBIDDEN, b"Bad Winscope authorization token!\nThis is Winscope ADB proxy.\n",
                              'text/txt')
 
@@ -965,13 +963,9 @@ def call_adb(params: str, device: str = None, stdin: bytes = None):
         log.debug("Call: " + ' '.join(command))
         return subprocess.check_output(command, stderr=subprocess.STDOUT, input=stdin).decode('utf-8')
     except OSError as ex:
-        log.debug('Error executing adb command: {}\n{}'.format(
-            ' '.join(command), repr(ex)))
         raise AdbError('Error executing adb command: {}\n{}'.format(
             ' '.join(command), repr(ex)))
     except subprocess.CalledProcessError as ex:
-        log.debug('Error executing adb command: {}\n{}'.format(
-            ' '.join(command), ex.output.decode("utf-8")))
         raise AdbError('Error executing adb command: adb {}\n{}'.format(
             params, ex.output.decode("utf-8")))
 
@@ -983,13 +977,9 @@ def call_adb_outfile(params: str, outfile, device: str = None, stdin: bytes = No
         _, err = process.communicate(stdin)
         outfile.seek(0)
         if process.returncode != 0:
-            log.debug('Error executing adb command: adb {}\n'.format(params) + err.decode(
-                'utf-8') + '\n' + outfile.read().decode('utf-8'))
             raise AdbError('Error executing adb command: adb {}\n'.format(params) + err.decode(
                 'utf-8') + '\n' + outfile.read().decode('utf-8'))
     except OSError as ex:
-        log.debug('Error executing adb command: adb {}\n{}'.format(
-            params, repr(ex)))
         raise AdbError(
             'Error executing adb command: adb {}\n{}'.format(params, repr(ex)))
 
@@ -1028,7 +1018,7 @@ class ListDevicesEndpoint(RequestEndpoint):
                 }
         self.foundDevices = devices
         j = json.dumps(devices)
-        log.debug("Detected devices: " + j)
+        log.info("Detected devices: " + j)
         server.respond(HTTPStatus.OK, j.encode("utf-8"), "text/json")
 
 
@@ -1075,25 +1065,35 @@ class DeviceRequestEndpoint(RequestEndpoint):
         return json.loads(server.rfile.read(length).decode("utf-8"))
 
     def get_targets_and_prepare_for_tracing(self, server, device_id, perfetto_config_file, targets_map: dict[str, TraceTarget | DumpTarget], perfetto_name):
-        log.debug("Clearing perfetto config file for previous tracing session")
+        warnings: list[str] = []
+
         call_adb(f"shell su root rm -f {perfetto_config_file}", device_id)
+        log.debug("Cleared perfetto config file for previous tracing session")
 
         trace_requests: list[dict] = self.get_request(server)
         trace_types = [t.get("name") for t in trace_requests]
         log.debug(f"Received client request of {trace_types} for {device_id}")
+
         perfetto_query_result = call_adb("shell perfetto --query", device_id)
 
+        too_many_perfetto_sessions = self.too_many_perfetto_sessions(perfetto_query_result)
+        if (too_many_perfetto_sessions):
+            warnings.append("Limit of 5 Perfetto sessions reached on device. Will attempt to collect legacy traces.")
+            log.warning(warnings[0])
+
         trace_targets: list[tuple[DumpTarget | TraceTarget, TraceConfig | None]] = []
         for t in trace_requests:
             try:
                 trace_name = t.get("name")
                 target = targets_map[trace_name]
-                is_perfetto = target.is_perfetto_available(perfetto_query_result)
+                is_perfetto = (not too_many_perfetto_sessions) and target.is_perfetto_available(perfetto_query_result)
                 config = None
                 if target.get_trace_config is not None:
                     config = target.get_trace_config(is_perfetto)
                     self.apply_config(config, t.get("config"), server, device_id)
-                if trace_name == perfetto_name or not is_perfetto:
+                is_valid_perfetto_target = trace_name == perfetto_name and not too_many_perfetto_sessions
+                is_valid_trace_target = trace_name != perfetto_name and not is_perfetto
+                if is_valid_perfetto_target or is_valid_trace_target:
                     trace_targets.append((target, config))
 
             except KeyError as err:
@@ -1106,7 +1106,25 @@ class DeviceRequestEndpoint(RequestEndpoint):
         log.debug("Trace requested for {} with targets {}".format(
             device_id, ','.join([target.trace_name for target, config in trace_targets])))
 
-        return trace_targets
+        return trace_targets, warnings
+
+    def too_many_perfetto_sessions(self, perfetto_query_result: str):
+        concurrent_sessions_start = perfetto_query_result.find(PERFETTO_TRACING_SESSIONS_QUERY_START)
+        if concurrent_sessions_start != -1:
+            concurrent_sessions = perfetto_query_result[concurrent_sessions_start + len(PERFETTO_TRACING_SESSIONS_QUERY_START):]
+            log.info(f"Concurrent sessions:\n{concurrent_sessions}\n")
+            concurrent_sessions_end = concurrent_sessions.find(PERFETTO_TRACING_SESSIONS_QUERY_END)
+            if concurrent_sessions_end > 0:
+                concurrent_sessions_end -= 1
+            concurrent_sessions = concurrent_sessions[:concurrent_sessions_end]
+            number_of_concurrent_sessions = len(concurrent_sessions.split("\n")) if len(concurrent_sessions) > 0 else 0
+
+            if PERFETTO_UNIQUE_SESSION_NAME in concurrent_sessions:
+                call_adb("shell perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop")
+                log.debug("Stopped already-running winscope perfetto session.")
+                number_of_concurrent_sessions -= 1
+            return number_of_concurrent_sessions >= 5
+        return False
 
     def apply_config(self, trace_config: TraceConfig, requested_configs: list[dict], server, device_id):
         for requested_config in requested_configs:
@@ -1148,9 +1166,9 @@ class DeviceRequestEndpoint(RequestEndpoint):
                 .format( device_id))
 
     def clear_last_tracing_session(self, device_id):
-        log.debug("Clearing previous tracing session files from device")
         call_adb(f"shell su root rm -rf {WINSCOPE_BACKUP_DIR}", device_id)
         call_adb(f"shell su root mkdir {WINSCOPE_BACKUP_DIR}", device_id)
+        log.debug("Cleared previous tracing session files from device")
 
 
 class FetchFilesEndpoint(DeviceRequestEndpoint):
@@ -1192,14 +1210,16 @@ class FetchFilesEndpoint(DeviceRequestEndpoint):
 TRACE_THREADS = {}
 
 class TraceThread(threading.Thread):
-    def __init__(self, trace_name: str, device_id: str, command: str, trace_identifier: str):
+    def __init__(self, trace_name: str, device_id: str, command: str, trace_identifier: str, status_filename: str):
         self.trace_command = command
         self.trace_name = trace_name
         self.trace_identifier = trace_identifier
+        self.status_filename = status_filename
         self._device_id = device_id
         self._keep_alive_timer = None
         self.out = None,
         self.err = None,
+        self._command_timed_out = False
         self._success = False
         try:
             shell = get_shell_args(self._device_id, "trace")
@@ -1217,7 +1237,7 @@ class TraceThread(threading.Thread):
             self.end_trace()
 
     def reset_timer(self):
-        log.debug(
+        log.info(
             "Resetting keep-alive clock for {} trace on {}".format(self.trace_name, self._device_id))
         if self._keep_alive_timer:
             self._keep_alive_timer.cancel()
@@ -1228,7 +1248,7 @@ class TraceThread(threading.Thread):
     def end_trace(self):
         if self._keep_alive_timer:
             self._keep_alive_timer.cancel()
-        log.debug("Sending SIGINT to the {} process on {}".format(
+        log.info("Sending SIGINT to the {} process on {}".format(
             self.trace_name,
             self._device_id))
         self.process.send_signal(signal.SIGINT)
@@ -1236,35 +1256,40 @@ class TraceThread(threading.Thread):
             log.debug("Waiting for {} trace shell to exit for {}".format(
                 self.trace_name,
                 self._device_id))
-            self.process.wait(timeout=5)
+            self.process.wait(timeout=COMMAND_TIMEOUT_S)
         except TimeoutError:
-            log.debug(
+            log.error(
                 "TIMEOUT - sending SIGKILL to the {} trace process on {}".format(self.trace_name, self._device_id))
             self.process.kill()
         self.join()
 
     def run(self):
-        log.debug("Trace {} started on {}".format(self.trace_name, self._device_id))
+        retry_interval = 0.1
+        log.info("Trace {} started on {}".format(self.trace_name, self._device_id))
         self.reset_timer()
         self.out, self.err = self.process.communicate(self.trace_command)
-        log.debug("Trace {} ended on {}, waiting for cleanup".format(self.trace_name, self._device_id))
+        log.info("Trace {} ended on {}, waiting for cleanup".format(self.trace_name, self._device_id))
         time.sleep(0.2)
-        for i in range(50):
-            if call_adb(f"shell su root cat {WINSCOPE_STATUS}", device=self._device_id) == 'TRACE_OK\n':
-                log.debug("Trace {} finished successfully on {}".format(
+        for i in range(int(COMMAND_TIMEOUT_S / retry_interval)):
+            if call_adb(f"shell su root cat {self.status_filename}", device=self._device_id) == 'TRACE_OK\n':
+                log.info("Trace {} finished on {}".format(
                     self.trace_name,
                     self._device_id))
                 if self.trace_name == "perfetto_trace":
                     self._success = True
                 else:
                     self._success = len(self.err) == 0
-                break
+                return
             log.debug("Still waiting for cleanup on {} for {}".format(self._device_id, self.trace_name))
-            time.sleep(0.1)
+            time.sleep(retry_interval)
+
+        self._command_timed_out = True
 
     def success(self):
         return self._success
 
+    def timed_out(self):
+        return self._command_timed_out
 
 class StartTraceEndpoint(DeviceRequestEndpoint):
     TRACE_COMMAND = """
@@ -1298,7 +1323,7 @@ while true; do sleep 0.1; done
 """
 
     def process_with_device(self, server, path, device_id):
-        trace_targets = self.get_targets_and_prepare_for_tracing(
+        trace_targets, warnings = self.get_targets_and_prepare_for_tracing(
             server, device_id, PERFETTO_TRACE_CONFIG_FILE, TRACE_TARGETS, "perfetto_trace")
 
         for t, config in trace_targets:
@@ -1318,21 +1343,21 @@ while true; do sleep 0.1; done
                     start_cmd = t.trace_start
 
                 command = StartTraceEndpoint.TRACE_COMMAND.format(
-                    winscope_status=WINSCOPE_STATUS,
+                    winscope_status=t.status_filename,
                     signal_handler_log=SIGNAL_HANDLER_LOG,
                     stop_commands=t.trace_stop,
                     perfetto_config_file=PERFETTO_TRACE_CONFIG_FILE,
                     start_commands=start_cmd,
                 )
                 log.debug(f"Executing start command for {t.trace_name} on {device_id}...")
-                thread = TraceThread(t.trace_name, device_id, command.encode('utf-8'), trace_identifier)
+                thread = TraceThread(t.trace_name, device_id, command.encode('utf-8'), trace_identifier, t.status_filename)
                 if device_id not in TRACE_THREADS:
                     TRACE_THREADS[device_id] = [thread]
                 else:
                     TRACE_THREADS[device_id].append(thread)
                 thread.start()
 
-        server.respond(HTTPStatus.OK, b'', "text/plain")
+        server.respond(HTTPStatus.OK, json.dumps(warnings).encode("utf-8"), "text/json")
 
 
 def move_collected_files(files: list[File | FileMatcher], device_id, trace_identifier):
@@ -1363,28 +1388,31 @@ class EndTraceEndpoint(DeviceRequestEndpoint):
                 thread.end_trace()
             success = thread.success()
             signal_handler_log = call_adb(f"shell su root cat {SIGNAL_HANDLER_LOG}", device=device_id).encode('utf-8')
-            out = b"### Shell script's stdout - start\n" + \
-                thread.out + \
-                b"### Shell script's stdout - end\n" + \
-                b"### Shell script's stderr - start\n" + \
-                thread.err + \
-                b"### Shell script's stderr - end\n" + \
-                b"### Signal handler log - start\n" + \
-                signal_handler_log + \
-                b"### Signal handler log - end\n"
+
+            if (thread.timed_out()):
+                timeout_message = "Trace {} timed out during cleanup".format(thread.trace_name)
+                errors.append(timeout_message)
+                log.error(timeout_message)
+
             if not success:
-                log.error(
-                    "Error ending trace {} on the device\n### Output ###\n".format(thread.trace_name) + out.decode(
-                        "utf-8")
-                )
+                log.error("Error ending trace {} on the device".format(thread.trace_name))
                 errors.append("Error ending trace {} on the device: {}".format(thread.trace_name, thread.err))
+
+            out = b"### Shell script's stdout ###\n" + \
+                (thread.out if thread.out else b'<no stdout>') + \
+                b"\n### Shell script's stderr ###\n" + \
+                (thread.err if thread.err else b'<no stderr>') + \
+                b"\n### Signal handler log ###\n" + \
+                (signal_handler_log if signal_handler_log else b'<no signal handler logs>') + \
+                b"\n"
+            log.debug("### Output ###\n".format(thread.trace_name) + out.decode("utf-8"))
             if thread.trace_name in TRACE_TARGETS:
                 files = TRACE_TARGETS[thread.trace_name].files
                 move_collected_files(files, device_id, thread.trace_identifier)
             else:
                 errors.append(f"File location unknown for {thread.trace_name}")
 
-        call_adb(f"shell su root rm {WINSCOPE_STATUS}", device=device_id)
+        call_adb(f"shell su root rm {thread.status_filename}", device=device_id)
         TRACE_THREADS.pop(device_id)
         server.respond(HTTPStatus.OK, json.dumps(errors).encode("utf-8"), "text/plain")
 
@@ -1400,7 +1428,7 @@ class StatusEndpoint(DeviceRequestEndpoint):
 
 class DumpEndpoint(DeviceRequestEndpoint):
     def process_with_device(self, server, path, device_id):
-        dump_targets = self.get_targets_and_prepare_for_tracing(
+        dump_targets, warnings = self.get_targets_and_prepare_for_tracing(
             server, device_id, PERFETTO_DUMP_CONFIG_FILE, DUMP_TARGETS, "perfetto_dump")
 
         dump_commands = []
@@ -1417,12 +1445,12 @@ class DumpEndpoint(DeviceRequestEndpoint):
         shell = get_shell_args(device_id, "dump")
         process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                    stdin=subprocess.PIPE, start_new_session=True)
-        log.debug("Starting dump on device {}".format(device_id))
+        log.info("Starting dump on device {}".format(device_id))
         out, err = process.communicate(dump_commands.encode('utf-8'))
         if process.returncode != 0:
             raise AdbError("Error executing dump command." + "\n\n### OUTPUT ###" + out.decode('utf-8') + "\n"
                            + err.decode('utf-8'))
-        log.debug("Dump finished on device {}".format(device_id))
+        log.info("Dump finished on device {}".format(device_id))
 
         for target, config in dump_targets:
             if config:
@@ -1432,7 +1460,7 @@ class DumpEndpoint(DeviceRequestEndpoint):
             else:
                 move_collected_files(target.files, device_id, "")
 
-        server.respond(HTTPStatus.OK, b'', "text/plain")
+        server.respond(HTTPStatus.OK, json.dumps(warnings).encode("utf-8"), "text/plain")
 
 
 class ADBWinscopeProxy(BaseHTTPRequestHandler):
diff --git a/tools/winscope/src/app/app_module.ts b/tools/winscope/src/app/app_module.ts
index e0fea16ad..c3b5457ee 100644
--- a/tools/winscope/src/app/app_module.ts
+++ b/tools/winscope/src/app/app_module.ts
@@ -45,13 +45,13 @@ import {MatToolbarModule} from '@angular/material/toolbar';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserModule, Title} from '@angular/platform-browser';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
-import {LogComponent} from 'viewers/common/log_component';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
 import {CoordinatesTableComponent} from 'viewers/components/coordinates_table_component';
 import {HierarchyComponent} from 'viewers/components/hierarchy_component';
 import {HierarchyTreeNodeDataViewComponent} from 'viewers/components/hierarchy_tree_node_data_view_component';
 import {ImeAdditionalPropertiesComponent} from 'viewers/components/ime_additional_properties_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
 import {PropertiesTableComponent} from 'viewers/components/properties_table_component';
 import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
@@ -70,9 +70,12 @@ import {ViewerJankCujsComponent} from 'viewers/viewer_jank_cujs/viewer_jank_cujs
 import {ViewerMediaBasedComponent} from 'viewers/viewer_media_based/viewer_media_based_component';
 import {ProtologScrollDirective} from 'viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive';
 import {ViewerProtologComponent} from 'viewers/viewer_protolog/viewer_protolog_component';
+import {SearchListComponent} from 'viewers/viewer_search/search_list_component';
+import {ViewerSearchComponent} from 'viewers/viewer_search/viewer_search_component';
 import {ViewerSurfaceFlingerComponent} from 'viewers/viewer_surface_flinger/viewer_surface_flinger_component';
 import {TransactionsScrollDirective} from 'viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive';
 import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_transactions_component';
+import {TransitionsScrollDirective} from 'viewers/viewer_transitions/scroll_strategy/transitions_scroll_directive';
 import {ViewerTransitionsComponent} from 'viewers/viewer_transitions/viewer_transitions_component';
 import {ViewerViewCaptureComponent} from 'viewers/viewer_view_capture/viewer_view_capture_component';
 import {ViewerWindowManagerComponent} from 'viewers/viewer_window_manager/viewer_window_manager_component';
@@ -113,6 +116,7 @@ import {GlobalErrorHandler} from './global_error_handler';
     ViewerMediaBasedComponent,
     ViewerTransitionsComponent,
     ViewerViewCaptureComponent,
+    ViewerSearchComponent,
     CollectTracesComponent,
     UploadTracesComponent,
     AdbProxyComponent,
@@ -144,6 +148,7 @@ import {GlobalErrorHandler} from './global_error_handler';
     SliderComponent,
     ProtologScrollDirective,
     TransactionsScrollDirective,
+    TransitionsScrollDirective,
     ViewCapturePropertyGroupsComponent,
     SelectWithFilterComponent,
     ShortcutsComponent,
@@ -153,6 +158,7 @@ import {GlobalErrorHandler} from './global_error_handler';
     LogComponent,
     WarningDialogComponent,
     SearchBoxComponent,
+    SearchListComponent,
   ],
   imports: [
     BrowserModule,
diff --git a/tools/winscope/src/app/components/app_component.ts b/tools/winscope/src/app/components/app_component.ts
index f2cb1a0a6..0f0e1c872 100644
--- a/tools/winscope/src/app/components/app_component.ts
+++ b/tools/winscope/src/app/components/app_component.ts
@@ -65,6 +65,7 @@ import {ViewerInputComponent} from 'viewers/viewer_input/viewer_input_component'
 import {ViewerJankCujsComponent} from 'viewers/viewer_jank_cujs/viewer_jank_cujs_component';
 import {ViewerMediaBasedComponent} from 'viewers/viewer_media_based/viewer_media_based_component';
 import {ViewerProtologComponent} from 'viewers/viewer_protolog/viewer_protolog_component';
+import {ViewerSearchComponent} from 'viewers/viewer_search/viewer_search_component';
 import {ViewerSurfaceFlingerComponent} from 'viewers/viewer_surface_flinger/viewer_surface_flinger_component';
 import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_transactions_component';
 import {ViewerTransitionsComponent} from 'viewers/viewer_transitions/viewer_transitions_component';
@@ -106,8 +107,9 @@ import {UploadTracesComponent} from './upload_traces_component';
               class="file-name-input-field"
               *ngIf="isEditingFilename"
               floatLabel="always"
-              (keydown.enter)="onCheckIconClick()"
-              (focusout)="onCheckIconClick()"
+              (keydown.esc)="trySubmitFilename()"
+              (keydown.enter)="trySubmitFilename()"
+              (focusout)="trySubmitFilename()"
               matTooltip="Allowed: A-Z a-z 0-9 . _ - #">
               <mat-label>Edit file name</mat-label>
               <input matInput class="right-align" [formControl]="filenameFormControl" />
@@ -118,7 +120,7 @@ import {UploadTracesComponent} from './upload_traces_component';
               mat-icon-button
               class="check-button"
               matTooltip="Submit file name"
-              (click)="onCheckIconClick()">
+              (click)="trySubmitFilename()">
               <mat-icon>check</mat-icon>
             </button>
             <button
@@ -463,6 +465,12 @@ export class AppComponent implements WinscopeEventListener {
         createCustomElement(ViewerInputComponent, {injector}),
       );
     }
+    if (!customElements.get('viewer-search')) {
+      customElements.define(
+        'viewer-search',
+        createCustomElement(ViewerSearchComponent, {injector}),
+      );
+    }
 
     this.traceConfigStorage =
       globalConfig.MODE === 'PROD'
@@ -508,7 +516,7 @@ export class AppComponent implements WinscopeEventListener {
     this.isEditingFilename = true;
   }
 
-  onCheckIconClick() {
+  trySubmitFilename() {
     if (this.filenameFormControl.invalid) {
       return;
     }
diff --git a/tools/winscope/src/app/components/app_component_test.ts b/tools/winscope/src/app/components/app_component_test.ts
index 70ca1cad7..af84b696d 100644
--- a/tools/winscope/src/app/components/app_component_test.ts
+++ b/tools/winscope/src/app/components/app_component_test.ts
@@ -178,10 +178,8 @@ describe('AppComponent', () => {
     goToTraceView();
     checkTraceViewPage();
 
-    (
-      assertDefined(
-        htmlElement.querySelector('.upload-new'),
-      ) as HTMLButtonElement
+    assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.upload-new'),
     ).click();
     fixture.detectChanges();
     await fixture.whenStable();
@@ -199,10 +197,8 @@ describe('AppComponent', () => {
       component.mediator,
       'onWinscopeEvent',
     ).and.callThrough();
-    (
-      assertDefined(
-        htmlElement.querySelector('.refresh-dumps'),
-      ) as HTMLButtonElement
+    assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.refresh-dumps'),
     ).click();
     fixture.detectChanges();
     await fixture.whenStable();
@@ -319,25 +315,33 @@ describe('AppComponent', () => {
     );
   });
 
-  it('validates filename on enter key', () => {
-    const spy = spyOn(component, 'onCheckIconClick');
+  it('validates filename on enter key, escape key or focus out', () => {
+    const spy = spyOn(component, 'trySubmitFilename');
 
     component.showDataLoadedElements = true;
     fixture.detectChanges();
-
     clickEditFilenameButton();
-
     const inputField = assertDefined(
       htmlElement.querySelector('.file-name-input-field'),
     );
     const inputEl = assertDefined(
-      htmlElement.querySelector('.file-name-input-field input'),
+      htmlElement.querySelector<HTMLInputElement>(
+        '.file-name-input-field input',
+      ),
     );
-    (inputEl as HTMLInputElement).value = 'valid_file_name';
+    inputEl.value = 'valid_file_name';
+
     inputField.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter'}));
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledTimes(1);
+
+    inputField.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledTimes(2);
 
+    inputField.dispatchEvent(new FocusEvent('focusout'));
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalled();
+    expect(spy).toHaveBeenCalledTimes(3);
   });
 
   it('downloads traces from upload traces section', () => {
@@ -362,8 +366,8 @@ describe('AppComponent', () => {
   it('opens shortcuts dialog', () => {
     expect(document.querySelector('shortcuts-panel')).toBeFalsy();
     const shortcutsButton = assertDefined(
-      htmlElement.querySelector('.shortcuts'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('.shortcuts'),
+    );
     shortcutsButton.click();
     fixture.detectChanges();
     expect(document.querySelector('shortcuts-panel')).toBeTruthy();
@@ -395,8 +399,8 @@ describe('AppComponent', () => {
     expect(snackbar.textContent).toContain(firstMessage.getMessage());
 
     const closeButton = assertDefined(
-      snackbar.querySelector('.snack-bar-action'),
-    ) as HTMLElement;
+      snackbar.querySelector<HTMLElement>('.snack-bar-action'),
+    );
     closeButton.click();
     fixture.detectChanges();
     await fixture.whenRenderingDone();
@@ -417,29 +421,29 @@ describe('AppComponent', () => {
 
   function updateFilenameInputAndDownloadTraces(name: string, valid: boolean) {
     const inputEl = assertDefined(
-      htmlElement.querySelector('.file-name-input-field input'),
+      htmlElement.querySelector<HTMLInputElement>(
+        '.file-name-input-field input',
+      ),
     );
     const checkButton = assertDefined(
       htmlElement.querySelector('.check-button'),
     );
-    (inputEl as HTMLInputElement).value = name;
+    inputEl.value = name;
     inputEl.dispatchEvent(new Event('input'));
     fixture.detectChanges();
     checkButton.dispatchEvent(new Event('click'));
     fixture.detectChanges();
+
+    const saveButton = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.save-button'),
+    );
     if (valid) {
       assertDefined(htmlElement.querySelector('.download-file-info'));
-      expect(
-        (htmlElement.querySelector('.save-button') as HTMLButtonElement)
-          .disabled,
-      ).toBeFalse();
+      expect(saveButton.disabled).toBeFalse();
       clickDownloadTracesButton();
     } else {
       expect(htmlElement.querySelector('.download-file-info')).toBeFalsy();
-      expect(
-        (htmlElement.querySelector('.save-button') as HTMLButtonElement)
-          .disabled,
-      ).toBeTrue();
+      expect(saveButton.disabled).toBeTrue();
     }
   }
 
@@ -465,6 +469,7 @@ describe('AppComponent', () => {
     expect(htmlElement.querySelector('.upload-traces-card')).toBeTruthy();
     expect(htmlElement.querySelector('.viewers')).toBeFalsy();
     expect(htmlElement.querySelector('.upload-new')).toBeFalsy();
+    expect(htmlElement.querySelector('timeline')).toBeFalsy();
     checkPermanentHeaderItems();
   }
 
@@ -475,6 +480,7 @@ describe('AppComponent', () => {
     expect(htmlElement.querySelector('.upload-traces-card')).toBeFalsy();
     expect(htmlElement.querySelector('.viewers')).toBeTruthy();
     expect(htmlElement.querySelector('.upload-new')).toBeTruthy();
+    expect(htmlElement.querySelector('timeline')).toBeTruthy();
     checkPermanentHeaderItems();
   }
 
diff --git a/tools/winscope/src/app/components/timeline/timeline_component.ts b/tools/winscope/src/app/components/timeline/timeline_component.ts
index bbd490c1a..81158779f 100644
--- a/tools/winscope/src/app/components/timeline/timeline_component.ts
+++ b/tools/winscope/src/app/components/timeline/timeline_component.ts
@@ -67,196 +67,203 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
   selector: 'timeline',
   encapsulation: ViewEncapsulation.None,
   template: `
-    <div id="toggle" *ngIf="timelineData.hasMoreThanOneDistinctTimestamp()">
-      <button
-        mat-icon-button
-        [class]="TOGGLE_BUTTON_CLASS"
-        color="basic"
-        aria-label="Toggle Expanded Timeline"
-        (click)="toggleExpand()">
-          <mat-icon *ngIf="!expanded" class="material-symbols-outlined">expand_circle_up</mat-icon>
-          <mat-icon *ngIf="expanded" class="material-symbols-outlined">expand_circle_down</mat-icon>
-        </button>
-    </div>
-    <div id="expanded-nav" *ngIf="expanded">
-      <div id="video-content" *ngIf="videoUrl !== undefined">
-        <video
-          *ngIf="getVideoCurrentTime() !== undefined"
-          id="video"
-          [currentTime]="getVideoCurrentTime()"
-          [src]="videoUrl"></video>
-        <div *ngIf="getVideoCurrentTime() === undefined" class="no-video-message">
-          <p>No screenrecording frame to show</p>
-          <p>Current timestamp before first screenrecording frame.</p>
+    <div
+      *ngIf="isDisabled"
+      class="disabled-message user-notification mat-body-1"> Timeline disabled due to ongoing search query </div>
+    <div [class.disabled-component]="isDisabled">
+      <div id="toggle" *ngIf="timelineData.hasMoreThanOneDistinctTimestamp()">
+        <button
+          mat-icon-button
+          [class]="TOGGLE_BUTTON_CLASS"
+          color="basic"
+          aria-label="Toggle Expanded Timeline"
+          (click)="toggleExpand()">
+            <mat-icon *ngIf="!expanded" class="material-symbols-outlined">expand_circle_up</mat-icon>
+            <mat-icon *ngIf="expanded" class="material-symbols-outlined">expand_circle_down</mat-icon>
+          </button>
+      </div>
+      <div id="expanded-nav" *ngIf="expanded">
+        <div id="video-content" *ngIf="videoUrl !== undefined">
+          <video
+            *ngIf="getVideoCurrentTime() !== undefined"
+            id="video"
+            [currentTime]="getVideoCurrentTime()"
+            [src]="videoUrl"></video>
+          <div *ngIf="getVideoCurrentTime() === undefined" class="no-video-message">
+            <p>No screenrecording frame to show</p>
+            <p>Current timestamp before first screenrecording frame.</p>
+          </div>
         </div>
+        <expanded-timeline
+          [timelineData]="timelineData"
+          (onTracePositionUpdate)="updatePosition($event)"
+          (onScrollEvent)="updateScrollEvent($event)"
+          (onTraceClicked)="onExpandedTimelineTraceClicked($event)"
+          (onMouseXRatioUpdate)="updateExpandedTimelineMouseXRatio($event)"
+          id="expanded-timeline"></expanded-timeline>
       </div>
-      <expanded-timeline
-        [timelineData]="timelineData"
-        (onTracePositionUpdate)="updatePosition($event)"
-        (onScrollEvent)="updateScrollEvent($event)"
-        (onTraceClicked)="onExpandedTimelineTraceClicked($event)"
-        (onMouseXRatioUpdate)="updateExpandedTimelineMouseXRatio($event)"
-        id="expanded-timeline"></expanded-timeline>
-    </div>
-    <div class="navbar-toggle">
-      <div class="navbar" #collapsedTimeline>
-        <ng-template [ngIf]="timelineData.hasTimestamps()">
-          <div id="time-selector">
-            <form [formGroup]="timestampForm" class="time-selector-form">
-              <mat-form-field
-                class="time-input human"
-                appearance="fill"
-                (keydown.enter)="onKeydownEnterTimeInputField($event)"
-                (change)="onHumanTimeInputChange($event)">
-                <mat-icon
-                  [matTooltip]="getHumanTimeTooltip()"
-                  matTooltipClass="multline-tooltip"
-                  matPrefix>schedule</mat-icon>
-                <input
-                  matInput
-                  name="humanTimeInput"
-                  [formControl]="selectedTimeFormControl" />
-                <div class="field-suffix" matSuffix>
-                  <span class="time-difference"> {{ getUTCOffset() }} </span>
-                  <button
-                    mat-icon-button
-                    [matTooltip]="getCopyHumanTimeTooltip()"
+      <div class="navbar-toggle">
+        <div class="navbar" #collapsedTimeline>
+          <ng-template [ngIf]="timelineData.hasTimestamps()">
+            <div id="time-selector">
+              <form [formGroup]="timestampForm" class="time-selector-form">
+                <mat-form-field
+                  class="time-input human"
+                  appearance="fill"
+                  (keydown.esc)="$event.target.blur()"
+                  (keydown.enter)="onKeydownEnterTimeInputField($event)"
+                  (change)="onHumanTimeInputChange($event)">
+                  <mat-icon
+                    [matTooltip]="getHumanTimeTooltip()"
                     matTooltipClass="multline-tooltip"
-                    [cdkCopyToClipboard]="getHumanTime()"
-                    (cdkCopyToClipboardCopied)="onTimeCopied('human')"
-                    matSuffix>
-                    <mat-icon>content_copy</mat-icon>
-                  </button>
-                </div>
-              </mat-form-field>
-              <mat-form-field
-                class="time-input nano"
-                appearance="fill"
-                (keydown.enter)="onKeydownEnterNanosecondsTimeInputField($event)"
-                (change)="onNanosecondsInputTimeChange($event)">
-                <mat-icon
-                  class="bookmark-icon"
-                  [class.material-symbols-outlined]="!currentPositionBookmarked()"
-                  matTooltip="bookmark timestamp"
-                  (click)="toggleBookmarkCurrentPosition($event)"
-                  matPrefix>flag</mat-icon>
-                <input matInput name="nsTimeInput" [formControl]="selectedNsFormControl" />
-                <div class="field-suffix" matSuffix>
-                  <button
-                    mat-icon-button
-                    [matTooltip]="getCopyPositionTooltip(selectedNsFormControl.value)"
-                    matTooltipClass="multline-tooltip"
-                    [cdkCopyToClipboard]="selectedNsFormControl.value"
-                    (cdkCopyToClipboardCopied)="onTimeCopied('ns')"
-                    matSuffix>
-                    <mat-icon>content_copy</mat-icon>
-                  </button>
-                </div>
-              </mat-form-field>
-            </form>
-            <div class="time-controls">
-              <button
-                mat-icon-button
-                id="prev_entry_button"
-                matTooltip="Go to previous entry"
-                (click)="moveToPreviousEntry()"
-                [class.disabled]="!hasPrevEntry()"
-                [disabled]="!hasPrevEntry()">
-                <mat-icon>chevron_left</mat-icon>
-              </button>
-              <button
-                mat-icon-button
-                id="next_entry_button"
-                matTooltip="Go to next entry"
-                (click)="moveToNextEntry()"
-                [class.disabled]="!hasNextEntry()"
-                [disabled]="!hasNextEntry()">
-                <mat-icon>chevron_right</mat-icon>
-              </button>
-            </div>
-          </div>
-          <div id="trace-selector">
-            <mat-form-field appearance="none">
-              <mat-select #traceSelector [formControl]="selectedTracesFormControl" multiple>
-                <div class="select-traces-panel">
-                  <div class="tip">Filter traces in the timeline</div>
-                  <mat-option
-                    *ngFor="let trace of sortedTraces"
-                    [value]="trace"
-                    [style]="{
-                      color: 'var(--blue-text-color)',
-                      opacity: isOptionDisabled(trace) ? 0.5 : 1.0
-                    }"
-                    [disabled]="isOptionDisabled(trace)"
-                    (click)="applyNewTraceSelection(trace)">
-                    <mat-icon
-                      [style]="{
-                        color: TRACE_INFO[trace.type].color
-                      }"
-                    >{{ TRACE_INFO[trace.type].icon }}</mat-icon>
-                    {{ getTitle(trace) }}
-                  </mat-option>
-                  <div class="actions">
-                    <button mat-flat-button color="primary" (click)="traceSelector.close()">
-                      Done
+                    matPrefix>schedule</mat-icon>
+                  <input
+                    matInput
+                    name="humanTimeInput"
+                    [formControl]="selectedTimeFormControl" />
+                  <div class="field-suffix" matSuffix>
+                    <span class="time-difference"> {{ getUTCOffset() }} </span>
+                    <button
+                      mat-icon-button
+                      [matTooltip]="getCopyHumanTimeTooltip()"
+                      matTooltipClass="multline-tooltip"
+                      [cdkCopyToClipboard]="getHumanTime()"
+                      (cdkCopyToClipboardCopied)="onTimeCopied('human')"
+                      matSuffix>
+                      <mat-icon>content_copy</mat-icon>
                     </button>
                   </div>
-                </div>
-                <mat-select-trigger class="shown-selection">
-                  <div class="filter-header">
-                    <span class="mat-body-2"> Filter </span>
-                    <mat-icon class="material-symbols-outlined">expand_circle_up</mat-icon>
+                </mat-form-field>
+                <mat-form-field
+                  class="time-input nano"
+                  appearance="fill"
+                  (keydown.esc)="$event.target.blur()"
+                  (keydown.enter)="onKeydownEnterNanosecondsTimeInputField($event)"
+                  (change)="onNanosecondsInputTimeChange($event)">
+                  <mat-icon
+                    class="bookmark-icon"
+                    [class.material-symbols-outlined]="!currentPositionBookmarked()"
+                    matTooltip="bookmark timestamp"
+                    (click)="toggleBookmarkCurrentPosition($event)"
+                    matPrefix>flag</mat-icon>
+                  <input matInput name="nsTimeInput" [formControl]="selectedNsFormControl" />
+                  <div class="field-suffix" matSuffix>
+                    <button
+                      mat-icon-button
+                      [matTooltip]="getCopyPositionTooltip(selectedNsFormControl.value)"
+                      matTooltipClass="multline-tooltip"
+                      [cdkCopyToClipboard]="selectedNsFormControl.value"
+                      (cdkCopyToClipboardCopied)="onTimeCopied('ns')"
+                      matSuffix>
+                      <mat-icon>content_copy</mat-icon>
+                    </button>
                   </div>
-
-                  <div class="trace-icons">
-                    <mat-icon
-                      class="trace-icon"
-                      *ngFor="let selectedTrace of getSelectedTracesToShow()"
-                      [style]="{color: TRACE_INFO[selectedTrace.type].color}"
-                      [matTooltip]="getTraceTooltip(selectedTrace)"
-                      #tooltip="matTooltip"
-                      (mouseenter)="tooltip.disabled = false"
-                      (mouseleave)="tooltip.disabled = true">
-                      {{ TRACE_INFO[selectedTrace.type].icon }}
-                    </mat-icon>
-                    <mat-icon
-                      class="trace-icon"
-                      *ngIf="selectedTraces.length > 8">
-                      more_horiz
-                    </mat-icon>
+                </mat-form-field>
+              </form>
+              <div class="time-controls">
+                <button
+                  mat-icon-button
+                  id="prev_entry_button"
+                  matTooltip="Go to previous entry"
+                  (click)="moveToPreviousEntry()"
+                  [class.disabled]="!hasPrevEntry()"
+                  [disabled]="!hasPrevEntry()">
+                  <mat-icon>chevron_left</mat-icon>
+                </button>
+                <button
+                  mat-icon-button
+                  id="next_entry_button"
+                  matTooltip="Go to next entry"
+                  (click)="moveToNextEntry()"
+                  [class.disabled]="!hasNextEntry()"
+                  [disabled]="!hasNextEntry()">
+                  <mat-icon>chevron_right</mat-icon>
+                </button>
+              </div>
+            </div>
+            <div id="trace-selector">
+              <mat-form-field appearance="none">
+                <mat-select #traceSelector [formControl]="selectedTracesFormControl" multiple>
+                  <div class="select-traces-panel">
+                    <div class="tip">Filter traces in the timeline</div>
+                    <mat-option
+                      *ngFor="let trace of sortedTraces"
+                      [value]="trace"
+                      [style]="{
+                        color: 'var(--blue-text-color)',
+                        opacity: isOptionDisabled(trace) ? 0.5 : 1.0
+                      }"
+                      [disabled]="isOptionDisabled(trace)"
+                      (click)="applyNewTraceSelection(trace)">
+                      <mat-icon
+                        [style]="{
+                          color: TRACE_INFO[trace.type].color
+                        }"
+                      >{{ TRACE_INFO[trace.type].icon }}</mat-icon>
+                      {{ getTitle(trace) }}
+                    </mat-option>
+                    <div class="actions">
+                      <button mat-flat-button color="primary" (click)="traceSelector.close()">
+                        Done
+                      </button>
+                    </div>
                   </div>
-                </mat-select-trigger>
-              </mat-select>
-            </mat-form-field>
+                  <mat-select-trigger class="shown-selection">
+                    <div class="filter-header">
+                      <span class="mat-body-2"> Filter </span>
+                      <mat-icon class="material-symbols-outlined">expand_circle_up</mat-icon>
+                    </div>
+
+                    <div class="trace-icons">
+                      <mat-icon
+                        class="trace-icon"
+                        *ngFor="let selectedTrace of getSelectedTracesToShow()"
+                        [style]="{color: TRACE_INFO[selectedTrace.type].color}"
+                        [matTooltip]="getTraceTooltip(selectedTrace)"
+                        #tooltip="matTooltip"
+                        (mouseenter)="tooltip.disabled = false"
+                        (mouseleave)="tooltip.disabled = true">
+                        {{ TRACE_INFO[selectedTrace.type].icon }}
+                      </mat-icon>
+                      <mat-icon
+                        class="trace-icon"
+                        *ngIf="selectedTraces.length > 8">
+                        more_horiz
+                      </mat-icon>
+                    </div>
+                  </mat-select-trigger>
+                </mat-select>
+              </mat-form-field>
+            </div>
+            <mini-timeline
+              *ngIf="timelineData.hasMoreThanOneDistinctTimestamp()"
+              [timelineData]="timelineData"
+              [currentTracePosition]="getCurrentTracePosition()"
+              [selectedTraces]="selectedTraces"
+              [initialZoom]="initialZoom"
+              [expandedTimelineScrollEvent]="expandedTimelineScrollEvent"
+              [expandedTimelineMouseXRatio]="expandedTimelineMouseXRatio"
+              [bookmarks]="bookmarks"
+              [store]="store"
+              (onTracePositionUpdate)="updatePosition($event)"
+              (onSeekTimestampUpdate)="updateSeekTimestamp($event)"
+              (onRemoveAllBookmarks)="removeAllBookmarks()"
+              (onToggleBookmark)="toggleBookmarkRange($event.range, $event.rangeContainsBookmark)"
+              (onTraceClicked)="onMiniTimelineTraceClicked($event)"
+              id="mini-timeline"
+              #miniTimeline></mini-timeline>
+          </ng-template>
+          <div
+            *ngIf="!timelineData.hasMoreThanOneDistinctTimestamp()"
+            class="no-timeline-msg">
+              <p class="mat-body-2">No timeline to show!</p>
+              <p
+                *ngIf="timelineData.hasTimestamps()"
+                class="mat-body-1">Only a single timestamp has been recorded.</p>
+              <p
+                *ngIf="!timelineData.hasTimestamps()"
+                class="mat-body-1">All loaded traces contain no timestamps.</p>
           </div>
-          <mini-timeline
-            *ngIf="timelineData.hasMoreThanOneDistinctTimestamp()"
-            [timelineData]="timelineData"
-            [currentTracePosition]="getCurrentTracePosition()"
-            [selectedTraces]="selectedTraces"
-            [initialZoom]="initialZoom"
-            [expandedTimelineScrollEvent]="expandedTimelineScrollEvent"
-            [expandedTimelineMouseXRatio]="expandedTimelineMouseXRatio"
-            [bookmarks]="bookmarks"
-            [store]="store"
-            (onTracePositionUpdate)="updatePosition($event)"
-            (onSeekTimestampUpdate)="updateSeekTimestamp($event)"
-            (onRemoveAllBookmarks)="removeAllBookmarks()"
-            (onToggleBookmark)="toggleBookmarkRange($event.range, $event.rangeContainsBookmark)"
-            (onTraceClicked)="onMiniTimelineTraceClicked($event)"
-            id="mini-timeline"
-            #miniTimeline></mini-timeline>
-        </ng-template>
-        <div
-          *ngIf="!timelineData.hasMoreThanOneDistinctTimestamp()"
-          class="no-timeline-msg">
-            <p class="mat-body-2">No timeline to show!</p>
-            <p
-              *ngIf="timelineData.hasTimestamps()"
-              class="mat-body-1">Only a single timestamp has been recorded.</p>
-            <p
-              *ngIf="!timelineData.hasTimestamps()"
-              class="mat-body-1">All loaded traces contain no timestamps.</p>
         </div>
       </div>
     </div>
@@ -473,6 +480,13 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         flex-direction: column;
         width: 100%;
       }
+      .disabled-message {
+        z-index: 100;
+        position: absolute;
+        top: 10%;
+        left: 50%;
+        opacity: 1;
+      }
     `,
     multlineTooltip,
   ],
@@ -514,6 +528,7 @@ export class TimelineComponent
   isInputFormFocused = false;
   storeKeyDeselectedTraces = 'miniTimeline.deselectedTraces';
   bookmarks: Timestamp[] = [];
+  isDisabled = false;
 
   private expanded = false;
   private emitEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
@@ -637,6 +652,42 @@ export class TimelineComponent
       }
       await this.miniTimeline?.drawer?.draw();
     });
+    await event.visit(WinscopeEventType.TRACE_ADD_REQUEST, async (event) => {
+      this.sortedTraces.unshift(event.trace);
+      this.sortedTraces.sort((a, b) =>
+        TraceTypeUtils.compareByDisplayOrder(a.type, b.type),
+      );
+      this.selectedTracesFormControl.setValue(
+        (this.selectedTracesFormControl.value ?? []).concat([event.trace]),
+      );
+      this.applyNewTraceSelection(event.trace);
+      await this.miniTimeline?.drawer?.draw();
+    });
+    await event.visit(WinscopeEventType.TRACE_REMOVE_REQUEST, async (event) => {
+      this.sortedTraces = this.sortedTraces.filter(
+        (trace) => trace !== event.trace,
+      );
+      this.selectedTracesFormControl.setValue(
+        this.selectedTracesFormControl.value?.filter(
+          (trace) => trace !== event.trace,
+        ) ?? [],
+      );
+      this.applyNewTraceSelection(event.trace);
+      await this.miniTimeline?.drawer?.draw();
+    });
+    await event.visit(
+      WinscopeEventType.INITIALIZE_TRACE_SEARCH_REQUEST,
+      async () => this.setIsDisabled(true),
+    );
+    await event.visit(WinscopeEventType.TRACE_SEARCH_REQUEST, async () =>
+      this.setIsDisabled(true),
+    );
+    await event.visit(WinscopeEventType.TRACE_SEARCH_INITIALIZED, async () =>
+      this.setIsDisabled(false),
+    );
+    await event.visit(WinscopeEventType.TRACE_SEARCH_COMPLETED, async () =>
+      this.setIsDisabled(false),
+    );
   }
 
   async toggleExpand() {
@@ -709,6 +760,7 @@ export class TimelineComponent
   @HostListener('document:keydown', ['$event'])
   async handleKeyboardEvent(event: KeyboardEvent) {
     if (
+      this.isDisabled ||
       this.isInputFormFocused ||
       !assertDefined(this.timelineData).hasMoreThanOneDistinctTimestamp()
     ) {
@@ -1002,4 +1054,9 @@ export class TimelineComponent
     const valid = TimestampUtils.isNsFormat(control.value ?? '');
     return !valid ? {invalidInput: control.value} : null;
   }
+
+  private setIsDisabled(value: boolean) {
+    this.isDisabled = value;
+    this.changeDetectorRef.detectChanges();
+  }
 }
diff --git a/tools/winscope/src/app/components/timeline/timeline_component_test.ts b/tools/winscope/src/app/components/timeline/timeline_component_test.ts
index 778a28e7e..7f2f20364 100644
--- a/tools/winscope/src/app/components/timeline/timeline_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/timeline_component_test.ts
@@ -40,11 +40,18 @@ import {TimeRange} from 'common/time';
 import {
   ActiveTraceChanged,
   ExpandedTimelineToggled,
+  InitializeTraceSearchRequest,
+  TraceAddRequest,
   TracePositionUpdate,
+  TraceRemoveRequest,
+  TraceSearchCompleted,
+  TraceSearchInitialized,
+  TraceSearchRequest,
   WinscopeEvent,
 } from 'messaging/winscope_event';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
+import {UnitTestUtils} from 'test/unit/utils';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
@@ -275,7 +282,7 @@ describe('TimelineComponent', () => {
 
   it('handles undefined active trace input', async () => {
     const traces = new TracesBuilder()
-      .setTimestamps(TraceType.SCREEN_RECORDING, [time100, time110])
+      .setTimestamps(TraceType.EVENT_LOG, [time100, time110])
       .build();
 
     const timelineData = assertDefined(component.timelineData);
@@ -1025,6 +1032,54 @@ describe('TimelineComponent', () => {
     expect(position).toBeDefined();
   });
 
+  it('adds/removes trace and redraws timeline', async () => {
+    loadSfWmTraces();
+    const timelineComponent = assertDefined(component.timeline);
+    const initialTraces = timelineComponent.sortedTraces.slice();
+    const spy = spyOn(
+      assertDefined(timelineComponent.miniTimeline?.drawer),
+      'draw',
+    );
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.SEARCH);
+
+    await timelineComponent.onWinscopeEvent(new TraceAddRequest(trace));
+    expect(spy).toHaveBeenCalledTimes(1);
+    expect(timelineComponent.sortedTraces).not.toEqual(initialTraces);
+    expect(timelineComponent.sortedTraces[0]).toEqual(trace);
+
+    await timelineComponent.onWinscopeEvent(new TraceRemoveRequest(trace));
+    expect(spy).toHaveBeenCalledTimes(2);
+    expect(timelineComponent.sortedTraces).toEqual(initialTraces);
+  });
+
+  it('disables or enables timeline on winscope events', async () => {
+    loadSfWmTraces();
+    const timelineComponent = assertDefined(component.timeline);
+    checkTimelineEnabled();
+
+    await timelineComponent.onWinscopeEvent(new InitializeTraceSearchRequest());
+    checkTimelineDisabled();
+    await timelineComponent.onWinscopeEvent(new TraceSearchInitialized([]));
+    checkTimelineEnabled();
+
+    await timelineComponent.onWinscopeEvent(new TraceSearchRequest(''));
+    checkTimelineDisabled();
+    await timelineComponent.onWinscopeEvent(new TraceSearchCompleted());
+    checkTimelineEnabled();
+  });
+
+  it('does not handle arrow key presses if component disabled', () => {
+    loadSfWmTraces();
+    const timelineComponent = assertDefined(component.timeline);
+    timelineComponent.isDisabled = true;
+    fixture.detectChanges();
+
+    const spyNextEntry = spyOn(timelineComponent, 'moveToNextEntry');
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}));
+    fixture.detectChanges();
+    expect(spyNextEntry).not.toHaveBeenCalled();
+  });
+
   function loadSfWmTraces(hostComponent = component, hostFixture = fixture) {
     const traces = new TracesBuilder()
       .setTimestamps(TraceType.SURFACE_FLINGER, [time100, time110])
@@ -1314,6 +1369,16 @@ describe('TimelineComponent', () => {
     fixture.detectChanges();
   }
 
+  function checkTimelineEnabled() {
+    expect(htmlElement.querySelector('.disabled-component')).toBeNull();
+    expect(htmlElement.querySelector('.disabled-message')).toBeNull();
+  }
+
+  function checkTimelineDisabled() {
+    expect(htmlElement.querySelector('.disabled-component')).toBeTruthy();
+    expect(htmlElement.querySelector('.disabled-message')).toBeTruthy();
+  }
+
   @Component({
     selector: 'host-component',
     template: `
diff --git a/tools/winscope/src/app/components/trace_view_component.ts b/tools/winscope/src/app/components/trace_view_component.ts
index 47ca86ccb..7d410aa6b 100644
--- a/tools/winscope/src/app/components/trace_view_component.ts
+++ b/tools/winscope/src/app/components/trace_view_component.ts
@@ -73,8 +73,8 @@ interface Tab {
                 class="tab">
               <mat-icon
                 class="icon"
-                [style]="{color: TRACE_INFO[tab.view.traces[0].type].color, marginRight: '0.5rem'}">
-                  {{ TRACE_INFO[tab.view.traces[0].type].icon }}
+                [style]="{color: getTabIconColor(tab), marginRight: '0.5rem'}">
+                  {{ getTabIcon(tab) }}
               </mat-icon>
               <span>
                 {{ getTitle(tab.view) }}
@@ -217,22 +217,6 @@ interface Tab {
         border-radius: 15px;
       }
 
-      .save-field {
-        display: flex;
-        align-items: center;
-        font-size: 14px;
-        width: 100%;
-      }
-
-      .save-field mat-form-field {
-        width: 100%;
-      }
-
-      .save-field button {
-        height: fit-content;
-        margin-inline-start: 10px;
-      }
-
       .existing-preset {
         display: flex;
         flex-direction: row;
@@ -303,6 +287,22 @@ export class TraceViewComponent
     this.renderViewsOverlay();
   }
 
+  getTabIconColor(tab: Tab): string {
+    if (tab.view.type === ViewType.GLOBAL_SEARCH) return '';
+    const trace = tab.view.traces.at(0);
+    if (!trace) return '';
+    return TRACE_INFO[trace.type].color;
+  }
+
+  getTabIcon(tab: Tab): string {
+    if (tab.view.type === ViewType.GLOBAL_SEARCH) {
+      return TRACE_INFO[TraceType.SEARCH].icon;
+    }
+    const trace = tab.view.traces.at(0);
+    if (!trace) return '';
+    return TRACE_INFO[trace.type].icon;
+  }
+
   async onTabClick(tab: Tab) {
     await this.showTab(tab, false);
   }
@@ -332,7 +332,7 @@ export class TraceViewComponent
   }
 
   getTitle(view: View): string {
-    const isDump = view.traces.length === 1 && view.traces[0].isDump();
+    const isDump = view.traces.length === 1 && view.traces.at(0)?.isDump();
     return view.title + (isDump ? ' Dump' : '');
   }
 
@@ -410,14 +410,14 @@ export class TraceViewComponent
   }
 
   private getCurrentTabTraceType(): TraceType | undefined {
-    return this.currentActiveTab?.view.traces[0].type;
+    return this.currentActiveTab?.view.traces.at(0)?.type;
   }
 
   private renderViewsTab(firstToRender: boolean) {
     this.tabs = this.viewers
       .map((viewer) => viewer.getViews())
       .flat()
-      .filter((view) => view.type === ViewType.TAB)
+      .filter((view) => view.type !== ViewType.OVERLAY)
       .map((view) => {
         return {
           view,
@@ -432,7 +432,10 @@ export class TraceViewComponent
     });
 
     if (this.tabs.length > 0) {
-      this.showTab(this.tabs[0], firstToRender);
+      const tabToShow = assertDefined(
+        this.tabs.find((tab) => tab.view.type !== ViewType.GLOBAL_SEARCH),
+      );
+      this.showTab(tabToShow, firstToRender);
     }
   }
 
@@ -483,9 +486,7 @@ export class TraceViewComponent
     this.currentActiveTab = tab;
 
     if (!firstToRender) {
-      Analytics.Navigation.logTabSwitched(
-        TRACE_INFO[tab.view.traces[0].type].name,
-      );
+      Analytics.Navigation.logTabSwitched(tab.view.title);
       await this.emitAppEvent(new TabbedViewSwitched(tab.view));
     }
   }
diff --git a/tools/winscope/src/app/components/trace_view_component_test.ts b/tools/winscope/src/app/components/trace_view_component_test.ts
index fbef1cc39..9b0ef8403 100644
--- a/tools/winscope/src/app/components/trace_view_component_test.ts
+++ b/tools/winscope/src/app/components/trace_view_component_test.ts
@@ -39,29 +39,21 @@ import {
 } from 'messaging/winscope_event';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
 import {TraceType} from 'trace/trace_type';
 import {Viewer, ViewType} from 'viewers/viewer';
 import {ViewerStub} from 'viewers/viewer_stub';
 import {TraceViewComponent} from './trace_view_component';
 
 describe('TraceViewComponent', () => {
-  const traceSf = new TraceBuilder<object>()
-    .setType(TraceType.SURFACE_FLINGER)
-    .setEntries([])
-    .build();
+  const traceSf = UnitTestUtils.makeEmptyTrace(TraceType.SURFACE_FLINGER);
   const traceWm = new TraceBuilder<object>()
     .setType(TraceType.WINDOW_MANAGER)
     .setEntries([{}])
     .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
     .build();
-  const traceSr = new TraceBuilder<object>()
-    .setType(TraceType.SCREEN_RECORDING)
-    .setEntries([])
-    .build();
-  const traceProtolog = new TraceBuilder<object>()
-    .setType(TraceType.PROTO_LOG)
-    .setEntries([])
-    .build();
+  const traceSr = UnitTestUtils.makeEmptyTrace(TraceType.SCREEN_RECORDING);
+  const traceProtolog = UnitTestUtils.makeEmptyTrace(TraceType.PROTO_LOG);
 
   let fixture: ComponentFixture<TestHostComponent>;
   let component: TestHostComponent;
@@ -90,10 +82,10 @@ describe('TraceViewComponent', () => {
     htmlElement = fixture.nativeElement;
     component = fixture.componentInstance;
     component.viewers = [
-      new ViewerStub('Title0', 'Content0', traceSf, ViewType.TAB),
-      new ViewerStub('Title1', 'Content1', traceWm, ViewType.TAB),
+      new ViewerStub('Title0', 'Content0', traceSf, ViewType.TRACE_TAB),
+      new ViewerStub('Title1', 'Content1', traceWm, ViewType.TRACE_TAB),
       new ViewerStub('Title2', 'Content2', traceSr, ViewType.OVERLAY),
-      new ViewerStub('Title3', 'Content3', traceProtolog, ViewType.TAB),
+      new ViewerStub('Title3', 'Content3', traceProtolog, ViewType.TRACE_TAB),
     ];
     fixture.detectChanges();
   });
@@ -119,7 +111,7 @@ describe('TraceViewComponent', () => {
   it('throws error if more than one overlay present', () => {
     expect(() => {
       component.viewers = [
-        new ViewerStub('Title0', 'Content0', traceSf, ViewType.TAB),
+        new ViewerStub('Title0', 'Content0', traceSf, ViewType.TRACE_TAB),
         new ViewerStub('Title1', 'Content1', traceWm, ViewType.OVERLAY),
         new ViewerStub('Title2', 'Content2', traceSr, ViewType.OVERLAY),
       ];
@@ -371,6 +363,17 @@ describe('TraceViewComponent', () => {
     );
   });
 
+  it('does not show global tab first', () => {
+    component.viewers = [
+      new ViewerStub('Title0', 'Content0', undefined, ViewType.GLOBAL_SEARCH),
+      new ViewerStub('Title1', 'Content1', traceWm, ViewType.TRACE_TAB),
+    ];
+    fixture.detectChanges();
+    const visibleTabContents = getVisibleTabContents();
+    expect(visibleTabContents.length).toEqual(1);
+    expect(visibleTabContents[0].innerHTML).toEqual('Content1');
+  });
+
   function getVisibleTabContents() {
     const contents: HTMLElement[] = [];
     htmlElement
diff --git a/tools/winscope/src/app/components/upload_traces_component.ts b/tools/winscope/src/app/components/upload_traces_component.ts
index b59f759b7..0eda819fe 100644
--- a/tools/winscope/src/app/components/upload_traces_component.ts
+++ b/tools/winscope/src/app/components/upload_traces_component.ts
@@ -105,7 +105,7 @@ import {LoadProgressComponent} from './load_progress_component';
             <mat-icon class="warning-icon" *ngIf="!canVisualizeTrace(trace)" [matTooltip]="cannotVisualizeTraceTooltip(trace)">
               warning
             </mat-icon>
-            <mat-icon class="trace-error-icon" *ngIf="trace.isCorrupted()" [matTooltip]="traceErrorTooltip(trace)">
+            <mat-icon class="error-icon" *ngIf="trace.isCorrupted()" [matTooltip]="traceErrorTooltip(trace)">
               error
             </mat-icon>
             <button mat-icon-button (click)="onRemoveTrace($event, trace)">
@@ -205,15 +205,9 @@ import {LoadProgressComponent} from './load_progress_component';
       .trace-error {
         background-color: var(--error-background-color);
       }
-      .warning-icon, .trace-error-icon {
+      .warning-icon, .error-icon {
         flex-shrink: 0;
       }
-      .warning-icon {
-        color: var(--warning-color);
-      }
-      .trace-error-icon {
-        color: var(--error-color);
-      }
     `,
   ],
 })
diff --git a/tools/winscope/src/app/components/upload_traces_component_test.ts b/tools/winscope/src/app/components/upload_traces_component_test.ts
index e97a6d208..2612eec9f 100644
--- a/tools/winscope/src/app/components/upload_traces_component_test.ts
+++ b/tools/winscope/src/app/components/upload_traces_component_test.ts
@@ -188,7 +188,7 @@ describe('UploadTracesComponent', () => {
       htmlElement.querySelector<HTMLButtonElement>('.load-btn'),
     );
 
-    expect(htmlElement.querySelector('.trace-error-icon')).toBeTruthy();
+    expect(htmlElement.querySelector('.error-icon')).toBeTruthy();
     expect(viewTracesButton.disabled).toBeTrue();
   });
 
diff --git a/tools/winscope/src/app/loaded_parsers_test.ts b/tools/winscope/src/app/loaded_parsers_test.ts
index ed30fb89d..a42703500 100644
--- a/tools/winscope/src/app/loaded_parsers_test.ts
+++ b/tools/winscope/src/app/loaded_parsers_test.ts
@@ -317,6 +317,7 @@ describe('LoadedParsers', () => {
     it('when a perfetto parser is already loaded', () => {
       loadParsers([parserSf0], [parserSf1]);
       expectLoadResult([parserSf1], [new TraceOverridden(filename)]);
+      userNotifierChecker.reset();
 
       loadParsers([parserSf0], []);
       expectLoadResult([parserSf1], [new TraceOverridden(filename)]);
diff --git a/tools/winscope/src/app/mediator.ts b/tools/winscope/src/app/mediator.ts
index 2482793b5..0c96f4967 100644
--- a/tools/winscope/src/app/mediator.ts
+++ b/tools/winscope/src/app/mediator.ts
@@ -33,7 +33,11 @@ import {
 import {
   ActiveTraceChanged,
   ExpandedTimelineToggled,
+  TraceAddRequest,
   TracePositionUpdate,
+  TraceSearchCompleted,
+  TraceSearchFailed,
+  TraceSearchInitialized,
   ViewersLoaded,
   ViewersUnloaded,
   WinscopeEvent,
@@ -51,6 +55,7 @@ import {ViewerFactory} from 'viewers/viewer_factory';
 import {FilesSource} from './files_source';
 import {TimelineData} from './timeline_data';
 import {TracePipeline} from './trace_pipeline';
+import {TraceSearchInitializer} from './trace_search/trace_search_initializer';
 
 export class Mediator {
   private abtChromeExtensionProtocol: WinscopeEventEmitter &
@@ -230,10 +235,13 @@ export class Mediator {
     );
 
     await event.visit(WinscopeEventType.TABBED_VIEW_SWITCHED, async (event) => {
-      if (this.timelineData.trySetActiveTrace(event.newFocusedView.traces[0])) {
-        await this.timelineComponent?.onWinscopeEvent(
-          new ActiveTraceChanged(event.newFocusedView.traces[0]),
-        );
+      const newActiveTrace = event.newFocusedView.traces[0];
+      if (this.timelineData.trySetActiveTrace(newActiveTrace)) {
+        const activeTraceChanged = new ActiveTraceChanged(newActiveTrace);
+        await this.timelineComponent?.onWinscopeEvent(activeTraceChanged);
+        for (const viewer of this.viewers) {
+          await viewer.onWinscopeEvent(activeTraceChanged);
+        }
       }
       this.focusedTabView = event.newFocusedView;
       await this.propagateTracePosition(
@@ -263,6 +271,9 @@ export class Mediator {
 
     await event.visit(WinscopeEventType.ACTIVE_TRACE_CHANGED, async (event) => {
       this.timelineData.trySetActiveTrace(event.trace);
+      for (const viewer of this.viewers) {
+        await viewer.onWinscopeEvent(event);
+      }
       await this.timelineComponent?.onWinscopeEvent(event);
     });
 
@@ -293,6 +304,48 @@ export class Mediator {
         await this.findViewerByType(event.traceType)?.onWinscopeEvent(event);
       },
     );
+
+    await event.visit(WinscopeEventType.TRACE_SEARCH_REQUEST, async (event) => {
+      await this.timelineComponent?.onWinscopeEvent(event);
+      const searchViewer = this.viewers.find(
+        (viewer) => viewer.getViews()[0].type === ViewType.GLOBAL_SEARCH,
+      );
+      const trace = await this.tracePipeline.tryCreateSearchTrace(event.query);
+      this.timelineComponent?.onWinscopeEvent(new TraceSearchCompleted());
+      if (!trace) {
+        await searchViewer?.onWinscopeEvent(new TraceSearchFailed());
+        return;
+      }
+      const newSearchTrace = new TraceAddRequest(trace);
+      await searchViewer?.onWinscopeEvent(newSearchTrace);
+      if (trace.lengthEntries > 0 && !trace.isDumpWithoutTimestamp()) {
+        assertDefined(this.timelineData).getTraces().addTrace(trace);
+        await this.timelineComponent?.onWinscopeEvent(newSearchTrace);
+      }
+    });
+
+    await event.visit(WinscopeEventType.TRACE_REMOVE_REQUEST, async (event) => {
+      this.tracePipeline.getTraces().deleteTrace(event.trace);
+      if (this.timelineData.hasTrace(event.trace)) {
+        this.timelineData.getTraces().deleteTrace(event.trace);
+        await this.timelineComponent?.onWinscopeEvent(event);
+      }
+    });
+
+    await event.visit(
+      WinscopeEventType.INITIALIZE_TRACE_SEARCH_REQUEST,
+      async (event) => {
+        await this.timelineComponent?.onWinscopeEvent(event);
+        const traces = this.tracePipeline.getTraces();
+        const views = await TraceSearchInitializer.createSearchViews(traces);
+        const searchViewer = this.viewers.find(
+          (viewer) => viewer.getViews()[0].type === ViewType.GLOBAL_SEARCH,
+        );
+        const initializedEvent = new TraceSearchInitialized(views);
+        await searchViewer?.onWinscopeEvent(initializedEvent);
+        await this.timelineComponent?.onWinscopeEvent(initializedEvent);
+      },
+    );
   }
 
   private async loadFiles(files: File[], source: FilesSource) {
@@ -459,7 +512,7 @@ export class Mediator {
     await this.propagateTracePosition(initialPosition, true);
 
     this.focusedTabView = this.viewers
-      .find((v) => v.getViews()[0].type !== ViewType.OVERLAY)
+      .find((v) => v.getViews()[0].type === ViewType.TRACE_TAB)
       ?.getViews()[0];
     this.areViewersLoaded = true;
 
diff --git a/tools/winscope/src/app/mediator_test.ts b/tools/winscope/src/app/mediator_test.ts
index 743787eb4..e39eb52d2 100644
--- a/tools/winscope/src/app/mediator_test.ts
+++ b/tools/winscope/src/app/mediator_test.ts
@@ -43,13 +43,20 @@ import {
   ExpandedTimelineToggled,
   FilterPresetApplyRequest,
   FilterPresetSaveRequest,
+  InitializeTraceSearchRequest,
   NoTraceTargetsSelected as NoTraceTargetsSelectedEvent,
   RemoteToolDownloadStart,
   RemoteToolFilesReceived,
   RemoteToolTimestampReceived,
   TabbedViewSwitched,
   TabbedViewSwitchRequest,
+  TraceAddRequest,
   TracePositionUpdate,
+  TraceRemoveRequest,
+  TraceSearchCompleted,
+  TraceSearchFailed,
+  TraceSearchInitialized,
+  TraceSearchRequest,
   ViewersLoaded,
   ViewersUnloaded,
   WinscopeEvent,
@@ -73,6 +80,7 @@ import {ViewerStub} from 'viewers/viewer_stub';
 import {Mediator} from './mediator';
 import {TimelineData} from './timeline_data';
 import {TracePipeline} from './trace_pipeline';
+import {TraceSearchInitializer} from './trace_search/trace_search_initializer';
 
 describe('Mediator', () => {
   const TIMESTAMP_10 = TimestampConverterUtils.makeRealTimestamp(10n);
@@ -96,6 +104,7 @@ describe('Mediator', () => {
 
   let inputFiles: File[];
   let eventLogFile: File;
+  let perfettoFile: File;
   let tracePipeline: TracePipeline;
   let timelineData: TimelineData;
   let abtChromeExtensionProtocol: WinscopeEventEmitter & WinscopeEventListener;
@@ -110,6 +119,7 @@ describe('Mediator', () => {
   let mediator: Mediator;
   let spies: Array<jasmine.Spy<jasmine.Func>>;
   let userNotifierChecker: UserNotifierChecker;
+  let createViewersSpy: jasmine.Spy;
 
   const viewerStub0 = new ViewerStub('Title0', undefined, traceSf);
   const viewerStub1 = new ViewerStub('Title1', undefined, traceWm);
@@ -135,6 +145,9 @@ describe('Mediator', () => {
         'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
       ),
     ];
+    perfettoFile = await UnitTestUtils.getFixtureFile(
+      'traces/perfetto/layers_trace.perfetto-trace',
+    );
     eventLogFile = await UnitTestUtils.getFixtureFile(
       'traces/eventlog_no_cujs.winscope',
     );
@@ -189,7 +202,10 @@ describe('Mediator', () => {
       crossToolProtocol,
     ];
 
-    spyOn(ViewerFactory.prototype, 'createViewers').and.returnValue(viewers);
+    createViewersSpy = spyOn(
+      ViewerFactory.prototype,
+      'createViewers',
+    ).and.returnValue(viewers);
 
     spies = [
       spyOn(abtChromeExtensionProtocol, 'onWinscopeEvent'),
@@ -236,9 +252,12 @@ describe('Mediator', () => {
 
   it('handles collected traces from Winscope', async () => {
     await mediator.onWinscopeEvent(
-      new AppFilesCollected({requested: [], collected: inputFiles}),
+      new AppFilesCollected({
+        requested: [],
+        collected: [inputFiles[0], inputFiles[1]],
+      }),
     );
-    userNotifierChecker.expectNotified([]);
+    userNotifierChecker.expectNone();
     await checkLoadTraceViewEvents(collectTracesComponent);
   });
 
@@ -314,14 +333,14 @@ describe('Mediator', () => {
         requested: [
           {
             name: 'Collected Trace',
-            types: [TraceType.EVENT_LOG, TraceType.CUJS],
+            types: [TraceType.SURFACE_FLINGER],
           },
           {
             name: 'Uncollected Trace',
             types: [TraceType.TRANSITION],
           },
         ],
-        collected: inputFiles.concat([eventLogFile]),
+        collected: [inputFiles[0]],
       }),
     );
     expect(
@@ -492,8 +511,9 @@ describe('Mediator', () => {
 
     resetSpyCalls();
     await mediator.onWinscopeEvent(new AppTraceViewRequest());
-    await checkLoadTraceViewEvents(uploadTracesComponent);
-    userNotifierChecker.expectNotified([new IncompleteFrameMapping(errorMsg)]);
+    await checkLoadTraceViewEvents(uploadTracesComponent, undefined, [
+      new IncompleteFrameMapping(errorMsg),
+    ]);
   });
 
   describe('timestamp received from remote tool', () => {
@@ -628,15 +648,41 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(
       new TabbedViewSwitched(viewerStub1.getViews()[0]),
     );
-    checkTracePositionUpdateEvents(
-      [viewerStub1, viewerOverlay, timelineComponent, crossToolProtocol],
-      [],
-      undefined,
-      undefined,
-      true,
+    userNotifierChecker.expectNone();
+    const tracePositionUpdate = makeExpectedTracePositionUpdate(undefined);
+    const activeTraceChanged = new ActiveTraceChanged(
+      viewerStub1.getViews()[0].traces[0],
+    );
+    expect(viewerStub0.onWinscopeEvent).toHaveBeenCalledOnceWith(
+      activeTraceChanged,
+    );
+    expect(viewerDump.onWinscopeEvent).toHaveBeenCalledOnceWith(
+      activeTraceChanged,
+    );
+
+    expect(viewerStub1.onWinscopeEvent).toHaveBeenCalledWith(
+      tracePositionUpdate,
     );
+    expect(viewerStub1.onWinscopeEvent).toHaveBeenCalledWith(
+      activeTraceChanged,
+    );
+
+    expect(viewerOverlay.onWinscopeEvent).toHaveBeenCalledWith(
+      tracePositionUpdate,
+    );
+    expect(viewerOverlay.onWinscopeEvent).toHaveBeenCalledWith(
+      activeTraceChanged,
+    );
+
     expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
-      new ActiveTraceChanged(viewerStub1.getViews()[0].traces[0]),
+      tracePositionUpdate,
+    );
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
+      activeTraceChanged,
+    );
+
+    expect(crossToolProtocol.onWinscopeEvent).toHaveBeenCalledOnceWith(
+      tracePositionUpdate,
     );
 
     // Position update -> update only visible viewers
@@ -655,12 +701,20 @@ describe('Mediator', () => {
     expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(event);
   });
 
-  it('notifies timeline of active trace change', async () => {
-    expect(timelineComponent.onWinscopeEvent).not.toHaveBeenCalled();
+  it('notifies timeline and viewers of active trace change', async () => {
+    await loadFiles();
+    await loadTraceView();
+    resetSpyCalls();
 
-    await mediator.onWinscopeEvent(new ActiveTraceChanged(traceWm));
+    const activeTraceChanged = new ActiveTraceChanged(traceWm);
+    await mediator.onWinscopeEvent(activeTraceChanged);
     expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(
-      new ActiveTraceChanged(traceWm),
+      activeTraceChanged,
+    );
+    viewers.forEach((viewer) =>
+      expect(viewer.onWinscopeEvent).toHaveBeenCalledOnceWith(
+        activeTraceChanged,
+      ),
     );
   });
 
@@ -697,11 +751,63 @@ describe('Mediator', () => {
     expect(viewerStub1.onWinscopeEvent).toHaveBeenCalledOnceWith(applyRequest);
   });
 
-  async function loadFiles(files = inputFiles) {
-    await mediator.onWinscopeEvent(new AppFilesUploaded(files));
+  it('initializes trace search', async () => {
+    const searchViewer = await loadPerfettoFilesAndReturnSearchViewer();
+    const spy = spyOn(
+      TraceSearchInitializer,
+      'createSearchViews',
+    ).and.returnValue(Promise.resolve(['test']));
+    const initializeRequest = new InitializeTraceSearchRequest();
+    await mediator.onWinscopeEvent(initializeRequest);
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
+      initializeRequest,
+    );
+    expect(spy).toHaveBeenCalledTimes(1);
+    const initializedEvent = new TraceSearchInitialized(['test']);
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
+      initializedEvent,
+    );
+    expect(searchViewer.onWinscopeEvent).toHaveBeenCalledWith(initializedEvent);
+  });
+
+  it('handles trace search request for successful queries', async () => {
+    const searchViewer = await loadPerfettoFilesAndReturnSearchViewer();
+    await requestSearch('select ts from surfaceflinger_layers_snapshot');
+    checkNewSearchTracePropagation(searchViewer, true);
+    await requestSearch('select id from surfaceflinger_layers_snapshot');
+    checkNewSearchTracePropagation(searchViewer, false);
+  });
+
+  it('handles trace search request for unsuccessful query', async () => {
+    const searchViewer = await loadPerfettoFilesAndReturnSearchViewer();
+    await requestSearch('select * from fake_table');
+    expect(searchViewer.onWinscopeEvent).toHaveBeenCalledWith(
+      new TraceSearchFailed(),
+    );
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
+      new TraceSearchCompleted(),
+    );
+  });
+
+  it('handles trace removal requests', async () => {
+    await loadPerfettoFilesAndReturnSearchViewer();
+    await requestSearch('select ts from surfaceflinger_layers_snapshot');
+    removeSearchTraceAndCheckPropagation(true);
+    await requestSearch('select id from surfaceflinger_layers_snapshot');
+    removeSearchTraceAndCheckPropagation(false);
+  });
+
+  async function loadFiles(
+    files = inputFiles,
+    viewersToReassignTraces = [viewerStub0, viewerStub1],
+  ) {
+    for (const file of files) {
+      await mediator.onWinscopeEvent(new AppFilesUploaded([file]));
+    }
     userNotifierChecker.expectNone();
-    reassignViewerStubTrace(viewerStub0);
-    reassignViewerStubTrace(viewerStub1);
+    viewersToReassignTraces.forEach((viewer) =>
+      reassignViewerStubTrace(viewer),
+    );
   }
 
   function reassignViewerStubTrace(viewerStub: ViewerStub) {
@@ -711,12 +817,12 @@ describe('Mediator', () => {
       .getTrace(viewerStubTraces[0].type) as Trace<object>;
   }
 
-  async function loadTraceView() {
+  async function loadTraceView(expectedViewers = viewers) {
     // Simulate "View traces" button click
     resetSpyCalls();
     await mediator.onWinscopeEvent(new AppTraceViewRequest());
 
-    await checkLoadTraceViewEvents(uploadTracesComponent);
+    await checkLoadTraceViewEvents(uploadTracesComponent, expectedViewers);
 
     // Simulate notification of TraceViewComponent about initially selected/focused tab
     resetSpyCalls();
@@ -731,19 +837,23 @@ describe('Mediator', () => {
     userNotifierChecker.expectNotified([]);
   }
 
-  async function checkLoadTraceViewEvents(progressListener: ProgressListener) {
+  async function checkLoadTraceViewEvents(
+    progressListener: ProgressListener,
+    expectedViewers = viewers,
+    notifications: UserWarning[] = [],
+  ) {
     expect(progressListener.onProgressUpdate).toHaveBeenCalled();
     expect(progressListener.onOperationFinished).toHaveBeenCalled();
     expect(timelineData.initialize).toHaveBeenCalledTimes(1);
     expect(appComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(
-      new ViewersLoaded([viewerStub0, viewerStub1, viewerOverlay, viewerDump]),
+      new ViewersLoaded(expectedViewers),
     );
 
     // Mediator triggers the viewers initialization
     // by sending them a "trace position update" event
     checkTracePositionUpdateEvents(
-      [viewerStub0, viewerStub1, viewerOverlay, viewerDump, timelineComponent],
-      [],
+      (expectedViewers as WinscopeEventListener[]).concat([timelineComponent]),
+      notifications,
     );
   }
 
@@ -752,7 +862,6 @@ describe('Mediator', () => {
     userNotifications: UserWarning[],
     position?: TracePosition,
     crossToolProtocolPosition = position,
-    multipleTimelineEvents = false,
   ) {
     userNotifierChecker.expectNotified(userNotifications);
     const event = makeExpectedTracePositionUpdate(position);
@@ -765,11 +874,7 @@ describe('Mediator', () => {
       if (isVisible) {
         const expected =
           listener === crossToolProtocol ? crossToolProtocolEvent : event;
-        if (multipleTimelineEvents && listener === timelineComponent) {
-          expect(listener.onWinscopeEvent).toHaveBeenCalledWith(expected);
-        } else {
-          expect(listener.onWinscopeEvent).toHaveBeenCalledOnceWith(expected);
-        }
+        expect(listener.onWinscopeEvent).toHaveBeenCalledOnceWith(expected);
       } else {
         expect(listener.onWinscopeEvent).not.toHaveBeenCalled();
       }
@@ -783,6 +888,63 @@ describe('Mediator', () => {
     userNotifierChecker.reset();
   }
 
+  async function loadPerfettoFilesAndReturnSearchViewer(): Promise<ViewerStub> {
+    await loadFiles([perfettoFile], [viewerStub0]);
+    const searchViewer = new ViewerStub(
+      'search',
+      undefined,
+      undefined,
+      ViewType.GLOBAL_SEARCH,
+    );
+    spyOn(searchViewer, 'onWinscopeEvent');
+    const expectedViewers = [viewerStub0, searchViewer];
+    createViewersSpy.and.returnValue(expectedViewers);
+    await loadTraceView(expectedViewers);
+    resetSpyCalls();
+    return searchViewer;
+  }
+
+  async function requestSearch(query: string) {
+    const event = new TraceSearchRequest(query);
+    await mediator.onWinscopeEvent(event);
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(event);
+  }
+
+  function checkNewSearchTracePropagation(
+    searchViewer: ViewerStub,
+    hasTimestamps: boolean,
+  ) {
+    const searchTraces = tracePipeline.getTraces().getTraces(TraceType.SEARCH);
+    const newTrace = searchTraces[searchTraces.length - 1];
+    const newTraceEvent = new TraceAddRequest(newTrace);
+    expect(searchViewer.onWinscopeEvent).toHaveBeenCalledWith(newTraceEvent);
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
+      new TraceSearchCompleted(),
+    );
+    expect(timelineData.hasTrace(newTrace)).toEqual(hasTimestamps);
+    const timelineComponentSpy = timelineComponent.onWinscopeEvent;
+    if (hasTimestamps) {
+      expect(timelineComponentSpy).toHaveBeenCalledWith(newTraceEvent);
+    } else {
+      expect(timelineComponentSpy).not.toHaveBeenCalledWith(newTraceEvent);
+    }
+  }
+
+  async function removeSearchTraceAndCheckPropagation(hasTimestamps: boolean) {
+    const searchTraces = tracePipeline.getTraces().getTraces(TraceType.SEARCH);
+    const newTrace = searchTraces[searchTraces.length - 1];
+    const removalRequest = new TraceRemoveRequest(newTrace);
+    await mediator.onWinscopeEvent(removalRequest);
+    expect(tracePipeline.getTraces().hasTrace(newTrace)).toBeFalse();
+    expect(timelineData.hasTrace(newTrace)).toBeFalse();
+    const timelineComponentSpy = timelineComponent.onWinscopeEvent;
+    if (hasTimestamps) {
+      expect(timelineComponentSpy).toHaveBeenCalledWith(removalRequest);
+    } else {
+      expect(timelineComponentSpy).not.toHaveBeenCalledWith(removalRequest);
+    }
+  }
+
   function makeExpectedTracePositionUpdate(
     tracePosition?: TracePosition,
   ): WinscopeEvent {
diff --git a/tools/winscope/src/app/timeline_data.ts b/tools/winscope/src/app/timeline_data.ts
index da9b82194..080cccfad 100644
--- a/tools/winscope/src/app/timeline_data.ts
+++ b/tools/winscope/src/app/timeline_data.ts
@@ -88,12 +88,11 @@ export class TimelineData {
 
     const tracesSortedByDisplayOrder = traces
       .mapTrace((trace) => trace)
-      .filter(
-        (trace) =>
-          TraceTypeUtils.isTraceTypeWithViewer(trace.type) &&
-          trace.type !== TraceType.SCREEN_RECORDING,
-      )
+      .filter((trace) => TraceTypeUtils.isTraceTypeWithViewer(trace.type))
       .sort((a, b) => {
+        // do not set screen recording as active unless it is the only trace
+        if (a.type === TraceType.SCREEN_RECORDING) return 1;
+        if (b.type === TraceType.SCREEN_RECORDING) return -1;
         return TraceTypeUtils.compareByDisplayOrder(a.type, b.type);
       });
     if (tracesSortedByDisplayOrder.length > 0) {
diff --git a/tools/winscope/src/app/timeline_data_test.ts b/tools/winscope/src/app/timeline_data_test.ts
index a6a0a7de2..276abfeac 100644
--- a/tools/winscope/src/app/timeline_data_test.ts
+++ b/tools/winscope/src/app/timeline_data_test.ts
@@ -23,6 +23,7 @@ import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {UnitTestUtils} from 'test/unit/utils';
 import {Traces} from 'trace/traces';
 import {TracePosition} from 'trace/trace_position';
 import {TraceType} from 'trace/trace_type';
@@ -42,12 +43,14 @@ describe('TimelineData', () => {
     .setTimestamps(TraceType.PROTO_LOG, [timestamp9])
     .setTimestamps(TraceType.EVENT_LOG, [timestamp9])
     .setTimestamps(TraceType.SURFACE_FLINGER, [timestamp10])
+    .setTimestamps(TraceType.SCREEN_RECORDING, [timestamp5])
     .setTimestamps(TraceType.WINDOW_MANAGER, [timestamp11])
     .setTimestamps(TraceType.TRANSACTIONS, [])
     .build();
 
   const traceSf = assertDefined(traces.getTrace(TraceType.SURFACE_FLINGER));
   const traceWm = assertDefined(traces.getTrace(TraceType.WINDOW_MANAGER));
+  const traceSr = assertDefined(traces.getTrace(TraceType.SCREEN_RECORDING));
 
   const position10 = TracePosition.fromTraceEntry(
     assertDefined(traces.getTrace(TraceType.SURFACE_FLINGER)).getEntry(0),
@@ -130,15 +133,27 @@ describe('TimelineData', () => {
     expect(timelineData.getFullTimeRange().from).toEqual(timestamp9);
   });
 
-  it('uses first entry of first active trace by default', () => {
+  it('uses first entry of first active trace by default, excluding screen recording', () => {
     timelineData.initialize(
       traces,
       undefined,
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
     );
+    expect(timelineData.getActiveTrace()).toEqual(traceSf);
     expect(timelineData.getCurrentPosition()).toEqual(position10);
   });
 
+  it('defaults active trace to screen recording if it is the only trace', () => {
+    const tracesOnlySr = new Traces();
+    tracesOnlySr.addTrace(traceSr);
+    timelineData.initialize(
+      tracesOnlySr,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    expect(timelineData.getActiveTrace()).toEqual(traceSr);
+  });
+
   it('uses explicit position if set and valid within time range', () => {
     timelineData.initialize(
       traces,
@@ -169,9 +184,7 @@ describe('TimelineData', () => {
 
     timelineData.setPosition(TracePosition.fromTimestamp(timestamp0));
     expect(timelineData.getCurrentPosition()).toEqual(
-      TracePosition.fromTraceEntry(
-        assertDefined(traces.getTrace(TraceType.PROTO_LOG)).getEntry(0),
-      ),
+      TracePosition.fromTraceEntry(traceSr.getEntry(0)),
     );
 
     timelineData.setPosition(position1000);
@@ -212,10 +225,7 @@ describe('TimelineData', () => {
     expect(success).toBeFalse();
 
     success = timelineData.trySetActiveTrace(
-      new TraceBuilder<{}>()
-        .setType(TraceType.SURFACE_FLINGER)
-        .setEntries([])
-        .build(),
+      UnitTestUtils.makeEmptyTrace(TraceType.SURFACE_FLINGER),
     );
     expect(timelineData.getActiveTrace()).toEqual(traceWm);
     expect(success).toBeFalse();
diff --git a/tools/winscope/src/app/trace_file_filter.ts b/tools/winscope/src/app/trace_file_filter.ts
index 4770c4273..585aed3a8 100644
--- a/tools/winscope/src/app/trace_file_filter.ts
+++ b/tools/winscope/src/app/trace_file_filter.ts
@@ -20,9 +20,11 @@ import {TimezoneInfo} from 'common/time';
 import {UserNotifier} from 'common/user_notifier';
 import {TraceOverridden} from 'messaging/user_warnings';
 import {TraceFile} from 'trace/trace_file';
+import {TraceMetadata} from 'trace/trace_metadata';
 
 export interface FilterResult {
   legacy: TraceFile[];
+  metadata: TraceMetadata;
   perfetto?: TraceFile;
   timezoneInfo?: TimezoneInfo;
 }
@@ -49,12 +51,17 @@ export class TraceFileFilter {
     );
 
     const perfettoFiles = files.filter((file) => this.isPerfettoFile(file));
-    const legacyFiles = files.filter((file) => !this.isPerfettoFile(file));
+    const {mFiles, metadata} = await this.extractAndAnalyzeMetadata(files);
+    const legacyFiles = files.filter(
+      (file) => !this.isPerfettoFile(file) && !mFiles.includes(file),
+    );
+
     if (!(await this.isBugreport(bugreportMainEntry, files))) {
       const perfettoFile = this.pickLargestFile(perfettoFiles);
       return {
         perfetto: perfettoFile,
         legacy: legacyFiles,
+        metadata,
       };
     }
 
@@ -67,6 +74,7 @@ export class TraceFileFilter {
       assertDefined(bugreportMainEntry),
       perfettoFiles,
       legacyFiles,
+      metadata,
       timezoneInfo,
     );
   }
@@ -131,6 +139,7 @@ export class TraceFileFilter {
     bugreportMainEntry: TraceFile,
     perfettoFiles: TraceFile[],
     legacyFiles: TraceFile[],
+    metadata: TraceMetadata,
     timezoneInfo?: TimezoneInfo,
   ): Promise<FilterResult> {
     const isFileAllowlisted = (file: TraceFile) => {
@@ -169,7 +178,12 @@ export class TraceFileFilter {
     const perfettoFile = perfettoFiles.find(
       (file) => file.file.name === TraceFileFilter.BUGREPORT_SYSTRACE_PATH,
     );
-    return {perfetto: perfettoFile, legacy: unzippedLegacyFiles, timezoneInfo};
+    return {
+      perfetto: perfettoFile,
+      legacy: unzippedLegacyFiles,
+      metadata,
+      timezoneInfo,
+    };
   }
 
   private isPerfettoFile(file: TraceFile): boolean {
@@ -181,6 +195,36 @@ export class TraceFileFilter {
     });
   }
 
+  private async extractAndAnalyzeMetadata(
+    files: TraceFile[],
+  ): Promise<{mFiles: TraceFile[]; metadata: TraceMetadata}> {
+    const mFiles = [];
+    const metadata: TraceMetadata = {};
+    for (const file of files) {
+      const buffer = new Uint8Array(await file.file.arrayBuffer());
+      const text = new TextDecoder().decode(buffer);
+      try {
+        const data = JSON.parse(text);
+        if (
+          data.realToElapsedTimeOffsetNanos !== undefined &&
+          data.elapsedRealTimeNanos !== undefined
+        ) {
+          metadata.screenRecordingOffsets = {
+            realToElapsedTimeOffsetNanos: BigInt(
+              data.realToElapsedTimeOffsetNanos,
+            ),
+            elapsedRealTimeNanos: BigInt(data.elapsedRealTimeNanos),
+          };
+          mFiles.push(file);
+          break;
+        }
+      } catch (e) {
+        // swallow - looking for metadata json
+      }
+    }
+    return {metadata, mFiles};
+  }
+
   private pickLargestFile(files: TraceFile[]): TraceFile | undefined {
     if (files.length === 0) {
       return undefined;
diff --git a/tools/winscope/src/app/trace_file_filter_test.ts b/tools/winscope/src/app/trace_file_filter_test.ts
index 5b157c711..0d07319a3 100644
--- a/tools/winscope/src/app/trace_file_filter_test.ts
+++ b/tools/winscope/src/app/trace_file_filter_test.ts
@@ -210,6 +210,18 @@ describe('TraceFileFilter', () => {
       ]);
     });
 
+    it('extracts screen recording metadata', async () => {
+      const metadataJson = await makeMetadataJsonFile();
+      const screenRecording = makeTraceFile('screen_recording.mp4');
+      const result = await filter.filter([screenRecording, metadataJson]);
+      expect(result.legacy).toEqual([screenRecording]);
+      expect(result.metadata.screenRecordingOffsets).toEqual({
+        elapsedRealTimeNanos: 0n,
+        realToElapsedTimeOffsetNanos: 1732721670187419904n,
+      });
+      userNotifierChecker.expectNone();
+    });
+
     async function checkPerfettoFilePickedWithoutErrors(
       perfettoFile: TraceFile,
     ) {
@@ -253,4 +265,11 @@ describe('TraceFileFilter', () => {
     );
     return new TraceFile(file, bugreportArchive);
   }
+
+  async function makeMetadataJsonFile(): Promise<TraceFile> {
+    const file = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata.json',
+    );
+    return new TraceFile(file, bugreportArchive);
+  }
 });
diff --git a/tools/winscope/src/app/trace_pipeline.ts b/tools/winscope/src/app/trace_pipeline.ts
index 4aaae5b17..3480ae686 100644
--- a/tools/winscope/src/app/trace_pipeline.ts
+++ b/tools/winscope/src/app/trace_pipeline.ts
@@ -27,12 +27,14 @@ import {CorruptedArchive, NoValidFiles} from 'messaging/user_warnings';
 import {FileAndParsers} from 'parsers/file_and_parsers';
 import {ParserFactory as LegacyParserFactory} from 'parsers/legacy/parser_factory';
 import {ParserFactory as PerfettoParserFactory} from 'parsers/perfetto/parser_factory';
+import {ParserSearch} from 'parsers/search/parser_search';
 import {TracesParserFactory} from 'parsers/traces/traces_parser_factory';
 import {FrameMapper} from 'trace/frame_mapper';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceFile} from 'trace/trace_file';
 import {TraceEntryTypeMap, TraceType, TraceTypeUtils} from 'trace/trace_type';
+import {QueryResult} from 'trace_processor/query_result';
 import {FilesSource} from './files_source';
 import {LoadedParsers} from './loaded_parsers';
 import {TraceFileFilter} from './trace_file_filter';
@@ -174,6 +176,20 @@ export class TracePipeline {
     return (await screenRecording.getEntry(0).getValue()).videoData;
   }
 
+  async tryCreateSearchTrace(
+    query: string,
+  ): Promise<Trace<QueryResult> | undefined> {
+    try {
+      const parser = new ParserSearch(query, this.timestampConverter);
+      await parser.parse();
+      const trace = Trace.fromParser(parser);
+      this.traces.addTrace(trace);
+      return trace;
+    } catch (e) {
+      return undefined;
+    }
+  }
+
   clear() {
     this.loadedParsers.clear();
     this.traces = new Traces();
@@ -200,6 +216,7 @@ export class TracePipeline {
     const legacyParsers = await new LegacyParserFactory().createParsers(
       filterResult.legacy,
       this.timestampConverter,
+      filterResult.metadata,
       progressListener,
     );
 
@@ -284,6 +301,7 @@ export class TracePipeline {
 
     progressListener?.onProgressUpdate(progressMessage, 0);
 
+    const currArchive: UnzippedArchive = [];
     for (let i = 0; i < files.length; i++) {
       let file = files[i];
 
@@ -309,11 +327,12 @@ export class TracePipeline {
           UserNotifier.add(new CorruptedArchive(file));
         }
       } else {
-        unzippedArchives.push([new TraceFile(file, undefined)]);
-        onSubProgressUpdate(100);
+        currArchive.push(new TraceFile(file, undefined));
       }
     }
-
+    if (currArchive.length > 0) {
+      unzippedArchives.push(currArchive);
+    }
     progressListener?.onProgressUpdate(progressMessage, 100);
 
     return unzippedArchives;
diff --git a/tools/winscope/src/app/trace_pipeline_test.ts b/tools/winscope/src/app/trace_pipeline_test.ts
index 77b3cef2e..77df387f9 100644
--- a/tools/winscope/src/app/trace_pipeline_test.ts
+++ b/tools/winscope/src/app/trace_pipeline_test.ts
@@ -448,16 +448,37 @@ describe('TracePipeline', () => {
   });
 
   it('can filter traces without visualization', async () => {
-    await loadFiles([validSfFile, shellTransitionFile]);
-    await expectLoadResult(2, []);
+    await loadFiles([shellTransitionFile]);
+    await expectLoadResult(1, []);
 
     tracePipeline.filterTracesWithoutVisualization();
-    expect(tracePipeline.getTraces().getSize()).toEqual(1);
+    expect(tracePipeline.getTraces().getSize()).toEqual(0);
     expect(
       tracePipeline.getTraces().getTrace(TraceType.SHELL_TRANSITION),
     ).toBeUndefined();
   });
 
+  it('tries to create search trace', async () => {
+    const perfettoFile = await UnitTestUtils.getFixtureFile(
+      'traces/perfetto/layers_trace.perfetto-trace',
+    );
+    await loadFiles([perfettoFile]);
+    const validQuery = 'select ts from surfaceflinger_layers_snapshot';
+    expect(await tracePipeline.tryCreateSearchTrace(validQuery)).toBeDefined();
+    expect(await tracePipeline.tryCreateSearchTrace('fail')).toBeUndefined();
+  });
+
+  it('creates screen recording using metadata', async () => {
+    const screenRecording = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4',
+    );
+    const metadata = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata.json',
+    );
+    await loadFiles([screenRecording, metadata]);
+    await expectLoadResult(1, []);
+  });
+
   async function loadFiles(
     files: File[],
     source: FilesSource = FilesSource.TEST,
diff --git a/tools/winscope/src/app/trace_search/abstract_search_view_factory.ts b/tools/winscope/src/app/trace_search/abstract_search_view_factory.ts
new file mode 100644
index 000000000..b0c3cf36a
--- /dev/null
+++ b/tools/winscope/src/app/trace_search/abstract_search_view_factory.ts
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TraceType} from 'trace/trace_type';
+import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
+
+export abstract class AbstractSearchViewFactory {
+  abstract readonly traceType: TraceType;
+
+  constructor(protected traceProcessor: WasmEngineProxy) {}
+
+  protected async createSqlTableWithDefaults(
+    tableName: string,
+  ): Promise<string> {
+    const newTableName = `${tableName}_with_defaults`;
+    const sql = `
+      CREATE PERFETTO TABLE ${newTableName}(
+        id INT,
+        base64_proto_id INT,
+        flat_key STRING,
+        key STRING,
+        int_value LONG,
+        string_value STRING,
+        real_value DOUBLE,
+        display_value STRING
+      ) AS
+      SELECT
+      id,
+      base64_proto_id,
+      flat_key,
+      key,
+      int_value,
+      string_value,
+      real_value,
+      CASE
+        WHEN int_value IS NOT NULL THEN cast_string!(int_value)
+        WHEN string_value IS NOT NULL THEN string_value
+        WHEN real_value IS NOT NULL THEN cast_string!(real_value)
+        ELSE NULL END
+      AS display_value
+      FROM __intrinsic_winscope_proto_to_args_with_defaults('${tableName}');
+    `;
+    await this.traceProcessor.query(sql);
+    return newTableName;
+  }
+
+  abstract createSearchViews(): Promise<string[]>;
+}
diff --git a/tools/winscope/src/app/trace_search/search_view_factory_sf.ts b/tools/winscope/src/app/trace_search/search_view_factory_sf.ts
new file mode 100644
index 000000000..6b8c65261
--- /dev/null
+++ b/tools/winscope/src/app/trace_search/search_view_factory_sf.ts
@@ -0,0 +1,134 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TraceType} from 'trace/trace_type';
+import {AbstractSearchViewFactory} from './abstract_search_view_factory';
+
+export class SearchViewFactorySf extends AbstractSearchViewFactory {
+  override readonly traceType = TraceType.SURFACE_FLINGER;
+
+  override async createSearchViews(): Promise<string[]> {
+    const layerArgsTable = await this.createSqlTableWithDefaults(
+      'surfaceflinger_layer',
+    );
+    const snapshotArgsTable = await this.createSqlTableWithDefaults(
+      'surfaceflinger_layers_snapshot',
+    );
+
+    const sqlCreateTableSfStateChanges = `
+            CREATE PERFETTO TABLE sf_state_changes AS
+              SELECT
+                STATE.id as state_id,
+                (SELECT X.id
+                  FROM surfaceflinger_layers_snapshot X
+                WHERE X.ts < STATE.ts
+                ORDER BY X.ts DESC
+                LIMIT 1
+                ) as previous_state_id
+              FROM surfaceflinger_layers_snapshot STATE;
+          `;
+    await this.traceProcessor.query(sqlCreateTableSfStateChanges);
+
+    const sqlCreateTableSfLayerIdentifier = `
+            CREATE PERFETTO TABLE sf_layer_identifier AS
+              SELECT
+                LAYER.snapshot_id as state_id,
+                LAYER_ID.int_value as layer_id,
+                PARENT_PROPERTY.int_value as parent_id,
+                NAME.string_value as layer_name,
+                LAYER.base64_proto_id
+              FROM surfaceflinger_layer LAYER
+              INNER JOIN ${layerArgsTable} LAYER_ID ON LAYER_ID.base64_proto_id = LAYER.base64_proto_id AND LAYER_ID.key = 'id'
+              INNER JOIN ${layerArgsTable} PARENT_PROPERTY ON PARENT_PROPERTY.base64_proto_id = LAYER.base64_proto_id AND PARENT_PROPERTY.key = 'parent'
+              INNER JOIN ${layerArgsTable} NAME ON NAME.base64_proto_id = LAYER.base64_proto_id AND NAME.key = 'name';
+          `;
+    await this.traceProcessor.query(sqlCreateTableSfLayerIdentifier);
+
+    const sqlCreateViewSfLayerWithProperties = `
+            CREATE PERFETTO VIEW sf_layer_with_properties AS
+              SELECT
+                STATE.id as state_id,
+                STATE.ts,
+                LAYER.layer_id,
+                LAYER.parent_id,
+                LAYER.layer_name,
+                PROPERTY.key as property,
+                PROPERTY.flat_key as flat_property,
+                PROPERTY.display_value as value
+              FROM surfaceflinger_layers_snapshot STATE
+              INNER JOIN sf_layer_identifier LAYER ON LAYER.state_id = STATE.id
+              INNER JOIN ${layerArgsTable} PROPERTY ON PROPERTY.base64_proto_id = LAYER.base64_proto_id;
+          `;
+    await this.traceProcessor.query(sqlCreateViewSfLayerWithProperties);
+
+    const layerSearchView = 'sf_layer_search';
+    const sqlCreateViewSfLayerSearch = `
+            CREATE PERFETTO VIEW ${layerSearchView}(
+              state_id INT,
+              ts INT,
+              layer_id INT,
+              parent_id INT,
+              layer_name STRING,
+              property STRING,
+              flat_property STRING,
+              value STRING,
+              previous_value STRING
+            ) AS
+            SELECT
+              CURRENT.state_id,
+              CURRENT.ts,
+              CURRENT.layer_id,
+              CURRENT.parent_id,
+              CURRENT.layer_name,
+              CURRENT.property,
+              CURRENT.flat_property,
+              CURRENT.value,
+              PREVIOUS.value as previous_value
+            FROM sf_state_changes CHANGE
+            INNER JOIN sf_layer_with_properties CURRENT ON CURRENT.state_id = CHANGE.state_id
+            INNER JOIN sf_layer_with_properties PREVIOUS ON PREVIOUS.state_id = CHANGE.previous_state_id AND PREVIOUS.layer_id = CURRENT.layer_id AND PREVIOUS.property = CURRENT.property;
+          `;
+    await this.traceProcessor.query(sqlCreateViewSfLayerSearch);
+
+    const sqlCreateViewSfEntry = `
+            CREATE PERFETTO VIEW sf_entry AS
+              SELECT
+                STATE.id as state_id,
+                STATE.ts,
+                PROPERTY.key as property,
+                PROPERTY.flat_key as flat_property,
+                PROPERTY.display_value as value
+              FROM surfaceflinger_layers_snapshot STATE
+              INNER JOIN ${snapshotArgsTable} PROPERTY ON PROPERTY.base64_proto_id = STATE.base64_proto_id;
+          `;
+    await this.traceProcessor.query(sqlCreateViewSfEntry);
+
+    const entrySearchView = 'sf_entry_search';
+    const sqlCreateViewSfEntrySearch = `
+            CREATE PERFETTO VIEW ${entrySearchView} AS
+              SELECT
+                STATE.*,
+                PREVIOUS.value as previous_value
+              FROM sf_entry STATE
+              INNER JOIN sf_state_changes STATE_CHANGES ON STATE_CHANGES.state_id = STATE.state_id
+              LEFT JOIN sf_entry PREVIOUS ON PREVIOUS.state_id = STATE_CHANGES.previous_state_id
+                                                     AND PREVIOUS.property = STATE.property;
+          `;
+    await this.traceProcessor.query(sqlCreateViewSfEntrySearch);
+
+    return [layerSearchView, entrySearchView];
+  }
+}
diff --git a/tools/winscope/src/app/trace_search/trace_search_initializer.ts b/tools/winscope/src/app/trace_search/trace_search_initializer.ts
new file mode 100644
index 000000000..f05321d8b
--- /dev/null
+++ b/tools/winscope/src/app/trace_search/trace_search_initializer.ts
@@ -0,0 +1,37 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Traces} from 'trace/traces';
+import {TraceProcessorFactory} from 'trace_processor/trace_processor_factory';
+import {SearchViewFactorySf} from './search_view_factory_sf';
+
+export class TraceSearchInitializer {
+  private static readonly FACTORIES = [SearchViewFactorySf];
+
+  static async createSearchViews(traces: Traces): Promise<string[]> {
+    const traceProcessor = await TraceProcessorFactory.getSingleInstance();
+
+    const searchViews = [];
+    for (const FactoryType of TraceSearchInitializer.FACTORIES) {
+      const factory = new FactoryType(traceProcessor);
+      if (traces.getTrace(factory.traceType)?.canSearch()) {
+        const views = await factory.createSearchViews();
+        searchViews.push(...views);
+      }
+    }
+    return searchViews;
+  }
+}
diff --git a/tools/winscope/src/app/trace_search/trace_search_initializer_test.ts b/tools/winscope/src/app/trace_search/trace_search_initializer_test.ts
new file mode 100644
index 000000000..e56242e5c
--- /dev/null
+++ b/tools/winscope/src/app/trace_search/trace_search_initializer_test.ts
@@ -0,0 +1,62 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {TraceSearchInitializer} from './trace_search_initializer';
+
+describe('TraceSearchInitializer', () => {
+  let traces: Traces;
+
+  beforeEach(() => {
+    traces = new Traces();
+  });
+
+  it('robust to no searchable traces', async () => {
+    const views = await TraceSearchInitializer.createSearchViews(traces);
+    expect(views).toEqual([]);
+  });
+
+  it('initializes surface flinger', async () => {
+    const parser = await UnitTestUtils.getPerfettoParser(
+      TraceType.SURFACE_FLINGER,
+      'traces/perfetto/layers_trace.perfetto-trace',
+    );
+    const trace = Trace.fromParser(parser);
+    traces.addTrace(trace);
+    const views = await TraceSearchInitializer.createSearchViews(traces);
+    expect(views).toEqual(['sf_layer_search', 'sf_entry_search']);
+    const queryResult = await UnitTestUtils.runQueryAndGetResult(`
+      SELECT * FROM sf_layer_search
+        WHERE layer_name LIKE 'Task%'
+        AND property='flags'
+        AND value!=previous_value
+    `);
+    expect(queryResult.numRows()).toEqual(2);
+
+    const queryResultEntry = await UnitTestUtils.runQueryAndGetResult(`
+      SELECT * FROM sf_entry_search
+        WHERE property LIKE 'displays[1]%'
+        AND (
+          flat_property='displays.layer_stack'
+          OR flat_property='displays.is_virtual'
+        )
+    `);
+    expect(queryResultEntry.numRows()).toEqual(40);
+  });
+});
diff --git a/tools/winscope/src/common/dom_utils.ts b/tools/winscope/src/common/dom_utils.ts
new file mode 100644
index 000000000..472027c5a
--- /dev/null
+++ b/tools/winscope/src/common/dom_utils.ts
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export class DOMUtils {
+  static isElementVisible(element: HTMLElement) {
+    const rect = element.getBoundingClientRect();
+    return rect.height > 0 && rect.width > 0;
+  }
+}
diff --git a/tools/winscope/src/common/filter_flag.ts b/tools/winscope/src/common/filter_flag.ts
index c748eb907..cd474c825 100644
--- a/tools/winscope/src/common/filter_flag.ts
+++ b/tools/winscope/src/common/filter_flag.ts
@@ -14,65 +14,8 @@
  * limitations under the License.
  */
 
-import {StringUtils} from './string_utils';
-
 export enum FilterFlag {
   MATCH_CASE,
   MATCH_WORD,
   USE_REGEX,
 }
-
-export type StringFilterPredicate = (value: string) => boolean;
-
-export function makeFilterPredicate(
-  filterString: string,
-  flags: FilterFlag[],
-): StringFilterPredicate {
-  const matchCase = flags.includes(FilterFlag.MATCH_CASE);
-  const matchWord = flags.includes(FilterFlag.MATCH_WORD);
-  const useRegex = flags.includes(FilterFlag.USE_REGEX);
-
-  let filter: StringFilterPredicate;
-  if (useRegex) {
-    const regexFlags = useRegex && !matchCase ? 'i' : '';
-    const regexString = matchWord
-      ? '\\b(?:' + filterString + ')\\b'
-      : filterString;
-    try {
-      const regex = new RegExp(regexString, regexFlags);
-      filter = (entryString: string) => {
-        if (filterString.length === 0) return true;
-        return regex.test(entryString);
-      };
-    } catch (e) {
-      filter = (entryString: string) => false;
-    }
-  } else {
-    const testString = matchCase ? filterString : filterString.toLowerCase();
-    filter = (entryString: string) => {
-      if (filterString.length === 0) return true;
-
-      let entrySubstring = matchCase ? entryString : entryString.toLowerCase();
-      let testStringIndex = entrySubstring.indexOf(testString);
-
-      while (testStringIndex !== -1) {
-        if (!matchWord) return true;
-
-        const nextChar = entrySubstring.at(testStringIndex + testString.length);
-        if (
-          nextChar === undefined ||
-          !(StringUtils.isAlpha(nextChar) || StringUtils.isDigit(nextChar))
-        ) {
-          return true;
-        }
-
-        entrySubstring = entrySubstring.slice(
-          testStringIndex + testString.length,
-        );
-        testStringIndex = entrySubstring.indexOf(testString);
-      }
-      return false;
-    };
-  }
-  return filter;
-}
diff --git a/tools/winscope/src/common/intDefMapping.json b/tools/winscope/src/common/intDefMapping.json
index 82269068b..484de3b97 100644
--- a/tools/winscope/src/common/intDefMapping.json
+++ b/tools/winscope/src/common/intDefMapping.json
@@ -412,6 +412,22 @@
       "3": "ELAPSED_REALTIME"
     }
   },
+  "android.app.AppCompatTaskInfo.TopActivityFlag": {
+    "flag": true,
+    "values": {
+      "0": "FLAG_UNDEFINED",
+      "1": "FLAG_LETTERBOX_EDU_ENABLED",
+      "2": "FLAG_ELIGIBLE_FOR_LETTERBOX_EDU",
+      "4": "FLAG_LETTERBOXED",
+      "8": "FLAG_IN_SIZE_COMPAT",
+      "16": "FLAG_LETTERBOX_DOUBLE_TAP_ENABLED",
+      "32": "FLAG_IS_FROM_LETTERBOX_DOUBLE_TAP",
+      "64": "FLAG_ELIGIBLE_FOR_USER_ASPECT_RATIO_BUTTON",
+      "128": "FLAG_FULLSCREEN_OVERRIDE_SYSTEM",
+      "256": "FLAG_FULLSCREEN_OVERRIDE_USER",
+      "512": "FLAG_HAS_MIN_ASPECT_RATIO_OVERRIDE"
+    }
+  },
   "android.app.AppOpsManager.AttributionFlags": {
     "flag": true,
     "values": {
@@ -483,6 +499,12 @@
       "4": "HISTORY_FLAG_GET_ATTRIBUTION_CHAINS"
     }
   },
+  "android.app.AppOpsManager.OpNotedCallbackFlags": {
+    "flag": true,
+    "values": {
+      "1": "OP_NOTED_CALLBACK_FLAG_IGNORE_ASYNC"
+    }
+  },
   "android.app.AppOpsManager.SamplingStrategy": {
     "flag": false,
     "values": {
@@ -581,6 +603,16 @@
       "4": "LAUNCH_MODE_SINGLE_INSTANCE_PER_TASK"
     }
   },
+  "android.app.ApplicationStartInfo.StartComponent": {
+    "flag": false,
+    "values": {
+      "1": "START_COMPONENT_ACTIVITY",
+      "2": "START_COMPONENT_BROADCAST",
+      "3": "START_COMPONENT_CONTENT_PROVIDER",
+      "4": "START_COMPONENT_SERVICE",
+      "5": "START_COMPONENT_OTHER"
+    }
+  },
   "android.app.ApplicationStartInfo.StartReason": {
     "flag": false,
     "values": {
@@ -664,21 +696,14 @@
       "32": "FLAG_INTERACTIVE"
     }
   },
-  "android.app.CameraCompatTaskInfo.CameraCompatControlState": {
-    "flag": false,
-    "values": {
-      "0": "CAMERA_COMPAT_CONTROL_HIDDEN",
-      "1": "CAMERA_COMPAT_CONTROL_TREATMENT_SUGGESTED",
-      "2": "CAMERA_COMPAT_CONTROL_TREATMENT_APPLIED",
-      "3": "CAMERA_COMPAT_CONTROL_DISMISSED"
-    }
-  },
   "android.app.CameraCompatTaskInfo.FreeformCameraCompatMode": {
     "flag": false,
     "values": {
       "0": "CAMERA_COMPAT_FREEFORM_NONE",
-      "1": "CAMERA_COMPAT_FREEFORM_PORTRAIT",
-      "2": "CAMERA_COMPAT_FREEFORM_LANDSCAPE"
+      "1": "CAMERA_COMPAT_FREEFORM_PORTRAIT_DEVICE_IN_LANDSCAPE",
+      "2": "CAMERA_COMPAT_FREEFORM_LANDSCAPE_DEVICE_IN_LANDSCAPE",
+      "3": "CAMERA_COMPAT_FREEFORM_PORTRAIT_DEVICE_IN_PORTRAIT",
+      "4": "CAMERA_COMPAT_FREEFORM_LANDSCAPE_DEVICE_IN_PORTRAIT"
     }
   },
   "android.app.ContextImpl.ContextType": {
@@ -1231,10 +1256,10 @@
     "flag": false,
     "values": {
       "-1": "ORIENTATION_UNKNOWN",
-      "0": "PORTRAIT",
-      "1": "LANDSCAPE",
-      "2": "SQUARE_PORTRAIT",
-      "3": "SQUARE_LANDSCAPE"
+      "0": "ORIENTATION_PORTRAIT",
+      "1": "ORIENTATION_LANDSCAPE",
+      "2": "ORIENTATION_SQUARE_PORTRAIT",
+      "3": "ORIENTATION_SQUARE_LANDSCAPE"
     }
   },
   "android.app.WallpaperManager.SetWallpaperFlags": {
@@ -1321,6 +1346,22 @@
       "16": "ID_TYPE_INDIVIDUAL_ATTESTATION"
     }
   },
+  "android.app.admin.DevicePolicyManager.AutoTimePolicy": {
+    "flag": false,
+    "values": {
+      "0": "AUTO_TIME_NOT_CONTROLLED_BY_POLICY",
+      "1": "AUTO_TIME_DISABLED",
+      "2": "AUTO_TIME_ENABLED"
+    }
+  },
+  "android.app.admin.DevicePolicyManager.AutoTimeZonePolicy": {
+    "flag": false,
+    "values": {
+      "0": "AUTO_TIME_ZONE_NOT_CONTROLLED_BY_POLICY",
+      "1": "AUTO_TIME_ZONE_DISABLED",
+      "2": "AUTO_TIME_ZONE_ENABLED"
+    }
+  },
   "android.app.admin.DevicePolicyManager.ContentProtectionPolicy": {
     "flag": false,
     "values": {
@@ -1672,7 +1713,9 @@
       "210041": "TAG_PACKAGE_INSTALLED",
       "210042": "TAG_PACKAGE_UPDATED",
       "210043": "TAG_PACKAGE_UNINSTALLED",
-      "210044": "TAG_BACKUP_SERVICE_TOGGLED"
+      "210044": "TAG_BACKUP_SERVICE_TOGGLED",
+      "210045": "TAG_NFC_ENABLED",
+      "210046": "TAG_NFC_DISABLED"
     }
   },
   "android.app.admin.SystemUpdateInfo.SecurityPatchState": {
@@ -1771,6 +1814,35 @@
       "5": "STATUS_ACCESS_DENIED"
     }
   },
+  "android.app.appfunctions.AppFunctionException.ErrorCategory": {
+    "flag": false,
+    "values": {
+      "0": "ERROR_CATEGORY_UNKNOWN",
+      "1": "ERROR_CATEGORY_REQUEST_ERROR",
+      "3": "ERROR_CATEGORY_APP",
+      "2": "ERROR_CATEGORY_SYSTEM"
+    }
+  },
+  "android.app.appfunctions.AppFunctionException.ErrorCode": {
+    "flag": false,
+    "values": {
+      "1000": "ERROR_DENIED",
+      "3000": "ERROR_APP_UNKNOWN_ERROR",
+      "1003": "ERROR_FUNCTION_NOT_FOUND",
+      "2000": "ERROR_SYSTEM_ERROR",
+      "1001": "ERROR_INVALID_ARGUMENT",
+      "1002": "ERROR_DISABLED",
+      "2001": "ERROR_CANCELLED"
+    }
+  },
+  "android.app.appfunctions.AppFunctionManager.EnabledState": {
+    "flag": false,
+    "values": {
+      "0": "APP_FUNCTION_STATE_DEFAULT",
+      "1": "APP_FUNCTION_STATE_ENABLED",
+      "2": "APP_FUNCTION_STATE_DISABLED"
+    }
+  },
   "android.app.backup.BackupAgent.BackupTransportFlags": {
     "flag": true,
     "values": {
@@ -1882,7 +1954,8 @@
       "12": "STOP_REASON_APP_STANDBY",
       "13": "STOP_REASON_USER",
       "14": "STOP_REASON_SYSTEM_PROCESSING",
-      "15": "STOP_REASON_ESTIMATED_APP_LAUNCH_TIME_CHANGED"
+      "15": "STOP_REASON_ESTIMATED_APP_LAUNCH_TIME_CHANGED",
+      "16": "STOP_REASON_TIMEOUT_ABANDONED"
     }
   },
   "android.app.job.JobScheduler.PendingJobReason": {
@@ -1905,7 +1978,8 @@
       "-2": "PENDING_JOB_REASON_INVALID_JOB_ID",
       "13": "PENDING_JOB_REASON_JOB_SCHEDULER_OPTIMIZATION",
       "14": "PENDING_JOB_REASON_QUOTA",
-      "15": "PENDING_JOB_REASON_USER"
+      "15": "PENDING_JOB_REASON_USER",
+      "16": "PENDING_JOB_REASON_CONSTRAINT_DEADLINE"
     }
   },
   "android.app.job.JobScheduler.Result": {
@@ -2256,7 +2330,8 @@
       "5": "STATUS_ACCESS_DENIED",
       "6": "STATUS_UNSUPPORTED_OPERATION",
       "7": "STATUS_CHANNEL_ERROR",
-      "8": "STATUS_UNSUPPORTED_DATA_TYPE"
+      "8": "STATUS_UNSUPPORTED_DATA_TYPE",
+      "9": "STATUS_MAX_CONCURRENT_CONNECTIONS_EXCEEDED"
     }
   },
   "android.appwidget.AppWidgetProviderInfo.CategoryFlags": {
@@ -2264,7 +2339,8 @@
     "values": {
       "1": "WIDGET_CATEGORY_HOME_SCREEN",
       "2": "WIDGET_CATEGORY_KEYGUARD",
-      "4": "WIDGET_CATEGORY_SEARCHBOX"
+      "4": "WIDGET_CATEGORY_SEARCHBOX",
+      "8": "WIDGET_CATEGORY_NOT_KEYGUARD"
     }
   },
   "android.appwidget.AppWidgetProviderInfo.FeatureFlags": {
@@ -2339,13 +2415,20 @@
       "1": "DEVICE_POLICY_CUSTOM"
     }
   },
+  "android.companion.virtual.VirtualDeviceParams.DynamicDisplayPolicyType": {
+    "flag": false,
+    "values": {
+      "2": "POLICY_TYPE_RECENTS",
+      "3": "POLICY_TYPE_ACTIVITY"
+    }
+  },
   "android.companion.virtual.VirtualDeviceParams.DynamicPolicyType": {
     "flag": false,
     "values": {
       "2": "POLICY_TYPE_RECENTS",
       "3": "POLICY_TYPE_ACTIVITY",
       "4": "POLICY_TYPE_CLIPBOARD",
-      "6": "POLICY_TYPE_BLOCKED_ACTIVITY_BEHAVIOR"
+      "6": "POLICY_TYPE_BLOCKED_ACTIVITY"
     }
   },
   "android.companion.virtual.VirtualDeviceParams.LockState": {
@@ -2369,7 +2452,10 @@
       "1": "POLICY_TYPE_AUDIO",
       "2": "POLICY_TYPE_RECENTS",
       "3": "POLICY_TYPE_ACTIVITY",
-      "5": "POLICY_TYPE_CAMERA"
+      "4": "POLICY_TYPE_CLIPBOARD",
+      "5": "POLICY_TYPE_CAMERA",
+      "6": "POLICY_TYPE_BLOCKED_ACTIVITY",
+      "7": "POLICY_TYPE_DEFAULT_DEVICE_CAMERA_ACCESS"
     }
   },
   "android.companion.virtual.camera.VirtualCameraConfig.SensorOrientation": {
@@ -2381,6 +2467,15 @@
       "270": "SENSOR_ORIENTATION_270"
     }
   },
+  "android.companion.virtual.sensor.VirtualSensorConfig.ReportingMode": {
+    "flag": false,
+    "values": {
+      "0": "REPORTING_MODE_CONTINUOUS",
+      "1": "REPORTING_MODE_ON_CHANGE",
+      "2": "REPORTING_MODE_ONE_SHOT",
+      "3": "REPORTING_MODE_SPECIAL_TRIGGER"
+    }
+  },
   "android.content.ClipDescription.ClassificationStatus": {
     "flag": false,
     "values": {
@@ -2534,7 +2629,8 @@
   "android.content.Intent.ExtendedFlags": {
     "flag": true,
     "values": {
-      "1": "EXTENDED_FLAG_FILTER_MISMATCH"
+      "1": "EXTENDED_FLAG_FILTER_MISMATCH",
+      "2": "EXTENDED_FLAG_MISSING_CREATOR_OR_INVALID_TOKEN"
     }
   },
   "android.content.Intent.FillInFlags": {
@@ -2627,6 +2723,15 @@
       "4096": "FLAG_ACTIVITY_LAUNCH_ADJACENT"
     }
   },
+  "android.content.Intent.NestedIntentKey.NestedIntentKeyType": {
+    "flag": true,
+    "values": {
+      "1": "NESTED_INTENT_KEY_TYPE_EXTRA_PARCEL",
+      "2": "NESTED_INTENT_KEY_TYPE_EXTRA_PARCEL_ARRAY",
+      "4": "NESTED_INTENT_KEY_TYPE_EXTRA_PARCEL_LIST",
+      "8": "NESTED_INTENT_KEY_TYPE_CLIP_DATA"
+    }
+  },
   "android.content.Intent.UriFlags": {
     "flag": true,
     "values": {
@@ -2858,7 +2963,8 @@
       "4": "PRIVATE_FLAG_EXT_ATTRIBUTIONS_ARE_USER_VISIBLE",
       "8": "PRIVATE_FLAG_EXT_ENABLE_ON_BACK_INVOKED_CALLBACK",
       "16": "PRIVATE_FLAG_EXT_ALLOWLISTED_FOR_HIDDEN_APIS",
-      "32": "PRIVATE_FLAG_EXT_CPU_OVERRIDE"
+      "32": "PRIVATE_FLAG_EXT_CPU_OVERRIDE",
+      "64": "PRIVATE_FLAG_EXT_NOT_LAUNCHED"
     }
   },
   "android.content.pm.ApplicationInfo.Category": {
@@ -3033,6 +3139,23 @@
       "2": "REASON_REMIND_OWNERSHIP"
     }
   },
+  "android.content.pm.PackageInstaller.VerificationFailedReason": {
+    "flag": false,
+    "values": {
+      "0": "VERIFICATION_FAILED_REASON_UNKNOWN",
+      "1": "VERIFICATION_FAILED_REASON_NETWORK_UNAVAILABLE",
+      "2": "VERIFICATION_FAILED_REASON_PACKAGE_BLOCKED"
+    }
+  },
+  "android.content.pm.PackageInstaller.VerificationPolicy": {
+    "flag": false,
+    "values": {
+      "0": "VERIFICATION_POLICY_NONE",
+      "1": "VERIFICATION_POLICY_BLOCK_FAIL_OPEN",
+      "2": "VERIFICATION_POLICY_BLOCK_FAIL_WARN",
+      "3": "VERIFICATION_POLICY_BLOCK_FAIL_CLOSED"
+    }
+  },
   "android.content.pm.PackageManager.AppMetadataSource": {
     "flag": true,
     "values": {
@@ -3705,6 +3828,21 @@
       "2": "DOMAIN_STATE_VERIFIED"
     }
   },
+  "android.content.pm.verify.pkg.VerificationSession.VerificationIncompleteReason": {
+    "flag": false,
+    "values": {
+      "1": "VERIFICATION_INCOMPLETE_NETWORK_UNAVAILABLE",
+      "0": "VERIFICATION_INCOMPLETE_UNKNOWN"
+    }
+  },
+  "android.content.pm.verify.pkg.VerificationStatus.VerifierStatusAsl": {
+    "flag": false,
+    "values": {
+      "0": "VERIFIER_STATUS_ASL_UNDEFINED",
+      "1": "VERIFIER_STATUS_ASL_GOOD",
+      "2": "VERIFIER_STATUS_ASL_BAD"
+    }
+  },
   "android.content.res.ApkAssets.FormatType": {
     "flag": false,
     "values": {
@@ -3831,6 +3969,7 @@
       "1": "OPEN_READONLY",
       "268435456": "CREATE_IF_NECESSARY",
       "16": "NO_LOCALIZED_COLLATORS",
+      "32": "NO_DOUBLE_QUOTED_STRS",
       "536870912": "ENABLE_WRITE_AHEAD_LOGGING"
     }
   },
@@ -3866,6 +4005,13 @@
       "2": "FORCE_INVERT_COLOR_DARK"
     }
   },
+  "android.graphics.Gainmap.GainmapDirection": {
+    "flag": false,
+    "values": {
+      "0": "GAINMAP_DIRECTION_SDR_TO_HDR",
+      "1": "GAINMAP_DIRECTION_HDR_TO_SDR"
+    }
+  },
   "android.graphics.HardwareBufferRenderer.RenderResult.RenderResultStatus": {
     "flag": false,
     "values": {
@@ -3934,6 +4080,7 @@
       "538982489": "Y8",
       "540422489": "Y16",
       "54": "YCBCR_P010",
+      "60": "YCBCR_P210",
       "16": "NV16",
       "17": "NV21",
       "20": "YUY2",
@@ -3954,6 +4101,7 @@
       "4099": "RAW_DEPTH10",
       "34": "PRIVATE",
       "1212500294": "HEIC",
+      "4102": "HEIC_ULTRAHDR",
       "4101": "JPEG_R"
     }
   },
@@ -4303,6 +4451,7 @@
       "4096": "DATASPACE_DEPTH",
       "4098": "DATASPACE_DYNAMIC_DEPTH",
       "4100": "DATASPACE_HEIF",
+      "4102": "DATASPACE_HEIF_ULTRAHDR",
       "4101": "DATASPACE_JPEG_R",
       "0": "DATASPACE_UNKNOWN",
       "406913024": "DATASPACE_SCRGB_LINEAR",
@@ -4318,7 +4467,8 @@
       "147193856": "DATASPACE_BT2020",
       "281083904": "DATASPACE_BT709",
       "155844608": "DATASPACE_DCI_P3",
-      "138477568": "DATASPACE_SRGB_LINEAR"
+      "138477568": "DATASPACE_SRGB_LINEAR",
+      "142999552": "DATASPACE_DISPLAY_BT2020"
     }
   },
   "android.hardware.HardwareBuffer.Format": {
@@ -4339,12 +4489,27 @@
       "52": "DS_FP32UI8",
       "53": "S_UI8",
       "54": "YCBCR_P010",
+      "60": "YCBCR_P210",
       "56": "R_8",
       "57": "R_16",
       "58": "RG_1616",
       "59": "RGBA_10101010"
     }
   },
+  "android.hardware.LutProperties.Dimension": {
+    "flag": false,
+    "values": {
+      "1": "ONE_DIMENSION",
+      "3": "THREE_DIMENSION"
+    }
+  },
+  "android.hardware.LutProperties.SamplingKey": {
+    "flag": false,
+    "values": {
+      "0": "SAMPLING_KEY_RGB",
+      "1": "SAMPLING_KEY_MAX_RGB"
+    }
+  },
   "android.hardware.SensorAdditionalInfo.AdditionalInfoType": {
     "flag": false,
     "values": {
@@ -4465,6 +4630,8 @@
       "13": "BIOMETRIC_ERROR_NEGATIVE_BUTTON",
       "14": "BIOMETRIC_ERROR_NO_DEVICE_CREDENTIAL",
       "15": "BIOMETRIC_ERROR_SECURITY_UPDATE_REQUIRED",
+      "20": "BIOMETRIC_ERROR_IDENTITY_CHECK_NOT_ACTIVE",
+      "21": "BIOMETRIC_ERROR_NOT_ENABLED_FOR_APPS",
       "100": "BIOMETRIC_PAUSED_REJECTED"
     }
   },
@@ -4581,7 +4748,7 @@
       "255": "BIOMETRIC_WEAK",
       "4095": "BIOMETRIC_CONVENIENCE",
       "32768": "DEVICE_CREDENTIAL",
-      "65536": "MANDATORY_BIOMETRICS"
+      "65536": "IDENTITY_CHECK"
     }
   },
   "android.hardware.biometrics.BiometricManager.BiometricError": {
@@ -4591,7 +4758,9 @@
       "1": "BIOMETRIC_ERROR_HW_UNAVAILABLE",
       "11": "BIOMETRIC_ERROR_NONE_ENROLLED",
       "12": "BIOMETRIC_ERROR_NO_HARDWARE",
-      "15": "BIOMETRIC_ERROR_SECURITY_UPDATE_REQUIRED"
+      "15": "BIOMETRIC_ERROR_SECURITY_UPDATE_REQUIRED",
+      "7": "BIOMETRIC_ERROR_LOCKOUT",
+      "20": "BIOMETRIC_ERROR_IDENTITY_CHECK_NOT_ACTIVE"
     }
   },
   "android.hardware.biometrics.BiometricPrompt.AuthenticationResultType": {
@@ -4611,7 +4780,8 @@
       "5": "DISMISSED_REASON_ERROR",
       "6": "DISMISSED_REASON_SERVER_REQUESTED",
       "7": "DISMISSED_REASON_CREDENTIAL_CONFIRMED",
-      "8": "DISMISSED_REASON_CONTENT_VIEW_MORE_OPTIONS"
+      "8": "DISMISSED_REASON_CONTENT_VIEW_MORE_OPTIONS",
+      "9": "DISMISSED_REASON_ERROR_NO_WM"
     }
   },
   "android.hardware.biometrics.BiometricRequestConstants.RequestReason": {
@@ -4684,6 +4854,7 @@
     "values": {
       "0": "SESSION_OPERATION_MODE_NORMAL",
       "1": "SESSION_OPERATION_MODE_CONSTRAINED_HIGH_SPEED",
+      "2": "SESSION_OPERATION_MODE_SHARED",
       "32768": "SESSION_OPERATION_MODE_VENDOR_START"
     }
   },
@@ -4704,8 +4875,7 @@
       "1": "EXTENSION_FACE_RETOUCH",
       "2": "EXTENSION_BOKEH",
       "3": "EXTENSION_HDR",
-      "4": "EXTENSION_NIGHT",
-      "5": "EXTENSION_EYES_FREE_VIDEOGRAPHY"
+      "4": "EXTENSION_NIGHT"
     }
   },
   "android.hardware.camera2.CameraInjectionSession.InjectionStatusCallback.ErrorCode": {
@@ -4788,6 +4958,32 @@
       "1": "SESSION_HIGH_SPEED"
     }
   },
+  "android.hardware.contexthub.HubEndpointInfo.EndpointType": {
+    "flag": false,
+    "values": {
+      "1": "TYPE_FRAMEWORK",
+      "2": "TYPE_APP",
+      "3": "TYPE_NATIVE",
+      "4": "TYPE_NANOAPP",
+      "5": "TYPE_HUB_ENDPOINT"
+    }
+  },
+  "android.hardware.contexthub.HubServiceInfo.ServiceFormat": {
+    "flag": false,
+    "values": {
+      "0": "FORMAT_CUSTOM",
+      "1": "FORMAT_AIDL",
+      "2": "FORMAT_PW_RPC_PROTOBUF"
+    }
+  },
+  "android.hardware.contexthub.IHubEndpointLifecycleCallback.EndpointLifecycleReason": {
+    "flag": false,
+    "values": {
+      "0": "REASON_UNSPECIFIED",
+      "3": "REASON_OPEN_ENDPOINT_SESSION_REQUEST_REJECTED",
+      "4": "REASON_CLOSE_ENDPOINT_SESSION_REQUESTED"
+    }
+  },
   "android.hardware.devicestate.DeviceState.DeviceStateProperties": {
     "flag": false,
     "values": {
@@ -4807,7 +5003,8 @@
       "14": "PROPERTY_POWER_CONFIGURATION_TRIGGER_WAKE",
       "15": "PROPERTY_EXTENDED_DEVICE_STATE_EXTERNAL_DISPLAY",
       "16": "PROPERTY_FEATURE_REAR_DISPLAY",
-      "17": "PROPERTY_FEATURE_DUAL_DISPLAY_INTERNAL_DEFAULT"
+      "17": "PROPERTY_FEATURE_DUAL_DISPLAY_INTERNAL_DEFAULT",
+      "1001": "PROPERTY_FEATURE_REAR_DISPLAY_OUTER_DEFAULT"
     }
   },
   "android.hardware.devicestate.DeviceState.PhysicalDeviceStateProperties": {
@@ -4856,7 +5053,8 @@
     "values": {
       "0": "BRIGHTNESS_MAX_REASON_NONE",
       "1": "BRIGHTNESS_MAX_REASON_THERMAL",
-      "2": "BRIGHTNESS_MAX_REASON_POWER_IC"
+      "2": "BRIGHTNESS_MAX_REASON_POWER_IC",
+      "3": "BRIGHTNESS_MAX_REASON_WEAR_BEDTIME_MODE"
     }
   },
   "android.hardware.display.BrightnessInfo.HighBrightnessMode": {
@@ -4950,7 +5148,9 @@
       "4": "EVENT_DISPLAY_BRIGHTNESS_CHANGED",
       "5": "EVENT_DISPLAY_HDR_SDR_RATIO_CHANGED",
       "6": "EVENT_DISPLAY_CONNECTED",
-      "7": "EVENT_DISPLAY_DISCONNECTED"
+      "7": "EVENT_DISPLAY_DISCONNECTED",
+      "8": "EVENT_DISPLAY_REFRESH_RATE_CHANGED",
+      "9": "EVENT_DISPLAY_STATE_CHANGED"
     }
   },
   "android.hardware.display.DisplayManagerInternal.RefreshRateLimitType": {
@@ -4959,6 +5159,15 @@
       "1": "REFRESH_RATE_LIMIT_HIGH_BRIGHTNESS_MODE"
     }
   },
+  "android.hardware.display.DisplayTopology.TreeNode.Position": {
+    "flag": false,
+    "values": {
+      "0": "POSITION_LEFT",
+      "1": "POSITION_TOP",
+      "2": "POSITION_RIGHT",
+      "3": "POSITION_BOTTOM"
+    }
+  },
   "android.hardware.display.DisplayViewport.ViewportType": {
     "flag": false,
     "values": {
@@ -5203,6 +5412,16 @@
       "7": "HDMI_RELATIVE_POSITION_DIFFERENT_BRANCH"
     }
   },
+  "android.hardware.input.InputManager.CustomInputGestureResult": {
+    "flag": false,
+    "values": {
+      "1": "CUSTOM_INPUT_GESTURE_RESULT_SUCCESS",
+      "2": "CUSTOM_INPUT_GESTURE_RESULT_ERROR_ALREADY_EXISTS",
+      "3": "CUSTOM_INPUT_GESTURE_RESULT_ERROR_DOES_NOT_EXIST",
+      "4": "CUSTOM_INPUT_GESTURE_RESULT_ERROR_RESERVED_GESTURE",
+      "5": "CUSTOM_INPUT_GESTURE_RESULT_ERROR_OTHER"
+    }
+  },
   "android.hardware.input.InputManager.RemappableModifierKey": {
     "flag": false,
     "values": {
@@ -5225,6 +5444,88 @@
       "1": "SWITCH_STATE_ON"
     }
   },
+  "android.hardware.input.KeyGestureEvent.KeyGestureType": {
+    "flag": false,
+    "values": {
+      "0": "KEY_GESTURE_TYPE_UNSPECIFIED",
+      "1": "KEY_GESTURE_TYPE_HOME",
+      "2": "KEY_GESTURE_TYPE_RECENT_APPS",
+      "3": "KEY_GESTURE_TYPE_BACK",
+      "4": "KEY_GESTURE_TYPE_APP_SWITCH",
+      "5": "KEY_GESTURE_TYPE_LAUNCH_ASSISTANT",
+      "6": "KEY_GESTURE_TYPE_LAUNCH_VOICE_ASSISTANT",
+      "7": "KEY_GESTURE_TYPE_LAUNCH_SYSTEM_SETTINGS",
+      "8": "KEY_GESTURE_TYPE_TOGGLE_NOTIFICATION_PANEL",
+      "9": "KEY_GESTURE_TYPE_TOGGLE_TASKBAR",
+      "10": "KEY_GESTURE_TYPE_TAKE_SCREENSHOT",
+      "11": "KEY_GESTURE_TYPE_SCREENSHOT_CHORD",
+      "12": "KEY_GESTURE_TYPE_OPEN_SHORTCUT_HELPER",
+      "13": "KEY_GESTURE_TYPE_BRIGHTNESS_UP",
+      "14": "KEY_GESTURE_TYPE_BRIGHTNESS_DOWN",
+      "15": "KEY_GESTURE_TYPE_KEYBOARD_BACKLIGHT_UP",
+      "16": "KEY_GESTURE_TYPE_KEYBOARD_BACKLIGHT_DOWN",
+      "17": "KEY_GESTURE_TYPE_KEYBOARD_BACKLIGHT_TOGGLE",
+      "18": "KEY_GESTURE_TYPE_VOLUME_UP",
+      "19": "KEY_GESTURE_TYPE_VOLUME_DOWN",
+      "20": "KEY_GESTURE_TYPE_VOLUME_MUTE",
+      "21": "KEY_GESTURE_TYPE_ALL_APPS",
+      "22": "KEY_GESTURE_TYPE_LAUNCH_SEARCH",
+      "23": "KEY_GESTURE_TYPE_LANGUAGE_SWITCH",
+      "24": "KEY_GESTURE_TYPE_ACCESSIBILITY_ALL_APPS",
+      "25": "KEY_GESTURE_TYPE_TOGGLE_CAPS_LOCK",
+      "26": "KEY_GESTURE_TYPE_SYSTEM_MUTE",
+      "27": "KEY_GESTURE_TYPE_SPLIT_SCREEN_NAVIGATION_LEFT",
+      "28": "KEY_GESTURE_TYPE_SPLIT_SCREEN_NAVIGATION_RIGHT",
+      "29": "KEY_GESTURE_TYPE_CHANGE_SPLITSCREEN_FOCUS_LEFT",
+      "30": "KEY_GESTURE_TYPE_CHANGE_SPLITSCREEN_FOCUS_RIGHT",
+      "31": "KEY_GESTURE_TYPE_TRIGGER_BUG_REPORT",
+      "32": "KEY_GESTURE_TYPE_LOCK_SCREEN",
+      "33": "KEY_GESTURE_TYPE_OPEN_NOTES",
+      "34": "KEY_GESTURE_TYPE_TOGGLE_POWER",
+      "35": "KEY_GESTURE_TYPE_SYSTEM_NAVIGATION",
+      "36": "KEY_GESTURE_TYPE_SLEEP",
+      "37": "KEY_GESTURE_TYPE_WAKEUP",
+      "38": "KEY_GESTURE_TYPE_MEDIA_KEY",
+      "39": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_BROWSER",
+      "40": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_EMAIL",
+      "41": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_CONTACTS",
+      "42": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_CALENDAR",
+      "43": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_CALCULATOR",
+      "44": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_MUSIC",
+      "45": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_MAPS",
+      "46": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_MESSAGING",
+      "47": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_GALLERY",
+      "48": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_FILES",
+      "49": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_WEATHER",
+      "50": "KEY_GESTURE_TYPE_LAUNCH_DEFAULT_FITNESS",
+      "51": "KEY_GESTURE_TYPE_LAUNCH_APPLICATION",
+      "52": "KEY_GESTURE_TYPE_DESKTOP_MODE",
+      "53": "KEY_GESTURE_TYPE_MULTI_WINDOW_NAVIGATION",
+      "54": "KEY_GESTURE_TYPE_RECENT_APPS_SWITCHER",
+      "55": "KEY_GESTURE_TYPE_ACCESSIBILITY_SHORTCUT_CHORD",
+      "56": "KEY_GESTURE_TYPE_RINGER_TOGGLE_CHORD",
+      "57": "KEY_GESTURE_TYPE_GLOBAL_ACTIONS",
+      "58": "KEY_GESTURE_TYPE_TV_ACCESSIBILITY_SHORTCUT_CHORD",
+      "59": "KEY_GESTURE_TYPE_TV_TRIGGER_BUG_REPORT",
+      "60": "KEY_GESTURE_TYPE_ACCESSIBILITY_SHORTCUT",
+      "61": "KEY_GESTURE_TYPE_CLOSE_ALL_DIALOGS",
+      "62": "KEY_GESTURE_TYPE_MOVE_TO_NEXT_DISPLAY",
+      "63": "KEY_GESTURE_TYPE_TOGGLE_TALKBACK",
+      "64": "KEY_GESTURE_TYPE_TOGGLE_STICKY_KEYS",
+      "65": "KEY_GESTURE_TYPE_TOGGLE_BOUNCE_KEYS",
+      "66": "KEY_GESTURE_TYPE_TOGGLE_SLOW_KEYS",
+      "67": "KEY_GESTURE_TYPE_TOGGLE_MOUSE_KEYS",
+      "68": "KEY_GESTURE_TYPE_SNAP_LEFT_FREEFORM_WINDOW",
+      "69": "KEY_GESTURE_TYPE_SNAP_RIGHT_FREEFORM_WINDOW",
+      "70": "KEY_GESTURE_TYPE_MINIMIZE_FREEFORM_WINDOW",
+      "71": "KEY_GESTURE_TYPE_TOGGLE_MAXIMIZE_FREEFORM_WINDOW",
+      "72": "KEY_GESTURE_TYPE_MAGNIFIER_ZOOM_IN",
+      "73": "KEY_GESTURE_TYPE_MAGNIFIER_ZOOM_OUT",
+      "74": "KEY_GESTURE_TYPE_TOGGLE_MAGNIFICATION",
+      "75": "KEY_GESTURE_TYPE_ACTIVATE_SELECT_TO_SPEAK",
+      "76": "KEY_GESTURE_TYPE_MAXIMIZE_FREEFORM_WINDOW"
+    }
+  },
   "android.hardware.input.KeyboardLayoutSelectionResult.LayoutSelectionCriteria": {
     "flag": false,
     "values": {
@@ -5443,7 +5744,8 @@
       "10001": "LIGHT_TYPE_INPUT",
       "10002": "LIGHT_TYPE_PLAYER_ID",
       "10003": "LIGHT_TYPE_KEYBOARD_BACKLIGHT",
-      "10004": "LIGHT_TYPE_KEYBOARD_MIC_MUTE"
+      "10004": "LIGHT_TYPE_KEYBOARD_MIC_MUTE",
+      "10005": "LIGHT_TYPE_KEYBOARD_VOLUME_MUTE"
     }
   },
   "android.hardware.lights.LightsManager.LightType": {
@@ -5496,7 +5798,16 @@
       "2": "TYPE_ENABLE_NANOAPP",
       "3": "TYPE_DISABLE_NANOAPP",
       "4": "TYPE_QUERY_NANOAPPS",
-      "5": "TYPE_RELIABLE_MESSAGE"
+      "5": "TYPE_RELIABLE_MESSAGE",
+      "6": "TYPE_HUB_MESSAGE_DEFAULT",
+      "7": "TYPE_HUB_MESSAGE_REQUIRES_RESPONSE"
+    }
+  },
+  "android.hardware.location.HubInfo.HubType": {
+    "flag": false,
+    "values": {
+      "0": "TYPE_CONTEXT_HUB",
+      "1": "TYPE_VENDOR_HUB"
     }
   },
   "android.hardware.radio.Announcement.Type": {
@@ -5560,6 +5871,69 @@
       "7": "PROGRAM_TYPE_SXM"
     }
   },
+  "android.hardware.radio.RadioAlert.AlertCategory": {
+    "flag": false,
+    "values": {
+      "0": "CATEGORY_GEO",
+      "1": "CATEGORY_MET",
+      "2": "CATEGORY_SAFETY",
+      "3": "CATEGORY_SECURITY",
+      "4": "CATEGORY_RESCUE",
+      "5": "CATEGORY_FIRE",
+      "6": "CATEGORY_HEALTH",
+      "7": "CATEGORY_ENV",
+      "8": "CATEGORY_TRANSPORT",
+      "9": "CATEGORY_INFRA",
+      "10": "CATEGORY_CBRNE",
+      "11": "CATEGORY_OTHER"
+    }
+  },
+  "android.hardware.radio.RadioAlert.AlertCertainty": {
+    "flag": false,
+    "values": {
+      "0": "CERTAINTY_OBSERVED",
+      "1": "CERTAINTY_LIKELY",
+      "2": "CERTAINTY_POSSIBLE",
+      "3": "CERTAINTY_UNLIKELY",
+      "4": "CERTAINTY_UNKNOWN"
+    }
+  },
+  "android.hardware.radio.RadioAlert.AlertMessageType": {
+    "flag": false,
+    "values": {
+      "0": "MESSAGE_TYPE_ALERT",
+      "1": "MESSAGE_TYPE_UPDATE",
+      "2": "MESSAGE_TYPE_CANCEL"
+    }
+  },
+  "android.hardware.radio.RadioAlert.AlertSeverity": {
+    "flag": false,
+    "values": {
+      "0": "SEVERITY_EXTREME",
+      "1": "SEVERITY_SEVERE",
+      "2": "SEVERITY_MODERATE",
+      "3": "SEVERITY_MINOR",
+      "4": "SEVERITY_UNKNOWN"
+    }
+  },
+  "android.hardware.radio.RadioAlert.AlertStatus": {
+    "flag": false,
+    "values": {
+      "0": "STATUS_ACTUAL",
+      "1": "STATUS_EXERCISE",
+      "2": "STATUS_TEST"
+    }
+  },
+  "android.hardware.radio.RadioAlert.AlertUrgency": {
+    "flag": false,
+    "values": {
+      "0": "URGENCY_IMMEDIATE",
+      "1": "URGENCY_EXPECTED",
+      "2": "URGENCY_FUTURE",
+      "3": "URGENCY_PAST",
+      "4": "URGENCY_UNKNOWN"
+    }
+  },
   "android.hardware.radio.RadioManager.Band": {
     "flag": false,
     "values": {
@@ -5845,6 +6219,14 @@
       "3": "BACK_DISPOSITION_ADJUST_NOTHING"
     }
   },
+  "android.inputmethodservice.InputMethodService.ImeWindowVisibility": {
+    "flag": true,
+    "values": {
+      "1": "IME_ACTIVE",
+      "2": "IME_VISIBLE",
+      "4": "IME_VISIBLE_IMPERCEPTIBLE"
+    }
+  },
   "android.inputmethodservice.InputMethodService.SettingsObserver.ShowImeWithHardKeyboardType": {
     "flag": false,
     "values": {
@@ -5920,7 +6302,8 @@
       "1000": "USAGE_EMERGENCY",
       "1001": "USAGE_SAFETY",
       "1002": "USAGE_VEHICLE_STATUS",
-      "1003": "USAGE_ANNOUNCEMENT"
+      "1003": "USAGE_ANNOUNCEMENT",
+      "1004": "USAGE_SPEAKER_CLEANUP"
     }
   },
   "android.media.AudioAttributes.AttributeUsage": {
@@ -5946,7 +6329,8 @@
       "1000": "USAGE_EMERGENCY",
       "1001": "USAGE_SAFETY",
       "1002": "USAGE_VEHICLE_STATUS",
-      "1003": "USAGE_ANNOUNCEMENT"
+      "1003": "USAGE_ANNOUNCEMENT",
+      "1004": "USAGE_SPEAKER_CLEANUP"
     }
   },
   "android.media.AudioAttributes.CapturePolicy": {
@@ -6013,7 +6397,8 @@
       "27": "TYPE_BLE_SPEAKER",
       "28": "TYPE_ECHO_REFERENCE",
       "30": "TYPE_BLE_BROADCAST",
-      "31": "TYPE_DOCK_ANALOG"
+      "31": "TYPE_DOCK_ANALOG",
+      "32": "TYPE_MULTICHANNEL_GROUP"
     }
   },
   "android.media.AudioDeviceInfo.AudioDeviceTypeIn": {
@@ -6066,12 +6451,14 @@
       "19": "TYPE_AUX_LINE",
       "20": "TYPE_IP",
       "21": "TYPE_BUS",
+      "25": "TYPE_REMOTE_SUBMIX",
       "23": "TYPE_HEARING_AID",
       "24": "TYPE_BUILTIN_SPEAKER_SAFE",
       "26": "TYPE_BLE_HEADSET",
       "27": "TYPE_BLE_SPEAKER",
       "30": "TYPE_BLE_BROADCAST",
-      "31": "TYPE_DOCK_ANALOG"
+      "31": "TYPE_DOCK_ANALOG",
+      "32": "TYPE_MULTICHANNEL_GROUP"
     }
   },
   "android.media.AudioDeviceVolumeManager.VolumeAdjustmentMode": {
@@ -6135,6 +6522,7 @@
       "15": "ENCODING_AAC_ELD",
       "16": "ENCODING_AAC_XHE",
       "17": "ENCODING_AC4",
+      "32": "ENCODING_AC4_L4",
       "18": "ENCODING_E_AC3_JOC",
       "19": "ENCODING_DOLBY_MAT",
       "20": "ENCODING_OPUS",
@@ -6172,6 +6560,7 @@
       "15": "ENCODING_AAC_ELD",
       "16": "ENCODING_AAC_XHE",
       "17": "ENCODING_AC4",
+      "32": "ENCODING_AC4_L4",
       "18": "ENCODING_E_AC3_JOC",
       "19": "ENCODING_DOLBY_MAT",
       "20": "ENCODING_OPUS",
@@ -6198,6 +6587,7 @@
       "10": "ENCODING_AAC_LC",
       "14": "ENCODING_DOLBY_TRUEHD",
       "17": "ENCODING_AC4",
+      "32": "ENCODING_AC4_L4",
       "18": "ENCODING_E_AC3_JOC",
       "19": "ENCODING_DOLBY_MAT",
       "23": "ENCODING_MPEGH_BL_L3",
@@ -6290,6 +6680,13 @@
       "4": "CSD_WARNING_ACCUMULATION_START"
     }
   },
+  "android.media.AudioManager.DeviceConnectionState": {
+    "flag": false,
+    "values": {
+      "0": "DEVICE_CONNECTION_STATE_DISCONNECTED",
+      "1": "DEVICE_CONNECTION_STATE_CONNECTED"
+    }
+  },
   "android.media.AudioManager.DeviceVolumeBehavior": {
     "flag": false,
     "values": {
@@ -6435,7 +6832,8 @@
       "4": "MUTED_BY_STREAM_MUTED",
       "8": "MUTED_BY_APP_OPS",
       "16": "MUTED_BY_CLIENT_VOLUME",
-      "32": "MUTED_BY_VOLUME_SHAPER"
+      "32": "MUTED_BY_VOLUME_SHAPER",
+      "64": "MUTED_BY_PORT_VOLUME"
     }
   },
   "android.media.AudioPlaybackConfiguration.PlayerState": {
@@ -7179,6 +7577,9 @@
       "9": "TYPE_HDMI",
       "10": "TYPE_HDMI_ARC",
       "29": "TYPE_HDMI_EARC",
+      "6": "TYPE_LINE_DIGITAL",
+      "5": "TYPE_LINE_ANALOG",
+      "19": "TYPE_AUX_LINE",
       "11": "TYPE_USB_DEVICE",
       "12": "TYPE_USB_ACCESSORY",
       "13": "TYPE_DOCK",
@@ -7719,6 +8120,80 @@
       "1": "CAPTURE_REGION_FIXED_DISPLAY"
     }
   },
+  "android.media.quality.AmbientBacklightEvent.Type": {
+    "flag": false,
+    "values": {
+      "1": "AMBIENT_BACKLIGHT_EVENT_ENABLED",
+      "2": "AMBIENT_BACKLIGHT_EVENT_DISABLED",
+      "3": "AMBIENT_BACKLIGHT_EVENT_METADATA",
+      "4": "AMBIENT_BACKLIGHT_EVENT_INTERRUPTED"
+    }
+  },
+  "android.media.quality.AmbientBacklightSettings.ColorFormat": {
+    "flag": false,
+    "values": {
+      "1": "COLOR_FORMAT_RGB888"
+    }
+  },
+  "android.media.quality.AmbientBacklightSettings.CompressAlgorithm": {
+    "flag": false,
+    "values": {
+      "0": "ALGORITHM_NONE",
+      "1": "ALGORITHM_RLE"
+    }
+  },
+  "android.media.quality.AmbientBacklightSettings.Source": {
+    "flag": false,
+    "values": {
+      "0": "SOURCE_NONE",
+      "1": "SOURCE_AUDIO",
+      "2": "SOURCE_VIDEO",
+      "3": "SOURCE_AUDIO_VIDEO"
+    }
+  },
+  "android.media.quality.ParamCapability.ParamType": {
+    "flag": true,
+    "values": {
+      "1": "TYPE_INT",
+      "2": "TYPE_LONG",
+      "3": "TYPE_DOUBLE",
+      "4": "TYPE_STRING"
+    }
+  },
+  "android.media.quality.PictureProfile.ErrorCode": {
+    "flag": false,
+    "values": {
+      "0": "ERROR_UNKNOWN",
+      "1": "ERROR_NO_PERMISSION",
+      "2": "ERROR_DUPLICATE",
+      "3": "ERROR_INVALID_ARGUMENT",
+      "4": "ERROR_NOT_ALLOWLISTED"
+    }
+  },
+  "android.media.quality.PictureProfile.ProfileType": {
+    "flag": false,
+    "values": {
+      "1": "TYPE_SYSTEM",
+      "2": "TYPE_APPLICATION"
+    }
+  },
+  "android.media.quality.SoundProfile.ErrorCode": {
+    "flag": false,
+    "values": {
+      "0": "ERROR_UNKNOWN",
+      "1": "ERROR_NO_PERMISSION",
+      "2": "ERROR_DUPLICATE",
+      "3": "ERROR_INVALID_ARGUMENT",
+      "4": "ERROR_NOT_ALLOWLISTED"
+    }
+  },
+  "android.media.quality.SoundProfile.ProfileType": {
+    "flag": false,
+    "values": {
+      "1": "TYPE_SYSTEM",
+      "2": "TYPE_APPLICATION"
+    }
+  },
   "android.media.session.MediaController.PlaybackInfo.PlaybackType": {
     "flag": false,
     "values": {
@@ -7748,8 +8223,7 @@
       "8": "STATE_CONNECTING",
       "9": "STATE_SKIPPING_TO_PREVIOUS",
       "10": "STATE_SKIPPING_TO_NEXT",
-      "11": "STATE_SKIPPING_TO_QUEUE_ITEM",
-      "12": "STATE_PLAYBACK_SUPPRESSED"
+      "11": "STATE_SKIPPING_TO_QUEUE_ITEM"
     }
   },
   "android.media.soundtrigger.SoundTriggerDetector.RecognitionFlags": {
@@ -8022,6 +8496,15 @@
       "500": "PRIORITY_HINT_USE_CASE_TYPE_RECORD"
     }
   },
+  "android.media.tv.TvInputServiceExtensionManager.RegisterResult": {
+    "flag": false,
+    "values": {
+      "0": "REGISTER_SUCCESS",
+      "1": "REGISTER_FAIL_NAME_NOT_STANDARDIZED",
+      "2": "REGISTER_FAIL_IMPLEMENTATION_NOT_STANDARDIZED",
+      "3": "REGISTER_FAIL_REMOTE_EXCEPTION"
+    }
+  },
   "android.media.tv.TvRecordingInfo.DaysOfWeek": {
     "flag": true,
     "values": {
@@ -8215,7 +8698,9 @@
       "0": "TUNER_VERSION_UNKNOWN",
       "65536": "TUNER_VERSION_1_0",
       "65537": "TUNER_VERSION_1_1",
-      "131072": "TUNER_VERSION_2_0"
+      "131072": "TUNER_VERSION_2_0",
+      "196608": "TUNER_VERSION_3_0",
+      "262144": "TUNER_VERSION_4_0"
     }
   },
   "android.media.tv.tuner.dvr.DvrPlayback.PlaybackStatus": {
@@ -9012,7 +9497,8 @@
       "43": "FRONTEND_STATUS_TYPE_IPTV_PACKETS_LOST",
       "44": "FRONTEND_STATUS_TYPE_IPTV_PACKETS_RECEIVED",
       "45": "FRONTEND_STATUS_TYPE_IPTV_WORST_JITTER_MS",
-      "46": "FRONTEND_STATUS_TYPE_IPTV_AVERAGE_JITTER_MS"
+      "46": "FRONTEND_STATUS_TYPE_IPTV_AVERAGE_JITTER_MS",
+      "47": "FRONTEND_STATUS_TYPE_STANDARD_EXT"
     }
   },
   "android.media.tv.tuner.frontend.FrontendStatus.FrontendTransmissionMode": {
@@ -9497,6 +9983,73 @@
       "13": "SECURITY_TYPE_DPP"
     }
   },
+  "android.net.wifi.WifiAnnotations.SoftApDisconnectReason": {
+    "flag": false,
+    "values": {
+      "0": "REASON_UNKNOWN",
+      "1": "REASON_UNSPECIFIED",
+      "2": "REASON_PREV_AUTH_NOT_VALID",
+      "3": "REASON_DEAUTH_LEAVING",
+      "4": "REASON_DISASSOC_DUE_TO_INACTIVITY",
+      "5": "REASON_DISASSOC_AP_BUSY",
+      "6": "REASON_CLASS2_FRAME_FROM_NONAUTH_STA",
+      "7": "REASON_CLASS3_FRAME_FROM_NONASSOC_STA",
+      "8": "REASON_DISASSOC_STA_HAS_LEFT",
+      "9": "REASON_STA_REQ_ASSOC_WITHOUT_AUTH",
+      "10": "REASON_PWR_CAPABILITY_NOT_VALID",
+      "11": "REASON_SUPPORTED_CHANNEL_NOT_VALID",
+      "12": "REASON_BSS_TRANSITION_DISASSOC",
+      "13": "REASON_INVALID_IE",
+      "14": "REASON_MICHAEL_MIC_FAILURE",
+      "15": "REASON_FOURWAY_HANDSHAKE_TIMEOUT",
+      "16": "REASON_GROUP_KEY_UPDATE_TIMEOUT",
+      "17": "REASON_IE_IN_4WAY_DIFFERS",
+      "18": "REASON_GROUP_CIPHER_NOT_VALID",
+      "19": "REASON_PAIRWISE_CIPHER_NOT_VALID",
+      "20": "REASON_AKMP_NOT_VALID",
+      "21": "REASON_UNSUPPORTED_RSN_IE_VERSION",
+      "22": "REASON_INVALID_RSN_IE_CAPAB",
+      "23": "REASON_IEEE_802_1X_AUTH_FAILED",
+      "24": "REASON_CIPHER_SUITE_REJECTED",
+      "25": "REASON_TDLS_TEARDOWN_UNREACHABLE",
+      "26": "REASON_TDLS_TEARDOWN_UNSPECIFIED",
+      "27": "REASON_SSP_REQUESTED_DISASSOC",
+      "28": "REASON_NO_SSP_ROAMING_AGREEMENT",
+      "29": "REASON_BAD_CIPHER_OR_AKM",
+      "30": "REASON_NOT_AUTHORIZED_THIS_LOCATION",
+      "31": "REASON_SERVICE_CHANGE_PRECLUDES_TS",
+      "32": "REASON_UNSPECIFIED_QOS_REASON",
+      "33": "REASON_NOT_ENOUGH_BANDWIDTH",
+      "34": "REASON_DISASSOC_LOW_ACK",
+      "35": "REASON_EXCEEDED_TXOP",
+      "36": "REASON_STA_LEAVING",
+      "37": "REASON_END_TS_BA_DLS",
+      "38": "REASON_UNKNOWN_TS_BA",
+      "39": "REASON_TIMEOUT",
+      "45": "REASON_PEERKEY_MISMATCH",
+      "46": "REASON_AUTHORIZED_ACCESS_LIMIT_REACHED",
+      "47": "REASON_EXTERNAL_SERVICE_REQUIREMENTS",
+      "48": "REASON_INVALID_FT_ACTION_FRAME_COUNT",
+      "49": "REASON_INVALID_PMKID",
+      "50": "REASON_INVALID_MDE",
+      "51": "REASON_INVALID_FTE",
+      "52": "REASON_MESH_PEERING_CANCELLED",
+      "53": "REASON_MESH_MAX_PEERS",
+      "54": "REASON_MESH_CONFIG_POLICY_VIOLATION",
+      "55": "REASON_MESH_CLOSE_RCVD",
+      "56": "REASON_MESH_MAX_RETRIES",
+      "57": "REASON_MESH_CONFIRM_TIMEOUT",
+      "58": "REASON_MESH_INVALID_GTK",
+      "59": "REASON_MESH_INCONSISTENT_PARAMS",
+      "60": "REASON_MESH_INVALID_SECURITY_CAP",
+      "61": "REASON_MESH_PATH_ERROR_NO_PROXY_INFO",
+      "62": "REASON_MESH_PATH_ERROR_NO_FORWARDING_INFO",
+      "63": "REASON_MESH_PATH_ERROR_DEST_UNREACHABLE",
+      "64": "REASON_MAC_ADDRESS_ALREADY_EXISTS_IN_MBSS",
+      "65": "REASON_MESH_CHANNEL_SWITCH_REGULATORY_REQ",
+      "66": "REASON_MESH_CHANNEL_SWITCH_UNSPECIFIED"
+    }
+  },
   "android.net.wifi.WifiAnnotations.UriScheme": {
     "flag": false,
     "values": {
@@ -9526,6 +10079,14 @@
       "8": "WIFI_STANDARD_11BE"
     }
   },
+  "android.net.wifi.WifiMigration.KeystoreMigrationStatus": {
+    "flag": false,
+    "values": {
+      "0": "KEYSTORE_MIGRATION_SUCCESS_MIGRATION_COMPLETE",
+      "1": "KEYSTORE_MIGRATION_SUCCESS_MIGRATION_NOT_NEEDED",
+      "2": "KEYSTORE_MIGRATION_FAILURE_ENCOUNTERED_EXCEPTION"
+    }
+  },
   "android.net.wifi.WifiMigration.SharedStoreFileId": {
     "flag": false,
     "values": {
@@ -9649,8 +10210,10 @@
       "12": "POWER_COMPONENT_WAKELOCK",
       "13": "POWER_COMPONENT_MEMORY",
       "14": "POWER_COMPONENT_PHONE",
+      "15": "POWER_COMPONENT_AMBIENT_DISPLAY",
       "16": "POWER_COMPONENT_IDLE",
-      "17": "POWER_COMPONENT_REATTRIBUTED_TO_OTHER_CONSUMERS"
+      "17": "POWER_COMPONENT_REATTRIBUTED_TO_OTHER_CONSUMERS",
+      "18": "POWER_COMPONENT_BASE"
     }
   },
   "android.os.BatteryConsumer.PowerModel": {
@@ -9664,7 +10227,7 @@
   "android.os.BatteryConsumer.PowerState": {
     "flag": false,
     "values": {
-      "0": "POWER_STATE_ANY",
+      "0": "POWER_STATE_UNSPECIFIED",
       "1": "POWER_STATE_BATTERY",
       "2": "POWER_STATE_OTHER"
     }
@@ -9672,6 +10235,7 @@
   "android.os.BatteryConsumer.ProcessState": {
     "flag": false,
     "values": {
+      "-1": "PROCESS_STATE_ANY",
       "0": "PROCESS_STATE_UNSPECIFIED",
       "1": "PROCESS_STATE_FOREGROUND",
       "2": "PROCESS_STATE_BACKGROUND",
@@ -9682,7 +10246,7 @@
   "android.os.BatteryConsumer.ScreenState": {
     "flag": false,
     "values": {
-      "0": "SCREEN_STATE_ANY",
+      "0": "SCREEN_STATE_UNSPECIFIED",
       "1": "SCREEN_STATE_ON",
       "2": "SCREEN_STATE_OTHER"
     }
@@ -9781,6 +10345,56 @@
       "7": "BUGREPORT_MODE_ONBOARDING"
     }
   },
+  "android.os.Build.BackportedFixStatus": {
+    "flag": false,
+    "values": {
+      "0": "BACKPORTED_FIX_STATUS_UNKNOWN",
+      "1": "BACKPORTED_FIX_STATUS_FIXED",
+      "2": "BACKPORTED_FIX_STATUS_NOT_APPLICABLE",
+      "3": "BACKPORTED_FIX_STATUS_NOT_FIXED"
+    }
+  },
+  "android.os.Build.SdkIntFull": {
+    "flag": false,
+    "values": {
+      "100000": "BASE",
+      "200000": "BASE_1_1",
+      "300000": "CUPCAKE",
+      "400000": "DONUT",
+      "500000": "ECLAIR",
+      "600000": "ECLAIR_0_1",
+      "700000": "ECLAIR_MR1",
+      "800000": "FROYO",
+      "900000": "GINGERBREAD",
+      "1000000": "GINGERBREAD_MR1",
+      "1100000": "HONEYCOMB",
+      "1200000": "HONEYCOMB_MR1",
+      "1300000": "HONEYCOMB_MR2",
+      "1400000": "ICE_CREAM_SANDWICH",
+      "1500000": "ICE_CREAM_SANDWICH_MR1",
+      "1600000": "JELLY_BEAN",
+      "1700000": "JELLY_BEAN_MR1",
+      "1800000": "JELLY_BEAN_MR2",
+      "1900000": "KITKAT",
+      "2000000": "KITKAT_WATCH",
+      "2100000": "LOLLIPOP",
+      "2200000": "LOLLIPOP_MR1",
+      "2300000": "M",
+      "2400000": "N",
+      "2500000": "N_MR1",
+      "2600000": "O",
+      "2700000": "O_MR1",
+      "2800000": "P",
+      "2900000": "Q",
+      "3000000": "R",
+      "3100000": "S",
+      "3200000": "S_V2",
+      "3300000": "TIRAMISU",
+      "3400000": "UPSIDE_DOWN_CAKE",
+      "3500000": "VANILLA_ICE_CREAM",
+      "1000000000": "BAKLAVA"
+    }
+  },
   "android.os.Bundle.HasBinderStatus": {
     "flag": true,
     "values": {
@@ -9826,6 +10440,13 @@
       "14": "TYPE_USB_PORT"
     }
   },
+  "android.os.CpuHeadroomParams.CpuHeadroomCalculationType": {
+    "flag": false,
+    "values": {
+      "0": "CPU_HEADROOM_CALCULATION_TYPE_MIN",
+      "1": "CPU_HEADROOM_CALCULATION_TYPE_AVERAGE"
+    }
+  },
   "android.os.DropBoxManager.Flags": {
     "flag": true,
     "values": {
@@ -9851,6 +10472,13 @@
       "2048": "MOVE_SELF"
     }
   },
+  "android.os.GpuHeadroomParams.GpuHeadroomCalculationType": {
+    "flag": false,
+    "values": {
+      "0": "GPU_HEADROOM_CALCULATION_TYPE_MIN",
+      "1": "GPU_HEADROOM_CALCULATION_TYPE_AVERAGE"
+    }
+  },
   "android.os.HardwarePropertiesManager.DeviceTemperatureType": {
     "flag": false,
     "values": {
@@ -9875,6 +10503,13 @@
       "0": "STATUS_SUCCESS"
     }
   },
+  "android.os.IBinder.FrozenStateChangeCallback.State": {
+    "flag": false,
+    "values": {
+      "0": "STATE_FROZEN",
+      "1": "STATE_UNFROZEN"
+    }
+  },
   "android.os.IncidentManager.PendingReportFlags": {
     "flag": true,
     "values": {
@@ -10077,7 +10712,8 @@
       "4": "GO_TO_SLEEP_REASON_POWER_BUTTON",
       "10": "GO_TO_SLEEP_REASON_QUIESCENT",
       "6": "GO_TO_SLEEP_REASON_SLEEP_BUTTON",
-      "2": "GO_TO_SLEEP_REASON_TIMEOUT"
+      "2": "GO_TO_SLEEP_REASON_TIMEOUT",
+      "14": "GO_TO_SLEEP_REASON_UNKNOWN"
     }
   },
   "android.os.PowerManager.LocationPowerSaveMode": {
@@ -10286,6 +10922,15 @@
       "5000": "RESUME_ON_REBOOT_REBOOT_ERROR_PROVIDER_PREPARATION_FAILURE"
     }
   },
+  "android.os.RemoteCallbackList.FrozenCalleePolicy": {
+    "flag": false,
+    "values": {
+      "0": "FROZEN_CALLEE_POLICY_UNSET",
+      "1": "FROZEN_CALLEE_POLICY_ENQUEUE_ALL",
+      "2": "FROZEN_CALLEE_POLICY_ENQUEUE_MOST_RECENT",
+      "3": "FROZEN_CALLEE_POLICY_DROP"
+    }
+  },
   "android.os.StrictMode.ThreadPolicyMask": {
     "flag": true,
     "values": {
@@ -10323,6 +10968,7 @@
       "1024": "DETECT_VM_IMPLICIT_DIRECT_BOOT",
       "4096": "DETECT_VM_INCORRECT_CONTEXT_USE",
       "8192": "DETECT_VM_UNSAFE_INTENT_LAUNCH",
+      "16384": "DETECT_VM_BACKGROUND_ACTIVITY_LAUNCH_ABORTED",
       "-2147483648": "PENALTY_GATHER",
       "1073741824": "PENALTY_LOG",
       "536870912": "PENALTY_DIALOG",
@@ -10452,7 +11098,8 @@
       "6": "USER_OPERATION_ERROR_MAX_USERS",
       "7": "USER_OPERATION_ERROR_USER_ACCOUNT_ALREADY_EXISTS",
       "8": "USER_OPERATION_ERROR_DISABLED_USER",
-      "9": "USER_OPERATION_ERROR_PRIVATE_PROFILE"
+      "9": "USER_OPERATION_ERROR_PRIVATE_PROFILE",
+      "10": "USER_OPERATION_ERROR_USER_RESTRICTED"
     }
   },
   "android.os.UserManager.UserRestrictionSource": {
@@ -10473,21 +11120,13 @@
       "4": "SWITCHABILITY_STATUS_SYSTEM_USER_LOCKED"
     }
   },
-  "android.os.VibrationAttributes.Category": {
-    "flag": false,
-    "values": {
-      "0": "CATEGORY_UNKNOWN",
-      "1": "CATEGORY_KEYBOARD"
-    }
-  },
   "android.os.VibrationAttributes.Flag": {
     "flag": true,
     "values": {
       "1": "FLAG_BYPASS_INTERRUPTION_POLICY",
       "2": "FLAG_BYPASS_USER_VIBRATION_INTENSITY_OFF",
       "4": "FLAG_INVALIDATE_SETTINGS_CACHE",
-      "8": "FLAG_PIPELINED_EFFECT",
-      "16": "FLAG_BYPASS_USER_VIBRATION_INTENSITY_SCALE"
+      "8": "FLAG_PIPELINED_EFFECT"
     }
   },
   "android.os.VibrationAttributes.Usage": {
@@ -10502,7 +11141,8 @@
       "49": "USAGE_NOTIFICATION",
       "34": "USAGE_PHYSICAL_EMULATION",
       "33": "USAGE_RINGTONE",
-      "18": "USAGE_TOUCH"
+      "18": "USAGE_TOUCH",
+      "82": "USAGE_IME_FEEDBACK"
     }
   },
   "android.os.VibrationAttributes.UsageClass": {
@@ -10514,6 +11154,13 @@
       "3": "USAGE_CLASS_MEDIA"
     }
   },
+  "android.os.VibrationEffect.Composition.DelayType": {
+    "flag": false,
+    "values": {
+      "0": "DELAY_TYPE_PAUSE",
+      "1": "DELAY_TYPE_RELATIVE_START_OFFSET"
+    }
+  },
   "android.os.VibrationEffect.Composition.PrimitiveType": {
     "flag": false,
     "values": {
@@ -10638,6 +11285,17 @@
       "8": "FLAG_STORAGE_SDK"
     }
   },
+  "android.os.vibrator.VendorVibrationSession.Status": {
+    "flag": false,
+    "values": {
+      "1": "STATUS_SUCCESS",
+      "2": "STATUS_IGNORED",
+      "3": "STATUS_UNSUPPORTED",
+      "4": "STATUS_CANCELED",
+      "0": "STATUS_UNKNOWN",
+      "5": "STATUS_UNKNOWN_ERROR"
+    }
+  },
   "android.os.vibrator.persistence.VibrationXmlParser.Flags": {
     "flag": true,
     "values": {
@@ -10754,6 +11412,15 @@
       "3": "ERROR_INPUT_CLOSED"
     }
   },
+  "android.provider.ContactsContract.RawContacts.DefaultAccount.DefaultAccountAndState.DefaultAccountState": {
+    "flag": false,
+    "values": {
+      "1": "DEFAULT_ACCOUNT_STATE_NOT_SET",
+      "2": "DEFAULT_ACCOUNT_STATE_LOCAL",
+      "3": "DEFAULT_ACCOUNT_STATE_CLOUD",
+      "4": "DEFAULT_ACCOUNT_STATE_SIM"
+    }
+  },
   "android.provider.E2eeContactKeysManager.VerificationState": {
     "flag": false,
     "values": {
@@ -10987,12 +11654,41 @@
       "3": "TYPE_CHALLENGE"
     }
   },
-  "android.security.attestationverification.AttestationVerificationManager.VerificationResult": {
+  "android.security.attestationverification.AttestationVerificationManager.VerificationResultFlags": {
+    "flag": true,
+    "values": {
+      "1": "FLAG_FAILURE_UNKNOWN",
+      "2": "FLAG_FAILURE_UNSUPPORTED_PROFILE",
+      "4": "FLAG_FAILURE_CERTS",
+      "8": "FLAG_FAILURE_LOCAL_BINDING_REQUIREMENTS",
+      "16": "FLAG_FAILURE_KEYSTORE_REQUIREMENTS",
+      "32": "FLAG_FAILURE_BOOT_STATE",
+      "64": "FLAG_FAILURE_PATCH_LEVEL_DIFF"
+    }
+  },
+  "android.security.forensic.ForensicEvent.EventType": {
+    "flag": false,
+    "values": {
+      "0": "SECURITY_EVENT",
+      "1": "NETWORK_EVENT_DNS",
+      "2": "NETWORK_EVENT_CONNECT"
+    }
+  },
+  "android.security.forensic.ForensicManager.ForensicError": {
+    "flag": false,
+    "values": {
+      "0": "ERROR_UNKNOWN",
+      "1": "ERROR_PERMISSION_DENIED",
+      "3": "ERROR_TRANSPORT_UNAVAILABLE",
+      "4": "ERROR_DATA_SOURCE_UNAVAILABLE"
+    }
+  },
+  "android.security.forensic.ForensicManager.ForensicState": {
     "flag": false,
     "values": {
-      "0": "RESULT_UNKNOWN",
-      "1": "RESULT_SUCCESS",
-      "2": "RESULT_FAILURE"
+      "0": "STATE_UNKNOWN",
+      "1": "STATE_DISABLED",
+      "2": "STATE_ENABLED"
     }
   },
   "android.security.identity.CredentialDataResult.Entries.Status": {
@@ -11618,16 +12314,25 @@
       "1024": "FIELD_EXTRA_EFFECTS"
     }
   },
-  "android.service.notification.ZenModeConfig.ConfigChangeOrigin": {
+  "android.service.notification.ZenModeConfig.ConfigOrigin": {
+    "flag": false,
+    "values": {
+      "0": "ORIGIN_UNKNOWN",
+      "1": "ORIGIN_INIT",
+      "2": "ORIGIN_INIT_USER",
+      "3": "ORIGIN_USER_IN_SYSTEMUI",
+      "4": "ORIGIN_APP",
+      "5": "ORIGIN_SYSTEM",
+      "6": "ORIGIN_RESTORE_BACKUP",
+      "7": "ORIGIN_USER_IN_APP"
+    }
+  },
+  "android.service.notification.ZenModeConfig.ZenRule.ConditionOverride": {
     "flag": false,
     "values": {
-      "0": "UPDATE_ORIGIN_UNKNOWN",
-      "1": "UPDATE_ORIGIN_INIT",
-      "2": "UPDATE_ORIGIN_INIT_USER",
-      "3": "UPDATE_ORIGIN_USER",
-      "4": "UPDATE_ORIGIN_APP",
-      "5": "UPDATE_ORIGIN_SYSTEM_OR_SYSTEMUI",
-      "6": "UPDATE_ORIGIN_RESTORE_BACKUP"
+      "0": "OVERRIDE_NONE",
+      "1": "OVERRIDE_ACTIVATE",
+      "2": "OVERRIDE_DEACTIVATE"
     }
   },
   "android.service.notification.ZenModeDiff.ExistenceChange": {
@@ -11754,6 +12459,58 @@
       "4": "ROTATION_RESULT_FAILURE_NOT_SUPPORTED"
     }
   },
+  "android.service.settings.preferences.GetValueResult.ResultCode": {
+    "flag": false,
+    "values": {
+      "0": "RESULT_OK",
+      "1": "RESULT_UNSUPPORTED",
+      "2": "RESULT_UNAVAILABLE",
+      "3": "RESULT_REQUIRE_APP_PERMISSION",
+      "4": "RESULT_DISALLOW",
+      "5": "RESULT_INVALID_REQUEST",
+      "6": "RESULT_INTERNAL_ERROR"
+    }
+  },
+  "android.service.settings.preferences.MetadataResult.ResultCode": {
+    "flag": false,
+    "values": {
+      "0": "RESULT_OK",
+      "1": "RESULT_UNSUPPORTED",
+      "2": "RESULT_INTERNAL_ERROR"
+    }
+  },
+  "android.service.settings.preferences.SetValueResult.ResultCode": {
+    "flag": false,
+    "values": {
+      "0": "RESULT_OK",
+      "1": "RESULT_UNSUPPORTED",
+      "2": "RESULT_DISABLED",
+      "3": "RESULT_RESTRICTED",
+      "4": "RESULT_UNAVAILABLE",
+      "5": "RESULT_REQUIRE_APP_PERMISSION",
+      "6": "RESULT_REQUIRE_USER_CONSENT",
+      "7": "RESULT_DISALLOW",
+      "8": "RESULT_INVALID_REQUEST",
+      "9": "RESULT_INTERNAL_ERROR"
+    }
+  },
+  "android.service.settings.preferences.SettingsPreferenceMetadata.WriteSensitivity": {
+    "flag": false,
+    "values": {
+      "0": "NOT_SENSITIVE",
+      "1": "SENSITIVE",
+      "2": "INTENT_ONLY"
+    }
+  },
+  "android.service.settings.preferences.SettingsPreferenceValue.Type": {
+    "flag": false,
+    "values": {
+      "0": "TYPE_BOOLEAN",
+      "1": "TYPE_LONG",
+      "2": "TYPE_DOUBLE",
+      "3": "TYPE_STRING"
+    }
+  },
   "android.service.settings.suggestions.Suggestion.Flags": {
     "flag": true,
     "values": {
@@ -13323,6 +14080,13 @@
       "5": "CALL_QUALITY_NOT_AVAILABLE"
     }
   },
+  "android.telephony.CarrierConfigManager.CARRIER_ROAMING_NTN_CONNECT_TYPE": {
+    "flag": false,
+    "values": {
+      "0": "CARRIER_ROAMING_NTN_CONNECT_AUTOMATIC",
+      "1": "CARRIER_ROAMING_NTN_CONNECT_MANUAL"
+    }
+  },
   "android.telephony.CarrierConfigManager.Ims.GeolocationPidfAllowedType": {
     "flag": false,
     "values": {
@@ -14386,6 +15150,16 @@
       "2": "LIMIT_BEHAVIOR_THROTTLED"
     }
   },
+  "android.telephony.SubscriptionPlan.SubscriptionStatus": {
+    "flag": false,
+    "values": {
+      "0": "SUBSCRIPTION_STATUS_UNKNOWN",
+      "1": "SUBSCRIPTION_STATUS_ACTIVE",
+      "2": "SUBSCRIPTION_STATUS_INACTIVE",
+      "3": "SUBSCRIPTION_STATUS_TRIAL",
+      "4": "SUBSCRIPTION_STATUS_SUSPENDED"
+    }
+  },
   "android.telephony.TelephonyCallback.TelephonyEvent": {
     "flag": false,
     "values": {
@@ -14430,7 +15204,12 @@
       "39": "EVENT_MEDIA_QUALITY_STATUS_CHANGED",
       "40": "EVENT_EMERGENCY_CALLBACK_MODE_CHANGED",
       "41": "EVENT_SIMULTANEOUS_CELLULAR_CALLING_SUBSCRIPTIONS_CHANGED",
-      "42": "EVENT_CARRIER_ROAMING_NTN_MODE_CHANGED"
+      "42": "EVENT_CARRIER_ROAMING_NTN_MODE_CHANGED",
+      "43": "EVENT_CARRIER_ROAMING_NTN_ELIGIBLE_STATE_CHANGED",
+      "44": "EVENT_CARRIER_ROAMING_NTN_AVAILABLE_SERVICES_CHANGED",
+      "45": "EVENT_CARRIER_ROAMING_NTN_SIGNAL_STRENGTH_CHANGED",
+      "46": "EVENT_SECURITY_ALGORITHMS_CHANGED",
+      "47": "EVENT_CELLULAR_IDENTIFIER_DISCLOSED_CHANGED"
     }
   },
   "android.telephony.TelephonyManager.AllowedNetworkTypesReason": {
@@ -14439,7 +15218,8 @@
       "0": "ALLOWED_NETWORK_TYPES_REASON_USER",
       "1": "ALLOWED_NETWORK_TYPES_REASON_POWER",
       "2": "ALLOWED_NETWORK_TYPES_REASON_CARRIER",
-      "3": "ALLOWED_NETWORK_TYPES_REASON_ENABLE_2G"
+      "3": "ALLOWED_NETWORK_TYPES_REASON_ENABLE_2G",
+      "4": "ALLOWED_NETWORK_TYPES_REASON_TEST"
     }
   },
   "android.telephony.TelephonyManager.AuthType": {
@@ -14928,7 +15708,9 @@
       "8192": "TYPE_BIP",
       "4096": "TYPE_VSIM",
       "16384": "TYPE_ENTERPRISE",
-      "32768": "TYPE_RCS"
+      "32768": "TYPE_RCS",
+      "65536": "TYPE_OEM_PAID",
+      "131072": "TYPE_OEM_PRIVATE"
     }
   },
   "android.telephony.data.ApnSetting.AuthType": {
@@ -16284,7 +17066,8 @@
       "3": "DATAGRAM_TYPE_KEEP_ALIVE",
       "4": "DATAGRAM_TYPE_LAST_SOS_MESSAGE_STILL_NEED_HELP",
       "5": "DATAGRAM_TYPE_LAST_SOS_MESSAGE_NO_HELP_NEEDED",
-      "6": "DATAGRAM_TYPE_SMS"
+      "6": "DATAGRAM_TYPE_SMS",
+      "7": "DATAGRAM_TYPE_CHECK_PENDING_INCOMING_SMS"
     }
   },
   "android.telephony.satellite.SatelliteManager.DeviceHoldPosition": {
@@ -16338,6 +17121,16 @@
       "-1": "SATELLITE_DATAGRAM_TRANSFER_STATE_UNKNOWN"
     }
   },
+  "android.telephony.satellite.SatelliteManager.SatelliteDisallowedReason": {
+    "flag": false,
+    "values": {
+      "0": "SATELLITE_DISALLOWED_REASON_NOT_SUPPORTED",
+      "1": "SATELLITE_DISALLOWED_REASON_NOT_PROVISIONED",
+      "2": "SATELLITE_DISALLOWED_REASON_NOT_IN_ALLOWED_REGION",
+      "3": "SATELLITE_DISALLOWED_REASON_UNSUPPORTED_DEFAULT_MSG_APP",
+      "4": "SATELLITE_DISALLOWED_REASON_LOCATION_DISABLED"
+    }
+  },
   "android.telephony.satellite.SatelliteManager.SatelliteModemState": {
     "flag": false,
     "values": {
@@ -16383,7 +17176,18 @@
       "23": "SATELLITE_RESULT_ILLEGAL_STATE",
       "24": "SATELLITE_RESULT_MODEM_TIMEOUT",
       "25": "SATELLITE_RESULT_LOCATION_DISABLED",
-      "26": "SATELLITE_RESULT_LOCATION_NOT_AVAILABLE"
+      "26": "SATELLITE_RESULT_LOCATION_NOT_AVAILABLE",
+      "27": "SATELLITE_RESULT_EMERGENCY_CALL_IN_PROGRESS",
+      "28": "SATELLITE_RESULT_DISABLE_IN_PROGRESS",
+      "29": "SATELLITE_RESULT_ENABLE_IN_PROGRESS",
+      "30": "SATELLITE_RESULT_NO_VALID_SATELLITE_SUBSCRIPTION"
+    }
+  },
+  "android.telephony.satellite.SatelliteSubscriberInfo.SubscriberIdType": {
+    "flag": false,
+    "values": {
+      "0": "ICCID",
+      "1": "IMSI_MSISDN"
     }
   },
   "android.text.FontConfig.Customization.LocaleFallback.Operation": {
@@ -16632,6 +17436,13 @@
       "9": "COLOR_MODE_DISPLAY_P3"
     }
   },
+  "android.view.Display.FrameRateCategory": {
+    "flag": false,
+    "values": {
+      "0": "FRAME_RATE_CATEGORY_NORMAL",
+      "1": "FRAME_RATE_CATEGORY_HIGH"
+    }
+  },
   "android.view.Display.HdrCapabilities.HdrType": {
     "flag": false,
     "values": {
@@ -16818,7 +17629,8 @@
       "1": "FLAG_SUPPRESS_SCRIM",
       "2": "FLAG_INSETS_ROUNDED_CORNER",
       "4": "FLAG_FORCE_CONSUMING",
-      "8": "FLAG_ANIMATE_RESIZING"
+      "8": "FLAG_ANIMATE_RESIZING",
+      "16": "FLAG_FORCE_CONSUMING_OPAQUE_CAPTION_BAR"
     }
   },
   "android.view.InsetsSource.InternalInsetsSide": {
@@ -16868,6 +17680,349 @@
       "-2147483648": "FLAG_TAINTED"
     }
   },
+  "android.view.KeyEvent.KeyCode": {
+    "flag": false,
+    "values": {
+      "0": "KEYCODE_UNKNOWN",
+      "1": "KEYCODE_SOFT_LEFT",
+      "2": "KEYCODE_SOFT_RIGHT",
+      "3": "KEYCODE_HOME",
+      "4": "KEYCODE_BACK",
+      "5": "KEYCODE_CALL",
+      "6": "KEYCODE_ENDCALL",
+      "7": "KEYCODE_0",
+      "8": "KEYCODE_1",
+      "9": "KEYCODE_2",
+      "10": "KEYCODE_3",
+      "11": "KEYCODE_4",
+      "12": "KEYCODE_5",
+      "13": "KEYCODE_6",
+      "14": "KEYCODE_7",
+      "15": "KEYCODE_8",
+      "16": "KEYCODE_9",
+      "17": "KEYCODE_STAR",
+      "18": "KEYCODE_POUND",
+      "19": "KEYCODE_DPAD_UP",
+      "20": "KEYCODE_DPAD_DOWN",
+      "21": "KEYCODE_DPAD_LEFT",
+      "22": "KEYCODE_DPAD_RIGHT",
+      "23": "KEYCODE_DPAD_CENTER",
+      "24": "KEYCODE_VOLUME_UP",
+      "25": "KEYCODE_VOLUME_DOWN",
+      "26": "KEYCODE_POWER",
+      "27": "KEYCODE_CAMERA",
+      "28": "KEYCODE_CLEAR",
+      "29": "KEYCODE_A",
+      "30": "KEYCODE_B",
+      "31": "KEYCODE_C",
+      "32": "KEYCODE_D",
+      "33": "KEYCODE_E",
+      "34": "KEYCODE_F",
+      "35": "KEYCODE_G",
+      "36": "KEYCODE_H",
+      "37": "KEYCODE_I",
+      "38": "KEYCODE_J",
+      "39": "KEYCODE_K",
+      "40": "KEYCODE_L",
+      "41": "KEYCODE_M",
+      "42": "KEYCODE_N",
+      "43": "KEYCODE_O",
+      "44": "KEYCODE_P",
+      "45": "KEYCODE_Q",
+      "46": "KEYCODE_R",
+      "47": "KEYCODE_S",
+      "48": "KEYCODE_T",
+      "49": "KEYCODE_U",
+      "50": "KEYCODE_V",
+      "51": "KEYCODE_W",
+      "52": "KEYCODE_X",
+      "53": "KEYCODE_Y",
+      "54": "KEYCODE_Z",
+      "55": "KEYCODE_COMMA",
+      "56": "KEYCODE_PERIOD",
+      "57": "KEYCODE_ALT_LEFT",
+      "58": "KEYCODE_ALT_RIGHT",
+      "59": "KEYCODE_SHIFT_LEFT",
+      "60": "KEYCODE_SHIFT_RIGHT",
+      "61": "KEYCODE_TAB",
+      "62": "KEYCODE_SPACE",
+      "63": "KEYCODE_SYM",
+      "64": "KEYCODE_EXPLORER",
+      "65": "KEYCODE_ENVELOPE",
+      "66": "KEYCODE_ENTER",
+      "67": "KEYCODE_DEL",
+      "68": "KEYCODE_GRAVE",
+      "69": "KEYCODE_MINUS",
+      "70": "KEYCODE_EQUALS",
+      "71": "KEYCODE_LEFT_BRACKET",
+      "72": "KEYCODE_RIGHT_BRACKET",
+      "73": "KEYCODE_BACKSLASH",
+      "74": "KEYCODE_SEMICOLON",
+      "75": "KEYCODE_APOSTROPHE",
+      "76": "KEYCODE_SLASH",
+      "77": "KEYCODE_AT",
+      "78": "KEYCODE_NUM",
+      "79": "KEYCODE_HEADSETHOOK",
+      "80": "KEYCODE_FOCUS",
+      "81": "KEYCODE_PLUS",
+      "82": "KEYCODE_MENU",
+      "83": "KEYCODE_NOTIFICATION",
+      "84": "KEYCODE_SEARCH",
+      "85": "KEYCODE_MEDIA_PLAY_PAUSE",
+      "86": "KEYCODE_MEDIA_STOP",
+      "87": "KEYCODE_MEDIA_NEXT",
+      "88": "KEYCODE_MEDIA_PREVIOUS",
+      "89": "KEYCODE_MEDIA_REWIND",
+      "90": "KEYCODE_MEDIA_FAST_FORWARD",
+      "91": "KEYCODE_MUTE",
+      "92": "KEYCODE_PAGE_UP",
+      "93": "KEYCODE_PAGE_DOWN",
+      "94": "KEYCODE_PICTSYMBOLS",
+      "95": "KEYCODE_SWITCH_CHARSET",
+      "96": "KEYCODE_BUTTON_A",
+      "97": "KEYCODE_BUTTON_B",
+      "98": "KEYCODE_BUTTON_C",
+      "99": "KEYCODE_BUTTON_X",
+      "100": "KEYCODE_BUTTON_Y",
+      "101": "KEYCODE_BUTTON_Z",
+      "102": "KEYCODE_BUTTON_L1",
+      "103": "KEYCODE_BUTTON_R1",
+      "104": "KEYCODE_BUTTON_L2",
+      "105": "KEYCODE_BUTTON_R2",
+      "106": "KEYCODE_BUTTON_THUMBL",
+      "107": "KEYCODE_BUTTON_THUMBR",
+      "108": "KEYCODE_BUTTON_START",
+      "109": "KEYCODE_BUTTON_SELECT",
+      "110": "KEYCODE_BUTTON_MODE",
+      "111": "KEYCODE_ESCAPE",
+      "112": "KEYCODE_FORWARD_DEL",
+      "113": "KEYCODE_CTRL_LEFT",
+      "114": "KEYCODE_CTRL_RIGHT",
+      "115": "KEYCODE_CAPS_LOCK",
+      "116": "KEYCODE_SCROLL_LOCK",
+      "117": "KEYCODE_META_LEFT",
+      "118": "KEYCODE_META_RIGHT",
+      "119": "KEYCODE_FUNCTION",
+      "120": "KEYCODE_SYSRQ",
+      "121": "KEYCODE_BREAK",
+      "122": "KEYCODE_MOVE_HOME",
+      "123": "KEYCODE_MOVE_END",
+      "124": "KEYCODE_INSERT",
+      "125": "KEYCODE_FORWARD",
+      "126": "KEYCODE_MEDIA_PLAY",
+      "127": "KEYCODE_MEDIA_PAUSE",
+      "128": "KEYCODE_MEDIA_CLOSE",
+      "129": "KEYCODE_MEDIA_EJECT",
+      "130": "KEYCODE_MEDIA_RECORD",
+      "131": "KEYCODE_F1",
+      "132": "KEYCODE_F2",
+      "133": "KEYCODE_F3",
+      "134": "KEYCODE_F4",
+      "135": "KEYCODE_F5",
+      "136": "KEYCODE_F6",
+      "137": "KEYCODE_F7",
+      "138": "KEYCODE_F8",
+      "139": "KEYCODE_F9",
+      "140": "KEYCODE_F10",
+      "141": "KEYCODE_F11",
+      "142": "KEYCODE_F12",
+      "143": "KEYCODE_NUM_LOCK",
+      "144": "KEYCODE_NUMPAD_0",
+      "145": "KEYCODE_NUMPAD_1",
+      "146": "KEYCODE_NUMPAD_2",
+      "147": "KEYCODE_NUMPAD_3",
+      "148": "KEYCODE_NUMPAD_4",
+      "149": "KEYCODE_NUMPAD_5",
+      "150": "KEYCODE_NUMPAD_6",
+      "151": "KEYCODE_NUMPAD_7",
+      "152": "KEYCODE_NUMPAD_8",
+      "153": "KEYCODE_NUMPAD_9",
+      "154": "KEYCODE_NUMPAD_DIVIDE",
+      "155": "KEYCODE_NUMPAD_MULTIPLY",
+      "156": "KEYCODE_NUMPAD_SUBTRACT",
+      "157": "KEYCODE_NUMPAD_ADD",
+      "158": "KEYCODE_NUMPAD_DOT",
+      "159": "KEYCODE_NUMPAD_COMMA",
+      "160": "KEYCODE_NUMPAD_ENTER",
+      "161": "KEYCODE_NUMPAD_EQUALS",
+      "162": "KEYCODE_NUMPAD_LEFT_PAREN",
+      "163": "KEYCODE_NUMPAD_RIGHT_PAREN",
+      "164": "KEYCODE_VOLUME_MUTE",
+      "165": "KEYCODE_INFO",
+      "166": "KEYCODE_CHANNEL_UP",
+      "167": "KEYCODE_CHANNEL_DOWN",
+      "168": "KEYCODE_ZOOM_IN",
+      "169": "KEYCODE_ZOOM_OUT",
+      "170": "KEYCODE_TV",
+      "171": "KEYCODE_WINDOW",
+      "172": "KEYCODE_GUIDE",
+      "173": "KEYCODE_DVR",
+      "174": "KEYCODE_BOOKMARK",
+      "175": "KEYCODE_CAPTIONS",
+      "176": "KEYCODE_SETTINGS",
+      "177": "KEYCODE_TV_POWER",
+      "178": "KEYCODE_TV_INPUT",
+      "179": "KEYCODE_STB_POWER",
+      "180": "KEYCODE_STB_INPUT",
+      "181": "KEYCODE_AVR_POWER",
+      "182": "KEYCODE_AVR_INPUT",
+      "183": "KEYCODE_PROG_RED",
+      "184": "KEYCODE_PROG_GREEN",
+      "185": "KEYCODE_PROG_YELLOW",
+      "186": "KEYCODE_PROG_BLUE",
+      "187": "KEYCODE_APP_SWITCH",
+      "188": "KEYCODE_BUTTON_1",
+      "189": "KEYCODE_BUTTON_2",
+      "190": "KEYCODE_BUTTON_3",
+      "191": "KEYCODE_BUTTON_4",
+      "192": "KEYCODE_BUTTON_5",
+      "193": "KEYCODE_BUTTON_6",
+      "194": "KEYCODE_BUTTON_7",
+      "195": "KEYCODE_BUTTON_8",
+      "196": "KEYCODE_BUTTON_9",
+      "197": "KEYCODE_BUTTON_10",
+      "198": "KEYCODE_BUTTON_11",
+      "199": "KEYCODE_BUTTON_12",
+      "200": "KEYCODE_BUTTON_13",
+      "201": "KEYCODE_BUTTON_14",
+      "202": "KEYCODE_BUTTON_15",
+      "203": "KEYCODE_BUTTON_16",
+      "204": "KEYCODE_LANGUAGE_SWITCH",
+      "205": "KEYCODE_MANNER_MODE",
+      "206": "KEYCODE_3D_MODE",
+      "207": "KEYCODE_CONTACTS",
+      "208": "KEYCODE_CALENDAR",
+      "209": "KEYCODE_MUSIC",
+      "210": "KEYCODE_CALCULATOR",
+      "211": "KEYCODE_ZENKAKU_HANKAKU",
+      "212": "KEYCODE_EISU",
+      "213": "KEYCODE_MUHENKAN",
+      "214": "KEYCODE_HENKAN",
+      "215": "KEYCODE_KATAKANA_HIRAGANA",
+      "216": "KEYCODE_YEN",
+      "217": "KEYCODE_RO",
+      "218": "KEYCODE_KANA",
+      "219": "KEYCODE_ASSIST",
+      "220": "KEYCODE_BRIGHTNESS_DOWN",
+      "221": "KEYCODE_BRIGHTNESS_UP",
+      "222": "KEYCODE_MEDIA_AUDIO_TRACK",
+      "223": "KEYCODE_SLEEP",
+      "224": "KEYCODE_WAKEUP",
+      "225": "KEYCODE_PAIRING",
+      "226": "KEYCODE_MEDIA_TOP_MENU",
+      "227": "KEYCODE_11",
+      "228": "KEYCODE_12",
+      "229": "KEYCODE_LAST_CHANNEL",
+      "230": "KEYCODE_TV_DATA_SERVICE",
+      "231": "KEYCODE_VOICE_ASSIST",
+      "232": "KEYCODE_TV_RADIO_SERVICE",
+      "233": "KEYCODE_TV_TELETEXT",
+      "234": "KEYCODE_TV_NUMBER_ENTRY",
+      "235": "KEYCODE_TV_TERRESTRIAL_ANALOG",
+      "236": "KEYCODE_TV_TERRESTRIAL_DIGITAL",
+      "237": "KEYCODE_TV_SATELLITE",
+      "238": "KEYCODE_TV_SATELLITE_BS",
+      "239": "KEYCODE_TV_SATELLITE_CS",
+      "240": "KEYCODE_TV_SATELLITE_SERVICE",
+      "241": "KEYCODE_TV_NETWORK",
+      "242": "KEYCODE_TV_ANTENNA_CABLE",
+      "243": "KEYCODE_TV_INPUT_HDMI_1",
+      "244": "KEYCODE_TV_INPUT_HDMI_2",
+      "245": "KEYCODE_TV_INPUT_HDMI_3",
+      "246": "KEYCODE_TV_INPUT_HDMI_4",
+      "247": "KEYCODE_TV_INPUT_COMPOSITE_1",
+      "248": "KEYCODE_TV_INPUT_COMPOSITE_2",
+      "249": "KEYCODE_TV_INPUT_COMPONENT_1",
+      "250": "KEYCODE_TV_INPUT_COMPONENT_2",
+      "251": "KEYCODE_TV_INPUT_VGA_1",
+      "252": "KEYCODE_TV_AUDIO_DESCRIPTION",
+      "253": "KEYCODE_TV_AUDIO_DESCRIPTION_MIX_UP",
+      "254": "KEYCODE_TV_AUDIO_DESCRIPTION_MIX_DOWN",
+      "255": "KEYCODE_TV_ZOOM_MODE",
+      "256": "KEYCODE_TV_CONTENTS_MENU",
+      "257": "KEYCODE_TV_MEDIA_CONTEXT_MENU",
+      "258": "KEYCODE_TV_TIMER_PROGRAMMING",
+      "259": "KEYCODE_HELP",
+      "260": "KEYCODE_NAVIGATE_PREVIOUS",
+      "261": "KEYCODE_NAVIGATE_NEXT",
+      "262": "KEYCODE_NAVIGATE_IN",
+      "263": "KEYCODE_NAVIGATE_OUT",
+      "264": "KEYCODE_STEM_PRIMARY",
+      "265": "KEYCODE_STEM_1",
+      "266": "KEYCODE_STEM_2",
+      "267": "KEYCODE_STEM_3",
+      "268": "KEYCODE_DPAD_UP_LEFT",
+      "269": "KEYCODE_DPAD_DOWN_LEFT",
+      "270": "KEYCODE_DPAD_UP_RIGHT",
+      "271": "KEYCODE_DPAD_DOWN_RIGHT",
+      "272": "KEYCODE_MEDIA_SKIP_FORWARD",
+      "273": "KEYCODE_MEDIA_SKIP_BACKWARD",
+      "274": "KEYCODE_MEDIA_STEP_FORWARD",
+      "275": "KEYCODE_MEDIA_STEP_BACKWARD",
+      "276": "KEYCODE_SOFT_SLEEP",
+      "277": "KEYCODE_CUT",
+      "278": "KEYCODE_COPY",
+      "279": "KEYCODE_PASTE",
+      "280": "KEYCODE_SYSTEM_NAVIGATION_UP",
+      "281": "KEYCODE_SYSTEM_NAVIGATION_DOWN",
+      "282": "KEYCODE_SYSTEM_NAVIGATION_LEFT",
+      "283": "KEYCODE_SYSTEM_NAVIGATION_RIGHT",
+      "284": "KEYCODE_ALL_APPS",
+      "285": "KEYCODE_REFRESH",
+      "286": "KEYCODE_THUMBS_UP",
+      "287": "KEYCODE_THUMBS_DOWN",
+      "288": "KEYCODE_PROFILE_SWITCH",
+      "289": "KEYCODE_VIDEO_APP_1",
+      "290": "KEYCODE_VIDEO_APP_2",
+      "291": "KEYCODE_VIDEO_APP_3",
+      "292": "KEYCODE_VIDEO_APP_4",
+      "293": "KEYCODE_VIDEO_APP_5",
+      "294": "KEYCODE_VIDEO_APP_6",
+      "295": "KEYCODE_VIDEO_APP_7",
+      "296": "KEYCODE_VIDEO_APP_8",
+      "297": "KEYCODE_FEATURED_APP_1",
+      "298": "KEYCODE_FEATURED_APP_2",
+      "299": "KEYCODE_FEATURED_APP_3",
+      "300": "KEYCODE_FEATURED_APP_4",
+      "301": "KEYCODE_DEMO_APP_1",
+      "302": "KEYCODE_DEMO_APP_2",
+      "303": "KEYCODE_DEMO_APP_3",
+      "304": "KEYCODE_DEMO_APP_4",
+      "305": "KEYCODE_KEYBOARD_BACKLIGHT_DOWN",
+      "306": "KEYCODE_KEYBOARD_BACKLIGHT_UP",
+      "307": "KEYCODE_KEYBOARD_BACKLIGHT_TOGGLE",
+      "308": "KEYCODE_STYLUS_BUTTON_PRIMARY",
+      "309": "KEYCODE_STYLUS_BUTTON_SECONDARY",
+      "310": "KEYCODE_STYLUS_BUTTON_TERTIARY",
+      "311": "KEYCODE_STYLUS_BUTTON_TAIL",
+      "312": "KEYCODE_RECENT_APPS",
+      "313": "KEYCODE_MACRO_1",
+      "314": "KEYCODE_MACRO_2",
+      "315": "KEYCODE_MACRO_3",
+      "316": "KEYCODE_MACRO_4",
+      "317": "KEYCODE_EMOJI_PICKER",
+      "318": "KEYCODE_SCREENSHOT",
+      "319": "KEYCODE_DICTATE",
+      "320": "KEYCODE_NEW",
+      "321": "KEYCODE_CLOSE",
+      "322": "KEYCODE_DO_NOT_DISTURB",
+      "323": "KEYCODE_PRINT",
+      "324": "KEYCODE_LOCK",
+      "325": "KEYCODE_FULLSCREEN",
+      "326": "KEYCODE_F13",
+      "327": "KEYCODE_F14",
+      "328": "KEYCODE_F15",
+      "329": "KEYCODE_F16",
+      "330": "KEYCODE_F17",
+      "331": "KEYCODE_F18",
+      "332": "KEYCODE_F19",
+      "333": "KEYCODE_F20",
+      "334": "KEYCODE_F21",
+      "335": "KEYCODE_F22",
+      "336": "KEYCODE_F23",
+      "337": "KEYCODE_F24"
+    }
+  },
   "android.view.KeyEvent.MetaState": {
     "flag": true,
     "values": {
@@ -17032,9 +18187,10 @@
     "values": {
       "0": "POINTER_ICON_VECTOR_STYLE_FILL_BLACK",
       "1": "POINTER_ICON_VECTOR_STYLE_FILL_GREEN",
-      "2": "POINTER_ICON_VECTOR_STYLE_FILL_YELLOW",
+      "2": "POINTER_ICON_VECTOR_STYLE_FILL_RED",
       "3": "POINTER_ICON_VECTOR_STYLE_FILL_PINK",
-      "4": "POINTER_ICON_VECTOR_STYLE_FILL_BLUE"
+      "4": "POINTER_ICON_VECTOR_STYLE_FILL_BLUE",
+      "5": "POINTER_ICON_VECTOR_STYLE_FILL_PURPLE"
     }
   },
   "android.view.PointerIcon.PointerIconVectorStyleStroke": {
@@ -17162,12 +18318,9 @@
     "flag": true,
     "values": {
       "0": "JANK_NONE",
-      "1": "DISPLAY_HAL",
-      "2": "JANK_SURFACEFLINGER_DEADLINE_MISSED",
-      "4": "JANK_SURFACEFLINGER_GPU_DEADLINE_MISSED",
-      "8": "JANK_APP_DEADLINE_MISSED",
-      "16": "PREDICTION_ERROR",
-      "32": "SURFACE_FLINGER_SCHEDULING"
+      "1": "JANK_COMPOSER",
+      "2": "JANK_APPLICATION",
+      "4": "JANK_OTHER"
     }
   },
   "android.view.SurfaceView.SurfaceLifecycleStrategy": {
@@ -17597,6 +18750,7 @@
       "4194304": "PRIVATE_FLAG_NOT_MAGNIFIABLE",
       "16777216": "PRIVATE_FLAG_COLOR_SPACE_AGNOSTIC",
       "33554432": "PRIVATE_FLAG_CONSUME_IME_INSETS",
+      "67108864": "PRIVATE_FLAG_OPT_OUT_EDGE_TO_EDGE",
       "268435456": "PRIVATE_FLAG_FIT_INSETS_CONTROLLED",
       "536870912": "PRIVATE_FLAG_TRUSTED_OVERLAY",
       "1073741824": "PRIVATE_FLAG_INSET_PARENT_FRAME_BY_IME",
@@ -17814,6 +18968,8 @@
       "10": "TRANSIT_PIP",
       "11": "TRANSIT_WAKE",
       "12": "TRANSIT_SLEEP",
+      "13": "TRANSIT_PREPARE_BACK_NAVIGATION",
+      "14": "TRANSIT_CLOSE_PREPARE_BACK_NAVIGATION",
       "1000": "TRANSIT_FIRST_CUSTOM"
     }
   },
@@ -17849,7 +19005,8 @@
       "512": "CONTENT_CHANGE_TYPE_DRAG_CANCELLED",
       "1024": "CONTENT_CHANGE_TYPE_CONTENT_INVALID",
       "2048": "CONTENT_CHANGE_TYPE_ERROR",
-      "4096": "CONTENT_CHANGE_TYPE_ENABLED"
+      "4096": "CONTENT_CHANGE_TYPE_ENABLED",
+      "32768": "CONTENT_CHANGE_TYPE_SUPPLEMENTAL_DESCRIPTION"
     }
   },
   "android.view.accessibility.AccessibilityEvent.EventType": {
@@ -17926,6 +19083,23 @@
       "4": "FLASH_REASON_PREVIEW"
     }
   },
+  "android.view.accessibility.AccessibilityNodeInfo.CheckedState": {
+    "flag": false,
+    "values": {
+      "0": "CHECKED_STATE_FALSE",
+      "1": "CHECKED_STATE_TRUE",
+      "2": "CHECKED_STATE_PARTIAL"
+    }
+  },
+  "android.view.accessibility.AccessibilityNodeInfo.ExpandedState": {
+    "flag": false,
+    "values": {
+      "0": "EXPANDED_STATE_UNDEFINED",
+      "1": "EXPANDED_STATE_COLLAPSED",
+      "2": "EXPANDED_STATE_PARTIAL",
+      "3": "EXPANDED_STATE_FULL"
+    }
+  },
   "android.view.accessibility.AccessibilityNodeInfo.PrefetchingStrategy": {
     "flag": true,
     "values": {
@@ -18170,7 +19344,9 @@
       "62": "PHASE_WM_NOTIFY_IME_VISIBILITY_CHANGED_FROM_CLIENT",
       "63": "PHASE_WM_POSTING_CHANGED_IME_VISIBILITY",
       "64": "PHASE_WM_INVOKING_IME_REQUESTED_LISTENER",
-      "65": "PHASE_CLIENT_ALREADY_HIDDEN"
+      "65": "PHASE_CLIENT_ALREADY_HIDDEN",
+      "66": "PHASE_CLIENT_VIEW_HANDLER_AVAILABLE",
+      "67": "PHASE_SERVER_UPDATE_CLIENT_VISIBILITY"
     }
   },
   "android.view.inputmethod.ImeTracker.Status": {
@@ -18479,6 +19655,22 @@
       "1": "RECORD_CONTINUOUSLY"
     }
   },
+  "android.webkit.WebChromeClient.FileChooserParams.Mode": {
+    "flag": false,
+    "values": {
+      "0": "MODE_OPEN",
+      "1": "MODE_OPEN_MULTIPLE",
+      "2": "MODE_OPEN_FOLDER",
+      "3": "MODE_SAVE"
+    }
+  },
+  "android.webkit.WebChromeClient.FileChooserParams.PermissionMode": {
+    "flag": false,
+    "values": {
+      "0": "PERMISSION_MODE_READ",
+      "1": "PERMISSION_MODE_READ_WRITE"
+    }
+  },
   "android.webkit.WebSettings.CacheMode": {
     "flag": false,
     "values": {
@@ -18749,7 +19941,8 @@
     "flag": false,
     "values": {
       "0": "EDGE_LEFT",
-      "1": "EDGE_RIGHT"
+      "1": "EDGE_RIGHT",
+      "2": "EDGE_NONE"
     }
   },
   "android.window.BackNavigationInfo.BackTargetType": {
@@ -18767,7 +19960,8 @@
     "flag": false,
     "values": {
       "0": "PRIORITY_DEFAULT",
-      "1000000": "PRIORITY_OVERLAY"
+      "1000000": "PRIORITY_OVERLAY",
+      "-2": "PRIORITY_SYSTEM_NAVIGATION_OBSERVER"
     }
   },
   "android.window.SplashScreen.SplashScreenStyle": {
@@ -18812,6 +20006,14 @@
       "3": "DEFER_MODE_NONE"
     }
   },
+  "android.window.SystemOverrideOnBackInvokedCallback.OverrideBehavior": {
+    "flag": false,
+    "values": {
+      "0": "OVERRIDE_UNDEFINED",
+      "1": "OVERRIDE_MOVE_TASK_TO_BACK",
+      "2": "OVERRIDE_FINISH_AND_REMOVE_TASK"
+    }
+  },
   "android.window.SystemPerformanceHinter.HintFlags": {
     "flag": false,
     "values": {
@@ -18826,9 +20028,10 @@
       "-30000": "TASK_CHILD_LAYER_TASK_BACKGROUND",
       "-20000": "TASK_CHILD_LAYER_LETTERBOX_BACKGROUND",
       "10000": "TASK_CHILD_LAYER_COMPAT_UI",
-      "20000": "TASK_CHILD_LAYER_WINDOW_DECORATIONS",
-      "30000": "TASK_CHILD_LAYER_RECENTS_ANIMATION_PIP_OVERLAY",
-      "40000": "TASK_CHILD_LAYER_TASK_OVERLAY",
+      "20000": "TASK_CHILD_LAYER_SETTINGS_DIALOG",
+      "30000": "TASK_CHILD_LAYER_WINDOW_DECORATIONS",
+      "40000": "TASK_CHILD_LAYER_RECENTS_ANIMATION_PIP_OVERLAY",
+      "50000": "TASK_CHILD_LAYER_TASK_OVERLAY",
       "60000": "TASK_CHILD_LAYER_RESIZE_VEIL"
     }
   },
@@ -18884,7 +20087,8 @@
     "values": {
       "1": "REFERENCE_BROADCAST",
       "2": "REFERENCE_CACHE",
-      "4": "REFERENCE_PERSIST"
+      "4": "REFERENCE_PERSIST",
+      "8": "REFERENCE_CONTENT_SUGGESTION"
     }
   },
   "android.window.TransitionFilter.ContainerOrder": {
@@ -18920,7 +20124,8 @@
       "1048576": "FLAG_MOVED_TO_TOP",
       "2097152": "FLAG_SYNC",
       "4194304": "FLAG_CONFIG_AT_END",
-      "8388608": "FLAG_FIRST_CUSTOM"
+      "8388608": "FLAG_IS_TASK_DISPLAY_AREA",
+      "16777216": "FLAG_FIRST_CUSTOM"
     }
   },
   "android.window.TransitionInfo.TransitionMode": {
@@ -18983,7 +20188,9 @@
       "4": "TRIPLETAP",
       "8": "TWOFINGER_DOUBLETAP",
       "16": "QUICK_SETTINGS",
-      "32": "GESTURE"
+      "32": "GESTURE",
+      "64": "KEY_GESTURE",
+      "127": "ALL"
     }
   },
   "com.android.internal.accessibility.util.AccessibilityUtils.A11yTextChangeType": {
@@ -19036,7 +20243,8 @@
     "values": {
       "2": "LAUNCH_REASON_PRIVATE_SPACE_SETTINGS_ACCESS",
       "1": "LAUNCH_REASON_DISABLE_QUIET_MODE",
-      "-1": "LAUNCH_REASON_UNKNOWN"
+      "-1": "LAUNCH_REASON_UNKNOWN",
+      "3": "LAUNCH_REASON_RESET_PRIVATE_SPACE_SETTINGS_ACCESS"
     }
   },
   "com.android.internal.compat.ChangeReporter.Source": {
@@ -19309,7 +20517,9 @@
       "113": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_OPEN",
       "114": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_CLOSE",
       "115": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_APP_LAUNCH",
-      "116": "CUJ_DESKTOP_MODE_ENTER_APP_HANDLE_DRAG_RELEASE"
+      "116": "CUJ_DESKTOP_MODE_ENTER_APP_HANDLE_DRAG_RELEASE",
+      "117": "CUJ_DESKTOP_MODE_EXIT_MODE_ON_LAST_WINDOW_CLOSE",
+      "118": "CUJ_DESKTOP_MODE_SNAP_RESIZE"
     }
   },
   "com.android.internal.jank.DisplayRefreshRate.RefreshRate": {
@@ -19369,6 +20579,14 @@
       "4": "TIMED_OUT"
     }
   },
+  "com.android.internal.pm.pkg.component.ParsedMainComponentImpl.IntentMatchingFlags": {
+    "flag": false,
+    "values": {
+      "1": "INTENT_MATCHING_FLAGS_NONE",
+      "2": "INTENT_MATCHING_FLAGS_ENFORCE_INTENT_FILTER",
+      "4": "INTENT_MATCHING_FLAGS_ALLOW_NULL_ACTION"
+    }
+  },
   "com.android.internal.pm.pkg.component.ParsedUsesPermission.UsesPermissionFlags": {
     "flag": true,
     "values": {
diff --git a/tools/winscope/src/logging/analytics.ts b/tools/winscope/src/logging/analytics.ts
index c0b81d886..405da520b 100644
--- a/tools/winscope/src/logging/analytics.ts
+++ b/tools/winscope/src/logging/analytics.ts
@@ -33,6 +33,10 @@ export class Analytics {
   private static PROXY_ERROR = 'proxy_error';
   private static PROXY_SERVER_NOT_FOUND = 'proxy_server_not_found';
   private static PROXY_NO_FILES_FOUND = 'proxy_no_files_found';
+  private static TP_QUERY_EXECUTION_TIME = 'tp_query_execution_time';
+  private static TP_QUERY_REQUESTED = 'tp_query_requested';
+  private static TP_QUERY_FAILED = 'tp_query_failed';
+  private static TP_QUERY_SAVED = 'tp_query_saved';
   private static RECT_SETTINGS = 'rect_settings';
   private static REFRESH_DUMPS = 'refresh_dumps';
   private static TIME_BOOKMARK = 'time_bookmark';
@@ -172,6 +176,25 @@ export class Analytics {
     }
   };
 
+  static TraceSearch = class {
+    static logQueryExecutionTime(value: number) {
+      Analytics.doLogEvent(Analytics.TP_QUERY_EXECUTION_TIME, {
+        value,
+      } as Gtag.CustomParams);
+    }
+    static logQueryFailure() {
+      Analytics.doLogEvent(Analytics.TP_QUERY_FAILED);
+    }
+    static logQueryRequested(type: 'new' | 'saved' | 'recent') {
+      Analytics.doLogEvent(Analytics.TP_QUERY_REQUESTED, {
+        type,
+      } as Gtag.CustomParams);
+    }
+    static logQuerySaved() {
+      Analytics.doLogEvent(Analytics.TP_QUERY_SAVED);
+    }
+  };
+
   static Tracing = class {
     static logTraceLoaded(parser: Parser<object>) {
       Analytics.doLogEvent(Analytics.TRACING_LOADED_EVENT, {
diff --git a/tools/winscope/src/material-theme.scss b/tools/winscope/src/material-theme.scss
index 1a4ab0ac1..ac48b89e7 100644
--- a/tools/winscope/src/material-theme.scss
+++ b/tools/winscope/src/material-theme.scss
@@ -48,12 +48,15 @@ $dark-theme: mat.define-dark-theme((
   )
 ));
 
-@mixin background-color($theme) {
+@mixin background-color($theme, $contrast-theme) {
   $config: mat.get-color-config($theme);
   $background: map.get($config, background);
 
+  $contrast-config: mat.get-color-config($contrast-theme);
+  $contrast-background: map.get($contrast-config, background);
   & {
     --background-color: #{mat.get-color-from-palette($background, background)};
+    --contrast-background-color: #{mat.get-color-from-palette($contrast-background, background)};
   }
 }
 
@@ -79,7 +82,7 @@ $dark-theme: mat.define-dark-theme((
 
 body:not(.dark-mode) {
   --added-element-color: #D8EAC5;
-  @include background-color($light-theme);
+  @include background-color($light-theme, $dark-theme);
   --blue-text-color: #{map.get(mat.$indigo-palette, A200)};
   @include border-color($light-theme);
   --card-title-background-color: #f1f1f1;
@@ -114,7 +117,7 @@ body:not(.dark-mode) {
 body.dark-mode {
   @include mat.all-component-colors($dark-theme);
   --added-element-color: #6D8358;
-  @include background-color($dark-theme);
+  @include background-color($dark-theme, $light-theme);
   --blue-text-color: #b8e3fd;
   @include border-color($dark-theme);
   --card-title-background-color: #343434;
diff --git a/tools/winscope/src/messaging/user_warnings.ts b/tools/winscope/src/messaging/user_warnings.ts
index 2dd1fe4d0..703b1a660 100644
--- a/tools/winscope/src/messaging/user_warnings.ts
+++ b/tools/winscope/src/messaging/user_warnings.ts
@@ -236,6 +236,20 @@ export class ProxyTraceTimeout extends UserWarning {
   }
 }
 
+export class ProxyTracingWarnings extends UserWarning {
+  constructor(private readonly warnings: string[]) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'proxy tracing warnings';
+  }
+
+  getMessage(): string {
+    return `Trace collection warning: ${this.warnings.join(', ')}`;
+  }
+}
+
 export class ProxyTracingErrors extends UserWarning {
   constructor(private readonly errorMessages: string[]) {
     super();
@@ -246,7 +260,7 @@ export class ProxyTracingErrors extends UserWarning {
   }
 
   getMessage(): string {
-    return `Errors occurred during tracing: ${this.errorMessages.join(', ')}`;
+    return `Trace collection errors: ${this.errorMessages.join(', ')}`;
   }
 }
 
@@ -260,8 +274,8 @@ export class MissingLayerIds extends UserWarning {
   }
 }
 
-export class DuplicateLayerId extends UserWarning {
-  constructor(private readonly layerId: string) {
+export class DuplicateLayerIds extends UserWarning {
+  constructor(private readonly layerIds: number[]) {
     super();
   }
 
@@ -270,7 +284,9 @@ export class DuplicateLayerId extends UserWarning {
   }
 
   getMessage(): string {
-    return `Duplicate SF layer id ${this.layerId} found - adding it as "Duplicate" to the hierarchy`;
+    const optionalPlural = this.layerIds.length > 1 ? 's' : '';
+    const layerIds = this.layerIds.join(', ');
+    return `Duplicate SF layer id${optionalPlural} ${layerIds} found - adding as "Duplicate" to the hierarchy`;
   }
 }
 
@@ -294,3 +310,17 @@ export class CannotParseAllTransitions extends UserWarning {
     return 'Cannot parse all transitions. Some may be missing in Transitions viewer.';
   }
 }
+
+export class TraceSearchQueryFailed extends UserWarning {
+  constructor(private readonly errorMessage: string) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'trace search query failed';
+  }
+
+  getMessage(): string {
+    return `Search query failed: ${this.errorMessage}`;
+  }
+}
diff --git a/tools/winscope/src/messaging/winscope_event.ts b/tools/winscope/src/messaging/winscope_event.ts
index e0982a6f8..4c693464c 100644
--- a/tools/winscope/src/messaging/winscope_event.ts
+++ b/tools/winscope/src/messaging/winscope_event.ts
@@ -43,6 +43,13 @@ export enum WinscopeEventType {
   NO_TRACE_TARGETS_SELECTED,
   FILTER_PRESET_SAVE_REQUEST,
   FILTER_PRESET_APPLY_REQUEST,
+  TRACE_SEARCH_REQUEST,
+  TRACE_SEARCH_FAILED,
+  TRACE_SEARCH_COMPLETED,
+  TRACE_ADD_REQUEST,
+  TRACE_REMOVE_REQUEST,
+  INITIALIZE_TRACE_SEARCH_REQUEST,
+  TRACE_SEARCH_INITIALIZED,
 }
 
 interface TypeMap {
@@ -66,6 +73,13 @@ interface TypeMap {
   [WinscopeEventType.NO_TRACE_TARGETS_SELECTED]: NoTraceTargetsSelected;
   [WinscopeEventType.FILTER_PRESET_SAVE_REQUEST]: FilterPresetSaveRequest;
   [WinscopeEventType.FILTER_PRESET_APPLY_REQUEST]: FilterPresetApplyRequest;
+  [WinscopeEventType.TRACE_SEARCH_REQUEST]: TraceSearchRequest;
+  [WinscopeEventType.TRACE_SEARCH_FAILED]: TraceSearchFailed;
+  [WinscopeEventType.TRACE_ADD_REQUEST]: TraceAddRequest;
+  [WinscopeEventType.TRACE_REMOVE_REQUEST]: TraceRemoveRequest;
+  [WinscopeEventType.INITIALIZE_TRACE_SEARCH_REQUEST]: InitializeTraceSearchRequest;
+  [WinscopeEventType.TRACE_SEARCH_INITIALIZED]: TraceSearchInitialized;
+  [WinscopeEventType.TRACE_SEARCH_COMPLETED]: TraceSearchCompleted;
 }
 
 export abstract class WinscopeEvent {
@@ -143,7 +157,9 @@ export class TabbedViewSwitched extends WinscopeEvent {
 
   constructor(view: View) {
     super();
-    assertTrue(view.type === ViewType.TAB);
+    assertTrue(
+      view.type === ViewType.TRACE_TAB || view.type === ViewType.GLOBAL_SEARCH,
+    );
     this.newFocusedView = view;
   }
 }
@@ -237,3 +253,44 @@ export class FilterPresetApplyRequest extends WinscopeEvent {
     super();
   }
 }
+
+export class TraceSearchRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_SEARCH_REQUEST;
+  constructor(readonly query: string) {
+    super();
+  }
+}
+
+export class TraceSearchFailed extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_SEARCH_FAILED;
+}
+
+export class TraceAddRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_ADD_REQUEST;
+  constructor(readonly trace: Trace<object>) {
+    super();
+  }
+}
+
+export class TraceRemoveRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_REMOVE_REQUEST;
+  constructor(readonly trace: Trace<object>) {
+    super();
+  }
+}
+
+export class InitializeTraceSearchRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.INITIALIZE_TRACE_SEARCH_REQUEST;
+}
+
+export class TraceSearchInitialized extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_SEARCH_INITIALIZED;
+
+  constructor(readonly views: string[]) {
+    super();
+  }
+}
+
+export class TraceSearchCompleted extends WinscopeEvent {
+  override readonly type = WinscopeEventType.TRACE_SEARCH_COMPLETED;
+}
diff --git a/tools/winscope/src/parsers/legacy/abstract_parser.ts b/tools/winscope/src/parsers/legacy/abstract_parser.ts
index cf14d4531..cec8e4024 100644
--- a/tools/winscope/src/parsers/legacy/abstract_parser.ts
+++ b/tools/winscope/src/parsers/legacy/abstract_parser.ts
@@ -25,6 +25,7 @@ import {
 import {AbsoluteEntryIndex, EntriesRange} from 'trace/index_types';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
+import {TraceMetadata} from 'trace/trace_metadata';
 import {TraceType} from 'trace/trace_type';
 import {ParsingUtils} from './parsing_utils';
 
@@ -35,15 +36,21 @@ export abstract class AbstractParser<T extends object = object>
   protected traceFile: TraceFile;
   protected decodedEntries: any[] = [];
   protected timestampConverter: ParserTimestampConverter;
+  protected readonly metadata: TraceMetadata | undefined;
 
   protected abstract getMagicNumber(): undefined | number[];
-  protected abstract decodeTrace(trace: Uint8Array): any[];
+  protected abstract decodeTrace(trace: Uint8Array): any[] | Promise<any[]>;
   protected abstract getTimestamp(decodedEntry: any): Timestamp;
   protected abstract processDecodedEntry(index: number, decodedEntry: any): any;
 
-  constructor(trace: TraceFile, timestampConverter: ParserTimestampConverter) {
+  constructor(
+    trace: TraceFile,
+    timestampConverter: ParserTimestampConverter,
+    metadata?: TraceMetadata,
+  ) {
     this.traceFile = trace;
     this.timestampConverter = timestampConverter;
+    this.metadata = metadata;
   }
 
   async parse() {
@@ -52,7 +59,7 @@ export abstract class AbstractParser<T extends object = object>
       traceBuffer,
       this.getMagicNumber(),
     );
-    this.decodedEntries = this.decodeTrace(traceBuffer);
+    this.decodedEntries = await this.decodeTrace(traceBuffer);
   }
 
   getDescriptors(): string[] {
diff --git a/tools/winscope/src/parsers/legacy/parser_common_test.ts b/tools/winscope/src/parsers/legacy/parser_common_test.ts
index 4f2257fa3..9df757059 100644
--- a/tools/winscope/src/parsers/legacy/parser_common_test.ts
+++ b/tools/winscope/src/parsers/legacy/parser_common_test.ts
@@ -34,6 +34,7 @@ describe('Parser', () => {
     const parsers = await new ParserFactory().createParsers(
       [trace],
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
+      {},
     );
     expect(parsers.length).toEqual(0);
   });
@@ -48,6 +49,7 @@ describe('Parser', () => {
     const parsers = await new ParserFactory().createParsers(
       [trace],
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
+      {},
     );
     expect(parsers.length).toEqual(0);
   });
@@ -60,6 +62,7 @@ describe('Parser', () => {
     const parsers = await new ParserFactory().createParsers(
       [trace],
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
+      {},
     );
     expect(parsers.length).toEqual(0);
   });
diff --git a/tools/winscope/src/parsers/legacy/parser_factory.ts b/tools/winscope/src/parsers/legacy/parser_factory.ts
index 9ad701256..2f425d271 100644
--- a/tools/winscope/src/parsers/legacy/parser_factory.ts
+++ b/tools/winscope/src/parsers/legacy/parser_factory.ts
@@ -39,6 +39,7 @@ import {ParserWindowManager} from 'parsers/window_manager/legacy/parser_window_m
 import {ParserWindowManagerDump} from 'parsers/window_manager/legacy/parser_window_manager_dump';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
+import {TraceMetadata} from 'trace/trace_metadata';
 
 export class ParserFactory {
   static readonly PARSERS = [
@@ -62,6 +63,7 @@ export class ParserFactory {
   async createParsers(
     traceFiles: TraceFile[],
     timestampConverter: ParserTimestampConverter,
+    metadata: TraceMetadata,
     progressListener?: ProgressListener,
   ): Promise<FileAndParser[]> {
     const parsers = new Array<{file: TraceFile; parser: Parser<object>}>();
@@ -76,7 +78,7 @@ export class ParserFactory {
 
       for (const ParserType of ParserFactory.PARSERS) {
         try {
-          const p = new ParserType(traceFile, timestampConverter);
+          const p = new ParserType(traceFile, timestampConverter, metadata);
           await p.parse();
           hasFoundParser = true;
 
diff --git a/tools/winscope/src/parsers/operations/translate_intdef.ts b/tools/winscope/src/parsers/operations/translate_intdef.ts
index ad84cf314..492ec0224 100644
--- a/tools/winscope/src/parsers/operations/translate_intdef.ts
+++ b/tools/winscope/src/parsers/operations/translate_intdef.ts
@@ -40,9 +40,10 @@ export class TranslateIntDef implements Operation<PropertyTreeNode> {
         this.apply(value, field);
       });
     } else {
-      if (typeof value.getValue() === 'number' && value.getValue() !== -1) {
+      const propertyValue = Number(value.getValue());
+      if (!Number.isNaN(propertyValue) && propertyValue !== -1) {
         const translation = this.translateIntDefToStringIfNeeded(
-          value.getValue(),
+          propertyValue,
           field,
         );
         if (typeof translation === 'string') {
@@ -91,9 +92,8 @@ export class TranslateIntDef implements Operation<PropertyTreeNode> {
     annotationType: string,
   ): string {
     let flags = '';
-
     const mapping =
-      intDefMapping[annotationType as keyof typeof intDefMapping].values;
+      intDefMapping[annotationType as keyof typeof intDefMapping]?.values ?? {};
 
     const knownFlagValues = Object.keys(mapping)
       .reverse()
@@ -126,7 +126,7 @@ export class TranslateIntDef implements Operation<PropertyTreeNode> {
 
     if (leftOver) {
       // If 0 is a valid flag value that isn't in the intDefMapping it will be ignored
-      flags += leftOver;
+      flags += ' | ' + leftOver;
     }
 
     return flags;
@@ -169,5 +169,7 @@ export class TranslateIntDef implements Operation<PropertyTreeNode> {
       'android.view.WindowInsets.Type.InsetsType',
     'WindowStateProto.requestedVisibleTypes':
       'android.view.WindowInsets.Type.InsetsType',
+    'Target.flags': 'android.window.TransitionInfo.ChangeFlags',
+    'Transition.flags': 'android.view.WindowManager.TransitionFlags',
   };
 }
diff --git a/tools/winscope/src/parsers/operations/translate_intdef_test.ts b/tools/winscope/src/parsers/operations/translate_intdef_test.ts
index 007eb62c1..7d0adf534 100644
--- a/tools/winscope/src/parsers/operations/translate_intdef_test.ts
+++ b/tools/winscope/src/parsers/operations/translate_intdef_test.ts
@@ -114,4 +114,40 @@ describe('TranslateIntDef', () => {
       assertDefined(params.getChildByName('behavior')).formattedValue(),
     ).toEqual('BEHAVIOR_DEFAULT');
   });
+
+  it('translates BigInt', () => {
+    propertyRoot = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('test')
+      .setName('node')
+      .setChildren([{name: 'layoutParamsFlags', value: 1n}])
+      .build();
+
+    const field = rootType.fields['intdefMappingEntry'];
+    operation = new TranslateIntDef(field);
+    operation.apply(propertyRoot);
+    expect(
+      assertDefined(
+        propertyRoot.getChildByName('layoutParamsFlags'),
+      ).formattedValue(),
+    ).toEqual('FLAG_ALLOW_LOCK_WHILE_SCREEN_ON');
+  });
+
+  it('formats leftover', () => {
+    propertyRoot = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('test')
+      .setName('node')
+      .setChildren([{name: 'inputConfig', value: 3}])
+      .build();
+
+    const field = rootType.fields['intdefMappingEntry'];
+    operation = new TranslateIntDef(field);
+    operation.apply(propertyRoot);
+    expect(
+      assertDefined(
+        propertyRoot.getChildByName('inputConfig'),
+      ).formattedValue(),
+    ).toEqual('NO_INPUT_CHANNEL | 2');
+  });
 });
diff --git a/tools/winscope/src/parsers/perfetto/parser_factory.ts b/tools/winscope/src/parsers/perfetto/parser_factory.ts
index f8fb9f86d..59c01b8ad 100644
--- a/tools/winscope/src/parsers/perfetto/parser_factory.ts
+++ b/tools/winscope/src/parsers/perfetto/parser_factory.ts
@@ -14,9 +14,7 @@
  * limitations under the License.
  */
 
-import {globalConfig} from 'common/global_config';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
-import {UrlUtils} from 'common/url_utils';
 import {UserNotifier} from 'common/user_notifier';
 import {ProgressListener} from 'messaging/progress_listener';
 import {InvalidPerfettoTrace} from 'messaging/user_warnings';
@@ -33,11 +31,8 @@ import {ParserViewCapture} from 'parsers/view_capture/perfetto/parser_view_captu
 import {ParserWindowManager} from 'parsers/window_manager/perfetto/parser_window_manager';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
-import {
-  initWasm,
-  resetEngineWorker,
-  WasmEngineProxy,
-} from 'trace_processor/wasm_engine_proxy';
+import {TraceProcessorFactory} from 'trace_processor/trace_processor_factory';
+import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
 
 export class ParserFactory {
   private static readonly PARSERS = [
@@ -54,7 +49,6 @@ export class ParserFactory {
     ParserKeyEvent,
   ];
   private static readonly CHUNK_SIZE_BYTES = 50 * 1024 * 1024;
-  private static traceProcessor?: WasmEngineProxy;
 
   async createParsers(
     traceFile: TraceFile,
@@ -123,24 +117,14 @@ export class ParserFactory {
   }
 
   private async initializeTraceProcessor(): Promise<WasmEngineProxy> {
-    if (!ParserFactory.traceProcessor) {
-      const traceProcessorRootUrl =
-        globalConfig.MODE === 'KARMA_TEST'
-          ? UrlUtils.getRootUrl() +
-            'base/deps_build/trace_processor/to_be_served/'
-          : UrlUtils.getRootUrl();
-      initWasm(traceProcessorRootUrl);
-      const engineId = 'random-id';
-      const enginePort = resetEngineWorker();
-      ParserFactory.traceProcessor = new WasmEngineProxy(engineId, enginePort);
-    }
+    const traceProcessor = await TraceProcessorFactory.getSingleInstance();
 
-    await ParserFactory.traceProcessor.resetTraceProcessor({
+    await traceProcessor.resetTraceProcessor({
       cropTrackEvents: false,
       ingestFtraceInRawTable: false,
       analyzeTraceProtoContent: false,
     });
 
-    return ParserFactory.traceProcessor;
+    return traceProcessor;
   }
 }
diff --git a/tools/winscope/src/parsers/screen_recording/mp4box.d.ts b/tools/winscope/src/parsers/screen_recording/mp4box.d.ts
new file mode 100644
index 000000000..0410ec5e4
--- /dev/null
+++ b/tools/winscope/src/parsers/screen_recording/mp4box.d.ts
@@ -0,0 +1,47 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+declare module 'mp4box' {
+  // mp4box does not have TypeScript support, so we must declare the types below
+  export interface FileInfo {
+    tracks: Track[];
+  }
+
+  export interface Track {
+    id: number;
+  }
+
+  export interface Sample {
+    duration: number;
+    timescale: number;
+  }
+
+  export type MP4ArrayBuffer = ArrayBuffer & {fileStart: number};
+
+  export interface MP4File {
+    onReady?: (info: FileInfo) => void;
+    onSamples?: (id: number, user: unknown, samples: Sample[]) => void;
+    appendBuffer(data: MP4ArrayBuffer): number;
+    start(): void;
+    setExtractionOptions(
+      trackId: number,
+      user?: unknown,
+      options?: {nbSamples?: number; rapAlignment?: number},
+    ): void;
+  }
+
+  export function createFile(): MP4File;
+}
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
index 4472b14bd..b4c715495 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
@@ -16,17 +16,30 @@
 
 import {ArrayUtils} from 'common/array_utils';
 import {Timestamp} from 'common/time';
+import {ParserTimestampConverter} from 'common/timestamp_converter';
+import {TIME_UNIT_TO_NANO} from 'common/time_units';
 import {UserNotifier} from 'common/user_notifier';
 import {MonotonicScreenRecording} from 'messaging/user_warnings';
+import * as MP4Box from 'mp4box';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {CoarseVersion} from 'trace/coarse_version';
 import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {ScreenRecordingUtils} from 'trace/screen_recording_utils';
+import {TraceFile} from 'trace/trace_file';
+import {ScreenRecordingOffsets, TraceMetadata} from 'trace/trace_metadata';
 import {TraceType} from 'trace/trace_type';
 
 class ParserScreenRecording extends AbstractParser {
   private realToBootTimeOffsetNs: bigint | undefined;
 
+  constructor(
+    trace: TraceFile,
+    timestampConverter: ParserTimestampConverter,
+    metadata: TraceMetadata,
+  ) {
+    super(trace, timestampConverter, metadata);
+  }
+
   override getTraceType(): TraceType {
     return TraceType.SCREEN_RECORDING;
   }
@@ -47,45 +60,19 @@ class ParserScreenRecording extends AbstractParser {
     return this.realToBootTimeOffsetNs;
   }
 
-  override decodeTrace(videoData: Uint8Array): Array<bigint> {
+  override async decodeTrace(videoData: Uint8Array): Promise<Array<bigint>> {
     const posVersion = this.searchMagicString(videoData);
-    const [posTimeOffset, metadataVersion] = this.parseMetadataVersion(
-      videoData,
-      posVersion,
-    );
-
-    if (metadataVersion !== 1 && metadataVersion !== 2) {
-      throw new TypeError(
-        `Metadata version "${metadataVersion}" not supported`,
+    if (posVersion !== undefined) {
+      return this.parseTimestampsUsingEmbeddedMetadata(videoData, posVersion);
+    } else if (this.metadata?.screenRecordingOffsets !== undefined) {
+      return await this.parseTimestampsUsingExternalMetadata(
+        videoData,
+        this.metadata.screenRecordingOffsets,
       );
     }
-
-    if (metadataVersion === 1) {
-      // UI traces contain "elapsed" timestamps (SYSTEM_TIME_BOOTTIME), whereas
-      // metadata Version 1 contains SYSTEM_TIME_MONOTONIC timestamps.
-      //
-      // Here we are pretending that metadata Version 1 contains "elapsed"
-      // timestamps as well, in order to synchronize with the other traces.
-      //
-      // If no device suspensions are involved, SYSTEM_TIME_MONOTONIC should
-      // indeed correspond to SYSTEM_TIME_BOOTTIME and things will work as
-      // expected.
-      UserNotifier.add(new MonotonicScreenRecording());
-    }
-
-    const [posCount, timeOffsetNs] = this.parserealToBootTimeOffsetNs(
-      videoData,
-      posTimeOffset,
+    throw new TypeError(
+      "video data doesn't contain winscope magic string and metadata json not provided",
     );
-    this.realToBootTimeOffsetNs = timeOffsetNs;
-    const [posTimestamps, count] = this.parseFramesCount(videoData, posCount);
-    const timestampsElapsedNs = this.parseTimestampsElapsedNs(
-      videoData,
-      posTimestamps,
-      count,
-    );
-
-    return timestampsElapsedNs;
   }
 
   protected override getTimestamp(decodedEntry: bigint): Timestamp {
@@ -104,18 +91,67 @@ class ParserScreenRecording extends AbstractParser {
     return new MediaBasedTraceEntry(videoTimeSeconds, videoData);
   }
 
-  private searchMagicString(videoData: Uint8Array): number {
+  private searchMagicString(videoData: Uint8Array): number | undefined {
     let pos = ArrayUtils.searchSubarray(
       videoData,
       ParserScreenRecording.WINSCOPE_META_MAGIC_STRING,
     );
     if (pos === undefined) {
-      throw new TypeError("video data doesn't contain winscope magic string");
+      return undefined;
     }
     pos += ParserScreenRecording.WINSCOPE_META_MAGIC_STRING.length;
     return pos;
   }
 
+  private parseTimestampsUsingEmbeddedMetadata(
+    videoData: Uint8Array,
+    posVersion: number,
+  ): Array<bigint> {
+    const [posCount, timeOffsetNs] = this.getOffsetAndCountFromPosVersion(
+      videoData,
+      posVersion,
+    );
+    const [posTimestamps, count] = this.parseFramesCount(videoData, posCount);
+    this.realToBootTimeOffsetNs = timeOffsetNs;
+    const timestampsElapsedNs = this.parseTimestampsElapsedNs(
+      videoData,
+      posTimestamps,
+      count,
+    );
+    return timestampsElapsedNs;
+  }
+
+  private getOffsetAndCountFromPosVersion(
+    videoData: Uint8Array,
+    posVersion: number,
+  ): [number, bigint] {
+    const [posTimeOffset, metadataVersion] = this.parseMetadataVersion(
+      videoData,
+      posVersion,
+    );
+
+    if (metadataVersion !== 1 && metadataVersion !== 2) {
+      throw new TypeError(
+        `Metadata version "${metadataVersion}" not supported`,
+      );
+    }
+
+    if (metadataVersion === 1) {
+      // UI traces contain "elapsed" timestamps (SYSTEM_TIME_BOOTTIME), whereas
+      // metadata Version 1 contains SYSTEM_TIME_MONOTONIC timestamps.
+      //
+      // Here we are pretending that metadata Version 1 contains "elapsed"
+      // timestamps as well, in order to synchronize with the other traces.
+      //
+      // If no device suspensions are involved, SYSTEM_TIME_MONOTONIC should
+      // indeed correspond to SYSTEM_TIME_BOOTTIME and things will work as
+      // expected.
+      UserNotifier.add(new MonotonicScreenRecording());
+    }
+
+    return this.parseRealToBootTimeOffsetNs(videoData, posTimeOffset);
+  }
+
   private parseMetadataVersion(
     videoData: Uint8Array,
     pos: number,
@@ -132,7 +168,7 @@ class ParserScreenRecording extends AbstractParser {
     return [pos, version];
   }
 
-  private parserealToBootTimeOffsetNs(
+  private parseRealToBootTimeOffsetNs(
     videoData: Uint8Array,
     pos: number,
   ): [number, bigint] {
@@ -181,6 +217,51 @@ class ParserScreenRecording extends AbstractParser {
     return timestamps;
   }
 
+  private async parseTimestampsUsingExternalMetadata(
+    videoData: Uint8Array,
+    metadata: ScreenRecordingOffsets,
+  ): Promise<Array<bigint>> {
+    this.realToBootTimeOffsetNs = metadata.realToElapsedTimeOffsetNanos;
+    const timestampsElapsedNs = await this.parseTimestampsFromMp4(
+      videoData.buffer.slice(
+        videoData.byteOffset,
+        videoData.byteLength + videoData.byteOffset,
+      ),
+      metadata.elapsedRealTimeNanos,
+    );
+    return timestampsElapsedNs;
+  }
+
+  private async parseTimestampsFromMp4(
+    arrayBuffer: ArrayBuffer,
+    elapsedRealTimeNanos: bigint,
+  ): Promise<Array<bigint>> {
+    const timestamps: Array<bigint> = [];
+    const mp4File: MP4Box.MP4File = MP4Box.createFile();
+    await new Promise<void>((resolve) => {
+      mp4File.onReady = (info) => {
+        mp4File.onSamples = (id, user, samples) => {
+          let curr = elapsedRealTimeNanos;
+          samples.forEach((sample) => {
+            const timeSeconds = sample.duration / sample.timescale;
+            const timeNs = BigInt(
+              Math.floor(TIME_UNIT_TO_NANO.s * timeSeconds),
+            );
+            curr += timeNs;
+            timestamps.push(curr);
+          });
+          resolve();
+        };
+        mp4File.setExtractionOptions(info.tracks[0].id);
+      };
+      const buffer = arrayBuffer as MP4Box.MP4ArrayBuffer;
+      buffer.fileStart = 0;
+      mp4File.appendBuffer(buffer);
+      mp4File.start();
+    });
+    return timestamps;
+  }
+
   private static readonly MPEG4_MAGIC_NUMBER = [
     0x00, 0x00, 0x00, 0x18, 0x66, 0x74, 0x79, 0x70, 0x6d, 0x70, 0x34, 0x32,
   ]; // ....ftypmp42
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
index 9d2eacd97..0986f7076 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
@@ -24,44 +24,99 @@ import {TraceType} from 'trace/trace_type';
 describe('ParserScreenRecording', () => {
   let parser: Parser<MediaBasedTraceEntry>;
 
-  beforeAll(async () => {
-    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
-    parser = (await UnitTestUtils.getParser(
-      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-    )) as Parser<MediaBasedTraceEntry>;
-  });
+  describe('metadata v2', () => {
+    beforeAll(async () => {
+      jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+      parser = (await UnitTestUtils.getParser(
+        'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
+      )) as Parser<MediaBasedTraceEntry>;
+    });
 
-  it('has expected trace type', () => {
-    expect(parser.getTraceType()).toEqual(TraceType.SCREEN_RECORDING);
-  });
+    it('has expected trace type', () => {
+      expect(parser.getTraceType()).toEqual(TraceType.SCREEN_RECORDING);
+    });
 
-  it('has expected coarse version', () => {
-    expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LATEST);
-  });
+    it('has expected coarse version', () => {
+      expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LATEST);
+    });
 
-  it('provides timestamps', () => {
-    const timestamps = assertDefined(parser.getTimestamps());
+    it('provides timestamps', () => {
+      const timestamps = assertDefined(parser.getTimestamps());
 
-    expect(timestamps.length).toEqual(123);
+      expect(timestamps.length).toEqual(123);
 
-    const expected = [
-      TimestampConverterUtils.makeRealTimestamp(1666361048792787045n),
-      TimestampConverterUtils.makeRealTimestamp(1666361048807348045n),
-      TimestampConverterUtils.makeRealTimestamp(1666361048827119045n),
-    ];
-    expect(timestamps.slice(0, 3)).toEqual(expected);
+      const expected = [
+        TimestampConverterUtils.makeRealTimestamp(1666361048792787045n),
+        TimestampConverterUtils.makeRealTimestamp(1666361048807348045n),
+        TimestampConverterUtils.makeRealTimestamp(1666361048827119045n),
+      ];
+      expect(timestamps.slice(0, 3)).toEqual(expected);
+    });
+
+    it('retrieves trace entry', async () => {
+      {
+        const entry = await parser.getEntry(0);
+        expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
+        expect(Number(entry.videoTimeSeconds)).toBeCloseTo(0);
+      }
+      {
+        const entry = await parser.getEntry(parser.getLengthEntries() - 1);
+        expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
+        expect(Number(entry.videoTimeSeconds)).toBeCloseTo(1.371077, 0.001);
+      }
+    });
   });
 
-  it('retrieves trace entry', async () => {
-    {
-      const entry = await parser.getEntry(0);
-      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
-      expect(Number(entry.videoTimeSeconds)).toBeCloseTo(0);
-    }
-    {
-      const entry = await parser.getEntry(parser.getLengthEntries() - 1);
-      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
-      expect(Number(entry.videoTimeSeconds)).toBeCloseTo(1.371077, 0.001);
-    }
+  describe('separate metadata file', () => {
+    beforeAll(async () => {
+      jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+      parser = (await UnitTestUtils.getParser(
+        'traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4',
+        undefined,
+        undefined,
+        {
+          screenRecordingOffsets: {
+            elapsedRealTimeNanos: 5n,
+            realToElapsedTimeOffsetNanos: 10n,
+          },
+        },
+      )) as Parser<MediaBasedTraceEntry>;
+    });
+
+    it('throws error if metadata not provided', async () => {
+      const parsers = await UnitTestUtils.getParsers(
+        'traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4',
+      );
+      expect(parsers.length).toEqual(0);
+    });
+
+    it('sets real to boot time offset', () => {
+      expect(parser.getRealToBootTimeOffsetNs()).toEqual(10n);
+    });
+
+    it('provides timestamps', () => {
+      const timestamps = assertDefined(parser.getTimestamps());
+      expect(timestamps.length).toEqual(158);
+
+      const expected = [
+        TimestampConverterUtils.makeRealTimestamp(599300015n),
+        TimestampConverterUtils.makeRealTimestamp(599400015n),
+        TimestampConverterUtils.makeRealTimestamp(1066066681n),
+      ];
+      expect(timestamps.slice(0, 3)).toEqual(expected);
+    });
+
+    it('retrieves trace entry', async () => {
+      {
+        const entry = await parser.getEntry(0);
+        expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
+        expect(Number(entry.videoTimeSeconds)).toBeCloseTo(0);
+      }
+      {
+        const entry = await parser.getEntry(parser.getLengthEntries() - 1);
+        expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
+        expect(Number(entry.videoTimeSeconds)).toBeCloseTo(4.192109, 0.001);
+      }
+    });
   });
 });
diff --git a/tools/winscope/src/parsers/search/parser_search.ts b/tools/winscope/src/parsers/search/parser_search.ts
new file mode 100644
index 000000000..3633eebb9
--- /dev/null
+++ b/tools/winscope/src/parsers/search/parser_search.ts
@@ -0,0 +1,128 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {INVALID_TIME_NS, Timestamp} from 'common/time';
+import {TimestampConverter} from 'common/timestamp_converter';
+import {UserNotifier} from 'common/user_notifier';
+import {Analytics} from 'logging/analytics';
+import {TraceSearchQueryFailed} from 'messaging/user_warnings';
+import {CoarseVersion} from 'trace/coarse_version';
+import {
+  CustomQueryParserResultTypeMap,
+  CustomQueryType,
+} from 'trace/custom_query';
+import {AbsoluteEntryIndex, EntriesRange} from 'trace/index_types';
+import {Parser} from 'trace/parser';
+import {TraceType} from 'trace/trace_type';
+import {QueryResult} from 'trace_processor/query_result';
+import {TraceProcessorFactory} from 'trace_processor/trace_processor_factory';
+
+export class ParserSearch implements Parser<QueryResult> {
+  private queryResult?: QueryResult;
+  private timestamps: Timestamp[] = [];
+
+  constructor(
+    private readonly query: string,
+    private timestampConverter: TimestampConverter,
+  ) {}
+
+  getCoarseVersion(): CoarseVersion {
+    return CoarseVersion.LATEST;
+  }
+
+  getTraceType(): TraceType {
+    return TraceType.SEARCH;
+  }
+
+  getLengthEntries(): number {
+    const queryResult = this.validateQueryResult();
+    const numRows = queryResult.numRows();
+    if (numRows === 0 || !this.hasTimestamps()) {
+      return 1;
+    }
+    return numRows;
+  }
+
+  getTimestamps(): Timestamp[] {
+    return this.timestamps;
+  }
+
+  async getEntry(index: AbsoluteEntryIndex): Promise<QueryResult> {
+    return this.validateQueryResult();
+  }
+
+  customQuery<Q extends CustomQueryType>(
+    type: Q,
+    entriesRange: EntriesRange,
+  ): Promise<CustomQueryParserResultTypeMap[Q]> {
+    throw new Error('not implemented');
+  }
+
+  getDescriptors(): string[] {
+    return [this.query];
+  }
+
+  getRealToMonotonicTimeOffsetNs(): bigint | undefined {
+    return undefined;
+  }
+
+  getRealToBootTimeOffsetNs(): bigint | undefined {
+    return undefined;
+  }
+
+  createTimestamps(): void {
+    throw new Error('not implemented');
+  }
+
+  async parse() {
+    const tp = await TraceProcessorFactory.getSingleInstance();
+    try {
+      this.queryResult = await tp.query(this.query).waitAllRows();
+      if (this.hasTimestamps() && this.queryResult.numRows() > 0) {
+        for (const it = this.queryResult.iter({}); it.valid(); it.next()) {
+          const ns = it.get('ts') as bigint;
+          if (ns === INVALID_TIME_NS) {
+            this.timestamps.push(this.timestampConverter.makeZeroTimestamp());
+          } else {
+            this.timestamps.push(
+              this.timestampConverter.makeTimestampFromBootTimeNs(ns),
+            );
+          }
+        }
+      } else {
+        this.timestamps.push(this.timestampConverter.makeZeroTimestamp());
+      }
+    } catch (e) {
+      Analytics.TraceSearch.logQueryFailure();
+      UserNotifier.add(
+        new TraceSearchQueryFailed((e as Error).message),
+      ).notify();
+      throw e;
+    }
+  }
+
+  private hasTimestamps(): boolean {
+    return this.queryResult?.columns().includes('ts') ?? false;
+  }
+
+  private validateQueryResult(): QueryResult {
+    return assertDefined(
+      this.queryResult,
+      () => 'Attempted to retrieve query result before running search query.',
+    );
+  }
+}
diff --git a/tools/winscope/src/parsers/search/parser_search_test.ts b/tools/winscope/src/parsers/search/parser_search_test.ts
new file mode 100644
index 000000000..b2126cc40
--- /dev/null
+++ b/tools/winscope/src/parsers/search/parser_search_test.ts
@@ -0,0 +1,173 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TraceSearchQueryFailed} from 'messaging/user_warnings';
+import {ParserSurfaceFlinger} from 'parsers/surface_flinger/perfetto/parser_surface_flinger';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {UnitTestUtils} from 'test/unit/utils';
+import {CoarseVersion} from 'trace/coarse_version';
+import {TraceType} from 'trace/trace_type';
+import {ParserSearch} from './parser_search';
+
+describe('ParserSearch', () => {
+  let userNotifierChecker: UserNotifierChecker;
+  let parser: ParserSearch;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+  });
+
+  afterEach(() => {
+    userNotifierChecker.reset();
+  });
+
+  describe('valid query with timestamps', () => {
+    beforeAll(async () => {
+      parser = await createParser(
+        'SELECT * FROM surfaceflinger_layers_snapshot',
+      );
+    });
+
+    afterEach(() => {
+      userNotifierChecker.expectNone();
+    });
+
+    it('has expected trace type', () => {
+      expect(parser.getTraceType()).toEqual(TraceType.SEARCH);
+    });
+
+    it('has expected coarse version', () => {
+      expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LATEST);
+    });
+
+    it('has length entries equal to number of rows', () => {
+      expect(parser.getLengthEntries()).toEqual(21);
+    });
+
+    it('provides timestamps', () => {
+      const expected = [
+        TimestampConverterUtils.makeElapsedTimestamp(14500282843n),
+        TimestampConverterUtils.makeElapsedTimestamp(14631249355n),
+        TimestampConverterUtils.makeElapsedTimestamp(15403446377n),
+      ];
+      const actual = assertDefined(parser.getTimestamps()).slice(0, 3);
+      expect(actual).toEqual(expected);
+      userNotifierChecker.expectNone();
+    });
+
+    it('provides query result', async () => {
+      const entry = await parser.getEntry(0);
+      expect(entry.numRows()).toEqual(21);
+      const firstRow = entry.iter({});
+      expect(firstRow.get('id')).toEqual(0n);
+      expect(firstRow.get('ts')).toEqual(14500282843n);
+      expect(firstRow.get('type')).toEqual('surfaceflinger_layers_snapshot');
+      expect(firstRow.get('arg_set_id')).toEqual(176n);
+    });
+  });
+
+  describe('valid query without timestamps', () => {
+    beforeAll(async () => {
+      parser = await createParser('SELECT * FROM surfaceflinger_layer');
+      userNotifierChecker.expectNone();
+    });
+
+    afterEach(() => {
+      userNotifierChecker.expectNone();
+    });
+
+    it('has length entries equal to 1 so query result can be accessed', () => {
+      expect(parser.getLengthEntries()).toEqual(1);
+    });
+
+    it('provides one invalid timestamp so query result can be accessed', () => {
+      expect(parser.getTimestamps()).toEqual([
+        TimestampConverterUtils.makeZeroTimestamp(),
+      ]);
+    });
+
+    it('provides query result', async () => {
+      const entry = await parser.getEntry(0);
+      expect(entry.numRows()).toEqual(1815);
+      const firstRow = entry.iter({});
+      expect(firstRow.get('id')).toEqual(0n);
+      expect(firstRow.get('type')).toEqual('surfaceflinger_layer');
+      expect(firstRow.get('arg_set_id')).toEqual(1n);
+      expect(firstRow.get('snapshot_id')).toEqual(0n);
+    });
+  });
+
+  describe('valid query without rows', () => {
+    beforeAll(async () => {
+      parser = await createParser('SELECT * FROM surfaceflinger_transactions');
+    });
+
+    afterEach(() => {
+      userNotifierChecker.expectNone();
+    });
+
+    it('has length entries equal to 1 so query result can be accessed', () => {
+      expect(parser.getLengthEntries()).toEqual(1);
+    });
+
+    it('provides one invalid timestamp so query result can be accessed', () => {
+      expect(parser.getTimestamps()).toEqual([
+        TimestampConverterUtils.makeZeroTimestamp(),
+      ]);
+    });
+
+    it('provides query result', async () => {
+      const entry = await parser.getEntry(0);
+      expect(entry.columns()).toEqual([
+        'id',
+        'type',
+        'ts',
+        'arg_set_id',
+        'base64_proto',
+        'base64_proto_id',
+      ]);
+      expect(entry.numRows()).toEqual(0);
+    });
+  });
+
+  it('notifies user of parsing error before throwing error', async () => {
+    const createFailingParser = () => createParser('SELECT * FROM fake_table');
+    await expectAsync(createFailingParser()).toBeRejected();
+    userNotifierChecker.reset();
+    try {
+      parser = await createFailingParser();
+    } catch (e) {
+      userNotifierChecker.expectNotified([
+        new TraceSearchQueryFailed((e as Error).message),
+      ]);
+    }
+  });
+
+  async function createParser(query: string): Promise<ParserSearch> {
+    await (
+      (await UnitTestUtils.getPerfettoParser(
+        TraceType.SURFACE_FLINGER,
+        'traces/perfetto/layers_trace.perfetto-trace',
+      )) as ParserSurfaceFlinger
+    ).parse();
+    parser = new ParserSearch(query, UnitTestUtils.getTimestampConverter());
+    await parser.parse();
+    return parser;
+  }
+});
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts
index eb3d8d5c5..bbc4c5652 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts
@@ -18,47 +18,59 @@ import {assertDefined} from 'common/assert_utils';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 
 export class LayerExtractor {
-  static extractLayersSortedByZ(layer: HierarchyTreeNode): HierarchyTreeNode[] {
+  static extractLayersTopToBottom(
+    layer: HierarchyTreeNode,
+  ): HierarchyTreeNode[] {
     const traverseList: HierarchyTreeNode[] = [];
 
-    if (!layer.isRoot()) traverseList.push(layer);
+    const sortedZChildren = layer
+      .getRelativeChildren()
+      .concat(
+        layer.getAllChildren().filter((child) => child.getZParent() === layer),
+      )
+      .sort((a, b) => LayerExtractor.compareByZAndLayerId(a, b));
 
-    const allChildrenSortedByZ = layer
-      .getAllChildren()
-      .slice()
-      .sort(LayerExtractor.compareByZOrderPath);
+    if (layer.isRoot()) {
+      sortedZChildren.forEach((c) => {
+        traverseList.push(...LayerExtractor.extractLayersTopToBottom(c));
+      });
+    } else {
+      const layerZ = LayerExtractor.getZ(layer);
+      const sortedZChildrenBelowRoot = sortedZChildren.filter(
+        (child) => LayerExtractor.getZ(child) < layerZ,
+      );
+      const sortedZChildrenAboveRoot = sortedZChildren.filter(
+        (child) => LayerExtractor.getZ(child) >= layerZ,
+      );
 
-    allChildrenSortedByZ.forEach((c) => {
-      traverseList.push(...LayerExtractor.extractLayersSortedByZ(c));
-    });
-
-    traverseList.sort(LayerExtractor.compareByZOrderPath);
+      sortedZChildrenAboveRoot.forEach((c) => {
+        traverseList.push(...LayerExtractor.extractLayersTopToBottom(c));
+      });
+      traverseList.push(layer);
+      sortedZChildrenBelowRoot.forEach((c) => {
+        traverseList.push(...LayerExtractor.extractLayersTopToBottom(c));
+      });
+    }
     return traverseList;
   }
 
-  private static compareByZOrderPath(
+  private static compareByZAndLayerId(
     a: HierarchyTreeNode,
     b: HierarchyTreeNode,
   ): number {
-    const aZOrderPath: number[] = assertDefined(
-      a.getEagerPropertyByName('zOrderPath'),
-    )
-      .getAllChildren()
-      .map((child) => child.getValue());
-    const bZOrderPath: number[] = assertDefined(
-      b.getEagerPropertyByName('zOrderPath'),
-    )
-      .getAllChildren()
-      .map((child) => child.getValue());
+    const aZ = LayerExtractor.getZ(a);
+    const bZ = LayerExtractor.getZ(b);
+
+    if (aZ > bZ) return -1;
+    if (aZ < bZ) return 1;
 
-    const zipLength = Math.min(aZOrderPath.length, bZOrderPath.length);
-    for (let i = 0; i < zipLength; ++i) {
-      const zOrderA = aZOrderPath[i];
-      const zOrderB = bZOrderPath[i];
-      if (zOrderA > zOrderB) return -1;
-      if (zOrderA < zOrderB) return 1;
-    }
     // When z-order is the same, the layer with larger ID is on top
-    return a.id > b.id ? -1 : 1;
+    const aId = a.getEagerPropertyByName('id')?.getValue();
+    const bId = b.getEagerPropertyByName('id')?.getValue();
+    return aId < bId ? 1 : -1;
+  }
+
+  private static getZ(node: HierarchyTreeNode): number {
+    return assertDefined(node.getEagerPropertyByName('z')).getValue();
   }
 }
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor_test.ts
new file mode 100644
index 000000000..8af77c448
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor_test.ts
@@ -0,0 +1,259 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {android} from 'protos/surfaceflinger/udc/static';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {LayerExtractor} from './layer_extractor';
+import {ZOrderPathsComputation} from './z_order_paths_computation';
+
+describe('LayerExtractor', () => {
+  it('sorts according to z', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            z: 1,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 2,
+          name: 'layer2',
+          properties: {
+            id: 2,
+            z: 2,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 3,
+          name: 'layer3',
+          properties: {
+            id: 3,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [2, 1, 3]);
+  });
+
+  it('handles relative layers', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            z: 1,
+          } as android.surfaceflinger.ILayerProto,
+          children: [
+            {
+              id: 2,
+              name: 'layer2',
+              properties: {
+                id: 2,
+                z: 1,
+              } as android.surfaceflinger.ILayerProto,
+            },
+          ],
+        },
+        {
+          id: 3,
+          name: 'layer3',
+          properties: {
+            id: 3,
+            z: 1,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 4,
+          name: 'layer4',
+          properties: {
+            id: 4,
+            z: 0,
+            zOrderRelativeOf: 1,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+    computeZOrderPaths(hierarchyRoot);
+
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [3, 2, 1, 4]);
+  });
+
+  it('handles negative z values', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            z: 1,
+          } as android.surfaceflinger.ILayerProto,
+          children: [
+            {
+              id: 2,
+              name: 'layer2',
+              properties: {
+                id: 2,
+                z: 0,
+              } as android.surfaceflinger.ILayerProto,
+            },
+          ],
+        },
+        {
+          id: 5,
+          name: 'layer5',
+          properties: {
+            id: 5,
+            z: -5,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+    computeZOrderPaths(hierarchyRoot);
+
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [1, 2, 5]);
+  });
+
+  it('falls back to layer id comparison for equal z values', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 2,
+          name: 'layer',
+          properties: {
+            id: 2,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [2, 1]);
+  });
+
+  it('only falls back to layer id comparison for siblings', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 2,
+          name: 'layer',
+          properties: {
+            id: 2,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+          children: [
+            {
+              id: 1,
+              name: 'layer',
+              properties: {
+                id: 1,
+                z: 0,
+              } as android.surfaceflinger.ILayerProto,
+            },
+          ],
+        },
+      ])
+      .build();
+
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [1, 2]);
+  });
+
+  it('restricts z-order sorting to each level of hierarchy', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 2,
+          name: 'layer2',
+          properties: {
+            id: 2,
+            z: 0,
+          } as android.surfaceflinger.ILayerProto,
+          children: [
+            {
+              id: 3,
+              name: 'layer3',
+              properties: {
+                id: 3,
+                z: 2,
+              } as android.surfaceflinger.ILayerProto,
+            },
+            {
+              id: 4,
+              name: 'layer4',
+              properties: {
+                id: 4,
+                z: 1,
+              } as android.surfaceflinger.ILayerProto,
+            },
+          ],
+        },
+      ])
+      .build();
+
+    const layers = LayerExtractor.extractLayersTopToBottom(hierarchyRoot);
+    checkLayerOrder(layers, [3, 4, 2, 1]);
+  });
+
+  function computeZOrderPaths(root: HierarchyTreeNode) {
+    new ZOrderPathsComputation().setRoot(root).executeInPlace();
+  }
+
+  function checkLayerOrder(layers: HierarchyTreeNode[], expectedIds: number[]) {
+    expect(
+      layers.map((layer) => layer.getEagerPropertyByName('id')?.getValue()),
+    ).toEqual(expectedIds);
+  }
+});
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
index 8ba2f2628..0bfba43da 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
@@ -83,8 +83,7 @@ class RectSfFactory {
       const existingNameCount = nameCounts.get(displayName);
       if (existingNameCount !== undefined) {
         nameCounts.set(displayName, existingNameCount + 1);
-        const qualifier = displayName === 'Unknown Display' ? '' : 'Mirror ';
-        displayName += ` (${qualifier}${existingNameCount + 1})`;
+        displayName += ` (${existingNameCount + 1})`;
       } else {
         nameCounts.set(displayName, 1);
       }
@@ -170,14 +169,27 @@ class RectSfFactory {
     const inputWindowInfo = assertDefined(
       layer.getEagerPropertyByName('inputWindowInfo'),
     );
+
+    const layerTransform = Transform.from(
+      assertDefined(layer.getEagerPropertyByName('transform')),
+    ).matrix;
+    const inverseLayerTransform = layerTransform.inverse();
+
+    // The input frame is given in the display space.
     let inputWindowRect = GeometryFactory.makeRect(
-      assertDefined(layer.getEagerPropertyByName('bounds')),
+      assertDefined(inputWindowInfo.getChildByName('frame')),
+    );
+    // Transform it to layer space.
+    inputWindowRect = inverseLayerTransform.transformRect(
+      displayTransform?.transformRect(inputWindowRect) ?? inputWindowRect,
     );
+
     const inputConfig = assertDefined(
       inputWindowInfo.getChildByName('inputConfig'),
     ).getValue();
 
     const shouldCropToDisplay =
+      inputWindowRect.isEmpty() ||
       (inputConfig & InputConfig.IS_WALLPAPER) !== 0 ||
       (invalidBoundsFromDisplays !== undefined &&
         invalidBoundsFromDisplays.some((invalid) =>
@@ -193,10 +205,6 @@ class RectSfFactory {
         layer.getEagerPropertyByName('isComputedVisible'),
       ).getValue();
 
-    const layerTransform = Transform.from(
-      assertDefined(layer.getEagerPropertyByName('transform')),
-    ).matrix;
-
     let touchableRegion: Region | undefined;
     const isTouchable = (inputConfig & InputConfig.NOT_TOUCHABLE) === 0;
     const touchableRegionNode =
@@ -205,15 +213,12 @@ class RectSfFactory {
     if (!isTouchable) {
       touchableRegion = Region.createEmpty();
     } else if (touchableRegionNode !== undefined) {
-      // The touchable region is given in the display space, not layer space.
+      // The touchable region is given in the display space.
       touchableRegion = GeometryFactory.makeRegion(touchableRegionNode);
-      // First, transform the region into layer stack space.
-      touchableRegion =
-        displayTransform?.transformRegion(touchableRegion) ?? touchableRegion;
-      // Second, transform the region into layer space.
-      touchableRegion = layerTransform
-        .inverse()
-        .transformRegion(touchableRegion);
+      // Transform it to layer space.
+      touchableRegion = inverseLayerTransform.transformRegion(
+        displayTransform?.transformRegion(touchableRegion) ?? touchableRegion,
+      );
       if (shouldCropToDisplay && display !== undefined) {
         touchableRegion = new Region(
           touchableRegion.rects.map((rect) => {
@@ -400,7 +405,7 @@ export class RectsComputation implements Computation {
       curAbsoluteZByLayerStack.set(layerStack, 1);
     }
 
-    const layersWithRects = LayerExtractor.extractLayersSortedByZ(
+    const layersWithRects = LayerExtractor.extractLayersTopToBottom(
       assertDefined(this.root),
     ).filter((node) =>
       shouldIncludeLayer(node, assertDefined(this.invalidBoundsFromDisplays)),
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
index 5c9a9ab00..a2f20f0a2 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
@@ -27,6 +27,7 @@ import {TraceRect} from 'trace/trace_rect';
 import {TraceRectBuilder} from 'trace/trace_rect_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {InputConfig, RectsComputation} from './rects_computation';
+import {ZOrderPathsComputation} from './z_order_paths_computation';
 
 describe('SurfaceFlinger RectsComputation', () => {
   const rotationTransform = new Transform(
@@ -58,7 +59,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
             screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0],
+            z: 0,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
         },
@@ -69,7 +70,7 @@ describe('SurfaceFlinger RectsComputation', () => {
     ).toThrowError();
   });
 
-  it('makes layer rects according to z order paths', () => {
+  it('makes layer rects according to z order', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -84,7 +85,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
             screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -99,7 +100,7 @@ describe('SurfaceFlinger RectsComputation', () => {
                 layerStack: 0,
                 bounds: {left: 0, top: 0, right: 2, bottom: 2},
                 screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-                zOrderPath: [0, 1],
+                z: 1,
                 occludedBy: [1],
                 isComputedVisible: false,
                 transform: Transform.EMPTY,
@@ -107,21 +108,6 @@ describe('SurfaceFlinger RectsComputation', () => {
             },
           ],
         },
-        {
-          id: 3,
-          name: 'layer3',
-          properties: {
-            id: 3,
-            name: 'layer3',
-            cornerRadius: 2,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 2, bottom: 2},
-            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-            zOrderPath: [0],
-            isComputedVisible: false,
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
         {
           id: 4,
           name: 'layerRelativeZ',
@@ -132,23 +118,8 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0, 2],
-            isComputedVisible: true,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 5,
-          name: 'layerNegativeZ',
-          properties: {
-            id: 5,
-            name: 'layerNegativeZ',
-            cornerRadius: 0,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 5, bottom: 5},
-            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [-5],
+            z: 2,
+            zOrderRelativeOf: 1,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
@@ -167,7 +138,7 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setName('layer1')
         .setCornerRadius(0)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(1)
+        .setDepth(0)
         .setGroupId(0)
         .setIsVisible(true)
         .setOpacity(0)
@@ -184,23 +155,7 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setName('layer2')
         .setCornerRadius(2)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(2)
-        .setGroupId(0)
-        .setIsVisible(false)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(2)
-        .setHeight(2)
-        .setId('3 layer3')
-        .setName('layer3')
-        .setCornerRadius(2)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(3)
+        .setDepth(1)
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(false)
@@ -216,24 +171,7 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setName('layerRelativeZ')
         .setCornerRadius(0)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(4)
-        .setGroupId(0)
-        .setIsVisible(true)
-        .setOpacity(1)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(5)
-        .setHeight(5)
-        .setId('5 layerNegativeZ')
-        .setName('layerNegativeZ')
-        .setCornerRadius(0)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(0)
+        .setDepth(2)
         .setGroupId(0)
         .setIsVisible(true)
         .setOpacity(1)
@@ -241,6 +179,7 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setIsSpy(false)
         .build(),
     ];
+    new ZOrderPathsComputation().setRoot(hierarchyRoot).executeInPlace();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
     checkLayerRects(hierarchyRoot, expectedRects);
@@ -261,7 +200,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
             screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
@@ -277,7 +216,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 1,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
             screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
@@ -404,7 +343,7 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setWidth(10)
         .setHeight(5)
         .setId('Display - 3')
-        .setName('Test Display (Mirror 2)')
+        .setName('Test Display (2)')
         .setCornerRadius(0)
         .setTransform(Transform.EMPTY.matrix)
         .setDepth(2)
@@ -482,166 +421,6 @@ describe('SurfaceFlinger RectsComputation', () => {
     expect(hierarchyRoot.getRects()).toEqual(expectedDisplayRects);
   });
 
-  it('handles z-order paths with different lengths', () => {
-    const hierarchyRoot = new HierarchyTreeBuilder()
-      .setId('LayerTraceEntry')
-      .setName('root')
-      .setChildren([
-        {
-          id: 1,
-          name: 'layer1',
-          properties: {
-            id: 1,
-            name: 'layer1',
-            cornerRadius: 0,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 1, bottom: 1},
-            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0, 1],
-            isComputedVisible: true,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'layer2',
-          properties: {
-            id: 2,
-            name: 'layer2',
-            cornerRadius: 0,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 2, bottom: 2},
-            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-            zOrderPath: [0, 0, 0],
-            isComputedVisible: true,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
-      ])
-      .build();
-
-    const expectedRects: TraceRect[] = [
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(1)
-        .setHeight(1)
-        .setId('1 layer1')
-        .setName('layer1')
-        .setCornerRadius(0)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(1)
-        .setGroupId(0)
-        .setIsVisible(true)
-        .setOpacity(1)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(2)
-        .setHeight(2)
-        .setId('2 layer2')
-        .setName('layer2')
-        .setCornerRadius(0)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(0)
-        .setGroupId(0)
-        .setIsVisible(true)
-        .setOpacity(1)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-    ];
-
-    computation.setRoot(hierarchyRoot).executeInPlace();
-    checkLayerRects(hierarchyRoot, expectedRects);
-  });
-
-  it('handles z-order paths with equal values (fall back to Layer ID comparison)', () => {
-    const hierarchyRoot = new HierarchyTreeBuilder()
-      .setId('LayerTraceEntry')
-      .setName('root')
-      .setChildren([
-        {
-          id: 1,
-          name: 'layer1',
-          properties: {
-            id: 1,
-            name: 'layer1',
-            cornerRadius: 0,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 1, bottom: 1},
-            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0, 1],
-            isComputedVisible: true,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'layer2',
-          properties: {
-            id: 2,
-            name: 'layer2',
-            cornerRadius: 0,
-            layerStack: 0,
-            bounds: {left: 0, top: 0, right: 2, bottom: 2},
-            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-            zOrderPath: [0, 1, 0],
-            isComputedVisible: true,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            transform: Transform.EMPTY,
-          } as android.surfaceflinger.ILayerProto,
-        },
-      ])
-      .build();
-
-    const expectedRects: TraceRect[] = [
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(1)
-        .setHeight(1)
-        .setId('1 layer1')
-        .setName('layer1')
-        .setCornerRadius(0)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(0)
-        .setGroupId(0)
-        .setIsVisible(true)
-        .setOpacity(1)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-
-      new TraceRectBuilder()
-        .setX(0)
-        .setY(0)
-        .setWidth(2)
-        .setHeight(2)
-        .setId('2 layer2')
-        .setName('layer2')
-        .setCornerRadius(0)
-        .setTransform(Transform.EMPTY.matrix)
-        .setDepth(1)
-        .setGroupId(0)
-        .setIsVisible(true)
-        .setOpacity(1)
-        .setIsDisplay(false)
-        .setIsSpy(false)
-        .build(),
-    ];
-
-    computation.setRoot(hierarchyRoot).executeInPlace();
-    checkLayerRects(hierarchyRoot, expectedRects);
-  });
-
   it('does not make non-visible rects with missing or invalid screen bounds', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
@@ -669,7 +448,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -50, top: -100, right: 50, bottom: 100},
             screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -684,7 +463,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -50, top: -100, right: 50, bottom: 100},
             screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -699,7 +478,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -50, top: -100, right: 50, bottom: 100},
             screenBounds: {left: -49.991, top: -100, right: 50, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -719,7 +498,7 @@ describe('SurfaceFlinger RectsComputation', () => {
               right: 50000,
               bottom: 50000,
             },
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -734,7 +513,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -100, top: -50, right: 100, bottom: 50},
             screenBounds: {left: -100, top: -50, right: 100, bottom: 50},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -748,7 +527,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: -50, top: -100, right: 50, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -814,7 +593,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -50, top: -100, right: 50, bottom: 100},
             screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -829,7 +608,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -100, top: -100, right: 100, bottom: 100},
             screenBounds: {left: -100, top: -100, right: 100, bottom: 100},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
@@ -858,9 +637,9 @@ describe('SurfaceFlinger RectsComputation', () => {
           {
             id: 2,
             layerStack: 1,
-            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
+            layerStackSpaceRect: {left: 0, top: 0, right: 6, bottom: 7},
             name: 'Test Display 2',
-            size: {w: 5, h: 5},
+            size: {w: 6, h: 7},
           },
         ],
       })
@@ -875,11 +654,12 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
             screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: InputConfig.SPY,
+              frame: {left: 0, top: 0, right: 1, bottom: 1},
               visible: true,
             },
           } as android.surfaceflinger.ILayerProto,
@@ -894,12 +674,13 @@ describe('SurfaceFlinger RectsComputation', () => {
                 layerStack: 0,
                 bounds: {left: 0, top: 0, right: 2, bottom: 2},
                 screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-                zOrderPath: [0, 1],
+                z: 1,
                 occludedBy: [1],
                 isComputedVisible: false,
                 transform: Transform.EMPTY,
                 inputWindowInfo: {
                   inputConfig: 0,
+                  frame: {left: 0, top: 0, right: 2, bottom: 2},
                   visible: false,
                 },
               } as android.surfaceflinger.ILayerProto,
@@ -916,11 +697,12 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: -999, top: -999, right: 999, bottom: 999},
             screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: false,
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: InputConfig.IS_WALLPAPER,
+              frame: {left: -999, top: -999, right: 999, bottom: 999},
               visible: true,
             },
           } as android.surfaceflinger.ILayerProto,
@@ -935,12 +717,13 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0, 2],
+            z: 2,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: 0,
+              frame: {left: 0, top: 0, right: 5, bottom: 5},
             },
           } as android.surfaceflinger.ILayerProto,
         },
@@ -954,7 +737,7 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0],
+            z: 0,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
@@ -971,12 +754,13 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0, 2],
+            z: 2,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: InputConfig.NOT_TOUCHABLE,
+              frame: {left: 0, top: 0, right: 5, bottom: 5},
             },
           } as android.surfaceflinger.ILayerProto,
         },
@@ -990,12 +774,13 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0, 2],
+            z: 2,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: 0,
+              frame: {left: 0, top: 0, right: 5, bottom: 5},
               touchableRegion: {
                 rect: [
                   {
@@ -1019,12 +804,13 @@ describe('SurfaceFlinger RectsComputation', () => {
             layerStack: 1,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
             screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
-            zOrderPath: [0, 2],
+            z: 2,
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
             inputWindowInfo: {
               inputConfig: 0,
+              frame: {left: 0, top: 0, right: 5, bottom: 5},
               touchableRegion: {
                 rect: [
                   {
@@ -1038,6 +824,36 @@ describe('SurfaceFlinger RectsComputation', () => {
             },
           } as android.surfaceflinger.ILayerProto,
         },
+        {
+          id: 9,
+          name: 'touchableLayerWithNoFrame',
+          properties: {
+            id: 9,
+            name: 'touchableLayerWithNoFrame',
+            cornerRadius: 0,
+            layerStack: 1,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            z: 2,
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: 0,
+              frame: {},
+              touchableRegion: {
+                rect: [
+                  {
+                    left: -999,
+                    top: -999,
+                    right: 999,
+                    bottom: 999,
+                  },
+                ],
+              },
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
       ])
       .build();
 
@@ -1157,6 +973,23 @@ describe('SurfaceFlinger RectsComputation', () => {
         .setIsSpy(false)
         .setFillRegion(new Region([new Rect(0, 0, 2, 2)]))
         .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(0)
+        .setHeight(0)
+        .setId('9')
+        .setName('touchableLayerWithNoFrame')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(2)
+        .setGroupId(1)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .setFillRegion(new Region([new Rect(0, 0, 6, 7)]))
+        .build(),
     ];
 
     const expectedDisplayRects = [
@@ -1179,8 +1012,8 @@ describe('SurfaceFlinger RectsComputation', () => {
       new TraceRectBuilder()
         .setX(0)
         .setY(0)
-        .setWidth(5)
-        .setHeight(5)
+        .setWidth(6)
+        .setHeight(7)
         .setId('Display - 2')
         .setName('Test Display 2')
         .setCornerRadius(0)
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
index 9bcb54738..0923e4b98 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
@@ -49,15 +49,14 @@ export class VisibilityPropertiesComputation implements Computation {
     this.displays =
       this.root.getEagerPropertyByName('displays')?.getAllChildren().slice() ??
       [];
-
-    const layersOrderedByZ = LayerExtractor.extractLayersSortedByZ(
+    const topDownTraversal = LayerExtractor.extractLayersTopToBottom(
       assertDefined(this.root),
     );
 
     const opaqueLayers: HierarchyTreeNode[] = [];
     const translucentLayers: HierarchyTreeNode[] = [];
 
-    for (const layer of layersOrderedByZ) {
+    for (const layer of topDownTraversal) {
       let isVisible = this.getIsVisible(layer);
       if (!isVisible) {
         layer.addEagerProperty(
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
index f0520da99..5a189d8c6 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
@@ -78,7 +78,7 @@ describe('VisibilityPropertiesComputation', () => {
               children: [],
               visibleRegion: {rect: [rect1x1]},
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -145,7 +145,7 @@ describe('VisibilityPropertiesComputation', () => {
                 children: [],
                 visibleRegion: {rect: [rect1x1]},
                 layerStack: 0,
-                zOrderPath: [0, 0],
+                z: 0,
                 zOrderRelativeOf: 3,
                 screenBounds: null,
                 isOpaque: false,
@@ -165,7 +165,7 @@ describe('VisibilityPropertiesComputation', () => {
               children: [],
               visibleRegion: {rect: [rect1x1]},
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -226,7 +226,7 @@ describe('VisibilityPropertiesComputation', () => {
               flags: 0,
               color: {r: 0, g: 0, b: 0, a: 0},
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -293,7 +293,7 @@ describe('VisibilityPropertiesComputation', () => {
               bounds: {left: 0, right: 0, top: 0, bottom: 0},
               excludesCompositionState: true,
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -331,7 +331,7 @@ describe('VisibilityPropertiesComputation', () => {
               children: [],
               visibleRegion: null,
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -371,7 +371,7 @@ describe('VisibilityPropertiesComputation', () => {
               children: [],
               visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 0}]},
               layerStack: 0,
-              zOrderPath: [0],
+              z: 0,
               screenBounds: null,
               isOpaque: false,
             } as android.surfaceflinger.ILayerProto,
@@ -408,8 +408,8 @@ describe('VisibilityPropertiesComputation', () => {
         ],
       })
       .setChildren([
-        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', [0], rect1x1),
-        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', [1], rect2x2),
+        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', 0, rect1x1),
+        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', 1, rect2x2),
       ])
       .build();
 
@@ -439,8 +439,8 @@ describe('VisibilityPropertiesComputation', () => {
         ],
       })
       .setChildren([
-        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', [0], rect1x1),
-        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', [1], rect2x2),
+        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', 0, rect1x1),
+        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', 1, rect2x2),
         {
           id: 3,
           name: 'coveringLayer',
@@ -451,7 +451,7 @@ describe('VisibilityPropertiesComputation', () => {
               parent: -1,
               children: [],
               layerStack: 0,
-              zOrderPath: [2],
+              z: 2,
               screenBounds: rect2x2,
               visibleRegion: {rect: [rect2x2]},
               activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
@@ -503,8 +503,8 @@ describe('VisibilityPropertiesComputation', () => {
         ],
       })
       .setChildren([
-        getChildHierarchyForOpaqueLayer(1, 'visibleLayer1', [0], rect1x1, 0),
-        getChildHierarchyForOpaqueLayer(2, 'visibleLayer2', [0], rect1x1, 1),
+        getChildHierarchyForOpaqueLayer(1, 'visibleLayer1', 0, rect1x1, 0),
+        getChildHierarchyForOpaqueLayer(2, 'visibleLayer2', 0, rect1x1, 1),
       ])
       .build();
 
@@ -537,16 +537,16 @@ describe('VisibilityPropertiesComputation', () => {
         getChildHierarchyForOpaqueLayer(
           1,
           'partiallyOccludedLayer',
-          [0],
+          0,
           rect2x2,
         ),
         getChildHierarchyForOpaqueLayer(
           2,
           'partiallyOccludingLayer',
-          [1],
+          1,
           rect1x1,
         ),
-        getChildHierarchyForOpaqueLayer(3, 'nonOccludingLayer', [1], {
+        getChildHierarchyForOpaqueLayer(3, 'nonOccludingLayer', 1, {
           left: 3,
           top: 3,
           bottom: 4,
@@ -585,8 +585,8 @@ describe('VisibilityPropertiesComputation', () => {
         ],
       })
       .setChildren([
-        getChildHierarchyForTranslucentLayer(1, 'coveredLayer', [0], rect2x2),
-        getChildHierarchyForTranslucentLayer(2, 'coveringLayer', [1], rect1x1),
+        getChildHierarchyForTranslucentLayer(1, 'coveredLayer', 0, rect2x2),
+        getChildHierarchyForTranslucentLayer(2, 'coveringLayer', 1, rect1x1),
       ])
       .build();
 
@@ -603,7 +603,7 @@ describe('VisibilityPropertiesComputation', () => {
     checkVisibleLayer(visibleLayer, [], []);
   });
 
-  it('computes occlusion state based on z order path', () => {
+  it('computes occlusion state based on z order', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -616,8 +616,8 @@ describe('VisibilityPropertiesComputation', () => {
         ],
       })
       .setChildren([
-        getChildHierarchyForOpaqueLayer(1, 'occludingLayer', [1], rect2x2),
-        getChildHierarchyForOpaqueLayer(2, 'occludedLayer', [0], rect1x1),
+        getChildHierarchyForOpaqueLayer(1, 'occludingLayer', 1, rect2x2),
+        getChildHierarchyForOpaqueLayer(2, 'occludedLayer', 0, rect1x1),
       ])
       .build();
 
@@ -653,7 +653,7 @@ describe('VisibilityPropertiesComputation', () => {
           activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
           color: {r: 0, g: 0, b: 0, a: 1},
           layerStack: 0,
-          zOrderPath: [0],
+          z: 0,
           screenBounds: null,
           isOpaque: false,
         } as android.surfaceflinger.ILayerProto,
@@ -682,7 +682,7 @@ describe('VisibilityPropertiesComputation', () => {
           color: {r: 0, g: 0, b: 0, a: 0},
           activeBuffer,
           layerStack: 0,
-          zOrderPath: [0],
+          z: 0,
           screenBounds: null,
           isOpaque: false,
         } as android.surfaceflinger.ILayerProto,
@@ -711,7 +711,7 @@ describe('VisibilityPropertiesComputation', () => {
   function getChildHierarchyForOpaqueLayer(
     id: number,
     name: string,
-    zOrderPath: number[],
+    z: number,
     bounds: android.surfaceflinger.IRectProto,
     layerStack = 0,
   ) {
@@ -726,7 +726,7 @@ describe('VisibilityPropertiesComputation', () => {
           children: [],
           layerStack,
           isOpaque: true,
-          zOrderPath,
+          z,
           screenBounds: bounds,
           visibleRegion: {rect: [bounds]},
         } as android.surfaceflinger.ILayerProto,
@@ -738,7 +738,7 @@ describe('VisibilityPropertiesComputation', () => {
   function getChildHierarchyForTranslucentLayer(
     id: number,
     name: string,
-    zOrderPath: number[],
+    z: number,
     bounds: android.surfaceflinger.IRectProto,
     layerStack = 0,
   ) {
@@ -753,7 +753,7 @@ describe('VisibilityPropertiesComputation', () => {
           children: [],
           layerStack,
           isOpaque: false,
-          zOrderPath,
+          z,
           screenBounds: bounds,
           visibleRegion: {rect: [bounds]},
         } as android.surfaceflinger.ILayerProto,
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
index 7c17bc711..6a29bb05b 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
@@ -31,32 +31,26 @@ export class ZOrderPathsComputation implements Computation {
     if (!this.root) {
       throw new Error('root not set in SF z-order paths computation');
     }
-
-    this.updateZOrderParents(this.root);
-    this.root.forEachNodeDfs((node) => {
-      if (node.id === 'LayerTraceEntry root') return;
-      const zOrderPath = this.getZOrderPath(node);
-      node.addEagerProperty(
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          `${node.id}`,
-          'zOrderPath',
-          zOrderPath,
-        ),
-      );
-    });
+    const layerIdToTreeNode = this.makeMapOfIdToNode();
+    this.updateZOrderParents(layerIdToTreeNode);
   }
 
-  private updateZOrderParents(root: HierarchyTreeNode) {
+  private makeMapOfIdToNode(): Map<number, HierarchyTreeNode> {
     const layerIdToTreeNode = new Map<number, HierarchyTreeNode>();
-    root.forEachNodeDfs((node) => {
+    assertDefined(this.root).forEachNodeDfs((node) => {
       if (node.isRoot()) return;
       layerIdToTreeNode.set(
         assertDefined(node.getEagerPropertyByName('id')).getValue(),
         node,
       );
     });
+    return layerIdToTreeNode;
+  }
 
-    root.forEachNodeDfs((node) => {
+  private updateZOrderParents(
+    layerIdToTreeNode: Map<number, HierarchyTreeNode>,
+  ) {
+    assertDefined(this.root).forEachNodeDfs((node) => {
       const zOrderRelativeOf = node
         .getEagerPropertyByName('zOrderRelativeOf')
         ?.getValue();
@@ -73,40 +67,8 @@ export class ZOrderPathsComputation implements Computation {
           return;
         }
         node.setZParent(zParent);
-
-        // add rel-z children to zParent
-        const existingRelZChildren =
-          zParent.getEagerPropertyByName('relZChildren');
-        if (existingRelZChildren) {
-          zParent.addEagerProperty(
-            DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-              zParent.id,
-              'relZChildren',
-              existingRelZChildren
-                .getAllChildren()
-                .map((c) => c.getValue())
-                .concat([node.id]),
-            ),
-          );
-        } else {
-          zParent.addEagerProperty(
-            DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-              zParent.id,
-              'relZChildren',
-              [node.id],
-            ),
-          );
-        }
+        zParent.addRelativeChild(node);
       }
     });
   }
-
-  private getZOrderPath(node: HierarchyTreeNode | undefined): number[] {
-    if (!node) return [];
-
-    const zOrderPath = this.getZOrderPath(node.getZParent());
-    const z = node.getEagerPropertyByName('z')?.getValue();
-    if (z !== undefined) zOrderPath.push(z);
-    return zOrderPath;
-  }
 }
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
index c78db305b..100efedb4 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
@@ -17,7 +17,6 @@
 import {assertDefined} from 'common/assert_utils';
 import {android} from 'protos/surfaceflinger/udc/static';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {ZOrderPathsComputation} from './z_order_paths_computation';
 
 describe('ZOrderPathsComputation', () => {
@@ -31,7 +30,7 @@ describe('ZOrderPathsComputation', () => {
     expect(() => computation.executeInPlace()).toThrowError();
   });
 
-  it('calculates zOrderPath for tree without rel z parent', () => {
+  it('does not affect tree without rel z parents set', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -92,34 +91,23 @@ describe('ZOrderPathsComputation', () => {
       .build();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    const layer1WithPath = assertDefined(
-      hierarchyRoot.getChildByName('layer1'),
-    );
-    const layer2WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer2'),
-    );
-    const layer3WithPath = assertDefined(
-      layer2WithPath.getChildByName('layer3'),
-    );
-    const layer4WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer4'),
-    );
+    const layer1 = assertDefined(hierarchyRoot.getChildByName('layer1'));
+    const layer2 = assertDefined(layer1.getChildByName('layer2'));
+    const layer3 = assertDefined(layer2.getChildByName('layer3'));
+    const layer4 = assertDefined(layer1.getChildByName('layer4'));
 
-    expect(
-      getZOrderPathArray(layer1WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0]);
-    expect(
-      getZOrderPathArray(layer2WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1]);
-    expect(
-      getZOrderPathArray(layer3WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1, 1]);
-    expect(
-      getZOrderPathArray(layer4WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 2]);
+    expect(layer1.getRelativeChildren()).toEqual([]);
+    expect(layer2.getRelativeChildren()).toEqual([]);
+    expect(layer3.getRelativeChildren()).toEqual([]);
+    expect(layer4.getRelativeChildren()).toEqual([]);
+
+    expect(layer1.getZParent()).toEqual(layer1.getParent());
+    expect(layer2.getZParent()).toEqual(layer2.getParent());
+    expect(layer3.getZParent()).toEqual(layer3.getParent());
+    expect(layer4.getZParent()).toEqual(layer4.getParent());
   });
 
-  it('calculates zOrderPath and adds rel z children properties for tree with rel z parent', () => {
+  it('updates tree with rel z parent', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -178,47 +166,20 @@ describe('ZOrderPathsComputation', () => {
       .build();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    const layer1WithPath = assertDefined(
-      hierarchyRoot.getChildByName('layer1'),
-    );
-    const layer2WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer2'),
-    );
-    const layer4WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer4'),
-    );
-    const layer5WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer5'),
-    );
+    const layer1 = assertDefined(hierarchyRoot.getChildByName('layer1'));
+    const layer2 = assertDefined(layer1.getChildByName('layer2'));
+    const layer4 = assertDefined(layer1.getChildByName('layer4'));
+    const layer5 = assertDefined(layer1.getChildByName('layer5'));
 
-    expect(
-      getZOrderPathArray(layer1WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0]);
-    expect(
-      getZOrderPathArray(layer2WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1]);
-    expect(
-      getZOrderPathArray(layer4WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1, 2]);
-    expect(
-      getZOrderPathArray(layer5WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1, 2]);
+    expect(layer1.getRelativeChildren()).toEqual([]);
+    expect(layer2.getRelativeChildren()).toEqual([layer4, layer5]);
+    expect(layer4.getRelativeChildren()).toEqual([]);
+    expect(layer5.getRelativeChildren()).toEqual([]);
 
-    expect(
-      layer1WithPath.getEagerPropertyByName('relZChildren'),
-    ).toBeUndefined();
-    expect(
-      layer2WithPath
-        .getEagerPropertyByName('relZChildren')
-        ?.getAllChildren()
-        .map((c) => c.formattedValue()),
-    ).toEqual([layer4WithPath.id, layer5WithPath.id]);
-    expect(
-      layer4WithPath.getEagerPropertyByName('relZChildren'),
-    ).toBeUndefined();
-    expect(
-      layer5WithPath.getEagerPropertyByName('relZChildren'),
-    ).toBeUndefined();
+    expect(layer1.getZParent()).toEqual(layer1.getParent());
+    expect(layer2.getZParent()).toEqual(layer2.getParent());
+    expect(layer4.getZParent()).toEqual(layer2);
+    expect(layer5.getZParent()).toEqual(layer2);
   });
 
   it('adds isMissingZParent chip', () => {
@@ -268,34 +229,19 @@ describe('ZOrderPathsComputation', () => {
       .build();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    const layer1WithPath = assertDefined(
-      hierarchyRoot.getChildByName('layer1'),
-    );
-    const layer2WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer2'),
-    );
-    const layer4WithPath = assertDefined(
-      layer1WithPath.getChildByName('layer4'),
-    );
-
-    expect(
-      getZOrderPathArray(layer1WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0]);
+    const layer1 = assertDefined(hierarchyRoot.getChildByName('layer1'));
+    const layer2 = assertDefined(layer1.getChildByName('layer2'));
+    const layer4 = assertDefined(layer1.getChildByName('layer4'));
     expect(
-      getZOrderPathArray(layer2WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 1]);
-    expect(
-      getZOrderPathArray(layer4WithPath.getEagerPropertyByName('zOrderPath')),
-    ).toEqual([0, 2]);
-    expect(
-      layer4WithPath.getEagerPropertyByName('isMissingZParent')?.getValue(),
+      layer4.getEagerPropertyByName('isMissingZParent')?.getValue(),
     ).toBeTrue();
-  });
 
-  function getZOrderPathArray(
-    property: PropertyTreeNode | undefined,
-  ): number[] {
-    if (!property) return [];
-    return property.getAllChildren().map((child) => Number(child.getValue()));
-  }
+    expect(layer1.getRelativeChildren()).toEqual([]);
+    expect(layer2.getRelativeChildren()).toEqual([]);
+    expect(layer4.getRelativeChildren()).toEqual([]);
+
+    expect(layer1.getZParent()).toEqual(layer1.getParent());
+    expect(layer2.getZParent()).toEqual(layer2.getParent());
+    expect(layer4.getZParent()).toEqual(layer4.getParent());
+  });
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts
index c17a58e68..54ecd0475 100644
--- a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts
+++ b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts
@@ -16,7 +16,7 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {UserNotifier} from 'common/user_notifier';
-import {MissingLayerIds} from 'messaging/user_warnings';
+import {DuplicateLayerIds, MissingLayerIds} from 'messaging/user_warnings';
 import {perfetto} from 'protos/surfaceflinger/latest/static';
 import {android} from 'protos/surfaceflinger/udc/static';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
@@ -122,7 +122,17 @@ export class EntryHierarchyTreeFactory {
         new RectsComputation(),
       ])
       .build();
-    UserNotifier.notify();
+
+    if (missingLayerIds) {
+      tree.addWarning(new MissingLayerIds());
+    }
+    const duplicateIds = Array.from(processed.keys()).filter(
+      (layerId) => assertDefined(processed.get(layerId)) > 1,
+    );
+    if (duplicateIds.length > 0) {
+      tree.addWarning(new DuplicateLayerIds(duplicateIds));
+    }
+
     return tree;
   }
 
diff --git a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts
index 5a87371d1..e7f5af639 100644
--- a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {MissingLayerIds} from 'messaging/user_warnings';
+import {DuplicateLayerIds, MissingLayerIds} from 'messaging/user_warnings';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {EntryHierarchyTreeFactory} from './entry_hierarchy_tree_factory';
 import {ParserSurfaceFlinger} from './legacy/parser_surface_flinger';
@@ -46,6 +46,29 @@ describe('EntryHierarchyTreeFactory', () => {
     );
     expect(tree.getAllChildren().length).toEqual(1);
     expect(tree.getChildByName('Test layer')).toBeDefined();
-    userNotifierChecker.expectNotified([new MissingLayerIds()]);
+    expect(tree.getWarnings()).toEqual([new MissingLayerIds()]);
+  });
+
+  it('handles duplicate layer ids', () => {
+    const entryProto = {};
+    const layerProtos = [
+      {
+        id: 0,
+        name: 'Test layer',
+      },
+      {
+        id: 0,
+        name: 'Test layer',
+      },
+    ];
+    const tree = factory.makeEntryHierarchyTree(
+      entryProto,
+      layerProtos,
+      ParserSurfaceFlinger,
+    );
+    expect(tree.getAllChildren().length).toEqual(2);
+    expect(tree.getChildByName('Test layer')).toBeDefined();
+    expect(tree.getChildByName('Test layer duplicate(1)')).toBeDefined();
+    expect(tree.getWarnings()).toEqual([new DuplicateLayerIds([0])]);
   });
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
index 0e9570999..fccc6268f 100644
--- a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
+++ b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
@@ -15,8 +15,6 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {UserNotifier} from 'common/user_notifier';
-import {DuplicateLayerId} from 'messaging/user_warnings';
 import {HierarchyTreeBuilder} from 'parsers/hierarchy_tree_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
@@ -44,7 +42,6 @@ export class HierarchyTreeBuilderSf extends HierarchyTreeBuilder {
       const curr = map.get(layerId);
       if (curr) {
         curr.push(layerNode);
-        UserNotifier.add(new DuplicateLayerId(layerId.toString()));
         layer.addEagerProperty(
           DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
             layerProperties.id,
diff --git a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
index e87a71de9..2af4b321a 100644
--- a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
@@ -14,7 +14,6 @@
  * limitations under the License.
  */
 
-import {DuplicateLayerId} from 'messaging/user_warnings';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
@@ -221,7 +220,6 @@ describe('HierarchyTreeBuilderSf', () => {
     expectedRoot.addOrReplaceChild(expectedRootLayer);
 
     expect(root).toEqual(expectedRoot);
-    userNotifierChecker.expectAdded([new DuplicateLayerId('2')]);
   });
 
   it('builds root with default parent values correctly', () => {
diff --git a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
index 79209e5a2..95f371764 100644
--- a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
-import {DuplicateLayerId} from 'messaging/user_warnings';
+import {DuplicateLayerIds} from 'messaging/user_warnings';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
@@ -149,7 +149,9 @@ describe('ParserSurfaceFlinger', () => {
         'traces/elapsed_and_real_timestamp/SurfaceFlinger_with_duplicated_ids.pb',
       )) as Parser<HierarchyTreeNode>;
       const entry = await parser.getEntry(0);
-      expect(entry).toBeTruthy();
+      expect(entry.getWarnings()).toEqual([
+        new DuplicateLayerIds([-2147483595]),
+      ]);
 
       const layer = assertDefined(
         entry.findDfs(
@@ -175,7 +177,6 @@ describe('ParserSurfaceFlinger', () => {
         'Input Consumer recents_animation_input_consumer#408(Mirror) duplicate(1)',
       );
       expect(dupLayer.getAllChildren().length).toEqual(0);
-      userNotifierChecker.expectNotified([new DuplicateLayerId('-2147483595')]);
     });
   });
 
diff --git a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
index 4ee00ad9a..3a1517fb0 100644
--- a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
-import {DuplicateLayerId} from 'messaging/user_warnings';
+import {DuplicateLayerIds} from 'messaging/user_warnings';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
@@ -152,7 +152,9 @@ describe('Perfetto ParserSurfaceFlinger', () => {
         'traces/perfetto/layers_trace_with_duplicated_ids.perfetto-trace',
       );
       const entry = await parser.getEntry(0);
-      expect(entry).toBeTruthy();
+      expect(entry.getWarnings()).toEqual([
+        new DuplicateLayerIds([-2147483595]),
+      ]);
 
       const layer = assertDefined(
         entry.findDfs(
@@ -173,12 +175,10 @@ describe('Perfetto ParserSurfaceFlinger', () => {
           ),
         ),
       );
-
       expect(dupLayer.name).toEqual(
         'Input Consumer recents_animation_input_consumer#408(Mirror) duplicate(1)',
       );
       expect(dupLayer.getAllChildren().length).toEqual(0);
-      userNotifierChecker.expectNotified([new DuplicateLayerId('-2147483595')]);
     });
   });
 });
diff --git a/tools/winscope/src/parsers/transitions/parser_transitions_utils.ts b/tools/winscope/src/parsers/transitions/entry_properties_tree_factory.ts
similarity index 84%
rename from tools/winscope/src/parsers/transitions/parser_transitions_utils.ts
rename to tools/winscope/src/parsers/transitions/entry_properties_tree_factory.ts
index ed7570a49..058440524 100644
--- a/tools/winscope/src/parsers/transitions/parser_transitions_utils.ts
+++ b/tools/winscope/src/parsers/transitions/entry_properties_tree_factory.ts
@@ -23,6 +23,7 @@ import {
   MakeTimestampStrategyType,
   TransformToTimestamp,
 } from 'parsers/operations/transform_to_timestamp';
+import {TranslateIntDef} from 'parsers/operations/translate_intdef';
 import {TamperedMessageType} from 'parsers/tampered_message_type';
 import {perfetto} from 'protos/transitions/latest/static';
 import root from 'protos/transitions/udc/json';
@@ -51,7 +52,7 @@ interface TransitionInfo {
   handlerMapping?: {[key: number]: string};
 }
 
-export class ParserTransitionsUtils {
+export class EntryPropertiesTreeFactory {
   static readonly TRANSITION_OPERATIONS = [
     new AddDuration(),
     new AddStatus(),
@@ -62,11 +63,14 @@ export class ParserTransitionsUtils {
     root.lookupType('com.android.server.wm.shell.TransitionTraceProto'),
   );
   private static readonly TransitionField =
-    ParserTransitionsUtils.TransitionTraceProto.fields['transitions'];
+    EntryPropertiesTreeFactory.TransitionTraceProto.fields['transitions'];
   private static readonly WM_ADD_DEFAULTS_OPERATION = new AddDefaults(
-    ParserTransitionsUtils.TransitionField,
+    EntryPropertiesTreeFactory.TransitionField,
     ['type', 'targets'],
   );
+  private static WM_INTDEF_OPERATION = new TranslateIntDef(
+    EntryPropertiesTreeFactory.TransitionField,
+  );
   private static readonly SET_FORMATTERS_OPERATION = new SetFormatters();
   private static readonly PERFETTO_TRANSITION_OPERATIONS = [
     new UpdateAbortTimeNodes(),
@@ -92,7 +96,7 @@ export class ParserTransitionsUtils {
     transitionTree.addOrReplaceChild(
       assertDefined(wmEntryTree.getChildByName('wmData')),
     );
-    ParserTransitionsUtils.TRANSITION_OPERATIONS.forEach((operation) =>
+    EntryPropertiesTreeFactory.TRANSITION_OPERATIONS.forEach((operation) =>
       operation.apply(transitionTree),
     );
     return transitionTree;
@@ -111,12 +115,12 @@ export class ParserTransitionsUtils {
       .build();
 
     if (!info) {
-      ParserTransitionsUtils.SET_FORMATTERS_OPERATION.apply(tree);
+      EntryPropertiesTreeFactory.SET_FORMATTERS_OPERATION.apply(tree);
       return tree;
     }
 
     if (denylistProperties.length > 0) {
-      ParserTransitionsUtils.PERFETTO_TRANSITION_OPERATIONS.forEach(
+      EntryPropertiesTreeFactory.PERFETTO_TRANSITION_OPERATIONS.forEach(
         (operation) => operation.apply(tree),
       );
     }
@@ -134,7 +138,7 @@ export class ParserTransitionsUtils {
     new AddRealToBootTimeOffsetTimestamp(realToBootTimeOffsetTimestamp).apply(
       wmDataNode,
     );
-    ParserTransitionsUtils.WM_ADD_DEFAULTS_OPERATION.apply(wmDataNode);
+    EntryPropertiesTreeFactory.WM_ADD_DEFAULTS_OPERATION.apply(wmDataNode);
     new TransformToTimestamp(
       [
         'abortTimeNs',
@@ -143,12 +147,12 @@ export class ParserTransitionsUtils {
         'finishTimeNs',
         'startingWindowRemoveTimeNs',
       ],
-      ParserTransitionsUtils.makeTimestampStrategy(info.timestampConverter),
+      EntryPropertiesTreeFactory.makeTimestampStrategy(info.timestampConverter),
     ).apply(wmDataNode);
 
     const customFormatters = new Map<string, PropertyFormatter>([
-      ['type', ParserTransitionsUtils.TRANSITION_TYPE_FORMATTER],
-      ['mode', ParserTransitionsUtils.TRANSITION_TYPE_FORMATTER],
+      ['type', EntryPropertiesTreeFactory.TRANSITION_TYPE_FORMATTER],
+      ['mode', EntryPropertiesTreeFactory.TRANSITION_TYPE_FORMATTER],
       ['abortTimeNs', TIMESTAMP_NODE_FORMATTER],
       ['createTimeNs', TIMESTAMP_NODE_FORMATTER],
       ['sendTimeNs', TIMESTAMP_NODE_FORMATTER],
@@ -157,6 +161,8 @@ export class ParserTransitionsUtils {
     ]);
 
     new SetFormatters(undefined, customFormatters).apply(tree);
+
+    EntryPropertiesTreeFactory.WM_INTDEF_OPERATION.apply(tree);
     return tree;
   }
 
@@ -173,12 +179,12 @@ export class ParserTransitionsUtils {
       .build();
 
     if (!info) {
-      ParserTransitionsUtils.SET_FORMATTERS_OPERATION.apply(tree);
+      EntryPropertiesTreeFactory.SET_FORMATTERS_OPERATION.apply(tree);
       return tree;
     }
 
     if (denylistProperties.length > 0) {
-      ParserTransitionsUtils.PERFETTO_TRANSITION_OPERATIONS.forEach(
+      EntryPropertiesTreeFactory.PERFETTO_TRANSITION_OPERATIONS.forEach(
         (operation) => operation.apply(tree),
       );
     }
@@ -197,12 +203,12 @@ export class ParserTransitionsUtils {
     );
     new TransformToTimestamp(
       ['dispatchTimeNs', 'mergeRequestTimeNs', 'mergeTimeNs', 'abortTimeNs'],
-      ParserTransitionsUtils.makeTimestampStrategy(info.timestampConverter),
+      EntryPropertiesTreeFactory.makeTimestampStrategy(info.timestampConverter),
     ).apply(shellDataNode);
 
     const customFormatters = new Map<string, PropertyFormatter>([
-      ['type', ParserTransitionsUtils.TRANSITION_TYPE_FORMATTER],
-      ['mode', ParserTransitionsUtils.TRANSITION_TYPE_FORMATTER],
+      ['type', EntryPropertiesTreeFactory.TRANSITION_TYPE_FORMATTER],
+      ['mode', EntryPropertiesTreeFactory.TRANSITION_TYPE_FORMATTER],
       ['dispatchTimeNs', TIMESTAMP_NODE_FORMATTER],
       ['mergeRequestTimeNs', TIMESTAMP_NODE_FORMATTER],
       ['mergeTimeNs', TIMESTAMP_NODE_FORMATTER],
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
index 5de877462..e38cef95b 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
@@ -16,7 +16,7 @@
 
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
-import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
+import {EntryPropertiesTreeFactory} from 'parsers/transitions/entry_properties_tree_factory';
 import root from 'protos/transitions/udc/json';
 import {com} from 'protos/transitions/udc/static';
 import {TraceType} from 'trace/trace_type';
@@ -113,15 +113,15 @@ export class ParserTransitionsShell extends AbstractParser<PropertyTreeNode> {
   ): PropertyTreeNode {
     this.validateShellTransitionEntry(entryProto);
 
-    const shellEntryTree = ParserTransitionsUtils.makeShellPropertiesTree({
+    const shellEntryTree = EntryPropertiesTreeFactory.makeShellPropertiesTree({
       entry: entryProto,
       realToBootTimeOffsetNs: this.realToBootTimeOffsetNs,
       handlerMapping: this.handlerMapping,
       timestampConverter: this.timestampConverter,
     });
-    const wmEntryTree = ParserTransitionsUtils.makeWmPropertiesTree();
+    const wmEntryTree = EntryPropertiesTreeFactory.makeWmPropertiesTree();
 
-    return ParserTransitionsUtils.makeTransitionPropertiesTree(
+    return EntryPropertiesTreeFactory.makeTransitionPropertiesTree(
       shellEntryTree,
       wmEntryTree,
     );
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell_test.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell_test.ts
index fa76d315e..5bdaaf6f6 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell_test.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell_test.ts
@@ -22,7 +22,7 @@ import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
-describe('ShellFileParserTransitions', () => {
+describe('ParserTransitionsShell', () => {
   let parser: Parser<PropertyTreeNode>;
 
   beforeAll(async () => {
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
index bf46a9da8..8a5bde0b1 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
@@ -16,7 +16,7 @@
 
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
-import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
+import {EntryPropertiesTreeFactory} from 'parsers/transitions/entry_properties_tree_factory';
 import root from 'protos/transitions/udc/json';
 import {com} from 'protos/transitions/udc/static';
 import {TraceType} from 'trace/trace_type';
@@ -100,14 +100,14 @@ export class ParserTransitionsWm extends AbstractParser<PropertyTreeNode> {
   ): PropertyTreeNode {
     this.validateWmTransitionEntry(entryProto);
 
-    const shellEntryTree = ParserTransitionsUtils.makeShellPropertiesTree();
-    const wmEntryTree = ParserTransitionsUtils.makeWmPropertiesTree({
+    const shellEntryTree = EntryPropertiesTreeFactory.makeShellPropertiesTree();
+    const wmEntryTree = EntryPropertiesTreeFactory.makeWmPropertiesTree({
       entry: entryProto,
       realToBootTimeOffsetNs: this.realToBootTimeOffsetNs,
       timestampConverter: this.timestampConverter,
     });
 
-    return ParserTransitionsUtils.makeTransitionPropertiesTree(
+    return EntryPropertiesTreeFactory.makeTransitionPropertiesTree(
       shellEntryTree,
       wmEntryTree,
     );
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
index ff25c3ef6..bc9deb403 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
@@ -22,7 +22,7 @@ import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
-describe('WmFileParserTransitions', () => {
+describe('ParserTransitionsWm', () => {
   let parser: Parser<PropertyTreeNode>;
 
   beforeAll(async () => {
@@ -35,6 +35,7 @@ describe('WmFileParserTransitions', () => {
   it('has expected trace type', () => {
     expect(parser.getTraceType()).toEqual(TraceType.WM_TRANSITION);
   });
+
   it('has expected coarse version', () => {
     expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LEGACY);
   });
@@ -45,4 +46,19 @@ describe('WmFileParserTransitions', () => {
     const expected = TimestampConverterUtils.makeZeroTimestamp();
     timestamps.forEach((timestamp) => expect(timestamp).toEqual(expected));
   });
+
+  it('translates flags', async () => {
+    const entry = await parser.getEntry(4);
+    expect(
+      entry.getChildByName('wmData')?.getChildByName('flags')?.formattedValue(),
+    ).toEqual('TRANSIT_FLAG_IS_RECENTS');
+
+    const targets = entry.getChildByName('wmData')?.getChildByName('targets');
+    expect(
+      targets?.getChildByName('0')?.getChildByName('flags')?.formattedValue(),
+    ).toEqual('FLAG_MOVED_TO_TOP | FLAG_SHOW_WALLPAPER');
+    expect(
+      targets?.getChildByName('1')?.getChildByName('flags')?.formattedValue(),
+    ).toEqual('FLAG_NONE');
+  });
 });
diff --git a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
index 551f71ec2..6e96b51a5 100644
--- a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
@@ -18,7 +18,7 @@ import {assertDefined} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
 import {AbstractTracesParser} from 'parsers/traces/abstract_traces_parser';
-import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
+import {EntryPropertiesTreeFactory} from 'parsers/transitions/entry_properties_tree_factory';
 import {CoarseVersion} from 'trace/coarse_version';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
@@ -147,7 +147,7 @@ export class TracesParserTransitions extends AbstractTracesParser<PropertyTreeNo
 
     const compressedTransitions = Array.from(idToTransition.values());
     compressedTransitions.forEach((transition) => {
-      ParserTransitionsUtils.TRANSITION_OPERATIONS.forEach((operation) =>
+      EntryPropertiesTreeFactory.TRANSITION_OPERATIONS.forEach((operation) =>
         operation.apply(transition),
       );
     });
diff --git a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
index 2c54cf385..bb9722bd8 100644
--- a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
+++ b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
@@ -16,7 +16,7 @@
 import {assertDefined} from 'common/assert_utils';
 import {AbstractParser} from 'parsers/perfetto/abstract_parser';
 import {FakeProtoBuilder} from 'parsers/perfetto/fake_proto_builder';
-import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
+import {EntryPropertiesTreeFactory} from 'parsers/transitions/entry_properties_tree_factory';
 import {perfetto} from 'protos/transitions/latest/static';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -89,7 +89,7 @@ export class ParserTransitions extends AbstractParser<PropertyTreeNode> {
       timestampConverter: this.timestampConverter,
     };
 
-    const shellEntryTree = ParserTransitionsUtils.makeShellPropertiesTree(
+    const shellEntryTree = EntryPropertiesTreeFactory.makeShellPropertiesTree(
       perfettoTransitionInfo,
       [
         'createTimeNs',
@@ -104,7 +104,7 @@ export class ParserTransitions extends AbstractParser<PropertyTreeNode> {
         'startingWindowRemoveTimeNs',
       ],
     );
-    const wmEntryTree = ParserTransitionsUtils.makeWmPropertiesTree(
+    const wmEntryTree = EntryPropertiesTreeFactory.makeWmPropertiesTree(
       perfettoTransitionInfo,
       [
         'dispatchTimeNs',
@@ -116,7 +116,7 @@ export class ParserTransitions extends AbstractParser<PropertyTreeNode> {
       ],
     );
 
-    return ParserTransitionsUtils.makeTransitionPropertiesTree(
+    return EntryPropertiesTreeFactory.makeTransitionPropertiesTree(
       shellEntryTree,
       wmEntryTree,
     );
diff --git a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
index 3f6118b9c..687576eac 100644
--- a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
+++ b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
@@ -106,6 +106,12 @@ describe('Perfetto ParserTransitions', () => {
       expect(
         assertDefined(targets[1].getChildByName('mode')).formattedValue(),
       ).toEqual('TO_BACK');
+      expect(
+        assertDefined(targets[0].getChildByName('flags')).formattedValue(),
+      ).toEqual('FLAG_MOVED_TO_TOP');
+      expect(
+        assertDefined(targets[1].getChildByName('flags')).formattedValue(),
+      ).toEqual('FLAG_SHOW_WALLPAPER');
 
       expect(
         assertDefined(
@@ -119,6 +125,14 @@ describe('Perfetto ParserTransitions', () => {
       expect(
         assertDefined(shellDataNode.getChildByName('handler')).formattedValue(),
       ).toEqual('com.android.wm.shell.transition.DefaultMixedHandler');
+
+      const entryWithFlags = await parser.getEntry(2);
+      const wmDataWithFlags = assertDefined(
+        entryWithFlags.getChildByName('wmData'),
+      );
+      expect(
+        assertDefined(wmDataWithFlags.getChildByName('flags')).formattedValue(),
+      ).toEqual('TRANSIT_FLAG_IS_RECENTS');
     });
   });
 });
diff --git a/tools/winscope/src/parsers/transitions/transition_type.ts b/tools/winscope/src/parsers/transitions/transition_type.ts
index 327e56f04..25a8a346c 100644
--- a/tools/winscope/src/parsers/transitions/transition_type.ts
+++ b/tools/winscope/src/parsers/transitions/transition_type.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-const FIRST_CUSTOM = 1000;
+const FRST_CUSTOM = 1000;
 
 export enum TransitionType {
   UNDEFINED = -1,
@@ -31,8 +31,10 @@ export enum TransitionType {
   PIP = 10,
   WAKE = 11,
   SLEEP = 12,
+  PREPARE_BACK_NAVIGATION = 13,
+  CLOSE_PREPARE_BACK_NAVIGATION = 14,
 
-  FRST_CUSTOM = FIRST_CUSTOM,
+  FIRST_CUSTOM = FRST_CUSTOM,
   EXIT_PIP = FIRST_CUSTOM + 1,
   EXIT_PIP_TO_SPLIT = FIRST_CUSTOM + 2,
   REMOVE_PIP = FIRST_CUSTOM + 3,
diff --git a/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_test.ts b/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_test.ts
index 059b632d3..9da5135e7 100644
--- a/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_test.ts
+++ b/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_test.ts
@@ -22,6 +22,7 @@ import {Parser} from 'trace/parser';
 import {Trace} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertySource} from 'trace/tree_node/property_tree_node';
 
 describe('ParserViewCapture', () => {
   let parser: Parser<HierarchyTreeNode>;
@@ -57,6 +58,10 @@ describe('ParserViewCapture', () => {
     expect(entry.id).toEqual(
       'ViewNode com.android.launcher3.taskbar.TaskbarDragLayer@265160962',
     );
+    // check calculated properties not overridden by lazily fetched properties
+    expect(
+      (await entry.getAllProperties()).getChildByName('translationX')?.source,
+    ).toEqual(PropertySource.CALCULATED);
   });
 
   it('supports VIEW_CAPTURE_METADATA custom query', async () => {
diff --git a/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_window.ts b/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_window.ts
index 929a7290f..f02c61975 100644
--- a/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_window.ts
+++ b/tools/winscope/src/parsers/view_capture/legacy/parser_view_capture_window.ts
@@ -64,7 +64,8 @@ export class ParserViewCaptureWindow implements Parser<HierarchyTreeNode> {
     'visibility',
     'alpha',
   ];
-  private static readonly DENYLIST_PROPERTIES = ['children'];
+  private static readonly DENYLIST_PROPERTIES =
+    ParserViewCaptureWindow.EAGER_PROPERTIES.concat(['children']); // some eager properties are overridden by calculated properties - avoid reloading them on lazy fetch
 
   private static readonly Operations = {
     SetFormattersNode: new SetFormatters(NodeField),
@@ -76,9 +77,7 @@ export class ParserViewCaptureWindow implements Parser<HierarchyTreeNode> {
     AddDefaultsNodeLazy: new AddDefaults(
       NodeField,
       undefined,
-      ParserViewCaptureWindow.EAGER_PROPERTIES.concat(
-        ParserViewCaptureWindow.DENYLIST_PROPERTIES,
-      ),
+      ParserViewCaptureWindow.DENYLIST_PROPERTIES,
     ),
     SetRootTransformProperties: new SetRootTransformProperties(),
   };
diff --git a/tools/winscope/src/parsers/window_manager/denylist_properties.ts b/tools/winscope/src/parsers/window_manager/denylist_properties.ts
index 663bd0079..dcae0f7f4 100644
--- a/tools/winscope/src/parsers/window_manager/denylist_properties.ts
+++ b/tools/winscope/src/parsers/window_manager/denylist_properties.ts
@@ -14,32 +14,8 @@
  * limitations under the License.
  */
 
-import {ProtoType} from './proto_type';
-
-const commonDenylistProperties = [
+export const DENYLIST_PROPERTIES = [
   'prototype',
   'rootWindowContainer',
   'children',
 ];
-
-export const DENYLIST_PROPERTIES = new Map<ProtoType, string[]>([
-  [
-    ProtoType.WindowManagerService,
-    commonDenylistProperties.concat(['windowContainer']),
-  ],
-  [ProtoType.RootWindowContainer, commonDenylistProperties],
-  [ProtoType.WindowContainer, commonDenylistProperties],
-  [
-    ProtoType.DisplayContent,
-    commonDenylistProperties.concat(['windowContainer']),
-  ],
-  [ProtoType.DisplayArea, commonDenylistProperties],
-  [ProtoType.Task, commonDenylistProperties.concat(['windowContainer'])],
-  [ProtoType.Activity, commonDenylistProperties],
-  [ProtoType.WindowToken, commonDenylistProperties],
-  [ProtoType.WindowState, commonDenylistProperties],
-  [
-    ProtoType.TaskFragment,
-    commonDenylistProperties.concat(['windowContainer']),
-  ],
-]);
diff --git a/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts b/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
index 43e499dab..63ebe8631 100644
--- a/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
+++ b/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
@@ -53,7 +53,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.windowManagerServiceField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.WindowManagerService),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -76,7 +76,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.rootWindowContainerField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.RootWindowContainer),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -100,7 +100,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.windowContainerField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.WindowContainer),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -123,7 +123,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.displayContentField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.DisplayContent),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -146,7 +146,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.displayAreaField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.DisplayArea),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -169,7 +169,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.taskField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.Task),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -193,7 +193,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.activityField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.Activity),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -216,7 +216,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.windowTokenField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.WindowToken),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -247,7 +247,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.windowStateField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.WindowState),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
@@ -270,7 +270,7 @@ export class WmOperationLists {
           new AddDefaults(
             this.tamperedProtos.taskFragmentField,
             undefined,
-            DENYLIST_PROPERTIES.get(ProtoType.TaskFragment),
+            DENYLIST_PROPERTIES,
           ),
         ],
       },
diff --git a/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts b/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
index 0b55e13f7..be0d25ece 100644
--- a/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
+++ b/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
@@ -158,11 +158,7 @@ export class PropertiesProviderFactory {
         .setData(entry)
         .setRootId('WindowManagerState')
         .setRootName('root')
-        .setDenyList(
-          assertDefined(
-            DENYLIST_PROPERTIES.get(ProtoType.WindowManagerService),
-          ),
-        )
+        .setDenyList(assertDefined(DENYLIST_PROPERTIES))
         .build();
     };
   }
@@ -307,17 +303,13 @@ export class PropertiesProviderFactory {
       const identifier = this.getIdentifier(containerChild);
       const name = this.getName(containerChild, identifier);
       const token = this.makeToken(identifier);
-      const containerDenylistProperties = assertDefined(
-        DENYLIST_PROPERTIES.get(containerChildType),
-      );
-
       const container = this.getContainer(containerChild);
 
       return new PropertyTreeBuilderFromProto()
         .setData(container)
         .setRootId(`${containerChildType} ${token}`)
         .setRootName(name)
-        .setDenyList(containerDenylistProperties)
+        .setDenyList(DENYLIST_PROPERTIES)
         .build();
     };
   }
diff --git a/tools/winscope/src/styles.css b/tools/winscope/src/styles.css
index 1df7cc66f..e9e01b084 100644
--- a/tools/winscope/src/styles.css
+++ b/tools/winscope/src/styles.css
@@ -64,6 +64,7 @@ rects-view .displays-select .mat-form-field-flex {
 
 .mat-select-panel:has(>.select-filter) {
     max-height: 75vh;
+    max-width: unset;
 }
 
 body.dark-mode button.mat-raised-button.mat-primary,
@@ -117,6 +118,86 @@ body.dark-mode button.mat-flat-button.mat-primary {
     border-top: 8px solid transparent;
 }
 
-log-view .filters .mat-form-field-infix {
+.applied-field .mat-form-field-flex {
+    border-width: 2px;
+    border-style: solid;
+    border-color: transparent;
+}
+
+.applied-field.highlighted:not(.mat-focused) .mat-form-field-flex {
+    border-color: var(--primary);
+}
+
+.applied-field.highlighted .mat-form-field-flex {
+    background-color: var(--selected-element-color);
+}
+
+.applied-field.highlighted:not(.mat-focused) .mat-form-field-underline {
+    display: none;
+}
+
+.no-padding-field .mat-form-field-wrapper {
+    padding-bottom: 0px;
+}
+
+.no-padding-field .mat-form-field-infix, .no-border-top-field .mat-form-field-infix  {
+    border-top: 0px;
+}
+
+.center-field .mat-form-field-flex {
+    align-items: center;
+}
+
+log-view .headers .mat-form-field-infix {
+    width: 100%;
+}
+
+.warning-icon {
+    color: var(--warning-color);
+}
+.error-icon {
+    color: var(--error-color);
+}
+
+.save-field {
+    display: flex;
+    align-items: center;
+    font-size: 14px;
     width: 100%;
 }
+
+.save-field mat-form-field {
+    width: 100%;
+}
+
+.save-field button {
+    height: fit-content;
+    min-width: fit-content;
+    margin-inline-start: 10px;
+}
+
+.search-tabs .mat-tab-label {
+    min-width: 80px;
+}
+
+.search-tabs mat-tab-body {
+    padding: 12px;
+}
+
+.user-notification {
+    color: var(--contrast-text-color);
+    background-color: var(--contrast-background-color);
+    box-shadow: 0px 3px 5px -1px rgba(0, 0, 0, 0.2), 0px 6px 10px 0px rgba(0, 0, 0, 0.14), 0px 1px 18px 0px rgba(0, 0, 0, 0.12);
+    border-radius: 4px;
+    box-sizing: border-box;
+    display: block;
+    margin: 24px;
+    padding: 14px 16px;
+    transform-origin: center;
+}
+
+.disabled-component {
+    pointer-events: none;
+    opacity: 0.5;
+    filter: grayscale(1);
+}
diff --git a/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts b/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
index 5d7763de4..a2f9cd788 100644
--- a/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
+++ b/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
@@ -160,8 +160,7 @@ describe('Cross-Tool Protocol', () => {
         const handles = await browser.getAllWindowHandles();
         if (handles.length < 2) return false;
         await browser.switchTo().window(await getWindowHandleWinscope());
-        const opened = element(by.css('upload-traces'));
-        return await opened.isPresent();
+        return await element(by.css('upload-traces')).isPresent();
       },
       20000,
       'The Winscope tab did not open',
diff --git a/tools/winscope/src/test/e2e/utils.ts b/tools/winscope/src/test/e2e/utils.ts
index a8f5efa68..afed8a910 100644
--- a/tools/winscope/src/test/e2e/utils.ts
+++ b/tools/winscope/src/test/e2e/utils.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 import * as path from 'path';
-import {browser, by, element, ElementFinder} from 'protractor';
+import {browser, by, element, ElementFinder, protractor} from 'protractor';
 
 class E2eTestUtils {
   static readonly WINSCOPE_URL = 'http://localhost:8080';
@@ -78,12 +78,7 @@ class E2eTestUtils {
 
   static async clickCloseIcon() {
     const button = element.all(by.css('.uploaded-files button')).first();
-    await browser.executeScript(
-      `
-      arguments[0].click();
-    `,
-      button,
-    );
+    await button.click();
   }
 
   static async clickDownloadTracesButton() {
@@ -124,9 +119,7 @@ class E2eTestUtils {
     const text = await traceSelector.getText();
     expect(text).toContain(trace.icon);
 
-    const icons: ElementFinder[] = await element.all(
-      by.css('.shown-selection .mat-icon'),
-    );
+    const icons = await element.all(by.css('.shown-selection .mat-icon'));
     const iconColors: string[] = [];
     for (const icon of icons) {
       iconColors.push(await icon.getCssValue('color'));
@@ -266,19 +259,25 @@ class E2eTestUtils {
 
   static async checkTotalScrollEntries(
     viewerSelector: string,
-    scrollViewport: Function,
     numberOfEntries: number,
-    scrollToBottomOffset?: number | undefined,
+    scrollToBottom = false,
   ) {
-    if (scrollToBottomOffset !== undefined) {
+    if (scrollToBottom) {
       const viewport = element(by.css(`${viewerSelector} .scroll`));
-      await browser.executeAsyncScript(
-        scrollViewport,
-        viewport,
-        scrollToBottomOffset,
+      let lastId: string | undefined;
+      let lastScrollEntryItemId = await E2eTestUtils.getLastScrollEntryItemId(
+        viewerSelector,
       );
+      while (lastId !== lastScrollEntryItemId) {
+        lastId = lastScrollEntryItemId;
+        await viewport.sendKeys(protractor.Key.END);
+        await new Promise<void>((resolve) => setTimeout(resolve, 500));
+        lastScrollEntryItemId = await E2eTestUtils.getLastScrollEntryItemId(
+          viewerSelector,
+        );
+      }
     }
-    const entries: ElementFinder[] = await element.all(
+    const entries = await element.all(
       by.css(`${viewerSelector} .scroll .entry`),
     );
     expect(await entries[entries.length - 1].getAttribute('item-id')).toEqual(
@@ -286,17 +285,25 @@ class E2eTestUtils {
     );
   }
 
+  static async getLastScrollEntryItemId(
+    viewerSelector: string,
+  ): Promise<string> {
+    const entries = await element.all(
+      by.css(`${viewerSelector} .scroll .entry`),
+    );
+    return await entries[entries.length - 1].getAttribute('item-id');
+  }
+
   static async toggleSelectFilterOptions(
     viewerSelector: string,
     filterSelector: string,
     options: string[],
   ) {
-    const selectFilter = element(
+    await element(
       by.css(
-        `${viewerSelector} .filters ${filterSelector} .mat-select-trigger`,
+        `${viewerSelector} .headers ${filterSelector} .mat-select-trigger`,
       ),
-    );
-    await selectFilter.click();
+    ).click();
 
     const optionElements: ElementFinder[] = await element.all(
       by.css('.mat-select-panel .mat-option'),
@@ -308,7 +315,9 @@ class E2eTestUtils {
       }
     }
 
-    const backdrop = element(by.css('.cdk-overlay-backdrop'));
+    const backdrop = await element(
+      by.css('.cdk-overlay-backdrop'),
+    ).getWebElement();
     await browser.actions().mouseMove(backdrop, {x: 0, y: 0}).click().perform();
   }
 
diff --git a/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts b/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
index 297ff6d78..a92d7830f 100644
--- a/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
@@ -62,9 +62,9 @@ describe('Viewer Input Method Clients', () => {
     const nodes = await element.all(
       by.css(`${viewerSelector} hierarchy-view .node`),
     );
-    expect(nodes.length).toEqual(4);
+    expect(nodes.length).toEqual(5);
     expect(await nodes[0].getText()).toContain(
-      'InputMethodClients - 2022-11-21, 18:05:14.969 - InsetsSourceConsumer#notifyAnimationFinished',
+      'InputMethodClients - 2022-11-21, 18:05:14.970 - InsetsSourceConsumer#notifyAnimationFinished',
     );
     expect(await nodes[1].getText()).toContain('253 - SfSubtree - Task=8#253');
     expect(await nodes[2].getText()).toContain(
@@ -73,6 +73,7 @@ describe('Viewer Input Method Clients', () => {
     expect(await nodes[3].getText()).toContain(
       '786 - com.google.(...).ZeroStateSearchActivity#786 HWC V',
     );
+    expect(await nodes[4].getText()).toContain('765 - InputMethod#765 HWC V');
   }
 
   async function checkInputMethodLayerProperties() {
diff --git a/tools/winscope/src/test/e2e/viewer_protolog_test.ts b/tools/winscope/src/test/e2e/viewer_protolog_test.ts
index b49075de4..a37337427 100644
--- a/tools/winscope/src/test/e2e/viewer_protolog_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_protolog_test.ts
@@ -14,13 +14,12 @@
  * limitations under the License.
  */
 
-import {browser, ElementFinder} from 'protractor';
+import {browser} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer Protolog', () => {
   const viewerSelector = 'viewer-protolog';
   const totalEntries = 7295;
-  const scrollToTotalBottomOffset = 700000;
 
   beforeEach(async () => {
     await E2eTestUtils.beforeEach(1000);
@@ -35,9 +34,8 @@ describe('Viewer Protolog', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       totalEntries,
-      scrollToTotalBottomOffset,
+      true,
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'notes',
@@ -62,16 +60,11 @@ describe('Viewer Protolog', () => {
 
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       totalEntries,
-      scrollToTotalBottomOffset,
+      true,
     );
     await filterByText('FREEZE');
-    await E2eTestUtils.checkTotalScrollEntries(
-      viewerSelector,
-      scrollViewport,
-      4,
-    );
+    await E2eTestUtils.checkTotalScrollEntries(viewerSelector, 4);
   });
 
   async function checkSelectFilter(
@@ -86,7 +79,6 @@ describe('Viewer Protolog', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       expectedFilteredEntries,
     );
 
@@ -97,26 +89,16 @@ describe('Viewer Protolog', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       totalEntries,
-      scrollToTotalBottomOffset,
+      true,
     );
   }
 
   async function filterByText(filterString: string) {
     await E2eTestUtils.updateInputField(
-      `${viewerSelector} .filters .text`,
+      `${viewerSelector} .headers .text`,
       'Search text',
       filterString,
     );
   }
-
-  function scrollViewport(
-    viewportEl: ElementFinder,
-    offset: number,
-    done: () => void,
-  ) {
-    viewportEl['scrollTop'] = offset;
-    window.requestAnimationFrame(() => done());
-  }
 });
diff --git a/tools/winscope/src/test/e2e/viewer_transactions_test.ts b/tools/winscope/src/test/e2e/viewer_transactions_test.ts
index 97eec796d..e45976fe9 100644
--- a/tools/winscope/src/test/e2e/viewer_transactions_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_transactions_test.ts
@@ -14,16 +14,15 @@
  * limitations under the License.
  */
 
-import {browser, by, element, ElementFinder} from 'protractor';
+import {browser, by, element} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer Transactions', () => {
   const viewerSelector = 'viewer-transactions';
   const totalEntries = 9534;
-  const scrollToTotalBottomOffset = 1000000;
 
   beforeEach(async () => {
-    await E2eTestUtils.beforeEach(1000);
+    await E2eTestUtils.beforeEach(2000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -35,9 +34,8 @@ describe('Viewer Transactions', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       totalEntries,
-      scrollToTotalBottomOffset,
+      true,
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'show_chart',
@@ -51,10 +49,10 @@ describe('Viewer Transactions', () => {
     );
     await E2eTestUtils.checkWinscopeRealTimestamp('18:05:17.505');
     await checkSelectedEntry();
-
     await checkSelectFilter('.pid', ['6914'], 2);
     await checkSelectFilter('.uid', ['10161'], 16);
     await checkSelectFilter('.flags', ['eBackgroundBlurRadiusChanged'], 10);
+    await new Promise<void>((resolve) => setTimeout(resolve, 1000));
   });
 
   async function checkSelectedEntry() {
@@ -110,7 +108,6 @@ describe('Viewer Transactions', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       expectedFilteredEntries,
     );
 
@@ -121,18 +118,8 @@ describe('Viewer Transactions', () => {
     );
     await E2eTestUtils.checkTotalScrollEntries(
       viewerSelector,
-      scrollViewport,
       totalEntries,
-      scrollToTotalBottomOffset,
+      true,
     );
   }
-
-  function scrollViewport(
-    viewportEl: ElementFinder,
-    offset: number,
-    done: () => void,
-  ) {
-    viewportEl['scrollTop'] = offset;
-    window.requestAnimationFrame(() => done());
-  }
 });
diff --git a/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_metadata.json b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_metadata.json
new file mode 100644
index 000000000..d33d45a8e
--- /dev/null
+++ b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_metadata.json
@@ -0,0 +1 @@
+{"elapsedRealTimeNanos":0,"realToElapsedTimeOffsetNanos":1732721670187419777}
\ No newline at end of file
diff --git a/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4 b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4
new file mode 100644
index 000000000..531ccd677
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/screen_recording_no_metadata.mp4 differ
diff --git a/tools/winscope/src/test/unit/hierarchy_tree_builder.ts b/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
index 52276e567..09652624b 100644
--- a/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
+++ b/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {SetFormatters} from 'parsers/operations/set_formatters';
 import {TraceRect} from 'trace/trace_rect';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {OperationChain} from 'trace/tree_node/operations/operation_chain';
@@ -51,7 +52,7 @@ export class HierarchyTreeBuilder extends TreeBuilder<
 
     const propertiesTree = new PropertyTreeNodeFactory().makeProtoProperty(
       rootId,
-      assertDefined(this.name),
+      '',
       this.properties,
     );
     this.additionalProperties.forEach((property) => {
@@ -64,6 +65,7 @@ export class HierarchyTreeBuilder extends TreeBuilder<
         .build();
       propertiesTree.addOrReplaceChild(childNode);
     });
+    new SetFormatters().apply(propertiesTree);
     const provider = new PropertiesProvider(
       propertiesTree,
       async () => propertiesTree,
diff --git a/tools/winscope/src/test/unit/mock_hierarchy_viewer_presenter.ts b/tools/winscope/src/test/unit/mock_hierarchy_viewer_presenter.ts
new file mode 100644
index 000000000..50da724ea
--- /dev/null
+++ b/tools/winscope/src/test/unit/mock_hierarchy_viewer_presenter.ts
@@ -0,0 +1,111 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Store} from 'common/store';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {
+  AbstractHierarchyViewerPresenter,
+  NotifyHierarchyViewCallbackType,
+} from 'viewers/common/abstract_hierarchy_viewer_presenter';
+import {DisplayIdentifier} from 'viewers/common/display_identifier';
+import {HierarchyPresenter} from 'viewers/common/hierarchy_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
+import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+import {UserOptions} from 'viewers/common/user_options';
+import {UiRect} from 'viewers/components/rects/ui_rect';
+
+export class MockPresenter extends AbstractHierarchyViewerPresenter<UiDataHierarchy> {
+  protected override hierarchyPresenter = new HierarchyPresenter(
+    {opt: {name: '', enabled: false}},
+    new TextFilter(),
+    [],
+    true,
+    false,
+    this.getEntryFormattedTimestamp,
+  );
+  protected override propertiesPresenter = new PropertiesPresenter(
+    {opt: {name: '', enabled: false}},
+    new TextFilter(),
+    [],
+  );
+  uiRects: UiRect[] = [];
+  displays: DisplayIdentifier[] = [];
+
+  constructor(
+    trace: Trace<HierarchyTreeNode>,
+    traces: Traces,
+    storage: Store,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<UiDataHierarchy>,
+    protected readonly multiTraceType: TraceType | undefined,
+  ) {
+    super(trace, traces, storage, notifyViewCallback, new MockData());
+  }
+
+  initializeRectsPresenter() {
+    this.rectsPresenter = new RectsPresenter(
+      {opt: {name: 'Test opt', enabled: false}},
+      () => this.uiRects,
+      () => this.displays,
+    );
+  }
+
+  override async onHighlightedNodeChange(node: UiHierarchyTreeNode) {
+    await this.applyHighlightedNodeChange(node);
+    this.refreshHierarchyViewerUiData();
+  }
+
+  override async onHighlightedIdChange(id: string) {
+    await this.applyHighlightedIdChange(id);
+    this.refreshHierarchyViewerUiData();
+  }
+
+  protected override keepCalculated(): boolean {
+    return false;
+  }
+
+  protected override getOverrideDisplayName(): string | undefined {
+    return undefined;
+  }
+
+  protected override refreshUIData(): void {
+    this.refreshHierarchyViewerUiData();
+  }
+}
+
+export class MockData implements UiDataHierarchy {
+  highlightedItem = '';
+  pinnedItems: UiHierarchyTreeNode[] = [];
+  hierarchyUserOptions: UserOptions = {};
+  hierarchyTrees: UiHierarchyTreeNode[] | undefined;
+  propertiesUserOptions: UserOptions = {};
+  propertiesTree: UiPropertyTreeNode | undefined;
+  highlightedProperty = '';
+  hierarchyFilter = new TextFilter();
+  propertiesFilter = new TextFilter();
+  isDarkMode?: boolean;
+  rectsToDraw: UiRect[] = [];
+  rectIdToShowState = new Map<string, RectShowState>();
+  displays: DisplayIdentifier[] = [];
+  rectsUserOptions: UserOptions = {};
+}
diff --git a/tools/winscope/src/test/unit/mock_log_viewer_presenter.ts b/tools/winscope/src/test/unit/mock_log_viewer_presenter.ts
new file mode 100644
index 000000000..b7e7e43b8
--- /dev/null
+++ b/tools/winscope/src/test/unit/mock_log_viewer_presenter.ts
@@ -0,0 +1,168 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
+import {Trace} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogSelectFilter, LogTextFilter} from 'viewers/common/log_filters';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogEntry, LogHeader, UiDataLog} from 'viewers/common/ui_data_log';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+import {UserOptions} from 'viewers/common/user_options';
+
+export class MockPresenter extends AbstractLogViewerPresenter<
+  UiDataLog,
+  PropertyTreeNode
+> {
+  protected override logPresenter = new LogPresenter<LogEntry>();
+  protected override propertiesPresenter = new PropertiesPresenter(
+    {
+      showDefaults: {
+        name: 'Show defaults',
+        enabled: false,
+        tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
+      },
+    },
+    new TextFilter(),
+    [],
+  );
+  stringColumn = {
+    name: 'String Column',
+    cssClass: 'string-column',
+  };
+  numberColumn = {
+    name: 'Number Column',
+    cssClass: 'number-column',
+  };
+  timestampColumn = {
+    name: 'Timestamp Column',
+    cssClass: 'timestamp-column',
+  };
+
+  constructor(
+    trace: Trace<PropertyTreeNode>,
+    readonly storage: Store,
+    notifyViewCallback: NotifyLogViewCallbackType<UiDataLog>,
+  ) {
+    super(trace, notifyViewCallback, MockData.createEmpty());
+  }
+
+  protected override async makeUiDataEntries(): Promise<LogEntry[]> {
+    if (this.trace.lengthEntries === 0) return [];
+    const entries: LogEntry[] = [
+      {
+        traceEntry: this.trace.getEntry(0),
+        fields: [
+          {spec: this.stringColumn, value: 'stringValue'},
+          {spec: this.numberColumn, value: 0},
+          {
+            spec: this.timestampColumn,
+            value: this.trace.getEntry(0).getTimestamp(),
+          },
+        ],
+        propertiesTree: await this.trace.getEntry(0).getValue(),
+      },
+      {
+        traceEntry: this.trace.getEntry(1),
+        fields: [
+          {spec: this.stringColumn, value: 'differentValue'},
+          {spec: this.numberColumn, value: 1},
+          {
+            spec: this.timestampColumn,
+            value: this.trace.getEntry(1).getTimestamp(),
+          },
+        ],
+        propertiesTree: await this.trace.getEntry(1).getValue(),
+      },
+      {
+        traceEntry: this.trace.getEntry(2),
+        fields: [
+          {spec: this.stringColumn, value: 'stringValue'},
+          {spec: this.numberColumn, value: 2},
+          {
+            spec: this.timestampColumn,
+            value: this.trace.getEntry(2).getTimestamp(),
+          },
+        ],
+        propertiesTree: await this.trace.getEntry(2).getValue(),
+      },
+      {
+        traceEntry: this.trace.getEntry(3),
+        fields: [
+          {spec: this.stringColumn, value: 'differentValue'},
+          {spec: this.numberColumn, value: 3},
+          {
+            spec: this.timestampColumn,
+            value: this.trace.getEntry(3).getTimestamp(),
+          },
+        ],
+        propertiesTree: await this.trace.getEntry(3).getValue(),
+      },
+    ];
+    return entries;
+  }
+
+  protected override makeHeaders(): LogHeader[] {
+    const stringFilter = new LogTextFilter(new TextFilter());
+    const numberFilter = new LogSelectFilter(['0', '1', '2', '3']);
+    const headers = [
+      new LogHeader(this.stringColumn, stringFilter),
+      new LogHeader(this.numberColumn, numberFilter),
+      new LogHeader(this.timestampColumn),
+    ];
+    return headers;
+  }
+
+  protected override updateFiltersInHeaders(
+    headers: LogHeader[],
+    allEntries: LogEntry[],
+  ) {
+    for (const header of headers) {
+      if (header.spec === this.stringColumn) {
+        (assertDefined(header.filter) as LogSelectFilter).options = [
+          'stringValue',
+          'differentValue',
+        ];
+      }
+    }
+  }
+}
+
+export class MockData implements UiDataLog {
+  constructor(
+    public headers: LogHeader[],
+    public entries: LogEntry[],
+    public currentIndex: undefined | number,
+    public selectedIndex: undefined | number,
+    public scrollToIndex: undefined | number,
+    public propertiesTree: undefined | UiPropertyTreeNode,
+    public propertiesUserOptions: UserOptions,
+    public isDarkMode = false,
+  ) {}
+
+  static createEmpty(): MockData {
+    return new MockData([], [], undefined, undefined, undefined, undefined, {});
+  }
+}
diff --git a/tools/winscope/src/test/unit/parser_builder.ts b/tools/winscope/src/test/unit/parser_builder.ts
index 02162da26..4e70ebcad 100644
--- a/tools/winscope/src/test/unit/parser_builder.ts
+++ b/tools/winscope/src/test/unit/parser_builder.ts
@@ -62,7 +62,7 @@ export class ParserBuilder<T> {
     type: Q,
     result: CustomQueryParserResultTypeMap[Q],
   ): this {
-    this.customQueryResult.set(type, result);
+    this.customQueryResult.set(type, result ?? {});
     return this;
   }
 
diff --git a/tools/winscope/src/test/unit/property_tree_builder.ts b/tools/winscope/src/test/unit/property_tree_builder.ts
index 8c05c9351..d09d0d9b2 100644
--- a/tools/winscope/src/test/unit/property_tree_builder.ts
+++ b/tools/winscope/src/test/unit/property_tree_builder.ts
@@ -26,7 +26,7 @@ export class PropertyTreeBuilder extends TreeBuilder<
   PropertyTreeNode,
   ChildProperty
 > {
-  isRoot: boolean = false;
+  isRoot = false;
   source = PropertySource.PROTO;
   value: any;
   formatter: PropertyFormatter | undefined;
diff --git a/tools/winscope/src/test/unit/trace_builder.ts b/tools/winscope/src/test/unit/trace_builder.ts
index 882e266dd..b6c780028 100644
--- a/tools/winscope/src/test/unit/trace_builder.ts
+++ b/tools/winscope/src/test/unit/trace_builder.ts
@@ -82,7 +82,7 @@ export class TraceBuilder<T> {
     type: Q,
     result: CustomQueryParserResultTypeMap[Q],
   ): TraceBuilder<T> {
-    this.parserCustomQueryResult.set(type, result);
+    this.parserCustomQueryResult.set(type, result ?? {});
     return this;
   }
 
diff --git a/tools/winscope/src/test/unit/tree_node_utils.ts b/tools/winscope/src/test/unit/tree_node_utils.ts
index 2e577bd14..eff47aea4 100644
--- a/tools/winscope/src/test/unit/tree_node_utils.ts
+++ b/tools/winscope/src/test/unit/tree_node_utils.ts
@@ -214,11 +214,11 @@ export class TreeNodeUtils {
       if (node.getDisplayName() !== expectedNode.getDisplayName()) {
         return false;
       }
+      const chips = node.getChips();
+      const expChips = expectedNode.getChips();
       if (
-        !(
-          node.getChips().length === 0 && expectedNode.getChips().length === 0
-        ) &&
-        node.getChips() !== expectedNode.getChips()
+        chips.length !== expChips.length ||
+        !chips.every((chip, i) => chip === expChips[i])
       ) {
         return false;
       }
diff --git a/tools/winscope/src/test/unit/user_notifier_checker.ts b/tools/winscope/src/test/unit/user_notifier_checker.ts
index a06e70121..41e5e2d1e 100644
--- a/tools/winscope/src/test/unit/user_notifier_checker.ts
+++ b/tools/winscope/src/test/unit/user_notifier_checker.ts
@@ -31,16 +31,12 @@ export class UserNotifierChecker {
   }
 
   expectAdded(notifications: UserNotification[]) {
-    notifications.forEach((n) =>
-      expect(this.userNotifierAdd).toHaveBeenCalledWith(n),
-    );
+    this.checkAdded(notifications);
     expect(this.userNotifierNotify).not.toHaveBeenCalled();
   }
 
   expectNotified(notifications: UserNotification[]) {
-    notifications.forEach((n) =>
-      expect(this.userNotifierAdd).toHaveBeenCalledWith(n),
-    );
+    this.checkAdded(notifications);
     expect(this.userNotifierNotify).toHaveBeenCalled();
   }
 
@@ -48,4 +44,11 @@ export class UserNotifierChecker {
     this.userNotifierAdd.calls.reset();
     this.userNotifierNotify.calls.reset();
   }
+
+  private checkAdded(notifications: UserNotification[]) {
+    expect(this.userNotifierAdd).toHaveBeenCalledTimes(notifications.length);
+    notifications.forEach((n) =>
+      expect(this.userNotifierAdd).toHaveBeenCalledWith(n),
+    );
+  }
 }
diff --git a/tools/winscope/src/test/unit/utils.ts b/tools/winscope/src/test/unit/utils.ts
index 38445e1bb..88f9e5b87 100644
--- a/tools/winscope/src/test/unit/utils.ts
+++ b/tools/winscope/src/test/unit/utils.ts
@@ -26,8 +26,11 @@ import {Parser} from 'trace/parser';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceFile} from 'trace/trace_file';
+import {TraceMetadata} from 'trace/trace_metadata';
 import {TraceEntryTypeMap, TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {QueryResult, Row, RowIterator} from 'trace_processor/query_result';
+import {TraceProcessorFactory} from 'trace_processor/trace_processor_factory';
 import {TimestampConverterUtils} from './timestamp_converter_utils';
 import {TraceBuilder} from './trace_builder';
 
@@ -72,11 +75,13 @@ class UnitTestUtils {
     filename: string,
     converter = UnitTestUtils.getTimestampConverter(),
     initializeRealToElapsedTimeOffsetNs = true,
+    metadata: TraceMetadata = {},
   ): Promise<Parser<object>> {
     const parsers = await UnitTestUtils.getParsers(
       filename,
       converter,
       initializeRealToElapsedTimeOffsetNs,
+      metadata,
     );
 
     expect(parsers.length)
@@ -90,6 +95,7 @@ class UnitTestUtils {
     filename: string,
     converter = UnitTestUtils.getTimestampConverter(),
     initializeRealToElapsedTimeOffsetNs = true,
+    metadata: TraceMetadata = {},
   ): Promise<Array<Parser<object>>> {
     const file = new TraceFile(
       await UnitTestUtils.getFixtureFile(filename),
@@ -98,7 +104,7 @@ class UnitTestUtils {
     const fileAndParsers = await new LegacyParserFactory().createParsers(
       [file],
       converter,
-      undefined,
+      metadata,
     );
 
     if (initializeRealToElapsedTimeOffsetNs) {
@@ -346,6 +352,54 @@ class UnitTestUtils {
     ).toEqual(0);
   }
 
+  static makeEmptyTrace<T extends TraceType>(
+    traceType: T,
+    descriptors: string[] = [],
+  ): Trace<TraceEntryTypeMap[T]> {
+    return new TraceBuilder<TraceEntryTypeMap[T]>()
+      .setEntries([])
+      .setTimestamps([])
+      .setDescriptors(descriptors)
+      .setType(traceType)
+      .build();
+  }
+
+  static makeSearchTraceSpies(
+    ts?: Timestamp,
+  ): [jasmine.SpyObj<QueryResult>, jasmine.SpyObj<RowIterator<Row>>] {
+    const spyQueryResult = jasmine.createSpyObj<QueryResult>('result', [
+      'numRows',
+      'columns',
+      'iter',
+    ]);
+    spyQueryResult.numRows.and.returnValue(1);
+    spyQueryResult.columns.and.returnValue(
+      ts === undefined ? ['property'] : ['ts', 'property'],
+    );
+
+    const spyIter = jasmine.createSpyObj<RowIterator<Row>>('iter', [
+      'valid',
+      'next',
+      'get',
+    ]);
+    if (ts) {
+      spyIter.get.withArgs('ts').and.returnValue(ts.getValueNs());
+    }
+    spyIter.get.withArgs('property').and.returnValue('test_value');
+    spyIter.valid.and.returnValue(true);
+    spyIter.next.and.callFake(() =>
+      assertDefined(spyIter).valid.and.returnValue(false),
+    );
+    spyQueryResult.iter.and.returnValue(spyIter);
+
+    return [spyQueryResult, spyIter];
+  }
+
+  static async runQueryAndGetResult(query: string): Promise<QueryResult> {
+    const tp = await TraceProcessorFactory.getSingleInstance();
+    return tp.query(query).waitAllRows();
+  }
+
   private static testTimestamps(
     timestamp: Timestamp,
     expectedTimestamp: Timestamp,
diff --git a/tools/winscope/src/trace/custom_query.ts b/tools/winscope/src/trace/custom_query.ts
index 1fb207733..bd6eeb7e1 100644
--- a/tools/winscope/src/trace/custom_query.ts
+++ b/tools/winscope/src/trace/custom_query.ts
@@ -13,6 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+
 import {RelativeEntryIndex, TraceEntryEager} from './trace';
 
 export enum CustomQueryType {
diff --git a/tools/winscope/src/trace/trace.ts b/tools/winscope/src/trace/trace.ts
index a5eb01319..b893f7c7a 100644
--- a/tools/winscope/src/trace/trace.ts
+++ b/tools/winscope/src/trace/trace.ts
@@ -18,6 +18,8 @@ import {ArrayUtils} from 'common/array_utils';
 import {assertDefined} from 'common/assert_utils';
 import {INVALID_TIME_NS, Timestamp} from 'common/time';
 import {TimestampUtils} from 'common/timestamp_utils';
+import {TracesParserInput} from 'parsers/input/perfetto/traces_parser_input';
+import {AbstractParser as AbstractPerfettoParser} from 'parsers/perfetto/abstract_parser';
 import {
   CustomQueryParamTypeMap,
   CustomQueryParserResultTypeMap,
@@ -177,6 +179,12 @@ export class Trace<T> {
     return this.parser;
   }
 
+  canSearch(): boolean {
+    return [AbstractPerfettoParser, TracesParserInput].some(
+      (ParserType) => this.parser instanceof ParserType,
+    );
+  }
+
   setFrameInfo(frameMap: FrameMap, framesRange: FramesRange | undefined) {
     if (frameMap.lengthEntries !== this.fullTrace.lengthEntries) {
       throw new Error(
diff --git a/tools/winscope/src/trace/trace_info.ts b/tools/winscope/src/trace/trace_info.ts
index 91179e8dc..dea3dacd2 100644
--- a/tools/winscope/src/trace/trace_info.ts
+++ b/tools/winscope/src/trace/trace_info.ts
@@ -30,6 +30,7 @@ const EVENT_LOG_ICON = 'description';
 const TRANSITION_ICON = 'animation';
 const CUJ_ICON = 'label';
 const INPUT_ICON = 'touch_app';
+const SEARCH_ICON = 'search';
 
 interface TraceInfoMap {
   [key: number]: {
@@ -169,7 +170,7 @@ export const TRACE_INFO: TraceInfoMap = {
     legacyExt: '.winscope',
   },
   [TraceType.CUJS]: {
-    name: 'Cujs',
+    name: 'Jank CUJs',
     icon: CUJ_ICON,
     color: '#FF63B8',
     downloadArchiveDir: 'eventlog',
@@ -190,10 +191,17 @@ export const TRACE_INFO: TraceInfoMap = {
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_EVENT_MERGED]: {
-    name: 'Input Events',
+    name: 'Input',
     icon: INPUT_ICON,
     color: '#8baef4',
     downloadArchiveDir: 'input',
     legacyExt: '.winscope',
   },
+  [TraceType.SEARCH]: {
+    name: 'Search',
+    icon: SEARCH_ICON,
+    color: '#DEBE13',
+    downloadArchiveDir: '',
+    legacyExt: '',
+  },
 };
diff --git a/tools/winscope/src/trace/trace_metadata.ts b/tools/winscope/src/trace/trace_metadata.ts
new file mode 100644
index 000000000..5808b1363
--- /dev/null
+++ b/tools/winscope/src/trace/trace_metadata.ts
@@ -0,0 +1,24 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export interface TraceMetadata {
+  screenRecordingOffsets?: ScreenRecordingOffsets;
+}
+
+export interface ScreenRecordingOffsets {
+  elapsedRealTimeNanos: bigint;
+  realToElapsedTimeOffsetNanos: bigint;
+}
diff --git a/tools/winscope/src/trace/trace_test.ts b/tools/winscope/src/trace/trace_test.ts
index 4deb6f162..b6200630f 100644
--- a/tools/winscope/src/trace/trace_test.ts
+++ b/tools/winscope/src/trace/trace_test.ts
@@ -19,9 +19,11 @@ import {ParserBuilder} from 'test/unit/parser_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {TraceUtils} from 'test/unit/trace_utils';
+import {UnitTestUtils} from 'test/unit/utils';
 import {FrameMapBuilder} from './frame_map_builder';
 import {AbsoluteFrameIndex} from './index_types';
 import {Trace} from './trace';
+import {TraceType} from './trace_type';
 
 describe('Trace', () => {
   let trace: Trace<string>;
@@ -1399,10 +1401,9 @@ describe('Trace', () => {
   });
 
   it('spansMultipleDates()', () => {
-    const emptyTrace = new TraceBuilder<string>()
-      .setEntries([])
-      .setTimestamps([])
-      .build();
+    const emptyTrace = UnitTestUtils.makeEmptyTrace(
+      TraceType.TEST_TRACE_STRING,
+    );
     expect(emptyTrace.spansMultipleDates()).toBeFalse();
 
     const traceWithElapsedTimestamps = new TraceBuilder<string>()
diff --git a/tools/winscope/src/trace/trace_type.ts b/tools/winscope/src/trace/trace_type.ts
index f28bea9fa..d6d2ce3c3 100644
--- a/tools/winscope/src/trace/trace_type.ts
+++ b/tools/winscope/src/trace/trace_type.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {QueryResult} from 'trace_processor/query_result';
 import {MediaBasedTraceEntry} from './media_based_trace_entry';
 import {HierarchyTreeNode} from './tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from './tree_node/property_tree_node';
@@ -43,6 +44,7 @@ export enum TraceType {
   INPUT_MOTION_EVENT,
   INPUT_KEY_EVENT,
   INPUT_EVENT_MERGED,
+  SEARCH,
 }
 
 export type ImeTraceType =
@@ -75,6 +77,7 @@ export interface TraceEntryTypeMap {
   [TraceType.INPUT_MOTION_EVENT]: PropertyTreeNode;
   [TraceType.INPUT_KEY_EVENT]: PropertyTreeNode;
   [TraceType.INPUT_EVENT_MERGED]: PropertyTreeNode;
+  [TraceType.SEARCH]: QueryResult;
 }
 
 export class TraceTypeUtils {
@@ -91,6 +94,7 @@ export class TraceTypeUtils {
   ];
 
   private static TRACES_WITH_VIEWERS_DISPLAY_ORDER = [
+    TraceType.SEARCH,
     TraceType.SCREEN_RECORDING,
     TraceType.SCREENSHOT,
     TraceType.SURFACE_FLINGER,
diff --git a/tools/winscope/src/trace/traces_test.ts b/tools/winscope/src/trace/traces_test.ts
index 5611748b7..2853ed798 100644
--- a/tools/winscope/src/trace/traces_test.ts
+++ b/tools/winscope/src/trace/traces_test.ts
@@ -21,6 +21,7 @@ import {TracesBuilder} from 'test/unit/traces_builder';
 import {TracesUtils} from 'test/unit/traces_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {TraceUtils} from 'test/unit/trace_utils';
+import {UnitTestUtils} from 'test/unit/utils';
 import {FrameMapBuilder} from './frame_map_builder';
 import {AbsoluteFrameIndex} from './index_types';
 import {Traces} from './traces';
@@ -164,14 +165,8 @@ describe('Traces', () => {
   });
 
   it('deleteTrace()', () => {
-    const trace0 = new TraceBuilder<string>()
-      .setType(TraceType.TEST_TRACE_STRING)
-      .setEntries([])
-      .build();
-    const trace1 = new TraceBuilder<number>()
-      .setType(TraceType.TEST_TRACE_NUMBER)
-      .setEntries([])
-      .build();
+    const trace0 = UnitTestUtils.makeEmptyTrace(TraceType.TEST_TRACE_STRING);
+    const trace1 = UnitTestUtils.makeEmptyTrace(TraceType.TEST_TRACE_NUMBER);
 
     const traces = new Traces();
     traces.addTrace(trace0);
@@ -190,14 +185,8 @@ describe('Traces', () => {
   });
 
   it('hasTrace()', () => {
-    const trace0 = new TraceBuilder<string>()
-      .setType(TraceType.TEST_TRACE_STRING)
-      .setEntries([])
-      .build();
-    const trace1 = new TraceBuilder<number>()
-      .setType(TraceType.TEST_TRACE_NUMBER)
-      .setEntries([])
-      .build();
+    const trace0 = UnitTestUtils.makeEmptyTrace(TraceType.TEST_TRACE_STRING);
+    const trace1 = UnitTestUtils.makeEmptyTrace(TraceType.TEST_TRACE_NUMBER);
 
     const traces = new Traces();
     traces.addTrace(trace0);
diff --git a/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts b/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
index 0aa2daa39..210bc5ba8 100644
--- a/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
+++ b/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {UserWarning} from 'messaging/user_warning';
 import {TraceRect} from 'trace/trace_rect';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
 import {PropertyTreeNode} from './property_tree_node';
@@ -24,6 +25,8 @@ export class HierarchyTreeNode extends TreeNode {
   private secondaryRects: TraceRect[] | undefined;
   private zParent: HierarchyTreeNode | undefined;
   private parent: this | undefined;
+  private relativeChildren: HierarchyTreeNode[] = [];
+  private warnings: UserWarning[] = [];
 
   constructor(
     id: string,
@@ -61,8 +64,8 @@ export class HierarchyTreeNode extends TreeNode {
     return this.secondaryRects;
   }
 
-  setZParent(parent: HierarchyTreeNode): void {
-    this.zParent = parent;
+  setZParent(value: HierarchyTreeNode): void {
+    this.zParent = value;
   }
 
   getZParent(): HierarchyTreeNode | undefined {
@@ -77,6 +80,14 @@ export class HierarchyTreeNode extends TreeNode {
     return this.parent;
   }
 
+  addRelativeChild(value: HierarchyTreeNode): void {
+    this.relativeChildren.push(value);
+  }
+
+  getRelativeChildren(): HierarchyTreeNode[] {
+    return this.relativeChildren;
+  }
+
   override isRoot(): boolean {
     return !this.parent;
   }
@@ -90,4 +101,12 @@ export class HierarchyTreeNode extends TreeNode {
 
     return ancestor;
   }
+
+  getWarnings(): UserWarning[] {
+    return this.warnings;
+  }
+
+  addWarning(warning: UserWarning) {
+    this.warnings.push(warning);
+  }
 }
diff --git a/tools/winscope/src/trace_collection/proxy_connection.ts b/tools/winscope/src/trace_collection/proxy_connection.ts
index aab3e6d4a..c22cde779 100644
--- a/tools/winscope/src/trace_collection/proxy_connection.ts
+++ b/tools/winscope/src/trace_collection/proxy_connection.ts
@@ -26,7 +26,10 @@ import {PersistentStore} from 'common/persistent_store';
 import {TimeUtils} from 'common/time_utils';
 import {UserNotifier} from 'common/user_notifier';
 import {Analytics} from 'logging/analytics';
-import {ProxyTracingErrors} from 'messaging/user_warnings';
+import {
+  ProxyTracingErrors,
+  ProxyTracingWarnings,
+} from 'messaging/user_warnings';
 import {AdbConnection, OnRequestSuccessCallback} from './adb_connection';
 import {AdbDevice} from './adb_device';
 import {ConnectionState} from './connection_state';
@@ -34,7 +37,7 @@ import {ProxyEndpoint} from './proxy_endpoint';
 import {TraceRequest} from './trace_request';
 
 export class ProxyConnection extends AdbConnection {
-  static readonly VERSION = '4.0.0';
+  static readonly VERSION = '4.0.8';
   static readonly WINSCOPE_PROXY_URL = 'http://localhost:5544';
 
   private static readonly MULTI_DISPLAY_SCREENRECORD_VERSION = '1.4';
@@ -205,7 +208,10 @@ export class ProxyConnection extends AdbConnection {
           `${ProxyEndpoint.START_TRACE}${
             assertDefined(this.selectedDevice).id
           }/`,
-          () => this.keepTraceAlive(),
+          (response: HttpResponse) => {
+            this.tryProcessWarnings(response);
+            this.keepTraceAlive();
+          },
           this.requestedTraces,
         );
         // TODO(b/330118129): identify source of additional start latency that affects some traces
@@ -240,7 +246,7 @@ export class ProxyConnection extends AdbConnection {
       case ConnectionState.DUMPING_STATE:
         await this.postToProxy(
           `${ProxyEndpoint.DUMP}${assertDefined(this.selectedDevice).id}/`,
-          FunctionUtils.DO_NOTHING,
+          (response: HttpResponse) => this.tryProcessWarnings(response),
           this.requestedTraces,
         );
         return;
@@ -257,6 +263,17 @@ export class ProxyConnection extends AdbConnection {
     }
   }
 
+  private tryProcessWarnings(response: HttpResponse) {
+    try {
+      const warnings = JSON.parse(response.body);
+      if (Array.isArray(warnings) && warnings.length > 0) {
+        UserNotifier.add(new ProxyTracingWarnings(warnings)).notify();
+      }
+    } catch {
+      // do nothing - warnings unavailable
+    }
+  }
+
   private async keepTraceAlive() {
     const state = this.getState();
     if (
diff --git a/tools/winscope/src/trace_collection/proxy_connection_test.ts b/tools/winscope/src/trace_collection/proxy_connection_test.ts
index a2930b978..ec96c40af 100644
--- a/tools/winscope/src/trace_collection/proxy_connection_test.ts
+++ b/tools/winscope/src/trace_collection/proxy_connection_test.ts
@@ -20,7 +20,11 @@ import {
   HttpRequestStatus,
   HttpResponse,
 } from 'common/http_request';
-import {ProxyTracingErrors} from 'messaging/user_warnings';
+import {UserNotification} from 'messaging/user_notification';
+import {
+  ProxyTracingErrors,
+  ProxyTracingWarnings,
+} from 'messaging/user_warnings';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {waitToBeCalled} from 'test/utils';
 import {AdbDevice} from 'trace_collection/adb_device';
@@ -334,6 +338,23 @@ describe('ProxyConnection', () => {
       ]);
     });
 
+    it('posts start trace request to proxy and handles response with warnings', async () => {
+      postSpy.and.returnValue(
+        Promise.resolve({
+          status: HttpRequestStatus.SUCCESS,
+          type: '',
+          text: '',
+          body: '["test warning"]',
+          getHeader: getVersionHeader,
+        }),
+      );
+      await checkSuccessfulTraceRequest(
+        [mockTraceRequest],
+        [mockTraceRequest],
+        [new ProxyTracingWarnings(['test warning'])],
+      );
+    });
+
     it('handles trace timeout', async () => {
       const requestObj = [mockTraceRequest];
       getSpy.and.returnValue(
@@ -456,6 +477,23 @@ describe('ProxyConnection', () => {
       ]);
     });
 
+    it('posts dump request and handles response with warnings', async () => {
+      postSpy.and.returnValue(
+        Promise.resolve({
+          status: HttpRequestStatus.SUCCESS,
+          type: '',
+          text: '',
+          body: '["test warning"]',
+          getHeader: getVersionHeader,
+        }),
+      );
+      await checkSuccessfulDumpRequest(
+        [mockTraceRequest],
+        [mockTraceRequest],
+        [new ProxyTracingWarnings(['test warning'])],
+      );
+    });
+
     function checkTraceEndedSuccessfully() {
       expect(postSpy).toHaveBeenCalledOnceWith(
         ProxyConnection.WINSCOPE_PROXY_URL +
@@ -470,6 +508,7 @@ describe('ProxyConnection', () => {
     async function checkSuccessfulTraceRequest(
       requests: TraceRequest[],
       updatedRequests = requests,
+      warnings?: UserNotification[],
     ) {
       postSpy.calls.reset();
       await connection.startTrace(mockDevice, requests);
@@ -482,11 +521,17 @@ describe('ProxyConnection', () => {
         updatedRequests,
       );
       expect(connection.getState()).toEqual(ConnectionState.TRACING);
+      if (warnings !== undefined) {
+        userNotifierChecker.expectNotified(warnings);
+      } else {
+        userNotifierChecker.expectNone();
+      }
     }
 
     async function checkSuccessfulDumpRequest(
       requests: TraceRequest[],
       updatedRequests = requests,
+      warnings?: UserNotification[],
     ) {
       postSpy.calls.reset();
       await connection.dumpState(mockDevice, requests);
@@ -499,6 +544,11 @@ describe('ProxyConnection', () => {
         updatedRequests,
       );
       expect(connection.getState()).toEqual(ConnectionState.DUMPING_STATE);
+      if (warnings !== undefined) {
+        userNotifierChecker.expectNotified(warnings);
+      } else {
+        userNotifierChecker.expectNone();
+      }
     }
   });
 
diff --git a/tools/winscope/src/trace_processor/trace_processor_factory.ts b/tools/winscope/src/trace_processor/trace_processor_factory.ts
new file mode 100644
index 000000000..7171aced0
--- /dev/null
+++ b/tools/winscope/src/trace_processor/trace_processor_factory.ts
@@ -0,0 +1,43 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {globalConfig} from 'common/global_config';
+import {UrlUtils} from 'common/url_utils';
+import {
+  initWasm,
+  resetEngineWorker,
+  WasmEngineProxy,
+} from 'trace_processor/wasm_engine_proxy';
+
+export class TraceProcessorFactory {
+  private static wasmEngine?: WasmEngineProxy;
+
+  static async getSingleInstance(): Promise<WasmEngineProxy> {
+    if (!TraceProcessorFactory.wasmEngine) {
+      const traceProcessorRootUrl =
+        globalConfig.MODE === 'KARMA_TEST'
+          ? UrlUtils.getRootUrl() +
+            'base/deps_build/trace_processor/to_be_served/'
+          : UrlUtils.getRootUrl();
+      initWasm(traceProcessorRootUrl);
+      const engineId = 'random-id';
+      const enginePort = resetEngineWorker();
+      TraceProcessorFactory.wasmEngine = new WasmEngineProxy(engineId, enginePort);
+    }
+
+    return TraceProcessorFactory.wasmEngine;
+  }
+}
diff --git a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
index 62b162abf..f3e5c3983 100644
--- a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
+++ b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
@@ -35,12 +35,12 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
 import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 import {HierarchyPresenter} from './hierarchy_presenter';
-import {PresetHierarchy} from './preset_hierarchy';
+import {PresetHierarchy, TextFilterValues} from './preset_hierarchy';
 import {RectShowState} from './rect_show_state';
-import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {ViewerEvents} from './viewer_events';
 
@@ -208,7 +208,18 @@ export abstract class AbstractHierarchyViewerPresenter<
     this.copyUiDataAndNotifyView();
   }
 
-  protected async handleCommonWinscopeEvents(event: WinscopeEvent) {
+  async onAppEvent(event: WinscopeEvent) {
+    await event.visit(
+      WinscopeEventType.TRACE_POSITION_UPDATE,
+      async (event) => {
+        if (this.initializeIfNeeded) await this.initializeIfNeeded(event);
+        await this.applyTracePositionUpdate(event);
+        if (this.processDataAfterPositionUpdate) {
+          await this.processDataAfterPositionUpdate(event);
+        }
+        this.refreshUIData();
+      },
+    );
     await event.visit(
       WinscopeEventType.FILTER_PRESET_SAVE_REQUEST,
       async (event) => {
@@ -219,14 +230,26 @@ export abstract class AbstractHierarchyViewerPresenter<
       this.uiData.isDarkMode = event.isDarkMode;
       this.copyUiDataAndNotifyView();
     });
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        const filterPresetName = event.name;
+        await this.applyPresetConfig(filterPresetName);
+        this.refreshUIData();
+      },
+    );
   }
 
   protected saveConfigAsPreset(storeKey: string) {
     const preset: PresetHierarchy = {
       hierarchyUserOptions: this.uiData.hierarchyUserOptions,
-      hierarchyFilter: this.uiData.hierarchyFilter,
+      hierarchyFilter: TextFilterValues.fromTextFilter(
+        this.uiData.hierarchyFilter,
+      ),
       propertiesUserOptions: this.uiData.propertiesUserOptions,
-      propertiesFilter: this.uiData.propertiesFilter,
+      propertiesFilter: TextFilterValues.fromTextFilter(
+        this.uiData.propertiesFilter,
+      ),
       rectsUserOptions: this.uiData.rectsUserOptions,
       rectIdToShowState: this.uiData.rectIdToShowState,
     };
@@ -241,14 +264,20 @@ export abstract class AbstractHierarchyViewerPresenter<
         parsedPreset.hierarchyUserOptions,
       );
       await this.hierarchyPresenter.applyHierarchyFilterChange(
-        parsedPreset.hierarchyFilter,
+        new TextFilter(
+          parsedPreset.hierarchyFilter.filterString,
+          parsedPreset.hierarchyFilter.flags,
+        ),
       );
 
       this.propertiesPresenter.applyPropertiesUserOptionsChange(
         parsedPreset.propertiesUserOptions,
       );
       this.propertiesPresenter.applyPropertiesFilterChange(
-        parsedPreset.propertiesFilter,
+        new TextFilter(
+          parsedPreset.propertiesFilter.filterString,
+          parsedPreset.propertiesFilter.flags,
+        ),
       );
       await this.updatePropertiesTree();
 
@@ -413,11 +442,15 @@ export abstract class AbstractHierarchyViewerPresenter<
     this.notifyViewCallback(copy);
   }
 
-  abstract onAppEvent(event: WinscopeEvent): Promise<void>;
   abstract onHighlightedNodeChange(node: UiHierarchyTreeNode): Promise<void>;
   abstract onHighlightedIdChange(id: string): Promise<void>;
   protected abstract keepCalculated(tree: HierarchyTreeNode): boolean;
   protected abstract getOverrideDisplayName(
     selected: [Trace<HierarchyTreeNode>, HierarchyTreeNode],
   ): string | undefined;
+  protected abstract refreshUIData(): void;
+  protected initializeIfNeeded?(event: TracePositionUpdate): Promise<void>;
+  protected processDataAfterPositionUpdate?(
+    event: TracePositionUpdate,
+  ): Promise<void>;
 }
diff --git a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
index 751050300..4c5e82074 100644
--- a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
+++ b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
@@ -15,37 +15,28 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {Store} from 'common/store';
-import {
-  FilterPresetApplyRequest,
-  FilterPresetSaveRequest,
-  TracePositionUpdate,
-} from 'messaging/winscope_event';
-import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TracePositionUpdate} from 'messaging/winscope_event';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
-import {TraceType} from 'trace/trace_type';
+import {PropertySource} from 'trace/tree_node/property_tree_node';
 import {
   AbstractHierarchyViewerPresenter,
   NotifyHierarchyViewCallbackType,
 } from 'viewers/common/abstract_hierarchy_viewer_presenter';
-import {VISIBLE_CHIP} from 'viewers/common/chip';
-import {DiffType} from 'viewers/common/diff_type';
-import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {UserOptions} from 'viewers/common/user_options';
-import {TextFilter} from './text_filter';
+import {Chip} from './chip';
 import {UiDataHierarchy} from './ui_data_hierarchy';
-import {ViewerEvents} from './viewer_events';
 
 export abstract class AbstractHierarchyViewerPresenterTest<
   UiData extends UiDataHierarchy,
 > {
   execute() {
-    describe('AbstractHierarchyViewerPresenter', () => {
+    describe('Common tests', () => {
       let uiData: UiDataHierarchy;
       let presenter: AbstractHierarchyViewerPresenter<UiData>;
       let userNotifierChecker: UserNotifierChecker;
@@ -53,6 +44,7 @@ export abstract class AbstractHierarchyViewerPresenterTest<
 
       beforeAll(async () => {
         jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+        jasmine.addCustomEqualityTester(chipEqualityTester);
         userNotifierChecker = new UserNotifierChecker();
         await this.setUpTestEnvironment();
       });
@@ -69,324 +61,88 @@ export abstract class AbstractHierarchyViewerPresenterTest<
         userNotifierChecker.reset();
       });
 
-      it('is robust to empty trace', async () => {
-        const notifyViewCallback = (newData: UiDataHierarchy) => {
-          uiData = newData;
-        };
-        const presenter =
-          this.createPresenterWithEmptyTrace(notifyViewCallback);
-
-        const positionUpdateWithoutTraceEntry =
-          TracePositionUpdate.fromTimestamp(
-            TimestampConverterUtils.makeRealTimestamp(0n),
-          );
-        await presenter.onAppEvent(positionUpdateWithoutTraceEntry);
-
-        expect(Object.keys(uiData.hierarchyUserOptions).length).toBeGreaterThan(
-          0,
+      it('has expected user options', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.hierarchyUserOptions).toEqual(this.expectedHierarchyOpts);
+        expect(uiData.propertiesUserOptions).toEqual(
+          this.expectedPropertiesOpts,
         );
-        expect(
-          Object.keys(uiData.propertiesUserOptions).length,
-        ).toBeGreaterThan(0);
-        expect(uiData.hierarchyTrees).toBeUndefined();
-        if (this.shouldExecuteRectTests) {
-          expect(
-            Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
-          ).toBeGreaterThan(0);
-        }
+        expect(uiData.rectsUserOptions).toEqual(this.expectedRectsOpts);
       });
 
-      it('clears ui data before throwing error on corrupted trace', async () => {
-        const notifyViewCallback = (newData: UiDataHierarchy) => {
-          uiData = newData;
-        };
-        const presenter =
-          this.createPresenterWithCorruptedTrace(notifyViewCallback);
+      it('after highlighting a node, updates properties on position update', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        const selectedTree = this.getSelectedTreeAfterPositionUpdate();
+        await presenter.onHighlightedNodeChange(selectedTree);
+        this.executePropertiesChecksAfterPositionUpdate(uiData);
 
-        try {
-          await presenter.onAppEvent(
-            TracePositionUpdate.fromTimestamp(
-              TimestampConverterUtils.makeRealTimestamp(0n),
-            ),
+        const secondUpdate = this.getSecondPositionUpdate();
+        if (secondUpdate) {
+          await presenter.onAppEvent(secondUpdate);
+          assertDefined(this.executePropertiesChecksAfterSecondPositionUpdate)(
+            uiData,
           );
-        } catch (e) {
-          expect(
-            Object.keys(uiData.hierarchyUserOptions).length,
-          ).toBeGreaterThan(0);
-          expect(
-            Object.keys(uiData.propertiesUserOptions).length,
-          ).toBeGreaterThan(0);
-          expect(uiData.hierarchyTrees).toBeUndefined();
-          expect(uiData.propertiesTree).toBeUndefined();
-          expect(uiData.highlightedItem).toEqual('');
-          expect(uiData.highlightedProperty).toEqual('');
-          expect(uiData.pinnedItems.length).toEqual(0);
-          if (this.shouldExecuteRectTests) {
-            expect(
-              Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
-            ).toBeGreaterThan(0);
-            expect(uiData.rectsToDraw).toEqual([]);
-            expect(uiData.rectIdToShowState).toBeUndefined();
-          }
         }
       });
 
-      it('adds events listeners', () => {
-        const element = document.createElement('div');
-        presenter.addEventListeners(element);
-
-        let spy: jasmine.Spy = spyOn(presenter, 'onPinnedItemChange');
-        const node = TreeNodeUtils.makeUiHierarchyNode({name: 'test'});
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HierarchyPinnedChange, {
-            detail: {pinnedItem: node},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(node);
-
-        spy = spyOn(presenter, 'onHighlightedIdChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HighlightedIdChange, {
-            detail: {id: 'test'},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith('test');
-
-        spy = spyOn(presenter, 'onHighlightedPropertyChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HighlightedPropertyChange, {
-            detail: {id: 'test'},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith('test');
-
-        spy = spyOn(presenter, 'onHierarchyUserOptionsChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HierarchyUserOptionsChange, {
-            detail: {userOptions: {}},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith({});
-
-        spy = spyOn(presenter, 'onHierarchyFilterChange');
-        const filter = new TextFilter('', []);
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HierarchyFilterChange, {detail: filter}),
-        );
-        expect(spy).toHaveBeenCalledWith(filter);
-
-        spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
-            detail: {userOptions: {}},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith({});
-
-        spy = spyOn(presenter, 'onPropertiesFilterChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.PropertiesFilterChange, {
-            detail: filter,
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(filter);
-
-        spy = spyOn(presenter, 'onHighlightedNodeChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.HighlightedNodeChange, {detail: {node}}),
+      it('after highlighting by id, updates properties tree on position update', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        await presenter.onHighlightedIdChange(
+          this.getSelectedTreeAfterPositionUpdate().id,
         );
-        expect(spy).toHaveBeenCalledWith(node);
-
-        if (this.shouldExecuteRectTests) {
-          spy = spyOn(presenter, 'onRectShowStateChange');
-          element.dispatchEvent(
-            new CustomEvent(ViewerEvents.RectShowStateChange, {
-              detail: {rectId: 'test', state: RectShowState.HIDE},
-            }),
-          );
-          expect(spy).toHaveBeenCalledWith('test', RectShowState.HIDE);
+        this.executePropertiesChecksAfterPositionUpdate(uiData);
 
-          spy = spyOn(presenter, 'onRectsUserOptionsChange');
-          element.dispatchEvent(
-            new CustomEvent(ViewerEvents.RectsUserOptionsChange, {
-              detail: {userOptions: {}},
-            }),
+        const secondUpdate = this.getSecondPositionUpdate();
+        if (secondUpdate) {
+          await presenter.onAppEvent(secondUpdate);
+          assertDefined(this.executePropertiesChecksAfterSecondPositionUpdate)(
+            uiData,
           );
-          expect(spy).toHaveBeenCalledWith({});
-        }
-      });
-
-      it('processes trace position updates', async () => {
-        pinNode(this.getSelectedTree());
-
-        await assertDefined(presenter).onAppEvent(
-          assertDefined(this.getPositionUpdate()),
-        );
-
-        expect(uiData.highlightedItem?.length).toEqual(0);
-        expect(Object.keys(uiData.hierarchyUserOptions).length).toBeGreaterThan(
-          0,
-        );
-        expect(
-          Object.keys(uiData.propertiesUserOptions).length,
-        ).toBeGreaterThan(0);
-        assertDefined(uiData.hierarchyTrees).forEach((tree) => {
-          expect(tree.getAllChildren().length > 0).toBeTrue();
-        });
-        expect(uiData.pinnedItems.length).toBeGreaterThan(0);
-
-        if (this.shouldExecuteRectTests) {
-          expect(
-            Object.keys(assertDefined(uiData.rectsUserOptions)).length,
-          ).toBeGreaterThan(0);
-          expect(uiData.rectsToDraw?.length).toBeGreaterThan(0);
-          expect(uiData.displays?.length).toBeGreaterThan(0);
         }
       });
 
-      if (this.shouldExecuteShowDiffTests) {
-        it('disables show diff and generates non-diff tree if no prev entry available', async () => {
-          await presenter.onAppEvent(this.getPositionUpdate());
-
-          const hierarchyOpts = assertDefined(uiData.hierarchyUserOptions);
-          expect(hierarchyOpts['showDiff'].isUnavailable).toBeTrue();
-
-          const propertyOpts = assertDefined(uiData.propertiesUserOptions);
-          expect(propertyOpts['showDiff'].isUnavailable).toBeTrue();
-
-          assertDefined(uiData.hierarchyTrees).forEach((tree) => {
-            expect(tree.getAllChildren().length > 0).toBeTrue();
-          });
+      it('correctly keeps/discards calculated properties', async () => {
+        await presenter.onPropertiesUserOptionsChange({
+          showDefaults: {name: '', enabled: true},
         });
-      }
-
-      if (this.shouldExecuteDumpTests) {
-        it('shows correct hierarchy tree name for entry', async () => {
-          const update = this.getPositionUpdate();
-          const spy = spyOn(
-            assertDefined(update.position.entry?.getFullTrace()),
-            'isDumpWithoutTimestamp',
-          );
-
-          spy.and.returnValue(false);
-          await presenter.onAppEvent(update);
-          const entryNode = assertDefined(uiData.hierarchyTrees?.at(0));
-          expect(entryNode.getDisplayName()).toContain(
-            update.position.timestamp.format(),
-          );
-
-          pinNode(entryNode);
-
-          spy.and.returnValue(true);
-          await presenter.onAppEvent(update);
-          const newEntryNode = assertDefined(uiData.hierarchyTrees?.at(0));
-          expect(newEntryNode.getDisplayName()).toContain('Dump');
-          expect(uiData.pinnedItems).toEqual([newEntryNode]);
-        });
-      }
-
-      it('handles pinned item change', () => {
-        expect(uiData.pinnedItems).toEqual([]);
-
-        const pinnedItem = TreeNodeUtils.makeUiHierarchyNode({
-          id: 'TestItem 4',
-          name: 'FirstPinnedItem',
-        });
-
-        presenter.onPinnedItemChange(pinnedItem);
-        expect(uiData.pinnedItems).toEqual([pinnedItem]);
-
-        presenter.onPinnedItemChange(pinnedItem);
-        expect(uiData.pinnedItems).toEqual([]);
-      });
-
-      it('updates highlighted property', () => {
-        expect(uiData.highlightedProperty).toEqual('');
-        const id = '4';
-        presenter.onHighlightedPropertyChange(id);
-        expect(uiData.highlightedProperty).toEqual(id);
-        presenter.onHighlightedPropertyChange(id);
-        expect(uiData.highlightedProperty).toEqual('');
-      });
-
-      it('filters hierarchy tree by visibility', async () => {
-        const userOptions: UserOptions = {
-          showOnlyVisible: {
-            name: 'Show only',
-            chip: VISIBLE_CHIP,
-            enabled: false,
-          },
-          flat: {
-            name: 'Flat',
-            enabled: true,
-          },
-        };
-
         await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onHierarchyUserOptionsChange(userOptions);
-
-        expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-          this.getExpectedChildrenBeforeVisibilityFilter(),
+        await presenter.onHighlightedIdChange(
+          assertDefined(uiData.hierarchyTrees)[0].id,
         );
-
-        const nonVisibleNode = assertDefined(
-          uiData.hierarchyTrees
-            ?.at(0)
-            ?.findDfs(
-              (node) =>
-                !node.isRoot() &&
-                !node.getEagerPropertyByName('isComputedVisible')?.getValue(),
-            ),
+        const calculatedPropertyInRoot = uiData.propertiesTree?.findDfs(
+          (node) => node.source === PropertySource.CALCULATED,
+        );
+        expect(calculatedPropertyInRoot !== undefined).toEqual(
+          this.keepCalculatedPropertiesInRoot,
         );
-        pinNode(nonVisibleNode);
-        expect(uiData.pinnedItems).toEqual([nonVisibleNode]);
 
-        userOptions['showOnlyVisible'].enabled = true;
-        await presenter.onHierarchyUserOptionsChange(userOptions);
-        expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-          this.getExpectedChildrenAfterVisibilityFilter(),
+        await presenter.onHighlightedIdChange(
+          this.getSelectedTreeAfterPositionUpdate().id,
+        );
+        const calculatedPropertyInChild = uiData.propertiesTree?.findDfs(
+          (node) => node.source === PropertySource.CALCULATED,
+        );
+        expect(calculatedPropertyInChild !== undefined).toEqual(
+          this.keepCalculatedPropertiesInChild,
         );
-        expect(uiData.pinnedItems).toEqual([nonVisibleNode]);
       });
 
-      if (this.shouldExecuteFlatTreeTest) {
-        it('flattens hierarchy tree', async () => {
-          //change flat view to true
-          const userOptions: UserOptions = {
-            showDiff: {
-              name: 'Show diff',
-              enabled: false,
-            },
-            simplifyNames: {
-              name: 'Simplify names',
-              enabled: false,
-            },
-            showOnlyVisible: {
-              name: 'Show only',
-              chip: VISIBLE_CHIP,
-              enabled: false,
-            },
-            flat: {
-              name: 'Flat',
-              enabled: true,
-            },
-          };
-
+      if (this.shouldExecuteRectTests) {
+        it('sets properties tree and associated ui data from rect', async () => {
           await presenter.onAppEvent(this.getPositionUpdate());
-          expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-            this.getExpectedChildrenBeforeFlatFilter!(),
-          );
 
-          await presenter.onHierarchyUserOptionsChange(userOptions);
-          expect(uiData.hierarchyUserOptions).toEqual(userOptions);
-          expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-            this.getExpectedChildrenAfterFlatFilter!(),
+          const rect = assertDefined(uiData.rectsToDraw?.at(2));
+          await presenter.onHighlightedIdChange(rect.id);
+          expect(uiData.highlightedItem).toEqual(rect.id);
+          const propertiesTree = assertDefined(uiData.propertiesTree);
+          expect(propertiesTree.id).toEqual(rect.id);
+          expect(propertiesTree.getAllChildren().length).toBeGreaterThan(0);
+          assertDefined(this.executeSpecializedChecksForPropertiesFromRect)(
+            uiData,
           );
-          assertDefined(uiData.hierarchyTrees).forEach((tree) => {
-            tree.getAllChildren().forEach((child) => {
-              expect(child.getAllChildren().length).toEqual(0);
-            });
-          });
+
+          await presenter.onHighlightedIdChange(rect.id);
+          expect(uiData.highlightedItem).toEqual('');
         });
       }
 
@@ -394,389 +150,46 @@ export abstract class AbstractHierarchyViewerPresenterTest<
         it('simplifies names in hierarchy tree', async () => {
           const longName = assertDefined(this.treeNodeLongName);
           const shortName = assertDefined(this.treeNodeShortName);
-          //change flat view to true
           const userOptions: UserOptions = {
-            showDiff: {
-              name: 'Show diff',
-              enabled: false,
-            },
             simplifyNames: {
               name: 'Simplify names',
               enabled: false,
             },
-            showOnlyVisible: {
-              name: 'Show only',
-              chip: VISIBLE_CHIP,
-              enabled: false,
-            },
-            flat: {
-              name: 'Flat',
-              enabled: false,
-            },
           };
 
           await presenter.onAppEvent(this.getPositionUpdate());
+          const longNameFilter = UiTreeUtils.makeNodeFilter(
+            new TextFilter(longName).getFilterPredicate(),
+          );
           let nodeWithLongName = assertDefined(
-            assertDefined(uiData.hierarchyTrees)[0].findDfs(
-              UiTreeUtils.makeNodeFilter(longName),
-            ),
+            assertDefined(uiData.hierarchyTrees)[0].findDfs(longNameFilter),
           );
           expect(nodeWithLongName.getDisplayName()).toEqual(shortName);
-          pinNode(nodeWithLongName);
+          presenter.onPinnedItemChange(nodeWithLongName);
           expect(uiData.pinnedItems).toEqual([nodeWithLongName]);
 
           await presenter.onHierarchyUserOptionsChange(userOptions);
           expect(uiData.hierarchyUserOptions).toEqual(userOptions);
           nodeWithLongName = assertDefined(
-            assertDefined(uiData.hierarchyTrees)[0].findDfs(
-              UiTreeUtils.makeNodeFilter(longName),
-            ),
+            assertDefined(uiData.hierarchyTrees)[0].findDfs(longNameFilter),
           );
           expect(longName).toContain(nodeWithLongName.getDisplayName());
           expect(uiData.pinnedItems).toEqual([nodeWithLongName]);
         });
       }
 
-      it('filters hierarchy tree by search string', async () => {
-        const userOptions: UserOptions = {
-          showDiff: {
-            name: 'Show diff',
-            enabled: false,
-          },
-          simplifyNames: {
-            name: 'Simplify names',
-            enabled: true,
-          },
-          showOnlyVisible: {
-            name: 'Show only',
-            chip: VISIBLE_CHIP,
-            enabled: false,
-          },
-          flat: {
-            name: 'Flat',
-            enabled: true,
-          },
-        };
-        await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onHierarchyUserOptionsChange(userOptions);
-        expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-          this.getExpectedHierarchyChildrenBeforeStringFilter(),
-        );
-
-        const nonMatchNode = assertDefined(
-          uiData.hierarchyTrees
-            ?.at(0)
-            ?.findDfs(
-              (node) =>
-                !node.isRoot() &&
-                !node.id.includes(this.hierarchyFilter.filterString),
-            ),
-        );
-        pinNode(nonMatchNode);
-        expect(uiData.pinnedItems).toEqual([nonMatchNode]);
-
-        await presenter.onHierarchyFilterChange(this.hierarchyFilter);
-        expect(this.getTotalHierarchyChildren(uiData)).toEqual(
-          this.expectedHierarchyChildrenAfterStringFilter,
-        );
-        expect(uiData.pinnedItems).toEqual([nonMatchNode]);
-      });
-
-      it('sets properties tree and associated ui data from tree node', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-
-        const selectedTree = this.getSelectedTree();
-        await presenter.onHighlightedNodeChange(selectedTree);
-        const propertiesTree = assertDefined(uiData.propertiesTree);
-        expect(propertiesTree.id).toContain(selectedTree.id);
-        expect(propertiesTree.getAllChildren().length).toEqual(
-          this.numberOfNonDefaultProperties,
-        );
-        if (this.executeSpecializedChecksForPropertiesFromNode) {
-          this.executeSpecializedChecksForPropertiesFromNode(uiData);
-        }
-      });
-
-      it('after highlighting a node, updates properties tree on position update', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        const selectedTree = this.getSelectedTreeAfterPositionUpdate();
-        await presenter.onHighlightedNodeChange(selectedTree);
-        this.executeChecksForPropertiesTreeAfterPositionUpdate(uiData);
-
-        const secondUpdate = this.getSecondPositionUpdate();
-        if (secondUpdate) {
-          await presenter.onAppEvent(secondUpdate);
-          assertDefined(
-            this.executeChecksForPropertiesTreeAfterSecondPositionUpdate,
-          )(uiData);
-        }
-      });
-
-      if (this.shouldExecuteShowDiffTests) {
-        it('updates properties tree to show diffs', async () => {
-          //change flat view to true
-          const userOptions: UserOptions = {
-            showDiff: {
-              name: 'Show diff',
-              enabled: true,
-            },
-          };
-
-          await presenter.onAppEvent(this.getShowDiffPositionUpdate());
-          await presenter.onHighlightedNodeChange(this.getSelectedTree());
-          const propertyName = assertDefined(this.propertyWithDiff);
-          expect(
-            assertDefined(
-              uiData.propertiesTree?.getChildByName(propertyName),
-            ).getDiff(),
-          ).toEqual(DiffType.NONE);
-
-          await presenter.onPropertiesUserOptionsChange(userOptions);
-          expect(uiData.propertiesUserOptions).toEqual(userOptions);
-          expect(
-            assertDefined(
-              uiData.propertiesTree?.getChildByName(propertyName),
-            ).getDiff(),
-          ).toEqual(assertDefined(this.expectedPropertyDiffType));
-        });
-      }
-
-      it('shows/hides defaults', async () => {
-        const userOptions: UserOptions = {
-          showDiff: {
-            name: 'Show diff',
-            enabled: true,
-          },
-          showDefaults: {
-            name: 'Show defaults',
-            enabled: true,
-          },
-        };
-
-        await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onHighlightedNodeChange(this.getSelectedTree());
-        expect(
-          assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(this.numberOfNonDefaultProperties);
-
-        await presenter.onPropertiesUserOptionsChange(userOptions);
-        expect(uiData.propertiesUserOptions).toEqual(userOptions);
-        expect(
-          assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(
-          this.numberOfNonDefaultProperties + this.numberOfDefaultProperties,
-        );
-      });
-
-      it('filters properties tree', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onHighlightedNodeChange(this.getSelectedTree());
-        expect(
-          assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(this.numberOfNonDefaultProperties);
-
-        await presenter.onPropertiesFilterChange(this.propertiesFilter);
-        expect(
-          assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(this.numberOfFilteredProperties);
-      });
-
-      if (this.shouldExecuteRectTests) {
-        const totalRects = assertDefined(this.expectedTotalRects);
-        const visibleRects = assertDefined(this.expectedVisibleRects);
-
-        it('creates input data for rects view', async () => {
-          await presenter.onAppEvent(this.getPositionUpdate());
-          const rectsToDraw = assertDefined(uiData.rectsToDraw);
-          const expectedFirstRect = assertDefined(this.expectedFirstRect);
-          expect(rectsToDraw[0].x).toEqual(expectedFirstRect.x);
-          expect(rectsToDraw[0].y).toEqual(expectedFirstRect.y);
-          expect(rectsToDraw[0].w).toEqual(expectedFirstRect.w);
-          expect(rectsToDraw[0].h).toEqual(expectedFirstRect.h);
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects);
-        });
-
-        it('filters rects by visibility', async () => {
-          const userOptions: UserOptions = {
-            showOnlyVisible: {
-              name: 'Show only',
-              chip: VISIBLE_CHIP,
-              enabled: false,
-            },
-          };
-
-          await presenter.onAppEvent(this.getPositionUpdate());
-          presenter.onRectsUserOptionsChange(userOptions);
-          expect(uiData.rectsUserOptions).toEqual(userOptions);
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects);
-
-          userOptions['showOnlyVisible'].enabled = true;
-          presenter.onRectsUserOptionsChange(userOptions);
-          this.checkRectUiData(uiData, visibleRects, totalRects, visibleRects);
-        });
-
-        it('filters rects by show/hide state', async () => {
-          const userOptions: UserOptions = {
-            ignoreRectShowState: {
-              name: 'Ignore',
-              icon: 'visibility',
-              enabled: true,
-            },
-          };
-          presenter.onRectsUserOptionsChange(userOptions);
-          await presenter.onAppEvent(this.getPositionUpdate());
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects);
-
-          await presenter.onRectShowStateChange(
-            assertDefined(uiData.rectsToDraw)[0].id,
-            RectShowState.HIDE,
-          );
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects - 1);
-
-          userOptions['ignoreRectShowState'].enabled = false;
-          presenter.onRectsUserOptionsChange(userOptions);
-          this.checkRectUiData(
-            uiData,
-            totalRects - 1,
-            totalRects,
-            totalRects - 1,
-          );
-        });
-
-        it('handles both visibility and show/hide state in rects', async () => {
-          const userOptions: UserOptions = {
-            ignoreRectShowState: {
-              name: 'Ignore',
-              icon: 'visibility',
-              enabled: true,
-            },
-            showOnlyVisible: {
-              name: 'Show only',
-              chip: VISIBLE_CHIP,
-              enabled: false,
-            },
-          };
-          presenter.onRectsUserOptionsChange(userOptions);
-          await presenter.onAppEvent(this.getPositionUpdate());
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects);
-
-          await presenter.onRectShowStateChange(
-            assertDefined(uiData.rectsToDraw)[0].id,
-            RectShowState.HIDE,
-          );
-          this.checkRectUiData(uiData, totalRects, totalRects, totalRects - 1);
-
-          userOptions['ignoreRectShowState'].enabled = false;
-          presenter.onRectsUserOptionsChange(userOptions);
-          this.checkRectUiData(
-            uiData,
-            totalRects - 1,
-            totalRects,
-            totalRects - 1,
-          );
-
-          userOptions['showOnlyVisible'].enabled = true;
-          presenter.onRectsUserOptionsChange(userOptions);
-          this.checkRectUiData(
-            uiData,
-            visibleRects - 1,
-            totalRects,
-            visibleRects - 1,
-          );
-
-          userOptions['ignoreRectShowState'].enabled = true;
-          presenter.onRectsUserOptionsChange(userOptions);
-          this.checkRectUiData(
-            uiData,
-            visibleRects,
-            totalRects,
-            visibleRects - 1,
-          );
-        });
-
-        it('sets properties tree and associated ui data from rect', async () => {
-          await presenter.onAppEvent(this.getPositionUpdate());
-
-          const rect = assertDefined(uiData.rectsToDraw?.at(2));
-          await presenter.onHighlightedIdChange(rect.id);
-          expect(uiData.highlightedItem).toEqual(rect.id);
-          const propertiesTree = assertDefined(uiData.propertiesTree);
-          expect(propertiesTree.id).toEqual(rect.id);
-          expect(propertiesTree.getAllChildren().length).toBeGreaterThan(0);
-
-          if (this.executeSpecializedChecksForPropertiesFromRect) {
-            this.executeSpecializedChecksForPropertiesFromRect(uiData);
-          }
-
-          await presenter.onHighlightedIdChange(rect.id);
-          expect(uiData.highlightedItem).toEqual('');
-        });
-
-        it('after highlighting a rect, updates properties tree on position update', async () => {
-          await presenter.onAppEvent(this.getPositionUpdate());
-          await presenter.onHighlightedIdChange(
-            this.getSelectedTreeAfterPositionUpdate().id,
-          );
-          this.executeChecksForPropertiesTreeAfterPositionUpdate(uiData);
-
-          const secondUpdate = this.getSecondPositionUpdate();
-          if (secondUpdate) {
-            await presenter.onAppEvent(secondUpdate);
-            assertDefined(
-              this.executeChecksForPropertiesTreeAfterSecondPositionUpdate,
-            )(uiData);
-          }
-        });
-      } else {
-        it('is robust to attempts to change rect user data', async () => {
-          expect(() =>
-            presenter.onRectsUserOptionsChange({}),
-          ).not.toThrowError();
-          await expectAsync(
-            presenter.onRectShowStateChange('', RectShowState.SHOW),
-          ).not.toBeRejected();
-        });
-      }
-
-      it('handles filter preset requests', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        const saveEvent = new FilterPresetSaveRequest(
-          'TestPreset',
-          TraceType.TEST_TRACE_STRING,
-        );
-        expect(storage.get(saveEvent.name)).toBeUndefined();
-        await presenter.onAppEvent(saveEvent);
-        expect(storage.get(saveEvent.name)).toBeDefined();
-
-        await presenter.onHierarchyFilterChange(
-          new TextFilter('Test Filter', []),
-        );
-        await presenter.onHierarchyUserOptionsChange({});
-        await presenter.onPropertiesUserOptionsChange({});
-        await presenter.onPropertiesFilterChange(
-          new TextFilter('Test Filter', []),
-        );
-
-        if (this.shouldExecuteRectTests) {
-          presenter.onRectsUserOptionsChange({});
-          await presenter.onRectShowStateChange(
-            assertDefined(uiData.rectsToDraw)[0].id,
-            RectShowState.HIDE,
+      function chipEqualityTester(
+        first: any,
+        second: any,
+      ): boolean | undefined {
+        if (first instanceof Chip || second instanceof Chip) {
+          return (
+            first.short === second.short &&
+            first.long === second.long &&
+            first.type === second.type
           );
         }
-        const currentUiData = uiData;
-
-        const applyEvent = new FilterPresetApplyRequest(
-          saveEvent.name,
-          TraceType.TEST_TRACE_STRING,
-        );
-        await presenter.onAppEvent(applyEvent);
-        expect(uiData).not.toEqual(currentUiData);
-      });
-
-      function pinNode(node: UiHierarchyTreeNode) {
-        presenter.onPinnedItemChange(node);
-        expect(uiData.pinnedItems).toEqual([node]);
+        return undefined;
       }
     });
 
@@ -785,49 +198,16 @@ export abstract class AbstractHierarchyViewerPresenterTest<
     }
   }
 
-  private getTotalHierarchyChildren(uiData: UiDataHierarchy) {
-    const children = assertDefined(uiData.hierarchyTrees).reduce(
-      (tot, tree) => (tot += tree.getAllChildren().length),
-      0,
-    );
-    return children;
-  }
-
-  private checkRectUiData(
-    uiData: UiDataHierarchy,
-    rectsToDraw: number,
-    allRects: number,
-    shownRects: number,
-  ) {
-    expect(assertDefined(uiData.rectsToDraw).length).toEqual(rectsToDraw);
-    const showStates = Array.from(
-      assertDefined(uiData.rectIdToShowState).values(),
-    );
-    expect(showStates.length).toEqual(allRects);
-    expect(showStates.filter((s) => s === RectShowState.SHOW).length).toEqual(
-      shownRects,
-    );
-  }
-
-  abstract readonly shouldExecuteFlatTreeTest: boolean;
   abstract readonly shouldExecuteRectTests: boolean;
-  abstract readonly shouldExecuteShowDiffTests: boolean;
-  abstract readonly shouldExecuteDumpTests: boolean;
   abstract readonly shouldExecuteSimplifyNamesTest: boolean;
-  abstract readonly numberOfDefaultProperties: number;
-  abstract readonly numberOfNonDefaultProperties: number;
-  abstract readonly propertiesFilter: TextFilter;
-  abstract readonly numberOfFilteredProperties: number;
-  abstract readonly hierarchyFilter: TextFilter;
-  abstract readonly expectedHierarchyChildrenAfterStringFilter: number;
+  abstract readonly keepCalculatedPropertiesInChild: boolean;
+  abstract readonly keepCalculatedPropertiesInRoot: boolean;
+  abstract readonly expectedHierarchyOpts: UserOptions;
+  abstract readonly expectedPropertiesOpts: UserOptions;
 
-  readonly expectedFirstRect?: Rect;
-  readonly expectedTotalRects?: number;
-  readonly expectedVisibleRects?: number;
+  readonly expectedRectsOpts?: UserOptions;
   readonly treeNodeLongName?: string;
   readonly treeNodeShortName?: string;
-  readonly propertyWithDiff?: string;
-  readonly expectedPropertyDiffType?: DiffType;
 
   abstract setUpTestEnvironment(): Promise<void>;
   abstract createPresenter(
@@ -837,28 +217,17 @@ export abstract class AbstractHierarchyViewerPresenterTest<
   abstract createPresenterWithEmptyTrace(
     callback: NotifyHierarchyViewCallbackType<UiData>,
   ): AbstractHierarchyViewerPresenter<UiData>;
-  abstract createPresenterWithCorruptedTrace(
-    callback: NotifyHierarchyViewCallbackType<UiData>,
-  ): AbstractHierarchyViewerPresenter<UiData>;
   abstract getPositionUpdate(): TracePositionUpdate;
   abstract getSecondPositionUpdate(): TracePositionUpdate | undefined;
-  abstract getShowDiffPositionUpdate(): TracePositionUpdate;
   abstract getSelectedTree(): UiHierarchyTreeNode;
   abstract getSelectedTreeAfterPositionUpdate(): UiHierarchyTreeNode;
-
-  abstract getExpectedChildrenBeforeVisibilityFilter(): number;
-  abstract getExpectedChildrenAfterVisibilityFilter(): number;
-  abstract getExpectedHierarchyChildrenBeforeStringFilter(): number;
-  abstract executeChecksForPropertiesTreeAfterPositionUpdate(
+  abstract executePropertiesChecksAfterPositionUpdate(
     uiData: UiDataHierarchy,
   ): void;
 
-  getExpectedChildrenBeforeFlatFilter?(): number;
-  getExpectedChildrenAfterFlatFilter?(): number;
-  executeSpecializedChecksForPropertiesFromNode?(uiData: UiDataHierarchy): void;
-  executeChecksForPropertiesTreeAfterSecondPositionUpdate?(
+  executeSpecializedChecksForPropertiesFromRect?(uiData: UiDataHierarchy): void;
+  executePropertiesChecksAfterSecondPositionUpdate?(
     uiData: UiDataHierarchy,
   ): void;
-  executeSpecializedChecksForPropertiesFromRect?(uiData: UiDataHierarchy): void;
   executeSpecializedTests?(): void;
 }
diff --git a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts
index 0bfde591e..d20103712 100644
--- a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts
+++ b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {DOMUtils} from 'common/dom_utils';
 import {FunctionUtils} from 'common/function_utils';
 import {Timestamp} from 'common/time';
 import {
@@ -27,12 +28,13 @@ import {
 } from 'messaging/winscope_event_emitter';
 import {Trace, TraceEntry} from 'trace/trace';
 import {TraceEntryFinder} from 'trace/trace_entry_finder';
+import {TracePosition} from 'trace/trace_position';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UserOptions} from 'viewers/common/user_options';
 import {LogPresenter} from './log_presenter';
-import {TextFilter} from './text_filter';
-import {LogEntry, LogFieldType, UiDataLog} from './ui_data_log';
+import {LogEntry, LogHeader, UiDataLog} from './ui_data_log';
 import {
   LogFilterChangeDetail,
   LogTextFilterChangeDetail,
@@ -42,16 +44,21 @@ import {
 
 export type NotifyLogViewCallbackType<UiData> = (uiData: UiData) => void;
 
-export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
-  implements WinscopeEventEmitter
+export abstract class AbstractLogViewerPresenter<
+  UiData extends UiDataLog,
+  TraceEntryType extends object,
+> implements WinscopeEventEmitter
 {
+  protected static readonly VALUE_NA = 'N/A';
   protected emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
   protected abstract logPresenter: LogPresenter<LogEntry>;
   protected propertiesPresenter?: PropertiesPresenter;
   protected keepCalculated?: boolean;
+  private activeTrace?: Trace<object>;
+  private isInitialized = false;
 
   protected constructor(
-    protected readonly trace: Trace<PropertyTreeNode>,
+    protected readonly trace: Trace<TraceEntryType>,
     private readonly notifyViewCallback: NotifyLogViewCallbackType<UiData>,
     protected readonly uiData: UiData,
   ) {
@@ -67,14 +74,14 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
       ViewerEvents.LogFilterChange,
       async (event) => {
         const detail: LogFilterChangeDetail = (event as CustomEvent).detail;
-        await this.onFilterChange(detail.type, detail.value);
+        await this.onSelectFilterChange(detail.header, detail.value);
       },
     );
     htmlElement.addEventListener(
       ViewerEvents.LogTextFilterChange,
       async (event) => {
         const detail: LogTextFilterChangeDetail = (event as CustomEvent).detail;
-        await this.onTextFilterChange(detail.type, detail.filter);
+        await this.onTextFilterChange(detail.header, detail.filter);
       },
     );
     htmlElement.addEventListener(ViewerEvents.LogEntryClick, async (event) => {
@@ -103,6 +110,23 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
           (event as CustomEvent).detail.userOptions,
         ),
     );
+    htmlElement.addEventListener(
+      ViewerEvents.PropertiesFilterChange,
+      async (event) => {
+        const detail: TextFilter = (event as CustomEvent).detail;
+        await this.onPropertiesFilterChange(detail);
+      },
+    );
+
+    document.addEventListener('keydown', async (event: KeyboardEvent) => {
+      const isViewerVisible = DOMUtils.isElementVisible(htmlElement);
+      const isPositionChange =
+        event.key === 'ArrowRight' || event.key === 'ArrowLeft';
+      if (!isViewerVisible || !isPositionChange) {
+        return;
+      }
+      await this.onPositionChangeByKeyPress(event);
+    });
   }
 
   async onAppEvent(event: WinscopeEvent) {
@@ -116,28 +140,27 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
       this.uiData.isDarkMode = event.isDarkMode;
       this.notifyViewChanged();
     });
+    await event.visit(WinscopeEventType.ACTIVE_TRACE_CHANGED, async (event) => {
+      this.activeTrace = event.trace;
+    });
   }
 
-  async onFilterChange(type: LogFieldType, value: string[] | string) {
-    this.logPresenter.applyFilterChange(type, value);
+  async onSelectFilterChange(header: LogHeader, value: string[]) {
+    this.logPresenter.applySelectFilterChange(header, value);
     await this.updatePropertiesTree();
     this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
     this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
-    this.uiData.scrollToIndex =
-      this.logPresenter.getCurrentIndex() ??
-      this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
     this.uiData.entries = this.logPresenter.getFilteredEntries();
     this.notifyViewChanged();
   }
 
-  async onTextFilterChange(type: LogFieldType, filter: TextFilter) {
-    this.logPresenter.applyTextFilterChange(type, filter);
+  async onTextFilterChange(header: LogHeader, value: TextFilter) {
+    this.logPresenter.applyTextFilterChange(header, value);
     await this.updatePropertiesTree();
     this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
     this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
-    this.uiData.scrollToIndex =
-      this.logPresenter.getCurrentIndex() ??
-      this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
     this.uiData.entries = this.logPresenter.getFilteredEntries();
     this.notifyViewChanged();
   }
@@ -149,11 +172,21 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
     this.propertiesPresenter.applyPropertiesUserOptionsChange(userOptions);
     this.uiData.propertiesUserOptions =
       this.propertiesPresenter.getUserOptions();
-    await this.updatePropertiesTree();
+    await this.updatePropertiesTree(false);
+    this.notifyViewChanged();
+  }
+
+  async onPropertiesFilterChange(textFilter: TextFilter) {
+    if (!this.propertiesPresenter) {
+      return;
+    }
+    this.propertiesPresenter.applyPropertiesFilterChange(textFilter);
+    await this.updatePropertiesTree(false);
+    this.uiData.propertiesFilter = textFilter;
     this.notifyViewChanged();
   }
 
-  async onLogTimestampClick(traceEntry: TraceEntry<PropertyTreeNode>) {
+  async onLogTimestampClick(traceEntry: TraceEntry<object>) {
     await this.emitAppEvent(
       TracePositionUpdate.fromTraceEntry(traceEntry, true),
     );
@@ -184,9 +217,44 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
     this.notifyViewChanged();
   }
 
+  async onPositionChangeByKeyPress(event: KeyboardEvent) {
+    const currIndex = this.uiData.currentIndex;
+    if (this.activeTrace === this.trace && currIndex !== undefined) {
+      if (event.key === 'ArrowRight') {
+        event.stopImmediatePropagation();
+        if (currIndex < this.uiData.entries.length - 1) {
+          const currTimestamp =
+            this.uiData.entries[currIndex].traceEntry.getTimestamp();
+          const nextEntry = this.uiData.entries
+            .slice(currIndex + 1)
+            .find((entry) => entry.traceEntry.getTimestamp() > currTimestamp);
+          if (nextEntry) {
+            return this.emitAppEvent(
+              new TracePositionUpdate(
+                TracePosition.fromTraceEntry(nextEntry.traceEntry),
+                true,
+              ),
+            );
+          }
+        }
+      } else {
+        event.stopImmediatePropagation();
+        if (currIndex > 0) {
+          return this.emitAppEvent(
+            new TracePositionUpdate(
+              TracePosition.fromTraceEntry(
+                this.uiData.entries[currIndex - 1].traceEntry,
+              ),
+              true,
+            ),
+          );
+        }
+      }
+    }
+  }
+
   protected refreshUiData() {
     this.uiData.headers = this.logPresenter.getHeaders();
-    this.uiData.filters = this.logPresenter.getFilters();
     this.uiData.entries = this.logPresenter.getFilteredEntries();
     this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
     this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
@@ -195,15 +263,21 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
       this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
       this.uiData.propertiesUserOptions =
         this.propertiesPresenter.getUserOptions();
+      this.uiData.propertiesFilter = this.propertiesPresenter.getTextFilter();
     }
   }
 
   protected async applyTracePositionUpdate(event: TracePositionUpdate) {
     await this.initializeIfNeeded();
-    const entry = TraceEntryFinder.findCorrespondingEntry(
-      this.trace,
-      event.position,
-    );
+    let entry: TraceEntry<TraceEntryType> | undefined;
+    if (event.position.entry?.getFullTrace() === this.trace) {
+      entry = event.position.entry as TraceEntry<TraceEntryType>;
+    } else {
+      entry = TraceEntryFinder.findCorrespondingEntry(
+        this.trace,
+        event.position,
+      );
+    }
     this.logPresenter.applyTracePositionUpdate(entry);
 
     this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
@@ -218,10 +292,13 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
     this.notifyViewChanged();
   }
 
-  protected async updatePropertiesTree() {
+  protected async updatePropertiesTree(updateDefaultAllowlist = true) {
     if (this.propertiesPresenter) {
       const tree = this.getPropertiesTree();
       this.propertiesPresenter.setPropertiesTree(tree);
+      if (updateDefaultAllowlist && this.updateDefaultAllowlist) {
+        this.updateDefaultAllowlist(tree);
+      }
       await this.propertiesPresenter.formatPropertiesTree(
         undefined,
         undefined,
@@ -231,6 +308,27 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
     }
   }
 
+  private async initializeIfNeeded() {
+    if (this.isInitialized) {
+      return;
+    }
+
+    if (this.initializeTraceSpecificData) {
+      await this.initializeTraceSpecificData();
+    }
+
+    const headers = this.makeHeaders();
+    const allEntries = await this.makeUiDataEntries(headers);
+    if (this.updateFiltersInHeaders) {
+      this.updateFiltersInHeaders(headers, allEntries);
+    }
+
+    this.logPresenter.setAllEntries(allEntries);
+    this.logPresenter.setHeaders(headers);
+    this.refreshUiData();
+    this.isInitialized = true;
+  }
+
   private updateIndicesUiData() {
     this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
     this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
@@ -254,5 +352,14 @@ export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
     this.notifyViewCallback(this.uiData);
   }
 
-  protected abstract initializeIfNeeded(): Promise<void>;
+  protected abstract makeHeaders(): LogHeader[];
+  protected abstract makeUiDataEntries(
+    headers: LogHeader[],
+  ): Promise<LogEntry[]>;
+  protected initializeTraceSpecificData?(): Promise<void>;
+  protected updateFiltersInHeaders?(
+    headers: LogHeader[],
+    allEntries: LogEntry[],
+  ): void;
+  protected updateDefaultAllowlist?(tree: PropertyTreeNode | undefined): void;
 }
diff --git a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts
index 11c10b360..b0d41dbe6 100644
--- a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts
+++ b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts
@@ -21,448 +21,114 @@ import {
   AbstractLogViewerPresenter,
   NotifyLogViewCallbackType,
 } from './abstract_log_viewer_presenter';
-import {TextFilter} from './text_filter';
-import {LogEntry, LogFieldType, LogFieldValue, UiDataLog} from './ui_data_log';
-import {
-  LogFilterChangeDetail,
-  LogTextFilterChangeDetail,
-  TimestampClickDetail,
-  ViewerEvents,
-} from './viewer_events';
+import {LogSelectFilter, LogTextFilter} from './log_filters';
+import {LogHeader, UiDataLog} from './ui_data_log';
 
 export abstract class AbstractLogViewerPresenterTest<UiData extends UiDataLog> {
   execute() {
-    describe('AbstractLogViewerPresenterTest', () => {
+    describe('Common tests', () => {
       let uiData: UiData;
-      let presenter: AbstractLogViewerPresenter<UiData>;
+      let presenter: AbstractLogViewerPresenter<UiData, object>;
+
       beforeAll(async () => {
         await this.setUpTestEnvironment();
       });
 
       beforeEach(async () => {
+        jasmine.addCustomEqualityTester(filterEqualityTester);
         presenter = await this.createPresenter((newData) => {
           uiData = newData;
         });
+        if (this.resetTestEnvironment) {
+          this.resetTestEnvironment();
+        }
       });
 
       it('is robust to empty trace', async () => {
-        const notifyViewCallback = (newData: UiData) => {
-          uiData = newData;
-        };
         const presenter = await this.createPresenterWithEmptyTrace(
-          notifyViewCallback,
+          (newData: UiData) => (uiData = newData),
         );
-
-        const positionUpdateWithoutTraceEntry =
+        await presenter.onAppEvent(
           TracePositionUpdate.fromTimestamp(
             TimestampConverterUtils.makeRealTimestamp(0n),
-          );
-        await presenter.onAppEvent(positionUpdateWithoutTraceEntry);
-
-        expect(uiData.entries).toEqual([]);
-        expect(uiData.selectedIndex).toBeUndefined();
-        expect(uiData.scrollToIndex).toBeUndefined();
-        expect(uiData.currentIndex).toBeUndefined();
-
-        if (this.shouldExecuteFilterTests) {
-          expect(uiData.filters?.length).toBeGreaterThan(0);
-        }
-
-        if (this.shouldExecuteHeaderTests) {
-          expect(uiData.headers?.length).toBeGreaterThan(0);
-        }
-
-        if (this.shouldExecutePropertiesTests) {
-          expect(uiData.propertiesTree).toBeUndefined();
-          expect(uiData.propertiesUserOptions).toBeDefined();
-          if (this.executePropertiesChecksForEmptyTrace) {
-            this.executePropertiesChecksForEmptyTrace(uiData);
+          ),
+        );
+        for (const [index, expectedHeader] of this.expectedHeaders.entries()) {
+          const header = uiData.headers[index];
+          expect(header.spec).toEqual(expectedHeader.header.spec);
+          if (expectedHeader.options) {
+            expect((header.filter as LogSelectFilter)?.options).toEqual([]);
           }
         }
-      });
-
-      it('adds events listeners', async () => {
-        const element = document.createElement('div');
-        presenter.addEventListeners(element);
-
-        let spy: jasmine.Spy = spyOn(presenter, 'onFilterChange');
-        const filterDetail = new LogFilterChangeDetail(
-          LogFieldType.CUJ_TYPE,
-          '',
-        );
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.LogFilterChange, {
-            detail: filterDetail,
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(filterDetail.type, filterDetail.value);
-
-        spy = spyOn(presenter, 'onTextFilterChange');
-        const textFilterDetail = new LogTextFilterChangeDetail(
-          LogFieldType.CUJ_TYPE,
-          new TextFilter('', []),
-        );
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.LogTextFilterChange, {
-            detail: textFilterDetail,
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(
-          textFilterDetail.type,
-          textFilterDetail.filter,
-        );
-
-        spy = spyOn(presenter, 'onLogEntryClick');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.LogEntryClick, {
-            detail: 0,
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(0);
-
-        spy = spyOn(presenter, 'onArrowDownPress');
-        element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowDownPress));
-        expect(spy).toHaveBeenCalled();
-
-        spy = spyOn(presenter, 'onArrowUpPress');
-        element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowUpPress));
-        expect(spy).toHaveBeenCalled();
-
-        await presenter.onAppEvent(this.getPositionUpdate());
-        spy = spyOn(presenter, 'onLogTimestampClick');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.TimestampClick, {
-            detail: new TimestampClickDetail(uiData.entries[0].traceEntry),
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(uiData.entries[0].traceEntry);
-
-        spy = spyOn(presenter, 'onRawTimestampClick');
-        const ts = TimestampConverterUtils.makeZeroTimestamp();
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.TimestampClick, {
-            detail: new TimestampClickDetail(undefined, ts),
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith(ts);
-
-        spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
-        element.dispatchEvent(
-          new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
-            detail: {userOptions: {}},
-          }),
-        );
-        expect(spy).toHaveBeenCalledWith({});
+        if (this.executePropertiesChecksForEmptyTrace) {
+          this.executePropertiesChecksForEmptyTrace(uiData);
+        }
       });
 
       it('processes trace position updates', async () => {
         await assertDefined(presenter).onAppEvent(
           assertDefined(this.getPositionUpdate()),
         );
-        expect(uiData.scrollToIndex).toEqual(
-          this.expectedIndexOfFirstPositionUpdate,
-        );
-        expect(uiData.currentIndex).toEqual(
-          this.expectedIndexOfFirstPositionUpdate,
-        );
-        expect(uiData.selectedIndex).toBeUndefined();
-        expect(uiData.entries.length).toEqual(this.totalOutputEntries);
-
-        if (this.shouldExecutePropertiesTests) {
-          expect(assertDefined(uiData.propertiesTree).id).toEqual(
-            assertDefined(uiData.entries[0].propertiesTree).id,
-          );
-          if (this.executePropertiesChecksAfterPositionUpdate) {
-            this.executePropertiesChecksAfterPositionUpdate(uiData);
-          }
-        }
-
-        if (this.shouldExecuteFilterTests) {
-          for (const [logFieldType, expectedOptions] of assertDefined(
-            this.expectedInitialFilterOptions,
-          )) {
-            const options = assertDefined(
-              uiData.filters?.find((f) => f.type === logFieldType)?.options,
+        for (const [index, expectedHeader] of this.expectedHeaders.entries()) {
+          const header = uiData.headers[index];
+          expect(header).toEqual(expectedHeader.header);
+          if (expectedHeader.options) {
+            expect((header.filter as LogSelectFilter).options).toEqual(
+              expectedHeader.options,
             );
-            if (Array.isArray(expectedOptions)) {
-              expect(options).toEqual(expectedOptions);
-            } else {
-              expect(options.length).toEqual(expectedOptions);
-            }
           }
         }
-      });
-
-      it('processes trace position update and updates current entry and scroll position', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        this.checkInitialTracePositionUpdate(uiData);
-
-        await presenter.onAppEvent(this.getSecondPositionUpdate());
-        expect(uiData.currentIndex).toEqual(
-          this.expectedIndexOfSecondPositionUpdate,
-        );
-        expect(uiData.selectedIndex).toBeUndefined();
-
-        if (this.shouldExecutePropertiesTests) {
-          expect(assertDefined(uiData.propertiesTree).id).toEqual(
-            assertDefined(
-              uiData.entries[this.expectedIndexOfSecondPositionUpdate]
-                .propertiesTree,
-            ).id,
-          );
+        if (this.executePropertiesChecksAfterPositionUpdate) {
+          this.executePropertiesChecksAfterPositionUpdate(uiData);
         }
       });
+    });
 
-      if (this.shouldExecuteFilterTests) {
-        it('filters entries', async () => {
-          for (const [type, valuesToSet] of assertDefined(
-            this.filterValuesToSet,
-          )) {
-            const expected = assertDefined(
-              this.expectedFieldValuesAfterFilter?.get(type),
-            );
-            for (let i = 0; i < valuesToSet.length; i++) {
-              const filterValues = valuesToSet[i];
-              const expectedFieldValues = expected[i];
-
-              await presenter.onFilterChange(type, filterValues);
-              const fieldValues = uiData.entries.map((entry) =>
-                assertDefined(this.getFieldValue(entry, type)),
-              );
-              if (Array.isArray(expectedFieldValues)) {
-                expect(new Set(fieldValues)).toEqual(
-                  new Set(expectedFieldValues),
-                );
-              } else {
-                expect(fieldValues.length).toEqual(expectedFieldValues);
-              }
-              await presenter.onFilterChange(type, []);
-            }
-          }
-        });
-
-        it('updates indices when filters change', async () => {
-          await presenter.onAppEvent(this.getSecondPositionUpdate());
-          const filterName = assertDefined(this.filterNameForCurrentIndexTest);
-          await presenter.onFilterChange(filterName, []);
-          expect(uiData.currentIndex).toEqual(
-            this.expectedIndexOfSecondPositionUpdate,
-          );
-          expect(uiData.scrollToIndex).toEqual(
-            this.expectedIndexOfSecondPositionUpdate,
-          );
-          expect(uiData.selectedIndex).toEqual(undefined);
-
-          const finalEntryIndex = uiData.entries.length - 1;
-          await presenter.onLogEntryClick(finalEntryIndex);
-          expect(uiData.selectedIndex).toEqual(finalEntryIndex);
-
-          await presenter.onFilterChange(
-            filterName,
-            assertDefined(this.filterChangeForCurrentIndexTest),
-          );
-          expect(uiData.currentIndex).toEqual(
-            this.expectedCurrentIndexAfterFilterChange,
-          );
-          expect(uiData.scrollToIndex).toEqual(
-            this.expectedCurrentIndexAfterFilterChange,
-          );
-
-          let expectedSelectedIndex =
-            finalEntryIndex <= uiData.entries.length - 1
-              ? finalEntryIndex
-              : this.expectedCurrentIndexAfterFilterChange;
-          expect(uiData.selectedIndex).toEqual(expectedSelectedIndex);
-
-          await presenter.onFilterChange(
-            filterName,
-            assertDefined(this.secondFilterChangeForCurrentIndexTest),
-          );
-          expect(uiData.currentIndex).toEqual(
-            this.expectedCurrentIndexAfterSecondFilterChange,
-          );
-          expect(uiData.scrollToIndex).toEqual(
-            this.expectedCurrentIndexAfterSecondFilterChange,
-          );
-
-          const prevStillValid =
-            expectedSelectedIndex !== undefined &&
-            expectedSelectedIndex <= uiData.entries.length - 1;
-          expectedSelectedIndex = prevStillValid
-            ? expectedSelectedIndex
-            : this.expectedCurrentIndexAfterSecondFilterChange;
-          expect(uiData.selectedIndex).toEqual(expectedSelectedIndex);
-        });
-      }
-
-      it('updates selected entry ui data when entry clicked', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        this.checkInitialTracePositionUpdate(uiData);
-
-        await presenter.onLogEntryClick(this.logEntryClickIndex);
-        this.checkSelectedEntryUiData(uiData, this.logEntryClickIndex);
-        expect(uiData.scrollToIndex).toEqual(undefined); // no scrolling
-
-        // does not remove selection when entry clicked again
-        await presenter.onLogEntryClick(this.logEntryClickIndex);
-        this.checkSelectedEntryUiData(uiData, this.logEntryClickIndex);
-        expect(uiData.scrollToIndex).toEqual(undefined); // no scrolling
-      });
-
-      it('updates selected entry ui data when entry changed by key press', async () => {
-        await presenter.onLogEntryClick(0);
-
-        await presenter.onArrowDownPress();
-        this.checkSelectedAndScrollIndices(uiData, 1);
-
-        await presenter.onArrowUpPress();
-        this.checkSelectedAndScrollIndices(uiData, 0);
-
-        // robust to attempt to go before first entry
-        await presenter.onArrowUpPress();
-        this.checkSelectedAndScrollIndices(uiData, 0);
-
-        // robust to attempt to go beyond last entry
-        const finalIndex = uiData.entries.length - 1;
-        await presenter.onLogEntryClick(finalIndex);
-        await presenter.onArrowDownPress();
-        expect(uiData.selectedIndex).toEqual(finalIndex);
-      });
-
-      it('computes index based on trace position update', async () => {
-        await presenter.onAppEvent(this.getPositionUpdate());
-        expect(uiData.currentIndex).toEqual(
-          this.expectedIndexOfFirstPositionUpdate,
-        );
-
-        await presenter.onAppEvent(this.getSecondPositionUpdate());
-        expect(uiData.currentIndex).toEqual(
-          this.expectedIndexOfSecondPositionUpdate,
-        );
-      });
-
-      it('emits event on log timestamp click', async () => {
-        const spy = jasmine.createSpy();
-        presenter.setEmitEvent(spy);
-
-        await presenter.onLogTimestampClick(uiData.entries[0].traceEntry);
-        expect(spy).toHaveBeenCalledWith(
-          TracePositionUpdate.fromTraceEntry(
-            uiData.entries[0].traceEntry,
-            true,
-          ),
+    function filterEqualityTester(
+      first: any,
+      second: any,
+    ): boolean | undefined {
+      if (first instanceof LogTextFilter && second instanceof LogTextFilter) {
+        return (
+          first.textFilter.filterString === second.textFilter.filterString &&
+          first.textFilter.flags.length === second.textFilter.flags.length &&
+          first.textFilter.flags.every(
+            (flag, index) => flag === second.textFilter.flags[index],
+          )
         );
-      });
-
-      it('emits event on raw timestamp click', async () => {
-        const spy = jasmine.createSpy();
-        presenter.setEmitEvent(spy);
-
-        const ts = TimestampConverterUtils.makeZeroTimestamp();
-        await presenter.onRawTimestampClick(ts);
-        expect(spy).toHaveBeenCalledWith(
-          TracePositionUpdate.fromTimestamp(ts, true),
+      }
+      if (
+        first instanceof LogSelectFilter &&
+        second instanceof LogSelectFilter
+      ) {
+        return (
+          first.options.length === second.options.length &&
+          first.shouldFilterBySubstring === second.shouldFilterBySubstring
         );
-      });
-
-      if (!this.shouldExecutePropertiesTests) {
-        it('is robust to attempts to change properties', async () => {
-          await presenter.onAppEvent(this.getPositionUpdate());
-          await presenter.onLogEntryClick(this.logEntryClickIndex);
-
-          await presenter.onPropertiesUserOptionsChange({});
-          expect(uiData.propertiesUserOptions).toBeUndefined();
-          expect(uiData.propertiesTree).toBeUndefined();
-        });
       }
-    });
+      return undefined;
+    }
 
     if (this.executeSpecializedTests) {
       this.executeSpecializedTests();
     }
   }
 
-  checkInitialTracePositionUpdate(uiData: UiDataLog) {
-    expect(uiData.entries.length).toEqual(this.totalOutputEntries);
-    expect(uiData.scrollToIndex).toEqual(
-      this.expectedIndexOfFirstPositionUpdate,
-    );
-    expect(uiData.currentIndex).toEqual(
-      this.expectedIndexOfFirstPositionUpdate,
-    );
-    expect(uiData.selectedIndex).toBeUndefined();
-
-    if (this.shouldExecuteFilterTests) {
-      expect(uiData.filters?.length).toBeGreaterThan(0);
-    }
-
-    if (this.shouldExecuteHeaderTests) {
-      expect(uiData.headers?.length).toBeGreaterThan(0);
-    }
-
-    if (this.shouldExecutePropertiesTests) {
-      expect(uiData.propertiesTree).toBeDefined();
-      expect(uiData.propertiesUserOptions).toBeDefined();
-    }
-  }
-
-  getFieldValue(entry: LogEntry, logFieldType: LogFieldType) {
-    return entry.fields.find((f) => f.type === logFieldType)?.value;
-  }
-
-  checkSelectedEntryUiData(uiData: UiDataLog, newIndex: number | undefined) {
-    expect(uiData.selectedIndex).toEqual(newIndex);
-    expect(uiData.currentIndex).toEqual(
-      this.expectedIndexOfFirstPositionUpdate,
-    );
-
-    if (this.shouldExecutePropertiesTests) {
-      if (newIndex !== undefined) {
-        expect(assertDefined(uiData.propertiesTree).id).toEqual(
-          assertDefined(uiData.entries[newIndex].propertiesTree).id,
-        );
-      } else {
-        expect(uiData.propertiesTree).toBeUndefined();
-      }
-    }
-  }
-
-  checkSelectedAndScrollIndices(uiData: UiDataLog, index: number | undefined) {
-    this.checkSelectedEntryUiData(uiData, index);
-    expect(uiData.scrollToIndex).toEqual(index);
-  }
-
-  abstract readonly shouldExecuteHeaderTests: boolean;
-  abstract readonly shouldExecuteFilterTests: boolean;
-  abstract readonly shouldExecutePropertiesTests: boolean;
-
-  abstract readonly totalOutputEntries: number;
-  abstract readonly expectedIndexOfFirstPositionUpdate: number;
-  abstract readonly expectedIndexOfSecondPositionUpdate: number;
-  abstract readonly logEntryClickIndex: number;
-
-  readonly expectedInitialFilterOptions?: Map<LogFieldType, string[] | number>;
-  readonly filterValuesToSet?: Map<LogFieldType, Array<string[] | string>>;
-  readonly expectedFieldValuesAfterFilter?: Map<
-    LogFieldType,
-    Array<LogFieldValue[] | number>
-  >;
-  readonly filterNameForCurrentIndexTest?: LogFieldType;
-  readonly filterChangeForCurrentIndexTest?: string[];
-  readonly expectedCurrentIndexAfterFilterChange?: number;
-  readonly secondFilterChangeForCurrentIndexTest?: string[];
-  readonly expectedCurrentIndexAfterSecondFilterChange?: number;
+  abstract readonly expectedHeaders: Array<{
+    header: LogHeader;
+    options?: string[];
+  }>;
 
   abstract setUpTestEnvironment(): Promise<void>;
   abstract createPresenter(
     callback: NotifyLogViewCallbackType<UiData>,
-  ): Promise<AbstractLogViewerPresenter<UiData>>;
+  ): Promise<AbstractLogViewerPresenter<UiData, object>>;
   abstract createPresenterWithEmptyTrace(
     callback: NotifyLogViewCallbackType<UiData>,
-  ): Promise<AbstractLogViewerPresenter<UiData>>;
+  ): Promise<AbstractLogViewerPresenter<UiData, object>>;
   abstract getPositionUpdate(): TracePositionUpdate;
-  abstract getSecondPositionUpdate(): TracePositionUpdate;
 
+  resetTestEnvironment?(): void;
   executePropertiesChecksForEmptyTrace?(uiData: UiDataLog): void;
   executePropertiesChecksAfterPositionUpdate?(uiData: UiDataLog): void;
   executeSpecializedTests?(): void;
diff --git a/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts b/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
index caa65034a..1a1181e51 100644
--- a/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
+++ b/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
@@ -18,7 +18,6 @@ import {assertDefined} from 'common/assert_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
 import {Store} from 'common/store';
 import {Timestamp} from 'common/time';
-import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
 import {Trace, TraceEntry} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {ImeTraceType, TraceType} from 'trace/trace_type';
@@ -33,6 +32,7 @@ import {
   ProcessedWindowManagerState,
 } from 'viewers/common/ime_utils';
 import {TableProperties} from 'viewers/common/table_properties';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UserOptions} from 'viewers/common/user_options';
 import {
   AbstractHierarchyViewerPresenter,
@@ -42,7 +42,6 @@ import {VISIBLE_CHIP} from './chip';
 import {HierarchyPresenter} from './hierarchy_presenter';
 import {UpdateSfSubtreeDisplayNames} from './operations/update_sf_subtree_display_names';
 import {PropertiesPresenter} from './properties_presenter';
-import {TextFilter} from './text_filter';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiTreeUtils} from './ui_tree_utils';
 
@@ -74,11 +73,7 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'ImeHierarchyFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     [],
     true,
     false,
@@ -92,20 +87,14 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
         showDefaults: {
           name: 'Show defaults',
           enabled: false,
-          tooltip: `
-                If checked, shows the value of all properties.
-                Otherwise, hides all properties whose value is
-                the default for its data type.
-              `,
+          tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
         },
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'ImePropertiesFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     [],
   );
   protected override multiTraceType = undefined;
@@ -135,69 +124,6 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
     this.wmTrace = traces.getTrace(TraceType.WINDOW_MANAGER);
   }
 
-  async onAppEvent(event: WinscopeEvent) {
-    await this.handleCommonWinscopeEvents(event);
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        this.clearOverridePropertiesTreeSelection();
-        await this.applyTracePositionUpdate(event);
-
-        const imeEntry = this.hierarchyPresenter.getCurrentEntryForTrace(
-          this.imeTrace,
-        );
-        const [sfEntry, wmEntry] = this.findSfWmTraceEntries(imeEntry);
-
-        if (imeEntry) {
-          this.additionalProperties = await this.getAdditionalProperties(
-            await wmEntry?.getValue(),
-            await sfEntry?.getValue(),
-            wmEntry?.getTimestamp(),
-            sfEntry?.getTimestamp(),
-          );
-          this.hierarchyTableProperties = this.getHierarchyTableProperties();
-
-          await this.updateOverridePropertiesTree(this.additionalProperties);
-
-          const highlightedItem = this.getHighlightedItem();
-          const selected = this.hierarchyPresenter.getSelectedTree();
-
-          if (!selected && highlightedItem !== undefined) {
-            const isHighlightedFilter = (node: HierarchyTreeNode) =>
-              UiTreeUtils.isHighlighted(node, highlightedItem);
-            let selectedTree =
-              this.additionalProperties?.sf?.taskLayerOfImeContainer?.findDfs(
-                isHighlightedFilter,
-              );
-            if (!selectedTree) {
-              selectedTree =
-                this.additionalProperties?.sf?.taskLayerOfImeSnapshot?.findDfs(
-                  isHighlightedFilter,
-                );
-            }
-
-            if (selectedTree) {
-              this.hierarchyPresenter.setSelectedTree([
-                assertDefined(this.sfTrace),
-                selectedTree,
-              ]);
-              await this.updatePropertiesTree();
-            }
-          }
-        }
-        this.refreshUIData();
-      },
-    );
-    await event.visit(
-      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
-      async (event) => {
-        const filterPresetName = event.name;
-        await this.applyPresetConfig(filterPresetName);
-        this.refreshUIData();
-      },
-    );
-  }
-
   async onHighlightedNodeChange(node: UiHierarchyTreeNode) {
     this.clearOverridePropertiesTreeSelection();
     await this.applyHighlightedNodeChange(node);
@@ -275,6 +201,55 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
     return this.overridePropertiesTreeName;
   }
 
+  protected override async initializeIfNeeded(): Promise<void> {
+    this.clearOverridePropertiesTreeSelection();
+  }
+
+  protected override async processDataAfterPositionUpdate(): Promise<void> {
+    const imeEntry = this.hierarchyPresenter.getCurrentEntryForTrace(
+      this.imeTrace,
+    );
+    const [sfEntry, wmEntry] = this.findSfWmTraceEntries(imeEntry);
+
+    if (imeEntry) {
+      this.additionalProperties = await this.getAdditionalProperties(
+        await wmEntry?.getValue(),
+        await sfEntry?.getValue(),
+        wmEntry?.getTimestamp(),
+        sfEntry?.getTimestamp(),
+      );
+      this.hierarchyTableProperties = this.getHierarchyTableProperties();
+
+      await this.updateOverridePropertiesTree(this.additionalProperties);
+
+      const highlightedItem = this.getHighlightedItem();
+      const selected = this.hierarchyPresenter.getSelectedTree();
+
+      if (!selected && highlightedItem !== undefined) {
+        const isHighlightedFilter = (node: HierarchyTreeNode) =>
+          UiTreeUtils.isHighlighted(node, highlightedItem);
+        let selectedTree =
+          this.additionalProperties?.sf?.taskLayerOfImeContainer?.findDfs(
+            isHighlightedFilter,
+          );
+        if (!selectedTree) {
+          selectedTree =
+            this.additionalProperties?.sf?.taskLayerOfImeSnapshot?.findDfs(
+              isHighlightedFilter,
+            );
+        }
+
+        if (selectedTree) {
+          this.hierarchyPresenter.setSelectedTree([
+            assertDefined(this.sfTrace),
+            selectedTree,
+          ]);
+          await this.updatePropertiesTree();
+        }
+      }
+    }
+  }
+
   private async makeSfSubtrees(
     sfProperties: ImeLayers,
   ): Promise<UiHierarchyTreeNode[]> {
@@ -388,7 +363,7 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
     await this.updatePropertiesTree();
   }
 
-  private refreshUIData() {
+  protected override refreshUIData() {
     this.uiData.hierarchyTableProperties = this.hierarchyTableProperties;
     this.uiData.additionalProperties = this.additionalProperties;
     this.refreshHierarchyViewerUiData();
diff --git a/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts b/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
index afb4bf46a..012fdc33d 100644
--- a/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
+++ b/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
@@ -33,7 +33,7 @@ import {PresenterInputMethodService} from 'viewers/viewer_input_method_service/p
 import {NotifyHierarchyViewCallbackType} from './abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from './abstract_hierarchy_viewer_presenter_test';
 import {AbstractPresenterInputMethod} from './abstract_presenter_input_method';
-import {TextFilter} from './text_filter';
+import {VISIBLE_CHIP} from './chip';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
@@ -45,14 +45,34 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
   private selectedTree: UiHierarchyTreeNode | undefined;
   private entries: Map<TraceType, HierarchyTreeNode> | undefined;
 
-  override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = false;
-  override readonly shouldExecuteShowDiffTests = false;
-  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = false;
-
-  override readonly hierarchyFilter = new TextFilter('Reject all', []);
-  override readonly expectedHierarchyChildrenAfterStringFilter = 0;
+  override readonly keepCalculatedPropertiesInChild = false;
+  override readonly keepCalculatedPropertiesInRoot = false;
+  override readonly expectedHierarchyOpts = {
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+    simplifyNames: {
+      name: 'Simplify names',
+      enabled: true,
+    },
+    flat: {
+      name: 'Flat',
+      enabled: false,
+    },
+  };
+  override readonly expectedPropertiesOpts = {
+    showDefaults: {
+      name: 'Show defaults',
+      enabled: false,
+      tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
+    },
+  };
 
   override async setUpTestEnvironment(): Promise<void> {
     let secondEntries: Map<TraceType, HierarchyTreeNode>;
@@ -105,27 +125,7 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
   override createPresenterWithEmptyTrace(
     callback: NotifyHierarchyViewCallbackType<ImeUiData>,
   ): AbstractPresenterInputMethod {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(this.imeTraceType)
-      .setEntries([])
-      .build();
-    const traces = new Traces();
-    traces.addTrace(trace);
-    return new this.PresenterInputMethod(
-      trace,
-      traces,
-      new InMemoryStorage(),
-      callback,
-    );
-  }
-  override createPresenterWithCorruptedTrace(
-    callback: NotifyHierarchyViewCallbackType<ImeUiData>,
-  ): AbstractPresenterInputMethod {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(this.imeTraceType)
-      .setEntries([assertDefined(this.selectedTree)])
-      .setIsCorrupted(true)
-      .build();
+    const trace = UnitTestUtils.makeEmptyTrace(this.imeTraceType);
     const traces = new Traces();
     traces.addTrace(trace);
     return new this.PresenterInputMethod(
@@ -153,30 +153,6 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
     return this.secondPositionUpdate;
   }
 
-  override getShowDiffPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.positionUpdate);
-  }
-
-  override getExpectedChildrenBeforeVisibilityFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedChildrenAfterVisibilityFilter(): number {
-    return this.numberOfVisibleChildren;
-  }
-
-  override getExpectedChildrenBeforeFlatFilter(): number {
-    return this.numberOfNestedChildren;
-  }
-
-  override getExpectedChildrenAfterFlatFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedHierarchyChildrenBeforeStringFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
   override getSelectedTree(): UiHierarchyTreeNode {
     return assertDefined(this.selectedTree);
   }
@@ -185,14 +161,12 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
     return assertDefined(this.selectedTree);
   }
 
-  override executeChecksForPropertiesTreeAfterPositionUpdate(
-    uiData: UiDataHierarchy,
-  ) {
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiDataHierarchy) {
     const trees = assertDefined(uiData.hierarchyTrees);
     expect(trees.length).toEqual(this.numberOfNestedChildren);
   }
 
-  override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
+  override executePropertiesChecksAfterSecondPositionUpdate(
     uiData: UiDataHierarchy,
   ) {
     const trees = assertDefined(uiData.hierarchyTrees);
@@ -348,8 +322,6 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
   protected getPropertiesTree?(): PropertyTreeNode;
   protected abstract getSelectedNode(): HierarchyTreeNode;
 
-  protected abstract readonly numberOfFlattenedChildren: number;
-  protected abstract readonly numberOfVisibleChildren: number;
   protected abstract readonly numberOfNestedChildren: number;
   protected abstract readonly PresenterInputMethod:
     | typeof PresenterInputMethodClients
diff --git a/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts b/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
index 6b8de264a..e39726c41 100644
--- a/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
+++ b/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
@@ -18,17 +18,18 @@ import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {AbstractPresenterInputMethod} from 'viewers/common/abstract_presenter_input_method';
 import {ImeUiData} from 'viewers/common/ime_ui_data';
 import {ViewerEvents} from 'viewers/common/viewer_events';
-import {View, Viewer} from 'viewers/viewer';
+import {View, Viewer, ViewType} from 'viewers/viewer';
 
 export abstract class AbstractViewerInputMethod implements Viewer {
   private readonly trace: Trace<HierarchyTreeNode>;
   protected readonly htmlElement: HTMLElement;
   protected readonly presenter: AbstractPresenterInputMethod;
-  protected abstract readonly view: View;
+  protected readonly view: View;
 
   protected imeUiCallback = (uiData: ImeUiData) => {
     (this.htmlElement as any).inputData = uiData;
@@ -39,6 +40,12 @@ export abstract class AbstractViewerInputMethod implements Viewer {
     this.htmlElement = document.createElement('viewer-input-method');
     this.presenter = this.initializePresenter(trace, traces, storage);
     this.addViewerEventListeners();
+    this.view = new View(
+      ViewType.TRACE_TAB,
+      this.getTraces(),
+      this.htmlElement,
+      TRACE_INFO[trace.type].name,
+    );
   }
 
   async onWinscopeEvent(event: WinscopeEvent) {
diff --git a/tools/winscope/src/viewers/common/add_diffs.ts b/tools/winscope/src/viewers/common/add_diffs.ts
index 33f82a275..d3e368dd3 100644
--- a/tools/winscope/src/viewers/common/add_diffs.ts
+++ b/tools/winscope/src/viewers/common/add_diffs.ts
@@ -169,7 +169,7 @@ export abstract class AddDiffs<T extends DiffNode> {
 }
 
 export type IsModifiedCallbackType = (
-  newTree: TreeNode | undefined,
-  oldTree: TreeNode | undefined,
+  newTree: TreeNode,
+  oldTree: TreeNode,
   denylistProperties: string[],
 ) => Promise<boolean>;
diff --git a/tools/winscope/src/viewers/common/collapsible_section_type.ts b/tools/winscope/src/viewers/common/collapsible_section_type.ts
index 74ec15857..29a2232b9 100644
--- a/tools/winscope/src/viewers/common/collapsible_section_type.ts
+++ b/tools/winscope/src/viewers/common/collapsible_section_type.ts
@@ -22,4 +22,7 @@ export enum CollapsibleSectionType {
   IME_ADDITIONAL_PROPERTIES = 'WM & SF PROPERTIES',
   INPUT_DISPATCH_PROPERTIES = 'INPUT DISPATCH PROPERTIES',
   LOG = 'LOG',
+  GLOBAL_SEARCH = 'GLOBAL SEARCH',
+  SEARCH_RESULTS = 'SEARCH RESULTS',
+  HOW_TO_SEARCH = 'HOW TO SEARCH',
 }
diff --git a/tools/winscope/src/viewers/common/hierarchy_presenter.ts b/tools/winscope/src/viewers/common/hierarchy_presenter.ts
index 4ff00dce6..3041a66c6 100644
--- a/tools/winscope/src/viewers/common/hierarchy_presenter.ts
+++ b/tools/winscope/src/viewers/common/hierarchy_presenter.ts
@@ -25,6 +25,7 @@ import {
 } from 'trace/tree_node/property_tree_node';
 import {TreeNode} from 'trace/tree_node/tree_node';
 import {IsModifiedCallbackType} from 'viewers/common/add_diffs';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {TreeNodeFilter, UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {UserOptions} from 'viewers/common/user_options';
@@ -35,7 +36,6 @@ import {Filter} from './operations/filter';
 import {FlattenChildren} from './operations/flatten_children';
 import {SimplifyNames} from './operations/simplify_names';
 import {PropertiesPresenter} from './properties_presenter';
-import {TextFilter} from './text_filter';
 import {UiTreeFormatter} from './ui_tree_formatter';
 
 export type GetHierarchyTreeNameType = (
@@ -85,8 +85,7 @@ export class HierarchyPresenter {
     >,
   ) {
     this.hierarchyFilter = UiTreeUtils.makeNodeFilter(
-      textFilter.filterString,
-      textFilter.flags,
+      textFilter.getFilterPredicate(),
     );
   }
 
@@ -109,11 +108,9 @@ export class HierarchyPresenter {
   getAllCurrentHierarchyTrees():
     | Array<[Trace<HierarchyTreeNode>, HierarchyTreeNode[]]>
     | undefined {
-    const currentTrees = [];
-    for (const entry of this.currentHierarchyTrees?.entries() ?? []) {
-      currentTrees.push(entry);
-    }
-    return currentTrees;
+    return this.currentHierarchyTrees
+      ? Array.from(this.currentHierarchyTrees.entries())
+      : undefined;
   }
 
   getCurrentHierarchyTreeNames(
@@ -227,8 +224,8 @@ export class HierarchyPresenter {
       const trace = entry.getFullTrace();
       currEntries.set(trace, entry);
 
-      const tree: HierarchyTreeNode | undefined = await entry?.getValue();
-      if (tree) currTrees.set(trace, [tree]);
+      const tree = await entry.getValue();
+      currTrees.set(trace, [tree]);
 
       const entryIndex = entry.getIndex();
       if (entryIndex > 0) {
@@ -322,22 +319,25 @@ export class HierarchyPresenter {
 
   async applyHierarchyUserOptionsChange(userOptions: UserOptions) {
     this.userOptions = userOptions;
-    this.currentFormattedTrees =
-      await this.formatHierarchyTreesAndUpdatePinnedItems(
-        this.currentHierarchyTrees,
-      );
+    if (this.currentHierarchyTrees) {
+      this.currentFormattedTrees =
+        await this.formatHierarchyTreesAndUpdatePinnedItems(
+          this.currentHierarchyTrees,
+        );
+    }
   }
 
   async applyHierarchyFilterChange(textFilter: TextFilter) {
     this.textFilter = textFilter;
     this.hierarchyFilter = UiTreeUtils.makeNodeFilter(
-      textFilter.filterString,
-      textFilter.flags,
+      textFilter.getFilterPredicate(),
     );
-    this.currentFormattedTrees =
-      await this.formatHierarchyTreesAndUpdatePinnedItems(
-        this.currentHierarchyTrees,
-      );
+    if (this.currentHierarchyTrees) {
+      this.currentFormattedTrees =
+        await this.formatHierarchyTreesAndUpdatePinnedItems(
+          this.currentHierarchyTrees,
+        );
+    }
   }
 
   getTextFilter(): TextFilter {
@@ -376,14 +376,9 @@ export class HierarchyPresenter {
   }
 
   private async formatHierarchyTreesAndUpdatePinnedItems(
-    hierarchyTrees:
-      | Map<Trace<HierarchyTreeNode>, HierarchyTreeNode[]>
-      | undefined,
+    hierarchyTrees: Map<Trace<HierarchyTreeNode>, HierarchyTreeNode[]>,
   ): Promise<Map<Trace<HierarchyTreeNode>, UiHierarchyTreeNode[]> | undefined> {
     this.pinnedItems = [];
-
-    if (!hierarchyTrees) return undefined;
-
     const formattedTrees = new Map<
       Trace<HierarchyTreeNode>,
       UiHierarchyTreeNode[]
@@ -508,12 +503,10 @@ export class HierarchyPresenter {
   }
 
   static isHierarchyTreeModified: IsModifiedCallbackType = async (
-    newTree: TreeNode | undefined,
-    oldTree: TreeNode | undefined,
+    newTree: TreeNode,
+    oldTree: TreeNode,
     denylistProperties: string[],
   ) => {
-    if (!newTree && !oldTree) return false;
-    if (!newTree || !oldTree) return true;
     if ((newTree as UiHierarchyTreeNode).isRoot()) return false;
     const newProperties = await (
       newTree as UiHierarchyTreeNode
diff --git a/tools/winscope/src/viewers/common/hierarchy_presenter_test.ts b/tools/winscope/src/viewers/common/hierarchy_presenter_test.ts
new file mode 100644
index 000000000..34a7e6803
--- /dev/null
+++ b/tools/winscope/src/viewers/common/hierarchy_presenter_test.ts
@@ -0,0 +1,474 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertySource} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
+import {DiffType} from './diff_type';
+import {HierarchyPresenter} from './hierarchy_presenter';
+import {SimplifyNames} from './operations/simplify_names';
+import {UserOptions} from './user_options';
+
+describe('HierarchyPresenter', () => {
+  const timestamp1 = TimestampConverterUtils.makeElapsedTimestamp(1n);
+  const timestamp2 = TimestampConverterUtils.makeElapsedTimestamp(2n);
+  const tree1 = new HierarchyTreeBuilder()
+    .setId('Test Trace')
+    .setName('entry')
+    .addChildProperty({name: 'setProp', value: true})
+    .addChildProperty({
+      name: 'defProp',
+      value: false,
+      source: PropertySource.DEFAULT,
+    })
+    .setChildren([
+      {
+        id: '1',
+        name: 'Parent1',
+        properties: {isComputedVisible: true, testProp: true},
+        children: [
+          {id: '3', name: 'Child3', properties: {isComputedVisible: true}},
+        ],
+      },
+      {
+        id: '2',
+        name: 'Parent2',
+        properties: {isComputedVisible: false, nested: {innerProp: 1}},
+      },
+    ])
+    .build();
+  const tree2 = new HierarchyTreeBuilder()
+    .setId('Test Trace')
+    .setName('entry')
+    .setChildren([
+      {
+        id: '1',
+        name: 'Parent1',
+        properties: {
+          isComputedVisible: true,
+          testProp: false,
+          newProp: true,
+        },
+      },
+      {
+        id: '2',
+        name: 'Parent2',
+        properties: {isComputedVisible: false, nested: {innerProp: 2}},
+      },
+    ])
+    .build();
+  const trace = new TraceBuilder<HierarchyTreeNode>()
+    .setType(TraceType.SURFACE_FLINGER)
+    .setEntries([tree1, tree2])
+    .setTimestamps([timestamp1, timestamp2])
+    .build();
+
+  const tree3 = new HierarchyTreeBuilder()
+    .setId('Test Trace 2')
+    .setName('entry')
+    .build();
+  const secondTrace = new TraceBuilder<HierarchyTreeNode>()
+    .setType(TraceType.SURFACE_FLINGER)
+    .setEntries([tree3])
+    .setTimestamps([timestamp1])
+    .build();
+  let presenter: HierarchyPresenter;
+
+  beforeAll(async () => {
+    jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+  });
+
+  beforeEach(() => {
+    presenter = new HierarchyPresenter({}, new TextFilter(), [], false, false);
+  });
+
+  it('exposes user options', async () => {
+    expect(presenter.getUserOptions()).toEqual({});
+    const testOptions = {test: {name: '', enabled: false}};
+    await presenter.applyHierarchyUserOptionsChange(testOptions);
+    expect(presenter.getUserOptions()).toEqual(testOptions);
+  });
+
+  it('updates current and previous entries for trace', async () => {
+    expect(presenter.getAllCurrentHierarchyTrees()?.length).toEqual(0);
+    expect(presenter.getAllFormattedTrees()).toBeUndefined();
+
+    await presenter.applyTracePositionUpdate(
+      [trace.getEntry(1), secondTrace.getEntry(0)],
+      '',
+    );
+    expect(presenter.getCurrentEntryForTrace(trace)).toEqual(trace.getEntry(1));
+    expect(presenter.getCurrentEntryForTrace(secondTrace)).toEqual(
+      secondTrace.getEntry(0),
+    );
+    expect(presenter.getCurrentHierarchyTreesForTrace(trace)?.length).toEqual(
+      1,
+    );
+    expect(presenter.getAllCurrentHierarchyTrees()?.length).toEqual(2);
+    expect(presenter.getAllFormattedTrees()?.length).toEqual(2);
+    expect(presenter.getFormattedTreesByTrace(trace)?.length).toEqual(1);
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeUndefined();
+    expect(
+      presenter.getPreviousHierarchyTreeForTrace(secondTrace),
+    ).toBeUndefined();
+
+    await presenter.applyHierarchyUserOptionsChange({
+      showDiff: {name: '', enabled: true, isUnavailable: false},
+    });
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeDefined();
+    expect(
+      presenter.getPreviousHierarchyTreeForTrace(secondTrace),
+    ).toBeUndefined();
+  });
+
+  it('explicitly sets selected tree', async () => {
+    expect(presenter.getSelectedTree()).toBeUndefined();
+    presenter.setSelectedTree([trace, tree1]);
+    expect(presenter.getSelectedTree()).toEqual([trace, tree1]);
+    presenter.setSelectedTree(undefined);
+    expect(presenter.getSelectedTree()).toBeUndefined();
+  });
+
+  it('adds current hierarchy trees', async () => {
+    await presenter.addCurrentHierarchyTrees([trace, [tree1]], undefined);
+    expect(presenter.getCurrentEntryForTrace(trace)).toBeUndefined();
+    expect(presenter.getCurrentHierarchyTreesForTrace(trace)?.length).toEqual(
+      1,
+    );
+    expect(presenter.getAllCurrentHierarchyTrees()?.length).toEqual(1);
+    expect(presenter.getAllFormattedTrees()?.length).toEqual(1);
+    expect(presenter.getFormattedTreesByTrace(trace)?.length).toEqual(1);
+
+    await presenter.addCurrentHierarchyTrees([secondTrace, [tree3]], tree3.id);
+    expect(presenter.getSelectedTree()).toEqual([secondTrace, tree3]);
+
+    await presenter.addCurrentHierarchyTrees([trace, [tree2]], undefined);
+    expect(presenter.getCurrentHierarchyTreesForTrace(trace)?.length).toEqual(
+      2,
+    );
+    expect(presenter.getAllCurrentHierarchyTrees()).toEqual([
+      [trace, [tree1, tree2]],
+      [secondTrace, [tree3]],
+    ]);
+    expect(presenter.getAllFormattedTrees()?.length).toEqual(3);
+    expect(presenter.getFormattedTreesByTrace(trace)?.length).toEqual(2);
+  });
+
+  it('updates previous hierarchy trees', async () => {
+    await applyTracePositionUpdate(0);
+    await presenter.updatePreviousHierarchyTrees();
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeUndefined();
+
+    await applyTracePositionUpdate(1);
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeUndefined();
+    await presenter.updatePreviousHierarchyTrees();
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeDefined();
+  });
+
+  it('robust to empty trace position update', async () => {
+    await applyTracePositionUpdate();
+    expect(presenter.getCurrentEntryForTrace(trace)).toEqual(trace.getEntry(0));
+    expect(presenter.getCurrentHierarchyTreesForTrace(trace)).toEqual([tree1]);
+
+    await presenter.applyTracePositionUpdate([], '');
+    expect(presenter.getCurrentEntryForTrace(trace)).toBeUndefined();
+    expect(presenter.getCurrentHierarchyTreesForTrace(trace)).toBeUndefined();
+  });
+
+  it('adds diffs to hierarchy tree based on user option', async () => {
+    await applyTracePositionUpdate(1);
+    expect(
+      getFormattedTree().findDfs((node) => node.name === 'Child3'),
+    ).toBeUndefined();
+    await presenter.applyHierarchyUserOptionsChange({
+      showDiff: {name: '', enabled: true, isUnavailable: false},
+    });
+    expect(
+      getFormattedTree()
+        .findDfs((node) => node.name === 'Child3')
+        ?.getDiff(),
+    ).toEqual(DiffType.DELETED);
+  });
+
+  it('adds diffs based on modified properties', async () => {
+    presenter = new HierarchyPresenter(
+      {showDiff: {name: '', enabled: true, isUnavailable: false}},
+      new TextFilter(),
+      [],
+      false,
+      false,
+    );
+    await applyTracePositionUpdate(1);
+    const tree = getFormattedTree();
+    expect(tree.findDfs((node) => node.name === 'Parent1')?.getDiff()).toEqual(
+      DiffType.MODIFIED,
+    );
+    expect(tree.findDfs((node) => node.name === 'Parent2')?.getDiff()).toEqual(
+      DiffType.MODIFIED,
+    );
+  });
+
+  it('applies deny list in add diffs operation', async () => {
+    presenter = new HierarchyPresenter(
+      {showDiff: {name: '', enabled: true, isUnavailable: false}},
+      new TextFilter(),
+      ['newProp', 'testProp'],
+      false,
+      false,
+    );
+    await applyTracePositionUpdate(1);
+    expect(
+      getFormattedTree()
+        .findDfs((node) => node.name === 'Parent1')
+        ?.getDiff(),
+    ).toEqual(DiffType.NONE);
+  });
+
+  it('disables show diff and generates non-diff tree if no prev entry available', async () => {
+    const opts = {showDiff: {name: '', enabled: false, isUnavailable: false}};
+    presenter.applyHierarchyUserOptionsChange(opts);
+    await applyTracePositionUpdate();
+    expect(opts['showDiff'].isUnavailable).toBeTrue();
+    const trees = assertDefined(presenter.getAllFormattedTrees());
+    expect(trees.length).toBeGreaterThan(0);
+    trees.forEach((tree) => {
+      expect(tree.getAllChildren().length > 0).toBeTrue();
+      tree.forEachNodeDfs((node) =>
+        expect(node.getDiff()).toEqual(DiffType.NONE),
+      );
+    });
+  });
+
+  it('makes node display name by strategy', async () => {
+    const testName = 'Test Name';
+    presenter = new HierarchyPresenter(
+      {},
+      new TextFilter(),
+      [],
+      false,
+      false,
+      () => testName,
+    );
+    expect(presenter.getCurrentHierarchyTreeNames(trace)).toBeUndefined();
+    await applyTracePositionUpdate();
+    const node = assertDefined(presenter.getAllFormattedTrees()?.at(0));
+    expect(node.name).toEqual('entry');
+    expect(node.getDisplayName()).toEqual(testName);
+    expect(presenter.getCurrentHierarchyTreeNames(trace)).toEqual([testName]);
+  });
+
+  it('disables headings based on showHeading', async () => {
+    await applyTracePositionUpdate();
+    let node = assertDefined(presenter.getAllFormattedTrees()?.at(0));
+    expect(node.name).toEqual('entry');
+    expect(node.heading()).toBeUndefined();
+
+    presenter = new HierarchyPresenter({}, new TextFilter(), [], true, false);
+    await applyTracePositionUpdate();
+    node = assertDefined(presenter.getAllFormattedTrees()?.at(0));
+    expect(node.name).toEqual('entry');
+    expect(node.heading()).toEqual('Test');
+  });
+
+  it('selects first node based on forceSelectFirstNode', async () => {
+    await applyTracePositionUpdate();
+    expect(presenter.getSelectedTree()).toBeUndefined();
+
+    presenter = new HierarchyPresenter({}, new TextFilter(), [], false, true);
+    await applyTracePositionUpdate();
+    expect(presenter.getSelectedTree()).toBeDefined();
+  });
+
+  it('applies custom operations', async () => {
+    const operation = jasmine.createSpyObj('operation', ['apply']);
+    presenter = new HierarchyPresenter(
+      {},
+      new TextFilter(),
+      [],
+      false,
+      false,
+      undefined,
+      [[TraceType.SURFACE_FLINGER, [operation]]],
+    );
+    await applyTracePositionUpdate();
+    expect(operation.apply).toHaveBeenCalledTimes(1);
+  });
+
+  it('propagates item selection to new entry', async () => {
+    await applyTracePositionUpdate(0, '1 Parent1');
+    expect(presenter.getSelectedTree()).toEqual([
+      trace,
+      assertDefined(tree1.getChildByName('Parent1')),
+    ]);
+  });
+
+  it('handles pinned item change', () => {
+    expect(presenter.getPinnedItems()).toEqual([]);
+    const item = TreeNodeUtils.makeUiHierarchyNode({id: '', name: ''});
+    presenter.applyPinnedItemChange(item);
+    expect(presenter.getPinnedItems()).toEqual([item]);
+    presenter.applyPinnedItemChange(item);
+    expect(presenter.getPinnedItems()).toEqual([]);
+  });
+
+  it('flattens hierarchy tree based on user option', async () => {
+    await applyTracePositionUpdate();
+    expect(getTotalHierarchyChildren()).toEqual(2);
+    await presenter.applyHierarchyUserOptionsChange({
+      flat: {name: '', enabled: true},
+    });
+    expect(getTotalHierarchyChildren()).toEqual(3);
+  });
+
+  it('filters hierarchy tree by visibility based on user option', async () => {
+    const userOptions: UserOptions = {
+      showOnlyVisible: {name: '', enabled: false},
+      flat: {name: '', enabled: true},
+    };
+    await presenter.applyHierarchyUserOptionsChange(userOptions);
+    await applyTracePositionUpdate();
+    expect(getTotalHierarchyChildren()).toEqual(3);
+
+    const nonVisibleNode = assertDefined(
+      getFormattedTree()?.findDfs(
+        (node) =>
+          !node.isRoot() &&
+          !node.getEagerPropertyByName('isComputedVisible')?.getValue(),
+      ),
+    );
+    presenter.applyPinnedItemChange(nonVisibleNode);
+
+    userOptions['showOnlyVisible'].enabled = true;
+    await presenter.applyHierarchyUserOptionsChange(userOptions);
+    expect(getTotalHierarchyChildren()).toEqual(2);
+    expect(presenter.getPinnedItems()).toEqual([nonVisibleNode]); // keeps pinned node
+  });
+
+  it('filters hierarchy tree by search string', async () => {
+    const userOptions: UserOptions = {flat: {name: '', enabled: true}};
+    await presenter.applyHierarchyUserOptionsChange(userOptions);
+    await applyTracePositionUpdate();
+    expect(getTotalHierarchyChildren()).toEqual(3);
+
+    const filterString = 'Parent';
+    const nonMatchNode = assertDefined(
+      getFormattedTree()?.findDfs(
+        (node) => !node.isRoot() && !node.id.includes(filterString),
+      ),
+    );
+    presenter.applyPinnedItemChange(nonMatchNode);
+
+    const filter = new TextFilter(filterString);
+    await presenter.applyHierarchyFilterChange(filter);
+    expect(presenter.getTextFilter()).toEqual(filter);
+    expect(getTotalHierarchyChildren()).toEqual(2);
+    expect(presenter.getPinnedItems()).toEqual([nonMatchNode]); // keeps pinned node
+  });
+
+  it('simplifies names in hierarchy tree based on user option', async () => {
+    const spy = spyOn(SimplifyNames.prototype, 'apply').and.callThrough();
+    await applyTracePositionUpdate();
+    expect(spy).not.toHaveBeenCalled();
+
+    await presenter.applyHierarchyUserOptionsChange({
+      simplifyNames: {name: '', enabled: true},
+    });
+    expect(spy).toHaveBeenCalledTimes(1);
+  });
+
+  it('applies highlighted id change', async () => {
+    await applyTracePositionUpdate();
+    presenter.applyHighlightedIdChange('fake node');
+    expect(presenter.getSelectedTree()).toBeUndefined();
+    presenter.applyHighlightedIdChange('1 Parent1');
+    expect(presenter.getSelectedTree()).toBeDefined();
+  });
+
+  it('applies highlighted node change', async () => {
+    await applyTracePositionUpdate();
+    const node = getFormattedTree();
+    node.setIsOldNode(true);
+    presenter.applyHighlightedNodeChange(node);
+    expect(presenter.getSelectedTree()).toBeUndefined();
+
+    node.setDiff(DiffType.DELETED);
+    presenter.applyHighlightedNodeChange(node);
+    expect(presenter.getSelectedTree()).toEqual([trace, node]);
+
+    const newNode = assertDefined(node.getChildByName('Parent1'));
+    presenter.applyHighlightedNodeChange(newNode);
+    expect(presenter.getSelectedTree()).toEqual([trace, newNode]);
+  });
+
+  it('can be cleared and re-populated', async () => {
+    const testName = 'Test Name';
+    presenter = new HierarchyPresenter(
+      {showDiff: {name: 'Show diff', enabled: true}},
+      new TextFilter(),
+      [],
+      false,
+      false,
+      () => testName,
+    );
+    await applyTracePositionUpdate(1, '1 Parent1');
+    expect(presenter.getAllCurrentHierarchyTrees()).toBeDefined();
+    expect(presenter.getAllFormattedTrees()).toBeDefined();
+    expect(presenter.getSelectedTree()).toBeDefined();
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeDefined();
+    expect(presenter.getCurrentEntryForTrace(trace)).toBeDefined();
+    expect(presenter.getCurrentHierarchyTreeNames(trace)).toBeDefined();
+
+    presenter.clear();
+    expect(presenter.getAllCurrentHierarchyTrees()).toBeUndefined();
+    expect(presenter.getAllFormattedTrees()).toBeUndefined();
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeUndefined();
+    expect(presenter.getCurrentEntryForTrace(trace)).toBeUndefined();
+    expect(presenter.getSelectedTree()).toBeUndefined();
+    expect(presenter.getCurrentHierarchyTreeNames(trace)).toBeUndefined();
+
+    await presenter.addCurrentHierarchyTrees([trace, [tree1]], '1 Parent1');
+    expect(presenter.getAllCurrentHierarchyTrees()).toBeDefined();
+    expect(presenter.getAllFormattedTrees()).toBeDefined();
+    expect(presenter.getSelectedTree()).toBeDefined();
+    expect(presenter.getPreviousHierarchyTreeForTrace(trace)).toBeUndefined();
+    expect(presenter.getCurrentEntryForTrace(trace)).toBeUndefined();
+    expect(presenter.getCurrentHierarchyTreeNames(trace)).toBeUndefined();
+  });
+
+  async function applyTracePositionUpdate(index = 0, highlightedItem = '') {
+    await presenter.applyTracePositionUpdate(
+      [trace.getEntry(index)],
+      highlightedItem,
+    );
+  }
+
+  function getFormattedTree() {
+    return assertDefined(presenter.getFormattedTreesByTrace(trace))[0];
+  }
+
+  function getTotalHierarchyChildren() {
+    return assertDefined(presenter.getAllFormattedTrees()).reduce(
+      (tot, tree) => (tot += tree.getAllChildren().length),
+      0,
+    );
+  }
+});
diff --git a/tools/winscope/src/viewers/common/hierarchy_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/hierarchy_viewer_presenter_test.ts
new file mode 100644
index 000000000..3dbe527a2
--- /dev/null
+++ b/tools/winscope/src/viewers/common/hierarchy_viewer_presenter_test.ts
@@ -0,0 +1,570 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {
+  DarkModeToggled,
+  FilterPresetApplyRequest,
+  FilterPresetSaveRequest,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {MockPresenter} from 'test/unit/mock_hierarchy_viewer_presenter';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
+import {UiRectBuilder} from 'viewers/components/rects/ui_rect_builder';
+import {DiffType} from './diff_type';
+import {RectShowState} from './rect_show_state';
+import {UiDataHierarchy} from './ui_data_hierarchy';
+import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
+import {UserOptions} from './user_options';
+import {ViewerEvents} from './viewer_events';
+
+describe('AbstractHierarchyViewerPresenter', () => {
+  const timestamp1 = TimestampConverterUtils.makeElapsedTimestamp(1n);
+  const timestamp2 = TimestampConverterUtils.makeElapsedTimestamp(2n);
+  let uiData: UiDataHierarchy;
+  let presenter: MockPresenter;
+  let trace: Trace<HierarchyTreeNode>;
+  let traces: Traces;
+  let positionUpdate: TracePositionUpdate;
+  let secondPositionUpdate: TracePositionUpdate;
+  let selectedTree: UiHierarchyTreeNode;
+  let storage: InMemoryStorage;
+
+  beforeAll(async () => {
+    jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+    trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.SURFACE_FLINGER)
+      .setEntries([
+        new HierarchyTreeBuilder()
+          .setId('Test Trace')
+          .setName('entry')
+          .setChildren([
+            {
+              id: '1',
+              name: 'p1',
+              properties: {isComputedVisible: true, testProp: true},
+              children: [
+                {id: '3', name: 'c3', properties: {isComputedVisible: true}},
+              ],
+            },
+            {id: '2', name: 'p2', properties: {isComputedVisible: false}},
+          ])
+          .build(),
+        new HierarchyTreeBuilder()
+          .setId('Test Trace')
+          .setName('entry')
+          .setChildren([
+            {
+              id: '1',
+              name: 'p1',
+              properties: {isComputedVisible: true, testProp: false},
+            },
+            {id: '2', name: 'p2'},
+          ])
+          .build(),
+      ])
+      .setTimestamps([timestamp1, timestamp2])
+      .build();
+    selectedTree = UiHierarchyTreeNode.from(
+      assertDefined((await trace.getEntry(0).getValue()).getChildByName('p1')),
+    );
+    positionUpdate = TracePositionUpdate.fromTraceEntry(trace.getEntry(0));
+    secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      trace.getEntry(1),
+    );
+    traces = new Traces();
+    traces.addTrace(trace);
+  });
+
+  beforeEach(() => {
+    storage = new InMemoryStorage();
+    presenter = new MockPresenter(
+      trace,
+      traces,
+      storage,
+      (newData) => {
+        uiData = newData;
+      },
+      undefined,
+    );
+  });
+
+  it('clears ui data before throwing error on corrupted trace', async () => {
+    const notifyViewCallback = (newData: UiDataHierarchy) => {
+      uiData = newData;
+    };
+    const trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.SURFACE_FLINGER)
+      .setEntries([selectedTree])
+      .setTimestamps([timestamp1])
+      .setIsCorrupted(true)
+      .build();
+    const traces = new Traces();
+    traces.addTrace(trace);
+    const presenter = new MockPresenter(
+      trace,
+      traces,
+      new InMemoryStorage(),
+      notifyViewCallback,
+      undefined,
+    );
+    initializeRectsPresenter(presenter);
+
+    try {
+      await presenter.onAppEvent(
+        TracePositionUpdate.fromTraceEntry(trace.getEntry(0)),
+      );
+      fail('error should be thrown for corrupted trace');
+    } catch (e) {
+      expect(Object.keys(uiData.hierarchyUserOptions).length).toBeGreaterThan(
+        0,
+      );
+      expect(Object.keys(uiData.propertiesUserOptions).length).toBeGreaterThan(
+        0,
+      );
+      expect(uiData.hierarchyTrees).toBeUndefined();
+      expect(uiData.propertiesTree).toBeUndefined();
+      expect(uiData.highlightedItem).toEqual('');
+      expect(uiData.highlightedProperty).toEqual('');
+      expect(uiData.pinnedItems.length).toEqual(0);
+      expect(
+        Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
+      ).toBeGreaterThan(0);
+      expect(uiData.rectsToDraw).toEqual([]);
+    }
+  });
+
+  it('processes trace position updates', async () => {
+    initializeRectsPresenter();
+    pinNode(selectedTree);
+    await presenter.onAppEvent(positionUpdate);
+
+    expect(uiData.highlightedItem?.length).toEqual(0);
+    expect(Object.keys(uiData.hierarchyUserOptions).length).toBeGreaterThan(0);
+    expect(Object.keys(uiData.propertiesUserOptions).length).toBeGreaterThan(0);
+    assertDefined(uiData.hierarchyTrees).forEach((tree) => {
+      expect(tree.getAllChildren().length > 0).toBeTrue();
+    });
+    expect(uiData.pinnedItems.length).toBeGreaterThan(0);
+    expect(
+      Object.keys(assertDefined(uiData.rectsUserOptions)).length,
+    ).toBeGreaterThan(0);
+    expect(uiData.rectsToDraw?.length).toBeGreaterThan(0);
+    expect(uiData.displays?.length).toBeGreaterThan(0);
+  });
+
+  it('adds events listeners', () => {
+    const element = document.createElement('div');
+    presenter.addEventListeners(element);
+
+    let spy: jasmine.Spy = spyOn(presenter, 'onPinnedItemChange');
+    const node = TreeNodeUtils.makeUiHierarchyNode({name: 'test'});
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HierarchyPinnedChange, {
+        detail: {pinnedItem: node},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(node);
+
+    spy = spyOn(presenter, 'onHighlightedIdChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HighlightedIdChange, {
+        detail: {id: 'test'},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith('test');
+
+    spy = spyOn(presenter, 'onHighlightedPropertyChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HighlightedPropertyChange, {
+        detail: {id: 'test'},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith('test');
+
+    spy = spyOn(presenter, 'onHierarchyUserOptionsChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HierarchyUserOptionsChange, {
+        detail: {userOptions: {}},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith({});
+
+    spy = spyOn(presenter, 'onHierarchyFilterChange');
+    const filter = new TextFilter();
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HierarchyFilterChange, {detail: filter}),
+    );
+    expect(spy).toHaveBeenCalledWith(filter);
+
+    spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
+        detail: {userOptions: {}},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith({});
+
+    spy = spyOn(presenter, 'onPropertiesFilterChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.PropertiesFilterChange, {
+        detail: filter,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(filter);
+
+    spy = spyOn(presenter, 'onHighlightedNodeChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.HighlightedNodeChange, {detail: {node}}),
+    );
+    expect(spy).toHaveBeenCalledWith(node);
+
+    spy = spyOn(presenter, 'onRectShowStateChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.RectShowStateChange, {
+        detail: {rectId: 'test', state: RectShowState.HIDE},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith('test', RectShowState.HIDE);
+
+    spy = spyOn(presenter, 'onRectsUserOptionsChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.RectsUserOptionsChange, {
+        detail: {userOptions: {}},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith({});
+  });
+
+  it('is robust to empty trace', async () => {
+    const callback = (newData: UiDataHierarchy) => {
+      uiData = newData;
+    };
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.WINDOW_MANAGER);
+    const traces = new Traces();
+    traces.addTrace(trace);
+    const presenter = new MockPresenter(
+      trace,
+      traces,
+      new InMemoryStorage(),
+      callback,
+      undefined,
+    );
+    presenter.initializeRectsPresenter();
+
+    const positionUpdateWithoutTraceEntry = TracePositionUpdate.fromTimestamp(
+      TimestampConverterUtils.makeRealTimestamp(0n),
+    );
+    await presenter.onAppEvent(positionUpdateWithoutTraceEntry);
+
+    expect(Object.keys(uiData.hierarchyUserOptions).length).toBeGreaterThan(0);
+    expect(Object.keys(uiData.propertiesUserOptions).length).toBeGreaterThan(0);
+    expect(uiData.hierarchyTrees).toBeUndefined();
+    expect(
+      Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
+    ).toBeGreaterThan(0);
+  });
+
+  it('handles filter preset requests', async () => {
+    initializeRectsPresenter();
+    await presenter.onAppEvent(positionUpdate);
+    const saveEvent = new FilterPresetSaveRequest(
+      'TestPreset',
+      TraceType.TEST_TRACE_STRING,
+    );
+    expect(storage.get(saveEvent.name)).toBeUndefined();
+    await presenter.onAppEvent(saveEvent);
+    expect(storage.get(saveEvent.name)).toBeDefined();
+
+    await presenter.onHierarchyFilterChange(new TextFilter('Test Filter'));
+    await presenter.onHierarchyUserOptionsChange({});
+    await presenter.onPropertiesUserOptionsChange({});
+    await presenter.onPropertiesFilterChange(new TextFilter('Test Filter'));
+    presenter.onRectsUserOptionsChange({});
+    await presenter.onRectShowStateChange(
+      assertDefined(uiData.rectsToDraw)[0].id,
+      RectShowState.HIDE,
+    );
+    const currentUiData = uiData;
+
+    const applyEvent = new FilterPresetApplyRequest(
+      saveEvent.name,
+      TraceType.TEST_TRACE_STRING,
+    );
+    await presenter.onAppEvent(applyEvent);
+    expect(uiData).not.toEqual(currentUiData);
+  });
+
+  it('updates dark mode', async () => {
+    expect(uiData.isDarkMode).toBeFalse();
+    await presenter.onAppEvent(new DarkModeToggled(true));
+    expect(uiData.isDarkMode).toBeTrue();
+  });
+
+  it('disables show diff if no prev entry available', async () => {
+    const userOptions: UserOptions = {
+      showDiff: {name: '', enabled: false, isUnavailable: false},
+    };
+    await presenter.onHierarchyUserOptionsChange(userOptions);
+    await presenter.onPropertiesUserOptionsChange(userOptions);
+    await presenter.onAppEvent(positionUpdate);
+    expect(uiData.hierarchyUserOptions['showDiff'].isUnavailable).toBeTrue();
+    expect(uiData.propertiesUserOptions['showDiff'].isUnavailable).toBeTrue();
+  });
+
+  it('shows correct hierarchy tree name for entry', async () => {
+    const spy = spyOn(
+      assertDefined(positionUpdate.position.entry?.getFullTrace()),
+      'isDumpWithoutTimestamp',
+    );
+    spy.and.returnValue(false);
+    await presenter.onAppEvent(positionUpdate);
+    const entryNode = assertDefined(uiData.hierarchyTrees?.at(0));
+    expect(entryNode.getDisplayName()).toContain(
+      positionUpdate.position.timestamp.format(),
+    );
+
+    pinNode(entryNode);
+    spy.and.returnValue(true);
+    await presenter.onAppEvent(positionUpdate);
+    const newEntryNode = assertDefined(uiData.hierarchyTrees?.at(0));
+    expect(newEntryNode.getDisplayName()).toContain('Dump');
+    expect(uiData.pinnedItems).toEqual([newEntryNode]);
+  });
+
+  it('handles pinned item change', () => {
+    expect(uiData.pinnedItems).toEqual([]);
+    const item = TreeNodeUtils.makeUiHierarchyNode({id: '', name: ''});
+    presenter.onPinnedItemChange(item);
+    expect(uiData.pinnedItems).toEqual([item]);
+    presenter.onPinnedItemChange(item);
+    expect(uiData.pinnedItems).toEqual([]);
+  });
+
+  it('updates and applies hierarchy user options', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    const userOptions: UserOptions = {flat: {name: '', enabled: true}};
+    await presenter.onHierarchyUserOptionsChange(userOptions);
+    expect(uiData.hierarchyUserOptions).toEqual(userOptions);
+    expect(uiData.hierarchyTrees?.at(0)?.getAllChildren().length).toEqual(3);
+  });
+
+  it('updates highlighted property', () => {
+    const id = '4';
+    presenter.onHighlightedPropertyChange(id);
+    expect(uiData.highlightedProperty).toEqual(id);
+    presenter.onHighlightedPropertyChange(id);
+    expect(uiData.highlightedProperty).toEqual('');
+  });
+
+  it('sets properties tree and associated ui data from tree node', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    await presenter.onHighlightedNodeChange(selectedTree);
+    const propertiesTree = assertDefined(uiData.propertiesTree);
+    expect(propertiesTree.id).toContain(selectedTree.id);
+    expect(propertiesTree.getAllChildren().length).toEqual(2);
+  });
+
+  it('updates and applies properties user options, calculating diffs from prev hierarchy tree', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    await presenter.onHighlightedIdChange(selectedTree.id);
+    await presenter.onAppEvent(secondPositionUpdate);
+    expect(
+      uiData.propertiesTree?.getChildByName('testProp')?.getDiff(),
+    ).toEqual(DiffType.NONE);
+
+    const userOptions: UserOptions = {showDiff: {name: '', enabled: true}};
+    await presenter.onPropertiesUserOptionsChange(userOptions);
+    expect(uiData.propertiesUserOptions).toEqual(userOptions);
+    expect(
+      uiData.propertiesTree?.getChildByName('testProp')?.getDiff(),
+    ).toEqual(DiffType.MODIFIED);
+  });
+
+  it('is robust to attempts to change rect user data if no rects presenter', async () => {
+    expect(() => presenter.onRectsUserOptionsChange({})).not.toThrowError();
+    await expectAsync(
+      presenter.onRectShowStateChange('', RectShowState.SHOW),
+    ).not.toBeRejected();
+  });
+
+  it('creates input data for rects view', async () => {
+    initializeRectsPresenter();
+    await presenter.onAppEvent(positionUpdate);
+    const rectsToDraw = assertDefined(uiData.rectsToDraw);
+    const expectedFirstRect = presenter.uiRects[0];
+    expect(rectsToDraw[0].x).toEqual(expectedFirstRect.x);
+    expect(rectsToDraw[0].y).toEqual(expectedFirstRect.y);
+    expect(rectsToDraw[0].w).toEqual(expectedFirstRect.w);
+    expect(rectsToDraw[0].h).toEqual(expectedFirstRect.h);
+    checkRectUiData(uiData, 3, 3, 3);
+  });
+
+  it('filters rects by visibility', async () => {
+    initializeRectsPresenter();
+    const userOptions: UserOptions = {
+      showOnlyVisible: {name: '', enabled: false},
+    };
+    await presenter.onAppEvent(positionUpdate);
+    presenter.onRectsUserOptionsChange(userOptions);
+    expect(uiData.rectsUserOptions).toEqual(userOptions);
+    checkRectUiData(uiData, 3, 3, 3);
+
+    userOptions['showOnlyVisible'].enabled = true;
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 2, 3, 2);
+  });
+
+  it('filters rects by show/hide state', async () => {
+    initializeRectsPresenter();
+    const userOptions: UserOptions = {
+      ignoreRectShowState: {
+        name: 'Ignore',
+        icon: 'visibility',
+        enabled: true,
+      },
+    };
+    await presenter.onAppEvent(positionUpdate);
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 3, 3, 3);
+
+    await presenter.onRectShowStateChange(
+      assertDefined(uiData.rectsToDraw)[0].id,
+      RectShowState.HIDE,
+    );
+    checkRectUiData(uiData, 3, 3, 2);
+
+    userOptions['ignoreRectShowState'].enabled = false;
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 2, 3, 2);
+  });
+
+  it('handles both visibility and show/hide state in rects', async () => {
+    initializeRectsPresenter();
+    const userOptions: UserOptions = {
+      ignoreRectShowState: {name: '', enabled: true},
+      showOnlyVisible: {name: '', enabled: false},
+    };
+    presenter.onRectsUserOptionsChange(userOptions);
+    await presenter.onAppEvent(positionUpdate);
+    checkRectUiData(uiData, 3, 3, 3);
+
+    await presenter.onRectShowStateChange(
+      assertDefined(uiData.rectsToDraw)[0].id,
+      RectShowState.HIDE,
+    );
+    checkRectUiData(uiData, 3, 3, 2);
+
+    userOptions['ignoreRectShowState'].enabled = false;
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 2, 3, 2);
+
+    userOptions['showOnlyVisible'].enabled = true;
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 1, 3, 1);
+
+    userOptions['ignoreRectShowState'].enabled = true;
+    presenter.onRectsUserOptionsChange(userOptions);
+    checkRectUiData(uiData, 2, 3, 1);
+  });
+
+  function pinNode(node: UiHierarchyTreeNode) {
+    presenter.onPinnedItemChange(node);
+    expect(uiData.pinnedItems).toEqual([node]);
+  }
+
+  function initializeRectsPresenter(p = presenter) {
+    p.initializeRectsPresenter();
+    p.uiRects = [
+      new UiRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(1)
+        .setHeight(1)
+        .setLabel('test rect')
+        .setTransform(IDENTITY_MATRIX)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsActiveDisplay(true)
+        .setId('1 p1')
+        .setGroupId(0)
+        .setIsClickable(true)
+        .setCornerRadius(0)
+        .setDepth(0)
+        .build(),
+      new UiRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(1)
+        .setHeight(1)
+        .setLabel('test rect 2')
+        .setTransform(IDENTITY_MATRIX)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsActiveDisplay(true)
+        .setId('3 c3')
+        .setGroupId(0)
+        .setIsClickable(true)
+        .setCornerRadius(0)
+        .setDepth(1)
+        .build(),
+      new UiRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(1)
+        .setHeight(1)
+        .setLabel('test rect 3')
+        .setTransform(IDENTITY_MATRIX)
+        .setIsVisible(false)
+        .setIsDisplay(false)
+        .setIsActiveDisplay(true)
+        .setId('2 p2')
+        .setGroupId(0)
+        .setIsClickable(true)
+        .setCornerRadius(0)
+        .setDepth(2)
+        .build(),
+    ];
+    p.displays = [{displayId: 0, groupId: 0, name: 'Display', isActive: true}];
+  }
+
+  function checkRectUiData(
+    uiData: UiDataHierarchy,
+    rectsToDraw: number,
+    allRects: number,
+    shownRects: number,
+  ) {
+    expect(assertDefined(uiData.rectsToDraw).length).toEqual(rectsToDraw);
+    const showStates = Array.from(
+      assertDefined(uiData.rectIdToShowState).values(),
+    );
+    expect(showStates.length).toEqual(allRects);
+    expect(showStates.filter((s) => s === RectShowState.SHOW).length).toEqual(
+      shownRects,
+    );
+  }
+});
diff --git a/tools/winscope/src/viewers/common/ime_ui_data.ts b/tools/winscope/src/viewers/common/ime_ui_data.ts
index c79428698..3ec2cc1ed 100644
--- a/tools/winscope/src/viewers/common/ime_ui_data.ts
+++ b/tools/winscope/src/viewers/common/ime_ui_data.ts
@@ -17,8 +17,8 @@
 import {ImeTraceType} from 'trace/trace_type';
 import {ImeAdditionalProperties} from 'viewers/common/ime_additional_properties';
 import {TableProperties} from 'viewers/common/table_properties';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UserOptions} from 'viewers/common/user_options';
-import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
@@ -31,8 +31,8 @@ export class ImeUiData implements UiDataHierarchy {
   propertiesUserOptions: UserOptions = {};
   propertiesTree: UiPropertyTreeNode | undefined;
   highlightedProperty = '';
-  hierarchyFilter = new TextFilter('', []);
-  propertiesFilter = new TextFilter('', []);
+  hierarchyFilter = new TextFilter();
+  propertiesFilter = new TextFilter();
 
   constructor(
     readonly traceType: ImeTraceType,
diff --git a/tools/winscope/src/viewers/common/ime_utils.ts b/tools/winscope/src/viewers/common/ime_utils.ts
index 84974e6e7..6ce262723 100644
--- a/tools/winscope/src/viewers/common/ime_utils.ts
+++ b/tools/winscope/src/viewers/common/ime_utils.ts
@@ -20,6 +20,7 @@ import {Item} from 'trace/item';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {WindowType} from 'trace/window_type';
+import {TextFilter} from 'viewers/common/text_filter';
 import {WmImeUtils} from 'viewers/common/wm_ime_utils';
 import {TreeNodeFilter, UiTreeUtils} from './ui_tree_utils';
 
@@ -79,6 +80,13 @@ export class ImeLayers implements Item {
 }
 
 class ImeAdditionalPropertiesUtils {
+  private isInputMethodSurface = UiTreeUtils.makeNodeFilter(
+    new TextFilter('InputMethod').getFilterPredicate(),
+  );
+  private isImeContainer = UiTreeUtils.makeNodeFilter(
+    new TextFilter('ImeContainer').getFilterPredicate(),
+  );
+
   processWindowManagerTraceEntry(
     entry: HierarchyTreeNode,
     wmEntryTimestamp: Timestamp | undefined,
@@ -107,8 +115,7 @@ class ImeAdditionalPropertiesUtils {
     processedWindowManagerState: ProcessedWindowManagerState,
     sfEntryTimestamp: Timestamp | undefined,
   ): ImeLayers | undefined {
-    const isImeContainer = UiTreeUtils.makeNodeFilter('ImeContainer');
-    const imeContainerLayer = entryTree.findDfs(isImeContainer);
+    const imeContainerLayer = entryTree.findDfs(this.isImeContainer);
 
     if (!imeContainerLayer) {
       return undefined;
@@ -124,9 +131,9 @@ class ImeAdditionalPropertiesUtils {
       ).getValue(),
     };
 
-    const isInputMethodSurface = UiTreeUtils.makeNodeFilter('InputMethod');
-    const inputMethodSurfaceLayer =
-      imeContainerLayer.findDfs(isInputMethodSurface);
+    const inputMethodSurfaceLayer = imeContainerLayer.findDfs(
+      this.isInputMethodSurface,
+    );
 
     if (!inputMethodSurfaceLayer) {
       return undefined;
@@ -148,7 +155,9 @@ class ImeAdditionalPropertiesUtils {
         ?.split(' ')[0]
         .slice(1);
     if (focusedWindowToken) {
-      const isFocusedWindow = UiTreeUtils.makeNodeFilter(focusedWindowToken);
+      const isFocusedWindow = UiTreeUtils.makeNodeFilter(
+        new TextFilter(focusedWindowToken).getFilterPredicate(),
+      );
       focusedWindowLayer = entryTree.findDfs(isFocusedWindow);
     }
 
@@ -160,12 +169,14 @@ class ImeAdditionalPropertiesUtils {
     // cases where both exist
     const taskLayerOfImeContainer = this.findAncestorTaskLayerOfImeLayer(
       entryTree,
-      UiTreeUtils.makeNodeFilter('ImeContainer'),
+      this.isImeContainer,
     );
 
     const taskLayerOfImeSnapshot = this.findAncestorTaskLayerOfImeLayer(
       entryTree,
-      UiTreeUtils.makeNodeFilter('IME-snapshot'),
+      UiTreeUtils.makeNodeFilter(
+        new TextFilter('IME-snapshot').getFilterPredicate(),
+      ),
     );
 
     const rootProperties = sfEntryTimestamp
@@ -261,9 +272,11 @@ class ImeAdditionalPropertiesUtils {
       return undefined;
     }
 
-    const isTaskLayer = UiTreeUtils.makeNodeFilter('Task|ImePlaceholder', [
-      FilterFlag.USE_REGEX,
-    ]);
+    const isTaskLayer = UiTreeUtils.makeNodeFilter(
+      new TextFilter('Task|ImePlaceholder', [
+        FilterFlag.USE_REGEX,
+      ]).getFilterPredicate(),
+    );
     const taskLayer = imeLayer.findAncestor(isTaskLayer);
     if (!taskLayer) {
       return undefined;
@@ -291,8 +304,9 @@ class ImeAdditionalPropertiesUtils {
   }
 
   private isInputMethodVisible(displayContent: HierarchyTreeNode): boolean {
-    const isInputMethod = UiTreeUtils.makeNodeFilter('InputMethod');
-    const inputMethodWindowOrLayer = displayContent.findDfs(isInputMethod);
+    const inputMethodWindowOrLayer = displayContent.findDfs(
+      this.isInputMethodSurface,
+    );
     return inputMethodWindowOrLayer
       ?.getEagerPropertyByName('isComputedVisible')
       ?.getValue();
diff --git a/tools/winscope/src/viewers/common/log_filters.ts b/tools/winscope/src/viewers/common/log_filters.ts
new file mode 100644
index 000000000..788bc52b2
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_filters.ts
@@ -0,0 +1,80 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {StringFilterPredicate} from 'viewers/common/string_filter_predicate';
+import {TextFilter} from 'viewers/common/text_filter';
+
+export abstract class LogFilter {
+  constructor(
+    public innerFilterWidthCss: string,
+    public outerFilterWidthCss: string,
+  ) {}
+
+  abstract updateFilterValue(value: string[]): void;
+  abstract getFilterPredicate(): StringFilterPredicate;
+}
+
+export class LogTextFilter extends LogFilter {
+  constructor(
+    public textFilter: TextFilter,
+    innerFilterWidthCss = '100',
+    outerFilterWidthCss = '100%',
+  ) {
+    super(innerFilterWidthCss, outerFilterWidthCss);
+  }
+
+  override updateFilterValue(value: string[]): void {
+    this.textFilter.filterString = value.at(0) ?? '';
+  }
+
+  override getFilterPredicate(): StringFilterPredicate {
+    return this.textFilter.getFilterPredicate();
+  }
+}
+
+export class LogSelectFilter extends LogFilter {
+  private filterValue: string[] = [];
+  private readonly filterPredicate: StringFilterPredicate;
+
+  constructor(
+    public options: string[],
+    readonly shouldFilterBySubstring = false,
+    innerFilterWidthCss = '100',
+    outerFilterWidthCss = '100%',
+  ) {
+    super(innerFilterWidthCss, outerFilterWidthCss);
+
+    if (this.shouldFilterBySubstring) {
+      this.filterPredicate = (entryString) => {
+        if (this.filterValue.length === 0) return true;
+        return this.filterValue.some((val) => entryString.includes(val));
+      };
+    } else {
+      this.filterPredicate = (entryString) => {
+        if (this.filterValue.length === 0) return true;
+        return this.filterValue.includes(entryString);
+      };
+    }
+  }
+
+  override updateFilterValue(value: string[]) {
+    this.filterValue = value;
+  }
+
+  override getFilterPredicate(): StringFilterPredicate {
+    return this.filterPredicate;
+  }
+}
diff --git a/tools/winscope/src/viewers/common/log_filters_test.ts b/tools/winscope/src/viewers/common/log_filters_test.ts
new file mode 100644
index 000000000..195f344e1
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_filters_test.ts
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogSelectFilter, LogTextFilter} from './log_filters';
+
+describe('LogFilters', () => {
+  it('text filter filters by substring', () => {
+    const filter = new LogTextFilter(new TextFilter());
+    let predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeTrue();
+
+    filter.updateFilterValue(['match']);
+    predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeFalse();
+    expect(predicate('match')).toBeTrue();
+    expect(predicate('test match')).toBeTrue();
+
+    filter.updateFilterValue([]);
+    predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeTrue();
+  });
+
+  it('select filter filters by exact match', () => {
+    const filter = new LogSelectFilter([]);
+    let predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeTrue();
+
+    filter.updateFilterValue(['match']);
+    predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeFalse();
+    expect(predicate('match')).toBeTrue();
+    expect(predicate('test match')).toBeFalse();
+
+    filter.updateFilterValue([]);
+    predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeTrue();
+  });
+
+  it('select filter filters by substring', () => {
+    const filter = new LogSelectFilter([], true);
+    filter.updateFilterValue(['match']);
+    const predicate = filter.getFilterPredicate();
+    expect(predicate('test')).toBeFalse();
+    expect(predicate('match')).toBeTrue();
+    expect(predicate('test match')).toBeTrue();
+  });
+});
diff --git a/tools/winscope/src/viewers/common/log_presenter.ts b/tools/winscope/src/viewers/common/log_presenter.ts
index efcd8a4ce..573ed0d02 100644
--- a/tools/winscope/src/viewers/common/log_presenter.ts
+++ b/tools/winscope/src/viewers/common/log_presenter.ts
@@ -16,24 +16,17 @@
 
 import {ArrayUtils} from 'common/array_utils';
 import {assertDefined} from 'common/assert_utils';
-import {
-  FilterFlag,
-  makeFilterPredicate,
-  StringFilterPredicate,
-} from 'common/filter_flag';
-import {Timestamp} from 'common/time';
 import {TraceEntry} from 'trace/trace';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TextFilter} from './text_filter';
-import {LogEntry, LogFieldType, LogFilter} from './ui_data_log';
+import {StringFilterPredicate} from 'viewers/common/string_filter_predicate';
+import {TextFilter} from 'viewers/common/text_filter';
+import {ColumnSpec, LogEntry, LogHeader} from './ui_data_log';
 
 export class LogPresenter<Entry extends LogEntry> {
   private allEntries: Entry[] = [];
   private filteredEntries: Entry[] = [];
-  private filters: LogFilter[] = [];
-  private headers: LogFieldType[] = [];
-  private filterPredicates = new Map<LogFieldType, StringFilterPredicate>();
-  private currentEntry: TraceEntry<PropertyTreeNode> | undefined;
+  private headers: LogHeader[] = [];
+  private filterPredicates = new Map<ColumnSpec, StringFilterPredicate>();
+  private currentEntry: TraceEntry<object> | undefined;
   private selectedIndex: number | undefined;
   private scrollToIndex: number | undefined;
   private currentIndex: number | undefined;
@@ -46,38 +39,23 @@ export class LogPresenter<Entry extends LogEntry> {
     this.updateFilteredEntries();
   }
 
-  setHeaders(headers: LogFieldType[]) {
+  setHeaders(headers: LogHeader[]) {
     this.headers = headers;
-  }
 
-  getHeaders(): LogFieldType[] {
-    return this.headers;
-  }
-
-  setFilters(filters: LogFilter[]) {
-    this.filters = filters;
-    this.filterPredicates = new Map<LogFieldType, StringFilterPredicate>();
-    this.filters.forEach((filter) => {
-      if (
-        filter.textFilter &&
-        (filter.textFilter.filterString || filter.textFilter.flags.length > 0)
-      ) {
-        this.filterPredicates.set(
-          filter.type,
-          this.makeLogFilterPredicate(
-            filter.type,
-            filter.textFilter.filterString,
-            filter.textFilter.flags,
-          ),
-        );
-      }
+    this.filterPredicates = new Map<ColumnSpec, StringFilterPredicate>();
+    this.headers.forEach((header) => {
+      if (!header.filter) return;
+      this.filterPredicates.set(
+        header.spec,
+        header.filter.getFilterPredicate(),
+      );
     });
     this.updateFilteredEntries();
     this.resetIndices();
   }
 
-  getFilters(): LogFilter[] {
-    return this.filters;
+  getHeaders(): LogHeader[] {
+    return this.headers;
   }
 
   getFilteredEntries(): Entry[] {
@@ -127,34 +105,33 @@ export class LogPresenter<Entry extends LogEntry> {
     }
   }
 
-  applyTracePositionUpdate(entry: TraceEntry<PropertyTreeNode> | undefined) {
+  applyTracePositionUpdate(entry: TraceEntry<object> | undefined) {
     this.currentEntry = entry;
     this.resetIndices();
   }
 
-  applyTextFilterChange(type: LogFieldType, value: TextFilter) {
-    assertDefined(
-      this.filters.find((filter) => filter.type === type),
-    ).textFilter = value;
-    if (value.filterString.length > 0) {
-      this.filterPredicates.set(
-        type,
-        this.makeLogFilterPredicate(type, value.filterString, value.flags),
-      );
+  applyTextFilterChange(header: LogHeader, value: TextFilter) {
+    const filter = assertDefined(header.filter);
+    const filterString = value.filterString;
+    filter.updateFilterValue([filterString]);
+    if (filterString.length > 0) {
+      this.filterPredicates.set(header.spec, filter.getFilterPredicate());
     } else {
-      this.filterPredicates.delete(type);
+      this.filterPredicates.delete(header.spec);
     }
     this.updateEntriesAfterFilterChange();
   }
 
-  applyFilterChange(type: LogFieldType, value: string[] | string) {
+  applySelectFilterChange(header: LogHeader, value: string[]) {
+    const filter = assertDefined(header.filter);
+    filter.updateFilterValue(value);
     if (value.length > 0) {
       this.filterPredicates.set(
-        type,
-        this.makeLogFilterPredicate(type, value, []),
+        header.spec,
+        assertDefined(header.filter).getFilterPredicate(),
       );
     } else {
-      this.filterPredicates.delete(type);
+      this.filterPredicates.delete(header.spec);
     }
     this.updateEntriesAfterFilterChange();
   }
@@ -185,42 +162,12 @@ export class LogPresenter<Entry extends LogEntry> {
     this.scrollToIndex = this.currentIndex;
   }
 
-  private static shouldFilterBySubstring(type: LogFieldType): boolean {
-    switch (type) {
-      case LogFieldType.FLAGS:
-      case LogFieldType.INPUT_DISPATCH_WINDOWS:
-        return true;
-      default:
-        return false;
-    }
-  }
-
-  private makeLogFilterPredicate(
-    type: LogFieldType,
-    filterValue: string | string[],
-    flags: FilterFlag[],
-  ): StringFilterPredicate {
-    if (
-      Array.isArray(filterValue) &&
-      LogPresenter.shouldFilterBySubstring(type)
-    ) {
-      return (entryString) =>
-        filterValue.some((val) => entryString.includes(val));
-    } else if (Array.isArray(filterValue)) {
-      return (entryString) => filterValue.includes(entryString);
-    } else {
-      return makeFilterPredicate(filterValue, flags);
-    }
-  }
-
   private updateFilteredEntries() {
     this.filteredEntries = this.allEntries.filter((entry) => {
-      for (const [filterType, predicate] of this.filterPredicates) {
-        const entryValue = entry.fields.find(
-          (f) => f.type === filterType,
-        )?.value;
+      for (const [spec, predicate] of this.filterPredicates) {
+        const entryValue = entry.fields.find((f) => f.spec === spec)?.value;
 
-        if (entryValue === undefined || entryValue instanceof Timestamp) {
+        if (entryValue === undefined) {
           continue;
         }
 
@@ -233,6 +180,7 @@ export class LogPresenter<Entry extends LogEntry> {
     if (this.filteredEntries.length === 0) {
       this.currentIndex = undefined;
       this.selectedIndex = undefined;
+      this.scrollToIndex = undefined;
     }
     this.originalIndicesOfAllEntries = this.filteredEntries.map((entry) =>
       entry.traceEntry.getIndex(),
diff --git a/tools/winscope/src/viewers/common/log_presenter_test.ts b/tools/winscope/src/viewers/common/log_presenter_test.ts
new file mode 100644
index 000000000..0ffab5dbc
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_presenter_test.ts
@@ -0,0 +1,369 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogSelectFilter, LogTextFilter} from './log_filters';
+import {LogPresenter} from './log_presenter';
+import {LogEntry, LogHeader} from './ui_data_log';
+
+describe('LogPresenter', () => {
+  let presenter: LogPresenter<LogEntry>;
+  const timestamp1 = TimestampConverterUtils.makeElapsedTimestamp(1n);
+  const timestamp2 = TimestampConverterUtils.makeElapsedTimestamp(2n);
+  const timestamp3 = TimestampConverterUtils.makeElapsedTimestamp(3n);
+  const timestamp4 = TimestampConverterUtils.makeElapsedTimestamp(4n);
+  const trace = new TraceBuilder<PropertyTreeNode>()
+    .setType(TraceType.TRANSACTIONS)
+    .setEntries([
+      new PropertyTreeBuilder()
+        .setRootId('Test Trace')
+        .setName('entry 1')
+        .build(),
+      new PropertyTreeBuilder()
+        .setRootId('Test Trace')
+        .setName('entry 2')
+        .build(),
+      new PropertyTreeBuilder()
+        .setRootId('Test Trace')
+        .setName('entry 3')
+        .build(),
+      new PropertyTreeBuilder()
+        .setRootId('Test Trace')
+        .setName('entry 4')
+        .build(),
+    ])
+    .setTimestamps([timestamp1, timestamp2, timestamp3, timestamp4])
+    .build();
+
+  const STRING_COLUMN = {
+    name: 'String Column',
+    cssClass: 'string-column',
+  };
+  const NUMBER_COLUMN = {
+    name: 'Number Column',
+    cssClass: 'number-column',
+  };
+  const TIMESTAMP_COLUMN = {
+    name: 'Timestamp Column',
+    cssClass: 'timestamp-column',
+  };
+  let stringFilter: LogTextFilter;
+  let numberFilter: LogSelectFilter;
+  let headers: LogHeader[];
+  let testEntries: LogEntry[];
+
+  describe('time-ordered entries', () => {
+    beforeEach(async () => {
+      presenter = new LogPresenter();
+      testEntries = await buildTestEntries();
+      presenter.setAllEntries(testEntries);
+      expectAllIndicesUndefined();
+
+      stringFilter = new LogTextFilter(new TextFilter('stringValue'));
+      numberFilter = new LogSelectFilter(['0', '1', '2', '3']);
+      headers = [
+        new LogHeader(STRING_COLUMN, stringFilter),
+        new LogHeader(NUMBER_COLUMN, numberFilter),
+        new LogHeader(TIMESTAMP_COLUMN),
+      ];
+    });
+
+    it('applies filters to existing entries when headers updated', async () => {
+      presenter.setHeaders(headers);
+      expect(presenter.getHeaders()).toEqual(headers);
+      expect(presenter.getFilteredEntries()).toEqual([
+        testEntries[0],
+        testEntries[2],
+      ]);
+      expectAllIndicesUndefined();
+    });
+
+    it('applies existing filters when entries updated', async () => {
+      presenter.setAllEntries([]);
+      expectAllIndicesUndefined();
+
+      presenter.setHeaders(headers);
+      expect(presenter.getHeaders()).toEqual(headers);
+      expectAllIndicesUndefined();
+
+      presenter.setAllEntries(testEntries);
+      expect(presenter.getFilteredEntries()).toEqual([
+        testEntries[0],
+        testEntries[2],
+      ]);
+      expectAllIndicesUndefined();
+    });
+
+    it('applies log entry click', () => {
+      // selects index
+      presenter.applyLogEntryClick(1);
+      expect(presenter.getSelectedIndex()).toEqual(1);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toBeUndefined();
+
+      // on same index, clears scroll but leaves current and selected unchanged
+      presenter.applyTracePositionUpdate(trace.getEntry(0));
+      presenter.applyLogEntryClick(1);
+      expect(presenter.getSelectedIndex()).toEqual(1);
+      expect(presenter.getCurrentIndex()).toEqual(0);
+      expect(presenter.getScrollToIndex()).toBeUndefined();
+    });
+
+    it('applies arrow down press', () => {
+      // selects and scrolls to first index if no selected or current index
+      presenter.applyArrowDownPress();
+      expect(presenter.getSelectedIndex()).toEqual(0);
+      expect(presenter.getScrollToIndex()).toEqual(0);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // selects next index after selected index
+      presenter.applyArrowDownPress();
+      expect(presenter.getSelectedIndex()).toEqual(1);
+      expect(presenter.getScrollToIndex()).toEqual(1);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // handles index out of range
+      presenter.applyArrowDownPress();
+      presenter.applyArrowDownPress();
+      presenter.applyArrowDownPress();
+      expect(presenter.getSelectedIndex()).toEqual(3);
+      expect(presenter.getScrollToIndex()).toEqual(3);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // selects next index after current index
+      presenter.applyTracePositionUpdate(trace.getEntry(0));
+      presenter.applyArrowDownPress();
+      expect(presenter.getSelectedIndex()).toEqual(1);
+      expect(presenter.getScrollToIndex()).toEqual(1);
+      expect(presenter.getCurrentIndex()).toEqual(0);
+
+      // handles no entries
+      presenter.setAllEntries([]);
+      presenter.applyArrowDownPress();
+      expectAllIndicesUndefined();
+    });
+
+    it('applies arrow up press', () => {
+      // selects first index if no selected or current index
+      presenter.applyArrowUpPress();
+      expect(presenter.getSelectedIndex()).toEqual(0);
+      expect(presenter.getScrollToIndex()).toEqual(0);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // selects index before selected index
+      presenter.applyLogEntryClick(2);
+      presenter.applyArrowUpPress();
+      expect(presenter.getSelectedIndex()).toEqual(1);
+      expect(presenter.getScrollToIndex()).toEqual(1);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // handles index out of range
+      presenter.applyArrowUpPress();
+      presenter.applyArrowUpPress();
+      presenter.applyArrowUpPress();
+      expect(presenter.getSelectedIndex()).toEqual(0);
+      expect(presenter.getScrollToIndex()).toEqual(0);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+
+      // selects index before current index
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      presenter.applyArrowUpPress();
+      expect(presenter.getSelectedIndex()).toEqual(0);
+      expect(presenter.getScrollToIndex()).toEqual(0);
+      expect(presenter.getCurrentIndex()).toEqual(1);
+
+      // handles no entries
+      presenter.setAllEntries([]);
+      presenter.applyArrowDownPress();
+      expectAllIndicesUndefined();
+    });
+
+    it('applies trace position update', () => {
+      // updates current index, clears selected index, scrolls to current index
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      expect(presenter.getCurrentIndex()).toEqual(1);
+      expect(presenter.getSelectedIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toEqual(1);
+
+      // if no current entry, current index undefined
+      presenter.applyTracePositionUpdate(undefined);
+      expect(presenter.getCurrentIndex()).toBeUndefined();
+      expect(presenter.getSelectedIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toBeUndefined();
+
+      // if current entry filtered out, returns next entry by time
+      updateStringFilterAndCheckEntries('stringValue', [
+        testEntries[0],
+        testEntries[2],
+      ]);
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      expect(presenter.getCurrentIndex()).toEqual(1);
+      expect(presenter.getSelectedIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toEqual(1);
+
+      // handles no filtered entries
+      updateStringFilterAndCheckEntries('no matches', []);
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      expectAllIndicesUndefined();
+      updateStringFilterAndCheckEntries('', testEntries);
+
+      // handles no entries
+      presenter.setAllEntries([]);
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      presenter.applyArrowDownPress();
+      expectAllIndicesUndefined();
+    });
+
+    it('applies trace position update for non time-ordered entries', () => {
+      const presenter = new LogPresenter(false);
+      presenter.setAllEntries([testEntries[3]].concat(testEntries.slice(0, 3)));
+      expectAllIndicesUndefined();
+
+      presenter.applyTracePositionUpdate(trace.getEntry(1));
+      expect(presenter.getCurrentIndex()).toEqual(2);
+      expect(presenter.getSelectedIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toEqual(2);
+
+      presenter.applyTracePositionUpdate(trace.getEntry(3));
+      expect(presenter.getCurrentIndex()).toEqual(0);
+      expect(presenter.getSelectedIndex()).toBeUndefined();
+      expect(presenter.getScrollToIndex()).toEqual(0);
+    });
+
+    it('applies text filter change', () => {
+      updateStringFilterAndCheckEntries('stringValue', [
+        testEntries[0],
+        testEntries[2],
+      ]);
+      updateStringFilterAndCheckEntries('no matches', []);
+      updateStringFilterAndCheckEntries('', testEntries);
+    });
+
+    it('applies select filter change', () => {
+      updateNumberFilterAndCheckEntries(['0'], [testEntries[0]]);
+      updateNumberFilterAndCheckEntries(
+        ['0', '3'],
+        [testEntries[0], testEntries[3]],
+      );
+      updateNumberFilterAndCheckEntries([], testEntries);
+    });
+  });
+
+  async function buildTestEntries(): Promise<LogEntry[]> {
+    return [
+      {
+        traceEntry: trace.getEntry(0),
+        fields: [
+          {
+            spec: STRING_COLUMN,
+            value: 'stringValue',
+          },
+          {
+            spec: NUMBER_COLUMN,
+            value: 0,
+          },
+          {
+            spec: TIMESTAMP_COLUMN,
+            value: timestamp1,
+          },
+        ],
+        propertiesTree: await trace.getEntry(0).getValue(),
+      },
+      {
+        traceEntry: trace.getEntry(1),
+        fields: [
+          {
+            spec: STRING_COLUMN,
+            value: 'differentValue',
+          },
+          {
+            spec: NUMBER_COLUMN,
+            value: 1,
+          },
+          {
+            spec: TIMESTAMP_COLUMN,
+            value: timestamp2,
+          },
+        ],
+        propertiesTree: await trace.getEntry(1).getValue(),
+      },
+      {
+        traceEntry: trace.getEntry(2),
+        fields: [
+          {
+            spec: STRING_COLUMN,
+            value: 'stringValue',
+          },
+          {
+            spec: NUMBER_COLUMN,
+            value: 2,
+          },
+          {
+            spec: TIMESTAMP_COLUMN,
+            value: timestamp3,
+          },
+        ],
+        propertiesTree: await trace.getEntry(2).getValue(),
+      },
+      {
+        traceEntry: trace.getEntry(3),
+        fields: [
+          {
+            spec: STRING_COLUMN,
+            value: 'differentValue',
+          },
+          {
+            spec: NUMBER_COLUMN,
+            value: 3,
+          },
+          {
+            spec: TIMESTAMP_COLUMN,
+            value: timestamp4,
+          },
+        ],
+        propertiesTree: await trace.getEntry(3).getValue(),
+      },
+    ];
+  }
+
+  function expectAllIndicesUndefined() {
+    expect(presenter.getCurrentIndex()).toBeUndefined();
+    expect(presenter.getSelectedIndex()).toBeUndefined();
+    expect(presenter.getScrollToIndex()).toBeUndefined();
+  }
+
+  function updateStringFilterAndCheckEntries(
+    value: string,
+    expectedEntries: LogEntry[],
+  ) {
+    stringFilter.updateFilterValue([value]);
+    presenter.applyTextFilterChange(headers[0], stringFilter.textFilter);
+    expect(presenter.getFilteredEntries()).toEqual(expectedEntries);
+  }
+
+  function updateNumberFilterAndCheckEntries(
+    value: string[],
+    expectedEntries: LogEntry[],
+  ) {
+    presenter.applySelectFilterChange(headers[1], value);
+    expect(presenter.getFilteredEntries()).toEqual(expectedEntries);
+  }
+});
diff --git a/tools/winscope/src/viewers/common/log_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/log_viewer_presenter_test.ts
new file mode 100644
index 000000000..58702cae2
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_viewer_presenter_test.ts
@@ -0,0 +1,571 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {
+  ActiveTraceChanged,
+  DarkModeToggled,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
+import {MockPresenter} from 'test/unit/mock_log_viewer_presenter';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
+import {TracePosition} from 'trace/trace_position';
+import {TraceType} from 'trace/trace_type';
+import {DEFAULT_PROPERTY_FORMATTER} from 'trace/tree_node/formatters';
+import {
+  PropertySource,
+  PropertyTreeNode,
+} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogSelectFilter, LogTextFilter} from './log_filters';
+import {LogHeader, UiDataLog} from './ui_data_log';
+import {UserOptions} from './user_options';
+import {
+  LogFilterChangeDetail,
+  LogTextFilterChangeDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from './viewer_events';
+
+describe('AbstractLogViewerPresenter', () => {
+  let uiData: UiDataLog;
+  let presenter: MockPresenter;
+  let trace: Trace<PropertyTreeNode>;
+  let positionUpdate: TracePositionUpdate;
+  let secondPositionUpdate: TracePositionUpdate;
+  let lastEntryPositionUpdate: TracePositionUpdate;
+
+  beforeAll(async () => {
+    const timestamp1 = TimestampConverterUtils.makeElapsedTimestamp(1n);
+    const timestamp2 = TimestampConverterUtils.makeElapsedTimestamp(2n);
+    const timestamp3 = TimestampConverterUtils.makeElapsedTimestamp(3n);
+    const timestamp4 = TimestampConverterUtils.makeElapsedTimestamp(4n);
+    trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSACTIONS)
+      .setEntries([
+        new PropertyTreeBuilder()
+          .setRootId('Test Trace')
+          .setName('entry 1')
+          .setChildren([
+            {
+              name: 'pass1',
+              value: 'pass',
+              formatter: DEFAULT_PROPERTY_FORMATTER,
+            },
+            {
+              name: 'pass2',
+              value: 'fail',
+              formatter: DEFAULT_PROPERTY_FORMATTER,
+              source: PropertySource.DEFAULT,
+            },
+            {
+              name: 'fail1',
+              value: 'pass',
+              formatter: DEFAULT_PROPERTY_FORMATTER,
+            },
+            {
+              name: 'fail2',
+              value: 'fail',
+              formatter: DEFAULT_PROPERTY_FORMATTER,
+            },
+          ])
+          .build(),
+        new PropertyTreeBuilder()
+          .setRootId('Test Trace')
+          .setName('entry 2')
+          .build(),
+        new PropertyTreeBuilder()
+          .setRootId('Test Trace')
+          .setName('entry 3')
+          .build(),
+        new PropertyTreeBuilder()
+          .setRootId('Test Trace')
+          .setName('entry 4')
+          .build(),
+      ])
+      .setTimestamps([timestamp1, timestamp2, timestamp3, timestamp4])
+      .build();
+    positionUpdate = TracePositionUpdate.fromTraceEntry(trace.getEntry(0));
+    secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      trace.getEntry(1),
+    );
+    lastEntryPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      trace.getEntry(3),
+    );
+  });
+
+  beforeEach(() => {
+    presenter = new MockPresenter(trace, new InMemoryStorage(), (newData) => {
+      uiData = newData;
+    });
+  });
+
+  it('adds events listeners', async () => {
+    const element = makeElement();
+    presenter.addEventListeners(element);
+
+    const testHeader = new LogHeader(
+      {name: 'Test Column', cssClass: 'test-class'},
+      new LogSelectFilter([]),
+    );
+
+    let spy: jasmine.Spy = spyOn(presenter, 'onSelectFilterChange');
+    const filterDetail = new LogFilterChangeDetail(testHeader, ['']);
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.LogFilterChange, {
+        detail: filterDetail,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(testHeader, filterDetail.value);
+
+    spy = spyOn(presenter, 'onTextFilterChange');
+    const textFilterDetail = new LogTextFilterChangeDetail(
+      testHeader,
+      new TextFilter(),
+    );
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.LogTextFilterChange, {
+        detail: textFilterDetail,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(testHeader, textFilterDetail.filter);
+
+    spy = spyOn(presenter, 'onLogEntryClick');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.LogEntryClick, {
+        detail: 0,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(0);
+
+    spy = spyOn(presenter, 'onArrowDownPress');
+    element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowDownPress));
+    expect(spy).toHaveBeenCalled();
+
+    spy = spyOn(presenter, 'onArrowUpPress');
+    element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowUpPress));
+    expect(spy).toHaveBeenCalled();
+
+    await presenter.onAppEvent(positionUpdate);
+    spy = spyOn(presenter, 'onLogTimestampClick');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.TimestampClick, {
+        detail: new TimestampClickDetail(uiData.entries[0].traceEntry),
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(uiData.entries[0].traceEntry);
+
+    spy = spyOn(presenter, 'onRawTimestampClick');
+    const ts = TimestampConverterUtils.makeZeroTimestamp();
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.TimestampClick, {
+        detail: new TimestampClickDetail(undefined, ts),
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(ts);
+
+    spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
+        detail: {userOptions: {}},
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith({});
+
+    spy = spyOn(presenter, 'onPropertiesFilterChange');
+    const filter = new TextFilter();
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.PropertiesFilterChange, {
+        detail: filter,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(filter);
+
+    spy = spyOn(presenter, 'onPositionChangeByKeyPress');
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}));
+    pressRightArrowKey();
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));
+    expect(spy).not.toHaveBeenCalled();
+
+    document.body.append(element);
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}));
+    pressRightArrowKey();
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));
+    expect(spy).toHaveBeenCalledTimes(2);
+  });
+
+  it('initializes entries and filters with options', async () => {
+    expect(uiData.scrollToIndex).toBeUndefined();
+    expect(uiData.currentIndex).toBeUndefined();
+    expect(uiData.selectedIndex).toBeUndefined();
+    expect(uiData.entries.length).toEqual(0);
+    expect(uiData.propertiesTree).toBeUndefined();
+    expect(uiData.headers).toEqual([]);
+
+    await assertDefined(presenter).onAppEvent(positionUpdate);
+
+    expect(uiData.scrollToIndex).toBeDefined();
+    expect(uiData.currentIndex).toBeDefined();
+    expect(uiData.selectedIndex).toBeUndefined();
+    expect(uiData.entries.length).toEqual(4);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[0].propertiesTree).id,
+    );
+    expect(uiData.headers.length).toEqual(3);
+    expect((uiData.headers[0].filter as LogSelectFilter).options).toEqual([
+      'stringValue',
+      'differentValue',
+    ]);
+  });
+
+  it('processes trace position update and updates ui data', async () => {
+    await assertDefined(presenter).onAppEvent(secondPositionUpdate);
+    expect(uiData.currentIndex).toEqual(1);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[1].propertiesTree).id,
+    );
+  });
+
+  it('allows arrow keydown event to propagate if presenter trace not active or current index not defined', async () => {
+    const element = makeElement();
+    document.body.append(element);
+    presenter.addEventListeners(element);
+    const listenerSpy = jasmine.createSpy();
+    document.addEventListener('keydown', listenerSpy);
+
+    await presenter.onAppEvent(
+      new TracePositionUpdate(
+        TracePosition.fromTimestamp(
+          TimestampConverterUtils.makeElapsedTimestamp(-1n),
+        ),
+      ),
+    );
+    expect(uiData.currentIndex).toBeUndefined();
+
+    pressRightArrowKey();
+    expect(listenerSpy).toHaveBeenCalledTimes(1);
+
+    await presenter.onAppEvent(
+      new ActiveTraceChanged(
+        assertDefined(positionUpdate.position.entry).getFullTrace(),
+      ),
+    );
+    pressRightArrowKey();
+    expect(listenerSpy).toHaveBeenCalledTimes(2);
+
+    await presenter.onAppEvent(positionUpdate);
+    pressRightArrowKey();
+    expect(listenerSpy).toHaveBeenCalledTimes(2);
+
+    await presenter.onAppEvent(
+      new ActiveTraceChanged(
+        UnitTestUtils.makeEmptyTrace(TraceType.TRANSACTIONS),
+      ),
+    );
+    pressRightArrowKey();
+    expect(listenerSpy).toHaveBeenCalledTimes(3);
+
+    document.removeEventListener('keydown', listenerSpy);
+  });
+
+  it('propagates position with next trace entry of different timestamp on right arrow key press', async () => {
+    const positionUpdateEntry = assertDefined(positionUpdate.position.entry);
+    const trace = positionUpdateEntry.getFullTrace();
+    await presenter.onAppEvent(new ActiveTraceChanged(trace));
+
+    const emitEventSpy = jasmine.createSpy();
+    presenter.setEmitEvent(emitEventSpy);
+    await presenter.onAppEvent(positionUpdate);
+
+    await presenter.onPositionChangeByKeyPress(
+      new KeyboardEvent('keydown', {key: 'ArrowRight'}),
+    );
+    const nextEntry = assertDefined(
+      uiData.entries.find(
+        (entry) =>
+          entry.traceEntry.getTimestamp() > positionUpdateEntry.getTimestamp(),
+      ),
+    );
+    expect(emitEventSpy).toHaveBeenCalledWith(
+      new TracePositionUpdate(
+        TracePosition.fromTraceEntry(nextEntry.traceEntry),
+        true,
+      ),
+    );
+  });
+
+  it('does not propagate any position on right arrow key press if on last entry', async () => {
+    const trace = assertDefined(
+      lastEntryPositionUpdate.position.entry,
+    ).getFullTrace();
+    await presenter.onAppEvent(new ActiveTraceChanged(trace));
+
+    const emitEventSpy = jasmine.createSpy();
+    presenter.setEmitEvent(emitEventSpy);
+    await presenter.onAppEvent(lastEntryPositionUpdate);
+
+    await presenter.onPositionChangeByKeyPress(
+      new KeyboardEvent('keydown', {key: 'ArrowRight'}),
+    );
+    expect(emitEventSpy).not.toHaveBeenCalled();
+  });
+
+  it('propagates position with prev trace entry on left arrow key press', async () => {
+    const trace = assertDefined(
+      lastEntryPositionUpdate.position.entry,
+    ).getFullTrace();
+    await presenter.onAppEvent(new ActiveTraceChanged(trace));
+
+    const emitEventSpy = jasmine.createSpy();
+    presenter.setEmitEvent(emitEventSpy);
+    await presenter.onAppEvent(lastEntryPositionUpdate);
+
+    await presenter.onPositionChangeByKeyPress(
+      new KeyboardEvent('keydown', {key: 'ArrowLeft'}),
+    );
+    expect(emitEventSpy).toHaveBeenCalledWith(
+      new TracePositionUpdate(
+        TracePosition.fromTraceEntry(
+          uiData.entries[assertDefined(uiData.currentIndex) - 1].traceEntry,
+        ),
+        true,
+      ),
+    );
+  });
+
+  it('does not propagate any position on left arrow key press if on first entry', async () => {
+    const trace = assertDefined(positionUpdate.position.entry).getFullTrace();
+    await presenter.onAppEvent(new ActiveTraceChanged(trace));
+
+    const emitEventSpy = jasmine.createSpy();
+    presenter.setEmitEvent(emitEventSpy);
+    await presenter.onAppEvent(positionUpdate);
+
+    await presenter.onPositionChangeByKeyPress(
+      new KeyboardEvent('keydown', {key: 'ArrowLeft'}),
+    );
+    expect(emitEventSpy).not.toHaveBeenCalled();
+  });
+
+  it('filters entries on select filter change', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    const header = uiData.headers[1];
+
+    await presenter.onSelectFilterChange(header, ['0']);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[1].value)),
+    ).toEqual(new Set([0]));
+
+    await presenter.onSelectFilterChange(header, ['0', '2', '3']);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[1].value)),
+    ).toEqual(new Set([0, 2, 3]));
+
+    await presenter.onSelectFilterChange(header, []);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[1].value)),
+    ).toEqual(new Set([0, 1, 2, 3]));
+  });
+
+  it('filters entries on text filter change', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    const header = uiData.headers[0];
+    const filter = header.filter as LogTextFilter;
+
+    filter.updateFilterValue(['stringValue']);
+    await presenter.onTextFilterChange(header, filter.textFilter);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[0].value)),
+    ).toEqual(new Set(['stringValue']));
+
+    filter.updateFilterValue(['value']);
+    await presenter.onTextFilterChange(header, filter.textFilter);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[0].value)),
+    ).toEqual(new Set(['stringValue', 'differentValue']));
+
+    filter.updateFilterValue(['']);
+    await presenter.onTextFilterChange(header, filter.textFilter);
+    expect(
+      new Set(uiData.entries.map((entry) => entry.fields[0].value)),
+    ).toEqual(new Set(['stringValue', 'differentValue']));
+  });
+
+  it('updates indices when filters change', async () => {
+    await presenter.onAppEvent(lastEntryPositionUpdate);
+    presenter.onLogEntryClick(1);
+    expect(uiData.currentIndex).toEqual(3);
+    expect(uiData.selectedIndex).toEqual(1);
+
+    const header = uiData.headers[1];
+    await presenter.onSelectFilterChange(header, ['0']);
+    expect(uiData.currentIndex).toEqual(0);
+    expect(uiData.selectedIndex).toEqual(0);
+
+    await presenter.onSelectFilterChange(header, ['0', '2']);
+    expect(uiData.currentIndex).toEqual(1);
+    expect(uiData.selectedIndex).toEqual(0);
+
+    await presenter.onSelectFilterChange(header, []);
+    expect(uiData.currentIndex).toEqual(3);
+    expect(uiData.selectedIndex).toEqual(0);
+  });
+
+  it('updates properties tree when entry clicked', async () => {
+    await presenter.onAppEvent(positionUpdate);
+
+    await presenter.onLogEntryClick(2);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[2].propertiesTree).id,
+    );
+
+    // does not remove selection when entry clicked again
+    await presenter.onLogEntryClick(2);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[2].propertiesTree).id,
+    );
+  });
+
+  it('updates properties tree when changed by key press', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    await presenter.onLogEntryClick(0);
+
+    await presenter.onArrowDownPress();
+    expect(uiData.selectedIndex).toEqual(1);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[1].propertiesTree).id,
+    );
+
+    await presenter.onArrowUpPress();
+    expect(uiData.selectedIndex).toEqual(0);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[0].propertiesTree).id,
+    );
+
+    // does not remove selection if index out of range
+    await presenter.onArrowUpPress();
+    expect(uiData.selectedIndex).toEqual(0);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[0].propertiesTree).id,
+    );
+
+    // does not remove selection if index out of range
+    await presenter.onLogEntryClick(3);
+    await presenter.onArrowDownPress();
+    expect(uiData.selectedIndex).toEqual(3);
+    expect(assertDefined(uiData.propertiesTree).id).toEqual(
+      assertDefined(uiData.entries[3].propertiesTree).id,
+    );
+  });
+
+  it('emits event on log timestamp click', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    const spy = jasmine.createSpy();
+    presenter.setEmitEvent(spy);
+
+    await presenter.onLogTimestampClick(uiData.entries[0].traceEntry);
+    expect(spy).toHaveBeenCalledWith(
+      TracePositionUpdate.fromTraceEntry(uiData.entries[0].traceEntry, true),
+    );
+  });
+
+  it('emits event on raw timestamp click', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    const spy = jasmine.createSpy();
+    presenter.setEmitEvent(spy);
+
+    const ts = TimestampConverterUtils.makeZeroTimestamp();
+    await presenter.onRawTimestampClick(ts);
+    expect(spy).toHaveBeenCalledWith(
+      TracePositionUpdate.fromTimestamp(ts, true),
+    );
+  });
+
+  it('filters properties tree', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    expect(
+      assertDefined(uiData.propertiesTree).getAllChildren().length,
+    ).toEqual(3);
+    await presenter.onPropertiesFilterChange(new TextFilter('pass'));
+    expect(
+      assertDefined(uiData.propertiesTree).getAllChildren().length,
+    ).toEqual(2);
+  });
+
+  it('shows/hides defaults', async () => {
+    await presenter.onAppEvent(positionUpdate);
+    expect(
+      assertDefined(uiData.propertiesTree).getAllChildren().length,
+    ).toEqual(3);
+    const userOptions: UserOptions = {
+      showDefaults: {
+        name: 'Show defaults',
+        enabled: true,
+      },
+    };
+    await presenter.onPropertiesUserOptionsChange(userOptions);
+    expect(uiData.propertiesUserOptions).toEqual(userOptions);
+    expect(
+      assertDefined(uiData.propertiesTree).getAllChildren().length,
+    ).toEqual(4);
+  });
+
+  it('updates dark mode', async () => {
+    expect(uiData.isDarkMode).toBeFalse();
+    await presenter.onAppEvent(new DarkModeToggled(true));
+    expect(uiData.isDarkMode).toBeTrue();
+  });
+
+  it('is robust to empty trace', async () => {
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.TRANSACTIONS);
+    const presenter = new MockPresenter(
+      trace,
+      new InMemoryStorage(),
+      (newData) => (uiData = newData),
+    );
+
+    await presenter.onAppEvent(
+      TracePositionUpdate.fromTimestamp(
+        TimestampConverterUtils.makeRealTimestamp(0n),
+      ),
+    );
+
+    expect(uiData.entries).toEqual([]);
+    expect(uiData.selectedIndex).toBeUndefined();
+    expect(uiData.scrollToIndex).toBeUndefined();
+    expect(uiData.currentIndex).toBeUndefined();
+    expect(uiData.headers.length).toEqual(3);
+    expect(uiData.propertiesTree).toBeUndefined();
+    expect(uiData.propertiesUserOptions).toBeDefined();
+    expect(uiData.propertiesFilter).toBeDefined();
+  });
+
+  function makeElement(): HTMLElement {
+    const element = document.createElement('div');
+    element.style.height = '5px';
+    element.style.width = '5px';
+    return element;
+  }
+
+  function pressRightArrowKey() {
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}));
+  }
+});
diff --git a/tools/winscope/src/viewers/common/preset_hierarchy.ts b/tools/winscope/src/viewers/common/preset_hierarchy.ts
index 6a9bffbeb..756c63bd2 100644
--- a/tools/winscope/src/viewers/common/preset_hierarchy.ts
+++ b/tools/winscope/src/viewers/common/preset_hierarchy.ts
@@ -14,15 +14,27 @@
  * limitations under the License.
  */
 
+import {FilterFlag} from 'common/filter_flag';
 import {UserOptions} from 'viewers/common/user_options';
 import {RectShowState} from './rect_show_state';
 import {TextFilter} from './text_filter';
 
+export class TextFilterValues {
+  private constructor(
+    public filterString: string,
+    public flags: FilterFlag[],
+  ) {}
+
+  static fromTextFilter(textFilter: TextFilter) {
+    return new TextFilterValues(textFilter.filterString, textFilter.flags);
+  }
+}
+
 export interface PresetHierarchy {
   hierarchyUserOptions: UserOptions;
-  hierarchyFilter: TextFilter;
+  hierarchyFilter: TextFilterValues;
   propertiesUserOptions: UserOptions;
-  propertiesFilter: TextFilter;
+  propertiesFilter: TextFilterValues;
   rectsUserOptions?: UserOptions;
   rectIdToShowState?: Map<string, RectShowState> | undefined;
 }
diff --git a/tools/winscope/src/viewers/common/properties_presenter.ts b/tools/winscope/src/viewers/common/properties_presenter.ts
index bb2240fcf..651f6e843 100644
--- a/tools/winscope/src/viewers/common/properties_presenter.ts
+++ b/tools/winscope/src/viewers/common/properties_presenter.ts
@@ -18,10 +18,10 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {Operation} from 'trace/tree_node/operations/operation';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {TreeNode} from 'trace/tree_node/tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
 import {IsModifiedCallbackType} from './add_diffs';
 import {AddDiffsPropertiesTree} from './add_diffs_properties_tree';
 import {Filter} from './operations/filter';
-import {TextFilter} from './text_filter';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 import {UiTreeFormatter} from './ui_tree_formatter';
 import {TreeNodeFilter, UiTreeUtils} from './ui_tree_utils';
@@ -35,19 +35,14 @@ export class PropertiesPresenter {
 
   constructor(
     private userOptions: UserOptions,
-    private textFilter: TextFilter | undefined,
+    private textFilter: TextFilter,
     private propertiesDenylist: string[],
     private customOperations?: Array<Operation<UiPropertyTreeNode>>,
     private defaultAllowlist: string[] = [],
   ) {
-    if (this.textFilter) {
-      this.propertiesFilter = UiTreeUtils.makeNodeFilter(
-        this.textFilter.filterString,
-        this.textFilter.flags,
-      );
-    } else {
-      this.propertiesFilter = UiTreeUtils.makeNodeFilter('');
-    }
+    this.propertiesFilter = UiTreeUtils.makeNodeFilter(
+      this.textFilter.getFilterPredicate(),
+    );
   }
 
   getUserOptions(): UserOptions {
@@ -85,8 +80,7 @@ export class PropertiesPresenter {
   applyPropertiesFilterChange(textFilter: TextFilter) {
     this.textFilter = textFilter;
     this.propertiesFilter = UiTreeUtils.makeNodeFilter(
-      textFilter.filterString,
-      textFilter.flags,
+      textFilter.getFilterPredicate(),
     );
   }
 
@@ -94,6 +88,10 @@ export class PropertiesPresenter {
     this.userOptions = userOptions;
   }
 
+  updateDefaultAllowList(value: string[]) {
+    this.defaultAllowlist = value;
+  }
+
   async formatPropertiesTree(
     previousHierarchyTree: HierarchyTreeNode | undefined,
     displayName: string | undefined,
@@ -162,12 +160,9 @@ export class PropertiesPresenter {
   }
 
   static isPropertyNodeModified: IsModifiedCallbackType = async (
-    newTree: TreeNode | undefined,
-    oldTree: TreeNode | undefined,
+    newTree: TreeNode,
+    oldTree: TreeNode,
   ) => {
-    if (!newTree && !oldTree) return false;
-    if (!newTree || !oldTree) return true;
-
     const newValue = (newTree as UiPropertyTreeNode).formattedValue();
     const oldValue = (oldTree as UiPropertyTreeNode).formattedValue();
 
diff --git a/tools/winscope/src/viewers/common/properties_presenter_test.ts b/tools/winscope/src/viewers/common/properties_presenter_test.ts
new file mode 100644
index 000000000..8cc1e69a0
--- /dev/null
+++ b/tools/winscope/src/viewers/common/properties_presenter_test.ts
@@ -0,0 +1,152 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertySource} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
+import {DiffType} from './diff_type';
+import {PropertiesPresenter} from './properties_presenter';
+import {UiPropertyTreeNode} from './ui_property_tree_node';
+
+describe('PropertiesPresenter', () => {
+  const pTree = new PropertyTreeBuilder()
+    .setIsRoot(true)
+    .setRootId('Test Trace')
+    .setName('entry')
+    .setChildren([
+      {name: 'defProp', value: false, source: PropertySource.DEFAULT},
+      {name: 'setProp', value: 1},
+      {name: 'otherProp', value: 2},
+      {name: 'calcProp', value: true, source: PropertySource.CALCULATED},
+    ])
+    .build();
+  const hTree = new HierarchyTreeBuilder()
+    .setId('Test Trace')
+    .setName('entry')
+    .setProperties({setProp: 2})
+    .build();
+  let presenter: PropertiesPresenter;
+
+  beforeAll(async () => {
+    jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+  });
+
+  beforeEach(() => {
+    presenter = new PropertiesPresenter({}, new TextFilter(), []);
+    presenter.setPropertiesTree(pTree);
+  });
+
+  it('exposes user options', () => {
+    expect(presenter.getUserOptions()).toEqual({});
+    const testOptions = {test: {name: 'Test opt', enabled: false}};
+    presenter.applyPropertiesUserOptionsChange(testOptions);
+    expect(presenter.getUserOptions()).toEqual(testOptions);
+  });
+
+  it('updates highlighted property', () => {
+    expect(presenter.getHighlightedProperty()).toEqual('');
+    const id = '4';
+    presenter.applyHighlightedPropertyChange(id);
+    expect(presenter.getHighlightedProperty()).toEqual(id);
+    presenter.applyHighlightedPropertyChange(id);
+    expect(presenter.getHighlightedProperty()).toEqual('');
+  });
+
+  it('updates properties tree to show diffs based on user option', async () => {
+    let formattedTree = await getFormattedTree(hTree);
+    expect(getDiff(formattedTree, 'setProp')).toEqual(DiffType.NONE);
+    expect(getDiff(formattedTree, 'otherProp')).toEqual(DiffType.NONE);
+
+    presenter.applyPropertiesUserOptionsChange({
+      showDiff: {name: '', enabled: true},
+    });
+    formattedTree = await getFormattedTree();
+    expect(getDiff(formattedTree, 'setProp')).toEqual(DiffType.ADDED);
+    expect(getDiff(formattedTree, 'otherProp')).toEqual(DiffType.ADDED);
+
+    formattedTree = await getFormattedTree(hTree);
+    formattedTree = assertDefined(presenter.getFormattedTree());
+    expect(getDiff(formattedTree, 'setProp')).toEqual(DiffType.MODIFIED);
+    expect(getDiff(formattedTree, 'otherProp')).toEqual(DiffType.ADDED);
+  });
+
+  it('shows/hides defaults based on user option', async () => {
+    expect((await getFormattedTree()).getAllChildren().length).toEqual(2);
+    presenter.applyPropertiesUserOptionsChange({
+      showDefaults: {name: '', enabled: true},
+    });
+    expect((await getFormattedTree()).getAllChildren().length).toEqual(3);
+  });
+
+  it('filters properties tree', async () => {
+    expect((await getFormattedTree()).getAllChildren().length).toEqual(2);
+    const filter = new TextFilter('setProp');
+    presenter.applyPropertiesFilterChange(filter);
+    expect(presenter.getTextFilter()).toEqual(filter);
+    expect((await getFormattedTree()).getAllChildren().length).toEqual(1);
+  });
+
+  it('keeps calculated properties', async () => {
+    const tree = await getFormattedTree(undefined, undefined, true);
+    expect(tree.getAllChildren().length).toEqual(3);
+  });
+
+  it('overrides display name', async () => {
+    const tree = await getFormattedTree(undefined, 'Override Name');
+    expect(tree.getDisplayName()).toEqual('Override Name');
+  });
+
+  it('keeps allowlist default properties', async () => {
+    presenter.updateDefaultAllowList(['defProp']);
+    expect((await getFormattedTree()).getChildByName('defProp')).toBeDefined();
+  });
+
+  it('discards denylist properties', async () => {
+    presenter = new PropertiesPresenter({}, new TextFilter(), ['setProp']);
+    presenter.setPropertiesTree(pTree);
+    const tree = await getFormattedTree();
+    expect(tree.getChildByName('setProp')).toBeUndefined();
+  });
+
+  it('applies custom operations', async () => {
+    const operation = jasmine.createSpyObj('operation', ['apply']);
+    presenter = new PropertiesPresenter({}, new TextFilter(), [], [operation]);
+    presenter.setPropertiesTree(pTree);
+    await getFormattedTree();
+    expect(operation.apply).toHaveBeenCalledTimes(1);
+  });
+
+  function getDiff(tree: UiPropertyTreeNode, propertyName: string): DiffType {
+    return assertDefined(tree.getChildByName(propertyName)).getDiff();
+  }
+
+  async function getFormattedTree(
+    previousHierarchyTree?: HierarchyTreeNode,
+    displayName?: string,
+    keepCalculated = false,
+  ): Promise<UiPropertyTreeNode> {
+    await presenter.formatPropertiesTree(
+      previousHierarchyTree,
+      displayName,
+      keepCalculated,
+    );
+    return assertDefined(presenter.getFormattedTree());
+  }
+});
diff --git a/tools/winscope/src/viewers/common/scroll_component_tests.ts b/tools/winscope/src/viewers/common/scroll_component_tests.ts
index 15d65e0b8..914b5806d 100644
--- a/tools/winscope/src/viewers/common/scroll_component_tests.ts
+++ b/tools/winscope/src/viewers/common/scroll_component_tests.ts
@@ -11,7 +11,7 @@
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
- * limitations under the License.d
+ * limitations under the License.
  */
 
 import {CdkVirtualScrollViewport} from '@angular/cdk/scrolling';
@@ -20,8 +20,12 @@ import {assertDefined} from 'common/assert_utils';
 import {animationFrameScheduler} from 'rxjs';
 import {ViewerProtologComponent} from 'viewers/viewer_protolog/viewer_protolog_component';
 import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_transactions_component';
+import {ViewerTransitionsComponent} from 'viewers/viewer_transitions/viewer_transitions_component';
 
-type ScrollComponent = ViewerProtologComponent | ViewerTransactionsComponent;
+type ScrollComponent =
+  | ViewerProtologComponent
+  | ViewerTransactionsComponent
+  | ViewerTransitionsComponent;
 
 export function executeScrollComponentTests(
   setUpTestEnvironment: () => Promise<
diff --git a/tools/winscope/src/viewers/common/string_filter_predicate.ts b/tools/winscope/src/viewers/common/string_filter_predicate.ts
new file mode 100644
index 000000000..a8e9f3811
--- /dev/null
+++ b/tools/winscope/src/viewers/common/string_filter_predicate.ts
@@ -0,0 +1,17 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export type StringFilterPredicate = (value: string) => boolean;
diff --git a/tools/winscope/src/viewers/common/text_filter.ts b/tools/winscope/src/viewers/common/text_filter.ts
index 3be558e64..d4dece84d 100644
--- a/tools/winscope/src/viewers/common/text_filter.ts
+++ b/tools/winscope/src/viewers/common/text_filter.ts
@@ -15,7 +15,66 @@
  */
 
 import {FilterFlag} from 'common/filter_flag';
+import {StringUtils} from 'common/string_utils';
+import {StringFilterPredicate} from 'viewers/common/string_filter_predicate';
 
 export class TextFilter {
-  constructor(public filterString: string, public flags: FilterFlag[]) {}
+  constructor(
+    public filterString: string = '',
+    public flags: FilterFlag[] = [],
+  ) {}
+
+  getFilterPredicate(): StringFilterPredicate {
+    const matchCase = this.flags.includes(FilterFlag.MATCH_CASE);
+    const matchWord = this.flags.includes(FilterFlag.MATCH_WORD);
+    const useRegex = this.flags.includes(FilterFlag.USE_REGEX);
+
+    if (useRegex) {
+      const regexFlags = useRegex && !matchCase ? 'i' : '';
+      const regexString = matchWord
+        ? '\\b(?:' + this.filterString + ')\\b'
+        : this.filterString;
+      try {
+        const regex = new RegExp(regexString, regexFlags);
+        return (entryString: string) => {
+          if (this.filterString.length === 0) return true;
+          return regex.test(entryString);
+        };
+      } catch (e) {
+        return (entryString: string) => false;
+      }
+    } else {
+      const testString = matchCase
+        ? this.filterString
+        : this.filterString.toLowerCase();
+      return (entryString: string) => {
+        if (this.filterString.length === 0) return true;
+
+        let entrySubstring = matchCase
+          ? entryString
+          : entryString.toLowerCase();
+        let testStringIndex = entrySubstring.indexOf(testString);
+
+        while (testStringIndex !== -1) {
+          if (!matchWord) return true;
+
+          const nextChar = entrySubstring.at(
+            testStringIndex + testString.length,
+          );
+          if (
+            nextChar === undefined ||
+            !(StringUtils.isAlpha(nextChar) || StringUtils.isDigit(nextChar))
+          ) {
+            return true;
+          }
+
+          entrySubstring = entrySubstring.slice(
+            testStringIndex + testString.length,
+          );
+          testStringIndex = entrySubstring.indexOf(testString);
+        }
+        return false;
+      };
+    }
+  }
 }
diff --git a/tools/winscope/src/common/filter_flag_test.ts b/tools/winscope/src/viewers/common/text_filter_test.ts
similarity index 73%
rename from tools/winscope/src/common/filter_flag_test.ts
rename to tools/winscope/src/viewers/common/text_filter_test.ts
index a55882704..2dee1ca87 100644
--- a/tools/winscope/src/common/filter_flag_test.ts
+++ b/tools/winscope/src/viewers/common/text_filter_test.ts
@@ -14,18 +14,24 @@
  * limitations under the License.
  */
 
-import {FilterFlag, makeFilterPredicate} from './filter_flag';
+import {FilterFlag} from 'common/filter_flag';
+import {TextFilter} from './text_filter';
 
-describe('makeFilterPredicate', () => {
+describe('TextFilter', () => {
   it('with empty filter string', () => {
-    const predicate = makeFilterPredicate('', []);
+    const predicate = new TextFilter().getFilterPredicate();
     expect(predicate('')).toBeTrue();
     expect(predicate('foobar')).toBeTrue();
     expect(predicate(' ')).toBeTrue();
+
+    const predicateWithRegex = new TextFilter('', [
+      FilterFlag.USE_REGEX,
+    ]).getFilterPredicate();
+    expect(predicateWithRegex('')).toBeTrue();
   });
 
   it('without flags', () => {
-    const predicate = makeFilterPredicate('foo', []);
+    const predicate = new TextFilter('foo').getFilterPredicate();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('Foo')).toBeTrue();
     expect(predicate('foobar')).toBeTrue();
@@ -33,20 +39,26 @@ describe('makeFilterPredicate', () => {
     expect(predicate('fo o')).toBeFalse();
 
     // does not interpret regex
-    const predicateWithRegexExp = makeFilterPredicate('foo|bar', []);
+    const predicateWithRegexExp = new TextFilter(
+      'foo|bar',
+    ).getFilterPredicate();
     expect(predicateWithRegexExp('foo')).toBeFalse();
     expect(predicateWithRegexExp('foo|bar')).toBeTrue();
   });
 
   it('with MATCH_CASE', () => {
-    const predicate = makeFilterPredicate('Foo', [FilterFlag.MATCH_CASE]);
+    const predicate = new TextFilter('Foo', [
+      FilterFlag.MATCH_CASE,
+    ]).getFilterPredicate();
     expect(predicate('Foo')).toBeTrue();
     expect(predicate('Foobar')).toBeTrue();
     expect(predicate('foo')).toBeFalse();
   });
 
   it('with MATCH_WORD', () => {
-    const predicate = makeFilterPredicate('Foo', [FilterFlag.MATCH_WORD]);
+    const predicate = new TextFilter('Foo', [
+      FilterFlag.MATCH_WORD,
+    ]).getFilterPredicate();
     expect(predicate('Foo')).toBeTrue();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('Foo.bar')).toBeTrue();
@@ -57,16 +69,18 @@ describe('makeFilterPredicate', () => {
   });
 
   it('with USE_REGEX', () => {
-    const predicate = makeFilterPredicate('foo|bar', [FilterFlag.USE_REGEX]);
+    const predicate = new TextFilter('foo|bar', [
+      FilterFlag.USE_REGEX,
+    ]).getFilterPredicate();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('bar')).toBeTrue();
     expect(predicate('Foo')).toBeTrue();
     expect(predicate('foobar')).toBeTrue();
     expect(predicate('foo123bar123')).toBeTrue();
 
-    const predicateWithInvalidRegex = makeFilterPredicate('foo|bar)', [
+    const predicateWithInvalidRegex = new TextFilter('foo|bar)', [
       FilterFlag.USE_REGEX,
-    ]);
+    ]).getFilterPredicate();
     expect(predicateWithInvalidRegex('foo')).toBeFalse();
     expect(predicateWithInvalidRegex('bar')).toBeFalse();
     expect(predicateWithInvalidRegex('Foo')).toBeFalse();
@@ -75,30 +89,30 @@ describe('makeFilterPredicate', () => {
   });
 
   it('with MATCH_CASE and MATCH_WORD', () => {
-    const predicate = makeFilterPredicate('foo', [
+    const predicate = new TextFilter('foo', [
       FilterFlag.MATCH_CASE,
       FilterFlag.MATCH_WORD,
-    ]);
+    ]).getFilterPredicate();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('Foo')).toBeFalse();
     expect(predicate('Foobar')).toBeFalse();
   });
 
   it('with MATCH_CASE and USE_REGEX', () => {
-    const predicate = makeFilterPredicate('foo|bar', [
+    const predicate = new TextFilter('foo|bar', [
       FilterFlag.MATCH_CASE,
       FilterFlag.USE_REGEX,
-    ]);
+    ]).getFilterPredicate();
     expect(predicate('bar')).toBeTrue();
     expect(predicate('foobar')).toBeTrue();
     expect(predicate('Bar')).toBeFalse();
   });
 
   it('with MATCH_WORD and USE_REGEX', () => {
-    const predicate = makeFilterPredicate('foo|bar', [
+    const predicate = new TextFilter('foo|bar', [
       FilterFlag.MATCH_WORD,
       FilterFlag.USE_REGEX,
-    ]);
+    ]).getFilterPredicate();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('Bar')).toBeTrue();
     expect(predicate('123 Bar')).toBeTrue();
@@ -107,11 +121,11 @@ describe('makeFilterPredicate', () => {
   });
 
   it('with MATCH_CASE, MATCH_WORD and USE_REGEX', () => {
-    const predicate = makeFilterPredicate('foo|bar', [
+    const predicate = new TextFilter('foo|bar', [
       FilterFlag.MATCH_CASE,
       FilterFlag.MATCH_WORD,
       FilterFlag.USE_REGEX,
-    ]);
+    ]).getFilterPredicate();
     expect(predicate('foo')).toBeTrue();
     expect(predicate('123 bar')).toBeTrue();
 
diff --git a/tools/winscope/src/viewers/common/ui_data_hierarchy.ts b/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
index b99419f2a..572daf2f9 100644
--- a/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
+++ b/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
@@ -14,12 +14,12 @@
  * limitations under the License.
  */
 
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 import {UiRect} from 'viewers/components/rects/ui_rect';
 import {DisplayIdentifier} from './display_identifier';
 import {RectShowState} from './rect_show_state';
-import {TextFilter} from './text_filter';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 
 export interface UiDataHierarchy {
diff --git a/tools/winscope/src/viewers/common/ui_data_log.ts b/tools/winscope/src/viewers/common/ui_data_log.ts
index 5bb05c5ad..9052e86d3 100644
--- a/tools/winscope/src/viewers/common/ui_data_log.ts
+++ b/tools/winscope/src/viewers/common/ui_data_log.ts
@@ -17,131 +17,45 @@
 import {Timestamp} from 'common/time';
 import {TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UserOptions} from 'viewers/common/user_options';
-import {TextFilter} from './text_filter';
+import {LogFilter} from './log_filters';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 
 export interface UiDataLog {
   entries: LogEntry[];
   selectedIndex: undefined | number;
   scrollToIndex: undefined | number;
+  currentIndex: undefined | number;
 
-  filters?: LogFilter[];
-  headers?: LogFieldType[];
-  currentIndex?: undefined | number;
+  headers: LogHeader[];
   propertiesTree?: undefined | UiPropertyTreeNode;
   propertiesUserOptions?: UserOptions;
   propertiesFilter?: TextFilter;
   isDarkMode?: boolean;
 }
 
-export interface LogFilter {
-  type: LogFieldType;
-  options?: string[];
-  textFilter?: TextFilter;
+export interface ColumnSpec {
+  name: string;
+  cssClass: string;
+}
+
+export class LogHeader {
+  constructor(public spec: ColumnSpec, public filter?: LogFilter) {}
 }
 
 export interface LogEntry {
-  traceEntry: TraceEntry<PropertyTreeNode>;
+  traceEntry: TraceEntry<object>;
   fields: LogField[];
   propertiesTree?: undefined | PropertyTreeNode;
 }
 
 export interface LogField {
-  type: LogFieldType;
+  spec: ColumnSpec;
   value: LogFieldValue;
   icon?: string;
   iconColor?: string;
+  propagateEntryTimestamp?: boolean;
 }
 
 export type LogFieldValue = string | number | Timestamp;
-
-export enum LogFieldType {
-  TRANSACTION_ID,
-  VSYNC_ID,
-  PID,
-  UID,
-  TRANSACTION_TYPE,
-  LAYER_OR_DISPLAY_ID,
-  FLAGS,
-  LOG_LEVEL,
-  TAG,
-  SOURCE_FILE,
-  TEXT,
-  TRANSITION_ID,
-  TRANSITION_TYPE,
-  SEND_TIME,
-  DISPATCH_TIME,
-  DURATION,
-  STATUS,
-  CUJ_TYPE,
-  START_TIME,
-  END_TIME,
-  INPUT_TYPE,
-  INPUT_SOURCE,
-  INPUT_ACTION,
-  INPUT_DEVICE_ID,
-  INPUT_DISPLAY_ID,
-  INPUT_EVENT_DETAILS,
-  INPUT_DISPATCH_WINDOWS,
-}
-
-export const LogFieldNames: ReadonlyMap<LogFieldType, string> = new Map([
-  [LogFieldType.TRANSACTION_ID, 'TX ID'],
-  [LogFieldType.VSYNC_ID, 'VSYNC ID'],
-  [LogFieldType.PID, 'PID'],
-  [LogFieldType.UID, 'UID'],
-  [LogFieldType.TRANSACTION_TYPE, 'TYPE'],
-  [LogFieldType.LAYER_OR_DISPLAY_ID, 'LAYER/DISP ID'],
-  [LogFieldType.FLAGS, 'Flags'],
-  [LogFieldType.LOG_LEVEL, 'Log level'],
-  [LogFieldType.TAG, 'Tag'],
-  [LogFieldType.SOURCE_FILE, 'Source files'],
-  [LogFieldType.TEXT, 'Search text'],
-  [LogFieldType.TRANSITION_ID, 'Id'],
-  [LogFieldType.TRANSITION_TYPE, 'Type'],
-  [LogFieldType.SEND_TIME, 'Send Time'],
-  [LogFieldType.DISPATCH_TIME, 'Dispatch Time'],
-  [LogFieldType.DURATION, 'Duration'],
-  [LogFieldType.STATUS, 'Status'],
-  [LogFieldType.CUJ_TYPE, 'Type'],
-  [LogFieldType.START_TIME, 'Start Time'],
-  [LogFieldType.END_TIME, 'End Time'],
-  [LogFieldType.INPUT_TYPE, 'Type'],
-  [LogFieldType.INPUT_SOURCE, 'Source'],
-  [LogFieldType.INPUT_ACTION, 'Action'],
-  [LogFieldType.INPUT_DEVICE_ID, 'Device'],
-  [LogFieldType.INPUT_DISPLAY_ID, 'Display'],
-  [LogFieldType.INPUT_EVENT_DETAILS, 'Details'],
-  [LogFieldType.INPUT_DISPATCH_WINDOWS, 'Target Windows'],
-]);
-
-export const LogFieldClassNames: ReadonlyMap<LogFieldType, string> = new Map([
-  [LogFieldType.TRANSACTION_ID, 'transaction-id right-align'],
-  [LogFieldType.VSYNC_ID, 'vsyncid right-align'],
-  [LogFieldType.PID, 'pid right-align'],
-  [LogFieldType.UID, 'uid right-align'],
-  [LogFieldType.TRANSACTION_TYPE, 'transaction-type'],
-  [LogFieldType.LAYER_OR_DISPLAY_ID, 'layer-or-display-id right-align'],
-  [LogFieldType.FLAGS, 'flags'],
-  [LogFieldType.LOG_LEVEL, 'log-level'],
-  [LogFieldType.TAG, 'tag'],
-  [LogFieldType.SOURCE_FILE, 'source-file'],
-  [LogFieldType.TEXT, 'text'],
-  [LogFieldType.TRANSITION_ID, 'transition-id right-align'],
-  [LogFieldType.TRANSITION_TYPE, 'transition-type'],
-  [LogFieldType.CUJ_TYPE, 'jank_cuj-type'],
-  [LogFieldType.SEND_TIME, 'send-time time'],
-  [LogFieldType.DISPATCH_TIME, 'dispatch-time time'],
-  [LogFieldType.START_TIME, 'start-time time'],
-  [LogFieldType.END_TIME, 'end-time time'],
-  [LogFieldType.DURATION, 'duration right-align'],
-  [LogFieldType.STATUS, 'status right-align'],
-  [LogFieldType.INPUT_TYPE, 'input-type inline'],
-  [LogFieldType.INPUT_SOURCE, 'input-source'],
-  [LogFieldType.INPUT_ACTION, 'input-action'],
-  [LogFieldType.INPUT_DEVICE_ID, 'input-device-id right-align'],
-  [LogFieldType.INPUT_DISPLAY_ID, 'input-display-id right-align'],
-  [LogFieldType.INPUT_EVENT_DETAILS, 'input-details'],
-  [LogFieldType.INPUT_DISPATCH_WINDOWS, 'input-windows'],
-]);
diff --git a/tools/winscope/src/viewers/common/ui_hierarchy_tree_node.ts b/tools/winscope/src/viewers/common/ui_hierarchy_tree_node.ts
index 6a311e9ca..3d922dfd7 100644
--- a/tools/winscope/src/viewers/common/ui_hierarchy_tree_node.ts
+++ b/tools/winscope/src/viewers/common/ui_hierarchy_tree_node.ts
@@ -43,11 +43,17 @@ export class UiHierarchyTreeNode extends HierarchyTreeNode implements DiffNode {
     const zParent = node.getZParent();
     if (zParent) displayNode.setZParent(zParent);
 
+    node
+      .getRelativeChildren()
+      .forEach((zChild) => displayNode.addRelativeChild(zChild));
+
     node.getAllChildren().forEach((child) => {
       displayNode.addOrReplaceChild(
         UiHierarchyTreeNode.from(child, displayNode),
       );
     });
+    node.getWarnings().forEach((warning) => displayNode.addWarning(warning));
+
     return displayNode;
   }
 
diff --git a/tools/winscope/src/viewers/common/ui_tree_utils.ts b/tools/winscope/src/viewers/common/ui_tree_utils.ts
index 6baedd871..46208adcf 100644
--- a/tools/winscope/src/viewers/common/ui_tree_utils.ts
+++ b/tools/winscope/src/viewers/common/ui_tree_utils.ts
@@ -14,12 +14,12 @@
  * limitations under the License.
  */
 
-import {FilterFlag, makeFilterPredicate} from 'common/filter_flag';
 import {
   PropertySource,
   PropertyTreeNode,
 } from 'trace/tree_node/property_tree_node';
 import {TreeNode} from 'trace/tree_node/tree_node';
+import {StringFilterPredicate} from 'viewers/common/string_filter_predicate';
 import {DiffType} from './diff_type';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
@@ -55,11 +55,7 @@ export class UiTreeUtils {
     );
   };
 
-  static makeNodeFilter(
-    filterString: string,
-    flags: FilterFlag[] = [],
-  ): TreeNodeFilter {
-    const predicate = makeFilterPredicate(filterString, flags);
+  static makeNodeFilter(predicate: StringFilterPredicate): TreeNodeFilter {
     return (node: TreeNode) => {
       return (
         predicate(node.id) ||
diff --git a/tools/winscope/src/viewers/common/viewer_events.ts b/tools/winscope/src/viewers/common/viewer_events.ts
index 778a31b8a..0341ea7c7 100644
--- a/tools/winscope/src/viewers/common/viewer_events.ts
+++ b/tools/winscope/src/viewers/common/viewer_events.ts
@@ -16,9 +16,9 @@
 
 import {Timestamp} from 'common/time';
 import {TraceEntry} from 'trace/trace';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TextFilter} from './text_filter';
-import {LogFieldType} from './ui_data_log';
+import {TextFilter} from 'viewers/common/text_filter';
+import {Search} from 'viewers/viewer_search/ui_data';
+import {LogHeader} from './ui_data_log';
 
 export enum ViewerEvents {
   HighlightedNodeChange = 'HighlightedNodeChange',
@@ -31,6 +31,7 @@ export enum ViewerEvents {
 
   PropertiesUserOptionsChange = 'PropertiesUserOptionsChange',
   PropertiesFilterChange = 'PropertiesFilterChange',
+  DispatchPropertiesFilterChange = 'DispatchPropertiesFilterChange',
   HighlightedPropertyChange = 'HighlightedPropertyChange',
 
   RectsUserOptionsChange = 'RectsUserOptionsChange',
@@ -45,6 +46,11 @@ export enum ViewerEvents {
   LogTextFilterChange = 'LogTextFilterChange',
   ArrowDownPress = 'ArrowDownPress',
   ArrowUpPress = 'ArrowUpPress',
+
+  GlobalSearchSectionClick = 'GlobalSearchSectionClick',
+  SearchQueryClick = 'SearchQueryClick',
+  SaveQueryClick = 'SaveQueryClick',
+  DeleteSavedQueryClick = 'DeleteSavedQueryClick',
 }
 
 export class RectDblClickDetail {
@@ -53,15 +59,27 @@ export class RectDblClickDetail {
 
 export class TimestampClickDetail {
   constructor(
-    public entry?: TraceEntry<PropertyTreeNode>,
+    public entry?: TraceEntry<object>,
     public timestamp?: Timestamp,
   ) {}
 }
 
 export class LogFilterChangeDetail {
-  constructor(public type: LogFieldType, public value: string[] | string) {}
+  constructor(public header: LogHeader, public value: string[]) {}
 }
 
 export class LogTextFilterChangeDetail {
-  constructor(public type: LogFieldType, public filter: TextFilter) {}
+  constructor(public header: LogHeader, public filter: TextFilter) {}
+}
+
+export class QueryClickDetail {
+  constructor(public query: string) {}
+}
+
+export class SaveQueryClickDetail {
+  constructor(public query: string, public name: string) {}
+}
+
+export class DeleteSavedQueryClickDetail {
+  constructor(public search: Search) {}
 }
diff --git a/tools/winscope/src/viewers/components/collapsible_section_title_component.ts b/tools/winscope/src/viewers/components/collapsible_section_title_component.ts
index 129f63637..343d67eae 100644
--- a/tools/winscope/src/viewers/components/collapsible_section_title_component.ts
+++ b/tools/winscope/src/viewers/components/collapsible_section_title_component.ts
@@ -34,12 +34,12 @@ import {Component, EventEmitter, Input, Output} from '@angular/core';
         flex-direction: row;
       }
       :host button {
-        padding-top: 4px;
+        padding-top: 8px;
         margin-right: 4px;
         width: 24px;
       }
       .mat-title {
-        padding-top: 8px;
+        padding-top: 12px;
       }
     `,
   ],
diff --git a/tools/winscope/src/viewers/components/coordinates_table_component_test.ts b/tools/winscope/src/viewers/components/coordinates_table_component_test.ts
index 5f0532493..1b7f54887 100644
--- a/tools/winscope/src/viewers/components/coordinates_table_component_test.ts
+++ b/tools/winscope/src/viewers/components/coordinates_table_component_test.ts
@@ -24,7 +24,6 @@ describe('CoordinatesTableComponent', () => {
   beforeAll(async () => {
     await TestBed.configureTestingModule({
       declarations: [CoordinatesTableComponent],
-      schemas: [],
     }).compileComponents();
   });
 
diff --git a/tools/winscope/src/viewers/components/hierarchy_component.ts b/tools/winscope/src/viewers/components/hierarchy_component.ts
index be78859e5..f5a2f37a8 100644
--- a/tools/winscope/src/viewers/components/hierarchy_component.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_component.ts
@@ -45,6 +45,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
           title="HIERARCHY"
           (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
         <search-box
+          formFieldClass="applied-field"
           [textFilter]="textFilter"
           (filterChange)="onFilterChange($event)"></search-box>
       </div>
@@ -55,6 +56,16 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         [traceType]="dependencies[0]"
         [logCallback]="Analytics.Navigation.logHierarchySettingsChanged">
       </user-options>
+      <ng-container *ngIf="tree && tree.getWarnings().length > 0">
+        <span
+          *ngFor="let warning of tree.getWarnings()"
+          class="mat-body-1 warning"
+          [matTooltip]="warning.getMessage()"
+          [matTooltipDisabled]="disableTooltip(warningEl)">
+          <mat-icon class="warning-icon"> warning </mat-icon>
+          <span class="warning-message" #warningEl>{{warning.getMessage()}}</span>
+        </span>
+      </ng-container>
       <properties-table
         *ngIf="tableProperties"
         class="properties-table"
@@ -62,7 +73,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       <div *ngIf="pinnedItems.length > 0" class="pinned-items">
         <tree-node
           *ngFor="let pinnedItem of pinnedItems"
-          class="node"
+          class="node full-opacity"
           [class]="pinnedItem.getDiff()"
           [class.selected]="isHighlighted(pinnedItem, highlightedItem)"
           [class.clickable]="true"
@@ -133,6 +144,25 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       tree-view {
         overflow: auto;
       }
+
+      .warning {
+        display: flex;
+        align-items: center;
+        padding: 2px 12px;
+        background-color: var(--warning-background-color);
+      }
+      .warning-message {
+        padding-inline-start: 2px;
+        white-space: nowrap;
+        overflow: hidden;
+        text-overflow: ellipsis;
+        width: 100%;
+      }
+      .warning-icon {
+        font-size: 18px;
+        min-width: 18px;
+        height: 18px;
+      }
     `,
     nodeStyles,
     viewerCardInnerStyle,
@@ -202,4 +232,8 @@ export class HierarchyComponent {
     });
     this.elementRef.nativeElement.dispatchEvent(event);
   }
+
+  disableTooltip(el: HTMLElement) {
+    return el.scrollWidth === el.clientWidth;
+  }
 }
diff --git a/tools/winscope/src/viewers/components/hierarchy_component_test.ts b/tools/winscope/src/viewers/components/hierarchy_component_test.ts
index bbb28f0b4..638b33a64 100644
--- a/tools/winscope/src/viewers/components/hierarchy_component_test.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_component_test.ts
@@ -31,6 +31,7 @@ import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {FilterFlag} from 'common/filter_flag';
 import {PersistentStore} from 'common/persistent_store';
+import {DuplicateLayerIds, MissingLayerIds} from 'messaging/user_warnings';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceType} from 'trace/trace_type';
 import {TextFilter} from 'viewers/common/text_filter';
@@ -95,7 +96,7 @@ describe('HierarchyComponent', () => {
         isUnavailable: false,
       },
     };
-    component.textFilter = new TextFilter('', []);
+    component.textFilter = new TextFilter();
     component.dependencies = [TraceType.SURFACE_FLINGER];
 
     fixture.detectChanges();
@@ -231,4 +232,50 @@ describe('HierarchyComponent', () => {
     fixture.detectChanges();
     expect(spy).toHaveBeenCalled();
   });
+
+  it('shows warnings', () => {
+    expect(htmlElement.querySelectorAll('.warning').length).toEqual(0);
+
+    const warning1 = new DuplicateLayerIds([123]);
+    component.tree?.addWarning(warning1);
+    const warning2 = new MissingLayerIds();
+    component.tree?.addWarning(warning2);
+    fixture.detectChanges();
+    const warnings = htmlElement.querySelectorAll('.warning');
+    expect(warnings.length).toEqual(2);
+    expect(warnings[0].textContent?.trim()).toEqual(
+      'warning ' + warning1.getMessage(),
+    );
+    expect(warnings[1].textContent?.trim()).toEqual(
+      'warning ' + warning2.getMessage(),
+    );
+  });
+
+  it('shows warning tooltip if text overflowing', () => {
+    const warning = new DuplicateLayerIds([123]);
+    component.tree?.addWarning(warning);
+    fixture.detectChanges();
+
+    const warningEl = assertDefined(htmlElement.querySelector('.warning'));
+    const msgEl = assertDefined(warningEl.querySelector('.warning-message'));
+
+    const spy = spyOnProperty(msgEl, 'scrollWidth').and.returnValue(
+      msgEl.clientWidth,
+    );
+    warningEl.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+    ).toBeNull();
+    warningEl.dispatchEvent(new Event('mouseleave'));
+    fixture.detectChanges();
+
+    spy.and.returnValue(msgEl.clientWidth + 1);
+    fixture.detectChanges();
+    warningEl.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel')?.textContent,
+    ).toEqual(warning.getMessage());
+  });
 });
diff --git a/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component.ts b/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component.ts
index a7a4384c4..e8378e130 100644
--- a/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component.ts
@@ -24,7 +24,7 @@ import {hierarchyTreeNodeDataViewStyles} from 'viewers/components/styles/tree_no
     <span class="mat-body-1" *ngIf="node">
       <span class="mat-body-2" *ngIf="node.heading()">{{ node.heading() }}</span>
       <ng-container *ngIf="node.heading()">&ngsp;-&ngsp;</ng-container>
-      <span>{{ node.getDisplayName() }}</span>
+      <span class="display-name" [matTooltip]="getNameTooltip()" [matTooltipShowDelay]="300">{{ node.getDisplayName() }}</span>
       <div *ngFor="let chip of node.getChips()" [class]="chipClass(chip)" [matTooltip]="chip.long">
         {{ chip.short }}
       </div>
@@ -35,6 +35,13 @@ import {hierarchyTreeNodeDataViewStyles} from 'viewers/components/styles/tree_no
 export class HierarchyTreeNodeDataViewComponent {
   @Input() node?: UiHierarchyTreeNode;
 
+  getNameTooltip(): string | undefined {
+    if (this.node?.name !== this.node?.getDisplayName()) {
+      return this.node?.name;
+    }
+    return undefined;
+  }
+
   chipClass(chip: Chip) {
     return [
       'tree-view-internal-chip',
diff --git a/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component_test.ts b/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component_test.ts
index 395d3d53d..3812c82c4 100644
--- a/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component_test.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_tree_node_data_view_component_test.ts
@@ -13,32 +13,79 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {
-  ComponentFixture,
-  ComponentFixtureAutoDetect,
-  TestBed,
-} from '@angular/core/testing';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
 import {MatTooltipModule} from '@angular/material/tooltip';
+import {assertDefined} from 'common/assert_utils';
+import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {HierarchyTreeNodeDataViewComponent} from './hierarchy_tree_node_data_view_component';
 
 describe('HierarchyTreeNodeDataViewComponent', () => {
+  let testNode: UiHierarchyTreeNode;
   let fixture: ComponentFixture<HierarchyTreeNodeDataViewComponent>;
   let component: HierarchyTreeNodeDataViewComponent;
+  let htmlElement: HTMLElement;
 
-  beforeAll(async () => {
+  beforeEach(async () => {
     await TestBed.configureTestingModule({
-      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
       declarations: [HierarchyTreeNodeDataViewComponent],
       imports: [MatTooltipModule],
     }).compileComponents();
-  });
-
-  beforeEach(() => {
     fixture = TestBed.createComponent(HierarchyTreeNodeDataViewComponent);
     component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    fixture.detectChanges();
+
+    testNode = TreeNodeUtils.makeUiHierarchyNode({
+      id: 1,
+      name: 'test node',
+    });
   });
 
-  it('can be created', () => {
+  it('is robust to no node', () => {
     expect(component).toBeTruthy();
   });
+
+  it('shows node heading if set', () => {
+    component.node = testNode;
+    fixture.detectChanges();
+    expect(htmlElement.textContent).toEqual('1 - test node');
+    testNode.setShowHeading(false);
+    fixture.detectChanges();
+    expect(htmlElement.textContent).toEqual('test node');
+  });
+
+  it('shows display name if set, with full name on hover', () => {
+    testNode.setDisplayName('display name');
+    component.node = testNode;
+    fixture.detectChanges();
+    expect(htmlElement.textContent).toEqual('1 - display name');
+    const displayName = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.display-name'),
+    );
+    checkTooltip(displayName, 'test node');
+  });
+
+  it('shows chips with tooltip on hover', () => {
+    testNode.addChip(VISIBLE_CHIP);
+    component.node = testNode;
+    fixture.detectChanges();
+    expect(htmlElement.textContent?.trim()).toEqual(
+      `1 - test node ${VISIBLE_CHIP.short}`,
+    );
+    const chip = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.tree-view-chip'),
+    );
+    checkTooltip(chip, VISIBLE_CHIP.long);
+  });
+
+  function checkTooltip(triggerElement: HTMLElement, expectedText: string) {
+    triggerElement.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    const tooltipPanel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+    );
+    expect(tooltipPanel.textContent?.trim()).toEqual(expectedText);
+  }
 });
diff --git a/tools/winscope/src/viewers/common/log_component.ts b/tools/winscope/src/viewers/components/log_component.ts
similarity index 69%
rename from tools/winscope/src/viewers/common/log_component.ts
rename to tools/winscope/src/viewers/components/log_component.ts
index 28a63a473..f9441fa7f 100644
--- a/tools/winscope/src/viewers/common/log_component.ts
+++ b/tools/winscope/src/viewers/components/log_component.ts
@@ -27,9 +27,12 @@ import {
 } from '@angular/core';
 import {MatSelectChange} from '@angular/material/select';
 
+import {DOMUtils} from 'common/dom_utils';
 import {Timestamp, TimestampFormatType} from 'common/time';
 import {TimeUtils} from 'common/time_utils';
 import {TraceType} from 'trace/trace_type';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogEntry, LogField, LogHeader} from 'viewers/common/ui_data_log';
 import {
   LogFilterChangeDetail,
   LogTextFilterChangeDetail,
@@ -47,15 +50,6 @@ import {
   viewerCardInnerStyle,
   viewerCardStyle,
 } from 'viewers/components/styles/viewer_card.styles';
-import {TextFilter} from './text_filter';
-import {
-  LogEntry,
-  LogField,
-  LogFieldClassNames,
-  LogFieldNames,
-  LogFieldType,
-  LogFilter,
-} from './ui_data_log';
 
 @Component({
   selector: 'log-view',
@@ -67,16 +61,17 @@ import {
             [title]="title"
             (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
 
-        <div class="filters" *ngIf="showFiltersInTitle && filters.length > 0">
-          <div class="filter" *ngFor="let filter of filters"
-               [class]="getLogFieldClass(filter.type)">
+        <div class="filters" *ngIf="showFiltersInTitle && getHeadersWithFilters().length > 0">
+          <div class="filter" *ngFor="let header of getHeadersWithFilters()"
+               [class]="header.spec.cssClass">
             <select-with-filter
-                *ngIf="filter.options?.length > 0"
-                [label]="getLogFieldName(filter.type)"
-                [options]="filter.options"
-                [outerFilterWidth]="getOuterFilterWidth(filter.type)"
-                [innerFilterWidth]="getInnerFilterWidth(filter.type)"
-                (selectChange)="onFilterChange($event, filter.type)">
+                *ngIf="(header.filter.options?.length ?? 0) > 0"
+                [label]="header.spec.name"
+                [options]="header.filter.options"
+                [outerFilterWidth]="header.filter.outerFilterWidthCss"
+                [innerFilterWidth]="header.filter.innerFilterWidthCss"
+                formFieldClass="no-border-top-field"
+                (selectChange)="onFilterChange($event, header)">
             </select-with-filter>
           </div>
         </div>
@@ -85,41 +80,54 @@ import {
 
     <div class="entries">
       <div class="headers table-header" *ngIf="headers.length > 0">
-        <div *ngFor="let header of headers" class="mat-body-2" [class]="getLogFieldClass(header)" [class.with-date]="areMultipleDatesPresent()">{{getLogFieldName(header)}}</div>
-      </div>
-
-      <div class="filters table-header" *ngIf="!showFiltersInTitle && filters.length > 0">
-        <div *ngIf="showTraceEntryTimes" class="time" [class.with-date]="areMultipleDatesPresent()">
+        <div *ngIf="showTraceEntryTimes" class="time">
           <button
               color="primary"
-              mat-stroked-button
-              class="go-to-current-time"
+              mat-button
+              class="time-button go-to-current-time"
               *ngIf="showCurrentTimeButton"
               (click)="onGoToCurrentTimeClick()">
             Go to Current Time
           </button>
         </div>
 
-        <div class="filter" *ngFor="let filter of filters" [class]="getLogFieldClass(filter.type)" [class.with-date]="areMultipleDatesPresent()">
-          <select-with-filter
-              *ngIf="filter.options?.length > 0"
-              [label]="getLogFieldName(filter.type)"
-              [options]="filter.options"
-              [outerFilterWidth]="getOuterFilterWidth(filter.type)"
-              [innerFilterWidth]="getInnerFilterWidth(filter.type)"
-              (selectChange)="onFilterChange($event, filter.type)">
-          </select-with-filter>
-
-          <search-box
-            *ngIf="filter.textFilter"
-            appearance="fill"
-            [textFilter]="filter.textFilter"
-            [fontSize]="12"
-            [wideField]="true"
-            [label]="getLogFieldName(filter.type)"
-            [filterName]="getLogFieldName(filter.type)"
-            (filterChange)="onSearchBoxChange($event, filter.type)"></search-box>
-        </div>
+        <ng-container *ngFor="let header of headers">
+          <div
+            *ngIf="!isHeaderWithFilter(header)"
+            class="mat-body-2 header"
+            [class]="header.spec.cssClass">
+          {{header.spec.name}}</div>
+
+          <div
+            *ngIf="isHeaderWithFilter(header) && !showFiltersInTitle"
+            class="filter mat-body-2"
+            [class]="header.spec.cssClass">
+            <select-with-filter
+                *ngIf="(header.filter.options?.length ?? 0) > 0"
+                [label]="header.spec.name"
+                [options]="header.filter.options"
+                [outerFilterWidth]="header.filter.outerFilterWidthCss"
+                [innerFilterWidth]="header.filter.innerFilterWidthCss"
+                appearance="none"
+                formFieldClass="no-padding-field"
+                (selectChange)="onFilterChange($event, header)">
+            </select-with-filter>
+
+            <search-box
+              *ngIf="header.filter.textFilter"
+              [textFilter]="header.filter.textFilter"
+              [label]="header.spec.name"
+              [filterName]="header.spec.name"
+              appearance="none"
+              [formFieldClass]="
+                'wide-field no-padding-field center-field '
+                 + header.spec.cssClass
+                 + (header.filter.textFilter.filterString?.length === 0 ? ' mat-body-2' : '')
+              "
+              height="fit-content"
+              (filterChange)="onSearchBoxChange($event, header)"></search-box>
+          </div>
+        </ng-container>
       </div>
 
       <div class="placeholder-text mat-body-1" *ngIf="entries.length === 0"> No entries found. </div>
@@ -146,6 +154,17 @@ import {
             [ngTemplateOutletContext]="{entry: entry, i: i}"> </ng-container>
       </cdk-virtual-scroll-viewport>
 
+      <cdk-virtual-scroll-viewport
+          *ngIf="isTransitions()"
+          transitionsVirtualScroll
+          class="scroll"
+          [scrollItems]="entries">
+        <ng-container
+            *cdkVirtualFor="let entry of entries; let i = index"
+            [ngTemplateOutlet]="content"
+            [ngTemplateOutletContext]="{entry: entry, i: i}"> </ng-container>
+      </cdk-virtual-scroll-viewport>
+
       <cdk-virtual-scroll-viewport
           *ngIf="isFixedSizeScrollViewport()"
           itemSize="36"
@@ -163,7 +182,7 @@ import {
             [class.current]="isCurrentEntry(i)"
             [class.selected]="isSelectedEntry(i)"
             (click)="onEntryClicked(i)">
-          <div *ngIf="showTraceEntryTimes" class="time" [class.with-date]="areMultipleDatesPresent()">
+          <div *ngIf="showTraceEntryTimes" class="time">
             <button
                 mat-button
                 class="time-button"
@@ -174,7 +193,7 @@ import {
             </button>
           </div>
 
-          <div [class]="getLogFieldClass(field.type)" [class.with-date]="areMultipleDatesPresent()" *ngFor="let field of entry.fields; index as i">
+          <div [class]="field.spec.cssClass" *ngFor="let field of entry.fields; index as i">
             <span class="mat-body-1" *ngIf="!showFieldButton(field)">{{ field.value }}</span>
             <button
                 *ngIf="showFieldButton(field)"
@@ -218,8 +237,7 @@ export class LogComponent {
   @Input() selectedIndex: number | undefined;
   @Input() scrollToIndex: number | undefined;
   @Input() currentIndex: number | undefined;
-  @Input() headers: LogFieldType[] = [];
-  @Input() filters: LogFilter[] = [];
+  @Input() headers: LogHeader[] = [];
   @Input() entries: LogEntry[] = [];
   @Input() showCurrentTimeButton = true;
   @Input() traceType: TraceType | undefined;
@@ -235,10 +253,16 @@ export class LogComponent {
     @Inject(ElementRef) private elementRef: ElementRef<HTMLElement>,
   ) {}
 
+  getHeadersWithFilters() {
+    return this.headers.filter((header) => this.isHeaderWithFilter(header));
+  }
+
+  isHeaderWithFilter(header: LogHeader): boolean {
+    return header.filter !== undefined;
+  }
+
   showFieldButton(field: LogField) {
-    return (
-      field.value instanceof Timestamp || field.type === LogFieldType.INPUT_TYPE
-    );
+    return field.value instanceof Timestamp || field.propagateEntryTimestamp;
   }
 
   formatFieldButton(field: LogField): string | number {
@@ -261,14 +285,6 @@ export class LogComponent {
     return timestamp.format();
   }
 
-  getLogFieldClass(fieldType: LogFieldType) {
-    return LogFieldClassNames.get(fieldType);
-  }
-
-  getLogFieldName(fieldType: LogFieldType) {
-    return LogFieldNames.get(fieldType);
-  }
-
   ngOnChanges() {
     if (
       this.scrollToIndex !== undefined &&
@@ -289,17 +305,17 @@ export class LogComponent {
     this.updateTableMarginEnd();
   }
 
-  onFilterChange(event: MatSelectChange, filterType: LogFieldType) {
+  onFilterChange(event: MatSelectChange, header: LogHeader) {
     this.emitEvent(
       ViewerEvents.LogFilterChange,
-      new LogFilterChangeDetail(filterType, event.value),
+      new LogFilterChangeDetail(header, event.value),
     );
   }
 
-  onSearchBoxChange(detail: TextFilter, filterType: LogFieldType) {
+  onSearchBoxChange(detail: TextFilter, header: LogHeader) {
     this.emitEvent(
       ViewerEvents.LogTextFilterChange,
-      new LogTextFilterChangeDetail(filterType, detail),
+      new LogTextFilterChangeDetail(header, detail),
     );
   }
 
@@ -324,10 +340,7 @@ export class LogComponent {
 
   onFieldButtonClick(event: MouseEvent, entry: LogEntry, field: LogField) {
     event.stopPropagation();
-    if (
-      field.type === LogFieldType.DISPATCH_TIME ||
-      field.type === LogFieldType.INPUT_TYPE
-    ) {
+    if (field.propagateEntryTimestamp) {
       this.onTraceEntryTimestampClick(event, entry);
     } else if (field.value instanceof Timestamp) {
       this.onRawTimestampClick(field.value as Timestamp);
@@ -336,11 +349,9 @@ export class LogComponent {
 
   @HostListener('document:keydown', ['$event'])
   async handleKeyboardEvent(event: KeyboardEvent) {
-    const logComponentRect = (
-      this.elementRef.nativeElement as HTMLElement
-    ).getBoundingClientRect();
-    const logComponentVisible =
-      logComponentRect.height > 0 && logComponentRect.width > 0;
+    const logComponentVisible = DOMUtils.isElementVisible(
+      this.elementRef.nativeElement,
+    );
     if (event.key === 'ArrowDown' && logComponentVisible) {
       event.stopPropagation();
       event.preventDefault();
@@ -361,38 +372,6 @@ export class LogComponent {
     return index === this.selectedIndex;
   }
 
-  getOuterFilterWidth(type: LogFieldType): string | undefined {
-    switch (type) {
-      case LogFieldType.INPUT_DISPATCH_WINDOWS:
-        return '300px';
-      default:
-        return '100%';
-    }
-  }
-
-  getInnerFilterWidth(type: LogFieldType): string | undefined {
-    switch (type) {
-      case LogFieldType.TRANSACTION_ID:
-        return '125';
-      case LogFieldType.VSYNC_ID:
-        return '90';
-      case LogFieldType.TRANSACTION_TYPE:
-        return '175';
-      case LogFieldType.LAYER_OR_DISPLAY_ID:
-        return '100';
-      case LogFieldType.FLAGS:
-        return '250';
-      case LogFieldType.TAG:
-        return '150';
-      case LogFieldType.SOURCE_FILE:
-        return '300';
-      case LogFieldType.INPUT_DISPATCH_WINDOWS:
-        return '300';
-      default:
-        return '100';
-    }
-  }
-
   isTransactions() {
     return this.traceType === TraceType.TRANSACTIONS;
   }
@@ -401,8 +380,16 @@ export class LogComponent {
     return this.traceType === TraceType.PROTO_LOG;
   }
 
+  isTransitions() {
+    return this.traceType === TraceType.TRANSITION;
+  }
+
   isFixedSizeScrollViewport() {
-    return !(this.isTransactions() || this.isProtolog());
+    return !(
+      this.isTransactions() ||
+      this.isProtolog() ||
+      this.isTransitions()
+    );
   }
 
   updateTableMarginEnd() {
diff --git a/tools/winscope/src/viewers/common/log_component_test.ts b/tools/winscope/src/viewers/components/log_component_test.ts
similarity index 78%
rename from tools/winscope/src/viewers/common/log_component_test.ts
rename to tools/winscope/src/viewers/components/log_component_test.ts
index cf547410d..3553bd5ee 100644
--- a/tools/winscope/src/viewers/common/log_component_test.ts
+++ b/tools/winscope/src/viewers/components/log_component_test.ts
@@ -15,7 +15,6 @@
  */
 
 import {ScrollingModule} from '@angular/cdk/scrolling';
-import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
   ComponentFixtureAutoDetect,
@@ -36,6 +35,14 @@ import {TraceBuilder} from 'test/unit/trace_builder';
 import {TraceEntry} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LogSelectFilter, LogTextFilter} from 'viewers/common/log_filters';
+import {TextFilter} from 'viewers/common/text_filter';
+import {
+  ColumnSpec,
+  LogEntry,
+  LogField,
+  LogHeader,
+} from 'viewers/common/ui_data_log';
 import {
   LogFilterChangeDetail,
   LogTextFilterChangeDetail,
@@ -48,10 +55,12 @@ import {PropertiesComponent} from 'viewers/components/properties_component';
 import {SearchBoxComponent} from 'viewers/components/search_box_component';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {LogComponent} from './log_component';
-import {TextFilter} from './text_filter';
-import {LogEntry, LogFieldType} from './ui_data_log';
 
 describe('LogComponent', () => {
+  const testColumn1: ColumnSpec = {name: 'test1', cssClass: 'test-1'};
+  const testColumn2: ColumnSpec = {name: 'test2', cssClass: 'test-2'};
+  const testColumn3: ColumnSpec = {name: 'test3', cssClass: 'test-3'};
+
   let fixture: ComponentFixture<LogComponent>;
   let component: LogComponent;
   let htmlElement: HTMLElement;
@@ -78,7 +87,6 @@ describe('LogComponent', () => {
         PropertiesComponent,
         SearchBoxComponent,
       ],
-      schemas: [CUSTOM_ELEMENTS_SCHEMA],
     }).compileComponents();
 
     fixture = TestBed.createComponent(LogComponent);
@@ -93,8 +101,24 @@ describe('LogComponent', () => {
   });
 
   it('renders filters', () => {
-    const filters = htmlElement.querySelectorAll('.entries .filter');
-    expect(filters.length).toEqual(2);
+    const filtersInTable = htmlElement.querySelectorAll('.entries .filter');
+    expect(filtersInTable.length).toEqual(2);
+    const filtersInTitle = htmlElement.querySelectorAll(
+      '.title-section .filter',
+    );
+    expect(filtersInTitle.length).toEqual(0);
+  });
+
+  it('renders filters in title', () => {
+    component.title = 'Test';
+    component.showFiltersInTitle = true;
+    fixture.detectChanges();
+    const filtersInTable = htmlElement.querySelectorAll('.entries .filter');
+    expect(filtersInTable.length).toEqual(0);
+    const filtersInTitle = htmlElement.querySelectorAll(
+      '.title-section .filter',
+    );
+    expect(filtersInTitle.length).toEqual(2);
   });
 
   it('renders entries', () => {
@@ -112,8 +136,8 @@ describe('LogComponent', () => {
     component.currentIndex = 1;
     fixture.detectChanges();
     const goToCurrentTimeButton = assertDefined(
-      htmlElement.querySelector('.go-to-current-time'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>('.go-to-current-time'),
+    );
     const spy = spyOn(
       assertDefined(component.scrollComponent),
       'scrollToIndex',
@@ -132,7 +156,7 @@ describe('LogComponent', () => {
       }
       component.entries = allEntries.filter((entry) => {
         const entryValue = assertDefined(
-          entry.fields.find((f) => f.type === detail.type),
+          entry.fields.find((f) => f.spec === detail.header.spec),
         ).value.toString();
         if (Array.isArray(detail.value)) {
           return detail.value.includes(entryValue);
@@ -142,14 +166,14 @@ describe('LogComponent', () => {
     });
     expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
     const filterTrigger = assertDefined(
-      htmlElement.querySelector(`.filters .tag .mat-select-trigger`),
-    ) as HTMLInputElement;
+      htmlElement.querySelector<HTMLElement>('.headers .mat-select-trigger'),
+    );
     filterTrigger.click();
     await fixture.whenStable();
 
     const firstOption = assertDefined(
-      document.querySelector('.mat-select-panel .mat-option'),
-    ) as HTMLElement;
+      document.querySelector<HTMLElement>('.mat-select-panel .mat-option'),
+    );
     firstOption.click();
     fixture.detectChanges();
     expect(htmlElement.querySelectorAll('.entry').length).toEqual(1);
@@ -169,7 +193,7 @@ describe('LogComponent', () => {
       }
       component.entries = allEntries.filter((entry) => {
         const entryValue = assertDefined(
-          entry.fields.find((f) => f.type === detail.type),
+          entry.fields.find((f) => f.spec === detail.header.spec),
         ).value.toString();
         return entryValue.includes(detail.filter.filterString);
       });
@@ -177,7 +201,7 @@ describe('LogComponent', () => {
     expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
 
     const inputEl = assertDefined(
-      htmlElement.querySelector<HTMLInputElement>(`.filters .vsyncid input`),
+      htmlElement.querySelector<HTMLInputElement>('.headers input'),
     );
 
     inputEl.value = '123';
@@ -225,17 +249,19 @@ describe('LogComponent', () => {
   });
 
   it('propagates entry on trace entry timestamp click', () => {
-    let entry: TraceEntry<PropertyTreeNode> | undefined;
-    htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
-      const detail: TimestampClickDetail = (event as CustomEvent).detail;
-      entry = detail.entry;
-    });
     const logTimestampButton = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.time-button'),
+      htmlElement.querySelectorAll<HTMLElement>('.time-button').item(1),
     );
-    logTimestampButton.click();
+    checkEntryPropagatedOnTimestampClick(logTimestampButton);
+  });
 
-    expect(entry).toBeDefined();
+  it('propagates entry on timestamp click with propagateEntryTimestamp set', () => {
+    const logTimestampButton = assertDefined(
+      htmlElement
+        .querySelectorAll<HTMLElement>(`.${testColumn3.cssClass} button`)
+        .item(1),
+    );
+    checkEntryPropagatedOnTimestampClick(logTimestampButton);
   });
 
   it('propagates timestamp on raw timestamp click', () => {
@@ -245,8 +271,8 @@ describe('LogComponent', () => {
       timestamp = detail.timestamp;
     });
     const logTimestampButton = assertDefined(
-      htmlElement.querySelector('.send-time button'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>(`.${testColumn3.cssClass} button`),
+    );
     logTimestampButton.click();
 
     expect(timestamp).toBeDefined();
@@ -260,8 +286,8 @@ describe('LogComponent', () => {
     });
 
     const entry = assertDefined(
-      htmlElement.querySelector('.entry[item-id="1"]'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>('.entry[item-id="1"]'),
+    );
     expect(entry.className).not.toContain('selected');
     const spy = spyOn(
       assertDefined(component.scrollComponent),
@@ -313,15 +339,15 @@ describe('LogComponent', () => {
       fieldTime = TimestampConverterUtils.makeRealTimestamp(2n);
     }
 
-    const fields1 = [
-      {type: LogFieldType.TAG, value: 'Test tag 1'},
-      {type: LogFieldType.VSYNC_ID, value: 123},
-      {type: LogFieldType.SEND_TIME, value: fieldTime},
+    const fields1: LogField[] = [
+      {spec: testColumn1, value: 'Test tag 1'},
+      {spec: testColumn2, value: 123},
+      {spec: testColumn3, value: fieldTime},
     ];
     const fields2 = [
-      {type: LogFieldType.TAG, value: 'Test tag 2'},
-      {type: LogFieldType.VSYNC_ID, value: 1234},
-      {type: LogFieldType.SEND_TIME, value: fieldTime},
+      {spec: testColumn1, value: 'Test tag 2'},
+      {spec: testColumn2, value: 1234},
+      {spec: testColumn3, value: fieldTime, propagateEntryTimestamp: true},
     ];
 
     const trace = new TraceBuilder<PropertyTreeNode>()
@@ -339,14 +365,27 @@ describe('LogComponent', () => {
 
     const entries = [entry1, entry2];
 
-    const filters = [
-      {type: LogFieldType.TAG, options: ['Test tag 1', 'Test tag 2']},
-      {type: LogFieldType.VSYNC_ID, textFilter: new TextFilter('', [])},
+    const headers = [
+      new LogHeader(
+        testColumn1,
+        new LogSelectFilter(['Test tag 1', 'Test tag 2']),
+      ),
+      new LogHeader(testColumn2, new LogTextFilter(new TextFilter())),
     ];
 
     component.entries = entries;
-    component.filters = filters;
+    component.headers = headers;
     component.selectedIndex = 0;
     component.traceType = TraceType.CUJS;
   }
+
+  function checkEntryPropagatedOnTimestampClick(button: HTMLElement) {
+    let entry: TraceEntry<object> | undefined;
+    htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
+      const detail: TimestampClickDetail = (event as CustomEvent).detail;
+      entry = detail.entry;
+    });
+    button.click();
+    expect(entry).toBeDefined();
+  }
 });
diff --git a/tools/winscope/src/viewers/components/properties_component.ts b/tools/winscope/src/viewers/components/properties_component.ts
index c26993c84..895ca69b3 100644
--- a/tools/winscope/src/viewers/components/properties_component.ts
+++ b/tools/winscope/src/viewers/components/properties_component.ts
@@ -46,7 +46,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
           [title]="title"
           (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
         <search-box
-          *ngIf="showFilter"
+          formFieldClass="applied-field"
           [textFilter]="textFilter"
           (filterChange)="onFilterChange($event)"></search-box>
       </div>
@@ -91,10 +91,6 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         flex-direction: column;
       }
 
-      .padded-title {
-        padding-bottom: 8px;
-      }
-
       .property-groups {
         overflow-y: auto;
       }
@@ -117,17 +113,16 @@ export class PropertiesComponent {
   ViewerEvents = ViewerEvents;
 
   @Input() title = 'PROPERTIES';
-  @Input() showFilter = true;
   @Input() userOptions: UserOptions = {};
   @Input() placeholderText = '';
   @Input() propertiesTree: UiPropertyTreeNode | undefined;
   @Input() highlightedProperty = '';
   @Input() curatedProperties: CuratedProperties | undefined;
-  @Input() displayPropertyGroups = false;
   @Input() isProtoDump = false;
   @Input() traceType: TraceType | undefined;
   @Input() store: PersistentStore | undefined;
   @Input() textFilter: TextFilter | undefined;
+  @Input() filterEventName = ViewerEvents.PropertiesFilterChange;
 
   @Output() collapseButtonClicked = new EventEmitter();
 
@@ -136,7 +131,7 @@ export class PropertiesComponent {
   constructor(@Inject(ElementRef) private elementRef: ElementRef) {}
 
   onFilterChange(detail: TextFilter) {
-    const event = new CustomEvent(ViewerEvents.PropertiesFilterChange, {
+    const event = new CustomEvent(this.filterEventName, {
       bubbles: true,
       detail,
     });
diff --git a/tools/winscope/src/viewers/components/properties_component_test.ts b/tools/winscope/src/viewers/components/properties_component_test.ts
index a2d0b3688..53ee83946 100644
--- a/tools/winscope/src/viewers/components/properties_component_test.ts
+++ b/tools/winscope/src/viewers/components/properties_component_test.ts
@@ -90,7 +90,7 @@ describe('PropertiesComponent', () => {
         isUnavailable: false,
       },
     };
-    component.textFilter = new TextFilter('', []);
+    component.textFilter = new TextFilter();
     component.traceType = TraceType.SURFACE_FLINGER;
 
     fixture.detectChanges();
diff --git a/tools/winscope/src/viewers/components/properties_table_component_test.ts b/tools/winscope/src/viewers/components/properties_table_component_test.ts
index c819a0a1c..0f65caf96 100644
--- a/tools/winscope/src/viewers/components/properties_table_component_test.ts
+++ b/tools/winscope/src/viewers/components/properties_table_component_test.ts
@@ -23,7 +23,6 @@ describe('PropertiesTableComponent', () => {
   beforeAll(async () => {
     await TestBed.configureTestingModule({
       declarations: [PropertiesTableComponent],
-      schemas: [],
     }).compileComponents();
   });
 
diff --git a/tools/winscope/src/viewers/components/rects/canvas.ts b/tools/winscope/src/viewers/components/rects/canvas.ts
index 3a1b94978..8ebdc6b87 100644
--- a/tools/winscope/src/viewers/components/rects/canvas.ts
+++ b/tools/winscope/src/viewers/components/rects/canvas.ts
@@ -90,7 +90,7 @@ export class Canvas {
     }
   }
 
-  updateViewPosition(camera: Camera, bounds: Box3D) {
+  updateViewPosition(camera: Camera, bounds: Box3D, zDepth: number) {
     // Must set 100% width and height so the HTML element expands to the parent's
     // boundaries and the correct clientWidth and clientHeight values can be read
     this.canvasRects.style.width = '100%';
@@ -128,7 +128,7 @@ export class Canvas {
       scaleFactor *
         ((-bounds.depth * camera.rotationAngleY ** 2) / 2 + bounds.center.y) -
         cameraHeight * panFactorY,
-      scaleFactor * -bounds.depth,
+      scaleFactor * -zDepth, // keeps camera in front of first rect
     );
     this.scene
       .translateX(translatedPos.x - (this.lastScene.translatedPos?.x ?? 0))
diff --git a/tools/winscope/src/viewers/components/rects/canvas_test.ts b/tools/winscope/src/viewers/components/rects/canvas_test.ts
index d18d22a8b..9279ba468 100644
--- a/tools/winscope/src/viewers/components/rects/canvas_test.ts
+++ b/tools/winscope/src/viewers/components/rects/canvas_test.ts
@@ -66,19 +66,19 @@ describe('Canvas', () => {
     it('handles zero size canvas element', () => {
       const canvasRendererSetSizeSpy = spyOn(canvas.renderer, 'setSize');
       canvasWidthSpy.and.returnValue(0);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       expect(canvasRendererSetSizeSpy).not.toHaveBeenCalled();
 
       canvasWidthSpy.and.returnValue(100);
       canvasHeightSpy.and.returnValue(0);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       expect(canvasRendererSetSizeSpy).not.toHaveBeenCalled();
     });
 
     it('changes camera lrtb and maintains scene translated position based on canvas aspect ratio', () => {
       camera.panScreenDistance = new Distance(2, 2);
 
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const [l, r, t, b] = [
         graphicsCamera.left,
         graphicsCamera.right,
@@ -88,7 +88,7 @@ describe('Canvas', () => {
       const prevPosition = graphicsScene.position.clone();
 
       canvasWidthSpy.and.returnValue(200);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsCamera.left).toBeLessThan(l);
       expect(graphicsCamera.right).toBeGreaterThan(r);
@@ -98,7 +98,7 @@ describe('Canvas', () => {
 
       canvasWidthSpy.and.returnValue(100);
       canvasHeightSpy.and.returnValue(200);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsCamera.left).toEqual(l);
       expect(graphicsCamera.right).toEqual(r);
@@ -108,12 +108,12 @@ describe('Canvas', () => {
     });
 
     it('changes scene translated position on change in pan screen distance', () => {
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevPosition = graphicsScene.position.clone();
       const prevScale = graphicsScene.scale.clone();
 
       camera.panScreenDistance = new Distance(2, 2);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsScene.position.x).toBeGreaterThan(prevPosition.x);
       expect(graphicsScene.position.y).toBeLessThan(prevPosition.y);
@@ -122,24 +122,24 @@ describe('Canvas', () => {
     });
 
     it('changes scene scale and scene translated position on change in zoom factor', () => {
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevPosition = graphicsScene.position.clone();
       const sceneScale = graphicsScene.scale.clone();
 
       camera.zoomFactor = 2;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsScene.scale).toEqual(sceneScale.multiplyScalar(2));
       expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(2));
     });
 
     it('changes camera position and scene translated x-position on change in rotation angle x', () => {
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevScenePos = graphicsScene.position.clone();
       const prevCameraPos = graphicsCamera.position.clone();
 
       camera.rotationAngleX = 1.5;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsScene.position.x).toBeLessThan(prevScenePos.x);
       expect(graphicsScene.position.y).toEqual(prevScenePos.y);
@@ -151,12 +151,12 @@ describe('Canvas', () => {
     });
 
     it('changes camera position and scene translated y-position on change in rotation angle y', () => {
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevScenePos = graphicsScene.position.clone();
       const prevCameraPos = graphicsCamera.position.clone();
 
       camera.rotationAngleY = 1.5;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsScene.position.x).toEqual(prevScenePos.x);
       expect(graphicsScene.position.y).toBeLessThan(prevScenePos.y);
@@ -168,46 +168,53 @@ describe('Canvas', () => {
     });
 
     it('changes scene scale and translated position on change in box diagonal', () => {
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevPosition = graphicsScene.position.clone();
       const sceneScale = graphicsScene.scale.clone();
 
       boundingBox.diagonal = 2;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
 
       expect(graphicsScene.scale).toEqual(sceneScale.multiplyScalar(0.5));
       expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(0.5));
     });
 
-    it('changes translated position on change in box depth', () => {
+    it('changes translated position on change in box depth or zDepth', () => {
       camera.rotationAngleX = 1;
       camera.rotationAngleY = 1;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevPosition = graphicsScene.position.clone();
       const prevScale = graphicsScene.scale.clone();
 
       boundingBox.depth = 2;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(2));
       expect(graphicsScene.scale).toEqual(prevScale);
+
+      canvas.updateViewPosition(camera, boundingBox, 4);
+      expect(graphicsScene.position).toEqual(
+        prevPosition.multiply(new THREE.Vector3(1, 1, 2)),
+      );
+      expect(graphicsScene.scale).toEqual(prevScale);
     });
 
     it('changes translated position on change in box center', () => {
       camera.rotationAngleX = 1;
       camera.rotationAngleY = 1;
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       const prevPosition = graphicsScene.position.clone();
       const prevScale = graphicsScene.scale.clone();
 
       boundingBox.center = new Point3D(3, 3, 3);
-      canvas.updateViewPosition(camera, boundingBox);
+      canvas.updateViewPosition(camera, boundingBox, boundingBox.depth);
       expect(graphicsScene.position).not.toEqual(prevPosition);
       expect(graphicsScene.scale).toEqual(prevScale);
     });
 
     it('robust to no labels canvas', () => {
       const canvas = new Canvas(canvasRects);
-      canvas.updateViewPosition(makeCamera(), makeBoundingBox());
+      const box = makeBoundingBox();
+      canvas.updateViewPosition(makeCamera(), box, box.depth);
     });
   });
 
@@ -789,7 +796,8 @@ describe('Canvas', () => {
       const canvasRects = document.createElement('canvas');
       const canvasLabels = document.createElement('canvas');
       canvas = new Canvas(canvasRects, canvasLabels);
-      canvas.updateViewPosition(makeCamera(), makeBoundingBox());
+      const box = makeBoundingBox();
+      canvas.updateViewPosition(makeCamera(), box, box.depth);
       canvas.renderView();
     });
 
diff --git a/tools/winscope/src/viewers/components/rects/mapper3d.ts b/tools/winscope/src/viewers/components/rects/mapper3d.ts
index b2a399d39..d2ef08608 100644
--- a/tools/winscope/src/viewers/components/rects/mapper3d.ts
+++ b/tools/winscope/src/viewers/components/rects/mapper3d.ts
@@ -20,7 +20,10 @@ import {Distance} from 'common/geometry/distance';
 import {Point3D} from 'common/geometry/point3d';
 import {Rect3D} from 'common/geometry/rect3d';
 import {Size} from 'common/geometry/size';
-import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {
+  IDENTITY_MATRIX,
+  TransformMatrix,
+} from 'common/geometry/transform_matrix';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiRect} from 'viewers/components/rects/ui_rect';
 import {ColorType} from './color_type';
@@ -58,6 +61,7 @@ class Mapper3D {
   private shadingModeIndex = 0;
   private allowedShadingModes: ShadingMode[] = [ShadingMode.GRADIENT];
   private pinnedItems: UiHierarchyTreeNode[] = [];
+  private previousBoundingBox: Box3D | undefined;
 
   setRects(rects: UiRect[]) {
     this.rects = rects;
@@ -87,12 +91,12 @@ class Mapper3D {
     this.zSpacingFactor = Math.min(Math.max(factor, 0), 1);
   }
 
-  increaseZoomFactor(ratio = 1) {
+  increaseZoomFactor(ratio: number) {
     this.zoomFactor += Mapper3D.ZOOM_FACTOR_STEP * ratio;
     this.zoomFactor = Math.min(this.zoomFactor, Mapper3D.ZOOM_FACTOR_MAX);
   }
 
-  decreaseZoomFactor(ratio = 1) {
+  decreaseZoomFactor(ratio: number) {
     this.zoomFactor -= Mapper3D.ZOOM_FACTOR_STEP * ratio;
     this.zoomFactor = Math.max(this.zoomFactor, Mapper3D.ZOOM_FACTOR_MIN);
   }
@@ -166,7 +170,7 @@ class Mapper3D {
     );
   }
 
-  computeScene(): Scene {
+  computeScene(updateBoundingBox: boolean): Scene {
     const rects3d: UiRect3D[] = [];
     const labels3d: RectLabel[] = [];
     let clusterYOffset = 0;
@@ -190,9 +194,15 @@ class Mapper3D {
       clusterYOffset += boundingBox.height + Mapper3D.DISPLAY_CLUSTER_SPACING;
     }
 
+    const newBoundingBox =
+      boundingBox ?? this.computeBoundingBox(rects3d, labels3d);
+    if (!this.previousBoundingBox || updateBoundingBox) {
+      this.previousBoundingBox = newBoundingBox;
+    }
+
     const angleX = this.getCameraXAxisAngle();
     const scene: Scene = {
-      boundingBox: boundingBox ?? this.computeBoundingBox(rects3d, labels3d),
+      boundingBox: this.previousBoundingBox,
       camera: {
         rotationAngleX: angleX,
         rotationAngleY: angleX * Mapper3D.Y_AXIS_ROTATION_FACTOR,
@@ -201,6 +211,7 @@ class Mapper3D {
       },
       rects: rects3d,
       labels: labels3d,
+      zDepth: newBoundingBox.depth,
     };
     return scene;
   }
@@ -372,13 +383,16 @@ class Mapper3D {
     const cameraTiltFactor =
       Math.sin(this.getCameraXAxisAngle()) / Mapper3D.Y_AXIS_ROTATION_FACTOR;
     const labelTextYSpacing = Math.max(
-      (rects2d.length * Mapper3D.LABEL_SPACING_MIN) /
+      ((this.onlyRenderSelectedLabel(rects2d) ? rects2d.length : 1) *
+        Mapper3D.LABEL_SPACING_MIN) /
         Mapper3D.LABEL_SPACING_PER_RECT_FACTOR,
       lowestYPoint / Mapper3D.LABEL_SPACING_INIT_FACTOR,
     );
-    const scaleFactor =
-      Math.min(this.zoomFactor, Math.max(1, Math.sqrt(rects2d.length)) / 2) **
-      2;
+
+    const scaleFactor = Math.max(
+      Math.min(this.zoomFactor ** 2, 1 + (8 - rects2d.length) * 0.05),
+      0.5,
+    );
 
     let labelY = lowestYPoint + Mapper3D.LABEL_FIRST_Y_OFFSET / scaleFactor;
     let lastDepth: number | undefined;
@@ -479,13 +493,17 @@ class Mapper3D {
     let minZ = Number.MAX_VALUE;
     let maxZ = Number.MIN_VALUE;
 
-    const updateMinMaxCoordinates = (point: Point3D) => {
-      minX = Math.min(minX, point.x);
-      maxX = Math.max(maxX, point.x);
-      minY = Math.min(minY, point.y);
-      maxY = Math.max(maxY, point.y);
-      minZ = Math.min(minZ, point.z);
-      maxZ = Math.max(maxZ, point.z);
+    const updateMinMaxCoordinates = (
+      point: Point3D,
+      transform?: TransformMatrix,
+    ) => {
+      const transformedPoint = transform?.transformPoint3D(point) ?? point;
+      minX = Math.min(minX, transformedPoint.x);
+      maxX = Math.max(maxX, transformedPoint.x);
+      minY = Math.min(minY, transformedPoint.y);
+      maxY = Math.max(maxY, transformedPoint.y);
+      minZ = Math.min(minZ, transformedPoint.z);
+      maxZ = Math.max(maxZ, transformedPoint.z);
     };
 
     rects.forEach((rect) => {
@@ -499,13 +517,13 @@ class Mapper3D {
         y: rect.center.y - rect.height / 2,
         z: rect.center.z
       };*/
-      updateMinMaxCoordinates(rect.topLeft);
-      updateMinMaxCoordinates(rect.bottomRight);
+      updateMinMaxCoordinates(rect.topLeft, rect.transform);
+      updateMinMaxCoordinates(rect.bottomRight, rect.transform);
     });
 
-    // if only selected rect label rendered, do not include in bounding box
+    // if multiple labels rendered, include first 10 in bounding box
     if (!this.onlyRenderSelectedLabel(rects)) {
-      labels.forEach((label) => {
+      labels.slice(0, 10).forEach((label) => {
         label.linePoints.forEach((point) => {
           updateMinMaxCoordinates(point);
         });
@@ -518,9 +536,9 @@ class Mapper3D {
       (minZ + maxZ) / 2,
     );
 
-    const width = maxX - minX;
-    const height = maxY - minY;
-    const depth = maxZ - minZ;
+    const width = (maxX - minX) * 1.1;
+    const height = (maxY - minY) * 1.1;
+    const depth = (maxZ - minZ) * 1.1;
 
     return {
       width,
diff --git a/tools/winscope/src/viewers/components/rects/rects_component.ts b/tools/winscope/src/viewers/components/rects/rects_component.ts
index 0a32587ae..5b328021f 100644
--- a/tools/winscope/src/viewers/components/rects/rects_component.ts
+++ b/tools/winscope/src/viewers/components/rects/rects_component.ts
@@ -215,12 +215,10 @@ import {ShadingMode} from './shading_mode';
         display: flex;
         flex-direction: column;
       }
-      .mat-title {
-        padding-top: 8px;
-      }
       .right-btn-container {
         display: flex;
         align-items: center;
+        padding: 2px 0px;
       }
       .right-btn-container .mat-slider-horizontal {
         min-width: 64px !important;
@@ -351,6 +349,7 @@ export class RectsComponent implements OnInit, OnDestroy {
   private internalMiniRects?: UiRect[];
   private storeKeyZSpacingFactor = '';
   private storeKeyShadingMode = '';
+  private storeKeySelectedDisplays = '';
   private internalDisplays: DisplayIdentifier[] = [];
   private internalHighlightedItem = '';
   private currentDisplays: DisplayIdentifier[] = [];
@@ -359,9 +358,7 @@ export class RectsComponent implements OnInit, OnDestroy {
   private largeRectsCanvas?: Canvas;
   private miniRectsCanvas?: Canvas;
   private resizeObserver = new ResizeObserver((entries) => {
-    const scene = this.largeRectsMapper3d.computeScene();
-    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
-    this.largeRectsCanvas?.renderView();
+    this.updateLargeRectsPosition();
   });
   private largeRectsCanvasElement?: HTMLCanvasElement;
   private miniRectsCanvasElement?: HTMLCanvasElement;
@@ -416,15 +413,12 @@ export class RectsComponent implements OnInit, OnDestroy {
       this.onCanvasMouseDown(event),
     );
 
+    this.largeRectsMapper3d.increaseZoomFactor(this.zoomFactor - 1);
+
     if (this.store) {
       this.updateControlsFromStore();
     }
 
-    this.currentDisplays =
-      this.internalDisplays.length > 0
-        ? [this.getActiveDisplay(this.internalDisplays)]
-        : [];
-    this.largeRectsMapper3d.increaseZoomFactor(this.zoomFactor - 1);
     this.redrawLargeRectsAndLabels();
 
     this.miniRectsCanvasElement = canvasContainer.querySelector(
@@ -458,11 +452,12 @@ export class RectsComponent implements OnInit, OnDestroy {
     let displayChange = false;
     if (simpleChanges['displays']) {
       const curr: DisplayIdentifier[] = simpleChanges['displays'].currentValue;
-      const prev: DisplayIdentifier[] | undefined =
-        simpleChanges['displays'].previousValue ?? undefined;
+      const prev: DisplayIdentifier[] =
+        simpleChanges['displays'].previousValue ?? [];
       displayChange =
-        curr.length > 0 &&
-        !curr.every((d, index) => d.displayId === prev?.at(index)?.displayId);
+        curr.length !== prev.length ||
+        (curr.length > 0 &&
+          !curr.every((d, index) => d.displayId === prev[index].displayId));
     }
 
     let redrawRects = false;
@@ -511,11 +506,12 @@ export class RectsComponent implements OnInit, OnDestroy {
     const activeDisplay = this.getActiveDisplay(this.internalDisplays);
 
     if (displays.length === 0) {
+      this.updateCurrentDisplays([], false);
       return;
     }
 
     if (change.firstChange) {
-      this.updateCurrentDisplays([activeDisplay]);
+      this.updateCurrentDisplays([activeDisplay], false);
       return;
     }
 
@@ -545,6 +541,7 @@ export class RectsComponent implements OnInit, OnDestroy {
   updateControlsFromStore() {
     this.storeKeyZSpacingFactor = `rectsView.${this.title}.zSpacingFactor`;
     this.storeKeyShadingMode = `rectsView.${this.title}.shadingMode`;
+    this.storeKeySelectedDisplays = `rectsView.${this.title}.selectedDisplayId`;
 
     const storedZSpacingFactor = assertDefined(this.store).get(
       this.storeKeyZSpacingFactor,
@@ -562,6 +559,24 @@ export class RectsComponent implements OnInit, OnDestroy {
     ) {
       this.largeRectsMapper3d.setShadingMode(storedShadingMode as ShadingMode);
     }
+
+    const storedSelectedDisplays = assertDefined(this.store).get(
+      this.storeKeySelectedDisplays,
+    );
+    if (storedSelectedDisplays !== undefined) {
+      const storedIds: Array<number | string> = JSON.parse(
+        storedSelectedDisplays,
+      );
+      const displays = this.internalDisplays.filter((display) => {
+        return storedIds.some((id) => display.displayId === id);
+      });
+      if (displays.length > 0) {
+        this.currentDisplays = displays;
+        this.largeRectsMapper3d.setCurrentGroupIds(
+          displays.map((d) => d.groupId),
+        );
+      }
+    }
   }
 
   onSeparationSliderChange(factor: number) {
@@ -583,7 +598,7 @@ export class RectsComponent implements OnInit, OnDestroy {
   resetCamera() {
     Analytics.Navigation.logZoom('reset', 'rects');
     this.largeRectsMapper3d.resetCamera();
-    this.redrawLargeRectsAndLabels();
+    this.redrawLargeRectsAndLabels(true);
   }
 
   @HostListener('wheel', ['$event'])
@@ -608,9 +623,7 @@ export class RectsComponent implements OnInit, OnDestroy {
     this.panning = true;
     const distance = new Distance(event.movementX, event.movementY);
     this.largeRectsMapper3d.addPanScreenDistance(distance);
-    const scene = this.largeRectsMapper3d.computeScene();
-    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
-    this.largeRectsCanvas?.renderView();
+    this.updateLargeRectsPosition();
   }
 
   onMouseUp(event: MouseEvent) {
@@ -629,7 +642,7 @@ export class RectsComponent implements OnInit, OnDestroy {
   }
 
   onDisplaySelectChange(event: MatSelectChange) {
-    const selectedDisplays = event.value;
+    const selectedDisplays: DisplayIdentifier[] = event.value;
     this.updateCurrentDisplays(selectedDisplays);
   }
 
@@ -721,10 +734,19 @@ export class RectsComponent implements OnInit, OnDestroy {
     );
   }
 
-  private updateCurrentDisplays(displays: DisplayIdentifier[]) {
+  private updateCurrentDisplays(
+    displays: DisplayIdentifier[],
+    storeChange = true,
+  ) {
+    if (storeChange) {
+      this.store?.add(
+        this.storeKeySelectedDisplays,
+        JSON.stringify(displays.map((d) => d.displayId)),
+      );
+    }
     this.currentDisplays = displays;
     this.largeRectsMapper3d.setCurrentGroupIds(displays.map((d) => d.groupId));
-    this.redrawLargeRectsAndLabels();
+    this.redrawLargeRectsAndLabels(true);
   }
 
   private findClickedRectId(event: MouseEvent): string | undefined {
@@ -750,30 +772,48 @@ export class RectsComponent implements OnInit, OnDestroy {
     this.updateLargeRectsPositionAndLabels();
   }
 
-  private redrawLargeRectsAndLabels() {
+  private redrawLargeRectsAndLabels(updateBoundingBox = false) {
     this.largeRectsMapper3d.setRects(this.internalRects);
-    const scene = this.largeRectsMapper3d.computeScene();
-    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    const scene = this.largeRectsMapper3d.computeScene(updateBoundingBox);
+    this.largeRectsCanvas?.updateViewPosition(
+      scene.camera,
+      scene.boundingBox,
+      scene.zDepth,
+    );
     this.largeRectsCanvas?.updateRects(scene.rects);
     this.largeRectsCanvas?.updateLabels(scene.labels);
     this.largeRectsCanvas?.renderView();
   }
 
+  private updateLargeRectsPosition() {
+    const scene = this.largeRectsMapper3d.computeScene(false);
+    this.largeRectsCanvas?.updateViewPosition(
+      scene.camera,
+      scene.boundingBox,
+      scene.zDepth,
+    );
+    this.largeRectsCanvas?.renderView();
+  }
+
   private updateLargeRectsPositionAndLabels() {
-    const scene = this.largeRectsMapper3d.computeScene();
-    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    const scene = this.largeRectsMapper3d.computeScene(false);
+    this.largeRectsCanvas?.updateViewPosition(
+      scene.camera,
+      scene.boundingBox,
+      scene.zDepth,
+    );
     this.largeRectsCanvas?.updateLabels(scene.labels);
     this.largeRectsCanvas?.renderView();
   }
 
   private updateLargeRectsColors() {
-    const scene = this.largeRectsMapper3d.computeScene();
+    const scene = this.largeRectsMapper3d.computeScene(false);
     this.largeRectsCanvas?.updateRects(scene.rects);
     this.largeRectsCanvas?.renderView();
   }
 
   private updateLargeRectsAndLabelsColors() {
-    const scene = this.largeRectsMapper3d.computeScene();
+    const scene = this.largeRectsMapper3d.computeScene(false);
     this.largeRectsCanvas?.updateRects(scene.rects);
     this.largeRectsCanvas?.updateLabels(scene.labels);
     this.largeRectsCanvas?.renderView();
@@ -788,8 +828,12 @@ export class RectsComponent implements OnInit, OnDestroy {
       this.miniRectsMapper3d.resetToOrthogonalState();
       this.miniRectsMapper3d.setRects(this.internalMiniRects);
 
-      const scene = this.miniRectsMapper3d.computeScene();
-      this.miniRectsCanvas.updateViewPosition(scene.camera, scene.boundingBox);
+      const scene = this.miniRectsMapper3d.computeScene(true);
+      this.miniRectsCanvas.updateViewPosition(
+        scene.camera,
+        scene.boundingBox,
+        scene.zDepth,
+      );
       this.miniRectsCanvas.updateRects(scene.rects);
       this.miniRectsCanvas.updateLabels(scene.labels);
       this.miniRectsCanvas.renderView();
diff --git a/tools/winscope/src/viewers/components/rects/rects_component_test.ts b/tools/winscope/src/viewers/components/rects/rects_component_test.ts
index 0b839452c..f3e488c23 100644
--- a/tools/winscope/src/viewers/components/rects/rects_component_test.ts
+++ b/tools/winscope/src/viewers/components/rects/rects_component_test.ts
@@ -62,12 +62,15 @@ describe('RectsComponent', () => {
   let updateLabelsSpy: jasmine.Spy<(labels: RectLabel[]) => void>;
   let renderViewSpy: jasmine.Spy<() => void>;
 
+  beforeAll(() => {
+    localStorage.clear();
+  });
+
   beforeEach(async () => {
     updateViewPositionSpy = spyOn(Canvas.prototype, 'updateViewPosition');
     updateRectsSpy = spyOn(Canvas.prototype, 'updateRects');
     updateLabelsSpy = spyOn(Canvas.prototype, 'updateLabels');
     renderViewSpy = spyOn(Canvas.prototype, 'renderView');
-    localStorage.clear();
 
     await TestBed.configureTestingModule({
       imports: [
@@ -88,7 +91,6 @@ describe('RectsComponent', () => {
         CollapsibleSectionTitleComponent,
         UserOptionsComponent,
       ],
-      schemas: [],
     }).compileComponents();
 
     fixture = TestBed.createComponent(TestHostComponent);
@@ -96,6 +98,10 @@ describe('RectsComponent', () => {
     htmlElement = fixture.nativeElement;
   });
 
+  afterEach(() => {
+    localStorage.clear();
+  });
+
   it('can be created', () => {
     expect(component).toBeTruthy();
   });
@@ -117,15 +123,23 @@ describe('RectsComponent', () => {
 
   it('draws scene when input data changes', async () => {
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
     resetSpies();
 
     checkAllSpiesCalled(0);
     component.rects = [rectGroup0];
     fixture.detectChanges();
     checkAllSpiesCalled(1);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
+
     component.rects = [rectGroup0];
     fixture.detectChanges();
     checkAllSpiesCalled(2);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
   });
 
   it('draws scene when rotation slider changes', () => {
@@ -174,7 +188,7 @@ describe('RectsComponent', () => {
       {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
       {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0]);
   });
 
   it('handles display change by checkbox', async () => {
@@ -184,26 +198,23 @@ describe('RectsComponent', () => {
       {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
       {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0]);
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
 
-    const trigger = assertDefined(
-      htmlElement.querySelector('.displays-section .mat-select-trigger'),
-    );
-    (trigger as HTMLElement).click();
-    fixture.detectChanges();
-
-    const options = document.querySelectorAll<HTMLElement>(
-      '.mat-select-panel .mat-option',
-    );
+    openDisplaysSelect();
+    const options = getDisplayOptions();
 
     options.item(1).click();
-    await checkSelectedDisplay([0, 1]);
+    await checkSelectedDisplay([0, 1], [0, 1], true);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).not.toEqual(
+      boundingBox,
+    );
 
     options.item(0).click();
-    await checkSelectedDisplay([1]);
+    await checkSelectedDisplay([1], [1], true);
 
     options.item(1).click();
-    await checkSelectedDisplay([]);
+    await checkSelectedDisplay([], [], true);
     const placeholder = assertDefined(
       htmlElement.querySelector('.placeholder-text'),
     );
@@ -217,13 +228,9 @@ describe('RectsComponent', () => {
       {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
       {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0]);
 
-    const trigger = assertDefined(
-      htmlElement.querySelector('.displays-section .mat-select-trigger'),
-    );
-    (trigger as HTMLElement).click();
-    fixture.detectChanges();
+    openDisplaysSelect();
 
     const onlyButtons = document.querySelectorAll<HTMLElement>(
       '.mat-select-panel .mat-option .option-only-button',
@@ -234,15 +241,15 @@ describe('RectsComponent', () => {
 
     // no change
     display0Button.click();
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0]);
 
     display1Button.click();
-    await checkSelectedDisplay([1]);
+    await checkSelectedDisplay([1], [1]);
 
     assertDefined(display0Button.parentElement).click();
-    await checkSelectedDisplay([0, 1]);
+    await checkSelectedDisplay([0, 1], [0, 1], true);
     display0Button.click();
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0], true);
   });
 
   it('tracks selected display', async () => {
@@ -251,21 +258,25 @@ describe('RectsComponent', () => {
       {displayId: 20, groupId: 1, name: 'Display 1', isActive: false},
     ];
     component.rects = [rectGroup0, rectGroup1];
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0]);
 
     component.displays = [
       {displayId: 20, groupId: 2, name: 'Display 1', isActive: false},
       {displayId: 10, groupId: 1, name: 'Display 0', isActive: false},
     ];
-    await checkSelectedDisplay([0], [1]);
+    await checkSelectedDisplay([0], [1], false);
   });
 
   it('updates scene on separation slider change', () => {
     component.rects = [rectGroup0, rectGroup0];
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
     updateSeparationSlider();
 
     checkAllSpiesCalled(2);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
     const rectsBefore = assertDefined(updateRectsSpy.calls.first().args[0]);
     const rectsAfter = assertDefined(updateRectsSpy.calls.mostRecent().args[0]);
 
@@ -276,12 +287,16 @@ describe('RectsComponent', () => {
   it('updates scene on rotation slider change', () => {
     component.rects = [rectGroup0];
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
     updateRotationSlider();
 
     expect(updateViewPositionSpy).toHaveBeenCalledTimes(2);
     expect(updateRectsSpy).toHaveBeenCalledTimes(1);
     expect(updateLabelsSpy).toHaveBeenCalledTimes(2);
     expect(renderViewSpy).toHaveBeenCalledTimes(2);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
 
     const cameraBefore = assertDefined(
       updateViewPositionSpy.calls.first().args[0],
@@ -301,6 +316,7 @@ describe('RectsComponent', () => {
   it('updates scene on shading mode change', () => {
     component.rects = [rectGroup0];
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
 
     updateShadingMode(ShadingMode.GRADIENT, ShadingMode.WIRE_FRAME);
     updateShadingMode(ShadingMode.WIRE_FRAME, ShadingMode.OPACITY);
@@ -309,6 +325,9 @@ describe('RectsComponent', () => {
     expect(updateRectsSpy).toHaveBeenCalledTimes(3);
     expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
     expect(renderViewSpy).toHaveBeenCalledTimes(3);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
 
     const rectsGradient = assertDefined(updateRectsSpy.calls.first().args[0]);
     const rectsWireFrame = assertDefined(updateRectsSpy.calls.argsFor(1).at(0));
@@ -324,6 +343,8 @@ describe('RectsComponent', () => {
 
     expect(rectsOpacity[0].colorType).toEqual(ColorType.VISIBLE_WITH_OPACITY);
     expect(rectsOpacity[0].darkFactor).toEqual(0.5);
+
+    updateShadingMode(ShadingMode.OPACITY, ShadingMode.GRADIENT); // cycles back to original
   });
 
   it('uses stored rects view settings', () => {
@@ -341,6 +362,46 @@ describe('RectsComponent', () => {
     expect(newRectsComponent.getShadingMode()).toEqual(ShadingMode.WIRE_FRAME);
   });
 
+  it('uses stored selected displays if present in new trace', async () => {
+    component.rects = [rectGroup0, rectGroup1];
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: true},
+      {displayId: 20, groupId: 1, name: 'Display 1', isActive: true},
+    ];
+    await checkSelectedDisplay([0], [0]);
+
+    openDisplaysSelect();
+    const options = getDisplayOptions();
+    options.item(1).click();
+    await checkSelectedDisplay([0, 1], [0, 1]);
+
+    const fixtureWithSameDisplays = TestBed.createComponent(TestHostComponent);
+    const componentWithSameDisplays = fixtureWithSameDisplays.componentInstance;
+    componentWithSameDisplays.rects = component.rects;
+    componentWithSameDisplays.displays = component.displays;
+    await checkSelectedDisplay(
+      [0, 1],
+      [0, 1],
+      false,
+      fixtureWithSameDisplays,
+      fixtureWithSameDisplays.nativeElement,
+    );
+
+    const fixtureWithDisplay1 = TestBed.createComponent(TestHostComponent);
+    const componentWithDisplay1 = fixtureWithDisplay1.componentInstance;
+    componentWithDisplay1.rects = [rectGroup1];
+    componentWithDisplay1.displays = [
+      {displayId: 20, groupId: 1, name: 'Display 1', isActive: true},
+    ];
+    await checkSelectedDisplay(
+      [1],
+      [1],
+      false,
+      fixtureWithDisplay1,
+      fixtureWithDisplay1.nativeElement,
+    );
+  });
+
   it('defaults initial selection to first active display with rects', async () => {
     component.rects = [rectGroup0, rectGroup1];
     component.displays = [
@@ -365,13 +426,13 @@ describe('RectsComponent', () => {
       {displayId: 20, groupId: 1, name: 'Display 1', isActive: false},
     ];
     component.rects = [rectGroup1];
-    await checkSelectedDisplay([1]);
+    await checkSelectedDisplay([1], [1]);
   });
 
-  it('handles change from zero to one display', async () => {
+  it('handles change from zero to one display and back to zero', async () => {
     component.displays = [];
     component.rects = [];
-    await checkSelectedDisplay([]);
+    await checkSelectedDisplay([], []);
     const placeholder = assertDefined(
       htmlElement.querySelector('.placeholder-text'),
     );
@@ -381,7 +442,25 @@ describe('RectsComponent', () => {
     component.displays = [
       {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
     ];
-    await checkSelectedDisplay([0]);
+    await checkSelectedDisplay([0], [0], true);
+
+    component.displays = [];
+    component.rects = [];
+    await checkSelectedDisplay([], []);
+  });
+
+  it('handles current display group id no longer present', async () => {
+    component.rects = [rectGroup0];
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+    ];
+    await checkSelectedDisplay([0], [0]);
+
+    component.rects = [rectGroup1];
+    component.displays = [
+      {displayId: 20, groupId: 1, name: 'Display 1', isActive: false},
+    ];
+    await checkSelectedDisplay([1], [1]);
   });
 
   it('draws mini rects with non-present group id', () => {
@@ -456,11 +535,7 @@ describe('RectsComponent', () => {
       assertDefined(component.rectsComponent).collapseButtonClicked,
       'emit',
     );
-    const collapseButton = assertDefined(
-      htmlElement.querySelector('collapsible-section-title button'),
-    ) as HTMLButtonElement;
-    collapseButton.click();
-    fixture.detectChanges();
+    findAndClickElement('collapsible-section-title button');
     expect(spy).toHaveBeenCalled();
   });
 
@@ -487,17 +562,18 @@ describe('RectsComponent', () => {
     fixture.detectChanges();
 
     const testString = 'test_id';
-    spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(testString);
     let id: string | undefined;
     htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) => {
       id = (event as CustomEvent).detail.id;
     });
 
-    const canvas = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
+    const spy = spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(
+      undefined,
     );
-    canvas.click();
-    fixture.detectChanges();
+    clickLargeRectsCanvas();
+    expect(id).toBeUndefined();
+    spy.and.returnValue(testString);
+    clickLargeRectsCanvas();
     expect(id).toEqual(testString);
   });
 
@@ -507,6 +583,7 @@ describe('RectsComponent', () => {
     const cameraBefore = updateViewPositionSpy.calls.mostRecent().args[0];
     expect(cameraBefore.panScreenDistance.dx).toEqual(0);
     expect(cameraBefore.panScreenDistance.dy).toEqual(0);
+    const boundingBoxBefore = updateViewPositionSpy.calls.mostRecent().args[1];
     resetSpies();
 
     const testString = 'test_id';
@@ -522,25 +599,23 @@ describe('RectsComponent', () => {
     expect(updateLabelsSpy).not.toHaveBeenCalled();
     expect(renderViewSpy).toHaveBeenCalled();
 
-    const cameraAfter = updateViewPositionSpy.calls.mostRecent().args[0];
+    const [cameraAfter, boundingBoxAfter] =
+      updateViewPositionSpy.calls.mostRecent().args;
     expect(cameraAfter.panScreenDistance.dx).toEqual(5);
     expect(cameraAfter.panScreenDistance.dy).toEqual(10);
+    expect(boundingBoxAfter).toEqual(boundingBoxBefore);
 
-    const canvas = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
-    );
-    canvas.click();
-    fixture.detectChanges();
+    clickLargeRectsCanvas();
     expect(id).toBeUndefined();
 
-    canvas.click();
-    fixture.detectChanges();
+    clickLargeRectsCanvas();
     expect(id).toEqual(testString);
   });
 
   it('handles window resize', async () => {
     component.rects = [rectGroup0];
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
     resetSpies();
 
     spyOnProperty(window, 'innerWidth').and.returnValue(window.innerWidth / 2);
@@ -551,6 +626,9 @@ describe('RectsComponent', () => {
     expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
     expect(updateRectsSpy).not.toHaveBeenCalled();
     expect(updateLabelsSpy).not.toHaveBeenCalled();
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
   });
 
   it('handles change in dark mode', async () => {
@@ -570,6 +648,7 @@ describe('RectsComponent', () => {
   it('handles zoom button clicks', () => {
     component.rects = [rectGroup0];
     fixture.detectChanges();
+    const boundingBox = updateViewPositionSpy.calls.mostRecent().args[1];
     const zoomFactor =
       updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
     resetSpies();
@@ -578,14 +657,16 @@ describe('RectsComponent', () => {
     checkZoomedIn(zoomFactor);
     const zoomedInFactor =
       updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
     resetSpies();
 
-    const zoomOutButton = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.zoom-out-button'),
-    );
-    zoomOutButton.click();
-    fixture.detectChanges();
+    findAndClickElement('.zoom-out-button');
     checkZoomedOut(zoomedInFactor);
+    expect(updateViewPositionSpy.calls.mostRecent().args[1]).toEqual(
+      boundingBox,
+    );
   });
 
   it('handles zoom change via scroll event', () => {
@@ -631,11 +712,7 @@ describe('RectsComponent', () => {
     panView();
     resetSpies();
 
-    const resetButton = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.reset-button'),
-    );
-    resetButton.click();
-    fixture.detectChanges();
+    findAndClickElement('.reset-button');
     checkAllSpiesCalled(1);
     const [newCamera, newBoundingBox] =
       updateViewPositionSpy.calls.mostRecent().args;
@@ -669,7 +746,9 @@ describe('RectsComponent', () => {
     resetSpies();
 
     const testString = 'test_id';
-    spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(testString);
+    const spy = spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(
+      undefined,
+    );
     let detail: RectDblClickDetail | undefined;
     htmlElement.addEventListener(ViewerEvents.RectsDblClick, (event) => {
       detail = (event as CustomEvent).detail;
@@ -678,6 +757,11 @@ describe('RectsComponent', () => {
     const canvas = assertDefined(
       htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
     );
+    canvas.dispatchEvent(new MouseEvent('dblclick'));
+    fixture.detectChanges();
+    expect(detail).toBeUndefined();
+    spy.and.returnValue(testString);
+
     canvas.dispatchEvent(new MouseEvent('dblclick'));
     fixture.detectChanges();
     expect(detail).toEqual(new RectDblClickDetail(testString));
@@ -701,6 +785,44 @@ describe('RectsComponent', () => {
     expect(miniRectDoubleClick).toBeTrue();
   });
 
+  it('does not render more that selected label if over 30 rects', () => {
+    component.rects = Array.from({length: 30}, () => rectGroup0);
+    fixture.detectChanges();
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(30);
+
+    const newRect = makeRectWithGroupId(0, true, 'new rect');
+    component.rects = component.rects.concat([newRect]);
+    fixture.detectChanges();
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(0);
+
+    component.highlightedItem = newRect.id;
+    fixture.detectChanges();
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(1);
+  });
+
+  it('does not render more that selected label if multiple group ids', async () => {
+    component.rects = [rectGroup0];
+    component.displays = [
+      {displayId: 0, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
+    ];
+    fixture.detectChanges();
+    await checkSelectedDisplay([0], [0]);
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(1);
+
+    component.rects = component.rects.concat([rectGroup1]);
+    fixture.detectChanges();
+    openDisplaysSelect();
+    getDisplayOptions().item(1).click();
+    await checkSelectedDisplay([0, 1], [0, 1], true);
+
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(0);
+
+    component.highlightedItem = rectGroup0.id;
+    fixture.detectChanges();
+    expect(updateLabelsSpy.calls.mostRecent().args[0].length).toEqual(1);
+  });
+
   function resetSpies() {
     [
       updateViewPositionSpy,
@@ -712,14 +834,15 @@ describe('RectsComponent', () => {
 
   async function checkSelectedDisplay(
     displayNumbers: number[],
-    testIds?: number[],
+    testIds: number[],
+    changeInBoundingBox?: boolean,
+    f = fixture,
+    el = htmlElement,
   ) {
-    fixture.detectChanges();
-    await fixture.whenStable();
-    fixture.detectChanges();
-    const displaySelect = assertDefined(
-      htmlElement.querySelector('.displays-select'),
-    );
+    f.detectChanges();
+    await f.whenStable();
+    f.detectChanges();
+    const displaySelect = assertDefined(el.querySelector('.displays-select'));
     expect(displaySelect.textContent?.trim()).toEqual(
       displayNumbers
         .map((displayNumber) => `Display ${displayNumber}`)
@@ -728,17 +851,20 @@ describe('RectsComponent', () => {
     const drawnRects = updateRectsSpy.calls.mostRecent().args[0];
     expect(drawnRects.length).toEqual(displayNumbers.length);
     drawnRects.forEach((rect, index) => {
-      expect(rect.id).toEqual(
-        `test-id ${testIds ? testIds[index] : displayNumbers[index]}`,
-      );
+      expect(rect.id).toEqual(`test-id ${testIds[index]}`);
       if (index > 0) expect(rect.transform.ty).toBeGreaterThan(0);
     });
+    if (changeInBoundingBox) {
+      expect(updateViewPositionSpy.calls.mostRecent().args[1]).not.toEqual(
+        updateViewPositionSpy.calls.argsFor(
+          updateViewPositionSpy.calls.count() - 2,
+        )[1],
+      );
+    }
   }
 
   function findAndClickElement(selector: string) {
-    const el = assertDefined(
-      htmlElement.querySelector(selector),
-    ) as HTMLElement;
+    const el = assertDefined(htmlElement.querySelector<HTMLElement>(selector));
     el.click();
     fixture.detectChanges();
   }
@@ -777,7 +903,11 @@ describe('RectsComponent', () => {
     expect(rectsComponent.getShadingMode()).toEqual(after);
   }
 
-  function makeRectWithGroupId(groupId: number, isVisible = true): UiRect {
+  function makeRectWithGroupId(
+    groupId: number,
+    isVisible = true,
+    id?: string,
+  ): UiRect {
     return new UiRectBuilder()
       .setX(0)
       .setY(0)
@@ -797,7 +927,7 @@ describe('RectsComponent', () => {
       .setIsVisible(isVisible)
       .setIsDisplay(false)
       .setIsActiveDisplay(false)
-      .setId('test-id ' + groupId)
+      .setId(id ?? 'test-id ' + groupId)
       .setGroupId(groupId)
       .setIsClickable(true)
       .setCornerRadius(0)
@@ -820,11 +950,11 @@ describe('RectsComponent', () => {
   }
 
   function clickZoomInButton() {
-    const zoomInButton = assertDefined(
-      htmlElement.querySelector<HTMLElement>('.zoom-in-button'),
-    );
-    zoomInButton.click();
-    fixture.detectChanges();
+    findAndClickElement('.zoom-in-button');
+  }
+
+  function clickLargeRectsCanvas() {
+    findAndClickElement('.large-rects-canvas');
   }
 
   function checkZoomedIn(oldZoomFactor: number) {
@@ -847,6 +977,16 @@ describe('RectsComponent', () => {
     ).toBeLessThan(oldZoomFactor);
   }
 
+  function openDisplaysSelect() {
+    findAndClickElement('.displays-section .mat-select-trigger');
+  }
+
+  function getDisplayOptions() {
+    return document.querySelectorAll<HTMLElement>(
+      '.mat-select-panel .mat-option',
+    );
+  }
+
   function checkAllSpiesCalled(times: number) {
     [
       updateViewPositionSpy,
diff --git a/tools/winscope/src/viewers/components/rects/scene.ts b/tools/winscope/src/viewers/components/rects/scene.ts
index f7a3a5f0f..0d6695fa8 100644
--- a/tools/winscope/src/viewers/components/rects/scene.ts
+++ b/tools/winscope/src/viewers/components/rects/scene.ts
@@ -24,4 +24,5 @@ export interface Scene {
   camera: Camera;
   rects: UiRect3D[];
   labels: RectLabel[];
+  zDepth: number;
 }
diff --git a/tools/winscope/src/viewers/components/search_box_component.ts b/tools/winscope/src/viewers/components/search_box_component.ts
index ea7e1382a..36f77cbcf 100644
--- a/tools/winscope/src/viewers/components/search_box_component.ts
+++ b/tools/winscope/src/viewers/components/search_box_component.ts
@@ -22,7 +22,13 @@ import {TextFilter} from 'viewers/common/text_filter';
 @Component({
   selector: 'search-box',
   template: `
-    <mat-form-field class="search-box" [class.wide-field]="wideField" [appearance]="appearance" [style.font-size]="fontSize + 'px'" (keydown.enter)="$event.target.blur()">
+    <mat-form-field
+      *ngIf="textFilter"
+      [class]="getFormFieldClasses()"
+      [appearance]="appearance"
+      [style.height]="height"
+      (keydown.esc)="$event.target.blur()"
+      (keydown.enter)="$event.target.blur()">
       <mat-label>{{ label }}</mat-label>
       <input
         matInput
@@ -57,26 +63,27 @@ import {TextFilter} from 'viewers/common/text_filter';
   styles: [
     `
     .search-box {
-      height: 48px;
-    }
-    .wide-field {
-      width: 100%;
+      font-size: 14px;
+      margin-top: 4px;
     }
     .search-box .mat-icon {
       font-size: 18px;
     }
+    .wide-field {
+      width: 100%;
+    }
   `,
   ],
 })
 export class SearchBoxComponent {
   FilterFlag = FilterFlag;
 
-  @Input() textFilter: TextFilter | undefined = new TextFilter('', []);
+  @Input() textFilter: TextFilter | undefined = new TextFilter();
   @Input() label = 'Search';
   @Input() filterName = 'filter';
-  @Input() appearance: string | undefined;
-  @Input() fontSize = 14;
-  @Input() wideField = false;
+  @Input() appearance = '';
+  @Input() formFieldClass = '';
+  @Input() height = '48px';
 
   @Output() readonly filterChange = new EventEmitter<TextFilter>();
 
@@ -98,4 +105,12 @@ export class SearchBoxComponent {
   onFilterChange() {
     this.filterChange.emit(this.textFilter);
   }
+
+  getFormFieldClasses(): string {
+    return (
+      'search-box ' +
+      ((this.textFilter?.filterString.length ?? 0) > 0 ? 'highlighted ' : '') +
+      this.formFieldClass
+    );
+  }
 }
diff --git a/tools/winscope/src/viewers/components/search_box_component_test.ts b/tools/winscope/src/viewers/components/search_box_component_test.ts
index 11ade8b16..ba9d8907e 100644
--- a/tools/winscope/src/viewers/components/search_box_component_test.ts
+++ b/tools/winscope/src/viewers/components/search_box_component_test.ts
@@ -48,7 +48,7 @@ describe('SearchBoxComponent', () => {
     fixture = TestBed.createComponent(SearchBoxComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
-    component.textFilter = new TextFilter('', []);
+    component.textFilter = new TextFilter();
     fixture.detectChanges();
   });
 
@@ -68,9 +68,11 @@ describe('SearchBoxComponent', () => {
   it('handles change in filter', () => {
     const spy = spyOn(component.filterChange, 'emit');
     expect(component.textFilter?.filterString).toEqual('');
+    expect(htmlElement.querySelector('.highlighted')).toBeNull();
     changeFilterString('Test');
     expect(component.textFilter?.filterString).toEqual('Test');
-    expect(spy).toHaveBeenCalledWith(new TextFilter('Test', []));
+    expect(spy).toHaveBeenCalledWith(new TextFilter('Test'));
+    expect(htmlElement.querySelector('.highlighted')).toBeTruthy();
   });
 
   it('handles change in flags', () => {
@@ -87,7 +89,7 @@ describe('SearchBoxComponent', () => {
 
     buttons.item(0).click();
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalledWith(new TextFilter('', []));
+    expect(spy).toHaveBeenCalledWith(new TextFilter());
 
     buttons.item(2).click();
     fixture.detectChanges();
diff --git a/tools/winscope/src/viewers/components/select_with_filter_component.ts b/tools/winscope/src/viewers/components/select_with_filter_component.ts
index f6df8c655..4af8e6445 100644
--- a/tools/winscope/src/viewers/components/select_with_filter_component.ts
+++ b/tools/winscope/src/viewers/components/select_with_filter_component.ts
@@ -19,14 +19,19 @@ import {MatSelectChange} from '@angular/material/select';
 @Component({
   selector: 'select-with-filter',
   template: `
-    <mat-form-field appearance="fill" [style]="getOuterFormFieldStyle()">
+    <mat-form-field
+      [style]="getOuterFormFieldStyle()"
+      [style.text-align]="'unset'"
+      [appearance]="appearance"
+      [class]="formFieldClass"
+      [class.mat-body-2]="!select.value || select.value.length === 0">
       <mat-label>{{ label }}</mat-label>
       <mat-select
         (opened)="filter.focus()"
         (closed)="onSelectClosed()"
         (selectionChange)="onSelectChange($event)"
-        [multiple]="multiple"
-        [value]="value">
+        [multiple]="true"
+        #select>
         <mat-form-field class="select-filter" [style]="getInnerFormFieldStyle()">
           <mat-label>Filter options</mat-label>
           <input matInput #filter [(ngModel)]="filterString" />
@@ -44,7 +49,6 @@ import {MatSelectChange} from '@angular/material/select';
     `
       mat-form-field {
         width: 100%;
-        font-size: 12px;
       }
 
       .hidden-option {
@@ -59,8 +63,8 @@ export class SelectWithFilterComponent {
   @Input() outerFilterWidth = '100px';
   @Input() innerFilterWidth = '100';
   @Input() flex = 'none';
-  @Input() multiple = true;
-  @Input() value?: string | string[] | undefined;
+  @Input() appearance = '';
+  @Input() formFieldClass = '';
 
   @Output() readonly selectChange = new EventEmitter<MatSelectChange>();
 
diff --git a/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts b/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
index 672d8a99e..2b474cc9e 100644
--- a/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
@@ -19,6 +19,7 @@ export const timeButtonStyle = `
       padding: 0px;
       line-height: normal;
       text-align: left;
+      white-space: normal;
     }
 `;
 
diff --git a/tools/winscope/src/viewers/components/styles/log_component.styles.ts b/tools/winscope/src/viewers/components/styles/log_component.styles.ts
index 2d99e422e..0c70ce479 100644
--- a/tools/winscope/src/viewers/components/styles/log_component.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/log_component.styles.ts
@@ -24,11 +24,6 @@ export const logComponentStyles = `
     padding: 12px;
   }
 
-  .entries .filters {
-    display: flex;
-    flex-direction: row;
-  }
-
   .entries .scroll {
     flex: 1;
   }
@@ -39,22 +34,22 @@ export const logComponentStyles = `
     overflow-wrap: anywhere;
   }
 
-  .filters div,
+  .headers div,
   .entries div {
     padding: 4px;
   }
 
-  .time:not(.with-date) {
-    flex: 0 0 135px;
+  .filter {
+    align-content: center;
   }
 
-  .time.with-date {
-    flex: 0 0 175px;
+  .time {
+    flex: 1;
+    min-width: 135px;
   }
 
   .go-to-current-time {
-    font-size: 12px;
-    height: 75%;
+    height: 100%;
     width: fit-content;
   }
 
@@ -64,6 +59,7 @@ export const logComponentStyles = `
 
   .right-align {
     text-align: end;
+    justify-content: end;
   }
 
   .layer-or-display-id {
@@ -96,8 +92,9 @@ export const logComponentStyles = `
     min-width: 85px;
   }
 
-  .flags, .flags select-with-filter {
+  .flags {
     flex: 2;
+    min-width: 100px;
   }
 
   .log-level {
@@ -105,33 +102,27 @@ export const logComponentStyles = `
     min-width: 85px;
   }
 
-  .filters .log-level select-with-filter {
-    flex: 1;
-  }
-
-  .tag, .tag select-with-filter {
+  .tag {
     flex: 2;
+    min-width: 85px;
   }
 
-  .source-file, .source-file select-with-filter {
+  .source-file {
     flex: 4;
+    min-width: 150px;
   }
 
   .text {
     flex: 10;
   }
 
-  .filters mat-form-field {
-    width: 80%;
-    font-size: 12px;
-  }
-
   .title-section .filters {
     margin-top: 8px;
   }
 
   .transition-id {
-    flex: 1;
+    flex: none;
+    width: 40px;
   }
 
   .entries .headers {
@@ -142,29 +133,49 @@ export const logComponentStyles = `
     border-bottom: solid 1px rgba(0, 0, 0, 0.5);
   }
 
+  .header {
+    display: flex;
+    align-items: center;
+  }
+
   .transition-type {
+    flex: 1;
+    min-width: 100px;
+  }
+
+  .handler {
     flex: 3;
+    min-width: 70px;
   }
 
-  .jank_cuj-type {
-    flex: 8;
+  .participants {
+    flex: 3;
+    white-space: pre-wrap;
+    min-width: 100px;
+  }
+
+  .jank-cuj-type {
+    flex: 5;
   }
 
   .start-time, .end-time, .dispatch-time, .send-time {
-    flex: 3;
+    flex: 2;
+    min-width: 100px;
   }
 
   .duration {
-    flex: 2;
+    flex: none;
+    width: 60px;
   }
 
   .status {
-    flex: 3;
+    flex: none;
+    width: 110px;
   }
 
   .entry .status {
     display: flex;
-    align-items: center;
+    align-items: start;
     gap: 5px;
     justify-content: end;
   }
@@ -202,4 +213,8 @@ export const logComponentStyles = `
     display: flex;
     flex: 10;
   }
+
+  .search-result {
+    flex: 1;
+  }
 `;
diff --git a/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts b/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
index 9c44c410f..739116b5c 100644
--- a/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
@@ -15,72 +15,76 @@
  */
 
 export const viewerCardStyle = `
-    .rects-view:not(.collapsed),
-    .hierarchy-view:not(.collapsed),
-    .ime-additional-properties:not(.collapsed),
-    .properties-view:not(.collapsed),
-    .log-view:not(.collapsed),
-    .property-groups:not(.collapsed) {
-        display: flex;
-        flex-direction: column;
-        overflow: auto;
-        border-radius: 4px;
-        background-color: unset;
-        margin: 4px;
-        padding-bottom: 12px;
-        background-color: var(--background-color);
-        box-shadow: 0px 1px 3px var(--border-color), 0px 1px 2px var(--border-color);
-    }
+  .rects-view:not(.collapsed),
+  .hierarchy-view:not(.collapsed),
+  .ime-additional-properties:not(.collapsed),
+  .properties-view:not(.collapsed),
+  .log-view:not(.collapsed),
+  .property-groups:not(.collapsed),
+  .global-search:not(.collapsed),
+  .search-results:not(.collapsed),
+  .how-to-search:not(.collapsed) {
+    display: flex;
+    flex-direction: column;
+    overflow: auto;
+    border-radius: 4px;
+    margin: 4px;
+    padding-bottom: 12px;
+    background-color: var(--background-color);
+    box-shadow: 0px 1px 3px var(--border-color), 0px 1px 2px var(--border-color);
+  }
 
-    .rects-view:not(.collapsed),
-    .hierarchy-view:not(.collapsed),
-    .ime-additional-properties:not(.collapsed),
-    .properties-view:not(.collapsed) {
-        flex: 1;
-    }
+  .rects-view:not(.collapsed),
+  .hierarchy-view:not(.collapsed),
+  .ime-additional-properties:not(.collapsed),
+  .properties-view:not(.collapsed),
+  .global-search:not(.collapsed),
+  .how-to-search:not(.collapsed) {
+    flex: 1;
+  }
 
-    .property-groups:not(.collapsed):not(.empty) {
-      flex: 2;
-    }
+  .property-groups:not(.collapsed):not(.empty) {
+    flex: 2;
+  }
 
-    .property-groups.empty:not(.collapsed) {
-      flex: 0.2;
-    }
+  .property-groups.empty:not(.collapsed) {
+    flex: 0.2;
+  }
 
-    .log-view:not(.collapsed) {
-        flex: 3;
-    }
+  .log-view:not(.collapsed),
+  .search-results:not(.collapsed) {
+    flex: 3;
+  }
 
-    .rects-view.collapsed,
-    .hierarchy-view.collapsed,
-    .ime-additional-properties.collapsed,
-    .properties-view.collapsed,
-    .log-view.collapsed,
-    .property-groups.collapsed {
-        display: none;
-    }
+  .collapsed {
+    display: none;
+  }
 `;
 
 export const viewerCardInnerStyle = `
-    .title-section {
-        display: flex;
-        flex-direction: row;
-        flex-wrap: wrap;
-        justify-content: space-between;
-        background-color: var(--card-title-background-color);
-        padding: 0px 12px 0px 12px;
-    }
+  .title-section {
+    display: flex;
+    flex-direction: row;
+    flex-wrap: wrap;
+    justify-content: space-between;
+    background-color: var(--card-title-background-color);
+    padding: 0px 12px 0px 12px;
+  }
 
-    .view-controls {
-        display: flex;
-        flex-direction: row;
-        align-items: baseline;
-        padding: 8px 12px;
-        overflow-x: auto;
-        overflow-y: hidden;
-    }
+  .view-controls {
+    display: flex;
+    flex-direction: row;
+    align-items: baseline;
+    padding: 8px 12px;
+    overflow-x: auto;
+    overflow-y: hidden;
+  }
 
-    .placeholder-text {
-      padding: 8px 12px;
-    }
+  .placeholder-text {
+    padding: 8px 12px;
+  }
+
+  .padded-title {
+    padding-bottom: 8px;
+  }
 `;
diff --git a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
index 0cb8d9aad..c491a2101 100644
--- a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
+++ b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
@@ -46,7 +46,6 @@ describe('SurfaceFlingerPropertyGroupsComponent', () => {
         TransformMatrixComponent,
         CollapsibleSectionTitleComponent,
       ],
-      schemas: [],
     }).compileComponents();
     fixture = TestBed.createComponent(TestHostComponent);
     component = fixture.componentInstance;
diff --git a/tools/winscope/src/viewers/components/transform_matrix_component_test.ts b/tools/winscope/src/viewers/components/transform_matrix_component_test.ts
index aec4321e8..4e0718bd1 100644
--- a/tools/winscope/src/viewers/components/transform_matrix_component_test.ts
+++ b/tools/winscope/src/viewers/components/transform_matrix_component_test.ts
@@ -28,7 +28,6 @@ describe('TransformMatrixComponent', () => {
     await TestBed.configureTestingModule({
       providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
       declarations: [TransformMatrixComponent],
-      schemas: [],
     }).compileComponents();
   });
 
diff --git a/tools/winscope/src/viewers/components/view_capture_property_groups_component_test.ts b/tools/winscope/src/viewers/components/view_capture_property_groups_component_test.ts
index 8736759ef..420bd197b 100644
--- a/tools/winscope/src/viewers/components/view_capture_property_groups_component_test.ts
+++ b/tools/winscope/src/viewers/components/view_capture_property_groups_component_test.ts
@@ -40,7 +40,6 @@ describe('ViewCapturePropertyGroupsComponent', () => {
         ViewCapturePropertyGroupsComponent,
         TransformMatrixComponent,
       ],
-      schemas: [],
     }).compileComponents();
     fixture = TestBed.createComponent(TestHostComponent);
     component = fixture.componentInstance;
diff --git a/tools/winscope/src/viewers/viewer.ts b/tools/winscope/src/viewers/viewer.ts
index b6c6bdec1..4fc8cf32c 100644
--- a/tools/winscope/src/viewers/viewer.ts
+++ b/tools/winscope/src/viewers/viewer.ts
@@ -22,8 +22,9 @@ import {WinscopeEventListener} from 'messaging/winscope_event_listener';
 import {Trace} from 'trace/trace';
 
 enum ViewType {
-  TAB,
+  TRACE_TAB,
   OVERLAY,
+  GLOBAL_SEARCH,
 }
 
 class View {
diff --git a/tools/winscope/src/viewers/viewer_factory.ts b/tools/winscope/src/viewers/viewer_factory.ts
index cc9105780..7be713c83 100644
--- a/tools/winscope/src/viewers/viewer_factory.ts
+++ b/tools/winscope/src/viewers/viewer_factory.ts
@@ -19,7 +19,7 @@ import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType, TraceTypeUtils} from 'trace/trace_type';
-import {Viewer} from './viewer';
+import {Viewer, ViewType} from './viewer';
 import {ViewerInput} from './viewer_input/viewer_input';
 import {ViewerInputMethodClients} from './viewer_input_method_clients/viewer_input_method_clients';
 import {ViewerInputMethodManagerService} from './viewer_input_method_manager_service/viewer_input_method_manager_service';
@@ -28,6 +28,7 @@ import {ViewerJankCujs} from './viewer_jank_cujs/viewer_jank_cujs';
 import {ViewerScreenshot} from './viewer_media_based/viewer_screenshot';
 import {ViewerScreenRecording} from './viewer_media_based/viewer_screen_recording';
 import {ViewerProtoLog} from './viewer_protolog/viewer_protolog';
+import {ViewerSearch} from './viewer_search/viewer_search';
 import {ViewerSurfaceFlinger} from './viewer_surface_flinger/viewer_surface_flinger';
 import {ViewerTransactions} from './viewer_transactions/viewer_transactions';
 import {ViewerTransitions} from './viewer_transitions/viewer_transitions';
@@ -57,6 +58,13 @@ class ViewerFactory {
   createViewers(traces: Traces, storage: Store): Viewer[] {
     const viewers: Viewer[] = [];
 
+    for (const trace of traces) {
+      if (trace.canSearch()) {
+        viewers.push(new ViewerSearch(traces, storage));
+        break;
+      }
+    }
+
     // instantiate one viewer for one trace
     traces.forEachTrace((trace) => {
       ViewerFactory.SINGLE_TRACE_VIEWERS.forEach((Viewer) => {
@@ -83,12 +91,31 @@ class ViewerFactory {
     // Note:
     // the final order of tabs/views in the UI corresponds the order of the
     // respective viewers below
-    return viewers.sort((a, b) =>
-      TraceTypeUtils.compareByDisplayOrder(
-        a.getTraces()[0].type,
-        b.getTraces()[0].type,
-      ),
-    );
+    return viewers.sort((a, b) => {
+      const aView = a.getViews()[0];
+      const bView = b.getViews()[0];
+      if (
+        aView.type === ViewType.TRACE_TAB &&
+        bView.type === ViewType.TRACE_TAB
+      ) {
+        return TraceTypeUtils.compareByDisplayOrder(
+          a.getTraces()[0].type,
+          b.getTraces()[0].type,
+        );
+      } else if (
+        aView.type === ViewType.GLOBAL_SEARCH &&
+        bView.type !== ViewType.GLOBAL_SEARCH
+      ) {
+        return -1;
+      } else if (
+        aView.type !== ViewType.GLOBAL_SEARCH &&
+        bView.type === ViewType.GLOBAL_SEARCH
+      ) {
+        return 1;
+      } else {
+        return aView.title < bView.title ? -1 : 1;
+      }
+    });
   }
 }
 
diff --git a/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts
index 3bd80ec6e..fe3c0b5cd 100644
--- a/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts
+++ b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts
@@ -56,8 +56,8 @@ export class DispatchEntryFormatter implements Operation<UiPropertyTreeNode> {
     let formattedPointers = '';
     dispatchedPointerNode.getAllChildren()?.forEach((pointer) => {
       const axisValues = pointer.getChildByName('axisValueInWindow');
-      let x = '';
-      let y = '';
+      let x = '?';
+      let y = '?';
       axisValues?.getAllChildren()?.forEach((axisValue) => {
         const axis = Number(axisValue.getChildByName('axis')?.getValue());
         if (axis === DispatchEntryFormatter.AXIS_X) {
diff --git a/tools/winscope/src/viewers/viewer_input/presenter.ts b/tools/winscope/src/viewers/viewer_input/presenter.ts
index cf3152d56..ab4f62c74 100644
--- a/tools/winscope/src/viewers/viewer_input/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_input/presenter.ts
@@ -19,7 +19,7 @@ import {PersistentStoreProxy} from 'common/persistent_store_proxy';
 import {Store} from 'common/store';
 import {TabbedViewSwitchRequest} from 'messaging/winscope_event';
 import {CustomQueryType} from 'trace/custom_query';
-import {Trace, TraceEntry} from 'trace/trace';
+import {Trace, TraceEntry, TraceEntryLazy} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
@@ -29,10 +29,12 @@ import {
   NotifyLogViewCallbackType,
 } from 'viewers/common/abstract_log_viewer_presenter';
 import {VISIBLE_CHIP} from 'viewers/common/chip';
+import {LogSelectFilter} from 'viewers/common/log_filters';
 import {LogPresenter} from 'viewers/common/log_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
 import {RectsPresenter} from 'viewers/common/rects_presenter';
-import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {UI_RECT_FACTORY} from 'viewers/common/ui_rect_factory';
 import {UserOptions} from 'viewers/common/user_options';
 import {ViewerEvents} from 'viewers/common/viewer_events';
@@ -48,16 +50,40 @@ enum InputEventType {
   MOTION,
 }
 
-export class Presenter extends AbstractLogViewerPresenter<UiData> {
-  static readonly FIELD_TYPES = [
-    LogFieldType.INPUT_TYPE,
-    LogFieldType.INPUT_SOURCE,
-    LogFieldType.INPUT_ACTION,
-    LogFieldType.INPUT_DEVICE_ID,
-    LogFieldType.INPUT_DISPLAY_ID,
-    LogFieldType.INPUT_EVENT_DETAILS,
-  ];
-
+export class Presenter extends AbstractLogViewerPresenter<
+  UiData,
+  PropertyTreeNode
+> {
+  private static readonly COLUMNS = {
+    type: {
+      name: 'Type',
+      cssClass: 'input-type inline',
+    },
+    source: {
+      name: 'Source',
+      cssClass: 'input-source',
+    },
+    action: {
+      name: 'Action',
+      cssClass: 'input-action',
+    },
+    deviceId: {
+      name: 'Device',
+      cssClass: 'input-device-id right-align',
+    },
+    displayId: {
+      name: 'Display',
+      cssClass: 'input-display-id right-align',
+    },
+    details: {
+      name: 'Details',
+      cssClass: 'input-details',
+    },
+    dispatchWindows: {
+      name: 'Target Windows',
+      cssClass: 'input-windows',
+    },
+  };
   static readonly DENYLIST_DISPATCH_PROPERTIES = ['eventId'];
 
   private readonly traces: Traces;
@@ -71,12 +97,12 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
   protected override logPresenter = new LogPresenter<InputEntry>();
   protected override propertiesPresenter = new PropertiesPresenter(
     {},
-    undefined,
+    new TextFilter(),
     [],
   );
   protected dispatchPropertiesPresenter = new PropertiesPresenter(
     {},
-    undefined,
+    new TextFilter(),
     Presenter.DENYLIST_DISPATCH_PROPERTIES,
     [new DispatchEntryFormatter(this.layerIdToName)],
   );
@@ -124,80 +150,145 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     this.surfaceFlingerTrace = this.traces.getTrace(TraceType.SURFACE_FLINGER);
   }
 
-  protected override async initializeIfNeeded() {
-    if (this.allEntries !== undefined) {
-      return;
-    }
+  async onDispatchPropertiesFilterChange(textFilter: TextFilter) {
+    this.dispatchPropertiesPresenter.applyPropertiesFilterChange(textFilter);
+    await this.updateDispatchPropertiesTree();
+    this.uiData.dispatchPropertiesFilter = textFilter;
+    this.notifyViewChanged();
+  }
 
+  protected override async initializeTraceSpecificData() {
     if (this.surfaceFlingerTrace !== undefined) {
       const layerMappings = await this.surfaceFlingerTrace.customQuery(
         CustomQueryType.SF_LAYERS_ID_AND_NAME,
       );
       layerMappings.forEach(({id, name}) => this.layerIdToName.set(id, name));
     }
+  }
 
-    this.allEntries = await this.makeInputEntries();
-
-    this.logPresenter.setAllEntries(this.allEntries);
-    this.logPresenter.setHeaders(Presenter.FIELD_TYPES);
-    this.logPresenter.setFilters([
-      {
-        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
-        options: [...this.allInputLayerIds.values()].map((layerId) => {
-          return this.getLayerDisplayName(layerId);
-        }),
-      },
-    ]);
-
-    this.refreshUiData();
+  protected override makeHeaders(): LogHeader[] {
+    return [
+      new LogHeader(Presenter.COLUMNS.type),
+      new LogHeader(Presenter.COLUMNS.source),
+      new LogHeader(Presenter.COLUMNS.action),
+      new LogHeader(Presenter.COLUMNS.deviceId),
+      new LogHeader(Presenter.COLUMNS.displayId),
+      new LogHeader(Presenter.COLUMNS.details),
+      new LogHeader(
+        Presenter.COLUMNS.dispatchWindows,
+        new LogSelectFilter([], true, '300', '300px'),
+      ),
+    ];
   }
 
-  private async makeInputEntries(): Promise<InputEntry[]> {
+  protected override async makeUiDataEntries(): Promise<InputEntry[]> {
     const entries: InputEntry[] = [];
     for (let i = 0; i < this.trace.lengthEntries; i++) {
-      const entry = assertDefined(this.trace.getEntry(i));
-      const wrapperTree = await entry.getValue();
-
-      let type = InputEventType.KEY;
-      let eventTree = wrapperTree.getChildByName('keyEvent');
-      if (eventTree === undefined || eventTree.getAllChildren().length === 0) {
-        eventTree = assertDefined(wrapperTree.getChildByName('motionEvent'));
-        type = InputEventType.MOTION;
-      }
-      eventTree.setIsRoot(true);
+      const traceEntry = assertDefined(this.trace.getEntry(i));
+      const entry = await this.makeInputEntry(traceEntry);
+      entries.push(entry);
+    }
+    return Promise.resolve(entries);
+  }
 
-      const dispatchTree = assertDefined(
-        wrapperTree.getChildByName('windowDispatchEvents'),
-      );
-      dispatchTree.setIsRoot(true);
-      dispatchTree.getAllChildren().forEach((dispatchEntry) => {
-        const windowIdNode = dispatchEntry.getChildByName('windowId');
-        const windowId = Number(windowIdNode?.getValue() ?? -1);
-        this.allInputLayerIds.add(windowId);
+  protected override updateFiltersInHeaders(headers: LogHeader[]) {
+    const dispatchWindowsHeader = headers.find(
+      (header) => header.spec === Presenter.COLUMNS.dispatchWindows,
+    );
+    (assertDefined(dispatchWindowsHeader?.filter) as LogSelectFilter).options =
+      [...this.allInputLayerIds.values()].map((layerId) => {
+        return this.getLayerDisplayName(layerId);
       });
+  }
 
-      let sfEntry: TraceEntry<HierarchyTreeNode> | undefined;
-      if (this.surfaceFlingerTrace !== undefined && this.trace.hasFrameInfo()) {
-        const frame = entry.getFramesRange()?.start;
-        if (frame !== undefined) {
-          const sfFrame = this.surfaceFlingerTrace.getFrame(frame);
-          if (sfFrame.lengthEntries > 0) {
-            sfEntry = sfFrame.getEntry(0);
-          }
+  private async makeInputEntry(
+    traceEntry: TraceEntryLazy<PropertyTreeNode>,
+  ): Promise<InputEntry> {
+    const wrapperTree = await traceEntry.getValue();
+
+    let eventTree = wrapperTree.getChildByName('keyEvent');
+    let type = InputEventType.KEY;
+    if (eventTree === undefined || eventTree.getAllChildren().length === 0) {
+      eventTree = assertDefined(wrapperTree.getChildByName('motionEvent'));
+      type = InputEventType.MOTION;
+    }
+    eventTree.setIsRoot(true);
+
+    const dispatchTree = assertDefined(
+      wrapperTree.getChildByName('windowDispatchEvents'),
+    );
+    dispatchTree.setIsRoot(true);
+    dispatchTree.getAllChildren().forEach((dispatchEntry) => {
+      const windowIdNode = dispatchEntry.getChildByName('windowId');
+      const windowId = Number(windowIdNode?.getValue() ?? -1);
+      this.allInputLayerIds.add(windowId);
+    });
+
+    let sfEntry: TraceEntry<HierarchyTreeNode> | undefined;
+    if (this.surfaceFlingerTrace !== undefined && this.trace.hasFrameInfo()) {
+      const frame = traceEntry.getFramesRange()?.start;
+      if (frame !== undefined) {
+        const sfFrame = this.surfaceFlingerTrace.getFrame(frame);
+        if (sfFrame.lengthEntries > 0) {
+          sfEntry = sfFrame.getEntry(0);
         }
       }
-
-      entries.push(
-        new InputEntry(
-          entry,
-          this.extractLogFields(eventTree, dispatchTree, type),
-          eventTree,
-          dispatchTree,
-          sfEntry,
-        ),
-      );
     }
-    return Promise.resolve(entries);
+
+    return new InputEntry(
+      traceEntry,
+      [
+        {
+          spec: Presenter.COLUMNS.type,
+          value: type === InputEventType.KEY ? 'KEY' : 'MOTION',
+          propagateEntryTimestamp: true,
+        },
+        {
+          spec: Presenter.COLUMNS.source,
+          value: assertDefined(eventTree.getChildByName('source'))
+            .formattedValue()
+            .replace('SOURCE_', ''),
+        },
+        {
+          spec: Presenter.COLUMNS.action,
+          value: assertDefined(eventTree.getChildByName('action'))
+            .formattedValue()
+            .replace('ACTION_', ''),
+        },
+        {
+          spec: Presenter.COLUMNS.deviceId,
+          value: assertDefined(eventTree.getChildByName('deviceId')).getValue(),
+        },
+        {
+          spec: Presenter.COLUMNS.displayId,
+          value: assertDefined(
+            eventTree.getChildByName('displayId'),
+          ).getValue(),
+        },
+        {
+          spec: Presenter.COLUMNS.details,
+          value:
+            type === InputEventType.KEY
+              ? Presenter.extractKeyDetails(eventTree, dispatchTree)
+              : Presenter.extractDispatchDetails(dispatchTree),
+        },
+        {
+          spec: Presenter.COLUMNS.dispatchWindows,
+          value: dispatchTree
+            .getAllChildren()
+            .map((dispatchEntry) => {
+              const windowId = Number(
+                dispatchEntry.getChildByName('windowId')?.getValue() ?? -1,
+              );
+              return this.getLayerDisplayName(windowId);
+            })
+            .join(', '),
+        },
+      ],
+      eventTree,
+      dispatchTree,
+      sfEntry,
+    );
   }
 
   private getLayerDisplayName(layerId: number): string {
@@ -208,97 +299,44 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     }\u{200C}`;
   }
 
-  private extractLogFields(
+  private static extractKeyDetails(
     eventTree: PropertyTreeNode,
     dispatchTree: PropertyTreeNode,
-    type: InputEventType,
-  ): LogField[] {
-    const targetWindows: string[] = [];
-    dispatchTree.getAllChildren().forEach((dispatchEntry) => {
-      const windowId = Number(
-        dispatchEntry.getChildByName('windowId')?.getValue() ?? -1,
-      );
-      targetWindows.push(this.getLayerDisplayName(windowId));
-    });
-
-    return [
-      {
-        type: LogFieldType.INPUT_TYPE,
-        value: type === InputEventType.KEY ? 'KEY' : 'MOTION',
-      },
-      {
-        type: LogFieldType.INPUT_SOURCE,
-        value: assertDefined(eventTree.getChildByName('source'))
-          .formattedValue()
-          .replace('SOURCE_', ''),
-      },
-      {
-        type: LogFieldType.INPUT_ACTION,
-        value: assertDefined(eventTree.getChildByName('action'))
-          .formattedValue()
-          .replace('ACTION_', ''),
-      },
-      {
-        type: LogFieldType.INPUT_DEVICE_ID,
-        value: assertDefined(eventTree.getChildByName('deviceId')).getValue(),
-      },
-      {
-        type: LogFieldType.INPUT_DISPLAY_ID,
-        value: assertDefined(eventTree.getChildByName('displayId')).getValue(),
-      },
-      {
-        type: LogFieldType.INPUT_EVENT_DETAILS,
-        value:
-          type === InputEventType.KEY
-            ? Presenter.extractKeyDetails(eventTree)
-            : Presenter.extractMotionDetails(eventTree),
-      },
-      {
-        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
-        value: targetWindows.join(', '),
-      },
-    ];
+  ): string {
+    const keyDetails =
+      'Keycode: ' +
+        eventTree
+          .getChildByName('keyCode')
+          ?.formattedValue()
+          ?.replace(/^KEYCODE_/, '') ?? '<?>';
+    return keyDetails + ' ' + Presenter.extractDispatchDetails(dispatchTree);
   }
 
-  private static extractKeyDetails(eventTree: PropertyTreeNode): string {
-    return (
-      'Keycode: ' + eventTree.getChildByName('keyCode')?.formattedValue() ??
-      'not present'
-    );
-  }
-
-  private static extractMotionDetails(eventTree: PropertyTreeNode): string {
+  private static extractDispatchDetails(
+    dispatchTree: PropertyTreeNode,
+  ): string {
     let details = '';
-    const pointers =
-      eventTree.getChildByName('pointer')?.getAllChildren() ?? [];
-    pointers.forEach((pointer) => {
-      const id = pointer.getChildByName('pointerId')?.formattedValue() ?? '?';
-      let x = '?';
-      let y = '?';
-      const axisValues =
-        pointer.getChildByName('axisValue')?.getAllChildren() ?? [];
-      axisValues.forEach((axisValue) => {
-        if (axisValue.getChildByName('axis')?.formattedValue() === 'AXIS_X') {
-          x = axisValue.getChildByName('value')?.getValue();
-          return;
-        }
-        if (axisValue.getChildByName('axis')?.formattedValue() === 'AXIS_Y') {
-          y = axisValue.getChildByName('value')?.getValue();
-          return;
-        }
-      });
-
-      if (details.length !== 0) {
-        details += ', ';
+    dispatchTree.getAllChildren().forEach((dispatchEntry) => {
+      const windowIdNode = dispatchEntry.getChildByName('windowId');
+      if (windowIdNode === undefined) {
+        return;
+      }
+      if (windowIdNode.formattedValue() === '0') {
+        // Skip showing windowId 0, which is an omnipresent system window.
+        return;
       }
-      details += '[' + id + ': (' + x + ', ' + y + ')]';
+      details += windowIdNode.getValue() + ', ';
     });
-    return details;
+    return '[' + details.slice(0, -2) + ']';
   }
 
   protected override async updatePropertiesTree() {
     await super.updatePropertiesTree();
+    await this.updateDispatchPropertiesTree();
+    await this.updateRects();
+  }
 
+  private async updateDispatchPropertiesTree() {
     const inputEntry = this.getCurrentEntry();
     const tree = inputEntry?.dispatchPropertiesTree;
     this.dispatchPropertiesPresenter.setPropertiesTree(tree);
@@ -309,8 +347,6 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     );
     this.uiData.dispatchPropertiesTree =
       this.dispatchPropertiesPresenter.getFormattedTree();
-
-    await this.updateRects();
   }
 
   private async updateRects() {
@@ -381,17 +417,26 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     htmlElement.addEventListener(ViewerEvents.RectsDblClick, async (event) => {
       await this.onRectDoubleClick();
     });
+
+    htmlElement.addEventListener(
+      ViewerEvents.DispatchPropertiesFilterChange,
+      async (event) => {
+        const detail: TextFilter = (event as CustomEvent).detail;
+        await this.onDispatchPropertiesFilterChange(detail);
+      },
+    );
   }
 
   onHighlightedPropertyChange(id: string) {
     this.propertiesPresenter.applyHighlightedPropertyChange(id);
     this.dispatchPropertiesPresenter.applyHighlightedPropertyChange(id);
-    this.uiData.highlightedProperty = id;
+    this.uiData.highlightedProperty =
+      id === this.uiData.highlightedProperty ? '' : id;
     this.notifyViewChanged();
   }
 
   async onHighlightedIdChange(id: string) {
-    this.uiData.highlightedRect = id;
+    this.uiData.highlightedRect = id === this.uiData.highlightedRect ? '' : id;
     await this.updateRects();
     this.notifyViewChanged();
   }
diff --git a/tools/winscope/src/viewers/viewer_input/presenter_test.ts b/tools/winscope/src/viewers/viewer_input/presenter_test.ts
index be906e693..5915b3cb4 100644
--- a/tools/winscope/src/viewers/viewer_input/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_input/presenter_test.ts
@@ -16,7 +16,10 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {TracePositionUpdate} from 'messaging/winscope_event';
+import {
+  TabbedViewSwitchRequest,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
 import {Transform} from 'parsers/surface_flinger/transform_utils';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
@@ -33,19 +36,79 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
 import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
-import {
-  LogFieldType,
-  LogFieldValue,
-  UiDataLog,
-} from 'viewers/common/ui_data_log';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogField, LogHeader} from 'viewers/common/ui_data_log';
+import {UserOptions} from 'viewers/common/user_options';
+import {ViewerEvents} from 'viewers/common/viewer_events';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
 class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader({
+        name: 'Type',
+        cssClass: 'input-type inline',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Source',
+        cssClass: 'input-source',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Action',
+        cssClass: 'input-action',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Device',
+        cssClass: 'input-device-id right-align',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Display',
+        cssClass: 'input-display-id right-align',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Details',
+        cssClass: 'input-details',
+      }),
+    },
+    {
+      header: new LogHeader(
+        {
+          name: 'Target Windows',
+          cssClass: 'input-windows',
+        },
+        new LogSelectFilter(
+          Array.from({length: 6}, () => ''),
+          true,
+          '100',
+          '100%',
+        ),
+      ),
+      options: [
+        this.wrappedName('win-212'),
+        this.wrappedName('win-64'),
+        this.wrappedName('win-82'),
+        this.wrappedName('win-75'),
+        this.wrappedName('win-zero-not-98'),
+        this.wrappedName('98'),
+      ],
+    },
+  ];
   private trace: Trace<PropertyTreeNode> | undefined;
   private surfaceFlingerTrace: Trace<HierarchyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
-  private secondPositionUpdate: TracePositionUpdate | undefined;
   private layerIdToName: Array<{id: number; name: string}> = [
     {id: 0, name: 'win-zero-not-98'},
     {id: 212, name: 'win-212'},
@@ -55,86 +118,6 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
     // The layer name for window with id 98 is omitted to test incomplete mapping.
   ];
 
-  override readonly shouldExecuteHeaderTests = true;
-  override readonly shouldExecuteFilterTests = true;
-  override readonly shouldExecutePropertiesTests = true;
-
-  override readonly totalOutputEntries = 8;
-  override readonly expectedIndexOfFirstPositionUpdate = 0;
-  override readonly expectedIndexOfSecondPositionUpdate = 2;
-  override readonly logEntryClickIndex = 3;
-  override readonly expectedInitialFilterOptions = new Map<
-    LogFieldType,
-    string[] | number
-  >([
-    [
-      LogFieldType.INPUT_DISPATCH_WINDOWS,
-      [
-        wrappedName('win-212'),
-        wrappedName('win-64'),
-        wrappedName('win-82'),
-        wrappedName('win-75'),
-        wrappedName('win-zero-not-98'),
-        wrappedName('98'),
-      ],
-    ],
-  ]);
-  override readonly filterValuesToSet = new Map<
-    LogFieldType,
-    Array<string | string[]>
-  >([
-    [
-      LogFieldType.INPUT_DISPATCH_WINDOWS,
-      [
-        // Case 1: No filter.
-        [],
-        // Case 2: The second entry is dispatched only to window '98'. Also ensure
-        // that this does not match events dispatched to window 'win-zero-not-98'.
-        [wrappedName('98')],
-        // Case 3: Events dispatched to 64 are also dispatched to other windows.
-        [wrappedName('win-64')],
-        // Case 4: Multiple filters that match all events.
-        [wrappedName('win-zero-not-98'), wrappedName('98')],
-      ],
-    ],
-  ]);
-  override readonly expectedFieldValuesAfterFilter = new Map<
-    LogFieldType,
-    Array<LogFieldValue[] | number>
-  >([
-    [
-      LogFieldType.INPUT_DISPATCH_WINDOWS,
-      [
-        // Case 1
-        this.totalOutputEntries,
-        // Case 2
-        [wrappedName('98')],
-        // Case 3
-        [
-          [
-            wrappedName('win-212'),
-            wrappedName('win-64'),
-            wrappedName('win-82'),
-            wrappedName('win-75'),
-            wrappedName('win-zero-not-98'),
-          ].join(', '),
-        ],
-        // Case 4
-        this.totalOutputEntries,
-      ],
-    ],
-  ]);
-
-  override readonly filterNameForCurrentIndexTest =
-    LogFieldType.INPUT_DISPATCH_WINDOWS;
-  override readonly filterChangeForCurrentIndexTest = [wrappedName('98')];
-  override readonly secondFilterChangeForCurrentIndexTest = [
-    wrappedName('98'),
-    wrappedName('515'),
-  ];
-  override readonly expectedCurrentIndexAfterFilterChange = 0;
-  override readonly expectedCurrentIndexAfterSecondFilterChange = 0;
-
   override async setUpTestEnvironment(): Promise<void> {
     const parser = (await UnitTestUtils.getTracesParser([
       'traces/perfetto/input-events.perfetto-trace',
@@ -157,9 +140,6 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
     this.positionUpdate = TracePositionUpdate.fromTraceEntry(
       this.trace.getEntry(0),
     );
-    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
-      this.trace.getEntry(2),
-    );
   }
 
   override async createPresenterWithEmptyTrace(
@@ -206,48 +186,36 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
     return assertDefined(this.positionUpdate);
   }
 
-  override getSecondPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.secondPositionUpdate);
-  }
-
-  override executePropertiesChecksForEmptyTrace(uiDataLog: UiDataLog) {
-    const uiData = uiDataLog as UiData;
+  override executePropertiesChecksForEmptyTrace(uiData: UiData) {
     expect(uiData.highlightedProperty).toBeFalsy();
     expect(uiData.dispatchPropertiesTree).toBeUndefined();
+    expect(uiData.dispatchPropertiesFilter).toBeDefined();
   }
 
-  override executePropertiesChecksAfterPositionUpdate(
-    uiDataLog: UiDataLog,
-  ): void {
-    expect(uiDataLog.entries.length).toEqual(8);
-    expect(uiDataLog.currentIndex).toEqual(0);
-    expect(uiDataLog.selectedIndex).toBeUndefined();
-    const curEntry = uiDataLog.entries[0];
-    const expectedFields = [
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiData): void {
+    expect(uiData.entries.length).toEqual(8);
+    expect(uiData.currentIndex).toEqual(0);
+    expect(uiData.selectedIndex).toBeUndefined();
+    const curEntry = uiData.entries[0];
+    const expectedFields: LogField[] = [
       {
-        type: LogFieldType.INPUT_TYPE,
+        spec: uiData.headers[0].spec,
         value: 'MOTION',
+        propagateEntryTimestamp: true,
       },
+      {spec: uiData.headers[1].spec, value: 'TOUCHSCREEN'},
+      {spec: uiData.headers[2].spec, value: 'DOWN'},
+      {spec: uiData.headers[3].spec, value: 4},
+      {spec: uiData.headers[4].spec, value: 0},
+      {spec: uiData.headers[5].spec, value: '[212, 64, 82, 75]'},
       {
-        type: LogFieldType.INPUT_SOURCE,
-        value: 'TOUCHSCREEN',
-      },
-      {
-        type: LogFieldType.INPUT_ACTION,
-        value: 'DOWN',
-      },
-      {
-        type: LogFieldType.INPUT_EVENT_DETAILS,
-        value: '[0: (431, 624)]',
-      },
-      {
-        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
+        spec: uiData.headers[6].spec,
         value: [
-          wrappedName('win-212'),
-          wrappedName('win-64'),
-          wrappedName('win-82'),
-          wrappedName('win-75'),
-          wrappedName('win-zero-not-98'),
+          this.wrappedName('win-212'),
+          this.wrappedName('win-64'),
+          this.wrappedName('win-82'),
+          this.wrappedName('win-75'),
+          this.wrappedName('win-zero-not-98'),
         ].join(', '),
       },
     ];
@@ -255,7 +223,7 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
       expect(curEntry.fields).toContain(field);
     });
 
-    const motionEvent = assertDefined(uiDataLog.propertiesTree);
+    const motionEvent = assertDefined(uiData.propertiesTree);
     expect(motionEvent.getChildByName('eventId')?.getValue()).toEqual(
       330184796,
     );
@@ -263,7 +231,6 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
       'ACTION_DOWN',
     );
 
-    const uiData = uiDataLog as UiData;
     const dispatchProperties = assertDefined(uiData.dispatchPropertiesTree);
     expect(dispatchProperties.getAllChildren().length).toEqual(5);
 
@@ -401,6 +368,54 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
         await this.setUpTestEnvironment();
       });
 
+      it('adds events listeners', async () => {
+        const element = document.createElement('div');
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        presenter.addEventListeners(element);
+
+        const testId = 'testId';
+
+        let spy: jasmine.Spy = spyOn(presenter, 'onHighlightedPropertyChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HighlightedPropertyChange, {
+            detail: {id: testId},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(testId);
+
+        spy = spyOn(presenter, 'onHighlightedIdChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HighlightedIdChange, {
+            detail: {id: testId},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(testId);
+
+        spy = spyOn(presenter, 'onRectsUserOptionsChange');
+        const userOptions = {};
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.RectsUserOptionsChange, {
+            detail: {userOptions},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(userOptions);
+
+        spy = spyOn(presenter, 'onRectDoubleClick');
+        element.dispatchEvent(new CustomEvent(ViewerEvents.RectsDblClick));
+        expect(spy).toHaveBeenCalled();
+
+        spy = spyOn(presenter, 'onDispatchPropertiesFilterChange');
+        const filter = new TextFilter();
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.DispatchPropertiesFilterChange, {
+            detail: filter,
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(filter);
+      });
+
       it('updates selected entry', async () => {
         const presenter = await this.createPresenter(
           (uiDataLog) => (uiData = uiDataLog as UiData),
@@ -570,6 +585,147 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
 
       it('extracts corresponding input rects from SF trace', async () => {
         const parser = assertDefined(this.trace).getParser();
+        const traces = await getTracesWithSf(parser, this.layerIdToName);
+        const trace = assertDefined(
+          traces.getTrace(TraceType.INPUT_EVENT_MERGED),
+        );
+
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(0)),
+        );
+        expect(uiData.rectsToDraw).toEqual([]);
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(1)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(2)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(3)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(3);
+        uiData.rectsToDraw?.forEach((rect) =>
+          expect(rect.id).toEqual('inputRect'),
+        );
+      });
+
+      it('filters dispatch properties tree', async () => {
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(this.getPositionUpdate());
+        await presenter.onLogEntryClick(3);
+        expect(
+          assertDefined(uiData.dispatchPropertiesTree).getAllChildren().length,
+        ).toEqual(5);
+        await presenter.onDispatchPropertiesFilterChange(new TextFilter('212'));
+        expect(
+          assertDefined(uiData.dispatchPropertiesTree).getAllChildren().length,
+        ).toEqual(1);
+      });
+
+      it('updates highlighted property', async () => {
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        expect(uiData.highlightedProperty).toEqual('');
+        const id = '4';
+        presenter.onHighlightedPropertyChange(id);
+        expect(uiData.highlightedProperty).toEqual(id);
+        presenter.onHighlightedPropertyChange(id);
+        expect(uiData.highlightedProperty).toEqual('');
+      });
+
+      it('updates highlighted rect', async () => {
+        const parser = assertDefined(this.trace).getParser();
+        const traces = await getTracesWithSf(parser, this.layerIdToName);
+        const trace = assertDefined(
+          traces.getTrace(TraceType.INPUT_EVENT_MERGED),
+        );
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(1)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+
+        const rect = assertDefined(uiData.rectsToDraw)[0];
+        await presenter.onHighlightedIdChange(rect.id);
+        expect(uiData.highlightedRect).toEqual(rect.id);
+        await presenter.onHighlightedIdChange(rect.id);
+        expect(uiData.highlightedRect).toEqual('');
+      });
+
+      it('filters rects by having content or visibility', async () => {
+        const userOptions: UserOptions = {
+          showOnlyVisible: {
+            name: 'Show only',
+            chip: VISIBLE_CHIP,
+            enabled: false,
+          },
+          showOnlyWithContent: {
+            name: 'Has input',
+            icon: 'pan_tool_alt',
+            enabled: true,
+          },
+        };
+        const parser = assertDefined(this.trace).getParser();
+        const traces = await getTracesWithSf(parser, this.layerIdToName);
+        const trace = assertDefined(
+          traces.getTrace(TraceType.INPUT_EVENT_MERGED),
+        );
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(1)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+
+        await presenter.onRectsUserOptionsChange(userOptions);
+        expect(uiData.rectsUserOptions).toEqual(userOptions);
+        expect(uiData.rectsToDraw).toHaveSize(0);
+
+        userOptions['showOnlyVisible'].enabled = true;
+        userOptions['showOnlyWithContent'].enabled = false;
+        await presenter.onRectsUserOptionsChange(userOptions);
+        expect(uiData.rectsToDraw).toHaveSize(1);
+      });
+
+      it('emits event on rect double click', async () => {
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+        await presenter.onRectDoubleClick();
+        expect(spy).toHaveBeenCalledWith(
+          new TabbedViewSwitchRequest(assertDefined(this.surfaceFlingerTrace)),
+        );
+      });
+
+      async function getTracesWithSf(
+        parser: Parser<PropertyTreeNode>,
+        layerIdToName: Array<{
+          id: number;
+          name: string;
+        }>,
+      ) {
         const traces = new Traces();
 
         // FRAME:         0     1   2   3
@@ -600,47 +756,18 @@ class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
           .setFrame(2, 3)
           .setParserCustomQueryResult(
             CustomQueryType.SF_LAYERS_ID_AND_NAME,
-            this.layerIdToName,
+            layerIdToName,
           )
           .build();
         traces.addTrace(sfTrace);
-
-        const presenter = PresenterInputTest.createPresenterWithTraces(
-          traces,
-          (uiDataLog) => (uiData = uiDataLog as UiData),
-        );
-
-        await presenter.onAppEvent(
-          TracePositionUpdate.fromTraceEntry(trace.getEntry(0)),
-        );
-        expect(uiData.rectsToDraw).toEqual([]);
-
-        await presenter.onAppEvent(
-          TracePositionUpdate.fromTraceEntry(trace.getEntry(1)),
-        );
-        expect(uiData.rectsToDraw).toHaveSize(1);
-        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
-
-        await presenter.onAppEvent(
-          TracePositionUpdate.fromTraceEntry(trace.getEntry(2)),
-        );
-        expect(uiData.rectsToDraw).toHaveSize(1);
-        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
-
-        await presenter.onAppEvent(
-          TracePositionUpdate.fromTraceEntry(trace.getEntry(3)),
-        );
-        expect(uiData.rectsToDraw).toHaveSize(3);
-        uiData.rectsToDraw?.forEach((rect) =>
-          expect(rect.id).toEqual('inputRect'),
-        );
-      });
+        return traces;
+      }
     });
   }
-}
 
-function wrappedName(name: string): string {
-  return `\u{200C}${name}\u{200C}`;
+  private wrappedName(name: string): string {
+    return `\u{200C}${name}\u{200C}`;
+  }
 }
 
 describe('PresenterInput', async () => {
diff --git a/tools/winscope/src/viewers/viewer_input/ui_data.ts b/tools/winscope/src/viewers/viewer_input/ui_data.ts
index 02e00df2e..f5c6243cf 100644
--- a/tools/winscope/src/viewers/viewer_input/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_input/ui_data.ts
@@ -20,11 +20,11 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
 import {
   LogEntry,
   LogField,
-  LogFieldType,
-  LogFilter,
+  LogHeader,
   UiDataLog,
 } from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
@@ -33,9 +33,8 @@ import {UiRect} from 'viewers/components/rects/ui_rect';
 
 export class UiData implements UiDataLog {
   constructor(
-    public headers: LogFieldType[],
+    public headers: LogHeader[],
     public entries: LogEntry[],
-    public filters: LogFilter[],
     public selectedIndex: undefined | number,
     public scrollToIndex: undefined | number,
     public currentIndex: undefined | number,
@@ -51,11 +50,13 @@ export class UiData implements UiDataLog {
   rectsUserOptions: UserOptions | undefined;
   displays: DisplayIdentifier[] = [];
   isDarkMode = false;
+  propertiesFilter = new TextFilter();
+  dispatchPropertiesFilter = new TextFilter();
 
   readonly dependencies: TraceType[] = [TraceType.INPUT_EVENT_MERGED];
 
   static createEmpty(): UiData {
-    return new UiData([], [], [], undefined, undefined, undefined, undefined);
+    return new UiData([], [], undefined, undefined, undefined, undefined);
   }
 }
 
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input.ts b/tools/winscope/src/viewers/viewer_input/viewer_input.ts
index d3ae0d8f3..ba800823d 100644
--- a/tools/winscope/src/viewers/viewer_input/viewer_input.ts
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input.ts
@@ -20,6 +20,7 @@ import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {View, Viewer, ViewType} from 'viewers/viewer';
@@ -56,10 +57,10 @@ export class ViewerInput implements Viewer {
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
-      'Input',
+      TRACE_INFO[TraceType.INPUT_EVENT_MERGED].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts b/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts
index 55661e39d..4db899566 100644
--- a/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts
@@ -19,6 +19,7 @@ import {PersistentStore} from 'common/persistent_store';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
+import {ViewerEvents} from 'viewers/common/viewer_events';
 import {ShadingMode} from 'viewers/components/rects/shading_mode';
 import {
   viewerCardInnerStyle,
@@ -60,7 +61,6 @@ import {UiData} from './ui_data';
           [currentIndex]="inputData?.currentIndex"
           [entries]="inputData?.entries"
           [headers]="inputData?.headers"
-          [filters]="inputData?.filters"
           [showFiltersInTitle]="true"
           [traceType]="${TraceType.INPUT_EVENT_MERGED}"
           [showTraceEntryTimes]="false"
@@ -77,7 +77,7 @@ import {UiData} from './ui_data';
           [traceType]="${TraceType.INPUT_EVENT_MERGED}"
           [store]="store"
           [isProtoDump]="true"
-          [showFilter]="false"
+          [textFilter]="inputData?.propertiesFilter"
           placeholderText="No selected entry."
           (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"></properties-view>
         <properties-view
@@ -89,7 +89,8 @@ import {UiData} from './ui_data';
           [traceType]="${TraceType.INPUT_EVENT_MERGED}"
           [store]="store"
           [isProtoDump]="true"
-          [showFilter]="false"
+          [textFilter]="inputData?.dispatchPropertiesFilter"
+          [filterEventName]="ViewerEvents.DispatchPropertiesFilterChange"
           placeholderText="No selected entry."
           (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.INPUT_DISPATCH_PROPERTIES, true)"></properties-view>
       </div>
@@ -118,6 +119,7 @@ export class ViewerInputComponent {
   @Input() active = false;
   TraceType = TraceType;
   CollapsibleSectionType = CollapsibleSectionType;
+  ViewerEvents = ViewerEvents;
 
   rectsTitle = 'INPUT WINDOWS';
   eventLogTitle = 'EVENT LOG';
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts b/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts
index 49f67619f..afdb9c8b6 100644
--- a/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts
@@ -16,9 +16,7 @@
 
 import {ClipboardModule} from '@angular/cdk/clipboard';
 import {ScrollingModule} from '@angular/cdk/scrolling';
-import {CommonModule} from '@angular/common';
 import {HttpClientModule} from '@angular/common/http';
-import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
   ComponentFixtureAutoDetect,
@@ -26,7 +24,6 @@ import {
 } from '@angular/core/testing';
 import {FormsModule} from '@angular/forms';
 import {MatButtonModule} from '@angular/material/button';
-import {MatCheckboxModule} from '@angular/material/checkbox';
 import {MatDividerModule} from '@angular/material/divider';
 import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatIconModule} from '@angular/material/icon';
@@ -41,21 +38,27 @@ import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Trace, TraceEntry} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {LogComponent} from 'viewers/common/log_component';
-import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
 import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
 import {RectsComponent} from 'viewers/components/rects/rects_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
+import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {TreeComponent} from 'viewers/components/tree_component';
 import {TreeNodeComponent} from 'viewers/components/tree_node_component';
-import {Presenter} from './presenter';
+import {UserOptionsComponent} from 'viewers/components/user_options_component';
 import {InputEntry, UiData} from './ui_data';
 import {ViewerInputComponent} from './viewer_input_component';
 
 describe('ViewerInputComponent', () => {
+  const testSpec = {name: 'Test Column', cssClass: 'test-class'};
+  const testField = {spec: testSpec, value: 'VALUE'};
   let fixture: ComponentFixture<ViewerInputComponent>;
   let component: ViewerInputComponent;
   let htmlElement: HTMLElement;
@@ -71,6 +74,7 @@ describe('ViewerInputComponent', () => {
       .setName('entry')
       .build();
     trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.INPUT_EVENT_MERGED)
       .setEntries([tree])
       .setTimestamps([TimestampConverterUtils.makeElapsedTimestamp(20n)])
       .build();
@@ -81,21 +85,19 @@ describe('ViewerInputComponent', () => {
     await TestBed.configureTestingModule({
       providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
       imports: [
-        CommonModule,
-        MatIconModule,
-        MatDividerModule,
-        HttpClientModule,
-        MatCheckboxModule,
         MatSliderModule,
+        MatTooltipModule,
+        MatDividerModule,
+        ScrollingModule,
+        MatIconModule,
+        ClipboardModule,
         MatFormFieldModule,
+        MatButtonModule,
         MatInputModule,
         BrowserAnimationsModule,
         FormsModule,
-        MatTooltipModule,
-        MatButtonModule,
         MatSelectModule,
-        ScrollingModule,
-        ClipboardModule,
+        HttpClientModule,
       ],
       declarations: [
         ViewerInputComponent,
@@ -107,8 +109,10 @@ describe('ViewerInputComponent', () => {
         CollapsibleSectionTitleComponent,
         LogComponent,
         RectsComponent,
+        SelectWithFilterComponent,
+        SearchBoxComponent,
+        UserOptionsComponent,
       ],
-      schemas: [CUSTOM_ELEMENTS_SCHEMA],
     }).compileComponents();
 
     fixture = TestBed.createComponent(ViewerInputComponent);
@@ -123,14 +127,28 @@ describe('ViewerInputComponent', () => {
     expect(component).toBeTruthy();
   });
 
-  it('renders entries', () => {
+  it('renders filter in title', () => {
+    expect(htmlElement.querySelector('.headers .filter')).toBeNull();
+    expect(
+      htmlElement.querySelector(
+        `.title-section .filter.${testSpec.cssClass.split(' ')[0]}`,
+      ),
+    ).toBeTruthy();
+  });
+
+  it('renders entries with field values and no trace timestamp', () => {
     expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+    const entry = assertDefined(
+      htmlElement.querySelector(
+        `.scroll .entry .${testSpec.cssClass.split(' ')[0]}`,
+      ),
+    );
+    expect(entry.textContent).toContain('VALUE');
+    expect(htmlElement.querySelector('.scroll .entry .time')).toBeNull();
+  });
 
-    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
-    expect(entry.innerHTML).toContain(`MOTION #1`);
-    expect(entry.innerHTML).toContain(`EXAMPLE SOURCE #1`);
-    expect(entry.innerHTML).toContain(`EXAMPLE ACTION #1`);
-    expect(entry.innerHTML).toContain(`EXAMPLE DETAILS #1`);
+  it('hides go to current time button', () => {
+    expect(htmlElement.querySelector('.go-to-current-time')).toBeNull();
   });
 
   it('shows message when no event is selected', () => {
@@ -198,9 +216,9 @@ describe('ViewerInputComponent', () => {
     ];
 
     const uiData = UiData.createEmpty();
+    uiData.headers = [new LogHeader(testSpec, new LogSelectFilter([]))];
     uiData.entries = entries;
     uiData.selectedIndex = 0;
-    uiData.headers = Presenter.FIELD_TYPES;
 
     uiData.rectsToDraw = [];
     return uiData;
@@ -210,33 +228,24 @@ describe('ViewerInputComponent', () => {
     entry: TraceEntry<PropertyTreeNode>,
     num: number,
   ): InputEntry {
-    const fields: LogField[] = [
-      {
-        type: LogFieldType.INPUT_TYPE,
-        value: `MOTION #${num}`,
-      },
-      {
-        type: LogFieldType.INPUT_SOURCE,
-        value: `EXAMPLE SOURCE #${num}`,
-      },
-      {
-        type: LogFieldType.INPUT_ACTION,
-        value: `EXAMPLE ACTION #${num}`,
-      },
-      {
-        type: LogFieldType.INPUT_DEVICE_ID,
-        value: 42,
-      },
-      {
-        type: LogFieldType.INPUT_DISPLAY_ID,
-        value: 2,
-      },
-      {
-        type: LogFieldType.INPUT_EVENT_DETAILS,
-        value: `EXAMPLE DETAILS #${num}`,
-      },
-    ];
-
-    return new InputEntry(entry, fields, tree, tree, undefined);
+    return new InputEntry(
+      entry,
+      [
+        {
+          spec: testSpec,
+          value: 'VALUE',
+          propagateEntryTimestamp: true,
+        },
+        testField,
+        testField,
+        testField,
+        testField,
+        testField,
+        testField,
+      ],
+      tree,
+      tree,
+      undefined,
+    );
   }
 });
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
index 80de81358..adf914fb2 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
@@ -51,11 +51,7 @@ export class PresenterInputMethodClients extends AbstractPresenterInputMethod {
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'ImeHierarchyFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     [],
     true,
     false,
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
index dd1168cc0..724a1b34e 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
@@ -19,20 +19,12 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertySource} from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
-import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodClients} from './presenter_input_method_clients';
 
 class PresenterInputMethodClientsTest extends AbstractPresenterInputMethodTest {
-  override readonly numberOfDefaultProperties = 1;
-  override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilter = new TextFilter('where', []);
-  override readonly numberOfFilteredProperties = 1;
-
   protected override readonly PresenterInputMethod =
     PresenterInputMethodClients;
   protected override readonly imeTraceType = TraceType.INPUT_METHOD_CLIENTS;
-  protected override readonly numberOfFlattenedChildren = 11;
-  protected override readonly numberOfVisibleChildren = 1;
   protected override readonly numberOfNestedChildren = 2;
 
   override getSelectedNode(): HierarchyTreeNode {
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts b/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
index b8de9b2fa..5ba5ace7a 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
@@ -17,11 +17,9 @@
 import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
-import {TRACE_INFO} from 'trace/trace_info';
 import {ImeTraceType, TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {AbstractViewerInputMethod} from 'viewers/common/abstract_viewer_input_method';
-import {View, ViewType} from 'viewers/viewer';
 import {PresenterInputMethodClients} from './presenter_input_method_clients';
 
 class ViewerInputMethodClients extends AbstractViewerInputMethod {
@@ -29,16 +27,8 @@ class ViewerInputMethodClients extends AbstractViewerInputMethod {
     TraceType.INPUT_METHOD_CLIENTS,
   ];
 
-  override readonly view: View;
-
   constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
-    this.view = new View(
-      ViewType.TAB,
-      this.getTraces(),
-      this.htmlElement,
-      TRACE_INFO[TraceType.INPUT_METHOD_CLIENTS].name,
-    );
   }
 
   override initializePresenter(
diff --git a/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts b/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
index e15e83ff7..8cd53df05 100644
--- a/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
@@ -23,21 +23,13 @@ import {
   PropertyTreeNode,
 } from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
-import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodManagerService} from './presenter_input_method_manager_service';
 
 class PresenterInputMethodManagerServiceTest extends AbstractPresenterInputMethodTest {
-  override readonly numberOfDefaultProperties = 1;
-  override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilter = new TextFilter('elapsedNanos', []);
-  override readonly numberOfFilteredProperties = 1;
-
   protected override readonly PresenterInputMethod =
     PresenterInputMethodManagerService;
   protected override readonly imeTraceType =
     TraceType.INPUT_METHOD_MANAGER_SERVICE;
-  protected override readonly numberOfFlattenedChildren = 1;
-  protected override readonly numberOfVisibleChildren = 0;
   protected override readonly numberOfNestedChildren = 1;
 
   override getSelectedNode(): HierarchyTreeNode {
diff --git a/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts b/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
index db094beec..08ebf11f4 100644
--- a/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
@@ -17,11 +17,9 @@
 import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
-import {TRACE_INFO} from 'trace/trace_info';
 import {ImeTraceType, TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {AbstractViewerInputMethod} from 'viewers/common/abstract_viewer_input_method';
-import {View, ViewType} from 'viewers/viewer';
 import {PresenterInputMethodManagerService} from './presenter_input_method_manager_service';
 
 class ViewerInputMethodManagerService extends AbstractViewerInputMethod {
@@ -29,16 +27,8 @@ class ViewerInputMethodManagerService extends AbstractViewerInputMethod {
     TraceType.INPUT_METHOD_MANAGER_SERVICE,
   ];
 
-  override readonly view: View;
-
   constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
-    this.view = new View(
-      ViewType.TAB,
-      this.getTraces(),
-      this.htmlElement,
-      TRACE_INFO[TraceType.INPUT_METHOD_MANAGER_SERVICE].name,
-    );
   }
 
   override initializePresenter(
diff --git a/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts b/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
index 059140bdf..45433fe57 100644
--- a/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
@@ -18,20 +18,12 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertySource} from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
-import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodService} from './presenter_input_method_service';
 
 class PresenterInputMethodServiceTest extends AbstractPresenterInputMethodTest {
-  override readonly numberOfDefaultProperties = 1;
-  override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilter = new TextFilter('elapsedNanos', []);
-  override readonly numberOfFilteredProperties = 1;
-
   protected override readonly PresenterInputMethod =
     PresenterInputMethodService;
   protected override readonly imeTraceType = TraceType.INPUT_METHOD_SERVICE;
-  protected override readonly numberOfFlattenedChildren = 11;
-  protected override readonly numberOfVisibleChildren = 1;
   protected override readonly numberOfNestedChildren = 2;
 
   override getSelectedNode(): HierarchyTreeNode {
diff --git a/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts b/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
index 9436b428d..535387fd4 100644
--- a/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
@@ -17,11 +17,9 @@
 import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
-import {TRACE_INFO} from 'trace/trace_info';
 import {ImeTraceType, TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {AbstractViewerInputMethod} from 'viewers/common/abstract_viewer_input_method';
-import {View, ViewType} from 'viewers/viewer';
 import {PresenterInputMethodService} from './presenter_input_method_service';
 
 class ViewerInputMethodService extends AbstractViewerInputMethod {
@@ -29,16 +27,8 @@ class ViewerInputMethodService extends AbstractViewerInputMethod {
     TraceType.INPUT_METHOD_SERVICE,
   ];
 
-  override readonly view: View;
-
   constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
-    this.view = new View(
-      ViewType.TAB,
-      this.getTraces(),
-      this.htmlElement,
-      TRACE_INFO[TraceType.INPUT_METHOD_SERVICE].name,
-    );
   }
 
   override initializePresenter(
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts b/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts
index bcd7f4bba..bb35a162b 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts
@@ -15,6 +15,8 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
+import {Timestamp} from 'common/time';
 import {TimeDuration} from 'common/time_duration';
 import {Trace} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -24,52 +26,66 @@ import {
 } from 'viewers/common/abstract_log_viewer_presenter';
 import {LogPresenter} from 'viewers/common/log_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
-import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogField, LogHeader} from 'viewers/common/ui_data_log';
 import {CujEntry, CujStatus, UiData} from './ui_data';
 
-export class Presenter extends AbstractLogViewerPresenter<UiData> {
-  static readonly FIELD_NAMES = [
-    LogFieldType.CUJ_TYPE,
-    LogFieldType.START_TIME,
-    LogFieldType.END_TIME,
-    LogFieldType.DURATION,
-    LogFieldType.STATUS,
-  ];
-  private static readonly VALUE_NA = 'N/A';
-
-  private isInitialized = false;
+export class Presenter extends AbstractLogViewerPresenter<
+  UiData,
+  PropertyTreeNode
+> {
+  private static readonly COLUMNS = {
+    type: {
+      name: 'Type',
+      cssClass: 'jank-cuj-type',
+    },
+    startTime: {
+      name: 'Start Time',
+      cssClass: 'start-time time',
+    },
+    endTime: {
+      name: 'End Time',
+      cssClass: 'end-time time',
+    },
+    duration: {
+      name: 'Duration',
+      cssClass: 'duration right-align',
+    },
+    status: {
+      name: 'Status',
+      cssClass: 'status right-align',
+    },
+  };
   private transitionTrace: Trace<PropertyTreeNode>;
 
   protected override logPresenter = new LogPresenter<CujEntry>();
   protected override propertiesPresenter = new PropertiesPresenter(
     {},
-    undefined,
+    new TextFilter(),
     [],
     [],
   );
 
   constructor(
     trace: Trace<PropertyTreeNode>,
+    private readonly storage: Store,
     notifyViewCallback: NotifyLogViewCallbackType<UiData>,
   ) {
     super(trace, notifyViewCallback, UiData.createEmpty());
     this.transitionTrace = trace;
   }
 
-  protected async initializeIfNeeded() {
-    if (this.isInitialized) {
-      return;
-    }
-
-    const allEntries = await this.makeUiDataEntries();
-
-    this.logPresenter.setAllEntries(allEntries);
-    this.logPresenter.setHeaders(Presenter.FIELD_NAMES);
-    this.refreshUiData();
-    this.isInitialized = true;
+  protected override makeHeaders(): LogHeader[] {
+    return [
+      new LogHeader(Presenter.COLUMNS.type),
+      new LogHeader(Presenter.COLUMNS.startTime),
+      new LogHeader(Presenter.COLUMNS.endTime),
+      new LogHeader(Presenter.COLUMNS.duration),
+      new LogHeader(Presenter.COLUMNS.status),
+    ];
   }
 
-  private async makeUiDataEntries(): Promise<CujEntry[]> {
+  protected override async makeUiDataEntries(): Promise<CujEntry[]> {
     const cujs: CujEntry[] = [];
     for (
       let traceIndex = 0;
@@ -79,9 +95,9 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
       const entry = assertDefined(this.trace.getEntry(traceIndex));
       const cujNode = await entry.getValue();
 
-      let status: CujStatus | undefined;
-      let statusIcon: string | undefined;
-      let statusIconColor: string | undefined;
+      let status: CujStatus;
+      let statusIcon: string;
+      let statusIconColor: string;
       if (assertDefined(cujNode.getChildByName('canceled')).getValue()) {
         status = CujStatus.CANCELLED;
         statusIcon = 'close';
@@ -92,8 +108,12 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         statusIconColor = 'green';
       }
 
-      const startTs = cujNode.getChildByName('startTimestamp')?.getValue();
-      const endTs = cujNode.getChildByName('endTimestamp')?.getValue();
+      const startTs: Timestamp | undefined = cujNode
+        .getChildByName('startTimestamp')
+        ?.getValue();
+      const endTs: Timestamp | undefined = cujNode
+        .getChildByName('endTimestamp')
+        ?.getValue();
 
       let timeDiff: TimeDuration | undefined = undefined;
       if (startTs && endTs) {
@@ -106,25 +126,22 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
       ).formattedValue();
 
       const fields: LogField[] = [
+        {spec: Presenter.COLUMNS.type, value: cujType},
         {
-          type: LogFieldType.CUJ_TYPE,
-          value: cujType,
-        },
-        {
-          type: LogFieldType.START_TIME,
+          spec: Presenter.COLUMNS.startTime,
           value: startTs ?? Presenter.VALUE_NA,
         },
         {
-          type: LogFieldType.END_TIME,
+          spec: Presenter.COLUMNS.endTime,
           value: endTs ?? Presenter.VALUE_NA,
         },
         {
-          type: LogFieldType.DURATION,
+          spec: Presenter.COLUMNS.duration,
           value: timeDiff?.format() ?? Presenter.VALUE_NA,
         },
         {
-          type: LogFieldType.STATUS,
-          value: status ?? Presenter.VALUE_NA,
+          spec: Presenter.COLUMNS.status,
+          value: status,
           icon: statusIcon,
           iconColor: statusIconColor,
         },
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts b/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts
index cd8e24b5a..214a5a4eb 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
@@ -25,22 +26,45 @@ import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
 import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
 class PresenterJankCujsTest extends AbstractLogViewerPresenterTest<UiData> {
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader({
+        name: 'Type',
+        cssClass: 'jank-cuj-type',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Start Time',
+        cssClass: 'start-time time',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'End Time',
+        cssClass: 'end-time time',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Duration',
+        cssClass: 'duration right-align',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Status',
+        cssClass: 'status right-align',
+      }),
+    },
+  ];
   private trace: Trace<PropertyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
-  private secondPositionUpdate: TracePositionUpdate | undefined;
-
-  override readonly shouldExecuteHeaderTests = true;
-  override readonly shouldExecuteFilterTests = false;
-  override readonly shouldExecutePropertiesTests = true;
-
-  override readonly totalOutputEntries = 16;
-  override readonly expectedIndexOfFirstPositionUpdate = 0;
-  override readonly expectedIndexOfSecondPositionUpdate = 2;
-  override readonly logEntryClickIndex = 3;
 
   override async setUpTestEnvironment(): Promise<void> {
     const parser = (await UnitTestUtils.getTracesParser([
@@ -55,19 +79,13 @@ class PresenterJankCujsTest extends AbstractLogViewerPresenterTest<UiData> {
     this.positionUpdate = TracePositionUpdate.fromTraceEntry(
       this.trace.getEntry(0),
     );
-    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
-      this.trace.getEntry(2),
-    );
   }
 
   override async createPresenterWithEmptyTrace(
     callback: NotifyLogViewCallbackType<UiData>,
   ): Promise<Presenter> {
-    const trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.CUJS)
-      .setEntries([])
-      .build();
-    return new Presenter(trace, callback);
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.CUJS);
+    return new Presenter(trace, new InMemoryStorage(), callback);
   }
 
   override async createPresenter(
@@ -77,7 +95,7 @@ class PresenterJankCujsTest extends AbstractLogViewerPresenterTest<UiData> {
     const traces = new Traces();
     traces.addTrace(trace);
 
-    const presenter = new Presenter(trace, callback);
+    const presenter = new Presenter(trace, new InMemoryStorage(), callback);
     await presenter.onAppEvent(this.getPositionUpdate()); // trigger initialization
     return presenter;
   }
@@ -86,10 +104,6 @@ class PresenterJankCujsTest extends AbstractLogViewerPresenterTest<UiData> {
     return assertDefined(this.positionUpdate);
   }
 
-  override getSecondPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.secondPositionUpdate);
-  }
-
   override executePropertiesChecksAfterPositionUpdate(uiData: UiData) {
     const cujTypeValues = uiData.entries.map((entry) => {
       return entry.fields[0].value;
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts b/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts
index ef2e9ec6c..7ca4d9811 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts
@@ -16,27 +16,32 @@
 
 import {TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
 import {
   LogEntry,
   LogField,
-  LogFieldType,
+  LogHeader,
   UiDataLog,
 } from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 
 export class UiData implements UiDataLog {
   constructor(
-    public headers: LogFieldType[],
+    public headers: LogHeader[],
     public entries: LogEntry[],
     public selectedIndex: undefined | number,
+    public currentIndex: undefined | number,
     public scrollToIndex: undefined | number,
     public propertiesTree: undefined | UiPropertyTreeNode,
   ) {}
 
+  propertiesFilter = new TextFilter();
+
   static createEmpty() {
-    return new UiData([], [], undefined, undefined, undefined);
+    return new UiData([], [], undefined, undefined, undefined, undefined);
   }
 }
+
 export class CujEntry implements LogEntry {
   constructor(
     public traceEntry: TraceEntry<PropertyTreeNode>,
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts
index b1670e7ac..be2ec975a 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts
@@ -14,10 +14,12 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {View, Viewer, ViewType} from 'viewers/viewer';
@@ -32,20 +34,20 @@ export class ViewerJankCujs implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(trace: Trace<PropertyTreeNode>, traces: Traces) {
+  constructor(trace: Trace<PropertyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-jank-cujs');
     const notifyViewCallback = (data: UiData) => {
       (this.htmlElement as any).inputData = data;
     };
-    this.presenter = new Presenter(trace, notifyViewCallback);
+    this.presenter = new Presenter(trace, storage, notifyViewCallback);
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
-      'Jank CUJs',
+      TRACE_INFO[TraceType.CUJS].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts
index bc4384c80..d6789f3e3 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts
@@ -15,7 +15,7 @@
  */
 import {Component, Input, ViewChild} from '@angular/core';
 import {TraceType} from 'trace/trace_type';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts
index 6ccddbedb..855102c29 100644
--- a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts
@@ -24,28 +24,27 @@ import {
 import {MatDividerModule} from '@angular/material/divider';
 import {MatIconModule} from '@angular/material/icon';
 import {assertDefined} from 'common/assert_utils';
-import {TimeDuration} from 'common/time_duration';
-import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
-import {CujType} from 'trace/cuj_type';
 import {Parser} from 'trace/parser';
 import {Trace, TraceEntry} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {LogComponent} from 'viewers/common/log_component';
-import {LogEntry, LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {LogEntry, LogHeader} from 'viewers/common/ui_data_log';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
 import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
 import {TreeComponent} from 'viewers/components/tree_component';
 import {TreeNodeComponent} from 'viewers/components/tree_node_component';
-import {Presenter} from './presenter';
-import {CujStatus, UiData} from './ui_data';
+import {CujEntry, UiData} from './ui_data';
 import {ViewerJankCujsComponent} from './viewer_jank_cujs_component';
 
 describe('ViewerJankCujsComponent', () => {
+  const testSpec = {name: 'Test Column', cssClass: 'test-class'};
+  const testField = {spec: testSpec, value: 'VALUE'};
   let fixture: ComponentFixture<ViewerJankCujsComponent>;
   let component: ViewerJankCujsComponent;
   let htmlElement: HTMLElement;
@@ -85,7 +84,6 @@ describe('ViewerJankCujsComponent', () => {
         CollapsibleSectionTitleComponent,
         LogComponent,
       ],
-      schemas: [],
     }).compileComponents();
 
     fixture = TestBed.createComponent(ViewerJankCujsComponent);
@@ -100,70 +98,44 @@ describe('ViewerJankCujsComponent', () => {
     expect(component).toBeTruthy();
   });
 
-  it('renders entries', () => {
+  it('renders entries with field values and no trace timestamp', () => {
     expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+    const entry = assertDefined(
+      htmlElement.querySelector(
+        `.scroll .entry .${testSpec.cssClass.split(' ')[0]}`,
+      ),
+    );
+    expect(entry.textContent).toContain('VALUE');
+    expect(htmlElement.querySelector('.scroll .entry .time')).toBeNull();
+  });
 
-    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
-    expect(entry.innerHTML).toContain('LOCKSCREEN_PASSWORD_DISAPPEAR');
-    expect(entry.innerHTML).toContain('30ns');
+  it('hides go to current time button', () => {
+    expect(htmlElement.querySelector('.go-to-current-time')).toBeNull();
   });
 
   function makeUiData(): UiData {
-    let mockTransitionIdCounter = 0;
-
     const cujEntries = [
-      createMockCujEntry(entry, 20, CujType[20], 30, mockTransitionIdCounter++),
-      createMockCujEntry(entry, 66, CujType[66], 42, 50, CujStatus.CANCELLED),
-      createMockCujEntry(entry, 46, CujType[46], 49, mockTransitionIdCounter++),
-      createMockCujEntry(entry, 59, CujType[59], 58, 70, CujStatus.EXECUTED),
+      createMockCujEntry(entry, 1),
+      createMockCujEntry(entry, 2),
+      createMockCujEntry(entry, 3),
+      createMockCujEntry(entry, 4),
     ];
 
     const uiData = UiData.createEmpty();
+    uiData.headers = [new LogHeader(testSpec, new LogSelectFilter([]))];
     uiData.entries = cujEntries;
     uiData.selectedIndex = 0;
-    uiData.headers = Presenter.FIELD_NAMES;
     return uiData;
   }
 
   function createMockCujEntry(
     entry: TraceEntry<PropertyTreeNode>,
-    cujTypeId: number,
-    cujTypeStr: string,
-    startTsNanos: number,
-    endTsNanos: number,
-    status = CujStatus.EXECUTED,
+    i: number,
   ): LogEntry {
-    const fields: LogField[] = [
-      {
-        type: LogFieldType.CUJ_TYPE,
-        value: `${cujTypeStr} (${cujTypeId})`,
-      },
-      {
-        type: LogFieldType.START_TIME,
-        value: TimestampConverterUtils.makeElapsedTimestamp(
-          BigInt(startTsNanos),
-        ),
-      },
-      {
-        type: LogFieldType.END_TIME,
-        value: TimestampConverterUtils.makeElapsedTimestamp(BigInt(endTsNanos)),
-      },
-      {
-        type: LogFieldType.DURATION,
-        value: new TimeDuration(BigInt(endTsNanos - startTsNanos)).format(),
-      },
-      {
-        type: LogFieldType.STATUS,
-        value: status,
-        icon: 'check',
-        iconColor: 'green',
-      },
-    ];
-
-    return {
-      traceEntry: entry,
-      fields,
-      propertiesTree: undefined,
-    };
+    return new CujEntry(
+      entry,
+      [testField, testField, testField, testField, testField],
+      undefined,
+    );
   }
 });
diff --git a/tools/winscope/src/viewers/viewer_protolog/presenter.ts b/tools/winscope/src/viewers/viewer_protolog/presenter.ts
index b73bdbd9e..18aba39a6 100644
--- a/tools/winscope/src/viewers/viewer_protolog/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/presenter.ts
@@ -15,7 +15,6 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {PersistentStoreProxy} from 'common/persistent_store_proxy';
 import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -23,25 +22,34 @@ import {
   AbstractLogViewerPresenter,
   NotifyLogViewCallbackType,
 } from 'viewers/common/abstract_log_viewer_presenter';
+import {LogSelectFilter, LogTextFilter} from 'viewers/common/log_filters';
 import {LogPresenter} from 'viewers/common/log_presenter';
 import {TextFilter} from 'viewers/common/text_filter';
-import {
-  LogEntry,
-  LogField,
-  LogFieldType,
-  LogFilter,
-} from 'viewers/common/ui_data_log';
+import {LogEntry, LogField, LogHeader} from 'viewers/common/ui_data_log';
 import {ProtologEntry, UiData} from './ui_data';
 
-export class Presenter extends AbstractLogViewerPresenter<UiData> {
-  static readonly FIELD_TYPES = [
-    LogFieldType.LOG_LEVEL,
-    LogFieldType.TAG,
-    LogFieldType.SOURCE_FILE,
-    LogFieldType.TEXT,
-  ];
-  private isInitialized = false;
-
+export class Presenter extends AbstractLogViewerPresenter<
+  UiData,
+  PropertyTreeNode
+> {
+  private static readonly COLUMNS = {
+    logLevel: {
+      name: 'Log Level',
+      cssClass: 'log-level',
+    },
+    tag: {
+      name: 'Tag',
+      cssClass: 'tag',
+    },
+    sourceFile: {
+      name: 'Source files',
+      cssClass: 'source-file',
+    },
+    text: {
+      name: 'Search text',
+      cssClass: 'text',
+    },
+  };
   protected override logPresenter = new LogPresenter<LogEntry>();
 
   constructor(
@@ -52,45 +60,25 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     super(trace, notifyViewCallback, UiData.createEmpty());
   }
 
-  protected override async initializeIfNeeded() {
-    if (this.isInitialized) {
-      return;
-    }
-    const allEntries = await this.makeAllUiDataMessages();
-    const filters: LogFilter[] = [];
-
-    for (const type of Presenter.FIELD_TYPES) {
-      if (type === LogFieldType.TEXT) {
-        filters.push({
-          type,
-          textFilter: PersistentStoreProxy.new(
-            'ProtoLog' + type,
-            new TextFilter('', []),
-            this.storage,
-          ),
-        });
-      } else {
-        filters.push({
-          type,
-          options: this.getUniqueMessageValues(
-            allEntries,
-            (entry: ProtologEntry) =>
-              assertDefined(
-                entry.fields.find((f) => f.type === type),
-              ).value.toString(),
-          ),
-        });
-      }
-    }
-
-    this.logPresenter.setAllEntries(allEntries);
-    this.logPresenter.setFilters(filters);
-
-    this.refreshUiData();
-    this.isInitialized = true;
+  protected override makeHeaders(): LogHeader[] {
+    return [
+      new LogHeader(Presenter.COLUMNS.logLevel, new LogSelectFilter([])),
+      new LogHeader(
+        Presenter.COLUMNS.tag,
+        new LogSelectFilter([], false, '150'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.sourceFile,
+        new LogSelectFilter([], false, '300'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.text,
+        new LogTextFilter(new TextFilter()),
+      ),
+    ];
   }
 
-  private async makeAllUiDataMessages(): Promise<ProtologEntry[]> {
+  protected override async makeUiDataEntries(): Promise<ProtologEntry[]> {
     const messages: ProtologEntry[] = [];
 
     for (
@@ -102,25 +90,25 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
       const messageNode = await entry.getValue();
       const fields: LogField[] = [
         {
-          type: LogFieldType.LOG_LEVEL,
+          spec: Presenter.COLUMNS.logLevel,
           value: assertDefined(
             messageNode.getChildByName('level'),
           ).formattedValue(),
         },
         {
-          type: LogFieldType.TAG,
+          spec: Presenter.COLUMNS.tag,
           value: assertDefined(
             messageNode.getChildByName('tag'),
           ).formattedValue(),
         },
         {
-          type: LogFieldType.SOURCE_FILE,
+          spec: Presenter.COLUMNS.sourceFile,
           value: assertDefined(
             messageNode.getChildByName('at'),
           ).formattedValue(),
         },
         {
-          type: LogFieldType.TEXT,
+          spec: Presenter.COLUMNS.text,
           value: assertDefined(
             messageNode.getChildByName('text'),
           ).formattedValue(),
@@ -132,6 +120,23 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     return messages;
   }
 
+  protected override updateFiltersInHeaders(
+    headers: LogHeader[],
+    allEntries: ProtologEntry[],
+  ) {
+    for (const header of headers) {
+      if (header.filter instanceof LogSelectFilter) {
+        assertDefined(header.filter).options = this.getUniqueMessageValues(
+          allEntries,
+          (entry: ProtologEntry) =>
+            assertDefined(
+              entry.fields.find((f) => f.spec === header.spec),
+            ).value.toString(),
+        );
+      }
+    }
+  }
+
   private getUniqueMessageValues(
     allMessages: ProtologEntry[],
     getValue: (message: ProtologEntry) => string,
diff --git a/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts b/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
index bca69f156..086aebb51 100644
--- a/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
@@ -20,6 +20,7 @@ import {TracePositionUpdate} from 'messaging/winscope_event';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
 import {Trace} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {
@@ -29,117 +30,44 @@ import {
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
 import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {LogSelectFilter, LogTextFilter} from 'viewers/common/log_filters';
 import {TextFilter} from 'viewers/common/text_filter';
-import {LogFieldType, LogFieldValue} from 'viewers/common/ui_data_log';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
 class PresenterProtologTest extends AbstractLogViewerPresenterTest<UiData> {
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader(
+        {name: 'Log Level', cssClass: 'log-level'},
+        new LogSelectFilter(Array.from({length: 3}, () => '')),
+      ),
+      options: ['level0', 'level1', 'level2'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Tag', cssClass: 'tag'},
+        new LogSelectFilter(Array.from({length: 3}, () => '')),
+      ),
+      options: ['tag0', 'tag1', 'tag2'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Source files', cssClass: 'source-file'},
+        new LogSelectFilter(Array.from({length: 3}, () => '')),
+      ),
+      options: ['sourcefile0', 'sourcefile1', 'sourcefile2'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Search text', cssClass: 'text'},
+        new LogTextFilter(new TextFilter()),
+      ),
+    },
+  ];
   private trace: Trace<PropertyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
-  private secondPositionUpdate: TracePositionUpdate | undefined;
-
-  override readonly shouldExecuteHeaderTests = false;
-  override readonly shouldExecuteFilterTests = true;
-  override readonly shouldExecutePropertiesTests = false;
-
-  override readonly totalOutputEntries = 3;
-  override readonly expectedIndexOfFirstPositionUpdate = 0;
-  override readonly expectedIndexOfSecondPositionUpdate = 1;
-  override readonly expectedInitialFilterOptions = new Map<
-    LogFieldType,
-    string[] | number
-  >([
-    [LogFieldType.LOG_LEVEL, ['level0', 'level1', 'level2']],
-    [LogFieldType.TAG, ['tag0', 'tag1', 'tag2']],
-    [LogFieldType.SOURCE_FILE, ['sourcefile0', 'sourcefile1', 'sourcefile2']],
-  ]);
-  override readonly filterValuesToSet = new Map<
-    LogFieldType,
-    Array<string | string[]>
-  >([
-    [LogFieldType.LOG_LEVEL, [[], ['level1'], ['level0', 'level1', 'level2']]],
-    [LogFieldType.TAG, [[], ['tag1'], ['tag0', 'tag1', 'tag2']]],
-    [
-      LogFieldType.SOURCE_FILE,
-      [[], ['sourcefile1'], ['sourcefile0', 'sourcefile1', 'sourcefile2']],
-    ],
-    [LogFieldType.TEXT, [[], 'text', 'text0', 'text1']],
-  ]);
-  override readonly expectedFieldValuesAfterFilter = new Map<
-    LogFieldType,
-    Array<LogFieldValue[] | number>
-  >([
-    [
-      LogFieldType.LOG_LEVEL,
-      [this.totalOutputEntries, ['level1'], ['level0', 'level1', 'level2']],
-    ],
-    [
-      LogFieldType.TAG,
-      [this.totalOutputEntries, ['tag1'], ['tag0', 'tag1', 'tag2']],
-    ],
-    [
-      LogFieldType.SOURCE_FILE,
-      [
-        this.totalOutputEntries,
-        ['sourcefile1'],
-        ['sourcefile0', 'sourcefile1', 'sourcefile2'],
-      ],
-    ],
-    [
-      LogFieldType.TEXT,
-      [
-        this.totalOutputEntries,
-        ['text0', 'text1', 'text2'],
-        ['text0'],
-        ['text1'],
-      ],
-    ],
-  ]);
-  override readonly logEntryClickIndex = 10;
-  override readonly filterNameForCurrentIndexTest = LogFieldType.LOG_LEVEL;
-  override readonly filterChangeForCurrentIndexTest = ['level1'];
-  override readonly expectedCurrentIndexAfterFilterChange = 0;
-  override readonly secondFilterChangeForCurrentIndexTest = [
-    'level0',
-    'level1',
-  ];
-  override readonly expectedCurrentIndexAfterSecondFilterChange = 1;
-
-  override executeSpecializedTests() {
-    describe('Specialized tests', () => {
-      let presenter: Presenter;
-      let uiData: UiData;
-
-      beforeAll(async () => {
-        await this.setUpTestEnvironment();
-      });
-
-      beforeEach(async () => {
-        const notifyViewCallback = (newData: UiData) => {
-          uiData = newData;
-        };
-        presenter = await this.createPresenter(notifyViewCallback);
-      });
-
-      it('handles text filter change', async () => {
-        await presenter.onAppEvent(this.getSecondPositionUpdate());
-        expect(uiData.entries.length).toEqual(3);
-        expect(uiData.currentIndex).toEqual(1);
-        expect(uiData.scrollToIndex).toEqual(1);
-        expect(uiData.selectedIndex).toEqual(undefined);
-
-        await presenter.onTextFilterChange(
-          LogFieldType.TEXT,
-          new TextFilter('text0', []),
-        );
-        expect(uiData.entries.length).toEqual(1);
-        expect(uiData.currentIndex).toEqual(0);
-        expect(uiData.scrollToIndex).toEqual(0);
-        expect(uiData.selectedIndex).toEqual(undefined);
-      });
-    });
-  }
 
   override async setUpTestEnvironment(): Promise<void> {
     const time10 = TimestampConverterUtils.makeRealTimestamp(10n);
@@ -228,18 +156,16 @@ class PresenterProtologTest extends AbstractLogViewerPresenterTest<UiData> {
       .setTimestamps([time10, time11, time12])
       .build();
 
-    this.positionUpdate = TracePositionUpdate.fromTimestamp(time10);
-    this.secondPositionUpdate = TracePositionUpdate.fromTimestamp(time11);
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
+    );
   }
 
   override async createPresenterWithEmptyTrace(
     callback: NotifyLogViewCallbackType<UiData>,
   ): Promise<Presenter> {
-    const emptyTrace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.PROTO_LOG)
-      .setEntries([])
-      .build();
-    return new Presenter(emptyTrace, callback, new InMemoryStorage());
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.PROTO_LOG);
+    return new Presenter(trace, callback, new InMemoryStorage());
   }
 
   override async createPresenter(
@@ -257,10 +183,6 @@ class PresenterProtologTest extends AbstractLogViewerPresenterTest<UiData> {
   override getPositionUpdate(): TracePositionUpdate {
     return assertDefined(this.positionUpdate);
   }
-
-  override getSecondPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.secondPositionUpdate);
-  }
 }
 
 describe('PresenterProtolog', () => {
diff --git a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
index 22d085be7..e02adcd34 100644
--- a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
@@ -15,7 +15,6 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {LogFieldType} from 'viewers/common/ui_data_log';
 import {VariableHeightScrollStrategy} from 'viewers/common/variable_height_scroll_strategy';
 import {ProtologEntry} from 'viewers/viewer_protolog/ui_data';
 
@@ -27,8 +26,7 @@ export class ProtologScrollStrategy extends VariableHeightScrollStrategy {
 
   protected override predictScrollItemHeight(entry: ProtologEntry): number {
     const textHeight = this.subItemHeight(
-      assertDefined(entry.fields.find((f) => f.type === LogFieldType.TEXT))
-        .value as string,
+      entry.fields[3].value as string,
       this.textCharsPerRow,
     );
     const timestampHeight = this.subItemHeight(
@@ -36,9 +34,7 @@ export class ProtologScrollStrategy extends VariableHeightScrollStrategy {
       this.timestampCharsPerRow,
     );
     const sourceFileHeight = this.subItemHeight(
-      assertDefined(
-        entry.fields.find((f) => f.type === LogFieldType.SOURCE_FILE),
-      ).value as string,
+      assertDefined(entry.fields[2]).value as string,
       this.sourceFileCharsPerRow,
     );
     return Math.max(textHeight, timestampHeight, sourceFileHeight);
diff --git a/tools/winscope/src/viewers/viewer_protolog/ui_data.ts b/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
index 7a8d14a45..cb2dc8942 100644
--- a/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
@@ -19,14 +19,14 @@ import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {
   LogEntry,
   LogField,
-  LogFilter,
+  LogHeader,
   UiDataLog,
 } from 'viewers/common/ui_data_log';
 
 export class UiData implements UiDataLog {
   constructor(
-    public filters: LogFilter[],
-    public entries: LogEntry[],
+    public headers: LogHeader[],
+    public entries: ProtologEntry[],
     public currentIndex: undefined | number,
     public selectedIndex: undefined | number,
     public scrollToIndex: undefined | number,
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
index e70f27c66..7640202b2 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
@@ -46,7 +46,7 @@ class ViewerProtoLog implements Viewer {
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.PROTO_LOG].name,
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
index 672cb0134..353820af9 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
@@ -16,7 +16,7 @@
 import {Component, Input, ViewChild} from '@angular/core';
 import {PersistentStore} from 'common/persistent_store';
 import {TraceType} from 'trace/trace_type';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
@@ -30,7 +30,7 @@ import {UiData} from './ui_data';
         [scrollToIndex]="inputData?.scrollToIndex"
         [currentIndex]="inputData?.currentIndex"
         [entries]="inputData?.entries"
-        [filters]="inputData?.filters"
+        [headers]="inputData?.headers"
         [traceType]="${TraceType.PROTO_LOG}">
       </log-view>
     </div>
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
index a01a868ba..50c743fdc 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
@@ -18,14 +18,15 @@ import {
   CdkVirtualScrollViewport,
   ScrollingModule,
 } from '@angular/cdk/scrolling';
-import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
   ComponentFixtureAutoDetect,
   TestBed,
 } from '@angular/core/testing';
 import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
 import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
 import {MatInputModule} from '@angular/material/input';
 import {MatSelectModule} from '@angular/material/select';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
@@ -34,113 +35,102 @@ import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogSelectFilter} from 'viewers/common/log_filters';
 import {executeScrollComponentTests} from 'viewers/common/scroll_component_tests';
-import {LogFieldType} from 'viewers/common/ui_data_log';
+import {LogHeader} from 'viewers/common/ui_data_log';
+import {LogComponent} from 'viewers/components/log_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {ProtologScrollDirective} from './scroll_strategy/protolog_scroll_directive';
 import {ProtologEntry, UiData} from './ui_data';
 import {ViewerProtologComponent} from './viewer_protolog_component';
 
 describe('ViewerProtologComponent', () => {
-  describe('Main component', () => {
-    let fixture: ComponentFixture<ViewerProtologComponent>;
-    let component: ViewerProtologComponent;
-    let htmlElement: HTMLElement;
+  const testSpec = {name: 'Test Column', cssClass: 'test-class'};
+  const testField = {spec: testSpec, value: 'VALUE'};
+  let fixture: ComponentFixture<ViewerProtologComponent>;
+  let component: ViewerProtologComponent;
+  let htmlElement: HTMLElement;
 
+  describe('Main component', () => {
     beforeEach(async () => {
-      await TestBed.configureTestingModule({
-        providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-        imports: [
-          ScrollingModule,
-          MatFormFieldModule,
-          FormsModule,
-          MatInputModule,
-          BrowserAnimationsModule,
-          MatSelectModule,
-        ],
-        declarations: [
-          ViewerProtologComponent,
-          SelectWithFilterComponent,
-          LogComponent,
-          ProtologScrollDirective,
-        ],
-        schemas: [CUSTOM_ELEMENTS_SCHEMA],
-      }).compileComponents();
-      fixture = TestBed.createComponent(ViewerProtologComponent);
-      component = fixture.componentInstance;
-      htmlElement = fixture.nativeElement;
-
-      component.inputData = makeUiData();
-      fixture.detectChanges();
+      await setUpTestEnvironment();
     });
 
     it('can be created', () => {
       expect(component).toBeTruthy();
     });
 
-    it('creates message filters', () => {
-      expect(htmlElement.querySelector('.filters .log-level')).toBeTruthy();
-      expect(htmlElement.querySelector('.filters .tag')).toBeTruthy();
-      expect(htmlElement.querySelector('.filters .source-file')).toBeTruthy();
-      expect(htmlElement.querySelector('.filters .text')).toBeTruthy();
+    it('render headers as filters', () => {
+      expect(
+        htmlElement.querySelector(
+          `.headers .filter.${testSpec.cssClass.split(' ')[0]}`,
+        ),
+      ).toBeTruthy();
     });
 
-    it('renders log messages', () => {
+    it('renders entries with field values and no trace timestamp', () => {
       expect(htmlElement.querySelector('.scroll')).toBeTruthy();
-      const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
-      expect(entry.innerHTML).toContain('INFO');
-      expect(entry.innerHTML).toContain('WindowManager');
-      expect(entry.innerHTML).toContain('test_source_file.java');
-      expect(entry.innerHTML).toContain('test information about message');
+      const entry = assertDefined(
+        htmlElement.querySelector(
+          `.scroll .entry .${testSpec.cssClass.split(' ')[0]}`,
+        ),
+      );
+      expect(entry.textContent).toContain('VALUE');
+
+      const entryTimestamp = assertDefined(
+        htmlElement.querySelector('.scroll .entry .time'),
+      );
+      expect(entryTimestamp.textContent?.trim()).toEqual('10ns');
+    });
+
+    it('shows go to current time button', () => {
+      expect(htmlElement.querySelector('.go-to-current-time')).toBeTruthy();
     });
   });
 
   describe('Scroll component', () => {
     executeScrollComponentTests(setUpTestEnvironment);
-    async function setUpTestEnvironment(): Promise<
-      [
-        ComponentFixture<ViewerProtologComponent>,
-        HTMLElement,
-        CdkVirtualScrollViewport,
-      ]
-    > {
-      await TestBed.configureTestingModule({
-        providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-        imports: [
-          ScrollingModule,
-          MatFormFieldModule,
-          FormsModule,
-          MatInputModule,
-          BrowserAnimationsModule,
-          MatSelectModule,
-        ],
-        declarations: [
-          ViewerProtologComponent,
-          LogComponent,
-          ProtologScrollDirective,
-        ],
-        schemas: [CUSTOM_ELEMENTS_SCHEMA],
-      }).compileComponents();
-      const fixture = TestBed.createComponent(ViewerProtologComponent);
-      const protologComponent = fixture.componentInstance;
-      const htmlElement = fixture.nativeElement;
-      protologComponent.inputData = makeUiData();
-      fixture.detectChanges();
-      const viewport = assertDefined(
-        protologComponent.logComponent?.scrollComponent,
-      );
-      return [fixture, htmlElement, viewport];
-    }
   });
 
+  async function setUpTestEnvironment(): Promise<
+    [
+      ComponentFixture<ViewerProtologComponent>,
+      HTMLElement,
+      CdkVirtualScrollViewport,
+    ]
+  > {
+    await TestBed.configureTestingModule({
+      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      imports: [
+        ScrollingModule,
+        MatFormFieldModule,
+        FormsModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        MatSelectModule,
+        MatButtonModule,
+        MatIconModule,
+      ],
+      declarations: [
+        ViewerProtologComponent,
+        SelectWithFilterComponent,
+        LogComponent,
+        ProtologScrollDirective,
+        SearchBoxComponent,
+      ],
+    }).compileComponents();
+    fixture = TestBed.createComponent(ViewerProtologComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+
+    component.inputData = makeUiData();
+    fixture.detectChanges();
+    const viewport = assertDefined(component.logComponent?.scrollComponent);
+    return [fixture, htmlElement, viewport];
+  }
+
   function makeUiData(): UiData {
-    const allLogLevels = ['INFO', 'ERROR'];
-    const allTags = ['WindowManager', 'INVALID'];
-    const allSourceFiles = [
-      'test_source_file.java',
-      'other_test_source_file.java',
-    ];
     const propertiesTree = new PropertyTreeBuilder()
       .setRootId('Protolog')
       .setName('tree')
@@ -155,31 +145,22 @@ describe('ViewerProtologComponent', () => {
     const messages: ProtologEntry[] = [];
     const shortMessage = 'test information about message';
     const longMessage = shortMessage.repeat(10) + 'keep';
+    const traceEntry = trace.getEntry(0);
     for (let i = 0; i < 200; i++) {
-      const message = new ProtologEntry(trace.getEntry(0), [
-        {
-          type: LogFieldType.LOG_LEVEL,
-          value: i % 2 === 0 ? allLogLevels[0] : allLogLevels[1],
-        },
-        {type: LogFieldType.TAG, value: i % 2 === 0 ? allTags[0] : allTags[1]},
-        {
-          type: LogFieldType.SOURCE_FILE,
-          value: i % 2 === 0 ? allSourceFiles[0] : allSourceFiles[1],
-        },
-        {
-          type: LogFieldType.TEXT,
-          value: i % 2 === 0 ? shortMessage : longMessage,
-        },
-      ]);
-      messages.push(message);
+      messages.push(
+        new ProtologEntry(traceEntry, [
+          testField,
+          testField,
+          testField,
+          {
+            spec: {name: 'Test Column Text', cssClass: 'test-class-text'},
+            value: i % 2 === 0 ? shortMessage : longMessage,
+          },
+        ]),
+      );
     }
     return new UiData(
-      [
-        {type: LogFieldType.LOG_LEVEL, options: allLogLevels},
-        {type: LogFieldType.TAG, options: allTags},
-        {type: LogFieldType.SOURCE_FILE, options: allSourceFiles},
-        {type: LogFieldType.TEXT},
-      ],
+      [new LogHeader(testSpec, new LogSelectFilter([]))],
       messages,
       150,
       undefined,
diff --git a/tools/winscope/src/viewers/viewer_search/presenter.ts b/tools/winscope/src/viewers/viewer_search/presenter.ts
new file mode 100644
index 000000000..524edf4f7
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/presenter.ts
@@ -0,0 +1,236 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {FunctionUtils} from 'common/function_utils';
+import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
+import {
+  InitializeTraceSearchRequest,
+  TracePositionUpdate,
+  TraceRemoveRequest,
+  TraceSearchRequest,
+  WinscopeEvent,
+  WinscopeEventType,
+} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {QueryResult} from 'trace_processor/query_result';
+import {
+  DeleteSavedQueryClickDetail,
+  QueryClickDetail,
+  SaveQueryClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {SearchResultPresenter} from './search_result_presenter';
+import {Search, SearchResult, UiData} from './ui_data';
+
+class QueryAndTrace {
+  constructor(
+    readonly query: string,
+    public trace: Trace<QueryResult> | undefined,
+  ) {}
+}
+
+export class Presenter {
+  private emitWinscopeEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
+  private uiData = UiData.createEmpty();
+  private runQueries: QueryAndTrace[] = [];
+  private savedSearches = PersistentStoreProxy.new<{searches: Search[]}>(
+    'savedSearches',
+    {searches: []},
+    this.storage,
+  );
+  private currentSearchPresenters: SearchResultPresenter[] = [];
+  private viewerElement: HTMLElement | undefined;
+
+  constructor(
+    private traces: Traces,
+    private storage: Store,
+    private readonly notifyViewCallback: (uiData: UiData) => void,
+  ) {
+    this.uiData.savedSearches = Array.from(this.savedSearches.searches);
+    this.copyUiDataAndNotifyView();
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.emitWinscopeEvent = callback;
+  }
+
+  addEventListeners(htmlElement: HTMLElement) {
+    this.viewerElement = htmlElement;
+    htmlElement.addEventListener(
+      ViewerEvents.GlobalSearchSectionClick,
+      async (event) => {
+        this.onGlobalSearchSectionClick();
+      },
+    );
+    htmlElement.addEventListener(
+      ViewerEvents.SearchQueryClick,
+      async (event) => {
+        const detail: QueryClickDetail = (event as CustomEvent).detail;
+        this.onSearchQueryClick(detail.query);
+      },
+    );
+    htmlElement.addEventListener(ViewerEvents.SaveQueryClick, async (event) => {
+      const detail: SaveQueryClickDetail = (event as CustomEvent).detail;
+      this.onSaveQueryClick(detail.query, detail.name);
+    });
+    htmlElement.addEventListener(
+      ViewerEvents.DeleteSavedQueryClick,
+      async (event) => {
+        const detail: DeleteSavedQueryClickDetail = (event as CustomEvent)
+          .detail;
+        this.onDeleteSavedQueryClick(detail.search);
+      },
+    );
+  }
+
+  async onAppEvent(event: WinscopeEvent) {
+    await event.visit(
+      WinscopeEventType.TRACE_SEARCH_INITIALIZED,
+      async (event) => {
+        this.uiData.searchViews = event.views;
+        this.uiData.initialized = true;
+        this.copyUiDataAndNotifyView();
+      },
+    );
+    await event.visit(WinscopeEventType.TRACE_ADD_REQUEST, async (event) => {
+      if (event.trace.type === TraceType.SEARCH) {
+        this.showQueryResult(event.trace as Trace<QueryResult>);
+      }
+    });
+    await event.visit(WinscopeEventType.TRACE_SEARCH_FAILED, async (event) => {
+      this.onTraceSearchFailed();
+    });
+    for (const p of this.currentSearchPresenters) {
+      await p.onAppEvent(event);
+    }
+  }
+
+  async onGlobalSearchSectionClick() {
+    if (!this.uiData.initialized) {
+      this.emitWinscopeEvent(new InitializeTraceSearchRequest());
+    }
+  }
+
+  async onSearchQueryClick(query: string) {
+    if (this.runQueries.length > 0) {
+      this.clearQuery(this.runQueries[this.runQueries.length - 1].query);
+    }
+    this.runQueries.push(new QueryAndTrace(query, undefined));
+    this.emitWinscopeEvent(new TraceSearchRequest(query));
+  }
+
+  private clearQuery(query: string) {
+    this.uiData.currentSearches = this.uiData.currentSearches.filter(
+      (s) => s.query !== query,
+    );
+    this.copyUiDataAndNotifyView();
+    this.currentSearchPresenters = this.currentSearchPresenters.filter((p) => {
+      if (p.query === query) {
+        p.onDestroy();
+        return false;
+      }
+      return true;
+    });
+
+    const runQueryIndex = this.runQueries.findIndex((r) => r.query === query);
+    if (runQueryIndex !== -1) {
+      const trace = this.runQueries[runQueryIndex].trace;
+      if (trace) {
+        this.emitWinscopeEvent(new TraceRemoveRequest(trace));
+        this.runQueries.splice(runQueryIndex, 1);
+      }
+    }
+  }
+
+  onSaveQueryClick(query: string, name: string) {
+    this.uiData.savedSearches.unshift(new Search(query, name));
+    this.savedSearches.searches = this.uiData.savedSearches;
+    this.copyUiDataAndNotifyView();
+  }
+
+  onDeleteSavedQueryClick(savedSearch: Search) {
+    this.uiData.savedSearches = this.uiData.savedSearches.filter(
+      (s) => s !== savedSearch,
+    );
+    this.savedSearches.searches = this.uiData.savedSearches;
+    this.copyUiDataAndNotifyView();
+  }
+
+  private onTraceSearchFailed() {
+    this.uiData.lastTraceFailed = true;
+    this.copyUiDataAndNotifyView();
+    this.uiData.lastTraceFailed = false;
+  }
+
+  private async showQueryResult(newTrace: Trace<QueryResult>) {
+    const traceQuery = newTrace.getDescriptors()[0];
+    const runQuery = assertDefined(
+      this.runQueries.find((q) => q.query === traceQuery),
+    );
+    runQuery.trace = newTrace;
+
+    if (this.uiData.recentSearches.length >= 10) {
+      this.uiData.recentSearches.pop();
+    }
+    this.uiData.recentSearches.unshift(new Search(runQuery.query));
+
+    this.uiData.currentSearches = [];
+    for (const {query, trace} of this.runQueries) {
+      if (trace) {
+        const firstEntry =
+          trace.lengthEntries > 0 ? trace.getEntry(0) : undefined;
+        const presenter = new SearchResultPresenter(
+          query,
+          trace,
+          (result: SearchResult) => {
+            const currentSearch = this.uiData.currentSearches.find(
+              (search) => search.query === result.query,
+            );
+            if (currentSearch) {
+              currentSearch.scrollToIndex = result.scrollToIndex;
+              currentSearch.selectedIndex = result.selectedIndex;
+            } else {
+              this.uiData.currentSearches.push(result);
+            }
+            this.copyUiDataAndNotifyView();
+          },
+          firstEntry ? await firstEntry.getValue() : undefined,
+        );
+        presenter.addEventListeners(assertDefined(this.viewerElement));
+        presenter.setEmitEvent(async (event) => this.emitWinscopeEvent(event));
+        this.currentSearchPresenters.push(presenter);
+        if (firstEntry) {
+          await this.emitWinscopeEvent(
+            TracePositionUpdate.fromTraceEntry(firstEntry),
+          );
+        }
+      }
+    }
+    this.copyUiDataAndNotifyView();
+  }
+
+  private copyUiDataAndNotifyView() {
+    // Create a shallow copy of the data, otherwise the Angular OnPush change detection strategy
+    // won't detect the new input
+    const copy = Object.assign({}, this.uiData);
+    this.notifyViewCallback(copy);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_search/presenter_test.ts b/tools/winscope/src/viewers/viewer_search/presenter_test.ts
new file mode 100644
index 000000000..2e271376a
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/presenter_test.ts
@@ -0,0 +1,278 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {
+  InitializeTraceSearchRequest,
+  TraceAddRequest,
+  TracePositionUpdate,
+  TraceRemoveRequest,
+  TraceSearchFailed,
+  TraceSearchInitialized,
+  TraceSearchRequest,
+} from 'messaging/winscope_event';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {QueryResult} from 'trace_processor/query_result';
+import {
+  DeleteSavedQueryClickDetail,
+  QueryClickDetail,
+  SaveQueryClickDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {Presenter} from './presenter';
+import {Search, SearchResult, UiData} from './ui_data';
+
+describe('PresenterSearch', () => {
+  let presenter: Presenter;
+  let uiData: UiData;
+  let userNotifierChecker: UserNotifierChecker;
+  let element: HTMLElement;
+  let emitEventSpy: jasmine.Spy;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+    jasmine.addCustomEqualityTester(searchEqualityTester);
+  });
+
+  beforeEach(() => {
+    presenter = new Presenter(
+      new Traces(),
+      new InMemoryStorage(),
+      (newData: UiData) => (uiData = newData),
+    );
+    userNotifierChecker.reset();
+    element = document.createElement('div');
+    presenter.addEventListeners(element);
+    emitEventSpy = jasmine.createSpy();
+    presenter.setEmitEvent(emitEventSpy);
+  });
+
+  it('adds event listeners', () => {
+    let spy: jasmine.Spy = spyOn(presenter, 'onGlobalSearchSectionClick');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.GlobalSearchSectionClick),
+    );
+    expect(spy).toHaveBeenCalled();
+
+    spy = spyOn(presenter, 'onSearchQueryClick');
+    const testQuery = 'search query';
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.SearchQueryClick, {
+        detail: new QueryClickDetail(testQuery),
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(testQuery);
+
+    spy = spyOn(presenter, 'onSaveQueryClick');
+    const saveQueryDetail = new SaveQueryClickDetail('save query', 'foo');
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.SaveQueryClick, {
+        detail: saveQueryDetail,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(
+      saveQueryDetail.query,
+      saveQueryDetail.name,
+    );
+
+    spy = spyOn(presenter, 'onDeleteSavedQueryClick');
+    const deleteQueryDetail = new DeleteSavedQueryClickDetail(
+      new Search('delete query', 'bar'),
+    );
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.DeleteSavedQueryClick, {
+        detail: deleteQueryDetail,
+      }),
+    );
+    expect(spy).toHaveBeenCalledWith(deleteQueryDetail.search);
+  });
+
+  it('handles trace search initialization', async () => {
+    await presenter.onGlobalSearchSectionClick();
+    expect(emitEventSpy).toHaveBeenCalledOnceWith(
+      new InitializeTraceSearchRequest(),
+    );
+    expect(uiData.initialized).toBeFalse();
+
+    await presenter.onAppEvent(new TraceSearchInitialized(['test_view']));
+    expect(uiData.initialized).toBeTrue();
+    expect(uiData.searchViews).toEqual(['test_view']);
+
+    emitEventSpy.calls.reset();
+    await presenter.onGlobalSearchSectionClick();
+    expect(emitEventSpy).not.toHaveBeenCalled();
+  });
+
+  it('handles search for successful query with zero rows', async () => {
+    const query = 'successful empty query';
+    await runSearchWithNoRowsAndCheckUiData(
+      query,
+      UnitTestUtils.makeEmptyTrace(TraceType.SEARCH, [query]),
+    );
+  });
+
+  it('handles search for successful query with non-zero rows', async () => {
+    const testQuery = 'successful non-empty query';
+    presenter.onSearchQueryClick(testQuery);
+    expect(emitEventSpy).toHaveBeenCalledOnceWith(
+      new TraceSearchRequest(testQuery),
+    );
+
+    const time100 = TimestampConverterUtils.makeRealTimestamp(100n);
+    const [spyQueryResult, spyIter] =
+      UnitTestUtils.makeSearchTraceSpies(time100);
+    const trace = new TraceBuilder<QueryResult>()
+      .setEntries([spyQueryResult])
+      .setTimestamps([time100])
+      .setDescriptors([testQuery])
+      .setType(TraceType.SEARCH)
+      .build();
+
+    await presenter.onAppEvent(new TraceAddRequest(trace));
+    const expectedSearchResult = new SearchResult(testQuery, [], []);
+    expect(uiData.currentSearches).toEqual([expectedSearchResult]);
+    expect(uiData.lastTraceFailed).toEqual(false);
+
+    await presenter.onAppEvent(
+      TracePositionUpdate.fromTraceEntry(trace.getEntry(0)),
+    );
+    expect(uiData.currentSearches.length).toEqual(1);
+    expect(uiData.currentSearches[0].currentIndex).toEqual(0);
+    expect(uiData.currentSearches[0].headers.length).toEqual(2);
+    expect(uiData.currentSearches[0].entries.length).toEqual(1);
+    expect(uiData.lastTraceFailed).toEqual(false);
+    expect(uiData.recentSearches).toEqual([new Search(testQuery)]);
+
+    // adds event listeners and emit event for search presenter
+    emitEventSpy.calls.reset();
+    element.dispatchEvent(
+      new CustomEvent(ViewerEvents.TimestampClick, {
+        detail: new TimestampClickDetail(undefined, time100),
+      }),
+    );
+    expect(emitEventSpy).toHaveBeenCalledOnceWith(
+      TracePositionUpdate.fromTimestamp(time100, true),
+    );
+  });
+
+  it('handles non-search trace added event', async () => {
+    const currData = uiData;
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.SURFACE_FLINGER);
+    await presenter.onAppEvent(new TraceAddRequest(trace));
+    expect(uiData).toEqual(currData);
+  });
+
+  it('handles search for unsuccessful query', async () => {
+    const testQuery = 'unsuccessful query';
+    presenter.onSearchQueryClick(testQuery);
+    await presenter.onAppEvent(new TraceSearchFailed());
+    expect(uiData.lastTraceFailed).toEqual(true);
+    expect(uiData.currentSearches).toEqual([]);
+    expect(uiData.recentSearches).toEqual([]);
+  });
+
+  it('clears current search result when query run again, keeping both in recent searches', async () => {
+    const testQuery = 'query to be overwritten';
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.SEARCH, [testQuery]);
+    await runSearchWithNoRowsAndCheckUiData(testQuery, trace);
+    emitEventSpy.calls.reset();
+
+    await presenter.onSearchQueryClick(testQuery);
+    expect(emitEventSpy).toHaveBeenCalledWith(new TraceRemoveRequest(trace));
+    expect(emitEventSpy).toHaveBeenCalledWith(
+      new TraceSearchRequest(testQuery),
+    );
+    expect(uiData.currentSearches).toEqual([]);
+    expect(uiData.recentSearches).toEqual([new Search(testQuery)]);
+    emitEventSpy.calls.reset();
+
+    const newQuery = 'new query';
+    const newTrace = UnitTestUtils.makeEmptyTrace(TraceType.SEARCH, [newQuery]);
+    await runSearchWithNoRowsAndCheckUiData(newQuery, newTrace);
+    emitEventSpy.calls.reset();
+
+    // check removed presenter cannot still affect ui data
+    element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowDownPress));
+    expect(uiData.currentSearches.length).toEqual(1);
+
+    await presenter.onSearchQueryClick(newQuery);
+    expect(emitEventSpy).toHaveBeenCalledWith(new TraceRemoveRequest(newTrace));
+    expect(emitEventSpy).toHaveBeenCalledWith(new TraceSearchRequest(newQuery));
+    expect(uiData.currentSearches).toEqual([]);
+    expect(uiData.recentSearches).toEqual([
+      new Search(newQuery),
+      new Search(testQuery),
+    ]);
+  });
+
+  it('handles save query click', () => {
+    const testQuery = 'save query';
+    const testName = 'save name';
+    presenter.onSaveQueryClick(testQuery, testName);
+    const testSearch = new Search(testQuery, testName);
+    expect(uiData.savedSearches).toEqual([testSearch]);
+
+    const newQuery = 'new save query';
+    const newName = 'new save name';
+    presenter.onSaveQueryClick(newQuery, newName);
+    const newSearch = new Search(newQuery, newName);
+    expect(uiData.savedSearches).toEqual([newSearch, testSearch]);
+  });
+
+  it('handles delete saved query click', () => {
+    const testQuery = 'delete query';
+    const testName = 'delete name';
+    const testSearch = new Search(testQuery, testName);
+    presenter.onDeleteSavedQueryClick(testSearch);
+    expect(uiData.savedSearches).toEqual([]);
+
+    presenter.onSaveQueryClick(testQuery, testName);
+    expect(uiData.savedSearches).toEqual([testSearch]);
+
+    presenter.onDeleteSavedQueryClick(uiData.savedSearches[0]);
+    expect(uiData.savedSearches).toEqual([]);
+  });
+
+  function searchEqualityTester(first: any, second: any): boolean | undefined {
+    if (first instanceof Search && second instanceof Search) {
+      return first.query === second.query && first.name === second.name;
+    }
+    return undefined;
+  }
+
+  async function runSearchWithNoRowsAndCheckUiData(
+    testQuery: string,
+    trace: Trace<QueryResult>,
+  ) {
+    presenter.onSearchQueryClick(testQuery);
+    expect(emitEventSpy).toHaveBeenCalledOnceWith(
+      new TraceSearchRequest(testQuery),
+    );
+    await presenter.onAppEvent(new TraceAddRequest(trace));
+    expect(uiData.currentSearches).toEqual([
+      new SearchResult(testQuery, [], []),
+    ]);
+    expect(uiData.lastTraceFailed).toEqual(false);
+    expect(uiData.recentSearches[0]).toEqual(new Search(testQuery));
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_search/search_list_component.ts b/tools/winscope/src/viewers/viewer_search/search_list_component.ts
new file mode 100644
index 000000000..26f9e770b
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/search_list_component.ts
@@ -0,0 +1,140 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {NgTemplateOutlet} from '@angular/common';
+import {Component, Input} from '@angular/core';
+import {Search} from './ui_data';
+
+@Component({
+  selector: 'search-list',
+  template: `
+    <span class="mat-body-1" *ngIf="searches.length === 0">
+      {{placeholderText}}
+    </span>
+    <div class="listed-search" *ngFor="let search of searches">
+      <span
+        #searchName
+        class="mat-body-2 listed-search-name"
+        [matTooltipDisabled]="!showTooltip(search, searchName)"
+        [matTooltip]="getTooltip(search)"> {{search.name}} </span>
+      <div class="listed-search-date-options">
+        <span> {{formatTimeMs(search.timeMs)}} </span>
+        <button
+          mat-icon-button
+          class="listed-search-options"
+          *ngIf="menuOptions.length > 0"
+          [class.force-show]="searchOptionsTarget === search"
+          (click)="searchOptionsTarget = search"
+          [cdkMenuTriggerFor]="optionsMenu">
+          <mat-icon> more_vert </mat-icon>
+        </button>
+
+        <ng-template #optionsMenu>
+          <div class="context-menu" cdkMenu>
+            <div class="context-menu-item-container">
+              <ng-container *ngFor="let opt of menuOptions">
+                <span
+                  *ngIf="opt.innerMenu"
+                  class="context-menu-item"
+                  cdkMenuItem
+                  [cdkMenuTriggerFor]="innerMenu"> {{opt.name}} </span>
+                <span
+                  *ngIf="!opt.innerMenu"
+                  class="context-menu-item"
+                  (click)="opt.onClickCallback(search)"
+                  cdkMenuItem> {{opt.name}} </span>
+
+                  <ng-template #innerMenu>
+                    <div class="context-menu inner-menu" cdkMenu>
+                      <div class="context-menu-item-container">
+                        <span class="context-menu-item" [cdkMenuItemDisabled]="true" cdkMenuItem>
+                          <ng-container
+                            [ngTemplateOutlet]="opt.innerMenu"
+                            [ngTemplateOutletContext]="{search}"></ng-container>
+                        </span>
+                      </div>
+                    </div>
+                  </ng-template>
+              </ng-container>
+            </div>
+          </div>
+        </ng-template>
+      </div>
+    </div>
+  `,
+  styles: [
+    `
+      .listed-search {
+        display: flex;
+        flex-direction: row;
+        align-items: center;
+        justify-content: space-between;
+      }
+      .listed-search {
+        width: 100%;
+        column-gap: 10px;
+      }
+      .listed-search:hover {
+          background-color: var(--hover-element-color);
+      }
+      .listed-search:not(:hover) .listed-search-options:not(.force-show) {
+        visibility: hidden;
+      }
+      .listed-search-name {
+        overflow: hidden;
+        text-overflow: ellipsis;
+        white-space: nowrap;
+      }
+      .listed-search-date-options {
+        display: flex;
+        flex-direction: row;
+        align-items: center;
+        white-space: pre-line;
+      }
+      .listed-search-options {
+        width: fit-content;
+        cursor: pointer;
+      }
+    `,
+  ],
+})
+export class SearchListComponent {
+  @Input() searches: Search[] = [];
+  @Input() placeholderText = '';
+  @Input() menuOptions: MenuOption[] = [];
+
+  searchOptionsTarget: Search | undefined;
+
+  showTooltip(search: Search, el: HTMLElement) {
+    return search.name !== search.query || el.scrollWidth > el.offsetWidth;
+  }
+
+  getTooltip(search: Search) {
+    if (search.name === search.query) return search.query;
+    return search.name + ': ' + search.query;
+  }
+
+  formatTimeMs(timeMs: number) {
+    const time = new Date(timeMs);
+    return time.toTimeString().slice(0, 5) + '\n' + time.toLocaleDateString();
+  }
+}
+
+export interface MenuOption {
+  name: string;
+  onClickCallback: (search: Search) => void;
+  innerMenu?: NgTemplateOutlet;
+}
diff --git a/tools/winscope/src/viewers/viewer_search/search_list_component_test.ts b/tools/winscope/src/viewers/viewer_search/search_list_component_test.ts
new file mode 100644
index 000000000..b68fd95d3
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/search_list_component_test.ts
@@ -0,0 +1,193 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {CdkMenuModule} from '@angular/cdk/menu';
+import {NgTemplateOutlet} from '@angular/common';
+import {Component, ViewChild} from '@angular/core';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {MatButtonModule} from '@angular/material/button';
+import {MatIconModule} from '@angular/material/icon';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {MenuOption, SearchListComponent} from './search_list_component';
+import {Search} from './ui_data';
+
+describe('SearchListComponent', () => {
+  let fixture: ComponentFixture<TestHostComponent>;
+  let component: TestHostComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      declarations: [TestHostComponent, SearchListComponent],
+      imports: [
+        CdkMenuModule,
+        BrowserAnimationsModule,
+        MatTooltipModule,
+        MatIconModule,
+        MatButtonModule,
+      ],
+    }).compileComponents();
+    fixture = TestBed.createComponent(TestHostComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('shows placeholder text if no searches', () => {
+    expect(htmlElement.textContent?.trim()).toEqual('');
+    const placeholderText = 'placeholder text';
+    component.placeholderText = placeholderText;
+    fixture.detectChanges();
+    expect(htmlElement.textContent?.trim()).toEqual(placeholderText);
+  });
+
+  it('shows search names with tooltips', () => {
+    component.searches = [
+      new Search('query1', 'name1'),
+      new Search('query2', 'query2'),
+    ];
+    fixture.detectChanges();
+
+    const listedSearches =
+      htmlElement.querySelectorAll<HTMLElement>('.listed-search');
+    expect(listedSearches.length).toEqual(2);
+
+    const queryName1 = assertDefined(
+      listedSearches[0].querySelector<HTMLElement>('.listed-search-name'),
+    );
+    const queryName2 = assertDefined(
+      listedSearches[1].querySelector<HTMLElement>('.listed-search-name'),
+    );
+    expect(queryName1.textContent?.trim()).toEqual('name1');
+    expect(queryName2.textContent?.trim()).toEqual('query2');
+
+    // shows tooltip when name and query are different
+    queryName1.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      assertDefined(
+        document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+      ).textContent?.trim(),
+    ).toEqual('name1: query1');
+    queryName1.dispatchEvent(new Event('mouseleave'));
+    fixture.detectChanges();
+
+    // does not show tooltip when name and query are the same
+    queryName2.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+    ).toBeNull();
+
+    // shows tooltip when element is overflowing
+    queryName2.style.maxWidth = queryName2.offsetWidth / 2 + 'px';
+    fixture.detectChanges();
+    queryName2.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      assertDefined(
+        document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+      ).textContent?.trim(),
+    ).toEqual('query2');
+  });
+
+  it('formats search dates', () => {
+    spyOn(Date, 'now').and.returnValue(0);
+    component.searches = [new Search('query1', 'name1')];
+    fixture.detectChanges();
+    expect(
+      htmlElement
+        .querySelector('.listed-search-date-options')
+        ?.textContent?.trim(),
+    ).toEqual('01:00\n1/1/1970');
+  });
+
+  it('shows menu options and triggers callback on interaction', () => {
+    let optionClicked: Search | undefined;
+    component.searches = [new Search('query1', 'name1')];
+    fixture.detectChanges();
+    // does not show menu button if no options
+    expect(htmlElement.querySelector('.listed-search-options')).toBeNull();
+
+    const onClickCallback = (search: Search) => (optionClicked = search);
+    component.menuOptions = [{name: 'option1', onClickCallback}];
+    fixture.detectChanges();
+    assertDefined(
+      htmlElement.querySelector<HTMLElement>('.listed-search-options'),
+    ).click();
+    const option = assertDefined(
+      document.querySelector<HTMLElement>('.context-menu .context-menu-item'),
+    );
+    expect(option.textContent?.trim()).toEqual('option1');
+    option.click();
+    expect(optionClicked).toEqual(component.searches[0]);
+  });
+
+  it('shows inner menu', () => {
+    let clickedSearch: Search | undefined;
+    component.menuOptions = [
+      {
+        name: 'option1',
+        onClickCallback: (search: Search) => (clickedSearch = search),
+        innerMenu: component.testTemplate,
+      },
+    ];
+    component.searches = [new Search('query1', 'name1')];
+    fixture.detectChanges();
+    assertDefined(
+      htmlElement.querySelector<HTMLElement>('.listed-search-options'),
+    ).click();
+
+    const option = assertDefined(
+      document.querySelector<HTMLElement>('.context-menu .context-menu-item'),
+    );
+    expect(option.textContent?.trim()).toEqual('option1');
+    option.dispatchEvent(new MouseEvent('mouseenter'));
+
+    const innerMenu = assertDefined(document.querySelector('.inner-menu'));
+    expect(innerMenu.querySelector('.inner-menu-item')).toBeTruthy();
+  });
+
+  @Component({
+    selector: 'host-component',
+    template: `
+      <search-list
+        [searches]="searches"
+        [placeholderText]="placeholderText"
+        [menuOptions]="menuOptions"></search-list>
+
+      <ng-template #testTemplate>
+        <span class="inner-menu-item"></span>
+      </ng-template>
+    `,
+  })
+  class TestHostComponent {
+    @ViewChild(SearchListComponent) searchListComponent:
+      | SearchListComponent
+      | undefined;
+    @ViewChild('testTemplate') testTemplate: NgTemplateOutlet | undefined;
+
+    searches: Search[] = [];
+    placeholderText: string | undefined;
+    menuOptions: MenuOption[] = [];
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_search/search_result_presenter.ts b/tools/winscope/src/viewers/viewer_search/search_result_presenter.ts
new file mode 100644
index 000000000..d4717ca36
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/search_result_presenter.ts
@@ -0,0 +1,122 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FunctionUtils} from 'common/function_utils';
+import {Trace, TraceEntry} from 'trace/trace';
+import {QueryResult, RowIteratorBase} from 'trace_processor/query_result';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {
+  LogEntry,
+  LogField,
+  LogFieldValue,
+  LogHeader,
+} from 'viewers/common/ui_data_log';
+import {SearchResult} from './ui_data';
+
+export class SearchResultPresenter extends AbstractLogViewerPresenter<
+  SearchResult,
+  QueryResult
+> {
+  protected override logPresenter = new LogPresenter<LogEntry>();
+  constructor(
+    readonly query: string,
+    trace: Trace<QueryResult>,
+    notifyViewCallback: NotifyLogViewCallbackType<SearchResult>,
+    private readonly queryResult?: QueryResult,
+  ) {
+    super(trace, notifyViewCallback, new SearchResult(query, [], []));
+  }
+
+  onDestroy() {
+    // until presenter is garbage collected it may still receive events
+    // so we must make sure it can no longer affect ui data
+    this.notifyViewChanged = FunctionUtils.DO_NOTHING;
+  }
+
+  protected override makeHeaders(): LogHeader[] {
+    return (
+      this.queryResult?.columns().map((colName) => {
+        return new LogHeader({name: colName, cssClass: 'search-result'});
+      }) ?? []
+    );
+  }
+
+  protected override async makeUiDataEntries(
+    headers: LogHeader[],
+  ): Promise<LogEntry[]> {
+    if (!this.queryResult || this.trace.lengthEntries === 0) {
+      return [];
+    }
+    const entry = this.trace.getEntry(0);
+    const hasTimestamps = !this.trace.isDumpWithoutTimestamp();
+    const entries: LogEntry[] = [];
+    let i = 0;
+    for (const it = this.queryResult.iter({}); it.valid(); it.next()) {
+      entries.push(
+        this.makeLogEntry(
+          headers,
+          it,
+          i,
+          hasTimestamps ? this.trace.getEntry(i) : entry,
+        ),
+      );
+      i++;
+    }
+    return entries;
+  }
+
+  private makeLogEntry(
+    headers: LogHeader[],
+    it: RowIteratorBase,
+    i: number,
+    traceEntry: TraceEntry<QueryResult>,
+  ): LogEntry {
+    const fields: LogField[] = [];
+    for (const header of headers) {
+      const value = it.get(header.spec.name);
+      if (header.spec.name === 'ts') {
+        fields.push({
+          spec: header.spec,
+          value: this.trace.getEntry(i).getTimestamp(),
+        });
+      } else {
+        let displayValue: LogFieldValue;
+        if (value === null) {
+          displayValue = 'NULL';
+        } else if (typeof value === 'bigint') {
+          displayValue = Number(value);
+        } else if (value instanceof Uint8Array) {
+          displayValue = '[]';
+        } else {
+          displayValue = value;
+        }
+        fields.push({
+          spec: header.spec,
+          value: displayValue,
+        });
+      }
+    }
+    return {
+      traceEntry,
+      fields,
+      propertiesTree: undefined,
+    };
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_search/search_result_presenter_test.ts b/tools/winscope/src/viewers/viewer_search/search_result_presenter_test.ts
new file mode 100644
index 000000000..17284e3f4
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/search_result_presenter_test.ts
@@ -0,0 +1,124 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TracePositionUpdate} from 'messaging/winscope_event';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
+import {QueryResult, Row, RowIterator} from 'trace_processor/query_result';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {LogHeader} from 'viewers/common/ui_data_log';
+import {SearchResultPresenter} from './search_result_presenter';
+import {SearchResult} from './ui_data';
+
+class SearchResultPresenterTest extends AbstractLogViewerPresenterTest<SearchResult> {
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader({
+        name: 'ts',
+        cssClass: 'search-result',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'property',
+        cssClass: 'search-result',
+      }),
+    },
+  ];
+  private trace: Trace<QueryResult> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private spyIter: jasmine.SpyObj<RowIterator<Row>> | undefined;
+
+  override async setUpTestEnvironment(): Promise<void> {
+    const time100 = TimestampConverterUtils.makeRealTimestamp(100n);
+    const [spyQueryResult, spyIter] =
+      UnitTestUtils.makeSearchTraceSpies(time100);
+    this.spyIter = spyIter;
+    this.trace = new TraceBuilder<QueryResult>()
+      .setEntries([spyQueryResult])
+      .setTimestamps([time100])
+      .setType(TraceType.SEARCH)
+      .build();
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
+    );
+  }
+
+  override resetTestEnvironment() {
+    assertDefined(this.spyIter).valid.and.returnValue(true);
+  }
+
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<SearchResult>,
+  ): Promise<SearchResultPresenter> {
+    const time100 = TimestampConverterUtils.makeRealTimestamp(100n);
+    const [spyQueryResult, spyIter] =
+      UnitTestUtils.makeSearchTraceSpies(time100);
+    this.spyIter = spyIter;
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.SEARCH);
+    return new SearchResultPresenter(
+      'fake query',
+      trace,
+      callback,
+      spyQueryResult,
+    );
+  }
+
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<SearchResult>,
+    trace = assertDefined(this.trace),
+    positionUpdate = assertDefined(this.getPositionUpdate()),
+  ): Promise<SearchResultPresenter> {
+    const presenter = new SearchResultPresenter(
+      'successful query',
+      trace,
+      callback,
+      await trace.getEntry(0).getValue(),
+    );
+    await presenter.onAppEvent(positionUpdate); // trigger initialization
+    return presenter;
+  }
+
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
+  }
+
+  override executePropertiesChecksAfterPositionUpdate(result: SearchResult) {
+    const firstEntry = assertDefined(this.trace).getEntry(0);
+    expect(result.entries).toEqual([
+      {
+        traceEntry: firstEntry,
+        fields: [
+          {
+            spec: this.expectedHeaders[0].header.spec,
+            value: firstEntry.getTimestamp(),
+          },
+          {spec: this.expectedHeaders[1].header.spec, value: 'test_value'},
+        ],
+        propertiesTree: undefined,
+      },
+    ]);
+  }
+}
+
+describe('SearchResultPresenterTest', () => {
+  new SearchResultPresenterTest().execute();
+});
diff --git a/tools/winscope/src/viewers/viewer_search/ui_data.ts b/tools/winscope/src/viewers/viewer_search/ui_data.ts
new file mode 100644
index 000000000..caace5016
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/ui_data.ts
@@ -0,0 +1,49 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {LogEntry, LogHeader} from 'viewers/common/ui_data_log';
+
+export class UiData {
+  currentSearches: SearchResult[] = [];
+  savedSearches: Search[] = [];
+  recentSearches: Search[] = [];
+  lastTraceFailed = false;
+  initialized = false;
+  searchViews: string[] = [];
+
+  static createEmpty() {
+    return new UiData();
+  }
+}
+
+export class SearchResult {
+  selectedIndex: undefined | number;
+  scrollToIndex: undefined | number;
+  currentIndex: undefined | number;
+
+  constructor(
+    readonly query: string,
+    readonly headers: LogHeader[],
+    readonly entries: LogEntry[],
+  ) {}
+}
+
+export class Search {
+  readonly timeMs: number;
+  constructor(readonly query: string, readonly name = query) {
+    this.timeMs = Date.now();
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_search/viewer_search.ts b/tools/winscope/src/viewers/viewer_search/viewer_search.ts
new file mode 100644
index 000000000..033d6dbfd
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/viewer_search.ts
@@ -0,0 +1,69 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Store} from 'common/store';
+import {WinscopeEvent} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
+import {TraceType} from 'trace/trace_type';
+import {QueryResult} from 'trace_processor/query_result';
+import {View, Viewer, ViewType} from 'viewers/viewer';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+import {ViewerSearchComponent} from './viewer_search_component';
+
+export class ViewerSearch implements Viewer {
+  static readonly DEPENDENCIES: TraceType[] = [TraceType.SEARCH];
+
+  private readonly htmlElement: HTMLElement;
+  private readonly presenter: Presenter;
+  private readonly traces: Traces;
+  private readonly view: View;
+
+  constructor(traces: Traces, storage: Store) {
+    this.htmlElement = document.createElement('viewer-search');
+    const notifyViewCallback = (data: UiData) => {
+      (this.htmlElement as unknown as ViewerSearchComponent).inputData = data;
+    };
+    this.presenter = new Presenter(traces, storage, notifyViewCallback);
+    this.presenter.addEventListeners(this.htmlElement);
+    this.traces = traces;
+    this.view = new View(
+      ViewType.GLOBAL_SEARCH,
+      this.getTraces(),
+      this.htmlElement,
+      TRACE_INFO[TraceType.SEARCH].name,
+    );
+  }
+
+  async onWinscopeEvent(event: WinscopeEvent) {
+    await this.presenter.onAppEvent(event);
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.presenter.setEmitEvent(callback);
+  }
+
+  getViews(): View[] {
+    return [this.view];
+  }
+
+  getTraces(): Array<Trace<QueryResult>> {
+    return this.traces.getTraces(TraceType.SEARCH);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_search/viewer_search_component.ts b/tools/winscope/src/viewers/viewer_search/viewer_search_component.ts
new file mode 100644
index 000000000..09aad378d
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/viewer_search_component.ts
@@ -0,0 +1,437 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {NgTemplateOutlet} from '@angular/common';
+import {Component, ElementRef, Inject, Input, ViewChild} from '@angular/core';
+import {FormControl, ValidationErrors, Validators} from '@angular/forms';
+import {assertDefined} from 'common/assert_utils';
+import {TimeDuration} from 'common/time_duration';
+import {TIME_UNIT_TO_NANO} from 'common/time_units';
+import {Analytics} from 'logging/analytics';
+import {TraceType} from 'trace/trace_type';
+import {CollapsibleSections} from 'viewers/common/collapsible_sections';
+import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
+import {
+  DeleteSavedQueryClickDetail,
+  QueryClickDetail,
+  SaveQueryClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {timeButtonStyle} from 'viewers/components/styles/clickable_property.styles';
+import {logComponentStyles} from 'viewers/components/styles/log_component.styles';
+import {
+  viewerCardInnerStyle,
+  viewerCardStyle,
+} from 'viewers/components/styles/viewer_card.styles';
+import {MenuOption} from './search_list_component';
+import {Search, UiData} from './ui_data';
+
+@Component({
+  selector: 'viewer-search',
+  template: `
+    <div class="card-grid" *ngIf="inputData">
+      <collapsed-sections
+        [class.empty]="sections.areAllSectionsExpanded()"
+        [sections]="sections"
+        (sectionChange)="sections.onCollapseStateChange($event, false)">
+      </collapsed-sections>
+
+      <div
+        class="global-search"
+        [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.GLOBAL_SEARCH)"
+        (click)="onGlobalSearchClick($event)">
+        <div class="title-section">
+          <collapsible-section-title
+            class="padded-title"
+            [title]="CollapsibleSectionType.GLOBAL_SEARCH"
+            (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.GLOBAL_SEARCH, true)"></collapsible-section-title>
+            <span class="mat-body-2 message-with-spinner" *ngIf="initializing">
+              <span>Initializing</span>
+              <mat-spinner [diameter]="20"></mat-spinner>
+            </span>
+        </div>
+
+          <mat-tab-group class="search-tabs">
+            <mat-tab label="Search">
+             <div class="body">
+                <span class="mat-body-2">
+                  {{globalSearchText}}
+                </span>
+
+                <mat-form-field appearance="outline" class="query-field padded-field">
+                  <textarea matInput [formControl]="searchQueryControl" (keydown)="onTextAreaKeydown($event)" [readonly]="runningQuery"></textarea>
+                  <mat-error *ngIf="searchQueryControl.invalid && searchQueryControl.value">Enter valid SQL query.</mat-error>
+                </mat-form-field>
+
+                <div class="query-actions">
+                  <div *ngIf="runningQuery" class="running-query-message">
+                    <mat-icon class="material-symbols-outlined"> timer </mat-icon>
+                    <span class="mat-body-2 message-with-spinner">
+                      <span>Calculating results </span>
+                      <mat-spinner [diameter]="20"></mat-spinner>
+                    </span>
+                  </div>
+                  <div *ngIf="lastQueryExecutionTime" class="query-execution-time">
+                    <span class="mat-body-1">
+                      Executed in {{lastQueryExecutionTime}}
+                    </span>
+                  </div>
+                  <button
+                    mat-flat-button
+                    class="query-button"
+                    color="primary"
+                    (click)="onSearchQueryClick()"
+                    [disabled]="searchQueryDisabled()"> Run Search Query </button>
+                </div>
+                <div class="current-search" *ngFor="let search of inputData.currentSearches">
+                  <span class="query">
+                    <span class="mat-body-2"> Current: </span>
+                    <span class="mat-body-1"> {{search.query}} </span>
+                  </span>
+                  <ng-container
+                    [ngTemplateOutlet]="saveQueryField"
+                    [ngTemplateOutletContext]="{search}"></ng-container>
+                </div>
+              </div>
+            </mat-tab>
+
+            <mat-tab label="Saved">
+              <search-list
+                class="body"
+                [searches]="inputData.savedSearches"
+                placeholderText="Saved queries will appear here."
+                [menuOptions]="savedSearchMenuOptions"></search-list>
+            </mat-tab>
+
+            <mat-tab label="Recent">
+              <search-list
+                class="body"
+                [searches]="inputData.recentSearches"
+                placeholderText="Recent queries will appear here."
+                [menuOptions]="recentSearchMenuOptions"></search-list>
+            </mat-tab>
+
+            <ng-template #saveQueryField let-search="search">
+              <div class="outline-field save-field">
+                <mat-form-field appearance="outline">
+                  <input matInput [formControl]="saveQueryNameControl" (keydown.enter)="onSaveQueryClick(search.query)"/>
+                  <mat-error *ngIf="saveQueryNameControl.invalid && saveQueryNameControl.value">Query with that name already exists.</mat-error>
+                </mat-form-field>
+                <button
+                  mat-flat-button
+                  class="query-button"
+                  color="primary"
+                  [disabled]="saveQueryNameControl.invalid"
+                  (click)="onSaveQueryClick(search.query)"> Save Query </button>
+              </div>
+            </ng-template>
+          </mat-tab-group>
+      </div>
+
+      <div
+        class="search-results"
+        [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.SEARCH_RESULTS)">
+        <div class="title-section">
+          <collapsible-section-title
+            class="padded-title"
+            [title]="CollapsibleSectionType.SEARCH_RESULTS"
+            (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.SEARCH_RESULTS, true)"></collapsible-section-title>
+        </div>
+        <div class="result" *ngFor="let search of inputData.currentSearches">
+          <div class="results-table">
+            <log-view
+              class="results-log-view"
+              [entries]="search.entries"
+              [headers]="search.headers"
+              [selectedIndex]="search.selectedIndex"
+              [scrollToIndex]="search.scrollToIndex"
+              [currentIndex]="search.currentIndex"
+              [traceType]="${TraceType.SEARCH}"
+              [showTraceEntryTimes]="false"
+              [showCurrentTimeButton]="false"></log-view>
+          </div>
+        </div>
+      </div>
+
+      <div
+        class="how-to-search"
+        [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.HOW_TO_SEARCH)">
+        <div class="title-section">
+        <collapsible-section-title
+          class="padded-title"
+          [title]="CollapsibleSectionType.HOW_TO_SEARCH"
+          (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.HOW_TO_SEARCH, true)"></collapsible-section-title>
+        </div>
+      </div>
+    </div>
+  `,
+  styles: [
+    `
+      .search-tabs {
+        height: 100%;
+      }
+      .global-search .body {
+        display: flex;
+        flex-direction: column;
+      }
+      .query-field {
+        height: fit-content;
+      }
+      .query-field textarea {
+        height: 300px;
+      }
+      .query-button {
+        width: fit-content;
+        line-height: 24px;
+        padding: 0 10px;
+      }
+      .end-align-button {
+        align-self: end;
+      }
+      .query-actions {
+        display: flex;
+        flex-direction: row;
+        justify-content: end;
+        column-gap: 10px;
+        align-items: center;
+      }
+      .running-query-message {
+        display: flex;
+        flex-direction: row;
+        align-items: center;
+        color: #FF8A00;
+      }
+      .current-search {
+        padding: 10px 0px;
+      }
+      .current-search .query {
+        display: flex;
+        flex-direction: column;
+      }
+      .message-with-spinner {
+        display: flex;
+        flex-direction: row;
+        align-items: center;
+        justify-content: space-between;
+      }
+
+      .result, .results-table {
+        height: 100%;
+        display: flex;
+        flex-direction: column;
+      }
+      .results-log-view {
+        display: flex;
+        flex-direction: column;
+        overflow: auto;
+        border-radius: 4px;
+        background-color: var(--background-color);
+        flex: 1;
+      }
+    `,
+    viewerCardStyle,
+    viewerCardInnerStyle,
+    logComponentStyles,
+    timeButtonStyle,
+  ],
+})
+export class ViewerSearchComponent {
+  @Input() inputData: UiData | undefined;
+  @ViewChild('saveQueryField') saveQueryField: NgTemplateOutlet | undefined;
+
+  CollapsibleSectionType = CollapsibleSectionType;
+  sections = new CollapsibleSections([
+    {
+      type: CollapsibleSectionType.GLOBAL_SEARCH,
+      label: CollapsibleSectionType.GLOBAL_SEARCH,
+      isCollapsed: false,
+    },
+    {
+      type: CollapsibleSectionType.SEARCH_RESULTS,
+      label: CollapsibleSectionType.SEARCH_RESULTS,
+      isCollapsed: false,
+    },
+    {
+      type: CollapsibleSectionType.HOW_TO_SEARCH,
+      label: CollapsibleSectionType.HOW_TO_SEARCH,
+      isCollapsed: false,
+    },
+  ]);
+  searchQueryControl = new FormControl('', Validators.required);
+  saveQueryNameControl = new FormControl(
+    '',
+    assertDefined(
+      Validators.compose([
+        Validators.required,
+        (control: FormControl) =>
+          this.validateSearchQuerySaveName(
+            control,
+            this.inputData?.savedSearches ?? [],
+          ),
+      ]),
+    ),
+  );
+  runningQuery: string | undefined;
+  lastQueryExecutionTime: string | undefined;
+  lastQueryStartTime: number | undefined;
+  initializing = false;
+  readonly savedSearchMenuOptions: MenuOption[] = [
+    {
+      name: 'Run Query',
+      onClickCallback: (search: Search) => {
+        Analytics.TraceSearch.logQueryRequested('saved');
+        this.onRunQueryFromOptionsClick(search);
+      },
+    },
+    {
+      name: 'Delete Query',
+      onClickCallback: (search: Search) => this.onDeleteQueryClick(search),
+    },
+  ];
+  readonly recentSearchMenuOptions: MenuOption[] = [
+    {
+      name: 'Run Query',
+      onClickCallback: (search: Search) => {
+        Analytics.TraceSearch.logQueryRequested('recent');
+        this.onRunQueryFromOptionsClick(search);
+      },
+    },
+    {name: 'Save Query', onClickCallback: (search: Search) => {}},
+  ];
+
+  readonly globalSearchText = `
+     Write an SQL query in the field below, and run the search. \
+     Results will be shown in a tabular view and you can optionally visualize them in the timeline. \
+  `;
+
+  constructor(
+    @Inject(ElementRef) private elementRef: ElementRef<HTMLElement>,
+  ) {}
+
+  ngAfterViewInit() {
+    this.recentSearchMenuOptions[1].innerMenu = this.saveQueryField;
+  }
+
+  ngOnChanges() {
+    if (this.initializing && this.inputData?.initialized) {
+      this.initializing = false;
+    }
+    const runningQueryComplete = this.inputData?.currentSearches.some(
+      (search) => search.query === this.runningQuery,
+    );
+    if (
+      this.runningQuery &&
+      (runningQueryComplete || this.inputData?.lastTraceFailed)
+    ) {
+      if (runningQueryComplete) {
+        this.searchQueryControl.setValue(this.runningQuery);
+        this.saveQueryNameControl.setValue(this.runningQuery);
+      }
+      const executionTimeMs =
+        Date.now() - assertDefined(this.lastQueryStartTime);
+      Analytics.TraceSearch.logQueryExecutionTime(executionTimeMs);
+      this.lastQueryExecutionTime = new TimeDuration(
+        BigInt(executionTimeMs * TIME_UNIT_TO_NANO.ms),
+      ).format();
+      this.lastQueryStartTime = undefined;
+      this.runningQuery = undefined;
+    }
+  }
+
+  onGlobalSearchClick() {
+    if (!this.initializing && !this.inputData?.initialized) {
+      this.initializing = true;
+      const event = new CustomEvent(ViewerEvents.GlobalSearchSectionClick);
+      this.elementRef.nativeElement.dispatchEvent(event);
+    }
+  }
+
+  onSearchQueryClick() {
+    this.runningQuery = assertDefined(this.searchQueryControl.value);
+    Analytics.TraceSearch.logQueryRequested('new');
+    this.dispatchSearchQueryEvent();
+  }
+
+  onSaveQueryClick(query: string) {
+    if (this.saveQueryNameControl.invalid) {
+      return;
+    }
+    const event = new CustomEvent(ViewerEvents.SaveQueryClick, {
+      detail: new SaveQueryClickDetail(
+        query,
+        assertDefined(this.saveQueryNameControl.value),
+      ),
+    });
+    this.elementRef.nativeElement.dispatchEvent(event);
+    Analytics.TraceSearch.logQuerySaved();
+    this.saveQueryNameControl.reset();
+  }
+
+  onRunQueryFromOptionsClick(search: Search) {
+    this.runningQuery = search.query;
+    this.dispatchSearchQueryEvent();
+  }
+
+  onDeleteQueryClick(search: Search) {
+    const event = new CustomEvent(ViewerEvents.DeleteSavedQueryClick, {
+      detail: new DeleteSavedQueryClickDetail(search),
+    });
+    this.elementRef.nativeElement.dispatchEvent(event);
+  }
+
+  searchQueryDisabled(): boolean {
+    return (
+      this.searchQueryControl.invalid ||
+      !!this.runningQuery ||
+      !this.inputData?.initialized
+    );
+  }
+
+  currentSearchPresent(): boolean {
+    return (this.inputData?.currentSearches.length ?? 0) > 0;
+  }
+
+  onTextAreaKeydown(event: KeyboardEvent) {
+    event.stopPropagation();
+    if (
+      event.key === 'Enter' &&
+      !event.shiftKey &&
+      !this.searchQueryDisabled()
+    ) {
+      event.preventDefault();
+      this.onSearchQueryClick();
+    }
+  }
+
+  private validateSearchQuerySaveName(
+    control: FormControl,
+    savedSearches: Search[],
+  ): ValidationErrors | null {
+    const valid =
+      control.value &&
+      !savedSearches.some((search) => search.name === control.value);
+    return !valid ? {invalidInput: control.value} : null;
+  }
+
+  private dispatchSearchQueryEvent() {
+    this.lastQueryExecutionTime = undefined;
+    this.lastQueryStartTime = Date.now();
+    const event = new CustomEvent(ViewerEvents.SearchQueryClick, {
+      detail: new QueryClickDetail(assertDefined(this.runningQuery)),
+    });
+    this.elementRef.nativeElement.dispatchEvent(event);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_search/viewer_search_component_test.ts b/tools/winscope/src/viewers/viewer_search/viewer_search_component_test.ts
new file mode 100644
index 000000000..73bea4ec6
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_search/viewer_search_component_test.ts
@@ -0,0 +1,357 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {CdkMenuModule} from '@angular/cdk/menu';
+import {ScrollingModule} from '@angular/cdk/scrolling';
+import {Component, ViewChild} from '@angular/core';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {FormsModule, ReactiveFormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
+import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
+import {MatProgressSpinnerModule} from '@angular/material/progress-spinner';
+import {MatTabsModule} from '@angular/material/tabs';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {UnitTestUtils} from 'test/unit/utils';
+import {
+  DeleteSavedQueryClickDetail,
+  QueryClickDetail,
+  SaveQueryClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
+import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {LogComponent} from 'viewers/components/log_component';
+import {SearchListComponent} from './search_list_component';
+import {Search, SearchResult, UiData} from './ui_data';
+import {ViewerSearchComponent} from './viewer_search_component';
+
+describe('ViewerSearchComponent', () => {
+  const testQuery = 'select * from table';
+  let fixture: ComponentFixture<TestHostComponent>;
+  let component: TestHostComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      declarations: [
+        TestHostComponent,
+        ViewerSearchComponent,
+        CollapsedSectionsComponent,
+        CollapsibleSectionTitleComponent,
+        SearchListComponent,
+        LogComponent,
+      ],
+      imports: [
+        MatFormFieldModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        FormsModule,
+        ReactiveFormsModule,
+        MatButtonModule,
+        MatIconModule,
+        MatTabsModule,
+        CdkMenuModule,
+        MatProgressSpinnerModule,
+        ScrollingModule,
+        MatTooltipModule,
+      ],
+    }).compileComponents();
+    fixture = TestBed.createComponent(TestHostComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    component.inputData.initialized = true;
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('creates global search section with tabs', () => {
+    const globalSearch = assertDefined(
+      htmlElement.querySelector('.global-search'),
+    );
+    const searchTabs =
+      globalSearch.querySelectorAll<HTMLElement>('.mat-tab-label');
+    const [searchTab, savedTab, recentTab] = Array.from(searchTabs);
+    expect(searchTab.textContent).toEqual('Search');
+    expect(savedTab.textContent).toEqual('Saved');
+    expect(recentTab.textContent).toEqual('Recent');
+  });
+
+  it('creates collapsed sections with no buttons', () => {
+    UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
+  });
+
+  it('handles search box section collapse/expand', () => {
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.global-search',
+      'GLOBAL SEARCH',
+    );
+  });
+
+  it('handles tabulated results section collapse/expand', () => {
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.search-results',
+      'SEARCH RESULTS',
+    );
+  });
+
+  it('handles documentation groups section collapse/expand', () => {
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.how-to-search',
+      'HOW TO SEARCH',
+    );
+  });
+
+  it('handles search via search query click', () => {
+    runSearchAndCheckHandled(runSearchByQueryButton);
+  });
+
+  it('handles search via run query from options click', () => {
+    const runSearch = () => {
+      component.searchComponent?.onRunQueryFromOptionsClick(
+        new Search(testQuery),
+      );
+      fixture.detectChanges();
+    };
+    runSearchAndCheckHandled(runSearch);
+  });
+
+  it('handles running query complete', () => {
+    runSearchByQueryButton();
+    component.inputData.currentSearches.push(
+      new SearchResult(testQuery, [], []),
+    );
+    component.inputData = Object.assign({}, component.inputData);
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.running-query-message')).toBeNull();
+    expect(htmlElement.querySelector('.query-execution-time')).toBeTruthy();
+    expect(htmlElement.querySelector('log-view')).toBeTruthy();
+    expect(getSearchQueryButton().disabled).toBeFalse();
+  });
+
+  it('handles running query failure', () => {
+    runSearchByQueryButton();
+    component.inputData.lastTraceFailed = true;
+    component.inputData = Object.assign({}, component.inputData);
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.running-query-message')).toBeNull();
+    expect(htmlElement.querySelector('log-view')).toBeNull();
+    expect(getSearchQueryButton().disabled).toBeFalse();
+  });
+
+  it('handles search via enter key', () => {
+    const runSearch = () => {
+      const textInput = getTextInput();
+      changeInput(textInput, testQuery);
+      pressEnter(textInput);
+    };
+    runSearchAndCheckHandled(runSearch);
+  });
+
+  it('does not handle search on enter key + shift key', () => {
+    let query: string | undefined;
+    htmlElement
+      .querySelector('viewer-search')
+      ?.addEventListener(ViewerEvents.SearchQueryClick, (event) => {
+        const detail: QueryClickDetail = (event as CustomEvent).detail;
+        query = detail.query;
+      });
+    const textInput = getTextInput();
+    changeInput(textInput, testQuery);
+    pressEnter(textInput, true);
+    expect(query).toBeUndefined();
+  });
+
+  it('emits event on save query click', () => {
+    let detail: SaveQueryClickDetail | undefined;
+    htmlElement
+      .querySelector('viewer-search')
+      ?.addEventListener(ViewerEvents.SaveQueryClick, (event) => {
+        detail = (event as CustomEvent).detail;
+      });
+    const testName = 'Query 1';
+    component.inputData.savedSearches.push(new Search(testQuery, testName));
+    fixture.detectChanges();
+    component.inputData.currentSearches.push(
+      new SearchResult(testQuery, [], []),
+    );
+    fixture.detectChanges();
+
+    const saveField = assertDefined(
+      htmlElement.querySelector('.current-search .save-field'),
+    );
+    const saveQueryButton = assertDefined(
+      saveField.querySelector<HTMLElement>('.query-button'),
+    );
+    const input = assertDefined(
+      saveField.querySelector<HTMLInputElement>('input'),
+    );
+    changeInput(input, testName);
+    pressEnter(input);
+    saveQueryButton.click();
+    fixture.detectChanges();
+    expect(detail).toBeUndefined(); // name already exists
+
+    const testName2 = 'Query 2';
+    changeInput(input, testName2);
+    pressEnter(input); // save by enter key
+    expect(detail).toEqual(new SaveQueryClickDetail(testQuery, testName2));
+
+    const testName3 = 'Query 3';
+    changeInput(input, testName3);
+    saveQueryButton.click();
+    fixture.detectChanges(); // save by click
+    expect(detail).toEqual(new SaveQueryClickDetail(testQuery, testName3));
+  });
+
+  it('emits event on delete query click', () => {
+    let detail: DeleteSavedQueryClickDetail | undefined;
+    htmlElement
+      .querySelector('viewer-search')
+      ?.addEventListener(ViewerEvents.DeleteSavedQueryClick, (event) => {
+        detail = (event as CustomEvent).detail;
+      });
+    const search = new Search('');
+    component.searchComponent?.onDeleteQueryClick(search);
+    expect(detail).toEqual(new DeleteSavedQueryClickDetail(search));
+  });
+
+  it('handles trace search initialization', () => {
+    component.inputData.initialized = false;
+    fixture.detectChanges();
+    const spy = jasmine.createSpy();
+    htmlElement
+      .querySelector('viewer-search')
+      ?.addEventListener(ViewerEvents.GlobalSearchSectionClick, (event) =>
+        spy(),
+      );
+    const globalSearch = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.global-search'),
+    );
+    expect(globalSearch.querySelector('.message-with-spinner')).toBeNull();
+
+    clickGlobalSearchAndCheckMessage(globalSearch);
+    clickGlobalSearchAndCheckMessage(globalSearch);
+    expect(spy).toHaveBeenCalledTimes(1);
+
+    changeInput(getTextInput(), testQuery);
+    expect(getSearchQueryButton().disabled).toBeTrue();
+
+    component.inputData.initialized = true;
+    component.inputData = Object.assign({}, component.inputData);
+    fixture.detectChanges();
+    expect(globalSearch.querySelector('.message-with-spinner')).toBeNull();
+    expect(getSearchQueryButton().disabled).toBeFalse();
+  });
+
+  function clickGlobalSearchAndCheckMessage(globalSearch: HTMLElement) {
+    globalSearch.click();
+    fixture.detectChanges();
+    expect(globalSearch.querySelector('.message-with-spinner')).toBeTruthy();
+    expect(getSearchQueryButton().disabled).toBeTrue();
+  }
+
+  function getTextInput(): HTMLTextAreaElement {
+    return assertDefined(
+      htmlElement.querySelector<HTMLTextAreaElement>('.query-field textarea'),
+    );
+  }
+
+  function changeInput(
+    input: HTMLInputElement | HTMLTextAreaElement,
+    query: string,
+  ) {
+    input.value = query;
+    input.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+  }
+
+  function getSearchQueryButton(): HTMLButtonElement {
+    return assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>(
+        '.query-actions .query-button',
+      ),
+    );
+  }
+
+  function clickSearchQueryButton() {
+    getSearchQueryButton().click();
+    fixture.detectChanges();
+  }
+
+  function runSearchByQueryButton() {
+    changeInput(getTextInput(), testQuery);
+    clickSearchQueryButton();
+  }
+
+  function runSearchAndCheckHandled(runSearch: () => void) {
+    let query: string | undefined;
+    htmlElement
+      .querySelector('viewer-search')
+      ?.addEventListener(ViewerEvents.SearchQueryClick, (event) => {
+        const detail: QueryClickDetail = (event as CustomEvent).detail;
+        query = detail.query;
+      });
+    runSearch();
+    expect(query).toEqual(testQuery);
+    checkSearchQueryHandled();
+  }
+
+  function pressEnter(
+    input: HTMLInputElement | HTMLTextAreaElement,
+    shiftKey = false,
+  ) {
+    input.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter', shiftKey}));
+    fixture.detectChanges();
+  }
+
+  function checkSearchQueryHandled() {
+    expect(getSearchQueryButton().disabled).toBeTrue();
+    const runningQueryMessage = assertDefined(
+      htmlElement.querySelector('.running-query-message'),
+    );
+    expect(runningQueryMessage.textContent?.trim()).toEqual(
+      'timer Calculating results',
+    );
+    expect(runningQueryMessage.querySelector('mat-spinner')).toBeTruthy();
+  }
+
+  @Component({
+    selector: 'host-component',
+    template: `
+      <viewer-search [inputData]="inputData"></viewer-search>
+    `,
+  })
+  class TestHostComponent {
+    @ViewChild(ViewerSearchComponent) searchComponent:
+      | ViewerSearchComponent
+      | undefined;
+
+    inputData = UiData.createEmpty();
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_stub.ts b/tools/winscope/src/viewers/viewer_stub.ts
index b5ee3f34b..314e446e6 100644
--- a/tools/winscope/src/viewers/viewer_stub.ts
+++ b/tools/winscope/src/viewers/viewer_stub.ts
@@ -17,13 +17,11 @@
 import {FunctionUtils} from 'common/function_utils';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
-import {TraceBuilder} from 'test/unit/trace_builder';
 import {Trace} from 'trace/trace';
-import {TraceType} from 'trace/trace_type';
 import {View, Viewer, ViewType} from './viewer';
 
 class ViewerStub implements Viewer {
-  private readonly trace: Trace<object>;
+  private readonly traces: Array<Trace<object>> = [];
   private htmlElement: HTMLElement;
   private title: string;
   private view: View;
@@ -43,13 +41,10 @@ class ViewerStub implements Viewer {
     } else {
       this.htmlElement = undefined as unknown as HTMLElement;
     }
-
-    this.trace =
-      trace ??
-      new TraceBuilder<object>().setType(TraceType.WINDOW_MANAGER).build();
+    if (trace) this.traces = [trace];
 
     this.view = new View(
-      viewType ?? ViewType.TAB,
+      viewType ?? ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       this.title,
@@ -73,7 +68,7 @@ class ViewerStub implements Viewer {
   }
 
   getTraces(): Array<Trace<object>> {
-    return [this.trace];
+    return this.traces;
   }
 }
 
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts b/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
index f488825b4..76a11b648 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
@@ -20,8 +20,6 @@ import {Store} from 'common/store';
 import {
   TabbedViewSwitchRequest,
   TracePositionUpdate,
-  WinscopeEvent,
-  WinscopeEventType,
 } from 'messaging/winscope_event';
 import {LayerFlag} from 'parsers/surface_flinger/layer_flag';
 import {CustomQueryType} from 'trace/custom_query';
@@ -89,11 +87,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'SfHierarchyFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
     true,
     false,
@@ -134,29 +128,22 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
         showDefaults: {
           name: 'Show defaults',
           enabled: false,
-          tooltip: `
-              If checked, shows the value of all properties.
-              Otherwise, hides all properties whose value is
-              the default for its data type.
-            `,
+          tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
         },
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'SfPropertiesFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
     undefined,
     ['a', 'type'],
   );
   protected override multiTraceType = undefined;
 
-  private viewCapturePackageNames: string[] = [];
+  private viewCapturePackageNames: string[] | undefined;
   private curatedProperties: SfCuratedProperties | undefined;
-  private displayPropertyGroups = false;
   private wmTrace: Trace<HierarchyTreeNode> | undefined;
   private wmFocusedDisplayId: number | undefined;
 
@@ -171,40 +158,19 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
   }
 
   async onRectDoubleClick(rectId: string) {
+    if (!this.viewCapturePackageNames) {
+      return;
+    }
     const rectHasViewCapture = this.viewCapturePackageNames.some(
       (packageName) => rectId.includes(packageName),
     );
     if (!rectHasViewCapture) {
       return;
     }
-    const newActiveTrace = this.traces.getTrace(TraceType.VIEW_CAPTURE);
-    if (!newActiveTrace) {
-      return;
-    }
-    await this.emitWinscopeEvent(new TabbedViewSwitchRequest(newActiveTrace));
-  }
-
-  override async onAppEvent(event: WinscopeEvent) {
-    await this.handleCommonWinscopeEvents(event);
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.initializeIfNeeded();
-        await this.setInitialWmActiveDisplay(event);
-        await this.applyTracePositionUpdate(event);
-        this.updateCuratedProperties();
-        this.refreshUIData();
-      },
-    );
-    await event.visit(
-      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
-      async (event) => {
-        const filterPresetName = event.name;
-        await this.applyPresetConfig(filterPresetName);
-        this.updateCuratedProperties();
-        this.refreshUIData();
-      },
+    const newActiveTrace = assertDefined(
+      this.traces.getTrace(TraceType.VIEW_CAPTURE),
     );
+    await this.emitWinscopeEvent(new TabbedViewSwitchRequest(newActiveTrace));
   }
 
   override async onHighlightedNodeChange(item: UiHierarchyTreeNode) {
@@ -231,15 +197,27 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     return tree.isRoot();
   }
 
-  private async initializeIfNeeded() {
-    const tracesVc = this.traces.getTraces(TraceType.VIEW_CAPTURE);
-    const promisesPackageName = tracesVc.map(async (trace) => {
-      const packageAndWindow = await trace.customQuery(
-        CustomQueryType.VIEW_CAPTURE_METADATA,
-      );
-      return packageAndWindow.packageName;
-    });
-    this.viewCapturePackageNames = await Promise.all(promisesPackageName);
+  protected override async initializeIfNeeded(event: TracePositionUpdate) {
+    if (!this.viewCapturePackageNames) {
+      const tracesVc = this.traces.getTraces(TraceType.VIEW_CAPTURE);
+      const promisesPackageName = tracesVc.map(async (trace) => {
+        const packageAndWindow = await trace.customQuery(
+          CustomQueryType.VIEW_CAPTURE_METADATA,
+        );
+        return packageAndWindow.packageName;
+      });
+      this.viewCapturePackageNames = await Promise.all(promisesPackageName);
+    }
+    await this.setInitialWmActiveDisplay(event);
+  }
+
+  protected override async processDataAfterPositionUpdate(): Promise<void> {
+    this.updateCuratedProperties();
+  }
+
+  protected override refreshUIData() {
+    this.uiData.curatedProperties = this.curatedProperties;
+    this.refreshHierarchyViewerUiData();
   }
 
   private updateCuratedProperties() {
@@ -249,17 +227,14 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     if (selectedHierarchyTree && propertiesTree) {
       if (selectedHierarchyTree[1].isRoot()) {
         this.curatedProperties = undefined;
-        this.displayPropertyGroups = false;
       } else {
         this.curatedProperties = this.getCuratedProperties(
           selectedHierarchyTree[1],
           propertiesTree,
         );
-        this.displayPropertyGroups = true;
       }
     } else {
       this.curatedProperties = undefined;
-      this.displayPropertyGroups = false;
     }
   }
 
@@ -299,7 +274,9 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       zOrderRelativeOfNode.setFormatter(
         new FixedStringFormatter(assertDefined(hTree.getZParent()).id),
       );
-      relativeParent = this.getLayerSummary(zOrderRelativeOfNode);
+      relativeParent = this.getLayerSummary(
+        zOrderRelativeOfNode.formattedValue(),
+      );
     }
 
     const curated: SfCuratedProperties = {
@@ -324,11 +301,9 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       ).formattedValue(),
       z: assertDefined(pTree.getChildByName('z')).formattedValue(),
       relativeParent,
-      relativeChildren:
-        pTree
-          .getChildByName('relZChildren')
-          ?.getAllChildren()
-          .map((c) => this.getLayerSummary(c)) ?? [],
+      relativeChildren: hTree
+        .getRelativeChildren()
+        .map((c) => this.getLayerSummary(c.id)),
       calcColor: this.getColorPropertyValue(pTree, 'color'),
       calcShadowRadius: this.getPixelPropertyValue(pTree, 'shadowRadius'),
       calcCornerRadius: this.getPixelPropertyValue(pTree, 'cornerRadius'),
@@ -385,7 +360,9 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     if (occludedBy && occludedBy.length > 0) {
       summary.push({
         key: 'Occluded by',
-        layerValues: occludedBy.map((layer) => this.getLayerSummary(layer)),
+        layerValues: occludedBy.map((layer) =>
+          this.getLayerSummary(layer.formattedValue()),
+        ),
         desc: 'Fully occluded by these opaque layers',
       });
     }
@@ -397,7 +374,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       summary.push({
         key: 'Partially occluded by',
         layerValues: partiallyOccludedBy.map((layer) =>
-          this.getLayerSummary(layer),
+          this.getLayerSummary(layer.formattedValue()),
         ),
         desc: 'Partially occluded by these opaque layers',
       });
@@ -407,7 +384,9 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     if (coveredBy && coveredBy.length > 0) {
       summary.push({
         key: 'Covered by',
-        layerValues: coveredBy.map((layer) => this.getLayerSummary(layer)),
+        layerValues: coveredBy.map((layer) =>
+          this.getLayerSummary(layer.formattedValue()),
+        ),
         desc: 'Partially or fully covered by these likely translucent layers',
       });
     }
@@ -418,8 +397,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     return nodes.map((reason) => reason.formattedValue()).join(', ');
   }
 
-  private getLayerSummary(layer: PropertyTreeNode): SfLayerSummary {
-    const nodeId = layer.formattedValue();
+  private getLayerSummary(nodeId: string): SfLayerSummary {
     const parts = nodeId.split(' ');
     return {
       layerId: parts[0],
@@ -458,12 +436,6 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
         ?.getValue();
     }
   }
-
-  private refreshUIData() {
-    this.uiData.curatedProperties = this.curatedProperties;
-    this.uiData.displayPropertyGroups = this.displayPropertyGroups;
-    this.refreshHierarchyViewerUiData();
-  }
 }
 
 export function makeDisplayIdentifiers(
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts b/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
index 43c723fe4..a6edaa1bc 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
@@ -15,10 +15,12 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {Store} from 'common/store';
-import {TracePositionUpdate} from 'messaging/winscope_event';
+import {
+  TabbedViewSwitchRequest,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
@@ -31,12 +33,11 @@ import {EMPTY_OBJ_STRING} from 'trace/tree_node/formatters';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
-import {DiffType} from 'viewers/common/diff_type';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
 import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
-import {UserOptions} from 'viewers/common/user_options';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
@@ -48,31 +49,61 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
   private selectedTree: UiHierarchyTreeNode | undefined;
   private selectedTreeAfterPositionUpdate: UiHierarchyTreeNode | undefined;
 
-  override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = true;
-  override readonly shouldExecuteShowDiffTests = true;
-  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = true;
+  override readonly keepCalculatedPropertiesInChild = false;
+  override readonly keepCalculatedPropertiesInRoot = true;
+  override readonly expectedHierarchyOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+    simplifyNames: {
+      name: 'Simplify names',
+      enabled: true,
+    },
+    flat: {
+      name: 'Flat',
+      enabled: false,
+    },
+  };
+  override readonly expectedPropertiesOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showDefaults: {
+      name: 'Show defaults',
+      enabled: false,
+      tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
+    },
+  };
+  override readonly expectedRectsOpts = {
+    ignoreRectShowState: {
+      name: 'Ignore',
+      icon: 'visibility',
+      enabled: false,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+  };
 
-  override readonly numberOfDefaultProperties = 32;
-  override readonly numberOfNonDefaultProperties = 24;
-  override readonly expectedFirstRect = new Rect(0, 0, 1080, 2400);
-  override readonly propertiesFilter = new TextFilter('bound', []);
-  override readonly expectedTotalRects = 11;
-  override readonly expectedVisibleRects = 6;
   override readonly treeNodeLongName =
     'ActivityRecord{64953af u0 com.google.android.apps.nexuslauncher/.NexusLauncherActivity#96';
   override readonly treeNodeShortName =
     'ActivityRecord{64953af u0 com.google.(...).NexusLauncherActivity#96';
-  override readonly numberOfFilteredProperties = 3;
-  override readonly hierarchyFilter = new TextFilter('Wallpaper', []);
-  override readonly expectedHierarchyChildrenAfterStringFilter = 4;
-  override readonly propertyWithDiff = 'bounds';
-  override readonly expectedPropertyDiffType = DiffType.ADDED;
-
-  private readonly numberOfFlattenedChildren = 94;
-  private readonly numberOfVisibleChildren = 6;
-  private readonly numberOfNestedChildren = 3;
 
   override async setUpTestEnvironment(): Promise<void> {
     this.traceSf = new TraceBuilder<HierarchyTreeNode>()
@@ -89,6 +120,9 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
           'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
           6,
         ),
+        await UnitTestUtils.getTraceEntry<HierarchyTreeNode>(
+          'traces/elapsed_and_real_timestamp/SurfaceFlinger_with_duplicated_ids.pb',
+        ),
       ])
       .build();
 
@@ -117,13 +151,16 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
         'Surface(name=b48baf1 InputMethod)/@0x3a7bd57 - animation-leash of insets_animation#163',
       ),
     );
-    this.selectedTreeAfterPositionUpdate = UiHierarchyTreeNode.from(
+    const treeAfterPosiionUpdateParent = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(
-          UiTreeUtils.makeIdMatchFilter('79 Wallpaper BBQ wrapper#79'),
-        ),
+        firstEntryDataTree
+          .findDfs(UiTreeUtils.makeIdMatchFilter('79 Wallpaper BBQ wrapper#79'))
+          ?.getZParent(),
       ),
     );
+    this.selectedTreeAfterPositionUpdate = assertDefined(
+      treeAfterPosiionUpdateParent.getChildByName('Wallpaper BBQ wrapper#79'),
+    );
     const rect = assertDefined(
       this.selectedTreeAfterPositionUpdate.getRects()?.at(0),
     );
@@ -133,23 +170,7 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
   override createPresenterWithEmptyTrace(
     callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(TraceType.SURFACE_FLINGER)
-      .setEntries([])
-      .build();
-    const traces = new Traces();
-    traces.addTrace(trace);
-    return new Presenter(trace, traces, new InMemoryStorage(), callback);
-  }
-
-  override createPresenterWithCorruptedTrace(
-    callback: NotifyHierarchyViewCallbackType<UiData>,
-  ): Presenter {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(TraceType.SURFACE_FLINGER)
-      .setEntries([assertDefined(this.selectedTree)])
-      .setIsCorrupted(true)
-      .build();
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.SURFACE_FLINGER);
     const traces = new Traces();
     traces.addTrace(trace);
     return new Presenter(trace, traces, new InMemoryStorage(), callback);
@@ -173,38 +194,6 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
     return assertDefined(this.secondPositionUpdate);
   }
 
-  override getShowDiffPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.positionUpdate);
-  }
-
-  override getExpectedChildrenBeforeVisibilityFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedChildrenAfterVisibilityFilter(): number {
-    return this.numberOfVisibleChildren;
-  }
-
-  override getExpectedChildrenBeforeFlatFilter(): number {
-    return this.numberOfNestedChildren;
-  }
-
-  override getExpectedChildrenAfterFlatFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedHierarchyChildrenBeforeStringFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override executeSpecializedChecksForPropertiesFromNode(
-    uiData: UiDataHierarchy,
-  ) {
-    expect(assertDefined((uiData as UiData).curatedProperties).flags).toEqual(
-      'HIDDEN (0x1)',
-    );
-  }
-
   override getSelectedTree(): UiHierarchyTreeNode {
     return assertDefined(this.selectedTree);
   }
@@ -213,9 +202,7 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
     return assertDefined(this.selectedTreeAfterPositionUpdate);
   }
 
-  override executeChecksForPropertiesTreeAfterPositionUpdate(
-    uiData: UiDataHierarchy,
-  ) {
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiDataHierarchy) {
     expect(
       assertDefined(
         uiData.propertiesTree
@@ -232,9 +219,12 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
         isActive: true,
       },
     ]);
+    expect(assertDefined((uiData as UiData).curatedProperties).flags).toEqual(
+      'ENABLE_BACKPRESSURE (0x100)',
+    );
   }
 
-  override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
+  override executePropertiesChecksAfterSecondPositionUpdate(
     uiData: UiDataHierarchy,
   ) {
     expect(
@@ -389,64 +379,45 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
       });
 
       it('updates view capture package names', async () => {
-        const traceVc = new TraceBuilder<HierarchyTreeNode>()
-          .setType(TraceType.VIEW_CAPTURE)
-          .setEntries([await UnitTestUtils.getViewCaptureEntry()])
-          .setParserCustomQueryResult(CustomQueryType.VIEW_CAPTURE_METADATA, {
-            packageName: 'com.google.android.apps.nexuslauncher',
-            windowName: 'not_used',
-          })
-          .build();
-        const traces = new Traces();
+        await createPresenterWithViewCapture(assertDefined(this.traceSf));
+        expect(
+          uiData.rectsToDraw.filter((rect) => rect.hasContent).length,
+        ).toEqual(2);
+      });
 
-        const traceSf = assertDefined(this.traceSf);
-        traces.addTrace(traceSf);
-        traces.addTrace(traceVc);
-        const notifyViewCallback = (newData: UiData) => {
-          uiData = newData;
-        };
-        const presenter = new Presenter(
-          traceSf,
-          traces,
-          new InMemoryStorage(),
-          notifyViewCallback as NotifyHierarchyViewCallbackType<UiData>,
+      it('handles rect double click if view capture trace present', async () => {
+        const [presenter, traceVc] = await createPresenterWithViewCapture(
+          assertDefined(this.traceSf),
         );
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
 
-        const firstEntry = traceSf.getEntry(0);
-        const positionUpdate = TracePositionUpdate.fromTraceEntry(firstEntry);
+        await presenter.onRectDoubleClick('not in package');
+        expect(spy).not.toHaveBeenCalled();
+        await presenter.onRectDoubleClick(
+          'com.google.android.apps.nexuslauncher',
+        );
+        expect(spy).toHaveBeenCalledOnceWith(
+          new TabbedViewSwitchRequest(traceVc),
+        );
+      });
 
-        await presenter.onAppEvent(positionUpdate);
-        expect(
-          uiData.rectsToDraw.filter((rect) => rect.hasContent).length,
-        ).toEqual(2);
+      it('robust to rect double click if view capture trace not present', async () => {
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+        await presenter.onRectDoubleClick('not in package');
+        expect(spy).not.toHaveBeenCalled();
       });
 
       it('keeps alpha and transform type regardless of show/hide defaults', async () => {
-        const userOptions: UserOptions = {
-          showDiff: {
-            name: 'Show diff',
-            enabled: true,
-          },
-          showDefaults: {
-            name: 'Show defaults',
-            enabled: true,
-          },
-        };
-
         const treeForAlphaCheck = this.getSelectedTree();
         const treeForTransformCheck = this.getSelectedTreeAfterPositionUpdate();
-
         await presenter.onAppEvent(this.getPositionUpdate());
-        await checkColorAndTransformProperties(
-          treeForAlphaCheck,
-          treeForTransformCheck,
-        );
-
-        await presenter.onPropertiesUserOptionsChange(userOptions);
-        await checkColorAndTransformProperties(
-          treeForAlphaCheck,
-          treeForTransformCheck,
-        );
+        await checkColorAndTransform(treeForAlphaCheck, treeForTransformCheck);
+        await presenter.onPropertiesUserOptionsChange({
+          showDefaults: {name: '', enabled: true},
+        });
+        await checkColorAndTransform(treeForAlphaCheck, treeForTransformCheck);
       });
 
       it('clears curated properties on position update if no properties tree found', async () => {
@@ -475,13 +446,17 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
         const nodeWithRelZChild = assertDefined(
           assertDefined(uiData.hierarchyTrees)[0].findDfs(
             UiTreeUtils.makeNodeFilter(
-              '98 2c99222 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity#98',
+              new TextFilter(
+                '98 2c99222 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity#98',
+              ).getFilterPredicate(),
             ),
           ),
         );
         const nodeWithRelZParent = assertDefined(
           assertDefined(uiData.hierarchyTrees)[0].findDfs(
-            UiTreeUtils.makeNodeFilter('13 ImeContainer#13'),
+            UiTreeUtils.makeNodeFilter(
+              new TextFilter('13 ImeContainer#13').getFilterPredicate(),
+            ),
           ),
         );
 
@@ -504,7 +479,102 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
         expect(uiData.curatedProperties?.relativeChildren).toEqual([]);
       });
 
-      async function checkColorAndTransformProperties(
+      it('adds warnings to ui hierarchy tree node', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.hierarchyTrees?.at(0)?.getWarnings().length).toEqual(0);
+        const entry = assertDefined(this.traceSf?.getEntry(5));
+        await presenter.onAppEvent(TracePositionUpdate.fromTraceEntry(entry));
+        expect(uiData.hierarchyTrees?.at(0)?.getWarnings().length).toEqual(1);
+      });
+
+      it('sets properties tree but no curated properties for root node', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        await presenter.onHighlightedIdChange(
+          assertDefined(uiData.hierarchyTrees)[0].id,
+        );
+        expect(uiData.propertiesTree?.getDisplayName()).toEqual(
+          '1970-01-01, 00:00:00.000',
+        );
+        expect(uiData.curatedProperties).toBeUndefined();
+      });
+
+      it('formats summary, color, pixel and crop correctly in curated properties', async () => {
+        const tree = new HierarchyTreeBuilder()
+          .setId('LayerTraceEntry')
+          .setName('root')
+          .setChildren([
+            {
+              id: '1',
+              name: 'layer1',
+              properties: {
+                occludedBy: ['0 layer0'],
+                partiallyOccludedBy: ['2 layer2'],
+                flags: null,
+                zOrderRelativeOf: null,
+                bounds: null,
+                screenBounds: null,
+                activeBuffer: null,
+                currFrame: null,
+                destinationFrame: {left: 0, right: 1, top: 0, bottom: 1},
+                z: null,
+                color: {r: 0, g: 0, b: 0, a: 1},
+                shadowRadius: 1,
+                cornerRadius: null,
+                cornerRadiusCrop: null,
+                backgroundBlurRadius: null,
+                requestedColor: null,
+                requestedCornerRadius: null,
+              },
+            },
+          ])
+          .build();
+        const traces = new Traces();
+        const traceSf = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.SURFACE_FLINGER)
+          .setEntries([tree])
+          .build();
+        traces.addTrace(traceSf);
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        const presenter = new Presenter(
+          traceSf,
+          traces,
+          new InMemoryStorage(),
+          notifyViewCallback,
+        );
+        const positionUpdate = TracePositionUpdate.fromTraceEntry(
+          traceSf.getEntry(0),
+        );
+        await presenter.onAppEvent(positionUpdate);
+        await presenter.onHighlightedIdChange(
+          assertDefined(tree.getChildByName('layer1')).id,
+        );
+        expect(uiData.curatedProperties?.summary).toEqual([
+          {
+            key: 'Occluded by',
+            desc: 'Fully occluded by these opaque layers',
+            layerValues: [{layerId: '0', nodeId: '0 layer0', name: 'layer0'}],
+          },
+          {
+            key: 'Partially occluded by',
+            desc: 'Partially occluded by these opaque layers',
+            layerValues: [{layerId: '2', nodeId: '2 layer2', name: 'layer2'}],
+          },
+        ]);
+        expect(uiData.curatedProperties?.calcColor).toEqual(
+          '(0, 0, 0), alpha: 1',
+        );
+        expect(uiData.curatedProperties?.reqColor).toEqual('no color found');
+        expect(uiData.curatedProperties?.calcShadowRadius).toEqual('1 px');
+        expect(uiData.curatedProperties?.calcCornerRadius).toEqual('0 px');
+        expect(uiData.curatedProperties?.destinationFrame).toEqual(
+          '(0, 0) - (1, 1)',
+        );
+        expect(uiData.curatedProperties?.reqCrop).toEqual(EMPTY_OBJ_STRING);
+      });
+
+      async function checkColorAndTransform(
         treeForAlphaCheck: UiHierarchyTreeNode,
         treeForTransformCheck: UiHierarchyTreeNode,
       ) {
@@ -520,6 +590,38 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<U
             ?.formattedValue(),
         ).toEqual('IDENTITY');
       }
+
+      async function createPresenterWithViewCapture(
+        traceSf: Trace<HierarchyTreeNode>,
+      ): Promise<[Presenter, Trace<HierarchyTreeNode>]> {
+        const traceVc = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.VIEW_CAPTURE)
+          .setEntries([await UnitTestUtils.getViewCaptureEntry()])
+          .setParserCustomQueryResult(CustomQueryType.VIEW_CAPTURE_METADATA, {
+            packageName: 'com.google.android.apps.nexuslauncher',
+            windowName: 'not_used',
+          })
+          .build();
+        const traces = new Traces();
+
+        traces.addTrace(traceSf);
+        traces.addTrace(traceVc);
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        const presenter = new Presenter(
+          traceSf,
+          traces,
+          new InMemoryStorage(),
+          notifyViewCallback as NotifyHierarchyViewCallbackType<UiData>,
+        );
+
+        const firstEntry = traceSf.getEntry(0);
+        const positionUpdate = TracePositionUpdate.fromTraceEntry(firstEntry);
+
+        await presenter.onAppEvent(positionUpdate);
+        return [presenter, traceVc];
+      }
     });
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts b/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
index 6e093cc22..3575b684c 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
@@ -32,8 +32,8 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
-  hierarchyFilter = new TextFilter('', []);
-  propertiesFilter = new TextFilter('', []);
+  hierarchyFilter = new TextFilter();
+  propertiesFilter = new TextFilter();
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
@@ -44,6 +44,5 @@ export class UiData implements UiDataHierarchy {
 
   constructor(
     public curatedProperties: SfCuratedProperties | undefined = undefined,
-    public displayPropertyGroups = true,
   ) {}
 }
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
index 1d3eee63e..d6a0a08d1 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
@@ -56,7 +56,7 @@ export class ViewerSurfaceFlinger implements Viewer {
     );
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.SURFACE_FLINGER].name,
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
index bec5f631e..7c9f30927 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
@@ -79,7 +79,6 @@ import {UiData} from './ui_data';
           [highlightedProperty]="inputData?.highlightedProperty ?? ''"
           [traceType]="${TraceType.SURFACE_FLINGER}"
           [store]="store"
-          [displayPropertyGroups]="inputData?.displayPropertyGroups"
           [isProtoDump]="true"
           placeholderText="No selected entry or layer."
           [textFilter]="inputData?.propertiesFilter"
diff --git a/tools/winscope/src/viewers/viewer_transactions/presenter.ts b/tools/winscope/src/viewers/viewer_transactions/presenter.ts
index c9da60ab0..a2e243064 100644
--- a/tools/winscope/src/viewers/viewer_transactions/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/presenter.ts
@@ -23,25 +23,31 @@ import {
   AbstractLogViewerPresenter,
   NotifyLogViewCallbackType,
 } from 'viewers/common/abstract_log_viewer_presenter';
+import {LogSelectFilter} from 'viewers/common/log_filters';
 import {LogPresenter} from 'viewers/common/log_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
-import {LogField, LogFieldType, LogFilter} from 'viewers/common/ui_data_log';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogField, LogHeader} from 'viewers/common/ui_data_log';
 import {UserOptions} from 'viewers/common/user_options';
 import {SetRootDisplayNames} from './operations/set_root_display_name';
 import {TransactionsEntry, TransactionsEntryType, UiData} from './ui_data';
 
-export class Presenter extends AbstractLogViewerPresenter<UiData> {
-  private static readonly FIELD_TYPES = [
-    LogFieldType.TRANSACTION_ID,
-    LogFieldType.VSYNC_ID,
-    LogFieldType.PID,
-    LogFieldType.UID,
-    LogFieldType.TRANSACTION_TYPE,
-    LogFieldType.LAYER_OR_DISPLAY_ID,
-    LogFieldType.FLAGS,
-  ];
-  private static readonly VALUE_NA = 'N/A';
-  private isInitialized = false;
+export class Presenter extends AbstractLogViewerPresenter<
+  UiData,
+  PropertyTreeNode
+> {
+  private static readonly COLUMNS = {
+    id: {name: 'TX ID', cssClass: 'transaction-id right-align'},
+    vsyncId: {name: 'VSYNC ID', cssClass: 'vsyncid right-align'},
+    pid: {name: 'PID', cssClass: 'pid right-align'},
+    uid: {name: 'UID', cssClass: 'uid right-align'},
+    type: {name: 'TYPE', cssClass: 'transaction-type'},
+    layerOrDisplayId: {
+      name: 'LAYER/DISP ID',
+      cssClass: 'layer-or-display-id right-align',
+    },
+    flags: {name: 'Flags', cssClass: 'flags'},
+  };
 
   protected override keepCalculated = true;
   protected override logPresenter = new LogPresenter<TransactionsEntry>();
@@ -61,7 +67,7 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
       },
       this.storage,
     ),
-    undefined,
+    new TextFilter(),
     [],
     [new SetRootDisplayNames()],
   );
@@ -74,49 +80,59 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     super(trace, notifyViewCallback, UiData.createEmpty());
   }
 
-  protected override async initializeIfNeeded() {
-    if (this.isInitialized) {
-      return;
-    }
-
-    const allEntries = await this.makeUiDataEntries();
-    const filters: LogFilter[] = [];
+  protected override makeHeaders(): LogHeader[] {
+    return [
+      new LogHeader(
+        Presenter.COLUMNS.id,
+        new LogSelectFilter([], false, '125'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.vsyncId,
+        new LogSelectFilter([], false, '90'),
+      ),
+      new LogHeader(Presenter.COLUMNS.pid, new LogSelectFilter([])),
+      new LogHeader(Presenter.COLUMNS.uid, new LogSelectFilter([])),
+      new LogHeader(
+        Presenter.COLUMNS.type,
+        new LogSelectFilter([], false, '175'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.layerOrDisplayId,
+        new LogSelectFilter([]),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.flags,
+        new LogSelectFilter([], true, '250', '100%'),
+      ),
+    ];
+  }
 
-    for (const type of Presenter.FIELD_TYPES) {
-      if (type === LogFieldType.FLAGS) {
-        filters.push({
-          type,
-          options: this.getUniqueUiDataEntryValues(
-            allEntries,
-            (entry: TransactionsEntry) =>
-              assertDefined(
-                entry.fields.find((f) => f.type === type)?.value as string,
-              )
-                .split('|')
-                .map((flag) => flag.trim()),
-          ),
-        });
-      } else {
-        filters.push({
-          type,
-          options: this.getUniqueUiDataEntryValues(
-            allEntries,
-            (entry: TransactionsEntry) =>
-              assertDefined(
-                entry.fields.find((f) => f.type === type),
-              ).value.toString(),
-          ),
-        });
-      }
+  protected override updateDefaultAllowlist(
+    tree: PropertyTreeNode | undefined,
+  ): void {
+    if (!tree) {
+      return;
     }
-
-    this.logPresenter.setAllEntries(allEntries);
-    this.logPresenter.setFilters(filters);
-    this.refreshUiData();
-    this.isInitialized = true;
+    const allowlist: string[] = [];
+    tree
+      .getChildByName('what')
+      ?.formattedValue()
+      .split(' | ')
+      .forEach((flag) => {
+        const properties = layerChangeFlagToPropertiesMap.get(flag);
+        if (properties !== undefined) {
+          allowlist.push(...properties);
+        } else if (flag.startsWith('e')) {
+          const candidateProperty = flag.split('Changed')[0].slice(1);
+          allowlist.push(
+            candidateProperty[0].toLowerCase() + candidateProperty.slice(1),
+          );
+        }
+      });
+    this.propertiesPresenter.updateDefaultAllowList(allowlist);
   }
 
-  private async makeUiDataEntries(): Promise<TransactionsEntry[]> {
+  protected override async makeUiDataEntries(): Promise<TransactionsEntry[]> {
     const entries: TransactionsEntry[] = [];
 
     const entryProtos = await Promise.all(
@@ -154,22 +170,22 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
 
         for (const layerState of layerChanges) {
           const fields: LogField[] = [
-            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
-            {type: LogFieldType.VSYNC_ID, value: vsyncId},
-            {type: LogFieldType.PID, value: pid},
-            {type: LogFieldType.UID, value: uid},
+            {spec: Presenter.COLUMNS.id, value: transactionId},
+            {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+            {spec: Presenter.COLUMNS.pid, value: pid},
+            {spec: Presenter.COLUMNS.uid, value: uid},
             {
-              type: LogFieldType.TRANSACTION_TYPE,
+              spec: Presenter.COLUMNS.type,
               value: TransactionsEntryType.LAYER_CHANGED,
             },
             {
-              type: LogFieldType.LAYER_OR_DISPLAY_ID,
+              spec: Presenter.COLUMNS.layerOrDisplayId,
               value: assertDefined(
                 layerState.getChildByName('layerId'),
               ).formattedValue(),
             },
             {
-              type: LogFieldType.FLAGS,
+              spec: Presenter.COLUMNS.flags,
               value: assertDefined(
                 layerState.getChildByName('what'),
               ).formattedValue(),
@@ -183,22 +199,22 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         ).getAllChildren();
         for (const displayState of displayChanges) {
           const fields: LogField[] = [
-            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
-            {type: LogFieldType.VSYNC_ID, value: vsyncId},
-            {type: LogFieldType.PID, value: pid},
-            {type: LogFieldType.UID, value: uid},
+            {spec: Presenter.COLUMNS.id, value: transactionId},
+            {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+            {spec: Presenter.COLUMNS.pid, value: pid},
+            {spec: Presenter.COLUMNS.uid, value: uid},
             {
-              type: LogFieldType.TRANSACTION_TYPE,
+              spec: Presenter.COLUMNS.type,
               value: TransactionsEntryType.DISPLAY_CHANGED,
             },
             {
-              type: LogFieldType.LAYER_OR_DISPLAY_ID,
+              spec: Presenter.COLUMNS.layerOrDisplayId,
               value: assertDefined(
                 displayState.getChildByName('id'),
               ).formattedValue(),
             },
             {
-              type: LogFieldType.FLAGS,
+              spec: Presenter.COLUMNS.flags,
               value: assertDefined(
                 displayState.getChildByName('what'),
               ).formattedValue(),
@@ -209,16 +225,16 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
 
         if (layerChanges.length === 0 && displayChanges.length === 0) {
           const fields: LogField[] = [
-            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
-            {type: LogFieldType.VSYNC_ID, value: vsyncId},
-            {type: LogFieldType.PID, value: pid},
-            {type: LogFieldType.UID, value: uid},
+            {spec: Presenter.COLUMNS.id, value: transactionId},
+            {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+            {spec: Presenter.COLUMNS.pid, value: pid},
+            {spec: Presenter.COLUMNS.uid, value: uid},
             {
-              type: LogFieldType.TRANSACTION_TYPE,
+              spec: Presenter.COLUMNS.type,
               value: TransactionsEntryType.NO_OP,
             },
-            {type: LogFieldType.LAYER_OR_DISPLAY_ID, value: ''},
-            {type: LogFieldType.FLAGS, value: ''},
+            {spec: Presenter.COLUMNS.layerOrDisplayId, value: ''},
+            {spec: Presenter.COLUMNS.flags, value: ''},
           ];
           entries.push(new TransactionsEntry(entry, fields, undefined));
         }
@@ -228,21 +244,21 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         entryNode.getChildByName('addedLayers'),
       ).getAllChildren()) {
         const fields: LogField[] = [
-          {type: LogFieldType.TRANSACTION_ID, value: ''},
-          {type: LogFieldType.VSYNC_ID, value: vsyncId},
-          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
-          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.id, value: ''},
+          {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+          {spec: Presenter.COLUMNS.pid, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.uid, value: Presenter.VALUE_NA},
           {
-            type: LogFieldType.TRANSACTION_TYPE,
+            spec: Presenter.COLUMNS.type,
             value: TransactionsEntryType.LAYER_ADDED,
           },
           {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            spec: Presenter.COLUMNS.layerOrDisplayId,
             value: assertDefined(
               layerCreationArgs.getChildByName('layerId'),
             ).formattedValue(),
           },
-          {type: LogFieldType.FLAGS, value: ''},
+          {spec: Presenter.COLUMNS.flags, value: ''},
         ];
         entries.push(new TransactionsEntry(entry, fields, layerCreationArgs));
       }
@@ -251,19 +267,19 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         entryNode.getChildByName('destroyedLayers'),
       ).getAllChildren()) {
         const fields: LogField[] = [
-          {type: LogFieldType.TRANSACTION_ID, value: ''},
-          {type: LogFieldType.VSYNC_ID, value: vsyncId},
-          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
-          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.id, value: ''},
+          {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+          {spec: Presenter.COLUMNS.pid, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.uid, value: Presenter.VALUE_NA},
           {
-            type: LogFieldType.TRANSACTION_TYPE,
+            spec: Presenter.COLUMNS.type,
             value: TransactionsEntryType.LAYER_DESTROYED,
           },
           {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            spec: Presenter.COLUMNS.layerOrDisplayId,
             value: destroyedLayerId.formattedValue(),
           },
-          {type: LogFieldType.FLAGS, value: ''},
+          {spec: Presenter.COLUMNS.flags, value: ''},
         ];
         entries.push(new TransactionsEntry(entry, fields, destroyedLayerId));
       }
@@ -272,22 +288,22 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         entryNode.getChildByName('addedDisplays'),
       ).getAllChildren()) {
         const fields: LogField[] = [
-          {type: LogFieldType.TRANSACTION_ID, value: ''},
-          {type: LogFieldType.VSYNC_ID, value: vsyncId},
-          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
-          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.id, value: ''},
+          {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+          {spec: Presenter.COLUMNS.pid, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.uid, value: Presenter.VALUE_NA},
           {
-            type: LogFieldType.TRANSACTION_TYPE,
+            spec: Presenter.COLUMNS.type,
             value: TransactionsEntryType.DISPLAY_ADDED,
           },
           {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            spec: Presenter.COLUMNS.layerOrDisplayId,
             value: assertDefined(
               displayState.getChildByName('id'),
             ).formattedValue(),
           },
           {
-            type: LogFieldType.FLAGS,
+            spec: Presenter.COLUMNS.flags,
             value: assertDefined(
               displayState.getChildByName('what'),
             ).formattedValue(),
@@ -300,19 +316,19 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         entryNode.getChildByName('removedDisplays'),
       ).getAllChildren()) {
         const fields: LogField[] = [
-          {type: LogFieldType.TRANSACTION_ID, value: ''},
-          {type: LogFieldType.VSYNC_ID, value: vsyncId},
-          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
-          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.id, value: ''},
+          {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+          {spec: Presenter.COLUMNS.pid, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.uid, value: Presenter.VALUE_NA},
           {
-            type: LogFieldType.TRANSACTION_TYPE,
+            spec: Presenter.COLUMNS.type,
             value: TransactionsEntryType.DISPLAY_REMOVED,
           },
           {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            spec: Presenter.COLUMNS.layerOrDisplayId,
             value: removedDisplayId.formattedValue(),
           },
-          {type: LogFieldType.FLAGS, value: ''},
+          {spec: Presenter.COLUMNS.flags, value: ''},
         ];
         entries.push(new TransactionsEntry(entry, fields, removedDisplayId));
       }
@@ -321,19 +337,19 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         entryNode.getChildByName('destroyedLayerHandles'),
       ).getAllChildren()) {
         const fields: LogField[] = [
-          {type: LogFieldType.TRANSACTION_ID, value: ''},
-          {type: LogFieldType.VSYNC_ID, value: vsyncId},
-          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
-          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.id, value: ''},
+          {spec: Presenter.COLUMNS.vsyncId, value: vsyncId},
+          {spec: Presenter.COLUMNS.pid, value: Presenter.VALUE_NA},
+          {spec: Presenter.COLUMNS.uid, value: Presenter.VALUE_NA},
           {
-            type: LogFieldType.TRANSACTION_TYPE,
+            spec: Presenter.COLUMNS.type,
             value: TransactionsEntryType.LAYER_HANDLE_DESTROYED,
           },
           {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            spec: Presenter.COLUMNS.layerOrDisplayId,
             value: destroyedLayerHandleId.formattedValue(),
           },
-          {type: LogFieldType.FLAGS, value: ''},
+          {spec: Presenter.COLUMNS.flags, value: ''},
         ];
         entries.push(
           new TransactionsEntry(entry, fields, destroyedLayerHandleId),
@@ -344,6 +360,36 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     return entries;
   }
 
+  protected override updateFiltersInHeaders(
+    headers: LogHeader[],
+    allEntries: TransactionsEntry[],
+  ) {
+    for (const header of headers) {
+      if (header.spec === Presenter.COLUMNS.flags) {
+        (assertDefined(header.filter) as LogSelectFilter).options =
+          this.getUniqueUiDataEntryValues(
+            allEntries,
+            (entry: TransactionsEntry) =>
+              assertDefined(
+                entry.fields.find((f) => f.spec === header.spec)
+                  ?.value as string,
+              )
+                .split('|')
+                .map((flag) => flag.trim()),
+          );
+      } else {
+        (assertDefined(header.filter) as LogSelectFilter).options =
+          this.getUniqueUiDataEntryValues(
+            allEntries,
+            (entry: TransactionsEntry) =>
+              assertDefined(
+                entry.fields.find((f) => f.spec === header.spec),
+              ).value.toString(),
+          );
+      }
+    }
+  }
+
   private getUniqueUiDataEntryValues<T>(
     entries: TransactionsEntry[],
     getValue: (entry: TransactionsEntry) => T | T[],
@@ -385,3 +431,10 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     return result;
   }
 }
+
+const layerChangeFlagToPropertiesMap = new Map([
+  ['eReparent', ['parentId']],
+  ['eRelativeLayerChanged', ['relativeParentId']],
+  ['eLayerChanged', ['layerId']],
+  ['ePositionChanged', ['x', 'y', 'z']],
+]);
diff --git a/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts b/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
index ccd3c668a..1d1e60509 100644
--- a/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
@@ -25,39 +25,45 @@ import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
 import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
-import {
-  LogEntry,
-  LogFieldType,
-  LogFieldValue,
-} from 'viewers/common/ui_data_log';
-import {UserOptions} from 'viewers/common/user_options';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
-import {TransactionsEntryType, UiData} from './ui_data';
+import {UiData} from './ui_data';
 
 class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
-  private trace: Trace<PropertyTreeNode> | undefined;
-  private positionUpdate: TracePositionUpdate | undefined;
-  private secondPositionUpdate: TracePositionUpdate | undefined;
-
-  override readonly shouldExecuteHeaderTests = false;
-  override readonly shouldExecuteFilterTests = true;
-  override readonly shouldExecutePropertiesTests = true;
-
-  override readonly totalOutputEntries = 1647;
-  override readonly expectedIndexOfFirstPositionUpdate = 0;
-  override readonly expectedIndexOfSecondPositionUpdate = 13;
-  override readonly expectedInitialFilterOptions = new Map<
-    LogFieldType,
-    string[] | number
-  >([
-    [
-      LogFieldType.PID,
-      ['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300'],
-    ],
-    [LogFieldType.UID, ['N/A', '1000', '1003', '10169', '10235', '10239']],
-    [
-      LogFieldType.TRANSACTION_TYPE,
-      [
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader(
+        {name: 'TX ID', cssClass: 'transaction-id right-align'},
+        new LogSelectFilter(Array.from({length: 1295}, () => '')),
+      ),
+    },
+    {
+      header: new LogHeader(
+        {name: 'VSYNC ID', cssClass: 'vsyncid right-align'},
+        new LogSelectFilter(Array.from({length: 710}, () => '')),
+      ),
+    },
+    {
+      header: new LogHeader(
+        {name: 'PID', cssClass: 'pid right-align'},
+        new LogSelectFilter(Array.from({length: 8}, () => '')),
+      ),
+      options: ['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'UID', cssClass: 'uid right-align'},
+        new LogSelectFilter(Array.from({length: 6}, () => '')),
+      ),
+      options: ['N/A', '1000', '1003', '10169', '10235', '10239'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'TYPE', cssClass: 'transaction-type'},
+        new LogSelectFilter(Array.from({length: 6}, () => '')),
+      ),
+      options: [
         'DISPLAY_CHANGED',
         'LAYER_ADDED',
         'LAYER_CHANGED',
@@ -65,81 +71,27 @@ class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
         'LAYER_HANDLE_DESTROYED',
         'NO_OP',
       ],
-    ],
-    [LogFieldType.TRANSACTION_ID, 1295],
-    [LogFieldType.LAYER_OR_DISPLAY_ID, 117],
-  ]);
-  override readonly filterValuesToSet = new Map<LogFieldType, string[][]>([
-    [LogFieldType.TRANSACTION_ID, [[], ['2211908157465']]],
-    [LogFieldType.VSYNC_ID, [[], ['1'], ['1', '3', '10']]],
-    [LogFieldType.PID, [[], ['0'], ['0', '515']]],
-    [LogFieldType.UID, [[], ['1000'], ['1000', '1003']]],
-    [
-      LogFieldType.TRANSACTION_TYPE,
-      [
-        [],
-        [TransactionsEntryType.LAYER_ADDED],
-        [
-          TransactionsEntryType.LAYER_ADDED,
-          TransactionsEntryType.LAYER_DESTROYED,
-        ],
-      ],
-    ],
-    [LogFieldType.LAYER_OR_DISPLAY_ID, [[], ['1'], ['1', '3']]],
-    [LogFieldType.FLAGS, [[], ['Crop'], ['STRING_WITH_NO_MATCHES']]],
-  ]);
-  override readonly expectedFieldValuesAfterFilter = new Map<
-    LogFieldType,
-    Array<LogFieldValue[] | number>
-  >([
-    [LogFieldType.TRANSACTION_ID, [this.totalOutputEntries, ['2211908157465']]],
-    [LogFieldType.VSYNC_ID, [this.totalOutputEntries, [1], [1, 3, 10]]],
-    [
-      LogFieldType.PID,
-      [
-        ['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300'],
-        ['0'],
-        ['0', '515'],
-      ],
-    ],
-    [
-      LogFieldType.UID,
-      [
-        ['N/A', '1000', '1003', '10169', '10235', '10239'],
-        ['1000'],
-        ['1000', '1003'],
-      ],
-    ],
-    [
-      LogFieldType.TRANSACTION_TYPE,
-      [
-        [
-          TransactionsEntryType.DISPLAY_CHANGED,
-          TransactionsEntryType.LAYER_ADDED,
-          TransactionsEntryType.LAYER_CHANGED,
-          TransactionsEntryType.LAYER_DESTROYED,
-          TransactionsEntryType.LAYER_HANDLE_DESTROYED,
-          TransactionsEntryType.NO_OP,
-        ],
-        [TransactionsEntryType.LAYER_ADDED],
-        [
-          TransactionsEntryType.LAYER_ADDED,
-          TransactionsEntryType.LAYER_DESTROYED,
-        ],
-      ],
-    ],
-    [
-      LogFieldType.LAYER_OR_DISPLAY_ID,
-      [this.totalOutputEntries, ['1'], ['1', '3']],
-    ],
-    [LogFieldType.FLAGS, [this.totalOutputEntries, 980, 0]],
-  ]);
-  override readonly logEntryClickIndex = 10;
-  override readonly filterNameForCurrentIndexTest = LogFieldType.PID;
-  override readonly filterChangeForCurrentIndexTest = ['0'];
-  override readonly secondFilterChangeForCurrentIndexTest = ['0', '515'];
-  override readonly expectedCurrentIndexAfterFilterChange = 10;
-  override readonly expectedCurrentIndexAfterSecondFilterChange = 11;
+    },
+    {
+      header: new LogHeader(
+        {name: 'LAYER/DISP ID', cssClass: 'layer-or-display-id right-align'},
+        new LogSelectFilter(Array.from({length: 117}, () => '')),
+      ),
+    },
+    {
+      header: new LogHeader(
+        {name: 'Flags', cssClass: 'flags'},
+        new LogSelectFilter(
+          Array.from({length: 30}, () => ''),
+          true,
+          '250',
+          '100%',
+        ),
+      ),
+    },
+  ];
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
 
   override executeSpecializedTests() {
     describe('Specialized tests', () => {
@@ -151,60 +103,56 @@ class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
       });
 
       beforeEach(async () => {
-        const notifyViewCallback = (newData: UiData) => {
+        presenter = await this.createPresenter((newData: UiData) => {
           uiData = newData;
-        };
-        presenter = await this.createPresenter(notifyViewCallback);
-      });
-
-      it('includes no op transitions', async () => {
-        await presenter.onFilterChange(LogFieldType.TRANSACTION_TYPE, [
-          TransactionsEntryType.NO_OP,
-        ]);
-        const fieldValues = assertDefined(uiData).entries.map((entry) =>
-          getFieldValue(entry, LogFieldType.TRANSACTION_TYPE),
-        );
-        expect(new Set(fieldValues)).toEqual(
-          new Set([TransactionsEntryType.NO_OP]),
-        );
-
-        for (const entry of assertDefined(uiData).entries) {
-          expect(
-            getFieldValue(entry, LogFieldType.LAYER_OR_DISPLAY_ID),
-          ).toEqual('');
-          expect(getFieldValue(entry, LogFieldType.FLAGS)).toEqual('');
-          expect(entry.propertiesTree).toEqual(undefined);
-        }
+        });
       });
 
-      it('shows/hides defaults', async () => {
-        const userOptions: UserOptions = {
-          showDiff: {
-            name: 'Show diff',
-            enabled: true,
-          },
-          showDefaults: {
-            name: 'Show defaults',
-            enabled: true,
-          },
-        };
-
+      it('keeps properties related to what has changed regardless of hide defaults', async () => {
         await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onLogEntryClick(this.logEntryClickIndex);
+        await presenter.onLogEntryClick(10);
         expect(
           assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(6);
+        ).toEqual(8);
+        expect(
+          uiData.propertiesTree?.getChildByName('transformToDisplayInverse'),
+        ).toBeDefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('destinationFrame'),
+        ).toBeDefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('autoRefresh'),
+        ).toBeDefined();
 
-        await presenter.onPropertiesUserOptionsChange(userOptions);
-        expect(uiData.propertiesUserOptions).toEqual(userOptions);
+        await presenter.onLogEntryClick(279);
+        expect(uiData.propertiesTree?.getChildByName('flags')).toBeDefined();
+        expect(uiData.propertiesTree?.getChildByName('parentId')).toBeDefined();
         expect(
-          assertDefined(uiData.propertiesTree).getAllChildren().length,
-        ).toEqual(42);
+          uiData.propertiesTree?.getChildByName('relativeParentId'),
+        ).toBeDefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('transformToDisplayInverse'),
+        ).toBeUndefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('destinationFrame'),
+        ).toBeUndefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('autoRefresh'),
+        ).toBeUndefined();
+
+        await presenter.onLogEntryClick(584);
+        expect(uiData.propertiesTree?.getChildByName('flags')).toBeDefined();
+        expect(uiData.propertiesTree?.getChildByName('layerId')).toBeDefined();
+        expect(uiData.propertiesTree?.getChildByName('x')).toBeDefined();
+        expect(uiData.propertiesTree?.getChildByName('y')).toBeDefined();
+        expect(uiData.propertiesTree?.getChildByName('z')).toBeDefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('parentId'),
+        ).toBeUndefined();
+        expect(
+          uiData.propertiesTree?.getChildByName('relativeParentId'),
+        ).toBeUndefined();
       });
-
-      function getFieldValue(entry: LogEntry, logFieldName: LogFieldType) {
-        return entry.fields.find((f) => f.type === logFieldName)?.value;
-      }
     });
   }
 
@@ -212,23 +160,20 @@ class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
     const parser = (await UnitTestUtils.getParser(
       'traces/elapsed_and_real_timestamp/Transactions.pb',
     )) as Parser<PropertyTreeNode>;
-    this.trace = new TraceBuilder<PropertyTreeNode>().setParser(parser).build();
+    this.trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSACTIONS)
+      .setParser(parser)
+      .build();
     this.positionUpdate = TracePositionUpdate.fromTraceEntry(
       this.trace.getEntry(0),
     );
-    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
-      this.trace.getEntry(10),
-    );
   }
 
   override async createPresenterWithEmptyTrace(
     callback: NotifyLogViewCallbackType<UiData>,
   ): Promise<Presenter> {
-    const emptyTrace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSACTIONS)
-      .setEntries([])
-      .build();
-    return new Presenter(emptyTrace, new InMemoryStorage(), callback);
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.TRANSACTIONS);
+    return new Presenter(trace, new InMemoryStorage(), callback);
   }
 
   override async createPresenter(
@@ -246,10 +191,6 @@ class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
   override getPositionUpdate(): TracePositionUpdate {
     return assertDefined(this.positionUpdate);
   }
-
-  override getSecondPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.secondPositionUpdate);
-  }
 }
 
 describe('PresenterTransactions', () => {
diff --git a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
index 98b466492..00a152e53 100644
--- a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright 2023, The Android Open Source Project
+ * Copyright (C) 2023 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,8 +14,6 @@
  * limitations under the License.
  */
 
-import {assertDefined} from 'common/assert_utils';
-import {LogFieldType} from 'viewers/common/ui_data_log';
 import {VariableHeightScrollStrategy} from 'viewers/common/variable_height_scroll_strategy';
 import {TransactionsEntry} from 'viewers/viewer_transactions/ui_data';
 
@@ -26,8 +24,7 @@ export class TransactionsScrollStrategy extends VariableHeightScrollStrategy {
 
   protected override predictScrollItemHeight(entry: TransactionsEntry): number {
     const flagsHeight = this.subItemHeight(
-      assertDefined(entry.fields.find((f) => f.type === LogFieldType.FLAGS))
-        .value as string,
+      entry.fields[6].value as string,
       this.flagCharsPerRow,
     );
     const timestampHeight = this.subItemHeight(
diff --git a/tools/winscope/src/viewers/viewer_transactions/ui_data.ts b/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
index b29490137..caeeceb70 100644
--- a/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
@@ -19,7 +19,7 @@ import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {
   LogEntry,
   LogField,
-  LogFilter,
+  LogHeader,
   UiDataLog,
 } from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
@@ -27,8 +27,8 @@ import {UserOptions} from 'viewers/common/user_options';
 
 export class UiData implements UiDataLog {
   constructor(
-    public filters: LogFilter[],
-    public entries: LogEntry[],
+    public headers: LogHeader[],
+    public entries: TransactionsEntry[],
     public currentIndex: undefined | number,
     public selectedIndex: undefined | number,
     public scrollToIndex: undefined | number,
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
index a7a90484a..5b0fdece1 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
@@ -44,7 +44,7 @@ class ViewerTransactions implements Viewer {
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.TRANSACTIONS].name,
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
index 76f11b0f5..aa58af999 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
@@ -17,7 +17,7 @@ import {Component, Input, ViewChild} from '@angular/core';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
@@ -37,19 +37,19 @@ import {UiData} from './ui_data';
         [scrollToIndex]="inputData?.scrollToIndex"
         [currentIndex]="inputData?.currentIndex"
         [entries]="inputData?.entries"
-        [filters]="inputData?.filters"
+        [headers]="inputData?.headers"
         [traceType]="${TraceType.TRANSACTIONS}">
       </log-view>
 
       <properties-view
-        *ngIf="inputData?.propertiesTree"
         class="properties-view"
         [title]="propertiesTitle"
-        [showFilter]="false"
         [userOptions]="inputData?.propertiesUserOptions"
         [propertiesTree]="inputData?.propertiesTree"
         [traceType]="${TraceType.TRANSACTIONS}"
         [isProtoDump]="false"
+        [textFilter]="inputData?.propertiesFilter"
+        placeholderText="No current or selected transaction."
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"
         [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES)"></properties-view>
     </div>
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
index c3e787cc6..20cc850d8 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
@@ -14,19 +14,21 @@
  * limitations under the License.
  */
 
+import {ClipboardModule} from '@angular/cdk/clipboard';
 import {
   CdkVirtualScrollViewport,
   ScrollingModule,
 } from '@angular/cdk/scrolling';
-import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
   ComponentFixtureAutoDetect,
   TestBed,
 } from '@angular/core/testing';
 import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
 import {MatDividerModule} from '@angular/material/divider';
 import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
 import {MatInputModule} from '@angular/material/input';
 import {MatSelectModule} from '@angular/material/select';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
@@ -35,55 +37,35 @@ import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
+import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogSelectFilter} from 'viewers/common/log_filters';
 import {executeScrollComponentTests} from 'viewers/common/scroll_component_tests';
-import {LogFieldType} from 'viewers/common/ui_data_log';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
+import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
+import {TreeComponent} from 'viewers/components/tree_component';
+import {TreeNodeComponent} from 'viewers/components/tree_node_component';
 import {TransactionsScrollDirective} from './scroll_strategy/transactions_scroll_directive';
 import {TransactionsEntry, UiData} from './ui_data';
 import {ViewerTransactionsComponent} from './viewer_transactions_component';
 
 describe('ViewerTransactionsComponent', () => {
-  describe('Main component', () => {
-    let fixture: ComponentFixture<ViewerTransactionsComponent>;
-    let component: ViewerTransactionsComponent;
-    let htmlElement: HTMLElement;
+  const testSpec = {name: 'Test Column', cssClass: 'test-class'};
+  const testField = {spec: testSpec, value: 'VALUE'};
+  let fixture: ComponentFixture<ViewerTransactionsComponent>;
+  let component: ViewerTransactionsComponent;
+  let htmlElement: HTMLElement;
 
+  describe('Main component', () => {
     beforeEach(async () => {
-      await TestBed.configureTestingModule({
-        providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-        imports: [
-          ScrollingModule,
-          MatFormFieldModule,
-          FormsModule,
-          MatInputModule,
-          BrowserAnimationsModule,
-          MatSelectModule,
-          MatDividerModule,
-        ],
-        declarations: [
-          ViewerTransactionsComponent,
-          TransactionsScrollDirective,
-          SelectWithFilterComponent,
-          CollapsedSectionsComponent,
-          CollapsibleSectionTitleComponent,
-          PropertiesComponent,
-          LogComponent,
-        ],
-        schemas: [CUSTOM_ELEMENTS_SCHEMA],
-      }).compileComponents();
-
-      fixture = TestBed.createComponent(ViewerTransactionsComponent);
-      component = fixture.componentInstance;
-      htmlElement = fixture.nativeElement;
-
-      component.inputData = makeUiData(0);
-      fixture.detectChanges();
+      await setUpTestEnvironment(() => makeUiData(0));
     });
 
     it('can be created', () => {
@@ -94,34 +76,46 @@ describe('ViewerTransactionsComponent', () => {
       expect(htmlElement.querySelector('.log-view')).toBeTruthy();
     });
 
-    it('renders filters', () => {
-      expect(htmlElement.querySelector('.filters .pid')).toBeTruthy();
-      expect(htmlElement.querySelector('.filters .uid')).toBeTruthy();
+    it('render headers as filters', () => {
       expect(
-        htmlElement.querySelector('.filters .transaction-type'),
-      ).toBeTruthy();
-      expect(
-        htmlElement.querySelector('.filters .transaction-id'),
+        htmlElement.querySelector(
+          `.headers .filter.${testSpec.cssClass.split(' ')[0]}`,
+        ),
       ).toBeTruthy();
     });
 
-    it('renders entries', () => {
+    it('renders entries with field values and trace timestamp', () => {
       expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+      const entry = assertDefined(
+        htmlElement.querySelector(
+          `.scroll .entry .${testSpec.cssClass.split(' ')[0]}`,
+        ),
+      );
+      expect(entry.textContent).toContain('VALUE');
 
-      const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
-      expect(entry.innerHTML).toContain('1ns');
-      expect(entry.innerHTML).toContain('-111');
-      expect(entry.innerHTML).toContain('PID_VALUE');
-      expect(entry.innerHTML).toContain('UID_VALUE');
-      expect(entry.innerHTML).toContain('TYPE_VALUE');
-      expect(entry.innerHTML).toContain('ID_VALUE');
-      expect(entry.innerHTML).toContain('flag1 | flag2');
+      const entryTimestamp = assertDefined(
+        htmlElement.querySelector('.scroll .entry .time'),
+      );
+      expect(entryTimestamp.textContent?.trim()).toEqual('1ns');
+    });
+
+    it('shows go to current time button', () => {
+      expect(htmlElement.querySelector('.go-to-current-time')).toBeTruthy();
     });
 
     it('renders properties', () => {
       expect(htmlElement.querySelector('.properties-view')).toBeTruthy();
     });
 
+    it('shows message when no transaction is selected', () => {
+      assertDefined(component.inputData).propertiesTree = undefined;
+      fixture.detectChanges();
+      expect(
+        htmlElement.querySelector('.properties-view .placeholder-text')
+          ?.textContent,
+      ).toContain('No current or selected transaction');
+    });
+
     it('creates collapsed sections with no buttons', () => {
       UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
     });
@@ -151,75 +145,28 @@ describe('ViewerTransactionsComponent', () => {
 
       const entry1 = new TransactionsEntry(
         trace.getEntry(0),
-        [
-          {type: LogFieldType.VSYNC_ID, value: -111},
-          {type: LogFieldType.PID, value: 'PID_VALUE'},
-          {type: LogFieldType.UID, value: 'UID_VALUE'},
-          {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE'},
-          {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
-            value: 'LAYER_OR_DISPLAY_ID_VALUE',
-          },
-          {type: LogFieldType.TRANSACTION_ID, value: 'TRANSACTION_ID_VALUE'},
-          {type: LogFieldType.FLAGS, value: 'flag1 | flag2'},
-        ],
+        Array.from({length: 7}, () => testField),
         propertiesTree,
       );
 
-      const entry2 = new TransactionsEntry(
-        trace.getEntry(1),
-        [
-          {type: LogFieldType.VSYNC_ID, value: -222},
-          {type: LogFieldType.PID, value: 'PID_VALUE_2'},
-          {type: LogFieldType.UID, value: 'UID_VALUE_2'},
-          {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE_2'},
-          {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
-            value: 'LAYER_OR_DISPLAY_ID_VALUE_2',
-          },
-          {type: LogFieldType.TRANSACTION_ID, value: 'TRANSACTION_ID_VALUE_2'},
-          {type: LogFieldType.FLAGS, value: 'flag3 | flag4'},
-        ],
-        propertiesTree,
-      );
-
-      return new UiData(
-        [
-          {type: LogFieldType.VSYNC_ID, options: ['-111', '-222']},
-          {type: LogFieldType.PID, options: ['PID_VALUE', 'PID_VALUE_2']},
-          {type: LogFieldType.UID, options: ['UID_VALUE', 'UID_VALUE_2']},
-          {
-            type: LogFieldType.TRANSACTION_TYPE,
-            options: ['TYPE_VALUE', 'TYPE_VALUE_2'],
-          },
-          {
-            type: LogFieldType.LAYER_OR_DISPLAY_ID,
-            options: [
-              'LAYER_OR_DISPLAY_ID_VALUE',
-              'LAYER_OR_DISPLAY_ID_VALUE_2',
-            ],
-          },
-          {
-            type: LogFieldType.TRANSACTION_ID,
-            options: ['TRANSACTION_ID_VALUE', 'TRANSACTION_ID_VALUE_2'],
-          },
-          {
-            type: LogFieldType.FLAGS,
-            options: ['flag1', 'flag2', 'flag3', 'flag4'],
-          },
-        ],
-        [entry1, entry2],
+      const uiData = new UiData(
+        [new LogHeader(testSpec, new LogSelectFilter([]))],
+        [entry1],
         1,
         selectedEntryIndex,
         0,
         UiPropertyTreeNode.from(propertiesTree),
         {},
       );
+
+      return uiData;
     }
   });
 
   describe('Scroll component', () => {
-    executeScrollComponentTests(setUpTestEnvironment);
+    executeScrollComponentTests(() =>
+      setUpTestEnvironment(makeUiDataForScroll),
+    );
 
     function makeUiDataForScroll(): UiData {
       const propertiesTree = new PropertyTreeBuilder()
@@ -231,6 +178,7 @@ describe('ViewerTransactionsComponent', () => {
       const ts = TimestampConverterUtils.makeElapsedTimestamp(1n);
 
       const trace = new TraceBuilder<PropertyTreeNode>()
+        .setType(TraceType.TRANSACTIONS)
         .setEntries([propertiesTree, propertiesTree])
         .setTimestamps([ts, ts])
         .build();
@@ -246,60 +194,70 @@ describe('ViewerTransactionsComponent', () => {
       );
       const shortMessage = 'flag1 | flag2';
       const longMessage = shortMessage.repeat(20);
+      const traceEntry = trace.getEntry(0);
+
       for (let i = 0; i < 200; i++) {
         const entry = new TransactionsEntry(
-          trace.getEntry(0),
-          [
-            {type: LogFieldType.VSYNC_ID, value: -111},
-            {type: LogFieldType.PID, value: 'PID_VALUE'},
-            {type: LogFieldType.UID, value: 'UID_VALUE'},
-            {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE'},
-            {
-              type: LogFieldType.LAYER_OR_DISPLAY_ID,
-              value: 'LAYER_OR_DISPLAY_ID_VALUE',
-            },
-            {
-              type: LogFieldType.TRANSACTION_ID,
-              value: 'TRANSACTION_ID_VALUE',
-            },
+          traceEntry,
+          Array.from({length: 6}, () => testField).concat([
             {
-              type: LogFieldType.FLAGS,
+              spec: {name: 'Test Column Flags', cssClass: 'test-class-flags'},
               value: i % 2 === 0 ? shortMessage : longMessage,
             },
-          ],
+          ]),
           propertiesTree,
         );
         uiData.entries.push(entry);
       }
       return uiData;
     }
-
-    async function setUpTestEnvironment(): Promise<
-      [
-        ComponentFixture<ViewerTransactionsComponent>,
-        HTMLElement,
-        CdkVirtualScrollViewport,
-      ]
-    > {
-      await TestBed.configureTestingModule({
-        providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-        imports: [ScrollingModule],
-        declarations: [
-          ViewerTransactionsComponent,
-          LogComponent,
-          TransactionsScrollDirective,
-        ],
-        schemas: [CUSTOM_ELEMENTS_SCHEMA],
-      }).compileComponents();
-      const fixture = TestBed.createComponent(ViewerTransactionsComponent);
-      const transactionsComponent = fixture.componentInstance;
-      const htmlElement = fixture.nativeElement;
-      transactionsComponent.inputData = makeUiDataForScroll();
-      fixture.detectChanges();
-      const viewport = assertDefined(
-        transactionsComponent.logComponent?.scrollComponent,
-      );
-      return [fixture, htmlElement, viewport];
-    }
   });
+
+  async function setUpTestEnvironment(
+    makeUiData: () => UiData,
+  ): Promise<
+    [
+      ComponentFixture<ViewerTransactionsComponent>,
+      HTMLElement,
+      CdkVirtualScrollViewport,
+    ]
+  > {
+    await TestBed.configureTestingModule({
+      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      imports: [
+        MatDividerModule,
+        ScrollingModule,
+        MatIconModule,
+        ClipboardModule,
+        MatFormFieldModule,
+        MatButtonModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        FormsModule,
+        MatSelectModule,
+      ],
+      declarations: [
+        ViewerTransactionsComponent,
+        TransactionsScrollDirective,
+        SelectWithFilterComponent,
+        CollapsedSectionsComponent,
+        CollapsibleSectionTitleComponent,
+        PropertiesComponent,
+        TreeComponent,
+        TreeNodeComponent,
+        PropertyTreeNodeDataViewComponent,
+        SearchBoxComponent,
+        LogComponent,
+      ],
+    }).compileComponents();
+
+    fixture = TestBed.createComponent(ViewerTransactionsComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+
+    component.inputData = makeUiData();
+    fixture.detectChanges();
+    const viewport = assertDefined(component.logComponent?.scrollComponent);
+    return [fixture, htmlElement, viewport];
+  }
 });
diff --git a/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names.ts b/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names.ts
index 2dec87bbe..e921f08aa 100644
--- a/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names.ts
@@ -14,22 +14,22 @@
  * limitations under the License.
  */
 
-import {assertDefined} from 'common/assert_utils';
 import {FixedStringFormatter} from 'trace/tree_node/formatters';
 import {Operation} from 'trace/tree_node/operations/operation';
-import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
 export class UpdateTransitionChangesNames
-  implements Operation<UiPropertyTreeNode>
+  implements Operation<PropertyTreeNode>
 {
   constructor(
     private readonly layerIdToName: Map<number, string>,
     private readonly windowTokenToTitle: Map<string, string>,
   ) {}
 
-  apply(node: UiPropertyTreeNode): void {
-    assertDefined(node.getChildByName('wmData'))
-      .getChildByName('targets')
+  apply(node: PropertyTreeNode): void {
+    node
+      .getChildByName('wmData')
+      ?.getChildByName('targets')
       ?.getAllChildren()
       .forEach((target) => {
         const layerId = target.getChildByName('layerId');
@@ -38,7 +38,7 @@ export class UpdateTransitionChangesNames
           const layerName = this.layerIdToName.get(layerIdValue);
           if (layerName) {
             layerId.setFormatter(
-              new FixedStringFormatter(`${layerIdValue} ${layerName}`),
+              new FixedStringFormatter(`${layerIdValue} (${layerName})`),
             );
           }
         }
diff --git a/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names_test.ts b/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names_test.ts
index abad5a376..c464ff2e6 100644
--- a/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names_test.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/operations/update_transition_changes_names_test.ts
@@ -15,7 +15,6 @@
  */
 
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
-import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UpdateTransitionChangesNames} from './update_transition_changes_names';
 
 describe('UpdateTransitionChangesNames', () => {
@@ -34,32 +33,30 @@ describe('UpdateTransitionChangesNames', () => {
   });
 
   it('updates layerId and windowToken display names if in maps', () => {
-    const propertyRoot = UiPropertyTreeNode.from(
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [
-              {
-                name: 'targets',
-                children: [
-                  {
-                    name: '0',
-                    children: [
-                      {name: 'layerId', value: 2},
-                      {name: 'windowId', value: 159077656n},
-                    ],
-                  },
-                ],
-              },
-            ],
-          },
-        ])
-        .build(),
-    );
+    const propertyRoot = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('TransitionsTraceEntry')
+      .setName('transition')
+      .setChildren([
+        {
+          name: 'wmData',
+          children: [
+            {
+              name: 'targets',
+              children: [
+                {
+                  name: '0',
+                  children: [
+                    {name: 'layerId', value: 2},
+                    {name: 'windowId', value: 159077656n},
+                  ],
+                },
+              ],
+            },
+          ],
+        },
+      ])
+      .build();
 
     operation.apply(propertyRoot);
     expect(
@@ -69,7 +66,7 @@ describe('UpdateTransitionChangesNames', () => {
         ?.getChildByName('0')
         ?.getChildByName('layerId')
         ?.formattedValue(),
-    ).toEqual('2 testLayer');
+    ).toEqual('2 (testLayer)');
 
     expect(
       propertyRoot
@@ -82,32 +79,30 @@ describe('UpdateTransitionChangesNames', () => {
   });
 
   it('updates only windowId display name if neither layer id nor token in maps', () => {
-    const propertyRoot = UiPropertyTreeNode.from(
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [
-              {
-                name: 'targets',
-                children: [
-                  {
-                    name: '0',
-                    children: [
-                      {name: 'layerId', value: 1},
-                      {name: 'windowId', value: 193491296n},
-                    ],
-                  },
-                ],
-              },
-            ],
-          },
-        ])
-        .build(),
-    );
+    const propertyRoot = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('TransitionsTraceEntry')
+      .setName('transition')
+      .setChildren([
+        {
+          name: 'wmData',
+          children: [
+            {
+              name: 'targets',
+              children: [
+                {
+                  name: '0',
+                  children: [
+                    {name: 'layerId', value: 1},
+                    {name: 'windowId', value: 193491296n},
+                  ],
+                },
+              ],
+            },
+          ],
+        },
+      ])
+      .build();
 
     operation.apply(propertyRoot);
     expect(
diff --git a/tools/winscope/src/viewers/viewer_transitions/presenter.ts b/tools/winscope/src/viewers/viewer_transitions/presenter.ts
index 858206bdc..82303ae29 100644
--- a/tools/winscope/src/viewers/viewer_transitions/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/presenter.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
 import {CustomQueryType} from 'trace/custom_query';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
@@ -25,47 +26,52 @@ import {
   AbstractLogViewerPresenter,
   NotifyLogViewCallbackType,
 } from 'viewers/common/abstract_log_viewer_presenter';
+import {LogSelectFilter} from 'viewers/common/log_filters';
 import {LogPresenter} from 'viewers/common/log_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
-import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {TextFilter} from 'viewers/common/text_filter';
+import {ColumnSpec, LogField, LogHeader} from 'viewers/common/ui_data_log';
 import {UpdateTransitionChangesNames} from './operations/update_transition_changes_names';
 import {TransitionsEntry, TransitionStatus, UiData} from './ui_data';
 
-export class Presenter extends AbstractLogViewerPresenter<UiData> {
-  static readonly FIELD_TYPES = [
-    LogFieldType.TRANSITION_ID,
-    LogFieldType.TRANSITION_TYPE,
-    LogFieldType.SEND_TIME,
-    LogFieldType.DISPATCH_TIME,
-    LogFieldType.DURATION,
-    LogFieldType.STATUS,
-  ];
-  private static readonly VALUE_NA = 'N/A';
-
-  private isInitialized = false;
+export class Presenter extends AbstractLogViewerPresenter<
+  UiData,
+  PropertyTreeNode
+> {
+  private static readonly COLUMNS = {
+    id: {name: 'Id', cssClass: 'transition-id right-align'},
+    type: {name: 'Type', cssClass: 'transition-type'},
+    sendTime: {name: 'Send Time', cssClass: 'send-time time'},
+    dispatchTime: {name: 'Dispatch Time', cssClass: 'dispatch-time time'},
+    duration: {name: 'Duration', cssClass: 'duration right-align'},
+    handler: {name: 'Handler', cssClass: 'handler'},
+    participants: {name: 'Participants', cssClass: 'participants'},
+    flags: {name: 'Flags', cssClass: 'flags'},
+    status: {name: 'Status', cssClass: 'status right-align'},
+  };
   private transitionTrace: Trace<PropertyTreeNode>;
   private surfaceFlingerTrace: Trace<HierarchyTreeNode> | undefined;
   private windowManagerTrace: Trace<HierarchyTreeNode> | undefined;
   private layerIdToName = new Map<number, string>();
   private windowTokenToTitle = new Map<string, string>();
+  private updateTransitionChangesNames = new UpdateTransitionChangesNames(
+    this.layerIdToName,
+    this.windowTokenToTitle,
+  );
+  private uniqueFieldValues = new Map<ColumnSpec, Set<string>>();
 
   protected override keepCalculated = false;
   protected override logPresenter = new LogPresenter<TransitionsEntry>(false);
   protected override propertiesPresenter = new PropertiesPresenter(
     {},
-    undefined,
+    new TextFilter(),
     [],
-    [
-      new UpdateTransitionChangesNames(
-        this.layerIdToName,
-        this.windowTokenToTitle,
-      ),
-    ],
   );
 
   constructor(
     trace: Trace<PropertyTreeNode>,
     traces: Traces,
+    readonly storage: Store,
     notifyViewCallback: NotifyLogViewCallbackType<UiData>,
   ) {
     super(trace, notifyViewCallback, UiData.createEmpty());
@@ -74,11 +80,7 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
     this.windowManagerTrace = traces.getTrace(TraceType.WINDOW_MANAGER);
   }
 
-  protected async initializeIfNeeded() {
-    if (this.isInitialized) {
-      return;
-    }
-
+  protected override async initializeTraceSpecificData() {
     if (this.surfaceFlingerTrace) {
       const layersIdAndName = await this.surfaceFlingerTrace.customQuery(
         CustomQueryType.SF_LAYERS_ID_AND_NAME,
@@ -96,33 +98,96 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
         this.windowTokenToTitle.set(value.token, value.title);
       });
     }
+  }
 
-    const allEntries = await this.makeUiDataEntries();
-
-    this.logPresenter.setAllEntries(allEntries);
-    this.logPresenter.setHeaders(Presenter.FIELD_TYPES);
-    this.refreshUiData();
-    this.isInitialized = true;
+  protected override makeHeaders(): LogHeader[] {
+    return [
+      new LogHeader(Presenter.COLUMNS.id),
+      new LogHeader(
+        Presenter.COLUMNS.type,
+        new LogSelectFilter([], false, '175'),
+      ),
+      new LogHeader(Presenter.COLUMNS.sendTime),
+      new LogHeader(Presenter.COLUMNS.dispatchTime),
+      new LogHeader(Presenter.COLUMNS.duration),
+      new LogHeader(
+        Presenter.COLUMNS.handler,
+        new LogSelectFilter([], false, '250'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.participants,
+        new LogSelectFilter([], true, '250', '100%'),
+      ),
+      new LogHeader(
+        Presenter.COLUMNS.flags,
+        new LogSelectFilter([], true, '250', '100%'),
+      ),
+      new LogHeader(Presenter.COLUMNS.status, new LogSelectFilter([])),
+    ];
   }
 
-  private async makeUiDataEntries(): Promise<TransitionsEntry[]> {
+  protected override async makeUiDataEntries(
+    headers: LogHeader[],
+  ): Promise<TransitionsEntry[]> {
     // TODO(b/339191691): Ideally we should refactor the parsers to
     // keep a map of time -> rowId, instead of relying on table order
-    const transitions = await this.makeTransitions();
+    headers.forEach((header) => {
+      if (!header.filter) return;
+      this.uniqueFieldValues.set(header.spec, new Set());
+    });
+    const transitions = await this.makeTransitions(headers);
     this.sortTransitions(transitions);
     return transitions;
   }
 
+  protected override updateFiltersInHeaders(headers: LogHeader[]) {
+    headers.forEach((header) => {
+      if (!(header.filter instanceof LogSelectFilter)) return;
+      header.filter.options = this.getUniqueUiDataEntryValues(header.spec);
+    });
+  }
+
+  private getUniqueUiDataEntryValues(spec: ColumnSpec): string[] {
+    const result = [...assertDefined(this.uniqueFieldValues.get(spec))];
+
+    result.sort((a, b) => {
+      const aIsNumber = !isNaN(Number(a));
+      const bIsNumber = !isNaN(Number(b));
+
+      if (aIsNumber && bIsNumber) {
+        return Number(a) - Number(b);
+      } else if (aIsNumber) {
+        return 1; // place number after strings in the result
+      } else if (bIsNumber) {
+        return -1; // place number after strings in the result
+      }
+
+      // a and b are both strings
+      if (a < b) {
+        return -1;
+      } else if (a > b) {
+        return 1;
+      } else {
+        return 0;
+      }
+    });
+
+    return result;
+  }
+
   private sortTransitions(transitions: TransitionsEntry[]) {
     const getId = (a: TransitionsEntry) =>
-      assertDefined(a.fields.find((f) => f.type === LogFieldType.TRANSITION_ID))
-        .value;
+      assertDefined(
+        a.fields.find((field) => field.spec === Presenter.COLUMNS.id),
+      ).value;
     transitions.sort((a: TransitionsEntry, b: TransitionsEntry) => {
       return getId(a) <= getId(b) ? -1 : 1;
     });
   }
 
-  private async makeTransitions(): Promise<TransitionsEntry[]> {
+  private async makeTransitions(
+    headers: LogHeader[],
+  ): Promise<TransitionsEntry[]> {
     const transitions: TransitionsEntry[] = [];
     for (
       let traceIndex = 0;
@@ -140,58 +205,46 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
       const shellDataNode = assertDefined(
         transitionNode.getChildByName('shellData'),
       );
+      this.updateTransitionChangesNames.apply(transitionNode);
 
-      let status: TransitionStatus | undefined;
-      let statusIcon: string | undefined;
-      let statusIconColor: string | undefined;
-      if (assertDefined(transitionNode.getChildByName('merged')).getValue()) {
-        status = TransitionStatus.MERGED;
-        statusIcon = 'merge';
-        statusIconColor = 'gray';
-      } else if (
-        assertDefined(transitionNode.getChildByName('aborted')).getValue()
-      ) {
-        status = TransitionStatus.ABORTED;
-        statusIcon = 'close';
-        statusIconColor = 'red';
-      } else if (
-        assertDefined(transitionNode.getChildByName('played')).getValue()
-      ) {
-        status = TransitionStatus.PLAYED;
-        statusIcon = 'check';
-        statusIconColor = 'green';
-      }
+      const transitionType = this.extractAndFormatTransitionType(wmDataNode);
+      const handler = this.extractAndFormatHandler(shellDataNode);
+      const participants = this.extractAndFormatParticipants(wmDataNode);
+      const flags = this.extractAndFormatFlags(wmDataNode);
+      const [status, statusIcon, statusIconColor] =
+        this.extractAndFormatStatus(transitionNode);
 
       const fields: LogField[] = [
         {
-          type: LogFieldType.TRANSITION_ID,
+          spec: Presenter.COLUMNS.id,
           value: assertDefined(transitionNode.getChildByName('id')).getValue(),
         },
+        {spec: Presenter.COLUMNS.type, value: transitionType},
         {
-          type: LogFieldType.TRANSITION_TYPE,
-          value: wmDataNode.getChildByName('type')?.formattedValue() ?? 'NONE',
-        },
-        {
-          type: LogFieldType.SEND_TIME,
+          spec: Presenter.COLUMNS.sendTime,
           value:
             wmDataNode.getChildByName('sendTimeNs')?.getValue() ??
             Presenter.VALUE_NA,
         },
         {
-          type: LogFieldType.DISPATCH_TIME,
+          spec: Presenter.COLUMNS.dispatchTime,
           value:
             shellDataNode.getChildByName('dispatchTimeNs')?.getValue() ??
             Presenter.VALUE_NA,
+          propagateEntryTimestamp: true,
         },
         {
-          type: LogFieldType.DURATION,
+          spec: Presenter.COLUMNS.duration,
           value:
             transitionNode.getChildByName('duration')?.formattedValue() ??
             Presenter.VALUE_NA,
         },
+        {spec: Presenter.COLUMNS.handler, value: handler},
+        {spec: Presenter.COLUMNS.participants, value: participants},
+        {spec: Presenter.COLUMNS.flags, value: flags},
         {
-          type: LogFieldType.STATUS,
-          value: status ?? Presenter.VALUE_NA,
+          spec: Presenter.COLUMNS.status,
+          value: status,
           icon: statusIcon,
           iconColor: statusIconColor,
         },
@@ -201,4 +254,93 @@ export class Presenter extends AbstractLogViewerPresenter<UiData> {
 
     return transitions;
   }
+
+  private extractAndFormatTransitionType(wmDataNode: PropertyTreeNode): string {
+    const transitionType =
+      wmDataNode.getChildByName('type')?.formattedValue() ?? 'NONE';
+    assertDefined(this.uniqueFieldValues.get(Presenter.COLUMNS.type)).add(
+      transitionType,
+    );
+    return transitionType;
+  }
+
+  private extractAndFormatHandler(shellDataNode: PropertyTreeNode): string {
+    const handler =
+      shellDataNode.getChildByName('handler')?.formattedValue() ??
+      Presenter.VALUE_NA;
+    assertDefined(this.uniqueFieldValues.get(Presenter.COLUMNS.handler)).add(
+      handler,
+    );
+    return handler;
+  }
+
+  private extractAndFormatFlags(wmDataNode: PropertyTreeNode): string {
+    const flags =
+      wmDataNode.getChildByName('flags')?.formattedValue() ??
+      Presenter.VALUE_NA;
+
+    const uniqueFlags = assertDefined(
+      this.uniqueFieldValues.get(Presenter.COLUMNS.flags),
+    );
+    flags
+      .split('|')
+      .map((flag) => flag.trim())
+      .forEach((flag) => uniqueFlags.add(flag));
+
+    return flags;
+  }
+
+  private extractAndFormatParticipants(wmDataNode: PropertyTreeNode): string {
+    const targets = wmDataNode.getChildByName('targets')?.getAllChildren();
+    if (!targets) return Presenter.VALUE_NA;
+
+    const layers = new Set<string>();
+    const windows = new Set<string>();
+    targets.forEach((target) => {
+      const layerId = target.getChildByName('layerId');
+      if (layerId) layers.add(layerId.formattedValue());
+      const windowId = target.getChildByName('windowId');
+      if (windowId) windows.add(windowId.formattedValue());
+    });
+    const uniqueParticipants = assertDefined(
+      this.uniqueFieldValues.get(Presenter.COLUMNS.participants),
+    );
+    layers.forEach((layer) => uniqueParticipants.add(layer));
+    windows.forEach((window) => uniqueParticipants.add(window));
+
+    return `Layers: ${
+      layers.size > 0 ? [...layers].join(', ') : Presenter.VALUE_NA
+    }\nWindows: ${
+      windows.size > 0 ? [...windows].join(', ') : Presenter.VALUE_NA
+    }`;
+  }
+
+  private extractAndFormatStatus(
+    transitionNode: PropertyTreeNode,
+  ): [string, string | undefined, string | undefined] {
+    let status = Presenter.VALUE_NA;
+    let statusIcon: string | undefined;
+    let statusIconColor: string | undefined;
+    if (assertDefined(transitionNode.getChildByName('merged')).getValue()) {
+      status = TransitionStatus.MERGED;
+      statusIcon = 'merge';
+      statusIconColor = 'gray';
+    } else if (
+      assertDefined(transitionNode.getChildByName('aborted')).getValue()
+    ) {
+      status = TransitionStatus.ABORTED;
+      statusIcon = 'close';
+      statusIconColor = 'red';
+    } else if (
+      assertDefined(transitionNode.getChildByName('played')).getValue()
+    ) {
+      status = TransitionStatus.PLAYED;
+      statusIcon = 'check';
+      statusIconColor = 'green';
+    }
+    assertDefined(this.uniqueFieldValues.get(Presenter.COLUMNS.status)).add(
+      status,
+    );
+    return [status, statusIcon, statusIconColor];
+  }
 }
diff --git a/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts b/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
index 3f3ba0d38..71477e6b1 100644
--- a/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {ParserBuilder} from 'test/unit/parser_builder';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
@@ -28,23 +29,97 @@ import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
 import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
-import {UiDataLog} from 'viewers/common/ui_data_log';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {LogHeader, UiDataLog} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
 class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
+  override readonly expectedHeaders = [
+    {
+      header: new LogHeader({
+        name: 'Id',
+        cssClass: 'transition-id right-align',
+      }),
+    },
+    {
+      header: new LogHeader(
+        {name: 'Type', cssClass: 'transition-type'},
+        new LogSelectFilter(Array.from({length: 2}, () => '')),
+      ),
+      options: ['OPEN', 'TO_FRONT'],
+    },
+    {header: new LogHeader({name: 'Send Time', cssClass: 'send-time time'})},
+    {
+      header: new LogHeader({
+        name: 'Dispatch Time',
+        cssClass: 'dispatch-time time',
+      }),
+    },
+    {
+      header: new LogHeader({
+        name: 'Duration',
+        cssClass: 'duration right-align',
+      }),
+    },
+    {
+      header: new LogHeader(
+        {name: 'Handler', cssClass: 'handler'},
+        new LogSelectFilter(Array.from({length: 3}, () => '')),
+      ),
+      options: [
+        'N/A',
+        'com.android.wm.shell.recents.RecentsTransitionHandler',
+        'com.android.wm.shell.transition.DefaultMixedHandler',
+      ],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Participants', cssClass: 'participants'},
+        new LogSelectFilter(
+          Array.from({length: 12}, () => ''),
+          true,
+          '250',
+          '100%',
+        ),
+      ),
+      options: [
+        '47',
+        '67',
+        '398',
+        '471',
+        '472',
+        '489',
+        '0xc3df4d',
+        '0x5ba3da0',
+        '0x97b5518',
+        '0xa884527',
+        '0xb887160',
+        '0xc5f6ee4',
+      ],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Flags', cssClass: 'flags'},
+        new LogSelectFilter(
+          Array.from({length: 2}, () => ''),
+          true,
+          '250',
+          '100%',
+        ),
+      ),
+      options: ['TRANSIT_FLAG_IS_RECENTS', '0'],
+    },
+    {
+      header: new LogHeader(
+        {name: 'Status', cssClass: 'status right-align'},
+        new LogSelectFilter(Array.from({length: 3}, () => '')),
+      ),
+      options: ['MERGED', 'N/A', 'PLAYED'],
+    },
+  ];
   private trace: Trace<PropertyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
-  private secondPositionUpdate: TracePositionUpdate | undefined;
-
-  override readonly shouldExecuteHeaderTests = true;
-  override readonly shouldExecuteFilterTests = false;
-  override readonly shouldExecutePropertiesTests = true;
-
-  override readonly totalOutputEntries = 4;
-  override readonly expectedIndexOfFirstPositionUpdate = 3;
-  override readonly expectedIndexOfSecondPositionUpdate = 1;
-  override readonly logEntryClickIndex = 2;
 
   override async setUpTestEnvironment(): Promise<void> {
     const parser = await UnitTestUtils.getPerfettoParser(
@@ -60,9 +135,6 @@ class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
     this.positionUpdate = TracePositionUpdate.fromTraceEntry(
       this.trace.getEntry(0),
     );
-    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
-      this.trace.getEntry(2),
-    );
   }
 
   override async createPresenterWithEmptyTrace(
@@ -72,7 +144,7 @@ class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
       .setEntries(TraceType.TRANSITION, [])
       .build();
     const trace = assertDefined(traces.getTrace(TraceType.TRANSITION));
-    return new Presenter(trace, traces, callback);
+    return new Presenter(trace, traces, new InMemoryStorage(), callback);
   }
 
   override async createPresenter(
@@ -84,7 +156,12 @@ class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
     const traces = new Traces();
     traces.addTrace(transitionTrace);
 
-    const presenter = new Presenter(transitionTrace, traces, callback);
+    const presenter = new Presenter(
+      transitionTrace,
+      traces,
+      new InMemoryStorage(),
+      callback,
+    );
     await presenter.onAppEvent(positionUpdate); // trigger initialization
     return presenter;
   }
@@ -93,10 +170,6 @@ class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
     return assertDefined(this.positionUpdate);
   }
 
-  override getSecondPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.secondPositionUpdate);
-  }
-
   override executePropertiesChecksAfterPositionUpdate(uiData: UiDataLog) {
     expect(uiData.entries.length).toEqual(4);
 
@@ -107,6 +180,9 @@ class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
     expect(wmData.getChildByName('createTimeNs')?.formattedValue()).toEqual(
       '2023-11-21, 13:30:33.176',
     );
+
+    const dispatchTime = uiData.entries[0].fields[3];
+    expect(dispatchTime?.propagateEntryTimestamp).toBeTrue();
   }
 
   override executeSpecializedTests() {
diff --git a/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_directive.ts b/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_directive.ts
new file mode 100644
index 000000000..d594f5fb8
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_directive.ts
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {VIRTUAL_SCROLL_STRATEGY} from '@angular/cdk/scrolling';
+import {Directive, forwardRef} from '@angular/core';
+import {VariableHeightScrollDirective} from 'viewers/common/variable_height_scroll_directive';
+import {TransitionsEntry} from 'viewers/viewer_transitions/ui_data';
+import {TransitionsScrollStrategy} from './transitions_scroll_strategy';
+
+@Directive({
+  selector: '[transitionsVirtualScroll]',
+  providers: [
+    {
+      provide: VIRTUAL_SCROLL_STRATEGY,
+      useFactory: (dir: TransitionsScrollDirective) => dir.scrollStrategy,
+      deps: [forwardRef(() => TransitionsScrollDirective)],
+    },
+  ],
+})
+export class TransitionsScrollDirective extends VariableHeightScrollDirective<TransitionsEntry> {
+  scrollStrategy = new TransitionsScrollStrategy();
+}
diff --git a/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_strategy.ts b/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_strategy.ts
new file mode 100644
index 000000000..ac6c89ef9
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_transitions/scroll_strategy/transitions_scroll_strategy.ts
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {VariableHeightScrollStrategy} from 'viewers/common/variable_height_scroll_strategy';
+import {TransitionsEntry} from 'viewers/viewer_transitions/ui_data';
+
+export class TransitionsScrollStrategy extends VariableHeightScrollStrategy {
+  protected readonly defaultRowSize = 36;
+  private readonly participantsCharsPerRow = 25;
+  private readonly timestampCharsPerRow = 20;
+
+  protected override predictScrollItemHeight(entry: TransitionsEntry): number {
+    const participantsHeight = this.subItemHeight(
+      entry.fields[6].value as string,
+      this.participantsCharsPerRow,
+    );
+    const timestampHeight = this.subItemHeight(
+      entry.traceEntry.getTimestamp().format(),
+      this.timestampCharsPerRow,
+    );
+    return Math.max(participantsHeight, timestampHeight);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_transitions/ui_data.ts b/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
index 91b44d457..d18f41531 100644
--- a/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
@@ -16,17 +16,18 @@
 
 import {TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from 'viewers/common/text_filter';
 import {
   LogEntry,
   LogField,
-  LogFieldType,
+  LogHeader,
   UiDataLog,
 } from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 
 export class UiData implements UiDataLog {
   constructor(
-    public headers: LogFieldType[],
+    public headers: LogHeader[],
     public entries: LogEntry[],
     public currentIndex: undefined | number,
     public selectedIndex: undefined | number,
@@ -34,6 +35,8 @@ export class UiData implements UiDataLog {
     public propertiesTree: undefined | UiPropertyTreeNode,
   ) {}
 
+  propertiesFilter = new TextFilter();
+
   static createEmpty(): UiData {
     return new UiData([], [], undefined, undefined, undefined, undefined);
   }
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
index fb3a12e7d..05074128e 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
@@ -13,6 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
@@ -32,17 +33,17 @@ export class ViewerTransitions implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(trace: Trace<PropertyTreeNode>, traces: Traces) {
+  constructor(trace: Trace<PropertyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-transitions');
     const notifyViewCallback = (data: UiData) => {
       (this.htmlElement as any).inputData = data;
     };
-    this.presenter = new Presenter(trace, traces, notifyViewCallback);
+    this.presenter = new Presenter(trace, traces, storage, notifyViewCallback);
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.TRANSITION].name,
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
index f890fbac8..1447a0107 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
@@ -18,7 +18,7 @@ import {Component, Input, ViewChild} from '@angular/core';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {LogComponent} from 'viewers/common/log_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {selectedElementStyle} from 'viewers/components/styles/selected_element.styles';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
@@ -48,11 +48,11 @@ import {UiData} from './ui_data';
       <properties-view
         class="properties-view"
         [title]="propertiesTitle"
-        [showFilter]="false"
         [propertiesTree]="inputData?.propertiesTree"
         [traceType]="${TraceType.TRANSITION}"
+        [textFilter]="inputData?.propertiesFilter"
         [isProtoDump]="false"
-        placeholderText="No selected transition."
+        placeholderText="No current or selected transition."
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"
         [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES)"></properties-view>
     </div>
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
index 0371a938b..47ca95b73 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
@@ -13,43 +13,57 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 import {ClipboardModule} from '@angular/cdk/clipboard';
-import {ScrollingModule} from '@angular/cdk/scrolling';
+import {
+  CdkVirtualScrollViewport,
+  ScrollingModule,
+} from '@angular/cdk/scrolling';
 import {
   ComponentFixture,
   ComponentFixtureAutoDetect,
   TestBed,
 } from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
 import {MatDividerModule} from '@angular/material/divider';
+import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
+import {MatSelectModule} from '@angular/material/select';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Trace, TraceEntry} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {LogComponent} from 'viewers/common/log_component';
-import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {LogSelectFilter} from 'viewers/common/log_filters';
+import {executeScrollComponentTests} from 'viewers/common/scroll_component_tests';
+import {LogHeader} from 'viewers/common/ui_data_log';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {LogComponent} from 'viewers/components/log_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
 import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
+import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {TreeComponent} from 'viewers/components/tree_component';
 import {TreeNodeComponent} from 'viewers/components/tree_node_component';
-import {Presenter} from './presenter';
-import {TransitionsEntry, TransitionStatus, UiData} from './ui_data';
+import {TransitionsScrollDirective} from './scroll_strategy/transitions_scroll_directive';
+import {TransitionsEntry, UiData} from './ui_data';
 import {ViewerTransitionsComponent} from './viewer_transitions_component';
 
 describe('ViewerTransitionsComponent', () => {
-  let fixture: ComponentFixture<ViewerTransitionsComponent>;
-  let component: ViewerTransitionsComponent;
-  let htmlElement: HTMLElement;
-
+  const testSpec = {name: 'Test Column', cssClass: 'test-class'};
+  const testField = {spec: testSpec, value: 'VALUE'};
   let transitionTree: PropertyTreeNode;
   let trace: Trace<PropertyTreeNode>;
   let entry: TraceEntry<PropertyTreeNode>;
+  let fixture: ComponentFixture<ViewerTransitionsComponent>;
+  let component: ViewerTransitionsComponent;
+  let htmlElement: HTMLElement;
 
   beforeAll(() => {
     transitionTree = new PropertyTreeBuilder()
@@ -58,13 +72,83 @@ describe('ViewerTransitionsComponent', () => {
       .setName('transition')
       .build();
     trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSITION)
       .setEntries([transitionTree])
       .setTimestamps([TimestampConverterUtils.makeElapsedTimestamp(20n)])
       .build();
     entry = trace.getEntry(0);
   });
 
-  beforeEach(async () => {
+  describe('Main component', () => {
+    beforeEach(async () => {
+      await setUpTestEnvironment();
+    });
+
+    it('can be created', () => {
+      expect(component).toBeTruthy();
+    });
+
+    it('renders headers with filters', () => {
+      expect(
+        htmlElement.querySelector(
+          `.headers .filter.${testSpec.cssClass.split(' ')[0]}`,
+        ),
+      ).toBeTruthy();
+    });
+
+    it('renders entries with field values and no trace timestamp', () => {
+      expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+      const entry = assertDefined(
+        htmlElement.querySelector(
+          `.scroll .entry .${testSpec.cssClass.split(' ')[0]}`,
+        ),
+      );
+      expect(entry.textContent).toContain('VALUE');
+      expect(htmlElement.querySelector('.scroll .entry .time')).toBeNull();
+    });
+
+    it('hides go to current time button', () => {
+      expect(htmlElement.querySelector('.go-to-current-time')).toBeNull();
+    });
+
+    it('renders properties', () => {
+      expect(htmlElement.querySelector('.properties-view')).toBeTruthy();
+    });
+
+    it('shows message when no transition is selected', () => {
+      assertDefined(component.inputData).propertiesTree = undefined;
+      fixture.detectChanges();
+      expect(
+        htmlElement.querySelector('.properties-view .placeholder-text')
+          ?.innerHTML,
+      ).toContain('No current or selected transition');
+    });
+
+    it('creates collapsed sections with no buttons', () => {
+      UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
+    });
+
+    it('handles properties section collapse/expand', () => {
+      UnitTestUtils.checkSectionCollapseAndExpand(
+        htmlElement,
+        fixture,
+        '.properties-view',
+        'SELECTED TRANSITION',
+      );
+    });
+  });
+
+  describe('Scroll component', () => {
+    executeScrollComponentTests(setUpTestEnvironment);
+  });
+
+  async function setUpTestEnvironment(): Promise<
+    [
+      ComponentFixture<ViewerTransitionsComponent>,
+      HTMLElement,
+      CdkVirtualScrollViewport,
+    ]
+  > {
     await TestBed.configureTestingModule({
       providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
       imports: [
@@ -72,6 +156,12 @@ describe('ViewerTransitionsComponent', () => {
         ScrollingModule,
         MatIconModule,
         ClipboardModule,
+        MatFormFieldModule,
+        MatButtonModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        FormsModule,
+        MatSelectModule,
       ],
       declarations: [
         ViewerTransitionsComponent,
@@ -82,121 +172,48 @@ describe('ViewerTransitionsComponent', () => {
         CollapsedSectionsComponent,
         CollapsibleSectionTitleComponent,
         LogComponent,
+        SearchBoxComponent,
+        TransitionsScrollDirective,
+        SelectWithFilterComponent,
       ],
-      schemas: [],
     }).compileComponents();
-
     fixture = TestBed.createComponent(ViewerTransitionsComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
-
     component.inputData = makeUiData();
     fixture.detectChanges();
-  });
-
-  it('can be created', () => {
-    expect(component).toBeTruthy();
-  });
-
-  it('renders entries', () => {
-    expect(htmlElement.querySelector('.scroll')).toBeTruthy();
-
-    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
-    expect(entry.innerHTML).toContain('TO_FRONT');
-    expect(entry.innerHTML).toContain('10ns');
-  });
-
-  it('shows message when no transition is selected', () => {
-    assertDefined(component.inputData).propertiesTree = undefined;
-    fixture.detectChanges();
-    expect(
-      htmlElement.querySelector('.properties-view .placeholder-text')
-        ?.innerHTML,
-    ).toContain('No selected transition');
-  });
-
-  it('creates collapsed sections with no buttons', () => {
-    UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
-  });
-
-  it('handles properties section collapse/expand', () => {
-    UnitTestUtils.checkSectionCollapseAndExpand(
-      htmlElement,
-      fixture,
-      '.properties-view',
-      'SELECTED TRANSITION',
-    );
-  });
+    const viewport = assertDefined(component.logComponent?.scrollComponent);
+    return [fixture, htmlElement, viewport];
+  }
 
   function makeUiData(): UiData {
-    let mockTransitionIdCounter = 0;
-
-    const transitions = [
-      createMockTransition(entry, 20, 30, mockTransitionIdCounter++),
-      createMockTransition(
-        entry,
-        42,
-        50,
-        mockTransitionIdCounter++,
-        TransitionStatus.MERGED,
-      ),
-      createMockTransition(entry, 46, 49, mockTransitionIdCounter++),
-      createMockTransition(
-        entry,
-        58,
-        70,
-        mockTransitionIdCounter++,
-        TransitionStatus.ABORTED,
-      ),
-    ];
-
+    const transitions = [];
+    for (let i = 0; i < 200; i++) {
+      transitions.push(createMockTransition(entry, i));
+    }
     const uiData = UiData.createEmpty();
+    uiData.headers = [new LogHeader(testSpec, new LogSelectFilter([]))];
     uiData.entries = transitions;
     uiData.selectedIndex = 0;
-    uiData.headers = Presenter.FIELD_TYPES;
     return uiData;
   }
 
   function createMockTransition(
     entry: TraceEntry<PropertyTreeNode>,
-    sendTimeNanos: number,
-    finishTimeNanos: number,
-    id: number,
-    status = TransitionStatus.PLAYED,
+    i: number,
   ): TransitionsEntry {
-    const fields: LogField[] = [
-      {
-        type: LogFieldType.TRANSITION_ID,
-        value: id,
-      },
-      {
-        type: LogFieldType.TRANSITION_TYPE,
-        value: 'TO_FRONT',
-      },
-      {
-        type: LogFieldType.SEND_TIME,
-        value: TimestampConverterUtils.makeElapsedTimestamp(
-          BigInt(sendTimeNanos),
-        ),
-      },
-      {
-        type: LogFieldType.DISPATCH_TIME,
-        value: TimestampConverterUtils.makeElapsedTimestamp(
-          BigInt(sendTimeNanos) + 5n,
-        ),
-      },
-      {
-        type: LogFieldType.DURATION,
-        value: (finishTimeNanos - sendTimeNanos).toString() + 'ns',
-      },
-      {
-        type: LogFieldType.STATUS,
-        value: status,
-        icon: 'check',
-        iconColor: 'green',
-      },
-    ];
-
-    return new TransitionsEntry(entry, fields, transitionTree);
+    return new TransitionsEntry(
+      entry,
+      [
+        testField,
+        testField,
+        testField,
+        testField,
+        testField,
+        testField,
+        {spec: testSpec, value: i % 2 === 0 ? 'VALUE' : 'VALUE'.repeat(40)},
+      ],
+      transitionTree,
+    );
   }
 });
diff --git a/tools/winscope/src/viewers/viewer_view_capture/presenter.ts b/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
index 14d30af09..141e7e22b 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
@@ -19,8 +19,7 @@ import {PersistentStoreProxy} from 'common/persistent_store_proxy';
 import {Store} from 'common/store';
 import {
   TabbedViewSwitchRequest,
-  WinscopeEvent,
-  WinscopeEventType,
+  TracePositionUpdate,
 } from 'messaging/winscope_event';
 import {CustomQueryType} from 'trace/custom_query';
 import {Trace} from 'trace/trace';
@@ -71,11 +70,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'VcHierarchyFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
     false,
     true,
@@ -116,20 +111,14 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
         showDefaults: {
           name: 'Show defaults',
           enabled: false,
-          tooltip: `
-              If checked, shows the value of all properties.
-              Otherwise, hides all properties whose value is
-              the default for its data type.
-            `,
+          tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
         },
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'VcPropertiesFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
   );
   protected override readonly multiTraceType = TraceType.VIEW_CAPTURE;
@@ -164,46 +153,6 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     return this.viewCaptureTraces;
   }
 
-  getViewCaptureTraceFromId(id: number): Trace<HierarchyTreeNode> {
-    return assertDefined(this.viewCaptureTraces[id]);
-  }
-
-  override async onAppEvent(event: WinscopeEvent) {
-    await this.handleCommonWinscopeEvents(event);
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.initializeIfNeeded();
-        await this.applyTracePositionUpdate(event);
-
-        if (this.uiData && this.surfaceFlingerTrace) {
-          const surfaceFlingerEntry =
-            (await TraceEntryFinder.findCorrespondingEntry(
-              this.surfaceFlingerTrace,
-              event.position,
-            )?.getValue()) as HierarchyTreeNode;
-          if (surfaceFlingerEntry) {
-            this.sfRects = UI_RECT_FACTORY.makeUiRects(
-              surfaceFlingerEntry,
-              this.viewCapturePackageNames,
-            );
-          }
-        }
-        this.updateCuratedProperties();
-        this.refreshUIData();
-      },
-    );
-    await event.visit(
-      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
-      async (event) => {
-        const filterPresetName = event.name;
-        await this.applyPresetConfig(filterPresetName);
-        this.updateCuratedProperties();
-        this.refreshUIData();
-      },
-    );
-  }
-
   override async onHighlightedNodeChange(node: UiHierarchyTreeNode) {
     await this.applyHighlightedNodeChange(node);
     this.updateCuratedProperties();
@@ -220,15 +169,40 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     return undefined;
   }
 
-  protected override keepCalculated(): boolean {
-    return true;
+  protected override keepCalculated(node: UiHierarchyTreeNode): boolean {
+    return node.isRoot();
   }
 
-  private async initializeIfNeeded() {
+  protected override async initializeIfNeeded() {
     await this.initializePackageNamesIfNeeded();
     await this.initializeWindowsIfNeeded();
   }
 
+  protected override async processDataAfterPositionUpdate(
+    event: TracePositionUpdate,
+  ): Promise<void> {
+    if (this.uiData && this.surfaceFlingerTrace) {
+      const surfaceFlingerEntry =
+        (await TraceEntryFinder.findCorrespondingEntry(
+          this.surfaceFlingerTrace,
+          event.position,
+        )?.getValue()) as HierarchyTreeNode;
+      if (surfaceFlingerEntry) {
+        this.sfRects = UI_RECT_FACTORY.makeUiRects(
+          surfaceFlingerEntry,
+          this.viewCapturePackageNames,
+        );
+      }
+    }
+    this.updateCuratedProperties();
+  }
+
+  protected override refreshUIData() {
+    this.uiData.sfRects = this.sfRects;
+    this.uiData.curatedProperties = this.curatedProperties;
+    this.refreshHierarchyViewerUiData();
+  }
+
   private async initializePackageNamesIfNeeded() {
     if (this.viewCapturePackageNames.length > 0) {
       return;
@@ -331,10 +305,4 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     assertTrue(index !== -1);
     return index;
   }
-
-  private refreshUIData() {
-    this.uiData.sfRects = this.sfRects;
-    this.uiData.curatedProperties = this.curatedProperties;
-    this.refreshHierarchyViewerUiData();
-  }
 }
diff --git a/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts b/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
index 10ff5392b..ee4625457 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
@@ -15,10 +15,12 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {Store} from 'common/store';
-import {TracePositionUpdate} from 'messaging/winscope_event';
+import {
+  TabbedViewSwitchRequest,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CustomQueryType} from 'trace/custom_query';
@@ -29,8 +31,7 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
-import {DiffType} from 'viewers/common/diff_type';
-import {TextFilter} from 'viewers/common/text_filter';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
@@ -41,29 +42,58 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
   private traces: Traces | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
   private secondPositionUpdate: TracePositionUpdate | undefined;
-  private diffPositionUpdate: TracePositionUpdate | undefined;
   private selectedTree: UiHierarchyTreeNode | undefined;
 
-  override readonly shouldExecuteFlatTreeTest = false;
   override readonly shouldExecuteRectTests = true;
-  override readonly shouldExecuteShowDiffTests = true;
-  override readonly shouldExecuteDumpTests = false;
   override readonly shouldExecuteSimplifyNamesTest = true;
+  override readonly keepCalculatedPropertiesInChild = false;
+  override readonly keepCalculatedPropertiesInRoot = true;
+  override readonly expectedHierarchyOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+    simplifyNames: {
+      name: 'Simplify names',
+      enabled: true,
+    },
+  };
+  override readonly expectedPropertiesOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showDefaults: {
+      name: 'Show defaults',
+      enabled: false,
+      tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
+    },
+  };
+  override readonly expectedRectsOpts = {
+    ignoreRectShowState: {
+      name: 'Ignore',
+      icon: 'visibility',
+      enabled: false,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+  };
 
-  override readonly numberOfDefaultProperties = 3;
-  override readonly numberOfNonDefaultProperties = 15;
-  override readonly expectedFirstRect = new Rect(0, 0, 1080, 249);
-  override readonly propertiesFilter = new TextFilter('alpha', []);
-  override readonly expectedTotalRects = 13;
-  override readonly expectedVisibleRects = 5;
   override readonly treeNodeLongName =
     'com.android.launcher3.taskbar.TaskbarView@80213537';
   override readonly treeNodeShortName = 'TaskbarView@80213537';
-  override readonly numberOfFilteredProperties = 1;
-  override readonly hierarchyFilter = new TextFilter('BubbleBarView', []);
-  override readonly expectedHierarchyChildrenAfterStringFilter = 1;
-  override readonly propertyWithDiff = 'translationY';
-  override readonly expectedPropertyDiffType = DiffType.MODIFIED;
 
   override async setUpTestEnvironment(): Promise<void> {
     const parsers = (await UnitTestUtils.getParsers(
@@ -92,17 +122,15 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
     const firstEntryDataTree = await firstEntry.getValue();
     this.selectedTree = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(
-          UiTreeUtils.makeIdMatchFilter(
-            'ViewNode com.android.launcher3.taskbar.TaskbarView@80213537',
-          ),
-        ),
+        firstEntryDataTree
+          .findDfs(
+            UiTreeUtils.makeIdMatchFilter(
+              'ViewNode com.android.launcher3.taskbar.TaskbarView@80213537',
+            ),
+          )
+          ?.getParent(),
       ),
-    );
-
-    this.diffPositionUpdate = TracePositionUpdate.fromTraceEntry(
-      traceTaskbar.getEntry(21),
-    );
+    ).getChildByName('com.android.launcher3.taskbar.TaskbarView@80213537');
   }
 
   override createPresenterWithEmptyTrace(
@@ -121,23 +149,6 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
     return new Presenter(traces, new InMemoryStorage(), callback);
   }
 
-  override createPresenterWithCorruptedTrace(
-    callback: NotifyHierarchyViewCallbackType<UiData>,
-  ): Presenter {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(TraceType.VIEW_CAPTURE)
-      .setEntries([assertDefined(this.selectedTree)])
-      .setParserCustomQueryResult(CustomQueryType.VIEW_CAPTURE_METADATA, {
-        packageName: 'the_package_name',
-        windowName: 'the_window_name',
-      })
-      .setIsCorrupted(true)
-      .build();
-    const traces = new Traces();
-    traces.addTrace(trace);
-    return new Presenter(traces, new InMemoryStorage(), callback);
-  }
-
   override createPresenter(
     callback: NotifyHierarchyViewCallbackType<UiData>,
     storage: Store,
@@ -153,30 +164,6 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
     return assertDefined(this.secondPositionUpdate);
   }
 
-  override getShowDiffPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.diffPositionUpdate);
-  }
-
-  override getExpectedChildrenBeforeVisibilityFilter(): number {
-    return this.numberOfNestedChildren;
-  }
-
-  override getExpectedChildrenAfterVisibilityFilter(): number {
-    return this.numberOfVisibleChildren;
-  }
-
-  override getExpectedHierarchyChildrenBeforeStringFilter(): number {
-    return this.numberOfNestedChildren;
-  }
-
-  override executeSpecializedChecksForPropertiesFromNode(
-    uiData: UiDataHierarchy,
-  ) {
-    expect(
-      assertDefined((uiData as UiData).curatedProperties).translationY,
-    ).toEqual('-0.633');
-  }
-
   override getSelectedTree(): UiHierarchyTreeNode {
     return assertDefined(this.selectedTree);
   }
@@ -185,9 +172,7 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
     return assertDefined(this.selectedTree);
   }
 
-  override executeChecksForPropertiesTreeAfterPositionUpdate(
-    uiData: UiDataHierarchy,
-  ) {
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiDataHierarchy) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
     expect(
       assertDefined(
@@ -198,16 +183,18 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
       {displayId: 0, groupId: 0, name: 'Taskbar', isActive: true},
       {displayId: 1, groupId: 1, name: 'PhoneWindow@25063d9', isActive: true},
     ]);
+    expect(
+      assertDefined((uiData as UiData).curatedProperties).translationY,
+    ).toEqual('-0.633');
   }
 
-  override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
+  override executePropertiesChecksAfterSecondPositionUpdate(
     uiData: UiDataHierarchy,
   ) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
+    expect(propertiesTree.getChildByName('translationY')).toBeUndefined();
     expect(
-      assertDefined(
-        propertiesTree.getChildByName('translationY'),
-      ).formattedValue(),
+      assertDefined((uiData as UiData).curatedProperties).translationY,
     ).toEqual('0');
   }
 
@@ -223,8 +210,105 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiDa
     expect(curatedProperties.willNotDraw).toEqual('false');
   }
 
-  private readonly numberOfVisibleChildren = 6;
-  private readonly numberOfNestedChildren = 16;
+  override executeSpecializedTests() {
+    describe('Specialized tests', () => {
+      let presenter: Presenter;
+      let uiData: UiData;
+
+      beforeAll(async () => {
+        await this.setUpTestEnvironment();
+      });
+
+      beforeEach(() => {
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        presenter = this.createPresenter(
+          notifyViewCallback as NotifyHierarchyViewCallbackType<UiData>,
+          new InMemoryStorage(),
+        );
+      });
+
+      it('exposes all VC traces', () => {
+        const traces = new Traces();
+        const vcTraces = [
+          UnitTestUtils.makeEmptyTrace(TraceType.VIEW_CAPTURE),
+          UnitTestUtils.makeEmptyTrace(TraceType.VIEW_CAPTURE),
+        ];
+        vcTraces.forEach((trace) => traces.addTrace(trace));
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        const presenter = new Presenter(
+          traces,
+          new InMemoryStorage(),
+          notifyViewCallback,
+        );
+        expect(presenter.getTraces()).toEqual(vcTraces);
+      });
+
+      it('extracts rects from SF trace', async () => {
+        const sfTrace = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.SURFACE_FLINGER)
+          .setEntries([await UnitTestUtils.getLayerTraceEntry(0)])
+          .build();
+        const presenter = createPresenterWithSfTrace(
+          assertDefined(this.traces),
+          sfTrace,
+        );
+        await presenter.onAppEvent(assertDefined(this.positionUpdate));
+        expect(assertDefined(uiData.sfRects).length).toBeGreaterThan(0);
+      });
+
+      it('handles double click if SF trace present', async () => {
+        const sfTrace = UnitTestUtils.makeEmptyTrace(TraceType.SURFACE_FLINGER);
+        const presenter = createPresenterWithSfTrace(
+          assertDefined(this.traces),
+          sfTrace,
+        );
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+
+        await presenter.onMiniRectsDoubleClick();
+        expect(spy).toHaveBeenCalledOnceWith(
+          new TabbedViewSwitchRequest(sfTrace),
+        );
+      });
+
+      it('robust to double click if SF trace not present', async () => {
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+        await presenter.onMiniRectsDoubleClick();
+        expect(spy).not.toHaveBeenCalled();
+      });
+
+      it('clears curated properties on position update if no properties tree found', async () => {
+        await presenter.onAppEvent(assertDefined(this.secondPositionUpdate));
+        const nodeName = 'com.android.internal.policy.DecorView@220010144';
+        await presenter.onHighlightedIdChange(nodeName);
+        expect(uiData.propertiesTree).toBeDefined();
+        expect(uiData.curatedProperties).toBeDefined();
+
+        await presenter.onAppEvent(assertDefined(this.positionUpdate));
+        expect(uiData.propertiesTree).toBeUndefined();
+        expect(uiData.curatedProperties).toBeUndefined();
+      });
+
+      function createPresenterWithSfTrace(
+        vcTraces: Traces,
+        sfTrace: Trace<HierarchyTreeNode>,
+      ): Presenter {
+        const traces = new Traces();
+        vcTraces.forEachTrace((trace) => traces.addTrace(trace));
+        traces.addTrace(sfTrace);
+
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        return new Presenter(traces, new InMemoryStorage(), notifyViewCallback);
+      }
+    });
+  }
 }
 
 describe('PresenterViewCapture', () => {
diff --git a/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts b/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
index 39e24c9b3..e37fb1a3b 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
@@ -32,8 +32,8 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
-  hierarchyFilter = new TextFilter('', []);
-  propertiesFilter = new TextFilter('', []);
+  hierarchyFilter = new TextFilter();
+  propertiesFilter = new TextFilter();
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
diff --git a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
index fc9c7de2f..ac6a1d5e8 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
@@ -14,7 +14,6 @@
  * limitations under the License.
  */
 
-import {FunctionUtils} from 'common/function_utils';
 import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
@@ -31,14 +30,11 @@ import {UiData} from './ui_data';
 export class ViewerViewCapture implements Viewer {
   static readonly DEPENDENCIES: TraceType[] = [TraceType.VIEW_CAPTURE];
 
-  private readonly traces: Traces;
   private readonly htmlElement: HTMLElement;
   private readonly presenter: Presenter;
   private readonly view: View;
-  private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
 
   constructor(traces: Traces, storage: Store) {
-    this.traces = traces;
     this.htmlElement = document.createElement('viewer-view-capture');
     const notifyViewCallback = (uiData: UiData) => {
       (this.htmlElement as any).inputData = uiData;
@@ -54,7 +50,7 @@ export class ViewerViewCapture implements Viewer {
     );
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.VIEW_CAPTURE].name,
diff --git a/tools/winscope/src/viewers/viewer_window_manager/presenter.ts b/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
index 1ffd4dfd0..e308b40ce 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
@@ -16,7 +16,6 @@
 
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
 import {Store} from 'common/store';
-import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
@@ -71,11 +70,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'WmHierarchyFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
     true,
     false,
@@ -115,20 +110,14 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
         showDefaults: {
           name: 'Show defaults',
           enabled: false,
-          tooltip: `
-                If checked, shows the value of all properties.
-                Otherwise, hides all properties whose value is
-                the default for its data type.
-              `,
+          tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
         },
       },
       this.storage,
     ),
-    PersistentStoreProxy.new<TextFilter>(
-      'WmPropertiesFilter',
-      new TextFilter('', []),
-      this.storage,
-    ),
+    new TextFilter(),
     Presenter.DENYLIST_PROPERTY_NAMES,
   );
   protected override multiTraceType = undefined;
@@ -142,25 +131,6 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     super(trace, traces, storage, notifyViewCallback, new UiData());
   }
 
-  override async onAppEvent(event: WinscopeEvent) {
-    await this.handleCommonWinscopeEvents(event);
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.applyTracePositionUpdate(event);
-        this.refreshUIData();
-      },
-    );
-    await event.visit(
-      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
-      async (event) => {
-        const filterPresetName = event.name;
-        await this.applyPresetConfig(filterPresetName);
-        this.refreshUIData();
-      },
-    );
-  }
-
   override async onHighlightedNodeChange(item: UiHierarchyTreeNode) {
     await this.applyHighlightedNodeChange(item);
     this.refreshUIData();
@@ -183,7 +153,11 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
   }
 
   protected override keepCalculated(tree: HierarchyTreeNode): boolean {
-    return tree.isRoot();
+    return false;
+  }
+
+  protected override refreshUIData() {
+    this.refreshHierarchyViewerUiData();
   }
 
   private getDisplays(rects: UiRect[]): DisplayIdentifier[] {
@@ -205,8 +179,4 @@ export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
     const parts = id.split(' ');
     return parts.slice(2).join(' ');
   }
-
-  private refreshUIData() {
-    this.refreshHierarchyViewerUiData();
-  }
 }
diff --git a/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts b/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
index ec392d0c8..3e9a83fb1 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
@@ -15,7 +15,6 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {Store} from 'common/store';
 import {TracePositionUpdate} from 'messaging/winscope_event';
@@ -27,7 +26,7 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
-import {DiffType} from 'viewers/common/diff_type';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
 import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
@@ -41,31 +40,61 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
   private selectedTree: UiHierarchyTreeNode | undefined;
   private selectedTreeAfterPositionUpdate: UiHierarchyTreeNode | undefined;
 
-  override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = true;
-  override readonly shouldExecuteShowDiffTests = true;
-  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = true;
+  override readonly keepCalculatedPropertiesInChild = false;
+  override readonly keepCalculatedPropertiesInRoot = false;
+  override readonly expectedHierarchyOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+    simplifyNames: {
+      name: 'Simplify names',
+      enabled: true,
+    },
+    flat: {
+      name: 'Flat',
+      enabled: false,
+    },
+  };
+  override readonly expectedPropertiesOpts = {
+    showDiff: {
+      name: 'Show diff',
+      enabled: false,
+      isUnavailable: true,
+    },
+    showDefaults: {
+      name: 'Show defaults',
+      enabled: false,
+      tooltip: `If checked, shows the value of all properties.
+Otherwise, hides all properties whose value is
+the default for its data type.`,
+    },
+  };
+  override readonly expectedRectsOpts = {
+    ignoreRectShowState: {
+      name: 'Ignore',
+      icon: 'visibility',
+      enabled: false,
+    },
+    showOnlyVisible: {
+      name: 'Show only',
+      chip: VISIBLE_CHIP,
+      enabled: false,
+    },
+  };
 
-  override readonly numberOfDefaultProperties = 29;
-  override readonly numberOfNonDefaultProperties = 21;
-  override readonly expectedFirstRect = new Rect(0, 0, 1080, 2400);
-  override readonly propertiesFilter = new TextFilter('requested', []);
-  override readonly expectedTotalRects = 12;
-  override readonly expectedVisibleRects = 7;
   override readonly treeNodeLongName =
     'f7092ed com.google.android.apps.nexuslauncher/.NexusLauncherActivity';
   override readonly treeNodeShortName =
     'com.google.(...).NexusLauncherActivity';
-  override readonly numberOfFilteredProperties = 2;
-  override readonly hierarchyFilter = new TextFilter('ScreenDecor', []);
-  override readonly expectedHierarchyChildrenAfterStringFilter = 2;
-  override readonly propertyWithDiff = 'animator';
-  override readonly expectedPropertyDiffType = DiffType.ADDED;
-
-  private readonly numberOfFlattenedChildren = 68;
-  private readonly numberOfVisibleChildren = 6;
-  private readonly numberOfNestedChildren = 1;
 
   override async setUpTestEnvironment(): Promise<void> {
     this.trace = new TraceBuilder<HierarchyTreeNode>()
@@ -85,12 +114,20 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
     const firstEntryDataTree = await firstEntry.getValue();
     this.selectedTree = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(UiTreeUtils.makeNodeFilter('93d3f3c')),
+        firstEntryDataTree.findDfs(
+          UiTreeUtils.makeNodeFilter(
+            new TextFilter('93d3f3c').getFilterPredicate(),
+          ),
+        ),
       ),
     );
     this.selectedTreeAfterPositionUpdate = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(UiTreeUtils.makeNodeFilter('f7092ed')),
+        firstEntryDataTree.findDfs(
+          UiTreeUtils.makeNodeFilter(
+            new TextFilter('f7092ed').getFilterPredicate(),
+          ),
+        ),
       ),
     );
   }
@@ -98,23 +135,7 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
   override createPresenterWithEmptyTrace(
     callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(TraceType.WINDOW_MANAGER)
-      .setEntries([])
-      .build();
-    const traces = new Traces();
-    traces.addTrace(trace);
-    return new Presenter(trace, traces, new InMemoryStorage(), callback);
-  }
-
-  override createPresenterWithCorruptedTrace(
-    callback: NotifyHierarchyViewCallbackType<UiData>,
-  ): Presenter {
-    const trace = new TraceBuilder<HierarchyTreeNode>()
-      .setType(TraceType.WINDOW_MANAGER)
-      .setEntries([assertDefined(this.selectedTree)])
-      .setIsCorrupted(true)
-      .build();
+    const trace = UnitTestUtils.makeEmptyTrace(TraceType.WINDOW_MANAGER);
     const traces = new Traces();
     traces.addTrace(trace);
     return new Presenter(trace, traces, new InMemoryStorage(), callback);
@@ -138,30 +159,6 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
     return assertDefined(this.secondPositionUpdate);
   }
 
-  override getShowDiffPositionUpdate(): TracePositionUpdate {
-    return assertDefined(this.positionUpdate);
-  }
-
-  override getExpectedChildrenBeforeVisibilityFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedChildrenAfterVisibilityFilter(): number {
-    return this.numberOfVisibleChildren;
-  }
-
-  override getExpectedChildrenBeforeFlatFilter(): number {
-    return this.numberOfNestedChildren;
-  }
-
-  override getExpectedChildrenAfterFlatFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
-  override getExpectedHierarchyChildrenBeforeStringFilter(): number {
-    return this.numberOfFlattenedChildren;
-  }
-
   override getSelectedTree(): UiHierarchyTreeNode {
     return assertDefined(this.selectedTree);
   }
@@ -170,7 +167,7 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
     return assertDefined(this.selectedTreeAfterPositionUpdate);
   }
 
-  override executeChecksForPropertiesTreeAfterPositionUpdate(uiData: UiData) {
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiData) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
     expect(
       assertDefined(propertiesTree.getChildByName('state')).formattedValue(),
@@ -185,9 +182,12 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<Ui
     ]);
   }
 
-  override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
-    uiData: UiData,
-  ) {
+  override executeSpecializedChecksForPropertiesFromRect(uiData: UiData) {
+    const propertiesTree = assertDefined(uiData.propertiesTree);
+    expect(propertiesTree.getAllChildren().length).toEqual(10);
+  }
+
+  override executePropertiesChecksAfterSecondPositionUpdate(uiData: UiData) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
     expect(
       assertDefined(propertiesTree.getChildByName('state')).formattedValue(),
diff --git a/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts b/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
index d71c6ec59..bd528eae2 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
@@ -31,8 +31,8 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
-  hierarchyFilter = new TextFilter('', []);
-  propertiesFilter = new TextFilter('', []);
+  hierarchyFilter = new TextFilter();
+  propertiesFilter = new TextFilter();
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
diff --git a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
index 4f54f7232..1453196b1 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
@@ -44,7 +44,7 @@ export class ViewerWindowManager implements Viewer {
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
-      ViewType.TAB,
+      ViewType.TRACE_TAB,
       this.getTraces(),
       this.htmlElement,
       TRACE_INFO[TraceType.WINDOW_MANAGER].name,
diff --git a/treble/compare_bp_system_image.sh b/treble/compare_bp_system_image.sh
index d1fcdf49b..97abad01a 100755
--- a/treble/compare_bp_system_image.sh
+++ b/treble/compare_bp_system_image.sh
@@ -1,6 +1,6 @@
 #!/bin/bash
-echo "Note: Should run 'lunch aosp_cf_x86_64_only_phone-trunk_staging-userdebug && m aosp_cf_system_x86_64 && m' before running this script"
-bp_base_path=$ANDROID_BUILD_TOP/out/soong/.intermediates/device/google/cuttlefish/system_image/aosp_cf_system_x86_64/android_common
+echo "Note: Should run 'lunch aosp_cf_x86_64_phone-trunk_staging-userdebug && m' before running this script"
+bp_base_path=$ANDROID_BUILD_TOP/out/soong/.intermediates/build/make/target/product/generic/aosp_shared_system_image/android_common
 bp_path=$bp_base_path/root
 echo $OUT
 echo $bp_path
```

