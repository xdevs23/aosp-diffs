```diff
diff --git a/PREUPLOAD.cfg b/PREUPLOAD.cfg
index 67140f347..8cfd5cb31 100644
--- a/PREUPLOAD.cfg
+++ b/PREUPLOAD.cfg
@@ -4,9 +4,12 @@
 [Builtin Hooks]
 rustfmt = true
 ktfmt = true
+bpfmt = true
+clang_format = true
 
 [Builtin Hooks Options]
 ktfmt = --kotlinlang-style
+clang_format = --commit ${PREUPLOAD_COMMIT} --style file --extensions c,h,cc,cpp
 
 [Options]
 ignore_merged_commits = true
diff --git a/apps/Development/Android.bp b/apps/Development/Android.bp
index a291d7113..f8924c08e 100644
--- a/apps/Development/Android.bp
+++ b/apps/Development/Android.bp
@@ -23,7 +23,7 @@ android_app {
 
     libs: [
         "android.test.runner.stubs",
-        "org.apache.http.legacy",
+        "org.apache.http.legacy.stubs.system",
         "telephony-common",
     ],
 
diff --git a/apps/ShareTest/Android.bp b/apps/ShareTest/Android.bp
index 78b56169c..46207a1e7 100644
--- a/apps/ShareTest/Android.bp
+++ b/apps/ShareTest/Android.bp
@@ -23,7 +23,7 @@ android_app {
         "**/*.kt",
     ],
     asset_dirs: ["assets"],
-    sdk_version: "current",
+    sdk_version: "35",
     static_libs: [
         "androidx.core_core-ktx",
         "androidx.compose.runtime_runtime",
diff --git a/apps/ShareTest/res/layout/activity_main.xml b/apps/ShareTest/res/layout/activity_main.xml
index cb158ad23..059ea30d2 100644
--- a/apps/ShareTest/res/layout/activity_main.xml
+++ b/apps/ShareTest/res/layout/activity_main.xml
@@ -437,6 +437,19 @@
                 android:layout_height="wrap_content"
                 android:text="Include Caller Direct Target"
                 />
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                style="@style/subtitle"
+                android:text="Exclude Targets"
+                />
+            <CheckBox
+                android:id="@+id/exclude_self"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:text="Exclude self from targets (for Shareousel payload change: set for an odd number of items)"
+                />
         </LinearLayout>
     </ScrollView>
     <Button
diff --git a/apps/ShareTest/src/com/android/sharetest/AdditionalContentProvider.kt b/apps/ShareTest/src/com/android/sharetest/AdditionalContentProvider.kt
index 87a2dba04..fcc6077ac 100644
--- a/apps/ShareTest/src/com/android/sharetest/AdditionalContentProvider.kt
+++ b/apps/ShareTest/src/com/android/sharetest/AdditionalContentProvider.kt
@@ -1,5 +1,6 @@
 package com.android.sharetest
 
+import android.content.ComponentName
 import android.content.ContentProvider
 import android.content.ContentValues
 import android.content.Intent
@@ -27,19 +28,19 @@ class AdditionalContentProvider : ContentProvider() {
         val cursor = MatrixCursor(arrayOf(AdditionalContentContract.Columns.URI))
         val chooserIntent =
             queryArgs?.getParcelable(Intent.EXTRA_INTENT, Intent::class.java) ?: return cursor
-        val count = runCatching {
-            uri.getQueryParameter(PARAM_COUNT)?.toInt()
-        }.getOrNull() ?: ImageContentProvider.IMAGE_COUNT
-        val includeSize = runCatching {
-            uri.getQueryParameter(PARAM_SIZE_META).toBoolean()
-        }.getOrDefault(true)
-        val mimeTypes = kotlin.runCatching {
-            uri.getQueryParameters(PARAM_MIME_TYPE)
-        }.getOrNull() ?: listOf("image/jpeg")
+        val count =
+            runCatching { uri.getQueryParameter(PARAM_COUNT)?.toInt() }.getOrNull()
+                ?: ImageContentProvider.IMAGE_COUNT
+        val includeSize =
+            runCatching { uri.getQueryParameter(PARAM_SIZE_META).toBoolean() }.getOrDefault(true)
+        val mimeTypes =
+            kotlin.runCatching { uri.getQueryParameters(PARAM_MIME_TYPE) }.getOrNull()
+                ?: listOf("image/jpeg")
         // Images are img1 ... img8
-        val uris = Array(count) { idx ->
-            ImageContentProvider.makeItemUri(idx, mimeTypes[idx % mimeTypes.size], includeSize)
-        }
+        val uris =
+            Array(count) { idx ->
+                ImageContentProvider.makeItemUri(idx, mimeTypes[idx % mimeTypes.size], includeSize)
+            }
         val callingPackage = getCallingPackage()
         for (u in uris) {
             cursor.addRow(arrayOf(u.toString()))
@@ -48,11 +49,12 @@ class AdditionalContentProvider : ContentProvider() {
         val startPos = chooserIntent.getIntExtra(CURSOR_START_POSITION, -1)
         if (startPos >= 0) {
             var cursorExtras = cursor.extras
-            cursorExtras = if (cursorExtras == null) {
-                Bundle()
-            } else {
-                Bundle(cursorExtras)
-            }
+            cursorExtras =
+                if (cursorExtras == null) {
+                    Bundle()
+                } else {
+                    Bundle(cursorExtras)
+                }
             cursorExtras.putInt(AdditionalContentContract.CursorExtraKeys.POSITION, startPos)
             cursor.extras = cursorExtras
         }
@@ -78,22 +80,22 @@ class AdditionalContentProvider : ContentProvider() {
 
         // Update alternate intent if the chooser intent has one.
         if (chooserIntent.hasExtra(Intent.EXTRA_ALTERNATE_INTENTS)) {
-            chooserIntent.getParcelableExtra(Intent.EXTRA_INTENT, Intent::class.java)
-                ?.let { targetIntent ->
-                    result.putParcelableArray(
-                        Intent.EXTRA_ALTERNATE_INTENTS,
-                        arrayOf(createAlternateIntent(targetIntent))
-                    )
-                }
+            chooserIntent.getParcelableExtra(Intent.EXTRA_INTENT, Intent::class.java)?.let {
+                targetIntent ->
+                result.putParcelableArray(
+                    Intent.EXTRA_ALTERNATE_INTENTS,
+                    arrayOf(createAlternateIntent(targetIntent))
+                )
+            }
         }
 
         if (chooserIntent.hasExtra(Intent.EXTRA_CHOOSER_MODIFY_SHARE_ACTION)) {
             result.setModifyShareAction(
                 context,
-                chooserIntent.getParcelableExtra(
-                    Intent.EXTRA_INTENT,
-                    Intent::class.java
-                )?.extraStream?.size ?: -1
+                chooserIntent
+                    .getParcelableExtra(Intent.EXTRA_INTENT, Intent::class.java)
+                    ?.extraStream
+                    ?.size ?: -1
             )
         }
 
@@ -105,12 +107,10 @@ class AdditionalContentProvider : ContentProvider() {
                         context,
                         buildString {
                             append("Modified Caller Target. Shared URIs:")
-                            chooserIntent.getParcelableExtra(
-                                Intent.EXTRA_INTENT,
-                                Intent::class.java
-                            )?.extraStream?.forEach {
-                                append("\n * $it")
-                            }
+                            chooserIntent
+                                .getParcelableExtra(Intent.EXTRA_INTENT, Intent::class.java)
+                                ?.extraStream
+                                ?.forEach { append("\n * $it") }
                         }
                     )
                 )
@@ -124,6 +124,24 @@ class AdditionalContentProvider : ContentProvider() {
             )
         }
 
+        if (chooserIntent.hasExtra(Intent.EXTRA_EXCLUDE_COMPONENTS)) {
+            chooserIntent.getParcelableExtra(Intent.EXTRA_INTENT, Intent::class.java)?.let {
+                targetIntent ->
+                val excluded =
+                    if (targetIntent.extraStream.size % 2 == 0) {
+                        null
+                    } else {
+                        arrayOf(
+                            ComponentName(
+                                context.packageName,
+                                CallerDirectTargetActivity::class.java.name
+                            )
+                        )
+                    }
+                result.putParcelableArray(Intent.EXTRA_EXCLUDE_COMPONENTS, excluded)
+            }
+        }
+
         val latency = chooserIntent.getIntExtra(EXTRA_SELECTION_LATENCY, 0)
         if (latency > 0) {
             SystemClock.sleep(latency.toLong())
@@ -172,4 +190,3 @@ class AdditionalContentProvider : ContentProvider() {
         val PARAM_MIME_TYPE = "mimetype"
     }
 }
-
diff --git a/apps/ShareTest/src/com/android/sharetest/ShareTestActivity.kt b/apps/ShareTest/src/com/android/sharetest/ShareTestActivity.kt
index 42261b153..a43d52537 100644
--- a/apps/ShareTest/src/com/android/sharetest/ShareTestActivity.kt
+++ b/apps/ShareTest/src/com/android/sharetest/ShareTestActivity.kt
@@ -20,6 +20,7 @@ import android.app.Activity
 import android.app.PendingIntent
 import android.content.BroadcastReceiver
 import android.content.ClipData
+import android.content.ComponentName
 import android.content.Context
 import android.content.Intent
 import android.content.IntentFilter
@@ -74,6 +75,7 @@ class ShareTestActivity : Activity() {
     private lateinit var shareouselCheck: CheckBox
     private lateinit var altIntentCheck: CheckBox
     private lateinit var callerTargetCheck: CheckBox
+    private lateinit var excludeSelfCheck: CheckBox
     private lateinit var selectionLatencyGroup: RadioGroup
     private lateinit var imageSizeMetadataCheck: CheckBox
     private val customActionFactory = CustomActionFactory(this)
@@ -95,26 +97,29 @@ class ShareTestActivity : Activity() {
             WindowInsetsCompat.CONSUMED
         }
 
-        customActionReceiver = object : BroadcastReceiver() {
-            override fun onReceive(context: Context?, intent: Intent) {
-                Toast.makeText(
-                    this@ShareTestActivity,
-                    "Custom action invoked, isModified: ${!intent.isInitial}",
-                    Toast.LENGTH_LONG
-                )
-                    .show()
+        customActionReceiver =
+            object : BroadcastReceiver() {
+                override fun onReceive(context: Context?, intent: Intent) {
+                    Toast.makeText(
+                            this@ShareTestActivity,
+                            "Custom action invoked, isModified: ${!intent.isInitial}",
+                            Toast.LENGTH_LONG
+                        )
+                        .show()
+                }
             }
-        }
 
-        refinementReceiver = object : BroadcastReceiver() {
-            override fun onReceive(context: Context?, intent: Intent) {
-                // Need to show refinement in another activity because this one is beneath the
-                // sharesheet.
-                val activityIntent = Intent(this@ShareTestActivity, RefinementActivity::class.java)
-                activityIntent.putExtras(intent)
-                startActivity(activityIntent)
+        refinementReceiver =
+            object : BroadcastReceiver() {
+                override fun onReceive(context: Context?, intent: Intent) {
+                    // Need to show refinement in another activity because this one is beneath the
+                    // sharesheet.
+                    val activityIntent =
+                        Intent(this@ShareTestActivity, RefinementActivity::class.java)
+                    activityIntent.putExtras(intent)
+                    startActivity(activityIntent)
+                }
             }
-        }
 
         registerReceiver(
             customActionReceiver,
@@ -133,19 +138,20 @@ class ShareTestActivity : Activity() {
         shareouselCheck = requireViewById(R.id.shareousel)
         altIntentCheck = requireViewById(R.id.alt_intent)
         callerTargetCheck = requireViewById(R.id.caller_direct_target)
+        excludeSelfCheck = requireViewById(R.id.exclude_self)
         mediaTypeSelection = requireViewById(R.id.media_type_selection)
         mediaTypeHeader = requireViewById(R.id.media_type_header)
         selectionLatencyGroup = requireViewById(R.id.selection_latency)
         imageSizeMetadataCheck = requireViewById(R.id.image_size_metadata)
-        mediaSelection = requireViewById<RadioGroup>(R.id.media_selection).apply {
-            setOnCheckedChangeListener { _, id -> updateMediaTypesList(id) }
-            check(R.id.no_media)
-        }
+        mediaSelection =
+            requireViewById<RadioGroup>(R.id.media_selection).apply {
+                setOnCheckedChangeListener { _, id -> updateMediaTypesList(id) }
+                check(R.id.no_media)
+            }
         metadata = requireViewById(R.id.metadata)
 
-        textSelection = requireViewById<RadioGroup>(R.id.text_selection).apply {
-            check(R.id.short_text)
-        }
+        textSelection =
+            requireViewById<RadioGroup>(R.id.text_selection).apply { check(R.id.short_text) }
         requireViewById<RadioGroup>(R.id.action_selection).check(R.id.no_actions)
 
         requireViewById<Button>(R.id.share).setOnClickListener(this::share)
@@ -157,58 +163,58 @@ class ShareTestActivity : Activity() {
         }
 
         requireViewById<RadioGroup>(R.id.image_latency).setOnCheckedChangeListener { _, checkedId ->
-            ImageContentProvider.openLatency = when (checkedId) {
-                R.id.image_latency_50 -> 50
-                R.id.image_latency_200 -> 200
-                R.id.image_latency_800 -> 800
-                else -> 0
-            }
+            ImageContentProvider.openLatency =
+                when (checkedId) {
+                    R.id.image_latency_50 -> 50
+                    R.id.image_latency_200 -> 200
+                    R.id.image_latency_800 -> 800
+                    else -> 0
+                }
         }
         requireViewById<RadioGroup>(R.id.image_latency).check(R.id.image_latency_none)
 
         requireViewById<RadioGroup>(R.id.image_get_type_latency).setOnCheckedChangeListener {
-                _,
-                checkedId,
+            _,
+            checkedId,
             ->
-            ImageContentProvider.getTypeLatency = when (checkedId) {
-                R.id.image_get_type_latency_50 -> 50
-                R.id.image_get_type_latency_200 -> 200
-                R.id.image_get_type_latency_800 -> 800
-                else -> 0
-            }
+            ImageContentProvider.getTypeLatency =
+                when (checkedId) {
+                    R.id.image_get_type_latency_50 -> 50
+                    R.id.image_get_type_latency_200 -> 200
+                    R.id.image_get_type_latency_800 -> 800
+                    else -> 0
+                }
         }
-        requireViewById<RadioGroup>(R.id.image_get_type_latency).check(
-            R.id.image_get_type_latency_none
-        )
+        requireViewById<RadioGroup>(R.id.image_get_type_latency)
+            .check(R.id.image_get_type_latency_none)
 
         requireViewById<RadioGroup>(R.id.image_query_latency).let { radioGroup ->
-            radioGroup.setOnCheckedChangeListener {
-                    _,
-                    checkedId,
+            radioGroup.setOnCheckedChangeListener { _, checkedId,
                 ->
-                ImageContentProvider.queryLatency = when (checkedId) {
-                    R.id.image_query_latency_50 -> 50
-                    R.id.image_query_latency_200 -> 200
-                    R.id.image_query_latency_800 -> 800
-                    else -> 0
-                }
+                ImageContentProvider.queryLatency =
+                    when (checkedId) {
+                        R.id.image_query_latency_50 -> 50
+                        R.id.image_query_latency_200 -> 200
+                        R.id.image_query_latency_800 -> 800
+                        else -> 0
+                    }
             }
             radioGroup.check(R.id.image_query_latency_none)
         }
 
         requireViewById<RadioGroup>(R.id.image_load_failure_rate).setOnCheckedChangeListener {
-                _,
-                checkedId,
+            _,
+            checkedId,
             ->
-            ImageContentProvider.openFailureRate = when (checkedId) {
-                R.id.image_load_failure_rate_50 -> .5f
-                R.id.image_load_failure_rate_100 -> 1f
-                else -> 0f
-            }
+            ImageContentProvider.openFailureRate =
+                when (checkedId) {
+                    R.id.image_load_failure_rate_50 -> .5f
+                    R.id.image_load_failure_rate_100 -> 1f
+                    else -> 0f
+                }
         }
-        requireViewById<RadioGroup>(R.id.image_load_failure_rate).check(
-            R.id.image_load_failure_rate_none
-        )
+        requireViewById<RadioGroup>(R.id.image_load_failure_rate)
+            .check(R.id.image_load_failure_rate_none)
     }
 
     private fun updateMediaTypesList(id: Int) {
@@ -220,41 +226,40 @@ class ShareTestActivity : Activity() {
     }
 
     private fun removeMediaTypeOptions() {
-        mediaTypeSelection.adapter = ArrayAdapter(
-            this, android.R.layout.simple_spinner_item, emptyArray<String>()
-        ).apply {
-            setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
-        }
+        mediaTypeSelection.adapter =
+            ArrayAdapter(this, android.R.layout.simple_spinner_item, emptyArray<String>()).apply {
+                setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
+            }
         setMediaTypeVisibility(false)
     }
 
     private fun setSingleMediaTypeOptions() {
-        mediaTypeSelection.adapter = ArrayAdapter(
-            this,
-            android.R.layout.simple_spinner_item,
-            arrayOf(TYPE_IMAGE, TYPE_VIDEO, TYPE_PDF)
-        ).apply {
-            setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
-        }
+        mediaTypeSelection.adapter =
+            ArrayAdapter(
+                    this,
+                    android.R.layout.simple_spinner_item,
+                    arrayOf(TYPE_IMAGE, TYPE_VIDEO, TYPE_PDF)
+                )
+                .apply { setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item) }
         setMediaTypeVisibility(true)
     }
 
     private fun setAllMediaTypeOptions() {
-        mediaTypeSelection.adapter = ArrayAdapter(
-            this,
-            android.R.layout.simple_spinner_item,
-            arrayOf(
-                TYPE_IMAGE,
-                TYPE_VIDEO,
-                TYPE_PDF,
-                TYPE_IMG_VIDEO,
-                TYPE_IMG_PDF,
-                TYPE_VIDEO_PDF,
-                TYPE_ALL
-            )
-        ).apply {
-            setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)
-        }
+        mediaTypeSelection.adapter =
+            ArrayAdapter(
+                    this,
+                    android.R.layout.simple_spinner_item,
+                    arrayOf(
+                        TYPE_IMAGE,
+                        TYPE_VIDEO,
+                        TYPE_PDF,
+                        TYPE_IMG_VIDEO,
+                        TYPE_IMG_PDF,
+                        TYPE_VIDEO_PDF,
+                        TYPE_ALL
+                    )
+                )
+                .apply { setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item) }
         setMediaTypeVisibility(true)
     }
 
@@ -275,38 +280,40 @@ class ShareTestActivity : Activity() {
         val imageIndex = Random.nextInt(ADDITIONAL_ITEM_COUNT)
 
         when (mediaSelection.checkedRadioButtonId) {
-            R.id.one_image -> share.apply {
-                val sharedUri = makeItemUri(
-                    imageIndex,
-                    mimeTypes[imageIndex % mimeTypes.size],
-                    imageSizeMetadataCheck.isChecked
-                )
-                putExtra(Intent.EXTRA_STREAM, sharedUri)
-                clipData = ClipData("", arrayOf("image/jpg"), ClipData.Item(sharedUri))
-                type = if (mimeTypes.size == 1) mimeTypes[0] else "*/*"
-            }
-
-            R.id.many_images -> share.apply {
-                val imageUris = ArrayList(
-                    (0 until IMAGE_COUNT).map { idx ->
+            R.id.one_image ->
+                share.apply {
+                    val sharedUri =
                         makeItemUri(
-                            idx,
-                            mimeTypes[idx % mimeTypes.size],
+                            imageIndex,
+                            mimeTypes[imageIndex % mimeTypes.size],
                             imageSizeMetadataCheck.isChecked
                         )
-                    })
-                action = Intent.ACTION_SEND_MULTIPLE
-                clipData = ClipData("", arrayOf("image/jpg"), ClipData.Item(imageUris[0])).apply {
-                    for (i in 1 until IMAGE_COUNT) {
-                        addItem(ClipData.Item(imageUris[i]))
-                    }
+                    putExtra(Intent.EXTRA_STREAM, sharedUri)
+                    clipData = ClipData("", arrayOf("image/jpg"), ClipData.Item(sharedUri))
+                    type = if (mimeTypes.size == 1) mimeTypes[0] else "*/*"
+                }
+            R.id.many_images ->
+                share.apply {
+                    val imageUris =
+                        ArrayList(
+                            (0 until IMAGE_COUNT).map { idx ->
+                                makeItemUri(
+                                    idx,
+                                    mimeTypes[idx % mimeTypes.size],
+                                    imageSizeMetadataCheck.isChecked
+                                )
+                            }
+                        )
+                    action = Intent.ACTION_SEND_MULTIPLE
+                    clipData =
+                        ClipData("", arrayOf("image/jpg"), ClipData.Item(imageUris[0])).apply {
+                            for (i in 1 until IMAGE_COUNT) {
+                                addItem(ClipData.Item(imageUris[i]))
+                            }
+                        }
+                    type = if (mimeTypes.size == 1) mimeTypes[0] else "*/*"
+                    putParcelableArrayListExtra(Intent.EXTRA_STREAM, imageUris)
                 }
-                type = if (mimeTypes.size == 1) mimeTypes[0] else "*/*"
-                putParcelableArrayListExtra(
-                    Intent.EXTRA_STREAM,
-                    imageUris
-                )
-            }
         }
 
         val url = "https://developer.android.com/training/sharing/send#adding-rich-content-previews"
@@ -322,24 +329,26 @@ class ShareTestActivity : Activity() {
         }
 
         if (requireViewById<CheckBox>(R.id.include_icon).isChecked) {
-            share.clipData = ClipData(
-                "", arrayOf("image/png"), ClipData.Item(ImageContentProvider.ICON_URI)
-            )
+            share.clipData =
+                ClipData("", arrayOf("image/png"), ClipData.Item(ImageContentProvider.ICON_URI))
             share.data = ImageContentProvider.ICON_URI
         }
 
-        val chosenComponentPendingIntent = PendingIntent.getBroadcast(
-            this, 0,
-            Intent(this, ChosenComponentBroadcastReceiver::class.java),
-            PendingIntent.FLAG_MUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
-        )
+        val chosenComponentPendingIntent =
+            PendingIntent.getBroadcast(
+                this,
+                0,
+                Intent(this, ChosenComponentBroadcastReceiver::class.java),
+                PendingIntent.FLAG_MUTABLE or PendingIntent.FLAG_UPDATE_CURRENT
+            )
 
         val chooserIntent =
             Intent.createChooser(share, null, chosenComponentPendingIntent.intentSender)
 
-        val sendingImage = mediaSelection.checkedRadioButtonId.let {
-            it == R.id.one_image || it == R.id.many_images
-        }
+        val sendingImage =
+            mediaSelection.checkedRadioButtonId.let {
+                it == R.id.one_image || it == R.id.many_images
+            }
         if (sendingImage && altIntentCheck.isChecked) {
             chooserIntent.putExtra(
                 Intent.EXTRA_ALTERNATE_INTENTS,
@@ -353,6 +362,13 @@ class ShareTestActivity : Activity() {
             )
         }
 
+        if (excludeSelfCheck.isChecked) {
+            chooserIntent.putExtra(
+                Intent.EXTRA_EXCLUDE_COMPONENTS,
+                arrayOf(ComponentName(packageName, CallerDirectTargetActivity::class.java.name))
+            )
+        }
+
         if (albumCheck.isChecked) {
             chooserIntent.putExtra(
                 Intent.EXTRA_CHOOSER_CONTENT_TYPE_HINT,
@@ -372,13 +388,16 @@ class ShareTestActivity : Activity() {
         }
 
         when (requireViewById<RadioGroup>(R.id.action_selection).checkedRadioButtonId) {
-            R.id.one_action -> chooserIntent.putExtra(
-                Intent.EXTRA_CHOOSER_CUSTOM_ACTIONS, customActionFactory.getCustomActions(1)
-            )
-
-            R.id.five_actions -> chooserIntent.putExtra(
-                Intent.EXTRA_CHOOSER_CUSTOM_ACTIONS, customActionFactory.getCustomActions(5)
-            )
+            R.id.one_action ->
+                chooserIntent.putExtra(
+                    Intent.EXTRA_CHOOSER_CUSTOM_ACTIONS,
+                    customActionFactory.getCustomActions(1)
+                )
+            R.id.five_actions ->
+                chooserIntent.putExtra(
+                    Intent.EXTRA_CHOOSER_CUSTOM_ACTIONS,
+                    customActionFactory.getCustomActions(5)
+                )
         }
 
         if (metadata.text.isNotEmpty()) {
@@ -387,21 +406,23 @@ class ShareTestActivity : Activity() {
         if (shareouselCheck.isChecked) {
             val additionalContentUri =
                 AdditionalContentProvider.ADDITIONAL_CONTENT_URI.buildUpon()
-                        .appendQueryParameter(
-                            AdditionalContentProvider.PARAM_COUNT,
-                            ADDITIONAL_ITEM_COUNT.toString(),
-                        )
-                        .appendQueryParameter(
-                            AdditionalContentProvider.PARAM_SIZE_META,
-                            imageSizeMetadataCheck.isChecked.toString(),
-                        )
-                        .also { builder ->
-                            mimeTypes.forEach {
-                                builder.appendQueryParameter(
-                                    AdditionalContentProvider.PARAM_MIME_TYPE, it)
-                            }
+                    .appendQueryParameter(
+                        AdditionalContentProvider.PARAM_COUNT,
+                        ADDITIONAL_ITEM_COUNT.toString(),
+                    )
+                    .appendQueryParameter(
+                        AdditionalContentProvider.PARAM_SIZE_META,
+                        imageSizeMetadataCheck.isChecked.toString(),
+                    )
+                    .also { builder ->
+                        mimeTypes.forEach {
+                            builder.appendQueryParameter(
+                                AdditionalContentProvider.PARAM_MIME_TYPE,
+                                it
+                            )
                         }
-                        .build()
+                    }
+                    .build()
             chooserIntent.putExtra(
                 Intent.EXTRA_CHOOSER_ADDITIONAL_CONTENT_URI,
                 additionalContentUri,
@@ -414,12 +435,13 @@ class ShareTestActivity : Activity() {
                     imageIndex,
                 )
             }
-            val latency = when (selectionLatencyGroup.checkedRadioButtonId) {
-                R.id.selection_latency_50 -> 50
-                R.id.selection_latency_200 -> 200
-                R.id.selection_latency_800 -> 800
-                else -> 0
-            }
+            val latency =
+                when (selectionLatencyGroup.checkedRadioButtonId) {
+                    R.id.selection_latency_50 -> 50
+                    R.id.selection_latency_200 -> 200
+                    R.id.selection_latency_800 -> 800
+                    else -> 0
+                }
             if (latency > 0) {
                 chooserIntent.putExtra(AdditionalContentProvider.EXTRA_SELECTION_LATENCY, latency)
             }
@@ -450,9 +472,7 @@ class ShareTestActivity : Activity() {
             .append(" to ")
             .append("share", ForegroundColorSpan(Color.GREEN), Spannable.SPAN_INCLUSIVE_EXCLUSIVE)
             .append(".")
-            .let {
-                if (richText.isChecked) it else it.toString()
-            }
+            .let { if (richText.isChecked) it else it.toString() }
 
     private fun createLongText(): CharSequence =
         SpannableStringBuilder("Here is a lot more text to share:")
@@ -472,14 +492,13 @@ class ShareTestActivity : Activity() {
                 for (color in colors) {
                     append("\n")
                     append(
-                        createShortText(), BulletSpan(40, color, 20),
+                        createShortText(),
+                        BulletSpan(40, color, 20),
                         Spannable.SPAN_INCLUSIVE_EXCLUSIVE
                     )
                 }
             }
-            .let {
-                if (richText.isChecked) it else it.toString()
-            }
+            .let { if (richText.isChecked) it else it.toString() }
 
     private fun createTextTitle(): CharSequence =
         SpannableStringBuilder()
@@ -487,9 +506,7 @@ class ShareTestActivity : Activity() {
             .append(" the ", StyleSpan(Typeface.ITALIC), Spannable.SPAN_INCLUSIVE_EXCLUSIVE)
             .append("Title", ForegroundColorSpan(Color.RED), Spannable.SPAN_INCLUSIVE_EXCLUSIVE)
             .append("!")
-            .let {
-                if (richText.isChecked) it else it.toString()
-            }
+            .let { if (richText.isChecked) it else it.toString() }
 
     override fun onDestroy() {
         super.onDestroy()
@@ -497,5 +514,3 @@ class ShareTestActivity : Activity() {
         unregisterReceiver(refinementReceiver)
     }
 }
-
-
diff --git a/apps/launchperf/Android.bp b/apps/launchperf/Android.bp
index bd6d0403f..77c35eb84 100644
--- a/apps/launchperf/Android.bp
+++ b/apps/launchperf/Android.bp
@@ -5,6 +5,6 @@ package {
 android_test {
     name: "launchperf",
     srcs: ["**/*.java"],
-    libs: ["android.test.runner"],
+    libs: ["android.test.runner.stubs.system"],
     platform_apis: true,
 }
diff --git a/cmds/monkey/Android.bp b/cmds/monkey/Android.bp
index 884cef2a3..a748b2ec0 100644
--- a/cmds/monkey/Android.bp
+++ b/cmds/monkey/Android.bp
@@ -12,6 +12,12 @@ java_binary {
     name: "monkey",
     srcs: ["**/*.java"],
     wrapper: "monkey.sh",
+    static_libs: [
+        "monkey_aidl-java",
+    ],
+    jni_libs: [
+        "libmonkey_jni",
+    ],
 }
 
 android_test {
@@ -20,8 +26,9 @@ android_test {
     // not available for the host.
     // Therefore, we are relying on 'android_test' here until ravenwood is ready.
     name: "monkey_test",
-    srcs: ["**/*.java",
-           "**/*.kt",
+    srcs: [
+        "**/*.java",
+        "**/*.kt",
     ],
 
     kotlincflags: [
@@ -30,6 +37,10 @@ android_test {
 
     static_libs: [
         "androidx.test.runner",
+        "monkey_aidl-java",
+    ],
+    jni_libs: [
+        "libmonkey_jni",
     ],
 
     libs: [
diff --git a/cmds/monkey/libmonkey_jni/Android.bp b/cmds/monkey/libmonkey_jni/Android.bp
new file mode 100644
index 000000000..d0a7cd6d0
--- /dev/null
+++ b/cmds/monkey/libmonkey_jni/Android.bp
@@ -0,0 +1,43 @@
+// Copyright 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+//
+
+package {
+    default_team: "trendy_team_input_framework",
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+cc_library_shared {
+    name: "libmonkey_jni",
+    host_supported: true,
+    srcs: [
+        "libmonkey_jni.cpp",
+    ],
+    defaults: [
+        "inputflinger_defaults",
+    ],
+    shared_libs: [
+        "libbinder_ndk",
+        "libinput",
+        "liblog",
+        "monkey_aidl-ndk",
+    ],
+}
+
+aidl_interface {
+    name: "monkey_aidl",
+    srcs: ["com/android/commands/monkey/IMonkey.aidl"],
+    unstable: true,
+    host_supported: true,
+}
diff --git a/cmds/monkey/libmonkey_jni/com/android/commands/monkey/IMonkey.aidl b/cmds/monkey/libmonkey_jni/com/android/commands/monkey/IMonkey.aidl
new file mode 100644
index 000000000..1525bc516
--- /dev/null
+++ b/cmds/monkey/libmonkey_jni/com/android/commands/monkey/IMonkey.aidl
@@ -0,0 +1,30 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.commands.monkey;
+
+/**
+ * A local AIDL interface used as a foreign function interface (ffi) to
+ * communicate with the libinput library.
+ *
+ * NOTE: Since we use this as a local interface, all processing happens on the
+ * calling thread.
+ */
+interface IMonkey {
+    boolean writeTouchEvent(int pointerId, int toolType, int action, float locationX,
+                             float locationY, float pressure, float majorAxisSize,
+                             long eventTime);
+}
diff --git a/cmds/monkey/libmonkey_jni/libmonkey_jni.cpp b/cmds/monkey/libmonkey_jni/libmonkey_jni.cpp
new file mode 100644
index 000000000..c1ade4d22
--- /dev/null
+++ b/cmds/monkey/libmonkey_jni/libmonkey_jni.cpp
@@ -0,0 +1,72 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#define LOG_TAG "NativeMonkey"
+
+#include <aidl/com/android/commands/monkey/BnMonkey.h>
+#include <android-base/logging.h>
+#include <android/binder_ibinder_jni.h>
+#include <input/VirtualInputDevice.h>
+
+namespace {
+
+constexpr int32_t GOOGLE_VENDOR_ID = 0x18d1;
+constexpr int32_t PRODUCT_ID = 0x0001;
+
+android::base::unique_fd openUinputTouchscreen(int width, int height) {
+  return openUinput("Monkey touch", GOOGLE_VENDOR_ID, PRODUCT_ID,
+                    /*phys=*/"monkeydevice", android::DeviceType::TOUCHSCREEN,
+                    height, width);
+}
+} // namespace
+
+class MonkeyService : public aidl::com::android::commands::monkey::BnMonkey {
+public:
+  MonkeyService(int width, int height)
+      : mTouchScreen(openUinputTouchscreen(width, height)) {}
+
+private:
+  ::ndk::ScopedAStatus writeTouchEvent(int32_t pointerId, int32_t toolType,
+                                       int32_t action, float x, float y,
+                                       float pressure, float majorAxisSize,
+                                       int64_t eventTime,
+                                       bool *_aidl_return) override {
+    *_aidl_return = mTouchScreen.writeTouchEvent(
+        pointerId, toolType, action, x, y, pressure, majorAxisSize,
+        std::chrono::nanoseconds(eventTime));
+    return ndk::ScopedAStatus::ok();
+  }
+
+  android::VirtualTouchscreen mTouchScreen;
+};
+
+static jobject createNativeService(JNIEnv *env, jclass, jint width,
+                                   jint height) {
+  std::shared_ptr<MonkeyService> service =
+      ndk::SharedRefBase::make<MonkeyService>(width, height);
+  // The call `AIBinder_toJavaBinder` increments the refcount, so this will
+  // prevent "service" from getting destructed. The ownership will now be
+  // transferred to Java.
+  return AIBinder_toJavaBinder(env, service->asBinder().get());
+}
+
+extern "C" JNIEXPORT jobject JNICALL
+Java_com_android_commands_monkey_Monkey_createNativeService(JNIEnv *env,
+                                                            jclass clazz,
+                                                            jint width,
+                                                            jint height) {
+  return createNativeService(env, clazz, width, height);
+}
diff --git a/cmds/monkey/src/com/android/commands/monkey/Monkey.java b/cmds/monkey/src/com/android/commands/monkey/Monkey.java
index f821a0e5a..3bed5515f 100644
--- a/cmds/monkey/src/com/android/commands/monkey/Monkey.java
+++ b/cmds/monkey/src/com/android/commands/monkey/Monkey.java
@@ -16,6 +16,9 @@
 
 package com.android.commands.monkey;
 
+import static android.view.InputDevice.SOURCE_TOUCHSCREEN;
+import static android.view.MotionEvent.TOOL_TYPE_FINGER;
+
 import android.app.ActivityManager;
 import android.app.IActivityController;
 import android.app.IActivityManager;
@@ -23,15 +26,20 @@ import android.content.ComponentName;
 import android.content.Intent;
 import android.content.pm.IPackageManager;
 import android.content.pm.ResolveInfo;
+import android.hardware.display.DisplayManagerGlobal;
+import android.hardware.input.VirtualTouchEvent;
 import android.os.Build;
 import android.os.Debug;
 import android.os.Environment;
+import android.os.IBinder;
 import android.os.Process;
 import android.os.RemoteException;
 import android.os.ServiceManager;
 import android.os.StrictMode;
 import android.os.SystemClock;
+import android.view.Display;
 import android.view.IWindowManager;
+import android.view.MotionEvent;
 import android.view.Surface;
 
 import java.io.BufferedReader;
@@ -46,8 +54,8 @@ import java.io.Writer;
 import java.nio.file.Files;
 import java.nio.file.Path;
 import java.nio.file.Paths;
-import java.util.Arrays;
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.Iterator;
@@ -59,6 +67,11 @@ import java.util.Set;
  * Application that injects random key events and other actions into the system.
  */
 public class Monkey {
+    static {
+        System.loadLibrary("monkey_jni");
+    }
+
+    private static native IBinder createNativeService(int width, int height);
 
     /**
      * Monkey Debugging/Dev Support
@@ -188,13 +201,18 @@ public class Monkey {
     /** Categories we are allowed to launch **/
     private ArrayList<String> mMainCategories = new ArrayList<String>();
 
-    /** Applications we can switch to, as well as their corresponding categories. */
+    /**
+     * Applications we can switch to, as well as their corresponding categories.
+     */
     private HashMap<ComponentName, String> mMainApps = new HashMap<>();
 
     /** The delay between event inputs **/
     long mThrottle = 0;
 
-    /** Whether to randomize each throttle (0-mThrottle ms) inserted between events. */
+    /**
+     * Whether to randomize each throttle (0-mThrottle ms) inserted between
+     * events.
+     */
     boolean mRandomizeThrottle = false;
 
     /** The number of iterations **/
@@ -206,6 +224,8 @@ public class Monkey {
     /** The random number generator **/
     Random mRandom = null;
 
+    private final IMonkey mMonkeyService = createMonkeyService();
+
     /** Dropped-event statistics **/
     long mDroppedKeyEvents = 0;
 
@@ -260,6 +280,15 @@ public class Monkey {
 
     public static String currentPackage;
 
+    private static IMonkey createMonkeyService() {
+        // Get the width and height of the touchscreen on the default display
+        Display display = DisplayManagerGlobal.getInstance().getRealDisplay(
+                Display.DEFAULT_DISPLAY);
+        final int width = display.getWidth();
+        final int height = display.getHeight();
+        return IMonkey.Stub.asInterface(createNativeService(width, height));
+    }
+
     /**
      * Monitor operations happening in the system.
      */
@@ -274,8 +303,8 @@ public class Monkey {
                 // around this region for the monkey to minimize
                 // harmless dropbox uploads from monkeys.
                 StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();
-                Logger.out.println("    // " + (allow ? "Allowing" : "Rejecting") + " start of "
-                        + intent + " in package " + pkg);
+                Logger.out.println("    // " + (allow ? "Allowing" : "Rejecting")
+                        + " start of " + intent + " in package " + pkg);
                 StrictMode.setThreadPolicy(savedPolicy);
             }
             currentPackage = pkg;
@@ -293,13 +322,11 @@ public class Monkey {
             // In case the activity is launching home and the default launcher
             // package is disabled, allow anyway to prevent ANR (see b/38121026)
             final Set<String> categories = intent.getCategories();
-            if (intent.getAction() == Intent.ACTION_MAIN
-                    && categories != null
+            if (intent.getAction() == Intent.ACTION_MAIN && categories != null
                     && categories.contains(Intent.CATEGORY_HOME)) {
                 try {
-                    final ResolveInfo resolveInfo =
-                            mPm.resolveIntent(intent, intent.getType(), 0,
-                                    ActivityManager.getCurrentUser());
+                    final ResolveInfo resolveInfo = mPm.resolveIntent(
+                            intent, intent.getType(), 0, ActivityManager.getCurrentUser());
                     final String launcherPackage = resolveInfo.activityInfo.packageName;
                     if (pkg.equals(launcherPackage)) {
                         return true;
@@ -315,8 +342,9 @@ public class Monkey {
         public boolean activityResuming(String pkg) {
             StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();
             Logger.out.println("    // activityResuming(" + pkg + ")");
-            boolean allow = MonkeyUtils.getPackageFilter().checkEnteringPackage(pkg)
-                    || (DEBUG_ALLOW_ANY_RESTARTS != 0);
+            boolean allow =
+                    MonkeyUtils.getPackageFilter().checkEnteringPackage(pkg)
+                            || (DEBUG_ALLOW_ANY_RESTARTS != 0);
             if (!allow) {
                 if (mVerbose > 0) {
                     Logger.out.println("    // " + (allow ? "Allowing" : "Rejecting")
@@ -328,9 +356,9 @@ public class Monkey {
             return allow;
         }
 
-        public boolean appCrashed(String processName, int pid,
-                String shortMsg, String longMsg,
-                long timeMillis, String stackTrace) {
+        public boolean appCrashed(String processName, int pid, String shortMsg,
+                                String longMsg, long timeMillis,
+                                String stackTrace) {
             StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();
             Logger.err.println("// CRASH: " + processName + " (pid " + pid + ")");
             Logger.err.println("// Short Msg: " + shortMsg);
@@ -350,7 +378,7 @@ public class Monkey {
                         if (!mIgnoreCrashes) {
                             mAbort = true;
                         }
-                        if (mRequestBugreport){
+                        if (mRequestBugreport) {
                             mRequestAppCrashBugreport = true;
                             mReportProcessName = processName;
                         }
@@ -365,7 +393,8 @@ public class Monkey {
             return 0;
         }
 
-        public int appNotResponding(String processName, int pid, String processStats) {
+        public int appNotResponding(String processName, int pid,
+                                    String processStats) {
             StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();
             Logger.err.println("// NOT RESPONDING: " + processName + " (pid " + pid + ")");
             Logger.err.println(processStats);
@@ -787,6 +816,80 @@ public class Monkey {
         }
     }
 
+    private int injectEvent(MonkeyEvent ev) {
+        if (ev instanceof MonkeyMotionEvent motion) {
+            final MotionEvent motionEvent = motion.getMotionEventForInjection();
+            if (motionEvent.isFromSource(SOURCE_TOUCHSCREEN)) {
+                return injectTouchEvent(motionEvent);
+            }
+        }
+        return ev.injectEvent(mWm, mAm, mVerbose);
+    }
+
+    private boolean writeTouchEvent(MotionEvent motion, int pointerIndex,
+                                    int action) throws RemoteException {
+        int pointerId = motion.getPointerId(pointerIndex);
+        return mMonkeyService.writeTouchEvent(
+            pointerId, TOOL_TYPE_FINGER, action, motion.getX(pointerIndex),
+            motion.getY(pointerIndex), motion.getPressure(pointerIndex),
+            motion.getTouchMajor(pointerIndex), motion.getEventTime());
+    }
+
+    private int injectTouchEvent(MotionEvent event) {
+        try {
+            boolean success = true;
+            switch (event.getActionMasked()) {
+                case MotionEvent.ACTION_DOWN:
+                case MotionEvent.ACTION_POINTER_DOWN: {
+                    // Send a single write
+                    int pointerIndex = event.getActionIndex();
+                    success &= writeTouchEvent(event, pointerIndex, VirtualTouchEvent.ACTION_DOWN);
+                    break;
+                }
+                case MotionEvent.ACTION_MOVE: {
+                    // Iterate through pointers and send them all!
+                    // This would currently result in multiple motion events to be sent, because
+                    // there's an EV_SYN being sent after each "writeTouchEvent". To avoid this,
+                    // we would ideally only send EV_SYN at the last call to "writeTouchEvent".
+                    // However, the current approach should be good enough, and batching
+                    // should help lump the events together, anyways.
+                    for (int pointerIndex = 0; pointerIndex < event.getPointerCount();
+                            pointerIndex++) {
+                        success &= writeTouchEvent(event, pointerIndex,
+                                VirtualTouchEvent.ACTION_MOVE);
+                    }
+                    break;
+                }
+                case MotionEvent.ACTION_UP:
+                case MotionEvent.ACTION_POINTER_UP: {
+                    // Send a single write
+                    int pointerIndex = event.getActionIndex();
+                    int resolvedAction = VirtualTouchEvent.ACTION_UP;
+                    if ((event.getFlags() & MotionEvent.FLAG_CANCELED) != 0) {
+                        resolvedAction = VirtualTouchEvent.ACTION_CANCEL;
+                    }
+                    success &= writeTouchEvent(event, pointerIndex, resolvedAction);
+                    break;
+                }
+                case MotionEvent.ACTION_CANCEL: {
+                    // Cancel all pointers!
+                    for (int pointerIndex = 0; pointerIndex < event.getPointerCount();
+                            pointerIndex++) {
+                        success &= writeTouchEvent(event, pointerIndex,
+                                                    VirtualTouchEvent.ACTION_CANCEL);
+                    }
+                    break;
+                }
+                default:
+                    throw new RuntimeException("Unhandled action " + event);
+            }
+            return success ? MonkeyEvent.INJECT_SUCCESS : MonkeyEvent.INJECT_FAIL;
+        } catch (RemoteException exc) {
+            exc.rethrowAsRuntimeException();
+        }
+        return MonkeyEvent.INJECT_FAIL;
+    }
+
     /**
      * Process the command-line options
      *
@@ -1019,6 +1122,7 @@ public class Monkey {
         }
 
         mWm = IWindowManager.Stub.asInterface(ServiceManager.getService("window"));
+
         if (mWm == null) {
             Logger.err.println("** Error: Unable to connect to window manager; is the system "
                     + "running?");
@@ -1208,7 +1312,7 @@ public class Monkey {
 
                 MonkeyEvent ev = mEventSource.getNextEvent();
                 if (ev != null) {
-                    int injectCode = ev.injectEvent(mWm, mAm, mVerbose);
+                    final int injectCode = injectEvent(ev);
                     if (injectCode == MonkeyEvent.INJECT_FAIL) {
                         Logger.out.println("    // Injection Failed");
                         if (ev instanceof MonkeyKeyEvent) {
diff --git a/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java b/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
index 3eabc4210..a7d0cc487 100644
--- a/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
+++ b/cmds/monkey/src/com/android/commands/monkey/MonkeyMotionEvent.java
@@ -56,7 +56,7 @@ public abstract class MonkeyMotionEvent extends MonkeyEvent {
     }
 
     public MonkeyMotionEvent addPointer(int id, float x, float y) {
-        return addPointer(id, x, y, 0, 0);
+        return addPointer(id, x, y, 1 /*pressure*/, 5 /*size*/);
     }
 
     public MonkeyMotionEvent addPointer(int id, float x, float y,
@@ -142,6 +142,10 @@ public abstract class MonkeyMotionEvent extends MonkeyEvent {
         return ev;
     }
 
+    public MotionEvent getMotionEventForInjection() {
+        return getEvent();
+    }
+
     @Override
     public boolean isThrottlable() {
         return (getAction() == MotionEvent.ACTION_UP);
diff --git a/ide/intellij/codestyles/AndroidStyle.xml b/ide/intellij/codestyles/AndroidStyle.xml
index 4f9bc6533..846e69ac7 100644
--- a/ide/intellij/codestyles/AndroidStyle.xml
+++ b/ide/intellij/codestyles/AndroidStyle.xml
@@ -23,6 +23,8 @@
         <emptyLine />
         <package name="junit" withSubpackages="true" static="true" />
         <emptyLine />
+        <package name="junitparams" withSubpackages="true" static="true" />
+        <emptyLine />
         <package name="kotlin" withSubpackages="true" static="true" />
         <emptyLine />
         <package name="net" withSubpackages="true" static="true" />
@@ -53,6 +55,8 @@
         <emptyLine />
         <package name="junit" withSubpackages="true" static="false" />
         <emptyLine />
+        <package name="junitparams" withSubpackages="true" static="false" />
+        <emptyLine />
         <package name="kotlin" withSubpackages="true" static="false" />
         <emptyLine />
         <package name="net" withSubpackages="true" static="false" />
@@ -321,4 +325,4 @@
       <option name="TAB_SIZE" value="4" />
     </indentOptions>
   </codeStyleSettings>
-</code_scheme>
\ No newline at end of file
+</code_scheme>
diff --git a/python-packages/adb/adb/__init__.py b/python-packages/adb/adb/__init__.py
index 473c6cae2..6f7a0a9b7 100644
--- a/python-packages/adb/adb/__init__.py
+++ b/python-packages/adb/adb/__init__.py
@@ -375,7 +375,7 @@ class AndroidDevice(object):
         cmd.append(filename)
         return self._simple_call(cmd)
 
-    def push(self, local: str | list[str], remote: str, sync: bool = False) -> str:
+    def push(self, local: str | list[str], remote: str, sync: bool = False, parameters= []) -> str:
         """Transfer a local file or directory to the device.
 
         Args:
@@ -388,6 +388,8 @@ class AndroidDevice(object):
             Output of the command.
         """
         cmd = ['push']
+        cmd = cmd + parameters
+
         if sync:
             cmd.append('--sync')
 
diff --git a/samples/SceneTransitionLayoutDemo/Android.bp b/samples/SceneTransitionLayoutDemo/Android.bp
new file mode 100644
index 000000000..7e70d7e6d
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/Android.bp
@@ -0,0 +1,59 @@
+// Copyright (C) 2023 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+package {
+    // See: http://go/android-license-faq
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+android_library {
+    name: "PlatformComposeSceneTransitionLayoutDemoLib",
+
+    sdk_version: "current",
+    manifest: "AndroidManifest.xml",
+
+    srcs: [
+        "src/**/*.kt",
+    ],
+
+    static_libs: [
+        "PlatformComposeSceneTransitionLayout",
+        "androidx.compose.runtime_runtime",
+        "androidx.compose.material3_material3",
+        "androidx.compose.material3_material3-window-size-class",
+        "androidx.compose.material_material-icons-extended",
+        "androidx.window_window",
+    ],
+
+    kotlincflags: ["-Xjvm-default=all"],
+    use_resource_processor: true,
+}
+
+android_app {
+    name: "PlatformComposeSceneTransitionLayoutDemo",
+    defaults: [
+        "platform_app_defaults",
+        "SystemUI_optimized_defaults",
+    ],
+
+    sdk_version: "current",
+    manifest: "app/AndroidManifest.xml",
+
+    static_libs: [
+        "PlatformComposeSceneTransitionLayoutDemoLib",
+    ],
+
+    dxflags: ["--multi-dex"],
+    use_resource_processor: true,
+}
diff --git a/samples/SceneTransitionLayoutDemo/AndroidManifest.xml b/samples/SceneTransitionLayoutDemo/AndroidManifest.xml
new file mode 100644
index 000000000..a05d5e9c7
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/AndroidManifest.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    package="com.android.compose.animation.scene.demo">
+
+    <application
+        android:enableOnBackInvokedCallback="true" />
+
+</manifest>
diff --git a/samples/SceneTransitionLayoutDemo/OWNERS b/samples/SceneTransitionLayoutDemo/OWNERS
new file mode 100644
index 000000000..42cb5c1e7
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/OWNERS
@@ -0,0 +1,14 @@
+set noparent
+
+# Bug component: 1184816
+
+amiko@google.com
+jdemeulenaere@google.com
+omarmt@google.com
+
+# SysUI Dr No's.
+# Don't send reviews here.
+cinek@google.com
+dsandler@android.com
+juliacr@google.com
+pixel@google.com
diff --git a/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml b/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml
new file mode 100644
index 000000000..dd0dcaa2e
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/app/AndroidManifest.xml
@@ -0,0 +1,38 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    package="com.android.compose.animation.scene.demo.app">
+    <application
+        android:label="@string/app_name"
+        android:icon="@mipmap/ic_launcher"
+        android:roundIcon="@mipmap/ic_launcher_round"
+        android:supportsRtl="true">
+        <activity
+            android:name="com.android.compose.animation.scene.demo.DemoActivity"
+            android:theme="@style/Theme.SceneTransitionLayoutDemo"
+            android:windowSoftInputMode="adjustResize"
+            android:exported="true">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.LAUNCHER" />
+            </intent-filter>
+        </activity>
+
+        <profileable android:shell="true" />
+    </application>
+</manifest>
diff --git a/samples/SceneTransitionLayoutDemo/benchmark/AndroidManifest.xml b/samples/SceneTransitionLayoutDemo/benchmark/AndroidManifest.xml
new file mode 100644
index 000000000..edfa738b0
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/benchmark/AndroidManifest.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<manifest />
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/benchmark/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmark.kt b/samples/SceneTransitionLayoutDemo/benchmark/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmark.kt
new file mode 100644
index 000000000..945d613b2
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/benchmark/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmark.kt
@@ -0,0 +1,92 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.benchmark
+
+import android.content.Intent
+import androidx.benchmark.macro.CompilationMode
+import androidx.benchmark.macro.FrameTimingMetric
+import androidx.benchmark.macro.MacrobenchmarkScope
+import androidx.benchmark.macro.StartupMode
+import androidx.benchmark.macro.StartupTimingMetric
+import androidx.benchmark.macro.junit4.MacrobenchmarkRule
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.uiautomator.Direction
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RunWith(AndroidJUnit4::class)
+class SceneTransitionLayoutDemoBenchmark {
+    @get:Rule val benchmarkRule = MacrobenchmarkRule()
+
+    private fun MacrobenchmarkScope.benchmarkScope(): SceneTransitionLayoutBenchmarkScope {
+        return object : SceneTransitionLayoutBenchmarkScope {
+            override fun startActivity(intent: Intent) = startActivityAndWait(intent)
+        }
+    }
+
+    @Test
+    fun shadeStartup() {
+        benchmarkRule.measureRepeated(
+            packageName = StlDemoConstants.PACKAGE,
+            metrics = listOf(StartupTimingMetric()),
+            iterations = ITERATIONS,
+            startupMode = StartupMode.COLD,
+            compilationMode = CompilationMode.Full(),
+        ) {
+            // Start the demo in the shade. This is our more busy screen because it has a bunch of
+            // elements for the quick settings but also nested SceneTransitionLayouts for each
+            // notification.
+            benchmarkScope().startDemoActivity(StlDemoConstants.SHADE_SCENE)
+        }
+    }
+
+    @Test
+    fun lockscreenToShade() {
+        benchmarkSwipeFromScene(
+            fromScene = StlDemoConstants.LOCKSCREEN_SCENE,
+            toScene = StlDemoConstants.SHADE_SCENE,
+            direction = Direction.DOWN,
+        )
+    }
+
+    @Test
+    fun shadeToQuickSettings() {
+        benchmarkSwipeFromScene(
+            fromScene = StlDemoConstants.SHADE_SCENE,
+            toScene = StlDemoConstants.QUICK_SETTINGS_SCENE,
+            direction = Direction.DOWN,
+        )
+    }
+
+    private fun benchmarkSwipeFromScene(fromScene: String, toScene: String, direction: Direction) {
+        benchmarkRule.measureRepeated(
+            packageName = StlDemoConstants.PACKAGE,
+            metrics = listOf(FrameTimingMetric()),
+            iterations = ITERATIONS,
+            startupMode = StartupMode.WARM,
+            compilationMode = CompilationMode.Full(),
+            setupBlock = { benchmarkScope().setupSwipeFromScene(fromScene, toScene) },
+        ) {
+            swipeFromScene(fromScene, toScene, direction)
+        }
+    }
+
+    private companion object {
+        const val ITERATIONS = 25
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/benchmark/utils/Android.bp b/samples/SceneTransitionLayoutDemo/benchmark/utils/Android.bp
new file mode 100644
index 000000000..1b39912e9
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/benchmark/utils/Android.bp
@@ -0,0 +1,37 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+package {
+    // See: http://go/android-license-faq
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+android_library {
+    name: "PlatformComposeSceneTransitionLayoutBenchmarkUtils",
+    manifest: "AndroidManifest.xml",
+
+    srcs: [
+        "src/**/*.kt",
+    ],
+
+    static_libs: [
+        "PlatformComposeSceneTransitionLayoutDemoLib",
+        "androidx.test.monitor",
+        "androidx.test.uiautomator_uiautomator",
+        "androidx.compose.material3_material3-window-size-class",
+        "androidx.window_window",
+    ],
+
+    kotlincflags: ["-Xjvm-default=all"],
+}
diff --git a/samples/SceneTransitionLayoutDemo/benchmark/utils/AndroidManifest.xml b/samples/SceneTransitionLayoutDemo/benchmark/utils/AndroidManifest.xml
new file mode 100644
index 000000000..3673efd15
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/benchmark/utils/AndroidManifest.xml
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    package="com.android.compose.animation.scene.benchmark.utils"/>
diff --git a/samples/SceneTransitionLayoutDemo/benchmark/utils/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmarkUtils.kt b/samples/SceneTransitionLayoutDemo/benchmark/utils/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmarkUtils.kt
new file mode 100644
index 000000000..0fcf9b798
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/benchmark/utils/src/com/android/compose/animation/scene/benchmark/SceneTransitionLayoutDemoBenchmarkUtils.kt
@@ -0,0 +1,151 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.benchmark
+
+import android.content.Intent
+import android.util.DisplayMetrics
+import androidx.compose.ui.unit.Density
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.By
+import androidx.test.uiautomator.BySelector
+import androidx.test.uiautomator.Direction
+import androidx.test.uiautomator.UiDevice
+import androidx.test.uiautomator.Until
+import com.android.compose.animation.scene.demo.calculateWindowSizeClass
+import com.android.compose.animation.scene.demo.shouldUseSplitScenes
+import kotlin.math.roundToInt
+import kotlin.properties.ReadOnlyProperty
+import kotlin.reflect.KProperty
+
+/**
+ * This file contains utilities to perform benchmark tests for the demo app of SceneTransitionLayout
+ * given a [SceneTransitionLayoutBenchmarkScope].
+ *
+ * These abstractions are necessary to share test code between AndroidX tests written with the
+ * MacrobenchmarkRule and Platform tests written with Platform helpers.
+ */
+interface SceneTransitionLayoutBenchmarkScope {
+    /** Start an activity using [intent]. */
+    fun startActivity(intent: Intent)
+}
+
+fun SceneTransitionLayoutBenchmarkScope.startDemoActivity(initialScene: String) {
+    val intent =
+        (context().packageManager.getLaunchIntentForPackage(StlDemoConstants.PACKAGE)
+                ?: error("Unable to acquire intent for package ${StlDemoConstants.PACKAGE}"))
+            .apply {
+                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
+                addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK)
+                putExtra(StlDemoConstants.INITIAL_SCENE_EXTRA, initialScene)
+                putExtra(StlDemoConstants.FULLSCREEN_EXTRA, true)
+                putExtra(StlDemoConstants.DISABLE_RIPPLE_EXTRA, true)
+            }
+
+    val device = device()
+    device.pressHome()
+    startActivity(intent)
+    device.waitForObject(sceneSelector(initialScene))
+}
+
+fun SceneTransitionLayoutBenchmarkScope.setupSwipeFromScene(fromScene: String, toScene: String) {
+    startDemoActivity(initialScene = fromScene)
+
+    // Wait for the root SceneTransitionLayout to be there. Note that startDemoActivity already
+    // waited for fromScene, so we know it's there.
+    val device = device()
+    device.waitForObject(StlDemoConstants.ROOT_STL_SELECTOR)
+
+    // Verify that toScene is not there yet.
+    device.waitUntilGone(sceneSelector(toScene))
+}
+
+fun swipeFromScene(fromScene: String, toScene: String, direction: Direction) {
+    // Swipe in the given direction.
+    val densityDpi = context().resources.configuration.densityDpi
+    val density = densityDpi.toFloat() / DisplayMetrics.DENSITY_DEFAULT
+    val swipeSpeed = 1_500 // in dp/s
+    val device = device()
+    device
+        .findObject(StlDemoConstants.ROOT_STL_SELECTOR)
+        .swipe(direction, /* percent= */ 0.9f, /* speed= */ (swipeSpeed * density).roundToInt())
+
+    // Wait for fromScene to disappear.
+    device.waitUntilGone(sceneSelector(fromScene))
+
+    // Check that we are at toScene.
+    device.waitForObject(sceneSelector(toScene))
+}
+
+/**
+ * Navigate back to [previousScene] assuming that we are currently on [currentScene] and that going
+ * back will land us at [previousScene].
+ */
+fun navigateBackToPreviousScene(previousScene: String, currentScene: String) {
+    val device = device()
+    device.waitUntilGone(sceneSelector(previousScene))
+    device.waitForObject(sceneSelector(currentScene))
+
+    device.pressBack()
+    device.waitUntilGone(sceneSelector(currentScene))
+    device.waitForObject(sceneSelector(previousScene))
+}
+
+private fun instrumentation() = InstrumentationRegistry.getInstrumentation()
+
+private fun context() = instrumentation().targetContext
+
+private fun device() = UiDevice.getInstance(instrumentation())
+
+private fun UiDevice.waitForObject(selector: BySelector, timeout: Long = 5_000) {
+    if (!wait(Until.hasObject(selector), timeout)) {
+        error("Did not find $selector within $timeout ms")
+    }
+}
+
+private fun UiDevice.waitUntilGone(selector: BySelector, timeout: Long = 5_000) {
+    if (!wait(Until.gone(selector), timeout)) {
+        error("$selector is still there after waiting $timeout ms")
+    }
+}
+
+private fun sceneSelector(scene: String) = By.res("scene:$scene")
+
+object StlDemoConstants {
+    const val PACKAGE = "com.android.compose.animation.scene.demo.app"
+    val LOCKSCREEN_SCENE by AdaptiveScene("Lockscreen", "SplitLockscreen")
+    val SHADE_SCENE by AdaptiveScene("Shade", "SplitShade")
+    const val QUICK_SETTINGS_SCENE = "QuickSettings"
+
+    internal const val INITIAL_SCENE_EXTRA = "initial_scene"
+    internal const val FULLSCREEN_EXTRA = "fullscreen"
+    internal const val DISABLE_RIPPLE_EXTRA = "disable_ripple"
+    internal val ROOT_STL_SELECTOR = By.res("SystemUiSceneTransitionLayout")
+}
+
+/** A scene whose key depends on whether we are using split scenes or not. */
+private class AdaptiveScene(private val normalScene: String, private val splitScene: String) :
+    ReadOnlyProperty<Any, String> {
+    override fun getValue(thisRef: Any, property: KProperty<*>): String {
+        val context = context()
+        val density = Density(context)
+        return if (shouldUseSplitScenes(calculateWindowSizeClass(context, density))) {
+            splitScene
+        } else {
+            normalScene
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/res/drawable-v24/ic_launcher_foreground.xml b/samples/SceneTransitionLayoutDemo/res/drawable-v24/ic_launcher_foreground.xml
new file mode 100644
index 000000000..966abaff2
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/drawable-v24/ic_launcher_foreground.xml
@@ -0,0 +1,30 @@
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:aapt="http://schemas.android.com/aapt"
+    android:width="108dp"
+    android:height="108dp"
+    android:viewportHeight="108"
+    android:viewportWidth="108">
+  <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
+    <aapt:attr name="android:fillColor">
+      <gradient
+          android:endX="85.84757"
+          android:endY="92.4963"
+          android:startX="42.9492"
+          android:startY="49.59793"
+          android:type="linear">
+        <item
+            android:color="#44000000"
+            android:offset="0.0" />
+        <item
+            android:color="#00000000"
+            android:offset="1.0" />
+      </gradient>
+    </aapt:attr>
+  </path>
+  <path
+      android:fillColor="#FFFFFF"
+      android:fillType="nonZero"
+      android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
+      android:strokeColor="#00000000"
+      android:strokeWidth="1" />
+</vector>
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/res/drawable/ic_launcher_background.xml b/samples/SceneTransitionLayoutDemo/res/drawable/ic_launcher_background.xml
new file mode 100644
index 000000000..61bb79edb
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/drawable/ic_launcher_background.xml
@@ -0,0 +1,170 @@
+<?xml version="1.0" encoding="utf-8"?>
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="108dp"
+    android:height="108dp"
+    android:viewportHeight="108"
+    android:viewportWidth="108">
+  <path
+      android:fillColor="#3DDC84"
+      android:pathData="M0,0h108v108h-108z" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M9,0L9,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,0L19,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M29,0L29,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M39,0L39,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M49,0L49,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M59,0L59,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M69,0L69,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M79,0L79,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M89,0L89,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M99,0L99,108"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,9L108,9"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,19L108,19"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,29L108,29"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,39L108,39"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,49L108,49"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,59L108,59"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,69L108,69"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,79L108,79"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,89L108,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M0,99L108,99"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,29L89,29"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,39L89,39"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,49L89,49"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,59L89,59"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,69L89,69"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M19,79L89,79"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M29,19L29,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M39,19L39,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M49,19L49,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M59,19L59,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M69,19L69,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+  <path
+      android:fillColor="#00000000"
+      android:pathData="M79,19L79,89"
+      android:strokeColor="#33FFFFFF"
+      android:strokeWidth="0.8" />
+</vector>
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher.xml b/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher.xml
new file mode 100644
index 000000000..03eed2533
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
+  <background android:drawable="@drawable/ic_launcher_background" />
+  <foreground android:drawable="@drawable/ic_launcher_foreground" />
+</adaptive-icon>
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher_round.xml b/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher_round.xml
new file mode 100644
index 000000000..03eed2533
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/mipmap-anydpi-v26/ic_launcher_round.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
+  <background android:drawable="@drawable/ic_launcher_background" />
+  <foreground android:drawable="@drawable/ic_launcher_foreground" />
+</adaptive-icon>
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher.webp
new file mode 100644
index 000000000..c209e78ec
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher_round.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher_round.webp
new file mode 100644
index 000000000..b2dfe3d1b
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-hdpi/ic_launcher_round.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher.webp
new file mode 100644
index 000000000..4f0f1d64e
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher_round.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher_round.webp
new file mode 100644
index 000000000..62b611da0
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-mdpi/ic_launcher_round.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher.webp
new file mode 100644
index 000000000..948a3070f
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher_round.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher_round.webp
new file mode 100644
index 000000000..1b9a6956b
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xhdpi/ic_launcher_round.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher.webp
new file mode 100644
index 000000000..28d4b77f9
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher_round.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher_round.webp
new file mode 100644
index 000000000..9287f5083
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xxhdpi/ic_launcher_round.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher.webp
new file mode 100644
index 000000000..aa7d6427e
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher_round.webp b/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher_round.webp
new file mode 100644
index 000000000..9126ae37c
Binary files /dev/null and b/samples/SceneTransitionLayoutDemo/res/mipmap-xxxhdpi/ic_launcher_round.webp differ
diff --git a/samples/SceneTransitionLayoutDemo/res/values-af/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-af/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-af/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-am/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-am/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-am/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ar/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ar/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ar/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-as/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-as/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-as/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-az/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-az/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-az/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-b+sr+Latn/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-b+sr+Latn/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-b+sr+Latn/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-be/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-be/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-be/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-bg/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-bg/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-bg/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-bn/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-bn/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-bn/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-bs/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-bs/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-bs/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ca/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ca/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ca/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-cs/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-cs/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-cs/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-da/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-da/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-da/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-de/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-de/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-de/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-el/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-el/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-el/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-en-rAU/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-en-rAU/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-en-rAU/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-en-rCA/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-en-rCA/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-en-rCA/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-en-rGB/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-en-rGB/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-en-rGB/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-en-rIN/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-en-rIN/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-en-rIN/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-en-rXC/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-en-rXC/strings.xml
new file mode 100644
index 000000000..023f99890
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-en-rXC/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-es-rUS/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-es-rUS/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-es-rUS/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-es/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-es/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-es/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-et/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-et/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-et/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-eu/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-eu/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-eu/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-fa/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-fa/strings.xml
new file mode 100644
index 000000000..065d3ff21
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-fa/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"    "</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-fi/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-fi/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-fi/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-fr-rCA/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-fr-rCA/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-fr-rCA/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-fr/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-fr/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-fr/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-gl/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-gl/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-gl/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-gu/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-gu/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-gu/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-hi/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-hi/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-hi/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-hr/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-hr/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-hr/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-hu/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-hu/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-hu/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-hy/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-hy/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-hy/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-in/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-in/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-in/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-is/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-is/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-is/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-it/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-it/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-it/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-iw/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-iw/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-iw/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ja/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ja/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ja/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ka/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ka/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ka/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-kk/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-kk/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-kk/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-km/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-km/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-km/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-kn/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-kn/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-kn/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ko/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ko/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ko/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ky/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ky/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ky/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-lo/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-lo/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-lo/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-lt/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-lt/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-lt/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-lv/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-lv/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-lv/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-mk/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-mk/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-mk/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ml/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ml/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ml/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-mn/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-mn/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-mn/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-mr/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-mr/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-mr/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ms/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ms/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ms/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-my/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-my/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-my/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-nb/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-nb/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-nb/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ne/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ne/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ne/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-nl/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-nl/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-nl/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-or/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-or/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-or/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-pa/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-pa/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-pa/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-pl/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-pl/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-pl/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-pt-rBR/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-pt-rBR/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-pt-rBR/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-pt-rPT/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-pt-rPT/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-pt-rPT/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-pt/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-pt/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-pt/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ro/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ro/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ro/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ru/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ru/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ru/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-si/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-si/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-si/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sk/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sk/strings.xml
new file mode 100644
index 000000000..21d4725dc
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sk/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"DemoRozloeniaPrechoduScny"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sl/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sl/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sl/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sq/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sq/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sq/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sr/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sr/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sr/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sv/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sv/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sv/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-sw/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-sw/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-sw/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ta/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ta/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ta/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-te/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-te/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-te/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-th/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-th/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-th/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-tl/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-tl/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-tl/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-tr/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-tr/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-tr/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-uk/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-uk/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-uk/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-ur/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-ur/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-ur/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-uz/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-uz/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-uz/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-vi/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-vi/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-vi/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-zh-rCN/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-zh-rCN/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-zh-rCN/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-zh-rHK/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-zh-rHK/strings.xml
new file mode 100644
index 000000000..f004e5e31
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-zh-rHK/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">""</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-zh-rTW/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-zh-rTW/strings.xml
new file mode 100644
index 000000000..2548451d1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-zh-rTW/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values-zu/strings.xml b/samples/SceneTransitionLayoutDemo/res/values-zu/strings.xml
new file mode 100644
index 000000000..17de09d28
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values-zu/strings.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+ -->
+
+<resources xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <string name="app_name" msgid="3302068728980616664">"I-SceneTransitionLayoutDemo"</string>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/res/values/colors.xml b/samples/SceneTransitionLayoutDemo/res/values/colors.xml
new file mode 100644
index 000000000..d8233dc48
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values/colors.xml
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources>
+    <color name="ic_launcher_background">#FFFFFF</color>
+</resources>
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/res/values/strings.xml b/samples/SceneTransitionLayoutDemo/res/values/strings.xml
new file mode 100644
index 000000000..0ceaaed5e
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values/strings.xml
@@ -0,0 +1,20 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources>
+    <!-- Application name [CHAR LIMIT=NONE] -->
+    <string name="app_name">SceneTransitionLayoutDemo</string>
+</resources>
\ No newline at end of file
diff --git a/samples/SceneTransitionLayoutDemo/res/values/themes.xml b/samples/SceneTransitionLayoutDemo/res/values/themes.xml
new file mode 100644
index 000000000..befb7592b
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/res/values/themes.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<resources xmlns:tools="http://schemas.android.com/tools">
+    <style name="Theme.SceneTransitionLayoutDemo" parent="android:Theme.Material.Light.NoActionBar">
+        <item name="android:statusBarColor">@android:color/transparent</item>
+        <item name="android:navigationBarColor">@android:color/transparent</item>
+        <item name="android:windowLightStatusBar">true</item>
+        <item name="android:windowLayoutInDisplayCutoutMode">always</item>
+    </style>
+</resources>
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/AlwaysOnDisplay.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/AlwaysOnDisplay.kt
new file mode 100644
index 000000000..cec096597
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/AlwaysOnDisplay.kt
@@ -0,0 +1,51 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+
+object AlwaysOnDisplay {
+    object Elements {
+        val Background = ElementKey("AlwaysOnDisplayBackground")
+    }
+}
+
+@Composable
+fun SceneScope.AlwaysOnDisplay(modifier: Modifier = Modifier) {
+    Box(modifier) {
+        Box(
+            Modifier.element(AlwaysOnDisplay.Elements.Background)
+                .fillMaxSize()
+                .background(Color.Black)
+        )
+
+        Column(Modifier.padding(16.dp)) {
+            Clock(Color.White, Modifier.padding(top = 16.dp))
+            SmartSpace(Color.White)
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt
new file mode 100644
index 000000000..0149efdd1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Bouncer.kt
@@ -0,0 +1,123 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.shape.CircleShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.ArrowBack
+import androidx.compose.material.icons.filled.Check
+import androidx.compose.material3.Button
+import androidx.compose.material3.ButtonDefaults
+import androidx.compose.material3.Icon
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.vector.ImageVector
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.grid.VerticalGrid
+
+object Bouncer {
+    fun userActions(lockscreenScene: SceneKey) =
+        mapOf(Back to lockscreenScene, Swipe.Down to lockscreenScene)
+
+    object Elements {
+        val Background = ElementKey("BouncerBackground")
+        val Content = ElementKey("BouncerContent")
+    }
+}
+
+@Composable
+fun SceneScope.Bouncer(
+    onBouncerCancelled: () -> Unit,
+    onBouncerSolved: () -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Box(modifier) {
+        Box(
+            Modifier.element(Bouncer.Elements.Background)
+                .fillMaxSize()
+                .background(MaterialTheme.colorScheme.surfaceContainer)
+        )
+
+        val nColumns = 3
+        val nRows = 4
+        val gridSpacing = 24.dp
+        val normalButtonColor = MaterialTheme.colorScheme.surfaceBright
+        val actionButtonColor = MaterialTheme.colorScheme.tertiary
+        val actionIconColor = MaterialTheme.colorScheme.onTertiary
+
+        VerticalGrid(
+            columns = 3,
+            Modifier.align(Alignment.BottomCenter)
+                .padding(bottom = 100.dp)
+                .element(Bouncer.Elements.Content),
+            horizontalSpacing = gridSpacing,
+            verticalSpacing = gridSpacing,
+        ) {
+            repeat(nRows * nColumns) { i ->
+                val row = i / nColumns
+                val col = i % nColumns
+
+                val isLastRow = row == nRows - 1
+                val isFirstColumn = col == 0
+                val isLastColumn = col == nColumns - 1
+                val isCancelButton = isLastRow && isFirstColumn
+                val isSolveButton = isLastRow && isLastColumn
+
+                val color =
+                    if (isCancelButton || isSolveButton) {
+                        actionButtonColor
+                    } else {
+                        normalButtonColor
+                    }
+
+                Button(
+                    onClick = {
+                        when {
+                            isCancelButton -> onBouncerCancelled()
+                            isSolveButton -> onBouncerSolved()
+                        }
+                    },
+                    modifier = Modifier.size(80.dp),
+                    colors = ButtonDefaults.buttonColors(containerColor = color),
+                    shape = CircleShape,
+                    elevation = null,
+                ) {
+                    val icon: ImageVector? =
+                        when {
+                            isCancelButton -> Icons.Default.ArrowBack
+                            isSolveButton -> Icons.Default.Check
+                            else -> null
+                        }
+
+                    icon?.let { Icon(it, null, tint = actionIconColor) }
+                }
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/CachedText.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/CachedText.kt
new file mode 100644
index 000000000..741d737a8
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/CachedText.kt
@@ -0,0 +1,76 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.material3.LocalTextStyle
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.remember
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.drawBehind
+import androidx.compose.ui.graphics.ColorProducer
+import androidx.compose.ui.layout.Layout
+import androidx.compose.ui.text.TextLayoutResult
+import androidx.compose.ui.text.TextMeasurer
+import androidx.compose.ui.text.TextStyle
+import androidx.compose.ui.text.drawText
+import androidx.compose.ui.text.style.TextOverflow
+
+/**
+ * A text whose measures can be cached outside composition using [textMeasurer].
+ *
+ * Important: DO NOT USE THIS IN PRODUCTION CODE. You should always use the Text() or BasicText()
+ * composables instead. This was introduced only to optimize the SceneTransitionLayout benchmarks
+ * and make their frame time metrics more stable.
+ */
+@Composable
+fun CachedText(
+    text: String,
+    textMeasurer: TextMeasurer,
+    modifier: Modifier = Modifier,
+    style: TextStyle = LocalTextStyle.current,
+    overflow: TextOverflow = TextOverflow.Clip,
+    softWrap: Boolean = true,
+    maxLines: Int = Int.MAX_VALUE,
+    color: ColorProducer? = null,
+) {
+    val lastLayoutResult = remember {
+        object {
+            var value: TextLayoutResult? = null
+        }
+    }
+
+    val localColor = if (color != null) null else LocalContentColor.current
+    Layout(
+        modifier =
+            modifier.drawBehind {
+                val textLayoutResult =
+                    lastLayoutResult.value ?: error("draw happened before layout")
+                val color =
+                    color?.let { it() }
+                        ?: localColor
+                        ?: error("localColor should not be null when color is null")
+                drawText(textLayoutResult, color)
+            }
+    ) { _, constraints ->
+        val layoutResult =
+            textMeasurer.measure(text, style, overflow, softWrap, maxLines, constraints).also {
+                lastLayoutResult.value = it
+            }
+        layout(layoutResult.size.width, layoutResult.size.height) {}
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Camera.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Camera.kt
new file mode 100644
index 000000000..9f6d0a201
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Camera.kt
@@ -0,0 +1,115 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.shape.CircleShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.PhotoCamera
+import androidx.compose.material3.Icon
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.getValue
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.draw.drawBehind
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementColorAsState
+
+object Camera {
+    fun userActions(lockscreenScene: SceneKey): Map<UserAction, UserActionResult> =
+        mapOf(Back to lockscreenScene)
+
+    object Elements {
+        val Background = ElementKey("CameraBackground")
+        val Button = ElementKey("CameraButton")
+        val ButtonIcon = ElementKey("CameraButtonBackground")
+    }
+
+    object Values {
+        val ButtonColor = ValueKey("CameraButtonColor")
+        val ButtonIconColor = ValueKey("CameraButtonIconColor")
+    }
+}
+
+@Composable
+fun SceneScope.Camera(modifier: Modifier = Modifier) {
+    Box(modifier) {
+        Box(Modifier.element(Camera.Elements.Background).fillMaxSize().background(Color.Black))
+        CameraButton(
+            backgroundColor = Color.White,
+            iconColor = Color.Black,
+            onClick = {},
+            Modifier.align(Alignment.BottomCenter).padding(bottom = 100.dp).size(70.dp),
+        )
+    }
+}
+
+@Composable
+fun SceneScope.CameraButton(
+    backgroundColor: Color,
+    iconColor: Color,
+    onClick: () -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Element(Camera.Elements.Button, modifier) {
+        val backgroundColor by
+            animateElementColorAsState(backgroundColor, Camera.Values.ButtonColor)
+        val iconColor by
+            animateElementColorAsState(iconColor, Camera.Values.ButtonIconColor)
+                // TODO(b/231674463): We should not read iconColor during composition.
+                .unsafeCompositionState(initialValue = iconColor)
+
+        content {
+            Box(
+                Modifier.fillMaxSize().clip(CircleShape).clickable(onClick = onClick).drawBehind {
+                    drawRect(backgroundColor)
+                }
+            ) {
+                CameraButtonIcon(
+                    iconColor = iconColor,
+                    Modifier.element(Camera.Elements.ButtonIcon).size(24.dp).align(Alignment.Center),
+                )
+            }
+        }
+    }
+}
+
+@Composable
+private fun CameraButtonIcon(iconColor: Color, modifier: Modifier = Modifier) {
+    // Note: In practice, we should somehow defer the icon color read to the drawing phase but
+    // there is no overload of Icon taking a `tint: () -> Color`.
+    Icon(
+        Icons.Default.PhotoCamera,
+        contentDescription = null,
+        tint = iconColor,
+        modifier = modifier,
+    )
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Clock.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Clock.kt
new file mode 100644
index 000000000..50696ced8
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Clock.kt
@@ -0,0 +1,54 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.text.BasicText
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.getValue
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.sp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementColorAsState
+
+object Clock {
+    object Elements {
+        val Clock = ElementKey("Clock")
+    }
+
+    object Values {
+        val TextColor = ValueKey("ClockTextColor")
+    }
+}
+
+@Composable
+fun SceneScope.Clock(color: Color, modifier: Modifier = Modifier) {
+    Element(Clock.Elements.Clock, modifier) {
+        val color by animateElementColorAsState(color, Clock.Values.TextColor)
+
+        content {
+            BasicText(
+                "03:25",
+                color = { color },
+                style = MaterialTheme.typography.displayLarge.copy(fontSize = 80.sp),
+            )
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoActivity.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoActivity.kt
new file mode 100644
index 000000000..fc7b7ddd6
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoActivity.kt
@@ -0,0 +1,163 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import android.os.Bundle
+import android.view.WindowInsets
+import androidx.activity.ComponentActivity
+import androidx.activity.compose.ReportDrawn
+import androidx.activity.compose.setContent
+import androidx.compose.foundation.IndicationNodeFactory
+import androidx.compose.foundation.LocalIndication
+import androidx.compose.foundation.interaction.InteractionSource
+import androidx.compose.foundation.isSystemInDarkTheme
+import androidx.compose.foundation.layout.safeDrawingPadding
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Typography
+import androidx.compose.material3.dynamicDarkColorScheme
+import androidx.compose.material3.dynamicLightColorScheme
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.runtime.SideEffect
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.mutableStateOf
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.saveable.rememberSaveable
+import androidx.compose.runtime.setValue
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.drawscope.ContentDrawScope
+import androidx.compose.ui.node.DelegatableNode
+import androidx.compose.ui.node.DrawModifierNode
+import androidx.compose.ui.platform.LocalContext
+import androidx.compose.ui.text.font.DeviceFontFamilyName
+import androidx.compose.ui.text.font.Font
+import androidx.compose.ui.text.font.FontFamily
+import androidx.compose.ui.text.font.FontWeight
+import com.android.compose.modifiers.thenIf
+
+class DemoActivity : ComponentActivity() {
+    private companion object {
+        const val INITIAL_SCENE_EXTRA = "initial_scene"
+        const val FULLSCREEN_EXTRA = "fullscreen"
+        const val DISABLE_RIPPLE_EXTRA = "disable_ripple"
+    }
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+        window.setDecorFitsSystemWindows(false)
+
+        val initialScene =
+            intent.extras?.getString(INITIAL_SCENE_EXTRA)?.let { scene ->
+                Scenes.AllScenes[scene] ?: error("Scene $scene does not exist")
+            }
+
+        val isFullscreen = intent.extras?.getBoolean(FULLSCREEN_EXTRA) ?: false
+        val disableRipple = intent.extras?.getBoolean(DISABLE_RIPPLE_EXTRA) ?: false
+
+        setContent {
+            DemoTheme {
+                var configuration by
+                    rememberSaveable(stateSaver = DemoConfiguration.Saver) {
+                        mutableStateOf(DemoConfiguration(isFullscreen = isFullscreen))
+                    }
+
+                SideEffect {
+                    if (configuration.isFullscreen) {
+                        window.insetsController?.hide(WindowInsets.Type.statusBars())
+                    } else {
+                        window.insetsController?.show(WindowInsets.Type.statusBars())
+                    }
+                }
+
+                val indication = if (disableRipple) NoIndication else LocalIndication.current
+                CompositionLocalProvider(LocalIndication provides indication) {
+                    SystemUi(
+                        configuration,
+                        { configuration = it },
+                        Modifier.thenIf(!configuration.isFullscreen) {
+                            Modifier.safeDrawingPadding()
+                        },
+                        initialScene = initialScene,
+                    )
+                }
+
+                ReportDrawn()
+            }
+        }
+    }
+}
+
+@Composable
+private fun DemoTheme(content: @Composable () -> Unit) {
+    val context = LocalContext.current
+    val colorScheme =
+        if (isSystemInDarkTheme()) dynamicDarkColorScheme(context)
+        else dynamicLightColorScheme(context)
+    val typography = MaterialTheme.typography
+    val typographyWithGoogleSans = remember(typography) { typography.withGoogleSans() }
+
+    MaterialTheme(
+        colorScheme = colorScheme,
+        typography = typographyWithGoogleSans,
+        content = content,
+    )
+}
+
+private fun Typography.withGoogleSans(): Typography {
+    val brandFont = DeviceFontFamilyName("google-sans-text")
+    val plainFont = DeviceFontFamilyName("google-sans")
+
+    val brand =
+        FontFamily(
+            Font(brandFont, weight = FontWeight.Medium),
+            Font(brandFont, weight = FontWeight.Normal),
+        )
+
+    val plain =
+        FontFamily(
+            Font(plainFont, weight = FontWeight.Medium),
+            Font(plainFont, weight = FontWeight.Normal),
+        )
+
+    return this.copy(
+        displayLarge = this.displayLarge.copy(fontFamily = brand),
+        displayMedium = this.displayMedium.copy(fontFamily = brand),
+        displaySmall = this.displaySmall.copy(fontFamily = brand),
+        headlineLarge = this.headlineLarge.copy(fontFamily = brand),
+        headlineMedium = this.headlineMedium.copy(fontFamily = brand),
+        headlineSmall = this.headlineSmall.copy(fontFamily = brand),
+        titleLarge = this.titleLarge.copy(fontFamily = brand),
+        titleMedium = this.titleMedium.copy(fontFamily = plain),
+        titleSmall = this.titleSmall.copy(fontFamily = plain),
+        bodyLarge = this.bodyLarge.copy(fontFamily = plain),
+        bodyMedium = this.bodyMedium.copy(fontFamily = plain),
+        bodySmall = this.bodySmall.copy(fontFamily = plain),
+        labelLarge = this.labelLarge.copy(fontFamily = plain),
+        labelMedium = this.labelMedium.copy(fontFamily = plain),
+        labelSmall = this.labelSmall.copy(fontFamily = plain),
+    )
+}
+
+private data object NoIndication : IndicationNodeFactory {
+    override fun create(interactionSource: InteractionSource): DelegatableNode = NoIndicationNode()
+}
+
+private class NoIndicationNode : Modifier.Node(), DrawModifierNode {
+    override fun ContentDrawScope.draw() {
+        drawContent()
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt
new file mode 100644
index 000000000..dbc1ecbea
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/DemoConfiguration.kt
@@ -0,0 +1,768 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.animation.AnimatedVisibility
+import androidx.compose.animation.animateContentSize
+import androidx.compose.animation.core.Spring
+import androidx.compose.animation.expandVertically
+import androidx.compose.foundation.border
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.width
+import androidx.compose.foundation.rememberScrollState
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.foundation.verticalScroll
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.Add
+import androidx.compose.material.icons.filled.Remove
+import androidx.compose.material3.AlertDialog
+import androidx.compose.material3.Button
+import androidx.compose.material3.Checkbox
+import androidx.compose.material3.FilledTonalButton
+import androidx.compose.material3.Icon
+import androidx.compose.material3.IconButton
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Slider
+import androidx.compose.material3.Text
+import androidx.compose.material3.TriStateCheckbox
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.DisposableEffect
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.mutableStateOf
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.saveable.mapSaver
+import androidx.compose.runtime.setValue
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.state.ToggleableState
+import androidx.compose.ui.text.style.TextAlign
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ProgressConverter
+import com.android.compose.animation.scene.demo.DemoOverscrollProgress.Tanh
+import kotlin.math.roundToInt
+import kotlin.math.tanh
+
+data class DemoConfiguration(
+    val notificationsInLockscreen: Int = 2,
+    val notificationsInShade: Int = 10,
+    val interactiveNotifications: Boolean = false,
+    val showMediaPlayer: Boolean = true,
+    val isFullscreen: Boolean = false,
+    val canChangeSceneOrOverlays: Boolean = true,
+    val transitionInterceptionThreshold: Float = 0.05f,
+    val springConfigurations: DemoSpringConfigurations = DemoSpringConfigurations.presets[1],
+    val useOverscrollSpec: Boolean = true,
+    val overscrollProgressConverter: DemoOverscrollProgress = Tanh(maxProgress = 0.2f, tilt = 3f),
+    val enableInterruptions: Boolean = true,
+    val lsToShadeRequiresFullSwipe: ToggleableState = ToggleableState.Indeterminate,
+    val enableOverlays: Boolean = false,
+) {
+    companion object {
+        val Saver = run {
+            val notificationsInLockscreenKey = "notificationsInLockscreen"
+            val notificationsInShadeKey = "notificationsInShade"
+            val interactiveNotificationsKey = "interactiveNotifications"
+            val showMediaPlayerKey = "showMediaPlayer"
+            val isFullscreenKey = "isFullscreen"
+            val canChangeSceneOrOverlaysKey = "canChangeSceneOrOverlays"
+            val transitionInterceptionThresholdKey = "transitionInterceptionThreshold"
+            val springConfigurationsKey = "springConfigurations"
+            val useOverscrollSpec = "useOverscrollSpec"
+            val overscrollProgress = "overscrollProgress"
+            val enableInterruptions = "enableInterruptions"
+            val lsToShadeRequiresFullSwipe = "lsToShadeRequiresFullSwipe"
+
+            mapSaver(
+                save = {
+                    mapOf(
+                        notificationsInLockscreenKey to it.notificationsInLockscreen,
+                        notificationsInShadeKey to it.notificationsInShade,
+                        interactiveNotificationsKey to it.interactiveNotifications,
+                        showMediaPlayerKey to it.showMediaPlayer,
+                        isFullscreenKey to it.isFullscreen,
+                        canChangeSceneOrOverlaysKey to it.canChangeSceneOrOverlays,
+                        transitionInterceptionThresholdKey to it.transitionInterceptionThreshold,
+                        springConfigurationsKey to it.springConfigurations.save(),
+                        useOverscrollSpec to it.useOverscrollSpec,
+                        overscrollProgress to it.overscrollProgressConverter.save(),
+                        enableInterruptions to it.enableInterruptions,
+                        lsToShadeRequiresFullSwipe to it.lsToShadeRequiresFullSwipe,
+                    )
+                },
+                restore = {
+                    DemoConfiguration(
+                        notificationsInLockscreen = it[notificationsInLockscreenKey] as Int,
+                        notificationsInShade = it[notificationsInShadeKey] as Int,
+                        interactiveNotifications = it[interactiveNotificationsKey] as Boolean,
+                        showMediaPlayer = it[showMediaPlayerKey] as Boolean,
+                        isFullscreen = it[isFullscreenKey] as Boolean,
+                        canChangeSceneOrOverlays = it[canChangeSceneOrOverlaysKey] as Boolean,
+                        transitionInterceptionThreshold =
+                            it[transitionInterceptionThresholdKey] as Float,
+                        springConfigurations =
+                            it[springConfigurationsKey].restoreSpringConfigurations(),
+                        useOverscrollSpec = it[useOverscrollSpec] as Boolean,
+                        overscrollProgressConverter =
+                            it[overscrollProgress].restoreOverscrollProgress(),
+                        enableInterruptions = it[enableInterruptions] as Boolean,
+                        lsToShadeRequiresFullSwipe =
+                            it[lsToShadeRequiresFullSwipe] as ToggleableState,
+                    )
+                },
+            )
+        }
+    }
+}
+
+data class DemoSpringConfigurations(
+    val name: String,
+    val systemUiSprings: SpringConfiguration,
+    val notificationSprings: SpringConfiguration,
+) {
+    fun save(): String =
+        listOf(
+                systemUiSprings.stiffness,
+                systemUiSprings.dampingRatio,
+                notificationSprings.stiffness,
+                notificationSprings.dampingRatio,
+            )
+            .joinToString(",")
+
+    companion object {
+        val presets =
+            listOf(
+                DemoSpringConfigurations(
+                    name = "Fast",
+                    systemUiSprings =
+                        SpringConfiguration(Spring.StiffnessMedium, Spring.DampingRatioNoBouncy),
+                    notificationSprings =
+                        SpringConfiguration(Spring.StiffnessMedium, Spring.DampingRatioNoBouncy),
+                ),
+                DemoSpringConfigurations(
+                    name = "Normal",
+                    systemUiSprings =
+                        SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioNoBouncy),
+                    notificationSprings =
+                        SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioNoBouncy),
+                ),
+                DemoSpringConfigurations(
+                    name = "SlowBouncy",
+                    systemUiSprings =
+                        SpringConfiguration(
+                            stiffness = (Spring.StiffnessLow + Spring.StiffnessVeryLow) / 2f,
+                            dampingRatio = 0.85f,
+                        ),
+                    notificationSprings =
+                        SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioLowBouncy),
+                ),
+                DemoSpringConfigurations(
+                    name = "Less Bouncy",
+                    systemUiSprings =
+                        SpringConfiguration(
+                            stiffness = (Spring.StiffnessMediumLow + Spring.StiffnessLow) / 2f,
+                            dampingRatio = 0.8f,
+                        ),
+                    notificationSprings =
+                        SpringConfiguration(
+                            stiffness = Spring.StiffnessMediumLow,
+                            dampingRatio = 0.8f,
+                        ),
+                ),
+                DemoSpringConfigurations(
+                    name = "Bouncy",
+                    systemUiSprings =
+                        SpringConfiguration(
+                            stiffness = (Spring.StiffnessMediumLow + Spring.StiffnessLow) / 2f,
+                            dampingRatio = Spring.DampingRatioLowBouncy,
+                        ),
+                    notificationSprings =
+                        SpringConfiguration(Spring.StiffnessMediumLow, Spring.DampingRatioLowBouncy),
+                ),
+                DemoSpringConfigurations(
+                    name = "VeryBouncy",
+                    systemUiSprings =
+                        SpringConfiguration(Spring.StiffnessLow, Spring.DampingRatioMediumBouncy),
+                    notificationSprings =
+                        SpringConfiguration(
+                            Spring.StiffnessMediumLow,
+                            Spring.DampingRatioMediumBouncy,
+                        ),
+                ),
+            )
+
+        private fun List<Pair<Float, String>>.addIntermediateValues(): List<Pair<Float, String>> =
+            flatMapIndexed { index, curr ->
+                if (index == 0) {
+                    listOf(curr)
+                } else {
+                    val prev = get(index - 1)
+                    val incr = (curr.first - prev.first) / 4f
+                    listOf(
+                        prev.first + incr * 1f to "${prev.second}+",
+                        prev.first + incr * 2f to "${prev.second}++",
+                        prev.first + incr * 3f to "${prev.second}+++",
+                        curr,
+                    )
+                }
+            }
+
+        private val stiffnessPairs =
+            listOf(
+                    Spring.StiffnessVeryLow to "VeryLow",
+                    Spring.StiffnessLow to "Low",
+                    Spring.StiffnessMediumLow to "MediumLow",
+                    Spring.StiffnessMedium to "Medium",
+                    Spring.StiffnessHigh to "High",
+                )
+                .addIntermediateValues()
+
+        val stiffnessNames = stiffnessPairs.toMap()
+        val stiffnessValues = stiffnessPairs.map { it.first }
+
+        private val dampingRatioPairs =
+            listOf(
+                    Spring.DampingRatioNoBouncy to "NoBouncy",
+                    0.85f to "VeryLow",
+                    Spring.DampingRatioLowBouncy to "Low",
+                    Spring.DampingRatioMediumBouncy to "Medium",
+                    Spring.DampingRatioHighBouncy to "High",
+                )
+                .addIntermediateValues()
+        val dampingRatioNames = dampingRatioPairs.toMap()
+        val dampingRatioValues = dampingRatioPairs.map { it.first }
+    }
+}
+
+sealed class DemoOverscrollProgress(val name: String, val params: LinkedHashMap<String, Any>) :
+    ProgressConverter {
+    // Note: the order is guaranteed because we are using an ordered map (LinkedHashMap).
+    fun save(): String = "$name:${params.values.joinToString(",")}"
+
+    data object Linear : DemoOverscrollProgress("linear", linkedMapOf()) {
+        override fun convert(value: Float) = value
+    }
+
+    data class RubberBand(val factor: Float) :
+        DemoOverscrollProgress("rubberBand", linkedMapOf("factor" to factor)) {
+        override fun convert(value: Float) = value * factor
+    }
+
+    data class Tanh(val maxProgress: Float, val tilt: Float) :
+        DemoOverscrollProgress("tanh", linkedMapOf("maxValue" to maxProgress, "tilt" to tilt)) {
+        override fun convert(value: Float) = maxProgress * tanh(value / (maxProgress * tilt))
+    }
+
+    companion object {
+        // We are using "by lazy" to avoid a null pointer on "Linear", read more on
+        // https://medium.com/livefront/kotlin-a-tale-of-static-cyclical-initialization-3aea530d2053
+        val presets by lazy {
+            listOf(
+                Linear,
+                RubberBand(factor = 0.1f),
+                RubberBand(factor = 0.15f),
+                RubberBand(factor = 0.21f),
+                Tanh(maxProgress = 1f, tilt = 1f),
+                Tanh(maxProgress = 0.5f, tilt = 1f),
+                Tanh(maxProgress = 0.5f, tilt = 1.5f),
+                Tanh(maxProgress = 0.7f, tilt = 2f),
+                Tanh(maxProgress = 0.2f, tilt = 3f),
+            )
+        }
+    }
+}
+
+private fun Any?.restoreSpringConfigurations(): DemoSpringConfigurations {
+    val p = (this as String).split(",").map { it.toFloat() }
+    return DemoSpringConfigurations(
+        name = "Custom",
+        systemUiSprings = SpringConfiguration(stiffness = p[0], dampingRatio = p[1]),
+        notificationSprings = SpringConfiguration(stiffness = p[2], dampingRatio = p[3]),
+    )
+}
+
+private fun Any?.restoreOverscrollProgress(): DemoOverscrollProgress {
+    val (name, paramsString) = (this as String).split(":")
+    val p = paramsString.split(",")
+    return when (name) {
+        "linear" -> DemoOverscrollProgress.Linear
+        "tanh" -> DemoOverscrollProgress.Tanh(maxProgress = p[0].toFloat(), tilt = p[1].toFloat())
+        "rubberBand" -> DemoOverscrollProgress.RubberBand(factor = p[0].toFloat())
+        else -> error("Unknown OverscrollProgress $name ($paramsString)")
+    }
+}
+
+data class SpringConfiguration(val stiffness: Float, val dampingRatio: Float)
+
+@Composable
+fun DemoConfigurationDialog(
+    configuration: DemoConfiguration,
+    onConfigurationChange: (DemoConfiguration) -> Unit,
+    onDismissRequest: () -> Unit,
+) {
+    AlertDialog(
+        onDismissRequest = onDismissRequest,
+        title = { Text("Demo configuration") },
+        text = {
+            Column(Modifier.fillMaxWidth().verticalScroll(rememberScrollState())) {
+                Text(text = "Generic app settings", style = MaterialTheme.typography.titleMedium)
+
+                // Fullscreen.
+                Checkbox(
+                    label = "Fullscreen",
+                    checked = configuration.isFullscreen,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(isFullscreen = !configuration.isFullscreen)
+                        )
+                    },
+                )
+
+                // Interruptions.
+                Checkbox(
+                    label = "Interruptions",
+                    checked = configuration.enableInterruptions,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(
+                                enableInterruptions = !configuration.enableInterruptions
+                            )
+                        )
+                    },
+                )
+
+                // Can change scene.
+                Checkbox(
+                    label = "Can change scene or overlays",
+                    checked = configuration.canChangeSceneOrOverlays,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(
+                                canChangeSceneOrOverlays = !configuration.canChangeSceneOrOverlays
+                            )
+                        )
+                    },
+                )
+
+                // Overlays.
+                Checkbox(
+                    label = "Overlays",
+                    checked = configuration.enableOverlays,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(enableOverlays = !configuration.enableOverlays)
+                        )
+                    },
+                )
+
+                Text(text = "Springs", style = MaterialTheme.typography.titleMedium)
+
+                SpringsPicker(
+                    value = configuration.springConfigurations,
+                    onValue = {
+                        onConfigurationChange(configuration.copy(springConfigurations = it))
+                    },
+                )
+
+                Text(text = "Scrollable", style = MaterialTheme.typography.titleMedium)
+
+                // Interception threshold.
+                val thresholdString =
+                    String.format("%.2f", configuration.transitionInterceptionThreshold)
+                Text(text = "Interception threshold: $thresholdString")
+                Slider(
+                    value = configuration.transitionInterceptionThreshold,
+                    onValueChange = {
+                        onConfigurationChange(
+                            configuration.copy(transitionInterceptionThreshold = it)
+                        )
+                    },
+                    valueRange = 0f..0.5f,
+                    stepSize = 0.01f,
+                )
+
+                Text(text = "Overscroll", style = MaterialTheme.typography.titleMedium)
+
+                Checkbox(
+                    label = "Use Overscroll Spec",
+                    checked = configuration.useOverscrollSpec,
+                    onCheckedChange = {
+                        onConfigurationChange(configuration.copy(useOverscrollSpec = it))
+                    },
+                )
+
+                OverscrollProgressPicker(
+                    value = configuration.overscrollProgressConverter,
+                    onValue = {
+                        onConfigurationChange(configuration.copy(overscrollProgressConverter = it))
+                    },
+                )
+
+                Text(text = "Media", style = MaterialTheme.typography.titleMedium)
+
+                // Whether we should show the media player.
+                Checkbox(
+                    label = "Show media player",
+                    checked = configuration.showMediaPlayer,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(showMediaPlayer = !configuration.showMediaPlayer)
+                        )
+                    },
+                )
+
+                Text(text = "Notifications", style = MaterialTheme.typography.titleMedium)
+
+                // Whether notifications are interactive
+                Checkbox(
+                    label = "Interactive notifications",
+                    checked = configuration.interactiveNotifications,
+                    onCheckedChange = {
+                        onConfigurationChange(
+                            configuration.copy(
+                                interactiveNotifications = !configuration.interactiveNotifications
+                            )
+                        )
+                    },
+                )
+
+                // Number of notifications in the Shade scene.
+                Counter(
+                    "# notifications in Shade",
+                    configuration.notificationsInShade,
+                    onValueChange = {
+                        onConfigurationChange(configuration.copy(notificationsInShade = it))
+                    },
+                )
+
+                // Number of notifications in the Lockscreen scene.
+                Counter(
+                    "# notifications in Lockscreen",
+                    configuration.notificationsInLockscreen,
+                    onValueChange = {
+                        onConfigurationChange(configuration.copy(notificationsInLockscreen = it))
+                    },
+                )
+
+                Text(text = "Lockscreen", style = MaterialTheme.typography.titleMedium)
+
+                // Whether the LS => Shade transition requires a full distance swipe to be
+                // committed.
+                Checkbox(
+                    label = "Require full LS => Shade swipe",
+                    state = configuration.lsToShadeRequiresFullSwipe,
+                    onStateChange = {
+                        onConfigurationChange(configuration.copy(lsToShadeRequiresFullSwipe = it))
+                    },
+                )
+            }
+        },
+        confirmButton = { Button(onClick = { onDismissRequest() }) { Text("Done") } },
+        dismissButton = {
+            Button(onClick = { onConfigurationChange(DemoConfiguration()) }) { Text("Reset") }
+        },
+    )
+}
+
+@Composable
+private fun Checkbox(
+    label: String,
+    checked: Boolean,
+    onCheckedChange: (Boolean) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Row(
+        modifier
+            .fillMaxWidth()
+            .clip(MaterialTheme.shapes.small)
+            .clickable(onClick = { onCheckedChange(!checked) }),
+        verticalAlignment = Alignment.CenterVertically,
+    ) {
+        Checkbox(checked, onCheckedChange)
+        Text(label, Modifier.padding(start = 8.dp))
+    }
+}
+
+@Composable
+private fun Checkbox(
+    label: String,
+    state: ToggleableState,
+    onStateChange: (ToggleableState) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    fun onClick() {
+        onStateChange(
+            when (state) {
+                ToggleableState.On -> ToggleableState.Off
+                ToggleableState.Off -> ToggleableState.Indeterminate
+                ToggleableState.Indeterminate -> ToggleableState.On
+            }
+        )
+    }
+
+    Row(
+        modifier.fillMaxWidth().clip(MaterialTheme.shapes.small).clickable(onClick = ::onClick),
+        verticalAlignment = Alignment.CenterVertically,
+    ) {
+        TriStateCheckbox(state, onClick = ::onClick)
+        Text(label, Modifier.padding(start = 8.dp))
+    }
+}
+
+@Composable
+private fun Counter(
+    label: String,
+    value: Int,
+    onValueChange: (Int) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Row(modifier, verticalAlignment = Alignment.CenterVertically) {
+        IconButton(onClick = { onValueChange((value - 1).coerceAtLeast(0)) }) {
+            Icon(Icons.Default.Remove, null)
+        }
+        Text(value.toString(), Modifier.width(18.dp), textAlign = TextAlign.Center)
+        IconButton(onClick = { onValueChange((value + 1)) }) { Icon(Icons.Default.Add, null) }
+        Text(label, Modifier.padding(start = 8.dp))
+    }
+}
+
+@Composable
+private fun <T> Slider(
+    value: T,
+    onValueChange: (T) -> Unit,
+    values: List<T>,
+    onValueNotFound: () -> Int = { 0 },
+) {
+    Slider(
+        value = (values.indexOf(value).takeIf { it != -1 } ?: onValueNotFound()).toFloat(),
+        onValueChange = { onValueChange(values[it.roundToInt()]) },
+        valueRange = 0f..values.lastIndex.toFloat(),
+        steps = values.lastIndex - 1,
+    )
+}
+
+@Composable
+private fun Slider(
+    value: Float,
+    onValueChange: (Float) -> Unit,
+    valueRange: ClosedFloatingPointRange<Float> = 0f..1f,
+    stepSize: Float,
+) {
+    Slider(
+        value = value,
+        onValueChange = onValueChange,
+        valueRange = valueRange,
+        steps = ((valueRange.endInclusive - valueRange.start) / stepSize).toInt() - 1,
+    )
+}
+
+@Composable
+fun SpringsPicker(value: DemoSpringConfigurations, onValue: (DemoSpringConfigurations) -> Unit) {
+    Text(text = "Selected: ${value.name}")
+    Slider(value = value, onValueChange = onValue, values = DemoSpringConfigurations.presets)
+
+    var isExpanded by remember { mutableStateOf(value.name == "Custom") }
+    DisposableEffect(value) { onDispose { isExpanded = true } }
+    if (!isExpanded) FilledTonalButton(onClick = { isExpanded = true }) { Text("Show more") }
+
+    AnimatedVisibility(isExpanded, enter = expandVertically()) {
+        Column(
+            Modifier.animateContentSize()
+                .border(1.dp, color = MaterialTheme.colorScheme.primary, RoundedCornerShape(8.dp))
+                .padding(4.dp)
+                .fillMaxWidth()
+        ) {
+            Text(text = "System Ui")
+
+            Text(
+                text =
+                    buildString {
+                        append("stiffness: ")
+                        append(String.format("%.2f", value.systemUiSprings.stiffness))
+                        append(" (")
+                        append(
+                            DemoSpringConfigurations.stiffnessNames[value.systemUiSprings.stiffness]
+                        )
+                        append(")")
+                    }
+            )
+
+            Slider(
+                value = value.systemUiSprings.stiffness,
+                onValueChange = {
+                    onValue(
+                        value.copy(
+                            name = "Custom",
+                            systemUiSprings = value.systemUiSprings.copy(stiffness = it),
+                        )
+                    )
+                },
+                values = DemoSpringConfigurations.stiffnessValues,
+            )
+
+            Text(
+                text =
+                    buildString {
+                        append("dampingRatio: ")
+                        append(String.format("%.2f", value.systemUiSprings.dampingRatio))
+                        append(" (")
+                        append(
+                            DemoSpringConfigurations.dampingRatioNames[
+                                    value.systemUiSprings.dampingRatio]
+                        )
+                        append(")")
+                    }
+            )
+
+            Slider(
+                value = value.systemUiSprings.dampingRatio,
+                onValueChange = {
+                    onValue(
+                        value.copy(
+                            name = "Custom",
+                            systemUiSprings = value.systemUiSprings.copy(dampingRatio = it),
+                        )
+                    )
+                },
+                DemoSpringConfigurations.dampingRatioValues,
+            )
+
+            Text(text = "Notification")
+
+            Text(
+                text =
+                    buildString {
+                        append("stiffness: ")
+                        append(String.format("%.2f", value.notificationSprings.stiffness))
+                        append(" (")
+                        append(
+                            DemoSpringConfigurations.stiffnessNames[
+                                    value.notificationSprings.stiffness]
+                        )
+                        append(")")
+                    }
+            )
+
+            Slider(
+                value = value.notificationSprings.stiffness,
+                onValueChange = {
+                    onValue(
+                        value.copy(
+                            name = "Custom",
+                            notificationSprings = value.notificationSprings.copy(stiffness = it),
+                        )
+                    )
+                },
+                DemoSpringConfigurations.stiffnessValues,
+            )
+
+            Text(
+                text =
+                    buildString {
+                        append("dampingRatio: ")
+                        append(String.format("%.2f", value.notificationSprings.dampingRatio))
+                        append(" (")
+                        append(
+                            DemoSpringConfigurations.dampingRatioNames[
+                                    value.notificationSprings.dampingRatio]
+                        )
+                        append(")")
+                    }
+            )
+
+            Slider(
+                value = value.notificationSprings.dampingRatio,
+                onValueChange = {
+                    onValue(
+                        value.copy(
+                            name = "Custom",
+                            notificationSprings = value.notificationSprings.copy(dampingRatio = it),
+                        )
+                    )
+                },
+                DemoSpringConfigurations.dampingRatioValues,
+            )
+        }
+    }
+}
+
+@Composable
+fun OverscrollProgressPicker(
+    value: DemoOverscrollProgress,
+    onValue: (DemoOverscrollProgress) -> Unit,
+) {
+    Text(text = "Overscroll progress")
+    val presets = DemoOverscrollProgress.presets
+    Slider(
+        value = value,
+        onValueChange = onValue,
+        values = DemoOverscrollProgress.presets,
+        onValueNotFound = { presets.indexOfFirst { it.name == value.name } },
+    )
+
+    var isExpanded by remember { mutableStateOf(false) }
+    DisposableEffect(value) { onDispose { isExpanded = true } }
+
+    Column(
+        Modifier.animateContentSize()
+            .border(1.dp, color = MaterialTheme.colorScheme.primary, RoundedCornerShape(8.dp))
+            .padding(4.dp)
+            .fillMaxWidth()
+    ) {
+        Text(text = "Function name: ${value.name}")
+        when (value) {
+            DemoOverscrollProgress.Linear -> {}
+            is DemoOverscrollProgress.Tanh -> {
+                Text(text = "Max progress: ${String.format("%.2f", value.maxProgress)}")
+                if (isExpanded) {
+                    Slider(
+                        value = value.maxProgress,
+                        onValueChange = { onValue(value.copy(maxProgress = it)) },
+                        valueRange = 0.05f..3f,
+                        stepSize = 0.05f,
+                    )
+                }
+                Text(text = "Tilt: ${String.format("%.2f", value.tilt)}")
+                if (isExpanded) {
+                    Slider(
+                        value = value.tilt,
+                        onValueChange = { onValue(value.copy(tilt = it)) },
+                        valueRange = 1f..5f,
+                        stepSize = 0.1f,
+                    )
+                }
+            }
+            is DemoOverscrollProgress.RubberBand -> {
+                Text(text = "Factor: ${String.format("%.2f", value.factor)}")
+                if (isExpanded) {
+                    Slider(
+                        value = value.factor,
+                        onValueChange = { onValue(value.copy(factor = it)) },
+                        valueRange = 0.01f..1f,
+                        stepSize = 0.01f,
+                    )
+                }
+            }
+        }
+    }
+
+    if (!isExpanded) FilledTonalButton(onClick = { isExpanded = true }) { Text("Show more") }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt
new file mode 100644
index 000000000..9fe8df27f
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/HorizontalHalfScreen.kt
@@ -0,0 +1,58 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.ui.unit.Density
+import androidx.compose.ui.unit.IntOffset
+import androidx.compose.ui.unit.IntSize
+import androidx.compose.ui.unit.LayoutDirection
+import com.android.compose.animation.scene.SwipeSource
+import com.android.compose.animation.scene.SwipeSourceDetector
+
+/** A [SwipeSource] for the left or right half of the device. */
+enum class HorizontalHalfScreen(private val onResolve: (LayoutDirection) -> Resolved) :
+    SwipeSource {
+    Left(onResolve = { Resolved.Left }),
+    Right(onResolve = { Resolved.Right }),
+    Start(onResolve = { if (it == LayoutDirection.Ltr) Resolved.Left else Resolved.Right }),
+    End(onResolve = { if (it == LayoutDirection.Ltr) Resolved.Right else Resolved.Left });
+
+    override fun resolve(layoutDirection: LayoutDirection): SwipeSource.Resolved {
+        return onResolve(layoutDirection)
+    }
+
+    enum class Resolved : SwipeSource.Resolved {
+        Left,
+        Right,
+    }
+}
+
+object HorizontalHalfScreenDetector : SwipeSourceDetector {
+    override fun source(
+        layoutSize: IntSize,
+        position: IntOffset,
+        density: Density,
+        orientation: Orientation,
+    ): SwipeSource.Resolved {
+        return if (position.x < layoutSize.width / 2) {
+            HorizontalHalfScreen.Resolved.Left
+        } else {
+            HorizontalHalfScreen.Resolved.Right
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt
new file mode 100644
index 000000000..e2cc555bf
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Launcher.kt
@@ -0,0 +1,90 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.Canvas
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.SwipeDirection
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+import com.android.compose.grid.VerticalGrid
+
+object Launcher {
+    fun userActions(
+        shadeScene: SceneKey,
+        configuration: DemoConfiguration,
+    ): Map<UserAction, UserActionResult> {
+        return buildList {
+                if (configuration.enableOverlays) {
+                    add(
+                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.Start) to
+                            UserActionResult.ShowOverlay(Overlays.QuickSettings)
+                    )
+                    add(
+                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.End) to
+                            UserActionResult.ShowOverlay(Overlays.Notifications)
+                    )
+                } else {
+                    add(Swipe.Down to shadeScene)
+                    add(Swipe(SwipeDirection.Down, pointerCount = 2) to Scenes.QuickSettings)
+                }
+            }
+            .toMap()
+    }
+
+    object Elements {
+        val Scene = ElementKey("LauncherScene")
+        val SmartSpace = ElementKey("SmartSpace")
+        val IconsGrid = ElementKey("LauncherIconsGrid")
+    }
+}
+
+@Composable
+fun SceneScope.Launcher(columnsCount: Int, modifier: Modifier = Modifier) {
+    Column(modifier.element(Launcher.Elements.Scene)) {
+        SmartSpace(
+            MaterialTheme.colorScheme.onBackground,
+            Modifier.element(Launcher.Elements.SmartSpace).padding(top = 40.dp, start = 40.dp),
+        )
+
+        VerticalGrid(columnsCount, Modifier.element(Launcher.Elements.IconsGrid).padding(16.dp)) {
+            val iconColor = MaterialTheme.colorScheme.tertiary
+            repeat(columnsCount * 5) {
+                Box(Modifier.fillMaxSize()) { AppIcon(iconColor, Modifier.align(Alignment.Center)) }
+            }
+        }
+    }
+}
+
+@Composable
+private fun AppIcon(color: Color, modifier: Modifier = Modifier) {
+    Canvas(modifier.size(60.dp)) { drawCircle(color) }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt
new file mode 100644
index 000000000..77fbf8c4e
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Lockscreen.kt
@@ -0,0 +1,184 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.ExperimentalFoundationApi
+import androidx.compose.foundation.background
+import androidx.compose.foundation.combinedClickable
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.shape.CircleShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.Lock
+import androidx.compose.material.icons.filled.LockOpen
+import androidx.compose.material3.Icon
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.SwipeDirection
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+
+object Lockscreen {
+    fun userActions(
+        isLockscreenDismissable: Boolean,
+        shadeScene: SceneKey,
+        requiresFullDistanceSwipeToShade: Boolean,
+        configuration: DemoConfiguration,
+        fastSwipeToQuickSettings: Boolean = true,
+    ): Map<UserAction, UserActionResult> {
+        return buildList {
+                if (configuration.enableOverlays) {
+                    add(
+                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.Start) to
+                            UserActionResult.ShowOverlay(
+                                Overlays.QuickSettings,
+                                requiresFullDistanceSwipe = requiresFullDistanceSwipeToShade,
+                            )
+                    )
+                    add(
+                        Swipe(SwipeDirection.Down, fromSource = HorizontalHalfScreen.End) to
+                            UserActionResult.ShowOverlay(
+                                Overlays.Notifications,
+                                requiresFullDistanceSwipe = requiresFullDistanceSwipeToShade,
+                            )
+                    )
+                } else {
+                    add(
+                        Swipe.Down to
+                            UserActionResult(
+                                shadeScene,
+                                requiresFullDistanceSwipe = requiresFullDistanceSwipeToShade,
+                            )
+                    )
+                }
+
+                add(Swipe.Start to Scenes.StubEnd)
+                add(Swipe.End to Scenes.StubStart)
+                add(
+                    Swipe.Up to
+                        if (isLockscreenDismissable) {
+                            Scenes.Launcher
+                        } else {
+                            Scenes.Bouncer
+                        }
+                )
+
+                if (fastSwipeToQuickSettings) {
+                    add(Swipe(SwipeDirection.Down, pointerCount = 2) to Scenes.QuickSettings)
+                }
+            }
+            .toMap()
+    }
+
+    object Elements {
+        val Scene = ElementKey("LockscreenScene")
+        val LockButton = ElementKey("LockscreenLockButton")
+    }
+}
+
+@Composable
+fun SceneScope.Lockscreen(
+    notificationList: @Composable SceneScope.() -> Unit,
+    mediaPlayer: (@Composable SceneScope.() -> Unit)?,
+    isDismissable: Boolean,
+    onToggleDismissable: () -> Unit,
+    onChangeScene: (SceneKey) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Column(modifier.element(Lockscreen.Elements.Scene).fillMaxSize()) {
+        StatusBar(showDateAndTime = false, Modifier.padding(horizontal = 16.dp))
+
+        Column(Modifier.padding(start = 16.dp, bottom = 16.dp)) {
+            Clock(MaterialTheme.colorScheme.onSurfaceVariant)
+            SmartSpace(MaterialTheme.colorScheme.onSurface)
+        }
+
+        if (mediaPlayer != null) {
+            Box(Modifier.padding(horizontal = 16.dp)) { mediaPlayer() }
+        }
+
+        Box(Modifier.weight(1f)) { notificationList() }
+
+        LockButton(
+            isDismissable,
+            onToggleDismissable,
+            onChangeScene,
+            Modifier.align(Alignment.CenterHorizontally).padding(top = 16.dp),
+        )
+
+        LockscreenCameraButton(
+            onClick = { onChangeScene(Scenes.Camera) },
+            Modifier.align(Alignment.End),
+        )
+    }
+}
+
+@Composable
+@OptIn(ExperimentalFoundationApi::class)
+internal fun SceneScope.LockButton(
+    isDismissable: Boolean,
+    onToggleDismissable: () -> Unit,
+    onChangeScene: (SceneKey) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Box(
+        modifier
+            .element(Lockscreen.Elements.LockButton)
+            .size(70.dp)
+            .background(MaterialTheme.colorScheme.surfaceBright, shape = CircleShape)
+            .clip(CircleShape)
+            .combinedClickable(
+                onClick = onToggleDismissable,
+                onLongClick = {
+                    if (isDismissable) {
+                        onChangeScene(Scenes.Launcher)
+                    } else {
+                        onChangeScene(Scenes.Bouncer)
+                    }
+                },
+            ),
+        contentAlignment = Alignment.Center,
+    ) {
+        val icon = if (isDismissable) Icons.Default.LockOpen else Icons.Default.Lock
+        Icon(
+            imageVector = icon,
+            contentDescription = null,
+            tint = MaterialTheme.colorScheme.onSurface,
+        )
+    }
+}
+
+@Composable
+internal fun SceneScope.LockscreenCameraButton(onClick: () -> Unit, modifier: Modifier = Modifier) {
+    CameraButton(
+        backgroundColor = MaterialTheme.colorScheme.surfaceBright,
+        iconColor = MaterialTheme.colorScheme.onSurface,
+        onClick,
+        modifier.padding(top = 16.dp, start = 16.dp, end = 32.dp, bottom = 32.dp).size(48.dp),
+    )
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/MediaPlayer.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/MediaPlayer.kt
new file mode 100644
index 000000000..98c62d021
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/MediaPlayer.kt
@@ -0,0 +1,227 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.animation.core.LinearEasing
+import androidx.compose.animation.core.Spring
+import androidx.compose.animation.core.animateDpAsState
+import androidx.compose.animation.core.animateFloat
+import androidx.compose.animation.core.infiniteRepeatable
+import androidx.compose.animation.core.rememberInfiniteTransition
+import androidx.compose.animation.core.spring
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.Canvas
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.BoxScope
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.Pause
+import androidx.compose.material.icons.filled.PlayArrow
+import androidx.compose.material3.FilledIconButton
+import androidx.compose.material3.Icon
+import androidx.compose.material3.IconButtonDefaults
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.derivedStateOf
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.remember
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.geometry.Offset
+import androidx.compose.ui.graphics.Path
+import androidx.compose.ui.graphics.drawscope.clipRect
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ContentKey
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.MovableElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.StaticElementContentPicker
+import com.android.compose.animation.scene.content.state.TransitionState
+import kotlin.math.ceil
+import kotlin.math.roundToInt
+
+object MediaPlayer {
+    object Elements {
+        val MediaPlayer = MovableElementKey("MediaPlayer", contentPicker = ContentPicker)
+    }
+
+    object Dimensions {
+        val Height = 150.dp
+    }
+
+    object Shapes {
+        val Background = RoundedCornerShape(24.dp)
+    }
+
+    object ContentPicker : StaticElementContentPicker {
+        override val contents =
+            setOf(
+                Scenes.Lockscreen,
+                Scenes.SplitLockscreen,
+                Scenes.Shade,
+                Scenes.SplitShade,
+                Scenes.QuickSettings,
+                Overlays.QuickSettings,
+            )
+
+        override fun contentDuringTransition(
+            element: ElementKey,
+            transition: TransitionState.Transition,
+            fromContentZIndex: Float,
+            toContentZIndex: Float,
+        ): ContentKey {
+            return when {
+                // During the Lockscreen => Shade transition, the media player is visible in the
+                // Lockscreen when progress is in [0; 0.5]. It is then visible in the Shade scene
+                // when progress is in [0.8; 1]. We move it half-way through, when progress = 0.65.
+                transition.isTransitioning(from = Scenes.Lockscreen, to = Scenes.Shade) -> {
+                    if (transition.progress < 0.65f) {
+                        Scenes.Lockscreen
+                    } else {
+                        Scenes.Shade
+                    }
+                }
+
+                // Same as Lockscreen => Shade, but with reversed progress.
+                transition.isTransitioning(from = Scenes.Shade, to = Scenes.Lockscreen) -> {
+                    if (transition.progress < 1f - 0.65f) {
+                        Scenes.Shade
+                    } else {
+                        Scenes.Lockscreen
+                    }
+                }
+
+                // When going from QS <=> Shade we always want to compose the media player in the QS
+                // scene, otherwise it will be drawn above the QS footer actions.
+                transition.isTransitioningBetween(Scenes.QuickSettings, Scenes.Shade) -> {
+                    Scenes.QuickSettings
+                }
+
+                // When going from SplitLockscreen to SplitShade, we always compose the media player
+                // in the SplitShade, otherwise the shade will fade above it.
+                transition.isTransitioningBetween(Scenes.SplitLockscreen, Scenes.SplitShade) ->
+                    Scenes.SplitShade
+                transition.isTransitioningBetween(Scenes.Lockscreen, Scenes.QuickSettings) ->
+                    Scenes.QuickSettings
+                transition.isTransitioningFromOrTo(Overlays.QuickSettings) -> Overlays.QuickSettings
+                else -> pickSingleContentIn(contents, transition, element)
+            }
+        }
+    }
+}
+
+@Composable
+fun SceneScope.MediaPlayer(
+    isPlaying: Boolean,
+    onIsPlayingChange: (Boolean) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    MovableElement(MediaPlayer.Elements.MediaPlayer, modifier) {
+        content {
+            Box(
+                Modifier.fillMaxWidth()
+                    .height(MediaPlayer.Dimensions.Height)
+                    .background(MaterialTheme.colorScheme.tertiary, MediaPlayer.Shapes.Background)
+                    .padding(16.dp)
+            ) {
+                FilledIconButton(
+                    onClick = { onIsPlayingChange(!isPlaying) },
+                    Modifier.align(Alignment.CenterEnd),
+                    colors =
+                        IconButtonDefaults.filledIconButtonColors(
+                            MaterialTheme.colorScheme.onTertiary
+                        ),
+                ) {
+                    val color = MaterialTheme.colorScheme.tertiary
+                    if (isPlaying) {
+                        Icon(Icons.Default.Pause, null, tint = color)
+                    } else {
+                        Icon(Icons.Default.PlayArrow, null, tint = color)
+                    }
+                }
+
+                Sinusoid(isPlaying = isPlaying)
+            }
+        }
+    }
+}
+
+@Composable
+private fun BoxScope.Sinusoid(isPlaying: Boolean, modifier: Modifier = Modifier) {
+    val color = MaterialTheme.colorScheme.onTertiary
+    val waveWidth = 10.dp
+    val maxWaveHeight = 5.dp
+    val lineWidth = 3.dp
+
+    val waveHeight by
+        animateDpAsState(
+            if (isPlaying) maxWaveHeight else 0.dp,
+            spring(stiffness = Spring.StiffnessMediumLow),
+        )
+
+    val shouldAnimateWave by remember { derivedStateOf { waveHeight > 0.dp } }
+    Box(
+        modifier.align(Alignment.BottomCenter).fillMaxWidth().height(maxWaveHeight * 2),
+        propagateMinConstraints = true,
+    ) {
+        if (shouldAnimateWave) {
+            val translation by
+                rememberInfiniteTransition()
+                    .animateFloat(
+                        0f,
+                        1f,
+                        infiniteRepeatable(tween(durationMillis = 1_000, easing = LinearEasing)),
+                    )
+
+            val path = remember { Path() }
+            Canvas(Modifier) {
+                val waveWidthPx = waveWidth.toPx()
+                val waveHeightPx = waveHeight.toPx()
+                val lineWidthPx = lineWidth.toPx()
+
+                clipRect {
+                    path.reset()
+
+                    repeat(ceil(size.width / (waveWidthPx * 2)).roundToInt() + 1) { i ->
+                        path.moveTo((i - translation) * waveWidthPx * 2, center.y - lineWidthPx / 2)
+                        path.relativeQuadraticTo(waveWidthPx / 2, -waveHeightPx, waveWidthPx, 0f)
+                        path.relativeQuadraticTo(waveWidthPx / 2, waveHeightPx, waveWidthPx, 0f)
+                        path.relativeLineTo(0f, lineWidthPx)
+                        path.relativeQuadraticTo(-waveWidthPx / 2, waveHeightPx, -waveWidthPx, 0f)
+                        path.relativeQuadraticTo(-waveWidthPx / 2, -waveHeightPx, -waveWidthPx, 0f)
+                        path.close()
+                    }
+
+                    drawPath(path, color)
+                }
+            }
+        } else {
+            Canvas(Modifier) {
+                drawLine(
+                    color,
+                    start = Offset(0f, center.y),
+                    end = Offset(size.width, center.y),
+                    strokeWidth = lineWidth.toPx(),
+                )
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt
new file mode 100644
index 000000000..cf0b6aeb2
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/NotificationShade.kt
@@ -0,0 +1,57 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.PaddingValues
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.UserActionResult
+
+object NotificationShade {
+    object Elements {
+        val Root = ElementKey("NotificationShadeRoot")
+        val Content = ElementKey("NotificationShadeContent")
+    }
+
+    val UserActions =
+        mapOf(
+            Back to UserActionResult.HideOverlay(Overlays.Notifications),
+            Swipe.Up to UserActionResult.HideOverlay(Overlays.Notifications),
+            Swipe.Left to UserActionResult.ReplaceByOverlay(Overlays.QuickSettings),
+        )
+}
+
+@Composable
+fun SceneScope.NotificationShade(
+    notificationList: @Composable SceneScope.() -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    PartialShade(
+        modifier.element(NotificationShade.Elements.Root),
+
+        // The notification list already applies some padding.
+        innerPadding = PaddingValues(0.dp),
+    ) {
+        Column(Modifier.element(NotificationShade.Elements.Content)) { notificationList() }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt
new file mode 100644
index 000000000..81e624041
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/PartialShade.kt
@@ -0,0 +1,125 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.BoxScope
+import androidx.compose.foundation.layout.PaddingValues
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.geometry.Offset
+import androidx.compose.ui.geometry.Size
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.graphics.drawscope.ContentDrawScope
+import androidx.compose.ui.layout.LayoutCoordinates
+import androidx.compose.ui.layout.positionInWindow
+import androidx.compose.ui.node.DrawModifierNode
+import androidx.compose.ui.node.LayoutAwareModifierNode
+import androidx.compose.ui.node.ModifierNodeElement
+import androidx.compose.ui.node.invalidateDraw
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.LowestZIndexContentPicker
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.modifiers.thenIf
+
+object PartialShade {
+    object Elements {
+        val Background =
+            ElementKey("PartialShadeBackground", contentPicker = LowestZIndexContentPicker)
+    }
+
+    object Colors {
+        val Background
+            @Composable get() = Shade.Colors.Scrim
+    }
+
+    object Shapes {
+        val Background =
+            RoundedCornerShape(
+                bottomStart = Shade.Dimensions.ScrimCornerSize,
+                bottomEnd = Shade.Dimensions.ScrimCornerSize,
+            )
+        val SplitBackground = RoundedCornerShape(Shade.Dimensions.ScrimCornerSize)
+    }
+}
+
+@Composable
+fun SceneScope.PartialShade(
+    modifier: Modifier = Modifier,
+    outerPadding: PaddingValues = PaddingValues(16.dp),
+    innerPadding: PaddingValues = PaddingValues(16.dp),
+    content: @Composable BoxScope.() -> Unit,
+) {
+    val isSplitShade = shouldUseSplitScenes(calculateWindowSizeClass())
+
+    Box(
+        modifier.fillMaxWidth(if (isSplitShade) 0.5f else 1f).thenIf(isSplitShade) {
+            Modifier.padding(outerPadding)
+        }
+    ) {
+        val backgroundColor = PartialShade.Colors.Background
+        Box(
+            Modifier.element(PartialShade.Elements.Background)
+                .matchParentSize()
+                .thenIf(!isSplitShade) { Modifier.then(ExtraBackgroundElement(backgroundColor)) }
+                .background(
+                    backgroundColor,
+                    if (isSplitShade) PartialShade.Shapes.SplitBackground
+                    else PartialShade.Shapes.Background,
+                )
+        )
+
+        Box(Modifier.padding(innerPadding), content = content)
+    }
+}
+
+// A modifier that ensures that there is no hole between the shade and the top of the device when
+// overscrolling it in non-split mode.
+private data class ExtraBackgroundElement(val color: Color) :
+    ModifierNodeElement<ExtraBackgroundNode>() {
+    override fun create(): ExtraBackgroundNode = ExtraBackgroundNode(color)
+
+    override fun update(node: ExtraBackgroundNode) {
+        node.color = color
+    }
+}
+
+private class ExtraBackgroundNode(var color: Color) :
+    Modifier.Node(), LayoutAwareModifierNode, DrawModifierNode {
+    private var lastY = 0f
+
+    override fun onPlaced(coordinates: LayoutCoordinates) {
+        val y = coordinates.positionInWindow().y
+        if (y != lastY) {
+            lastY = y
+            invalidateDraw()
+        }
+    }
+
+    override fun ContentDrawScope.draw() {
+        if (lastY > 0) {
+            drawRect(color, topLeft = Offset(0f, -lastY), size = Size(size.width, lastY))
+        }
+
+        drawContent()
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt
new file mode 100644
index 000000000..e4a8491df
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettings.kt
@@ -0,0 +1,272 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.ExperimentalFoundationApi
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Arrangement
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.pager.PagerState
+import androidx.compose.foundation.rememberScrollState
+import androidx.compose.foundation.shape.CircleShape
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.foundation.verticalScroll
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.Brightness5
+import androidx.compose.material.icons.filled.PowerSettingsNew
+import androidx.compose.material.icons.filled.Settings
+import androidx.compose.material3.FilledIconButton
+import androidx.compose.material3.Icon
+import androidx.compose.material3.IconButtonDefaults
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.material3.Text
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.res.colorResource
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.LowestZIndexContentPicker
+import com.android.compose.animation.scene.NestedScrollBehavior
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.SwipeDirection
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+
+object QuickSettings {
+    /**
+     * The progress from which we can assume that the QuickSettings => Shade transition is
+     * *visually* committed. This is used so that if the QS pager is not on the first page when the
+     * transition started, and we swipe up to the Shade scene (which shows the first n tiles) such
+     * that the transition is at least 97%, then swiping down will reset the QS pager to the first
+     * page and those first tiles will be shared.
+     */
+    val TransitionToShadeCommittedProgress = 0.97f
+
+    fun userActions(
+        shadeScene: SceneKey,
+        lockscreenScene: SceneKey,
+        isLockscreenDismissed: Boolean,
+    ): Map<UserAction, UserActionResult> {
+        val fastSwipeUpScene = if (isLockscreenDismissed) Scenes.Launcher else lockscreenScene
+        return mapOf(
+            Back to shadeScene,
+            Swipe.Up to shadeScene,
+            Swipe(SwipeDirection.Up, pointerCount = 2) to fastSwipeUpScene,
+            Swipe(SwipeDirection.Up, fromSource = Edge.Bottom) to fastSwipeUpScene,
+        )
+    }
+
+    object Elements {
+        val Background =
+            ElementKey("QuickSettingsBackground", contentPicker = LowestZIndexContentPicker)
+        val Date = ElementKey("QuickSettingsDate")
+        val Operator = ElementKey("QuickSettingsOperator")
+        val BrightnessSlider = ElementKey("QuickSettingsBrightnessSlider")
+        val ExpandedGrid = ElementKey("QuickSettingsExpandedGrid")
+        val PagerIndicators = ElementKey("QuickSettingsPagerIndicator")
+        val FooterActions = ElementKey("QuickSettingsFooterActions")
+    }
+
+    object Dimensions {
+        val Padding = 16.dp
+        val FooterActionsPadding = 16.dp
+        val FooterActionsBottomPadding = 32.dp
+        val FooterActionsButtonSize = 40.dp
+    }
+
+    object Shapes {
+        val FooterActionsBackground = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp)
+    }
+
+    object Modifiers {
+        val HorizontalPadding = Modifier.padding(horizontal = Dimensions.Padding)
+    }
+}
+
+@Composable
+@OptIn(ExperimentalFoundationApi::class)
+fun SceneScope.QuickSettings(
+    pagerState: PagerState,
+    tiles: List<QuickSettingsTileViewModel>,
+    nGridRows: Int,
+    nGridColumns: Int,
+    mediaPlayer: (@Composable SceneScope.() -> Unit)?,
+    onSettingsButtonClicked: () -> Unit,
+    onPowerButtonClicked: () -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Box(modifier) {
+        QuickSettingsBackground(Modifier.fillMaxSize())
+
+        CompositionLocalProvider(LocalContentColor provides Color.White) {
+            val scrollState = rememberScrollState()
+
+            Column(
+                Modifier.verticalNestedScrollToScene(topBehavior = NestedScrollBehavior.EdgeAlways)
+                    .verticalScroll(scrollState)
+                    .padding(vertical = QuickSettings.Dimensions.Padding)
+            ) {
+                val horizontalPaddingModifier = QuickSettings.Modifiers.HorizontalPadding
+
+                TimeRow(horizontalPaddingModifier)
+                DateAndBatteryRow(horizontalPaddingModifier)
+                BrightnessSlider(
+                    horizontalPaddingModifier.padding(top = QuickSettings.Dimensions.Padding)
+                )
+
+                QuickSettingsPager(
+                    pagerState = pagerState,
+                    tiles = tiles,
+                    nRows = nGridRows,
+                    nColumns = nGridColumns,
+                    Modifier.padding(top = QuickSettings.Dimensions.Padding)
+                        .element(QuickSettings.Elements.ExpandedGrid),
+                )
+
+                if (mediaPlayer != null) {
+                    Box(horizontalPaddingModifier) { mediaPlayer() }
+                }
+
+                // Add a spacer with the same height as the footer actions so that we can scroll the
+                // media player fully above the footer actions.
+                Spacer(
+                    Modifier.height(
+                        QuickSettings.Dimensions.FooterActionsButtonSize +
+                            QuickSettings.Dimensions.FooterActionsPadding +
+                            QuickSettings.Dimensions.FooterActionsBottomPadding
+                    )
+                )
+            }
+
+            FooterActions(
+                onSettingsButtonClicked,
+                onPowerButtonClicked,
+                Modifier.align(Alignment.BottomCenter)
+                    .element(QuickSettings.Elements.FooterActions)
+                    .background(Color.Black, QuickSettings.Shapes.FooterActionsBackground)
+                    .padding(
+                        top = QuickSettings.Dimensions.FooterActionsPadding,
+                        start = QuickSettings.Dimensions.FooterActionsPadding,
+                        end = QuickSettings.Dimensions.FooterActionsPadding,
+                        bottom = QuickSettings.Dimensions.FooterActionsBottomPadding,
+                    ),
+            )
+        }
+    }
+}
+
+@Composable
+fun SceneScope.QuickSettingsBackground(modifier: Modifier = Modifier) {
+    Box(
+        modifier
+            .element(QuickSettings.Elements.Background)
+            .fillMaxSize()
+            .background(colorResource(android.R.color.system_neutral1_1000))
+    )
+}
+
+@Composable
+private fun SceneScope.TimeRow(modifier: Modifier = Modifier) {
+    Row(modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {
+        ShadeTime(scale = 2.57f)
+        Spacer(Modifier.weight(1f))
+        Operator()
+    }
+}
+
+@Composable
+internal fun SceneScope.Operator(modifier: Modifier = Modifier) {
+    Text("Emergency calls only", modifier.element(QuickSettings.Elements.Operator))
+}
+
+@Composable
+private fun SceneScope.DateAndBatteryRow(modifier: Modifier = Modifier) {
+    Row(modifier.fillMaxWidth(), verticalAlignment = Alignment.CenterVertically) {
+        ShadeDate(Modifier.element(QuickSettings.Elements.Date))
+        Spacer(Modifier.weight(1f))
+        BatteryPercentage()
+    }
+}
+
+@Composable
+internal fun SceneScope.BrightnessSlider(modifier: Modifier = Modifier) {
+    Box(
+        modifier
+            .element(QuickSettings.Elements.BrightnessSlider)
+            .fillMaxWidth()
+            .height(48.dp)
+            .background(QuickSettingsGrid.Colors.ActiveTileBackground, CircleShape),
+        contentAlignment = Alignment.CenterEnd,
+    ) {
+        Icon(
+            Icons.Default.Brightness5,
+            contentDescription = null,
+            tint = Color.Black,
+            modifier = Modifier.padding(horizontal = 16.dp),
+        )
+    }
+}
+
+@Composable
+internal fun FooterActions(
+    onSettingsButtonClicked: () -> Unit,
+    onPowerButtonClicked: () -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Row(modifier.fillMaxWidth(), horizontalArrangement = Arrangement.spacedBy(8.dp)) {
+        Spacer(Modifier.weight(1f))
+
+        FilledIconButton(
+            onClick = onSettingsButtonClicked,
+            colors =
+                IconButtonDefaults.filledIconButtonColors(
+                    containerColor = QuickSettingsGrid.Colors.InactiveTileBackground,
+                    contentColor = QuickSettingsGrid.Colors.InactiveTileText,
+                ),
+            modifier = Modifier.size(QuickSettings.Dimensions.FooterActionsButtonSize),
+        ) {
+            Icon(Icons.Default.Settings, null, Modifier.size(20.dp))
+        }
+
+        FilledIconButton(
+            onClick = onPowerButtonClicked,
+            colors =
+                IconButtonDefaults.filledIconButtonColors(
+                    containerColor = QuickSettingsGrid.Colors.ActiveTileBackground,
+                    contentColor = QuickSettingsGrid.Colors.ActiveTileText,
+                ),
+            modifier = Modifier.size(QuickSettings.Dimensions.FooterActionsButtonSize),
+        ) {
+            Icon(Icons.Default.PowerSettingsNew, null, Modifier.size(20.dp))
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsGrid.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsGrid.kt
new file mode 100644
index 000000000..babd2aac4
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsGrid.kt
@@ -0,0 +1,361 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.animation.animateColorAsState
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.ChevronRight
+import androidx.compose.material3.Icon
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.ReadOnlyComposable
+import androidx.compose.runtime.Stable
+import androidx.compose.runtime.key
+import androidx.compose.runtime.remember
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.draw.drawBehind
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.graphics.CompositingStrategy
+import androidx.compose.ui.graphics.graphicsLayer
+import androidx.compose.ui.graphics.vector.ImageVector
+import androidx.compose.ui.layout.Layout
+import androidx.compose.ui.res.colorResource
+import androidx.compose.ui.text.TextMeasurer
+import androidx.compose.ui.text.style.TextOverflow
+import androidx.compose.ui.unit.Constraints
+import androidx.compose.ui.unit.Dp
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.grid.VerticalGrid
+import kotlin.math.abs
+import kotlin.math.ceil
+import kotlin.math.roundToInt
+
+class QuickSettingsTileIdentity
+
+@Stable
+interface QuickSettingsTileViewModel {
+    val key: ElementKey
+    val isActive: Boolean
+
+    val icon: ImageVector
+    val title: String
+    val description: String?
+
+    val showChevron: Boolean
+    val onClick: () -> Unit
+
+    val textMeasurer: TextMeasurer
+}
+
+object QuickSettingsGrid {
+    object Elements {
+        val Tiles = ElementKey.withIdentity { it is QuickSettingsTileIdentity }
+        val GridAnchor = ElementKey("QuickSettingsGridAnchor")
+    }
+
+    object Values {
+        val Expansion = ValueKey("QuickSettingsGridExpansion")
+    }
+
+    object Dimensions {
+        val TileExpandedHeight = 84.dp
+        val TileCollapsedHeight = 60.dp
+        val Spacing = 8.dp
+
+        const val RowCountWhenCollapsed = 2
+    }
+
+    object Colors {
+        val ActiveTileBackground: Color
+            @Composable
+            @ReadOnlyComposable
+            get() = colorResource(android.R.color.system_accent1_100)
+
+        val InactiveTileBackground: Color
+            @Composable
+            @ReadOnlyComposable
+            get() = colorResource(android.R.color.system_neutral1_800)
+
+        val ActiveTileText: Color
+            @Composable
+            @ReadOnlyComposable
+            get() = colorResource(android.R.color.system_accent1_900)
+
+        val InactiveTileText: Color
+            @Composable
+            @ReadOnlyComposable
+            get() = colorResource(android.R.color.system_neutral1_100)
+    }
+
+    object Shapes {
+        val Tile = RoundedCornerShape(Dimensions.TileCollapsedHeight / 2)
+    }
+}
+
+/**
+ * Display all [tiles] as a grid with [nColumns] columns. The tiles will be expanded if [isExpanded]
+ * is true.
+ */
+@Composable
+fun SceneScope.QuickSettingsGrid(
+    tiles: List<QuickSettingsTileViewModel>,
+    nColumns: Int,
+    isExpanded: Boolean,
+    expansionProgress: () -> Float,
+    modifier: Modifier = Modifier,
+    nRowsTarget: Int? = null,
+) {
+    val tileHeight = tileHeight(isExpanded)
+
+    Column(modifier) {
+        VerticalGrid(
+            columns = nColumns,
+            horizontalSpacing = QuickSettingsGrid.Dimensions.Spacing,
+            verticalSpacing = QuickSettingsGrid.Dimensions.Spacing,
+        ) {
+            tiles.forEachIndexed { i, tile ->
+                key(tile.key) { Tile(tile, tileHeight, expansionProgress) }
+            }
+        }
+
+        // Fill the space that would be taking by the remaining number of rows in case there are
+        // not enough tiles to fill the grid.
+        if (nRowsTarget != null) {
+            val nRows = ceil(tiles.size.toFloat() / nColumns).roundToInt()
+            val nRowsToFill = abs(nRowsTarget - nRows)
+            if (nRowsToFill > 0) {
+                Spacer(
+                    Modifier.height(
+                        (tileHeight + QuickSettingsGrid.Dimensions.Spacing) * nRowsToFill
+                    )
+                )
+            }
+        }
+    }
+}
+
+fun tileHeight(isExpanded: Boolean) =
+    if (isExpanded) QuickSettingsGrid.Dimensions.TileExpandedHeight
+    else QuickSettingsGrid.Dimensions.TileCollapsedHeight
+
+@Composable
+private fun SceneScope.Tile(
+    viewModel: QuickSettingsTileViewModel,
+    height: Dp,
+    expansionProgress: () -> Float,
+    modifier: Modifier = Modifier,
+) {
+    val isActive = viewModel.isActive
+    val icon = viewModel.icon
+    val title = viewModel.title
+    val description = viewModel.description
+    val showChevron = viewModel.showChevron
+
+    val targetBackgroundColor: Color =
+        if (isActive) QuickSettingsGrid.Colors.ActiveTileBackground
+        else QuickSettingsGrid.Colors.InactiveTileBackground
+    val targetContentColor: Color =
+        if (isActive) QuickSettingsGrid.Colors.ActiveTileText
+        else QuickSettingsGrid.Colors.InactiveTileText
+    val backgroundColor = animateColorAsState(targetBackgroundColor)
+    val contentColor = animateColorAsState(targetContentColor)
+
+    Layout(
+        modifier =
+            modifier
+                .element(viewModel.key)
+                .fillMaxWidth()
+                // Note: This height modifier is what is setting the size of this tile when idle,
+                // but during transitions the height is actually interpolated and constrained by
+                // Modifier.element(key) above.
+                .height(height)
+                .clip(QuickSettingsGrid.Shapes.Tile)
+                .clickable(onClick = viewModel.onClick)
+                .drawBehind { drawRect(backgroundColor.value) },
+        contents =
+            remember(icon, title, description, contentColor, showChevron, expansionProgress) {
+                tileContents(
+                    icon,
+                    title,
+                    description,
+                    showChevron,
+                    { contentColor.value },
+                    expansionProgress,
+                    viewModel.textMeasurer,
+                )
+            },
+    ) { measurables, constraints ->
+        val contentsSize = measurables.size
+        check(contentsSize >= 2 && contentsSize <= 4)
+        repeat(contentsSize) { check(measurables[it].size == 1) }
+
+        // The indices of the chevron and description in the measurables, or -1 if they are not
+        // shown.
+        val descriptionIndex: Int
+        val chevronIndex: Int
+        if (description != null) {
+            descriptionIndex = 2
+            if (showChevron) {
+                chevronIndex = 3
+            } else {
+                chevronIndex = -1
+            }
+        } else {
+            descriptionIndex = -1
+            if (showChevron) {
+                chevronIndex = 2
+            } else {
+                chevronIndex = -1
+            }
+        }
+
+        // The height of this layout should already be fixed by Modifier.element(),
+        // Modifier.height() and Modifier.fillMaxWidth().
+        check(constraints.minWidth == constraints.maxWidth)
+        check(constraints.minHeight == constraints.maxHeight)
+
+        // Icon and chevron are exactly 20dp x 20dp.
+        val iconSize = 20.dp.roundToPx()
+        val iconConstraints = Constraints.fixed(iconSize, iconSize)
+        val iconPlaceable = measurables[0][0].measure(iconConstraints)
+        val chevronPlaceable =
+            if (chevronIndex != -1) {
+                measurables[chevronIndex][0].measure(iconConstraints)
+            } else {
+                null
+            }
+
+        // The tile has a horizontal padding of 16dp.
+        val horizontalPadding = 16.dp.roundToPx()
+
+        // There is a 8dp spacing between the icon and the texts.
+        val iconSpacing = 8.dp.roundToPx()
+
+        // The remaining width for the texts.
+        val textMaxWidthWithoutChevron =
+            constraints.maxWidth - iconPlaceable.width - horizontalPadding * 2 - iconSpacing
+        val textMaxWidth =
+            if (chevronPlaceable != null) {
+                textMaxWidthWithoutChevron - chevronPlaceable.width - iconSpacing
+            } else {
+                textMaxWidthWithoutChevron
+            }
+
+        // We don't want to remeasure texts and icons every frame of animations, so we use the same
+        // maxHeight independently of the current height.
+        val collapsedHeight = QuickSettingsGrid.Dimensions.TileCollapsedHeight.roundToPx()
+        val textMaxHeight = collapsedHeight
+        val textConstraints = Constraints(maxWidth = textMaxWidth, maxHeight = textMaxHeight)
+        val titlePlaceable = measurables[1][0].measure(textConstraints)
+        val descriptionPlaceable =
+            if (descriptionIndex != -1) measurables[2][0].measure(textConstraints) else null
+
+        val width = constraints.minWidth
+        val height = constraints.minHeight
+        layout(width, height) {
+            // Icon and chevron are centered vertically.
+            iconPlaceable.placeRelative(horizontalPadding, (height - iconPlaceable.height) / 2)
+            chevronPlaceable?.placeRelative(
+                width - horizontalPadding - chevronPlaceable.width,
+                (height - chevronPlaceable.height) / 2,
+            )
+
+            // If there is no description, the title is always centered vertically.
+            val textX = horizontalPadding + iconPlaceable.width + iconSpacing
+            if (descriptionPlaceable == null) {
+                titlePlaceable.placeRelative(textX, (height - titlePlaceable.height) / 2)
+                return@layout
+            }
+
+            // When collapsed, the title is centered vertically and the description if faded out.
+            val titleCollapsedY = (height - titlePlaceable.height) / 2
+
+            // When expanded, the title + description are centered vertically.
+            val titleExpandedY = (height - titlePlaceable.height - descriptionPlaceable.height) / 2
+
+            val titleY =
+                (titleCollapsedY + expansionProgress() * (titleExpandedY - titleCollapsedY))
+                    .roundToInt()
+            titlePlaceable.placeRelative(textX, titleY)
+            descriptionPlaceable.placeRelative(textX, titleY + titlePlaceable.height)
+        }
+    }
+}
+
+private fun tileContents(
+    icon: ImageVector,
+    title: String,
+    description: String?,
+    showChevron: Boolean,
+    contentColor: () -> Color,
+    expansionProgress: () -> Float,
+    textMeasurer: TextMeasurer,
+): List<@Composable () -> Unit> {
+    return buildList {
+        // Icon.
+        add { Icon(icon, null, tint = contentColor()) }
+
+        // Title.
+        add {
+            CachedText(
+                title,
+                textMeasurer,
+                style = MaterialTheme.typography.labelLarge,
+                maxLines = 1,
+                overflow = TextOverflow.Ellipsis,
+                color = contentColor,
+            )
+        }
+
+        // Description.
+        if (description != null) {
+            add {
+                CachedText(
+                    description,
+                    textMeasurer,
+                    style = MaterialTheme.typography.bodyMedium,
+                    maxLines = 1,
+                    overflow = TextOverflow.Ellipsis,
+                    color = contentColor,
+                    modifier =
+                        Modifier.graphicsLayer {
+                            alpha = expansionProgress()
+                            compositingStrategy = CompositingStrategy.ModulateAlpha
+                        },
+                )
+            }
+        }
+
+        // Chevron.
+        if (showChevron) {
+            add {
+                // TODO(b/231674463): We should not read contentColor() during composition.
+                Icon(Icons.Default.ChevronRight, null, tint = contentColor())
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsPager.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsPager.kt
new file mode 100644
index 000000000..5d7f43691
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsPager.kt
@@ -0,0 +1,167 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.Canvas
+import androidx.compose.foundation.ExperimentalFoundationApi
+import androidx.compose.foundation.layout.Arrangement
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.pager.HorizontalPager
+import androidx.compose.foundation.pager.PagerState
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.LaunchedEffect
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.runtime.snapshotFlow
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.animateSceneFloatAsState
+import com.android.compose.animation.scene.content.state.TransitionState
+import kotlin.math.ceil
+import kotlin.math.roundToInt
+import kotlinx.coroutines.flow.first
+import kotlinx.coroutines.launch
+
+@Composable
+fun SceneScope.QuickSettingsPager(
+    pagerState: PagerState,
+    tiles: List<QuickSettingsTileViewModel>,
+    nRows: Int,
+    nColumns: Int,
+    modifier: Modifier = Modifier,
+) {
+    val nTiles = tiles.size
+    val nTilesPerPage = nRows * nColumns
+
+    // Each page must have exactly nRows rows, unless there is a single page.
+    val nRowsTarget =
+        if (nTiles < nTilesPerPage) ceil(nTiles.toFloat() / nColumns).roundToInt() else nRows
+
+    PagerStateResetter(pagerState)
+
+    Column(modifier.noResizeDuringTransitions()) {
+        Box {
+            GridAnchor(isExpanded = true)
+
+            // The grid expansion progress. To make the Tile() implementation more self-contained we
+            // could have an animateSharedFloatAsState, but this will create a new shared value for
+            // each tile that will all have the same value so we instead create a single shared
+            // value here used by all Tiles.
+            val expansionProgress by
+                animateSceneFloatAsState(
+                    1f,
+                    QuickSettingsGrid.Values.Expansion,
+                    canOverflow = false,
+                )
+
+            HorizontalPager(pagerState, Modifier.fillMaxWidth()) { page ->
+                val firstTileIndex = page * nTilesPerPage
+                QuickSettingsGrid(
+                    tiles.subList(
+                        firstTileIndex,
+                        minOf(tiles.size, firstTileIndex + nTilesPerPage),
+                    ),
+                    nColumns,
+                    isExpanded = true,
+                    expansionProgress = { expansionProgress },
+                    modifier = QuickSettings.Modifiers.HorizontalPadding,
+                    nRowsTarget = nRowsTarget,
+                )
+            }
+        }
+
+        val activeColor = QuickSettingsGrid.Colors.ActiveTileBackground
+        val inactiveColor = QuickSettingsGrid.Colors.InactiveTileBackground
+        PagerIndicators(
+            pagerState,
+            activeColor,
+            inactiveColor,
+            Modifier.align(Alignment.CenterHorizontally),
+        )
+    }
+}
+
+fun nQuickSettingsPages(nTiles: Int, nRows: Int, nColumns: Int): Int {
+    val nTilesPerPage = nRows * nColumns
+    return ceil(nTiles.toFloat() / nTilesPerPage).roundToInt()
+}
+
+/**
+ * The invisible anchor used to anchor the movement of the brightness slider and height of the tiles
+ * that are not shared and appearing.
+ */
+@Composable
+fun SceneScope.GridAnchor(isExpanded: Boolean, modifier: Modifier = Modifier) {
+    // The width of this anchor does not matter, but the height is used to anchor the size of the
+    // (dis)appearing tiles.
+    Spacer(modifier.element(QuickSettingsGrid.Elements.GridAnchor).height(tileHeight(isExpanded)))
+}
+
+@Composable
+@OptIn(ExperimentalFoundationApi::class)
+private fun SceneScope.PagerIndicators(
+    pagerState: PagerState,
+    activeColor: Color,
+    inactiveColor: Color,
+    modifier: Modifier = Modifier,
+) {
+    Row(
+        modifier.element(QuickSettings.Elements.PagerIndicators).height(48.dp),
+        horizontalArrangement = Arrangement.spacedBy(4.dp),
+        verticalAlignment = Alignment.CenterVertically,
+    ) {
+        repeat(pagerState.pageCount) { i ->
+            Canvas(modifier = Modifier.size(6.dp)) {
+                val color = if (pagerState.currentPage == i) activeColor else inactiveColor
+                drawCircle(color)
+            }
+        }
+    }
+}
+
+/**
+ * Snaps [pagerState] to the first page if we are transitioning from QS => Shade and the transition
+ * goes past [QuickSettings.TransitionToShadeCommittedProgress].
+ */
+@Composable
+@OptIn(ExperimentalFoundationApi::class)
+private fun SceneScope.PagerStateResetter(pagerState: PagerState) {
+    if (
+        pagerState.currentPage != 0 &&
+            layoutState.isTransitioning(from = Scenes.QuickSettings, to = Scenes.Shade)
+    ) {
+        val transition = layoutState.transitionState as TransitionState.Transition
+        val scrollScope = rememberCoroutineScope()
+        LaunchedEffect(transition, pagerState) {
+            // Wait for the progress to reach TransitionToShadeCommittedProgress.
+            snapshotFlow { transition.progress }
+                .first { it >= QuickSettings.TransitionToShadeCommittedProgress }
+
+            // Scroll to the first page.
+            scrollScope.launch { pagerState.scrollToPage(0) }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt
new file mode 100644
index 000000000..e222bac92
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/QuickSettingsShade.kt
@@ -0,0 +1,56 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.layout.Column
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Modifier
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.UserActionResult
+
+object QuickSettingsShade {
+    object Elements {
+        val Root = ElementKey("QuickSettingsShadeContentRoot")
+        val Content = ElementKey("QuickSettingsShadeContent")
+    }
+
+    val UserActions =
+        mapOf(
+            Back to UserActionResult.HideOverlay(Overlays.QuickSettings),
+            Swipe.Up to UserActionResult.HideOverlay(Overlays.QuickSettings),
+            Swipe.Right to UserActionResult.ReplaceByOverlay(Overlays.Notifications),
+        )
+}
+
+@Composable
+fun SceneScope.QuickSettingsShade(
+    mediaPlayer: @Composable (SceneScope.() -> Unit)?,
+    modifier: Modifier = Modifier,
+) {
+    PartialShade(modifier.element(QuickSettingsShade.Elements.Root)) {
+        Column(Modifier.element(QuickSettingsShade.Elements.Content)) {
+            Clock(MaterialTheme.colorScheme.onSurfaceVariant)
+            if (mediaPlayer != null) {
+                mediaPlayer()
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt
new file mode 100644
index 000000000..8e12f36dd
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Shade.kt
@@ -0,0 +1,494 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+@file:OptIn(ExperimentalFoundationApi::class)
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.animation.core.Animatable
+import androidx.compose.animation.core.AnimationVector1D
+import androidx.compose.animation.core.VectorConverter
+import androidx.compose.animation.core.VisibilityThreshold
+import androidx.compose.foundation.ExperimentalFoundationApi
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.width
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.material3.LocalTextStyle
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Text
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.runtime.LaunchedEffect
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.mutableStateOf
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.draw.drawBehind
+import androidx.compose.ui.geometry.Offset
+import androidx.compose.ui.graphics.BlendMode
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.graphics.CompositingStrategy
+import androidx.compose.ui.graphics.drawscope.scale
+import androidx.compose.ui.graphics.graphicsLayer
+import androidx.compose.ui.input.nestedscroll.nestedScroll
+import androidx.compose.ui.layout.Layout
+import androidx.compose.ui.layout.layout
+import androidx.compose.ui.platform.LocalDensity
+import androidx.compose.ui.platform.LocalLayoutDirection
+import androidx.compose.ui.text.drawText
+import androidx.compose.ui.text.rememberTextMeasurer
+import androidx.compose.ui.unit.Constraints
+import androidx.compose.ui.unit.Density
+import androidx.compose.ui.unit.Dp
+import androidx.compose.ui.unit.LayoutDirection
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.NestedScrollBehavior
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementFloatAsState
+import com.android.compose.animation.scene.animateSceneFloatAsState
+import com.android.compose.modifiers.thenIf
+import com.android.compose.nestedscroll.LargeTopAppBarNestedScrollConnection
+import com.android.compose.nestedscroll.PriorityNestedScrollConnection
+import kotlin.math.ceil
+import kotlin.math.roundToInt
+import kotlinx.coroutines.launch
+
+object Shade {
+    fun userActions(
+        isLockscreenDismissed: Boolean,
+        lockscreenScene: SceneKey,
+    ): Map<UserAction, UserActionResult> {
+        val previousScreen =
+            if (isLockscreenDismissed) {
+                Scenes.Launcher
+            } else {
+                lockscreenScene
+            }
+
+        return mapOf(
+            Back to previousScreen,
+            Swipe.Up to previousScreen,
+            Swipe.Down to Scenes.QuickSettings,
+        )
+    }
+
+    object Elements {
+        val Time = ElementKey("ShadeTime")
+        val Date = ElementKey("ShadeDate")
+        val BatteryPercentage = ElementKey("ShadeBatteryPercentage")
+        val CollapsedGrid = ElementKey("QuickSettingsCollapsedGrid")
+        val Scrim = ElementKey("ShadeScrim")
+        val ScrimBackground = ElementKey("ShadeScrimBackground")
+    }
+
+    object Values {
+        val TimeScale = ValueKey("ShadeTimeScale")
+    }
+
+    object Dimensions {
+        val ScrimCornerSize = 30.dp
+        val StatusBarHeight = 40.dp
+    }
+
+    object Colors {
+        val Scrim: Color
+            @Composable get() = MaterialTheme.colorScheme.surfaceContainer
+    }
+
+    object Shapes {
+        val Scrim =
+            RoundedCornerShape(
+                topStart = Dimensions.ScrimCornerSize,
+                topEnd = Dimensions.ScrimCornerSize,
+            )
+    }
+}
+
+@Composable
+fun SceneScope.Shade(
+    notificationList: @Composable SceneScope.() -> Unit,
+    mediaPlayer: (@Composable SceneScope.() -> Unit)?,
+    quickSettingsTiles: List<QuickSettingsTileViewModel>,
+    nQuickSettingsColumns: Int,
+    modifier: Modifier = Modifier,
+) {
+    CompositionLocalProvider(LocalContentColor provides Color.White) {
+        val shouldPunchHoleBehindScrim =
+            layoutState.isTransitioning() &&
+                !layoutState.isTransitioningBetween(Scenes.QuickSettings, Scenes.Shade)
+
+        val scrimMinTopPadding = Shade.Dimensions.StatusBarHeight
+        ShadeLayout(
+            modifier =
+                modifier.thenIf(shouldPunchHoleBehindScrim) {
+                    // Use the Offscreen composition strategy so that Scrim() can leverage blending
+                    // algorithms against background and underScrim.
+                    Modifier.graphicsLayer(compositingStrategy = CompositingStrategy.Offscreen)
+                },
+            scrimMinTopPadding = scrimMinTopPadding,
+            background = { QuickSettingsBackground(Modifier.fillMaxSize()) },
+            underScrim = {
+                UnderScrim(
+                    mediaPlayer = mediaPlayer,
+                    quickSettingsTiles = quickSettingsTiles,
+                    nQuickSettingsColumns = nQuickSettingsColumns,
+                )
+            },
+            scrim = {
+                Scrim(
+                    notificationList = notificationList,
+                    shouldPunchHoleBehindScrim = shouldPunchHoleBehindScrim,
+                    scrimMinTopPadding = scrimMinTopPadding,
+                )
+            },
+        )
+    }
+}
+
+@Composable
+private fun SceneScope.ShadeLayout(
+    background: @Composable () -> Unit,
+    underScrim: @Composable () -> Unit,
+    scrim: @Composable () -> Unit,
+    scrimMinTopPadding: Dp,
+    modifier: Modifier = Modifier,
+) {
+    // The offset of the scrim compared to its position at rest. When this is equal to 0 (its
+    // maximum value), then the scrim is at its bottom-most position, right below [underScrim]
+    // vertically. When it is equal to its minimum (negative) value, then the scrim is at its
+    // top-most position (at y = scrimMinTopPadding).
+    val scrimOffset = remember { mutableStateOf(0f) }
+
+    // The additional scrim offset so that the notifications in the shade are below the
+    // notifications in the lockscreen when the Lockscreen => Shade transition starts and as long as
+    // the user finger is down.
+    val additionalScrimOffset = additionalScrimOffset()
+
+    // The last height of [underScrim].
+    val underScrimHeight = remember {
+        object {
+            var value = 0f
+        }
+    }
+
+    val density = LocalDensity.current
+    Layout(
+        modifier = modifier,
+        contents =
+            listOf(
+                { background() },
+                { underScrim() },
+                {
+                    Box(
+                        Modifier.verticalNestedScrollToScene(
+                                topBehavior = NestedScrollBehavior.EdgeWithPreview
+                            )
+                            .nestedScroll(
+                                remember(
+                                    scrimOffset,
+                                    underScrimHeight,
+                                    density,
+                                    scrimMinTopPadding,
+                                ) {
+                                    scrimNestedScrollConnection(
+                                        scrimOffset = { scrimOffset.value },
+                                        onScrimOffsetChange = { scrimOffset.value = it },
+                                        underScrimHeight = { underScrimHeight.value },
+                                        density = density,
+                                        scrimMinTopPadding = scrimMinTopPadding,
+                                    )
+                                }
+                            )
+                    ) {
+                        scrim()
+                    }
+                },
+            ),
+    ) { measurables, constraints ->
+        check(measurables.size == 3)
+        check(measurables[0].size == 1) { "background should compose only top-level composable" }
+        check(measurables[1].size == 1) { "underScrim should compose only top-level composable" }
+        check(measurables[2].size == 1)
+
+        val background = measurables[0][0].measure(constraints)
+        val underScrim = measurables[1][0].measure(constraints)
+        val scrim = measurables[2][0].measure(constraints)
+
+        // Update the last height of underScrim.
+        underScrimHeight.value = underScrim.height.toFloat()
+
+        layout(
+            width = maxOf(background.width, underScrim.width, scrim.width),
+            height = maxOf(background.height, underScrim.height, scrim.height),
+        ) {
+            background.place(0, 0)
+            underScrim.place(0, 0)
+
+            val additionalScrimOffset = additionalScrimOffset?.value?.toPx() ?: 0f
+            scrim.placeWithLayer(
+                0,
+                underScrim.height + (scrimOffset.value + additionalScrimOffset).roundToInt(),
+            )
+        }
+    }
+}
+
+/**
+ * Returns the additional offset that we should add to the scrim to ensure that notifications move
+ * downwards (and not upwards) during the Lockscreen => Shade transition, even if they have a
+ * smaller y position (i.e. they are visually higher) in the Shade scene than in the Lockscreen
+ * scene.
+ */
+@Composable
+private fun SceneScope.additionalScrimOffset(): Animatable<Dp, AnimationVector1D>? {
+    fun shouldHaveAdditionalScrimOffset(): Boolean {
+        val currentTransition = layoutState.currentTransition ?: return false
+        return currentTransition.isInitiatedByUserInput &&
+            layoutState.isTransitioning(from = Scenes.Lockscreen, to = Scenes.Shade)
+    }
+
+    // Important: Make sure that we always return the same Animatable and that
+    // shouldStartWithAdditionalScrimOffset() is checked the first time the Shade scene is composed.
+    val animatable =
+        remember {
+            if (!shouldHaveAdditionalScrimOffset()) {
+                return@remember null
+            }
+
+            Animatable(30.dp, Dp.VectorConverter, Dp.VisibilityThreshold)
+        } ?: return null
+
+    // Animate the offset to 0.dp as soon as the user releases their finger.
+    val currentTransition = layoutState.currentTransition
+    val shouldKeepAdditionalScrimOffset =
+        shouldHaveAdditionalScrimOffset() &&
+            currentTransition != null &&
+            (currentTransition.isUserInputOngoing ||
+                currentTransition.currentScene == Scenes.Lockscreen)
+
+    val coroutineScope = rememberCoroutineScope()
+    LaunchedEffect(shouldKeepAdditionalScrimOffset) {
+        if (!shouldKeepAdditionalScrimOffset) {
+            // Important: We animate using coroutineScope and not the scope of this LaunchedEffect
+            // because we want to cancel the animation only if additionalScrimOffset() is removed
+            // from composition.
+            coroutineScope.launch { animatable.animateTo(0.dp) }
+        }
+    }
+
+    return animatable
+}
+
+/**
+ * The scroll connection used to offset the scrim depending on the current offset and the scroll
+ * state of the scrim content.
+ */
+private fun scrimNestedScrollConnection(
+    scrimOffset: () -> Float,
+    onScrimOffsetChange: (Float) -> Unit,
+    underScrimHeight: () -> Float,
+    density: Density,
+    scrimMinTopPadding: Dp,
+): PriorityNestedScrollConnection {
+    return LargeTopAppBarNestedScrollConnection(
+        height = scrimOffset,
+        onHeightChanged = onScrimOffsetChange,
+        minHeight = { minScrimOffset(density, underScrimHeight(), scrimMinTopPadding) },
+        maxHeight = { 0f },
+    )
+}
+
+/**
+ * The minimum value of the scrim offset relative to its original position at rest, i.e. when it is
+ * visually right below the underScrim content (header, quick settings, media player, etc).
+ */
+private fun minScrimOffset(
+    density: Density,
+    underScrimHeight: Float,
+    scrimMinTopPadding: Dp,
+): Float {
+    return -underScrimHeight + with(density) { scrimMinTopPadding.toPx() }
+}
+
+@Composable
+private fun SceneScope.UnderScrim(
+    mediaPlayer: @Composable (SceneScope.() -> Unit)?,
+    quickSettingsTiles: List<QuickSettingsTileViewModel>,
+    nQuickSettingsColumns: Int,
+    modifier: Modifier = Modifier,
+) {
+    Column(modifier) {
+        val horizontalPaddingModifier =
+            Modifier.padding(horizontal = QuickSettings.Dimensions.Padding)
+
+        StatusBar(showDateAndTime = true, horizontalPaddingModifier)
+
+        Box {
+            GridAnchor(isExpanded = false)
+
+            // The grid expansion progress. To make the Tile() implementation more
+            // self-contained we could have an animateSharedFloatAsState, but this will
+            // create a new shared value for each tile that will all have the same value so
+            // we instead create a single shared value here used by all Tiles.
+            val expansionProgress by
+                animateSceneFloatAsState(
+                    0f,
+                    QuickSettingsGrid.Values.Expansion,
+                    canOverflow = false,
+                )
+
+            QuickSettingsGrid(
+                // Only show the first tiles in a 2 x nQuickSettingsColumns grid.
+                tiles = quickSettingsTiles.take(2 * nQuickSettingsColumns),
+                nColumns = nQuickSettingsColumns,
+                isExpanded = false,
+                expansionProgress = { expansionProgress },
+                horizontalPaddingModifier.element(Shade.Elements.CollapsedGrid),
+            )
+        }
+
+        if (mediaPlayer != null) {
+            Box(horizontalPaddingModifier.padding(top = QuickSettingsGrid.Dimensions.Spacing)) {
+                mediaPlayer()
+            }
+        }
+
+        Spacer(Modifier.height(QuickSettings.Dimensions.Padding))
+    }
+}
+
+@Composable
+private fun SceneScope.Scrim(
+    notificationList: @Composable SceneScope.() -> Unit,
+    shouldPunchHoleBehindScrim: Boolean,
+    scrimMinTopPadding: Dp,
+    modifier: Modifier = Modifier,
+) {
+    Box(modifier.element(Shade.Elements.Scrim).clip(Shade.Shapes.Scrim)) {
+        if (shouldPunchHoleBehindScrim) {
+            Spacer(
+                Modifier.fillMaxSize().drawBehind {
+                    // Clear pixels from the destination. The color does not matter here given that
+                    // the source (this spacer) is not drawn when using DstOut.
+                    drawRect(Color.Black, blendMode = BlendMode.DstOut)
+                }
+            )
+        }
+
+        Box(
+            Modifier.element(Shade.Elements.ScrimBackground)
+                .fillMaxSize()
+                .background(Shade.Colors.Scrim)
+        )
+
+        Box(
+            Modifier.padding(bottom = scrimMinTopPadding)
+                // Make sure this list is full size so that shared notifications are not clipped
+                // when animating from lockscreen to shade.
+                .fillMaxSize(),
+            propagateMinConstraints = true,
+        ) {
+            notificationList()
+        }
+    }
+}
+
+@Composable
+fun SceneScope.StatusBar(showDateAndTime: Boolean, modifier: Modifier = Modifier) {
+    Row(
+        modifier.height(Shade.Dimensions.StatusBarHeight),
+        verticalAlignment = Alignment.CenterVertically,
+    ) {
+        if (showDateAndTime) {
+            ShadeTime(scale = 1f)
+            Spacer(Modifier.width(16.dp))
+            ShadeDate(Modifier.element(Shade.Elements.Date))
+        } else {
+            Operator()
+        }
+
+        Spacer(Modifier.weight(1f))
+        BatteryPercentage()
+    }
+}
+
+@Composable
+fun SceneScope.ShadeTime(scale: Float, modifier: Modifier = Modifier) {
+    Element(Shade.Elements.Time, modifier) {
+        val measurer = rememberTextMeasurer()
+        val color = LocalContentColor.current
+        val style = LocalTextStyle.current
+        val animatedScale by
+            animateElementFloatAsState(scale, Shade.Values.TimeScale, canOverflow = false)
+        val layoutResult = remember(measurer, style) { measurer.measure("10:36", style = style) }
+        val layoutDirection = LocalLayoutDirection.current
+
+        Spacer(
+            Modifier.layout { measurable, _ ->
+                    // Layout this element with the *target* size/scale of the element in this
+                    // scene.
+                    val width = ceil(layoutResult.size.width * scale).roundToInt()
+                    val height = ceil(layoutResult.size.height * scale).roundToInt()
+                    measurable.measure(Constraints.fixed(width, height)).run {
+                        layout(width, height) { place(0, 0) }
+                    }
+                }
+                .drawBehind {
+                    val topLeft: Offset
+                    val pivot: Offset
+                    if (layoutDirection == LayoutDirection.Ltr) {
+                        topLeft = Offset.Zero
+                        pivot = Offset.Zero
+                    } else {
+                        topLeft = Offset(size.width - layoutResult.size.width, 0f)
+                        pivot = Offset(size.width, 0f)
+                    }
+
+                    scale(animatedScale, pivot = pivot) {
+                        drawText(layoutResult, color = color, topLeft = topLeft)
+                    }
+                }
+        )
+    }
+}
+
+@Composable
+fun ShadeDate(modifier: Modifier = Modifier) {
+    Box(modifier) { Text("Mon, Mar 20") }
+}
+
+@Composable
+fun SceneScope.BatteryPercentage(modifier: Modifier = Modifier) {
+    Text("92%", modifier.element(Shade.Elements.BatteryPercentage))
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SmartSpace.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SmartSpace.kt
new file mode 100644
index 000000000..967e95942
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SmartSpace.kt
@@ -0,0 +1,82 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.text.BasicText
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.WbSunny
+import androidx.compose.material3.Icon
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Text
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.getValue
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import androidx.compose.ui.unit.sp
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementColorAsState
+
+object SmartSpace {
+    object Elements {
+        val SmartSpace = ElementKey("SmartSpace")
+    }
+
+    object Values {
+        val TextColor = ValueKey("SmartSpaceTextColor")
+    }
+}
+
+@Composable
+fun SceneScope.SmartSpace(textColor: Color, modifier: Modifier = Modifier) {
+    Element(SmartSpace.Elements.SmartSpace, modifier) {
+        val color = animateElementColorAsState(textColor, SmartSpace.Values.TextColor)
+
+        content {
+            Column {
+                BasicText(
+                    "Mon, Mar 20",
+                    color = { color.value },
+                    style = MaterialTheme.typography.titleLarge.copy(fontSize = 20.sp),
+                )
+
+                Row(verticalAlignment = Alignment.CenterVertically) {
+                    // We have to use valueOrNull here and fallback on the target color given that
+                    // there is no way to tint the color at drawing time.
+                    // TODO(b/231674463): We should not read color during composition.
+                    val color by color.unsafeCompositionState(initialValue = textColor)
+
+                    Icon(
+                        Icons.Default.WbSunny,
+                        null,
+                        Modifier.size(24.dp).padding(end = 4.dp),
+                        tint = color,
+                    )
+
+                    Text("13C", color = color, fontSize = 14.sp)
+                }
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitLockscreen.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitLockscreen.kt
new file mode 100644
index 000000000..a819e677a
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitLockscreen.kt
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.padding
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+
+object SplitLockscreen {
+    fun userActions(
+        isLockscreenDismissable: Boolean,
+        shadeScene: SceneKey,
+        configuration: DemoConfiguration,
+    ) =
+        Lockscreen.userActions(
+            isLockscreenDismissable,
+            shadeScene,
+            requiresFullDistanceSwipeToShade = false,
+            configuration,
+            fastSwipeToQuickSettings = false,
+        )
+}
+
+@Composable
+fun SceneScope.SplitLockscreen(
+    notificationList: @Composable SceneScope.() -> Unit,
+    mediaPlayer: @Composable (SceneScope.() -> Unit)?,
+    isDismissable: Boolean,
+    onToggleDismissable: () -> Unit,
+    onChangeScene: (SceneKey) -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Column(modifier.element(Lockscreen.Elements.Scene).fillMaxSize()) {
+        StatusBar(showDateAndTime = false, Modifier.padding(horizontal = 16.dp))
+        Row(Modifier.weight(1f).fillMaxWidth()) {
+            Column(Modifier.weight(1f).padding(16.dp)) {
+                Clock(MaterialTheme.colorScheme.onSurfaceVariant)
+                SmartSpace(MaterialTheme.colorScheme.onSurface)
+
+                if (mediaPlayer != null) {
+                    Box(Modifier.padding(top = 32.dp, start = 16.dp)) { mediaPlayer() }
+                }
+            }
+
+            Box(Modifier.weight(1f).padding(16.dp)) { notificationList() }
+        }
+
+        LockButton(
+            isDismissable,
+            onToggleDismissable,
+            onChangeScene,
+            Modifier.align(Alignment.CenterHorizontally).padding(top = 16.dp),
+        )
+
+        LockscreenCameraButton(
+            onClick = { onChangeScene(Scenes.Camera) },
+            Modifier.align(Alignment.End),
+        )
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitShade.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitShade.kt
new file mode 100644
index 000000000..3f0504cda
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SplitShade.kt
@@ -0,0 +1,146 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.pager.rememberPagerState
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.graphics.Color
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.UserAction
+import com.android.compose.animation.scene.UserActionResult
+
+object SplitShade {
+    fun userActions(
+        isLockscreenDismissed: Boolean,
+        lockscreenScene: SceneKey,
+    ): Map<UserAction, UserActionResult> {
+        val previousScreen =
+            if (isLockscreenDismissed) {
+                Scenes.Launcher
+            } else {
+                lockscreenScene
+            }
+
+        return mapOf(Back to previousScreen, Swipe.Up to previousScreen)
+    }
+
+    object Elements {
+        val Background = ElementKey("SplitShadeBackground")
+    }
+
+    object Shapes {
+        val Scrim = RoundedCornerShape(Shade.Dimensions.ScrimCornerSize)
+    }
+}
+
+@Composable
+fun SceneScope.SplitShade(
+    notificationList: @Composable SceneScope.() -> Unit,
+    mediaPlayer: @Composable (SceneScope.() -> Unit)?,
+    quickSettingsTiles: List<QuickSettingsTileViewModel>,
+    nQuickSettingsRows: Int,
+    nQuickSettingsColumns: Int,
+    onSettingsButtonClicked: () -> Unit,
+    onPowerButtonClicked: () -> Unit,
+    modifier: Modifier = Modifier,
+) {
+    Box(modifier) {
+        Box(modifier.element(SplitShade.Elements.Background).fillMaxSize().background(Color.Black))
+
+        CompositionLocalProvider(LocalContentColor provides Color.White) {
+            Column(
+                Modifier.fillMaxSize()
+                    .padding(top = 16.dp, bottom = 32.dp, start = 16.dp, end = 16.dp)
+            ) {
+                Row(Modifier.fillMaxWidth()) {
+                    ShadeTime(scale = 1f)
+                    ShadeDate(Modifier.padding(start = 16.dp).element(Shade.Elements.Date))
+                    Spacer(Modifier.weight(1f))
+                    Operator()
+                    BatteryPercentage(Modifier.padding(start = 16.dp))
+                }
+
+                Row(Modifier.fillMaxWidth().padding(top = 16.dp)) {
+                    Column(Modifier.weight(1f).padding(top = QuickSettings.Dimensions.Padding)) {
+                        val horizontalPaddingModifier = QuickSettings.Modifiers.HorizontalPadding
+
+                        BrightnessSlider(horizontalPaddingModifier)
+
+                        val nPages =
+                            nQuickSettingsPages(
+                                nTiles = quickSettingsTiles.size,
+                                nRows = nQuickSettingsRows,
+                                nColumns = nQuickSettingsColumns,
+                            )
+
+                        QuickSettingsPager(
+                            pagerState = rememberPagerState { nPages },
+                            tiles = quickSettingsTiles,
+                            nRows = nQuickSettingsRows,
+                            nColumns = nQuickSettingsColumns,
+                            Modifier.padding(top = QuickSettings.Dimensions.Padding),
+                        )
+
+                        if (mediaPlayer != null) {
+                            Box(horizontalPaddingModifier.padding()) { mediaPlayer() }
+                        }
+
+                        Spacer(Modifier.weight(1f))
+                        FooterActions(
+                            onSettingsButtonClicked,
+                            onPowerButtonClicked,
+                            horizontalPaddingModifier.element(QuickSettings.Elements.FooterActions),
+                        )
+                    }
+
+                    Box(
+                        Modifier.weight(1f)
+                            .padding(start = 16.dp)
+                            .clip(SplitShade.Shapes.Scrim)
+                            .verticalNestedScrollToScene()
+                    ) {
+                        Box(
+                            Modifier.element(Shade.Elements.ScrimBackground)
+                                .fillMaxSize()
+                                .background(Shade.Colors.Scrim)
+                        )
+
+                        notificationList()
+                    }
+                }
+            }
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Stub.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Stub.kt
new file mode 100644
index 000000000..311a2f309
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/Stub.kt
@@ -0,0 +1,66 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.fillMaxSize
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Text
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import com.android.compose.animation.scene.Back
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.Swipe
+
+object Stub {
+    fun startUserActions(lockscreenScene: SceneKey) =
+        mapOf(Back to lockscreenScene, Swipe.Start to lockscreenScene)
+
+    fun endUserActions(lockscreenScene: SceneKey) =
+        mapOf(Back to lockscreenScene, Swipe.End to lockscreenScene)
+
+    object Elements {
+        val SceneStart = ElementKey("StubSceneStart")
+        val SceneEnd = ElementKey("StubSceneEnd")
+        val TextStart = ElementKey("StubTextStart")
+        val TextEnd = ElementKey("StubTextEnd")
+    }
+}
+
+@Composable
+fun SceneScope.Stub(
+    rootKey: ElementKey,
+    textKey: ElementKey,
+    text: String,
+    modifier: Modifier = Modifier,
+) {
+    Box(
+        modifier.element(rootKey).fillMaxSize().background(MaterialTheme.colorScheme.background),
+        contentAlignment = Alignment.Center,
+    ) {
+        Text(
+            text,
+            modifier = modifier.element(textKey),
+            style = MaterialTheme.typography.titleLarge,
+            color = MaterialTheme.colorScheme.onBackground,
+        )
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt
new file mode 100644
index 000000000..e84eb5a38
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/SystemUi.kt
@@ -0,0 +1,786 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo
+
+import android.content.Context
+import androidx.activity.compose.BackHandler
+import androidx.compose.foundation.background
+import androidx.compose.foundation.border
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.horizontalScroll
+import androidx.compose.foundation.layout.Arrangement
+import androidx.compose.foundation.layout.Box
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.pager.rememberPagerState
+import androidx.compose.foundation.rememberScrollState
+import androidx.compose.foundation.shape.RoundedCornerShape
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.AirplanemodeInactive
+import androidx.compose.material.icons.filled.Bedtime
+import androidx.compose.material.icons.filled.Bluetooth
+import androidx.compose.material.icons.filled.ChargingStation
+import androidx.compose.material.icons.filled.CreditCard
+import androidx.compose.material.icons.filled.DoNotDisturb
+import androidx.compose.material.icons.filled.FlashlightOff
+import androidx.compose.material.icons.filled.Home
+import androidx.compose.material.icons.filled.NearbyOff
+import androidx.compose.material.icons.filled.NetworkWifi
+import androidx.compose.material.icons.filled.PowerSettingsNew
+import androidx.compose.material.icons.filled.ScreenRotation
+import androidx.compose.material.icons.filled.Settings
+import androidx.compose.material.icons.filled.Videocam
+import androidx.compose.material.icons.filled.ZoomOutMap
+import androidx.compose.material3.Button
+import androidx.compose.material3.Icon
+import androidx.compose.material3.IconButton
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Text
+import androidx.compose.material3.windowsizeclass.ExperimentalMaterial3WindowSizeClassApi
+import androidx.compose.material3.windowsizeclass.WindowHeightSizeClass
+import androidx.compose.material3.windowsizeclass.WindowSizeClass
+import androidx.compose.material3.windowsizeclass.WindowWidthSizeClass
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.key
+import androidx.compose.runtime.mutableStateOf
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.runtime.saveable.Saver
+import androidx.compose.runtime.saveable.SaverScope
+import androidx.compose.runtime.saveable.rememberSaveable
+import androidx.compose.runtime.setValue
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.clip
+import androidx.compose.ui.graphics.toComposeRect
+import androidx.compose.ui.graphics.vector.ImageVector
+import androidx.compose.ui.platform.LocalConfiguration
+import androidx.compose.ui.platform.LocalContext
+import androidx.compose.ui.platform.LocalDensity
+import androidx.compose.ui.platform.testTag
+import androidx.compose.ui.semantics.semantics
+import androidx.compose.ui.semantics.testTagsAsResourceId
+import androidx.compose.ui.state.ToggleableState
+import androidx.compose.ui.text.TextMeasurer
+import androidx.compose.ui.text.rememberTextMeasurer
+import androidx.compose.ui.unit.Density
+import androidx.compose.ui.unit.dp
+import androidx.window.layout.WindowMetricsCalculator
+import com.android.compose.animation.scene.DefaultEdgeDetector
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.MutableSceneTransitionLayoutState
+import com.android.compose.animation.scene.OverlayKey
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.SceneTransitionLayout
+import com.android.compose.animation.scene.SceneTransitions
+import com.android.compose.animation.scene.demo.notification.NotificationList
+import com.android.compose.animation.scene.demo.notification.notifications
+import com.android.compose.animation.scene.demo.transitions.systemUiTransitions
+import com.android.compose.modifiers.thenIf
+import kotlin.math.max
+
+object Scenes {
+    val AlwaysOnDisplay = SceneKey("AlwaysOnDisplay")
+    val Bouncer = SceneKey("Bouncer")
+    val Camera = SceneKey("Camera")
+    val Launcher = SceneKey("Launcher")
+    val Lockscreen = SceneKey("Lockscreen")
+    val SplitLockscreen = SceneKey("SplitLockscreen")
+    val QuickSettings = SceneKey("QuickSettings")
+    val Shade = SceneKey("Shade")
+    val SplitShade = SceneKey("SplitShade")
+
+    // Stub scenes on the start and end of the lockscreen.
+    val StubStart = SceneKey("StubStart")
+    val StubEnd = SceneKey("StubEnd")
+
+    val AllScenes =
+        listOf(
+                AlwaysOnDisplay,
+                Bouncer,
+                Camera,
+                Launcher,
+                Lockscreen,
+                SplitLockscreen,
+                QuickSettings,
+                Shade,
+                SplitShade,
+                StubStart,
+                StubEnd,
+            )
+            .associateBy { it.debugName }
+
+    /**
+     * A smart saver that restores the right scene depending on the current [lockscreenScene] and
+     * [shadeScene].
+     */
+    class SceneSaver(private val lockscreenScene: SceneKey, private val shadeScene: SceneKey) :
+        Saver<SceneKey, String> {
+        override fun SaverScope.save(value: SceneKey): String = value.debugName
+
+        override fun restore(value: String): SceneKey {
+            return ensureCorrectScene(AllScenes.getValue(value), lockscreenScene, shadeScene)
+        }
+    }
+
+    fun ensureCorrectScene(
+        scene: SceneKey,
+        lockscreenScene: SceneKey,
+        shadeScene: SceneKey,
+    ): SceneKey {
+        return when (scene) {
+            Lockscreen,
+            SplitLockscreen -> lockscreenScene
+            Shade,
+            SplitShade -> shadeScene
+            // We should never be in the QuickSettings page if the SplitShade is a possible scene.
+            QuickSettings -> if (shadeScene == SplitShade) SplitShade else QuickSettings
+            else -> scene
+        }
+    }
+}
+
+object Overlays {
+    val Notifications = OverlayKey("NotificationsOverlay")
+    val QuickSettings = OverlayKey("QuickSettingsOverlay")
+}
+
+/** A [Saver] that restores a [MutableSceneTransitionLayoutState] to its previous [currentScene]. */
+class MutableSceneTransitionLayoutSaver(
+    private val sceneSaver: Scenes.SceneSaver,
+    private val transitions: SceneTransitions,
+    private val canChangeScene: (SceneKey) -> Boolean,
+    private val enableInterruptions: Boolean,
+) : Saver<MutableSceneTransitionLayoutState, String> {
+    override fun SaverScope.save(state: MutableSceneTransitionLayoutState): String {
+        val currentScene = state.transitionState.currentScene
+        return with(sceneSaver) { save(currentScene) }
+    }
+
+    override fun restore(value: String): MutableSceneTransitionLayoutState {
+        val currentScene = sceneSaver.restore(value)
+        return MutableSceneTransitionLayoutState(
+            currentScene,
+            transitions,
+            canChangeScene = canChangeScene,
+            enableInterruptions = enableInterruptions,
+        )
+    }
+}
+
+@Composable
+fun SystemUi(modifier: Modifier = Modifier) {
+    var configuration by
+        rememberSaveable(stateSaver = DemoConfiguration.Saver) {
+            mutableStateOf(DemoConfiguration())
+        }
+    SystemUi(configuration, { configuration = it }, modifier)
+}
+
+@Composable
+fun SystemUi(
+    configuration: DemoConfiguration,
+    onConfigurationChange: (DemoConfiguration) -> Unit,
+    modifier: Modifier = Modifier,
+    initialScene: SceneKey? = null,
+) {
+    val windowSizeClass = calculateWindowSizeClass()
+    val shouldUseSplitScenes = shouldUseSplitScenes(windowSizeClass)
+
+    val lockscreenScene: SceneKey
+    val shadeScene: SceneKey
+    val launcherColumns: Int
+    if (shouldUseSplitScenes) {
+        lockscreenScene = Scenes.SplitLockscreen
+        shadeScene = Scenes.SplitShade
+        launcherColumns = 8
+    } else {
+        lockscreenScene = Scenes.Lockscreen
+        shadeScene = Scenes.Shade
+        launcherColumns = 4
+    }
+
+    val notificationCount =
+        max(configuration.notificationsInLockscreen, configuration.notificationsInShade)
+    val interactiveNotifications = configuration.interactiveNotifications
+    val notificationSprings = configuration.springConfigurations.notificationSprings
+    val notificationTextMeasurer = rememberTextMeasurer(cacheSize = notificationCount * 2)
+    val notifications =
+        remember(
+            interactiveNotifications,
+            notificationCount,
+            notificationSprings,
+            notificationTextMeasurer,
+        ) {
+            notifications(
+                interactiveNotifications,
+                notificationCount,
+                notificationSprings,
+                notificationTextMeasurer,
+            )
+        }
+    val expectedQsSize = 12
+    val quickSettingsTextMeasurer = rememberTextMeasurer(cacheSize = expectedQsSize * 2)
+    val quickSettingsTiles = remember { quickSettingsTiles(quickSettingsTextMeasurer) }
+    check(expectedQsSize == quickSettingsTiles.size)
+
+    var isLockscreenDismissable by remember { mutableStateOf(false) }
+    var isLockscreenDismissed by remember { mutableStateOf(false) }
+    var showConfigurationDialog by remember { mutableStateOf(false) }
+
+    val nQuickSettingsColumns =
+        when (windowSizeClass.widthSizeClass) {
+            WindowWidthSizeClass.Compact -> 2
+            WindowWidthSizeClass.Medium,
+            WindowWidthSizeClass.Expanded ->
+                when (windowSizeClass.heightSizeClass) {
+                    // Phone landscape.
+                    WindowHeightSizeClass.Compact -> 2
+                    else -> 3
+                }
+            else -> error("Unknown size class: ${windowSizeClass.widthSizeClass}")
+        }
+
+    val nQuickSettingsRow = 4
+    val nQuickSettingsSplitShadeRows = nQuickSettingsColumns
+
+    // The state of the quick settings pager in the phone (one column) layout.
+    val nQuickSettingsPages =
+        nQuickSettingsPages(
+            nTiles = quickSettingsTiles.size,
+            nRows = nQuickSettingsRow,
+            nColumns = nQuickSettingsColumns,
+        )
+    val quickSettingsPagerState = rememberPagerState { nQuickSettingsPages }
+
+    val springConfiguration = configuration.springConfigurations.systemUiSprings
+    val transitions =
+        remember(quickSettingsPagerState, springConfiguration, configuration) {
+            systemUiTransitions(quickSettingsPagerState, springConfiguration, configuration)
+        }
+    val enableInterruptions = configuration.enableInterruptions
+
+    val sceneSaver =
+        remember(lockscreenScene, shadeScene) { Scenes.SceneSaver(lockscreenScene, shadeScene) }
+    fun maybeUpdateLockscreenDismissed(scene: SceneKey) {
+        when (scene) {
+            Scenes.Launcher -> isLockscreenDismissed = true
+            Scenes.Lockscreen,
+            Scenes.SplitLockscreen -> isLockscreenDismissed = false
+            else -> {}
+        }
+    }
+
+    val canChangeScene =
+        remember(configuration) {
+            { scene: SceneKey ->
+                if (configuration.canChangeSceneOrOverlays) {
+                    maybeUpdateLockscreenDismissed(scene)
+                    true
+                } else {
+                    false
+                }
+            }
+        }
+
+    val stateSaver =
+        remember(sceneSaver, transitions, canChangeScene, enableInterruptions) {
+            MutableSceneTransitionLayoutSaver(
+                sceneSaver,
+                transitions,
+                canChangeScene,
+                enableInterruptions,
+            )
+        }
+    val layoutState =
+        rememberSaveable(
+            transitions,
+            canChangeScene,
+            enableInterruptions,
+            configuration,
+            saver = stateSaver,
+        ) {
+            val initialScene =
+                initialScene?.let {
+                    Scenes.ensureCorrectScene(
+                        initialScene,
+                        lockscreenScene = lockscreenScene,
+                        shadeScene = shadeScene,
+                    )
+                } ?: lockscreenScene
+
+            MutableSceneTransitionLayoutState(
+                initialScene,
+                transitions,
+                canChangeScene = canChangeScene,
+                canShowOverlay = { configuration.canChangeSceneOrOverlays },
+                canHideOverlay = { configuration.canChangeSceneOrOverlays },
+                canReplaceOverlay = { _, _ -> configuration.canChangeSceneOrOverlays },
+                enableInterruptions = enableInterruptions,
+            )
+        }
+
+    val coroutineScope = rememberCoroutineScope()
+    fun onChangeScene(scene: SceneKey) {
+        maybeUpdateLockscreenDismissed(scene)
+
+        // Enforce that we are going to the right shade/lockscreen here depending on the windows
+        // size class.
+        layoutState.setTargetScene(
+            Scenes.ensureCorrectScene(scene, lockscreenScene, shadeScene),
+            coroutineScope,
+        )
+    }
+
+    fun onPowerButtonClicked() {
+        isLockscreenDismissable = false
+        isLockscreenDismissed = false
+
+        if (layoutState.transitionState.currentScene == Scenes.AlwaysOnDisplay) {
+            onChangeScene(lockscreenScene)
+        } else {
+            onChangeScene(Scenes.AlwaysOnDisplay)
+        }
+    }
+
+    fun onSettingsButtonClicked() {
+        showConfigurationDialog = true
+    }
+
+    fun onExpandButtonClicked() {
+        onConfigurationChange(configuration.copy(isFullscreen = true))
+    }
+
+    @Composable
+    fun SceneScope.NotificationList(maxNotificationCount: Int) {
+        NotificationList(notifications, maxNotificationCount, configuration)
+    }
+
+    if (showConfigurationDialog) {
+        DemoConfigurationDialog(
+            configuration,
+            onConfigurationChange,
+            onDismissRequest = { showConfigurationDialog = false },
+        )
+    }
+
+    Column(modifier) {
+        if (!configuration.isFullscreen) {
+            Row(Modifier.horizontalScroll(rememberScrollState())) {
+                IconButton(::onPowerButtonClicked) { Icon(Icons.Default.PowerSettingsNew, null) }
+                IconButton(::onSettingsButtonClicked) { Icon(Icons.Default.Settings, null) }
+                IconButton(::onExpandButtonClicked) { Icon(Icons.Default.ZoomOutMap, null) }
+
+                Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
+                    listOf(
+                            Scenes.AlwaysOnDisplay to "AOD",
+                            Scenes.Lockscreen to "Lock",
+                            Scenes.Bouncer to "Bouncer",
+                            Scenes.Launcher to "Gone",
+                            Scenes.Shade to "Shade",
+                            Scenes.QuickSettings to "QS",
+                        )
+                        .forEach { (scene, name) ->
+                            Button(onClick = { onChangeScene(scene) }) { Text(name) }
+                        }
+
+                    listOf(Overlays.Notifications to "NS", Overlays.QuickSettings to "QSS")
+                        .forEach { (overlay, name) ->
+                            Button(
+                                onClick = {
+                                    if (layoutState.currentOverlays.contains(overlay)) {
+                                        layoutState.hideOverlay(overlay, coroutineScope)
+                                    } else {
+                                        layoutState.showOverlay(overlay, coroutineScope)
+                                    }
+                                }
+                            ) {
+                                Text(name)
+                            }
+                        }
+                }
+            }
+        }
+
+        // Provide an easy way to leave full screen mode by going back.
+        BackHandler(enabled = configuration.isFullscreen) {
+            onConfigurationChange(configuration.copy(isFullscreen = false))
+        }
+
+        val shape = RoundedCornerShape(Shade.Dimensions.ScrimCornerSize)
+        val borderColor = MaterialTheme.colorScheme.onSurface
+
+        Box(
+            Modifier.thenIf(!configuration.isFullscreen) {
+                    Modifier.padding(3.dp).border(1.dp, borderColor, shape).clip(shape)
+                }
+                .background(MaterialTheme.colorScheme.surfaceVariant)
+        ) {
+            CompositionLocalProvider(
+                LocalContentColor provides MaterialTheme.colorScheme.onSurface
+            ) {
+                var isMediaPlayerPlaying by remember { mutableStateOf(false) }
+                val mediaPlayer: (@Composable SceneScope.() -> Unit)? =
+                    if (configuration.showMediaPlayer) {
+                        {
+                            MediaPlayer(
+                                isPlaying = isMediaPlayerPlaying,
+                                onIsPlayingChange = { isMediaPlayerPlaying = it },
+                            )
+                        }
+                    } else {
+                        null
+                    }
+
+                // SceneTransitionLayout can only be bound to one SceneTransitionLayoutState, so
+                // make sure we recompose it fully when we create a new state object.
+                key(layoutState) {
+                    SceneTransitionLayout(
+                        state = layoutState,
+                        transitionInterceptionThreshold =
+                            configuration.transitionInterceptionThreshold,
+                        modifier =
+                            // Make this layout accessible to UiAutomator.
+                            Modifier.semantics { testTagsAsResourceId = true }
+                                .testTag("SystemUiSceneTransitionLayout"),
+                        swipeSourceDetector =
+                            if (configuration.enableOverlays) HorizontalHalfScreenDetector
+                            else DefaultEdgeDetector,
+                    ) {
+                        scene(Scenes.Launcher, Launcher.userActions(shadeScene, configuration)) {
+                            Launcher(launcherColumns)
+                        }
+                        scene(
+                            Scenes.Lockscreen,
+                            Lockscreen.userActions(
+                                isLockscreenDismissable,
+                                shadeScene,
+                                requiresFullDistanceSwipeToShade =
+                                    when (configuration.lsToShadeRequiresFullSwipe) {
+                                        ToggleableState.On -> true
+                                        ToggleableState.Off -> false
+                                        ToggleableState.Indeterminate ->
+                                            configuration.interactiveNotifications
+                                    },
+                                configuration,
+                            ),
+                        ) {
+                            Lockscreen(
+                                notificationList = {
+                                    NotificationList(
+                                        maxNotificationCount =
+                                            configuration.notificationsInLockscreen
+                                    )
+                                },
+                                mediaPlayer,
+                                isDismissable = isLockscreenDismissable,
+                                onToggleDismissable = {
+                                    isLockscreenDismissable = !isLockscreenDismissable
+                                },
+                                ::onChangeScene,
+                            )
+                        }
+                        scene(
+                            Scenes.SplitLockscreen,
+                            SplitLockscreen.userActions(
+                                isLockscreenDismissable,
+                                shadeScene,
+                                configuration,
+                            ),
+                        ) {
+                            SplitLockscreen(
+                                notificationList = {
+                                    NotificationList(
+                                        maxNotificationCount =
+                                            configuration.notificationsInLockscreen
+                                    )
+                                },
+                                mediaPlayer,
+                                isDismissable = isLockscreenDismissable,
+                                onToggleDismissable = {
+                                    isLockscreenDismissable = !isLockscreenDismissable
+                                },
+                                ::onChangeScene,
+                            )
+                        }
+                        scene(Scenes.StubStart, Stub.startUserActions(lockscreenScene)) {
+                            Stub(
+                                rootKey = Stub.Elements.SceneStart,
+                                textKey = Stub.Elements.TextStart,
+                                text = "Stub scene (start)",
+                            )
+                        }
+                        scene(Scenes.StubEnd, Stub.endUserActions(lockscreenScene)) {
+                            Stub(
+                                rootKey = Stub.Elements.SceneEnd,
+                                textKey = Stub.Elements.TextEnd,
+                                text = "Stub scene (end)",
+                            )
+                        }
+                        scene(Scenes.Camera, Camera.userActions(lockscreenScene)) { Camera() }
+                        scene(Scenes.Bouncer, Bouncer.userActions(lockscreenScene)) {
+                            Bouncer(
+                                onBouncerCancelled = { onChangeScene(lockscreenScene) },
+                                onBouncerSolved = { onChangeScene(Scenes.Launcher) },
+                            )
+                        }
+                        scene(
+                            Scenes.QuickSettings,
+                            QuickSettings.userActions(
+                                shadeScene,
+                                lockscreenScene,
+                                isLockscreenDismissed,
+                            ),
+                        ) {
+                            QuickSettings(
+                                quickSettingsPagerState,
+                                quickSettingsTiles,
+                                nQuickSettingsRow,
+                                nQuickSettingsColumns,
+                                mediaPlayer,
+                                ::onSettingsButtonClicked,
+                                ::onPowerButtonClicked,
+                            )
+                        }
+                        scene(
+                            Scenes.Shade,
+                            Shade.userActions(isLockscreenDismissed, lockscreenScene),
+                        ) {
+                            Shade(
+                                notificationList = {
+                                    NotificationList(
+                                        maxNotificationCount = configuration.notificationsInShade
+                                    )
+                                },
+                                mediaPlayer,
+                                quickSettingsTiles,
+                                nQuickSettingsColumns,
+                            )
+                        }
+                        scene(
+                            Scenes.SplitShade,
+                            SplitShade.userActions(isLockscreenDismissed, lockscreenScene),
+                        ) {
+                            SplitShade(
+                                notificationList = {
+                                    NotificationList(
+                                        maxNotificationCount = configuration.notificationsInShade
+                                    )
+                                },
+                                mediaPlayer,
+                                quickSettingsTiles,
+                                nQuickSettingsSplitShadeRows,
+                                nQuickSettingsColumns,
+                                ::onSettingsButtonClicked,
+                                ::onPowerButtonClicked,
+                            )
+                        }
+
+                        scene(Scenes.AlwaysOnDisplay) {
+                            AlwaysOnDisplay(Modifier.clickable { onChangeScene(lockscreenScene) })
+                        }
+
+                        overlay(
+                            Overlays.Notifications,
+                            userActions = NotificationShade.UserActions,
+                            alignment = Alignment.TopEnd,
+                        ) {
+                            NotificationShade(
+                                notificationList = {
+                                    NotificationList(
+                                        maxNotificationCount = configuration.notificationsInShade
+                                    )
+                                }
+                            )
+                        }
+                        overlay(
+                            Overlays.QuickSettings,
+                            userActions = QuickSettingsShade.UserActions,
+                            alignment = Alignment.TopStart,
+                        ) {
+                            QuickSettingsShade(mediaPlayer)
+                        }
+                    }
+                }
+            }
+        }
+    }
+}
+
+// Adapted from [androidx.compose.material3.windowsizeclass.calculateWindowSizeClass].
+@Composable
+internal fun calculateWindowSizeClass(): WindowSizeClass {
+    // Observe view configuration changes and recalculate the size class on each change. We can't
+    // use Activity#onConfigurationChanged as this will sometimes fail to be called on different
+    // API levels, hence why this function needs to be @Composable so we can observe the
+    // ComposeView's configuration changes.
+    LocalConfiguration.current
+
+    return calculateWindowSizeClass(LocalContext.current, LocalDensity.current)
+}
+
+@OptIn(ExperimentalMaterial3WindowSizeClassApi::class)
+fun calculateWindowSizeClass(context: Context, density: Density): WindowSizeClass {
+    val metrics = WindowMetricsCalculator.getOrCreate().computeCurrentWindowMetrics(context)
+    val size = with(density) { metrics.bounds.toComposeRect().size.toDpSize() }
+    return WindowSizeClass.calculateFromSize(size)
+}
+
+fun shouldUseSplitScenes(windowSizeClass: WindowSizeClass): Boolean {
+    return when (windowSizeClass.widthSizeClass) {
+        WindowWidthSizeClass.Compact,
+        WindowWidthSizeClass.Medium -> false
+        WindowWidthSizeClass.Expanded -> true
+        else -> error("Unknown size class: ${windowSizeClass.widthSizeClass}")
+    }
+}
+
+private fun quickSettingsTiles(textMeasurer: TextMeasurer): List<QuickSettingsTileViewModel> {
+    return listOf(
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.NetworkWifi,
+            title = "Internet",
+            description = "Google Guest",
+            isActive = true,
+            showChevron = true,
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.Bluetooth,
+            title = "Bluetooth",
+            isActive = true,
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.DoNotDisturb,
+            title = "Do Not Disturb",
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.FlashlightOff,
+            title = "Flashlight",
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.AirplanemodeInactive,
+            title = "Airplane mode",
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.Home,
+            title = "Home",
+            description = "1600 Amphitheatre Pkwy",
+            isActive = true,
+            showChevron = true,
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.CreditCard,
+            title = "GPay",
+            description = " 0061",
+            isActive = true,
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.ScreenRotation,
+            title = "Auto-rotate",
+            isActive = true,
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.Bedtime,
+            title = "Night Light",
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.Videocam,
+            title = "Screen record",
+            description = "Start",
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.NearbyOff,
+            title = "Nearby Share",
+            showChevron = true,
+        ),
+        quickSettingsTile(
+            textMeasurer = textMeasurer,
+            icon = Icons.Default.ChargingStation,
+            title = "Battery Share",
+            description = "On",
+            inactiveDescription = "Off",
+        ),
+    )
+}
+
+private fun quickSettingsTile(
+    textMeasurer: TextMeasurer,
+    icon: ImageVector,
+    title: String,
+    key: ElementKey = ElementKey("Tile:$title", identity = QuickSettingsTileIdentity()),
+    isActive: Boolean = false,
+    description: String? = null,
+    inactiveDescription: String? = description,
+    showChevron: Boolean = false,
+): QuickSettingsTileViewModel {
+    val activeDescription = description
+
+    var isActive by mutableStateOf(isActive)
+    var description by mutableStateOf(if (isActive) activeDescription else inactiveDescription)
+
+    return object : QuickSettingsTileViewModel {
+        override val key: ElementKey = key
+        override val isActive: Boolean
+            get() = isActive
+
+        override val icon: ImageVector = icon
+        override val title: String = title
+        override val description: String?
+            get() = description
+
+        override val showChevron: Boolean = showChevron
+        override val onClick: () -> Unit = {
+            isActive = !isActive
+            description =
+                if (isActive) {
+                    activeDescription
+                } else {
+                    inactiveDescription
+                }
+        }
+
+        override val textMeasurer: TextMeasurer = textMeasurer
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt
new file mode 100644
index 000000000..799978227
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/DemoNotifications.kt
@@ -0,0 +1,114 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.notification
+
+import androidx.compose.runtime.Composable
+import androidx.compose.ui.text.TextMeasurer
+import com.android.compose.animation.scene.ContentKey
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.MovableElementKey
+import com.android.compose.animation.scene.MutableSceneTransitionLayoutState
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.SceneTransitions
+import com.android.compose.animation.scene.StaticElementContentPicker
+import com.android.compose.animation.scene.content.state.TransitionState
+import com.android.compose.animation.scene.demo.Overlays
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.SpringConfiguration
+import com.android.compose.animation.scene.demo.transitions.ToShadeScrimFadeEndFraction
+import com.android.compose.animation.scene.demo.transitions.ToSplitShadeOpaqueBackgroundProgress
+
+fun notifications(
+    isInteractive: Boolean,
+    n: Int,
+    springConfiguration: SpringConfiguration,
+    textMeasurer: TextMeasurer,
+): List<NotificationViewModel> {
+    val transitions = NotificationContent.transitions(springConfiguration)
+    return List(n) { notification(isInteractive, it + 1, transitions, textMeasurer) }
+}
+
+private fun notification(
+    isInteractive: Boolean,
+    i: Int,
+    transitions: SceneTransitions,
+    textMeasurer: TextMeasurer,
+    key: MovableElementKey =
+        MovableElementKey(
+            "Notification:$i",
+            identity = NotificationIdentity(),
+            contentPicker = NotificationContentPicker,
+        ),
+): NotificationViewModel {
+    return object : NotificationViewModel {
+        override val key: MovableElementKey = key
+        override val state: MutableSceneTransitionLayoutState =
+            MutableSceneTransitionLayoutState(Notification.Scenes.Collapsed, transitions)
+        override val isInteractive: Boolean = isInteractive
+
+        override val collapsedContent: @Composable SceneScope.() -> Unit = {
+            CollapsedNotificationContent(i, textMeasurer)
+        }
+
+        override val expandedContent: @Composable SceneScope.() -> Unit = {
+            ExpandedNotificationContent(i, textMeasurer)
+        }
+    }
+}
+
+private object NotificationContentPicker : StaticElementContentPicker {
+    override val contents =
+        setOf(
+            Scenes.Lockscreen,
+            Scenes.Shade,
+            Scenes.SplitLockscreen,
+            Scenes.SplitShade,
+            Overlays.Notifications,
+        )
+
+    override fun contentDuringTransition(
+        element: ElementKey,
+        transition: TransitionState.Transition,
+        fromContentZIndex: Float,
+        toContentZIndex: Float,
+    ): ContentKey {
+        return when {
+            transition.isTransitioning(from = Scenes.Lockscreen, to = Scenes.Shade) -> Scenes.Shade
+            transition.isTransitioning(from = Scenes.Shade, to = Scenes.Lockscreen) -> {
+                // From Shade to Lockscreen the shared element animation is disabled, so we first
+                // show the notification in the shade/scrim as long as the scrim is opaque, then we
+                // show them in the lockscreen once the scrim fades out.
+                if (transition.progress < 1f - ToShadeScrimFadeEndFraction) {
+                    Scenes.Shade
+                } else {
+                    Scenes.Lockscreen
+                }
+            }
+            transition.isTransitioning(from = Scenes.SplitLockscreen, to = Scenes.SplitShade) ->
+                Scenes.SplitShade
+            transition.isTransitioning(from = Scenes.SplitShade, to = Scenes.SplitLockscreen) -> {
+                if (transition.progress < 1f - ToSplitShadeOpaqueBackgroundProgress) {
+                    Scenes.SplitShade
+                } else {
+                    Scenes.SplitLockscreen
+                }
+            }
+            transition.isTransitioningFromOrTo(Overlays.Notifications) -> Overlays.Notifications
+            else -> pickSingleContentIn(contents, transition, element)
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt
new file mode 100644
index 000000000..075f6cfa1
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/Notification.kt
@@ -0,0 +1,145 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.notification
+
+import androidx.compose.foundation.background
+import androidx.compose.foundation.clickable
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.material3.LocalContentColor
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.CompositionLocalProvider
+import androidx.compose.runtime.Stable
+import androidx.compose.runtime.getValue
+import androidx.compose.runtime.remember
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.graphics.Path
+import androidx.compose.ui.unit.Dp
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.MovableElementKey
+import com.android.compose.animation.scene.MutableSceneTransitionLayoutState
+import com.android.compose.animation.scene.NestedScrollBehavior
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.SceneTransitionLayout
+import com.android.compose.animation.scene.Swipe
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementDpAsState
+import com.android.compose.modifiers.thenIf
+
+object Notification {
+    object Values {
+        val BackgroundTopRadius = ValueKey("NotificationBackgroundTopRadius")
+        val BackgroundBottomRadius = ValueKey("NotificationBackgroundTopRadius")
+    }
+
+    object Scenes {
+        val Collapsed = SceneKey("CollapsedNotification")
+        val Expanded = SceneKey("ExpandedNotification")
+    }
+}
+
+@Stable
+interface NotificationViewModel {
+    val key: MovableElementKey
+    val state: MutableSceneTransitionLayoutState
+    val isExpanded: Boolean
+        get() = state.transitionState.currentScene == Notification.Scenes.Expanded
+
+    /** Whether the user can click or swipe on the notification to expand or collapse it. */
+    val isInteractive: Boolean
+
+    /** The different contents of this notification. */
+    val collapsedContent: @Composable SceneScope.() -> Unit
+    val expandedContent: @Composable SceneScope.() -> Unit
+}
+
+@Composable
+internal fun SceneScope.Notification(
+    viewModel: NotificationViewModel,
+    isFirstNotification: Boolean,
+    isLastNotification: Boolean,
+    modifier: Modifier = Modifier,
+) {
+    fun targetRadius(isLarge: Boolean): Dp {
+        return if (isLarge) 24.dp else 4.dp
+    }
+
+    val key = viewModel.key
+    MovableElement(key, modifier) {
+        val topRadius by
+            animateElementDpAsState(
+                targetRadius(isLarge = isFirstNotification),
+                Notification.Values.BackgroundTopRadius,
+            )
+
+        val bottomRadius by
+            animateElementDpAsState(
+                targetRadius(isLarge = isLastNotification),
+                Notification.Values.BackgroundBottomRadius,
+            )
+
+        content {
+            val backgroundColor = MaterialTheme.colorScheme.surfaceBright
+            val contentColor = MaterialTheme.colorScheme.onSurface
+            val isInteractive = viewModel.isInteractive
+
+            val coroutineScope = rememberCoroutineScope()
+            CompositionLocalProvider(LocalContentColor provides contentColor) {
+                SceneTransitionLayout(
+                    state = viewModel.state,
+                    Modifier.fillMaxWidth()
+                        .notificationClip(remember { Path() }, { topRadius }, { bottomRadius })
+                        .thenIf(isInteractive) {
+                            Modifier.verticalNestedScrollToScene(
+                                    topBehavior = NestedScrollBehavior.EdgeWithPreview,
+                                    bottomBehavior = NestedScrollBehavior.EdgeWithPreview,
+                                )
+                                .clickable {
+                                    viewModel.state.setTargetScene(
+                                        when (viewModel.state.transitionState.currentScene) {
+                                            Notification.Scenes.Expanded ->
+                                                Notification.Scenes.Collapsed
+                                            else -> Notification.Scenes.Expanded
+                                        },
+                                        coroutineScope,
+                                    )
+                                }
+                        }
+                        .background(backgroundColor),
+                ) {
+                    scene(
+                        Notification.Scenes.Collapsed,
+                        if (isInteractive) CollapsedUserActions else emptyMap(),
+                    ) {
+                        viewModel.collapsedContent(/* sceneScope= */ this)
+                    }
+                    scene(
+                        Notification.Scenes.Expanded,
+                        if (isInteractive) ExpandedUserActions else emptyMap(),
+                    ) {
+                        viewModel.expandedContent(/* sceneScope= */ this)
+                    }
+                }
+            }
+        }
+    }
+}
+
+private val CollapsedUserActions = mapOf(Swipe.Down to Notification.Scenes.Expanded)
+private val ExpandedUserActions = mapOf(Swipe.Up to Notification.Scenes.Collapsed)
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationClip.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationClip.kt
new file mode 100644
index 000000000..ae21e19e7
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationClip.kt
@@ -0,0 +1,54 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.notification
+
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.drawWithCache
+import androidx.compose.ui.geometry.CornerRadius
+import androidx.compose.ui.geometry.RoundRect
+import androidx.compose.ui.graphics.Path
+import androidx.compose.ui.graphics.drawscope.clipPath
+import androidx.compose.ui.unit.Dp
+
+internal fun Modifier.notificationClip(
+    path: Path,
+    topRadius: () -> Dp,
+    bottomRadius: () -> Dp,
+): Modifier {
+    return drawWithCache {
+        val topRadius = topRadius()
+        val bottomRadius = bottomRadius()
+        val topCornerRadius = CornerRadius(topRadius.toPx())
+        val bottomCornerRadius = CornerRadius(bottomRadius.toPx())
+
+        path.reset()
+        path.addRoundRect(
+            RoundRect(
+                0f,
+                0f,
+                size.width,
+                size.height,
+                topLeftCornerRadius = topCornerRadius,
+                topRightCornerRadius = topCornerRadius,
+                bottomLeftCornerRadius = bottomCornerRadius,
+                bottomRightCornerRadius = bottomCornerRadius,
+            )
+        )
+
+        onDrawWithContent { clipPath(path) { this@onDrawWithContent.drawContent() } }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationContent.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationContent.kt
new file mode 100644
index 000000000..7d7ea85e5
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationContent.kt
@@ -0,0 +1,185 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.notification
+
+import androidx.compose.animation.core.spring
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.Row
+import androidx.compose.foundation.layout.Spacer
+import androidx.compose.foundation.layout.height
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.layout.size
+import androidx.compose.foundation.layout.width
+import androidx.compose.material.icons.Icons
+import androidx.compose.material.icons.filled.ExpandMore
+import androidx.compose.material.icons.filled.Home
+import androidx.compose.material3.Icon
+import androidx.compose.material3.MaterialTheme
+import androidx.compose.material3.Text
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.getValue
+import androidx.compose.ui.Alignment
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.draw.drawWithContent
+import androidx.compose.ui.graphics.drawscope.rotate
+import androidx.compose.ui.graphics.vector.ImageVector
+import androidx.compose.ui.text.TextMeasurer
+import androidx.compose.ui.unit.dp
+import androidx.compose.ui.zIndex
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.ValueKey
+import com.android.compose.animation.scene.animateElementIntAsState
+import com.android.compose.animation.scene.demo.CachedText
+import com.android.compose.animation.scene.demo.SpringConfiguration
+import com.android.compose.animation.scene.transitions
+
+object NotificationContent {
+    object Elements {
+        val Icon = ElementKey("NotificationContentIcon")
+        val Title = ElementKey("NotificationContentTitle")
+        val AltTitle = ElementKey("NotificationContentAltTitle")
+        val Content = ElementKey("NotificationContentContent")
+        val Chevron = ElementKey("NotificationContentChevron")
+    }
+
+    object Values {
+        val ChevronRotation = ValueKey("NotificationChevronRotation")
+    }
+
+    fun transitions(springConfiguration: SpringConfiguration) = transitions {
+        defaultSwipeSpec =
+            spring(
+                stiffness = springConfiguration.stiffness,
+                dampingRatio = springConfiguration.dampingRatio,
+                visibilityThreshold = 0.5f,
+            )
+
+        overscrollDisabled(Notification.Scenes.Collapsed, Orientation.Vertical)
+        overscrollDisabled(Notification.Scenes.Expanded, Orientation.Vertical)
+
+        from(Notification.Scenes.Expanded, to = Notification.Scenes.Collapsed) {
+            spec = tween(500)
+
+            fractionRange(end = 0.5f) { fade(Elements.AltTitle) }
+        }
+    }
+}
+
+@Composable
+fun SceneScope.CollapsedNotificationContent(
+    i: Int,
+    textMeasurer: TextMeasurer,
+    modifier: Modifier = Modifier,
+) {
+    Row(
+        modifier.height(80.dp).padding(horizontal = 20.dp),
+        verticalAlignment = Alignment.CenterVertically,
+    ) {
+        Icon(Icons.Default.Home, Modifier.zIndex(-2f))
+        Spacer(Modifier.width(8.dp))
+        Column(Modifier.weight(1f)) {
+            Title(i, textMeasurer)
+            Spacer(Modifier.width(8.dp))
+            Content("This is the notification content", textMeasurer)
+        }
+        Spacer(Modifier.width(8.dp))
+        Chevron(rotate = false, Modifier.zIndex(-1f))
+    }
+}
+
+@Composable
+fun SceneScope.ExpandedNotificationContent(
+    i: Int,
+    textMeasurer: TextMeasurer,
+    modifier: Modifier = Modifier,
+) {
+    Column(modifier.padding(20.dp)) {
+        Row(verticalAlignment = Alignment.CenterVertically) {
+            Icon(Icons.Default.Home)
+            Spacer(Modifier.width(8.dp))
+            Text(
+                "Example notification",
+                style = MaterialTheme.typography.bodyMedium,
+                modifier = Modifier.weight(1f).element(NotificationContent.Elements.AltTitle),
+            )
+            Spacer(Modifier.width(8.dp))
+            Chevron(rotate = true)
+        }
+        Row {
+            Spacer(Modifier.size(24.dp + 8.dp))
+            Column {
+                Title(i, textMeasurer)
+                Spacer(Modifier.width(8.dp))
+                Content("This is the notification content", textMeasurer)
+            }
+        }
+    }
+}
+
+@Composable
+private fun SceneScope.Title(i: Int, textMeasurer: TextMeasurer, modifier: Modifier = Modifier) {
+    CachedText(
+        "Notification $i",
+        textMeasurer,
+        modifier.element(NotificationContent.Elements.Title),
+        style = MaterialTheme.typography.titleSmall,
+    )
+}
+
+@Composable
+private fun SceneScope.Content(
+    content: String,
+    textMeasurer: TextMeasurer,
+    modifier: Modifier = Modifier,
+) {
+    CachedText(
+        content,
+        textMeasurer,
+        modifier.element(NotificationContent.Elements.Content),
+        style = MaterialTheme.typography.bodyMedium,
+    )
+}
+
+@Composable
+private fun SceneScope.Icon(icon: ImageVector, modifier: Modifier = Modifier) {
+    Icon(icon, null, modifier.size(24.dp).element(NotificationContent.Elements.Icon))
+}
+
+@Composable
+private fun SceneScope.Chevron(rotate: Boolean, modifier: Modifier = Modifier) {
+    val key = NotificationContent.Elements.Chevron
+    Element(key, modifier) {
+        val rotation by
+            animateElementIntAsState(
+                if (rotate) 180 else 0,
+                NotificationContent.Values.ChevronRotation,
+            )
+
+        content {
+            Icon(
+                Icons.Default.ExpandMore,
+                null,
+                Modifier.size(24.dp).drawWithContent {
+                    rotate(rotation.toFloat()) { this@drawWithContent.drawContent() }
+                },
+            )
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt
new file mode 100644
index 000000000..d5b5e5e66
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/notification/NotificationList.kt
@@ -0,0 +1,135 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.notification
+
+import androidx.compose.foundation.layout.Arrangement
+import androidx.compose.foundation.layout.Column
+import androidx.compose.foundation.layout.fillMaxWidth
+import androidx.compose.foundation.layout.padding
+import androidx.compose.foundation.rememberScrollState
+import androidx.compose.foundation.verticalScroll
+import androidx.compose.runtime.Composable
+import androidx.compose.runtime.LaunchedEffect
+import androidx.compose.runtime.key
+import androidx.compose.runtime.rememberCoroutineScope
+import androidx.compose.ui.Modifier
+import androidx.compose.ui.unit.dp
+import androidx.compose.ui.zIndex
+import com.android.compose.animation.scene.ElementKey
+import com.android.compose.animation.scene.ObservableTransitionState
+import com.android.compose.animation.scene.SceneScope
+import com.android.compose.animation.scene.SceneTransitionLayoutState
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.observableTransitionState
+import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.flow.combine
+import kotlinx.coroutines.flow.filter
+import kotlinx.coroutines.flow.filterIsInstance
+import kotlinx.coroutines.flow.first
+import kotlinx.coroutines.flow.flatMapLatest
+
+class NotificationIdentity
+
+object NotificationList {
+    object Elements {
+        val Notifications = ElementKey.withIdentity { it is NotificationIdentity }
+    }
+}
+
+@Composable
+fun SceneScope.NotificationList(
+    notifications: List<NotificationViewModel>,
+    maxNotificationCount: Int?,
+    demoConfiguration: DemoConfiguration,
+    modifier: Modifier = Modifier,
+) {
+    if (demoConfiguration.interactiveNotifications) {
+        ExpandFirstNotificationWhenSwipingFromLockscreenToShade(notifications)
+    }
+
+    // TODO(b/291025415): Do not share elements that are laid out fully outside the
+    // SceneTransitionLayout bounds.
+    // TODO(b/291025415): Make sure everything still works when using `LazyColumn` instead of a
+    // scrollable `Column`.
+    val scrollState = rememberScrollState()
+    Column(
+        modifier.verticalScroll(scrollState).fillMaxWidth().padding(16.dp),
+        verticalArrangement = Arrangement.spacedBy(2.dp),
+    ) {
+        val n = maxNotificationCount ?: notifications.size
+        repeat(n) { i ->
+            val notification = notifications[i]
+            val isFirst = i == 0
+            val isLast = i == n - 1
+
+            key(notification.key) {
+                Notification(
+                    notification,
+                    isFirst,
+                    isLast,
+                    // Make sure that notifications that are shared (which are always the first
+                    // n notifications) are always drawn above the notifications that are not
+                    // shared.
+                    Modifier.zIndex((n - i).toFloat()),
+                )
+            }
+        }
+    }
+}
+
+@Composable
+private fun SceneScope.ExpandFirstNotificationWhenSwipingFromLockscreenToShade(
+    notifications: List<NotificationViewModel>
+) {
+    val firstNotification = notifications.firstOrNull() ?: return
+    val coroutineScope = rememberCoroutineScope()
+    val layoutState = layoutState
+
+    LaunchedEffect(coroutineScope, layoutState, firstNotification, firstNotification.isExpanded) {
+        if (!firstNotification.isExpanded) {
+            expandFirstNotificationWhenSwipingFromLockscreenToShade(
+                coroutineScope,
+                layoutState,
+                firstNotification,
+            )
+        }
+    }
+}
+
+private suspend fun expandFirstNotificationWhenSwipingFromLockscreenToShade(
+    coroutineScope: CoroutineScope,
+    layoutState: SceneTransitionLayoutState,
+    firstNotification: NotificationViewModel,
+) {
+    // Wait for the user to release their finger during the next swipe transition from Lockscreen to
+    // Shade.
+    layoutState
+        .observableTransitionState()
+        .filterIsInstance<ObservableTransitionState.Transition.ChangeScene>()
+        .filter {
+            it.isInitiatedByUserInput &&
+                it.isTransitioning(from = Scenes.Lockscreen, to = Scenes.Shade)
+        }
+        .flatMapLatest { it.isUserInputOngoing.combine(it.currentScene) { a, b -> a to b } }
+        .first { (isUserInputOngoing, currentScene) ->
+            !isUserInputOngoing && currentScene == Scenes.Shade
+        }
+
+    // Expand the first notification.
+    firstNotification.state.setTargetScene(Notification.Scenes.Expanded, coroutineScope)
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/AlwaysOnDisplayTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/AlwaysOnDisplayTransitions.kt
new file mode 100644
index 000000000..4fc4842f6
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/AlwaysOnDisplayTransitions.kt
@@ -0,0 +1,49 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.TransitionBuilder
+import com.android.compose.animation.scene.demo.AlwaysOnDisplay
+import com.android.compose.animation.scene.demo.Clock
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.SmartSpace
+
+fun SceneTransitionsBuilder.alwaysOnDisplayTransitions() {
+    to(Scenes.AlwaysOnDisplay) { defaultTransition() }
+
+    // Given that ShadeTransitions.kt defines a generic from(Shade) transition, make sure we use
+    // this transition when going from Shade to AOD.
+    from(Scenes.Shade, to = Scenes.AlwaysOnDisplay) { defaultTransition() }
+
+    // Given that SplitShadeTransitions.kt defines a generic from(SplitShade) transition, make sure
+    // we use this transition when going from SplitShade to AOD.
+    from(Scenes.SplitShade, to = Scenes.AlwaysOnDisplay) { defaultTransition() }
+}
+
+val AodBackgroundEndProgress = 0.5f
+
+private fun TransitionBuilder.defaultTransition() {
+    spec = tween(durationMillis = 500)
+
+    fractionRange(end = AodBackgroundEndProgress) { fade(AlwaysOnDisplay.Elements.Background) }
+    fractionRange(start = AodBackgroundEndProgress) {
+        fade(Clock.Elements.Clock)
+        fade(SmartSpace.Elements.SmartSpace)
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt
new file mode 100644
index 000000000..9977edada
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/BouncerTransitions.kt
@@ -0,0 +1,31 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.foundation.gestures.Orientation
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.demo.Bouncer
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.Scenes
+
+fun SceneTransitionsBuilder.bouncerTransitions(configuration: DemoConfiguration) {
+    if (configuration.useOverscrollSpec) {
+        overscroll(Scenes.Bouncer, Orientation.Vertical) {
+            translate(Bouncer.Elements.Content, y = { absoluteDistance })
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LauncherTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LauncherTransitions.kt
new file mode 100644
index 000000000..628d97e85
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LauncherTransitions.kt
@@ -0,0 +1,40 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.demo.Bouncer
+import com.android.compose.animation.scene.demo.Launcher
+import com.android.compose.animation.scene.demo.Scenes
+
+fun SceneTransitionsBuilder.launcherTransitions() {
+    from(Scenes.Bouncer, to = Scenes.Launcher) {
+        spec = tween(durationMillis = 500)
+
+        translate(Bouncer.Elements.Content, y = (-150).dp)
+        fractionRange(end = 0.5f) { fade(Bouncer.Elements.Content) }
+        fractionRange(start = 0.5f) {
+            fade(Bouncer.Elements.Background)
+            scaleDraw(Launcher.Elements.Scene, 0.5f, 0.5f)
+        }
+    }
+
+    overscrollDisabled(Scenes.Launcher, Orientation.Vertical)
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt
new file mode 100644
index 000000000..d59cc8e2e
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/LockscreenTransitions.kt
@@ -0,0 +1,126 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.CubicBezierEasing
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.ui.unit.dp
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.TransitionBuilder
+import com.android.compose.animation.scene.TransitionKey
+import com.android.compose.animation.scene.demo.Bouncer
+import com.android.compose.animation.scene.demo.Camera
+import com.android.compose.animation.scene.demo.Clock
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.Launcher
+import com.android.compose.animation.scene.demo.Lockscreen
+import com.android.compose.animation.scene.demo.MediaPlayer
+import com.android.compose.animation.scene.demo.QuickSettings
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.Shade
+import com.android.compose.animation.scene.demo.SmartSpace
+import com.android.compose.animation.scene.demo.Stub
+import com.android.compose.animation.scene.demo.notification.NotificationList
+
+fun SceneTransitionsBuilder.lockscreenTransitions(configuration: DemoConfiguration) {
+    // The transitions between lockscreen/split lockscreen <=> bouncer/launcher/camera/stub are
+    // the same.
+    commonLockscreenTransitions(Scenes.Lockscreen)
+    commonLockscreenTransitions(Scenes.SplitLockscreen)
+
+    if (configuration.useOverscrollSpec) {
+        overscrollDisabled(Scenes.Lockscreen, Orientation.Vertical)
+
+        overscroll(Scenes.StubStart, Orientation.Horizontal) {
+            translate(Stub.Elements.TextStart, x = { absoluteDistance })
+        }
+
+        overscroll(Scenes.StubEnd, Orientation.Horizontal) {
+            translate(Stub.Elements.TextEnd, x = { absoluteDistance })
+        }
+    }
+}
+
+val BouncerBackgroundEndProgress = 0.5f
+
+fun SceneTransitionsBuilder.commonLockscreenTransitions(lockscreenScene: SceneKey) {
+    from(
+        Scenes.Bouncer,
+        to = lockscreenScene,
+        preview = {
+            fractionRange(easing = CubicBezierEasing(0.1f, 0.1f, 0f, 1f)) {
+                scaleDraw(Bouncer.Elements.Content, scaleY = 0.8f, scaleX = 0.8f)
+            }
+        },
+        key = TransitionKey.PredictiveBack,
+    ) {
+        bouncerToLockscreenTransition()
+    }
+
+    from(Scenes.Bouncer, to = lockscreenScene) { bouncerToLockscreenTransition() }
+
+    from(lockscreenScene, to = Scenes.Launcher) {
+        spec = tween(durationMillis = 500)
+
+        fractionRange(end = 0.5f) {
+            fade(Clock.Elements.Clock)
+            fade(SmartSpace.Elements.SmartSpace)
+            fade(Lockscreen.Elements.LockButton)
+            fade(Camera.Elements.Button)
+            fade(NotificationList.Elements.Notifications)
+            fade(MediaPlayer.Elements.MediaPlayer)
+            fade(Shade.Elements.BatteryPercentage)
+            fade(QuickSettings.Elements.Operator)
+        }
+
+        fractionRange(start = 0.5f) {
+            fade(Launcher.Elements.Scene)
+            scaleDraw(Launcher.Elements.Scene, 0.5f, 0.5f)
+        }
+    }
+
+    from(lockscreenScene, to = Scenes.StubStart) {
+        spec = tween(durationMillis = 500)
+
+        translate(Stub.Elements.SceneStart, Edge.Start)
+        translate(Lockscreen.Elements.Scene, Edge.End)
+    }
+
+    from(lockscreenScene, to = Scenes.StubEnd) {
+        spec = tween(durationMillis = 500)
+
+        translate(Stub.Elements.SceneEnd, Edge.End)
+        translate(Lockscreen.Elements.Scene, Edge.Start)
+    }
+
+    from(lockscreenScene, to = Scenes.Camera) {
+        spec = tween(durationMillis = 350)
+
+        fade(Camera.Elements.Background)
+    }
+}
+
+private fun TransitionBuilder.bouncerToLockscreenTransition() {
+    spec = tween(durationMillis = 500)
+
+    translate(Bouncer.Elements.Content, y = 300.dp)
+    fractionRange(start = BouncerBackgroundEndProgress) { fade(Bouncer.Elements.Background) }
+    fractionRange(end = BouncerBackgroundEndProgress) { fade(Bouncer.Elements.Content) }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt
new file mode 100644
index 000000000..e5c37aa2a
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/NotificationShadeTransitions.kt
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.TransitionBuilder
+import com.android.compose.animation.scene.demo.NotificationShade
+import com.android.compose.animation.scene.demo.Overlays
+import com.android.compose.animation.scene.demo.notification.NotificationList
+
+fun SceneTransitionsBuilder.notificationShadeTransitions() {
+    to(Overlays.Notifications) {
+        spec = tween(500)
+        toNotificationShade()
+    }
+
+    from(Overlays.Notifications) {
+        spec = tween(500)
+        reversed { toNotificationShade() }
+        sharedElement(NotificationList.Elements.Notifications, enabled = false)
+    }
+
+    overscroll(Overlays.Notifications, Orientation.Vertical) {
+        translate(NotificationShade.Elements.Root, y = { absoluteDistance })
+    }
+
+    overscroll(Overlays.Notifications, Orientation.Horizontal) {
+        translate(NotificationShade.Elements.Root, x = { absoluteDistance })
+    }
+}
+
+private fun TransitionBuilder.toNotificationShade() {
+    translate(NotificationShade.Elements.Root, Edge.Top)
+    fractionRange(start = 0.5f) { fade(NotificationList.Elements.Notifications) }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt
new file mode 100644
index 000000000..ee83dd86e
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsShadeTransitions.kt
@@ -0,0 +1,58 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.demo.Clock
+import com.android.compose.animation.scene.demo.MediaPlayer
+import com.android.compose.animation.scene.demo.NotificationShade
+import com.android.compose.animation.scene.demo.Overlays
+import com.android.compose.animation.scene.demo.PartialShade
+import com.android.compose.animation.scene.demo.QuickSettingsShade
+import com.android.compose.animation.scene.demo.notification.NotificationList
+
+fun SceneTransitionsBuilder.quickSettingsShadeTransitions() {
+    to(Overlays.QuickSettings) {
+        spec = tween(500)
+        translate(QuickSettingsShade.Elements.Root, Edge.Top)
+    }
+
+    from(Overlays.QuickSettings, to = Overlays.Notifications) {
+        spec = tween(500)
+
+        anchoredTranslate(NotificationShade.Elements.Content, PartialShade.Elements.Background)
+        anchoredTranslate(QuickSettingsShade.Elements.Content, PartialShade.Elements.Background)
+
+        fractionRange(end = 0.5f) {
+            fade(MediaPlayer.Elements.MediaPlayer)
+            fade(Clock.Elements.Clock)
+        }
+
+        fractionRange(start = 0.5f) { fade(NotificationList.Elements.Notifications) }
+    }
+
+    overscroll(Overlays.QuickSettings, Orientation.Vertical) {
+        translate(QuickSettingsShade.Elements.Root, y = { absoluteDistance })
+    }
+
+    overscroll(Overlays.QuickSettings, Orientation.Horizontal) {
+        translate(QuickSettingsShade.Elements.Root, x = { absoluteDistance })
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt
new file mode 100644
index 000000000..e586324ed
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/QuickSettingsTransitions.kt
@@ -0,0 +1,65 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.MediaPlayer
+import com.android.compose.animation.scene.demo.QuickSettings
+import com.android.compose.animation.scene.demo.QuickSettingsGrid
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.Shade
+
+val QuickSettingsBackgroundEndProgress = 0.5f
+
+fun SceneTransitionsBuilder.quickSettingsTransitions(configuration: DemoConfiguration) {
+    to(Scenes.QuickSettings) {
+        spec = tween(durationMillis = 500)
+
+        // TODO(b/308961608): Share those elements and animate their color.
+        sharedElement(Shade.Elements.BatteryPercentage)
+        sharedElement(QuickSettings.Elements.Operator)
+
+        fractionRange(end = QuickSettingsBackgroundEndProgress) {
+            fade(QuickSettings.Elements.Background)
+        }
+
+        fractionRange(start = QuickSettingsBackgroundEndProgress) {
+            fade(Shade.Elements.Time)
+            fade(Shade.Elements.BatteryPercentage)
+            fade(QuickSettings.Elements.Date)
+            fade(QuickSettings.Elements.Operator)
+            fade(QuickSettings.Elements.BrightnessSlider)
+            fade(QuickSettings.Elements.ExpandedGrid)
+            fade(QuickSettings.Elements.PagerIndicators)
+            fade(QuickSettings.Elements.FooterActions)
+            fade(MediaPlayer.Elements.MediaPlayer)
+
+            scaleSize(QuickSettingsGrid.Elements.Tiles, height = 0.5f)
+        }
+    }
+
+    if (configuration.useOverscrollSpec) {
+        overscroll(Scenes.QuickSettings, Orientation.Vertical) {
+            translate(QuickSettings.Elements.BrightnessSlider, y = { absoluteDistance })
+            translate(QuickSettings.Elements.ExpandedGrid, y = { absoluteDistance })
+            translate(MediaPlayer.Elements.MediaPlayer, y = { absoluteDistance })
+        }
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt
new file mode 100644
index 000000000..60638bd4b
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/ShadeTransitions.kt
@@ -0,0 +1,192 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import androidx.compose.foundation.gestures.Orientation
+import androidx.compose.foundation.pager.PagerState
+import androidx.compose.ui.unit.IntSize
+import com.android.compose.animation.scene.Edge
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.TransitionBuilder
+import com.android.compose.animation.scene.UserActionDistance
+import com.android.compose.animation.scene.UserActionDistanceScope
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.MediaPlayer
+import com.android.compose.animation.scene.demo.QuickSettings
+import com.android.compose.animation.scene.demo.QuickSettingsGrid
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.Shade
+import com.android.compose.animation.scene.demo.notification.NotificationList
+import com.android.compose.animation.scene.inScene
+
+fun SceneTransitionsBuilder.shadeTransitions(
+    qsPagerState: PagerState,
+    configuration: DemoConfiguration,
+) {
+    // The distance when swiping the Shade from/to a scene (except QuickSettings).
+    val swipeDistance =
+        object : UserActionDistance {
+            override fun UserActionDistanceScope.absoluteDistance(
+                fromSceneSize: IntSize,
+                orientation: Orientation,
+            ): Float {
+                val distance = Shade.Elements.Scrim.targetOffset(Scenes.Shade)?.y ?: return 0f
+                check(distance > 0f) { "Scrim target offset in Shade is equal to $distance" }
+
+                // Use the bottom of the QS grid for the minimum distance, so that the distance is
+                // not too small if the scrim was scrolled at the top because it has a lot of
+                // notifications.
+                val qsGridOffset =
+                    Shade.Elements.CollapsedGrid.targetOffset(Scenes.Shade) ?: return 0f
+                val qsGridSize = Shade.Elements.CollapsedGrid.targetSize(Scenes.Shade) ?: return 0f
+                val minDistance = qsGridOffset.y + qsGridSize.height
+                check(minDistance > 0f) {
+                    "Invalid QS offset and size in Shade (qsGridOffset=$qsGridOffset " +
+                        "qsGridSize=$qsGridSize)"
+                }
+
+                // Note: we might want to have a minimum swipe distance here if the scrim was
+                // scrolled at the top of the shade scene because it contains a lot of
+                // notifications, or introduce a new element that is always at the initial scrim
+                // position and use that to compute the distance.
+                return maxOf(distance, minDistance)
+            }
+        }
+    to(Scenes.Shade) {
+        spec = tween(durationMillis = 500)
+        distance = swipeDistance
+
+        toShadeTransformations()
+    }
+
+    from(Scenes.Shade) {
+        spec = tween(durationMillis = 500)
+        distance = swipeDistance
+
+        // Same transition as when going *to* the shade, except that we never share notifications.
+        reversed { toShadeTransformations() }
+        sharedElement(NotificationList.Elements.Notifications, enabled = false)
+    }
+
+    // The distance when swiping the Shade from/to QuickSettings.
+    val qsSwipeDistance =
+        object : UserActionDistance {
+            override fun UserActionDistanceScope.absoluteDistance(
+                fromSceneSize: IntSize,
+                orientation: Orientation,
+            ): Float {
+                val scrimOffsetInShade =
+                    Shade.Elements.Scrim.targetOffset(Scenes.Shade) ?: return 0f
+                val shadeSceneSize = Scenes.Shade.targetSize() ?: return 0f
+                val distance = shadeSceneSize.height - scrimOffsetInShade.y
+                check(distance > 0f) {
+                    "Invalid QS swipe distance (scrimOffsetInShade=$scrimOffsetInShade " +
+                        "shadeSceneSize=$shadeSceneSize)"
+                }
+                return distance
+            }
+        }
+
+    from(Scenes.QuickSettings, to = Scenes.Shade) {
+        spec = tween(durationMillis = 500)
+        distance = qsSwipeDistance
+
+        sharedElement(
+            QuickSettingsGrid.Elements.Tiles,
+
+            // Disable the shared tiles animation if the pager is not on page 0 or is animating.
+            enabled = qsPagerState.currentPage == 0 && !qsPagerState.isScrollInProgress,
+        )
+
+        anchoredTranslate(QuickSettings.Elements.Date, Shade.Elements.BatteryPercentage)
+        anchoredTranslate(QuickSettings.Elements.Operator, Shade.Elements.BatteryPercentage)
+        anchoredTranslate(Shade.Elements.Date, Shade.Elements.Time)
+        anchoredTranslate(
+            QuickSettings.Elements.BrightnessSlider,
+            QuickSettingsGrid.Elements.GridAnchor,
+        )
+        anchoredTranslate(
+            QuickSettings.Elements.ExpandedGrid,
+            QuickSettingsGrid.Elements.GridAnchor,
+        )
+        anchoredTranslate(Shade.Elements.CollapsedGrid, QuickSettingsGrid.Elements.GridAnchor)
+        anchoredSize(
+            QuickSettingsGrid.Elements.Tiles,
+            QuickSettingsGrid.Elements.GridAnchor,
+            anchorWidth = false,
+        )
+
+        translate(Shade.Elements.Scrim, Edge.Bottom)
+
+        // The tiles in the QS appear when going from Shade => QS, and they do so throughout the
+        // whole transition.
+        fade(QuickSettingsGrid.Elements.Tiles.inScene(Scenes.QuickSettings))
+
+        // The tiles in the Shade are either shared (and therefore the transformations are ignored)
+        // or they are not because the QS pager is not on the first page. Those tiles should appear
+        // during the second half of the transition from QS => Shade.
+        fractionRange(start = 0.5f, end = QuickSettings.TransitionToShadeCommittedProgress) {
+            fade(QuickSettingsGrid.Elements.Tiles.inScene(Scenes.Shade))
+        }
+
+        timestampRange(endMillis = 83) {
+            fade(QuickSettings.Elements.FooterActions)
+            fade(QuickSettings.Elements.PagerIndicators)
+        }
+        timestampRange(endMillis = 150) {
+            fade(QuickSettings.Elements.BrightnessSlider)
+            fade(QuickSettings.Elements.Operator)
+            fade(QuickSettings.Elements.Date)
+        }
+        timestampRange(startMillis = 350) { fade(Shade.Elements.Date) }
+    }
+
+    if (configuration.useOverscrollSpec) {
+        overscroll(Scenes.Shade, Orientation.Vertical) {
+            translate(Shade.Elements.Scrim, y = { absoluteDistance })
+        }
+    }
+}
+
+/** The progress until which the shade scrim should be completely opaque when going to the shade. */
+val ToShadeScrimFadeEndFraction = 0.5f
+
+private fun TransitionBuilder.toShadeTransformations() {
+    translate(Shade.Elements.Scrim, Edge.Top, startsOutsideLayoutBounds = false)
+    scaleSize(QuickSettingsGrid.Elements.Tiles, height = 0.5f)
+
+    // Never share the media player when going to the shade. We will compose it in the lockscreen
+    // or in the shade depending on the transition progress.
+    sharedElement(MediaPlayer.Elements.MediaPlayer, enabled = false)
+
+    sharedElement(Shade.Elements.BatteryPercentage, enabled = false)
+
+    fractionRange(end = ToShadeScrimFadeEndFraction) {
+        fade(Shade.Elements.ScrimBackground)
+        translate(Shade.Elements.CollapsedGrid, Edge.Top, startsOutsideLayoutBounds = false)
+    }
+
+    fractionRange(start = ToShadeScrimFadeEndFraction) {
+        fade(Shade.Elements.Date)
+        fade(Shade.Elements.Time)
+        fade(Shade.Elements.BatteryPercentage)
+        fade(NotificationList.Elements.Notifications.inScene(Scenes.Shade))
+    }
+
+    fractionRange(start = 0.8f) { fade(MediaPlayer.Elements.MediaPlayer.inScene(Scenes.Shade)) }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SplitShadeTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SplitShadeTransitions.kt
new file mode 100644
index 000000000..851671e0d
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SplitShadeTransitions.kt
@@ -0,0 +1,74 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.tween
+import com.android.compose.animation.scene.SceneTransitionsBuilder
+import com.android.compose.animation.scene.TransitionBuilder
+import com.android.compose.animation.scene.demo.MediaPlayer
+import com.android.compose.animation.scene.demo.QuickSettings
+import com.android.compose.animation.scene.demo.QuickSettingsGrid
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.Shade
+import com.android.compose.animation.scene.demo.SplitShade
+import com.android.compose.animation.scene.demo.notification.NotificationList
+
+fun SceneTransitionsBuilder.splitShadeTransitions() {
+    to(Scenes.SplitShade) {
+        spec = tween(durationMillis = 500)
+        toSplitShadeTransformations()
+    }
+
+    from(Scenes.SplitShade) {
+        spec = tween(durationMillis = 500)
+
+        // Same transition as when going *to* the split shade, except that we never share
+        // notifications.
+        reversed { toSplitShadeTransformations() }
+        sharedElement(NotificationList.Elements.Notifications, enabled = false)
+    }
+}
+
+val ToSplitShadeOpaqueBackgroundProgress = 0.5f
+
+private fun TransitionBuilder.toSplitShadeTransformations() {
+    sharedElement(Shade.Elements.BatteryPercentage, enabled = false)
+    sharedElement(QuickSettings.Elements.Operator, enabled = false)
+
+    fractionRange(end = ToSplitShadeOpaqueBackgroundProgress) {
+        fade(SplitShade.Elements.Background)
+    }
+
+    fractionRange(start = ToSplitShadeOpaqueBackgroundProgress) {
+        fade(Shade.Elements.Time)
+        fade(Shade.Elements.Date)
+        fade(Shade.Elements.BatteryPercentage)
+        fade(Shade.Elements.ScrimBackground)
+
+        fade(QuickSettings.Elements.Operator)
+        fade(QuickSettings.Elements.BrightnessSlider)
+        fade(QuickSettings.Elements.FooterActions)
+        fade(QuickSettings.Elements.PagerIndicators)
+
+        fade(MediaPlayer.Elements.MediaPlayer)
+
+        fade(QuickSettingsGrid.Elements.Tiles)
+        scaleSize(QuickSettingsGrid.Elements.Tiles, height = 0.5f)
+
+        fade(NotificationList.Elements.Notifications)
+    }
+}
diff --git a/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt
new file mode 100644
index 000000000..89dfc41f6
--- /dev/null
+++ b/samples/SceneTransitionLayoutDemo/src/com/android/compose/animation/scene/demo/transitions/SystemUiTransitions.kt
@@ -0,0 +1,158 @@
+/*
+ * Copyright 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compose.animation.scene.demo.transitions
+
+import androidx.compose.animation.core.spring
+import androidx.compose.foundation.pager.PagerState
+import com.android.compose.animation.scene.InterruptionHandler
+import com.android.compose.animation.scene.InterruptionResult
+import com.android.compose.animation.scene.SceneKey
+import com.android.compose.animation.scene.content.state.TransitionState
+import com.android.compose.animation.scene.demo.DemoConfiguration
+import com.android.compose.animation.scene.demo.Scenes
+import com.android.compose.animation.scene.demo.SpringConfiguration
+import com.android.compose.animation.scene.transitions
+
+fun systemUiTransitions(
+    qsPagerState: PagerState,
+    springConfiguration: SpringConfiguration,
+    configuration: DemoConfiguration,
+) = transitions {
+    interruptionHandler = DemoInterruptionHandler
+    defaultSwipeSpec =
+        spring(
+            stiffness = springConfiguration.stiffness,
+            dampingRatio = springConfiguration.dampingRatio,
+            visibilityThreshold = 0.5f,
+        )
+    defaultOverscrollProgressConverter = configuration.overscrollProgressConverter
+
+    alwaysOnDisplayTransitions()
+    shadeTransitions(qsPagerState, configuration)
+    splitShadeTransitions()
+    quickSettingsTransitions(configuration)
+    lockscreenTransitions(configuration)
+    bouncerTransitions(configuration)
+    launcherTransitions()
+    notificationShadeTransitions()
+    quickSettingsShadeTransitions()
+}
+
+object DemoInterruptionHandler : InterruptionHandler {
+    override fun onInterruption(
+        interrupted: TransitionState.Transition.ChangeScene,
+        newTargetScene: SceneKey,
+    ): InterruptionResult? {
+        return handleLauncherDuringLockscreenToBouncer(interrupted, newTargetScene)
+            ?: handleAod(interrupted)
+            ?: handleShadeLauncherQuickSettings(interrupted, newTargetScene)
+    }
+
+    private fun handleLauncherDuringLockscreenToBouncer(
+        transition: TransitionState.Transition,
+        targetScene: SceneKey,
+    ): InterruptionResult? {
+        if (
+            targetScene != Scenes.Launcher ||
+                !transition.isTransitioningBetween(Scenes.Lockscreen, Scenes.Bouncer)
+        ) {
+            return null
+        }
+
+        // Animate from bouncer only when the bouncer is fully opaque, otherwise animate from
+        // lockscreen.
+        val animatesFromBouncer =
+            if (transition.isTransitioning(to = Scenes.Bouncer)) {
+                transition.progress >= BouncerBackgroundEndProgress
+            } else {
+                transition.progress <= 1f - BouncerBackgroundEndProgress
+            }
+
+        return if (animatesFromBouncer) {
+            InterruptionResult(
+                animateFrom = Scenes.Bouncer,
+
+                // We don't want the content of the lockscreen to be shown during the Bouncer =>
+                // Launcher transition. We disable chaining of the transitions so that only the
+                // Bouncer and Launcher scenes are composed.
+                chain = false,
+            )
+        } else {
+            InterruptionResult(animateFrom = Scenes.Lockscreen)
+        }
+    }
+
+    private fun handleAod(transition: TransitionState.Transition): InterruptionResult? {
+        if (
+            transition !is TransitionState.Transition.ChangeScene ||
+                (!transition.isTransitioning(from = Scenes.AlwaysOnDisplay) &&
+                    !transition.isTransitioning(to = Scenes.AlwaysOnDisplay))
+        ) {
+            return null
+        }
+
+        // Animate from AOD only when it is fully opaque, otherwise animate from the other scene in
+        // the transition.
+        val otherScene: SceneKey
+        val animatesFromAod =
+            if (transition.isTransitioning(to = Scenes.AlwaysOnDisplay)) {
+                otherScene = transition.fromScene
+                transition.progress >= AodBackgroundEndProgress
+            } else {
+                otherScene = transition.toScene
+                transition.progress <= 1f - AodBackgroundEndProgress
+            }
+
+        return if (animatesFromAod) {
+            InterruptionResult(animateFrom = Scenes.AlwaysOnDisplay, chain = false)
+        } else {
+            InterruptionResult(animateFrom = otherScene)
+        }
+    }
+
+    private fun handleShadeLauncherQuickSettings(
+        transition: TransitionState.Transition,
+        targetScene: SceneKey,
+    ): InterruptionResult? {
+        if (
+            (transition.isTransitioningBetween(Scenes.Shade, Scenes.Launcher) &&
+                targetScene == Scenes.QuickSettings) ||
+                (transition.isTransitioningBetween(Scenes.Shade, Scenes.QuickSettings) &&
+                    targetScene == Scenes.Launcher)
+        ) {
+            return InterruptionResult(animateFrom = Scenes.Shade)
+        }
+
+        if (
+            transition.isTransitioningBetween(Scenes.QuickSettings, Scenes.Launcher) &&
+                targetScene == Scenes.Shade
+        ) {
+            val animatesFromQS =
+                if (transition.isTransitioning(to = Scenes.QuickSettings)) {
+                    transition.progress >= QuickSettingsBackgroundEndProgress
+                } else {
+                    transition.progress <= 1f - QuickSettingsBackgroundEndProgress
+                }
+
+            return InterruptionResult(
+                animateFrom = if (animatesFromQS) Scenes.QuickSettings else Scenes.Launcher
+            )
+        }
+
+        return null
+    }
+}
diff --git a/samples/VirtualDeviceManager/Android.bp b/samples/VirtualDeviceManager/Android.bp
index 56299ee3e..dcabd03d2 100644
--- a/samples/VirtualDeviceManager/Android.bp
+++ b/samples/VirtualDeviceManager/Android.bp
@@ -66,6 +66,7 @@ android_app {
     static_libs: [
         "androidx.annotation_annotation",
         "androidx.appcompat_appcompat",
+        "com.google.android.material_material",
     ],
 }
 
@@ -90,22 +91,3 @@ android_library {
         "hilt_android",
     ],
 }
-
-android_app {
-    name: "VirtualCameraDemo",
-    manifest: "virtualcamera/AndroidManifest.xml",
-    privileged: true,
-    privapp_allowlist: "virtualcamera/com.example.android.vdmdemo.virtualcamera.xml",
-    platform_apis: true,
-    srcs: [
-        "virtualcamera/src/**/*.java",
-    ],
-    resource_dirs: [
-        "virtualcamera/res",
-    ],
-    static_libs: [
-        "androidx.annotation_annotation",
-        "androidx.appcompat_appcompat",
-        "hilt_android",
-    ],
-}
diff --git a/samples/VirtualDeviceManager/README.md b/samples/VirtualDeviceManager/README.md
index ef771c126..1f4f11c8f 100644
--- a/samples/VirtualDeviceManager/README.md
+++ b/samples/VirtualDeviceManager/README.md
@@ -63,6 +63,21 @@ run
 The interactive script will prompt you which apps to install to which of the
 available devices, build the APKs and install them.
 
+### Using adevice on the host device
+
+1.  Track the required modules.
+
+    ```shell
+    adevice track VdmHost
+    adevice track VdmDemos
+    ```
+
+1.  Update the device
+
+    ```shell
+    adevice update
+    ```
+
 ### Manually
 
 1.  Source `build/envsetup.sh` and run `lunch` or set
@@ -156,14 +171,7 @@ show a launcher-like list of installed apps on the host device.
 
 -   The Host app has a **CREATE MIRROR DISPLAY** button, clicking it will create
     a new virtual display, mirror the default host display there and start
-    streaming the display contents to the client. Run the commands below to
-    enable this functionality.
-
-    ```shell
-    adb shell device_config put virtual_devices android.companion.virtual.flags.consistent_display_flags true
-    adb shell device_config put virtual_devices android.companion.virtual.flags.interactive_screen_mirror true
-    adb shell am force-stop com.example.android.vdmdemo.host
-    ```
+    streaming the display contents to the client.
 
 ### Settings
 
@@ -182,8 +190,8 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
 -   **Remote** allows the host device to act as a pointer that controls the
     mouse movement on the focused display.
 
--   **Navigation** shows an on-screen D-Pad and touchpad for navigating the
-    activity on the focused display.
+-   **Navigation** shows an on-screen D-Pad, rotary and touchpad for navigating
+    the activity on the focused display.
 
 -   **Keyboard** shows the host device's on-screen keyboard and sends any key
     events to the activity on the focused display.
@@ -225,6 +233,20 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
     adb shell am force-stop com.example.android.vdmdemo.host
     ```
 
+-   **Enable custom activity policy**: Whether to use custom user notification
+    for activities that are unable to launch on the virtual display and send
+    such activities to the default display, whenever possible. Use together with
+    the activity policy demo. The behavior of the display fallback launch is
+    different depending on whether an activity result is expected by the caller,
+    and on whether the default display keyguard is currently locked. \
+    *This can be changed dynamically.*
+
+    ```shell
+    adb shell device_config put virtual_devices android.companion.virtual.flags.dynamic_policy true
+    adb shell device_config put virtual_devices android.companion.virtualdevice.flags.activity_control_api true
+    adb shell am force-stop com.example.android.vdmdemo.host
+    ```
+
 #### Client capabilities
 
 -   **Enable client Sensors**: Enables sensor injection from the client device
@@ -232,10 +254,10 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
     will access the virtual sensors by default. \
     *Changing this will recreate the virtual device.*
 
--   **Enable client Camera**: Enables front & back camera injection from the client device
-    into the host device. (WIP: Any context that is associated with the virtual device
-    will the virtual cameras by default). Run the commands below on host device \
-    to enable this functionality.
+-   **Enable client Camera**: Enables front & back camera injection from the
+    client device into the host device. (WIP: Any context that is associated
+    with the virtual device will the virtual cameras by default). Run the
+    commands below on host device to enable this functionality. \
     *Changing this will recreate the virtual device.*
 
     ```shell
@@ -256,15 +278,15 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
     automatically rotate the relevant display upon such request. Disabling this
     simulates a fixed orientation display that cannot physically rotate. Then
     any streamed apps on that display will be letterboxed/pillarboxed if they
-    request orientation change. Run the commands below to enable this
-    functionality. \
+    request orientation change. \
     *This can be changed dynamically but only applies to newly created
     displays.*
 
-    ```shell
-    adb shell device_config put virtual_devices android.companion.virtual.flags.consistent_display_flags true
-    adb shell am force-stop com.example.android.vdmdemo.host
-    ```
+-   **Display category**: Whether to specify a custom display category for the
+    virtual displays. This means that only activities that have explicitly set
+    a matching `android:requiredDisplayCategory` activity attribute can be
+    launched on that display. \
+    *Changing this will recreate the virtual device.*
 
 -   **Always unlocked**: Whether the virtual displays should remain unlocked and
     interactive when the host device is locked. Disabling this will result in a
@@ -285,12 +307,23 @@ Each input screen has a "Back", "Home" and "Forward" buttons.
     adb shell am force-stop com.example.android.vdmdemo.host
     ```
 
+-   **Custom status bar**: Whether to add a custom status bar view on the
+    non-mirror virtual displays. Run the commands below to enable this
+    functionality. \
+    *This can be changed dynamically but only applies to newly created
+    displays.*
+
+    ```shell
+    adb shell device_config put virtual_devices android.companion.virtualdevice.flags.status_bar_and_insets true
+    adb shell am force-stop com.example.android.vdmdemo.host
+    ```
+
 #### Input method
 
-Note: The virtual keyboard acts like a physically connected keyboard to the
-host device. If you want the software keyboard to be shown on the virtual
-displays, you likely need to enable this in the host Settings. On a Pixel
-device: System -> Language and input -> Physical keyboard.
+Note: The virtual keyboard acts like a physically connected keyboard to the host
+device. If you want the software keyboard to be shown on the virtual displays,
+you likely need to enable this in the host Settings. On a Pixel device: System
+-> Language and input -> Physical keyboard.
 
 -   **Display IME policy**: Choose the IME behavior on remote displays. Run the
     commands below to enable this functionality. \
@@ -346,10 +379,10 @@ device: System -> Language and input -> Physical keyboard.
 
 ### Input
 
-The input menu button enables **on-screen D-Pad and touchpad** for navigating
-the activity on the focused display. The focused display is indicated by the
-frame around its header whenever there are more than one displays. The display
-focus is based on user interaction.
+The input menu button enables **on-screen D-Pad, rotary and touchpad** for
+navigating the activity on the focused display. The focused display is indicated
+by the frame around its header whenever there are more than one displays. The
+display focus is based on user interaction.
 
 In addition, any input events generated from an **externally connected
 keyboard** are forwarded to the activity streamed on the focused display.
@@ -362,16 +395,25 @@ display, if the mouse pointer is currently positioned on a streamed display.
 
 ## Demos
 
+-   **Activity policy**: An activity showcasing blocking of activity launches on
+    the virtual device - either because the activity has opted out via
+    `android:canDisplayOnRemoteDevices` attribute, or because of the custom
+    activity policy of that device.
+
 -   **Sensors**: A simple activity balancing a beam on the screen based on the
     accelerometer events, which allows for selecting which device's sensor to
     use. By default, will use the sensors of the device it's shown on.
 
+-   **Display Power**: A simple activity showcasing the behavior of proximity
+    locks, screen brightness override and requesting the screen to be kept on
+    or turned on.
+
 -   **Rotation**: A simple activity that is in landscape by default and can send
     orientation change requests on demand. Showcases the display rotation on the
     client, which will rotate the user-visible surface.
 
 -   **Home**: A simple activity with utilities around launching HOME and
-    SECONDARY_HOME Intents.
+    SECONDARY_HOME Intents, as well as other implicit intents.
 
 -   **Secure Window**: A simple activity that declares the Window as secure.
     This showcases the FLAG_SECURE streaming policies in VDM.
@@ -393,12 +435,34 @@ display, if the mouse pointer is currently positioned on a streamed display.
 -   **Stylus**: A simple drawing activity that reacts on stylus input events.
     Use together with the simulated stylus input feature of the host app.
 
+The demo activity depends on whether the **Display Category** Host preference is
+enabled or not. If enabled, it becomes equivalent to the **Home** demo activity,
+which showcases implicit intent handling.
+
 <!-- LINT.ThenChange(README.md) -->
 
 ## SDK Version
 
+### Beyond Android 15
+
+-   Added support for custom system windows (like status bar) and insets.
+
+-   Added support for per-display activity policies.
+
+-   Added support for custom redirection of blocked activities.
+
+-   Added support for hiding the blocked activity dialog.
+
+-   Added support for virtual display cutout.
+
+-   Added support for virtual display rotation.
+
+-   Added support for virtual rotary input.
+
 ### Android 15 / Vanilla Ice Cream / SDK level 35
 
+-   Added support for virtual stylus input.
+
 -   Added support for cross-device clipboard.
 
 -   Added support for custom home activities.
@@ -425,6 +489,8 @@ display, if the mouse pointer is currently positioned on a streamed display.
 
 ### Android 14 / Upside Down Cake / SDK level 34
 
+-   Added support for display categories and restricted activities.
+
 -   Added support for virtual sensors.
 
 -   Added device awareness to contexts.
@@ -437,6 +503,8 @@ display, if the mouse pointer is currently positioned on a streamed display.
 
 -   Added support for virtual navigation input: D-Pad and navigation touchpad.
 
+-   Added support for display categories and restricted activities.
+
 -   Improved support for audio, allowing routing to be based on the origin
     context.
 
diff --git a/samples/VirtualDeviceManager/client/res/layout/activity_main.xml b/samples/VirtualDeviceManager/client/res/layout/activity_main.xml
index 504605185..e2b2228de 100644
--- a/samples/VirtualDeviceManager/client/res/layout/activity_main.xml
+++ b/samples/VirtualDeviceManager/client/res/layout/activity_main.xml
@@ -61,9 +61,21 @@
         android:layout_height="0dp"
         android:visibility="gone"
         app:layout_constraintBottom_toBottomOf="parent"
-        app:layout_constraintEnd_toEndOf="parent"
+        app:layout_constraintEnd_toStartOf="@+id/rotary_fragment_container"
         app:layout_constraintHorizontal_chainStyle="packed"
         app:layout_constraintStart_toEndOf="@+id/dpad_fragment_container"
         app:layout_constraintTop_toBottomOf="@+id/guideline" />
 
+    <androidx.fragment.app.FragmentContainerView
+        android:id="@+id/rotary_fragment_container"
+        android:name="com.example.android.vdmdemo.common.RotaryFragment"
+        android:layout_width="0dp"
+        android:layout_height="0dp"
+        android:visibility="gone"
+        app:layout_constraintBottom_toBottomOf="parent"
+        app:layout_constraintEnd_toEndOf="parent"
+        app:layout_constraintHorizontal_chainStyle="packed"
+        app:layout_constraintStart_toEndOf="@+id/nav_touchpad_fragment_container"
+        app:layout_constraintTop_toBottomOf="@+id/guideline" />
+
 </androidx.constraintlayout.widget.ConstraintLayout>
diff --git a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/DisplayAdapter.java b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/DisplayAdapter.java
index 3011a104b..f5e27041c 100644
--- a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/DisplayAdapter.java
+++ b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/DisplayAdapter.java
@@ -38,6 +38,7 @@ import androidx.recyclerview.widget.RecyclerView;
 import androidx.recyclerview.widget.RecyclerView.ViewHolder;
 
 import com.example.android.vdmdemo.client.DisplayAdapter.DisplayHolder;
+import com.example.android.vdmdemo.common.RemoteEventProto.DisplayRotation;
 import com.example.android.vdmdemo.common.RemoteEventProto.InputDeviceType;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
 import com.example.android.vdmdemo.common.RemoteIo;
@@ -90,10 +91,11 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
         }
     }
 
-    void addDisplay(boolean homeSupported) {
+    void addDisplay(boolean homeSupported, boolean rotationSupported) {
         Log.i(TAG, "Adding display " + sNextDisplayIndex);
         mDisplayRepository.add(
-                new RemoteDisplay(sNextDisplayIndex.getAndIncrement(), homeSupported));
+                new RemoteDisplay(sNextDisplayIndex.getAndIncrement(), homeSupported,
+                        rotationSupported));
         notifyItemInserted(mDisplayRepository.size() - 1);
     }
 
@@ -199,6 +201,7 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
         private TextView mDisplayTitle = null;
         private View mRotateButton = null;
         private int mDisplayId = 0;
+        private RemoteDisplay mRemoteDisplay = null;
 
         DisplayHolder(View view) {
             super(view);
@@ -209,7 +212,8 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
                 return;
             }
             Log.i(TAG, "Rotating display " + mDisplayId + " to " + rotationDegrees);
-            mRotateButton.setEnabled(rotationDegrees == 0 || resize);
+            mRotateButton.setEnabled(rotationDegrees == 0 || resize
+                    || mRemoteDisplay.isRotationSupported());
 
             // Make sure the rotation is visible.
             View strut = itemView.requireViewById(R.id.strut);
@@ -275,8 +279,8 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
 
         @SuppressLint("ClickableViewAccessibility")
         void onBind(int position) {
-            RemoteDisplay remoteDisplay = mDisplayRepository.get(position);
-            mDisplayId = remoteDisplay.getDisplayId();
+            mRemoteDisplay = mDisplayRepository.get(position);
+            mDisplayId = mRemoteDisplay.getDisplayId();
             Log.v(TAG, "Binding DisplayHolder for display " + mDisplayId + " to position "
                     + position);
 
@@ -308,7 +312,7 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
             backButton.setOnClickListener(v -> mInputManager.sendBack(mDisplayId));
 
             View homeButton = itemView.requireViewById(R.id.display_home);
-            if (remoteDisplay.isHomeSupported()) {
+            if (mRemoteDisplay.isHomeSupported()) {
                 homeButton.setVisibility(View.VISIBLE);
                 homeButton.setOnClickListener(v -> mInputManager.sendHome(mDisplayId));
             } else {
@@ -318,12 +322,20 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
             mRotateButton = itemView.requireViewById(R.id.display_rotate);
             mRotateButton.setOnClickListener(v -> {
                 mInputManager.setFocusedDisplayId(mDisplayId);
-                // This rotation is simply resizing the display with width with height swapped.
-                mDisplayController.setSurface(
-                        mSurface,
-                        /* width= */ mTextureView.getHeight(),
-                        /* height= */ mTextureView.getWidth());
-                rotateDisplay(mTextureView.getWidth() > mTextureView.getHeight() ? 90 : -90, true);
+                if (mRemoteDisplay.isRotationSupported()) {
+                    mRemoteIo.sendMessage(RemoteEvent.newBuilder()
+                            .setDisplayId(mDisplayId)
+                            .setDisplayRotation(DisplayRotation.newBuilder())
+                            .build());
+                } else {
+                    // This rotation is simply resizing the display with width with height swapped.
+                    mDisplayController.setSurface(
+                            mSurface,
+                            /* width= */ mTextureView.getHeight(),
+                            /* height= */ mTextureView.getWidth());
+                    rotateDisplay(mTextureView.getWidth() > mTextureView.getHeight() ? 90 : -90,
+                            true);
+                }
             });
 
             View resizeButton = itemView.requireViewById(R.id.display_resize);
@@ -404,10 +416,12 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
         // Local ID, not corresponding to the displayId of the relevant Display on the host device.
         private final int mDisplayId;
         private final boolean mHomeSupported;
+        private final boolean mRotationSupported;
 
-        RemoteDisplay(int displayId, boolean homeSupported) {
+        RemoteDisplay(int displayId, boolean homeSupported, boolean rotationSupported) {
             mDisplayId = displayId;
             mHomeSupported = homeSupported;
+            mRotationSupported = rotationSupported;
         }
 
         int getDisplayId() {
@@ -417,5 +431,9 @@ final class DisplayAdapter extends RecyclerView.Adapter<DisplayHolder> {
         boolean isHomeSupported() {
             return mHomeSupported;
         }
+
+        boolean isRotationSupported() {
+            return mRotationSupported;
+        }
     }
 }
diff --git a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/InputManager.java b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/InputManager.java
index f477eae79..8bdd28765 100644
--- a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/InputManager.java
+++ b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/InputManager.java
@@ -111,6 +111,9 @@ final class InputManager {
                 case DEVICE_TYPE_MOUSE:
                     sendMouseEvent(event, displayId);
                     break;
+                case DEVICE_TYPE_ROTARY_ENCODER:
+                    sendRotaryEvent(event, displayId);
+                    break;
                 default:
                     Log.e(TAG, "sendInputEvent got invalid device type " + deviceType.getNumber());
             }
@@ -201,7 +204,7 @@ final class InputManager {
             case MotionEvent.ACTION_BUTTON_RELEASE:
                 RemoteInputEvent buttonEvent =
                         RemoteInputEvent.newBuilder()
-                                .setTimestampMs(System.currentTimeMillis())
+                                .setTimestampMs(event.getEventTime())
                                 .setDeviceType(InputDeviceType.DEVICE_TYPE_MOUSE)
                                 .setMouseButtonEvent(
                                         RemoteKeyEvent.newBuilder()
@@ -217,7 +220,7 @@ final class InputManager {
                 setFocusedDisplayId(displayId);
                 RemoteInputEvent relativeEvent =
                         RemoteInputEvent.newBuilder()
-                                .setTimestampMs(System.currentTimeMillis())
+                                .setTimestampMs(event.getEventTime())
                                 .setDeviceType(InputDeviceType.DEVICE_TYPE_MOUSE)
                                 .setMouseRelativeEvent(
                                         RemoteMotionEvent.newBuilder()
@@ -232,7 +235,7 @@ final class InputManager {
                 float scrollY = event.getAxisValue(MotionEvent.AXIS_VSCROLL);
                 RemoteInputEvent scrollEvent =
                         RemoteInputEvent.newBuilder()
-                                .setTimestampMs(System.currentTimeMillis())
+                                .setTimestampMs(event.getEventTime())
                                 .setDeviceType(InputDeviceType.DEVICE_TYPE_MOUSE)
                                 .setMouseScrollEvent(
                                         RemoteMotionEvent.newBuilder()
@@ -245,6 +248,18 @@ final class InputManager {
         }
     }
 
+    private void sendRotaryEvent(MotionEvent event, int displayId) {
+        sendInputEvent(
+                RemoteInputEvent.newBuilder()
+                        .setDeviceType(InputDeviceType.DEVICE_TYPE_ROTARY_ENCODER)
+                        .setTimestampMs(event.getEventTime())
+                        .setMouseScrollEvent(RemoteMotionEvent.newBuilder()
+                                .setX(event.getAxisValue(MotionEvent.AXIS_SCROLL))
+                                .build())
+                        .build(),
+                displayId);
+    }
+
     private void sendInputEvent(RemoteInputEvent inputEvent, int displayId) {
         mRemoteIo.sendMessage(
                 RemoteEvent.newBuilder().setDisplayId(displayId).setInputEvent(inputEvent).build());
diff --git a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
index 81fae6638..854f7cfd0 100644
--- a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
+++ b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/MainActivity.java
@@ -43,6 +43,7 @@ import com.example.android.vdmdemo.common.RemoteEventProto.DeviceCapabilities;
 import com.example.android.vdmdemo.common.RemoteEventProto.InputDeviceType;
 import com.example.android.vdmdemo.common.RemoteEventProto.RemoteEvent;
 import com.example.android.vdmdemo.common.RemoteIo;
+import com.example.android.vdmdemo.common.RotaryFragment;
 
 import dagger.hilt.android.AndroidEntryPoint;
 
@@ -136,6 +137,12 @@ public class MainActivity extends Hilt_MainActivity {
         navTouchpadFragment.setInputEventListener((event) ->
                 mInputManager.sendInputEventToFocusedDisplay(
                         InputDeviceType.DEVICE_TYPE_NAVIGATION_TOUCHPAD, event));
+        RotaryFragment rotaryFragment =
+                (RotaryFragment) getSupportFragmentManager().findFragmentById(
+                        R.id.rotary_fragment_container);
+        rotaryFragment.setInputEventListener((event) ->
+                mInputManager.sendInputEventToFocusedDisplay(
+                        InputDeviceType.DEVICE_TYPE_ROTARY_ENCODER, event));
 
         mConnectionManager.startClientSession();
     }
@@ -212,7 +219,8 @@ public class MainActivity extends Hilt_MainActivity {
     private void processRemoteEvent(RemoteEvent event) {
         if (event.hasStartStreaming()) {
             runOnUiThread(
-                    () -> mDisplayAdapter.addDisplay(event.getStartStreaming().getHomeEnabled()));
+                    () -> mDisplayAdapter.addDisplay(event.getStartStreaming().getHomeEnabled(),
+                            event.getStartStreaming().getRotationSupported()));
         } else if (event.hasStopStreaming()) {
             runOnUiThread(() -> mDisplayAdapter.removeDisplay(event.getDisplayId()));
         } else if (event.hasDisplayRotation()) {
@@ -235,6 +243,7 @@ public class MainActivity extends Hilt_MainActivity {
         int visibility = dpad.getVisibility() == View.VISIBLE ? View.GONE : View.VISIBLE;
         dpad.setVisibility(visibility);
         requireViewById(R.id.nav_touchpad_fragment_container).setVisibility(visibility);
+        requireViewById(R.id.rotary_fragment_container).setVisibility(visibility);
     }
 
     private static boolean hasRecordAudioPermission(Context context) {
diff --git a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/VirtualSensorController.java b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/VirtualSensorController.java
index 3157f09be..c3b3266e8 100644
--- a/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/VirtualSensorController.java
+++ b/samples/VirtualDeviceManager/client/src/com/example/android/vdmdemo/client/VirtualSensorController.java
@@ -35,8 +35,9 @@ import dagger.hilt.android.qualifiers.ApplicationContext;
 import dagger.hilt.android.scopes.ActivityScoped;
 
 import java.util.List;
+import java.util.Objects;
 import java.util.function.Consumer;
-import java.util.stream.Collectors;
+import java.util.stream.Stream;
 
 import javax.inject.Inject;
 
@@ -86,20 +87,28 @@ final class VirtualSensorController implements AutoCloseable {
     }
 
     public List<SensorCapabilities> getSensorCapabilities() {
-        return mSensorManager.getSensorList(Sensor.TYPE_ALL).stream()
-                .map(
-                        sensor ->
-                                SensorCapabilities.newBuilder()
-                                        .setType(sensor.getType())
-                                        .setName(sensor.getName())
-                                        .setVendor(sensor.getVendor())
-                                        .setMaxRange(sensor.getMaximumRange())
-                                        .setResolution(sensor.getResolution())
-                                        .setPower(sensor.getPower())
-                                        .setMinDelayUs(sensor.getMinDelay())
-                                        .setMaxDelayUs(sensor.getMaxDelay())
-                                        .build())
-                .collect(Collectors.toList());
+        // For demo purposes we only need a single accelerometer and proximity sensor.
+        return Stream.of(
+                        mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER),
+                        mSensorManager.getDefaultSensor(Sensor.TYPE_PROXIMITY))
+                .filter(Objects::nonNull)
+                .map(VirtualSensorController::createSensorCapabilitiesFromSensor)
+                .toList();
+    }
+
+    private static SensorCapabilities createSensorCapabilitiesFromSensor(Sensor sensor) {
+        return SensorCapabilities.newBuilder()
+                .setType(sensor.getType())
+                .setName(sensor.getName())
+                .setVendor(sensor.getVendor())
+                .setMaxRange(sensor.getMaximumRange())
+                .setResolution(sensor.getResolution())
+                .setPower(sensor.getPower())
+                .setMinDelayUs(sensor.getMinDelay())
+                .setMaxDelayUs(sensor.getMaxDelay())
+                .setIsWakeUpSensor(sensor.isWakeUpSensor())
+                .setReportingMode(sensor.getReportingMode())
+                .build();
     }
 
     private void processRemoteEvent(RemoteEvent remoteEvent) {
diff --git a/samples/VirtualDeviceManager/common/proto/remote_event.proto b/samples/VirtualDeviceManager/common/proto/remote_event.proto
index f3e4711d7..537af6810 100644
--- a/samples/VirtualDeviceManager/common/proto/remote_event.proto
+++ b/samples/VirtualDeviceManager/common/proto/remote_event.proto
@@ -70,6 +70,8 @@ message SensorCapabilities {
   float power = 6;
   int32 min_delay_us = 7;
   int32 max_delay_us = 8;
+  bool is_wake_up_sensor = 9;
+  int32 reporting_mode = 10;
 }
 
 message CameraCapabilities {
@@ -96,6 +98,7 @@ message CameraFrame {
 
 message StartStreaming {
   bool home_enabled = 1;
+  bool rotation_supported = 2;
 }
 
 message StopStreaming {
@@ -122,6 +125,7 @@ enum InputDeviceType {
   DEVICE_TYPE_NAVIGATION_TOUCHPAD = 3;
   DEVICE_TYPE_TOUCHSCREEN = 4;
   DEVICE_TYPE_KEYBOARD = 5;
+  DEVICE_TYPE_ROTARY_ENCODER = 6;
 }
 
 message RemoteInputEvent {
diff --git a/samples/VirtualDeviceManager/common/res/drawable/rotary.xml b/samples/VirtualDeviceManager/common/res/drawable/rotary.xml
new file mode 100644
index 000000000..dc885c59a
--- /dev/null
+++ b/samples/VirtualDeviceManager/common/res/drawable/rotary.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape android:shape="rectangle">
+            <solid android:color="@android:color/transparent" />
+        </shape>
+    </item>
+    <item>
+        <shape android:shape="oval">
+            <solid android:color="?attr/colorButtonNormal" />
+            <size
+                android:width="100dp"
+                android:height="100dp"/>
+        </shape>
+    </item>
+    <item
+        android:bottom="65dp"
+        android:left="65dp"
+        android:right="20dp"
+        android:top="20dp" >
+        <shape android:shape="oval">
+            <solid android:color="?attr/colorControlNormal" />
+        </shape>
+    </item>
+</layer-list>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/common/res/layout/rotary_fragment.xml b/samples/VirtualDeviceManager/common/res/layout/rotary_fragment.xml
new file mode 100644
index 000000000..5a5cc4d4c
--- /dev/null
+++ b/samples/VirtualDeviceManager/common/res/layout/rotary_fragment.xml
@@ -0,0 +1,8 @@
+<ImageView xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/rotary"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_margin="5dp"
+    android:layout_gravity="center"
+    android:scaleType="matrix"
+    android:src="@drawable/rotary" />
diff --git a/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/ConnectionManager.java b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/ConnectionManager.java
index 9e65a685d..5f276e62e 100644
--- a/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/ConnectionManager.java
+++ b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/ConnectionManager.java
@@ -377,5 +377,11 @@ public class ConnectionManager {
                 onError("Failed to establish connection.");
             }
         }
+
+        @Override
+        public void onLost(@NonNull Network network) {
+            super.onLost(network);
+            startClientSession();
+        }
     }
 }
diff --git a/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/DpadFragment.java b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/DpadFragment.java
index 4ed8e4481..a78521fbb 100644
--- a/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/DpadFragment.java
+++ b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/DpadFragment.java
@@ -86,8 +86,8 @@ public final class DpadFragment extends Hilt_DpadFragment {
         if (mInputEventListener != null) {
             mInputEventListener.accept(
                     new KeyEvent(
-                            /* downTime= */ System.currentTimeMillis(),
-                            /* eventTime= */ System.currentTimeMillis(),
+                            e.getDownTime(),
+                            e.getEventTime(),
                             action,
                             keyCode,
                             /* repeat= */ 0));
diff --git a/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/RotaryFragment.java b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/RotaryFragment.java
new file mode 100644
index 000000000..bcbdc6cab
--- /dev/null
+++ b/samples/VirtualDeviceManager/common/src/com/example/android/vdmdemo/common/RotaryFragment.java
@@ -0,0 +1,116 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.common;
+
+import android.graphics.Matrix;
+import android.os.Bundle;
+import android.view.GestureDetector;
+import android.view.InputDevice;
+import android.view.MotionEvent;
+import android.view.View;
+import android.widget.ImageView;
+
+import androidx.annotation.NonNull;
+import androidx.core.view.GestureDetectorCompat;
+import androidx.fragment.app.Fragment;
+
+import dagger.hilt.android.AndroidEntryPoint;
+
+import java.util.function.Consumer;
+
+/** Fragment to show UI for a rotary input. */
+@AndroidEntryPoint(Fragment.class)
+public final class RotaryFragment extends Hilt_RotaryFragment {
+
+    private Consumer<MotionEvent> mInputEventListener;
+
+    private ImageView mView;
+    private GestureDetectorCompat mDetector;
+    private final GestureListener mGestureListener = new GestureListener();
+
+
+    public RotaryFragment() {
+        super(R.layout.rotary_fragment);
+    }
+
+    public void setInputEventListener(Consumer<MotionEvent> listener) {
+        mInputEventListener = listener;
+    }
+
+    @Override
+    public void onViewCreated(View view, Bundle savedInstanceState) {
+        mView = (ImageView) view;
+        mDetector = new GestureDetectorCompat(requireContext(), mGestureListener);
+        mView.setOnTouchListener((v, e) -> mDetector.onTouchEvent(e));
+    }
+
+    private class GestureListener extends GestureDetector.SimpleOnGestureListener {
+
+        private static final int SCROLL_THRESHOLD = 80;
+        private float mCurrentAngle = 0f;
+        private int mScroll = 0;
+        @Override
+        public boolean onDown(@NonNull MotionEvent e) {
+            return true;
+        }
+
+        @Override
+        public boolean onScroll(
+                MotionEvent e1, @NonNull MotionEvent e2, float distanceX, float distanceY) {
+            float angle = calculateAngle(e2.getX(), e2.getY());
+            Matrix matrix = new Matrix();
+            matrix.postRotate(angle, mView.getPivotX(), mView.getPivotY());
+            mView.setImageMatrix(matrix);
+
+            mScroll += angle > mCurrentAngle ? 1 : -1;
+            mCurrentAngle = angle;
+            if (Math.abs(mScroll) >= SCROLL_THRESHOLD) {
+                final MotionEvent.PointerProperties pointerProperties =
+                        new MotionEvent.PointerProperties();
+                pointerProperties.toolType = MotionEvent.TOOL_TYPE_UNKNOWN;
+                final MotionEvent.PointerCoords pointerCoords = new MotionEvent.PointerCoords();
+                pointerCoords.setAxisValue(MotionEvent.AXIS_SCROLL, mScroll > 0 ? 1 : -1);
+                MotionEvent scrollEvent = MotionEvent.obtain(
+                        0 /* downTime */,
+                        0 /* eventTime */,
+                        MotionEvent.ACTION_SCROLL,
+                        1 /* pointerCount */,
+                        new MotionEvent.PointerProperties[]{pointerProperties},
+                        new MotionEvent.PointerCoords[]{pointerCoords},
+                        0 /* metaState */,
+                        0 /* buttonState */,
+                        1f /* xPrecision */,
+                        1f /* yPrecision */,
+                        0 /* deviceId */,
+                        0 /* edgeFlags */,
+                        InputDevice.SOURCE_ROTARY_ENCODER,
+                        0 /* flags */);
+                mInputEventListener.accept(scrollEvent);
+                mScroll = 0;
+            }
+            return true;
+        }
+    }
+
+    private float calculateAngle(float x, float y) {
+        float px = (x / (float) mView.getDrawable().getBounds().width()) - 0.5f;
+        float py = (1 - y / (float) mView.getDrawable().getBounds().height()) - 0.5f;
+        double angle = -Math.toDegrees(Math.atan2(py, px)) + 90f;
+        if (angle > 180) angle -= 360;
+        return (float) angle;
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/AndroidManifest.xml b/samples/VirtualDeviceManager/demos/AndroidManifest.xml
index ce4aacdc8..ab5fc50a4 100644
--- a/samples/VirtualDeviceManager/demos/AndroidManifest.xml
+++ b/samples/VirtualDeviceManager/demos/AndroidManifest.xml
@@ -21,6 +21,7 @@
     <uses-permission android:name="android.permission.BODY_SENSORS" />
     <uses-permission android:name="android.permission.POST_NOTIFICATION" />
     <uses-permission android:name="android.permission.VIBRATE" />
+    <uses-permission android:name="android.permission.WAKE_LOCK" />
 
     <!-- LINT.IfChange -->
     <application
@@ -36,11 +37,47 @@
             </intent-filter>
         </activity>
 
+        <activity
+            android:name=".ActivityPolicyDemoActivity"
+            android:exported="true"
+            android:label="@string/activity_policy_demo" />
+
+        <activity
+            android:name=".MainActivityWithDisplayCategory"
+            android:requiredDisplayCategory="@string/display_category"
+            android:exported="true"
+            android:label="VDM Demos Restricted">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.LAUNCHER" />
+                <category android:name="com.example.android.vdmdemo.DISPLAY_CATEGORY" />
+            </intent-filter>
+        </activity>
+
+        <activity
+            android:name=".CalculatorWithDisplayCategory"
+            android:requiredDisplayCategory="@string/display_category"
+            android:exported="true"
+            android:label="Calculator Restricted">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.APP_CALCULATOR" />
+                <category android:name="android.intent.category.LAUNCHER" />
+                <category android:name="com.example.android.vdmdemo.DISPLAY_CATEGORY" />
+            </intent-filter>
+        </activity>
+
         <activity
             android:name=".SensorDemoActivity"
             android:exported="false"
             android:label="@string/sensor_demo" />
 
+        <activity
+            android:name=".DisplayPowerDemoActivity"
+            android:exported="false"
+            android:label="@string/display_power_demo" />
+
         <activity
             android:name=".RotationDemoActivity"
             android:exported="true"
@@ -76,6 +113,30 @@
             android:exported="true"
             android:label="@string/stylus_demo" />
 
+        <activity
+            android:name=".BlockedActivity"
+            android:exported="true"
+            android:label="@string/blocked_activity" />
+
+        <activity
+            android:name=".OptedOutActivity"
+            android:canDisplayOnRemoteDevices="false"
+            android:exported="true"
+            android:label="@string/opted_out_activity" />
+
+        <activity
+            android:name=".TurnScreenOnActivity"
+            android:turnScreenOn="true"
+            android:exported="false"
+            android:label="@string/turn_screen_on_activity" />
+
+        <activity
+            android:name=".TurnScreenOnShowWhenLockedActivity"
+            android:turnScreenOn="true"
+            android:showWhenLocked="true"
+            android:exported="false"
+            android:label="@string/turn_screen_on_show_when_locked_activity" />
+
     </application>
     <!-- LINT.ThenChange(/samples/VirtualDeviceManager/README.md:demos) -->
 </manifest>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/activity_policy_demo_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/activity_policy_demo_activity.xml
new file mode 100644
index 000000000..7061f7387
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/res/layout/activity_policy_demo_activity.xml
@@ -0,0 +1,37 @@
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="wrap_content"
+    android:layout_height="match_parent"
+    android:layout_gravity="center"
+    android:gravity="center"
+    android:orientation="vertical"
+    android:padding="10dp">
+
+    <Button
+        android:id="@+id/start_opted_out_activity"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onStartOptedOutActivitySelected"
+        android:text="@string/start_opted_out_activity" />
+
+    <Button
+        android:id="@+id/start_activity"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onStartBlockedActivitySelected"
+        android:text="@string/start_blocked_activity" />
+
+    <Button
+        android:id="@+id/start_activity_for_result"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onStartBlockedActivityForResultSelected"
+        android:text="@string/start_blocked_activity_for_result" />
+
+    <Button
+        android:id="@+id/secure_window_demo"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onStartSecureWindowDemo"
+        android:text="@string/secure_window_demo" />
+
+</LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/display_power_demo_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/display_power_demo_activity.xml
new file mode 100644
index 000000000..e7ec66b25
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/res/layout/display_power_demo_activity.xml
@@ -0,0 +1,51 @@
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:gravity="center"
+    android:orientation="vertical"
+    android:padding="10dp">
+
+    <com.google.android.material.switchmaterial.SwitchMaterial
+        android:id="@+id/proximity_lock"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:checked="false"
+        android:text="Proximity Lock" />
+
+    <com.google.android.material.switchmaterial.SwitchMaterial
+        android:id="@+id/keep_screen_on"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:checked="false"
+        android:text="Keep Screen On" />
+
+    <com.google.android.material.switchmaterial.SwitchMaterial
+        android:id="@+id/override_screen_brightness"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:checked="false"
+        android:text="Override Screen Brightness" />
+
+    <com.google.android.material.slider.Slider
+        android:id="@+id/screen_brightness"
+        android:theme="@style/SliderTheme"
+        android:enabled="false"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:value="0.5"
+        android:valueFrom="0.0"
+        android:valueTo="1.0" />
+
+    <Button
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:onClick="onLaunchTurnScreenOnActivity"
+        android:text="Launch Turn Screen On Activity" />
+
+    <Button
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:onClick="onLaunchTurnScreenOnShowWhenLockedActivity"
+        android:text="Launch Turn Screen On Show When Locked Activity" />
+
+</LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
index 41b6fd8b8..df0701744 100644
--- a/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
+++ b/samples/VirtualDeviceManager/demos/res/layout/main_activity.xml
@@ -6,6 +6,13 @@
     android:orientation="vertical"
     android:padding="10dp">
 
+    <Button
+        android:id="@+id/activity_policy_demo"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onDemoSelected"
+        android:text="@string/activity_policy_demo" />
+
     <Button
         android:id="@+id/sensor_demo"
         android:layout_width="match_parent"
@@ -13,6 +20,13 @@
         android:onClick="onDemoSelected"
         android:text="@string/sensor_demo" />
 
+    <Button
+        android:id="@+id/display_power_demo"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onDemoSelected"
+        android:text="@string/display_power_demo" />
+
     <Button
         android:id="@+id/vibration_demo"
         android:layout_width="match_parent"
@@ -34,13 +48,6 @@
         android:onClick="onDemoSelected"
         android:text="@string/home_demo" />
 
-    <Button
-        android:id="@+id/secure_window_demo"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:onClick="onDemoSelected"
-        android:text="@string/secure_window_demo" />
-
     <Button
         android:id="@+id/permissions_demo"
         android:layout_width="match_parent"
diff --git a/samples/VirtualDeviceManager/demos/res/layout/permissions_demo_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/permissions_demo_activity.xml
index 58a13a6d0..d3e4c8461 100644
--- a/samples/VirtualDeviceManager/demos/res/layout/permissions_demo_activity.xml
+++ b/samples/VirtualDeviceManager/demos/res/layout/permissions_demo_activity.xml
@@ -1,4 +1,5 @@
 <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/main_layout"
     android:layout_width="wrap_content"
     android:layout_height="match_parent"
     android:layout_gravity="center"
@@ -7,17 +8,24 @@
     android:padding="10dp">
 
     <Button
-        android:id="@+id/request_permissions"
+        android:id="@+id/request_device_aware_permissions"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
         android:onClick="onRequestPermissions"
-        android:text="@string/request_permissions" />
+        android:text="@string/request_device_aware_permissions" />
 
     <Button
-        android:id="@+id/revoke_permissions"
+        android:id="@+id/revoke_device_aware_permissions"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
         android:onClick="onRevokePermissions"
-        android:text="@string/revoke_permissions" />
+        android:text="@string/revoke_device_aware_permissions" />
+
+    <Button
+        android:id="@+id/request_non_device_aware_permissions"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:onClick="onRequestPermissions"
+        android:text="@string/request_non_device_aware_permissions" />
 
 </LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/layout/secure_window_demo_activity.xml b/samples/VirtualDeviceManager/demos/res/layout/text_demo_activity.xml
similarity index 85%
rename from samples/VirtualDeviceManager/demos/res/layout/secure_window_demo_activity.xml
rename to samples/VirtualDeviceManager/demos/res/layout/text_demo_activity.xml
index bf17bcde9..c2fb9b5ae 100644
--- a/samples/VirtualDeviceManager/demos/res/layout/secure_window_demo_activity.xml
+++ b/samples/VirtualDeviceManager/demos/res/layout/text_demo_activity.xml
@@ -7,10 +7,9 @@
     android:padding="10dp">
 
     <TextView
-        android:id="@+id/secure_text"
+        android:id="@+id/text"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
         android:padding="20dp"
-        android:text="@string/secure_text"
         android:textStyle="bold" />
 </LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/values/strings.xml b/samples/VirtualDeviceManager/demos/res/values/strings.xml
index a41903e43..adc209ae9 100644
--- a/samples/VirtualDeviceManager/demos/res/values/strings.xml
+++ b/samples/VirtualDeviceManager/demos/res/values/strings.xml
@@ -1,6 +1,8 @@
 <resources>
     <string name="app_name" translatable="false">VDM Demos</string>
+    <string name="activity_policy_demo" translatable="false">VDM Activity Policy Demo</string>
     <string name="sensor_demo" translatable="false">VDM Sensor Demo</string>
+    <string name="display_power_demo" translatable="false">VDM Display Power Demo</string>
     <string name="vibration_demo" translatable="false">VDM Vibration Demo</string>
     <string name="rotation_demo" translatable="false">VDM Rotation Demo</string>
     <string name="home_demo" translatable="false">VDM Home Demo</string>
@@ -9,6 +11,16 @@
     <string name="latency_demo" translatable="false">VDM Latency Demo</string>
     <string name="stylus_demo" translatable="false">VDM Stylus Demo</string>
 
+    <string name="start_opted_out_activity" translatable="false">Start opted out activity</string>
+    <string name="start_blocked_activity" translatable="false">Start blocked activity</string>
+    <string name="start_blocked_activity_for_result" translatable="false">Start blocked activity for result</string>
+    <string name="opted_out_activity" translatable="false">VDM Opted Out Activity</string>
+    <string name="blocked_activity" translatable="false">VDM Blocked Activity</string>
+    <string name="turn_screen_on_activity" translatable="false">VDM Turn Screen On Activity</string>
+    <string name="turn_screen_on_show_when_locked_activity" translatable="false">VDM Turn Screen On Show When Locked Activity</string>
+
+    <string name="display_category" translatable="false">com.example.android.vdmdemo.DISPLAY_CATEGORY</string>
+
     <string name="current_device" translatable="false">Device: %s</string>
     <string name="change_device" translatable="false">Change</string>
 
@@ -22,11 +34,17 @@
     <string name="calculator_new_task" translatable="false">Calculator in new task</string>
 
     <string name="secure_text" translatable="false">You shall only be able to read this on the host device screen</string>
+    <string name="opted_out_activity_text" translatable="false">This activity can not be launched on the virtual device because cas opted out via canDisplayOnRemoteDevices</string>
+    <string name="blocked_activity_text" translatable="false">This activity can not be launched on the virtual device because of the activity policy of the virtual device</string>
+    <string name="calculator_text" translatable="false">This \"calculator\" activity can only be shown on displays with the matching category</string>
+    <string name="turn_screen_on_activity_text" translatable="false">This activity should turn the screen on if the device is not locked</string>
+    <string name="turn_screen_on_show_when_locked_activity_text" translatable="false">This activity should turn the screen on even when the device is locked</string>
 
-    <string name="request_permissions" translatable="false">Request permissions</string>
-    <string name="revoke_permissions" translatable="false">Revoke permissions</string>
+    <string name="request_device_aware_permissions" translatable="false">Request device aware permissions</string>
+    <string name="revoke_device_aware_permissions" translatable="false">Revoke device aware permissions</string>
+    <string name="request_non_device_aware_permissions" translatable="false">Request non-device aware permissions</string>
 
     <string name="vibrate" translatable="false">Vibrate</string>
     <string name="perform_haptic_feedback" translatable="false">Perform haptic feedback</string>
     <string name="ringtone_vibration" translatable="false">Ringtone vibration</string>
-</resources>
+</resources>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/demos/res/values/styles.xml b/samples/VirtualDeviceManager/demos/res/values/styles.xml
index 11cb8607b..93478999c 100644
--- a/samples/VirtualDeviceManager/demos/res/values/styles.xml
+++ b/samples/VirtualDeviceManager/demos/res/values/styles.xml
@@ -1,4 +1,7 @@
 <resources>
     <style name="AppTheme" parent="@style/Theme.AppCompat.NoActionBar">
     </style>
-</resources>
\ No newline at end of file
+    <style name="SliderTheme" parent="@style/Theme.MaterialComponents.Light">
+        <item name="colorPrimary">?attr/colorSecondary</item>
+    </style>
+</resources>
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/ActivityPolicyDemoActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/ActivityPolicyDemoActivity.java
new file mode 100644
index 000000000..60e49eaa4
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/ActivityPolicyDemoActivity.java
@@ -0,0 +1,57 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.content.Intent;
+import android.os.Bundle;
+import android.view.View;
+
+import androidx.activity.result.ActivityResultLauncher;
+import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult;
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Demo activity for showcasing Virtual Devices with custom activity policy. */
+public final class ActivityPolicyDemoActivity extends AppCompatActivity {
+    private final ActivityResultLauncher<Intent> mActivityResultLauncher =
+            registerForActivityResult(new StartActivityForResult(), result -> {});
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.activity_policy_demo_activity);
+    }
+
+    /** Handle start opted out activity request. */
+    public void onStartOptedOutActivitySelected(View view) {
+        startActivity(new Intent(this, OptedOutActivity.class));
+    }
+
+    /** Handle start blocked activity request. */
+    public void onStartBlockedActivitySelected(View view) {
+        startActivity(new Intent(this, BlockedActivity.class));
+    }
+
+    /** Handle start blocked activity for result request. */
+    public void onStartBlockedActivityForResultSelected(View view) {
+        mActivityResultLauncher.launch(new Intent(this, BlockedActivity.class));
+    }
+
+    /** Handle start secure window activity. */
+    public void onStartSecureWindowDemo(View view) {
+        startActivity(new Intent(this, SecureWindowDemoActivity.class));
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/BlockedActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/BlockedActivity.java
new file mode 100644
index 000000000..e685da949
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/BlockedActivity.java
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.os.Bundle;
+import android.widget.TextView;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Activity that cannot be launched on the virtual device due to the device activity policy. */
+public final class BlockedActivity extends AppCompatActivity {
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text)).setText(R.string.blocked_activity_text);
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/CalculatorWithDisplayCategory.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/CalculatorWithDisplayCategory.java
new file mode 100644
index 000000000..22b2a2561
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/CalculatorWithDisplayCategory.java
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.os.Bundle;
+import android.widget.TextView;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Custom "calculator" activity for testing implicit intents and display categories. */
+public final class CalculatorWithDisplayCategory extends AppCompatActivity {
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text)).setText(R.string.calculator_text);
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/DisplayPowerDemoActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/DisplayPowerDemoActivity.java
new file mode 100644
index 000000000..8770c2bf6
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/DisplayPowerDemoActivity.java
@@ -0,0 +1,130 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.app.ActivityOptions;
+import android.app.AlertDialog;
+import android.content.Intent;
+import android.hardware.display.DisplayManager;
+import android.os.Bundle;
+import android.os.PowerManager;
+import android.view.Display;
+import android.view.View;
+import android.view.WindowManager;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+import com.google.android.material.slider.Slider;
+import com.google.android.material.switchmaterial.SwitchMaterial;
+
+import java.util.stream.Stream;
+
+/** Demo activity for display power and wake locks with VDM. */
+public final class DisplayPowerDemoActivity extends AppCompatActivity {
+
+    private PowerManager.WakeLock mProximityWakeLock;
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.display_power_demo_activity);
+
+        SwitchMaterial proximitySwitch = requireViewById(R.id.proximity_lock);
+        SwitchMaterial keepScreenOnSwitch = requireViewById(R.id.keep_screen_on);
+        SwitchMaterial overrideBrightnessSwitch = requireViewById(R.id.override_screen_brightness);
+        Slider brightnessSlider = requireViewById(R.id.screen_brightness);
+
+        PowerManager powerManager = getSystemService(PowerManager.class);
+        if (powerManager.isWakeLockLevelSupported(PowerManager.PROXIMITY_SCREEN_OFF_WAKE_LOCK)) {
+            mProximityWakeLock = powerManager.newWakeLock(
+                    PowerManager.PROXIMITY_SCREEN_OFF_WAKE_LOCK, "VdmDemo:proximityLock");
+            proximitySwitch.setEnabled(true);
+            proximitySwitch.setOnCheckedChangeListener((v, isChecked) -> {
+                if (isChecked && !mProximityWakeLock.isHeld()) {
+                    mProximityWakeLock.acquire();
+                } else if (!isChecked && mProximityWakeLock.isHeld()) {
+                    mProximityWakeLock.release();
+                }
+            });
+        } else {
+            proximitySwitch.setEnabled(false);
+        }
+
+        keepScreenOnSwitch.setOnCheckedChangeListener((v, isChecked) -> {
+            if (isChecked) {
+                getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
+            } else {
+                getWindow().clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
+            }
+        });
+
+        overrideBrightnessSwitch.setOnCheckedChangeListener((v, isChecked) -> {
+            brightnessSlider.setEnabled(isChecked);
+            float value = isChecked ? brightnessSlider.getValue() : -1f;
+            setScreenBrightness(value);
+        });
+        brightnessSlider.addOnChangeListener((slider, value, user) -> setScreenBrightness(value));
+    }
+
+    @Override
+    public void onDestroy() {
+        super.onDestroy();
+        if (mProximityWakeLock != null && mProximityWakeLock.isHeld()) {
+            mProximityWakeLock.release();
+        }
+    }
+
+    private void setScreenBrightness(float value) {
+        WindowManager.LayoutParams layout = getWindow().getAttributes();
+        layout.screenBrightness = value;
+        getWindow().setAttributes(layout);
+    }
+
+    /** Launches an activity with android:turnScreenOn */
+    public void onLaunchTurnScreenOnActivity(View v) {
+        chooseDisplayAndStartActivity(TurnScreenOnActivity.class);
+    }
+
+    /** Launches an activity with android:turnScreenOn and android:showWhenLocked */
+    public void onLaunchTurnScreenOnShowWhenLockedActivity(View v) {
+        chooseDisplayAndStartActivity(TurnScreenOnShowWhenLockedActivity.class);
+    }
+
+    private void chooseDisplayAndStartActivity(Class<?> cls) {
+        Intent intent = new Intent(this, cls);
+
+        DisplayManager displayManager = getSystemService(DisplayManager.class);
+        Display[] displays = displayManager.getDisplays();
+
+        if (displays.length == 1) {
+            startActivity(intent);
+            return;
+        }
+
+        AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(this);
+        alertDialogBuilder.setTitle("Choose display");
+        alertDialogBuilder.setItems(
+                Stream.of(displays).map(d -> d.getName()).toArray(String[]::new),
+                (dialog, i) -> {
+                    startActivity(
+                            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK),
+                            ActivityOptions.makeBasic().setLaunchDisplayId(
+                                    displays[i].getDisplayId()).toBundle());
+                });
+        alertDialogBuilder.show();
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/HomeDemoActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/HomeDemoActivity.java
index c04df6990..43f47cc96 100644
--- a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/HomeDemoActivity.java
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/HomeDemoActivity.java
@@ -18,16 +18,21 @@ package com.example.android.vdmdemo.demos;
 
 import android.app.ActivityOptions;
 import android.app.AlertDialog;
+import android.companion.virtual.VirtualDevice;
+import android.companion.virtual.VirtualDeviceManager;
 import android.content.Intent;
+import android.content.pm.ActivityInfo;
+import android.content.pm.PackageManager;
 import android.hardware.display.DisplayManager;
 import android.os.Bundle;
 import android.view.Display;
 import android.view.View;
 
 import androidx.appcompat.app.AppCompatActivity;
+import androidx.core.os.BuildCompat;
 
 /** Demo activity for showcasing Virtual Devices with home experience. */
-public final class HomeDemoActivity extends AppCompatActivity {
+public class HomeDemoActivity extends AppCompatActivity {
 
     private DisplayManager mDisplayManager;
 
@@ -73,15 +78,60 @@ public final class HomeDemoActivity extends AppCompatActivity {
         alertDialogBuilder.setItems(
                 displayNames,
                 (dialog, which) -> {
+                    int displayId = which == 0
+                            ? Display.INVALID_DISPLAY
+                            : displays[which - 1].getDisplayId();
                     Intent intent = new Intent(Intent.ACTION_MAIN);
                     intent.addCategory(category);
+                    String requiredDisplayCategory = getRequiredDisplayCategory(displayId);
+                    if (requiredDisplayCategory != null) {
+                        intent.addCategory(requiredDisplayCategory);
+                    }
                     intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                     ActivityOptions options = ActivityOptions.makeBasic();
-                    if (which > 0) {
-                        options.setLaunchDisplayId(displays[which - 1].getDisplayId());
+                    if (displayId != Display.INVALID_DISPLAY) {
+                        options.setLaunchDisplayId(displayId);
                     }
                     startActivity(intent, options.toBundle());
                 });
         alertDialogBuilder.show();
     }
+
+    private String getRequiredDisplayCategory(int displayId) {
+        if (displayId == Display.DEFAULT_DISPLAY || !BuildCompat.isAtLeastV()) {
+            return null;
+        }
+        if (displayId == Display.INVALID_DISPLAY) {
+            displayId = getDisplay().getDisplayId();
+        }
+        // Check if the desired display id belongs to the current virtual device (if any).
+        // If the current display has a category, assume all displays on that device have the same
+        // category (not true in the general case).
+        // There's no API to get the categories for a given display.
+        VirtualDeviceManager vdm = getSystemService(VirtualDeviceManager.class);
+        VirtualDevice virtualDevice = vdm.getVirtualDevice(getDeviceId());
+        if (virtualDevice == null) {
+            return null;
+        }
+        boolean sameDevice = false;
+        for (int deviceDisplayId : vdm.getVirtualDevice(getDeviceId()).getDisplayIds()) {
+            if (deviceDisplayId == displayId) {
+                sameDevice = true;
+                break;
+            }
+        }
+        if (!sameDevice) {
+            return null;
+        }
+
+        // We're running on a virtual device and the launch display belongs to the same device.
+        // Return the current requiredDisplayCategory.
+        try {
+            ActivityInfo ai = getPackageManager().getActivityInfo(
+                    getComponentName(), PackageManager.GET_ACTIVITIES);
+            return ai.requiredDisplayCategory;
+        } catch (PackageManager.NameNotFoundException e) {
+            return null;
+        }
+    }
 }
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
index 8d3da3885..3e9924770 100644
--- a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivity.java
@@ -34,11 +34,13 @@ public class MainActivity extends AppCompatActivity {
     /** Handles demo launch request. */
     public void onDemoSelected(View view) {
         switch (view.getId()) {
+            case R.id.activity_policy_demo -> startActivity(
+                    new Intent(this, ActivityPolicyDemoActivity.class));
             case R.id.home_demo -> startActivity(new Intent(this, HomeDemoActivity.class));
             case R.id.sensor_demo -> startActivity(new Intent(this, SensorDemoActivity.class));
+            case R.id.display_power_demo -> startActivity(
+                    new Intent(this, DisplayPowerDemoActivity.class));
             case R.id.rotation_demo -> startActivity(new Intent(this, RotationDemoActivity.class));
-            case R.id.secure_window_demo -> startActivity(
-                    new Intent(this, SecureWindowDemoActivity.class));
             case R.id.permissions_demo -> startActivity(
                     new Intent(this, PermissionsDemoActivity.class));
             case R.id.latency_demo -> startActivity(new Intent(this, LatencyDemoActivity.class));
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivityWithDisplayCategory.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivityWithDisplayCategory.java
new file mode 100644
index 000000000..5fe9e0ebd
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/MainActivityWithDisplayCategory.java
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+/** Demo activity for showcasing Virtual Devices with display categories. */
+public final class MainActivityWithDisplayCategory extends HomeDemoActivity {
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/OptedOutActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/OptedOutActivity.java
new file mode 100644
index 000000000..731ebb0e0
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/OptedOutActivity.java
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.os.Bundle;
+import android.widget.TextView;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Activity that cannot be launched on the virtual device because it has opted out. */
+public final class OptedOutActivity extends AppCompatActivity {
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text)).setText(R.string.opted_out_activity_text);
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/PermissionsDemoActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/PermissionsDemoActivity.java
index 94fe72750..238498be6 100644
--- a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/PermissionsDemoActivity.java
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/PermissionsDemoActivity.java
@@ -17,11 +17,14 @@
 package com.example.android.vdmdemo.demos;
 
 import android.Manifest;
+import android.content.pm.PackageManager;
 import android.os.Bundle;
 import android.view.View;
 
 import androidx.appcompat.app.AppCompatActivity;
 
+import com.google.android.material.snackbar.Snackbar;
+
 import java.util.Arrays;
 
 /** Demo activity for showcasing Virtual Devices with permission requests. */
@@ -29,33 +32,62 @@ public final class PermissionsDemoActivity extends AppCompatActivity {
 
     private static final int REQUEST_CODE_PERMISSIONS = 1001;
 
-    private static final String[] PERMISSIONS = {
-        Manifest.permission.READ_CONTACTS,
-        Manifest.permission.ACCESS_FINE_LOCATION,
-        Manifest.permission.BLUETOOTH_CONNECT,
-        Manifest.permission.READ_CALENDAR,
-        Manifest.permission.READ_SMS,
-        Manifest.permission.READ_EXTERNAL_STORAGE,
-        Manifest.permission.READ_MEDIA_AUDIO,
-        Manifest.permission.READ_MEDIA_IMAGES,
+    private static final String[] DEVICE_AWARE_PERMISSIONS = {
         Manifest.permission.RECORD_AUDIO,
         Manifest.permission.CAMERA,
-        Manifest.permission.BODY_SENSORS,
+    };
+
+    private View mLayout;
+
+    private static final String[] NON_DEVICE_AWARE_PERMISSIONS = {
+        Manifest.permission.READ_CONTACTS,
     };
 
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
         setContentView(R.layout.permissions_demo_activity);
+        mLayout = findViewById(R.id.main_layout);
+    }
+
+    @Override
+    public void onRequestPermissionsResult(
+            int requestCode, String[] permissions, int[] grantResults) {
+        if (requestCode == REQUEST_CODE_PERMISSIONS) {
+            String output = parseGrantResults(permissions, grantResults);
+            Snackbar.make(mLayout, output, Snackbar.LENGTH_SHORT).show();
+        } else {
+            super.onRequestPermissionsResult(requestCode, permissions, grantResults);
+        }
     }
 
     /** Handle permission request. */
     public void onRequestPermissions(View view) {
-        requestPermissions(PERMISSIONS, REQUEST_CODE_PERMISSIONS);
+        if (view.getId() == R.id.request_device_aware_permissions) {
+            requestPermissions(DEVICE_AWARE_PERMISSIONS, REQUEST_CODE_PERMISSIONS);
+        } else {
+            requestPermissions(NON_DEVICE_AWARE_PERMISSIONS, REQUEST_CODE_PERMISSIONS);
+        }
     }
 
     /** Handle permission revoke. */
     public void onRevokePermissions(View view) {
-        revokeSelfPermissionsOnKill(Arrays.asList(PERMISSIONS));
+        revokeSelfPermissionsOnKill(Arrays.asList(DEVICE_AWARE_PERMISSIONS));
+    }
+
+    private String parseGrantResults(String[] permissions, int[] grantResults) {
+        StringBuilder result = new StringBuilder();
+        for (int i = 0; i < permissions.length; i++) {
+            String permission = permissions[i];
+            int grantResult = grantResults[i];
+
+            if (grantResult == PackageManager.PERMISSION_GRANTED) {
+                result.append(permission).append(" is granted. ");
+            } else {
+                result.append(permission).append(" is denied. ");
+            }
+        }
+
+        return result.toString();
     }
 }
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/SecureWindowDemoActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/SecureWindowDemoActivity.java
index c821615aa..a8c755f9f 100644
--- a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/SecureWindowDemoActivity.java
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/SecureWindowDemoActivity.java
@@ -18,6 +18,7 @@ package com.example.android.vdmdemo.demos;
 
 import android.os.Bundle;
 import android.view.WindowManager;
+import android.widget.TextView;
 
 import androidx.appcompat.app.AppCompatActivity;
 
@@ -27,7 +28,8 @@ public final class SecureWindowDemoActivity extends AppCompatActivity {
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
-        setContentView(R.layout.secure_window_demo_activity);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text)).setText(R.string.secure_text);
         getWindow()
                 .setFlags(
                         WindowManager.LayoutParams.FLAG_SECURE,
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnActivity.java
new file mode 100644
index 000000000..eef8200a1
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnActivity.java
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.os.Bundle;
+import android.widget.TextView;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Activity that has android:turnScreenOn. */
+public final class TurnScreenOnActivity extends AppCompatActivity {
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text)).setText(R.string.turn_screen_on_activity_text);
+    }
+}
diff --git a/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnShowWhenLockedActivity.java b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnShowWhenLockedActivity.java
new file mode 100644
index 000000000..b08271aad
--- /dev/null
+++ b/samples/VirtualDeviceManager/demos/src/com/example/android/vdmdemo/demos/TurnScreenOnShowWhenLockedActivity.java
@@ -0,0 +1,34 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.demos;
+
+import android.os.Bundle;
+import android.widget.TextView;
+
+import androidx.appcompat.app.AppCompatActivity;
+
+/** Activity that has android:turnScreenOn and android:showWhenLocked. */
+public final class TurnScreenOnShowWhenLockedActivity extends AppCompatActivity {
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.text_demo_activity);
+        ((TextView) requireViewById(R.id.text))
+                .setText(R.string.turn_screen_on_show_when_locked_activity_text);
+    }
+}
diff --git a/samples/VirtualDeviceManager/host/AndroidManifest.xml b/samples/VirtualDeviceManager/host/AndroidManifest.xml
index 2c8c8ca4c..3da57d216 100644
--- a/samples/VirtualDeviceManager/host/AndroidManifest.xml
+++ b/samples/VirtualDeviceManager/host/AndroidManifest.xml
@@ -36,6 +36,9 @@
     <uses-permission
         android:name="android.permission.ADD_TRUSTED_DISPLAY"
         tools:ignore="ProtectedPermissions" />
+    <uses-permission
+        android:name="android.permission.SUBSCRIBE_TO_KEYGUARD_LOCKED_STATE"
+        tools:ignore="ProtectedPermissions" />
 
     <queries>
         <intent>
@@ -73,7 +76,19 @@
             android:exported="true"
             android:launchMode="singleTop"
             android:theme="@style/AppTheme.FullScreen" />
-
+        <activity
+            android:name=".CustomLauncherActivityWithRequiredDisplayCategory"
+            android:requiredDisplayCategory="@string/display_category"
+            android:exported="true"
+            android:launchMode="singleTop"
+            android:theme="@style/AppTheme.FullScreen" />
+        <activity
+            android:name=".UnlockKeyguardDialog"
+            android:exported="false"
+            android:excludeFromRecents="true"
+            android:launchMode="singleInstance"
+            android:label="@string/unlock_dialog_title"
+            android:theme="@style/Theme.AppCompat.Dialog.Alert" />
         <service
             android:name=".VdmService"
             android:exported="false"
diff --git a/samples/VirtualDeviceManager/host/res/layout/fragment_input_navigation.xml b/samples/VirtualDeviceManager/host/res/layout/fragment_input_navigation.xml
index 2040e46a4..614a498e5 100644
--- a/samples/VirtualDeviceManager/host/res/layout/fragment_input_navigation.xml
+++ b/samples/VirtualDeviceManager/host/res/layout/fragment_input_navigation.xml
@@ -18,4 +18,11 @@
         android:layout_height="match_parent"
         android:layout_weight="1" />
 
+    <androidx.fragment.app.FragmentContainerView
+        android:id="@+id/rotary_fragment_container"
+        android:name="com.example.android.vdmdemo.common.RotaryFragment"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:layout_weight="1" />
+
 </LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/host/res/layout/status_bar.xml b/samples/VirtualDeviceManager/host/res/layout/status_bar.xml
new file mode 100644
index 000000000..2065ae114
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/res/layout/status_bar.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="utf-8"?>
+<com.example.android.vdmdemo.host.StatusBar xmlns:android="http://schemas.android.com/apk/res/android"
+    android:theme="@style/SysUiTheme"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:orientation="horizontal"
+    android:gravity="center">
+
+    <TextView
+        android:id="@+id/clock"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:textSize="24sp"/>
+
+</com.example.android.vdmdemo.host.StatusBar>
diff --git a/samples/VirtualDeviceManager/host/res/layout/unlock_keyguard_dialog.xml b/samples/VirtualDeviceManager/host/res/layout/unlock_keyguard_dialog.xml
new file mode 100644
index 000000000..528e111a2
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/res/layout/unlock_keyguard_dialog.xml
@@ -0,0 +1,21 @@
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:gravity="center"
+    android:orientation="vertical">
+
+    <TextView
+        android:id="@+id/message_view"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:padding="20dp"
+        android:gravity="center" />
+
+    <Button
+        android:text="Cancel"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:layout_gravity="end"
+        android:onClick="onCanceled" />
+
+</LinearLayout>
diff --git a/samples/VirtualDeviceManager/host/res/values/colors.xml b/samples/VirtualDeviceManager/host/res/values/colors.xml
new file mode 100644
index 000000000..d7ec9aa5b
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/res/values/colors.xml
@@ -0,0 +1,5 @@
+<resources>
+    <color name="cyan">#00ffff</color>
+    <color name="magenta">#ff00ff</color>
+    <color name="yellow">#ffff00</color>
+</resources>
diff --git a/samples/VirtualDeviceManager/host/res/values/dimens.xml b/samples/VirtualDeviceManager/host/res/values/dimens.xml
new file mode 100644
index 000000000..c6345b027
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/res/values/dimens.xml
@@ -0,0 +1,3 @@
+<resources>
+    <dimen name="status_bar_height">42dp</dimen>
+</resources>
diff --git a/samples/VirtualDeviceManager/host/res/values/strings.xml b/samples/VirtualDeviceManager/host/res/values/strings.xml
index f26eea0ea..0ec16347f 100644
--- a/samples/VirtualDeviceManager/host/res/values/strings.xml
+++ b/samples/VirtualDeviceManager/host/res/values/strings.xml
@@ -33,16 +33,26 @@
     <string name="button_forward" translatable="false">Forward</string>
     <string name="button_home" translatable="false">Home</string>
 
+    <string name="custom_activity_launch_blocked_message" translatable="false">Can\'t show %s here, try on your %s</string>
+    <string name="custom_activity_launch_fallback_message" translatable="false">Launched %s on your %s</string>
+    <string name="unlock_dialog_title" translatable="false">Device locked</string>
+    <string name="unlock_dialog_message" translatable="false">Unlock your %s to continue.</string>
+
+    <string name="display_category" translatable="false">com.example.android.vdmdemo.DISPLAY_CATEGORY</string>
+
     <string name="pref_device_profile" translatable="false">device_profile</string>
     <string name="pref_hide_from_recents" translatable="false">hide_from_recents</string>
     <string name="pref_enable_cross_device_clipboard" translatable="false">enable_cross_device_clipboard</string>
+    <string name="pref_enable_custom_activity_policy" translatable="false">enable_custom_activity_policy</string>
     <string name="pref_enable_client_camera" translatable="false">enable_client_camera</string>
     <string name="pref_enable_client_sensors" translatable="false">enable_client_sensors</string>
     <string name="pref_enable_client_audio" translatable="false">enable_client_audio</string>
     <string name="pref_enable_display_rotation" translatable="false">enable_display_rotation</string>
+    <string name="pref_enable_display_category" translatable="false">enable_display_category</string>
     <string name="pref_always_unlocked_device" translatable="false">always_unlocked_device</string>
     <string name="pref_show_pointer_icon" translatable="false">show_pointer_icon</string>
     <string name="pref_enable_custom_home" translatable="false">enable_custom_home</string>
+    <string name="pref_enable_custom_status_bar" translatable="false">enable_custom_status_bar</string>
     <string name="pref_display_ime_policy" translatable="false">display_ime_policy</string>
     <string name="pref_enable_client_native_ime" translatable="false">enable_client_native_ime</string>
     <string name="pref_record_encoder_output" translatable="false">record_encoder_output</string>
@@ -50,6 +60,8 @@
     <string name="internal_pref_home_displays_supported" translatable="false">home_displays_supported</string>
     <string name="internal_pref_mirror_displays_supported" translatable="false">mirror_displays_supported</string>
     <string name="internal_pref_virtual_stylus_supported" translatable="false">virtual_stylus_supported</string>
+    <string name="internal_pref_virtual_rotary_supported" translatable="false">virtual_rotary_supported</string>
+    <string name="internal_pref_display_rotation_supported" translatable="false">display_rotation_supported</string>
 
     <string name="app_streaming" translatable="false">android.app.role.COMPANION_DEVICE_APP_STREAMING</string>
     <string name="nearby_device_streaming" translatable="false">android.app.role.COMPANION_DEVICE_NEARBY_DEVICE_STREAMING</string>
diff --git a/samples/VirtualDeviceManager/host/res/values/styles.xml b/samples/VirtualDeviceManager/host/res/values/styles.xml
index 43de6d1a0..facc7f46f 100644
--- a/samples/VirtualDeviceManager/host/res/values/styles.xml
+++ b/samples/VirtualDeviceManager/host/res/values/styles.xml
@@ -10,9 +10,12 @@
     <style name="AppTheme.FullScreen">
         <item name="android:windowNoTitle">true</item>
         <item name="android:windowActionBar">false</item>
-        <item name="android:windowFullscreen">true</item>
         <item name="android:windowIsTranslucent">true</item>
         <item name="android:windowBackground">@android:color/transparent</item>
         <item name="android:windowShowWallpaper">true</item>
     </style>
+    <style name="SysUiTheme" parent="@style/Theme.AppCompat.Light.NoActionBar">
+        <item name="android:textColor">@color/magenta</item>
+        <item name="android:background">@color/cyan</item>
+    </style>
 </resources>
diff --git a/samples/VirtualDeviceManager/host/res/xml/preferences.xml b/samples/VirtualDeviceManager/host/res/xml/preferences.xml
index 1462e92c2..16945c3f8 100644
--- a/samples/VirtualDeviceManager/host/res/xml/preferences.xml
+++ b/samples/VirtualDeviceManager/host/res/xml/preferences.xml
@@ -18,13 +18,19 @@
         <SwitchPreferenceCompat
             android:key="@string/pref_hide_from_recents"
             android:title="Hide streamed app from recents"
-            android:defaultValue="false"
+            android:defaultValue="true"
             app:iconSpaceReserved="false"/>
         <SwitchPreferenceCompat
             android:key="@string/pref_enable_cross_device_clipboard"
             android:title="Enable cross-device clipboard"
             android:defaultValue="false"
             app:iconSpaceReserved="false"/>
+        <SwitchPreferenceCompat
+            android:key="@string/pref_enable_custom_activity_policy"
+            android:title="Enable custom activity policy"
+            android:summary="Show a custom notification when an activity could not be launched and try to send it to the default display"
+            android:defaultValue="false"
+            app:iconSpaceReserved="false"/>
     </PreferenceCategory>
 
     <PreferenceCategory
@@ -58,11 +64,17 @@
             android:summary="Rotate the remote display instead of letterboxing or pillarboxing"
             android:defaultValue="true"
             app:iconSpaceReserved="false" />
+        <SwitchPreferenceCompat
+            android:key="@string/pref_enable_display_category"
+            android:title="Enable display category"
+            android:summary="Set a category for the remote display to restrict activity launches"
+            android:defaultValue="true"
+            app:iconSpaceReserved="false" />
         <SwitchPreferenceCompat
             android:key="@string/pref_always_unlocked_device"
             android:title="Always unlocked"
             android:summary="Remote displays remain unlocked even when the host is locked"
-            android:defaultValue="false"
+            android:defaultValue="true"
             app:iconSpaceReserved="false" />
         <SwitchPreferenceCompat
             android:key="@string/pref_show_pointer_icon"
@@ -76,6 +88,12 @@
             android:summary="Use a custom home activity instead of the default one on home displays"
             android:defaultValue="false"
             app:iconSpaceReserved="false" />
+        <SwitchPreferenceCompat
+            android:key="@string/pref_enable_custom_status_bar"
+            android:title="Custom status bar"
+            android:summary="Show a custom status bar on the remote displays."
+            android:defaultValue="false"
+            app:iconSpaceReserved="false" />
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivity.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivity.java
index b7f903034..9b32785ce 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivity.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivity.java
@@ -22,30 +22,25 @@ import android.os.Bundle;
 import android.widget.GridView;
 
 import androidx.appcompat.app.AppCompatActivity;
-import androidx.core.view.WindowCompat;
-import androidx.core.view.WindowInsetsCompat;
-import androidx.core.view.WindowInsetsControllerCompat;
 
 import dagger.hilt.android.AndroidEntryPoint;
 
+import javax.inject.Inject;
+
 /** Simple activity that can act as a home/launcher on a virtual device. */
 @AndroidEntryPoint(AppCompatActivity.class)
 public class CustomLauncherActivity extends Hilt_CustomLauncherActivity {
 
+    @Inject PreferenceController mPreferenceController;
+
     @Override
     public void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
         setContentView(R.layout.custom_launcher);
 
-        WindowInsetsControllerCompat windowInsetsController =
-                WindowCompat.getInsetsController(getWindow(), getWindow().getDecorView());
-        windowInsetsController.setSystemBarsBehavior(
-                WindowInsetsControllerCompat.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE);
-        windowInsetsController.hide(WindowInsetsCompat.Type.systemBars());
-
         GridView launcher = requireViewById(R.id.app_grid);
-        LauncherAdapter launcherAdapter =
-                new LauncherAdapter(getPackageManager(), WallpaperManager.getInstance(this));
+        LauncherAdapter launcherAdapter = new LauncherAdapter(
+                this, mPreferenceController, WallpaperManager.getInstance(this));
         launcher.setAdapter(launcherAdapter);
         launcher.setOnItemClickListener(
                 (parent, v, position, id) -> {
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivityWithRequiredDisplayCategory.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivityWithRequiredDisplayCategory.java
new file mode 100644
index 000000000..ac90f973d
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/CustomLauncherActivityWithRequiredDisplayCategory.java
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.example.android.vdmdemo.host;
+
+import dagger.hilt.android.AndroidEntryPoint;
+
+/** Same as CustomLauncherActivity but with a display category. */
+@AndroidEntryPoint(CustomLauncherActivity.class)
+public class CustomLauncherActivityWithRequiredDisplayCategory
+        extends Hilt_CustomLauncherActivityWithRequiredDisplayCategory {
+}
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/InputActivity.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/InputActivity.java
index c78dd0de7..6cb1f12ad 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/InputActivity.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/InputActivity.java
@@ -30,6 +30,7 @@ import androidx.preference.PreferenceManager;
 import com.example.android.vdmdemo.common.DpadFragment;
 import com.example.android.vdmdemo.common.NavTouchpadFragment;
 import com.example.android.vdmdemo.common.RemoteEventProto.InputDeviceType;
+import com.example.android.vdmdemo.common.RotaryFragment;
 import com.google.android.material.bottomnavigation.BottomNavigationView;
 
 import dagger.hilt.android.AndroidEntryPoint;
@@ -158,6 +159,7 @@ public class InputActivity extends Hilt_InputActivity {
     public static final class NavigationFragment extends Hilt_InputActivity_NavigationFragment {
 
         @Inject InputController mInputController;
+        @Inject PreferenceController mPreferenceController;
 
         public NavigationFragment() {
             super(R.layout.fragment_input_navigation);
@@ -177,6 +179,16 @@ public class InputActivity extends Hilt_InputActivity {
             navTouchpadFragment.setInputEventListener((event) ->
                     mInputController.sendEventToFocusedDisplay(
                             InputDeviceType.DEVICE_TYPE_NAVIGATION_TOUCHPAD, event));
+            RotaryFragment rotaryFragment =
+                    (RotaryFragment) getChildFragmentManager().findFragmentById(
+                            R.id.rotary_fragment_container);
+            if (mPreferenceController.getBoolean(R.string.internal_pref_virtual_rotary_supported)) {
+                rotaryFragment.setInputEventListener((event) ->
+                        mInputController.sendEventToFocusedDisplay(
+                                InputDeviceType.DEVICE_TYPE_ROTARY_ENCODER, event));
+            } else {
+                getChildFragmentManager().beginTransaction().remove(rotaryFragment).commit();
+            }
         }
     }
 }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/LauncherAdapter.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/LauncherAdapter.java
index 3b159d991..331841baa 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/LauncherAdapter.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/LauncherAdapter.java
@@ -19,6 +19,7 @@ package com.example.android.vdmdemo.host;
 import android.app.WallpaperColors;
 import android.app.WallpaperManager;
 import android.content.ComponentName;
+import android.content.Context;
 import android.content.Intent;
 import android.content.pm.PackageManager;
 import android.content.pm.PackageManager.ResolveInfoFlags;
@@ -36,19 +37,26 @@ import android.widget.TextView;
 
 import java.util.ArrayList;
 import java.util.List;
+import java.util.Objects;
 
 final class LauncherAdapter extends BaseAdapter {
 
+    private static final Intent LAUNCHER_INTENT =
+            new Intent(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_LAUNCHER);
+
     private final List<ResolveInfo> mAvailableApps = new ArrayList<>();
-    private final PackageManager mPackageManager;
+    private final Context mContext;
+    private final PreferenceController mPreferenceController;
     private int mTextColor = Color.BLACK;
 
-    LauncherAdapter(PackageManager packageManager) {
-        this(packageManager, null);
+    LauncherAdapter(Context context, PreferenceController preferenceController) {
+        this(context, preferenceController, null);
     }
 
-    LauncherAdapter(PackageManager packageManager, WallpaperManager wallpaperManager) {
-        mPackageManager = packageManager;
+    LauncherAdapter(Context context, PreferenceController preferenceController,
+            WallpaperManager wallpaperManager) {
+        mContext = context;
+        mPreferenceController = preferenceController;
 
         if (wallpaperManager != null) {
             WallpaperColors wallpaperColors =
@@ -58,10 +66,34 @@ final class LauncherAdapter extends BaseAdapter {
             }
         }
 
-        mAvailableApps.addAll(
-                packageManager.queryIntentActivities(
-                        new Intent(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_LAUNCHER),
-                        ResolveInfoFlags.of(PackageManager.MATCH_ALL)));
+        buildAppList();
+    }
+
+    public void update() {
+        buildAppList();
+        notifyDataSetChanged();
+    }
+
+    void buildAppList() {
+        String requiredDisplayCategory = null;
+        if (mPreferenceController.getBoolean(R.string.pref_enable_display_category)) {
+            requiredDisplayCategory = mContext.getString(R.string.display_category);
+        }
+
+        Intent launchIntent = new Intent(LAUNCHER_INTENT);
+        if (requiredDisplayCategory != null) {
+            launchIntent.addCategory(requiredDisplayCategory);
+        }
+
+        mAvailableApps.clear();
+        for (ResolveInfo resolveInfo : mContext.getPackageManager().queryIntentActivities(
+                launchIntent, ResolveInfoFlags.of(PackageManager.MATCH_ALL))) {
+            // Note: this filtering is not necessary after Android V.
+            if (resolveInfo.activityInfo != null && Objects.equals(
+                    resolveInfo.activityInfo.requiredDisplayCategory, requiredDisplayCategory)) {
+                mAvailableApps.add(resolveInfo);
+            }
+        }
     }
 
     @Override
@@ -82,7 +114,7 @@ final class LauncherAdapter extends BaseAdapter {
     @Override
     public View getView(int position, View convertView, ViewGroup parent) {
         final ResolveInfo ri = mAvailableApps.get(position);
-        final Drawable img = ri.loadIcon(mPackageManager);
+        final Drawable img = ri.loadIcon(mContext.getPackageManager());
         if (convertView == null) {
             convertView =
                     LayoutInflater.from(parent.getContext())
@@ -94,7 +126,7 @@ final class LauncherAdapter extends BaseAdapter {
         imageView.setImageDrawable(img);
 
         TextView textView = convertView.requireViewById(R.id.app_title);
-        textView.setText(ri.loadLabel(mPackageManager));
+        textView.setText(ri.loadLabel(mContext.getPackageManager()));
         textView.setTextColor(mTextColor);
         return convertView;
     }
@@ -107,15 +139,8 @@ final class LauncherAdapter extends BaseAdapter {
         if (ri == null) {
             return null;
         }
-        Intent intent = new Intent(Intent.ACTION_MAIN);
-        intent.addCategory(Intent.CATEGORY_LAUNCHER);
-        if (ri.activityInfo != null) {
-            intent.setComponent(
-                    new ComponentName(ri.activityInfo.packageName, ri.activityInfo.name));
-        } else {
-            intent.setComponent(new ComponentName(ri.serviceInfo.packageName, ri.serviceInfo.name));
-        }
-        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
-        return intent;
+        return new Intent(LAUNCHER_INTENT)
+                .setComponent(new ComponentName(ri.activityInfo.packageName, ri.activityInfo.name))
+                .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
     }
 }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
index cecd1fa07..4b13574f7 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/MainActivity.java
@@ -16,11 +16,13 @@
 
 package com.example.android.vdmdemo.host;
 
+import android.Manifest;
 import android.app.AlertDialog;
 import android.content.ComponentName;
 import android.content.Context;
 import android.content.Intent;
 import android.content.ServiceConnection;
+import android.content.pm.PackageManager;
 import android.os.Bundle;
 import android.os.IBinder;
 import android.util.Log;
@@ -31,8 +33,11 @@ import android.view.View;
 import android.widget.Button;
 import android.widget.GridView;
 
+import androidx.activity.result.ActivityResultLauncher;
+import androidx.activity.result.contract.ActivityResultContracts.RequestPermission;
 import androidx.appcompat.app.AppCompatActivity;
 import androidx.appcompat.widget.Toolbar;
+import androidx.core.content.ContextCompat;
 
 import dagger.hilt.android.AndroidEntryPoint;
 
@@ -49,6 +54,19 @@ public class MainActivity extends Hilt_MainActivity {
     private GridView mLauncher = null;
     private Button mHomeDisplayButton = null;
     private Button mMirrorDisplayButton = null;
+    private LauncherAdapter mLauncherAdapter = null;
+
+    private final ActivityResultLauncher<String> mRequestPermissionLauncher =
+            registerForActivityResult(new RequestPermission(), isGranted -> {
+                // no-op
+            });
+
+    private final ActivityResultLauncher<String> mVdmServicePermissionLauncher =
+            registerForActivityResult(new RequestPermission(), isGranted -> {
+                if (mVdmService == null) {
+                    attemptStartVdmService();
+                }
+            });
 
     private final ServiceConnection mServiceConnection =
             new ServiceConnection() {
@@ -89,13 +107,13 @@ public class MainActivity extends Hilt_MainActivity {
         mMirrorDisplayButton.setEnabled(
                 mPreferenceController.getBoolean(R.string.internal_pref_mirror_displays_supported));
 
+        mLauncherAdapter = new LauncherAdapter(this, mPreferenceController);
         mLauncher = requireViewById(R.id.app_grid);
         mLauncher.setVisibility(View.GONE);
-        LauncherAdapter launcherAdapter = new LauncherAdapter(getPackageManager());
-        mLauncher.setAdapter(launcherAdapter);
+        mLauncher.setAdapter(mLauncherAdapter);
         mLauncher.setOnItemClickListener(
                 (parent, v, position, id) -> {
-                    Intent intent = launcherAdapter.createPendingRemoteIntent(position);
+                    Intent intent = mLauncherAdapter.createPendingRemoteIntent(position);
                     if (intent == null || mVdmService == null) {
                         return;
                     }
@@ -103,7 +121,7 @@ public class MainActivity extends Hilt_MainActivity {
                 });
         mLauncher.setOnItemLongClickListener(
                 (parent, v, position, id) -> {
-                    Intent intent = launcherAdapter.createPendingRemoteIntent(position);
+                    Intent intent = mLauncherAdapter.createPendingRemoteIntent(position);
                     if (intent == null || mVdmService == null) {
                         return true;
                     }
@@ -137,10 +155,16 @@ public class MainActivity extends Hilt_MainActivity {
     @Override
     protected void onStart() {
         super.onStart();
-        Intent intent = new Intent(this, VdmService.class);
-        Log.i(TAG, "Starting Vdm Host service");
-        startForegroundService(intent);
-        bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE);
+        attemptStartVdmService();
+    }
+
+    @Override
+    protected void onResume() {
+        super.onResume();
+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO)
+                == PackageManager.PERMISSION_DENIED) {
+            mRequestPermissionLauncher.launch(Manifest.permission.RECORD_AUDIO);
+        }
     }
 
     @Override
@@ -152,11 +176,32 @@ public class MainActivity extends Hilt_MainActivity {
         unbindService(mServiceConnection);
     }
 
+    private void attemptStartVdmService() {
+        // Need NEARBY_WIFI_DEVICES for WifiAware
+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.NEARBY_WIFI_DEVICES)
+                == PackageManager.PERMISSION_DENIED) {
+            mVdmServicePermissionLauncher.launch(Manifest.permission.NEARBY_WIFI_DEVICES);
+            return;
+        }
+
+        // Need POST_NOTIFICATIONS for the foreground Service Notification
+        if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS)
+                == PackageManager.PERMISSION_DENIED) {
+            mVdmServicePermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS);
+            return;
+        }
+        Log.i(TAG, "Starting Vdm Host service");
+        Intent intent = new Intent(this, VdmService.class);
+        startForegroundService(intent);
+        bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE);
+    }
+
     private void updateLauncherVisibility(boolean virtualDeviceActive) {
         final int visibility = virtualDeviceActive ? View.VISIBLE : View.GONE;
         runOnUiThread(
                 () -> {
                     if (mLauncher != null) {
+                        mLauncherAdapter.update();
                         mLauncher.setVisibility(visibility);
                     }
                     if (mHomeDisplayButton != null) {
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
index b6652633c..d52766aff 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/PreferenceController.java
@@ -26,6 +26,7 @@ import android.companion.virtual.flags.Flags;
 import android.content.Context;
 import android.content.SharedPreferences;
 import android.util.ArrayMap;
+import android.util.Log;
 
 import androidx.annotation.StringRes;
 import androidx.core.os.BuildCompat;
@@ -53,6 +54,8 @@ import javax.inject.Singleton;
 @Singleton
 final class PreferenceController {
 
+    private static final String TAG = PreferenceController.class.getSimpleName();
+
     // LINT.IfChange
     private static final Set<PrefRule<?>> RULES = Set.of(
 
@@ -61,11 +64,17 @@ final class PreferenceController {
             new StringRule(R.string.pref_device_profile, UPSIDE_DOWN_CAKE)
                     .withDefaultValue(AssociationRequest.DEVICE_PROFILE_APP_STREAMING),
 
-            new BoolRule(R.string.pref_hide_from_recents, UPSIDE_DOWN_CAKE),
+            new BoolRule(R.string.pref_hide_from_recents, UPSIDE_DOWN_CAKE)
+                    .withDefaultValue(true),
 
             new BoolRule(R.string.pref_enable_cross_device_clipboard,
                     VANILLA_ICE_CREAM, Flags::crossDeviceClipboard),
 
+            new BoolRule(R.string.pref_enable_custom_activity_policy,
+                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    Flags::dynamicPolicy,
+                    android.companion.virtualdevice.flags.Flags::activityControlApi),
+
             new BoolRule(R.string.pref_enable_client_camera, VANILLA_ICE_CREAM,
                     Flags::virtualCamera),
 
@@ -73,16 +82,22 @@ final class PreferenceController {
 
             new BoolRule(R.string.pref_enable_client_audio, UPSIDE_DOWN_CAKE),
 
-            new BoolRule(R.string.pref_enable_display_rotation,
-                    VANILLA_ICE_CREAM, Flags::consistentDisplayFlags)
+            new BoolRule(R.string.pref_enable_display_rotation, VANILLA_ICE_CREAM)
                     .withDefaultValue(true),
 
-            new BoolRule(R.string.pref_always_unlocked_device, TIRAMISU),
+            new BoolRule(R.string.pref_enable_display_category, UPSIDE_DOWN_CAKE),
+
+            new BoolRule(R.string.pref_always_unlocked_device, TIRAMISU)
+                    .withDefaultValue(true),
 
             new BoolRule(R.string.pref_show_pointer_icon, TIRAMISU),
 
             new BoolRule(R.string.pref_enable_custom_home, VANILLA_ICE_CREAM, Flags::vdmCustomHome),
 
+            new BoolRule(R.string.pref_enable_custom_status_bar,
+                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    android.companion.virtualdevice.flags.Flags::statusBarAndInsets),
+
             new StringRule(R.string.pref_display_ime_policy, VANILLA_ICE_CREAM, Flags::vdmCustomIme)
                     .withDefaultValue(String.valueOf(0)),
 
@@ -91,18 +106,24 @@ final class PreferenceController {
 
             new BoolRule(R.string.pref_record_encoder_output, TIRAMISU),
 
-
             // Internal-only switches not exposed in the settings page.
             // All of these are booleans acting as switches, while the above ones may be any type.
 
             new InternalBoolRule(R.string.internal_pref_home_displays_supported, TIRAMISU),
 
             new InternalBoolRule(R.string.internal_pref_mirror_displays_supported,
-                    VANILLA_ICE_CREAM,
-                    Flags::consistentDisplayFlags, Flags::interactiveScreenMirror),
+                    VANILLA_ICE_CREAM),
 
             new InternalBoolRule(R.string.internal_pref_virtual_stylus_supported,
-                    VANILLA_ICE_CREAM, Flags::virtualStylus)
+                    VANILLA_ICE_CREAM, Flags::virtualStylus),
+
+            new InternalBoolRule(R.string.internal_pref_virtual_rotary_supported,
+                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    android.companion.virtualdevice.flags.Flags::virtualRotary),
+
+            new InternalBoolRule(R.string.internal_pref_display_rotation_supported,
+                    VANILLA_ICE_CREAM,  // TODO: update to post-V once available
+                    android.companion.virtualdevice.flags.Flags::virtualDisplayRotationApi)
     );
     // LINT.ThenChange(/samples/VirtualDeviceManager/README.md:host_options)
 
@@ -196,15 +217,17 @@ final class PreferenceController {
         }
 
         void evaluate(Context context, SharedPreferences prefs, SharedPreferences.Editor editor) {
-            if (!prefs.contains(context.getString(mKey)) || !isSatisfied()) {
+            String preferenceName = context.getString(mKey);
+            if (!prefs.contains(preferenceName) || !isSatisfied(preferenceName)) {
                 reset(context, editor);
             }
         }
 
         void evaluate(Context context, PreferenceManager preferenceManager)  {
-            Preference preference = preferenceManager.findPreference(context.getString(mKey));
+            String preferenceName = context.getString(mKey);
+            Preference preference = preferenceManager.findPreference(preferenceName);
             if (preference != null) {
-                boolean enabled = isSatisfied();
+                boolean enabled = isSatisfied(preferenceName);
                 if (preference.isEnabled() != enabled) {
                     preference.setEnabled(enabled);
                 }
@@ -213,9 +236,14 @@ final class PreferenceController {
 
         protected abstract void reset(Context context, SharedPreferences.Editor editor);
 
-        protected boolean isSatisfied() {
-            return isSdkVersionSatisfied()
-                    && Arrays.stream(mRequiredFlags).allMatch(BooleanSupplier::getAsBoolean);
+        protected boolean isSatisfied(String preferenceName) {
+            try {
+                return isSdkVersionSatisfied()
+                        && Arrays.stream(mRequiredFlags).allMatch(BooleanSupplier::getAsBoolean);
+            } catch (NoSuchMethodError e) {
+                Log.w(TAG, "Missing at least one required flag for feature: " + preferenceName, e);
+                return false;
+            }
         }
 
         private boolean isSdkVersionSatisfied() {
@@ -246,7 +274,8 @@ final class PreferenceController {
 
         @Override
         void evaluate(Context context, SharedPreferences prefs, SharedPreferences.Editor editor) {
-            editor.putBoolean(context.getString(mKey), isSatisfied());
+            String preferenceName = context.getString(mKey);
+            editor.putBoolean(preferenceName, isSatisfied(preferenceName));
         }
     }
 
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
index 96288b30b..d1e5fb0fa 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/RemoteDisplay.java
@@ -38,6 +38,9 @@ import android.hardware.input.VirtualMouseRelativeEvent;
 import android.hardware.input.VirtualMouseScrollEvent;
 import android.hardware.input.VirtualNavigationTouchpad;
 import android.hardware.input.VirtualNavigationTouchpadConfig;
+import android.hardware.input.VirtualRotaryEncoder;
+import android.hardware.input.VirtualRotaryEncoderConfig;
+import android.hardware.input.VirtualRotaryEncoderScrollEvent;
 import android.hardware.input.VirtualStylus;
 import android.hardware.input.VirtualStylusButtonEvent;
 import android.hardware.input.VirtualStylusConfig;
@@ -67,6 +70,8 @@ import com.example.android.vdmdemo.common.VideoManager;
 
 import java.lang.annotation.Retention;
 import java.lang.annotation.RetentionPolicy;
+import java.util.Collections;
+import java.util.Set;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.function.Consumer;
 
@@ -99,6 +104,7 @@ class RemoteDisplay implements AutoCloseable {
     private final VirtualDevice mVirtualDevice;
     private final @DisplayType int mDisplayType;
     private final AtomicBoolean mClosed = new AtomicBoolean(false);
+    private StatusBar mStatusBar;
     private int mRotation;
     private int mWidth;
     private int mHeight;
@@ -110,6 +116,7 @@ class RemoteDisplay implements AutoCloseable {
     private VirtualNavigationTouchpad mNavigationTouchpad;
     private VirtualKeyboard mKeyboard;
     private VirtualStylus mStylus;
+    private VirtualRotaryEncoder mRotary;
 
     @SuppressLint("WrongConstant")
     RemoteDisplay(
@@ -136,9 +143,17 @@ class RemoteDisplay implements AutoCloseable {
             flags &= ~DisplayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY;
         }
 
+        Set<String> displayCategories;
+        if (mPreferenceController.getBoolean(R.string.pref_enable_display_category)) {
+            displayCategories = Set.of(context.getString(R.string.display_category));
+        } else {
+            displayCategories = Collections.emptySet();
+        }
+
         VirtualDisplayConfig.Builder virtualDisplayBuilder =
                 new VirtualDisplayConfig.Builder(
                                 "VirtualDisplay" + mRemoteDisplayId, mWidth, mHeight, mDpi)
+                        .setDisplayCategories(displayCategories)
                         .setFlags(flags);
 
         if (mDisplayType == DISPLAY_TYPE_HOME) {
@@ -192,6 +207,20 @@ class RemoteDisplay implements AutoCloseable {
 
         mRotation = mVirtualDisplay.getDisplay().getRotation();
 
+        if (mPreferenceController.getBoolean(R.string.pref_enable_custom_status_bar)
+                && mDisplayType != DISPLAY_TYPE_MIRROR) {
+            // Custom status bar cannot be shown on mirror displays. Also, it needs to be recreated
+            // whenever the dimensions of the display change.
+            final Context displayContext =
+                    mContext.createDisplayContext(mVirtualDisplay.getDisplay());
+            mContext.getMainExecutor().execute(() -> {
+                if (mStatusBar != null) {
+                    mStatusBar.destroy(displayContext);
+                }
+                mStatusBar = StatusBar.create(displayContext);
+            });
+        }
+
         if (mTouchscreen != null) {
             mTouchscreen.close();
         }
@@ -258,6 +287,13 @@ class RemoteDisplay implements AutoCloseable {
             goHome();
         } else if (event.hasInputEvent()) {
             processInputEvent(event.getInputEvent());
+        } else if (event.hasDisplayRotation()) {
+            int rotation = mVirtualDisplay.getDisplay().getRotation();
+            // Change the rotation of the display. The rotation is a Surface rotation and has
+            // only 4 possible values.
+            rotation += 1;
+            rotation %= 4;
+            mVirtualDisplay.setRotation(rotation);
         } else if (event.hasStopStreaming() && event.getStopStreaming().getPause()) {
             if (mVideoManager != null) {
                 mVideoManager.stop();
@@ -300,6 +336,8 @@ class RemoteDisplay implements AutoCloseable {
             case DEVICE_TYPE_KEYBOARD:
                 mKeyboard.sendKeyEvent(remoteEventToVirtualKeyEvent(inputEvent));
                 break;
+            case DEVICE_TYPE_ROTARY_ENCODER:
+                processRotaryEvent(remoteEventToVirtualRotaryEncoderEvent(inputEvent));
             default:
                 Log.e(
                         TAG,
@@ -320,6 +358,9 @@ class RemoteDisplay implements AutoCloseable {
             case DEVICE_TYPE_KEYBOARD:
                 mKeyboard.sendKeyEvent(keyEventToVirtualKeyEvent((KeyEvent) event));
                 break;
+            case DEVICE_TYPE_ROTARY_ENCODER:
+                processRotaryEvent(motionEventToVirtualRotaryEncoderEvent((MotionEvent) event));
+                break;
             default:
                 Log.e(
                         TAG,
@@ -374,6 +415,17 @@ class RemoteDisplay implements AutoCloseable {
         }
     }
 
+    void processRotaryEvent(VirtualRotaryEncoderScrollEvent rotaryEvent) {
+        if (mRotary == null) {
+            mRotary = mVirtualDevice.createVirtualRotaryEncoder(
+                    new VirtualRotaryEncoderConfig.Builder()
+                            .setAssociatedDisplayId(getDisplayId())
+                            .setInputDeviceName("vdmdemo-rotary" + mRemoteDisplayId)
+                            .build());
+        }
+        mRotary.sendScrollEvent(rotaryEvent);
+    }
+
     private void processMouseEvent(RemoteInputEvent inputEvent) {
         if (!createMouseIfNeeded()) {
             return;
@@ -436,8 +488,8 @@ class RemoteDisplay implements AutoCloseable {
     private static int displayRotationToDegrees(int displayRotation) {
         return switch (displayRotation) {
             case Surface.ROTATION_90 -> -90;
-            case Surface.ROTATION_180 -> 180;
-            case Surface.ROTATION_270 -> 90;
+            case Surface.ROTATION_180 -> -180;
+            case Surface.ROTATION_270 -> -270;
             default -> 0;
         };
     }
@@ -484,6 +536,22 @@ class RemoteDisplay implements AutoCloseable {
                 .build();
     }
 
+    private static VirtualRotaryEncoderScrollEvent remoteEventToVirtualRotaryEncoderEvent(
+            RemoteInputEvent event) {
+        return new VirtualRotaryEncoderScrollEvent.Builder()
+                .setEventTimeNanos((long) (event.getTimestampMs() * 1e6))
+                .setScrollAmount(event.getMouseScrollEvent().getX())
+                .build();
+    }
+
+    private static VirtualRotaryEncoderScrollEvent motionEventToVirtualRotaryEncoderEvent(
+            MotionEvent motionEvent) {
+        return new VirtualRotaryEncoderScrollEvent.Builder()
+                .setEventTimeNanos((long) (motionEvent.getEventTime() * 1e6))
+                .setScrollAmount(motionEvent.getAxisValue(MotionEvent.AXIS_SCROLL))
+                .build();
+    }
+
     @Override
     public void close() {
         if (mClosed.getAndSet(true)) { // Prevent double closure.
@@ -498,6 +566,9 @@ class RemoteDisplay implements AutoCloseable {
         mDpad.close();
         mTouchscreen.close();
         mKeyboard.close();
+        if (mRotary != null) {
+            mRotary.close();
+        }
         if (mStylus != null) {
             mStylus.close();
         }
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/StatusBar.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/StatusBar.java
new file mode 100644
index 000000000..74cab66e3
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/StatusBar.java
@@ -0,0 +1,127 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.example.android.vdmdemo.host;
+
+import static android.view.WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS;
+
+import android.content.Context;
+import android.content.Intent;
+import android.graphics.Insets;
+import android.graphics.PixelFormat;
+import android.os.Binder;
+import android.os.Handler;
+import android.os.Looper;
+import android.util.AttributeSet;
+import android.view.Gravity;
+import android.view.LayoutInflater;
+import android.view.WindowInsets;
+import android.view.WindowManager;
+import android.widget.LinearLayout;
+import android.widget.TextView;
+
+import androidx.annotation.Nullable;
+
+import java.text.SimpleDateFormat;
+import java.util.Calendar;
+import java.util.List;
+import java.util.Locale;
+
+/** Custom status bar shown on remote displays. */
+public class StatusBar extends LinearLayout {
+
+    private final Handler mHandler = new Handler(Looper.getMainLooper());
+    private Runnable mClockUpdater;
+
+    public StatusBar(Context context) {
+        super(context);
+    }
+
+    public StatusBar(Context context, @Nullable AttributeSet attrs) {
+        super(context, attrs);
+    }
+
+    public StatusBar(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {
+        super(context, attrs, defStyleAttr);
+    }
+
+    public StatusBar(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
+        super(context, attrs, defStyleAttr, defStyleRes);
+    }
+
+    @Override
+    public void onAttachedToWindow() {
+        super.onAttachedToWindow();
+
+        TextView clock = requireViewById(R.id.clock);
+        SimpleDateFormat df = new SimpleDateFormat("EEE, MMM d, HH:mm:ss", Locale.US);
+
+        mClockUpdater = () -> {
+            try {
+                clock.post(() -> clock.setText(df.format(Calendar.getInstance().getTime())));
+            } finally {
+                mHandler.postDelayed(mClockUpdater, /* delayMillis= */1000);
+            }
+        };
+        mClockUpdater.run();
+
+        clock.setOnClickListener(v -> {
+            Intent intent = new Intent(Intent.ACTION_MAIN);
+            intent.addCategory(Intent.CATEGORY_APP_CALENDAR);
+            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+            getContext().startActivity(intent);
+        });
+    }
+
+    @Override
+    public void onDetachedFromWindow() {
+        super.onDetachedFromWindow();
+        mHandler.removeCallbacks(mClockUpdater);
+    }
+
+    void destroy(Context displayContext) {
+        WindowManager windowManager = displayContext.getSystemService(WindowManager.class);
+        windowManager.removeViewImmediate(this);
+    }
+
+    static StatusBar create(Context displayContext) {
+        final int statusBarHeight =
+                displayContext.getResources().getDimensionPixelSize(R.dimen.status_bar_height);
+
+        WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
+                WindowManager.LayoutParams.MATCH_PARENT,
+                statusBarHeight,
+                WindowManager.LayoutParams.TYPE_STATUS_BAR,
+                WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE
+                        | WindowManager.LayoutParams.FLAG_SPLIT_TOUCH
+                        | WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS,
+                PixelFormat.TRANSLUCENT);
+        lp.token = new Binder();
+        lp.gravity = Gravity.TOP;
+        lp.setFitInsetsTypes(0);
+        lp.setTitle("StatusBar");
+        lp.packageName = displayContext.getPackageName();
+        lp.layoutInDisplayCutoutMode = LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS;
+        lp.setInsetsParams(List.of(new WindowManager.InsetsParams(WindowInsets.Type.statusBars())
+                .setInsetsSize(Insets.of(0, statusBarHeight, 0, 0))));
+
+        LayoutInflater inflater = LayoutInflater.from(displayContext);
+        StatusBar statusBar = (StatusBar) inflater.inflate(R.layout.status_bar, null);
+
+        WindowManager windowManager = displayContext.getSystemService(WindowManager.class);
+        windowManager.addView(statusBar, lp);
+        return statusBar;
+    }
+}
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/UnlockKeyguardDialog.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/UnlockKeyguardDialog.java
new file mode 100644
index 000000000..adc9984ec
--- /dev/null
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/UnlockKeyguardDialog.java
@@ -0,0 +1,120 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.example.android.vdmdemo.host;
+
+import android.app.ActivityOptions;
+import android.app.KeyguardManager;
+import android.content.Context;
+import android.content.Intent;
+import android.content.IntentSender;
+import android.os.Build;
+import android.os.Bundle;
+import android.util.Log;
+import android.view.Display;
+import android.view.View;
+import android.widget.TextView;
+
+import androidx.annotation.NonNull;
+import androidx.appcompat.app.AppCompatActivity;
+
+import dagger.hilt.android.AndroidEntryPoint;
+
+/** A dialog prompting the user to unlock the default display for a fallback activity launch. */
+@AndroidEntryPoint(AppCompatActivity.class)
+public class UnlockKeyguardDialog extends Hilt_UnlockKeyguardDialog
+        implements KeyguardManager.KeyguardLockedStateListener {
+    private static final String TAG = "UnlockKeyguardDialog";
+
+    private IntentSender mTarget;
+    private KeyguardManager mKeyguardManager;
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        final Intent intent = getIntent();
+        mTarget = intent.getParcelableExtra(Intent.EXTRA_INTENT,
+                android.content.IntentSender.class);
+        if (mTarget == null) {
+            Log.wtf(TAG, "Invalid intent: " + intent);
+            finish();
+        }
+
+        mKeyguardManager = getSystemService(KeyguardManager.class);
+        if (mKeyguardManager == null) {
+            Log.wtf(TAG, "KeyguardManager not available");
+            finish();
+        }
+
+        setContentView(R.layout.unlock_keyguard_dialog);
+        ((TextView) requireViewById(R.id.message_view))
+                .setText(getString(R.string.unlock_dialog_message, Build.MODEL));
+
+        if (!mKeyguardManager.isKeyguardLocked()) {
+            onKeyguardLockedStateChanged(false);
+        } else {
+            mKeyguardManager.addKeyguardLockedStateListener(getMainExecutor(), this);
+        }
+
+        setFinishOnTouchOutside(true);
+    }
+
+    @Override
+    public void onNewIntent(@NonNull Intent intent) {
+        super.onNewIntent(intent);
+        setIntent(intent);
+    }
+
+    @Override
+    protected void onDestroy() {
+        mKeyguardManager.removeKeyguardLockedStateListener(this);
+        super.onDestroy();
+    }
+
+    @Override
+    public void onKeyguardLockedStateChanged(boolean isKeyguardLocked) {
+        if (isKeyguardLocked) return;
+
+        Bundle activityOptions =
+                ActivityOptions.makeBasic()
+                        .setPendingIntentBackgroundActivityStartMode(
+                                ActivityOptions.MODE_BACKGROUND_ACTIVITY_START_ALLOWED)
+                        .setLaunchDisplayId(Display.DEFAULT_DISPLAY)
+                        .toBundle();
+        try {
+            startIntentSender(mTarget, /* fillInIntent= */ null, /* flagsMask= */ 0,
+                    /* flagsValues= */ 0, /* extraFlags= */ 0, activityOptions);
+        } catch (IntentSender.SendIntentException e) {
+            Log.e(TAG, "Error while starting intent sender", e);
+        }
+        finish();
+    }
+
+    /** Called when the dialog has been canceled by the user. */
+    public void onCanceled(View view) {
+        finish();
+    }
+
+    /**
+     * Creates an intent that launches UnlockKeyguardDialog when an activity launch is blocked.
+     */
+    public static Intent createIntent(Context context, IntentSender target) {
+        return new Intent()
+                .setClass(context, UnlockKeyguardDialog.class)
+                .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
+                .putExtra(Intent.EXTRA_INTENT, target);
+    }
+}
diff --git a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
index 4934a9092..31411e3c6 100644
--- a/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
+++ b/samples/VirtualDeviceManager/host/src/com/example/android/vdmdemo/host/VdmService.java
@@ -20,12 +20,15 @@ import static android.companion.virtual.VirtualDeviceParams.DEVICE_POLICY_CUSTOM
 import static android.companion.virtual.VirtualDeviceParams.DEVICE_POLICY_DEFAULT;
 import static android.companion.virtual.VirtualDeviceParams.LOCK_STATE_ALWAYS_UNLOCKED;
 import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_AUDIO;
+import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_BLOCKED_ACTIVITY;
 import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_CAMERA;
 import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_CLIPBOARD;
 import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_RECENTS;
 import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_SENSORS;
 
 import android.annotation.SuppressLint;
+import android.app.ActivityOptions;
+import android.app.KeyguardManager;
 import android.app.Notification;
 import android.app.NotificationChannel;
 import android.app.NotificationManager;
@@ -39,6 +42,7 @@ import android.companion.virtual.VirtualDeviceManager;
 import android.companion.virtual.VirtualDeviceManager.ActivityListener;
 import android.companion.virtual.VirtualDeviceParams;
 import android.companion.virtual.sensor.VirtualSensorConfig;
+import android.companion.virtualdevice.flags.Flags;
 import android.content.ComponentName;
 import android.content.Intent;
 import android.content.IntentSender;
@@ -49,11 +53,17 @@ import android.graphics.drawable.Icon;
 import android.hardware.display.DisplayManager;
 import android.media.AudioManager;
 import android.os.Binder;
+import android.os.Build;
+import android.os.Handler;
 import android.os.IBinder;
+import android.os.Looper;
+import android.os.UserHandle;
 import android.util.Log;
 import android.view.Display;
+import android.widget.Toast;
 
 import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
 import androidx.core.os.BuildCompat;
 
 import com.example.android.vdmdemo.common.ConnectionManager;
@@ -130,6 +140,7 @@ public final class VdmService extends Hilt_VdmService {
     private Intent mPendingRemoteIntent = null;
     private @RemoteDisplay.DisplayType int mPendingDisplayType = RemoteDisplay.DISPLAY_TYPE_APP;
     private DisplayManager mDisplayManager;
+    private KeyguardManager mKeyguardManager;
     private VirtualDeviceManager mVirtualDeviceManager;
     private Consumer<Boolean> mLocalVirtualDeviceLifecycleListener;
 
@@ -159,6 +170,102 @@ public final class VdmService extends Hilt_VdmService {
                 }
             };
 
+    private final ActivityListener mActivityListener = new ActivityListener() {
+        @Override
+        public void onActivityLaunchBlocked(
+                int displayId, @NonNull ComponentName componentName, @NonNull UserHandle user,
+                @Nullable IntentSender intentSender) {
+            Log.w(TAG, "onActivityLaunchBlocked " + displayId + ": " + componentName);
+
+            if (!mPreferenceController.getBoolean(R.string.pref_enable_custom_activity_policy)) {
+                // The system dialog is shown on the virtual display.
+                return;
+            }
+
+            if (intentSender == null) {
+                showToast(displayId, componentName,
+                        R.string.custom_activity_launch_blocked_message);
+                return;
+            }
+
+            // When the keyguard is locked, show a dialog prompting the user to unlock it.
+            if (mKeyguardManager.isKeyguardLocked()) {
+                startActivity(
+                        UnlockKeyguardDialog.createIntent(VdmService.this, intentSender),
+                        ActivityOptions.makeBasic().setLaunchDisplayId(displayId).toBundle());
+                return;
+            }
+
+            // Try to launch the activity on the default display with NEW_TASK flag.
+            Intent fillInIntent = new Intent().addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+            ActivityOptions activityOptions = ActivityOptions.makeBasic()
+                    .setPendingIntentBackgroundActivityStartMode(
+                            ActivityOptions.MODE_BACKGROUND_ACTIVITY_START_ALLOWED)
+                    .setLaunchDisplayId(Display.DEFAULT_DISPLAY);
+            try {
+                startIntentSender(intentSender, fillInIntent, /* flagsMask= */ 0,
+                        /* flagsValues= */ 0, /* extraFlags= */ 0, activityOptions.toBundle());
+                showToast(displayId, componentName,
+                        R.string.custom_activity_launch_fallback_message);
+            } catch (IntentSender.SendIntentException e) {
+                Log.e(TAG, "Error while starting intent sender", e);
+                showToast(displayId, componentName,
+                        R.string.custom_activity_launch_blocked_message);
+            }
+        }
+
+        @Override
+        public void onTopActivityChanged(
+                int displayId, @NonNull ComponentName componentName) {
+            Log.w(TAG, "onTopActivityChanged " + displayId + ": " + componentName);
+            int remoteDisplayId = mDisplayRepository.getRemoteDisplayId(displayId);
+            if (remoteDisplayId == Display.INVALID_DISPLAY) {
+                return;
+            }
+            final CharSequence title = getTitle(componentName);
+            mRemoteIo.sendMessage(
+                    RemoteEvent.newBuilder()
+                            .setDisplayId(remoteDisplayId)
+                            .setDisplayChangeEvent(
+                                    DisplayChangeEvent.newBuilder().setTitle(title.toString()))
+                            .build());
+        }
+
+        @Override
+        public void onDisplayEmpty(int displayId) {
+            Log.i(TAG, "Display " + displayId + " is empty, removing");
+            mDisplayRepository.removeDisplay(displayId);
+        }
+
+        @Override
+        public void onSecureWindowShown(
+                int displayId, @NonNull ComponentName componentName, @NonNull UserHandle user) {
+            Log.i(TAG, "Secure window shown on display " + displayId + " by " + componentName);
+        }
+
+        private CharSequence getTitle(ComponentName componentName) {
+            CharSequence title;
+            try {
+                ActivityInfo activityInfo =
+                        getPackageManager().getActivityInfo(componentName, 0);
+                title = activityInfo.loadLabel(getPackageManager()).toString();
+            } catch (NameNotFoundException e) {
+                Log.w(TAG, "Failed to get activity label for " + componentName);
+                title = "";
+            }
+            return title;
+        }
+
+        private void showToast(int displayId, ComponentName componentName, int resId) {
+            final CharSequence title = getTitle(componentName);
+            final CharSequence text = getString(resId, title == null ? "this" : title, Build.MODEL);
+            new Handler(Looper.getMainLooper()).post(() -> Toast.makeText(
+                            createDisplayContext(mDisplayManager.getDisplay(displayId)),
+                            text, Toast.LENGTH_LONG)
+                    .show());
+        }
+    };
+
     public VdmService() {
     }
 
@@ -222,6 +329,7 @@ public final class VdmService extends Hilt_VdmService {
         mConnectionManager.addConnectionCallback(mConnectionCallback);
         mConnectionManager.startHostSession();
 
+        mKeyguardManager = getSystemService(KeyguardManager.class);
         mDisplayManager = getSystemService(DisplayManager.class);
         Objects.requireNonNull(mDisplayManager).registerDisplayListener(mDisplayListener, null);
 
@@ -388,8 +496,14 @@ public final class VdmService extends Hilt_VdmService {
         }
 
         if (mPreferenceController.getBoolean(R.string.pref_enable_custom_home)) {
-            virtualDeviceBuilder.setHomeComponent(
-                    new ComponentName(this, CustomLauncherActivity.class));
+            if (mPreferenceController.getBoolean(R.string.pref_enable_display_category)) {
+                virtualDeviceBuilder.setHomeComponent(
+                        new ComponentName(
+                                this, CustomLauncherActivityWithRequiredDisplayCategory.class));
+            } else {
+                virtualDeviceBuilder.setHomeComponent(
+                        new ComponentName(this, CustomLauncherActivity.class));
+            }
         }
 
         if (mPreferenceController.getBoolean(R.string.pref_hide_from_recents)) {
@@ -400,6 +514,11 @@ public final class VdmService extends Hilt_VdmService {
             virtualDeviceBuilder.setDevicePolicy(POLICY_TYPE_CLIPBOARD, DEVICE_POLICY_CUSTOM);
         }
 
+        if (mPreferenceController.getBoolean(R.string.pref_enable_custom_activity_policy)) {
+            virtualDeviceBuilder.setDevicePolicy(
+                    POLICY_TYPE_BLOCKED_ACTIVITY, DEVICE_POLICY_CUSTOM);
+        }
+
         if (mPreferenceController.getBoolean(R.string.pref_enable_client_native_ime)) {
             virtualDeviceBuilder.setInputMethodComponent(
                     new ComponentName(this, VdmProxyIme.class));
@@ -407,15 +526,18 @@ public final class VdmService extends Hilt_VdmService {
 
         if (mPreferenceController.getBoolean(R.string.pref_enable_client_sensors)) {
             for (SensorCapabilities sensor : mDeviceCapabilities.getSensorCapabilitiesList()) {
-                virtualDeviceBuilder.addVirtualSensorConfig(
-                        new VirtualSensorConfig.Builder(
-                                sensor.getType(), "Remote-" + sensor.getName())
-                                .setMinDelay(sensor.getMinDelayUs())
-                                .setMaxDelay(sensor.getMaxDelayUs())
-                                .setPower(sensor.getPower())
-                                .setResolution(sensor.getResolution())
-                                .setMaximumRange(sensor.getMaxRange())
-                                .build());
+                var builder = new VirtualSensorConfig.Builder(
+                        sensor.getType(), "Remote-" + sensor.getName())
+                        .setMinDelay(sensor.getMinDelayUs())
+                        .setMaxDelay(sensor.getMaxDelayUs())
+                        .setPower(sensor.getPower())
+                        .setResolution(sensor.getResolution())
+                        .setMaximumRange(sensor.getMaxRange());
+                if (Flags.deviceAwareDisplayPower()) {
+                    builder.setWakeUpSensor(sensor.getIsWakeUpSensor())
+                            .setReportingMode(sensor.getReportingMode());
+                }
+                virtualDeviceBuilder.addVirtualSensorConfig(builder.build());
             }
 
             if (mDeviceCapabilities.getSensorCapabilitiesCount() > 0) {
@@ -441,41 +563,13 @@ public final class VdmService extends Hilt_VdmService {
         mVirtualDevice.setShowPointerIcon(
                 mPreferenceController.getBoolean(R.string.pref_show_pointer_icon));
 
-        mVirtualDevice.addActivityListener(
-                MoreExecutors.directExecutor(),
-                new ActivityListener() {
-
-                    @Override
-                    public void onTopActivityChanged(
-                            int displayId, @NonNull ComponentName componentName) {
-                        Log.w(TAG, "onTopActivityChanged " + displayId + ": " + componentName);
-                        int remoteDisplayId = mDisplayRepository.getRemoteDisplayId(displayId);
-                        if (remoteDisplayId == Display.INVALID_DISPLAY) {
-                            return;
-                        }
-
-                        String title = "";
-                        try {
-                            ActivityInfo activityInfo =
-                                    getPackageManager().getActivityInfo(componentName, 0);
-                            title = activityInfo.loadLabel(getPackageManager()).toString();
-                        } catch (NameNotFoundException e) {
-                            Log.w(TAG, "Failed to get activity label for " + componentName);
-                        }
-                        mRemoteIo.sendMessage(
-                                RemoteEvent.newBuilder()
-                                        .setDisplayId(remoteDisplayId)
-                                        .setDisplayChangeEvent(
-                                                DisplayChangeEvent.newBuilder().setTitle(title))
-                                        .build());
-                    }
+        if (BuildCompat.isAtLeastV()) {
+            mVirtualDevice.addActivityPolicyExemption(new ComponentName(
+                    "com.example.android.vdmdemo.demos",
+                    "com.example.android.vdmdemo.demos.BlockedActivity"));
+        }
 
-                    @Override
-                    public void onDisplayEmpty(int displayId) {
-                        Log.i(TAG, "Display " + displayId + " is empty, removing");
-                        mDisplayRepository.removeDisplay(displayId);
-                    }
-                });
+        mVirtualDevice.addActivityListener(MoreExecutors.directExecutor(), mActivityListener);
         mVirtualDevice.addActivityListener(
                 MoreExecutors.directExecutor(),
                 new RunningVdmUidsTracker(getApplicationContext(), mPreferenceController,
@@ -528,7 +622,11 @@ public final class VdmService extends Hilt_VdmService {
         mPendingRemoteIntent = null;
         mPendingDisplayType = RemoteDisplay.DISPLAY_TYPE_HOME;
         mRemoteIo.sendMessage(RemoteEvent.newBuilder()
-                .setStartStreaming(StartStreaming.newBuilder().setHomeEnabled(true)).build());
+                .setStartStreaming(StartStreaming.newBuilder()
+                        .setHomeEnabled(true)
+                        .setRotationSupported(mPreferenceController.getBoolean(
+                                R.string.internal_pref_display_rotation_supported)))
+                .build());
     }
 
     void startMirroring() {
@@ -536,7 +634,10 @@ public final class VdmService extends Hilt_VdmService {
         mPendingDisplayType = RemoteDisplay.DISPLAY_TYPE_MIRROR;
         mRemoteIo.sendMessage(
                 RemoteEvent.newBuilder()
-                        .setStartStreaming(StartStreaming.newBuilder().setHomeEnabled(true))
+                        .setStartStreaming(StartStreaming.newBuilder()
+                                .setHomeEnabled(true)
+                                .setRotationSupported(mPreferenceController.getBoolean(
+                                        R.string.internal_pref_display_rotation_supported)))
                         .build());
     }
 
@@ -545,7 +646,11 @@ public final class VdmService extends Hilt_VdmService {
         mPendingRemoteIntent.addFlags(
                 Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NEW_TASK);
         mRemoteIo.sendMessage(
-                RemoteEvent.newBuilder().setStartStreaming(StartStreaming.newBuilder()).build());
+                RemoteEvent.newBuilder()
+                        .setStartStreaming(StartStreaming.newBuilder()
+                                .setRotationSupported(mPreferenceController.getBoolean(
+                                        R.string.internal_pref_display_rotation_supported)))
+                        .build());
     }
 
     void startIntentOnDisplayIndex(Intent intent, int displayIndex) {
@@ -579,6 +684,8 @@ public final class VdmService extends Hilt_VdmService {
                 b -> updateDevicePolicy(POLICY_TYPE_RECENTS, (Boolean) b));
         observers.put(R.string.pref_enable_cross_device_clipboard,
                 b -> updateDevicePolicy(POLICY_TYPE_CLIPBOARD, (Boolean) b));
+        observers.put(R.string.pref_enable_custom_activity_policy,
+                b -> updateDevicePolicy(POLICY_TYPE_BLOCKED_ACTIVITY, (Boolean) b));
         observers.put(R.string.pref_show_pointer_icon,
                 b -> {
                     if (mVirtualDevice != null) mVirtualDevice.setShowPointerIcon((Boolean) b);
@@ -598,6 +705,7 @@ public final class VdmService extends Hilt_VdmService {
         observers.put(R.string.pref_always_unlocked_device, v -> recreateVirtualDevice());
         observers.put(R.string.pref_enable_client_native_ime, v -> recreateVirtualDevice());
         observers.put(R.string.pref_enable_custom_home, v -> recreateVirtualDevice());
+        observers.put(R.string.pref_enable_display_category, v -> recreateVirtualDevice());
 
         return observers;
     }
diff --git a/samples/VirtualDeviceManager/setup.sh b/samples/VirtualDeviceManager/setup.sh
index 568a95a85..80967dfe8 100755
--- a/samples/VirtualDeviceManager/setup.sh
+++ b/samples/VirtualDeviceManager/setup.sh
@@ -52,8 +52,7 @@ function display_help() {
   echo ""
   echo "  -s, --host):         Setup the host application on the only device connected via ADB."
   echo "  -c, --client):       Setup the client application on the only device connected via ADB."
-  echo "  -cd, --camera_demo): Setup the virtual camera demo application (not installed by default)."
-  echo "  -a, --all):          Setup all available demo apps: host, client, demos and camera."
+  echo "  -a, --all):          Setup all available demo apps: host, client, and demos."
   echo "  -i, --install-only): Only install the selected application. Will not perform any build."
   echo "  -h, --help):         Print this help."
 }
@@ -113,16 +112,14 @@ fi
 
 INSTALL_HOST=true
 INSTALL_CLIENT=true
-INSTALL_VIRTUAL_CAMERA=false
 PERFORM_BUILD=true
 while [[ "$#" -gt 0 ]]; do
     case $1 in
         -h|--help) display_help; exit ;;
-        -a|--all) INSTALL_VIRTUAL_CAMERA=true; shift ;;
+        -a|--all) shift ;;
         -s|--host) INSTALL_CLIENT=false; shift ;;
         -c|--client) INSTALL_HOST=false; shift ;;
         -i|--install-only) PERFORM_BUILD=false; shift ;;
-        -cd|--camera_demo) INSTALL_VIRTUAL_CAMERA=true; INSTALL_HOST=false; INSTALL_CLIENT=false; shift;;
         *) echo "Unknown parameter passed: $1"; display_help; exit ;;
     esac
 done
@@ -134,10 +131,8 @@ DEVICE_SERIALS=( $(adb devices -l | tail -n +2 | head -n -1 | awk '{ print $1 }'
 DEVICE_NAMES=( $(adb devices -l | tail -n +2 | head -n -1 | awk '{ print $4 }') )
 HOST_SERIAL=""
 CLIENT_SERIAL=""
-CAMERA_DEMO_SERIAL=""
 CLIENT_INDEX=$DEVICE_COUNT
 HOST_INDEX=$DEVICE_COUNT
-CAMERA_DEMO_INDEX=$DEVICE_COUNT
 
 if [[ ${INSTALL_HOST} == true ]]; then
   if [[ ${DEVICE_COUNT} -eq 1 ]]; then
@@ -157,17 +152,6 @@ if [[ ${INSTALL_CLIENT} == true ]]; then
     CLIENT_INDEX=$?
   fi
 fi
-if [[ ${INSTALL_VIRTUAL_CAMERA} == true ]]; then
-  if [[ ${DEVICE_COUNT} -eq 1 ]]; then
-    CAMERA_DEMO_INDEX=0
-  elif ((HOST_INDEX == DEVICE_COUNT)); then
-    display_available_devices
-    select_device "Virtual Camera Demo"
-    CAMERA_DEMO_INDEX=$?
-  else
-    CAMERA_DEMO_INDEX=$HOST_INDEX
-  fi
-fi
 
 if ((HOST_INDEX == DEVICE_COUNT)); then
   echo "Not installing host app."
@@ -183,18 +167,10 @@ else
   CLIENT_NAME="${CLIENT_SERIAL} ${DEVICE_NAMES[CLIENT_INDEX]}"
   echo "Installing VDM Client app to ${CLIENT_NAME}."
 fi
-if ((CAMERA_DEMO_INDEX == DEVICE_COUNT)); then
-  echo "Not installing camera demo app."
-else
-  CAMERA_DEMO_SERIAL=${DEVICE_SERIALS[CAMERA_DEMO_INDEX]}
-  CAMERA_DEMO_NAME="${CAMERA_DEMO_SERIAL} ${DEVICE_NAMES[CAMERA_DEMO_INDEX]}"
-  echo "Installing camera demo app to ${CAMERA_DEMO_NAME}."
-fi
 
 APKS_TO_BUILD=""
 [[ -n "${HOST_SERIAL}" ]] && APKS_TO_BUILD="${APKS_TO_BUILD} VdmHost VdmDemos"
 [[ -n "${CLIENT_SERIAL}" ]] && APKS_TO_BUILD="${APKS_TO_BUILD} VdmClient"
-[[ -n "${CAMERA_DEMO_SERIAL}" ]] && APKS_TO_BUILD="${APKS_TO_BUILD} VirtualCameraDemo"
 [[ -n "${APKS_TO_BUILD}" ]] || exit 0
 
 if [[ ${PERFORM_BUILD} == true ]];
@@ -222,8 +198,8 @@ if [[ -n "${HOST_SERIAL}" ]]; then
   install_app "${HOST_SERIAL}" "${OUT}/system/app/VdmDemos/VdmDemos.apk" demos
   echo
 
-  readonly HOST_PERM_BASENAME=com.example.android.vdmdemo.host.xml
-  readonly HOST_PERM_SRC="${ANDROID_BUILD_TOP}/development/samples/VirtualDeviceManager/host/${HOST_PERM_BASENAME}"
+  readonly HOST_PERM_BASENAME=VdmHost.xml
+  readonly HOST_PERM_SRC="${OUT}/system/etc/permissions/${HOST_PERM_BASENAME}"
   readonly HOST_PERM_DST="/system/etc/permissions/${HOST_PERM_BASENAME}"
   readonly HOST_APK_DIR=/system/priv-app/VdmHost
 
@@ -241,27 +217,6 @@ if [[ -n "${HOST_SERIAL}" ]]; then
   fi
 fi
 
-if [[ -n "${CAMERA_DEMO_SERIAL}" ]]; then
-  echo
-  readonly CAMERA_PERM_BASENAME=com.example.android.vdmdemo.virtualcamera.xml
-  readonly CAMERA_PERM_SRC="${ANDROID_BUILD_TOP}/development/samples/VirtualDeviceManager/virtualcamera/${CAMERA_PERM_BASENAME}"
-  readonly CAMERA_PERM_DST="/system/etc/permissions/${CAMERA_PERM_BASENAME}"
-  readonly CAMERA_DEMO_APK_DIR=/system/priv-app/VirtualCameraDemo
-
-  echo "Preparing ${CAMERA_DEMO_NAME} for privileged VirtualCameraDemo installation..."
-  if adb -s "${CAMERA_DEMO_SERIAL}" shell ls "${CAMERA_DEMO_APK_DIR}/VirtualCameraDemo.apk" > /dev/null 2>&1 \
-      && adb -s "${CAMERA_DEMO_SERIAL}" pull "${CAMERA_PERM_DST}" "/tmp/${CAMERA_PERM_BASENAME}" > /dev/null 2>&1 \
-      && cmp --silent "/tmp/${CAMERA_PERM_BASENAME}" "${CAMERA_PERM_SRC}" \
-      && (adb -s "${CAMERA_DEMO_SERIAL}" uninstall com.example.android.vdmdemo.virtualcamera > /dev/null 2>&1 || true) \
-      && adb -s "${CAMERA_DEMO_SERIAL}" install -r -d -g "${OUT}/${CAMERA_DEMO_APK_DIR}/VirtualCameraDemo.apk" > /dev/null 2>&1; then
-    echo "A privileged installation already found, installed VirtualCameraDemo.apk to ${CAMERA_DEMO_NAME}"
-    echo
-  else
-    privileged_install "${CAMERA_DEMO_SERIAL}" "${CAMERA_DEMO_NAME}" "${CAMERA_DEMO_APK_DIR}" \
-                       "VirtualCameraDemo.apk" "${CAMERA_PERM_SRC}" "${CAMERA_PERM_DST}" virtualcamera
-  fi
-fi
-
 echo
 echo 'Success!'
 echo
diff --git a/samples/VirtualDeviceManager/virtualcamera/AndroidManifest.xml b/samples/VirtualDeviceManager/virtualcamera/AndroidManifest.xml
deleted file mode 100644
index 08a5b8ab0..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/AndroidManifest.xml
+++ /dev/null
@@ -1,52 +0,0 @@
-<manifest xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:tools="http://schemas.android.com/tools"
-    package="com.example.android.vdmdemo.virtualcamera"
-    android:versionCode="1"
-    android:versionName="1.0">
-
-    <uses-sdk
-        android:minSdkVersion="35"
-        android:targetSdkVersion="35" />
-
-    <uses-feature android:name="android.software.companion_device_setup" />
-
-    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
-    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
-    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
-
-    <uses-permission android:name="android.permission.CREATE_VIRTUAL_DEVICE" />
-    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
-
-    <uses-permission
-        android:name="android.permission.REQUEST_COMPANION_SELF_MANAGED"
-        tools:ignore="ProtectedPermissions" />
-    <uses-permission
-        android:name="android.permission.REQUEST_COMPANION_PROFILE_APP_STREAMING"
-        tools:ignore="ProtectedPermissions" />
-
-    <queries>
-        <intent>
-            <action android:name="android.intent.action.MAIN" />
-            <category android:name="android.intent.category.LAUNCHER" />
-        </intent>
-    </queries>
-
-    <application
-        android:name=".VirtualCameraDemoApplication"
-        android:label="@string/app_name"
-        android:theme="@style/AppTheme">
-        <activity
-            android:name=".MainActivity"
-            android:exported="true">
-            <intent-filter>
-                <action android:name="android.intent.action.MAIN" />
-                <category android:name="android.intent.category.LAUNCHER" />
-            </intent-filter>
-        </activity>
-
-        <service
-            android:name=".VirtualCameraDemoService"
-            android:exported="false"
-            android:foregroundServiceType="specialUse" />
-    </application>
-</manifest>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/drawable/close.xml b/samples/VirtualDeviceManager/virtualcamera/res/drawable/close.xml
deleted file mode 100644
index d5d2297ac..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/drawable/close.xml
+++ /dev/null
@@ -1,10 +0,0 @@
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="24dp"
-    android:height="24dp"
-    android:tint="?attr/colorControlNormal"
-    android:viewportWidth="24"
-    android:viewportHeight="24">
-    <path
-        android:fillColor="@android:color/white"
-        android:pathData="M19,6.41L17.59,5 12,10.59 6.41,5 5,6.41 10.59,12 5,17.59 6.41,19 12,13.41 17.59,19 19,17.59 13.41,12z" />
-</vector>
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/drawable/connected.xml b/samples/VirtualDeviceManager/virtualcamera/res/drawable/connected.xml
deleted file mode 100644
index 92485d26e..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/drawable/connected.xml
+++ /dev/null
@@ -1,10 +0,0 @@
-<vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="24dp"
-    android:height="24dp"
-    android:tint="?attr/colorControlNormal"
-    android:viewportWidth="960"
-    android:viewportHeight="960">
-    <path
-        android:fillColor="@android:color/white"
-        android:pathData="M720,640L575,640Q540,531 463.5,448Q387,365 281,320L720,320L720,640ZM80,800L80,680Q130,680 165,715Q200,750 200,800L80,800ZM280,800Q280,717 221.5,658.5Q163,600 80,600L80,520Q197,520 278.5,601.5Q360,683 360,800L280,800ZM440,800Q440,725 411.5,659.5Q383,594 334.5,545.5Q286,497 220.5,468.5Q155,440 80,440L80,360Q171,360 251,394.5Q331,429 391,489Q451,549 485.5,629Q520,709 520,800L440,800ZM800,800L600,800Q600,780 598.5,760Q597,740 594,720L800,720Q800,720 800,720Q800,720 800,720L800,240Q800,240 800,240Q800,240 800,240L160,240Q160,240 160,240Q160,240 160,240L160,286Q140,283 120,281.5Q100,280 80,280L80,240Q80,207 103.5,183.5Q127,160 160,160L800,160Q833,160 856.5,183.5Q880,207 880,240L880,720Q880,753 856.5,776.5Q833,800 800,800Z" />
-</vector>
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/layout/activity_main.xml b/samples/VirtualDeviceManager/virtualcamera/res/layout/activity_main.xml
deleted file mode 100644
index a0174f675..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/layout/activity_main.xml
+++ /dev/null
@@ -1,64 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:orientation="vertical"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent">
-    <TableLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content">
-        <TableRow
-            android:layout_width="match_parent"
-            android:layout_height="match_parent" >
-            <TextView
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:text="Display name" />
-            <EditText
-                android:id="@+id/camera_name_edit_text"
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:ems="10"
-                android:inputType="text"
-                android:text="Virtual Camera" />
-        </TableRow>
-        <TableRow
-            android:layout_width="match_parent"
-            android:layout_height="match_parent" >
-            <TextView
-                android:id="@+id/camera_input_type"
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:text="Virtual Camera input type" />
-            <RadioGroup
-                android:id="@+id/camera_type_radio_group"
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content" >
-                <RadioButton
-                    android:id="@+id/radio_canvas"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:text="Canvas" />
-                <RadioButton
-                    android:id="@+id/radio_video_file"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:text="MediaPlayer" />
-                <RadioButton
-                    android:id="@+id/radio_virtual_display"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:text="VirtualDisplay"
-                    android:enabled="false" />
-            </RadioGroup>
-        </TableRow>
-    </TableLayout>
-    <Button
-        android:id="@+id/create_camera_button"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:text="Create camera" />
-    <ListView
-        android:id="@+id/cameras_list_view"
-        android:layout_width="match_parent"
-        android:layout_height="match_parent" />
-</LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/layout/camera_item.xml b/samples/VirtualDeviceManager/virtualcamera/res/layout/camera_item.xml
deleted file mode 100644
index 1d2cf4006..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/layout/camera_item.xml
+++ /dev/null
@@ -1,30 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent">
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:layout_weight="1"
-        android:orientation="vertical">
-        <TextView
-            android:id="@+id/camera_display_name"
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:layout_weight="1"
-            android:text="TextView"
-            android:textAppearance="@android:style/TextAppearance.Material.Large" />
-        <TextView
-            android:id="@+id/camera_id"
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:layout_weight="1"
-            android:text="TextView" />
-    </LinearLayout>
-    <Button
-        android:id="@+id/remove_button"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        android:text="Remove" />
-</LinearLayout>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/raw/testvideo.mp4 b/samples/VirtualDeviceManager/virtualcamera/res/raw/testvideo.mp4
deleted file mode 100644
index a78b4f94b..000000000
Binary files a/samples/VirtualDeviceManager/virtualcamera/res/raw/testvideo.mp4 and /dev/null differ
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/values/strings.xml b/samples/VirtualDeviceManager/virtualcamera/res/values/strings.xml
deleted file mode 100644
index 1cded10b2..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/values/strings.xml
+++ /dev/null
@@ -1,6 +0,0 @@
-<resources>
-    <string name="app_name" translatable="false">Virtual Camera Demo</string>
-    <string name="create_camera" translatable="false">Create camera</string>
-    <string name="remove_camera" translatable="false">Remove camera</string>
-    <string name="camera_name" translatable="false">Virtual Camera</string>
-</resources>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/virtualcamera/res/values/styles.xml b/samples/VirtualDeviceManager/virtualcamera/res/values/styles.xml
deleted file mode 100644
index 6828a0b57..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/res/values/styles.xml
+++ /dev/null
@@ -1,5 +0,0 @@
-<resources>
-    <style name="AppTheme" parent="@style/Theme.AppCompat.Light.NoActionBar">
-        <item name="android:windowOptOutEdgeToEdgeEnforcement">true</item>
-    </style>
-</resources>
\ No newline at end of file
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/CanvasVirtualCamera.java b/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/CanvasVirtualCamera.java
deleted file mode 100644
index 43227769d..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/CanvasVirtualCamera.java
+++ /dev/null
@@ -1,104 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.virtualcamera;
-
-import android.companion.virtual.camera.VirtualCameraCallback;
-import android.graphics.Canvas;
-import android.graphics.Color;
-import android.graphics.Paint;
-import android.util.Log;
-import android.view.Surface;
-
-import androidx.annotation.GuardedBy;
-import androidx.annotation.NonNull;
-
-import java.util.concurrent.atomic.AtomicBoolean;
-
-/** Implementation of virtual camera callback drawing to camera Surface via canvas. */
-public class CanvasVirtualCamera implements VirtualCameraCallback {
-    private static final String TAG = CanvasVirtualCamera.class.getSimpleName();
-
-    private final Object mLock = new Object();
-    private final String mName;
-
-    CanvasVirtualCamera(String name) {
-        mName = name;
-    }
-
-    @GuardedBy("mLock")
-    RenderThread mRenderThread = null;
-
-    @Override
-    public void onStreamConfigured(int streamId, @NonNull Surface surface, int width, int height,
-            int format) {
-        synchronized (mLock) {
-            mRenderThread = new RenderThread(surface);
-        }
-    }
-
-    @Override
-    public void onStreamClosed(int streamId) {
-        synchronized (mLock) {
-            if (mRenderThread != null) {
-                mRenderThread.stopRendering();
-            }
-        }
-    }
-
-    private class RenderThread extends Thread {
-        private final Surface mSurface;
-        private final AtomicBoolean mStopRequested = new AtomicBoolean(false);
-
-        private float[] mHsv = new float[]{0f, 1f, 1f};
-
-        RenderThread(Surface surface) {
-            mSurface = surface;
-            start();
-        }
-
-        @Override
-        public void run() {
-            while (!mStopRequested.get()) {
-                Canvas canvas = mSurface.lockCanvas(null);
-
-                mHsv[0] += 1f;
-                if (mHsv[0] >= 360f) {
-                    mHsv[0] = 0f;
-                }
-                Log.d(TAG, "Drawing with h:" + mHsv[0]);
-
-                canvas.drawColor(Color.HSVToColor(mHsv));
-                Paint paint = new Paint();
-                paint.setColor(Color.BLACK);
-                paint.setTextSize(50);
-                canvas.drawText("Virtual camera: " + mName, 50, 50, paint);
-                mSurface.unlockCanvasAndPost(canvas);
-
-                try {
-                    Thread.sleep(1000 / 25);
-                } catch (InterruptedException e) {
-                    // Ignore.
-                }
-            }
-        }
-
-        public void stopRendering() {
-            mStopRequested.set(true);
-            mSurface.release();
-        }
-    }
-}
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/MainActivity.java b/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/MainActivity.java
deleted file mode 100644
index f1c0297e9..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/MainActivity.java
+++ /dev/null
@@ -1,132 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.virtualcamera;
-
-import android.companion.virtual.camera.VirtualCamera;
-import android.companion.virtual.camera.VirtualCameraCallback;
-import android.content.ComponentName;
-import android.content.Context;
-import android.content.Intent;
-import android.content.ServiceConnection;
-import android.os.Bundle;
-import android.os.IBinder;
-import android.util.Log;
-import android.widget.Button;
-import android.widget.EditText;
-import android.widget.ListView;
-import android.widget.RadioGroup;
-import android.widget.Toast;
-
-import androidx.appcompat.app.AppCompatActivity;
-
-import dagger.hilt.android.AndroidEntryPoint;
-
-import java.util.Objects;
-
-/** Main activity of virtual camera demo app. */
-@AndroidEntryPoint(AppCompatActivity.class)
-public class MainActivity extends Hilt_MainActivity {
-    public static final String TAG = "VirtualCameraDemo";
-
-    private VirtualCameraDemoService mVirtualCameraDemoService;
-    private EditText mCameraNameEditText;
-    private Button mCameraButton;
-    private ListView mCamerasListView;
-    private RadioGroup mCameraInputTypeRadioGroup;
-
-    private VirtualCameraArrayAdapter mVirtualCameraArrayAdapter = null;
-
-    private final ServiceConnection mServiceConnection =
-            new ServiceConnection() {
-
-                @Override
-                public void onServiceConnected(ComponentName className, IBinder binder) {
-                    Log.i(TAG, "Connected to Virtual Camera Demo Service");
-                    mVirtualCameraDemoService =
-                            ((VirtualCameraDemoService.LocalBinder) binder).getService();
-                    mVirtualCameraArrayAdapter.setVirtualCameraDemoService(
-                            mVirtualCameraDemoService);
-                }
-
-                @Override
-                public void onServiceDisconnected(ComponentName className) {
-                    Log.i(TAG, "Disconnected from Virtual Camera Demo Service");
-                    mVirtualCameraDemoService = null;
-                    mVirtualCameraArrayAdapter.setVirtualCameraDemoService(null);
-                }
-            };
-
-    VirtualCameraCallback getCameraCallback() {
-        int checkedId = mCameraInputTypeRadioGroup.getCheckedRadioButtonId();
-        Log.d(TAG, "checkedId = " + checkedId);
-        switch (checkedId) {
-            case R.id.radio_canvas -> {
-                return new CanvasVirtualCamera(mCameraNameEditText.getText().toString());
-            }
-            case R.id.radio_video_file -> {
-                return new VideoFileVirtualCamera(getApplicationContext());
-            }
-        }
-        return null;
-    }
-
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        setContentView(R.layout.activity_main);
-
-        mCameraNameEditText = Objects.requireNonNull(findViewById(R.id.camera_name_edit_text));
-        mCameraButton = Objects.requireNonNull(findViewById(R.id.create_camera_button));
-        mCameraButton.setOnClickListener(v -> {
-            Log.d(TAG, "onClick");
-            VirtualCameraCallback callback = getCameraCallback();
-            if (callback == null) {
-                Toast.makeText(this, "No camera input type selected", Toast.LENGTH_SHORT).show();
-            } else {
-                VirtualCamera virtualCamera = mVirtualCameraDemoService.createVirtualCamera(
-                        mCameraNameEditText.getText().toString(),
-                        callback);
-                mVirtualCameraArrayAdapter.add(virtualCamera);
-                Log.d(TAG, "Created virtual camera " + virtualCamera.getId());
-            }
-        });
-        mCamerasListView = Objects.requireNonNull(findViewById(R.id.cameras_list_view));
-        mVirtualCameraArrayAdapter = new VirtualCameraArrayAdapter(this);
-        mCamerasListView.setAdapter(mVirtualCameraArrayAdapter);
-
-        mCameraInputTypeRadioGroup = Objects.requireNonNull(
-                findViewById(R.id.camera_type_radio_group));
-    }
-
-    @Override
-    protected void onStart() {
-        super.onStart();
-        Log.d(TAG, "onStart");
-        Intent intent = new Intent(this, VirtualCameraDemoService.class);
-        startForegroundService(intent);
-        Log.d(TAG, "Starting foreground service");
-        bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE);
-    }
-
-    @Override
-    protected void onStop() {
-        super.onStop();
-        Log.d(TAG, "onStop");
-        unbindService(mServiceConnection);
-    }
-}
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VideoFileVirtualCamera.java b/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VideoFileVirtualCamera.java
deleted file mode 100644
index 65e7ee9fc..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VideoFileVirtualCamera.java
+++ /dev/null
@@ -1,60 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.virtualcamera;
-
-import android.companion.virtual.camera.VirtualCameraCallback;
-import android.content.Context;
-import android.media.MediaPlayer;
-import android.view.Surface;
-
-import androidx.annotation.NonNull;
-
-import dagger.hilt.android.qualifiers.ApplicationContext;
-
-import java.util.Objects;
-
-import javax.inject.Inject;
-
-/** Implementation of virtual camera callback playing video on camera's Surface. */
-public class VideoFileVirtualCamera implements VirtualCameraCallback {
-
-    private final Context mContext;
-    private MediaPlayer mMediaPlayer = null;
-
-    @Inject
-    VideoFileVirtualCamera(@ApplicationContext Context context) {
-        this.mContext = context;
-    }
-
-    @Override
-    public void onStreamConfigured(int streamId, @NonNull Surface surface, int width, int height,
-            int format) {
-        mMediaPlayer = Objects.requireNonNull(MediaPlayer.create(mContext,
-                                    R.raw.testvideo));
-        mMediaPlayer.setLooping(true);
-        mMediaPlayer.setSurface(surface);
-        mMediaPlayer.start();
-    }
-
-    @Override
-    public void onStreamClosed(int streamId) {
-        if (mMediaPlayer != null) {
-            mMediaPlayer.stop();
-            mMediaPlayer.release();
-        }
-    }
-}
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraArrayAdapter.java b/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraArrayAdapter.java
deleted file mode 100644
index bd883c1f4..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraArrayAdapter.java
+++ /dev/null
@@ -1,95 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.virtualcamera;
-
-import android.companion.virtual.camera.VirtualCamera;
-import android.content.Context;
-import android.view.LayoutInflater;
-import android.view.View;
-import android.view.ViewGroup;
-import android.widget.ArrayAdapter;
-import android.widget.Button;
-import android.widget.TextView;
-
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-
-import java.util.Objects;
-
-
-/** Array adapter for viewing list of currently registered cameras. */
-public class VirtualCameraArrayAdapter extends ArrayAdapter<VirtualCamera> {
-    private final LayoutInflater mLayoutInflater;
-
-    private VirtualCameraDemoService mVirtualCameraDemoService;
-
-    public VirtualCameraArrayAdapter(@NonNull Context context) {
-        super(context, 0);
-
-        mLayoutInflater = Objects.requireNonNull(context.getSystemService(LayoutInflater.class));
-    }
-
-    static class CameraViewHolder {
-        TextView mCameraDisplayName;
-        TextView mCameraId;
-
-        Button mRemoveButton;
-    }
-
-    public void setVirtualCameraDemoService(@Nullable VirtualCameraDemoService service) {
-        mVirtualCameraDemoService = service;
-    }
-
-    @Override
-    public int getCount() {
-        return mVirtualCameraDemoService != null ? mVirtualCameraDemoService.getCameras().size()
-                : 0;
-    }
-
-    @Override
-    public VirtualCamera getItem(int index) {
-        return mVirtualCameraDemoService != null ? mVirtualCameraDemoService.getCameras().get(index)
-                : null;
-    }
-
-    @NonNull
-    @Override
-    public View getView(int position, View convertView, ViewGroup parent) {
-        View row = convertView;
-        CameraViewHolder viewHolder;
-        if (row == null) {
-            row = mLayoutInflater.inflate(R.layout.camera_item, parent, false);
-            viewHolder = new CameraViewHolder();
-            viewHolder.mCameraDisplayName = row.findViewById(R.id.camera_display_name);
-            viewHolder.mCameraId = row.findViewById(R.id.camera_id);
-            viewHolder.mRemoveButton = row.findViewById(R.id.remove_button);
-            row.setTag(viewHolder);
-        } else {
-            viewHolder = (CameraViewHolder) row.getTag();
-        }
-        VirtualCamera camera = Objects.requireNonNull(getItem(position));
-        viewHolder.mCameraDisplayName.setText(camera.getConfig().getName());
-        viewHolder.mCameraId.setText(camera.getId());
-        viewHolder.mRemoveButton.setOnClickListener(v -> {
-            if (mVirtualCameraDemoService != null) {
-                mVirtualCameraDemoService.removeCamera(camera);
-            }
-            notifyDataSetChanged();
-        });
-        return row;
-    }
-}
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoService.java b/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoService.java
deleted file mode 100644
index e0703939c..000000000
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoService.java
+++ /dev/null
@@ -1,245 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.example.android.vdmdemo.virtualcamera;
-
-import static android.companion.virtual.VirtualDeviceParams.DEVICE_POLICY_CUSTOM;
-import static android.companion.virtual.VirtualDeviceParams.POLICY_TYPE_CAMERA;
-import static android.hardware.camera2.CameraMetadata.LENS_FACING_FRONT;
-
-import android.annotation.SuppressLint;
-import android.app.Notification;
-import android.app.NotificationChannel;
-import android.app.NotificationManager;
-import android.app.PendingIntent;
-import android.app.Service;
-import android.app.role.RoleManager;
-import android.companion.AssociationInfo;
-import android.companion.AssociationRequest;
-import android.companion.CompanionDeviceManager;
-import android.companion.virtual.VirtualDeviceManager;
-import android.companion.virtual.VirtualDeviceParams;
-import android.companion.virtual.camera.VirtualCamera;
-import android.companion.virtual.camera.VirtualCameraCallback;
-import android.companion.virtual.camera.VirtualCameraConfig;
-import android.content.Intent;
-import android.content.IntentSender;
-import android.graphics.ImageFormat;
-import android.os.Binder;
-import android.os.IBinder;
-import android.util.Log;
-
-import androidx.annotation.GuardedBy;
-import androidx.annotation.NonNull;
-
-import dagger.hilt.android.AndroidEntryPoint;
-
-import java.util.ArrayList;
-import java.util.List;
-import java.util.Objects;
-
-/** Virtual camera service. */
-@AndroidEntryPoint(Service.class)
-public final class VirtualCameraDemoService extends Hilt_VirtualCameraDemoService {
-    public static final String TAG = VirtualCameraDemoService.class.getSimpleName();
-
-    private static final String CHANNEL_ID =
-            "com.example.android.vdmdemo.virtualcamera.VirtualCameraDemoService";
-
-    private static final String ACTION_STOP =
-            "com.example.android.vdmdemo.virtualcamera.VirtualCameraDemoService.STOP";
-
-    private static final int NOTIFICATION_ID = 1;
-
-    private static final String VIRTUAL_DEVICE_NAME = "VirtualDevice - Virtual Camera demo";
-
-    private final Object mLock = new Object();
-
-    @GuardedBy("mLock")
-    private final ArrayList<VirtualCamera> mVirtualCameras = new ArrayList<>();
-
-    /** Provides an instance of this service to bound clients. */
-    public class LocalBinder extends Binder {
-        VirtualCameraDemoService getService() {
-            return VirtualCameraDemoService.this;
-        }
-    }
-
-    private final IBinder mBinder = new LocalBinder();
-
-    private VirtualDeviceManager.VirtualDevice mVirtualDevice = null;
-
-    @Override
-    public IBinder onBind(Intent intent) {
-        Log.d(TAG, "onBind");
-        return mBinder;
-    }
-
-    @Override
-    public int onStartCommand(Intent intent, int flags, int startId) {
-        if (intent != null && ACTION_STOP.equals(intent.getAction())) {
-            Log.i(TAG, "Stopping VDM Camera Demo Service.");
-            stopForeground(STOP_FOREGROUND_REMOVE);
-            stopSelf();
-            return START_NOT_STICKY;
-        }
-
-        NotificationChannel notificationChannel =
-                new NotificationChannel(
-                        CHANNEL_ID, "VDM Service Channel", NotificationManager.IMPORTANCE_LOW);
-        notificationChannel.enableVibration(false);
-        NotificationManager notificationManager = Objects.requireNonNull(
-                getSystemService(NotificationManager.class));
-        notificationManager.createNotificationChannel(notificationChannel);
-
-        Intent openIntent = new Intent(this, MainActivity.class);
-        PendingIntent pendingIntentOpen =
-                PendingIntent.getActivity(this, 0, openIntent, PendingIntent.FLAG_IMMUTABLE);
-        Intent stopIntent = new Intent(this, VirtualCameraDemoService.class);
-        stopIntent.setAction(ACTION_STOP);
-        PendingIntent pendingIntentStop =
-                PendingIntent.getService(this, 0, stopIntent, PendingIntent.FLAG_IMMUTABLE);
-
-        Notification notification =
-                new Notification.Builder(this, CHANNEL_ID)
-                        .setSmallIcon(R.drawable.connected)
-                        .setContentTitle("Virtual camera running")
-                        .setContentText("Click to open")
-                        .setContentIntent(pendingIntentOpen)
-                        .addAction(
-                                new Notification.Action.Builder(
-                                        R.drawable.close, "Stop", pendingIntentStop)
-                                        .build())
-                        .setOngoing(true)
-                        .build();
-        startForeground(NOTIFICATION_ID, notification);
-
-        return START_STICKY;
-    }
-
-    @Override
-    public void onCreate() {
-        super.onCreate();
-        Log.d(TAG, "onCreate");
-        associateAndCreateVirtualDevice();
-    }
-
-    @Override
-    public void onDestroy() {
-        super.onDestroy();
-        Log.d(TAG, "onDestroy");
-        if (mVirtualDevice != null) {
-            mVirtualDevice.close();
-        }
-    }
-
-    private void associateAndCreateVirtualDevice() {
-        CompanionDeviceManager cdm = getSystemService(CompanionDeviceManager.class);
-        RoleManager rm = getSystemService(RoleManager.class);
-        for (AssociationInfo associationInfo : cdm.getMyAssociations()) {
-            // Flashing the device clears the role and the permissions, but not the CDM
-            // associations.
-            // TODO(b/290596625): Remove the workaround to clear the associations if the role is not
-            // held.
-            if (!rm.isRoleHeld(AssociationRequest.DEVICE_PROFILE_APP_STREAMING)) {
-                cdm.disassociate(associationInfo.getId());
-            } else if (Objects.equals(associationInfo.getPackageName(), getPackageName())
-                    && Objects.equals(
-                    associationInfo.getDisplayName().toString(),
-                    VIRTUAL_DEVICE_NAME)) {
-                createVirtualDevice(associationInfo);
-                return;
-            }
-        }
-
-        @SuppressLint("MissingPermission")
-        AssociationRequest.Builder associationRequest =
-                new AssociationRequest.Builder()
-                        .setDeviceProfile(AssociationRequest.DEVICE_PROFILE_APP_STREAMING)
-                        .setDisplayName(VIRTUAL_DEVICE_NAME)
-                        .setSelfManaged(true);
-        cdm.associate(
-                associationRequest.build(),
-                new CompanionDeviceManager.Callback() {
-                    @Override
-                    public void onAssociationPending(@NonNull IntentSender intentSender) {
-                        try {
-                            startIntentSender(intentSender, null, 0, 0, 0);
-                        } catch (IntentSender.SendIntentException e) {
-                            Log.e(
-                                    TAG,
-                                    "onAssociationPending: Failed to send device selection intent",
-                                    e);
-                        }
-                    }
-
-                    @Override
-                    public void onAssociationCreated(@NonNull AssociationInfo associationInfo) {
-                        Log.i(TAG, "onAssociationCreated: ID " + associationInfo.getId());
-                        createVirtualDevice(associationInfo);
-                    }
-
-                    @Override
-                    public void onFailure(CharSequence error) {
-                        Log.e(TAG, "onFailure: RemoteDevice Association failed " + error);
-                    }
-                },
-                null);
-        Log.i(TAG, "createCdmAssociation: Waiting for association to happen");
-    }
-
-    private void createVirtualDevice(AssociationInfo associationInfo) {
-        VirtualDeviceParams.Builder virtualDeviceBuilder =
-                new VirtualDeviceParams.Builder()
-                        .setName(VIRTUAL_DEVICE_NAME)
-                        .setDevicePolicy(POLICY_TYPE_CAMERA, DEVICE_POLICY_CUSTOM);
-
-        VirtualDeviceManager vdm = getSystemService(VirtualDeviceManager.class);
-        mVirtualDevice = Objects.requireNonNull(vdm).createVirtualDevice(associationInfo.getId(),
-                virtualDeviceBuilder.build());
-    }
-
-    VirtualCamera createVirtualCamera(String name, VirtualCameraCallback cameraCallback) {
-        if (mVirtualDevice == null) {
-            Log.d(TAG, "No virtual device - cannot create camera");
-        }
-
-        VirtualCamera camera = mVirtualDevice.createVirtualCamera(
-                new VirtualCameraConfig.Builder(name)
-                        .addStreamConfig(640, 480, ImageFormat.YUV_420_888, 30)
-                        .setLensFacing(LENS_FACING_FRONT)
-                        .setVirtualCameraCallback(getMainExecutor(), cameraCallback)
-                        .build());
-
-        synchronized (mLock) {
-            mVirtualCameras.add(camera);
-        }
-
-        return camera;
-    }
-
-    void removeCamera(VirtualCamera camera) {
-        synchronized (mLock) {
-            mVirtualCameras.remove(camera);
-        }
-    }
-
-    List<VirtualCamera> getCameras() {
-        synchronized (mLock) {
-            return List.copyOf(mVirtualCameras);
-        }
-    }
-}
diff --git a/scripts/add3prf.py b/scripts/add3prf.py
index ab1dff58f..742c61283 100755
--- a/scripts/add3prf.py
+++ b/scripts/add3prf.py
@@ -203,7 +203,7 @@ def decide_license_type(cargo_license):
   # Some crate like time-macros-impl uses lower case names like LICENSE-Apache.
   licenses = []
   license_file = None
-  for license_file in glob.glob("LICENSE*") + glob.glob("COPYING*") + glob.glob("UNLICENSE*"):
+  for license_file in glob.glob("license*") + glob.glob("LICENSE*") + glob.glob("COPYING*") + glob.glob("UNLICENSE*"):
     lowered_name = os.path.splitext(license_file.lower())[0]
     if lowered_name == "license-apache":
       licenses.append(License(LicenseType.APACHE2, LicenseGroup.NOTICE, license_file))
diff --git a/scripts/stack_core.py b/scripts/stack_core.py
index 215a45d5a..b2a7842c5 100755
--- a/scripts/stack_core.py
+++ b/scripts/stack_core.py
@@ -61,6 +61,8 @@ class TraceConverter:
   spacing = ""
   apk_info = dict()
   lib_to_path = dict()
+  mte_fault_address = None
+  mte_stack_records = []
 
   # We use the "file" command line tool to extract BuildId from ELF files.
   ElfInfo = collections.namedtuple("ElfInfo", ["bitness", "build_id"])
@@ -133,6 +135,11 @@ class TraceConverter:
                                 r"[ \t]*[a-f0-9]" + self.width +
                                 r"[ \t]*[a-f0-9]" + self.width +
                                 r"[ \t]*[ \r\n]")  # pylint: disable-msg=C6310
+    self.mte_sync_line = re.compile(r".*signal 11 \(SIGSEGV\), code 9 \(SEGV_MTESERR\), fault addr 0x(?P<address>[0-9a-f]+)")
+    self.mte_stack_record_line = re.compile(r".*stack_record fp:0x(?P<fp>[0-9a-f]+) "
+                                            r"tag:0x(?P<tag>[0-9a-f]+) "
+                                            r"pc:(?P<object>[^+]+)\+0x(?P<offset>[0-9a-f]+)"
+                                            r"(?: \(BuildId: (?P<buildid>[A-Za-z0-9]+)\))?")
 
   def CleanLine(self, ln):
     # AndroidFeedback adds zero width spaces into its crash reports. These
@@ -157,11 +164,45 @@ class TraceConverter:
       (addr, value, symbol_with_offset, location) = vl
       print("  %8s  %8s  %s  %s" % (addr, value, symbol_with_offset.ljust(maxlen), location))
 
+  def MatchStackRecords(self):
+    if self.mte_fault_address is None:
+      return
+    fault_tag = (self.mte_fault_address >> 56) & 0xF
+    untagged_fault_address = self.mte_fault_address & ~(0xF << 56)
+    build_id_to_lib = {}
+    record_for_lib = collections.defaultdict(lambda: collections.defaultdict(set))
+    for lib, buildid, offset, fp, tag in self.mte_stack_records:
+      if buildid is not None:
+        if buildid not in build_id_to_lib:
+          basename = os.path.basename(lib).split("!")[-1]
+          newlib = self.GetLibraryByBuildId(symbol.SYMBOLS_DIR, basename, buildid)
+          if newlib is not None:
+            build_id_to_lib[buildid] = newlib
+            lib = newlib
+        else:
+          lib = build_id_to_lib[buildid]
+      record_for_lib[lib][offset].add((fp, tag))
+
+    for lib, values in record_for_lib.items():
+      records = symbol.GetStackRecordsForSet(lib, values.keys()) or []
+      for addr, function_name, local_name, file_line, frame_offset, size, tag_offset in records:
+        if frame_offset is None or size is None or tag_offset is None:
+          continue
+        for fp, tag in values[addr]:
+          obj_offset = untagged_fault_address - fp - frame_offset
+          if tag + tag_offset == fault_tag and obj_offset < size:
+            print('')
+            print('Potentially referenced stack object:')
+            print('  %d bytes inside a variable "%s" in stack frame of function "%s"'% (obj_offset, local_name, function_name))
+            print('  at %s' % file_line)
+
   def PrintOutput(self, trace_lines, value_lines):
     if self.trace_lines:
       self.PrintTraceLines(self.trace_lines)
     if self.value_lines:
       self.PrintValueLines(self.value_lines)
+    if self.mte_stack_records:
+      self.MatchStackRecords()
 
   def PrintDivider(self):
     print("\n-----------------------------------------------------\n")
@@ -415,12 +456,17 @@ class TraceConverter:
         register_header or dalvik_jni_thread_header or dalvik_native_thread_header or \
         revision_header or unreachable_header:
       ret = True
-      if self.trace_lines or self.value_lines:
+      if self.trace_lines or self.value_lines or self.mte_stack_records:
         self.PrintOutput(self.trace_lines, self.value_lines)
         self.PrintDivider()
         self.trace_lines = []
         self.value_lines = []
+        self.mte_fault_address = None
+        self.mte_stack_records = []
         self.last_frame = -1
+      if self.mte_sync_line.match(line):
+        match = self.mte_sync_line.match(line)
+        self.mte_fault_address = int(match.group("address"), 16)
       if process_header:
         print(process_header.group(1))
       if signal_header:
@@ -566,6 +612,16 @@ class TraceConverter:
                                    value,
                                    object_symbol_with_offset,
                                    source_location))
+    if self.mte_stack_record_line.match(line):
+      ret = True
+      match = self.mte_stack_record_line.match(line)
+      if self.mte_fault_address is not None:
+        self.mte_stack_records.append(
+          (match.group("object"),
+           match.group("buildid"),
+           int(match.group("offset"), 16),
+           int(match.group("fp"), 16),
+           int(match.group("tag"), 16)))
 
     return ret
 
diff --git a/scripts/symbol.py b/scripts/symbol.py
index 64242eab8..505677c15 100755
--- a/scripts/symbol.py
+++ b/scripts/symbol.py
@@ -241,6 +241,88 @@ def SymbolInformationForSet(lib, unique_addrs):
   return result
 
 
+def _OptionalStackRecordField(json_result, field):
+  """Fix up bizarre formatting of llvm-symbolizer output
+
+  Some parts of the FRAME output are output as a string containing a hex
+  integer, or the empty string when it's missing.
+
+  Args:
+    json_result: dictionary containing the Frame response
+    field: name of the field we want to read
+
+  Returns:
+    integer of field value, or None if missing
+  """
+  value = json_result.get(field, "")
+  if isinstance(value, int):
+    # Leaving this here in case someone decides to fix the types of the
+    # symbolizer output, so it's easier to roll out.
+    return value
+  if value != "":
+    return int(value, 16)
+  return None
+
+
+def _GetJSONSymbolizerForLib(lib, args=None):
+  """ Find symbol file for lib, and return a llvm-symbolizer instance for it.
+
+  Args:
+    lib: library (or executable) pathname containing symbols
+    args: (optional) list of arguments to pass to llvm-symbolizer
+
+  Returns:
+    child process, or None if lib not found
+  """
+  if args is None:
+    args = []
+  symbols = SYMBOLS_DIR + lib
+  if not os.path.exists(symbols):
+    symbols = lib
+    if not os.path.exists(symbols):
+      return None
+
+  # Make sure the symbols path is not a directory.
+  if os.path.isdir(symbols):
+    return None
+
+  cmd = [ToolPath("llvm-symbolizer"), "--output-style=JSON"] + args + ["--obj=" + symbols]
+  return _PIPE_ADDR2LINE_CACHE.GetProcess(cmd)
+
+
+def GetStackRecordsForSet(lib, unique_addrs):
+  """Look up stack record information for a set of addresses
+
+  Args:
+    lib: library (or executable) pathname containing symbols
+    unique_addrs: set of integer addresses look up.
+
+  Returns:
+    A list of tuples
+    (addr, function_name, local_name, file_line, frame_offset, size, tag_offset)
+    describing the local variables of the stack frame.
+    frame_offset, size, tag_offset may be None.
+  """
+  child = _GetJSONSymbolizerForLib(lib)
+  if child is None:
+    return None
+  records = []
+  for addr in unique_addrs:
+    child.stdin.write("FRAME 0x%x\n" % addr)
+    child.stdin.flush()
+    json_result = json.loads(child.stdout.readline().strip())
+    for frame in json_result["Frame"]:
+      records.append(
+        (addr,
+        frame["FunctionName"],
+        frame["Name"],
+        frame["DeclFile"] + ":" + str(frame["DeclLine"]),
+        frame.get("FrameOffset"),
+        _OptionalStackRecordField(frame, "Size"),
+        _OptionalStackRecordField(frame, "TagOffset")))
+  return records
+
+
 def CallLlvmSymbolizerForSet(lib, unique_addrs):
   """Look up line and symbol information for a set of addresses.
 
@@ -282,20 +364,10 @@ def CallLlvmSymbolizerForSet(lib, unique_addrs):
     addr_cache = {}
     _SYMBOL_INFORMATION_ADDR2LINE_CACHE[lib] = addr_cache
 
-  symbols = SYMBOLS_DIR + lib
-  if not os.path.exists(symbols):
-    symbols = lib
-    if not os.path.exists(symbols):
-      return None
-
-  # Make sure the symbols path is not a directory.
-  if os.path.isdir(symbols):
+  child = _GetJSONSymbolizerForLib(
+    lib, ["--functions", "--inlines", "--demangle"])
+  if child is None:
     return None
-
-  cmd = [ToolPath("llvm-symbolizer"), "--functions", "--inlines",
-      "--demangle", "--obj=" + symbols, "--output-style=JSON"]
-  child = _PIPE_ADDR2LINE_CACHE.GetProcess(cmd)
-
   for addr in addrs:
     try:
       child.stdin.write("0x%s\n" % addr)
diff --git a/scripts/update_crate_tests.py b/scripts/update_crate_tests.py
index 3a4ea3851..218a4b7e8 100755
--- a/scripts/update_crate_tests.py
+++ b/scripts/update_crate_tests.py
@@ -149,12 +149,6 @@ class Bazel(object):
 
         # soong_ui requires to be at the root of the repository.
         os.chdir(env.ANDROID_BUILD_TOP)
-        print("Generating Bazel files...")
-        cmd = [soong_ui, "--make-mode", "bp2build"]
-        try:
-            subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True)
-        except subprocess.CalledProcessError as e:
-            raise UpdaterException('Unable to generate bazel workspace: ' + e.output)
 
         print("Building Bazel Queryview. This can take a couple of minutes...")
         cmd = [soong_ui, "--build-mode", "--all-modules", "--dir=.", "queryview"]
diff --git a/sdk/plat_tools_source.prop_template b/sdk/plat_tools_source.prop_template
index db496f68f..9f633ab82 100644
--- a/sdk/plat_tools_source.prop_template
+++ b/sdk/plat_tools_source.prop_template
@@ -1,2 +1,2 @@
 Pkg.UserSrc=false
-Pkg.Revision=35.0.1
+Pkg.Revision=35.0.2
diff --git a/tools/cargo_embargo/Android.bp b/tools/cargo_embargo/Android.bp
index b1460e52c..25a47c6d5 100644
--- a/tools/cargo_embargo/Android.bp
+++ b/tools/cargo_embargo/Android.bp
@@ -29,7 +29,6 @@ rust_defaults {
         "libglob",
         "liblog_rust",
         "libnix",
-        "libonce_cell",
         "libregex",
         "libserde",
         "libserde_json",
diff --git a/tools/cargo_embargo/src/bp.rs b/tools/cargo_embargo/src/bp.rs
index 7744ae74f..ef58ade2e 100644
--- a/tools/cargo_embargo/src/bp.rs
+++ b/tools/cargo_embargo/src/bp.rs
@@ -73,10 +73,10 @@ impl BpProperties {
         BpProperties { map: BTreeMap::new(), raw_block: None }
     }
 
-    pub fn get_string(&self, k: &str) -> &str {
-        match self.map.get(k).unwrap() {
-            BpValue::String(s) => s,
-            _ => unreachable!(),
+    pub fn get_string(&self, k: &str) -> Option<&str> {
+        match self.map.get(k)? {
+            BpValue::String(s) => Some(s),
+            _ => None,
         }
     }
 
@@ -108,6 +108,7 @@ impl BpProperties {
             "defaults",
             "stem",
             "host_supported",
+            "host_cross_supported",
             "crate_name",
             "cargo_env_compat",
             "cargo_pkg_version",
diff --git a/tools/cargo_embargo/src/cargo.rs b/tools/cargo_embargo/src/cargo.rs
index 4140bc960..723459a6c 100644
--- a/tools/cargo_embargo/src/cargo.rs
+++ b/tools/cargo_embargo/src/cargo.rs
@@ -93,6 +93,8 @@ pub struct Crate {
     pub edition: String,
     pub package_dir: PathBuf, // canonicalized
     pub main_src: PathBuf,    // relative to package_dir
+    pub license: Option<String>,
+    pub license_file: Option<String>,
     /// Whether it is a test crate which doesn't actually contain any tests or benchmarks.
     pub empty_test: bool,
 }
@@ -102,6 +104,7 @@ pub struct Crate {
 pub struct Extern {
     pub name: String,
     pub lib_name: String,
+    pub raw_name: String,
     pub extern_type: ExternType,
 }
 
diff --git a/tools/cargo_embargo/src/cargo/cargo_out.rs b/tools/cargo_embargo/src/cargo/cargo_out.rs
index fb2f00f64..ee28cee46 100644
--- a/tools/cargo_embargo/src/cargo/cargo_out.rs
+++ b/tools/cargo_embargo/src/cargo/cargo_out.rs
@@ -20,12 +20,12 @@ use anyhow::bail;
 use anyhow::Context;
 use anyhow::Result;
 use log::debug;
-use once_cell::sync::Lazy;
 use regex::Regex;
 use std::collections::BTreeMap;
 use std::env;
 use std::path::Path;
 use std::path::PathBuf;
+use std::sync::LazyLock;
 
 /// Reads the given `cargo.out` and `cargo.metadata` files, and generates a list of crates based on
 /// the rustc invocations.
@@ -56,9 +56,14 @@ fn parse_cargo_out_str(
     assert!(cargo_out.cc_invocations.is_empty(), "cc not supported yet");
     assert!(cargo_out.ar_invocations.is_empty(), "ar not supported yet");
 
+    let mut raw_names = BTreeMap::new();
+    for rustc in cargo_out.rustc_invocations.iter() {
+        raw_name_from_rustc_invocation(rustc, &mut raw_names)
+    }
+
     let mut crates = Vec::new();
     for rustc in cargo_out.rustc_invocations.iter() {
-        let c = Crate::from_rustc_invocation(rustc, metadata, &cargo_out.tests)
+        let c = Crate::from_rustc_invocation(rustc, metadata, &cargo_out.tests, &raw_names)
             .with_context(|| format!("failed to process rustc invocation: {rustc}"))?;
         // Ignore build.rs crates.
         if c.name.starts_with("build_script_") {
@@ -74,6 +79,61 @@ fn parse_cargo_out_str(
     Ok(crates)
 }
 
+fn args_from_rustc_invocation(rustc: &str) -> Vec<&str> {
+    let mut args = Vec::new();
+    let mut chars = rustc.char_indices();
+    while let Some((start, c)) = chars.next() {
+        match c {
+            '\'' => {
+                let (end, _) =
+                    chars.find(|(_, c)| *c == '\'').expect("Missing closing single quote");
+                args.push(&rustc[start + 1..end]);
+            }
+            '"' => {
+                let (end, _) =
+                    chars.find(|(_, c)| *c == '"').expect("Missing closing double quote");
+                args.push(&rustc[start + 1..end]);
+            }
+            _ => {
+                if c.is_ascii_whitespace() {
+                    // Ignore, continue on to the next character.
+                } else if let Some((end, _)) = chars.find(|(_, c)| c.is_ascii_whitespace()) {
+                    args.push(&rustc[start..end]);
+                } else {
+                    args.push(&rustc[start..]);
+                }
+            }
+        }
+    }
+    args
+}
+
+/// Parse out the path name for a crate from a rustc invocation
+fn raw_name_from_rustc_invocation(rustc: &str, raw_names: &mut BTreeMap<String, String>) {
+    let mut crate_name = String::new();
+    // split into args
+    let mut arg_iter = args_from_rustc_invocation(rustc).into_iter();
+    // look for the crate name and a string ending in .rs and check whether the
+    // path string contains a kebab-case version of the crate name
+    while let Some(arg) = arg_iter.next() {
+        match arg {
+            "--crate-name" => crate_name = arg_iter.next().unwrap().to_string(),
+            _ if arg.ends_with(".rs") => {
+                assert_ne!(crate_name, "", "--crate-name option should precede input");
+                let snake_case_arg = arg.replace('-', "_");
+                if let Some(idx) = snake_case_arg.rfind(&crate_name) {
+                    let raw_name = arg[idx..idx + crate_name.len()].to_string();
+                    if crate_name != raw_name {
+                        raw_names.insert(crate_name, raw_name);
+                    }
+                }
+                break;
+            }
+            _ => {}
+        }
+    }
+}
+
 /// Whether a test target contains any tests or benchmarks.
 #[derive(Debug)]
 struct TestContents {
@@ -129,16 +189,16 @@ impl CargoOut {
             }
 
             // Cargo -v output of a call to rustc.
-            static RUSTC_REGEX: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^ +Running `rustc (.*)`$").unwrap());
+            static RUSTC_REGEX: LazyLock<Regex> =
+                LazyLock::new(|| Regex::new(r"^ +Running `(?:/[^\s]*/)?rustc (.*)`$").unwrap());
             if let Some(args) = match1(&RUSTC_REGEX, line) {
                 result.rustc_invocations.push(args);
                 continue;
             }
             // Cargo -vv output of a call to rustc could be split into multiple lines.
             // Assume that the first line will contain some CARGO_* env definition.
-            static RUSTC_VV_REGEX: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^ +Running `.*CARGO_.*=.*$").unwrap());
+            static RUSTC_VV_REGEX: LazyLock<Regex> =
+                LazyLock::new(|| Regex::new(r"^ +Running `.*CARGO_.*=.*$").unwrap());
             if RUSTC_VV_REGEX.is_match(line) {
                 // cargo build -vv output can have multiple lines for a rustc command due to
                 // '\n' in strings for environment variables.
@@ -155,8 +215,9 @@ impl CargoOut {
                     break;
                 }
                 // The combined -vv output rustc command line pattern.
-                static RUSTC_VV_CMD_ARGS: Lazy<Regex> =
-                    Lazy::new(|| Regex::new(r"^ *Running `.*CARGO_.*=.* rustc (.*)`$").unwrap());
+                static RUSTC_VV_CMD_ARGS: LazyLock<Regex> = LazyLock::new(|| {
+                    Regex::new(r"^ *Running `.*CARGO_.*=.* (?:/[^\s]*/)?rustc (.*)`$").unwrap()
+                });
                 if let Some(args) = match1(&RUSTC_VV_CMD_ARGS, &line) {
                     result.rustc_invocations.push(args);
                 } else {
@@ -165,8 +226,8 @@ impl CargoOut {
                 continue;
             }
             // Cargo -vv output of a "cc" or "ar" command; all in one line.
-            static CC_AR_VV_REGEX: Lazy<Regex> = Lazy::new(|| {
-                Regex::new(r#"^\[([^ ]*)[^\]]*\] running:? "(cc|ar)" (.*)$"#).unwrap()
+            static CC_AR_VV_REGEX: LazyLock<Regex> = LazyLock::new(|| {
+                Regex::new(r#"^\[([^ ]*)[^\]]*\] running:? "(?:/[^\s]*/)?(cc|ar)" (.*)$"#).unwrap()
             });
             if let Some((pkg, cmd, args)) = match3(&CC_AR_VV_REGEX, line) {
                 match cmd.as_str() {
@@ -177,8 +238,8 @@ impl CargoOut {
                 continue;
             }
             // Rustc output of file location path pattern for a warning message.
-            static WARNING_FILE_REGEX: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^ *--> ([^:]*):[0-9]+").unwrap());
+            static WARNING_FILE_REGEX: LazyLock<Regex> =
+                LazyLock::new(|| Regex::new(r"^ *--> ([^:]*):[0-9]+").unwrap());
             if result.warning_lines.contains_key(&n.saturating_sub(1)) {
                 if let Some(fpath) = match1(&WARNING_FILE_REGEX, line) {
                     result.warning_files.push(fpath);
@@ -193,8 +254,8 @@ impl CargoOut {
                 }
                 continue;
             }
-            static CARGO2ANDROID_RUNNING_REGEX: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^### Running: .*$").unwrap());
+            static CARGO2ANDROID_RUNNING_REGEX: LazyLock<Regex> =
+                LazyLock::new(|| Regex::new(r"^### Running: .*$").unwrap());
             if CARGO2ANDROID_RUNNING_REGEX.is_match(line) {
                 in_tests = line.contains("cargo test") && line.contains("--list");
                 continue;
@@ -202,10 +263,11 @@ impl CargoOut {
 
             // `cargo test -- --list` output
             // Example: Running unittests src/lib.rs (target.tmp/x86_64-unknown-linux-gnu/debug/deps/aarch64-58b675be7dc09833)
-            static CARGO_TEST_LIST_START_PAT: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^\s*Running (?:unittests )?(.*) \(.*/(.*)\)$").unwrap());
-            static CARGO_TEST_LIST_END_PAT: Lazy<Regex> =
-                Lazy::new(|| Regex::new(r"^(\d+) tests?, (\d+) benchmarks$").unwrap());
+            static CARGO_TEST_LIST_START_PAT: LazyLock<Regex> = LazyLock::new(|| {
+                Regex::new(r"^\s*Running (?:unittests )?(.*) \(.*/(.*)\)$").unwrap()
+            });
+            static CARGO_TEST_LIST_END_PAT: LazyLock<Regex> =
+                LazyLock::new(|| Regex::new(r"^(\d+) tests?, (\d+) benchmarks$").unwrap());
             if let Some(captures) = CARGO_TEST_LIST_START_PAT.captures(line) {
                 cur_test_key =
                     Some((captures.get(2).unwrap().as_str(), captures.get(1).unwrap().as_str()));
@@ -233,22 +295,13 @@ impl Crate {
         rustc: &str,
         metadata: &WorkspaceMetadata,
         tests: &BTreeMap<String, BTreeMap<PathBuf, TestContents>>,
+        raw_names: &BTreeMap<String, String>,
     ) -> Result<Crate> {
         let mut out = Crate::default();
         let mut extra_filename = String::new();
 
         // split into args
-        let args: Vec<&str> = rustc.split_whitespace().collect();
-        let mut arg_iter = args
-            .iter()
-            // Remove quotes from simple strings, panic for others.
-            .map(|arg| match (arg.chars().next(), arg.chars().skip(1).last()) {
-                (Some('"'), Some('"')) => &arg[1..arg.len() - 1],
-                (Some('\''), Some('\'')) => &arg[1..arg.len() - 1],
-                (Some('"'), _) => panic!("can't handle strings with whitespace"),
-                (Some('\''), _) => panic!("can't handle strings with whitespace"),
-                _ => arg,
-            });
+        let mut arg_iter = args_from_rustc_invocation(rustc).into_iter();
         // process each arg
         while let Some(arg) = arg_iter.next() {
             match arg {
@@ -277,7 +330,7 @@ impl Crate {
                         let filename = path.split('/').last().unwrap();
 
                         // Example filename: "libgetrandom-fd8800939535fc59.rmeta" or "libmls_rs_uniffi.rlib".
-                        static REGEX: Lazy<Regex> = Lazy::new(|| {
+                        static REGEX: LazyLock<Regex> = LazyLock::new(|| {
                             Regex::new(r"^lib([^-]*)(?:-[0-9a-f]*)?.(rlib|so|rmeta)$").unwrap()
                         });
 
@@ -293,9 +346,17 @@ impl Crate {
                             } else {
                                 bail!("Unexpected extension for extern filename {}", filename);
                             };
+
+                        let lib_name = lib_name.as_str().to_string();
+                        let raw_name = if let Some(raw_name) = raw_names.get(&lib_name) {
+                            raw_name.to_owned()
+                        } else {
+                            lib_name.clone()
+                        };
                         out.externs.push(Extern {
                             name: name.to_string(),
-                            lib_name: lib_name.as_str().to_string(),
+                            lib_name,
+                            raw_name,
                             extern_type,
                         });
                     } else if arg != "proc_macro" {
@@ -353,6 +414,9 @@ impl Crate {
                 "--color" => {
                     arg_iter.next().unwrap();
                 }
+                "--check-cfg" => {
+                    arg_iter.next().unwrap();
+                }
                 _ if arg.starts_with("--error-format=") => {}
                 _ if arg.starts_with("--emit=") => {}
                 _ if arg.starts_with("--edition=") => {}
@@ -413,6 +477,8 @@ impl Crate {
         out.package_name.clone_from(&package_metadata.name);
         out.version = Some(package_metadata.version.clone());
         out.edition.clone_from(&package_metadata.edition);
+        out.license.clone_from(&package_metadata.license);
+        out.license_file.clone_from(&package_metadata.license_file);
 
         let output_filename = out.name.clone() + &extra_filename;
         if let Some(test_contents) = tests.get(&output_filename).and_then(|m| m.get(&out.main_src))
@@ -455,3 +521,19 @@ fn find_cargo_toml(src_path: &Path) -> Result<PathBuf> {
     }
     Ok(package_dir.to_path_buf())
 }
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn parse_args() {
+        assert_eq!(args_from_rustc_invocation("foo bar"), vec!["foo", "bar"]);
+        assert_eq!(args_from_rustc_invocation("  foo   bar "), vec!["foo", "bar"]);
+        assert_eq!(args_from_rustc_invocation("'foo' \"bar\""), vec!["foo", "bar"]);
+        assert_eq!(
+            args_from_rustc_invocation("'fo o' \" b ar\" ' baz '"),
+            vec!["fo o", " b ar", " baz "]
+        );
+    }
+}
diff --git a/tools/cargo_embargo/src/cargo/metadata.rs b/tools/cargo_embargo/src/cargo/metadata.rs
index ea4c95983..5f7ed388b 100644
--- a/tools/cargo_embargo/src/cargo/metadata.rs
+++ b/tools/cargo_embargo/src/cargo/metadata.rs
@@ -49,6 +49,8 @@ pub struct PackageMetadata {
     pub features: BTreeMap<String, Vec<String>>,
     pub id: String,
     pub targets: Vec<TargetMetadata>,
+    pub license: Option<String>,
+    pub license_file: Option<String>,
 }
 
 #[derive(Clone, Debug, Deserialize, Eq, PartialEq)]
@@ -107,7 +109,13 @@ pub enum TargetKind {
 pub fn parse_cargo_metadata_str(cargo_metadata: &str, cfg: &VariantConfig) -> Result<Vec<Crate>> {
     let metadata =
         serde_json::from_str(cargo_metadata).context("failed to parse cargo metadata")?;
-    parse_cargo_metadata(&metadata, &cfg.features, &cfg.extra_cfg, cfg.tests)
+    parse_cargo_metadata(
+        &metadata,
+        &cfg.features,
+        &cfg.extra_cfg,
+        cfg.tests,
+        &cfg.workspace_excludes,
+    )
 }
 
 fn parse_cargo_metadata(
@@ -115,10 +123,13 @@ fn parse_cargo_metadata(
     features: &Option<Vec<String>>,
     cfgs: &[String],
     include_tests: bool,
+    workspace_excludes: &[String],
 ) -> Result<Vec<Crate>> {
     let mut crates = Vec::new();
     for package in &metadata.packages {
-        if !metadata.workspace_members.contains(&package.id) {
+        if !metadata.workspace_members.contains(&package.id)
+            || workspace_excludes.contains(&package.name)
+        {
             continue;
         }
 
@@ -169,6 +180,8 @@ fn parse_cargo_metadata(
                     types: target.crate_types.clone(),
                     features: features_without_deps.clone(),
                     edition: package.edition.to_owned(),
+                    license: package.license.clone(),
+                    license_file: package.license_file.clone(),
                     package_dir: package_dir.clone(),
                     main_src: main_src.to_owned(),
                     target: target_triple.clone(),
@@ -193,6 +206,8 @@ fn parse_cargo_metadata(
                     types: vec![CrateType::Test],
                     features: features_without_deps.clone(),
                     edition: package.edition.to_owned(),
+                    license: package.license.clone(),
+                    license_file: package.license_file.clone(),
                     package_dir: package_dir.clone(),
                     main_src: main_src.to_owned(),
                     target: target_triple.clone(),
@@ -246,6 +261,7 @@ fn get_externs(
                 externs.push(Extern {
                     name: lib_name.clone(),
                     lib_name,
+                    raw_name: target.name.clone(),
                     extern_type: ExternType::Rust,
                 });
             }
@@ -267,6 +283,11 @@ fn make_extern(packages: &[PackageMetadata], dependency: &DependencyMetadata) ->
         bail!("Package {} didn't have any library or proc-macro targets", dependency.name);
     };
     let lib_name = target.name.replace('-', "_");
+    // This is ugly but looking at the source path is the easiest way to tell if the raw
+    // crate name uses a hyphen instead of an underscore. It won't work if it uses both.
+    let raw_name = target.name.replace('_', "-");
+    let src_path = target.src_path.to_str().expect("failed to convert src_path to string");
+    let raw_name = if src_path.contains(&raw_name) { raw_name } else { lib_name.clone() };
     let name =
         if let Some(rename) = &dependency.rename { rename.clone() } else { lib_name.clone() };
 
@@ -277,8 +298,7 @@ fn make_extern(packages: &[PackageMetadata], dependency: &DependencyMetadata) ->
         } else {
             ExternType::Rust
         };
-
-    Ok(Extern { name, lib_name, extern_type })
+    Ok(Extern { name, lib_name, raw_name, extern_type })
 }
 
 /// Given a Cargo package ID, returns the path.
@@ -516,11 +536,13 @@ mod tests {
                 Extern {
                     name: "alwayslib".to_string(),
                     lib_name: "alwayslib".to_string(),
+                    raw_name: "alwayslib".to_string(),
                     extern_type: ExternType::Rust
                 },
                 Extern {
                     name: "unixlib".to_string(),
                     lib_name: "unixlib".to_string(),
+                    raw_name: "unixlib".to_string(),
                     extern_type: ExternType::Rust
                 },
             ]
@@ -577,6 +599,7 @@ mod tests {
             vec![Extern {
                 name: "foolib".to_string(),
                 lib_name: "foolib".to_string(),
+                raw_name: "foolib".to_string(),
                 extern_type: ExternType::Rust
             },]
         );
@@ -638,11 +661,13 @@ mod tests {
                 Extern {
                     name: "bar".to_string(),
                     lib_name: "bar".to_string(),
+                    raw_name: "bar".to_string(),
                     extern_type: ExternType::Rust
                 },
                 Extern {
                     name: "foo2".to_string(),
                     lib_name: "foo".to_string(),
+                    raw_name: "foo".to_string(),
                     extern_type: ExternType::Rust
                 },
             ]
@@ -653,11 +678,13 @@ mod tests {
                 Extern {
                     name: "baz".to_string(),
                     lib_name: "bar".to_string(),
+                    raw_name: "bar".to_string(),
                     extern_type: ExternType::Rust
                 },
                 Extern {
                     name: "foo2".to_string(),
                     lib_name: "foo".to_string(),
+                    raw_name: "foo".to_string(),
                     extern_type: ExternType::Rust
                 },
             ]
diff --git a/tools/cargo_embargo/src/config.rs b/tools/cargo_embargo/src/config.rs
index e73feb039..e64eb6d75 100644
--- a/tools/cargo_embargo/src/config.rs
+++ b/tools/cargo_embargo/src/config.rs
@@ -376,11 +376,16 @@ pub struct PackageConfig {
     /// Patch file to apply after rules.mk is generated.
     #[serde(skip_serializing_if = "Option::is_none")]
     pub rulesmk_patch: Option<PathBuf>,
+    /// `license_text` to use for `license` module, overriding the `license_file` given by the
+    /// package or the default "LICENSE".
+    #[serde(skip_serializing_if = "Option::is_none")]
+    pub license_text: Option<String>,
 }
 
 impl PackageConfig {
     /// Names of all the fields on `PackageConfig`.
-    const FIELD_NAMES: [&'static str; 3] = ["add_toplevel_block", "patch", "rulesmk_patch"];
+    const FIELD_NAMES: [&'static str; 4] =
+        ["add_toplevel_block", "license_text", "patch", "rulesmk_patch"];
 }
 
 /// Options that apply to everything in a package (i.e. everything associated with a particular
@@ -397,6 +402,9 @@ pub struct PackageVariantConfig {
     /// Whether to compile for host. Defaults to true.
     #[serde(default = "default_true", skip_serializing_if = "is_true")]
     pub host_supported: bool,
+    /// Whether to compile for non-build host targets. Defaults to true.
+    #[serde(default = "default_true", skip_serializing_if = "is_true")]
+    pub host_cross_supported: bool,
     /// Add a `compile_multilib: "first"` property to host modules.
     #[serde(default, skip_serializing_if = "is_false")]
     pub host_first_multilib: bool,
@@ -440,6 +448,7 @@ impl Default for PackageVariantConfig {
             alloc: false,
             device_supported: true,
             host_supported: true,
+            host_cross_supported: true,
             host_first_multilib: false,
             force_rlib: false,
             no_presubmit: false,
diff --git a/tools/cargo_embargo/src/main.rs b/tools/cargo_embargo/src/main.rs
index bcb7a0810..93f837a7b 100644
--- a/tools/cargo_embargo/src/main.rs
+++ b/tools/cargo_embargo/src/main.rs
@@ -47,7 +47,6 @@ use clap::Subcommand;
 use log::debug;
 use nix::fcntl::OFlag;
 use nix::unistd::pipe2;
-use once_cell::sync::Lazy;
 use std::collections::BTreeMap;
 use std::collections::VecDeque;
 use std::env;
@@ -56,6 +55,7 @@ use std::io::{Read, Write};
 use std::path::Path;
 use std::path::PathBuf;
 use std::process::{Command, Stdio};
+use std::sync::LazyLock;
 use tempfile::tempdir;
 
 // Major TODOs
@@ -63,7 +63,7 @@ use tempfile::tempdir;
 //  * handle warnings. put them in comments in the android.bp, some kind of report section
 
 /// Rust modules which shouldn't use the default generated names, to avoid conflicts or confusion.
-pub static RENAME_MAP: Lazy<BTreeMap<&str, &str>> = Lazy::new(|| {
+pub static RENAME_MAP: LazyLock<BTreeMap<&str, &str>> = LazyLock::new(|| {
     [
         ("libash", "libash_rust"),
         ("libatomic", "libatomic_rust"),
@@ -87,7 +87,7 @@ pub static RENAME_MAP: Lazy<BTreeMap<&str, &str>> = Lazy::new(|| {
 /// generated automatically by this script. Examples include compiler builtins
 /// and other foundational libraries. It also tracks the location of rules.mk
 /// build files for crates that are not under external/rust/crates.
-pub static RULESMK_RENAME_MAP: Lazy<BTreeMap<&str, &str>> = Lazy::new(|| {
+pub static RULESMK_RENAME_MAP: LazyLock<BTreeMap<&str, &str>> = LazyLock::new(|| {
     [
         ("liballoc", "trusty/user/base/lib/liballoc-rust"),
         ("libcompiler_builtins", "trusty/user/base/lib/libcompiler_builtins-rust"),
@@ -429,10 +429,13 @@ fn write_all_build_files(
     Ok(())
 }
 
-/// Runs the given command, and returns its standard output and standard error as a string.
-fn run_cargo(cmd: &mut Command) -> Result<String> {
+/// Runs the given command, and returns its standard output and (optionally) standard error as a string.
+fn run_cargo(cmd: &mut Command, include_stderr: bool) -> Result<String> {
     let (pipe_read, pipe_write) = pipe2(OFlag::O_CLOEXEC)?;
-    cmd.stdout(pipe_write.try_clone()?).stderr(pipe_write).stdin(Stdio::null());
+    if include_stderr {
+        cmd.stderr(pipe_write.try_clone()?);
+    }
+    cmd.stdout(pipe_write).stdin(Stdio::null());
     debug!("Running: {:?}\n", cmd);
     let mut child = cmd.spawn()?;
 
@@ -469,7 +472,7 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
     let target_dir = intermediates_dir.join("target.tmp");
 
     // cargo clean
-    run_cargo(Command::new("cargo").arg("clean").arg("--target-dir").arg(&target_dir))
+    run_cargo(Command::new("cargo").arg("clean").arg("--target-dir").arg(&target_dir), true)
         .context("Running cargo clean")?;
 
     let default_target = "x86_64-unknown-linux-gnu";
@@ -504,6 +507,7 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
             .arg("--format-version")
             .arg("1")
             .args(&feature_args),
+        false,
     )
     .context("Running cargo metadata")?;
 
@@ -532,6 +536,7 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
                 .arg(&target_dir)
                 .args(&workspace_args)
                 .args(&feature_args),
+            true,
         )?;
 
         if cfg.tests {
@@ -545,6 +550,7 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
                     .arg(&target_dir)
                     .args(&workspace_args)
                     .args(&feature_args),
+                true,
             )?;
             // cargo test -- --list
             cargo_out += &run_cargo(
@@ -556,6 +562,7 @@ fn generate_cargo_out(cfg: &VariantConfig, intermediates_dir: &Path) -> Result<C
                     .args(&workspace_args)
                     .args(&feature_args)
                     .args(["--", "--list"]),
+                true,
             )?;
         }
     }
@@ -606,11 +613,11 @@ fn write_build_files(
     for (variant_index, variant_config) in cfg.variants.iter().enumerate() {
         let variant_crates = &crates[variant_index];
         let def = PackageVariantConfig::default();
-        let package_cfg = variant_config.package.get(package_name).unwrap_or(&def);
+        let package_variant_cfg = variant_config.package.get(package_name).unwrap_or(&def);
 
         // If `copy_out` is enabled and there are any generated out files for the package, copy them to
         // the appropriate directory.
-        if package_cfg.copy_out && !out_files[variant_index].is_empty() {
+        if package_variant_cfg.copy_out && !out_files[variant_index].is_empty() {
             let out_dir = package_dir.join("out");
             if !out_dir.exists() {
                 std::fs::create_dir(&out_dir).expect("failed to create out dir");
@@ -625,7 +632,7 @@ fn write_build_files(
         if variant_config.generate_androidbp {
             bp_contents += &generate_android_bp(
                 variant_config,
-                package_cfg,
+                package_variant_cfg,
                 package_name,
                 variant_crates,
                 &out_files[variant_index],
@@ -634,7 +641,7 @@ fn write_build_files(
         if variant_config.generate_rulesmk {
             mk_contents += &generate_rules_mk(
                 variant_config,
-                package_cfg,
+                package_variant_cfg,
                 package_name,
                 variant_crates,
                 &out_files[variant_index],
@@ -651,13 +658,13 @@ fn write_build_files(
     }
     if !bp_contents.is_empty() {
         let output_path = package_dir.join("Android.bp");
-        let bp_contents = "// This file is generated by cargo_embargo.\n".to_owned()
-            + "// Do not modify this file after the first \"rust_*\" or \"genrule\" module\n"
-            + "// because the changes will be overridden on upgrade.\n"
-            + "// Content before the first \"rust_*\" or \"genrule\" module is preserved.\n\n"
-            + read_license_header(&output_path)?.trim()
-            + "\n"
-            + &bp_contents;
+        let package_header = generate_android_bp_package_header(
+            package_name,
+            package_cfg,
+            read_license_header(&output_path)?.trim(),
+            crates,
+        )?;
+        let bp_contents = package_header + &bp_contents;
         write_format_android_bp(&output_path, &bp_contents, package_cfg.patch.as_deref())?;
     }
     if !mk_contents.is_empty() {
@@ -678,6 +685,80 @@ fn write_build_files(
     Ok(())
 }
 
+fn generate_android_bp_package_header(
+    package_name: &str,
+    package_cfg: &PackageConfig,
+    license_header: &str,
+    crates: &[Vec<Crate>],
+) -> Result<String> {
+    let crates = crates.iter().flatten().collect::<Vec<_>>();
+    if let Some(first) = crates.first() {
+        if let Some(license) = first.license.as_ref() {
+            if crates.iter().all(|c| c.license.as_ref() == Some(license)) {
+                let mut modules = Vec::new();
+                let license = choose_license(license);
+                let license_name = format!("external_rust_crates_{}_license", package_name);
+
+                let mut package_module = BpModule::new("package".to_string());
+                package_module.props.set("default_team", "trendy_team_android_rust");
+                package_module.props.set("default_applicable_licenses", vec![license_name.clone()]);
+                modules.push(package_module);
+
+                let mut license_module = BpModule::new("license".to_string());
+                license_module.props.set("name", license_name);
+                license_module.props.set("visibility", vec![":__subpackages__"]);
+                license_module
+                    .props
+                    .set("license_kinds", vec![format!("SPDX-license-identifier-{}", license)]);
+                let license_text = package_cfg
+                    .license_text
+                    .as_deref()
+                    .unwrap_or_else(|| first.license_file.as_deref().unwrap_or("LICENSE"))
+                    .to_string();
+                license_module.props.set("license_text", vec![license_text]);
+                modules.push(license_module);
+
+                let mut bp_contents = "// This file is generated by cargo_embargo.\n".to_owned()
+                + "// Do not modify this file because the changes will be overridden on upgrade.\n\n";
+                for m in modules {
+                    m.write(&mut bp_contents)?;
+                    bp_contents += "\n";
+                }
+                return Ok(bp_contents);
+            } else {
+                eprintln!("Crates have different licenses.");
+            }
+        }
+    }
+
+    Ok("// This file is generated by cargo_embargo.\n".to_owned()
+        + "// Do not modify this file after the first \"rust_*\" or \"genrule\" module\n"
+        + "// because the changes will be overridden on upgrade.\n"
+        + "// Content before the first \"rust_*\" or \"genrule\" module is preserved.\n\n"
+        + license_header
+        + "\n")
+}
+
+/// Given an SPDX license expression that may offer a choice between several licenses, choose one to
+/// use.
+fn choose_license(license: &str) -> &str {
+    match license {
+        "MIT OR Apache-2.0" => "Apache-2.0",
+        "Apache-2.0 OR MIT" => "Apache-2.0",
+        "MIT/Apache-2.0" => "Apache-2.0",
+        "Apache-2.0/MIT" => "Apache-2.0",
+        "Apache-2.0 or BSD-3-Clause" => "Apache-2.0",
+        "Zlib OR Apache-2.0 OR MIT" => "Apache-2.0",
+        "MIT OR LGPL-3.0-or-later" => "MIT",
+        "Apache-2.0 / MIT" => "Apache-2.0",
+        "Unlicense OR MIT" => "MIT",
+        "BSD-3-Clause OR MIT OR Apache-2.0" => "Apache-2.0",
+        "BSD-2-Clause OR Apache-2.0 OR MIT" => "Apache-2.0",
+        "Apache-2.0 WITH LLVM-exception OR Apache-2.0 OR MIT" => "Apache-2.0",
+        _ => license,
+    }
+}
+
 /// Generates and returns a Soong Blueprint for the given set of crates, for a single variant of a
 /// package.
 fn generate_android_bp(
@@ -735,7 +816,7 @@ fn generate_android_bp(
     modules.sort();
     modules.dedup();
 
-    modules.sort_by_key(|m| m.props.get_string("name").to_string());
+    modules.sort_by_key(|m| m.props.get_string("name").unwrap().to_string());
     for m in modules {
         m.write(&mut bp_contents)?;
         bp_contents += "\n";
@@ -928,6 +1009,18 @@ fn crate_to_bp_modules(
             m.props.set("host_supported", true);
         }
 
+        if module_type != "rust_proc_macro" {
+            if package_cfg.host_supported && !package_cfg.host_cross_supported {
+                m.props.set("host_cross_supported", false);
+            } else if crate_.externs.iter().any(|extern_dep| extern_dep.name == "proc_macro2") {
+                // proc_macro2 is host_cross_supported: false.
+                // If there's a dependency on it, then we shouldn't build for HostCross.
+                m.props.set("host_cross_supported", false);
+            } else if crate_.package_name == "proc-macro2" {
+                m.props.set("host_cross_supported", false);
+            }
+        }
+
         if !crate_type.is_test() && package_cfg.host_supported && package_cfg.host_first_multilib {
             m.props.set("compile_multilib", "first");
         }
@@ -1117,8 +1210,10 @@ fn crate_to_rulesmk(
         contents += "\n";
     }
 
-    // crate dependencies without lib- prefix
-    let mut library_deps: Vec<_> = crate_.externs.iter().map(|dep| dep.lib_name.clone()).collect();
+    // crate dependencies without lib- prefix. Since paths to trusty modules may
+    // contain hyphens, we generate the module path using the raw name output by
+    // cargo metadata or cargo build.
+    let mut library_deps: Vec<_> = crate_.externs.iter().map(|dep| dep.raw_name.clone()).collect();
     if package_cfg.no_std {
         contents += "MODULE_ADD_IMPLICIT_DEPS := false\n";
         library_deps.push("compiler_builtins".to_string());
@@ -1160,9 +1255,10 @@ fn crate_to_rulesmk(
             )
         })
         .map(|dep| {
-            // Rewrite dependency name to module path for Trusty build system
+            // Rewrite dependency name so it is passed to the FIND_CRATE macro
+            // which will expand to the module path when building Trusty.
             if let Some(dep) = dep.strip_prefix("lib") {
-                format!("external/rust/crates/{dep}")
+                format!("$(call FIND_CRATE,{dep})")
             } else {
                 dep
             }
@@ -1247,7 +1343,11 @@ mod tests {
             assert_eq!(module_by_package.len(), 1);
             let crates = module_by_package.into_values().next().unwrap();
 
-            let mut output = String::new();
+            let package_name = &crates[0][0].package_name;
+            let def = PackageConfig::default();
+            let package_cfg = cfg.package.get(package_name).unwrap_or(&def);
+            let mut output =
+                generate_android_bp_package_header(package_name, package_cfg, "", &crates).unwrap();
             for (variant_index, variant_cfg) in cfg.variants.iter().enumerate() {
                 let variant_crates = &crates[variant_index];
                 let package_name = &variant_crates[0].package_name;
diff --git a/tools/cargo_embargo/testdata/aho-corasick/crates.json b/tools/cargo_embargo/testdata/aho-corasick/crates.json
index ac8a0bff5..092440bd4 100644
--- a/tools/cargo_embargo/testdata/aho-corasick/crates.json
+++ b/tools/cargo_embargo/testdata/aho-corasick/crates.json
@@ -9,7 +9,12 @@
       "features": ["default", "std"],
       "cfgs": [],
       "externs": [
-        { "name": "memchr", "lib_name": "memchr", "extern_type": "Rust" }
+        {
+          "name": "memchr",
+          "lib_name": "memchr",
+          "raw_name": "memchr",
+          "extern_type": "Rust"
+        }
       ],
       "codegens": [],
       "cap_lints": "",
@@ -18,6 +23,8 @@
       "edition": "2018",
       "package_dir": "/usr/local/google/home/qwandor/aosp/external/rust/crates/aho-corasick",
       "main_src": "src/lib.rs",
+      "license": "Unlicense OR MIT",
+      "license_file": null,
       "empty_test": false
     },
     {
@@ -29,7 +36,12 @@
       "features": ["default", "std"],
       "cfgs": [],
       "externs": [
-        { "name": "memchr", "lib_name": "memchr", "extern_type": "Rust" }
+        {
+          "name": "memchr",
+          "lib_name": "memchr",
+          "raw_name": "memchr",
+          "extern_type": "Rust"
+        }
       ],
       "codegens": [],
       "cap_lints": "",
@@ -38,6 +50,8 @@
       "edition": "2018",
       "package_dir": "/usr/local/google/home/qwandor/aosp/external/rust/crates/aho-corasick",
       "main_src": "src/lib.rs",
+      "license": "Unlicense OR MIT",
+      "license_file": null,
       "empty_test": false
     }
   ]
diff --git a/tools/cargo_embargo/testdata/aho-corasick/expected_Android.bp b/tools/cargo_embargo/testdata/aho-corasick/expected_Android.bp
index f16d7a414..dda00c5d7 100644
--- a/tools/cargo_embargo/testdata/aho-corasick/expected_Android.bp
+++ b/tools/cargo_embargo/testdata/aho-corasick/expected_Android.bp
@@ -1,3 +1,18 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file because the changes will be overridden on upgrade.
+
+package {
+default_applicable_licenses: ["external_rust_crates_aho-corasick_license"],
+default_team: "trendy_team_android_rust",
+}
+
+license {
+name: "external_rust_crates_aho-corasick_license",
+visibility: [":__subpackages__"],
+license_kinds: ["SPDX-license-identifier-MIT"],
+license_text: ["LICENSE"],
+}
+
 rust_test {
 name: "aho-corasick_test_src_lib",
 host_supported: true,
diff --git a/tools/cargo_embargo/testdata/async-trait/crates.json b/tools/cargo_embargo/testdata/async-trait/crates.json
index be4411b12..6434f82fd 100644
--- a/tools/cargo_embargo/testdata/async-trait/crates.json
+++ b/tools/cargo_embargo/testdata/async-trait/crates.json
@@ -12,10 +12,21 @@
         {
           "name": "proc_macro2",
           "lib_name": "proc_macro2",
+          "raw_name": "proc-macro2",
           "extern_type": "Rust"
         },
-        { "name": "quote", "lib_name": "quote", "extern_type": "Rust" },
-        { "name": "syn", "lib_name": "syn", "extern_type": "Rust" }
+        {
+          "name": "quote",
+          "lib_name": "quote",
+          "raw_name": "quote",
+          "extern_type": "Rust"
+        },
+        {
+          "name": "syn",
+          "lib_name": "syn",
+          "raw_name": "syn",
+          "extern_type": "Rust"
+        }
       ],
       "codegens": [],
       "cap_lints": "",
@@ -24,6 +35,8 @@
       "edition": "2021",
       "package_dir": "/usr/local/google/home/qwandor/aosp/external/rust/crates/async-trait",
       "main_src": "src/lib.rs",
+      "license": "MIT OR Apache-2.0",
+      "license_file": null,
       "empty_test": false
     }
   ]
diff --git a/tools/cargo_embargo/testdata/async-trait/expected_Android.bp b/tools/cargo_embargo/testdata/async-trait/expected_Android.bp
index 88433ac32..480871be8 100644
--- a/tools/cargo_embargo/testdata/async-trait/expected_Android.bp
+++ b/tools/cargo_embargo/testdata/async-trait/expected_Android.bp
@@ -1,3 +1,18 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file because the changes will be overridden on upgrade.
+
+package {
+default_applicable_licenses: ["external_rust_crates_async-trait_license"],
+default_team: "trendy_team_android_rust",
+}
+
+license {
+name: "external_rust_crates_async-trait_license",
+visibility: [":__subpackages__"],
+license_kinds: ["SPDX-license-identifier-Apache-2.0"],
+license_text: ["LICENSE"],
+}
+
 rust_proc_macro {
 name: "libasync_trait",
 crate_name: "async_trait",
diff --git a/tools/cargo_embargo/testdata/either/crates.json b/tools/cargo_embargo/testdata/either/crates.json
index d63b1b5de..546fe4e84 100644
--- a/tools/cargo_embargo/testdata/either/crates.json
+++ b/tools/cargo_embargo/testdata/either/crates.json
@@ -16,6 +16,8 @@
       "edition": "2018",
       "package_dir": ".../external/rust/crates/either",
       "main_src": "src/lib.rs",
+      "license": "MIT OR Apache-2.0",
+      "license_file": null,
       "empty_test": false
     },
     {
@@ -30,6 +32,7 @@
         {
           "name": "serde_json",
           "lib_name": "serde_json",
+          "raw_name": "serde_json",
           "extern_type": "Rust"
         }
       ],
@@ -40,6 +43,8 @@
       "edition": "2018",
       "package_dir": ".../external/rust/crates/either",
       "main_src": "src/lib.rs",
+      "license": "MIT OR Apache-2.0",
+      "license_file": null,
       "empty_test": false
     }
   ]
diff --git a/tools/cargo_embargo/testdata/either/expected_Android.bp b/tools/cargo_embargo/testdata/either/expected_Android.bp
index cf58a2c00..a212a6d7c 100644
--- a/tools/cargo_embargo/testdata/either/expected_Android.bp
+++ b/tools/cargo_embargo/testdata/either/expected_Android.bp
@@ -1,3 +1,18 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file because the changes will be overridden on upgrade.
+
+package {
+default_applicable_licenses: ["external_rust_crates_either_license"],
+default_team: "trendy_team_android_rust",
+}
+
+license {
+name: "external_rust_crates_either_license",
+visibility: [":__subpackages__"],
+license_kinds: ["SPDX-license-identifier-Apache-2.0"],
+license_text: ["LICENSE"],
+}
+
 rust_test {
 name: "either_test_src_lib",
 host_supported: true,
diff --git a/tools/cargo_embargo/testdata/plotters/crates.json b/tools/cargo_embargo/testdata/plotters/crates.json
index 801b1fabe..b0f486ccc 100644
--- a/tools/cargo_embargo/testdata/plotters/crates.json
+++ b/tools/cargo_embargo/testdata/plotters/crates.json
@@ -12,16 +12,19 @@
         {
           "name": "num_traits",
           "lib_name": "num_traits",
+          "raw_name": "num-traits",
           "extern_type": "Rust"
         },
         {
           "name": "plotters_backend",
           "lib_name": "plotters_backend",
+          "raw_name": "plotters-backend",
           "extern_type": "Rust"
         },
         {
           "name": "plotters_svg",
           "lib_name": "plotters_svg",
+          "raw_name": "plotters-svg",
           "extern_type": "Rust"
         }
       ],
@@ -32,6 +35,8 @@
       "edition": "2018",
       "package_dir": ".../external/rust/crates/plotters",
       "main_src": "src/lib.rs",
+      "license": "MIT",
+      "license_file": null,
       "empty_test": false
     }
   ]
diff --git a/tools/cargo_embargo/testdata/plotters/expected_Android.bp b/tools/cargo_embargo/testdata/plotters/expected_Android.bp
index 4a2c394f7..7f1007d27 100644
--- a/tools/cargo_embargo/testdata/plotters/expected_Android.bp
+++ b/tools/cargo_embargo/testdata/plotters/expected_Android.bp
@@ -1,3 +1,18 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file because the changes will be overridden on upgrade.
+
+package {
+default_applicable_licenses: ["external_rust_crates_plotters_license"],
+default_team: "trendy_team_android_rust",
+}
+
+license {
+name: "external_rust_crates_plotters_license",
+visibility: [":__subpackages__"],
+license_kinds: ["SPDX-license-identifier-MIT"],
+license_text: ["LICENSE"],
+}
+
 rust_library {
 name: "libplotters",
 host_supported: true,
diff --git a/tools/cargo_embargo/testdata/rustc-demangle-capi/crates.json b/tools/cargo_embargo/testdata/rustc-demangle-capi/crates.json
index f240a8775..2a3430801 100644
--- a/tools/cargo_embargo/testdata/rustc-demangle-capi/crates.json
+++ b/tools/cargo_embargo/testdata/rustc-demangle-capi/crates.json
@@ -12,6 +12,7 @@
         {
           "name": "rustc_demangle",
           "lib_name": "rustc_demangle",
+          "raw_name": "rustc-demangle",
           "extern_type": "Rust"
         }
       ],
@@ -22,6 +23,8 @@
       "edition": "2015",
       "package_dir": "/usr/local/google/home/qwandor/aosp/external/rust/crates/rustc-demangle-capi",
       "main_src": "src/lib.rs",
+      "license": "MIT/Apache-2.0",
+      "license_file": null,
       "empty_test": false
     },
     {
@@ -36,6 +39,7 @@
         {
           "name": "rustc_demangle",
           "lib_name": "rustc_demangle",
+          "raw_name": "rustc-demangle",
           "extern_type": "Rust"
         }
       ],
@@ -46,6 +50,8 @@
       "edition": "2015",
       "package_dir": "/usr/local/google/home/qwandor/aosp/external/rust/crates/rustc-demangle-capi",
       "main_src": "src/lib.rs",
+      "license": "MIT/Apache-2.0",
+      "license_file": null,
       "empty_test": false
     }
   ]
diff --git a/tools/cargo_embargo/testdata/rustc-demangle-capi/expected_Android.bp b/tools/cargo_embargo/testdata/rustc-demangle-capi/expected_Android.bp
index 9c633e4a3..8ef8a1516 100644
--- a/tools/cargo_embargo/testdata/rustc-demangle-capi/expected_Android.bp
+++ b/tools/cargo_embargo/testdata/rustc-demangle-capi/expected_Android.bp
@@ -1,3 +1,18 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file because the changes will be overridden on upgrade.
+
+package {
+default_applicable_licenses: ["external_rust_crates_rustc-demangle-capi_license"],
+default_team: "trendy_team_android_rust",
+}
+
+license {
+name: "external_rust_crates_rustc-demangle-capi_license",
+visibility: [":__subpackages__"],
+license_kinds: ["SPDX-license-identifier-Apache-2.0"],
+license_text: ["LICENSE"],
+}
+
 rust_ffi_static {
 name: "librustc_demangle_static",
 host_supported: true,
diff --git a/tools/external_crates/.gitignore b/tools/external_crates/.gitignore
index 2f7896d1d..2c96eb1b6 100644
--- a/tools/external_crates/.gitignore
+++ b/tools/external_crates/.gitignore
@@ -1 +1,2 @@
 target/
+Cargo.lock
diff --git a/tools/external_crates/Cargo.lock b/tools/external_crates/Cargo.lock
deleted file mode 100644
index a978d8902..000000000
--- a/tools/external_crates/Cargo.lock
+++ /dev/null
@@ -1,3035 +0,0 @@
-# This file is automatically @generated by Cargo.
-# It is not intended for manual editing.
-version = 3
-
-[[package]]
-name = "adler"
-version = "1.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f26201604c87b1e01bd3d98f8d5d9a8fcbb815e8cedb41ffccbeb4bf593a35fe"
-
-[[package]]
-name = "ahash"
-version = "0.8.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e89da841a80418a9b391ebaea17f5c112ffaaa96f621d2c285b5174da76b9011"
-dependencies = [
- "cfg-if",
- "getrandom",
- "once_cell",
- "version_check",
- "zerocopy",
-]
-
-[[package]]
-name = "aho-corasick"
-version = "1.1.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8e60d3430d3a69478ad0993f19238d2df97c507009a52b3c10addcd7f6bcb916"
-dependencies = [
- "memchr",
-]
-
-[[package]]
-name = "anstream"
-version = "0.6.13"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d96bd03f33fe50a863e394ee9718a706f988b9079b20c3784fb726e7678b62fb"
-dependencies = [
- "anstyle",
- "anstyle-parse",
- "anstyle-query",
- "anstyle-wincon",
- "colorchoice",
- "utf8parse",
-]
-
-[[package]]
-name = "anstyle"
-version = "1.0.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8901269c6307e8d93993578286ac0edf7f195079ffff5ebdeea6a59ffb7e36bc"
-
-[[package]]
-name = "anstyle-parse"
-version = "0.2.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c75ac65da39e5fe5ab759307499ddad880d724eed2f6ce5b5e8a26f4f387928c"
-dependencies = [
- "utf8parse",
-]
-
-[[package]]
-name = "anstyle-query"
-version = "1.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e28923312444cdd728e4738b3f9c9cac739500909bb3d3c94b43551b16517648"
-dependencies = [
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "anstyle-wincon"
-version = "3.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1cd54b81ec8d6180e24654d0b371ad22fc3dd083b6ff8ba325b72e00c87660a7"
-dependencies = [
- "anstyle",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "anyhow"
-version = "1.0.81"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "0952808a6c2afd1aa8947271f3a60f1a6763c7b912d210184c5149b5cf147247"
-
-[[package]]
-name = "arc-swap"
-version = "1.7.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "69f7f8c3906b62b754cd5326047894316021dcfe5a194c8ea52bdd94934a3457"
-
-[[package]]
-name = "arrayvec"
-version = "0.5.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "23b62fc65de8e4e7f52534fb52b0f3ed04746ae267519eef2a83941e8085068b"
-
-[[package]]
-name = "autocfg"
-version = "1.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f1fdabc7756949593fe60f30ec81974b613357de856987752631dea1e3394c80"
-
-[[package]]
-name = "base16ct"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4c7f02d4ea65f2c1853089ffd8d2787bdbc63de2f0d29dedbcf8ccdfa0ccd4cf"
-
-[[package]]
-name = "base64"
-version = "0.21.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9d297deb1925b89f2ccc13d7635fa0714f12c87adce1c75356b39ca9b7178567"
-
-[[package]]
-name = "base64ct"
-version = "1.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8c3c1a368f70d6cf7302d78f8f7093da241fb8e8807c05cc9e51a125895a6d5b"
-
-[[package]]
-name = "bitflags"
-version = "1.3.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bef38d45163c2f1dde094a7dfd33ccf595c92905c8f8f4fdc18d06fb1037718a"
-
-[[package]]
-name = "bitflags"
-version = "2.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cf4b9d6a944f767f8e5e0db018570623c85f3d925ac718db4e06d0187adb21c1"
-
-[[package]]
-name = "bitmaps"
-version = "2.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "031043d04099746d8db04daf1fa424b2bc8bd69d92b25962dcde24da39ab64a2"
-dependencies = [
- "typenum",
-]
-
-[[package]]
-name = "block-buffer"
-version = "0.10.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3078c7629b62d3f0439517fa394996acacc5cbc91c5a20d8c658e77abd503a71"
-dependencies = [
- "generic-array",
-]
-
-[[package]]
-name = "bstr"
-version = "1.9.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "05efc5cfd9110c8416e471df0e96702d58690178e206e61b7173706673c93706"
-dependencies = [
- "memchr",
- "regex-automata",
- "serde",
-]
-
-[[package]]
-name = "btoi"
-version = "0.4.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9dd6407f73a9b8b6162d8a2ef999fe6afd7cc15902ebf42c5cd296addf17e0ad"
-dependencies = [
- "num-traits",
-]
-
-[[package]]
-name = "bumpalo"
-version = "3.16.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "79296716171880943b8470b5f8d03aa55eb2e645a4874bdbb28adb49162e012c"
-
-[[package]]
-name = "bytes"
-version = "1.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "514de17de45fdb8dc022b1a7975556c53c86f9f0aa5f534b98977b171857c2c9"
-
-[[package]]
-name = "bytesize"
-version = "1.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a3e368af43e418a04d52505cf3dbc23dda4e3407ae2fa99fd0e4f308ce546acc"
-
-[[package]]
-name = "cargo"
-version = "0.73.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "77a6fe1f5394d14b81d2f3f605832a3ce35ed0bf120bc7ef437ce27fd4929c6a"
-dependencies = [
- "anyhow",
- "base64",
- "bytesize",
- "cargo-platform",
- "cargo-util",
- "clap",
- "crates-io",
- "curl",
- "curl-sys",
- "env_logger",
- "filetime",
- "flate2",
- "fwdansi",
- "git2",
- "git2-curl",
- "gix",
- "gix-features",
- "glob",
- "hex",
- "hmac",
- "home",
- "http-auth",
- "humantime",
- "ignore",
- "im-rc",
- "indexmap 1.9.3",
- "itertools 0.10.5",
- "jobserver",
- "lazycell",
- "libc",
- "libgit2-sys",
- "log",
- "memchr",
- "opener",
- "os_info",
- "pasetors",
- "pathdiff",
- "pulldown-cmark",
- "rand",
- "rustfix",
- "semver",
- "serde",
- "serde-value",
- "serde_ignored",
- "serde_json",
- "sha1",
- "shell-escape",
- "strip-ansi-escapes",
- "syn",
- "tar",
- "tempfile",
- "termcolor",
- "time",
- "toml",
- "toml_edit",
- "unicode-width",
- "unicode-xid",
- "url",
- "walkdir",
- "windows-sys 0.48.0",
-]
-
-[[package]]
-name = "cargo-platform"
-version = "0.1.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "24b1f0365a6c6bb4020cd05806fd0d33c44d38046b8bd7f0e40814b9763cabfc"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "cargo-util"
-version = "0.2.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9f2d9a9a8d3e0b61b1110c49ab8f6ed7a76ce4f2b1d53ae48a83152d3d5e8f5b"
-dependencies = [
- "anyhow",
- "core-foundation",
- "filetime",
- "hex",
- "ignore",
- "jobserver",
- "libc",
- "miow",
- "same-file",
- "sha2",
- "shell-escape",
- "tempfile",
- "tracing",
- "walkdir",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "cc"
-version = "1.0.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2678b2e3449475e95b0aa6f9b506a28e61b3dc8996592b983695e8ebb58a8b41"
-dependencies = [
- "jobserver",
- "libc",
-]
-
-[[package]]
-name = "cfg-if"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "baf1de4339761588bc0619e3cbc0120ee582ebb74b53b4efbf79117bd2da40fd"
-
-[[package]]
-name = "clap"
-version = "4.5.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "90bc066a67923782aa8515dbaea16946c5bcc5addbd668bb80af688e53e548a0"
-dependencies = [
- "clap_builder",
- "clap_derive",
-]
-
-[[package]]
-name = "clap_builder"
-version = "4.5.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ae129e2e766ae0ec03484e609954119f123cc1fe650337e155d03b022f24f7b4"
-dependencies = [
- "anstream",
- "anstyle",
- "clap_lex",
- "strsim",
- "terminal_size",
-]
-
-[[package]]
-name = "clap_derive"
-version = "4.5.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "528131438037fd55894f62d6e9f068b8f45ac57ffa77517819645d10aed04f64"
-dependencies = [
- "heck",
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "clap_lex"
-version = "0.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "98cc8fbded0c607b7ba9dd60cd98df59af97e84d24e49c8557331cfc26d301ce"
-
-[[package]]
-name = "clru"
-version = "0.6.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b8191fa7302e03607ff0e237d4246cc043ff5b3cb9409d995172ba3bea16b807"
-
-[[package]]
-name = "colorchoice"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "acbf1af155f9b9ef647e42cdc158db4b64a1b61f743629225fde6f3e0be2a7c7"
-
-[[package]]
-name = "const-oid"
-version = "0.9.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c2459377285ad874054d797f3ccebf984978aa39129f6eafde5cdc8315b612f8"
-
-[[package]]
-name = "core-foundation"
-version = "0.9.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "91e195e091a93c46f7102ec7818a2aa394e1e1771c3ab4825963fa03e45afb8f"
-dependencies = [
- "core-foundation-sys",
- "libc",
-]
-
-[[package]]
-name = "core-foundation-sys"
-version = "0.8.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "06ea2b9bc92be3c2baa9334a323ebca2d6f074ff852cd1d7b11064035cd3868f"
-
-[[package]]
-name = "cpufeatures"
-version = "0.2.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "53fe5e26ff1b7aef8bca9c6080520cfb8d9333c7568e1829cef191a9723e5504"
-dependencies = [
- "libc",
-]
-
-[[package]]
-name = "crate_health"
-version = "0.1.0"
-dependencies = [
- "anyhow",
- "cargo",
- "clap",
- "crate_health_proc_macros",
- "glob",
- "itertools 0.11.0",
- "num_cpus",
- "semver",
- "serde",
- "serde_json",
- "tempfile",
- "thiserror",
- "threadpool",
- "tinytemplate",
- "walkdir",
- "whoami",
-]
-
-[[package]]
-name = "crate_health_proc_macros"
-version = "0.1.0"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "crates-io"
-version = "0.37.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "876aa69b4afca5f2eb5e23daa3445930faf829bcb67075a20ffa884f11f8c57c"
-dependencies = [
- "anyhow",
- "curl",
- "percent-encoding",
- "serde",
- "serde_json",
- "url",
-]
-
-[[package]]
-name = "crc32fast"
-version = "1.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b3855a8a784b474f333699ef2bbca9db2c4a1f6d9088a90a2d25b1eb53111eaa"
-dependencies = [
- "cfg-if",
-]
-
-[[package]]
-name = "crossbeam-channel"
-version = "0.5.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ab3db02a9c5b5121e1e42fbdb1aeb65f5e02624cc58c43f2884c6ccac0b82f95"
-dependencies = [
- "crossbeam-utils",
-]
-
-[[package]]
-name = "crossbeam-deque"
-version = "0.8.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "613f8cc01fe9cf1a3eb3d7f488fd2fa8388403e97039e2f73692932e291a770d"
-dependencies = [
- "crossbeam-epoch",
- "crossbeam-utils",
-]
-
-[[package]]
-name = "crossbeam-epoch"
-version = "0.9.18"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5b82ac4a3c2ca9c3460964f020e1402edd5753411d7737aa39c3714ad1b5420e"
-dependencies = [
- "crossbeam-utils",
-]
-
-[[package]]
-name = "crossbeam-utils"
-version = "0.8.19"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "248e3bacc7dc6baa3b21e405ee045c3047101a49145e7e9eca583ab4c2ca5345"
-
-[[package]]
-name = "crypto-bigint"
-version = "0.5.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "0dc92fb57ca44df6db8059111ab3af99a63d5d0f8375d9972e319a379c6bab76"
-dependencies = [
- "generic-array",
- "rand_core",
- "subtle",
- "zeroize",
-]
-
-[[package]]
-name = "crypto-common"
-version = "0.1.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1bfb12502f3fc46cca1bb51ac28df9d618d813cdc3d2f25b9fe775a34af26bb3"
-dependencies = [
- "generic-array",
- "typenum",
-]
-
-[[package]]
-name = "ct-codecs"
-version = "1.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f3b7eb4404b8195a9abb6356f4ac07d8ba267045c8d6d220ac4dc992e6cc75df"
-
-[[package]]
-name = "curl"
-version = "0.4.46"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1e2161dd6eba090ff1594084e95fd67aeccf04382ffea77999ea94ed42ec67b6"
-dependencies = [
- "curl-sys",
- "libc",
- "openssl-probe",
- "openssl-sys",
- "schannel",
- "socket2",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "curl-sys"
-version = "0.4.72+curl-8.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "29cbdc8314c447d11e8fd156dcdd031d9e02a7a976163e396b548c03153bc9ea"
-dependencies = [
- "cc",
- "libc",
- "libnghttp2-sys",
- "libz-sys",
- "openssl-sys",
- "pkg-config",
- "vcpkg",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "der"
-version = "0.7.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f55bf8e7b65898637379c1b74eb1551107c8294ed26d855ceb9fd1a09cfc9bc0"
-dependencies = [
- "const-oid",
- "pem-rfc7468",
- "zeroize",
-]
-
-[[package]]
-name = "deranged"
-version = "0.3.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b42b6fa04a440b495c8b04d0e71b707c585f83cb9cb28cf8cd0d976c315e31b4"
-dependencies = [
- "powerfmt",
-]
-
-[[package]]
-name = "digest"
-version = "0.10.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9ed9a281f7bc9b7576e61468ba615a66a5c8cfdff42420a70aa82701a3b1e292"
-dependencies = [
- "block-buffer",
- "const-oid",
- "crypto-common",
- "subtle",
-]
-
-[[package]]
-name = "dunce"
-version = "1.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "56ce8c6da7551ec6c462cbaf3bfbc75131ebbfa1c944aeaa9dab51ca1c5f0c3b"
-
-[[package]]
-name = "ecdsa"
-version = "0.16.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ee27f32b5c5292967d2d4a9d7f1e0b0aed2c15daded5a60300e4abb9d8020bca"
-dependencies = [
- "der",
- "digest",
- "elliptic-curve",
- "rfc6979",
- "signature",
- "spki",
-]
-
-[[package]]
-name = "ed25519-compact"
-version = "2.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e9b3460f44bea8cd47f45a0c70892f1eff856d97cd55358b2f73f663789f6190"
-dependencies = [
- "getrandom",
-]
-
-[[package]]
-name = "either"
-version = "1.10.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "11157ac094ffbdde99aa67b23417ebdd801842852b500e395a45a9c0aac03e4a"
-
-[[package]]
-name = "elliptic-curve"
-version = "0.13.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b5e6043086bf7973472e0c7dff2142ea0b680d30e18d9cc40f267efbf222bd47"
-dependencies = [
- "base16ct",
- "crypto-bigint",
- "digest",
- "ff",
- "generic-array",
- "group",
- "hkdf",
- "pem-rfc7468",
- "pkcs8",
- "rand_core",
- "sec1",
- "subtle",
- "zeroize",
-]
-
-[[package]]
-name = "env_logger"
-version = "0.10.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4cd405aab171cb85d6735e5c8d9db038c17d3ca007a4d2c25f337935c3d90580"
-dependencies = [
- "humantime",
- "is-terminal",
- "log",
- "regex",
- "termcolor",
-]
-
-[[package]]
-name = "equivalent"
-version = "1.0.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5443807d6dff69373d433ab9ef5378ad8df50ca6298caf15de6e52e24aaf54d5"
-
-[[package]]
-name = "errno"
-version = "0.3.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a258e46cdc063eb8519c00b9fc845fc47bcfca4130e2f08e88665ceda8474245"
-dependencies = [
- "libc",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "faster-hex"
-version = "0.8.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "239f7bfb930f820ab16a9cd95afc26f88264cf6905c960b340a615384aa3338a"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "fastrand"
-version = "2.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "658bd65b1cf4c852a3cc96f18a8ce7b5640f6b703f905c7d74532294c2a63984"
-
-[[package]]
-name = "ff"
-version = "0.13.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ded41244b729663b1e574f1b4fb731469f69f79c17667b5d776b16cda0479449"
-dependencies = [
- "rand_core",
- "subtle",
-]
-
-[[package]]
-name = "fiat-crypto"
-version = "0.2.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c007b1ae3abe1cb6f85a16305acd418b7ca6343b953633fee2b76d8f108b830f"
-
-[[package]]
-name = "filetime"
-version = "0.2.23"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1ee447700ac8aa0b2f2bd7bc4462ad686ba06baa6727ac149a2d6277f0d240fd"
-dependencies = [
- "cfg-if",
- "libc",
- "redox_syscall",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "flate2"
-version = "1.0.28"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "46303f565772937ffe1d394a4fac6f411c6013172fadde9dcdb1e147a086940e"
-dependencies = [
- "crc32fast",
- "libz-sys",
- "miniz_oxide",
-]
-
-[[package]]
-name = "form_urlencoded"
-version = "1.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e13624c2627564efccf4934284bdd98cbaa14e79b0b5a141218e507b3a823456"
-dependencies = [
- "percent-encoding",
-]
-
-[[package]]
-name = "fwdansi"
-version = "1.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "08c1f5787fe85505d1f7777268db5103d80a7a374d2316a7ce262e57baf8f208"
-dependencies = [
- "memchr",
- "termcolor",
-]
-
-[[package]]
-name = "generic-array"
-version = "0.14.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "85649ca51fd72272d7821adaf274ad91c288277713d9c18820d8499a7ff69e9a"
-dependencies = [
- "typenum",
- "version_check",
- "zeroize",
-]
-
-[[package]]
-name = "getrandom"
-version = "0.2.14"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "94b22e06ecb0110981051723910cbf0b5f5e09a2062dd7663334ee79a9d1286c"
-dependencies = [
- "cfg-if",
- "js-sys",
- "libc",
- "wasi",
- "wasm-bindgen",
-]
-
-[[package]]
-name = "git2"
-version = "0.17.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7b989d6a7ca95a362cf2cfc5ad688b3a467be1f87e480b8dad07fee8c79b0044"
-dependencies = [
- "bitflags 1.3.2",
- "libc",
- "libgit2-sys",
- "log",
- "openssl-probe",
- "openssl-sys",
- "url",
-]
-
-[[package]]
-name = "git2-curl"
-version = "0.18.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f8f8b7432b72928cff76f69e59ed5327f94a52763731e71274960dee72fe5f8c"
-dependencies = [
- "curl",
- "git2",
- "log",
- "url",
-]
-
-[[package]]
-name = "gix"
-version = "0.45.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bf2a03ec66ee24d1b2bae3ab718f8d14f141613810cb7ff6756f7db667f1cd82"
-dependencies = [
- "gix-actor",
- "gix-attributes",
- "gix-commitgraph",
- "gix-config",
- "gix-credentials",
- "gix-date",
- "gix-diff",
- "gix-discover",
- "gix-features",
- "gix-fs",
- "gix-glob",
- "gix-hash",
- "gix-hashtable",
- "gix-ignore",
- "gix-index",
- "gix-lock",
- "gix-mailmap",
- "gix-negotiate",
- "gix-object",
- "gix-odb",
- "gix-pack",
- "gix-path",
- "gix-prompt",
- "gix-protocol",
- "gix-ref",
- "gix-refspec",
- "gix-revision",
- "gix-sec",
- "gix-tempfile",
- "gix-transport",
- "gix-traverse",
- "gix-url",
- "gix-utils",
- "gix-validate",
- "gix-worktree",
- "log",
- "once_cell",
- "prodash",
- "signal-hook",
- "smallvec",
- "thiserror",
- "unicode-normalization",
-]
-
-[[package]]
-name = "gix-actor"
-version = "0.21.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9fe73f9f6be1afbf1bd5be919a9636fa560e2f14d42262a934423ed6760cd838"
-dependencies = [
- "bstr",
- "btoi",
- "gix-date",
- "itoa",
- "nom",
- "thiserror",
-]
-
-[[package]]
-name = "gix-attributes"
-version = "0.13.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "78b79590ac382f80d87e06416f5fcac6fee5d83dcb152a00ed0bdbaa988acc31"
-dependencies = [
- "bstr",
- "gix-glob",
- "gix-path",
- "gix-quote",
- "kstring",
- "log",
- "smallvec",
- "thiserror",
- "unicode-bom",
-]
-
-[[package]]
-name = "gix-bitmap"
-version = "0.2.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a371db66cbd4e13f0ed9dc4c0fea712d7276805fccc877f77e96374d317e87ae"
-dependencies = [
- "thiserror",
-]
-
-[[package]]
-name = "gix-chunk"
-version = "0.4.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "45c8751169961ba7640b513c3b24af61aa962c967aaf04116734975cd5af0c52"
-dependencies = [
- "thiserror",
-]
-
-[[package]]
-name = "gix-command"
-version = "0.2.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3c576cfbf577f72c097b5f88aedea502cd62952bdc1fb3adcab4531d5525a4c7"
-dependencies = [
- "bstr",
-]
-
-[[package]]
-name = "gix-commitgraph"
-version = "0.16.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e8490ae1b3d55c47e6a71d247c082304a2f79f8d0332c1a2f5693d42a2021a09"
-dependencies = [
- "bstr",
- "gix-chunk",
- "gix-features",
- "gix-hash",
- "memmap2",
- "thiserror",
-]
-
-[[package]]
-name = "gix-config"
-version = "0.23.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "51f310120ae1ba8f0ca52fb22876ce9bad5b15c8ffb3eb7302e4b64a3b9f681c"
-dependencies = [
- "bstr",
- "gix-config-value",
- "gix-features",
- "gix-glob",
- "gix-path",
- "gix-ref",
- "gix-sec",
- "log",
- "memchr",
- "nom",
- "once_cell",
- "smallvec",
- "thiserror",
- "unicode-bom",
-]
-
-[[package]]
-name = "gix-config-value"
-version = "0.12.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6e874f41437441c02991dcea76990b9058fadfc54b02ab4dd06ab2218af43897"
-dependencies = [
- "bitflags 2.5.0",
- "bstr",
- "gix-path",
- "libc",
- "thiserror",
-]
-
-[[package]]
-name = "gix-credentials"
-version = "0.15.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c6f89fea8acd28f5ef8fa5042146f1637afd4d834bc8f13439d8fd1e5aca0d65"
-dependencies = [
- "bstr",
- "gix-command",
- "gix-config-value",
- "gix-path",
- "gix-prompt",
- "gix-sec",
- "gix-url",
- "thiserror",
-]
-
-[[package]]
-name = "gix-date"
-version = "0.5.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bc164145670e9130a60a21670d9b6f0f4f8de04e5dd256c51fa5a0340c625902"
-dependencies = [
- "bstr",
- "itoa",
- "thiserror",
- "time",
-]
-
-[[package]]
-name = "gix-diff"
-version = "0.30.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9029ad0083cc286a4bd2f5b3bf66bb66398abc26f2731a2824cd5edfc41a0e33"
-dependencies = [
- "gix-hash",
- "gix-object",
- "imara-diff",
- "thiserror",
-]
-
-[[package]]
-name = "gix-discover"
-version = "0.19.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "aba9c6c0d1f2b2efe65581de73de4305004612d49c83773e783202a7ef204f46"
-dependencies = [
- "bstr",
- "dunce",
- "gix-hash",
- "gix-path",
- "gix-ref",
- "gix-sec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-features"
-version = "0.30.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3a8c493409bf6060d408eec9bbdd1b12ea351266b50012e2a522f75dfc7b8314"
-dependencies = [
- "bytes",
- "crc32fast",
- "crossbeam-channel",
- "flate2",
- "gix-hash",
- "libc",
- "once_cell",
- "parking_lot",
- "prodash",
- "sha1_smol",
- "thiserror",
- "walkdir",
-]
-
-[[package]]
-name = "gix-fs"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "30da8997008adb87f94e15beb7ee229f8a48e97af585a584bfee4a5a1880aab5"
-dependencies = [
- "gix-features",
-]
-
-[[package]]
-name = "gix-glob"
-version = "0.8.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cd0ade1e80ab1f079703d1824e1daf73009096386aa7fd2f0477f6e4ac0a558e"
-dependencies = [
- "bitflags 2.5.0",
- "bstr",
- "gix-features",
- "gix-path",
-]
-
-[[package]]
-name = "gix-hash"
-version = "0.11.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4b422ff2ad9a0628baaad6da468cf05385bf3f5ab495ad5a33cce99b9f41092f"
-dependencies = [
- "hex",
- "thiserror",
-]
-
-[[package]]
-name = "gix-hashtable"
-version = "0.2.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "385f4ce6ecf3692d313ca3aa9bd3b3d8490de53368d6d94bedff3af8b6d9c58d"
-dependencies = [
- "gix-hash",
- "hashbrown 0.14.3",
- "parking_lot",
-]
-
-[[package]]
-name = "gix-ignore"
-version = "0.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "fc6f7f101a0ccce808dbf7008ba131dede94e20257e7bde7a44cbb2f8c775625"
-dependencies = [
- "bstr",
- "gix-glob",
- "gix-path",
- "unicode-bom",
-]
-
-[[package]]
-name = "gix-index"
-version = "0.17.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "616ba958fabfb11263fa042c35690d48a6c7be4e9277e2c7e24ff263b3fe7b82"
-dependencies = [
- "bitflags 2.5.0",
- "bstr",
- "btoi",
- "filetime",
- "gix-bitmap",
- "gix-features",
- "gix-hash",
- "gix-lock",
- "gix-object",
- "gix-traverse",
- "itoa",
- "memmap2",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-lock"
-version = "6.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3ec5d5e6f07316d3553aa7425e3ecd935ec29882556021fe1696297a448af8d2"
-dependencies = [
- "gix-tempfile",
- "gix-utils",
- "thiserror",
-]
-
-[[package]]
-name = "gix-mailmap"
-version = "0.13.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4653701922c920e009f1bc4309feaff14882ade017770788f9a150928da3fa6a"
-dependencies = [
- "bstr",
- "gix-actor",
- "thiserror",
-]
-
-[[package]]
-name = "gix-negotiate"
-version = "0.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "945c3ef1e912e44a5f405fc9e924edf42000566a1b257ed52cb1293300f6f08c"
-dependencies = [
- "bitflags 2.5.0",
- "gix-commitgraph",
- "gix-hash",
- "gix-object",
- "gix-revision",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-object"
-version = "0.30.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8926c8f51c44dec3e709cb5dbc93deb9e8d4064c43c9efc54c158dcdfe8446c7"
-dependencies = [
- "bstr",
- "btoi",
- "gix-actor",
- "gix-features",
- "gix-hash",
- "gix-validate",
- "hex",
- "itoa",
- "nom",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-odb"
-version = "0.46.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4b234d806278eeac2f907c8b5a105c4ba537230c1a9d9236d822bf0db291f8f3"
-dependencies = [
- "arc-swap",
- "gix-features",
- "gix-hash",
- "gix-object",
- "gix-pack",
- "gix-path",
- "gix-quote",
- "parking_lot",
- "tempfile",
- "thiserror",
-]
-
-[[package]]
-name = "gix-pack"
-version = "0.36.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7d2a14cb3156037eedb17d6cb7209b7180522b8949b21fd0fe3184c0a1d0af88"
-dependencies = [
- "clru",
- "gix-chunk",
- "gix-diff",
- "gix-features",
- "gix-hash",
- "gix-hashtable",
- "gix-object",
- "gix-path",
- "gix-tempfile",
- "gix-traverse",
- "memmap2",
- "parking_lot",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-packetline"
-version = "0.16.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8a8384b1e964151aff0d5632dd9b191059d07dff358b96bd940f1b452600d7ab"
-dependencies = [
- "bstr",
- "faster-hex",
- "thiserror",
-]
-
-[[package]]
-name = "gix-path"
-version = "0.8.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "18609c8cbec8508ea97c64938c33cd305b75dfc04a78d0c3b78b8b3fd618a77c"
-dependencies = [
- "bstr",
- "gix-trace",
- "home",
- "once_cell",
- "thiserror",
-]
-
-[[package]]
-name = "gix-prompt"
-version = "0.5.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2c22decaf4a063ccae2b2108820c8630c01bd6756656df3fe464b32b8958a5ea"
-dependencies = [
- "gix-command",
- "gix-config-value",
- "parking_lot",
- "rustix",
- "thiserror",
-]
-
-[[package]]
-name = "gix-protocol"
-version = "0.33.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "92a17058b45c461f0847528c5fb6ee6e76115e026979eb2d2202f98ee94f6c24"
-dependencies = [
- "bstr",
- "btoi",
- "gix-credentials",
- "gix-features",
- "gix-hash",
- "gix-transport",
- "maybe-async",
- "nom",
- "thiserror",
-]
-
-[[package]]
-name = "gix-quote"
-version = "0.4.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cbff4f9b9ea3fa7a25a70ee62f545143abef624ac6aa5884344e70c8b0a1d9ff"
-dependencies = [
- "bstr",
- "gix-utils",
- "thiserror",
-]
-
-[[package]]
-name = "gix-ref"
-version = "0.30.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ebdd999256f4ce8a5eefa89999879c159c263f3493a951d62aa5ce42c0397e1c"
-dependencies = [
- "gix-actor",
- "gix-features",
- "gix-fs",
- "gix-hash",
- "gix-lock",
- "gix-object",
- "gix-path",
- "gix-tempfile",
- "gix-validate",
- "memmap2",
- "nom",
- "thiserror",
-]
-
-[[package]]
-name = "gix-refspec"
-version = "0.11.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "72bfd622abc86dd8ad1ec51b9eb77b4f1a766b94e3a1b87cf4a022c5b5570cf4"
-dependencies = [
- "bstr",
- "gix-hash",
- "gix-revision",
- "gix-validate",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-revision"
-version = "0.15.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5044f56cd7a487ce9b034cbe0252ae0b6b47ff56ca3dabd79bc30214d0932cd7"
-dependencies = [
- "bstr",
- "gix-date",
- "gix-hash",
- "gix-hashtable",
- "gix-object",
- "gix-revwalk",
- "thiserror",
-]
-
-[[package]]
-name = "gix-revwalk"
-version = "0.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bc2623ba8747914f151f5e12b65adac576ab459dbed5f50a36c7a3e9cbf2d3ca"
-dependencies = [
- "gix-commitgraph",
- "gix-hash",
- "gix-hashtable",
- "gix-object",
- "smallvec",
- "thiserror",
-]
-
-[[package]]
-name = "gix-sec"
-version = "0.8.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9615cbd6b456898aeb942cd75e5810c382fbfc48dbbff2fa23ebd2d33dcbe9c7"
-dependencies = [
- "bitflags 2.5.0",
- "gix-path",
- "libc",
- "windows",
-]
-
-[[package]]
-name = "gix-tempfile"
-version = "6.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b3785cb010e9dc5c446dfbf02bc1119fc17d3a48a27c029efcb3a3c32953eb10"
-dependencies = [
- "gix-fs",
- "libc",
- "once_cell",
- "parking_lot",
- "signal-hook",
- "signal-hook-registry",
- "tempfile",
-]
-
-[[package]]
-name = "gix-trace"
-version = "0.1.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9b838b2db8f62c9447d483a4c28d251b67fee32741a82cb4d35e9eb4e9fdc5ab"
-
-[[package]]
-name = "gix-transport"
-version = "0.32.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "64a39ffed9a9078ed700605e064b15d7c6ae50aa65e7faa36ca6919e8081df15"
-dependencies = [
- "base64",
- "bstr",
- "curl",
- "gix-command",
- "gix-credentials",
- "gix-features",
- "gix-packetline",
- "gix-quote",
- "gix-sec",
- "gix-url",
- "thiserror",
-]
-
-[[package]]
-name = "gix-traverse"
-version = "0.26.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b0842e984cb4bf26339dc559f3a1b8bf8cdb83547799b2b096822a59f87f33d9"
-dependencies = [
- "gix-hash",
- "gix-hashtable",
- "gix-object",
- "thiserror",
-]
-
-[[package]]
-name = "gix-url"
-version = "0.19.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f1663df25ac42047a2547618d2a6979a26f478073f6306997429235d2cd4c863"
-dependencies = [
- "bstr",
- "gix-features",
- "gix-path",
- "home",
- "thiserror",
- "url",
-]
-
-[[package]]
-name = "gix-utils"
-version = "0.1.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "0066432d4c277f9877f091279a597ea5331f68ca410efc874f0bdfb1cd348f92"
-dependencies = [
- "fastrand",
- "unicode-normalization",
-]
-
-[[package]]
-name = "gix-validate"
-version = "0.7.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ba9b3737b2cef3dcd014633485f0034b0f1a931ee54aeb7d8f87f177f3c89040"
-dependencies = [
- "bstr",
- "thiserror",
-]
-
-[[package]]
-name = "gix-worktree"
-version = "0.18.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d388ad962e8854402734a7387af8790f6bdbc8d05349052dab16ca4a0def50f6"
-dependencies = [
- "bstr",
- "filetime",
- "gix-attributes",
- "gix-features",
- "gix-fs",
- "gix-glob",
- "gix-hash",
- "gix-ignore",
- "gix-index",
- "gix-object",
- "gix-path",
- "io-close",
- "thiserror",
-]
-
-[[package]]
-name = "glob"
-version = "0.3.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d2fabcfbdc87f4758337ca535fb41a6d701b65693ce38287d856d1674551ec9b"
-
-[[package]]
-name = "globset"
-version = "0.4.14"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "57da3b9b5b85bd66f31093f8c408b90a74431672542466497dcbdfdc02034be1"
-dependencies = [
- "aho-corasick",
- "bstr",
- "log",
- "regex-automata",
- "regex-syntax",
-]
-
-[[package]]
-name = "group"
-version = "0.13.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f0f9ef7462f7c099f518d754361858f86d8a07af53ba9af0fe635bbccb151a63"
-dependencies = [
- "ff",
- "rand_core",
- "subtle",
-]
-
-[[package]]
-name = "hashbrown"
-version = "0.12.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8a9ee70c43aaf417c914396645a0fa852624801b24ebb7ae78fe8272889ac888"
-
-[[package]]
-name = "hashbrown"
-version = "0.14.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "290f1a1d9242c78d09ce40a5e87e7554ee637af1351968159f4952f028f75604"
-
-[[package]]
-name = "heck"
-version = "0.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2304e00983f87ffb38b55b444b5e3b60a884b5d30c0fca7d82fe33449bbe55ea"
-
-[[package]]
-name = "hermit-abi"
-version = "0.3.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d231dfb89cfffdbc30e7fc41579ed6066ad03abda9e567ccafae602b97ec5024"
-
-[[package]]
-name = "hex"
-version = "0.4.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7f24254aa9a54b5c858eaee2f5bccdb46aaf0e486a595ed5fd8f86ba55232a70"
-
-[[package]]
-name = "hkdf"
-version = "0.12.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7b5f8eb2ad728638ea2c7d47a21db23b7b58a72ed6a38256b8a1849f15fbbdf7"
-dependencies = [
- "hmac",
-]
-
-[[package]]
-name = "hmac"
-version = "0.12.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6c49c37c09c17a53d937dfbb742eb3a961d65a994e6bcdcf37e7399d0cc8ab5e"
-dependencies = [
- "digest",
-]
-
-[[package]]
-name = "home"
-version = "0.5.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e3d1354bf6b7235cb4a0576c2619fd4ed18183f689b12b006a0ee7329eeff9a5"
-dependencies = [
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "http-auth"
-version = "0.1.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "643c9bbf6a4ea8a656d6b4cd53d34f79e3f841ad5203c1a55fb7d761923bc255"
-dependencies = [
- "memchr",
-]
-
-[[package]]
-name = "humantime"
-version = "2.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9a3a5bfb195931eeb336b2a7b4d761daec841b97f947d34394601737a7bba5e4"
-
-[[package]]
-name = "idna"
-version = "0.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "634d9b1461af396cad843f47fdba5597a4f9e6ddd4bfb6ff5d85028c25cb12f6"
-dependencies = [
- "unicode-bidi",
- "unicode-normalization",
-]
-
-[[package]]
-name = "ignore"
-version = "0.4.22"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b46810df39e66e925525d6e38ce1e7f6e1d208f72dc39757880fcb66e2c58af1"
-dependencies = [
- "crossbeam-deque",
- "globset",
- "log",
- "memchr",
- "regex-automata",
- "same-file",
- "walkdir",
- "winapi-util",
-]
-
-[[package]]
-name = "im-rc"
-version = "15.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "af1955a75fa080c677d3972822ec4bad316169ab1cfc6c257a942c2265dbe5fe"
-dependencies = [
- "bitmaps",
- "rand_core",
- "rand_xoshiro",
- "sized-chunks",
- "typenum",
- "version_check",
-]
-
-[[package]]
-name = "imara-diff"
-version = "0.1.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e98c1d0ad70fc91b8b9654b1f33db55e59579d3b3de2bffdced0fdb810570cb8"
-dependencies = [
- "ahash",
- "hashbrown 0.12.3",
-]
-
-[[package]]
-name = "indexmap"
-version = "1.9.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bd070e393353796e801d209ad339e89596eb4c8d430d18ede6a1cced8fafbd99"
-dependencies = [
- "autocfg",
- "hashbrown 0.12.3",
-]
-
-[[package]]
-name = "indexmap"
-version = "2.2.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "168fb715dda47215e360912c096649d23d58bf392ac62f73919e831745e40f26"
-dependencies = [
- "equivalent",
- "hashbrown 0.14.3",
-]
-
-[[package]]
-name = "io-close"
-version = "0.3.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9cadcf447f06744f8ce713d2d6239bb5bde2c357a452397a9ed90c625da390bc"
-dependencies = [
- "libc",
- "winapi",
-]
-
-[[package]]
-name = "is-terminal"
-version = "0.4.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f23ff5ef2b80d608d61efee834934d862cd92461afc0560dedf493e4c033738b"
-dependencies = [
- "hermit-abi",
- "libc",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "itertools"
-version = "0.10.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b0fd2260e829bddf4cb6ea802289de2f86d6a7a690192fbe91b3f46e0f2c8473"
-dependencies = [
- "either",
-]
-
-[[package]]
-name = "itertools"
-version = "0.11.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b1c173a5686ce8bfa551b3563d0c2170bf24ca44da99c7ca4bfdab5418c3fe57"
-dependencies = [
- "either",
-]
-
-[[package]]
-name = "itoa"
-version = "1.0.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "49f1f14873335454500d59611f1cf4a4b0f786f9ac11f4312a78e4cf2566695b"
-
-[[package]]
-name = "jobserver"
-version = "0.1.28"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ab46a6e9526ddef3ae7f787c06f0f2600639ba80ea3eade3d8e670a2230f51d6"
-dependencies = [
- "libc",
-]
-
-[[package]]
-name = "js-sys"
-version = "0.3.69"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "29c15563dc2726973df627357ce0c9ddddbea194836909d655df6a75d2cf296d"
-dependencies = [
- "wasm-bindgen",
-]
-
-[[package]]
-name = "kstring"
-version = "2.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ec3066350882a1cd6d950d055997f379ac37fd39f81cd4d8ed186032eb3c5747"
-dependencies = [
- "static_assertions",
-]
-
-[[package]]
-name = "lazycell"
-version = "1.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "830d08ce1d1d941e6b30645f1a0eb5643013d835ce3779a5fc208261dbe10f55"
-
-[[package]]
-name = "libc"
-version = "0.2.153"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9c198f91728a82281a64e1f4f9eeb25d82cb32a5de251c6bd1b5154d63a8e7bd"
-
-[[package]]
-name = "libgit2-sys"
-version = "0.15.2+1.6.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a80df2e11fb4a61f4ba2ab42dbe7f74468da143f1a75c74e11dee7c813f694fa"
-dependencies = [
- "cc",
- "libc",
- "libssh2-sys",
- "libz-sys",
- "openssl-sys",
- "pkg-config",
-]
-
-[[package]]
-name = "libnghttp2-sys"
-version = "0.1.9+1.58.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b57e858af2798e167e709b9d969325b6d8e9d50232fcbc494d7d54f976854a64"
-dependencies = [
- "cc",
- "libc",
-]
-
-[[package]]
-name = "libssh2-sys"
-version = "0.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2dc8a030b787e2119a731f1951d6a773e2280c660f8ec4b0f5e1505a386e71ee"
-dependencies = [
- "cc",
- "libc",
- "libz-sys",
- "openssl-sys",
- "pkg-config",
- "vcpkg",
-]
-
-[[package]]
-name = "libz-sys"
-version = "1.1.16"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5e143b5e666b2695d28f6bca6497720813f699c9602dd7f5cac91008b8ada7f9"
-dependencies = [
- "cc",
- "libc",
- "pkg-config",
- "vcpkg",
-]
-
-[[package]]
-name = "linux-raw-sys"
-version = "0.4.13"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "01cda141df6706de531b6c46c3a33ecca755538219bd484262fa09410c13539c"
-
-[[package]]
-name = "lock_api"
-version = "0.4.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3c168f8615b12bc01f9c17e2eb0cc07dcae1940121185446edc3744920e8ef45"
-dependencies = [
- "autocfg",
- "scopeguard",
-]
-
-[[package]]
-name = "log"
-version = "0.4.21"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "90ed8c1e510134f979dbc4f070f87d4313098b704861a105fe34231c70a3901c"
-
-[[package]]
-name = "maybe-async"
-version = "0.2.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5cf92c10c7e361d6b99666ec1c6f9805b0bea2c3bd8c78dc6fe98ac5bd78db11"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "memchr"
-version = "2.7.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6c8640c5d730cb13ebd907d8d04b52f55ac9a2eec55b440c8892f40d56c76c1d"
-
-[[package]]
-name = "memmap2"
-version = "0.5.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "83faa42c0a078c393f6b29d5db232d8be22776a891f8f56e5284faee4a20b327"
-dependencies = [
- "libc",
-]
-
-[[package]]
-name = "minimal-lexical"
-version = "0.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "68354c5c6bd36d73ff3feceb05efa59b6acb7626617f4962be322a825e61f79a"
-
-[[package]]
-name = "miniz_oxide"
-version = "0.7.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9d811f3e15f28568be3407c8e7fdb6514c1cda3cb30683f15b6a1a1dc4ea14a7"
-dependencies = [
- "adler",
-]
-
-[[package]]
-name = "miow"
-version = "0.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "359f76430b20a79f9e20e115b3428614e654f04fab314482fc0fda0ebd3c6044"
-dependencies = [
- "windows-sys 0.48.0",
-]
-
-[[package]]
-name = "nom"
-version = "7.1.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d273983c5a657a70a3e8f2a01329822f3b8c8172b73826411a55751e404a0a4a"
-dependencies = [
- "memchr",
- "minimal-lexical",
-]
-
-[[package]]
-name = "num-conv"
-version = "0.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "51d515d32fb182ee37cda2ccdcb92950d6a3c2893aa280e540671c2cd0f3b1d9"
-
-[[package]]
-name = "num-traits"
-version = "0.2.18"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "da0df0e5185db44f69b44f26786fe401b6c293d1907744beaa7fa62b2e5a517a"
-dependencies = [
- "autocfg",
-]
-
-[[package]]
-name = "num_cpus"
-version = "1.16.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4161fcb6d602d4d2081af7c3a45852d875a03dd337a6bfdd6e06407b61342a43"
-dependencies = [
- "hermit-abi",
- "libc",
-]
-
-[[package]]
-name = "num_threads"
-version = "0.1.7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5c7398b9c8b70908f6371f47ed36737907c87c52af34c268fed0bf0ceb92ead9"
-dependencies = [
- "libc",
-]
-
-[[package]]
-name = "once_cell"
-version = "1.19.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3fdb12b2476b595f9358c5161aa467c2438859caa136dec86c26fdd2efe17b92"
-
-[[package]]
-name = "opener"
-version = "0.5.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "293c15678e37254c15bd2f092314abb4e51d7fdde05c2021279c12631b54f005"
-dependencies = [
- "bstr",
- "winapi",
-]
-
-[[package]]
-name = "openssl-probe"
-version = "0.1.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ff011a302c396a5197692431fc1948019154afc178baf7d8e37367442a4601cf"
-
-[[package]]
-name = "openssl-sys"
-version = "0.9.102"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c597637d56fbc83893a35eb0dd04b2b8e7a50c91e64e9493e398b5df4fb45fa2"
-dependencies = [
- "cc",
- "libc",
- "pkg-config",
- "vcpkg",
-]
-
-[[package]]
-name = "ordered-float"
-version = "2.10.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "68f19d67e5a2795c94e73e0bb1cc1a7edeb2e28efd39e2e1c9b7a40c1108b11c"
-dependencies = [
- "num-traits",
-]
-
-[[package]]
-name = "orion"
-version = "0.17.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7abdb10181903c8c4b016ba45d6d6d5af1a1e2a461aa4763a83b87f5df4695e5"
-dependencies = [
- "fiat-crypto",
- "subtle",
- "zeroize",
-]
-
-[[package]]
-name = "os_info"
-version = "3.8.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ae99c7fa6dd38c7cafe1ec085e804f8f555a2f8659b0dbe03f1f9963a9b51092"
-dependencies = [
- "log",
- "serde",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "p384"
-version = "0.13.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "70786f51bcc69f6a4c0360e063a4cac5419ef7c5cd5b3c99ad70f3be5ba79209"
-dependencies = [
- "ecdsa",
- "elliptic-curve",
- "primeorder",
- "sha2",
-]
-
-[[package]]
-name = "parking_lot"
-version = "0.12.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3742b2c103b9f06bc9fff0a37ff4912935851bee6d36f3c02bcc755bcfec228f"
-dependencies = [
- "lock_api",
- "parking_lot_core",
-]
-
-[[package]]
-name = "parking_lot_core"
-version = "0.9.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4c42a9226546d68acdd9c0a280d17ce19bfe27a46bf68784e4066115788d008e"
-dependencies = [
- "cfg-if",
- "libc",
- "redox_syscall",
- "smallvec",
- "windows-targets 0.48.5",
-]
-
-[[package]]
-name = "pasetors"
-version = "0.6.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6b36d47c66f2230dd1b7143d9afb2b4891879020210eddf2ccb624e529b96dba"
-dependencies = [
- "ct-codecs",
- "ed25519-compact",
- "getrandom",
- "orion",
- "p384",
- "rand_core",
- "regex",
- "serde",
- "serde_json",
- "sha2",
- "subtle",
- "time",
- "zeroize",
-]
-
-[[package]]
-name = "pathdiff"
-version = "0.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8835116a5c179084a830efb3adc117ab007512b535bc1a21c991d3b32a6b44dd"
-
-[[package]]
-name = "pem-rfc7468"
-version = "0.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "88b39c9bfcfc231068454382784bb460aae594343fb030d46e9f50a645418412"
-dependencies = [
- "base64ct",
-]
-
-[[package]]
-name = "percent-encoding"
-version = "2.3.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e3148f5046208a5d56bcfc03053e3ca6334e51da8dfb19b6cdc8b306fae3283e"
-
-[[package]]
-name = "pin-project-lite"
-version = "0.2.14"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bda66fc9667c18cb2758a2ac84d1167245054bcf85d5d1aaa6923f45801bdd02"
-
-[[package]]
-name = "pkcs8"
-version = "0.10.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f950b2377845cebe5cf8b5165cb3cc1a5e0fa5cfa3e1f7f55707d8fd82e0a7b7"
-dependencies = [
- "der",
- "spki",
-]
-
-[[package]]
-name = "pkg-config"
-version = "0.3.30"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d231b230927b5e4ad203db57bbcbee2802f6bce620b1e4a9024a07d94e2907ec"
-
-[[package]]
-name = "powerfmt"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "439ee305def115ba05938db6eb1644ff94165c5ab5e9420d1c1bcedbba909391"
-
-[[package]]
-name = "ppv-lite86"
-version = "0.2.17"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5b40af805b3121feab8a3c29f04d8ad262fa8e0561883e7653e024ae4479e6de"
-
-[[package]]
-name = "primeorder"
-version = "0.13.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "353e1ca18966c16d9deb1c69278edbc5f194139612772bd9537af60ac231e1e6"
-dependencies = [
- "elliptic-curve",
-]
-
-[[package]]
-name = "proc-macro2"
-version = "1.0.79"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e835ff2298f5721608eb1a980ecaee1aef2c132bf95ecc026a11b7bf3c01c02e"
-dependencies = [
- "unicode-ident",
-]
-
-[[package]]
-name = "prodash"
-version = "25.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1d67eb4220992a4a052a4bb03cf776e493ecb1a3a36bab551804153d63486af7"
-dependencies = [
- "parking_lot",
-]
-
-[[package]]
-name = "pulldown-cmark"
-version = "0.9.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "57206b407293d2bcd3af849ce869d52068623f19e1b5ff8e8778e3309439682b"
-dependencies = [
- "bitflags 2.5.0",
- "memchr",
- "unicase",
-]
-
-[[package]]
-name = "quote"
-version = "1.0.35"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "291ec9ab5efd934aaf503a6466c5d5251535d108ee747472c3977cc5acc868ef"
-dependencies = [
- "proc-macro2",
-]
-
-[[package]]
-name = "rand"
-version = "0.8.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "34af8d1a0e25924bc5b7c43c079c942339d8f0a8b57c39049bef581b46327404"
-dependencies = [
- "libc",
- "rand_chacha",
- "rand_core",
-]
-
-[[package]]
-name = "rand_chacha"
-version = "0.3.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e6c10a63a0fa32252be49d21e7709d4d4baf8d231c2dbce1eaa8141b9b127d88"
-dependencies = [
- "ppv-lite86",
- "rand_core",
-]
-
-[[package]]
-name = "rand_core"
-version = "0.6.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ec0be4795e2f6a28069bec0b5ff3e2ac9bafc99e6a9a7dc3547996c5c816922c"
-dependencies = [
- "getrandom",
-]
-
-[[package]]
-name = "rand_xoshiro"
-version = "0.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6f97cdb2a36ed4183de61b2f824cc45c9f1037f28afe0a322e9fff4c108b5aaa"
-dependencies = [
- "rand_core",
-]
-
-[[package]]
-name = "redox_syscall"
-version = "0.4.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4722d768eff46b75989dd134e5c353f0d6296e5aaa3132e776cbdb56be7731aa"
-dependencies = [
- "bitflags 1.3.2",
-]
-
-[[package]]
-name = "regex"
-version = "1.10.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c117dbdfde9c8308975b6a18d71f3f385c89461f7b3fb054288ecf2a2058ba4c"
-dependencies = [
- "aho-corasick",
- "memchr",
- "regex-automata",
- "regex-syntax",
-]
-
-[[package]]
-name = "regex-automata"
-version = "0.4.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "86b83b8b9847f9bf95ef68afb0b8e6cdb80f498442f5179a29fad448fcc1eaea"
-dependencies = [
- "aho-corasick",
- "memchr",
- "regex-syntax",
-]
-
-[[package]]
-name = "regex-syntax"
-version = "0.8.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "adad44e29e4c806119491a7f06f03de4d1af22c3a680dd47f1e6e179439d1f56"
-
-[[package]]
-name = "rfc6979"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f8dd2a808d456c4a54e300a23e9f5a67e122c3024119acbfd73e3bf664491cb2"
-dependencies = [
- "hmac",
- "subtle",
-]
-
-[[package]]
-name = "rustfix"
-version = "0.6.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ecd2853d9e26988467753bd9912c3a126f642d05d229a4b53f5752ee36c56481"
-dependencies = [
- "anyhow",
- "log",
- "serde",
- "serde_json",
-]
-
-[[package]]
-name = "rustix"
-version = "0.38.32"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "65e04861e65f21776e67888bfbea442b3642beaa0138fdb1dd7a84a52dffdb89"
-dependencies = [
- "bitflags 2.5.0",
- "errno",
- "libc",
- "linux-raw-sys",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "ryu"
-version = "1.0.17"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e86697c916019a8588c99b5fac3cead74ec0b4b819707a682fd4d23fa0ce1ba1"
-
-[[package]]
-name = "same-file"
-version = "1.0.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "93fc1dc3aaa9bfed95e02e6eadabb4baf7e3078b0bd1b4d7b6b0b68378900502"
-dependencies = [
- "winapi-util",
-]
-
-[[package]]
-name = "schannel"
-version = "0.1.23"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "fbc91545643bcf3a0bbb6569265615222618bdf33ce4ffbbd13c4bbd4c093534"
-dependencies = [
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "scopeguard"
-version = "1.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "94143f37725109f92c262ed2cf5e59bce7498c01bcc1502d7b9afe439a4e9f49"
-
-[[package]]
-name = "sec1"
-version = "0.7.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d3e97a565f76233a6003f9f5c54be1d9c5bdfa3eccfb189469f11ec4901c47dc"
-dependencies = [
- "base16ct",
- "der",
- "generic-array",
- "pkcs8",
- "subtle",
- "zeroize",
-]
-
-[[package]]
-name = "semver"
-version = "1.0.22"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "92d43fe69e652f3df9bdc2b85b2854a0825b86e4fb76bc44d945137d053639ca"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "serde"
-version = "1.0.197"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3fb1c873e1b9b056a4dc4c0c198b24c3ffa059243875552b2bd0933b1aee4ce2"
-dependencies = [
- "serde_derive",
-]
-
-[[package]]
-name = "serde-value"
-version = "0.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f3a1a3341211875ef120e117ea7fd5228530ae7e7036a779fdc9117be6b3282c"
-dependencies = [
- "ordered-float",
- "serde",
-]
-
-[[package]]
-name = "serde_derive"
-version = "1.0.197"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7eb0b34b42edc17f6b7cac84a52a1c5f0e1bb2227e997ca9011ea3dd34e8610b"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "serde_ignored"
-version = "0.1.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a8e319a36d1b52126a0d608f24e93b2d81297091818cd70625fcf50a15d84ddf"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "serde_json"
-version = "1.0.115"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "12dc5c46daa8e9fdf4f5e71b6cf9a53f2487da0e86e55808e2d35539666497dd"
-dependencies = [
- "itoa",
- "ryu",
- "serde",
-]
-
-[[package]]
-name = "serde_spanned"
-version = "0.6.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "eb3622f419d1296904700073ea6cc23ad690adbd66f13ea683df73298736f0c1"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "sha1"
-version = "0.10.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e3bf829a2d51ab4a5ddf1352d8470c140cadc8301b2ae1789db023f01cedd6ba"
-dependencies = [
- "cfg-if",
- "cpufeatures",
- "digest",
-]
-
-[[package]]
-name = "sha1_smol"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ae1a47186c03a32177042e55dbc5fd5aee900b8e0069a8d70fba96a9375cd012"
-
-[[package]]
-name = "sha2"
-version = "0.10.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "793db75ad2bcafc3ffa7c68b215fee268f537982cd901d132f89c6343f3a3dc8"
-dependencies = [
- "cfg-if",
- "cpufeatures",
- "digest",
-]
-
-[[package]]
-name = "shell-escape"
-version = "0.1.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "45bb67a18fa91266cc7807181f62f9178a6873bfad7dc788c42e6430db40184f"
-
-[[package]]
-name = "signal-hook"
-version = "0.3.17"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8621587d4798caf8eb44879d42e56b9a93ea5dcd315a6487c357130095b62801"
-dependencies = [
- "libc",
- "signal-hook-registry",
-]
-
-[[package]]
-name = "signal-hook-registry"
-version = "1.4.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d8229b473baa5980ac72ef434c4415e70c4b5e71b423043adb4ba059f89c99a1"
-dependencies = [
- "libc",
-]
-
-[[package]]
-name = "signature"
-version = "2.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "77549399552de45a898a580c1b41d445bf730df867cc44e6c0233bbc4b8329de"
-dependencies = [
- "digest",
- "rand_core",
-]
-
-[[package]]
-name = "sized-chunks"
-version = "0.6.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "16d69225bde7a69b235da73377861095455d298f2b970996eec25ddbb42b3d1e"
-dependencies = [
- "bitmaps",
- "typenum",
-]
-
-[[package]]
-name = "smallvec"
-version = "1.13.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3c5e1a9a646d36c3599cd173a41282daf47c44583ad367b8e6837255952e5c67"
-
-[[package]]
-name = "socket2"
-version = "0.5.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "05ffd9c0a93b7543e062e759284fcf5f5e3b098501104bfbdde4d404db792871"
-dependencies = [
- "libc",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "spki"
-version = "0.7.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d91ed6c858b01f942cd56b37a94b3e0a1798290327d1236e4d9cf4eaca44d29d"
-dependencies = [
- "base64ct",
- "der",
-]
-
-[[package]]
-name = "static_assertions"
-version = "1.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a2eb9349b6444b326872e140eb1cf5e7c522154d69e7a0ffb0fb81c06b37543f"
-
-[[package]]
-name = "strip-ansi-escapes"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "011cbb39cf7c1f62871aea3cc46e5817b0937b49e9447370c93cacbe93a766d8"
-dependencies = [
- "vte",
-]
-
-[[package]]
-name = "strsim"
-version = "0.11.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7da8b5736845d9f2fcb837ea5d9e2628564b3b043a70948a3f0b778838c5fb4f"
-
-[[package]]
-name = "subtle"
-version = "2.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "81cdd64d312baedb58e21336b31bc043b77e01cc99033ce76ef539f78e965ebc"
-
-[[package]]
-name = "syn"
-version = "2.0.58"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "44cfb93f38070beee36b3fef7d4f5a16f27751d94b187b666a5cc5e9b0d30687"
-dependencies = [
- "proc-macro2",
- "quote",
- "unicode-ident",
-]
-
-[[package]]
-name = "tar"
-version = "0.4.40"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b16afcea1f22891c49a00c751c7b63b2233284064f11a200fc624137c51e2ddb"
-dependencies = [
- "filetime",
- "libc",
-]
-
-[[package]]
-name = "tempfile"
-version = "3.10.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "85b77fafb263dd9d05cbeac119526425676db3784113aa9295c88498cbf8bff1"
-dependencies = [
- "cfg-if",
- "fastrand",
- "rustix",
- "windows-sys 0.52.0",
-]
-
-[[package]]
-name = "termcolor"
-version = "1.4.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "06794f8f6c5c898b3275aebefa6b8a1cb24cd2c6c79397ab15774837a0bc5755"
-dependencies = [
- "winapi-util",
-]
-
-[[package]]
-name = "terminal_size"
-version = "0.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "21bebf2b7c9e0a515f6e0f8c51dc0f8e4696391e6f1ff30379559f8365fb0df7"
-dependencies = [
- "rustix",
- "windows-sys 0.48.0",
-]
-
-[[package]]
-name = "thiserror"
-version = "1.0.58"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "03468839009160513471e86a034bb2c5c0e4baae3b43f79ffc55c4a5427b3297"
-dependencies = [
- "thiserror-impl",
-]
-
-[[package]]
-name = "thiserror-impl"
-version = "1.0.58"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c61f3ba182994efc43764a46c018c347bc492c79f024e705f46567b418f6d4f7"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "threadpool"
-version = "1.8.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d050e60b33d41c19108b32cea32164033a9013fe3b46cbd4457559bfbf77afaa"
-dependencies = [
- "num_cpus",
-]
-
-[[package]]
-name = "time"
-version = "0.3.34"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c8248b6521bb14bc45b4067159b9b6ad792e2d6d754d6c41fb50e29fefe38749"
-dependencies = [
- "deranged",
- "itoa",
- "libc",
- "num-conv",
- "num_threads",
- "powerfmt",
- "serde",
- "time-core",
- "time-macros",
-]
-
-[[package]]
-name = "time-core"
-version = "0.1.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ef927ca75afb808a4d64dd374f00a2adf8d0fcff8e7b184af886c3c87ec4a3f3"
-
-[[package]]
-name = "time-macros"
-version = "0.2.17"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7ba3a3ef41e6672a2f0f001392bb5dcd3ff0a9992d618ca761a11c3121547774"
-dependencies = [
- "num-conv",
- "time-core",
-]
-
-[[package]]
-name = "tinytemplate"
-version = "1.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "be4d6b5f19ff7664e8c98d03e2139cb510db9b0a60b55f8e8709b689d939b6bc"
-dependencies = [
- "serde",
- "serde_json",
-]
-
-[[package]]
-name = "tinyvec"
-version = "1.6.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "87cc5ceb3875bb20c2890005a4e226a4651264a5c75edb2421b52861a0a0cb50"
-dependencies = [
- "tinyvec_macros",
-]
-
-[[package]]
-name = "tinyvec_macros"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1f3ccbac311fea05f86f61904b462b55fb3df8837a366dfc601a0161d0532f20"
-
-[[package]]
-name = "toml"
-version = "0.7.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "dd79e69d3b627db300ff956027cc6c3798cef26d22526befdfcd12feeb6d2257"
-dependencies = [
- "serde",
- "serde_spanned",
- "toml_datetime",
- "toml_edit",
-]
-
-[[package]]
-name = "toml_datetime"
-version = "0.6.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3550f4e9685620ac18a50ed434eb3aec30db8ba93b0287467bca5826ea25baf1"
-dependencies = [
- "serde",
-]
-
-[[package]]
-name = "toml_edit"
-version = "0.19.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1b5bb770da30e5cbfde35a2d7b9b8a2c4b8ef89548a7a6aeab5c9a576e3e7421"
-dependencies = [
- "indexmap 2.2.6",
- "serde",
- "serde_spanned",
- "toml_datetime",
- "winnow",
-]
-
-[[package]]
-name = "tracing"
-version = "0.1.40"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c3523ab5a71916ccf420eebdf5521fcef02141234bbc0b8a49f2fdc4544364ef"
-dependencies = [
- "pin-project-lite",
- "tracing-attributes",
- "tracing-core",
-]
-
-[[package]]
-name = "tracing-attributes"
-version = "0.1.27"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "34704c8d6ebcbc939824180af020566b01a7c01f80641264eba0999f6c2b6be7"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "tracing-core"
-version = "0.1.32"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "c06d3da6113f116aaee68e4d601191614c9053067f9ab7f6edbcb161237daa54"
-dependencies = [
- "once_cell",
-]
-
-[[package]]
-name = "typenum"
-version = "1.17.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "42ff0bf0c66b8238c6f3b578df37d0b7848e55df8577b3f74f92a69acceeb825"
-
-[[package]]
-name = "unicase"
-version = "2.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f7d2d4dafb69621809a81864c9c1b864479e1235c0dd4e199924b9742439ed89"
-dependencies = [
- "version_check",
-]
-
-[[package]]
-name = "unicode-bidi"
-version = "0.3.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "08f95100a766bf4f8f28f90d77e0a5461bbdb219042e7679bebe79004fed8d75"
-
-[[package]]
-name = "unicode-bom"
-version = "2.0.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7eec5d1121208364f6793f7d2e222bf75a915c19557537745b195b253dd64217"
-
-[[package]]
-name = "unicode-ident"
-version = "1.0.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "3354b9ac3fae1ff6755cb6db53683adb661634f67557942dea4facebec0fee4b"
-
-[[package]]
-name = "unicode-normalization"
-version = "0.1.23"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a56d1686db2308d901306f92a263857ef59ea39678a5458e7cb17f01415101f5"
-dependencies = [
- "tinyvec",
-]
-
-[[package]]
-name = "unicode-width"
-version = "0.1.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e51733f11c9c4f72aa0c160008246859e340b00807569a0da0e7a1079b27ba85"
-
-[[package]]
-name = "unicode-xid"
-version = "0.2.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f962df74c8c05a667b5ee8bcf162993134c104e96440b663c8daa176dc772d8c"
-
-[[package]]
-name = "url"
-version = "2.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "31e6302e3bb753d46e83516cae55ae196fc0c309407cf11ab35cc51a4c2a4633"
-dependencies = [
- "form_urlencoded",
- "idna",
- "percent-encoding",
-]
-
-[[package]]
-name = "utf8parse"
-version = "0.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "711b9620af191e0cdc7468a8d14e709c3dcdb115b36f838e601583af800a370a"
-
-[[package]]
-name = "vcpkg"
-version = "0.2.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "accd4ea62f7bb7a82fe23066fb0957d48ef677f6eeb8215f372f52e48bb32426"
-
-[[package]]
-name = "version_check"
-version = "0.9.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "49874b5167b65d7193b8aba1567f5c7d93d001cafc34600cee003eda787e483f"
-
-[[package]]
-name = "vte"
-version = "0.10.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "6cbce692ab4ca2f1f3047fcf732430249c0e971bfdd2b234cf2c47ad93af5983"
-dependencies = [
- "arrayvec",
- "utf8parse",
- "vte_generate_state_changes",
-]
-
-[[package]]
-name = "vte_generate_state_changes"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "d257817081c7dffcdbab24b9e62d2def62e2ff7d00b1c20062551e6cccc145ff"
-dependencies = [
- "proc-macro2",
- "quote",
-]
-
-[[package]]
-name = "walkdir"
-version = "2.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "29790946404f91d9c5d06f9874efddea1dc06c5efe94541a7d6863108e3a5e4b"
-dependencies = [
- "same-file",
- "winapi-util",
-]
-
-[[package]]
-name = "wasi"
-version = "0.11.0+wasi-snapshot-preview1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9c8d87e72b64a3b4db28d11ce29237c246188f4f51057d65a7eab63b7987e423"
-
-[[package]]
-name = "wasite"
-version = "0.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b8dad83b4f25e74f184f64c43b150b91efe7647395b42289f38e50566d82855b"
-
-[[package]]
-name = "wasm-bindgen"
-version = "0.2.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "4be2531df63900aeb2bca0daaaddec08491ee64ceecbee5076636a3b026795a8"
-dependencies = [
- "cfg-if",
- "wasm-bindgen-macro",
-]
-
-[[package]]
-name = "wasm-bindgen-backend"
-version = "0.2.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "614d787b966d3989fa7bb98a654e369c762374fd3213d212cfc0251257e747da"
-dependencies = [
- "bumpalo",
- "log",
- "once_cell",
- "proc-macro2",
- "quote",
- "syn",
- "wasm-bindgen-shared",
-]
-
-[[package]]
-name = "wasm-bindgen-macro"
-version = "0.2.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a1f8823de937b71b9460c0c34e25f3da88250760bec0ebac694b49997550d726"
-dependencies = [
- "quote",
- "wasm-bindgen-macro-support",
-]
-
-[[package]]
-name = "wasm-bindgen-macro-support"
-version = "0.2.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e94f17b526d0a461a191c78ea52bbce64071ed5c04c9ffe424dcb38f74171bb7"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
- "wasm-bindgen-backend",
- "wasm-bindgen-shared",
-]
-
-[[package]]
-name = "wasm-bindgen-shared"
-version = "0.2.92"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "af190c94f2773fdb3729c55b007a722abb5384da03bc0986df4c289bf5567e96"
-
-[[package]]
-name = "web-sys"
-version = "0.3.69"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "77afa9a11836342370f4817622a2f0f418b134426d91a82dfb48f532d2ec13ef"
-dependencies = [
- "js-sys",
- "wasm-bindgen",
-]
-
-[[package]]
-name = "whoami"
-version = "1.5.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a44ab49fad634e88f55bf8f9bb3abd2f27d7204172a112c7c9987e01c1c94ea9"
-dependencies = [
- "redox_syscall",
- "wasite",
- "web-sys",
-]
-
-[[package]]
-name = "winapi"
-version = "0.3.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5c839a674fcd7a98952e593242ea400abe93992746761e38641405d28b00f419"
-dependencies = [
- "winapi-i686-pc-windows-gnu",
- "winapi-x86_64-pc-windows-gnu",
-]
-
-[[package]]
-name = "winapi-i686-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
-
-[[package]]
-name = "winapi-util"
-version = "0.1.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f29e6f9198ba0d26b4c9f07dbe6f9ed633e1f3d5b8b414090084349e46a52596"
-dependencies = [
- "winapi",
-]
-
-[[package]]
-name = "winapi-x86_64-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
-
-[[package]]
-name = "windows"
-version = "0.48.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "e686886bc078bc1b0b600cac0147aadb815089b6e4da64016cbd754b6342700f"
-dependencies = [
- "windows-targets 0.48.5",
-]
-
-[[package]]
-name = "windows-sys"
-version = "0.48.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "677d2418bec65e3338edb076e806bc1ec15693c5d0104683f2efe857f61056a9"
-dependencies = [
- "windows-targets 0.48.5",
-]
-
-[[package]]
-name = "windows-sys"
-version = "0.52.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "282be5f36a8ce781fad8c8ae18fa3f9beff57ec1b52cb3de0789201425d9a33d"
-dependencies = [
- "windows-targets 0.52.4",
-]
-
-[[package]]
-name = "windows-targets"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9a2fa6e2155d7247be68c096456083145c183cbbbc2764150dda45a87197940c"
-dependencies = [
- "windows_aarch64_gnullvm 0.48.5",
- "windows_aarch64_msvc 0.48.5",
- "windows_i686_gnu 0.48.5",
- "windows_i686_msvc 0.48.5",
- "windows_x86_64_gnu 0.48.5",
- "windows_x86_64_gnullvm 0.48.5",
- "windows_x86_64_msvc 0.48.5",
-]
-
-[[package]]
-name = "windows-targets"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "7dd37b7e5ab9018759f893a1952c9420d060016fc19a472b4bb20d1bdd694d1b"
-dependencies = [
- "windows_aarch64_gnullvm 0.52.4",
- "windows_aarch64_msvc 0.52.4",
- "windows_i686_gnu 0.52.4",
- "windows_i686_msvc 0.52.4",
- "windows_x86_64_gnu 0.52.4",
- "windows_x86_64_gnullvm 0.52.4",
- "windows_x86_64_msvc 0.52.4",
-]
-
-[[package]]
-name = "windows_aarch64_gnullvm"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "2b38e32f0abccf9987a4e3079dfb67dcd799fb61361e53e2882c3cbaf0d905d8"
-
-[[package]]
-name = "windows_aarch64_gnullvm"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "bcf46cf4c365c6f2d1cc93ce535f2c8b244591df96ceee75d8e83deb70a9cac9"
-
-[[package]]
-name = "windows_aarch64_msvc"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "dc35310971f3b2dbbf3f0690a219f40e2d9afcf64f9ab7cc1be722937c26b4bc"
-
-[[package]]
-name = "windows_aarch64_msvc"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "da9f259dd3bcf6990b55bffd094c4f7235817ba4ceebde8e6d11cd0c5633b675"
-
-[[package]]
-name = "windows_i686_gnu"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "a75915e7def60c94dcef72200b9a8e58e5091744960da64ec734a6c6e9b3743e"
-
-[[package]]
-name = "windows_i686_gnu"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "b474d8268f99e0995f25b9f095bc7434632601028cf86590aea5c8a5cb7801d3"
-
-[[package]]
-name = "windows_i686_msvc"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "8f55c233f70c4b27f66c523580f78f1004e8b5a8b659e05a4eb49d4166cca406"
-
-[[package]]
-name = "windows_i686_msvc"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "1515e9a29e5bed743cb4415a9ecf5dfca648ce85ee42e15873c3cd8610ff8e02"
-
-[[package]]
-name = "windows_x86_64_gnu"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "53d40abd2583d23e4718fddf1ebec84dbff8381c07cae67ff7768bbf19c6718e"
-
-[[package]]
-name = "windows_x86_64_gnu"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5eee091590e89cc02ad514ffe3ead9eb6b660aedca2183455434b93546371a03"
-
-[[package]]
-name = "windows_x86_64_gnullvm"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "0b7b52767868a23d5bab768e390dc5f5c55825b6d30b86c844ff2dc7414044cc"
-
-[[package]]
-name = "windows_x86_64_gnullvm"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "77ca79f2451b49fa9e2af39f0747fe999fcda4f5e241b2898624dca97a1f2177"
-
-[[package]]
-name = "windows_x86_64_msvc"
-version = "0.48.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "ed94fce61571a4006852b7389a063ab983c02eb1bb37b47f8272ce92d06d9538"
-
-[[package]]
-name = "windows_x86_64_msvc"
-version = "0.52.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "32b752e52a2da0ddfbdbcc6fceadfeede4c939ed16d13e648833a61dfb611ed8"
-
-[[package]]
-name = "winnow"
-version = "0.5.40"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "f593a95398737aeed53e489c785df13f3618e41dbcd6718c6addbf1395aa6876"
-dependencies = [
- "memchr",
-]
-
-[[package]]
-name = "zerocopy"
-version = "0.7.32"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "74d4d3961e53fa4c9a25a8637fc2bfaf2595b3d3ae34875568a5cf64787716be"
-dependencies = [
- "zerocopy-derive",
-]
-
-[[package]]
-name = "zerocopy-derive"
-version = "0.7.32"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "9ce1b18ccd8e73a9321186f97e46f9f04b778851177567b1975109d26a08d2a6"
-dependencies = [
- "proc-macro2",
- "quote",
- "syn",
-]
-
-[[package]]
-name = "zeroize"
-version = "1.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "525b4ec142c6b68a2d10f01f7bbf6755599ca3f81ea53b8431b7dd348f5fdb2d"
diff --git a/tools/external_crates/Cargo.toml b/tools/external_crates/Cargo.toml
index f0b017094..cfcb6d71a 100644
--- a/tools/external_crates/Cargo.toml
+++ b/tools/external_crates/Cargo.toml
@@ -1,6 +1,10 @@
 [workspace]
 members = [
     "crate_health",
-    "crate_health_proc_macros",
+    "google_metadata",
+    "license_checker",
+    "name_and_version",
+    "name_and_version_proc_macros",
+    "rooted_path",
 ]
 resolver = "2"
diff --git a/tools/external_crates/android_cargo.py b/tools/external_crates/android_cargo.py
new file mode 100755
index 000000000..2f3c6ac99
--- /dev/null
+++ b/tools/external_crates/android_cargo.py
@@ -0,0 +1,36 @@
+#!/usr/bin/env python3
+
+# Copyright (C) 2024 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+import os
+from pathlib import Path
+import sys
+
+
+def main() -> None:
+  prebuilt_bin = (
+      (
+          Path(__file__).resolve().parents[3]
+          / "prebuilts/rust/linux-x86/stable/rust-analyzer"
+      )
+      .resolve()
+      .parents[0]
+  )
+  os.environ["PATH"] = os.pathsep.join([str(prebuilt_bin), os.environ["PATH"]])
+  os.execv(prebuilt_bin / "cargo", sys.argv)
+
+
+if __name__ == "__main__":
+  main()
diff --git a/tools/external_crates/cargo_embargo.json b/tools/external_crates/cargo_embargo.json
new file mode 100644
index 000000000..c2983b374
--- /dev/null
+++ b/tools/external_crates/cargo_embargo.json
@@ -0,0 +1,24 @@
+{
+  "package": {
+    "rooted_path": {
+      "device_supported": false
+    },
+    "google_metadata": {
+      "device_supported": false,
+      "add_toplevel_block": "google_metadata/cargo_embargo_protobuf.bp",
+      "patch": "google_metadata/patches/Android.bp.patch"
+    },
+    "name_and_version": {
+      "device_supported": false
+    },
+    "name_and_version_proc_macros": {
+      "device_supported": false
+    }
+  },
+  "tests": true,
+  "workspace": true,
+  "workspace_excludes": [
+    "crate_health",
+    "license_checker"
+  ]
+}
diff --git a/tools/external_crates/crate_health/Cargo.toml b/tools/external_crates/crate_health/Cargo.toml
index 186385e26..4c12fb5f6 100644
--- a/tools/external_crates/crate_health/Cargo.toml
+++ b/tools/external_crates/crate_health/Cargo.toml
@@ -7,20 +7,32 @@ edition = "2021"
 
 [dependencies]
 anyhow = "1"
-cargo = "0.73"
+cargo = "0.76"
+chrono = "0.4"
 clap = { version = "4.4.6", features = ["derive"] }
 glob = "0.3"
 itertools = "0.11"
 num_cpus = "1"
+protobuf = "3"
+reqwest = { version = "0.12.5", features = ["blocking"] }
 semver = "1"
 serde = { version = "1", features = ["derive"] }
 serde_json = "1"
+spdx = "0.10"
 thiserror = "1"
 threadpool = "1"
 tinytemplate = "1.2"
 walkdir = "2"
 whoami = "1"
-crate_health_proc_macros = { path = "../crate_health_proc_macros" }
+google_metadata = { path = "../google_metadata"}
+license_checker = { path = "../license_checker" }
+name_and_version = { path = "../name_and_version" }
+name_and_version_proc_macros = { path = "../name_and_version_proc_macros" }
+rooted_path = { path = "../rooted_path" }
+
+[build-dependencies]
+protobuf-codegen = "3"
+protobuf-parse = "3"
 
 [dev-dependencies]
 tempfile = "3"
diff --git a/tools/external_crates/crate_health/src/android_bp.rs b/tools/external_crates/crate_health/src/android_bp.rs
index ec5b937c1..2e94cda87 100644
--- a/tools/external_crates/crate_health/src/android_bp.rs
+++ b/tools/external_crates/crate_health/src/android_bp.rs
@@ -15,16 +15,19 @@
 use std::{
     collections::BTreeMap,
     env,
+    ffi::OsString,
+    fs::{copy, remove_file, rename},
     path::Path,
     process::{Command, Output},
-    str::from_utf8,
     sync::mpsc::channel,
 };
 
 use anyhow::{anyhow, Context, Result};
+use name_and_version::{NameAndVersion, NameAndVersionMap, NamedAndVersioned};
+use rooted_path::RootedPath;
 use threadpool::ThreadPool;
 
-use crate::{Crate, NameAndVersion, NameAndVersionMap, NamedAndVersioned, RepoPath};
+use crate::Crate;
 
 pub fn generate_android_bps<'a, T: Iterator<Item = &'a Crate>>(
     crates: T,
@@ -40,7 +43,7 @@ pub fn generate_android_bps<'a, T: Iterator<Item = &'a Crate>>(
         let crate_version = krate.version().clone();
         let staging_path = krate.staging_path();
         pool.execute(move || {
-            tx.send((crate_name, crate_version, generate_android_bp(&staging_path)))
+            tx.send((crate_name, crate_version, run_cargo_embargo(&staging_path)))
                 .expect("Failed to send");
         });
     }
@@ -51,22 +54,8 @@ pub fn generate_android_bps<'a, T: Iterator<Item = &'a Crate>>(
     Ok(results)
 }
 
-pub(crate) fn generate_android_bp(staging_path: &RepoPath) -> Result<Output> {
-    let generate_android_bp_output = run_cargo_embargo(staging_path)?;
-    if !generate_android_bp_output.status.success() {
-        println!(
-            "cargo_embargo failed for {}\nstdout:\n{}\nstderr:\n{}",
-            staging_path,
-            from_utf8(&generate_android_bp_output.stdout)?,
-            from_utf8(&generate_android_bp_output.stderr)?
-        );
-    }
-    Ok(generate_android_bp_output)
-}
-
-fn run_cargo_embargo(staging_path: &RepoPath) -> Result<Output> {
-    // Make sure we can find bpfmt.
-    let host_bin = staging_path.with_same_root(&"out/host/linux-x86/bin").abs();
+fn add_bpfmt_to_path(repo_root: impl AsRef<Path>) -> Result<OsString> {
+    let host_bin = repo_root.as_ref().join("prebuilts/build-tools/linux-x86/bin");
     let new_path = match env::var_os("PATH") {
         Some(p) => {
             let mut paths = vec![host_bin];
@@ -75,22 +64,56 @@ fn run_cargo_embargo(staging_path: &RepoPath) -> Result<Output> {
         }
         None => host_bin.as_os_str().into(),
     };
+    Ok(new_path)
+}
+
+fn run_cargo_embargo(staging_path: &RootedPath) -> Result<Output> {
+    maybe_build_cargo_embargo(&staging_path.root(), false)?;
+    let new_path = add_bpfmt_to_path(staging_path.root())?;
+
+    let cargo_lock = staging_path.join("Cargo.lock")?;
+    let saved_cargo_lock = staging_path.join("Cargo.lock.saved")?;
+    if cargo_lock.abs().exists() {
+        copy(&cargo_lock, &saved_cargo_lock)?;
+    }
 
     let mut cmd =
-        Command::new(staging_path.with_same_root(&"out/host/linux-x86/bin/cargo_embargo").abs());
-    cmd.args(["generate", "cargo_embargo.json"])
+        Command::new(staging_path.with_same_root("out/host/linux-x86/bin/cargo_embargo")?.abs());
+    let output = cmd
+        .args(["generate", "cargo_embargo.json"])
         .env("PATH", new_path)
         .env("ANDROID_BUILD_TOP", staging_path.root())
-        .current_dir(staging_path.abs())
+        .env_remove("OUT_DIR")
+        .current_dir(staging_path)
+        .output()
+        .context(format!("Failed to execute {:?}", cmd.get_program()))?;
+
+    if cargo_lock.abs().exists() {
+        remove_file(&cargo_lock)?;
+    }
+    if saved_cargo_lock.abs().exists() {
+        rename(saved_cargo_lock, cargo_lock)?;
+    }
+
+    Ok(output)
+}
+
+pub fn cargo_embargo_autoconfig(path: &RootedPath) -> Result<Output> {
+    maybe_build_cargo_embargo(&path.root(), false)?;
+    let new_path = add_bpfmt_to_path(path.root())?;
+
+    let mut cmd = Command::new(path.with_same_root("out/host/linux-x86/bin/cargo_embargo")?.abs());
+    cmd.args(["autoconfig", "cargo_embargo.json"])
+        .env("PATH", new_path)
+        .env("ANDROID_BUILD_TOP", path.root())
+        .env_remove("OUT_DIR")
+        .current_dir(path)
         .output()
         .context(format!("Failed to execute {:?}", cmd.get_program()))
 }
 
 pub fn maybe_build_cargo_embargo(repo_root: &impl AsRef<Path>, force_rebuild: bool) -> Result<()> {
-    if !force_rebuild
-        && repo_root.as_ref().join("out/host/linux-x86/bin/cargo_embargo").exists()
-        && repo_root.as_ref().join("out/host/linux-x86/bin/bpfmt").exists()
-    {
+    if !force_rebuild && repo_root.as_ref().join("out/host/linux-x86/bin/cargo_embargo").exists() {
         Ok(())
     } else {
         println!("Rebuilding cargo_embargo");
@@ -100,12 +123,12 @@ pub fn maybe_build_cargo_embargo(repo_root: &impl AsRef<Path>, force_rebuild: bo
 
 pub fn build_cargo_embargo(repo_root: &impl AsRef<Path>) -> Result<()> {
     let status = Command::new("/usr/bin/bash")
-        .args(["-c", "source build/envsetup.sh && lunch aosp_cf_x86_64_phone-trunk_staging-eng && m cargo_embargo bpfmt"])
-        .current_dir(repo_root).spawn().context("Failed to spawn build of cargo embargo and bpfmt")?.wait().context("Failed to wait on child process building cargo embargo and bpfmt")?;
+        .args(["-c", "source build/envsetup.sh && lunch aosp_cf_x86_64_phone-trunk_staging-eng && m cargo_embargo"])
+        .env_remove("OUT_DIR").current_dir(repo_root).spawn().context("Failed to spawn build of cargo embargo")?.wait().context("Failed to wait on child process building cargo embargo")?;
     match status.success() {
         true => Ok(()),
         false => Err(anyhow!(
-            "Building cargo embargo and bpfmt failed with exit code {}",
+            "Building cargo embargo failed with exit code {}",
             status.code().map(|code| { format!("{}", code) }).unwrap_or("(unknown)".to_string())
         )),
     }
diff --git a/tools/external_crates/crate_health/src/bin/health_report.rs b/tools/external_crates/crate_health/src/bin/health_report.rs
deleted file mode 100644
index bb78b33c7..000000000
--- a/tools/external_crates/crate_health/src/bin/health_report.rs
+++ /dev/null
@@ -1,53 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::path::PathBuf;
-
-use anyhow::Result;
-use clap::Parser;
-use crate_health::{
-    default_output_dir, default_repo_root, maybe_build_cargo_embargo, CrateCollection,
-    NameAndVersionMap, ReportEngine,
-};
-
-/// Generate a health report for crates in external/rust/crates
-#[derive(Parser, Debug)]
-#[command(about, long_about = None)]
-struct Args {
-    /// Path to the AOSP repo. Defaults to current working directory.
-    #[arg(long, default_value_os_t=default_repo_root().unwrap_or(PathBuf::from(".")))]
-    repo_root: PathBuf,
-
-    /// Path the health report will be written to.
-    #[arg(long, default_value_os_t=default_output_dir("crate-health-report.html"))]
-    output_path: PathBuf,
-}
-
-fn main() -> Result<()> {
-    let args = Args::parse();
-
-    maybe_build_cargo_embargo(&args.repo_root, false)?;
-
-    let mut cc = CrateCollection::new(args.repo_root);
-    cc.add_from(&"external/rust/crates")?;
-    cc.map_field_mut().retain(|_nv, krate| krate.is_crates_io());
-
-    cc.stage_crates()?;
-    cc.generate_android_bps()?;
-    cc.diff_android_bps()?;
-
-    let re = ReportEngine::new()?;
-
-    Ok(re.health_report(&cc, &args.output_path)?)
-}
diff --git a/tools/external_crates/crate_health/src/bin/migration_report.rs b/tools/external_crates/crate_health/src/bin/migration_report.rs
deleted file mode 100644
index 0901f5378..000000000
--- a/tools/external_crates/crate_health/src/bin/migration_report.rs
+++ /dev/null
@@ -1,50 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::path::PathBuf;
-
-use anyhow::Result;
-use clap::Parser;
-use crate_health::{
-    default_output_dir, default_repo_root, maybe_build_cargo_embargo, migrate, RepoPath,
-    ReportEngine,
-};
-
-/// Generate a health report for crates in external/rust/crates
-#[derive(Parser, Debug)]
-#[command(about, long_about = None)]
-struct Args {
-    /// Path to the AOSP repo. Defaults to current working directory.
-    #[arg(long, default_value_os_t=default_repo_root().unwrap_or(PathBuf::from(".")))]
-    repo_root: PathBuf,
-
-    /// Path the health report will be written to.
-    #[arg(long, default_value_os_t=default_output_dir("crate-migration-report.html"))]
-    output_path: PathBuf,
-}
-
-fn main() -> Result<()> {
-    let args = Args::parse();
-
-    maybe_build_cargo_embargo(&args.repo_root, false)?;
-
-    let migration = migrate(
-        RepoPath::new(args.repo_root.clone(), &"external/rust/crates"),
-        RepoPath::new(args.repo_root.clone(), &"out/rust-crate-migration-report"),
-    )?;
-
-    let re = ReportEngine::new()?;
-
-    Ok(re.migration_report(&migration, &args.output_path)?)
-}
diff --git a/tools/external_crates/crate_health/src/crate_collection.rs b/tools/external_crates/crate_health/src/crate_collection.rs
index 7aef6cec3..e143f3441 100644
--- a/tools/external_crates/crate_health/src/crate_collection.rs
+++ b/tools/external_crates/crate_health/src/crate_collection.rs
@@ -12,21 +12,20 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
-use crate_health_proc_macros::NameAndVersionMap;
+use name_and_version::{NameAndVersion, NameAndVersionMap, NamedAndVersioned};
+use name_and_version_proc_macros::NameAndVersionMap;
+use rooted_path::RootedPath;
 
 use std::{
     collections::HashSet,
     path::{Path, PathBuf},
 };
 
-use anyhow::{anyhow, Result};
+use anyhow::Result;
 use semver::Version;
 use walkdir::WalkDir;
 
-use crate::{
-    android_bp::generate_android_bps, Crate, CrateError, NameAndVersion, NameAndVersionMap,
-    NamedAndVersioned,
-};
+use crate::{Crate, CrateError};
 
 use std::collections::BTreeMap;
 
@@ -40,11 +39,14 @@ impl CrateCollection {
     pub fn new<P: Into<PathBuf>>(repo_root: P) -> CrateCollection {
         CrateCollection { crates: BTreeMap::new(), repo_root: repo_root.into() }
     }
-    pub fn add_from(&mut self, path: &impl AsRef<Path>) -> Result<()> {
+    pub fn add_from(&mut self, path: impl AsRef<Path>) -> Result<()> {
         for entry_or_err in WalkDir::new(self.repo_root.join(path)) {
             let entry = entry_or_err?;
             if entry.file_name() == "Cargo.toml" {
-                match Crate::from(&entry.path(), &self.repo_root.as_path()) {
+                match Crate::from(RootedPath::new(
+                    self.repo_root.clone(),
+                    entry.path().strip_prefix(&self.repo_root)?,
+                )?) {
                     Ok(krate) => self.crates.insert_or_error(
                         NameAndVersion::new(krate.name().to_string(), krate.version().clone()),
                         krate,
@@ -58,34 +60,4 @@ impl CrateCollection {
         }
         Ok(())
     }
-    pub fn repo_root(&self) -> &Path {
-        self.repo_root.as_path()
-    }
-    pub fn print(&self) -> Result<()> {
-        for krate in self.crates.values() {
-            krate.print()?
-        }
-        Ok(())
-    }
-    pub fn stage_crates(&self) -> Result<()> {
-        for krate in self.crates.values() {
-            krate.stage_crate()?
-        }
-        Ok(())
-    }
-    pub fn generate_android_bps(&mut self) -> Result<()> {
-        for (nv, output) in generate_android_bps(self.crates.values())?.into_iter() {
-            self.crates
-                .get_mut(&nv)
-                .ok_or(anyhow!("Failed to get crate {} {}", nv.name(), nv.version()))?
-                .set_generate_android_bp_output(output);
-        }
-        Ok(())
-    }
-    pub fn diff_android_bps(&mut self) -> Result<()> {
-        for krate in self.crates.values_mut() {
-            krate.diff_android_bp()?;
-        }
-        Ok(())
-    }
 }
diff --git a/tools/external_crates/crate_health/src/crate_type.rs b/tools/external_crates/crate_health/src/crate_type.rs
index bfe7d9119..195de4b87 100644
--- a/tools/external_crates/crate_health/src/crate_type.rs
+++ b/tools/external_crates/crate_health/src/crate_type.rs
@@ -14,9 +14,8 @@
 
 use std::{
     fs::{read_dir, remove_dir_all},
-    path::{Path, PathBuf},
+    path::Path,
     process::{Command, Output},
-    str::from_utf8,
 };
 
 use anyhow::{anyhow, Context, Result};
@@ -25,20 +24,19 @@ use cargo::{
     util::toml::read_manifest,
     Config,
 };
+use name_and_version::{IsUpgradableTo, NameAndVersionRef, NamedAndVersioned};
+use rooted_path::RootedPath;
 use semver::Version;
 
-use crate::{
-    copy_dir, ensure_exists_and_empty, name_and_version::IsUpgradableTo, CrateError,
-    NameAndVersionRef, NamedAndVersioned, RepoPath,
-};
+use crate::{copy_dir, ensure_exists_and_empty, generate_android_bps, CrateError};
 
 #[derive(Debug)]
 pub struct Crate {
     manifest: Manifest,
 
-    path: RepoPath,
+    path: RootedPath,
 
-    patch_output: Vec<Output>,
+    patch_output: Vec<(String, Output)>,
     generate_android_bp_output: Option<Output>,
     android_bp_diff: Option<Output>,
 }
@@ -50,7 +48,7 @@ impl NamedAndVersioned for Crate {
     fn version(&self) -> &Version {
         self.manifest.version()
     }
-    fn key<'k>(&'k self) -> NameAndVersionRef<'k> {
+    fn key(&self) -> NameAndVersionRef {
         NameAndVersionRef::new(self.name(), self.version())
     }
 }
@@ -58,54 +56,62 @@ impl NamedAndVersioned for Crate {
 impl IsUpgradableTo for Crate {}
 
 impl Crate {
-    pub fn new<P: Into<PathBuf>, Q: Into<PathBuf>>(
-        manifest: Manifest,
-        root: P,
-        relpath: Q,
-    ) -> Crate {
-        let root: PathBuf = root.into();
+    pub fn new(manifest: Manifest, path: RootedPath) -> Crate {
         Crate {
             manifest,
-            path: RepoPath::new(root.clone(), relpath),
+            path,
             patch_output: Vec::new(),
             generate_android_bp_output: None,
             android_bp_diff: None,
         }
     }
-    pub fn from<P: Into<PathBuf>>(cargo_toml: &impl AsRef<Path>, root: P) -> Result<Crate> {
-        let root: PathBuf = root.into();
-        let manifest_dir = cargo_toml.as_ref().parent().ok_or(anyhow!(
-            "Failed to get parent directory of manifest at {}",
-            cargo_toml.as_ref().display()
-        ))?;
-        let relpath = manifest_dir.strip_prefix(&root)?.to_path_buf();
-        let source_id = SourceId::for_path(manifest_dir)?;
+    pub fn from(cargo_toml: RootedPath) -> Result<Crate> {
+        let manifest_dir =
+            cargo_toml.with_same_root(cargo_toml.rel().parent().ok_or(anyhow!(
+                "Failed to get parent directory of manifest at {}",
+                cargo_toml
+            ))?)?;
+        let source_id = SourceId::for_path(manifest_dir.abs())?;
         let (manifest, _nested) =
             read_manifest(cargo_toml.as_ref(), source_id, &Config::default()?)?;
         match manifest {
-            cargo::core::EitherManifest::Real(r) => Ok(Crate::new(r, root, relpath)),
+            cargo::core::EitherManifest::Real(r) => Ok(Crate::new(r, manifest_dir)),
             cargo::core::EitherManifest::Virtual(_) => {
                 Err(anyhow!(CrateError::VirtualCrate(cargo_toml.as_ref().to_path_buf())))
             }
         }
     }
 
-    pub fn path(&self) -> &RepoPath {
+    pub fn description(&self) -> &str {
+        self.manifest.metadata().description.as_deref().unwrap_or("")
+    }
+    pub fn license(&self) -> Option<&str> {
+        self.manifest.metadata().license.as_deref()
+    }
+    pub fn license_file(&self) -> Option<&str> {
+        self.manifest.metadata().license_file.as_deref()
+    }
+    pub fn repository(&self) -> Option<&str> {
+        self.manifest.metadata().repository.as_deref()
+    }
+    pub fn path(&self) -> &RootedPath {
         &self.path
     }
-    pub fn android_bp(&self) -> RepoPath {
-        self.path.join(&"Android.bp")
+    pub fn android_bp(&self) -> RootedPath {
+        self.path.join("Android.bp").unwrap()
     }
-    pub fn cargo_embargo_json(&self) -> RepoPath {
-        self.path.join(&"cargo_embargo.json")
+    pub fn cargo_embargo_json(&self) -> RootedPath {
+        self.path.join("cargo_embargo.json").unwrap()
     }
-    pub fn staging_path(&self) -> RepoPath {
-        self.path.with_same_root(
-            Path::new("out/rust-crate-temporary-build").join(self.staging_dir_name()),
-        )
+    pub fn staging_path(&self) -> RootedPath {
+        self.path
+            .with_same_root("out/rust-crate-temporary-build")
+            .unwrap()
+            .join(self.staging_dir_name())
+            .unwrap()
     }
-    pub fn patch_dir(&self) -> RepoPath {
-        self.staging_path().join(&"patches")
+    pub fn patch_dir(&self) -> RootedPath {
+        self.staging_path().join("patches").unwrap()
     }
     pub fn staging_dir_name(&self) -> String {
         if let Some(dirname) = self.path.rel().file_name().and_then(|x| x.to_str()) {
@@ -113,59 +119,25 @@ impl Crate {
                 return dirname.to_string();
             }
         }
-        format!("{}-{}", self.name(), self.version().to_string())
-    }
-
-    pub fn aosp_url(&self) -> Option<String> {
-        if self.path.rel().starts_with("external/rust/crates") {
-            if self.path.rel().ends_with(self.name()) {
-                Some(format!(
-                    "https://android.googlesource.com/platform/{}/+/refs/heads/main",
-                    self.path()
-                ))
-            } else if self.path.rel().parent()?.ends_with(self.name()) {
-                Some(format!(
-                    "https://android.googlesource.com/platform/{}/+/refs/heads/main/{}",
-                    self.path().rel().parent()?.display(),
-                    self.path().rel().file_name()?.to_str()?
-                ))
-            } else {
-                None
-            }
-        } else {
-            None
-        }
-    }
-    pub fn crates_io_url(&self) -> String {
-        format!("https://crates.io/crates/{}", self.name())
+        format!("{}-{}", self.name(), self.version())
     }
 
-    pub fn is_crates_io(&self) -> bool {
-        const NOT_CRATES_IO: &'static [&'static str] = &[
-            "external/rust/beto-rust/",                 // Google crates
-            "external/rust/pica/",                      // Google crate
-            "external/rust/crates/webpki/third-party/", // Internal/example code
-            "external/rust/cxx/third-party/",           // Internal/example code
-            "external/rust/cxx/demo/",                  // Internal/example code
-        ];
-        !NOT_CRATES_IO.iter().any(|prefix| self.path().rel().starts_with(prefix))
-    }
     pub fn is_migration_denied(&self) -> bool {
-        const MIGRATION_DENYLIST: &'static [&'static str] = &[
+        const MIGRATION_DENYLIST: &[&str] = &[
             "external/rust/crates/openssl/", // It's complicated.
             "external/rust/cxx/",            // It's REALLY complicated.
         ];
         MIGRATION_DENYLIST.iter().any(|prefix| self.path().rel().starts_with(prefix))
     }
+
     pub fn is_android_bp_healthy(&self) -> bool {
-        !self.is_migration_denied()
-            && self.android_bp().abs().exists()
+        self.android_bp().abs().exists()
             && self.cargo_embargo_json().abs().exists()
             && self.generate_android_bp_success()
             && self.android_bp_unchanged()
     }
     pub fn patch_success(&self) -> bool {
-        self.patch_output.iter().all(|output| output.status.success())
+        self.patch_output.iter().all(|output| output.1.status.success())
     }
     pub fn generate_android_bp_success(&self) -> bool {
         self.generate_android_bp_output.as_ref().is_some_and(|output| output.status.success())
@@ -174,44 +146,37 @@ impl Crate {
         self.android_bp_diff.as_ref().is_some_and(|output| output.status.success())
     }
 
-    pub fn print(&self) -> Result<()> {
-        println!("{} {} {}", self.name(), self.version(), self.path());
-        if let Some(output) = &self.generate_android_bp_output {
-            println!("generate Android.bp exit status: {}", output.status);
-            println!("{}", from_utf8(&output.stdout)?);
-            println!("{}", from_utf8(&output.stderr)?);
-        }
-        if let Some(output) = &self.android_bp_diff {
-            println!("diff exit status: {}", output.status);
-            println!("{}", from_utf8(&output.stdout)?);
-            println!("{}", from_utf8(&output.stderr)?);
-        }
-        Ok(())
-    }
-
     // Make a clean copy of the crate in out/
     pub fn stage_crate(&self) -> Result<()> {
-        let staging_path_absolute = self.staging_path().abs();
-        ensure_exists_and_empty(&staging_path_absolute)?;
-        remove_dir_all(&staging_path_absolute)
-            .context(format!("Failed to remove {}", staging_path_absolute.display()))?;
-        copy_dir(&self.path().abs(), &staging_path_absolute).context(format!(
+        let staging_path = self.staging_path();
+        ensure_exists_and_empty(&staging_path)?;
+        remove_dir_all(&staging_path).context(format!("Failed to remove {}", staging_path))?;
+        copy_dir(self.path(), &staging_path).context(format!(
             "Failed to copy {} to {}",
             self.path(),
             self.staging_path()
         ))?;
-        if staging_path_absolute.join(".git").is_dir() {
-            remove_dir_all(staging_path_absolute.join(".git"))
+        if staging_path.join(".git")?.abs().is_dir() {
+            remove_dir_all(staging_path.join(".git")?)
                 .with_context(|| "Failed to remove .git".to_string())?;
         }
         Ok(())
     }
 
+    pub fn generate_android_bp(&mut self) -> Result<()> {
+        let (_, output) = generate_android_bps([&*self].into_iter())?
+            .into_iter()
+            .next()
+            .ok_or(anyhow!("Failed to get next element"))?;
+        self.set_generate_android_bp_output(output);
+        Ok(())
+    }
+
     pub fn diff_android_bp(&mut self) -> Result<()> {
         self.set_diff_output(
             diff_android_bp(
                 &self.android_bp().rel(),
-                &self.staging_path().join(&"Android.bp").rel(),
+                &self.staging_path().join("Android.bp")?.rel(),
                 &self.path.root(),
             )
             .context("Failed to diff Android.bp".to_string())?,
@@ -220,10 +185,10 @@ impl Crate {
     }
 
     pub fn apply_patches(&mut self) -> Result<()> {
-        let patch_dir_absolute = self.patch_dir().abs();
-        if patch_dir_absolute.exists() {
-            for entry in read_dir(&patch_dir_absolute)
-                .context(format!("Failed to read_dir {}", patch_dir_absolute.display()))?
+        let patch_dir = self.patch_dir();
+        if patch_dir.abs().exists() {
+            for entry in
+                read_dir(&patch_dir).context(format!("Failed to read_dir {}", patch_dir))?
             {
                 let entry = entry?;
                 if entry.file_name() == "Android.bp.patch"
@@ -236,17 +201,12 @@ impl Crate {
                 let output = Command::new("patch")
                     .args(["-p1", "-l", "--no-backup-if-mismatch", "-i"])
                     .arg(&entry_path)
-                    .current_dir(self.staging_path().abs())
+                    .current_dir(self.staging_path())
                     .output()?;
-                if !output.status.success() {
-                    println!(
-                        "Failed to apply {}\nstdout:\n{}\nstderr:\n:{}",
-                        entry_path.display(),
-                        from_utf8(&output.stdout)?,
-                        from_utf8(&output.stderr)?
-                    );
-                }
-                self.patch_output.push(output);
+                self.patch_output.push((
+                    String::from_utf8_lossy(entry.file_name().as_encoded_bytes()).to_string(),
+                    output,
+                ));
             }
         }
         Ok(())
@@ -258,48 +218,32 @@ impl Crate {
     pub fn generate_android_bp_output(&self) -> Option<&Output> {
         self.generate_android_bp_output.as_ref()
     }
-    pub fn set_generate_android_bp_output(&mut self, c2a_output: Output) {
-        self.generate_android_bp_output.replace(c2a_output);
+    pub fn set_generate_android_bp_output(&mut self, cargo_embargo_output: Output) {
+        self.generate_android_bp_output.replace(cargo_embargo_output);
     }
     pub fn set_diff_output(&mut self, diff_output: Output) {
         self.android_bp_diff.replace(diff_output);
     }
-    pub fn set_patch_output(&mut self, patch_output: Vec<Output>) {
-        self.patch_output = patch_output;
-    }
-}
-
-pub trait Migratable {
-    fn is_migration_eligible(&self) -> bool;
-    fn is_migratable(&self) -> bool;
-}
-
-impl Migratable for Crate {
-    fn is_migration_eligible(&self) -> bool {
-        self.is_crates_io()
-            && !self.is_migration_denied()
-            && self.android_bp().abs().exists()
-            && self.cargo_embargo_json().abs().exists()
-    }
-    fn is_migratable(&self) -> bool {
-        self.patch_success() && self.generate_android_bp_success() && self.android_bp_unchanged()
+    pub fn patch_output(&self) -> &Vec<(String, Output)> {
+        &self.patch_output
     }
 }
 
 #[cfg(test)]
 mod tests {
-    use std::fs::{create_dir, write};
+    use std::{
+        fs::{create_dir, write},
+        path::PathBuf,
+    };
 
     use super::*;
     use anyhow::anyhow;
     use tempfile::tempdir;
 
-    fn write_test_manifest(temp_crate_dir: &Path, name: &str, version: &str) -> Result<PathBuf> {
+    fn write_test_manifest(temp_crate_dir: &Path, name: &str, version: &str) -> Result<RootedPath> {
         let cargo_toml: PathBuf = [temp_crate_dir, &Path::new("Cargo.toml")].iter().collect();
-        write(
-            cargo_toml.as_path(),
-            format!("[package]\nname = \"{}\"\nversion = \"{}\"\n", name, version),
-        )?;
+        let cargo_toml = RootedPath::new("/", cargo_toml.strip_prefix("/")?)?;
+        write(&cargo_toml, format!("[package]\nname = \"{}\"\nversion = \"{}\"\n", name, version))?;
         let lib_rs: PathBuf = [temp_crate_dir, &Path::new("src/lib.rs")].iter().collect();
         create_dir(lib_rs.parent().ok_or(anyhow!("Failed to get parent"))?)?;
         write(lib_rs.as_path(), "// foo")?;
@@ -310,10 +254,9 @@ mod tests {
     fn test_from_and_properties() -> Result<()> {
         let temp_crate_dir = tempdir()?;
         let cargo_toml = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
-        let krate = Crate::from(&cargo_toml, &"/")?;
+        let krate = Crate::from(cargo_toml)?;
         assert_eq!(krate.name(), "foo");
         assert_eq!(krate.version().to_string(), "1.2.0");
-        assert!(krate.is_crates_io());
         assert_eq!(krate.android_bp().abs(), temp_crate_dir.path().join("Android.bp"));
         assert_eq!(
             krate.cargo_embargo_json().abs(),
@@ -326,7 +269,7 @@ mod tests {
     fn test_from_error() -> Result<()> {
         let temp_crate_dir = tempdir()?;
         let cargo_toml = write_test_manifest(temp_crate_dir.path(), "foo", "1.2.0")?;
-        assert!(Crate::from(&cargo_toml, &"/blah").is_err());
+        assert!(Crate::from(cargo_toml.join("blah")?).is_err());
         Ok(())
     }
 }
@@ -342,6 +285,8 @@ pub fn diff_android_bp(
             "-w",
             "-B",
             "-I",
+            r#"default_team: "trendy_team_android_rust""#,
+            "-I",
             "// has rustc warnings",
             "-I",
             "This file is generated by",
diff --git a/tools/external_crates/crate_health/src/lib.rs b/tools/external_crates/crate_health/src/lib.rs
index a6f88a150..4775cf430 100644
--- a/tools/external_crates/crate_health/src/lib.rs
+++ b/tools/external_crates/crate_health/src/lib.rs
@@ -15,23 +15,19 @@
 use std::env::current_dir;
 use std::fs::{create_dir_all, remove_dir_all};
 use std::path::{Path, PathBuf};
-use std::process::Command;
+use std::process::{Command, Output};
 use std::str::from_utf8;
 
 use anyhow::{anyhow, Context, Result};
 use semver::Version;
 use thiserror::Error;
 
-pub use self::crate_type::{diff_android_bp, Crate, Migratable};
+pub use self::crate_type::{diff_android_bp, Crate};
 mod crate_type;
 
 pub use self::crate_collection::CrateCollection;
 mod crate_collection;
 
-pub use self::reports::{ReportEngine, SizeReport, Table};
-mod reports;
-
-pub use self::migration::migrate;
 mod migration;
 
 pub use self::pseudo_crate::PseudoCrate;
@@ -40,24 +36,16 @@ mod pseudo_crate;
 pub use self::version_match::{CompatibleVersionPair, VersionMatch, VersionPair};
 mod version_match;
 
-pub use self::android_bp::{build_cargo_embargo, generate_android_bps, maybe_build_cargo_embargo};
+pub use self::android_bp::{
+    build_cargo_embargo, cargo_embargo_autoconfig, generate_android_bps, maybe_build_cargo_embargo,
+};
 mod android_bp;
 
-pub use self::name_and_version::{
-    IsUpgradableTo, NameAndVersion, NameAndVersionRef, NamedAndVersioned,
-};
-mod name_and_version;
+pub use self::license::{most_restrictive_type, update_module_license_files};
+mod license;
 
-pub use self::repo_path::RepoPath;
-mod repo_path;
-
-#[cfg(test)]
-pub use self::name_and_version_map::try_name_version_map_from_iter;
-pub use self::name_and_version_map::{
-    crates_with_multiple_versions, crates_with_single_version, most_recent_version,
-    NameAndVersionMap,
-};
-mod name_and_version_map;
+pub use self::managed_repo::ManagedRepo;
+mod managed_repo;
 
 #[derive(Error, Debug)]
 pub enum CrateError {
@@ -80,34 +68,43 @@ pub fn default_repo_root() -> Result<PathBuf> {
     Err(anyhow!(".repo directory not found in any ancestor of {}", cwd.display()))
 }
 
-pub fn default_output_dir(filename: &str) -> PathBuf {
-    PathBuf::from("/google/data/rw/users")
-        .join(&whoami::username()[..2])
-        .join(whoami::username())
-        .join("www")
-        .join(filename)
-}
-
-pub fn ensure_exists_and_empty(dir: &impl AsRef<Path>) -> Result<()> {
+pub fn ensure_exists_and_empty(dir: impl AsRef<Path>) -> Result<()> {
     let dir = dir.as_ref();
     if dir.exists() {
-        remove_dir_all(&dir).context(format!("Failed to remove {}", dir.display()))?;
+        remove_dir_all(dir).context(format!("Failed to remove {}", dir.display()))?;
     }
-    create_dir_all(&dir).context(format!("Failed to create {}", dir.display()))
+    create_dir_all(dir).context(format!("Failed to create {}", dir.display()))
 }
 
-// The copy_dir crate doesn't handle symlinks.
-pub fn copy_dir(src: &impl AsRef<Path>, dst: &impl AsRef<Path>) -> Result<()> {
-    let output =
-        Command::new("cp").arg("--archive").arg(src.as_ref()).arg(dst.as_ref()).output()?;
-    if !output.status.success() {
-        return Err(anyhow!(
-            "Failed to copy {} to {}\nstdout:\n{}\nstderr:\n{}",
-            src.as_ref().display(),
-            dst.as_ref().display(),
-            from_utf8(&output.stdout)?,
-            from_utf8(&output.stderr)?
-        ));
+pub trait RunQuiet {
+    fn run_quiet_and_expect_success(&mut self) -> Result<Output>;
+}
+impl RunQuiet for Command {
+    fn run_quiet_and_expect_success(&mut self) -> Result<Output> {
+        let output = self.output().context(format!("Failed to run {:?}", self))?;
+        if !output.status.success() {
+            return Err(anyhow!(
+                "Exit status {} for {:?}\nSTDOUT:\n{}\nSTDERR:\n{}",
+                output
+                    .status
+                    .code()
+                    .map(|code| { format!("{}", code) })
+                    .unwrap_or("(unknown)".to_string()),
+                self,
+                from_utf8(&output.stdout)?,
+                from_utf8(&output.stderr)?
+            ));
+        }
+        Ok(output)
     }
+}
+
+// The copy_dir crate doesn't handle symlinks.
+pub fn copy_dir(src: impl AsRef<Path>, dst: impl AsRef<Path>) -> Result<()> {
+    Command::new("cp")
+        .arg("--archive")
+        .arg(src.as_ref())
+        .arg(dst.as_ref())
+        .run_quiet_and_expect_success()?;
     Ok(())
 }
diff --git a/tools/external_crates/crate_health/src/license.rs b/tools/external_crates/crate_health/src/license.rs
new file mode 100644
index 000000000..46470ff29
--- /dev/null
+++ b/tools/external_crates/crate_health/src/license.rs
@@ -0,0 +1,108 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::BTreeMap,
+    fs::{remove_file, write},
+    path::Path,
+    sync::LazyLock,
+};
+
+use anyhow::{anyhow, Result};
+use glob::glob;
+use google_metadata::metadata::LicenseType;
+use license_checker::LicenseState;
+use spdx::{LicenseReq, Licensee};
+
+/// Update MODULE_LICENSE_* files in a directory based on the applicable licenses.
+/// These files are typically empty, and their name indicates the type of license that
+/// applies to the code, for example MODULE_LICENSE_APACHE2.
+pub fn update_module_license_files(path: &impl AsRef<Path>, licenses: &LicenseState) -> Result<()> {
+    let path = path.as_ref();
+    for old_module_license_file in glob(
+        path.join("MODULE_LICENSE*").to_str().ok_or(anyhow!("Failed to convert path to string"))?,
+    )? {
+        remove_file(old_module_license_file?)?;
+    }
+    for license in licenses.satisfied.keys().chain(&licenses.unsatisfied) {
+        if let Some(mod_lic) = MODULE_LICENSE_FILES.get(license) {
+            write(path.join(mod_lic), "")?; // Write an empty file. Essentially "touch".
+        }
+    }
+    Ok(())
+}
+
+fn discriminant(lt: LicenseType) -> u8 {
+    // Smaller --> more restricted
+    // Larger --> less restricted
+    match lt {
+        LicenseType::UNKNOWN => 0,
+        LicenseType::BY_EXCEPTION_ONLY => 1,
+        LicenseType::RESTRICTED => 2,
+        LicenseType::RESTRICTED_IF_STATICALLY_LINKED => 3,
+        LicenseType::RECIPROCAL => 4,
+        LicenseType::NOTICE => 5,
+        LicenseType::PERMISSIVE => 6,
+        LicenseType::UNENCUMBERED => 7,
+    }
+}
+
+pub fn most_restrictive_type(licenses: &LicenseState) -> LicenseType {
+    licenses
+        .satisfied
+        .keys()
+        .chain(&licenses.unsatisfied)
+        .map(|req| LICENSE_TYPES.get(req).cloned().unwrap_or(LicenseType::UNKNOWN))
+        .min_by(|a, b| discriminant(*a).cmp(&discriminant(*b)))
+        .unwrap_or(LicenseType::UNKNOWN)
+}
+
+static MODULE_LICENSE_FILES: LazyLock<BTreeMap<LicenseReq, &'static str>> = LazyLock::new(|| {
+    vec![
+        ("Apache-2.0", "MODULE_LICENSE_APACHE2"),
+        ("MIT", "MODULE_LICENSE_MIT"),
+        ("BSD-3-Clause", "MODULE_LICENSE_BSD"),
+        ("BSD-2-Clause", "MODULE_LICENSE_BSD"),
+        ("ISC", "MODULE_LICENSE_ISC"),
+        ("MPL-2.0", "MODULE_LICENSE_MPL"),
+        ("0BSD", "MODULE_LICENSE_PERMISSIVE"),
+        ("Unlicense", "MODULE_LICENSE_PERMISSIVE"),
+        ("Zlib", "MODULE_LICENSE_ZLIB"),
+        ("Unicode-DFS-2016", "MODULE_LICENSE_UNICODE"),
+        ("NCSA", "MODULE_LICENSE_NCSA"),
+        ("OpenSSL", "MODULE_LICENSE_OPENSSL"),
+    ]
+    .into_iter()
+    .map(|l| (Licensee::parse(l.0).unwrap().into_req(), l.1))
+    .collect()
+});
+static LICENSE_TYPES: LazyLock<BTreeMap<LicenseReq, LicenseType>> = LazyLock::new(|| {
+    vec![
+        ("Apache-2.0", LicenseType::NOTICE),
+        ("MIT", LicenseType::NOTICE),
+        ("BSD-3-Clause", LicenseType::NOTICE),
+        ("BSD-2-Clause", LicenseType::NOTICE),
+        ("ISC", LicenseType::NOTICE),
+        ("MPL-2.0", LicenseType::RECIPROCAL),
+        ("0BSD", LicenseType::PERMISSIVE),
+        ("Unlicense", LicenseType::PERMISSIVE),
+        ("Zlib", LicenseType::NOTICE),
+        ("Unicode-DFS-2016", LicenseType::NOTICE),
+        ("NCSA", LicenseType::NOTICE),
+        ("OpenSSL", LicenseType::NOTICE),
+    ]
+    .into_iter()
+    .map(|l| (Licensee::parse(l.0).unwrap().into_req(), l.1))
+    .collect()
+});
diff --git a/tools/external_crates/crate_health/src/main.rs b/tools/external_crates/crate_health/src/main.rs
index 46cd8bcc1..17a4a4a32 100644
--- a/tools/external_crates/crate_health/src/main.rs
+++ b/tools/external_crates/crate_health/src/main.rs
@@ -12,261 +12,103 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
-use std::{path::PathBuf, process::Command, str::from_utf8};
+use std::{collections::BTreeSet, path::PathBuf};
 
-use anyhow::{anyhow, Result};
+use anyhow::Result;
 use clap::{Parser, Subcommand};
-use crate_health::{
-    default_repo_root, maybe_build_cargo_embargo, migrate, CrateCollection, Migratable,
-    NameAndVersionMap, NamedAndVersioned, RepoPath,
-};
+use crate_health::{default_repo_root, maybe_build_cargo_embargo, ManagedRepo};
+use rooted_path::RootedPath;
 
 #[derive(Parser)]
 struct Cli {
     #[command(subcommand)]
     command: Cmd,
 
+    // The path to the Android source repo.
     #[arg(long, default_value_os_t=default_repo_root().unwrap_or(PathBuf::from(".")))]
     repo_root: PathBuf,
 
     /// Rebuild cargo_embargo and bpfmt, even if they are already present in the out directory.
     #[arg(long, default_value_t = false)]
     rebuild_cargo_embargo: bool,
+
+    /// Print command output in case of error, and full diffs.
+    #[arg(long, default_value_t = false)]
+    verbose: bool,
 }
 
 #[derive(Subcommand)]
 enum Cmd {
     /// Check the health of a crate, and whether it is safe to migrate.
     MigrationHealth {
-        /// The crate name. Also the directory name in external/rust/crates
-        crate_name: String,
+        /// The crate names. Also the directory names in external/rust/crates.
+        crates: Vec<String>,
+
+        /// Don't pin the crate version for the specified crates when checking health.
+        #[arg(long, value_parser = parse_crate_list, required=false, default_value="")]
+        unpinned: BTreeSet<String>,
     },
-    /// Migrate a crate from external/rust/crates to the monorepo.
+    /// Migrate crates from external/rust/crates to the monorepo.
     Migrate {
-        /// The crate name. Also the directory name in external/rust/crates
-        crate_name: String,
+        /// The crate names. Also the directory names in external/rust/crates.
+        crates: Vec<String>,
+
+        /// Add the specified crates with unpinned versions.
+        #[arg(long, value_parser = parse_crate_list, required=false, default_value="")]
+        unpinned: BTreeSet<String>,
     },
-    Regenerate {
+    /// Import a crate and its dependencies into the monorepo.
+    Import {
         /// The crate name.
         crate_name: String,
     },
+    /// Regenerate a crate directory.
+    Regenerate {
+        /// The crate names.
+        crates: Vec<String>,
+    },
+    /// Regenerate all crates
+    RegenerateAll {},
     /// Run pre-upload checks.
     PreuploadCheck {
         /// List of changed files
         files: Vec<String>,
     },
+    /// Try to fix problems with license files.
+    FixLicenses {},
+    /// Fix up METADATA files
+    FixMetadata {},
 }
 
-static IGNORED_FILES: &'static [&'static str] = &[
-    ".appveyor.yml",
-    ".bazelci",
-    ".bazelignore",
-    ".bazelrc",
-    ".bazelversion",
-    ".buildkite",
-    ".cargo",
-    ".cargo-checksum.json",
-    ".cargo_vcs_info.json",
-    ".circleci",
-    ".cirrus.yml",
-    ".clang-format",
-    ".clang-tidy",
-    ".clippy.toml",
-    ".clog.toml",
-    ".clog.toml",
-    ".codecov.yaml",
-    ".codecov.yml",
-    ".editorconfig",
-    ".gcloudignore",
-    ".gdbinit",
-    ".git",
-    ".git-blame-ignore-revs",
-    ".git-ignore-revs",
-    ".gitallowed",
-    ".gitattributes",
-    ".github",
-    ".gitignore",
-    ".idea",
-    ".ignore",
-    ".istanbul.yml",
-    ".mailmap",
-    ".md-inc.toml",
-    ".mdl-style.rb",
-    ".mdlrc",
-    ".pylintrc",
-    ".pylintrc-examples",
-    ".pylintrc-tests",
-    ".reuse",
-    ".rspec",
-    ".rustfmt.toml",
-    ".shellcheckrc",
-    ".standard-version",
-    ".tarpaulin.toml",
-    ".tokeignore",
-    ".travis.yml",
-    ".versionrc",
-    ".vim",
-    ".vscode",
-    ".yapfignore",
-    ".yardopts",
-    "BUILD",
-    "Cargo.lock",
-    "Cargo.lock.saved",
-    "Cargo.toml.orig",
-    "OWNERS",
-    // rules.mk related files that we won't migrate.
-    "cargo2rulesmk.json",
-    "CleanSpec.mk",
-    "rules.mk",
-    // cargo_embargo intermediates.
-    "Android.bp.orig",
-    "cargo.metadata",
-    "cargo.out",
-    "target.tmp",
-];
+fn parse_crate_list(arg: &str) -> Result<BTreeSet<String>> {
+    Ok(arg.split(',').map(|k| k.to_string()).collect())
+}
 
 fn main() -> Result<()> {
     let args = Cli::parse();
 
     maybe_build_cargo_embargo(&args.repo_root, args.rebuild_cargo_embargo)?;
 
-    match args.command {
-        Cmd::MigrationHealth { crate_name } => {
-            if args
-                .repo_root
-                .join("external/rust/android-crates-io/crates")
-                .join(&crate_name)
-                .exists()
-            {
-                return Err(anyhow!(
-                    "Crate {} already exists in external/rust/android-crates-io/crates",
-                    crate_name
-                ));
-            }
+    let managed_repo =
+        ManagedRepo::new(RootedPath::new(args.repo_root, "external/rust/android-crates-io")?);
 
-            let mut cc = CrateCollection::new(&args.repo_root);
-            cc.add_from(&PathBuf::from("external/rust/crates").join(&crate_name))?;
-            cc.map_field_mut().retain(|_nv, krate| krate.is_crates_io());
-            if cc.map_field().len() != 1 {
-                return Err(anyhow!(
-                    "Expected a single crate version for {}, but found {}. Crates with multiple versions are not supported yet.",
+    match args.command {
+        Cmd::MigrationHealth { crates, unpinned } => {
+            for crate_name in &crates {
+                managed_repo.migration_health(
                     crate_name,
-                    cc.map_field().len()
-                ));
-            }
-
-            cc.stage_crates()?;
-            cc.generate_android_bps()?;
-            cc.diff_android_bps()?;
-
-            let krate = cc.map_field().values().next().unwrap();
-            println!("Found {} v{} in {}", krate.name(), krate.version(), krate.path());
-            let migratable;
-            if !krate.is_android_bp_healthy() {
-                if krate.is_migration_denied() {
-                    println!("This crate is on the migration denylist");
-                }
-                if !krate.android_bp().abs().exists() {
-                    println!("There is no Android.bp file in {}", krate.path());
-                }
-                if !krate.cargo_embargo_json().abs().exists() {
-                    println!("There is no cargo_embargo.json file in {}", krate.path());
-                } else if !krate.generate_android_bp_success() {
-                    println!("cargo_embargo execution did not succeed for {}", krate.path());
-                } else if !krate.android_bp_unchanged() {
-                    println!(
-                        "Running cargo_embargo on {} produced changes to the Android.bp file:",
-                        krate.path()
-                    );
-                    println!(
-                        "{}",
-                        from_utf8(
-                            &krate
-                                .android_bp_diff()
-                                .ok_or(anyhow!("No Android.bp diff found"))?
-                                .stdout
-                        )?
-                    );
-                }
-                migratable = false;
-            } else {
-                let migration = migrate(
-                    RepoPath::new(
-                        args.repo_root.clone(),
-                        PathBuf::from("external/rust/crates").join(&crate_name),
-                    ),
-                    RepoPath::new(args.repo_root.clone(), &"out/rust-crate-migration-report"),
+                    args.verbose,
+                    unpinned.contains(crate_name),
                 )?;
-                let compatible_pairs = migration.compatible_pairs().collect::<Vec<_>>();
-                if compatible_pairs.len() != 1 {
-                    return Err(anyhow!("Couldn't find a compatible version to migrate to",));
-                }
-                let pair = compatible_pairs.first().unwrap();
-                if pair.source.version() != pair.dest.version() {
-                    println!(
-                        "Source and destination versions are different: {} -> {}",
-                        pair.source.version(),
-                        pair.dest.version()
-                    );
-                }
-                if !pair.dest.is_migratable() {
-                    if !pair.dest.patch_success() {
-                        println!("Patches did not apply successfully to the migrated crate");
-                        // TODO: Show errors.
-                    }
-                    if !pair.dest.generate_android_bp_success() {
-                        println!("cargo_embargo execution did not succeed for the migrated crate");
-                    } else if pair.dest.android_bp_unchanged() {
-                        println!("Running cargo_embargo for the migrated crate produced changes to the Android.bp file:");
-                        println!(
-                            "{}",
-                            from_utf8(
-                                &pair
-                                    .dest
-                                    .android_bp_diff()
-                                    .ok_or(anyhow!("No Android.bp diff found"))?
-                                    .stdout
-                            )?
-                        );
-                    }
-                }
-
-                let diff_status = Command::new("diff")
-                    .args(["-u", "-r", "-w", "--no-dereference"])
-                    .args(IGNORED_FILES.iter().map(|ignored| format!("--exclude={}", ignored)))
-                    .arg(pair.source.path().rel())
-                    .arg(pair.dest.staging_path().rel())
-                    .current_dir(&args.repo_root)
-                    .spawn()?
-                    .wait()?;
-                if !diff_status.success() {
-                    println!(
-                        "Found differences between {} and {}",
-                        pair.source.path(),
-                        pair.dest.staging_path()
-                    );
-                }
-                println!("All diffs:");
-                Command::new("diff")
-                    .args(["-u", "-r", "-w", "-q", "--no-dereference"])
-                    .arg(pair.source.path().rel())
-                    .arg(pair.dest.staging_path().rel())
-                    .current_dir(&args.repo_root)
-                    .spawn()?
-                    .wait()?;
-
-                migratable = pair.dest.is_migratable() && diff_status.success()
             }
-
-            println!(
-                "The crate is {}",
-                if krate.is_android_bp_healthy() && migratable { "healthy" } else { "UNHEALTHY" }
-            );
+            Ok(())
         }
-        Cmd::Migrate { crate_name: _ } => todo!(),
-        Cmd::Regenerate { crate_name: _ } => todo!(),
-        Cmd::PreuploadCheck { files: _ } => todo!(),
+        Cmd::Migrate { crates, unpinned } => managed_repo.migrate(crates, args.verbose, &unpinned),
+        Cmd::Regenerate { crates } => managed_repo.regenerate(crates.iter(), true),
+        Cmd::RegenerateAll {} => managed_repo.regenerate_all(true),
+        Cmd::PreuploadCheck { files } => managed_repo.preupload_check(&files),
+        Cmd::Import { crate_name } => managed_repo.import(&crate_name),
+        Cmd::FixLicenses {} => managed_repo.fix_licenses(),
+        Cmd::FixMetadata {} => managed_repo.fix_metadata(),
     }
-
-    Ok(())
 }
diff --git a/tools/external_crates/crate_health/src/managed_repo.rs b/tools/external_crates/crate_health/src/managed_repo.rs
new file mode 100644
index 000000000..4df3c3114
--- /dev/null
+++ b/tools/external_crates/crate_health/src/managed_repo.rs
@@ -0,0 +1,748 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::BTreeSet,
+    fs::{create_dir, read_dir, remove_dir_all, remove_file, rename, write},
+    os::unix::fs::symlink,
+    path::Path,
+    process::Command,
+    str::from_utf8,
+};
+
+use anyhow::{anyhow, Result};
+use glob::glob;
+use google_metadata::GoogleMetadata;
+use itertools::Itertools;
+use license_checker::find_licenses;
+use name_and_version::{NameAndVersion, NameAndVersionMap, NameAndVersionRef, NamedAndVersioned};
+use rooted_path::RootedPath;
+use semver::Version;
+use spdx::Licensee;
+
+use crate::{
+    cargo_embargo_autoconfig, copy_dir, most_restrictive_type, update_module_license_files, Crate,
+    CrateCollection, PseudoCrate, VersionMatch,
+};
+
+pub struct ManagedRepo {
+    path: RootedPath,
+    pseudo_crate: PseudoCrate,
+}
+
+impl ManagedRepo {
+    pub fn new(path: RootedPath) -> ManagedRepo {
+        let pseudo_crate = PseudoCrate::new(path.join("pseudo_crate").unwrap());
+        ManagedRepo { path, pseudo_crate }
+    }
+    pub fn contains(&self, crate_name: &str) -> bool {
+        self.managed_dir_for(crate_name).abs().exists()
+    }
+    pub fn managed_dir(&self) -> RootedPath {
+        self.path.join("crates").unwrap()
+    }
+    pub fn managed_dir_for(&self, crate_name: &str) -> RootedPath {
+        self.managed_dir().join(crate_name).unwrap()
+    }
+    pub fn vendored_dir_for(&self, crate_name: &str) -> RootedPath {
+        self.pseudo_crate.get_path().join("vendor").unwrap().join(crate_name).unwrap()
+    }
+    pub fn legacy_dir_for(&self, crate_name: &str) -> RootedPath {
+        self.path.with_same_root("external/rust/crates").unwrap().join(crate_name).unwrap()
+    }
+    pub fn new_cc(&self) -> CrateCollection {
+        CrateCollection::new(self.path.root())
+    }
+    pub fn vendored_crates(&self) -> Result<CrateCollection> {
+        let mut cc = self.new_cc();
+        cc.add_from(self.pseudo_crate.get_path().join("vendor")?.rel())?;
+        Ok(cc)
+    }
+    pub fn migration_health(
+        &self,
+        crate_name: &str,
+        verbose: bool,
+        unpinned: bool,
+    ) -> Result<Version> {
+        if self.contains(crate_name) {
+            return Err(anyhow!("Crate {} already exists in {}/crates", crate_name, self.path));
+        }
+
+        let mut cc = self.new_cc();
+        cc.add_from(self.legacy_dir_for(crate_name).rel())?;
+        if cc.map_field().len() != 1 {
+            return Err(anyhow!(
+                "Expected a single crate version for {}, but found {}. Crates with multiple versions are not supported yet.",
+                crate_name,
+                cc.map_field().len()
+            ));
+        }
+
+        let krate = cc.map_field_mut().values_mut().next().unwrap();
+        println!("Found {} v{} in {}", krate.name(), krate.version(), krate.path());
+        krate.stage_crate()?;
+        krate.generate_android_bp()?;
+        krate.diff_android_bp()?;
+        if !krate.is_android_bp_healthy() {
+            let mut show_cargo_embargo_results = true;
+            if krate.is_migration_denied() {
+                println!("This crate is on the migration denylist");
+                show_cargo_embargo_results = false;
+            }
+            if !krate.android_bp().abs().exists() {
+                println!("There is no Android.bp file in {}", krate.path());
+                show_cargo_embargo_results = false;
+            }
+            if !krate.cargo_embargo_json().abs().exists() {
+                show_cargo_embargo_results = false;
+                println!("There is no cargo_embargo.json file in {}", krate.path());
+            }
+            if show_cargo_embargo_results {
+                if !krate.generate_android_bp_success() {
+                    println!(
+                        "cargo_embargo execution did not succeed for {}",
+                        krate.staging_path(),
+                    );
+                    if verbose {
+                        println!(
+                            "stdout:\n{}\nstderr:\n{}",
+                            from_utf8(
+                                &krate
+                                    .generate_android_bp_output()
+                                    .ok_or(anyhow!("cargo_embargo output not found"))?
+                                    .stdout
+                            )?,
+                            from_utf8(
+                                &krate
+                                    .generate_android_bp_output()
+                                    .ok_or(anyhow!("cargo_embargo output not found"))?
+                                    .stderr
+                            )?,
+                        );
+                    }
+                } else if !krate.android_bp_unchanged() {
+                    println!(
+                        "Running cargo_embargo on {} produced changes to the Android.bp file",
+                        krate.path()
+                    );
+                    if verbose {
+                        println!(
+                            "{}",
+                            from_utf8(
+                                &krate
+                                    .android_bp_diff()
+                                    .ok_or(anyhow!("No Android.bp diff found"))?
+                                    .stdout
+                            )?
+                        );
+                    }
+                }
+            }
+            println!("The crate is UNHEALTHY");
+            return Err(anyhow!("Crate {} is unhealthy", crate_name));
+        }
+
+        if unpinned {
+            self.pseudo_crate.add_unpinned(krate)?;
+        } else {
+            self.pseudo_crate.add(krate)?;
+        }
+        self.pseudo_crate.vendor()?;
+
+        let mut source = self.new_cc();
+        source.add_from(self.legacy_dir_for(crate_name).rel())?;
+
+        let dest = self.vendored_crates()?;
+
+        let mut version_match = VersionMatch::new(source, dest)?;
+
+        version_match.stage_crates()?;
+        version_match.copy_customizations()?;
+        version_match.apply_patches()?;
+        version_match.generate_android_bps()?;
+        version_match.diff_android_bps()?;
+
+        self.pseudo_crate.remove(krate)?;
+        self.pseudo_crate.vendor()?;
+
+        let compatible_pairs = version_match.compatible_pairs().collect::<Vec<_>>();
+        if compatible_pairs.len() != 1 {
+            return Err(anyhow!("Couldn't find a compatible version to migrate to",));
+        }
+        let pair = compatible_pairs.first().unwrap();
+        let version = pair.dest.version().clone();
+        if pair.source.version() != pair.dest.version() {
+            println!(
+                "Source and destination versions are different: {} -> {}",
+                pair.source.version(),
+                pair.dest.version()
+            );
+        }
+        if !pair.dest.patch_success() {
+            println!("Patches did not apply successfully to the migrated crate");
+            if verbose {
+                for output in pair.dest.patch_output() {
+                    if !output.1.status.success() {
+                        println!(
+                            "Failed to apply {}\nstdout:\n{}\nstderr:\n:{}",
+                            output.0,
+                            from_utf8(&output.1.stdout)?,
+                            from_utf8(&output.1.stderr)?
+                        );
+                    }
+                }
+            }
+        }
+        if !pair.dest.generate_android_bp_success() {
+            println!("cargo_embargo execution did not succeed for the migrated crate");
+        } else if !pair.dest.android_bp_unchanged() {
+            println!("Running cargo_embargo for the migrated crate produced changes to the Android.bp file");
+            if verbose {
+                println!(
+                    "{}",
+                    from_utf8(
+                        &pair
+                            .dest
+                            .android_bp_diff()
+                            .ok_or(anyhow!("No Android.bp diff found"))?
+                            .stdout
+                    )?
+                );
+            }
+        }
+
+        let mut diff_cmd = Command::new("diff");
+        diff_cmd.args(["-u", "-r", "-w", "--no-dereference"]);
+        if !verbose {
+            diff_cmd.arg("-q");
+        }
+        let diff_status = diff_cmd
+            .args(IGNORED_FILES.iter().map(|ignored| format!("--exclude={}", ignored)))
+            .args(["-I", r#"default_team: "trendy_team_android_rust""#])
+            .arg(pair.source.path().rel())
+            .arg(pair.dest.staging_path().rel())
+            .current_dir(self.path.root())
+            .spawn()?
+            .wait()?;
+        if !diff_status.success() {
+            println!(
+                "Found differences between {} and {}",
+                pair.source.path(),
+                pair.dest.staging_path()
+            );
+        }
+        if verbose {
+            println!("All diffs:");
+            Command::new("diff")
+                .args(["-u", "-r", "-w", "-q", "--no-dereference"])
+                .arg(pair.source.path().rel())
+                .arg(pair.dest.staging_path().rel())
+                .current_dir(self.path.root())
+                .spawn()?
+                .wait()?;
+        }
+
+        if !pair.dest.patch_success()
+            || !pair.dest.generate_android_bp_success()
+            || !pair.dest.android_bp_unchanged()
+        {
+            println!("The crate is UNHEALTHY");
+            return Err(anyhow!("Crate {} is unhealthy", crate_name));
+        }
+
+        if diff_status.success() {
+            println!("The crate is healthy");
+            return Ok(version);
+        }
+
+        if unpinned {
+            println!("The crate was added with an unpinned version, and diffs were found which must be inspected manually");
+            return Ok(version);
+        }
+
+        println!("The crate is UNHEALTHY");
+        Err(anyhow!("Crate {} is unhealthy", crate_name))
+    }
+    pub fn migrate<T: AsRef<str>>(
+        &self,
+        crates: Vec<T>,
+        verbose: bool,
+        unpinned: &BTreeSet<String>,
+    ) -> Result<()> {
+        for crate_name in &crates {
+            let crate_name = crate_name.as_ref();
+            let version =
+                self.migration_health(crate_name, verbose, unpinned.contains(crate_name))?;
+            let src_dir = self.legacy_dir_for(crate_name);
+
+            let monorepo_crate_dir = self.managed_dir();
+            if !monorepo_crate_dir.abs().exists() {
+                create_dir(monorepo_crate_dir)?;
+            }
+            copy_dir(src_dir, self.managed_dir_for(crate_name))?;
+            if unpinned.contains(crate_name) {
+                self.pseudo_crate.add_unpinned(&NameAndVersionRef::new(crate_name, &version))?;
+            } else {
+                self.pseudo_crate.add(&NameAndVersionRef::new(crate_name, &version))?;
+            }
+        }
+
+        self.regenerate(crates.iter(), false)?;
+
+        for crate_name in &crates {
+            let crate_name = crate_name.as_ref();
+            let src_dir = self.legacy_dir_for(crate_name);
+            for entry in glob(
+                src_dir
+                    .abs()
+                    .join("*.bp")
+                    .to_str()
+                    .ok_or(anyhow!("Failed to convert path *.bp to str"))?,
+            )? {
+                remove_file(entry?)?;
+            }
+            remove_file(src_dir.join("cargo_embargo.json")?)?;
+            let test_mapping = src_dir.join("TEST_MAPPING")?;
+            if test_mapping.abs().exists() {
+                remove_file(test_mapping)?;
+            }
+            write(
+                src_dir.join("Android.bp")?,
+                format!("// This crate has been migrated to {}.\n", self.path),
+            )?;
+        }
+
+        Ok(())
+    }
+    pub fn import(&self, crate_name: &str) -> Result<()> {
+        let new_deps = self.add_crate_and_dependencies(crate_name)?;
+
+        for dep in &new_deps {
+            println!("Sprinkling Android glitter on {}", dep);
+
+            if self.contains(dep) {
+                return Err(anyhow!(
+                    "Crate {} already exists at {}",
+                    dep,
+                    self.managed_dir_for(dep)
+                ));
+            }
+            if self.legacy_dir_for(dep).abs().exists() {
+                return Err(anyhow!(
+                    "Legacy crate {} already exists at {}",
+                    dep,
+                    self.legacy_dir_for(dep)
+                ));
+            }
+
+            let vendored_dir = self.vendored_dir_for(dep);
+            let managed_dir = self.managed_dir_for(dep);
+            copy_dir(vendored_dir.abs(), managed_dir.abs())?;
+
+            // TODO: Copy to a temp dir, because otherwise we might run cargo and create/modify Cargo.lock.
+            let output = cargo_embargo_autoconfig(&managed_dir)?;
+            if !output.status.success() {
+                // TODO: Maybe just write a default cargo_embargo.json if cargo_embargo fails horribly.
+                // There is one pathological crate out there (unarray) where the version published
+                // to crates.io doesn't compile, and cargo_embargo relies on at least being
+                // able to compile successfully. In such case, we may need to do:
+                //  write(managed_dir.abs().join("cargo_embargo.json"), "{}")?;
+                return Err(anyhow!(
+                    "Failed to generate cargo_embargo.json:\nSTDOUT:\n{}\nSTDERR:\n{}",
+                    from_utf8(&output.stdout)?,
+                    from_utf8(&output.stderr)?
+                ));
+            }
+
+            let krate = Crate::from(managed_dir.join("Cargo.toml")?)?;
+
+            let licenses = find_licenses(krate.path().abs(), krate.name(), krate.license())?;
+
+            if !licenses.unsatisfied.is_empty() && licenses.satisfied.is_empty() {
+                let mut satisfied = false;
+                // Sometimes multiple crates live in a single GitHub repo. A common case
+                // is a crate with an associated proc_macro crate. In such cases, the individual
+                // crates are in subdirectories with license files at root of the repo, and
+                // the license files don't get distributed with the crates.
+                // So, if we didn't find a license file, try to guess the URL of the appropriate
+                // license file and download it. This is incredibly hacky, and only supports
+                // the most common case, which is LICENSE-APACHE.
+                if licenses.unsatisfied.len() == 1 {
+                    let req = licenses.unsatisfied.first().unwrap();
+                    if let Some(repository) = krate.repository() {
+                        if *req == Licensee::parse("Apache-2.0").unwrap().into_req() {
+                            let url = format!("{}/master/LICENSE-APACHE", repository);
+                            let body = reqwest::blocking::get(
+                                url.replace("github.com", "raw.githubusercontent.com"),
+                            )?
+                            .text()?;
+                            write(krate.path().abs().join("LICENSE"), body)?;
+                            let patch_dir = krate.path().abs().join("patches");
+                            create_dir(&patch_dir)?;
+                            let output = Command::new("diff")
+                                .args(["-u", "/dev/null", "LICENSE"])
+                                .current_dir(krate.path().abs())
+                                .output()?;
+                            write(patch_dir.join("LICENSE.patch"), output.stdout)?;
+                            satisfied = true;
+                        }
+                    }
+                }
+                if !satisfied {
+                    return Err(anyhow!(
+                        "Could not find license files for all licenses. Missing {}",
+                        licenses.unsatisfied.iter().join(", ")
+                    ));
+                }
+            }
+
+            // If there's a single applicable license file, symlink it to LICENSE.
+            if licenses.satisfied.len() == 1 && licenses.unsatisfied.is_empty() {
+                let license_file = krate.path().join("LICENSE")?;
+                if !license_file.abs().exists() {
+                    symlink(
+                        licenses.satisfied.iter().next().unwrap().1.file_name().unwrap(),
+                        license_file,
+                    )?;
+                }
+            }
+
+            update_module_license_files(&krate.path().abs(), &licenses)?;
+
+            let metadata = GoogleMetadata::init(
+                krate.path().join("METADATA")?,
+                krate.name(),
+                krate.version().to_string(),
+                krate.description(),
+                most_restrictive_type(&licenses),
+            )?;
+            metadata.write()?;
+
+            // Workaround. Our logic for crate health assumes the crate isn't healthy if there's
+            // no Android.bp. So create an empty one.
+            write(krate.path().abs().join("Android.bp"), "")?;
+
+            // TODO: Create TEST_MAPPING
+        }
+
+        self.regenerate(new_deps.iter(), true)?;
+
+        Ok(())
+    }
+    pub fn regenerate<T: AsRef<str>>(
+        &self,
+        crates: impl Iterator<Item = T>,
+        update_metadata: bool,
+    ) -> Result<()> {
+        let version_match = self.stage(crates)?;
+        if update_metadata {
+            version_match.update_metadata()?;
+        }
+
+        for pair in version_match.pairs() {
+            let source_version = NameAndVersion::from(&pair.source.key());
+            let pair = pair.to_compatible().ok_or(anyhow!(
+                "No compatible vendored crate found for {} v{}",
+                source_version.name(),
+                source_version.version()
+            ))?;
+
+            if !pair.dest.staging_path().abs().exists() {
+                return Err(anyhow!("Staged crate not found at {}", pair.dest.staging_path()));
+            }
+            let android_crate_dir = self.managed_dir_for(pair.source.name());
+            remove_dir_all(&android_crate_dir)?;
+            rename(pair.dest.staging_path(), &android_crate_dir)?;
+        }
+
+        self.pseudo_crate.regenerate_crate_list()?;
+
+        Ok(())
+    }
+    pub fn regenerate_all(&self, update_metadata: bool) -> Result<()> {
+        self.regenerate(self.pseudo_crate.deps()?.keys().map(|k| k.as_str()), update_metadata)
+    }
+    pub fn stage<T: AsRef<str>>(
+        &self,
+        crates: impl Iterator<Item = T>,
+    ) -> Result<VersionMatch<CrateCollection>> {
+        let mut cc = self.new_cc();
+        for crate_name in crates {
+            let crate_name = crate_name.as_ref();
+            let android_crate_dir = self.managed_dir_for(crate_name);
+            if !android_crate_dir.abs().exists() {
+                return Err(anyhow!("Crate {} not found in {}", crate_name, self.managed_dir()));
+            }
+
+            // Source
+            cc.add_from(android_crate_dir.rel())?;
+            let num_versions = cc.get_versions(crate_name).count();
+            if num_versions != 1 {
+                return Err(anyhow!(
+                    "Expected a single crate version for {}, but found {}. Crates with multiple versions are not supported yet.",
+                    crate_name,
+                    num_versions
+                ));
+            }
+        }
+
+        self.pseudo_crate.vendor()?;
+
+        // Dest
+        let dest = self.vendored_crates()?;
+
+        let mut version_match = VersionMatch::new(cc, dest)?;
+
+        version_match.stage_crates()?;
+        version_match.copy_customizations()?;
+        version_match.apply_patches()?;
+        version_match.generate_android_bps()?;
+        version_match.diff_android_bps()?;
+
+        for pair in version_match.pairs() {
+            let source_version = NameAndVersion::from(&pair.source.key());
+            let pair = pair.to_compatible().ok_or(anyhow!(
+                "No compatible vendored crate found for {} v{}",
+                source_version.name(),
+                source_version.version(),
+            ))?;
+
+            if !pair.dest.patch_success() {
+                for (patch, output) in pair.dest.patch_output() {
+                    if !output.status.success() {
+                        return Err(anyhow!(
+                            "Failed to patch {} with {}\nstdout:\n{}\nstderr:\n{}",
+                            pair.dest.name(),
+                            patch,
+                            from_utf8(&output.stdout)?,
+                            from_utf8(&output.stderr)?
+                        ));
+                    }
+                }
+            }
+            if !pair.dest.generate_android_bp_success() {
+                if let Some(output) = pair.dest.generate_android_bp_output() {
+                    return Err(anyhow!(
+                        "cargo_embargo execution failed for {}:\nstdout:\n{}\nstderr:\n:{}",
+                        pair.dest.name(),
+                        from_utf8(&output.stdout)?,
+                        from_utf8(&output.stderr)?
+                    ));
+                }
+            }
+        }
+
+        Ok(version_match)
+    }
+    pub fn preupload_check(&self, files: &[String]) -> Result<()> {
+        let deps = self.pseudo_crate.deps()?.keys().cloned().collect::<BTreeSet<_>>();
+
+        let mut managed_dirs = BTreeSet::new();
+        for entry in read_dir(self.managed_dir())? {
+            let entry = entry?;
+            if entry.path().is_dir() {
+                managed_dirs.insert(
+                    entry.file_name().into_string().map_err(|e| {
+                        anyhow!("Failed to convert {} to string", e.to_string_lossy())
+                    })?,
+                );
+            }
+        }
+
+        if deps != managed_dirs {
+            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match directories in {}\nDirectories not in Cargo.toml: {}\nCargo.toml deps with no directory: {}",
+                self.managed_dir(), managed_dirs.difference(&deps).join(", "), deps.difference(&managed_dirs).join(", ")));
+        }
+
+        let crate_list = self.pseudo_crate.read_crate_list()?;
+        if deps.iter().ne(crate_list.iter()) {
+            return Err(anyhow!("Deps in pseudo_crate/Cargo.toml don't match deps in crate-list.txt\nCargo.toml: {}\ncrate-list.txt: {}",
+                deps.iter().join(", "), crate_list.iter().join(", ")));
+        }
+
+        let changed_android_crates = files
+            .iter()
+            .filter_map(|file| {
+                let path = Path::new(file);
+                let components = path.components().collect::<Vec<_>>();
+                if path.starts_with("crates/") && components.len() > 2 {
+                    Some(components[1].as_os_str().to_string_lossy().to_string())
+                } else {
+                    None
+                }
+            })
+            .collect::<BTreeSet<_>>();
+
+        let version_match = self.stage(changed_android_crates.iter())?;
+
+        for pair in version_match.pairs() {
+            println!("Checking {}", pair.source.name());
+            let source_version = NameAndVersion::from(&pair.source.key());
+            let pair = pair.to_compatible().ok_or(anyhow!(
+                "No compatible vendored crate found for {} v{}",
+                source_version.name(),
+                source_version.version()
+            ))?;
+
+            let diff_status = Command::new("diff")
+                .args(["-u", "-r", "-w", "--no-dereference"])
+                .arg(pair.dest.staging_path().rel())
+                .arg(self.managed_dir_for(pair.source.name()).rel())
+                .current_dir(self.path.root())
+                .spawn()?
+                .wait()?;
+            if !diff_status.success() {
+                return Err(anyhow!(
+                    "Found differences between {} and {}",
+                    pair.source.path(),
+                    pair.dest.staging_path()
+                ));
+            }
+        }
+
+        Ok(())
+    }
+    // TODO: Run "cargo tree" for android targets as well. By default
+    // it runs it for the host target.
+    fn add_crate_and_dependencies(&self, crate_name: &str) -> Result<BTreeSet<String>> {
+        let mut cc = self.new_cc();
+        cc.add_from("external/rust/crates")?;
+        let unmigrated_crates =
+            cc.map_field().keys().map(|nv| nv.name().to_string()).collect::<BTreeSet<_>>();
+
+        let migrated_crates = self.pseudo_crate.deps()?.keys().cloned().collect::<BTreeSet<_>>();
+
+        let mut pending_deps = BTreeSet::from([crate_name.to_string()]);
+        let mut added_deps = BTreeSet::new();
+        while !pending_deps.is_empty() {
+            let cur_dep = pending_deps.pop_first().unwrap();
+            println!("Adding {}", cur_dep);
+            self.pseudo_crate.add_unversioned(&cur_dep)?;
+            // TODO: Try not to do "cargo vendor" so often.
+            self.pseudo_crate.vendor()?;
+            added_deps.insert(cur_dep.clone());
+            for new_dep in self.pseudo_crate.deps_of(&cur_dep)? {
+                if !added_deps.contains(&new_dep)
+                    && !migrated_crates.contains(&new_dep)
+                    && !unmigrated_crates.contains(&new_dep)
+                {
+                    println!("  Depends on {}", new_dep);
+                    pending_deps.insert(new_dep);
+                }
+            }
+        }
+        self.pseudo_crate.vendor()?;
+        Ok(added_deps)
+    }
+    pub fn fix_licenses(&self) -> Result<()> {
+        let mut cc = self.new_cc();
+        cc.add_from(self.managed_dir().rel())?;
+
+        for krate in cc.map_field().values() {
+            println!("{} = \"={}\"", krate.name(), krate.version());
+            let state = find_licenses(krate.path().abs(), krate.name(), krate.license())?;
+            if !state.unsatisfied.is_empty() {
+                println!("{:?}", state);
+            } else {
+                // For now, just update MODULE_LICENSE_*
+                update_module_license_files(&krate.path().abs(), &state)?;
+            }
+        }
+
+        Ok(())
+    }
+    pub fn fix_metadata(&self) -> Result<()> {
+        let mut cc = self.new_cc();
+        cc.add_from(self.managed_dir().rel())?;
+
+        for krate in cc.map_field().values() {
+            println!("{} = \"={}\"", krate.name(), krate.version());
+            let mut metadata = GoogleMetadata::try_from(krate.path().join("METADATA")?)?;
+            metadata.set_version_and_urls(krate.name(), krate.version().to_string())?;
+            metadata.migrate_archive();
+            metadata.migrate_homepage();
+            metadata.remove_deprecated_url();
+            metadata.write()?;
+        }
+
+        Ok(())
+    }
+}
+
+// Files that are ignored when migrating a crate to the monorepo.
+static IGNORED_FILES: &[&str] = &[
+    ".appveyor.yml",
+    ".bazelci",
+    ".bazelignore",
+    ".bazelrc",
+    ".bazelversion",
+    ".buildkite",
+    ".cargo",
+    ".cargo-checksum.json",
+    ".cargo_vcs_info.json",
+    ".circleci",
+    ".cirrus.yml",
+    ".clang-format",
+    ".clang-tidy",
+    ".clippy.toml",
+    ".clog.toml",
+    ".clog.toml",
+    ".codecov.yaml",
+    ".codecov.yml",
+    ".editorconfig",
+    ".gcloudignore",
+    ".gdbinit",
+    ".git",
+    ".git-blame-ignore-revs",
+    ".git-ignore-revs",
+    ".gitallowed",
+    ".gitattributes",
+    ".github",
+    ".gitignore",
+    ".idea",
+    ".ignore",
+    ".istanbul.yml",
+    ".mailmap",
+    ".md-inc.toml",
+    ".mdl-style.rb",
+    ".mdlrc",
+    ".pylintrc",
+    ".pylintrc-examples",
+    ".pylintrc-tests",
+    ".reuse",
+    ".rspec",
+    ".rustfmt.toml",
+    ".shellcheckrc",
+    ".standard-version",
+    ".tarpaulin.toml",
+    ".tokeignore",
+    ".travis.yml",
+    ".versionrc",
+    ".vim",
+    ".vscode",
+    ".yapfignore",
+    ".yardopts",
+    "BUILD",
+    "Cargo.lock",
+    "Cargo.lock.saved",
+    "Cargo.toml.orig",
+    "OWNERS",
+    // Deprecated config file for rules.mk.
+    "cargo2rulesmk.json",
+    // cargo_embargo intermediates.
+    "Android.bp.orig",
+    "cargo.metadata",
+    "cargo.out",
+    "target.tmp",
+];
diff --git a/tools/external_crates/crate_health/src/migration.rs b/tools/external_crates/crate_health/src/migration.rs
index b996e044d..a4eb1c567 100644
--- a/tools/external_crates/crate_health/src/migration.rs
+++ b/tools/external_crates/crate_health/src/migration.rs
@@ -13,7 +13,7 @@
 // limitations under the License.
 
 use std::{
-    fs::{copy, read_link, remove_dir_all},
+    fs::{copy, read_link},
     os::unix::fs::symlink,
     process::Output,
 };
@@ -21,21 +21,25 @@ use std::{
 use anyhow::{anyhow, Context, Result};
 use glob::glob;
 
-use crate::{
-    copy_dir, crate_type::diff_android_bp, most_recent_version, CompatibleVersionPair, Crate,
-    CrateCollection, Migratable, NameAndVersionMap, PseudoCrate, RepoPath, VersionMatch,
-};
+use crate::{copy_dir, crate_type::diff_android_bp, CompatibleVersionPair, Crate};
 
-static CUSTOMIZATIONS: &'static [&'static str] =
-    &["*.bp", "cargo_embargo.json", "patches", "METADATA", "TEST_MAPPING", "MODULE_LICENSE_*"];
+static CUSTOMIZATIONS: &[&str] = &[
+    "*.bp",
+    "*.mk",
+    "cargo_embargo.json",
+    "patches",
+    "METADATA",
+    "TEST_MAPPING",
+    "MODULE_LICENSE_*",
+];
 
-static SYMLINKS: &'static [&'static str] = &["LICENSE", "NOTICE"];
+static SYMLINKS: &[&str] = &["LICENSE", "NOTICE"];
 
 impl<'a> CompatibleVersionPair<'a, Crate> {
     pub fn copy_customizations(&self) -> Result<()> {
-        let dest_dir_absolute = self.dest.staging_path().abs();
+        let dest_dir = self.dest.staging_path();
         for pattern in CUSTOMIZATIONS {
-            let full_pattern = self.source.path().join(pattern);
+            let full_pattern = self.source.path().join(pattern)?;
             for entry in glob(
                 full_pattern
                     .abs()
@@ -48,28 +52,28 @@ impl<'a> CompatibleVersionPair<'a, Crate> {
                     .context(format!("Failed to get file name for {}", entry.display()))?
                     .to_os_string();
                 if entry.is_dir() {
-                    copy_dir(&entry, &dest_dir_absolute.join(filename)).context(format!(
+                    copy_dir(&entry, &dest_dir.join(filename)?).context(format!(
                         "Failed to copy {} to {}",
                         entry.display(),
-                        self.dest.staging_path()
+                        dest_dir
                     ))?;
                 } else {
-                    let dest_file = dest_dir_absolute.join(&filename);
-                    if dest_file.exists() {
-                        return Err(anyhow!("Destination file {} exists", dest_file.display()));
+                    let dest_file = dest_dir.join(&filename)?;
+                    if dest_file.abs().exists() {
+                        return Err(anyhow!("Destination file {} exists", dest_file));
                     }
-                    copy(&entry, dest_dir_absolute.join(filename)).context(format!(
+                    copy(&entry, dest_dir.join(filename)?).context(format!(
                         "Failed to copy {} to {}",
                         entry.display(),
-                        dest_dir_absolute.display()
+                        dest_dir
                     ))?;
                 }
             }
         }
         for link in SYMLINKS {
-            let src_path = self.source.path().join(link);
+            let src_path = self.source.path().join(link)?;
             if src_path.abs().is_symlink() {
-                let dest = read_link(src_path.abs())?;
+                let dest = read_link(src_path)?;
                 if dest.exists() {
                     return Err(anyhow!(
                         "Can't symlink {} -> {} because destination exists",
@@ -77,7 +81,7 @@ impl<'a> CompatibleVersionPair<'a, Crate> {
                         dest.display(),
                     ));
                 }
-                symlink(dest, dest_dir_absolute.join(link))?;
+                symlink(dest, dest_dir.join(link)?)?;
             }
         }
         Ok(())
@@ -85,43 +89,9 @@ impl<'a> CompatibleVersionPair<'a, Crate> {
     pub fn diff_android_bps(&self) -> Result<Output> {
         diff_android_bp(
             &self.source.android_bp().rel(),
-            &self.dest.staging_path().join(&"Android.bp").rel(),
+            &self.dest.staging_path().join("Android.bp")?.rel(),
             &self.source.path().root(),
         )
         .context("Failed to diff Android.bp".to_string())
     }
 }
-
-pub fn migrate(
-    source_dir: RepoPath,
-    pseudo_crate_dir: RepoPath,
-) -> Result<VersionMatch<CrateCollection>> {
-    let mut source = CrateCollection::new(source_dir.root());
-    source.add_from(&source_dir.rel())?;
-    source.map_field_mut().retain(|_nv, krate| krate.is_crates_io());
-
-    let pseudo_crate = PseudoCrate::new(pseudo_crate_dir);
-    if pseudo_crate.get_path().abs().exists() {
-        remove_dir_all(pseudo_crate.get_path().abs())
-            .context(format!("Failed to remove {}", pseudo_crate.get_path()))?;
-    }
-    pseudo_crate.init(
-        source
-            .filter_versions(&most_recent_version)
-            .filter(|(_nv, krate)| krate.is_migration_eligible())
-            .map(|(_nv, krate)| krate),
-    )?;
-
-    let mut dest = CrateCollection::new(source.repo_root());
-    dest.add_from(&pseudo_crate.get_path().join(&"vendor").rel())?;
-
-    let mut version_match = VersionMatch::new(source, dest)?;
-
-    version_match.stage_crates()?;
-    version_match.copy_customizations()?;
-    version_match.apply_patches()?;
-    version_match.generate_android_bps()?;
-    version_match.diff_android_bps()?;
-
-    Ok(version_match)
-}
diff --git a/tools/external_crates/crate_health/src/pseudo_crate.rs b/tools/external_crates/crate_health/src/pseudo_crate.rs
index bcde2f38e..f414d8987 100644
--- a/tools/external_crates/crate_health/src/pseudo_crate.rs
+++ b/tools/external_crates/crate_health/src/pseudo_crate.rs
@@ -13,18 +13,23 @@
 // limitations under the License.
 
 use std::{
-    fs::{create_dir, write},
+    collections::{BTreeMap, BTreeSet},
+    fs::{create_dir, read, write},
+    io::BufRead,
     process::Command,
     str::from_utf8,
 };
 
 use anyhow::{anyhow, Context, Result};
+use itertools::Itertools;
+use name_and_version::NamedAndVersioned;
+use rooted_path::RootedPath;
 use serde::Serialize;
 use tinytemplate::TinyTemplate;
 
-use crate::{ensure_exists_and_empty, NamedAndVersioned, RepoPath};
+use crate::{ensure_exists_and_empty, RunQuiet};
 
-static CARGO_TOML_TEMPLATE: &'static str = include_str!("templates/Cargo.toml.template");
+static CARGO_TOML_TEMPLATE: &str = include_str!("templates/Cargo.toml.template");
 
 #[derive(Serialize)]
 struct Dep {
@@ -38,21 +43,22 @@ struct CargoToml {
 }
 
 pub struct PseudoCrate {
-    path: RepoPath,
+    path: RootedPath,
 }
 
 impl PseudoCrate {
-    pub fn new(path: RepoPath) -> PseudoCrate {
+    pub fn new(path: RootedPath) -> PseudoCrate {
         PseudoCrate { path }
     }
     pub fn init<'a>(
         &self,
         crates: impl Iterator<Item = &'a (impl NamedAndVersioned + 'a)>,
+        exact_version: bool,
     ) -> Result<()> {
         if self.path.abs().exists() {
             return Err(anyhow!("Can't init pseudo-crate because {} already exists", self.path));
         }
-        ensure_exists_and_empty(&self.path.abs())?;
+        ensure_exists_and_empty(&self.path)?;
 
         let mut deps = Vec::new();
         for krate in crates {
@@ -62,61 +68,105 @@ impl PseudoCrate {
             if krate.name() != "libsqlite3-sys" {
                 deps.push(Dep {
                     name: krate.name().to_string(),
-                    version: if krate.name() == "remove_dir_all"
-                        && krate.version().to_string() == "0.7.1"
-                    {
-                        "0.7.0".to_string()
-                    } else {
-                        krate.version().to_string()
-                    },
+                    version: format!(
+                        "{}{}",
+                        if exact_version { "=" } else { "" },
+                        if krate.name() == "remove_dir_all"
+                            && krate.version().to_string() == "0.7.1"
+                        {
+                            "0.7.0".to_string()
+                        } else {
+                            krate.version().to_string()
+                        }
+                    ),
                 });
             }
         }
 
         let mut tt = TinyTemplate::new();
         tt.add_template("cargo_toml", CARGO_TOML_TEMPLATE)?;
-        let cargo_toml = self.path.join(&"Cargo.toml").abs();
-        write(&cargo_toml, tt.render("cargo_toml", &CargoToml { deps })?)?;
+        write(self.path.join("Cargo.toml")?, tt.render("cargo_toml", &CargoToml { deps })?)?;
 
-        create_dir(self.path.join(&"src").abs()).context("Failed to create src dir")?;
-        write(self.path.join(&"src/lib.rs").abs(), "// Nothing")
+        create_dir(self.path.join("src")?).context("Failed to create src dir")?;
+        write(self.path.join("src/lib.rs")?, "// Nothing")
             .context("Failed to create src/lib.rs")?;
 
         self.vendor()
-
-        // TODO: Run "cargo deny"
     }
-    pub fn get_path(&self) -> &RepoPath {
+    pub fn get_path(&self) -> &RootedPath {
         &self.path
     }
+    fn add_internal(&self, crate_and_version_str: &str) -> Result<()> {
+        Command::new("cargo")
+            .args(["add", crate_and_version_str])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()?;
+        Ok(())
+    }
     pub fn add(&self, krate: &impl NamedAndVersioned) -> Result<()> {
-        let status = Command::new("cargo")
-            .args(["add", format!("{}@={}", krate.name(), krate.version()).as_str()])
-            .current_dir(self.path.abs())
-            .spawn()
-            .context("Failed to spawn 'cargo add'")?
-            .wait()
-            .context("Failed to wait on 'cargo add'")?;
-        if !status.success() {
-            return Err(anyhow!("Failed to run 'cargo add {}@{}'", krate.name(), krate.version()));
-        }
+        self.add_internal(format!("{}@={}", krate.name(), krate.version()).as_str())
+    }
+    pub fn add_unpinned(&self, krate: &impl NamedAndVersioned) -> Result<()> {
+        self.add_internal(format!("{}@{}", krate.name(), krate.version()).as_str())
+    }
+    pub fn add_unversioned(&self, crate_name: &str) -> Result<()> {
+        self.add_internal(crate_name)
+    }
+    pub fn remove(&self, krate: &impl NamedAndVersioned) -> Result<()> {
+        Command::new("cargo")
+            .args(["remove", krate.name()])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()?;
         Ok(())
     }
     pub fn vendor(&self) -> Result<()> {
-        let output =
-            Command::new("cargo").args(["vendor"]).current_dir(self.path.abs()).output()?;
-        if !output.status.success() {
-            return Err(anyhow!(
-                "cargo vendor failed with exit code {}\nstdout:\n{}\nstderr:\n{}",
-                output
-                    .status
-                    .code()
-                    .map(|code| { format!("{}", code) })
-                    .unwrap_or("(unknown)".to_string()),
-                from_utf8(&output.stdout)?,
-                from_utf8(&output.stderr)?
-            ));
+        Command::new("cargo")
+            .args(["vendor"])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()?;
+        Ok(())
+    }
+    pub fn deps(&self) -> Result<BTreeMap<String, String>> {
+        let output = Command::new("cargo")
+            .args(["tree", "--depth=1", "--prefix=none"])
+            .current_dir(&self.path)
+            .run_quiet_and_expect_success()?;
+        let mut deps = BTreeMap::new();
+        for line in from_utf8(&output.stdout)?.lines().skip(1) {
+            let words = line.split(' ').collect::<Vec<_>>();
+            if words.len() < 2 {
+                return Err(anyhow!(
+                    "Failed to parse crate name and version from cargo tree: {}",
+                    line
+                ));
+            }
+            let version = words[1]
+                .strip_prefix('v')
+                .ok_or(anyhow!("Failed to parse version: {}", words[1]))?;
+            deps.insert(words[0].to_string(), version.to_string());
+        }
+        Ok(deps)
+    }
+    pub fn deps_of(&self, crate_name: &str) -> Result<BTreeSet<String>> {
+        let mut deps = BTreeSet::new();
+        let output = Command::new("cargo")
+            .args(["tree", "--prefix", "none"])
+            .current_dir(self.get_path().abs().join("vendor").join(crate_name))
+            .run_quiet_and_expect_success()?;
+        for line in from_utf8(&output.stdout)?.lines() {
+            deps.insert(line.split_once(' ').unwrap().0.to_string());
         }
+        Ok(deps)
+    }
+    pub fn regenerate_crate_list(&self) -> Result<()> {
+        write(self.path.join("crate-list.txt")?, format!("{}\n", self.deps()?.keys().join("\n")))?;
         Ok(())
     }
+    pub fn read_crate_list(&self) -> Result<Vec<String>> {
+        let mut lines = Vec::new();
+        for line in read(self.path.join("crate-list.txt")?)?.lines() {
+            lines.push(line?);
+        }
+        Ok(lines)
+    }
 }
diff --git a/tools/external_crates/crate_health/src/repo_path.rs b/tools/external_crates/crate_health/src/repo_path.rs
deleted file mode 100644
index 2092b7969..000000000
--- a/tools/external_crates/crate_health/src/repo_path.rs
+++ /dev/null
@@ -1,68 +0,0 @@
-// Copyright (C) 2024 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use core::fmt::Display;
-use std::path::{Path, PathBuf};
-
-#[derive(Debug, PartialEq, Eq)]
-pub struct RepoPath {
-    root: PathBuf,
-    path: PathBuf,
-}
-
-impl Display for RepoPath {
-    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
-        write!(f, "{}", self.path.display())
-    }
-}
-
-impl RepoPath {
-    pub fn new<P: Into<PathBuf>, Q: Into<PathBuf>>(root: P, path: Q) -> RepoPath {
-        let root: PathBuf = root.into();
-        let path: PathBuf = path.into();
-        assert!(root.is_absolute());
-        assert!(path.is_relative());
-        RepoPath { root, path }
-    }
-    pub fn root(&self) -> &Path {
-        self.root.as_path()
-    }
-    pub fn rel(&self) -> &Path {
-        self.path.as_path()
-    }
-    pub fn abs(&self) -> PathBuf {
-        self.root.join(&self.path)
-    }
-    pub fn join(&self, path: &impl AsRef<Path>) -> RepoPath {
-        RepoPath::new(self.root.clone(), self.path.join(path))
-    }
-    pub fn with_same_root<P: Into<PathBuf>>(&self, path: P) -> RepoPath {
-        RepoPath::new(self.root.clone(), path)
-    }
-}
-
-#[cfg(test)]
-mod tests {
-    use super::*;
-
-    #[test]
-    fn test_basic() {
-        let p = RepoPath::new(&"/foo", &"bar");
-        assert_eq!(p.root(), Path::new("/foo"));
-        assert_eq!(p.rel(), Path::new("bar"));
-        assert_eq!(p.abs(), PathBuf::from("/foo/bar"));
-        assert_eq!(p.join(&"baz"), RepoPath::new("/foo", "bar/baz"));
-        assert_eq!(p.with_same_root(&"baz"), RepoPath::new("/foo", "baz"));
-    }
-}
diff --git a/tools/external_crates/crate_health/src/reports.rs b/tools/external_crates/crate_health/src/reports.rs
deleted file mode 100644
index 49756c066..000000000
--- a/tools/external_crates/crate_health/src/reports.rs
+++ /dev/null
@@ -1,350 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-use std::{fmt::Display, fs::write, path::Path, str::from_utf8};
-
-use crate::{
-    crates_with_multiple_versions, crates_with_single_version, CompatibleVersionPair, Crate,
-    CrateCollection, NameAndVersionMap, NamedAndVersioned, VersionMatch, VersionPair,
-};
-
-use anyhow::Result;
-use serde::Serialize;
-use tinytemplate::TinyTemplate;
-
-static SIZE_REPORT_TEMPLATE: &'static str = include_str!("templates/size_report.html.template");
-static TABLE_TEMPLATE: &'static str = include_str!("templates/table.html.template");
-
-static CRATE_HEALTH_REPORT_TEMPLATE: &'static str =
-    include_str!("templates/crate_health.html.template");
-static MIGRATION_REPORT_TEMPLATE: &'static str =
-    include_str!("templates/migration_report.html.template");
-
-pub struct ReportEngine<'template> {
-    tt: TinyTemplate<'template>,
-}
-
-fn len_formatter(value: &serde_json::Value, out: &mut String) -> tinytemplate::error::Result<()> {
-    match value {
-        serde_json::Value::Array(a) => {
-            out.push_str(&format!("{}", a.len()));
-            Ok(())
-        }
-        _ => Err(tinytemplate::error::Error::GenericError {
-            msg: "Can only use length formatter on an array".to_string(),
-        }),
-    }
-}
-
-fn linkify(text: &dyn Display, url: &dyn Display) -> String {
-    format!("<a href=\"{}\">{}</a>", url, text)
-}
-
-impl<'template> ReportEngine<'template> {
-    pub fn new() -> Result<ReportEngine<'template>> {
-        let mut tt = TinyTemplate::new();
-        tt.add_template("size_report", SIZE_REPORT_TEMPLATE)?;
-        tt.add_template("table", TABLE_TEMPLATE)?;
-        tt.add_template("crate_health", CRATE_HEALTH_REPORT_TEMPLATE)?;
-        tt.add_template("migration", MIGRATION_REPORT_TEMPLATE)?;
-        tt.add_formatter("len", len_formatter);
-        Ok(ReportEngine { tt })
-    }
-    pub fn size_report(&self, cc: &CrateCollection) -> Result<String> {
-        let num_crates = cc.num_crates();
-        let crates_with_single_version = cc.filter_versions(&crates_with_single_version).count();
-        Ok(self.tt.render(
-            "size_report",
-            &SizeReport {
-                num_crates,
-                crates_with_single_version,
-                crates_with_multiple_versions: num_crates - crates_with_single_version,
-                num_dirs: cc.map_field().len(),
-            },
-        )?)
-    }
-    pub fn table<'a>(&self, crates: impl Iterator<Item = &'a Crate>) -> Result<String> {
-        let mut table = Table::new(&[&"Crate", &"Version", &"Path"]);
-        for krate in crates {
-            table.add_row(&[
-                &linkify(&krate.name(), &krate.crates_io_url()),
-                &krate.version().to_string(),
-                &krate
-                    .aosp_url()
-                    .map_or(format!("{}", krate.path()), |url| linkify(&krate.path(), &url)),
-            ]);
-        }
-        Ok(self.tt.render("table", &table)?)
-    }
-    pub fn health_table<'a>(&self, crates: impl Iterator<Item = &'a Crate>) -> Result<String> {
-        let mut table = Table::new(&[
-            &"Crate",
-            &"Version",
-            &"Path",
-            &"Has Android.bp",
-            &"Generate Android.bp succeeds",
-            &"Android.bp unchanged",
-            &"Has cargo_embargo.json",
-            &"On migration denylist",
-        ]);
-        table.set_vertical_headers();
-        for krate in crates {
-            table.add_row(&[
-                &linkify(&krate.name(), &krate.crates_io_url()),
-                &krate.version().to_string(),
-                &krate
-                    .aosp_url()
-                    .map_or(format!("{}", krate.path()), |url| linkify(&krate.path(), &url)),
-                &prefer_yes(krate.android_bp().abs().exists()),
-                &prefer_yes_or_summarize(
-                    krate.generate_android_bp_success(),
-                    krate
-                        .generate_android_bp_output()
-                        .map_or("Error".to_string(), |o| {
-                            format!(
-                                "STDOUT:\n{}\n\nSTDERR:\n{}",
-                                from_utf8(&o.stdout).unwrap_or("Error"),
-                                from_utf8(&o.stderr).unwrap_or("Error")
-                            )
-                        })
-                        .as_str(),
-                ),
-                &prefer_yes_or_summarize(
-                    krate.android_bp_unchanged(),
-                    krate
-                        .android_bp_diff()
-                        .map_or("Error", |o| from_utf8(&o.stdout).unwrap_or("Error")),
-                ),
-                &prefer_yes(krate.cargo_embargo_json().abs().exists()),
-                &prefer_no(krate.is_migration_denied()),
-            ]);
-        }
-        Ok(self.tt.render("table", &table)?)
-    }
-    pub fn migratable_table<'a>(
-        &self,
-        crate_pairs: impl Iterator<Item = CompatibleVersionPair<'a, Crate>>,
-    ) -> Result<String> {
-        let mut table = Table::new(&[&"Crate", &"Old Version", &"New Version", &"Path"]);
-        for crate_pair in crate_pairs {
-            let source = crate_pair.source;
-            let dest = crate_pair.dest;
-            let dest_version = if source.version() == dest.version() {
-                "".to_string()
-            } else {
-                dest.version().to_string()
-            };
-            table.add_row(&[
-                &linkify(&source.name(), &source.crates_io_url()),
-                &source.version().to_string(),
-                &dest_version,
-                &source
-                    .aosp_url()
-                    .map_or(format!("{}", source.path()), |url| linkify(&source.path(), &url)),
-            ]);
-        }
-        Ok(self.tt.render("table", &table)?)
-    }
-    pub fn migration_ineligible_table<'a>(
-        &self,
-        crates: impl Iterator<Item = &'a Crate>,
-    ) -> Result<String> {
-        let mut table = Table::new(&[
-            &"Crate",
-            &"Version",
-            &"Path",
-            &"In crates.io",
-            &"Denylisted",
-            &"Has Android.bp",
-            &"Has cargo_embargo.json",
-        ]);
-        table.set_vertical_headers();
-        for krate in crates {
-            table.add_row(&[
-                &linkify(&krate.name(), &krate.crates_io_url()),
-                &krate.version().to_string(),
-                &krate
-                    .aosp_url()
-                    .map_or(format!("{}", krate.path()), |url| linkify(&krate.path(), &url)),
-                &prefer_yes(krate.is_crates_io()),
-                &prefer_no(krate.is_migration_denied()),
-                &prefer_yes(krate.android_bp().abs().exists()),
-                &prefer_yes(krate.cargo_embargo_json().abs().exists()),
-            ]);
-        }
-        Ok(self.tt.render("table", &table)?)
-    }
-    pub fn migration_eligible_table<'a>(
-        &self,
-        crate_pairs: impl Iterator<Item = VersionPair<'a, Crate>>,
-    ) -> Result<String> {
-        let mut table = Table::new(&[
-            &"Crate",
-            &"Version",
-            &"Path",
-            &"Compatible version",
-            &"Patch succeeds",
-            &"Generate Android.bp succeeds",
-            &"Android.bp unchanged",
-        ]);
-        table.set_vertical_headers();
-        for crate_pair in crate_pairs {
-            let source = crate_pair.source;
-            let maybe_dest = crate_pair.dest;
-            table.add_row(&[
-                &linkify(&source.name(), &source.crates_io_url()),
-                &source.version().to_string(),
-                &source
-                    .aosp_url()
-                    .map_or(format!("{}", source.path()), |url| linkify(&source.path(), &url)),
-                maybe_dest.map_or(&"None", |dest| {
-                    if dest.version() != source.version() {
-                        dest.version()
-                    } else {
-                        &""
-                    }
-                }),
-                &prefer_yes(!maybe_dest.is_some_and(|dest| !dest.patch_success())),
-                &prefer_yes_or_summarize(
-                    !maybe_dest.is_some_and(|dest| !dest.generate_android_bp_success()),
-                    maybe_dest
-                        .map_or("Error".to_string(), |dest| {
-                            dest.generate_android_bp_output().map_or("Error".to_string(), |o| {
-                                format!(
-                                    "STDOUT:\n{}\n\nSTDERR:\n{}",
-                                    from_utf8(&o.stdout).unwrap_or("Error"),
-                                    from_utf8(&o.stderr).unwrap_or("Error")
-                                )
-                            })
-                        })
-                        .as_str(),
-                ),
-                &prefer_yes_or_summarize(
-                    !maybe_dest.is_some_and(|dest| !dest.android_bp_unchanged()),
-                    maybe_dest.map_or("Error", |dest| {
-                        dest.android_bp_diff()
-                            .map_or("Error", |o| from_utf8(&o.stdout).unwrap_or("Error"))
-                    }),
-                ),
-            ]);
-        }
-        Ok(self.tt.render("table", &table)?)
-    }
-    pub fn health_report(
-        &self,
-        cc: &CrateCollection,
-        output_path: &impl AsRef<Path>,
-    ) -> Result<()> {
-        let chr = CrateHealthReport {
-            crate_count: self.size_report(cc)?,
-            crate_multiversion: self.table(
-                cc.filter_versions(&crates_with_multiple_versions).map(|(_nv, krate)| krate),
-            )?,
-            healthy: self.table(
-                cc.map_field()
-                    .iter()
-                    .filter(|(_nv, krate)| krate.is_android_bp_healthy())
-                    .map(|(_nv, krate)| krate),
-            )?,
-            unhealthy: self.health_table(
-                cc.map_field()
-                    .iter()
-                    .filter(|(_nv, krate)| !krate.is_android_bp_healthy())
-                    .map(|(_nv, krate)| krate),
-            )?,
-        };
-        Ok(write(output_path, self.tt.render("crate_health", &chr)?)?)
-    }
-    pub fn migration_report(
-        &self,
-        m: &VersionMatch<CrateCollection>,
-        output_path: &impl AsRef<Path>,
-    ) -> Result<()> {
-        let mr = MigrationReport {
-            migratable: self.migratable_table(m.migratable())?,
-            eligible: self.migration_eligible_table(m.eligible_but_not_migratable())?,
-            ineligible: self.migration_ineligible_table(m.ineligible())?,
-            superfluous: self.table(m.superfluous().map(|(_nv, krate)| krate))?,
-        };
-        Ok(write(output_path, self.tt.render("migration", &mr)?)?)
-    }
-}
-
-pub fn prefer_yes(p: bool) -> &'static str {
-    if p {
-        ""
-    } else {
-        "No"
-    }
-}
-pub fn prefer_yes_or_summarize(p: bool, details: &str) -> String {
-    if p {
-        "".to_string()
-    } else {
-        format!("<details><summary>No</summary><pre>{}</pre></details>", details)
-    }
-}
-pub fn prefer_no(p: bool) -> &'static str {
-    if p {
-        "Yes"
-    } else {
-        ""
-    }
-}
-
-#[derive(Serialize)]
-pub struct SizeReport {
-    num_crates: usize,
-    crates_with_single_version: usize,
-    crates_with_multiple_versions: usize,
-    num_dirs: usize,
-}
-
-#[derive(Serialize)]
-pub struct Table {
-    header: Vec<String>,
-    rows: Vec<Vec<String>>,
-    vertical: bool,
-}
-
-impl Table {
-    pub fn new(header: &[&dyn Display]) -> Table {
-        Table {
-            header: header.iter().map(|cell| format!("{}", cell)).collect::<Vec<_>>(),
-            rows: Vec::new(),
-            vertical: false,
-        }
-    }
-    pub fn add_row(&mut self, row: &[&dyn Display]) {
-        self.rows.push(row.iter().map(|cell| format!("{}", cell)).collect::<Vec<_>>());
-    }
-    pub fn set_vertical_headers(&mut self) {
-        self.vertical = true;
-    }
-}
-
-#[derive(Serialize)]
-pub struct CrateHealthReport {
-    crate_count: String,
-    crate_multiversion: String,
-    healthy: String,
-    unhealthy: String,
-}
-#[derive(Serialize)]
-pub struct MigrationReport {
-    migratable: String,
-    eligible: String,
-    ineligible: String,
-    superfluous: String,
-}
diff --git a/tools/external_crates/crate_health/src/templates/crate_health.html.template b/tools/external_crates/crate_health/src/templates/crate_health.html.template
deleted file mode 100644
index 759fa4c1e..000000000
--- a/tools/external_crates/crate_health/src/templates/crate_health.html.template
+++ /dev/null
@@ -1,33 +0,0 @@
-<html>
-<head>
-<title>Crate health</title>
-<style>
-table, th, td \{
-  border: 1px solid black;
-  border-collapse: collapse;
-  padding: 3px;
-}
-td \{
-  vertical-align: top;
-}
-.vertical \{
-  writing-mode: vertical-lr;
-}
-</style>
-</head>
-<body>
-<h1>Crates in external/rust</h1>
-{crate_count | unescaped}
-<h1>Crates with multiple versions</h1>
-{crate_multiversion | unescaped}
-<h1>Healthy crates in external/rust</h1>
-<ul>
-<li>Has cargo_embargo.json</li>
-<li>cargo_embargo runs successfully</li>
-<li>The resulting Android.bp is unchanged</li>
-</ul>
-{healthy | unescaped }
-<h1>Unhealthy crates in external/rust</h1>
-{unhealthy | unescaped}
-</body>
-</html>
\ No newline at end of file
diff --git a/tools/external_crates/crate_health/src/templates/migration_report.html.template b/tools/external_crates/crate_health/src/templates/migration_report.html.template
deleted file mode 100644
index 02bae1489..000000000
--- a/tools/external_crates/crate_health/src/templates/migration_report.html.template
+++ /dev/null
@@ -1,53 +0,0 @@
-<html>
-<head>
-<title>Crate health</title>
-<style>
-table, th, td \{
-  border: 1px solid black;
-  border-collapse: collapse;
-  padding: 3px;
-}
-td \{
-  vertical-align: top;
-}
-.vertical \{
-  writing-mode: vertical-lr;
-}
-</style>
-</head>
-<body>
-
-<h1>Migratable crates</h1>
-<p>Crates that can be safely migrated:
-<ul>
-<li>migration-eligible as defined below</li>
-<li>Has a vendored crate with a compatible version</li>
-<li>Patches apply successfully</li>
-<li>cargo_embargo succeeds on the vendored version.</li>
-<li>No significant diffs in the resulting Android.bp</li>
-</ul>
-</p>
-{migratable | unescaped}
-
-<h1>Migration-eligible crates</h1>
-<p>Crates that are eligible for migration, but can't yet be migrated:
-<ul>
-<li>It is in crates.io</li>
-<li>It is not denylisted</li>
-<li>It has an Android.bp</li>
-<li>It has a cargo_embargo.json</li>
-</ul>
-</p>
-{eligible | unescaped}
-
-<h1>Ineligible crates</h1>
-<p>Crates that are not eligible for migration</p>
-</p>
-{ineligible | unescaped}
-
-<h1>Superfluous vendored crates</h1>
-<p>Vendored crates that we don't know anything about</p>
-{superfluous | unescaped}
-
-</body>
-</html>
\ No newline at end of file
diff --git a/tools/external_crates/crate_health/src/templates/size_report.html.template b/tools/external_crates/crate_health/src/templates/size_report.html.template
deleted file mode 100644
index 23f3aec8e..000000000
--- a/tools/external_crates/crate_health/src/templates/size_report.html.template
+++ /dev/null
@@ -1,6 +0,0 @@
-<ul>
-  <li>{num_crates} crates</li>
-  <li>{crates_with_single_version} have a single version</li>
-  <li>{crates_with_multiple_versions} have multiple versions</li>
-  <li>{num_dirs} total crate directories</li>
-</ul>
diff --git a/tools/external_crates/crate_health/src/templates/table.html.template b/tools/external_crates/crate_health/src/templates/table.html.template
deleted file mode 100644
index b36da4761..000000000
--- a/tools/external_crates/crate_health/src/templates/table.html.template
+++ /dev/null
@@ -1,10 +0,0 @@
-<p>{rows | len} crate directories</p>
-<table>
-<tr>{{ for cell in header}}
-  <th{{ if vertical }} class="vertical"{{ endif }}>{cell}</th>{{ endfor }}
-</tr>
-{{ for row in rows }}
-<tr>{{ for cell in row }}
-  <td>{cell | unescaped}</td>{{ endfor }}
-</tr>{{ endfor }}
-</table>
\ No newline at end of file
diff --git a/tools/external_crates/crate_health/src/version_match.rs b/tools/external_crates/crate_health/src/version_match.rs
index 49f7ad1ff..7cf8f3ffd 100644
--- a/tools/external_crates/crate_health/src/version_match.rs
+++ b/tools/external_crates/crate_health/src/version_match.rs
@@ -12,14 +12,13 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
-use std::collections::BTreeMap;
+use std::{collections::BTreeMap, path::Path};
 
 use anyhow::{anyhow, Result};
+use google_metadata::GoogleMetadata;
+use name_and_version::{NameAndVersion, NameAndVersionMap, NamedAndVersioned};
 
-use crate::{
-    generate_android_bps, CrateCollection, Migratable, NameAndVersion, NameAndVersionMap,
-    NamedAndVersioned,
-};
+use crate::{generate_android_bps, CrateCollection};
 
 #[derive(Debug)]
 pub struct VersionPair<'a, T> {
@@ -98,98 +97,49 @@ impl<CollectionType: NameAndVersionMap> VersionMatch<CollectionType> {
             self.compatibility.get(*nv).is_some_and(|compatibility| compatibility.is_none())
         })
     }
-    pub fn pairs<'a>(&'a self) -> impl Iterator<Item = VersionPair<'a, CollectionType::Value>> {
+    pub fn pairs(&self) -> impl Iterator<Item = VersionPair<CollectionType::Value>> {
         self.source
             .map_field()
             .iter()
             .map(|(nv, source)| VersionPair { source, dest: self.get_compatible_item(nv) })
     }
-    pub fn compatible_pairs<'a>(
-        &'a self,
-    ) -> impl Iterator<Item = CompatibleVersionPair<'a, CollectionType::Value>> {
-        self.pairs().into_iter().filter_map(
+    pub fn compatible_pairs(
+        &self,
+    ) -> impl Iterator<Item = CompatibleVersionPair<CollectionType::Value>> {
+        self.pairs().filter_map(
             |pair: VersionPair<'_, <CollectionType as NameAndVersionMap>::Value>| {
                 pair.to_compatible()
             },
         )
     }
-    pub fn print(&self) {
-        for (nv, compatibility) in self.compatibility.iter() {
-            match compatibility {
-                Some(dest) => {
-                    println!("{} old {} -> new {}", nv.name(), nv.version(), dest.version())
-                }
-                None => {
-                    if self.dest.contains_name(nv.name()) {
-                        println!("{} {} -> NO MATCHING VERSION", nv.name(), nv.version())
-                    } else {
-                        println!("{} {} -> NOT FOUND IN NEW", nv.name(), nv.version())
-                    }
-                }
-            }
-        }
-        for (nv, _) in self.superfluous() {
-            println!("{} {} -> NOT FOUND IN OLD", nv.name(), nv.version());
-        }
-    }
-}
-
-impl<CollectionType: NameAndVersionMap> VersionMatch<CollectionType>
-where
-    CollectionType::Value: Migratable,
-{
-    pub fn ineligible(&self) -> impl Iterator<Item = &CollectionType::Value> {
-        self.source.map_field().values().filter(|val| !val.is_migration_eligible())
-    }
-    pub fn eligible_but_not_migratable<'a>(
-        &'a self,
-    ) -> impl Iterator<Item = VersionPair<'a, CollectionType::Value>> {
-        self.pairs().filter(|pair| {
-            pair.source.is_migration_eligible()
-                && !pair.dest.is_some_and(|dest| dest.is_migratable())
-        })
-    }
-    pub fn compatible_and_eligible<'a>(
-        &'a self,
-    ) -> impl Iterator<Item = CompatibleVersionPair<'a, CollectionType::Value>> {
-        self.compatible_pairs().filter(|crate_pair| crate_pair.source.is_migration_eligible())
-    }
-    pub fn migratable<'a>(
-        &'a self,
-    ) -> impl Iterator<Item = CompatibleVersionPair<'a, CollectionType::Value>> {
-        self.compatible_pairs()
-            .filter(|pair| pair.source.is_migration_eligible() && pair.dest.is_migratable())
-    }
 }
 
 impl VersionMatch<CrateCollection> {
     pub fn copy_customizations(&self) -> Result<()> {
-        for pair in self.compatible_and_eligible() {
+        for pair in self.compatible_pairs() {
             pair.copy_customizations()?;
         }
         Ok(())
     }
     pub fn stage_crates(&mut self) -> Result<()> {
-        for pair in self.compatible_and_eligible() {
+        for pair in self.compatible_pairs() {
             pair.dest.stage_crate()?;
         }
         Ok(())
     }
     pub fn apply_patches(&mut self) -> Result<()> {
         let (s, d, c) = (&self.source, &mut self.dest, &self.compatibility);
-        for (source_key, source_crate) in s.map_field() {
-            if source_crate.is_migration_eligible() {
-                if let Some(dest_crate) = c.get(source_key).and_then(|compatibility| {
-                    compatibility.as_ref().and_then(|dest_key| d.map_field_mut().get_mut(dest_key))
-                }) {
-                    dest_crate.apply_patches()?
-                }
+        for source_key in s.map_field().keys() {
+            if let Some(dest_crate) = c.get(source_key).and_then(|compatibility| {
+                compatibility.as_ref().and_then(|dest_key| d.map_field_mut().get_mut(dest_key))
+            }) {
+                dest_crate.apply_patches()?
             }
         }
         Ok(())
     }
     pub fn generate_android_bps(&mut self) -> Result<()> {
-        let results = generate_android_bps(self.compatible_and_eligible().map(|pair| pair.dest))?;
+        let results = generate_android_bps(self.compatible_pairs().map(|pair| pair.dest))?;
         for (nv, output) in results.into_iter() {
             self.dest
                 .map_field_mut()
@@ -202,7 +152,7 @@ impl VersionMatch<CrateCollection> {
 
     pub fn diff_android_bps(&mut self) -> Result<()> {
         let mut results = BTreeMap::new();
-        for pair in self.compatible_and_eligible() {
+        for pair in self.compatible_pairs() {
             results.insert_or_error(NameAndVersion::from(pair.dest), pair.diff_android_bps()?)?;
         }
         for (nv, output) in results.into_iter() {
@@ -214,17 +164,45 @@ impl VersionMatch<CrateCollection> {
         }
         Ok(())
     }
+
+    pub fn update_metadata(&self) -> Result<()> {
+        for pair in self.compatible_pairs() {
+            let mut metadata =
+                GoogleMetadata::try_from(pair.dest.staging_path().join(Path::new("METADATA"))?)?;
+            let mut writeback = false;
+            writeback |= metadata.migrate_homepage();
+            writeback |= metadata.migrate_archive();
+            writeback |= metadata.remove_deprecated_url();
+            if pair.source.version() != pair.dest.version() {
+                metadata.set_date_to_today()?;
+                metadata.set_version_and_urls(pair.dest.name(), pair.dest.version().to_string())?;
+                writeback |= true;
+            }
+            if writeback {
+                metadata.write()?;
+            }
+        }
+        Ok(())
+    }
 }
 
 #[cfg(test)]
 mod tests {
-    use crate::try_name_version_map_from_iter;
-
     use super::*;
     use anyhow::Result;
     use itertools::assert_equal;
     use std::collections::BTreeMap;
 
+    fn try_name_version_map_from_iter<'a, ValueType>(
+        nvs: impl IntoIterator<Item = (&'a str, &'a str, ValueType)>,
+    ) -> Result<BTreeMap<NameAndVersion, ValueType>, name_and_version::Error> {
+        let mut test_map = BTreeMap::new();
+        for (name, version, val) in nvs {
+            test_map.insert_or_error(NameAndVersion::try_from_str(name, version)?, val)?;
+        }
+        Ok(test_map)
+    }
+
     #[test]
     fn test_version_map() -> Result<()> {
         let source = try_name_version_map_from_iter([
@@ -347,81 +325,4 @@ mod tests {
 
         Ok(())
     }
-
-    #[derive(Debug, PartialEq, Eq)]
-    struct FakeMigratable {
-        name: String,
-        source: bool,
-        eligible: bool,
-        migratable: bool,
-    }
-
-    impl FakeMigratable {
-        pub fn source(name: &str, eligible: bool) -> FakeMigratable {
-            FakeMigratable { name: name.to_string(), source: true, eligible, migratable: false }
-        }
-        pub fn dest(migratable: bool) -> FakeMigratable {
-            FakeMigratable { name: "".to_string(), source: false, eligible: false, migratable }
-        }
-    }
-
-    impl Migratable for FakeMigratable {
-        fn is_migration_eligible(&self) -> bool {
-            if !self.source {
-                unreachable!("Checking if dest is migration-eligible");
-            }
-            self.eligible
-        }
-
-        fn is_migratable(&self) -> bool {
-            if self.source {
-                unreachable!("Checking if source is migratable");
-            }
-            self.migratable
-        }
-    }
-
-    #[test]
-    fn test_migratability() -> Result<()> {
-        let source = try_name_version_map_from_iter([
-            ("ineligible", "1.2.3", FakeMigratable::source("ineligible", false)),
-            (
-                "eligible incompatible",
-                "1.2.3",
-                FakeMigratable::source("eligible incompatible", true),
-            ),
-            ("eligible compatible", "1.2.3", FakeMigratable::source("eligible compatible", true)),
-            ("migratable", "1.2.3", FakeMigratable::source("migratable", true)),
-            (
-                "migratable incompatible",
-                "1.2.3",
-                FakeMigratable::source("migratable incompatible", true),
-            ),
-        ])?;
-        let dest = try_name_version_map_from_iter([
-            ("ineligible", "1.2.3", FakeMigratable::dest(true)),
-            ("eligible incompatible", "2.0.0", FakeMigratable::dest(true)),
-            ("eligible compatible", "1.2.3", FakeMigratable::dest(false)),
-            ("migratable", "1.2.3", FakeMigratable::dest(true)),
-            ("migratable incompatible", "2.0.0", FakeMigratable::dest(true)),
-        ])?;
-
-        let version_match = VersionMatch::new(source, dest)?;
-
-        assert_equal(version_match.ineligible().map(|m| m.name.as_str()), ["ineligible"]);
-        assert_equal(
-            version_match.eligible_but_not_migratable().map(|pair| pair.source.name.as_str()),
-            ["eligible compatible", "eligible incompatible", "migratable incompatible"],
-        );
-        assert_equal(
-            version_match.compatible_and_eligible().map(|pair| pair.source.name.as_str()),
-            ["eligible compatible", "migratable"],
-        );
-        assert_equal(
-            version_match.migratable().map(|pair| pair.source.name.as_str()),
-            ["migratable"],
-        );
-
-        Ok(())
-    }
 }
diff --git a/tools/external_crates/google_metadata/.gitignore b/tools/external_crates/google_metadata/.gitignore
new file mode 100644
index 000000000..ea8c4bf7f
--- /dev/null
+++ b/tools/external_crates/google_metadata/.gitignore
@@ -0,0 +1 @@
+/target
diff --git a/tools/external_crates/google_metadata/Android.bp b/tools/external_crates/google_metadata/Android.bp
new file mode 100644
index 000000000..985caa089
--- /dev/null
+++ b/tools/external_crates/google_metadata/Android.bp
@@ -0,0 +1,32 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file after the first "rust_*" or "genrule" module
+// because the changes will be overridden on upgrade.
+// Content before the first "rust_*" or "genrule" module is preserved.
+
+package {
+    default_team: "trendy_team_android_rust",
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+rust_library_host {
+    name: "libgoogle_metadata",
+    crate_name: "google_metadata",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    edition: "2021",
+    rustlibs: [
+        "libchrono",
+        "libgoogle_metadata_proto",
+        "libprotobuf",
+        "libthiserror",
+    ],
+}
+
+rust_protobuf {
+    name: "libgoogle_metadata_proto",
+    crate_name: "google_metadata_proto",
+    host_supported: true,
+    protos: ["src/protos/metadata.proto"],
+    source_stem: "google_metadata",
+}
diff --git a/tools/external_crates/google_metadata/Cargo.toml b/tools/external_crates/google_metadata/Cargo.toml
new file mode 100644
index 000000000..8f762afa0
--- /dev/null
+++ b/tools/external_crates/google_metadata/Cargo.toml
@@ -0,0 +1,16 @@
+[package]
+name = "google_metadata"
+version = "0.1.0"
+edition = "2021"
+
+[dependencies]
+chrono = "0.4"
+protobuf = "3"
+thiserror = "1.0"
+
+[build-dependencies]
+protobuf-codegen = "3"
+protobuf-parse = "3"
+
+[lints.rust]
+unexpected_cfgs = { level = "warn", check-cfg = ['cfg(soong)'] }
diff --git a/tools/external_crates/google_metadata/build.rs b/tools/external_crates/google_metadata/build.rs
new file mode 100644
index 000000000..daba93d3f
--- /dev/null
+++ b/tools/external_crates/google_metadata/build.rs
@@ -0,0 +1,12 @@
+fn main() {
+    protobuf_codegen::Codegen::new()
+        // Pure Rust codegen. Not as well-tested, but avoids needing protoc installed.
+        .pure()
+        // All inputs and imports from the inputs must reside in `includes` directories.
+        .include("src/protos")
+        // Inputs must reside in some of include paths.
+        .input("src/protos/metadata.proto")
+        // Specify output directory relative to Cargo output directory.
+        .cargo_out_dir("protos")
+        .run_from_script();
+}
diff --git a/tools/external_crates/google_metadata/cargo_embargo_protobuf.bp b/tools/external_crates/google_metadata/cargo_embargo_protobuf.bp
new file mode 100644
index 000000000..921b65c54
--- /dev/null
+++ b/tools/external_crates/google_metadata/cargo_embargo_protobuf.bp
@@ -0,0 +1,7 @@
+rust_protobuf {
+    name: "libgoogle_metadata_proto",
+    crate_name: "google_metadata_proto",
+    host_supported: true,
+    protos: ["src/protos/metadata.proto"],
+    source_stem: "google_metadata",
+}
diff --git a/tools/external_crates/google_metadata/patches/Android.bp.patch b/tools/external_crates/google_metadata/patches/Android.bp.patch
new file mode 100644
index 000000000..2cb5a92a8
--- /dev/null
+++ b/tools/external_crates/google_metadata/patches/Android.bp.patch
@@ -0,0 +1,12 @@
+diff --git a/tools/external_crates/google_metadata/Android.bp b/tools/external_crates/google_metadata/Android.bp
+index 374dd6678..253c116fd 100644
+--- a/tools/external_crates/google_metadata/Android.bp
++++ b/tools/external_crates/google_metadata/Android.bp
+@@ -17,6 +17,7 @@ rust_library_host {
+     edition: "2021",
+     rustlibs: [
+         "libchrono",
++        "libgoogle_metadata_proto",
+         "libprotobuf",
+         "libthiserror",
+     ],
diff --git a/tools/external_crates/google_metadata/src/lib.rs b/tools/external_crates/google_metadata/src/lib.rs
new file mode 100644
index 000000000..8c42806ba
--- /dev/null
+++ b/tools/external_crates/google_metadata/src/lib.rs
@@ -0,0 +1,187 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! Crate for handling Google METADATA files.
+
+use std::{
+    fs::{read_to_string, write},
+    path::PathBuf,
+};
+
+use chrono::Datelike;
+use protobuf::text_format::ParseError;
+
+#[cfg(soong)]
+mod metadata_proto {
+    pub use google_metadata_proto::metadata::Identifier;
+    pub use google_metadata_proto::metadata::LicenseType;
+    pub use google_metadata_proto::metadata::MetaData;
+}
+
+#[cfg(not(soong))]
+mod metadata_proto {
+    include!(concat!(env!("OUT_DIR"), "/protos/mod.rs"));
+    pub use crate::metadata::Identifier;
+    pub use crate::metadata::LicenseType;
+    pub use crate::metadata::MetaData;
+}
+
+pub use metadata_proto::*;
+
+#[allow(missing_docs)]
+#[derive(thiserror::Error, Debug)]
+pub enum Error {
+    #[error("File exists: {}", .0.display())]
+    FileExists(PathBuf),
+    #[error("Crate name not set")]
+    CrateNameMissing(),
+    #[error("Crate names don't match: {} in METADATA vs {}", .0, .1)]
+    CrateNameMismatch(String, String),
+    #[error("Glob pattern error")]
+    ParseError(#[from] ParseError),
+    #[error("Write error")]
+    WriteError(#[from] std::io::Error),
+}
+
+/// Wrapper around a Google METADATA file.
+pub struct GoogleMetadata {
+    path: PathBuf,
+    metadata: MetaData,
+}
+
+impl GoogleMetadata {
+    /// Reads an existing METADATA file.
+    pub fn try_from<P: Into<PathBuf>>(path: P) -> Result<Self, Error> {
+        let path = path.into();
+        let metadata = read_to_string(&path)?;
+        let metadata: MetaData = protobuf::text_format::parse_from_str(&metadata)?;
+        Ok(GoogleMetadata { path, metadata })
+    }
+    /// Initializes a new METADATA file.
+    pub fn init<P: Into<PathBuf>, Q: Into<String>, R: Into<String>, S: Into<String>>(
+        path: P,
+        name: Q,
+        version: R,
+        desc: S,
+        license_type: LicenseType,
+    ) -> Result<Self, Error> {
+        let path = path.into();
+        if path.exists() {
+            return Err(Error::FileExists(path));
+        }
+        let mut metadata = GoogleMetadata { path, metadata: MetaData::new() };
+        let name = name.into();
+        metadata.set_date_to_today()?;
+        metadata.set_version_and_urls(&name, version)?;
+        let third_party = metadata.metadata.third_party.mut_or_insert_default();
+        third_party.set_homepage(crates_io_homepage(&name));
+        third_party.set_license_type(license_type);
+        metadata.metadata.set_name(name);
+        metadata.metadata.set_description(desc.into());
+        Ok(metadata)
+    }
+    /// Writes to the METADATA file.
+    ///
+    /// The existing file is overwritten.
+    pub fn write(&self) -> Result<(), Error> {
+        Ok(write(&self.path, protobuf::text_format::print_to_string_pretty(&self.metadata))?)
+    }
+    /// Sets the date fields to today's date.
+    pub fn set_date_to_today(&mut self) -> Result<(), Error> {
+        let now = chrono::Utc::now();
+        let date = self
+            .metadata
+            .third_party
+            .mut_or_insert_default()
+            .last_upgrade_date
+            .mut_or_insert_default();
+        date.set_day(now.day().try_into().unwrap());
+        date.set_month(now.month().try_into().unwrap());
+        date.set_year(now.year());
+        Ok(())
+    }
+    /// Sets the version and URL fields.
+    ///
+    /// Sets third_party.homepage and third_party.version, and
+    /// a single "Archive" identifier with crate archive URL and version.
+    pub fn set_version_and_urls<Q: Into<String>>(
+        &mut self,
+        name: impl AsRef<str>,
+        version: Q,
+    ) -> Result<(), Error> {
+        let name_in_metadata = self.metadata.name.as_ref().ok_or(Error::CrateNameMissing())?;
+        if name_in_metadata != name.as_ref() {
+            return Err(Error::CrateNameMismatch(
+                name_in_metadata.clone(),
+                name.as_ref().to_string(),
+            ));
+        }
+        let third_party = self.metadata.third_party.mut_or_insert_default();
+        third_party.set_homepage(crates_io_homepage(&name));
+        let version = version.into();
+        third_party.set_version(version.clone());
+        let mut identifier = Identifier::new();
+        identifier.set_type("Archive".to_string());
+        identifier.set_value(crate_archive_url(name, &version));
+        identifier.set_version(version);
+        self.metadata.third_party.mut_or_insert_default().identifier.clear();
+        self.metadata.third_party.mut_or_insert_default().identifier.push(identifier);
+        Ok(())
+    }
+    /// Migrate homepage from an identifier to its own field.
+    pub fn migrate_homepage(&mut self) -> bool {
+        let mut homepage = None;
+        for (idx, identifier) in self.metadata.third_party.identifier.iter().enumerate() {
+            if identifier.type_.as_ref().unwrap_or(&String::new()).to_lowercase() == "homepage" {
+                match homepage {
+                    Some(info) => panic!("Homepage set twice? {info:?} {identifier:?}"),
+                    None => homepage = Some((idx, identifier.clone())),
+                }
+            }
+        }
+        let Some(homepage) = homepage else { return false };
+        self.metadata.third_party.mut_or_insert_default().identifier.remove(homepage.0);
+        self.metadata.third_party.mut_or_insert_default().homepage = homepage.1.value;
+        true
+    }
+    /// Normalize case of 'Archive' identifiers.
+    pub fn migrate_archive(&mut self) -> bool {
+        let mut updated = false;
+        for identifier in self.metadata.third_party.mut_or_insert_default().identifier.iter_mut() {
+            if identifier.type_ == Some("ARCHIVE".to_string()) {
+                identifier.type_ = Some("Archive".to_string());
+                updated = true;
+            }
+        }
+        updated
+    }
+    /// Remove deprecate URL fields.
+    pub fn remove_deprecated_url(&mut self) -> bool {
+        let updated = !self.metadata.third_party.url.is_empty();
+        self.metadata.third_party.mut_or_insert_default().url.clear();
+        updated
+    }
+}
+
+fn crate_archive_url(name: impl AsRef<str>, version: impl AsRef<str>) -> String {
+    format!(
+        "https://static.crates.io/crates/{}/{}-{}.crate",
+        name.as_ref(),
+        name.as_ref(),
+        version.as_ref()
+    )
+}
+fn crates_io_homepage(name: impl AsRef<str>) -> String {
+    format!("https://crates.io/crates/{}", name.as_ref())
+}
diff --git a/tools/external_crates/google_metadata/src/protos/metadata.proto b/tools/external_crates/google_metadata/src/protos/metadata.proto
new file mode 100644
index 000000000..de6c5f63d
--- /dev/null
+++ b/tools/external_crates/google_metadata/src/protos/metadata.proto
@@ -0,0 +1,104 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+// A proto definition used to parse METADATA file in third party projects.
+
+// This proto will only contain fields and values the updater cares about.
+// It is not intended to be the formal definition of METADATA file.
+
+// See google3/third_party/metadata.proto if you need to add more stuff to match
+// upstream.
+
+syntax = "proto2"; // As long as upstream is proto2...
+
+package external_updater;
+
+message MetaData {
+  optional string name = 1;
+  optional string description = 3;
+  optional ThirdPartyMetaData third_party = 13;
+}
+
+enum LicenseType {
+  UNKNOWN = 0;
+  BY_EXCEPTION_ONLY = 1;
+  NOTICE = 2;
+  PERMISSIVE = 3;
+  RECIPROCAL = 4;
+  RESTRICTED_IF_STATICALLY_LINKED = 5;
+  RESTRICTED = 6;
+  UNENCUMBERED = 7;
+}
+
+enum DirectoryType {
+  PACKAGE = 1;
+  GOOGLE_INTERNAL = 4;
+}
+
+message ThirdPartyMetaData {
+  repeated URL url = 1;
+  optional string version = 2;
+  optional LicenseType license_type = 4;
+  optional string license_note = 5;
+  optional string local_modifications = 6;
+  optional Security security = 7;
+  optional Date last_upgrade_date = 10;
+  optional DirectoryType type = 11 [default = PACKAGE];
+  optional string homepage = 14;
+  repeated Identifier identifier = 15;
+}
+
+message URL {
+  enum Type {
+    UNKNOWN = 0;
+    HOMEPAGE = 1;
+    ARCHIVE = 2;
+    GIT = 3;
+    PIPER = 4;
+    SVN = 7;
+    HG = 8;
+    DARCS = 9;
+    OTHER = 11;
+  }
+
+  optional Type type = 1;
+
+  optional string value = 2;
+}
+
+message Identifier {
+  optional string type = 1;
+  optional string value = 3;
+  optional string version = 4;
+  optional bool primary_source = 6;
+}
+
+message Date {
+  optional int32 year = 1;
+  optional int32 month = 2;
+  optional int32 day = 3;
+}
+
+message Security {
+  enum Category {
+    SANDBOXED_ONLY = 1;
+    TRUSTED_DATA_ONLY = 2;
+    REVIEWED_AND_SECURE = 3;
+  }
+
+  optional Category category = 1;
+  optional string note = 2;
+  repeated string tag = 3;
+  repeated string mitigated_security_patch = 5;
+}
diff --git a/tools/external_crates/license_checker/.gitignore b/tools/external_crates/license_checker/.gitignore
new file mode 100644
index 000000000..96ef6c0b9
--- /dev/null
+++ b/tools/external_crates/license_checker/.gitignore
@@ -0,0 +1,2 @@
+/target
+Cargo.lock
diff --git a/tools/external_crates/license_checker/Cargo.toml b/tools/external_crates/license_checker/Cargo.toml
new file mode 100644
index 000000000..4b16856dc
--- /dev/null
+++ b/tools/external_crates/license_checker/Cargo.toml
@@ -0,0 +1,11 @@
+[package]
+name = "license_checker"
+version = "0.1.0"
+edition = "2021"
+
+[dependencies]
+gestalt_ratio = "0.2"
+glob = "0.3"
+itertools = "0.11"
+spdx = "0.10"
+thiserror = "1.0"
diff --git a/tools/external_crates/license_checker/src/content_checker.rs b/tools/external_crates/license_checker/src/content_checker.rs
new file mode 100644
index 000000000..5dad7be7f
--- /dev/null
+++ b/tools/external_crates/license_checker/src/content_checker.rs
@@ -0,0 +1,117 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use gestalt_ratio::gestalt_ratio;
+use itertools::Itertools;
+use spdx::{LicenseReq, Licensee};
+use std::sync::LazyLock;
+
+fn strip_punctuation(text: &str) -> String {
+    let lowercase = text.to_lowercase();
+    let mut processed = String::with_capacity(lowercase.len());
+    for c in lowercase.chars() {
+        if c.is_alphanumeric() || c == '.' {
+            processed.push(c)
+        } else if !processed.ends_with(' ') {
+            processed.push(' ')
+        }
+    }
+    processed.trim().to_string()
+}
+
+// TODO: It's possible for some license files to contain multiple licenses concatenated together
+pub(crate) fn classify_license_file_contents(contents: &str) -> Option<LicenseReq> {
+    let contents = strip_punctuation(contents);
+
+    // Exact match
+    for (req, required_text) in LICENSE_CONTENT_CLASSIFICATION.iter() {
+        if contents.contains(required_text) {
+            return Some(req.clone());
+        }
+    }
+
+    // Fuzzy match. This is expensive, so start with licenses that are closest in length to the file.
+    for (req, required_text) in LICENSE_CONTENT_CLASSIFICATION.iter().sorted_by(|a, b| {
+        let mut ra = a.1.len() as f32 / contents.len() as f32;
+        let mut rb = b.1.len() as f32 / contents.len() as f32;
+        if ra > 1.0 {
+            ra = 1.0 / ra;
+        }
+        if rb > 1.0 {
+            rb = 1.0 / rb;
+        }
+        rb.partial_cmp(&ra).unwrap()
+    }) {
+        let similarity = gestalt_ratio(&contents, required_text);
+        if similarity > 0.95 {
+            return Some(req.clone());
+        }
+    }
+
+    None
+}
+
+static LICENSE_CONTENT_CLASSIFICATION: LazyLock<Vec<(LicenseReq, String)>> = LazyLock::new(|| {
+    vec![
+        ("MIT", include_str!("licenses/MIT.txt")),
+        ("Apache-2.0", include_str!("licenses/Apache-2.0.txt")),
+        ("ISC", include_str!("licenses/ISC.txt")),
+        ("MPL-2.0", include_str!("licenses/MPL-2.0.txt")),
+        ("BSD-2-Clause", include_str!("licenses/BSD-2-Clause.txt")),
+        ("BSD-3-Clause", include_str!("licenses/BSD-3-Clause.txt")),
+        ("Unlicense", include_str!("licenses/Unlicense.txt")),
+    ]
+    .into_iter()
+    .map(|(req, tokens)| {
+        let tokens = strip_punctuation(tokens);
+        assert!(!tokens.is_empty());
+        (Licensee::parse(req).unwrap().into_req(), tokens)
+    })
+    .collect()
+});
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn test_strip_punctuation() {
+        assert_eq!(strip_punctuation("FOO BAR"), "foo bar", "Converted to lowercase");
+        assert_eq!(strip_punctuation("foo, bar"), "foo bar", "Punctuation removed");
+        assert_eq!(strip_punctuation("foo. bar"), "foo. bar", "Periods preserved");
+        assert_eq!(
+            strip_punctuation(" foo bar "),
+            "foo bar",
+            "Leading and trailing whitespace stripped"
+        );
+        assert_eq!(
+            strip_punctuation(" foo\n\n\n\nbar "),
+            "foo bar",
+            "Multiple whitespace replaced with single space"
+        );
+    }
+
+    #[test]
+    fn test_classify() {
+        assert!(classify_license_file_contents("foo").is_none());
+        assert_eq!(
+            classify_license_file_contents(include_str!("testdata/BSD-3-Clause-bindgen.txt")),
+            Some(Licensee::parse("BSD-3-Clause").unwrap().into_req())
+        );
+        assert_eq!(
+            classify_license_file_contents(include_str!("testdata/LICENSE-MIT-aarch64-paging.txt")),
+            Some(Licensee::parse("MIT").unwrap().into_req())
+        );
+    }
+}
diff --git a/tools/external_crates/license_checker/src/expression_parser.rs b/tools/external_crates/license_checker/src/expression_parser.rs
new file mode 100644
index 000000000..275471039
--- /dev/null
+++ b/tools/external_crates/license_checker/src/expression_parser.rs
@@ -0,0 +1,150 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use spdx::{Expression, LicenseReq, Licensee};
+use std::{
+    collections::{BTreeMap, BTreeSet},
+    sync::LazyLock,
+};
+
+use crate::LicenseCheckerError;
+
+pub(crate) fn get_chosen_licenses(
+    crate_name: &str,
+    cargo_toml_license: Option<&str>,
+) -> Result<BTreeSet<LicenseReq>, LicenseCheckerError> {
+    Ok(BTreeSet::from_iter(
+        Expression::parse(&get_spdx_expr(crate_name, cargo_toml_license)?)?
+            .minimized_requirements(LICENSE_PREFERENCE.iter())?,
+    ))
+}
+
+fn get_spdx_expr(
+    crate_name: &str,
+    cargo_toml_license: Option<&str>,
+) -> Result<String, LicenseCheckerError> {
+    // Check special cases.
+    if let Some((raw, expr)) = LICENSE_EXPR_SPECIAL_CASES.get(crate_name) {
+        if *raw != cargo_toml_license {
+            return Err(LicenseCheckerError::LicenseExpressionSpecialCase {
+                crate_name: crate_name.to_string(),
+                expected_license: raw.unwrap_or_default().to_string(),
+                cargo_toml_license: cargo_toml_license.unwrap_or_default().to_string(),
+            });
+        }
+        return Ok(expr.to_string());
+    }
+    // Default. Look at the license field in Cargo.toml, and treat '/' as OR.
+    if let Some(lic) = cargo_toml_license {
+        if lic.contains('/') {
+            Ok(lic.replace('/', " OR "))
+        } else {
+            Ok(lic.to_string())
+        }
+    } else {
+        Err(LicenseCheckerError::MissingLicenseField(crate_name.to_string()))
+    }
+}
+
+static LICENSE_PREFERENCE: LazyLock<Vec<Licensee>> = LazyLock::new(|| {
+    vec![
+        "Apache-2.0",
+        "MIT",
+        "BSD-3-Clause",
+        "BSD-2-Clause",
+        "ISC",
+        "MPL-2.0",
+        "0BSD",
+        "Unlicense",
+        "Zlib",
+        "Unicode-DFS-2016",
+        "NCSA",
+        "OpenSSL",
+    ]
+    .into_iter()
+    .map(|l| Licensee::parse(l).unwrap())
+    .collect()
+});
+static LICENSE_EXPR_SPECIAL_CASES: LazyLock<
+    BTreeMap<&'static str, (Option<&'static str>, &'static str)>,
+> = LazyLock::new(|| {
+    BTreeMap::from([
+        ("libfuzzer-sys", (Some("MIT/Apache-2.0/NCSA"), "(MIT OR Apache-2.0) AND NCSA")),
+        ("ring", (None, "MIT AND ISC AND OpenSSL")),
+        ("webpki", (None, "ISC AND BSD-3-Clause")),
+    ])
+});
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn test_get_spdx_expr() -> Result<(), LicenseCheckerError> {
+        assert_eq!(get_spdx_expr("foo", Some("MIT"))?, "MIT");
+
+        // No license, no exception
+        assert!(get_spdx_expr("foo", None).is_err());
+
+        // '/' treated as OR
+        assert_eq!(get_spdx_expr("foo", Some("MIT/Apache-2.0"))?, "MIT OR Apache-2.0");
+
+        // Exceptions.
+        assert_eq!(
+            get_spdx_expr("libfuzzer-sys", Some("MIT/Apache-2.0/NCSA"))?,
+            "(MIT OR Apache-2.0) AND NCSA"
+        );
+        assert_eq!(get_spdx_expr("ring", None)?, "MIT AND ISC AND OpenSSL");
+
+        // Exceptions. Raw license in Cargo.toml must match, if present.
+        assert!(get_spdx_expr("libfuzzer-sys", Some("blah")).is_err());
+        assert!(get_spdx_expr("libfuzzer-sys", None).is_err());
+        assert!(get_spdx_expr("ring", Some("blah")).is_err());
+
+        Ok(())
+    }
+
+    #[test]
+    fn test_get_chosen_licenses() -> Result<(), LicenseCheckerError> {
+        assert_eq!(
+            get_chosen_licenses("foo", Some("MIT"))?,
+            BTreeSet::from([Licensee::parse("MIT").unwrap().into_req()]),
+            "Simple case"
+        );
+        assert_eq!(
+            get_chosen_licenses("foo", Some("MIT OR Apache-2.0"))?,
+            BTreeSet::from([Licensee::parse("Apache-2.0").unwrap().into_req()]),
+            "Apache preferred to MIT"
+        );
+        assert!(get_chosen_licenses("foo", Some("GPL")).is_err(), "Unacceptable license");
+        assert!(get_chosen_licenses("foo", Some("blah")).is_err(), "Unrecognized license");
+        assert_eq!(
+            get_chosen_licenses("foo", Some("MIT AND Apache-2.0"))?,
+            BTreeSet::from([
+                Licensee::parse("Apache-2.0").unwrap().into_req(),
+                Licensee::parse("MIT").unwrap().into_req()
+            ]),
+            "Apache preferred to MIT"
+        );
+        assert_eq!(
+            get_chosen_licenses("webpki", None)?,
+            BTreeSet::from([
+                Licensee::parse("ISC").unwrap().into_req(),
+                Licensee::parse("BSD-3-Clause").unwrap().into_req()
+            ]),
+            "Exception"
+        );
+        Ok(())
+    }
+}
diff --git a/tools/external_crates/license_checker/src/file_name_checker.rs b/tools/external_crates/license_checker/src/file_name_checker.rs
new file mode 100644
index 000000000..e44fec3cb
--- /dev/null
+++ b/tools/external_crates/license_checker/src/file_name_checker.rs
@@ -0,0 +1,120 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::BTreeMap,
+    ffi::{OsStr, OsString},
+    path::Path,
+    sync::LazyLock,
+};
+
+use spdx::{LicenseReq, Licensee};
+
+pub(crate) fn classify_license_file_name(file: impl AsRef<Path>) -> Option<LicenseReq> {
+    // File should be relative
+    let file = file.as_ref();
+    let mut basename = if file.extension() == Some(OsStr::new("txt"))
+        || file.extension() == Some(OsStr::new("md"))
+    {
+        file.with_extension("")
+    } else {
+        file.to_owned()
+    };
+    let uppercase_name = basename.as_mut_os_string();
+    uppercase_name.make_ascii_uppercase();
+    if let Some(req) = LICENSE_FILE_NAME_CLASSIFICATION.get(uppercase_name) {
+        return Some(req.clone());
+    }
+    None
+}
+
+static LICENSE_FILE_NAME_CLASSIFICATION: LazyLock<BTreeMap<OsString, LicenseReq>> = LazyLock::new(
+    ||
+        // Filenames are case-insensitive.
+        vec![
+            ("LICENSE-MIT", "MIT"),
+            ("LICENSES/MIT", "MIT"),
+
+            ("LICENSE-APACHE", "Apache-2.0"),
+            ("LICENSE-APACHE-2.0", "Apache-2.0"),
+            ("LICENSES/Apache-2.0", "Apache-2.0"),
+
+            ("LICENSE-BSD-3-Clause", "BSD-3-Clause"),
+
+            ("LICENSE-UNICODE", "Unicode-DFS-2016"),
+
+            ("LICENSE-0BSD", "0BSD"),
+
+            ("LICENSE-ZLIB", "Zlib"),
+
+            ("UNLICENSE", "Unlicense"),
+        ]
+        .into_iter()
+        .map(|(file, req)| (OsString::from(file.to_uppercase()), Licensee::parse(req).unwrap().into_req()))
+        .collect(),
+);
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn test_classify() {
+        assert!(classify_license_file_name(Path::new("LICENSE")).is_none(), "Generic license name");
+        assert_eq!(
+            classify_license_file_name(Path::new("UNLICENSE")),
+            Some(Licensee::parse("Unlicense").unwrap().into_req()),
+            "Unlicense"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSE-MIT")),
+            Some(Licensee::parse("MIT").unwrap().into_req()),
+            "Standard name"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSE-APACHE")),
+            Some(Licensee::parse("Apache-2.0").unwrap().into_req()),
+            "Standard name"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSE-apache")),
+            Some(Licensee::parse("Apache-2.0").unwrap().into_req()),
+            "Case-insensitive"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSE-APACHE.md")),
+            Some(Licensee::parse("Apache-2.0").unwrap().into_req()),
+            ".md extension ignored"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSE-0BSD.txt")),
+            Some(Licensee::parse("0BSD").unwrap().into_req()),
+            ".txt extension ignored"
+        );
+        assert!(
+            classify_license_file_name(Path::new("LICENSE-0BSD.jpg")).is_none(),
+            "Random extension preserved"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSES/MIT")),
+            Some(Licensee::parse("MIT").unwrap().into_req()),
+            "Subdirectory"
+        );
+        assert_eq!(
+            classify_license_file_name(Path::new("LICENSES/Apache-2.0")),
+            Some(Licensee::parse("Apache-2.0").unwrap().into_req()),
+            "Subdirectory"
+        );
+    }
+}
diff --git a/tools/external_crates/license_checker/src/lib.rs b/tools/external_crates/license_checker/src/lib.rs
new file mode 100644
index 000000000..964adfe1d
--- /dev/null
+++ b/tools/external_crates/license_checker/src/lib.rs
@@ -0,0 +1,96 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::{BTreeMap, BTreeSet},
+    fs::read_to_string,
+    path::{Path, PathBuf},
+};
+
+use spdx::LicenseReq;
+use thiserror::Error;
+
+mod content_checker;
+mod expression_parser;
+mod file_name_checker;
+mod license_file_finder;
+
+#[derive(Error, Debug)]
+pub enum LicenseCheckerError {
+    #[error("Couldn't convert filesystem path {} (lossy) to a string for globbing.", .0.to_string_lossy())]
+    PathToString(PathBuf),
+    #[error("Glob error")]
+    GlobError(#[from] glob::GlobError),
+    #[error("Glob pattern error")]
+    PatternError(#[from] glob::PatternError),
+    #[error("Strip prefix error")]
+    StripPrefixError(#[from] std::path::StripPrefixError),
+    #[error("Found a license expression special case for crate {crate_name} but the Cargo.toml license field doesn't match. Expected '{expected_license}', found '{cargo_toml_license}'")]
+    LicenseExpressionSpecialCase {
+        crate_name: String,
+        expected_license: String,
+        cargo_toml_license: String,
+    },
+    #[error("Crate {0} doesn't have a license field in Cargo.toml, and no special case was found for this crate")]
+    MissingLicenseField(String),
+    #[error("SPDX expression parse error")]
+    ParseError(#[from] spdx::ParseError),
+    #[error("SPDX expression minimize error")]
+    MinimizeError(#[from] spdx::expression::MinimizeError),
+    #[error("Unknown license checker error")]
+    Unknown,
+}
+
+#[derive(Debug)]
+pub struct LicenseState {
+    pub unsatisfied: BTreeSet<LicenseReq>,
+    pub satisfied: BTreeMap<LicenseReq, PathBuf>,
+}
+
+pub fn find_licenses(
+    crate_path: impl AsRef<Path>,
+    crate_name: &str,
+    cargo_toml_license: Option<&str>,
+) -> Result<LicenseState, LicenseCheckerError> {
+    let crate_path = crate_path.as_ref();
+    let mut state = LicenseState { unsatisfied: BTreeSet::new(), satisfied: BTreeMap::new() };
+
+    state.unsatisfied = expression_parser::get_chosen_licenses(crate_name, cargo_toml_license)?;
+    let mut possible_license_files = license_file_finder::find_license_files(crate_path)?;
+
+    possible_license_files.retain(|file| {
+        if let Some(req) = file_name_checker::classify_license_file_name(file) {
+            if state.unsatisfied.remove(&req) {
+                state.satisfied.insert(req, file.clone());
+                return false;
+            }
+        }
+        true
+    });
+
+    if !state.unsatisfied.is_empty() {
+        possible_license_files.retain(|file| {
+            let contents = read_to_string(crate_path.join(file)).unwrap();
+            if let Some(req) = content_checker::classify_license_file_contents(&contents) {
+                if state.unsatisfied.remove(&req) {
+                    state.satisfied.insert(req, file.clone());
+                    return false;
+                }
+            }
+            true
+        });
+    }
+
+    Ok(state)
+}
diff --git a/tools/external_crates/license_checker/src/license_file_finder.rs b/tools/external_crates/license_checker/src/license_file_finder.rs
new file mode 100644
index 000000000..70fb34fe3
--- /dev/null
+++ b/tools/external_crates/license_checker/src/license_file_finder.rs
@@ -0,0 +1,51 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+use std::{
+    collections::BTreeSet,
+    path::{Path, PathBuf},
+};
+
+use glob::glob;
+
+use crate::LicenseCheckerError;
+
+static LICENSE_GLOBS: &[&str] =
+    &["LICENSE", "LICENCE", "LICENSE.*", "LICENSE-*", "LICENSES/*", "UNLICENSE", "COPYING"];
+
+pub(crate) fn find_license_files(
+    path: impl AsRef<Path>,
+) -> Result<BTreeSet<PathBuf>, LicenseCheckerError> {
+    multiglob(path, LICENSE_GLOBS.iter())
+}
+
+fn multiglob<T: AsRef<str>>(
+    path: impl AsRef<Path>,
+    patterns: impl Iterator<Item = T>,
+) -> Result<BTreeSet<PathBuf>, LicenseCheckerError> {
+    let path = path.as_ref();
+    let mut matches = BTreeSet::new();
+    for pattern in patterns {
+        let pattern = path.join(pattern.as_ref());
+        for file in
+            glob(pattern.to_str().ok_or(LicenseCheckerError::PathToString(pattern.clone()))?)?
+        {
+            let file = file?;
+            if !file.is_symlink() {
+                matches.insert(file.strip_prefix(path)?.to_owned());
+            }
+        }
+    }
+    Ok(matches)
+}
diff --git a/tools/external_crates/license_checker/src/licenses/Apache-2.0.txt b/tools/external_crates/license_checker/src/licenses/Apache-2.0.txt
new file mode 100644
index 000000000..1d6d25886
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/Apache-2.0.txt
@@ -0,0 +1,166 @@
+      "License" shall mean the terms and conditions for use, reproduction,
+      and distribution as defined by Sections 1 through 9 of this document.
+
+      "Licensor" shall mean the copyright owner or entity authorized by
+      the copyright owner that is granting the License.
+
+      "Legal Entity" shall mean the union of the acting entity and all
+      other entities that control, are controlled by, or are under common
+      control with that entity. For the purposes of this definition,
+      "control" means (i) the power, direct or indirect, to cause the
+      direction or management of such entity, whether by contract or
+      otherwise, or (ii) ownership of fifty percent (50%) or more of the
+      outstanding shares, or (iii) beneficial ownership of such entity.
+
+      "You" (or "Your") shall mean an individual or Legal Entity
+      exercising permissions granted by this License.
+
+      "Source" form shall mean the preferred form for making modifications,
+      including but not limited to software source code, documentation
+      source, and configuration files.
+
+      "Object" form shall mean any form resulting from mechanical
+      transformation or translation of a Source form, including but
+      not limited to compiled object code, generated documentation,
+      and conversions to other media types.
+
+      "Work" shall mean the work of authorship, whether in Source or
+      Object form, made available under the License, as indicated by a
+      copyright notice that is included in or attached to the work
+      (an example is provided in the Appendix below).
+
+      "Derivative Works" shall mean any work, whether in Source or Object
+      form, that is based on (or derived from) the Work and for which the
+      editorial revisions, annotations, elaborations, or other modifications
+      represent, as a whole, an original work of authorship. For the purposes
+      of this License, Derivative Works shall not include works that remain
+      separable from, or merely link (or bind by name) to the interfaces of,
+      the Work and Derivative Works thereof.
+
+      "Contribution" shall mean any work of authorship, including
+      the original version of the Work and any modifications or additions
+      to that Work or Derivative Works thereof, that is intentionally
+      submitted to Licensor for inclusion in the Work by the copyright owner
+      or by an individual or Legal Entity authorized to submit on behalf of
+      the copyright owner. For the purposes of this definition, "submitted"
+      means any form of electronic, verbal, or written communication sent
+      to the Licensor or its representatives, including but not limited to
+      communication on electronic mailing lists, source code control systems,
+      and issue tracking systems that are managed by, or on behalf of, the
+      Licensor for the purpose of discussing and improving the Work, but
+      excluding communication that is conspicuously marked or otherwise
+      designated in writing by the copyright owner as "Not a Contribution."
+
+      "Contributor" shall mean Licensor and any individual or Legal Entity
+      on behalf of whom a Contribution has been received by Licensor and
+      subsequently incorporated within the Work.
+
+   2. Grant of Copyright License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      copyright license to reproduce, prepare Derivative Works of,
+      publicly display, publicly perform, sublicense, and distribute the
+      Work and such Derivative Works in Source or Object form.
+
+   3. Grant of Patent License. Subject to the terms and conditions of
+      this License, each Contributor hereby grants to You a perpetual,
+      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
+      (except as stated in this section) patent license to make, have made,
+      use, offer to sell, sell, import, and otherwise transfer the Work,
+      where such license applies only to those patent claims licensable
+      by such Contributor that are necessarily infringed by their
+      Contribution(s) alone or by combination of their Contribution(s)
+      with the Work to which such Contribution(s) was submitted. If You
+      institute patent litigation against any entity (including a
+      cross-claim or counterclaim in a lawsuit) alleging that the Work
+      or a Contribution incorporated within the Work constitutes direct
+      or contributory patent infringement, then any patent licenses
+      granted to You under this License for that Work shall terminate
+      as of the date such litigation is filed.
+
+   4. Redistribution. You may reproduce and distribute copies of the
+      Work or Derivative Works thereof in any medium, with or without
+      modifications, and in Source or Object form, provided that You
+      meet the following conditions:
+
+      (a) You must give any other recipients of the Work or
+          Derivative Works a copy of this License; and
+
+      (b) You must cause any modified files to carry prominent notices
+          stating that You changed the files; and
+
+      (c) You must retain, in the Source form of any Derivative Works
+          that You distribute, all copyright, patent, trademark, and
+          attribution notices from the Source form of the Work,
+          excluding those notices that do not pertain to any part of
+          the Derivative Works; and
+
+      (d) If the Work includes a "NOTICE" text file as part of its
+          distribution, then any Derivative Works that You distribute must
+          include a readable copy of the attribution notices contained
+          within such NOTICE file, excluding those notices that do not
+          pertain to any part of the Derivative Works, in at least one
+          of the following places: within a NOTICE text file distributed
+          as part of the Derivative Works; within the Source form or
+          documentation, if provided along with the Derivative Works; or,
+          within a display generated by the Derivative Works, if and
+          wherever such third-party notices normally appear. The contents
+          of the NOTICE file are for informational purposes only and
+          do not modify the License. You may add Your own attribution
+          notices within Derivative Works that You distribute, alongside
+          or as an addendum to the NOTICE text from the Work, provided
+          that such additional attribution notices cannot be construed
+          as modifying the License.
+
+      You may add Your own copyright statement to Your modifications and
+      may provide additional or different license terms and conditions
+      for use, reproduction, or distribution of Your modifications, or
+      for any such Derivative Works as a whole, provided Your use,
+      reproduction, and distribution of the Work otherwise complies with
+      the conditions stated in this License.
+
+   5. Submission of Contributions. Unless You explicitly state otherwise,
+      any Contribution intentionally submitted for inclusion in the Work
+      by You to the Licensor shall be under the terms and conditions of
+      this License, without any additional terms or conditions.
+      Notwithstanding the above, nothing herein shall supersede or modify
+      the terms of any separate license agreement you may have executed
+      with Licensor regarding such Contributions.
+
+   6. Trademarks. This License does not grant permission to use the trade
+      names, trademarks, service marks, or product names of the Licensor,
+      except as required for reasonable and customary use in describing the
+      origin of the Work and reproducing the content of the NOTICE file.
+
+   7. Disclaimer of Warranty. Unless required by applicable law or
+      agreed to in writing, Licensor provides the Work (and each
+      Contributor provides its Contributions) on an "AS IS" BASIS,
+      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
+      implied, including, without limitation, any warranties or conditions
+      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
+      PARTICULAR PURPOSE. You are solely responsible for determining the
+      appropriateness of using or redistributing the Work and assume any
+      risks associated with Your exercise of permissions under this License.
+
+   8. Limitation of Liability. In no event and under no legal theory,
+      whether in tort (including negligence), contract, or otherwise,
+      unless required by applicable law (such as deliberate and grossly
+      negligent acts) or agreed to in writing, shall any Contributor be
+      liable to You for damages, including any direct, indirect, special,
+      incidental, or consequential damages of any character arising as a
+      result of this License or out of the use or inability to use the
+      Work (including but not limited to damages for loss of goodwill,
+      work stoppage, computer failure or malfunction, or any and all
+      other commercial damages or losses), even if such Contributor
+      has been advised of the possibility of such damages.
+
+   9. Accepting Warranty or Additional Liability. While redistributing
+      the Work or Derivative Works thereof, You may choose to offer,
+      and charge a fee for, acceptance of support, warranty, indemnity,
+      or other liability obligations and/or rights consistent with this
+      License. However, in accepting such obligations, You may act only
+      on Your own behalf and on Your sole responsibility, not on behalf
+      of any other Contributor, and only if You agree to indemnify,
+      defend, and hold each Contributor harmless for any liability
+      incurred by, or claims asserted against, such Contributor by reason
+      of your accepting any such warranty or additional liability.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/BSD-2-Clause.txt b/tools/external_crates/license_checker/src/licenses/BSD-2-Clause.txt
new file mode 100644
index 000000000..bc770d16c
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/BSD-2-Clause.txt
@@ -0,0 +1,22 @@
+Redistribution and use in source and binary forms, with or without
+modification, are permitted provided that the following conditions are
+met:
+
+1. Redistributions of source code must retain the above copyright
+notice, this list of conditions and the following disclaimer.
+
+2. Redistributions in binary form must reproduce the above copyright
+notice, this list of conditions and the following disclaimer in the
+documentation and/or other materials provided with the distribution.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
+IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
+TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
+PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
+TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
+PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/BSD-3-Clause.txt b/tools/external_crates/license_checker/src/licenses/BSD-3-Clause.txt
new file mode 100644
index 000000000..029e9b70f
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/BSD-3-Clause.txt
@@ -0,0 +1,24 @@
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+1. Redistributions of source code must retain the above copyright notice, this
+   list of conditions and the following disclaimer.
+
+2. Redistributions in binary form must reproduce the above copyright notice,
+   this list of conditions and the following disclaimer in the documentation
+   and/or other materials provided with the distribution.
+
+3. Neither the name of the copyright holder nor the names of its contributors
+   may be used to endorse or promote products derived from this software without
+   specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/ISC.txt b/tools/external_crates/license_checker/src/licenses/ISC.txt
new file mode 100644
index 000000000..c6c2f5e22
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/ISC.txt
@@ -0,0 +1,11 @@
+Permission to use, copy, modify, and /or distribute this software for
+any purpose with or without fee is hereby granted, provided that the
+above copyright notice and this permission notice appear in all copies.
+
+THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/MIT.txt b/tools/external_crates/license_checker/src/licenses/MIT.txt
new file mode 100644
index 000000000..7215f6950
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/MIT.txt
@@ -0,0 +1,17 @@
+Permission is hereby granted, free of charge, to any person obtaining a copy
+of this software and associated documentation files (the "Software"), to deal
+in the Software without restriction, including without limitation the rights
+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies of the Software, and to permit persons to whom the Software is
+furnished to do so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in all
+copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+SOFTWARE.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/MPL-2.0.txt b/tools/external_crates/license_checker/src/licenses/MPL-2.0.txt
new file mode 100644
index 000000000..6e67a7534
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/MPL-2.0.txt
@@ -0,0 +1,131 @@
+1.1. "Contributor" means each individual or legal entity that creates, contributes to the creation of, or owns Covered Software.
+1.2. "Contributor Version" means the combination of the Contributions of others (if any) used by a Contributor and that particular Contributor's Contribution.
+1.3. "Contribution" means Covered Software of a particular Contributor.
+1.4. "Covered Software" means Source Code Form to which the initial Contributor has attached the notice in Exhibit A, the Executable Form of such Source Code Form, and Modifications of such Source Code Form, in each case including portions thereof.
+1.5. "Incompatible With Secondary Licenses" means
+(a) that the initial Contributor has attached the notice described in Exhibit B to the Covered Software; or
+(b) that the Covered Software was made available under the terms of version 1.1 or earlier of the License, but not also under the terms of a Secondary License.
+1.6. "Executable Form" means any form of the work other than Source Code Form.
+1.7. "Larger Work" means a work that combines Covered Software with other material, in a separate file or files, that is not Covered Software.
+1.8. "License" means this document.
+1.9. "Licensable" means having the right to grant, to the maximum extent possible, whether at the time of the initial grant or subsequently, any and all of the rights conveyed by this License.
+1.10. "Modifications" means any of the following:
+(a) any file in Source Code Form that results from an addition to, deletion from, or modification of the contents of Covered Software; or
+(b) any new file in Source Code Form that contains any Covered Software.
+1.11. "Patent Claims" of a Contributor means any patent claim(s), including without limitation, method, process, and apparatus claims, in any patent Licensable by such Contributor that would be infringed, but for the grant of the License, by the making, using, selling, offering for sale, having made, import, or transfer of either its Contributions or its Contributor Version.
+1.12. "Secondary License" means either the GNU General Public License, Version 2.0, the GNU Lesser General Public License, Version 2.1, the GNU Affero General Public License, Version 3.0, or any later versions of those licenses.
+1.13. "Source Code Form" means the form of the work preferred for making modifications.
+1.14. "You" (or "Your") means an individual or a legal entity exercising rights under this License. For legal entities, "You" includes any entity that controls, is controlled by, or is under common control with You. For purposes of this definition, "control" means (a) the power, direct or indirect, to cause the direction or management of such entity, whether by contract or otherwise, or (b) ownership of more than fifty percent (50%) of the outstanding shares or beneficial ownership of such entity.
+2. License Grants and Conditions
+
+--------------------------------
+
+2.1. Grants
+Each Contributor hereby grants You a world-wide, royalty-free, non-exclusive license:
+
+(a) under intellectual property rights (other than patent or trademark) Licensable by such Contributor to use, reproduce, make available, modify, display, perform, distribute, and otherwise exploit its Contributions, either on an unmodified basis, with Modifications, or as part of a Larger Work; and
+(b) under Patent Claims of such Contributor to make, use, sell, offer for sale, have made, import, and otherwise transfer either its Contributions or its Contributor Version.
+2.2. Effective Date
+The licenses granted in Section 2.1 with respect to any Contribution become effective for each Contribution on the date the Contributor first distributes such Contribution.
+
+2.3. Limitations on Grant Scope
+The licenses granted in this Section 2 are the only rights granted under this License. No additional rights or licenses will be implied from the distribution or licensing of Covered Software under this License. Notwithstanding Section 2.1(b) above, no patent license is granted by a Contributor:
+
+(a) for any code that a Contributor has removed from Covered Software; or
+(b) for infringements caused by: (i) Your and any other third party's modifications of Covered Software, or (ii) the combination of its Contributions with other software (except as part of its Contributor Version); or
+(c) under Patent Claims infringed by Covered Software in the absence of its Contributions.
+This License does not grant any rights in the trademarks, service marks, or logos of any Contributor (except as may be necessary to comply with the notice requirements in Section 3.4).
+
+2.4. Subsequent Licenses
+No Contributor makes additional grants as a result of Your choice to distribute the Covered Software under a subsequent version of this License (see Section 10.2) or under the terms of a Secondary License (if permitted under the terms of Section 3.3).
+
+2.5. Representation
+Each Contributor represents that the Contributor believes its Contributions are its original creation(s) or it has sufficient rights to grant the rights to its Contributions conveyed by this License.
+
+2.6. Fair Use
+This License is not intended to limit any rights You have under applicable copyright doctrines of fair use, fair dealing, or other equivalents.
+
+2.7. Conditions
+Sections 3.1, 3.2, 3.3, and 3.4 are conditions of the licenses granted in Section 2.1.
+
+3. Responsibilities
+
+-------------------
+
+3.1. Distribution of Source Form
+All distribution of Covered Software in Source Code Form, including any Modifications that You create or to which You contribute, must be under the terms of this License. You must inform recipients that the Source Code Form of the Covered Software is governed by the terms of this License, and how they can obtain a copy of this License. You may not attempt to alter or restrict the recipients' rights in the Source Code Form.
+
+3.2. Distribution of Executable Form
+If You distribute Covered Software in Executable Form then:
+
+(a) such Covered Software must also be made available in Source Code Form, as described in Section 3.1, and You must inform recipients of the Executable Form how they can obtain a copy of such Source Code Form by reasonable means in a timely manner, at a charge no more than the cost of distribution to the recipient; and
+(b) You may distribute such Executable Form under the terms of this License, or sublicense it under different terms, provided that the license for the Executable Form does not attempt to limit or alter the recipients' rights in the Source Code Form under this License.
+3.3. Distribution of a Larger Work
+You may create and distribute a Larger Work under terms of Your choice, provided that You also comply with the requirements of this License for the Covered Software. If the Larger Work is a combination of Covered Software with a work governed by one or more Secondary Licenses, and the Covered Software is not Incompatible With Secondary Licenses, this License permits You to additionally distribute such Covered Software under the terms of such Secondary License(s), so that the recipient of the Larger Work may, at their option, further distribute the Covered Software under the terms of either this License or such Secondary License(s).
+
+3.4. Notices
+You may not remove or alter the substance of any license notices (including copyright notices, patent notices, disclaimers of warranty, or limitations of liability) contained within the Source Code Form of the Covered Software, except that You may alter any license notices to the extent required to remedy known factual inaccuracies.
+
+3.5. Application of Additional Terms
+You may choose to offer, and to charge a fee for, warranty, support, indemnity or liability obligations to one or more recipients of Covered Software. However, You may do so only on Your own behalf, and not on behalf of any Contributor. You must make it absolutely clear that any such warranty, support, indemnity, or liability obligation is offered by You alone, and You hereby agree to indemnify every Contributor for any liability incurred by such Contributor as a result of warranty, support, indemnity or liability terms You offer. You may include additional disclaimers of warranty and limitations of liability specific to any jurisdiction.
+
+4. Inability to Comply Due to Statute or Regulation
+
+---------------------------------------------------
+
+If it is impossible for You to comply with any of the terms of this License with respect to some or all of the Covered Software due to statute, judicial order, or regulation then You must: (a) comply with the terms of this License to the maximum extent possible; and (b) describe the limitations and the code they affect. Such description must be placed in a text file included with all distributions of the Covered Software under this License. Except to the extent prohibited by statute or regulation, such description must be sufficiently detailed for a recipient of ordinary skill to be able to understand it.
+
+5. Termination
+
+--------------
+
+5.1. The rights granted under this License will terminate automatically if You fail to comply with any of its terms. However, if You become compliant, then the rights granted under this License from a particular Contributor are reinstated (a) provisionally, unless and until such Contributor explicitly and finally terminates Your grants, and (b) on an ongoing basis, if such Contributor fails to notify You of the non-compliance by some reasonable means prior to 60 days after You have come back into compliance. Moreover, Your grants from a particular Contributor are reinstated on an ongoing basis if such Contributor notifies You of the non-compliance by some reasonable means, this is the first time You have received notice of non-compliance with this License from such Contributor, and You become compliant prior to 30 days after Your receipt of the notice.
+5.2. If You initiate litigation against any entity by asserting a patent infringement claim (excluding declaratory judgment actions, counter-claims, and cross-claims) alleging that a Contributor Version directly or indirectly infringes any patent, then the rights granted to You by any and all Contributors for the Covered Software under Section 2.1 of this License shall terminate.
+5.3. In the event of termination under Sections 5.1 or 5.2 above, all end user license agreements (excluding distributors and resellers) which have been validly granted by You or Your distributors under this License prior to termination shall survive termination.
+************************************************************************
+
+6. Disclaimer of Warranty
+
+* ------------------------- *
+
+Covered Software is provided under this License on an "as is" basis, without warranty of any kind, either expressed, implied, or statutory, including, without limitation, warranties that the Covered Software is free of defects, merchantable, fit for a particular purpose or non-infringing. The entire risk as to the quality and performance of the Covered Software is with You. Should any Covered Software prove defective in any respect, You (not any Contributor) assume the cost of any necessary servicing, repair, or correction. This disclaimer of warranty constitutes an essential part of this License. No use of any Covered Software is authorized under this License except under this disclaimer.
+
+************************************************************************
+
+************************************************************************
+
+7. Limitation of Liability
+
+* -------------------------- *
+
+Under no circumstances and under no legal theory, whether tort (including negligence), contract, or otherwise, shall any Contributor, or anyone who distributes Covered Software as permitted above, be liable to You for any direct, indirect, special, incidental, or consequential damages of any character including, without limitation, damages for lost profits, loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses, even if such party shall have been informed of the possibility of such damages. This limitation of liability shall not apply to liability for death or personal injury resulting from such party's negligence to the extent applicable law prohibits such limitation. Some jurisdictions do not allow the exclusion or limitation of incidental or consequential damages, so this exclusion and limitation may not apply to You.
+
+************************************************************************
+
+8. Litigation
+
+-------------
+
+Any litigation relating to this License may be brought only in the courts of a jurisdiction where the defendant maintains its principal place of business and such litigation shall be governed by laws of that jurisdiction, without reference to its conflict-of-law provisions. Nothing in this Section shall prevent a party's ability to bring cross-claims or counter-claims.
+
+9. Miscellaneous
+
+----------------
+
+This License represents the complete agreement concerning the subject matter hereof. If any provision of this License is held to be unenforceable, such provision shall be reformed only to the extent necessary to make it enforceable. Any law or regulation which provides that the language of a contract shall be construed against the drafter shall not be used to construe this License against a Contributor.
+
+10. Versions of the License
+
+---------------------------
+
+10.1. New Versions
+Mozilla Foundation is the license steward. Except as provided in Section 10.3, no one other than the license steward has the right to modify or publish new versions of this License. Each version will be given a distinguishing version number.
+
+10.2. Effect of New Versions
+You may distribute the Covered Software under the terms of the version of the License under which You originally received the Covered Software, or under the terms of any subsequent version published by the license steward.
+
+10.3. Modified Versions
+If you create software not governed by this License, and you want to create a new license for such software, you may create and use a modified version of this License if you rename the license and remove any references to the name of the license steward (except to note that such modified license differs from this License).
+
+10.4. Distributing Source Code Form that is Incompatible With Secondary Licenses
+If You choose to distribute Source Code Form that is Incompatible With Secondary Licenses under the terms of this version of the License, the notice described in Exhibit B of this License must be attached.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/licenses/Unlicense.txt b/tools/external_crates/license_checker/src/licenses/Unlicense.txt
new file mode 100644
index 000000000..b136eb397
--- /dev/null
+++ b/tools/external_crates/license_checker/src/licenses/Unlicense.txt
@@ -0,0 +1,23 @@
+This is free and unencumbered software released into the public domain.
+
+Anyone is free to copy, modify, publish, use, compile, sell, or distribute
+this software, either in source code form or as a compiled binary, for any
+purpose, commercial or non-commercial, and by any means.
+
+In jurisdictions that recognize copyright laws, the author or authors of this
+software dedicate any and all copyright interest in the software to the public
+domain. We make this dedication for the benefit of the public at large and to
+the detriment of our heirs and
+
+successors. We intend this dedication to be an overt act of relinquishment in
+perpetuity of all present and future rights to this software under copyright
+law.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+For more information, please refer to <http://unlicense.org/>
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/testdata/BSD-3-Clause-bindgen.txt b/tools/external_crates/license_checker/src/testdata/BSD-3-Clause-bindgen.txt
new file mode 100644
index 000000000..e693cc7b3
--- /dev/null
+++ b/tools/external_crates/license_checker/src/testdata/BSD-3-Clause-bindgen.txt
@@ -0,0 +1,29 @@
+BSD 3-Clause License
+
+Copyright (c) 2013, Jyun-Yan You
+All rights reserved.
+
+Redistribution and use in source and binary forms, with or without
+modification, are permitted provided that the following conditions are met:
+
+* Redistributions of source code must retain the above copyright notice, this
+  list of conditions and the following disclaimer.
+
+* Redistributions in binary form must reproduce the above copyright notice,
+  this list of conditions and the following disclaimer in the documentation
+  and/or other materials provided with the distribution.
+
+* Neither the name of the copyright holder nor the names of its
+  contributors may be used to endorse or promote products derived from
+  this software without specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
+AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
+FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
+SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
+CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
+OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
\ No newline at end of file
diff --git a/tools/external_crates/license_checker/src/testdata/LICENSE-MIT-aarch64-paging.txt b/tools/external_crates/license_checker/src/testdata/LICENSE-MIT-aarch64-paging.txt
new file mode 100644
index 000000000..15d014372
--- /dev/null
+++ b/tools/external_crates/license_checker/src/testdata/LICENSE-MIT-aarch64-paging.txt
@@ -0,0 +1,21 @@
+MIT License
+
+Copyright (c) 2022 The aarch64-paging Authors.
+
+Permission is hereby granted, free of charge, to any person obtaining a copy
+of this software and associated documentation files (the "Software"), to deal
+in the Software without restriction, including without limitation the rights
+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies of the Software, and to permit persons to whom the Software is
+furnished to do so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in all
+copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+SOFTWARE.
\ No newline at end of file
diff --git a/tools/external_crates/name_and_version/.gitignore b/tools/external_crates/name_and_version/.gitignore
new file mode 100644
index 000000000..869df07da
--- /dev/null
+++ b/tools/external_crates/name_and_version/.gitignore
@@ -0,0 +1,2 @@
+/target
+Cargo.lock
\ No newline at end of file
diff --git a/tools/external_crates/name_and_version/Android.bp b/tools/external_crates/name_and_version/Android.bp
new file mode 100644
index 000000000..45aeafe9a
--- /dev/null
+++ b/tools/external_crates/name_and_version/Android.bp
@@ -0,0 +1,42 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file after the first "rust_*" or "genrule" module
+// because the changes will be overridden on upgrade.
+// Content before the first "rust_*" or "genrule" module is preserved.
+
+package {
+    default_team: "trendy_team_android_rust",
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+rust_library_host {
+    name: "libname_and_version",
+    crate_name: "name_and_version",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    edition: "2021",
+    rustlibs: [
+        "libitertools",
+        "libsemver",
+        "libthiserror",
+    ],
+}
+
+rust_test_host {
+    name: "name_and_version_test_src_lib",
+    crate_name: "name_and_version",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    test_suites: ["general-tests"],
+    auto_gen_config: true,
+    test_options: {
+        unit_test: true,
+    },
+    edition: "2021",
+    rustlibs: [
+        "libitertools",
+        "libsemver",
+        "libthiserror",
+    ],
+}
diff --git a/tools/external_crates/name_and_version/Cargo.toml b/tools/external_crates/name_and_version/Cargo.toml
new file mode 100644
index 000000000..a96cbdec2
--- /dev/null
+++ b/tools/external_crates/name_and_version/Cargo.toml
@@ -0,0 +1,9 @@
+[package]
+name = "name_and_version"
+version = "0.1.0"
+edition = "2021"
+
+[dependencies]
+itertools = "0.13"
+semver = "1"
+thiserror = "1"
diff --git a/tools/external_crates/name_and_version/src/lib.rs b/tools/external_crates/name_and_version/src/lib.rs
new file mode 100644
index 000000000..d4cf7bb27
--- /dev/null
+++ b/tools/external_crates/name_and_version/src/lib.rs
@@ -0,0 +1,40 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! A name and version data structure that can be used as map key.
+
+use semver::Version;
+use thiserror::Error;
+
+pub use self::name_and_version::{
+    IsUpgradableTo, NameAndVersion, NameAndVersionRef, NamedAndVersioned,
+};
+mod name_and_version;
+
+pub use self::name_and_version_map::{
+    crates_with_multiple_versions, crates_with_single_version, most_recent_version,
+    NameAndVersionMap,
+};
+mod name_and_version_map;
+
+#[allow(missing_docs)]
+#[derive(Error, Debug)]
+pub enum Error {
+    #[error("Duplicate crate version: {0} {1}")]
+    DuplicateVersion(String, Version),
+    #[error("Version parse error")]
+    VersionParseError(#[from] semver::Error),
+    #[error("Unknown error")]
+    Unknown,
+}
diff --git a/tools/external_crates/crate_health/src/name_and_version.rs b/tools/external_crates/name_and_version/src/name_and_version.rs
similarity index 84%
rename from tools/external_crates/crate_health/src/name_and_version.rs
rename to tools/external_crates/name_and_version/src/name_and_version.rs
index 90dc24319..9327f9f93 100644
--- a/tools/external_crates/crate_health/src/name_and_version.rs
+++ b/tools/external_crates/name_and_version/src/name_and_version.rs
@@ -12,32 +12,38 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
+//! Data structures for representing a crate name and version, which can be
+//! used as a map key.
+
 use std::{
     borrow::Borrow,
     cmp::Ordering,
     hash::{Hash, Hasher},
 };
 
-#[cfg(test)]
-use anyhow::Result;
-
 use semver::{BuildMetadata, Prerelease, Version, VersionReq};
 
 static MIN_VERSION: Version =
     Version { major: 0, minor: 0, patch: 0, pre: Prerelease::EMPTY, build: BuildMetadata::EMPTY };
 
+/// A name and version pair trait.
 pub trait NamedAndVersioned {
+    /// Returns the name.
     fn name(&self) -> &str;
+    /// Returns the version.
     fn version(&self) -> &Version;
-    fn key<'a>(&'a self) -> NameAndVersionRef<'a>;
+    /// Returns a reference that can be used as a map key.
+    fn key(&self) -> NameAndVersionRef;
 }
 
+/// An owned namd and version.
 #[derive(Debug, PartialOrd, Ord, PartialEq, Eq, Hash, Clone)]
 pub struct NameAndVersion {
     name: String,
     version: Version,
 }
 
+/// A reference to a name and version.
 #[derive(Copy, Clone, Debug, PartialOrd, Ord, PartialEq, Eq, Hash)]
 pub struct NameAndVersionRef<'a> {
     name: &'a str,
@@ -45,17 +51,20 @@ pub struct NameAndVersionRef<'a> {
 }
 
 impl NameAndVersion {
+    /// Constructor that takes ownership of args.
     pub fn new(name: String, version: Version) -> Self {
         NameAndVersion { name, version }
     }
+    /// Constructor that clones a reference.
     pub fn from(nv: &impl NamedAndVersioned) -> Self {
         NameAndVersion { name: nv.name().to_string(), version: nv.version().clone() }
     }
+    /// The lowest possible version, used to find the first key in a map with this name.
     pub fn min_version(name: String) -> Self {
         NameAndVersion { name, version: MIN_VERSION.clone() }
     }
-    #[cfg(test)]
-    pub fn try_from_str(name: &str, version: &str) -> Result<Self> {
+    /// Intended for testing.
+    pub fn try_from_str(name: &str, version: &str) -> Result<Self, semver::Error> {
         Ok(NameAndVersion::new(name.to_string(), Version::parse(version)?))
     }
 }
@@ -68,11 +77,12 @@ impl NamedAndVersioned for NameAndVersion {
     fn version(&self) -> &Version {
         &self.version
     }
-    fn key<'k>(&'k self) -> NameAndVersionRef<'k> {
+    fn key(&self) -> NameAndVersionRef {
         NameAndVersionRef::new(self.name(), self.version())
     }
 }
 
+#[allow(missing_docs)]
 impl<'a> NameAndVersionRef<'a> {
     pub fn new(name: &'a str, version: &'a Version) -> Self {
         NameAndVersionRef { name, version }
@@ -86,7 +96,7 @@ impl<'a> NamedAndVersioned for NameAndVersionRef<'a> {
     fn version(&self) -> &Version {
         self.version
     }
-    fn key<'k>(&'k self) -> NameAndVersionRef<'k> {
+    fn key(&self) -> NameAndVersionRef {
         *self
     }
 }
@@ -107,7 +117,7 @@ impl<'a> Eq for (dyn NamedAndVersioned + 'a) {}
 
 impl<'a> PartialOrd for (dyn NamedAndVersioned + 'a) {
     fn partial_cmp(&self, other: &Self) -> Option<Ordering> {
-        self.key().partial_cmp(&other.key())
+        Some(self.cmp(other))
     }
 }
 
@@ -123,7 +133,9 @@ impl<'a> Hash for (dyn NamedAndVersioned + 'a) {
     }
 }
 
+/// A trait for determining semver compatibility.
 pub trait IsUpgradableTo: NamedAndVersioned {
+    /// Returns true if the object version is semver-compatible with 'other'.
     fn is_upgradable_to(&self, other: &impl NamedAndVersioned) -> bool {
         self.name() == other.name()
             && VersionReq::parse(&self.version().to_string())
@@ -131,16 +143,15 @@ pub trait IsUpgradableTo: NamedAndVersioned {
     }
 }
 
-impl<'a> IsUpgradableTo for NameAndVersion {}
+impl IsUpgradableTo for NameAndVersion {}
 impl<'a> IsUpgradableTo for NameAndVersionRef<'a> {}
 
 #[cfg(test)]
 mod tests {
     use super::*;
-    use anyhow::Result;
 
     #[test]
-    fn test_name_version_ref() -> Result<()> {
+    fn test_name_version_ref() -> Result<(), semver::Error> {
         let version = Version::parse("2.3.4")?;
         let compat1 = Version::parse("2.3.5")?;
         let compat2 = Version::parse("2.4.0")?;
@@ -164,7 +175,7 @@ mod tests {
     }
 
     #[test]
-    fn test_name_and_version() -> Result<()> {
+    fn test_name_and_version() -> Result<(), semver::Error> {
         let version = Version::parse("2.3.4")?;
         let compat1 = Version::parse("2.3.5")?;
         let compat2 = Version::parse("2.4.0")?;
diff --git a/tools/external_crates/crate_health/src/name_and_version_map.rs b/tools/external_crates/name_and_version/src/name_and_version_map.rs
similarity index 79%
rename from tools/external_crates/crate_health/src/name_and_version_map.rs
rename to tools/external_crates/name_and_version/src/name_and_version_map.rs
index f35d40415..bfca3ac28 100644
--- a/tools/external_crates/crate_health/src/name_and_version_map.rs
+++ b/tools/external_crates/name_and_version/src/name_and_version_map.rs
@@ -12,33 +12,44 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
+//! A mapping from crate names and versions to some associated data.
+
 use std::collections::{BTreeMap, HashSet};
 
-use anyhow::Result;
 use itertools::Itertools;
 use semver::Version;
 
-use crate::{CrateError, IsUpgradableTo, NameAndVersion, NamedAndVersioned};
+use crate::{Error, IsUpgradableTo, NameAndVersion, NamedAndVersioned};
 
+/// A mapping from crate names and versions to some associated data.
 pub trait NameAndVersionMap {
+    /// The data associated with each crate name and version.
     type Value;
 
+    /// Returns a reference to the map field.
     fn map_field(&self) -> &BTreeMap<NameAndVersion, Self::Value>;
+    /// Returns a mutable reference to the map field.
     fn map_field_mut(&mut self) -> &mut BTreeMap<NameAndVersion, Self::Value>;
-
-    fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), CrateError>;
+    /// Tries to insert a new key and value, returning an error if the key is already present.
+    fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), Error>;
+    /// Returns the number of crates. Multiple versions of a crate count multiple times.
     fn num_crates(&self) -> usize;
+    /// Returns true if the map contains a crate with the specified name.
     fn contains_name(&self, name: &str) -> bool {
         self.get_versions(name).next().is_some()
     }
+    /// Returns an iterator over versions of a specified crate
     fn get_versions<'a, 'b>(
         &'a self,
         name: &'b str,
     ) -> Box<dyn Iterator<Item = (&'a NameAndVersion, &'a Self::Value)> + 'a>;
+    /// Returns a mutable iterator over versions of a specified crate
     fn get_versions_mut<'a, 'b>(
         &'a mut self,
         name: &'b str,
     ) -> Box<dyn Iterator<Item = (&'a NameAndVersion, &'a mut Self::Value)> + 'a>;
+    /// Get the highest version in the map that is semver-compatible with
+    /// a given crate and version.
     fn get_version_upgradable_from<T: NamedAndVersioned + IsUpgradableTo>(
         &self,
         other: &T,
@@ -51,6 +62,8 @@ pub trait NameAndVersionMap {
         }
         best_version
     }
+    /// Returns an iterator over the map, filtered according to a predicate that acts on
+    /// all the available versions for a crate.
     fn filter_versions<
         'a: 'b,
         'b,
@@ -73,12 +86,15 @@ impl<ValueType> NameAndVersionMap for BTreeMap<NameAndVersion, ValueType> {
         self
     }
 
-    fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), CrateError> {
-        if self.contains_key(&key) {
-            Err(CrateError::DuplicateCrateVersion(key.name().to_string(), key.version().clone()))
-        } else {
-            self.insert(key, val);
-            Ok(())
+    fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), Error> {
+        match self.entry(key) {
+            std::collections::btree_map::Entry::Vacant(e) => {
+                e.insert(val);
+                Ok(())
+            }
+            std::collections::btree_map::Entry::Occupied(e) => {
+                Err(Error::DuplicateVersion(e.key().name().to_string(), e.key().version().clone()))
+            }
         }
     }
 
@@ -126,7 +142,7 @@ impl<ValueType> NameAndVersionMap for BTreeMap<NameAndVersion, ValueType> {
         f: F,
     ) -> Box<dyn Iterator<Item = (&'a NameAndVersion, &'a Self::Value)> + 'a> {
         let mut kept_keys: HashSet<NameAndVersion> = HashSet::new();
-        for (key, mut group) in self.iter().group_by(|item| item.0.name()).into_iter() {
+        for (key, mut group) in self.iter().chunk_by(|item| item.0.name()).into_iter() {
             kept_keys.extend(
                 f(&mut group).into_iter().map(move |v| NameAndVersion::new(key.to_string(), v)),
             );
@@ -135,6 +151,7 @@ impl<ValueType> NameAndVersionMap for BTreeMap<NameAndVersion, ValueType> {
     }
 }
 
+/// Select crates with a single version from an iterator.
 pub fn crates_with_single_version<'a, ValueType>(
     versions: &mut dyn Iterator<Item = (&'a NameAndVersion, &'a ValueType)>,
 ) -> HashSet<Version> {
@@ -146,6 +163,7 @@ pub fn crates_with_single_version<'a, ValueType>(
     vset
 }
 
+/// Select crates with multiple versions from an iterator.
 pub fn crates_with_multiple_versions<'a, ValueType>(
     versions: &mut dyn Iterator<Item = (&'a NameAndVersion, &'a ValueType)>,
 ) -> HashSet<Version> {
@@ -157,6 +175,7 @@ pub fn crates_with_multiple_versions<'a, ValueType>(
     vset
 }
 
+/// Select the most recent version of each crate from an iterator.
 pub fn most_recent_version<'a, ValueType>(
     versions: &mut dyn Iterator<Item = (&'a NameAndVersion, &'a ValueType)>,
 ) -> HashSet<Version> {
@@ -167,41 +186,37 @@ pub fn most_recent_version<'a, ValueType>(
     vset
 }
 
-#[cfg(test)]
-pub fn try_name_version_map_from_iter<'a, ValueType>(
-    nvs: impl IntoIterator<Item = (&'a str, &'a str, ValueType)>,
-) -> Result<BTreeMap<NameAndVersion, ValueType>> {
-    let mut test_map = BTreeMap::new();
-    for (name, version, val) in nvs {
-        test_map.insert_or_error(NameAndVersion::try_from_str(name, version)?, val)?;
-    }
-    Ok(test_map)
-}
-
 #[cfg(test)]
 mod tests {
     use crate::{NameAndVersion, NameAndVersionRef};
 
     use super::*;
-    use anyhow::Result;
     use itertools::assert_equal;
 
+    fn try_name_version_map_from_iter<'a, ValueType>(
+        nvs: impl IntoIterator<Item = (&'a str, &'a str, ValueType)>,
+    ) -> Result<BTreeMap<NameAndVersion, ValueType>, Error> {
+        let mut test_map = BTreeMap::new();
+        for (name, version, val) in nvs {
+            test_map.insert_or_error(NameAndVersion::try_from_str(name, version)?, val)?;
+        }
+        Ok(test_map)
+    }
+
     #[test]
-    fn test_name_and_version_map_empty() -> Result<()> {
+    fn test_name_and_version_map_empty() -> Result<(), Error> {
         let mut test_map: BTreeMap<NameAndVersion, String> = BTreeMap::new();
         let v = Version::parse("1.2.3")?;
         let nvp = NameAndVersionRef::new("foo", &v);
-        // let nvp = NameAndVersion::try_from_str("foo", "1.2.3")?;
         assert_eq!(test_map.num_crates(), 0);
         assert!(!test_map.contains_key(&nvp as &dyn NamedAndVersioned));
         assert!(!test_map.contains_name("foo"));
-        assert!(test_map.get(&nvp as &dyn NamedAndVersioned).is_none());
         assert!(test_map.get_mut(&nvp as &dyn NamedAndVersioned).is_none());
         Ok(())
     }
 
     #[test]
-    fn test_name_and_version_map_nonempty() -> Result<()> {
+    fn test_name_and_version_map_nonempty() -> Result<(), Error> {
         let mut test_map = try_name_version_map_from_iter([
             ("foo", "1.2.3", "foo v1".to_string()),
             ("foo", "2.3.4", "foo v2".to_string()),
@@ -229,8 +244,8 @@ mod tests {
         assert_eq!(test_map.get(&foo1), Some(&"foo v1".to_string()));
         assert_eq!(test_map.get(&foo2), Some(&"foo v2".to_string()));
         assert_eq!(test_map.get(&bar), Some(&"bar".to_string()));
-        assert!(test_map.get(&wrong_name).is_none());
-        assert!(test_map.get(&wrong_version).is_none());
+        assert!(!test_map.contains_key(&wrong_name));
+        assert!(!test_map.contains_key(&wrong_version));
 
         assert_eq!(test_map.get_mut(&foo1), Some(&mut "foo v1".to_string()));
         assert_eq!(test_map.get_mut(&foo2), Some(&mut "foo v2".to_string()));
@@ -261,7 +276,7 @@ mod tests {
     }
 
     #[test]
-    fn test_filter_versions() -> Result<()> {
+    fn test_filter_versions() -> Result<(), Error> {
         let test_map = try_name_version_map_from_iter([
             ("foo", "1.2.3", ()),
             ("foo", "2.3.4", ()),
diff --git a/tools/external_crates/name_and_version_proc_macros/Android.bp b/tools/external_crates/name_and_version_proc_macros/Android.bp
new file mode 100644
index 000000000..aadadaebd
--- /dev/null
+++ b/tools/external_crates/name_and_version_proc_macros/Android.bp
@@ -0,0 +1,23 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file after the first "rust_*" or "genrule" module
+// because the changes will be overridden on upgrade.
+// Content before the first "rust_*" or "genrule" module is preserved.
+
+package {
+    default_team: "trendy_team_android_rust",
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+rust_proc_macro {
+    name: "libname_and_version_proc_macros",
+    crate_name: "name_and_version_proc_macros",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    edition: "2021",
+    rustlibs: [
+        "libproc_macro2",
+        "libquote",
+        "libsyn",
+    ],
+}
diff --git a/tools/external_crates/crate_health_proc_macros/Cargo.toml b/tools/external_crates/name_and_version_proc_macros/Cargo.toml
similarity index 77%
rename from tools/external_crates/crate_health_proc_macros/Cargo.toml
rename to tools/external_crates/name_and_version_proc_macros/Cargo.toml
index a62e929d6..1f728362b 100644
--- a/tools/external_crates/crate_health_proc_macros/Cargo.toml
+++ b/tools/external_crates/name_and_version_proc_macros/Cargo.toml
@@ -1,5 +1,5 @@
 [package]
-name = "crate_health_proc_macros"
+name = "name_and_version_proc_macros"
 version = "0.1.0"
 edition = "2021"
 
diff --git a/tools/external_crates/crate_health_proc_macros/src/lib.rs b/tools/external_crates/name_and_version_proc_macros/src/lib.rs
similarity index 88%
rename from tools/external_crates/crate_health_proc_macros/src/lib.rs
rename to tools/external_crates/name_and_version_proc_macros/src/lib.rs
index a53dd5d65..832b2c187 100644
--- a/tools/external_crates/crate_health_proc_macros/src/lib.rs
+++ b/tools/external_crates/name_and_version_proc_macros/src/lib.rs
@@ -12,8 +12,11 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
+//! Derive the NameAndVersionMap trait for a struct with a suitable map field.
+
 use syn::{parse_macro_input, DeriveInput, Error};
 
+/// Derive the NameAndVersionMap trait for a struct with a suitable map field.
 #[proc_macro_derive(NameAndVersionMap)]
 pub fn derive_name_and_version_map(input: proc_macro::TokenStream) -> proc_macro::TokenStream {
     let input = parse_macro_input!(input as DeriveInput);
@@ -51,7 +54,7 @@ mod name_and_version_map {
                     self.#mapfield_name.map_field_mut()
                 }
 
-                fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), CrateError> {
+                fn insert_or_error(&mut self, key: NameAndVersion, val: Self::Value) -> Result<(), name_and_version::Error> {
                     self.#mapfield_name.insert_or_error(key, val)
                 }
 
@@ -77,7 +80,7 @@ mod name_and_version_map {
             }
         };
 
-        Ok(TokenStream::from(expanded))
+        Ok(expanded)
     }
 
     fn get_struct(input: &DeriveInput) -> Result<&DataStruct> {
@@ -89,17 +92,14 @@ mod name_and_version_map {
 
     fn get_map_field(strukt: &DataStruct) -> Result<&Field> {
         for field in &strukt.fields {
-            if let Ok((key_type, _value_type)) = get_map_type(&field.ty) {
-                if let syn::Type::Path(path) = &key_type {
-                    if path.path.segments.len() == 1
-                        && path.path.segments[0].ident == "NameAndVersion"
-                    {
-                        return Ok(field);
-                    }
+            if let Ok((syn::Type::Path(path), _value_type)) = get_map_type(&field.ty) {
+                if path.path.segments.len() == 1 && path.path.segments[0].ident == "NameAndVersion"
+                {
+                    return Ok(field);
                 }
             }
         }
-        return Err(Error::new_spanned(strukt.struct_token, "No field of type NameAndVersionMap"));
+        Err(Error::new_spanned(strukt.struct_token, "No field of type NameAndVersionMap"))
     }
 
     fn get_map_type(typ: &Type) -> Result<(&Type, &Type)> {
diff --git a/tools/external_crates/rooted_path/Android.bp b/tools/external_crates/rooted_path/Android.bp
new file mode 100644
index 000000000..edabe84d4
--- /dev/null
+++ b/tools/external_crates/rooted_path/Android.bp
@@ -0,0 +1,34 @@
+// This file is generated by cargo_embargo.
+// Do not modify this file after the first "rust_*" or "genrule" module
+// because the changes will be overridden on upgrade.
+// Content before the first "rust_*" or "genrule" module is preserved.
+
+package {
+    default_team: "trendy_team_android_rust",
+    default_applicable_licenses: ["Android-Apache-2.0"],
+}
+
+rust_library_host {
+    name: "librooted_path",
+    crate_name: "rooted_path",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    edition: "2021",
+    rustlibs: ["libthiserror"],
+}
+
+rust_test_host {
+    name: "rooted_path_test_src_lib",
+    crate_name: "rooted_path",
+    cargo_env_compat: true,
+    cargo_pkg_version: "0.1.0",
+    crate_root: "src/lib.rs",
+    test_suites: ["general-tests"],
+    auto_gen_config: true,
+    test_options: {
+        unit_test: true,
+    },
+    edition: "2021",
+    rustlibs: ["libthiserror"],
+}
diff --git a/tools/external_crates/rooted_path/Cargo.toml b/tools/external_crates/rooted_path/Cargo.toml
new file mode 100644
index 000000000..fdef05673
--- /dev/null
+++ b/tools/external_crates/rooted_path/Cargo.toml
@@ -0,0 +1,7 @@
+[package]
+name = "rooted_path"
+version = "0.1.0"
+edition = "2021"
+
+[dependencies]
+thiserror = "1.0"
diff --git a/tools/external_crates/rooted_path/src/lib.rs b/tools/external_crates/rooted_path/src/lib.rs
new file mode 100644
index 000000000..7c1748ca4
--- /dev/null
+++ b/tools/external_crates/rooted_path/src/lib.rs
@@ -0,0 +1,136 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+//! A path relative to a root. Useful for paths relative to an Android repo, for example.
+
+use core::fmt::Display;
+use std::path::{Path, PathBuf};
+
+use thiserror::Error;
+
+#[allow(missing_docs)]
+#[derive(Error, Debug)]
+pub enum RootedPathError {
+    #[error("Root path is not absolute: {}", .0.display())]
+    RootNotAbsolute(PathBuf),
+    #[error("Path is not relative: {}", .0.display())]
+    PathNotRelative(PathBuf),
+}
+
+/// A path relative to a root.
+#[derive(Debug, PartialEq, Eq)]
+pub struct RootedPath {
+    root: PathBuf,
+    path: PathBuf,
+}
+
+impl RootedPath {
+    /// Creates a new RootedPath from an absolute root and a path relative to the root.
+    pub fn new<P: Into<PathBuf>>(
+        root: P,
+        path: impl AsRef<Path>,
+    ) -> Result<RootedPath, RootedPathError> {
+        let root: PathBuf = root.into();
+        if !root.is_absolute() {
+            return Err(RootedPathError::RootNotAbsolute(root));
+        }
+        let path = path.as_ref();
+        if !path.is_relative() {
+            return Err(RootedPathError::PathNotRelative(path.to_path_buf()));
+        }
+        let path = root.join(path);
+        Ok(RootedPath { root, path })
+    }
+    /// Returns the root.
+    pub fn root(&self) -> &Path {
+        self.root.as_path()
+    }
+    /// Returns the path relative to the root.
+    pub fn rel(&self) -> &Path {
+        self.path.strip_prefix(&self.root).unwrap()
+    }
+    /// Returns the absolute path.
+    pub fn abs(&self) -> &Path {
+        self.path.as_path()
+    }
+    /// Creates a new RootedPath with path adjoined to self.
+    pub fn join(&self, path: impl AsRef<Path>) -> Result<RootedPath, RootedPathError> {
+        let path = path.as_ref();
+        if !path.is_relative() {
+            return Err(RootedPathError::PathNotRelative(path.to_path_buf()));
+        }
+        Ok(RootedPath { root: self.root.clone(), path: self.path.join(path) })
+    }
+    /// Creates a new RootedPath with the same root but a new relative directory.
+    pub fn with_same_root(&self, path: impl AsRef<Path>) -> Result<RootedPath, RootedPathError> {
+        RootedPath::new(self.root.clone(), path)
+    }
+}
+
+impl Display for RootedPath {
+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
+        write!(f, "{}", self.rel().display())
+    }
+}
+
+impl AsRef<Path> for RootedPath {
+    fn as_ref(&self) -> &Path {
+        self.abs()
+    }
+}
+
+impl From<RootedPath> for PathBuf {
+    fn from(val: RootedPath) -> Self {
+        val.path
+    }
+}
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+
+    #[test]
+    fn test_basic() -> Result<(), RootedPathError> {
+        let p = RootedPath::new("/foo", "bar")?;
+        assert_eq!(p.root(), Path::new("/foo"));
+        assert_eq!(p.rel(), Path::new("bar"));
+        assert_eq!(p.abs(), PathBuf::from("/foo/bar"));
+        assert_eq!(p.join("baz")?, RootedPath::new("/foo", "bar/baz")?);
+        assert_eq!(p.with_same_root("baz")?, RootedPath::new("/foo", "baz")?);
+        Ok(())
+    }
+
+    #[test]
+    fn test_errors() -> Result<(), RootedPathError> {
+        assert!(RootedPath::new("foo", "bar").is_err());
+        assert!(RootedPath::new("/foo", "/bar").is_err());
+        let p = RootedPath::new("/foo", "bar")?;
+        assert!(p.join("/baz").is_err());
+        assert!(p.with_same_root("/baz").is_err());
+        Ok(())
+    }
+
+    #[test]
+    fn test_conversion() -> Result<(), RootedPathError> {
+        let p = RootedPath::new("/foo", "bar")?;
+
+        let path = p.as_ref();
+        assert_eq!(path, Path::new("/foo/bar"));
+
+        let pathbuf: PathBuf = p.into();
+        assert_eq!(pathbuf, Path::new("/foo/bar"));
+
+        Ok(())
+    }
+}
diff --git a/tools/mergetool/remerge3.sh b/tools/mergetool/remerge3.sh
new file mode 100755
index 000000000..ec0fc2bbe
--- /dev/null
+++ b/tools/mergetool/remerge3.sh
@@ -0,0 +1,155 @@
+#!/bin/bash
+
+usage() {
+  cat <<EOF
+Usage:
+  ${0}                  Remerge all files with conflict markers in the git working tree
+  ${0} [FILE...]        Remerge the given files
+
+Options:
+  -t, --tool {bcompare,meld,vimdiff}
+    Use the specified merge tool.
+EOF
+}
+
+# shellcheck disable=SC2155
+readonly BIN_DIR=$(dirname "${BASH_SOURCE[0]}")
+readonly SPLIT3="${BIN_DIR}/split3.awk"
+readonly CONFLICT_MARKER_BEGIN='^<{7}( .+)?$'
+readonly CONFLICT_MARKER_BASE='^\|{7}( .+)?$'
+
+TEMP_FILES=()
+cleanup() {
+  rm -rf "${TEMP_FILES[@]}"
+}
+trap cleanup EXIT
+
+xtrace() {
+  (
+    set -x
+    "${@}"
+  )
+}
+
+mergetool() {
+  local file="${1}"
+  local MERGED="$file"
+  local BASE="${file}:BASE"
+  local LOCAL="${file}:LOCAL"
+  local REMOTE="${file}:REMOTE"
+  TEMP_FILES+=("$BASE" "$LOCAL" "$REMOTE")
+
+  local has_base=false
+  if grep -qE "${CONFLICT_MARKER_BASE}" "$file"; then
+    has_base=true
+  fi
+
+  $has_base && awk -f "$SPLIT3" -v TARGET=BASE <"$file" >"$BASE"
+  awk -f "$SPLIT3" -v TARGET=LOCAL <"$file" >"$LOCAL"
+  awk -f "$SPLIT3" -v TARGET=REMOTE <"$file" >"$REMOTE"
+
+  case "$MERGETOOL" in
+    bc*)
+      if $has_base; then
+        xtrace bcompare "$LOCAL" "$REMOTE" "$BASE" -mergeoutput="$MERGED"
+      else
+        xtrace bcompare "$LOCAL" "$REMOTE" -mergeoutput="$MERGED"
+      fi
+      ;;
+    meld)
+      if $has_base; then
+        xtrace meld "$LOCAL" "$BASE" "$REMOTE" -o "$MERGED"
+      else
+        xtrace meld "$LOCAL" "$MERGED" "$REMOTE"
+      fi
+      ;;
+    vim*)
+      if $has_base; then
+        xtrace vimdiff -c '4wincmd w | wincmd J' "$LOCAL" "$BASE" "$REMOTE" "$MERGED"
+      else
+        xtrace vimdiff -c 'wincmd l' "$LOCAL" "$MERGED" "$REMOTE"
+      fi
+      ;;
+  esac
+}
+
+#
+# BEGIN
+#
+
+MERGETOOL=vimdiff
+if [[ -n "$DISPLAY" ]]; then
+  if command -v bcompare; then
+    MERGETOOL=bcompare
+  elif command -v meld; then
+    MERGETOOL=meld
+  fi
+fi >/dev/null
+
+while [[ "$1" =~ ^- ]]; do
+  arg="${1}"
+  shift
+  case "$arg" in
+    --) break ;;
+    -t | --tool)
+      MERGETOOL="${1}"
+      shift
+      ;;
+    -h | --help | --usage)
+      usage
+      exit 0
+      ;;
+    *)
+      usage
+      exit 1
+      ;;
+  esac
+done
+
+IN_GIT_WORKTREE=false
+if git rev-parse >/dev/null 2>/dev/null; then
+  IN_GIT_WORKTREE=true
+fi
+
+readonly MERGETOOL
+readonly IN_GIT_WORKTREE
+
+FILES_UNFILTERED=()
+if [[ "${#}" -eq 0 ]]; then
+  while IFS= read -r -d '' ARG; do
+    FILES_UNFILTERED+=("$ARG")
+  done < <(git -c grep.fallbackToNoIndex=true grep -zlE "$CONFLICT_MARKER_BEGIN" 2>/dev/null)
+else
+  FILES_UNFILTERED+=("${@}")
+fi
+
+FILES=()
+for file in "${FILES_UNFILTERED[@]}"; do
+  if ! [[ -f "$file" ]] || [[ -L "$file" ]]; then
+    echo "[SKIPPED] ${file}: not a regular file"
+  elif ! grep -qE "$CONFLICT_MARKER_BEGIN" "$file"; then
+    echo "[SKIPPED] ${file}: no conflict markers found"
+  else
+    FILES+=("$file")
+  fi
+done
+
+echo "Found files with conflict markers:"
+printf '    %s\n' "${FILES[@]}"
+
+for file in "${FILES[@]}"; do
+  echo
+  echo "Merging '${file}'"
+  mergetool "$file"
+  exit_code="$?"
+  if [[ "$exit_code" -eq 0 ]]; then
+    if $IN_GIT_WORKTREE && [[ -n "$(git ls-files "$file")" ]]; then
+      xtrace git add "$file"
+    fi
+  else
+    echo "Failed to merge '${file}'"
+  fi
+  read -r -p "Continue merging other files? [Y/n]" -n 1 yn || exit
+  echo
+  [[ "$yn" == [nNqQ] ]] && exit "$exit_code"
+done
diff --git a/tools/mergetool/split3.awk b/tools/mergetool/split3.awk
new file mode 100755
index 000000000..a6c54d757
--- /dev/null
+++ b/tools/mergetool/split3.awk
@@ -0,0 +1,34 @@
+#!/usr/bin/awk -f
+
+# Supports only "simple" diff3 style conflicts. Criss-cross conflicts are not supported.
+
+BEGIN {
+  if (TARGET !~ /^(LOCAL|BASE|REMOTE)$/) {
+    print "Usage: ./split3.awk <file_with_diff3_conflict_markers -v TARGET={LOCAL,BASE,REMOTE}"
+    exit 1
+  }
+
+  PRINT = 1
+}
+
+/^<{7}( .+)?$/ {
+  PRINT = (TARGET == "LOCAL")
+  next
+}
+
+/^\|{7}( .+)?$/ {
+  PRINT = (TARGET == "BASE")
+  next
+}
+
+/^={7}( .+)?$/ {
+  PRINT = (TARGET == "REMOTE")
+  next
+}
+
+/^>{7}( .+)?$/ {
+  PRINT = 1
+  next
+}
+
+PRINT { print }
diff --git a/tools/motion/motion_test_watcher_app/.vscode/settings.json b/tools/motion/motion_test_watcher_app/.vscode/settings.json
index 65a196532..e99a9e909 100644
--- a/tools/motion/motion_test_watcher_app/.vscode/settings.json
+++ b/tools/motion/motion_test_watcher_app/.vscode/settings.json
@@ -1,3 +1,12 @@
 {
-  "editor.defaultFormatter": "esbenp.prettier-vscode"
+  "editor.defaultFormatter": "esbenp.prettier-vscode",
+  "[scss]": {
+    "editor.defaultFormatter": "esbenp.prettier-vscode"
+  },
+  "[html]": {
+    "editor.defaultFormatter": "esbenp.prettier-vscode"
+  },
+  "[typescript]": {
+    "editor.defaultFormatter": "esbenp.prettier-vscode"
+  }
 }
diff --git a/tools/motion/motion_test_watcher_app/angular.json b/tools/motion/motion_test_watcher_app/angular.json
index 63a28a29d..1f9481776 100644
--- a/tools/motion/motion_test_watcher_app/angular.json
+++ b/tools/motion/motion_test_watcher_app/angular.json
@@ -29,7 +29,6 @@
               "src/assets"
             ],
             "styles": [
-              "@angular/material/prebuilt-themes/indigo-pink.css",
               "src/styles.scss"
             ],
             "scripts": []
diff --git a/tools/motion/motion_test_watcher_app/package-lock.json b/tools/motion/motion_test_watcher_app/package-lock.json
index 76ee10d15..a00257016 100644
--- a/tools/motion/motion_test_watcher_app/package-lock.json
+++ b/tools/motion/motion_test_watcher_app/package-lock.json
@@ -8,24 +8,24 @@
       "name": "watch-web-app",
       "version": "0.0.0",
       "dependencies": {
-        "@angular/cdk": "^17.3.5",
-        "@angular/common": "^17.3.0",
-        "@angular/compiler": "^17.3.0",
-        "@angular/core": "^17.3.0",
-        "@angular/forms": "^17.3.0",
-        "@angular/material": "^17.3.5",
-        "@angular/material-experimental": "^17.3.5",
-        "@angular/platform-browser": "^17.3.0",
-        "@angular/platform-browser-dynamic": "^17.3.0",
-        "@angular/router": "^17.3.0",
+        "@angular/cdk": "^18.0.0",
+        "@angular/common": "^18.0.0",
+        "@angular/compiler": "^18.0.0",
+        "@angular/core": "^18.0.0",
+        "@angular/forms": "^18.0.0",
+        "@angular/material": "^18.0.0",
+        "@angular/platform-browser": "^18.0.0",
+        "@angular/platform-browser-dynamic": "^18.0.0",
+        "@angular/router": "^18.0.0",
+        "ng-keyboard-shortcuts": "^13.0.8",
         "rxjs": "~7.8.0",
         "tslib": "^2.3.0",
         "zone.js": "~0.14.3"
       },
       "devDependencies": {
-        "@angular-devkit/build-angular": "^17.3.5",
-        "@angular/cli": "^17.3.5",
-        "@angular/compiler-cli": "^17.3.0",
+        "@angular-devkit/build-angular": "^18.0.1",
+        "@angular/cli": "^18.0.1",
+        "@angular/compiler-cli": "^18.0.0",
         "@types/jasmine": "~5.1.0",
         "jasmine-core": "~5.1.0",
         "karma": "~6.4.0",
@@ -51,112 +51,112 @@
       }
     },
     "node_modules/@angular-devkit/architect": {
-      "version": "0.1703.5",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/architect/-/architect-0.1703.5.tgz",
-      "integrity": "sha512-j3+9QeXIafuRMtk7N5Cmm/IiMSS/TOaybzfCv/LK+DP3hjEd8f8Az7hPmevUuOArvWNzUvoUeu30GmR3wABydA==",
+      "version": "0.1801.1",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/architect/-/architect-0.1801.1.tgz",
+      "integrity": "sha512-7dIQ++D5PTzLgs4sEvi7pMpG4nY4CTnzLKbqKDI++fJKa7FEpVjje1tsr1r8ap8xD0QXr6sIxmQ4hdLeWwPhDQ==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/core": "17.3.5",
+        "@angular-devkit/core": "18.1.1",
         "rxjs": "7.8.1"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       }
     },
     "node_modules/@angular-devkit/build-angular": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/build-angular/-/build-angular-17.3.5.tgz",
-      "integrity": "sha512-Ju2MkMidJglJq/iWgM9CNbhK7A/2n0LNYPZx+ucb+aOFWvurCQrU4Mt/es6xCsxOEs5OPhjqdva8mxE5FHwzTQ==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/build-angular/-/build-angular-18.1.1.tgz",
+      "integrity": "sha512-sd/eOzitC8yN9xl/TbbuDxXL1LRZCX3gwKAddV1fJSrXJHEmDM7PhdQbNEPd2O58evMKSiMZK91WnYN0lhTZtw==",
       "dev": true,
       "dependencies": {
         "@ampproject/remapping": "2.3.0",
-        "@angular-devkit/architect": "0.1703.5",
-        "@angular-devkit/build-webpack": "0.1703.5",
-        "@angular-devkit/core": "17.3.5",
-        "@babel/core": "7.24.0",
-        "@babel/generator": "7.23.6",
-        "@babel/helper-annotate-as-pure": "7.22.5",
-        "@babel/helper-split-export-declaration": "7.22.6",
-        "@babel/plugin-transform-async-generator-functions": "7.23.9",
-        "@babel/plugin-transform-async-to-generator": "7.23.3",
-        "@babel/plugin-transform-runtime": "7.24.0",
-        "@babel/preset-env": "7.24.0",
-        "@babel/runtime": "7.24.0",
+        "@angular-devkit/architect": "0.1801.1",
+        "@angular-devkit/build-webpack": "0.1801.1",
+        "@angular-devkit/core": "18.1.1",
+        "@angular/build": "18.1.1",
+        "@babel/core": "7.24.7",
+        "@babel/generator": "7.24.7",
+        "@babel/helper-annotate-as-pure": "7.24.7",
+        "@babel/helper-split-export-declaration": "7.24.7",
+        "@babel/plugin-transform-async-generator-functions": "7.24.7",
+        "@babel/plugin-transform-async-to-generator": "7.24.7",
+        "@babel/plugin-transform-runtime": "7.24.7",
+        "@babel/preset-env": "7.24.7",
+        "@babel/runtime": "7.24.7",
         "@discoveryjs/json-ext": "0.5.7",
-        "@ngtools/webpack": "17.3.5",
+        "@ngtools/webpack": "18.1.1",
         "@vitejs/plugin-basic-ssl": "1.1.0",
         "ansi-colors": "4.1.3",
-        "autoprefixer": "10.4.18",
+        "autoprefixer": "10.4.19",
         "babel-loader": "9.1.3",
-        "babel-plugin-istanbul": "6.1.1",
         "browserslist": "^4.21.5",
-        "copy-webpack-plugin": "11.0.0",
-        "critters": "0.0.22",
-        "css-loader": "6.10.0",
-        "esbuild-wasm": "0.20.1",
+        "copy-webpack-plugin": "12.0.2",
+        "critters": "0.0.24",
+        "css-loader": "7.1.2",
+        "esbuild-wasm": "0.21.5",
         "fast-glob": "3.3.2",
-        "http-proxy-middleware": "2.0.6",
-        "https-proxy-agent": "7.0.4",
-        "inquirer": "9.2.15",
-        "jsonc-parser": "3.2.1",
+        "http-proxy-middleware": "3.0.0",
+        "https-proxy-agent": "7.0.5",
+        "istanbul-lib-instrument": "6.0.2",
+        "jsonc-parser": "3.3.1",
         "karma-source-map-support": "1.4.0",
         "less": "4.2.0",
-        "less-loader": "11.1.0",
+        "less-loader": "12.2.0",
         "license-webpack-plugin": "4.0.2",
-        "loader-utils": "3.2.1",
-        "magic-string": "0.30.8",
-        "mini-css-extract-plugin": "2.8.1",
+        "loader-utils": "3.3.1",
+        "magic-string": "0.30.10",
+        "mini-css-extract-plugin": "2.9.0",
         "mrmime": "2.0.0",
-        "open": "8.4.2",
+        "open": "10.1.0",
         "ora": "5.4.1",
         "parse5-html-rewriting-stream": "7.0.0",
-        "picomatch": "4.0.1",
-        "piscina": "4.4.0",
-        "postcss": "8.4.35",
+        "picomatch": "4.0.2",
+        "piscina": "4.6.1",
+        "postcss": "8.4.38",
         "postcss-loader": "8.1.1",
         "resolve-url-loader": "5.0.0",
         "rxjs": "7.8.1",
-        "sass": "1.71.1",
-        "sass-loader": "14.1.1",
-        "semver": "7.6.0",
+        "sass": "1.77.6",
+        "sass-loader": "14.2.1",
+        "semver": "7.6.2",
         "source-map-loader": "5.0.0",
         "source-map-support": "0.5.21",
-        "terser": "5.29.1",
+        "terser": "5.29.2",
         "tree-kill": "1.2.2",
-        "tslib": "2.6.2",
-        "undici": "6.11.1",
-        "vite": "5.1.7",
-        "watchpack": "2.4.0",
-        "webpack": "5.90.3",
-        "webpack-dev-middleware": "6.1.2",
-        "webpack-dev-server": "4.15.1",
+        "tslib": "2.6.3",
+        "undici": "6.19.2",
+        "vite": "5.3.2",
+        "watchpack": "2.4.1",
+        "webpack": "5.92.1",
+        "webpack-dev-middleware": "7.2.1",
+        "webpack-dev-server": "5.0.4",
         "webpack-merge": "5.10.0",
         "webpack-subresource-integrity": "5.1.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       },
       "optionalDependencies": {
-        "esbuild": "0.20.1"
+        "esbuild": "0.21.5"
       },
       "peerDependencies": {
-        "@angular/compiler-cli": "^17.0.0",
-        "@angular/localize": "^17.0.0",
-        "@angular/platform-server": "^17.0.0",
-        "@angular/service-worker": "^17.0.0",
+        "@angular/compiler-cli": "^18.0.0",
+        "@angular/localize": "^18.0.0",
+        "@angular/platform-server": "^18.0.0",
+        "@angular/service-worker": "^18.0.0",
         "@web/test-runner": "^0.18.0",
         "browser-sync": "^3.0.2",
         "jest": "^29.5.0",
         "jest-environment-jsdom": "^29.5.0",
         "karma": "^6.3.0",
-        "ng-packagr": "^17.0.0",
+        "ng-packagr": "^18.0.0",
         "protractor": "^7.0.0",
         "tailwindcss": "^2.0.0 || ^3.0.0",
-        "typescript": ">=5.2 <5.5"
+        "typescript": ">=5.4 <5.6"
       },
       "peerDependenciesMeta": {
         "@angular/localize": {
@@ -195,39 +195,39 @@
       }
     },
     "node_modules/@angular-devkit/build-webpack": {
-      "version": "0.1703.5",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/build-webpack/-/build-webpack-0.1703.5.tgz",
-      "integrity": "sha512-KcoKlWhDP6+2q3laQ6elXLt2QrVxWJFdCPUC9dIm0Tnc997Tal/UVhlDKaZgITYDgDvRFqG+tzNm2uFd8l7h+A==",
+      "version": "0.1801.1",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/build-webpack/-/build-webpack-0.1801.1.tgz",
+      "integrity": "sha512-9qImQciytrf433+h1aAWMD/Qn9cx7amlLtHX9j6ToBMWxY3L9ZKzwlCZ3Q+d6VWs7QrN/X9j8VkJl913yuXeCQ==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/architect": "0.1703.5",
+        "@angular-devkit/architect": "0.1801.1",
         "rxjs": "7.8.1"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       },
       "peerDependencies": {
         "webpack": "^5.30.0",
-        "webpack-dev-server": "^4.0.0"
+        "webpack-dev-server": "^5.0.2"
       }
     },
     "node_modules/@angular-devkit/core": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/core/-/core-17.3.5.tgz",
-      "integrity": "sha512-iqGv45HVI+yRROoTqQTY0QChYlRCZkFUfIjdfJLegjc6xq9sLtxDr03CWM45BKGG5lSxDOy+qu/pdRvtL3V2eg==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/core/-/core-18.1.1.tgz",
+      "integrity": "sha512-YFzn/+8LezX7ZJhMQisvrqfkxJm6+JOtbWFj8K/luK0rTDmE8Z9n9r6kJ36FnHcLJ5MvvVaBc7n1v1wnzdqXpg==",
       "dev": true,
       "dependencies": {
-        "ajv": "8.12.0",
-        "ajv-formats": "2.1.1",
-        "jsonc-parser": "3.2.1",
-        "picomatch": "4.0.1",
+        "ajv": "8.16.0",
+        "ajv-formats": "3.0.1",
+        "jsonc-parser": "3.3.1",
+        "picomatch": "4.0.2",
         "rxjs": "7.8.1",
         "source-map": "0.7.4"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       },
@@ -241,42 +241,112 @@
       }
     },
     "node_modules/@angular-devkit/schematics": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular-devkit/schematics/-/schematics-17.3.5.tgz",
-      "integrity": "sha512-oh/mvpMKxGfk5v9QIB7LfGsDC/iVpmsIAvbb4+1ddCx86EJXdz3xWnVDbUehOd6n7HJXnQrNirWjWvWquM2GhQ==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular-devkit/schematics/-/schematics-18.1.1.tgz",
+      "integrity": "sha512-r+DAvVvv+hOuhh19PefPOKa/zDkvzLHz/YOLGq/k1KfJRtNtjCKiDsXp1s6HSzYdJD1H10wnzUIh48uvxfwH5Q==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/core": "17.3.5",
-        "jsonc-parser": "3.2.1",
-        "magic-string": "0.30.8",
+        "@angular-devkit/core": "18.1.1",
+        "jsonc-parser": "3.3.1",
+        "magic-string": "0.30.10",
         "ora": "5.4.1",
         "rxjs": "7.8.1"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       }
     },
     "node_modules/@angular/animations": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/animations/-/animations-17.3.5.tgz",
-      "integrity": "sha512-hbfCnBxwhYQMKB+9tDcmfvckUtB8LdY1gPST6TZ7CzrWCSPddsnXxqxBZSBjBI6zXvE4FOV3kUzaUXM/Bq5sRw==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/animations/-/animations-18.1.1.tgz",
+      "integrity": "sha512-3BdB6lB7TT1BQFb8C3XyJ5A9YSrOx951NzcXnzFfTNiq1C+VeR455LtdNiDTPa9Vf5Df1cJb6ReJ1z17ztx+6Q==",
       "peer": true,
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "17.3.5"
+        "@angular/core": "18.1.1"
+      }
+    },
+    "node_modules/@angular/build": {
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/build/-/build-18.1.1.tgz",
+      "integrity": "sha512-DbgFqpaZE6g8VZaPboB54cVuERlZV6SAkNPEaMT/53cnCxL4QdSQs1aT9Wy8G1Ksr4WI5AZMdPic/TVF0KBGGQ==",
+      "dev": true,
+      "dependencies": {
+        "@ampproject/remapping": "2.3.0",
+        "@angular-devkit/architect": "0.1801.1",
+        "@babel/core": "7.24.7",
+        "@babel/helper-annotate-as-pure": "7.24.7",
+        "@babel/helper-split-export-declaration": "7.24.7",
+        "@babel/plugin-syntax-import-attributes": "7.24.7",
+        "@inquirer/confirm": "3.1.11",
+        "@vitejs/plugin-basic-ssl": "1.1.0",
+        "ansi-colors": "4.1.3",
+        "browserslist": "^4.23.0",
+        "critters": "0.0.24",
+        "esbuild": "0.21.5",
+        "fast-glob": "3.3.2",
+        "https-proxy-agent": "7.0.5",
+        "lmdb": "3.0.12",
+        "magic-string": "0.30.10",
+        "mrmime": "2.0.0",
+        "ora": "5.4.1",
+        "parse5-html-rewriting-stream": "7.0.0",
+        "picomatch": "4.0.2",
+        "piscina": "4.6.1",
+        "rollup": "4.18.0",
+        "sass": "1.77.6",
+        "semver": "7.6.2",
+        "undici": "6.19.2",
+        "vite": "5.3.2",
+        "watchpack": "2.4.1"
+      },
+      "engines": {
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
+        "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
+        "yarn": ">= 1.13.0"
+      },
+      "peerDependencies": {
+        "@angular/compiler-cli": "^18.0.0",
+        "@angular/localize": "^18.0.0",
+        "@angular/platform-server": "^18.0.0",
+        "@angular/service-worker": "^18.0.0",
+        "less": "^4.2.0",
+        "postcss": "^8.4.0",
+        "tailwindcss": "^2.0.0 || ^3.0.0",
+        "typescript": ">=5.4 <5.6"
+      },
+      "peerDependenciesMeta": {
+        "@angular/localize": {
+          "optional": true
+        },
+        "@angular/platform-server": {
+          "optional": true
+        },
+        "@angular/service-worker": {
+          "optional": true
+        },
+        "less": {
+          "optional": true
+        },
+        "postcss": {
+          "optional": true
+        },
+        "tailwindcss": {
+          "optional": true
+        }
       }
     },
     "node_modules/@angular/cdk": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/cdk/-/cdk-17.3.5.tgz",
-      "integrity": "sha512-6y8+yIPWG0wTdPwHIPxKrEFCX1JxxBh4aXcmQnrNTDIvtoEPGaea9SU9XKaU8ahiZMlcpUXqKLG0BVbEhA1Oow==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/cdk/-/cdk-18.1.1.tgz",
+      "integrity": "sha512-IaDjvRUgAoKnEeafrnBX+hjTR+1M3O3fV3AybBCjN4NuiPtuyOJiTMg0cTv6RbluJ/SenbT4MQq3tMpOsa9i4w==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
@@ -284,33 +354,32 @@
         "parse5": "^7.1.2"
       },
       "peerDependencies": {
-        "@angular/common": "^17.0.0 || ^18.0.0",
-        "@angular/core": "^17.0.0 || ^18.0.0",
+        "@angular/common": "^18.0.0 || ^19.0.0",
+        "@angular/core": "^18.0.0 || ^19.0.0",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@angular/cli": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/cli/-/cli-17.3.5.tgz",
-      "integrity": "sha512-6MHJzPKy4uB9qlJO1eKs4rtDlRuCe0lOiz1f3kHFZ/GQQm5xA1xsmZJMN4ASsnu4yU3oZs6vJ/vt8i2/jvdPbA==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/cli/-/cli-18.1.1.tgz",
+      "integrity": "sha512-sRmc5meBLRQgFKq6te1UM4JPHWPERrg1pjYStft/qRKkOyvgpNzq3Ol6hN3zNb2ds2bAgjKhEAlOwSOZuw1cqQ==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/architect": "0.1703.5",
-        "@angular-devkit/core": "17.3.5",
-        "@angular-devkit/schematics": "17.3.5",
-        "@schematics/angular": "17.3.5",
+        "@angular-devkit/architect": "0.1801.1",
+        "@angular-devkit/core": "18.1.1",
+        "@angular-devkit/schematics": "18.1.1",
+        "@inquirer/prompts": "5.0.7",
+        "@listr2/prompt-adapter-inquirer": "2.0.13",
+        "@schematics/angular": "18.1.1",
         "@yarnpkg/lockfile": "1.1.0",
-        "ansi-colors": "4.1.3",
-        "ini": "4.1.2",
-        "inquirer": "9.2.15",
-        "jsonc-parser": "3.2.1",
-        "npm-package-arg": "11.0.1",
-        "npm-pick-manifest": "9.0.0",
-        "open": "8.4.2",
-        "ora": "5.4.1",
-        "pacote": "17.0.6",
+        "ini": "4.1.3",
+        "jsonc-parser": "3.3.1",
+        "listr2": "8.2.3",
+        "npm-package-arg": "11.0.2",
+        "npm-pick-manifest": "9.0.1",
+        "pacote": "18.0.6",
         "resolve": "1.22.8",
-        "semver": "7.6.0",
+        "semver": "7.6.2",
         "symbol-observable": "4.0.0",
         "yargs": "17.7.2"
       },
@@ -318,38 +387,38 @@
         "ng": "bin/ng.js"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       }
     },
     "node_modules/@angular/common": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/common/-/common-17.3.5.tgz",
-      "integrity": "sha512-Ox91WxSnOSrQ6I21cHi69EfT2Pxtd5Knb5AsdwpxqE57V2E7EnWMhb+LP+holCtFUhK529EGXCk788M+Elyw6g==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/common/-/common-18.1.1.tgz",
+      "integrity": "sha512-qNfYAapvIi8JyQToSqbg3O5dRXaElv/yNp2evvBGn4UO/liHjdNV/DzgCdyKP7uVbYrR0W3bzj++SxVR3mrATQ==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "17.3.5",
+        "@angular/core": "18.1.1",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@angular/compiler": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/compiler/-/compiler-17.3.5.tgz",
-      "integrity": "sha512-lTubBFNlpH9zK46+yeVI7VJQNUELLAB8W1ucndYLCA9Rr9Jop+rYIXijmr42AGokOYr7yLc8HRiSQ5e+X2pUQg==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/compiler/-/compiler-18.1.1.tgz",
+      "integrity": "sha512-Nc2GZhXXi3O2otZIWgOJoGZ+88+R6YXGc70dibEpMvmDjKfYpc4pBjuYzaGntdiTYAzVOVTTv09dwTP6YOpPRA==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/core": "17.3.5"
+        "@angular/core": "18.1.1"
       },
       "peerDependenciesMeta": {
         "@angular/core": {
@@ -358,12 +427,12 @@
       }
     },
     "node_modules/@angular/compiler-cli": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/compiler-cli/-/compiler-cli-17.3.5.tgz",
-      "integrity": "sha512-R53JNbbVDHWSGdL0e2vGQ5iJCrILOWZ1oemKjekOFB93fUBlEyi+nZmm4uTO7RU8PgjB0UpxI6ok5ZE3Amkt6A==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/compiler-cli/-/compiler-cli-18.1.1.tgz",
+      "integrity": "sha512-TMPrN4HLa5raxW133bY3AxH1Gar36nmy0ikttMeSotLSlC5Y4SCYaiMY7QaPytD1iEGvqAd/rP+YuXzOIuCM/w==",
       "dev": true,
       "dependencies": {
-        "@babel/core": "7.23.9",
+        "@babel/core": "7.24.7",
         "@jridgewell/sourcemap-codec": "^1.4.14",
         "chokidar": "^3.0.0",
         "convert-source-map": "^1.5.1",
@@ -378,67 +447,22 @@
         "ngcc": "bundles/ngcc/index.js"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/compiler": "17.3.5",
-        "typescript": ">=5.2 <5.5"
-      }
-    },
-    "node_modules/@angular/compiler-cli/node_modules/@babel/core": {
-      "version": "7.23.9",
-      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.23.9.tgz",
-      "integrity": "sha512-5q0175NOjddqpvvzU+kDiSOAk4PfdO6FvwCWoQ6RO7rTzEe8vlo+4HVfcnAREhD4npMs0e9uZypjTwzZPCf/cw==",
-      "dev": true,
-      "dependencies": {
-        "@ampproject/remapping": "^2.2.0",
-        "@babel/code-frame": "^7.23.5",
-        "@babel/generator": "^7.23.6",
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helpers": "^7.23.9",
-        "@babel/parser": "^7.23.9",
-        "@babel/template": "^7.23.9",
-        "@babel/traverse": "^7.23.9",
-        "@babel/types": "^7.23.9",
-        "convert-source-map": "^2.0.0",
-        "debug": "^4.1.0",
-        "gensync": "^1.0.0-beta.2",
-        "json5": "^2.2.3",
-        "semver": "^6.3.1"
-      },
-      "engines": {
-        "node": ">=6.9.0"
-      },
-      "funding": {
-        "type": "opencollective",
-        "url": "https://opencollective.com/babel"
-      }
-    },
-    "node_modules/@angular/compiler-cli/node_modules/@babel/core/node_modules/convert-source-map": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
-      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
-      "dev": true
-    },
-    "node_modules/@angular/compiler-cli/node_modules/@babel/core/node_modules/semver": {
-      "version": "6.3.1",
-      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
-      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
-      "dev": true,
-      "bin": {
-        "semver": "bin/semver.js"
+        "@angular/compiler": "18.1.1",
+        "typescript": ">=5.4 <5.6"
       }
     },
     "node_modules/@angular/core": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/core/-/core-17.3.5.tgz",
-      "integrity": "sha512-y6P27lcrKy3yMx/rtMuGsAnDyVEsS3BdyArTXcD0TOImVGHhVIaB0L95DUCam3ajTe2f2x39eozJZDh7QSpJaw==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/core/-/core-18.1.1.tgz",
+      "integrity": "sha512-/JFQ49fVIthZzdggl7FOCYAjaynbkRcCyiri85kAyTIvJ6aMSIiEKwJCw45WI5ICf2HtC9kz6dr0OKhMR6SeiA==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
         "rxjs": "^6.5.3 || ^7.4.0",
@@ -446,26 +470,26 @@
       }
     },
     "node_modules/@angular/forms": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/forms/-/forms-17.3.5.tgz",
-      "integrity": "sha512-Rf/8XWHdFYZQaOVTJ0QVwxQm9fDqQqIJc0yfPcH/DYL5pT7R0U2z98I5McZawzUBJUo1Zt1gijzDlzNUGf6jiA==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/forms/-/forms-18.1.1.tgz",
+      "integrity": "sha512-CceH57IKeH2Zq8QFFkcJMvBbjxVRCtqzAqSETfShWzrt+ITrz4c6EnUMbj30iz+ntn/R+qGAp3n/t0D7HtTS6Q==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "17.3.5",
-        "@angular/core": "17.3.5",
-        "@angular/platform-browser": "17.3.5",
+        "@angular/common": "18.1.1",
+        "@angular/core": "18.1.1",
+        "@angular/platform-browser": "18.1.1",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@angular/material": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/material/-/material-17.3.5.tgz",
-      "integrity": "sha512-1+QqBQ8HVOwxOkx/v2n53JA9ALOee55yVDbnAv7TkseNN4JEDxOcE5TO5HGmdV2A4tcsXQ00MIdy04jiB4sCng==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/material/-/material-18.1.1.tgz",
+      "integrity": "sha512-9JdUEUZheMMk+Tu8oDLRdI2eXOeI9d2BjEZYkoDif4iB7TCldmcKJyTYXs3kSZz6B53vup/vgKJUPBHLkIDD+A==",
       "dependencies": {
         "@material/animation": "15.0.0-canary.7f224ddd4.0",
         "@material/auto-init": "15.0.0-canary.7f224ddd4.0",
@@ -510,6 +534,7 @@
         "@material/tab-scroller": "15.0.0-canary.7f224ddd4.0",
         "@material/textfield": "15.0.0-canary.7f224ddd4.0",
         "@material/theme": "15.0.0-canary.7f224ddd4.0",
+        "@material/tokens": "15.0.0-canary.7f224ddd4.0",
         "@material/tooltip": "15.0.0-canary.7f224ddd4.0",
         "@material/top-app-bar": "15.0.0-canary.7f224ddd4.0",
         "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
@@ -517,93 +542,29 @@
         "tslib": "^2.3.0"
       },
       "peerDependencies": {
-        "@angular/animations": "^17.0.0 || ^18.0.0",
-        "@angular/cdk": "17.3.5",
-        "@angular/common": "^17.0.0 || ^18.0.0",
-        "@angular/core": "^17.0.0 || ^18.0.0",
-        "@angular/forms": "^17.0.0 || ^18.0.0",
-        "@angular/platform-browser": "^17.0.0 || ^18.0.0",
+        "@angular/animations": "^18.0.0 || ^19.0.0",
+        "@angular/cdk": "18.1.1",
+        "@angular/common": "^18.0.0 || ^19.0.0",
+        "@angular/core": "^18.0.0 || ^19.0.0",
+        "@angular/forms": "^18.0.0 || ^19.0.0",
+        "@angular/platform-browser": "^18.0.0 || ^19.0.0",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
-    "node_modules/@angular/material-experimental": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/material-experimental/-/material-experimental-17.3.5.tgz",
-      "integrity": "sha512-gA7BTNcLP5WXAP4EcfjZiMhf2k53SOZd8Dg4+sydjlxwYI/sfHRg/cF0zGNjBpkRvBt0+1dNvJmEcEReXIqdCQ==",
-      "dependencies": {
-        "@material/animation": "15.0.0-canary.7f224ddd4.0",
-        "@material/auto-init": "15.0.0-canary.7f224ddd4.0",
-        "@material/banner": "15.0.0-canary.7f224ddd4.0",
-        "@material/base": "15.0.0-canary.7f224ddd4.0",
-        "@material/button": "15.0.0-canary.7f224ddd4.0",
-        "@material/card": "15.0.0-canary.7f224ddd4.0",
-        "@material/checkbox": "15.0.0-canary.7f224ddd4.0",
-        "@material/chips": "15.0.0-canary.7f224ddd4.0",
-        "@material/circular-progress": "15.0.0-canary.7f224ddd4.0",
-        "@material/data-table": "15.0.0-canary.7f224ddd4.0",
-        "@material/density": "15.0.0-canary.7f224ddd4.0",
-        "@material/dialog": "15.0.0-canary.7f224ddd4.0",
-        "@material/dom": "15.0.0-canary.7f224ddd4.0",
-        "@material/drawer": "15.0.0-canary.7f224ddd4.0",
-        "@material/elevation": "15.0.0-canary.7f224ddd4.0",
-        "@material/fab": "15.0.0-canary.7f224ddd4.0",
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/floating-label": "15.0.0-canary.7f224ddd4.0",
-        "@material/form-field": "15.0.0-canary.7f224ddd4.0",
-        "@material/icon-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/image-list": "15.0.0-canary.7f224ddd4.0",
-        "@material/layout-grid": "15.0.0-canary.7f224ddd4.0",
-        "@material/line-ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/linear-progress": "15.0.0-canary.7f224ddd4.0",
-        "@material/list": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu": "15.0.0-canary.7f224ddd4.0",
-        "@material/menu-surface": "15.0.0-canary.7f224ddd4.0",
-        "@material/notched-outline": "15.0.0-canary.7f224ddd4.0",
-        "@material/radio": "15.0.0-canary.7f224ddd4.0",
-        "@material/ripple": "15.0.0-canary.7f224ddd4.0",
-        "@material/rtl": "15.0.0-canary.7f224ddd4.0",
-        "@material/segmented-button": "15.0.0-canary.7f224ddd4.0",
-        "@material/select": "15.0.0-canary.7f224ddd4.0",
-        "@material/shape": "15.0.0-canary.7f224ddd4.0",
-        "@material/slider": "15.0.0-canary.7f224ddd4.0",
-        "@material/snackbar": "15.0.0-canary.7f224ddd4.0",
-        "@material/switch": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-bar": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-indicator": "15.0.0-canary.7f224ddd4.0",
-        "@material/tab-scroller": "15.0.0-canary.7f224ddd4.0",
-        "@material/textfield": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "@material/tooltip": "15.0.0-canary.7f224ddd4.0",
-        "@material/top-app-bar": "15.0.0-canary.7f224ddd4.0",
-        "@material/touch-target": "15.0.0-canary.7f224ddd4.0",
-        "@material/typography": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.3.0"
-      },
-      "peerDependencies": {
-        "@angular/animations": "^17.0.0 || ^18.0.0",
-        "@angular/cdk": "17.3.5",
-        "@angular/common": "^17.0.0 || ^18.0.0",
-        "@angular/core": "^17.0.0 || ^18.0.0",
-        "@angular/forms": "^17.0.0 || ^18.0.0",
-        "@angular/material": "17.3.5",
-        "@angular/platform-browser": "^17.0.0 || ^18.0.0"
-      }
-    },
     "node_modules/@angular/platform-browser": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/platform-browser/-/platform-browser-17.3.5.tgz",
-      "integrity": "sha512-ITlu/GTD64Sr0FMaFCJiHoTJrEZw8qRFXjPjv3BKhAp5dQKcwnCm02o1NOaj5d8oIItIh5fbI2zP0CSU2qNZkQ==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/platform-browser/-/platform-browser-18.1.1.tgz",
+      "integrity": "sha512-9FG2+NSWJXo+zu/W7VQE0UpaWejbV62AXW7218FBZXOdkdID5oNxHf0QdJ3hCaIJw1dKZEG49BTq005d9yQbew==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/animations": "17.3.5",
-        "@angular/common": "17.3.5",
-        "@angular/core": "17.3.5"
+        "@angular/animations": "18.1.1",
+        "@angular/common": "18.1.1",
+        "@angular/core": "18.1.1"
       },
       "peerDependenciesMeta": {
         "@angular/animations": {
@@ -612,46 +573,46 @@
       }
     },
     "node_modules/@angular/platform-browser-dynamic": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/platform-browser-dynamic/-/platform-browser-dynamic-17.3.5.tgz",
-      "integrity": "sha512-KuS4j3Gh1h/CEj+bIOc/IcZIdiCB/DNbtUvz1eNp1o23aM8QutqelI3A4WBnQuR4yq8Z/8M3FH9F1OVwwhn2QQ==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/platform-browser-dynamic/-/platform-browser-dynamic-18.1.1.tgz",
+      "integrity": "sha512-+nnWGLz7dhkRbel8qGIgfQa5PoE4ZMl0ClDw8HR0R5T3w+v0K6trPSjWIPDHm5ex25RvuLNmoUGu29drlHN3Fw==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "17.3.5",
-        "@angular/compiler": "17.3.5",
-        "@angular/core": "17.3.5",
-        "@angular/platform-browser": "17.3.5"
+        "@angular/common": "18.1.1",
+        "@angular/compiler": "18.1.1",
+        "@angular/core": "18.1.1",
+        "@angular/platform-browser": "18.1.1"
       }
     },
     "node_modules/@angular/router": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@angular/router/-/router-17.3.5.tgz",
-      "integrity": "sha512-KsIIs3t9IpxsdMSrJDZzO5WgIWkVE6Ep5WWiSyPIgEfA+ndGpJLmyv0d/r1yKKlYUJxz7Hde55o4thgT2n2x/A==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@angular/router/-/router-18.1.1.tgz",
+      "integrity": "sha512-XaPL+jzmanQa3y9JSMpyxcTqHTNLiGLW6yzcZ0hiKDRpCJ044cKLMK5Ruk84LfzvVDS//tGj46OYAwrPGmBFMg==",
       "dependencies": {
         "tslib": "^2.3.0"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0"
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0"
       },
       "peerDependencies": {
-        "@angular/common": "17.3.5",
-        "@angular/core": "17.3.5",
-        "@angular/platform-browser": "17.3.5",
+        "@angular/common": "18.1.1",
+        "@angular/core": "18.1.1",
+        "@angular/platform-browser": "18.1.1",
         "rxjs": "^6.5.3 || ^7.4.0"
       }
     },
     "node_modules/@babel/code-frame": {
-      "version": "7.24.2",
-      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.24.2.tgz",
-      "integrity": "sha512-y5+tLQyV8pg3fsiln67BVLD1P13Eg4lh5RW9mF0zUuvLrv9uIQ4MCL+CRT+FTsBlBjcIan6PGsLcBN0m3ClUyQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.24.7.tgz",
+      "integrity": "sha512-BcYH1CVJBO9tvyIZ2jVeXgSIMvGZ2FDRvDdOIVQyuklNKSsx+eppDEBq/g47Ayw+RqNFE+URvOShmf+f/qwAlA==",
       "dev": true,
       "dependencies": {
-        "@babel/highlight": "^7.24.2",
+        "@babel/highlight": "^7.24.7",
         "picocolors": "^1.0.0"
       },
       "engines": {
@@ -659,30 +620,30 @@
       }
     },
     "node_modules/@babel/compat-data": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.24.4.tgz",
-      "integrity": "sha512-vg8Gih2MLK+kOkHJp4gBEIkyaIi00jgWot2D9QOmmfLC8jINSOzmCLta6Bvz/JSBCqnegV0L80jhxkol5GWNfQ==",
+      "version": "7.24.9",
+      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.24.9.tgz",
+      "integrity": "sha512-e701mcfApCJqMMueQI0Fb68Amflj83+dvAvHawoBpAz+GDjCIyGHzNwnefjsWJ3xiYAqqiQFoWbspGYBdb2/ng==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/core": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.24.0.tgz",
-      "integrity": "sha512-fQfkg0Gjkza3nf0c7/w6Xf34BW4YvzNfACRLmmb7XRLa6XHdR+K9AlJlxneFfWYf6uhOzuzZVTjF/8KfndZANw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.24.7.tgz",
+      "integrity": "sha512-nykK+LEK86ahTkX/3TgauT0ikKoNCfKHEaZYTUVupJdTLzGNvrblu4u6fa7DhZONAltdf8e662t/abY8idrd/g==",
       "dev": true,
       "dependencies": {
         "@ampproject/remapping": "^2.2.0",
-        "@babel/code-frame": "^7.23.5",
-        "@babel/generator": "^7.23.6",
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helpers": "^7.24.0",
-        "@babel/parser": "^7.24.0",
-        "@babel/template": "^7.24.0",
-        "@babel/traverse": "^7.24.0",
-        "@babel/types": "^7.24.0",
+        "@babel/code-frame": "^7.24.7",
+        "@babel/generator": "^7.24.7",
+        "@babel/helper-compilation-targets": "^7.24.7",
+        "@babel/helper-module-transforms": "^7.24.7",
+        "@babel/helpers": "^7.24.7",
+        "@babel/parser": "^7.24.7",
+        "@babel/template": "^7.24.7",
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7",
         "convert-source-map": "^2.0.0",
         "debug": "^4.1.0",
         "gensync": "^1.0.0-beta.2",
@@ -713,14 +674,14 @@
       }
     },
     "node_modules/@babel/generator": {
-      "version": "7.23.6",
-      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.23.6.tgz",
-      "integrity": "sha512-qrSfCYxYQB5owCmGLbl8XRpX1ytXlpueOb0N0UmQwA073KZxejgQTzAmJezxvpwQD9uGtK2shHdi55QT+MbjIw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.24.7.tgz",
+      "integrity": "sha512-oipXieGC3i45Y1A41t4tAqpnEZWgB/lC6Ehh6+rOviR5XWpTtMmLN+fGjz9vOiNRt0p6RtO6DtD0pdU3vpqdSA==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.23.6",
-        "@jridgewell/gen-mapping": "^0.3.2",
-        "@jridgewell/trace-mapping": "^0.3.17",
+        "@babel/types": "^7.24.7",
+        "@jridgewell/gen-mapping": "^0.3.5",
+        "@jridgewell/trace-mapping": "^0.3.25",
         "jsesc": "^2.5.1"
       },
       "engines": {
@@ -728,38 +689,39 @@
       }
     },
     "node_modules/@babel/helper-annotate-as-pure": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-annotate-as-pure/-/helper-annotate-as-pure-7.22.5.tgz",
-      "integrity": "sha512-LvBTxu8bQSQkcyKOU+a1btnNFQ1dMAd0R6PyW3arXes06F6QLWLIrd681bxRPIXlrMGR3XYnW9JyML7dP3qgxg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-annotate-as-pure/-/helper-annotate-as-pure-7.24.7.tgz",
+      "integrity": "sha512-BaDeOonYvhdKw+JoMVkAixAAJzG2jVPIwWoKBPdYuY9b452e2rPuI9QPYh3KpofZ3pW2akOmwZLOiOsHMiqRAg==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-builder-binary-assignment-operator-visitor": {
-      "version": "7.22.15",
-      "resolved": "https://registry.npmjs.org/@babel/helper-builder-binary-assignment-operator-visitor/-/helper-builder-binary-assignment-operator-visitor-7.22.15.tgz",
-      "integrity": "sha512-QkBXwGgaoC2GtGZRoma6kv7Szfv06khvhFav67ZExau2RaXzy8MpHSMO2PNoP2XtmQphJQRHFfg77Bq731Yizw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-builder-binary-assignment-operator-visitor/-/helper-builder-binary-assignment-operator-visitor-7.24.7.tgz",
+      "integrity": "sha512-xZeCVVdwb4MsDBkkyZ64tReWYrLRHlMN72vP7Bdm3OUOuyFZExhsHUUnuWnm2/XOlAJzR0LfPpB56WXZn0X/lA==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.15"
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-compilation-targets": {
-      "version": "7.23.6",
-      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.23.6.tgz",
-      "integrity": "sha512-9JB548GZoQVmzrFgp8o7KxdgkTGm6xs9DW0o/Pim72UDjzr5ObUQ6ZzYPqA+g9OTS2bBQoctLJrky0RDCAWRgQ==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.24.8.tgz",
+      "integrity": "sha512-oU+UoqCHdp+nWVDkpldqIQL/i/bvAv53tRqLG/s+cOXxe66zOYLU7ar/Xs3LdmBihrUMEUhwu6dMZwbNOYDwvw==",
       "dev": true,
       "dependencies": {
-        "@babel/compat-data": "^7.23.5",
-        "@babel/helper-validator-option": "^7.23.5",
-        "browserslist": "^4.22.2",
+        "@babel/compat-data": "^7.24.8",
+        "@babel/helper-validator-option": "^7.24.8",
+        "browserslist": "^4.23.1",
         "lru-cache": "^5.1.1",
         "semver": "^6.3.1"
       },
@@ -777,19 +739,19 @@
       }
     },
     "node_modules/@babel/helper-create-class-features-plugin": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/helper-create-class-features-plugin/-/helper-create-class-features-plugin-7.24.4.tgz",
-      "integrity": "sha512-lG75yeuUSVu0pIcbhiYMXBXANHrpUPaOfu7ryAzskCgKUHuAxRQI5ssrtmF0X9UXldPlvT0XM/A4F44OXRt6iQ==",
-      "dev": true,
-      "dependencies": {
-        "@babel/helper-annotate-as-pure": "^7.22.5",
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-function-name": "^7.23.0",
-        "@babel/helper-member-expression-to-functions": "^7.23.0",
-        "@babel/helper-optimise-call-expression": "^7.22.5",
-        "@babel/helper-replace-supers": "^7.24.1",
-        "@babel/helper-skip-transparent-expression-wrappers": "^7.22.5",
-        "@babel/helper-split-export-declaration": "^7.22.6",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-create-class-features-plugin/-/helper-create-class-features-plugin-7.24.8.tgz",
+      "integrity": "sha512-4f6Oqnmyp2PP3olgUMmOwC3akxSm5aBYraQ6YDdKy7NcAMkDECHWG0DEnV6M2UAkERgIBhYt8S27rURPg7SxWA==",
+      "dev": true,
+      "dependencies": {
+        "@babel/helper-annotate-as-pure": "^7.24.7",
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-function-name": "^7.24.7",
+        "@babel/helper-member-expression-to-functions": "^7.24.8",
+        "@babel/helper-optimise-call-expression": "^7.24.7",
+        "@babel/helper-replace-supers": "^7.24.7",
+        "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7",
+        "@babel/helper-split-export-declaration": "^7.24.7",
         "semver": "^6.3.1"
       },
       "engines": {
@@ -809,12 +771,12 @@
       }
     },
     "node_modules/@babel/helper-create-regexp-features-plugin": {
-      "version": "7.22.15",
-      "resolved": "https://registry.npmjs.org/@babel/helper-create-regexp-features-plugin/-/helper-create-regexp-features-plugin-7.22.15.tgz",
-      "integrity": "sha512-29FkPLFjn4TPEa3RE7GpW+qbE8tlsu3jntNYNfcGsc49LphF1PQIiD+vMZ1z1xVOKt+93khA9tc2JBs3kBjA7w==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-create-regexp-features-plugin/-/helper-create-regexp-features-plugin-7.24.7.tgz",
+      "integrity": "sha512-03TCmXy2FtXJEZfbXDTSqq1fRJArk7lX9DOFC/47VthYcxyIOx+eXQmdo6DOQvrbpIix+KfXwvuXdFDZHxt+rA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-annotate-as-pure": "^7.22.5",
+        "@babel/helper-annotate-as-pure": "^7.24.7",
         "regexpu-core": "^5.3.1",
         "semver": "^6.3.1"
       },
@@ -851,74 +813,79 @@
       }
     },
     "node_modules/@babel/helper-environment-visitor": {
-      "version": "7.22.20",
-      "resolved": "https://registry.npmjs.org/@babel/helper-environment-visitor/-/helper-environment-visitor-7.22.20.tgz",
-      "integrity": "sha512-zfedSIzFhat/gFhWfHtgWvlec0nqB9YEIVrpuwjruLlXfUSnA8cJB0miHKwqDnQ7d32aKo2xt88/xZptwxbfhA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-environment-visitor/-/helper-environment-visitor-7.24.7.tgz",
+      "integrity": "sha512-DoiN84+4Gnd0ncbBOM9AZENV4a5ZiL39HYMyZJGZ/AZEykHYdJw0wW3kdcsh9/Kn+BRXHLkkklZ51ecPKmI1CQ==",
       "dev": true,
+      "dependencies": {
+        "@babel/types": "^7.24.7"
+      },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-function-name": {
-      "version": "7.23.0",
-      "resolved": "https://registry.npmjs.org/@babel/helper-function-name/-/helper-function-name-7.23.0.tgz",
-      "integrity": "sha512-OErEqsrxjZTJciZ4Oo+eoZqeW9UIiOcuYKRJA4ZAgV9myA+pOXhhmpfNCKjEH/auVfEYVFJ6y1Tc4r0eIApqiw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-function-name/-/helper-function-name-7.24.7.tgz",
+      "integrity": "sha512-FyoJTsj/PEUWu1/TYRiXTIHc8lbw+TDYkZuoE43opPS5TrI7MyONBE1oNvfguEXAD9yhQRrVBnXdXzSLQl9XnA==",
       "dev": true,
       "dependencies": {
-        "@babel/template": "^7.22.15",
-        "@babel/types": "^7.23.0"
+        "@babel/template": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-hoist-variables": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-hoist-variables/-/helper-hoist-variables-7.22.5.tgz",
-      "integrity": "sha512-wGjk9QZVzvknA6yKIUURb8zY3grXCcOZt+/7Wcy8O2uctxhplmUPkOdlgoNhmdVee2c92JXbf1xpMtVNbfoxRw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-hoist-variables/-/helper-hoist-variables-7.24.7.tgz",
+      "integrity": "sha512-MJJwhkoGy5c4ehfoRyrJ/owKeMl19U54h27YYftT0o2teQ3FJ3nQUf/I3LlJsX4l3qlw7WRXUmiyajvHXoTubQ==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-member-expression-to-functions": {
-      "version": "7.23.0",
-      "resolved": "https://registry.npmjs.org/@babel/helper-member-expression-to-functions/-/helper-member-expression-to-functions-7.23.0.tgz",
-      "integrity": "sha512-6gfrPwh7OuT6gZyJZvd6WbTfrqAo7vm4xCzAXOusKqq/vWdKXphTpj5klHKNmRUU6/QRGlBsyU9mAIPaWHlqJA==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-member-expression-to-functions/-/helper-member-expression-to-functions-7.24.8.tgz",
+      "integrity": "sha512-LABppdt+Lp/RlBxqrh4qgf1oEH/WxdzQNDJIu5gC/W1GyvPVrOBiItmmM8wan2fm4oYqFuFfkXmlGpLQhPY8CA==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.23.0"
+        "@babel/traverse": "^7.24.8",
+        "@babel/types": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-module-imports": {
-      "version": "7.24.3",
-      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.24.3.tgz",
-      "integrity": "sha512-viKb0F9f2s0BCS22QSF308z/+1YWKV/76mwt61NBzS5izMzDPwdq1pTrzf+Li3npBWX9KdQbkeCt1jSAM7lZqg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.24.7.tgz",
+      "integrity": "sha512-8AyH3C+74cgCVVXow/myrynrAGv+nTVg5vKu2nZph9x7RcRwzmh0VFallJuFTZ9mx6u4eSdXZfcOzSqTUm0HCA==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.24.0"
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-module-transforms": {
-      "version": "7.23.3",
-      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.23.3.tgz",
-      "integrity": "sha512-7bBs4ED9OmswdfDzpz4MpWgSrV7FXlc3zIagvLFjS5H+Mk7Snr21vQ6QwrsoCGMfNC4e4LQPdoULEt4ykz0SRQ==",
+      "version": "7.24.9",
+      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.24.9.tgz",
+      "integrity": "sha512-oYbh+rtFKj/HwBQkFlUzvcybzklmVdVV3UU+mN7n2t/q3yGHbuVdNxyFvSBO1tfvjyArpHNcWMAzsSPdyI46hw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-module-imports": "^7.22.15",
-        "@babel/helper-simple-access": "^7.22.5",
-        "@babel/helper-split-export-declaration": "^7.22.6",
-        "@babel/helper-validator-identifier": "^7.22.20"
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-module-imports": "^7.24.7",
+        "@babel/helper-simple-access": "^7.24.7",
+        "@babel/helper-split-export-declaration": "^7.24.7",
+        "@babel/helper-validator-identifier": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -928,35 +895,35 @@
       }
     },
     "node_modules/@babel/helper-optimise-call-expression": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-optimise-call-expression/-/helper-optimise-call-expression-7.22.5.tgz",
-      "integrity": "sha512-HBwaojN0xFRx4yIvpwGqxiV2tUfl7401jlok564NgB9EHS1y6QT17FmKWm4ztqjeVdXLuC4fSvHc5ePpQjoTbw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-optimise-call-expression/-/helper-optimise-call-expression-7.24.7.tgz",
+      "integrity": "sha512-jKiTsW2xmWwxT1ixIdfXUZp+P5yURx2suzLZr5Hi64rURpDYdMW0pv+Uf17EYk2Rd428Lx4tLsnjGJzYKDM/6A==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-plugin-utils": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.24.0.tgz",
-      "integrity": "sha512-9cUznXMG0+FxRuJfvL82QlTqIzhVW9sL0KjMPHhAOOvpQGL8QtdxnBKILjBqxlHyliz0yCa1G903ZXI/FuHy2w==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.24.8.tgz",
+      "integrity": "sha512-FFWx5142D8h2Mgr/iPVGH5G7w6jDn4jUSpZTyDnQO0Yn7Ks2Kuz6Pci8H6MPCoUJegd/UZQ3tAvfLCxQSnWWwg==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-remap-async-to-generator": {
-      "version": "7.22.20",
-      "resolved": "https://registry.npmjs.org/@babel/helper-remap-async-to-generator/-/helper-remap-async-to-generator-7.22.20.tgz",
-      "integrity": "sha512-pBGyV4uBqOns+0UvhsTO8qgl8hO89PmiDYv+/COyp1aeMcmfrfruz+/nCMFiYyFF/Knn0yfrC85ZzNFjembFTw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-remap-async-to-generator/-/helper-remap-async-to-generator-7.24.7.tgz",
+      "integrity": "sha512-9pKLcTlZ92hNZMQfGCHImUpDOlAgkkpqalWEeftW5FBya75k8Li2ilerxkM/uBEj01iBZXcCIB/bwvDYgWyibA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-annotate-as-pure": "^7.22.5",
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-wrap-function": "^7.22.20"
+        "@babel/helper-annotate-as-pure": "^7.24.7",
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-wrap-function": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -966,14 +933,14 @@
       }
     },
     "node_modules/@babel/helper-replace-supers": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/helper-replace-supers/-/helper-replace-supers-7.24.1.tgz",
-      "integrity": "sha512-QCR1UqC9BzG5vZl8BMicmZ28RuUBnHhAMddD8yHFHDRH9lLTZ9uUPehX8ctVPT8l0TKblJidqcgUUKGVrePleQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-replace-supers/-/helper-replace-supers-7.24.7.tgz",
+      "integrity": "sha512-qTAxxBM81VEyoAY0TtLrx1oAEJc09ZK67Q9ljQToqCnA+55eNwCORaxlKyu+rNfX86o8OXRUSNUnrtsAZXM9sg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-member-expression-to-functions": "^7.23.0",
-        "@babel/helper-optimise-call-expression": "^7.22.5"
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-member-expression-to-functions": "^7.24.7",
+        "@babel/helper-optimise-call-expression": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -983,103 +950,105 @@
       }
     },
     "node_modules/@babel/helper-simple-access": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-simple-access/-/helper-simple-access-7.22.5.tgz",
-      "integrity": "sha512-n0H99E/K+Bika3++WNL17POvo4rKWZ7lZEp1Q+fStVbUi8nxPQEBOlTmCOxW/0JsS56SKKQ+ojAe2pHKJHN35w==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-simple-access/-/helper-simple-access-7.24.7.tgz",
+      "integrity": "sha512-zBAIvbCMh5Ts+b86r/CjU+4XGYIs+R1j951gxI3KmmxBMhCg4oQMsv6ZXQ64XOm/cvzfU1FmoCyt6+owc5QMYg==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-skip-transparent-expression-wrappers": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-skip-transparent-expression-wrappers/-/helper-skip-transparent-expression-wrappers-7.22.5.tgz",
-      "integrity": "sha512-tK14r66JZKiC43p8Ki33yLBVJKlQDFoA8GYN67lWCDCqoL6EMMSuM9b+Iff2jHaM/RRFYl7K+iiru7hbRqNx8Q==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-skip-transparent-expression-wrappers/-/helper-skip-transparent-expression-wrappers-7.24.7.tgz",
+      "integrity": "sha512-IO+DLT3LQUElMbpzlatRASEyQtfhSE0+m465v++3jyyXeBTBUjtVZg28/gHeV5mrTJqvEKhKroBGAvhW+qPHiQ==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-split-export-declaration": {
-      "version": "7.22.6",
-      "resolved": "https://registry.npmjs.org/@babel/helper-split-export-declaration/-/helper-split-export-declaration-7.22.6.tgz",
-      "integrity": "sha512-AsUnxuLhRYsisFiaJwvp1QF+I3KjD5FOxut14q/GzovUe6orHLesW2C7d754kRm53h5gqrz6sFl6sxc4BVtE/g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-split-export-declaration/-/helper-split-export-declaration-7.24.7.tgz",
+      "integrity": "sha512-oy5V7pD+UvfkEATUKvIjvIAH/xCzfsFVw7ygW2SI6NClZzquT+mwdTfgfdbUiceh6iQO0CHtCPsyze/MZ2YbAA==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.22.5"
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-string-parser": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.24.1.tgz",
-      "integrity": "sha512-2ofRCjnnA9y+wk8b9IAREroeUP02KHp431N2mhKniy2yKIDKpbrHv9eXwm8cBeWQYcJmzv5qKCu65P47eCF7CQ==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.24.8.tgz",
+      "integrity": "sha512-pO9KhhRcuUyGnJWwyEgnRJTSIZHiT+vMD0kPeD+so0l7mxkMT19g3pjY9GTnHySck/hDzq+dtW/4VgnMkippsQ==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-validator-identifier": {
-      "version": "7.22.20",
-      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.22.20.tgz",
-      "integrity": "sha512-Y4OZ+ytlatR8AI+8KZfKuL5urKp7qey08ha31L8b3BwewJAoJamTzyvxPR/5D+KkdJCGPq/+8TukHBlY10FX9A==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.24.7.tgz",
+      "integrity": "sha512-rR+PBcQ1SMQDDyF6X0wxtG8QyLCgUB0eRAGguqRLfkCA87l7yAP7ehq8SNj96OOGTO8OBV70KhuFYcIkHXOg0w==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-validator-option": {
-      "version": "7.23.5",
-      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.23.5.tgz",
-      "integrity": "sha512-85ttAOMLsr53VgXkTbkx8oA6YTfT4q7/HzXSLEYmjcSTJPMPQtvq1BD79Byep5xMUYbGRzEpDsjUf3dyp54IKw==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.24.8.tgz",
+      "integrity": "sha512-xb8t9tD1MHLungh/AIoWYN+gVHaB9kwlu8gffXGSt3FFEIT7RjS+xWbc2vUD1UTZdIpKj/ab3rdqJ7ufngyi2Q==",
       "dev": true,
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helper-wrap-function": {
-      "version": "7.22.20",
-      "resolved": "https://registry.npmjs.org/@babel/helper-wrap-function/-/helper-wrap-function-7.22.20.tgz",
-      "integrity": "sha512-pms/UwkOpnQe/PDAEdV/d7dVCoBbB+R4FvYoHGZz+4VPcg7RtYy2KP7S2lbuWM6FCSgob5wshfGESbC/hzNXZw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/helper-wrap-function/-/helper-wrap-function-7.24.7.tgz",
+      "integrity": "sha512-N9JIYk3TD+1vq/wn77YnJOqMtfWhNewNE+DJV4puD2X7Ew9J4JvrzrFDfTfyv5EgEXVy9/Wt8QiOErzEmv5Ifw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-function-name": "^7.22.5",
-        "@babel/template": "^7.22.15",
-        "@babel/types": "^7.22.19"
+        "@babel/helper-function-name": "^7.24.7",
+        "@babel/template": "^7.24.7",
+        "@babel/traverse": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/helpers": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.24.4.tgz",
-      "integrity": "sha512-FewdlZbSiwaVGlgT1DPANDuCHaDMiOo+D/IDYRFYjHOuv66xMSJ7fQwwODwRNAPkADIO/z1EoF/l2BCWlWABDw==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.24.8.tgz",
+      "integrity": "sha512-gV2265Nkcz7weJJfvDoAEVzC1e2OTDpkGbEsebse8koXUJUXPsCMi7sRo/+SPMuMZ9MtUPnGwITTnQnU5YjyaQ==",
       "dev": true,
       "dependencies": {
-        "@babel/template": "^7.24.0",
-        "@babel/traverse": "^7.24.1",
-        "@babel/types": "^7.24.0"
+        "@babel/template": "^7.24.7",
+        "@babel/types": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/highlight": {
-      "version": "7.24.2",
-      "resolved": "https://registry.npmjs.org/@babel/highlight/-/highlight-7.24.2.tgz",
-      "integrity": "sha512-Yac1ao4flkTxTteCDZLEvdxg2fZfz1v8M4QpaGypq/WPDqg3ijHYbDfs+LG5hvzSoqaSZ9/Z9lKSP3CjZjv+pA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/highlight/-/highlight-7.24.7.tgz",
+      "integrity": "sha512-EStJpq4OuY8xYfhGVXngigBJRWxftKX9ksiGDnmlY3o7B/V7KIAc9X4oiK87uPJSc/vs5L869bem5fhZa8caZw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-validator-identifier": "^7.22.20",
+        "@babel/helper-validator-identifier": "^7.24.7",
         "chalk": "^2.4.2",
         "js-tokens": "^4.0.0",
         "picocolors": "^1.0.0"
@@ -1089,9 +1058,9 @@
       }
     },
     "node_modules/@babel/parser": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.24.4.tgz",
-      "integrity": "sha512-zTvEBcghmeBma9QIGunWevvBAp4/Qu9Bdq+2k0Ot4fVMD6v3dsC9WOcRSKk7tRRyBM/53yKMJko9xOatGQAwSg==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.24.8.tgz",
+      "integrity": "sha512-WzfbgXOkGzZiXXCqk43kKwZjzwx4oulxZi3nq2TYL9mOjQv6kYwul9mz6ID36njuL7Xkp6nJEfok848Zj10j/w==",
       "dev": true,
       "bin": {
         "parser": "bin/babel-parser.js"
@@ -1100,13 +1069,29 @@
         "node": ">=6.0.0"
       }
     },
+    "node_modules/@babel/plugin-bugfix-firefox-class-in-computed-class-key": {
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-firefox-class-in-computed-class-key/-/plugin-bugfix-firefox-class-in-computed-class-key-7.24.7.tgz",
+      "integrity": "sha512-TiT1ss81W80eQsN+722OaeQMY/G4yTb4G9JrqeiDADs3N8lbPMGldWi9x8tyqCW5NLx1Jh2AvkE6r6QvEltMMQ==",
+      "dev": true,
+      "dependencies": {
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
+      },
+      "engines": {
+        "node": ">=6.9.0"
+      },
+      "peerDependencies": {
+        "@babel/core": "^7.0.0"
+      }
+    },
     "node_modules/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression/-/plugin-bugfix-safari-id-destructuring-collision-in-function-expression-7.24.1.tgz",
-      "integrity": "sha512-y4HqEnkelJIOQGd+3g1bTeKsA5c6qM7eOn7VggGVbBc0y8MLSKHacwcIE2PplNlQSj0PqS9rrXL/nkPVK+kUNg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression/-/plugin-bugfix-safari-id-destructuring-collision-in-function-expression-7.24.7.tgz",
+      "integrity": "sha512-unaQgZ/iRu/By6tsjMZzpeBZjChYfLYry6HrEXPoz3KmfF0sVBQ1l8zKMQ4xRGLWVsjuvB8nQfjNP/DcfEOCsg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1116,14 +1101,14 @@
       }
     },
     "node_modules/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining/-/plugin-bugfix-v8-spread-parameters-in-optional-chaining-7.24.1.tgz",
-      "integrity": "sha512-Hj791Ii4ci8HqnaKHAlLNs+zaLXb0EzSDhiAWp5VNlyvCNymYfacs64pxTxbH1znW/NcArSmwpmG9IKE/TUVVQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining/-/plugin-bugfix-v8-spread-parameters-in-optional-chaining-7.24.7.tgz",
+      "integrity": "sha512-+izXIbke1T33mY4MSNnrqhPXDz01WYhEf3yF5NbnUtkiNnm+XBZJl3kNfoK6NKmYlz/D07+l2GWVK/QfDkNCuQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-skip-transparent-expression-wrappers": "^7.22.5",
-        "@babel/plugin-transform-optional-chaining": "^7.24.1"
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7",
+        "@babel/plugin-transform-optional-chaining": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1133,13 +1118,13 @@
       }
     },
     "node_modules/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly/-/plugin-bugfix-v8-static-class-fields-redefine-readonly-7.24.1.tgz",
-      "integrity": "sha512-m9m/fXsXLiHfwdgydIFnpk+7jlVbnvlK5B2EKiPdLUb6WX654ZaaEWJUjk8TftRbZpK0XibovlLWX4KIZhV6jw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly/-/plugin-bugfix-v8-static-class-fields-redefine-readonly-7.24.7.tgz",
+      "integrity": "sha512-utA4HuR6F4Vvcr+o4DnjL8fCOlgRFGbeeBEGNg3ZTrLFw6VWG5XmUrvcQ0FjIYMU2ST4XcR2Wsp7t9qOAPnxMg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1224,12 +1209,12 @@
       }
     },
     "node_modules/@babel/plugin-syntax-import-assertions": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-assertions/-/plugin-syntax-import-assertions-7.24.1.tgz",
-      "integrity": "sha512-IuwnI5XnuF189t91XbxmXeCDz3qs6iDRO7GJ++wcfgeXNs/8FmIlKcpDSXNVyuLQxlwvskmI3Ct73wUODkJBlQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-assertions/-/plugin-syntax-import-assertions-7.24.7.tgz",
+      "integrity": "sha512-Ec3NRUMoi8gskrkBe3fNmEQfxDvY8bgfQpz6jlk/41kX9eUjvpyqWU7PBP/pLAvMaSQjbMNKJmvX57jP+M6bPg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1239,12 +1224,12 @@
       }
     },
     "node_modules/@babel/plugin-syntax-import-attributes": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-attributes/-/plugin-syntax-import-attributes-7.24.1.tgz",
-      "integrity": "sha512-zhQTMH0X2nVLnb04tz+s7AMuasX8U0FnpE+nHTOhSOINjWMnopoZTxtIKsd45n4GQ/HIZLyfIpoul8e2m0DnRA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-attributes/-/plugin-syntax-import-attributes-7.24.7.tgz",
+      "integrity": "sha512-hbX+lKKeUMGihnK8nvKqmXBInriT3GVjzXKFriV3YC6APGxMbP8RZNFwy91+hocLXq90Mta+HshoB31802bb8A==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1396,12 +1381,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-arrow-functions": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-arrow-functions/-/plugin-transform-arrow-functions-7.24.1.tgz",
-      "integrity": "sha512-ngT/3NkRhsaep9ck9uj2Xhv9+xB1zShY3tM3g6om4xxCELwCDN4g4Aq5dRn48+0hasAql7s2hdBOysCfNpr4fw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-arrow-functions/-/plugin-transform-arrow-functions-7.24.7.tgz",
+      "integrity": "sha512-Dt9LQs6iEY++gXUwY03DNFat5C2NbO48jj+j/bSAz6b3HgPs39qcPiYt77fDObIcFwj3/C2ICX9YMwGflUoSHQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1411,14 +1396,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-async-generator-functions": {
-      "version": "7.23.9",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-generator-functions/-/plugin-transform-async-generator-functions-7.23.9.tgz",
-      "integrity": "sha512-8Q3veQEDGe14dTYuwagbRtwxQDnytyg1JFu4/HwEMETeofocrB0U0ejBJIXoeG/t2oXZ8kzCyI0ZZfbT80VFNQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-generator-functions/-/plugin-transform-async-generator-functions-7.24.7.tgz",
+      "integrity": "sha512-o+iF77e3u7ZS4AoAuJvapz9Fm001PuD2V3Lp6OSE4FYQke+cSewYtnek+THqGRWyQloRCyvWL1OkyfNEl9vr/g==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-plugin-utils": "^7.22.5",
-        "@babel/helper-remap-async-to-generator": "^7.22.20",
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-remap-async-to-generator": "^7.24.7",
         "@babel/plugin-syntax-async-generators": "^7.8.4"
       },
       "engines": {
@@ -1429,14 +1414,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-async-to-generator": {
-      "version": "7.23.3",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-to-generator/-/plugin-transform-async-to-generator-7.23.3.tgz",
-      "integrity": "sha512-A7LFsKi4U4fomjqXJlZg/u0ft/n8/7n7lpffUP/ZULx/DtV9SGlNKZolHH6PE8Xl1ngCc0M11OaeZptXVkfKSw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-to-generator/-/plugin-transform-async-to-generator-7.24.7.tgz",
+      "integrity": "sha512-SQY01PcJfmQ+4Ash7NE+rpbLFbmqA2GPIgqzxfFTL4t1FKRq4zTms/7htKpoCUI9OcFYgzqfmCdH53s6/jn5fA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-module-imports": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.22.5",
-        "@babel/helper-remap-async-to-generator": "^7.22.20"
+        "@babel/helper-module-imports": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-remap-async-to-generator": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1446,12 +1431,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-block-scoped-functions": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoped-functions/-/plugin-transform-block-scoped-functions-7.24.1.tgz",
-      "integrity": "sha512-TWWC18OShZutrv9C6mye1xwtam+uNi2bnTOCBUd5sZxyHOiWbU6ztSROofIMrK84uweEZC219POICK/sTYwfgg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoped-functions/-/plugin-transform-block-scoped-functions-7.24.7.tgz",
+      "integrity": "sha512-yO7RAz6EsVQDaBH18IDJcMB1HnrUn2FJ/Jslc/WtPPWcjhpUJXU/rjbwmluzp7v/ZzWcEhTMXELnnsz8djWDwQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1461,12 +1446,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-block-scoping": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoping/-/plugin-transform-block-scoping-7.24.4.tgz",
-      "integrity": "sha512-nIFUZIpGKDf9O9ttyRXpHFpKC+X3Y5mtshZONuEUYBomAKoM4y029Jr+uB1bHGPhNmK8YXHevDtKDOLmtRrp6g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoping/-/plugin-transform-block-scoping-7.24.7.tgz",
+      "integrity": "sha512-Nd5CvgMbWc+oWzBsuaMcbwjJWAcp5qzrbg69SZdHSP7AMY0AbWFqFO0WTFCA1jxhMCwodRwvRec8k0QUbZk7RQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1476,13 +1461,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-class-properties": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-properties/-/plugin-transform-class-properties-7.24.1.tgz",
-      "integrity": "sha512-OMLCXi0NqvJfORTaPQBwqLXHhb93wkBKZ4aNwMl6WtehO7ar+cmp+89iPEQPqxAnxsOKTaMcs3POz3rKayJ72g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-properties/-/plugin-transform-class-properties-7.24.7.tgz",
+      "integrity": "sha512-vKbfawVYayKcSeSR5YYzzyXvsDFWU2mD8U5TFeXtbCPLFUqe7GyCgvO6XDHzje862ODrOwy6WCPmKeWHbCFJ4w==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-class-features-plugin": "^7.24.1",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-class-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1492,13 +1477,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-class-static-block": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-static-block/-/plugin-transform-class-static-block-7.24.4.tgz",
-      "integrity": "sha512-B8q7Pz870Hz/q9UgP8InNpY01CSLDSCyqX7zcRuv3FcPl87A2G17lASroHWaCtbdIcbYzOZ7kWmXFKbijMSmFg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-static-block/-/plugin-transform-class-static-block-7.24.7.tgz",
+      "integrity": "sha512-HMXK3WbBPpZQufbMG4B46A90PkuuhN9vBCb5T8+VAHqvAqvcLi+2cKoukcpmUYkszLhScU3l1iudhrks3DggRQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-class-features-plugin": "^7.24.4",
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-create-class-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-class-static-block": "^7.14.5"
       },
       "engines": {
@@ -1509,18 +1494,18 @@
       }
     },
     "node_modules/@babel/plugin-transform-classes": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-classes/-/plugin-transform-classes-7.24.1.tgz",
-      "integrity": "sha512-ZTIe3W7UejJd3/3R4p7ScyyOoafetUShSf4kCqV0O7F/RiHxVj/wRaRnQlrGwflvcehNA8M42HkAiEDYZu2F1Q==",
-      "dev": true,
-      "dependencies": {
-        "@babel/helper-annotate-as-pure": "^7.22.5",
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-function-name": "^7.23.0",
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-replace-supers": "^7.24.1",
-        "@babel/helper-split-export-declaration": "^7.22.6",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-classes/-/plugin-transform-classes-7.24.8.tgz",
+      "integrity": "sha512-VXy91c47uujj758ud9wx+OMgheXm4qJfyhj1P18YvlrQkNOSrwsteHk+EFS3OMGfhMhpZa0A+81eE7G4QC+3CA==",
+      "dev": true,
+      "dependencies": {
+        "@babel/helper-annotate-as-pure": "^7.24.7",
+        "@babel/helper-compilation-targets": "^7.24.8",
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-function-name": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-replace-supers": "^7.24.7",
+        "@babel/helper-split-export-declaration": "^7.24.7",
         "globals": "^11.1.0"
       },
       "engines": {
@@ -1531,13 +1516,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-computed-properties": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-computed-properties/-/plugin-transform-computed-properties-7.24.1.tgz",
-      "integrity": "sha512-5pJGVIUfJpOS+pAqBQd+QMaTD2vCL/HcePooON6pDpHgRp4gNRmzyHTPIkXntwKsq3ayUFVfJaIKPw2pOkOcTw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-computed-properties/-/plugin-transform-computed-properties-7.24.7.tgz",
+      "integrity": "sha512-25cS7v+707Gu6Ds2oY6tCkUwsJ9YIDbggd9+cu9jzzDgiNq7hR/8dkzxWfKWnTic26vsI3EsCXNd4iEB6e8esQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/template": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/template": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1547,12 +1532,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-destructuring": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-destructuring/-/plugin-transform-destructuring-7.24.1.tgz",
-      "integrity": "sha512-ow8jciWqNxR3RYbSNVuF4U2Jx130nwnBnhRw6N6h1bOejNkABmcI5X5oz29K4alWX7vf1C+o6gtKXikzRKkVdw==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-destructuring/-/plugin-transform-destructuring-7.24.8.tgz",
+      "integrity": "sha512-36e87mfY8TnRxc7yc6M9g9gOB7rKgSahqkIKwLpz4Ppk2+zC2Cy1is0uwtuSG6AE4zlTOUa+7JGz9jCJGLqQFQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1562,13 +1547,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-dotall-regex": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-dotall-regex/-/plugin-transform-dotall-regex-7.24.1.tgz",
-      "integrity": "sha512-p7uUxgSoZwZ2lPNMzUkqCts3xlp8n+o05ikjy7gbtFJSt9gdU88jAmtfmOxHM14noQXBxfgzf2yRWECiNVhTCw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-dotall-regex/-/plugin-transform-dotall-regex-7.24.7.tgz",
+      "integrity": "sha512-ZOA3W+1RRTSWvyqcMJDLqbchh7U4NRGqwRfFSVbOLS/ePIP4vHB5e8T8eXcuqyN1QkgKyj5wuW0lcS85v4CrSw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1578,12 +1563,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-duplicate-keys": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-duplicate-keys/-/plugin-transform-duplicate-keys-7.24.1.tgz",
-      "integrity": "sha512-msyzuUnvsjsaSaocV6L7ErfNsa5nDWL1XKNnDePLgmz+WdU4w/J8+AxBMrWfi9m4IxfL5sZQKUPQKDQeeAT6lA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-duplicate-keys/-/plugin-transform-duplicate-keys-7.24.7.tgz",
+      "integrity": "sha512-JdYfXyCRihAe46jUIliuL2/s0x0wObgwwiGxw/UbgJBr20gQBThrokO4nYKgWkD7uBaqM7+9x5TU7NkExZJyzw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1593,12 +1578,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-dynamic-import": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-dynamic-import/-/plugin-transform-dynamic-import-7.24.1.tgz",
-      "integrity": "sha512-av2gdSTyXcJVdI+8aFZsCAtR29xJt0S5tas+Ef8NvBNmD1a+N/3ecMLeMBgfcK+xzsjdLDT6oHt+DFPyeqUbDA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-dynamic-import/-/plugin-transform-dynamic-import-7.24.7.tgz",
+      "integrity": "sha512-sc3X26PhZQDb3JhORmakcbvkeInvxz+A8oda99lj7J60QRuPZvNAk9wQlTBS1ZynelDrDmTU4pw1tyc5d5ZMUg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-dynamic-import": "^7.8.3"
       },
       "engines": {
@@ -1609,13 +1594,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-exponentiation-operator": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-exponentiation-operator/-/plugin-transform-exponentiation-operator-7.24.1.tgz",
-      "integrity": "sha512-U1yX13dVBSwS23DEAqU+Z/PkwE9/m7QQy8Y9/+Tdb8UWYaGNDYwTLi19wqIAiROr8sXVum9A/rtiH5H0boUcTw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-exponentiation-operator/-/plugin-transform-exponentiation-operator-7.24.7.tgz",
+      "integrity": "sha512-Rqe/vSc9OYgDajNIK35u7ot+KeCoetqQYFXM4Epf7M7ez3lWlOjrDjrwMei6caCVhfdw+mIKD4cgdGNy5JQotQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-builder-binary-assignment-operator-visitor": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-builder-binary-assignment-operator-visitor": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1625,12 +1610,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-export-namespace-from": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-export-namespace-from/-/plugin-transform-export-namespace-from-7.24.1.tgz",
-      "integrity": "sha512-Ft38m/KFOyzKw2UaJFkWG9QnHPG/Q/2SkOrRk4pNBPg5IPZ+dOxcmkK5IyuBcxiNPyyYowPGUReyBvrvZs7IlQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-export-namespace-from/-/plugin-transform-export-namespace-from-7.24.7.tgz",
+      "integrity": "sha512-v0K9uNYsPL3oXZ/7F9NNIbAj2jv1whUEtyA6aujhekLs56R++JDQuzRcP2/z4WX5Vg/c5lE9uWZA0/iUoFhLTA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-export-namespace-from": "^7.8.3"
       },
       "engines": {
@@ -1641,13 +1626,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-for-of": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-for-of/-/plugin-transform-for-of-7.24.1.tgz",
-      "integrity": "sha512-OxBdcnF04bpdQdR3i4giHZNZQn7cm8RQKcSwA17wAAqEELo1ZOwp5FFgeptWUQXFyT9kwHo10aqqauYkRZPCAg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-for-of/-/plugin-transform-for-of-7.24.7.tgz",
+      "integrity": "sha512-wo9ogrDG1ITTTBsy46oGiN1dS9A7MROBTcYsfS8DtsImMkHk9JXJ3EWQM6X2SUw4x80uGPlwj0o00Uoc6nEE3g==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-skip-transparent-expression-wrappers": "^7.22.5"
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1657,14 +1642,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-function-name": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-function-name/-/plugin-transform-function-name-7.24.1.tgz",
-      "integrity": "sha512-BXmDZpPlh7jwicKArQASrj8n22/w6iymRnvHYYd2zO30DbE277JO20/7yXJT3QxDPtiQiOxQBbZH4TpivNXIxA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-function-name/-/plugin-transform-function-name-7.24.7.tgz",
+      "integrity": "sha512-U9FcnA821YoILngSmYkW6FjyQe2TyZD5pHt4EVIhmcTkrJw/3KqcrRSxuOo5tFZJi7TE19iDyI1u+weTI7bn2w==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-function-name": "^7.23.0",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-compilation-targets": "^7.24.7",
+        "@babel/helper-function-name": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1674,12 +1659,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-json-strings": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-json-strings/-/plugin-transform-json-strings-7.24.1.tgz",
-      "integrity": "sha512-U7RMFmRvoasscrIFy5xA4gIp8iWnWubnKkKuUGJjsuOH7GfbMkB+XZzeslx2kLdEGdOJDamEmCqOks6e8nv8DQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-json-strings/-/plugin-transform-json-strings-7.24.7.tgz",
+      "integrity": "sha512-2yFnBGDvRuxAaE/f0vfBKvtnvvqU8tGpMHqMNpTN2oWMKIR3NqFkjaAgGwawhqK/pIN2T3XdjGPdaG0vDhOBGw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-json-strings": "^7.8.3"
       },
       "engines": {
@@ -1690,12 +1675,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-literals": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-literals/-/plugin-transform-literals-7.24.1.tgz",
-      "integrity": "sha512-zn9pwz8U7nCqOYIiBaOxoQOtYmMODXTJnkxG4AtX8fPmnCRYWBOHD0qcpwS9e2VDSp1zNJYpdnFMIKb8jmwu6g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-literals/-/plugin-transform-literals-7.24.7.tgz",
+      "integrity": "sha512-vcwCbb4HDH+hWi8Pqenwnjy+UiklO4Kt1vfspcQYFhJdpthSnW8XvWGyDZWKNVrVbVViI/S7K9PDJZiUmP2fYQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1705,12 +1690,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-logical-assignment-operators": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-logical-assignment-operators/-/plugin-transform-logical-assignment-operators-7.24.1.tgz",
-      "integrity": "sha512-OhN6J4Bpz+hIBqItTeWJujDOfNP+unqv/NJgyhlpSqgBTPm37KkMmZV6SYcOj+pnDbdcl1qRGV/ZiIjX9Iy34w==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-logical-assignment-operators/-/plugin-transform-logical-assignment-operators-7.24.7.tgz",
+      "integrity": "sha512-4D2tpwlQ1odXmTEIFWy9ELJcZHqrStlzK/dAOWYyxX3zT0iXQB6banjgeOJQXzEc4S0E0a5A+hahxPaEFYftsw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-logical-assignment-operators": "^7.10.4"
       },
       "engines": {
@@ -1721,12 +1706,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-member-expression-literals": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-member-expression-literals/-/plugin-transform-member-expression-literals-7.24.1.tgz",
-      "integrity": "sha512-4ojai0KysTWXzHseJKa1XPNXKRbuUrhkOPY4rEGeR+7ChlJVKxFa3H3Bz+7tWaGKgJAXUWKOGmltN+u9B3+CVg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-member-expression-literals/-/plugin-transform-member-expression-literals-7.24.7.tgz",
+      "integrity": "sha512-T/hRC1uqrzXMKLQ6UCwMT85S3EvqaBXDGf0FaMf4446Qx9vKwlghvee0+uuZcDUCZU5RuNi4781UQ7R308zzBw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1736,13 +1721,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-modules-amd": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-amd/-/plugin-transform-modules-amd-7.24.1.tgz",
-      "integrity": "sha512-lAxNHi4HVtjnHd5Rxg3D5t99Xm6H7b04hUS7EHIXcUl2EV4yl1gWdqZrNzXnSrHveL9qMdbODlLF55mvgjAfaQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-amd/-/plugin-transform-modules-amd-7.24.7.tgz",
+      "integrity": "sha512-9+pB1qxV3vs/8Hdmz/CulFB8w2tuu6EB94JZFsjdqxQokwGa9Unap7Bo2gGBGIvPmDIVvQrom7r5m/TCDMURhg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-module-transforms": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1752,14 +1737,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-modules-commonjs": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-commonjs/-/plugin-transform-modules-commonjs-7.24.1.tgz",
-      "integrity": "sha512-szog8fFTUxBfw0b98gEWPaEqF42ZUD/T3bkynW/wtgx2p/XCP55WEsb+VosKceRSd6njipdZvNogqdtI4Q0chw==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-commonjs/-/plugin-transform-modules-commonjs-7.24.8.tgz",
+      "integrity": "sha512-WHsk9H8XxRs3JXKWFiqtQebdh9b/pTk4EgueygFzYlTKAg0Ud985mSevdNjdXdFBATSKVJGQXP1tv6aGbssLKA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-simple-access": "^7.22.5"
+        "@babel/helper-module-transforms": "^7.24.8",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-simple-access": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1769,15 +1754,15 @@
       }
     },
     "node_modules/@babel/plugin-transform-modules-systemjs": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-systemjs/-/plugin-transform-modules-systemjs-7.24.1.tgz",
-      "integrity": "sha512-mqQ3Zh9vFO1Tpmlt8QPnbwGHzNz3lpNEMxQb1kAemn/erstyqw1r9KeOlOfo3y6xAnFEcOv2tSyrXfmMk+/YZA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-systemjs/-/plugin-transform-modules-systemjs-7.24.7.tgz",
+      "integrity": "sha512-GYQE0tW7YoaN13qFh3O1NCY4MPkUiAH3fiF7UcV/I3ajmDKEdG3l+UOcbAm4zUE3gnvUU+Eni7XrVKo9eO9auw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-hoist-variables": "^7.22.5",
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-validator-identifier": "^7.22.20"
+        "@babel/helper-hoist-variables": "^7.24.7",
+        "@babel/helper-module-transforms": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-validator-identifier": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1787,13 +1772,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-modules-umd": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-umd/-/plugin-transform-modules-umd-7.24.1.tgz",
-      "integrity": "sha512-tuA3lpPj+5ITfcCluy6nWonSL7RvaG0AOTeAuvXqEKS34lnLzXpDb0dcP6K8jD0zWZFNDVly90AGFJPnm4fOYg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-modules-umd/-/plugin-transform-modules-umd-7.24.7.tgz",
+      "integrity": "sha512-3aytQvqJ/h9z4g8AsKPLvD4Zqi2qT+L3j7XoFFu1XBlZWEl2/1kWnhmAbxpLgPrHSY0M6UA02jyTiwUVtiKR6A==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-module-transforms": "^7.23.3",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-module-transforms": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1803,13 +1788,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-named-capturing-groups-regex": {
-      "version": "7.22.5",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-named-capturing-groups-regex/-/plugin-transform-named-capturing-groups-regex-7.22.5.tgz",
-      "integrity": "sha512-YgLLKmS3aUBhHaxp5hi1WJTgOUb/NCuDHzGT9z9WTt3YG+CPRhJs6nprbStx6DnWM4dh6gt7SU3sZodbZ08adQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-named-capturing-groups-regex/-/plugin-transform-named-capturing-groups-regex-7.24.7.tgz",
+      "integrity": "sha512-/jr7h/EWeJtk1U/uz2jlsCioHkZk1JJZVcc8oQsJ1dUlaJD83f4/6Zeh2aHt9BIFokHIsSeDfhUmju0+1GPd6g==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.22.5",
-        "@babel/helper-plugin-utils": "^7.22.5"
+        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1819,12 +1804,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-new-target": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-new-target/-/plugin-transform-new-target-7.24.1.tgz",
-      "integrity": "sha512-/rurytBM34hYy0HKZQyA0nHbQgQNFm4Q/BOc9Hflxi2X3twRof7NaE5W46j4kQitm7SvACVRXsa6N/tSZxvPug==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-new-target/-/plugin-transform-new-target-7.24.7.tgz",
+      "integrity": "sha512-RNKwfRIXg4Ls/8mMTza5oPF5RkOW8Wy/WgMAp1/F1yZ8mMbtwXW+HDoJiOsagWrAhI5f57Vncrmr9XeT4CVapA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1834,12 +1819,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-nullish-coalescing-operator": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-nullish-coalescing-operator/-/plugin-transform-nullish-coalescing-operator-7.24.1.tgz",
-      "integrity": "sha512-iQ+caew8wRrhCikO5DrUYx0mrmdhkaELgFa+7baMcVuhxIkN7oxt06CZ51D65ugIb1UWRQ8oQe+HXAVM6qHFjw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-nullish-coalescing-operator/-/plugin-transform-nullish-coalescing-operator-7.24.7.tgz",
+      "integrity": "sha512-Ts7xQVk1OEocqzm8rHMXHlxvsfZ0cEF2yomUqpKENHWMF4zKk175Y4q8H5knJes6PgYad50uuRmt3UJuhBw8pQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-nullish-coalescing-operator": "^7.8.3"
       },
       "engines": {
@@ -1850,12 +1835,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-numeric-separator": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-numeric-separator/-/plugin-transform-numeric-separator-7.24.1.tgz",
-      "integrity": "sha512-7GAsGlK4cNL2OExJH1DzmDeKnRv/LXq0eLUSvudrehVA5Rgg4bIrqEUW29FbKMBRT0ztSqisv7kjP+XIC4ZMNw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-numeric-separator/-/plugin-transform-numeric-separator-7.24.7.tgz",
+      "integrity": "sha512-e6q1TiVUzvH9KRvicuxdBTUj4AdKSRwzIyFFnfnezpCfP2/7Qmbb8qbU2j7GODbl4JMkblitCQjKYUaX/qkkwA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-numeric-separator": "^7.10.4"
       },
       "engines": {
@@ -1866,15 +1851,15 @@
       }
     },
     "node_modules/@babel/plugin-transform-object-rest-spread": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-object-rest-spread/-/plugin-transform-object-rest-spread-7.24.1.tgz",
-      "integrity": "sha512-XjD5f0YqOtebto4HGISLNfiNMTTs6tbkFf2TOqJlYKYmbo+mN9Dnpl4SRoofiziuOWMIyq3sZEUqLo3hLITFEA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-object-rest-spread/-/plugin-transform-object-rest-spread-7.24.7.tgz",
+      "integrity": "sha512-4QrHAr0aXQCEFni2q4DqKLD31n2DL+RxcwnNjDFkSG0eNQ/xCavnRkfCUjsyqGC2OviNJvZOF/mQqZBw7i2C5Q==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-compilation-targets": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-object-rest-spread": "^7.8.3",
-        "@babel/plugin-transform-parameters": "^7.24.1"
+        "@babel/plugin-transform-parameters": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1884,13 +1869,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-object-super": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-object-super/-/plugin-transform-object-super-7.24.1.tgz",
-      "integrity": "sha512-oKJqR3TeI5hSLRxudMjFQ9re9fBVUU0GICqM3J1mi8MqlhVr6hC/ZN4ttAyMuQR6EZZIY6h/exe5swqGNNIkWQ==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-object-super/-/plugin-transform-object-super-7.24.7.tgz",
+      "integrity": "sha512-A/vVLwN6lBrMFmMDmPPz0jnE6ZGx7Jq7d6sT/Ev4H65RER6pZ+kczlf1DthF5N0qaPHBsI7UXiE8Zy66nmAovg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-replace-supers": "^7.24.1"
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-replace-supers": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1900,12 +1885,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-optional-catch-binding": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-optional-catch-binding/-/plugin-transform-optional-catch-binding-7.24.1.tgz",
-      "integrity": "sha512-oBTH7oURV4Y+3EUrf6cWn1OHio3qG/PVwO5J03iSJmBg6m2EhKjkAu/xuaXaYwWW9miYtvbWv4LNf0AmR43LUA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-optional-catch-binding/-/plugin-transform-optional-catch-binding-7.24.7.tgz",
+      "integrity": "sha512-uLEndKqP5BfBbC/5jTwPxLh9kqPWWgzN/f8w6UwAIirAEqiIVJWWY312X72Eub09g5KF9+Zn7+hT7sDxmhRuKA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-optional-catch-binding": "^7.8.3"
       },
       "engines": {
@@ -1916,13 +1901,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-optional-chaining": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-optional-chaining/-/plugin-transform-optional-chaining-7.24.1.tgz",
-      "integrity": "sha512-n03wmDt+987qXwAgcBlnUUivrZBPZ8z1plL0YvgQalLm+ZE5BMhGm94jhxXtA1wzv1Cu2aaOv1BM9vbVttrzSg==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-optional-chaining/-/plugin-transform-optional-chaining-7.24.8.tgz",
+      "integrity": "sha512-5cTOLSMs9eypEy8JUVvIKOu6NgvbJMnpG62VpIHrTmROdQ+L5mDAaI40g25k5vXti55JWNX5jCkq3HZxXBQANw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-skip-transparent-expression-wrappers": "^7.22.5",
+        "@babel/helper-plugin-utils": "^7.24.8",
+        "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7",
         "@babel/plugin-syntax-optional-chaining": "^7.8.3"
       },
       "engines": {
@@ -1933,12 +1918,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-parameters": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-parameters/-/plugin-transform-parameters-7.24.1.tgz",
-      "integrity": "sha512-8Jl6V24g+Uw5OGPeWNKrKqXPDw2YDjLc53ojwfMcKwlEoETKU9rU0mHUtcg9JntWI/QYzGAXNWEcVHZ+fR+XXg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-parameters/-/plugin-transform-parameters-7.24.7.tgz",
+      "integrity": "sha512-yGWW5Rr+sQOhK0Ot8hjDJuxU3XLRQGflvT4lhlSY0DFvdb3TwKaY26CJzHtYllU0vT9j58hc37ndFPsqT1SrzA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1948,13 +1933,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-private-methods": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-methods/-/plugin-transform-private-methods-7.24.1.tgz",
-      "integrity": "sha512-tGvisebwBO5em4PaYNqt4fkw56K2VALsAbAakY0FjTYqJp7gfdrgr7YX76Or8/cpik0W6+tj3rZ0uHU9Oil4tw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-methods/-/plugin-transform-private-methods-7.24.7.tgz",
+      "integrity": "sha512-COTCOkG2hn4JKGEKBADkA8WNb35TGkkRbI5iT845dB+NyqgO8Hn+ajPbSnIQznneJTa3d30scb6iz/DhH8GsJQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-class-features-plugin": "^7.24.1",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-class-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1964,14 +1949,14 @@
       }
     },
     "node_modules/@babel/plugin-transform-private-property-in-object": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-property-in-object/-/plugin-transform-private-property-in-object-7.24.1.tgz",
-      "integrity": "sha512-pTHxDVa0BpUbvAgX3Gat+7cSciXqUcY9j2VZKTbSB6+VQGpNgNO9ailxTGHSXlqOnX1Hcx1Enme2+yv7VqP9bg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-private-property-in-object/-/plugin-transform-private-property-in-object-7.24.7.tgz",
+      "integrity": "sha512-9z76mxwnwFxMyxZWEgdgECQglF2Q7cFLm0kMf8pGwt+GSJsY0cONKj/UuO4bOH0w/uAel3ekS4ra5CEAyJRmDA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-annotate-as-pure": "^7.22.5",
-        "@babel/helper-create-class-features-plugin": "^7.24.1",
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-annotate-as-pure": "^7.24.7",
+        "@babel/helper-create-class-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "@babel/plugin-syntax-private-property-in-object": "^7.14.5"
       },
       "engines": {
@@ -1982,12 +1967,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-property-literals": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-property-literals/-/plugin-transform-property-literals-7.24.1.tgz",
-      "integrity": "sha512-LetvD7CrHmEx0G442gOomRr66d7q8HzzGGr4PMHGr+5YIm6++Yke+jxj246rpvsbyhJwCLxcTn6zW1P1BSenqA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-property-literals/-/plugin-transform-property-literals-7.24.7.tgz",
+      "integrity": "sha512-EMi4MLQSHfd2nrCqQEWxFdha2gBCqU4ZcCng4WBGZ5CJL4bBRW0ptdqqDdeirGZcpALazVVNJqRmsO8/+oNCBA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -1997,12 +1982,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-regenerator": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-regenerator/-/plugin-transform-regenerator-7.24.1.tgz",
-      "integrity": "sha512-sJwZBCzIBE4t+5Q4IGLaaun5ExVMRY0lYwos/jNecjMrVCygCdph3IKv0tkP5Fc87e/1+bebAmEAGBfnRD+cnw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-regenerator/-/plugin-transform-regenerator-7.24.7.tgz",
+      "integrity": "sha512-lq3fvXPdimDrlg6LWBoqj+r/DEWgONuwjuOuQCSYgRroXDH/IdM1C0IZf59fL5cHLpjEH/O6opIRBbqv7ELnuA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
+        "@babel/helper-plugin-utils": "^7.24.7",
         "regenerator-transform": "^0.15.2"
       },
       "engines": {
@@ -2013,12 +1998,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-reserved-words": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-reserved-words/-/plugin-transform-reserved-words-7.24.1.tgz",
-      "integrity": "sha512-JAclqStUfIwKN15HrsQADFgeZt+wexNQ0uLhuqvqAUFoqPMjEcFCYZBhq0LUdz6dZK/mD+rErhW71fbx8RYElg==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-reserved-words/-/plugin-transform-reserved-words-7.24.7.tgz",
+      "integrity": "sha512-0DUq0pHcPKbjFZCfTss/pGkYMfy3vFWydkUBd9r0GHpIyfs2eCDENvqadMycRS9wZCXR41wucAfJHJmwA0UmoQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2028,16 +2013,16 @@
       }
     },
     "node_modules/@babel/plugin-transform-runtime": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-runtime/-/plugin-transform-runtime-7.24.0.tgz",
-      "integrity": "sha512-zc0GA5IitLKJrSfXlXmp8KDqLrnGECK7YRfQBmEKg1NmBOQ7e+KuclBEKJgzifQeUYLdNiAw4B4bjyvzWVLiSA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-runtime/-/plugin-transform-runtime-7.24.7.tgz",
+      "integrity": "sha512-YqXjrk4C+a1kZjewqt+Mmu2UuV1s07y8kqcUf4qYLnoqemhR4gRQikhdAhSVJioMjVTu6Mo6pAbaypEA3jY6fw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-module-imports": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "babel-plugin-polyfill-corejs2": "^0.4.8",
-        "babel-plugin-polyfill-corejs3": "^0.9.0",
-        "babel-plugin-polyfill-regenerator": "^0.5.5",
+        "@babel/helper-module-imports": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "babel-plugin-polyfill-corejs2": "^0.4.10",
+        "babel-plugin-polyfill-corejs3": "^0.10.1",
+        "babel-plugin-polyfill-regenerator": "^0.6.1",
         "semver": "^6.3.1"
       },
       "engines": {
@@ -2057,12 +2042,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-shorthand-properties": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-shorthand-properties/-/plugin-transform-shorthand-properties-7.24.1.tgz",
-      "integrity": "sha512-LyjVB1nsJ6gTTUKRjRWx9C1s9hE7dLfP/knKdrfeH9UPtAGjYGgxIbFfx7xyLIEWs7Xe1Gnf8EWiUqfjLhInZA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-shorthand-properties/-/plugin-transform-shorthand-properties-7.24.7.tgz",
+      "integrity": "sha512-KsDsevZMDsigzbA09+vacnLpmPH4aWjcZjXdyFKGzpplxhbeB4wYtury3vglQkg6KM/xEPKt73eCjPPf1PgXBA==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2072,13 +2057,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-spread": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-spread/-/plugin-transform-spread-7.24.1.tgz",
-      "integrity": "sha512-KjmcIM+fxgY+KxPVbjelJC6hrH1CgtPmTvdXAfn3/a9CnWGSTY7nH4zm5+cjmWJybdcPSsD0++QssDsjcpe47g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-spread/-/plugin-transform-spread-7.24.7.tgz",
+      "integrity": "sha512-x96oO0I09dgMDxJaANcRyD4ellXFLLiWhuwDxKZX5g2rWP1bTPkBSwCYv96VDXVT1bD9aPj8tppr5ITIh8hBng==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-skip-transparent-expression-wrappers": "^7.22.5"
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-skip-transparent-expression-wrappers": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2088,12 +2073,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-sticky-regex": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-sticky-regex/-/plugin-transform-sticky-regex-7.24.1.tgz",
-      "integrity": "sha512-9v0f1bRXgPVcPrngOQvLXeGNNVLc8UjMVfebo9ka0WF3/7+aVUHmaJVT3sa0XCzEFioPfPHZiOcYG9qOsH63cw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-sticky-regex/-/plugin-transform-sticky-regex-7.24.7.tgz",
+      "integrity": "sha512-kHPSIJc9v24zEml5geKg9Mjx5ULpfncj0wRpYtxbvKyTtHCYDkVE3aHQ03FrpEo4gEe2vrJJS1Y9CJTaThA52g==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2103,12 +2088,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-template-literals": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-template-literals/-/plugin-transform-template-literals-7.24.1.tgz",
-      "integrity": "sha512-WRkhROsNzriarqECASCNu/nojeXCDTE/F2HmRgOzi7NGvyfYGq1NEjKBK3ckLfRgGc6/lPAqP0vDOSw3YtG34g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-template-literals/-/plugin-transform-template-literals-7.24.7.tgz",
+      "integrity": "sha512-AfDTQmClklHCOLxtGoP7HkeMw56k1/bTQjwsfhL6pppo/M4TOBSq+jjBUBLmV/4oeFg4GWMavIl44ZeCtmmZTw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2118,12 +2103,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-typeof-symbol": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-typeof-symbol/-/plugin-transform-typeof-symbol-7.24.1.tgz",
-      "integrity": "sha512-CBfU4l/A+KruSUoW+vTQthwcAdwuqbpRNB8HQKlZABwHRhsdHZ9fezp4Sn18PeAlYxTNiLMlx4xUBV3AWfg1BA==",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-typeof-symbol/-/plugin-transform-typeof-symbol-7.24.8.tgz",
+      "integrity": "sha512-adNTUpDCVnmAE58VEqKlAA6ZBlNkMnWD0ZcW76lyNFN3MJniyGFZfNwERVk8Ap56MCnXztmDr19T4mPTztcuaw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.8"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2133,12 +2118,12 @@
       }
     },
     "node_modules/@babel/plugin-transform-unicode-escapes": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-escapes/-/plugin-transform-unicode-escapes-7.24.1.tgz",
-      "integrity": "sha512-RlkVIcWT4TLI96zM660S877E7beKlQw7Ig+wqkKBiWfj0zH5Q4h50q6er4wzZKRNSYpfo6ILJ+hrJAGSX2qcNw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-escapes/-/plugin-transform-unicode-escapes-7.24.7.tgz",
+      "integrity": "sha512-U3ap1gm5+4edc2Q/P+9VrBNhGkfnf+8ZqppY71Bo/pzZmXhhLdqgaUl6cuB07O1+AQJtCLfaOmswiNbSQ9ivhw==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2148,13 +2133,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-unicode-property-regex": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-property-regex/-/plugin-transform-unicode-property-regex-7.24.1.tgz",
-      "integrity": "sha512-Ss4VvlfYV5huWApFsF8/Sq0oXnGO+jB+rijFEFugTd3cwSObUSnUi88djgR5528Csl0uKlrI331kRqe56Ov2Ng==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-property-regex/-/plugin-transform-unicode-property-regex-7.24.7.tgz",
+      "integrity": "sha512-uH2O4OV5M9FZYQrwc7NdVmMxQJOCCzFeYudlZSzUAHRFeOujQefa92E74TQDVskNHCzOXoigEuoyzHDhaEaK5w==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2164,13 +2149,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-unicode-regex": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-regex/-/plugin-transform-unicode-regex-7.24.1.tgz",
-      "integrity": "sha512-2A/94wgZgxfTsiLaQ2E36XAOdcZmGAaEEgVmxQWwZXWkGhvoHbaqXcKnU8zny4ycpu3vNqg0L/PcCiYtHtA13g==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-regex/-/plugin-transform-unicode-regex-7.24.7.tgz",
+      "integrity": "sha512-hlQ96MBZSAXUq7ltkjtu3FJCCSMx/j629ns3hA3pXnBXjanNP0LHi+JpPeA81zaWgVK1VGH95Xuy7u0RyQ8kMg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2180,13 +2165,13 @@
       }
     },
     "node_modules/@babel/plugin-transform-unicode-sets-regex": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-sets-regex/-/plugin-transform-unicode-sets-regex-7.24.1.tgz",
-      "integrity": "sha512-fqj4WuzzS+ukpgerpAoOnMfQXwUHFxXUZUE84oL2Kao2N8uSlvcpnAidKASgsNgzZHBsHWvcm8s9FPWUhAb8fA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-unicode-sets-regex/-/plugin-transform-unicode-sets-regex-7.24.7.tgz",
+      "integrity": "sha512-2G8aAvF4wy1w/AGZkemprdGMRg5o6zPNhbHVImRz3lss55TYCBd6xStN19rt8XJHq20sqV0JbyWjOWwQRwV/wg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-create-regexp-features-plugin": "^7.22.15",
-        "@babel/helper-plugin-utils": "^7.24.0"
+        "@babel/helper-create-regexp-features-plugin": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
@@ -2196,26 +2181,27 @@
       }
     },
     "node_modules/@babel/preset-env": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/preset-env/-/preset-env-7.24.0.tgz",
-      "integrity": "sha512-ZxPEzV9IgvGn73iK0E6VB9/95Nd7aMFpbE0l8KQFDG70cOV9IxRP7Y2FUPmlK0v6ImlLqYX50iuZ3ZTVhOF2lA==",
-      "dev": true,
-      "dependencies": {
-        "@babel/compat-data": "^7.23.5",
-        "@babel/helper-compilation-targets": "^7.23.6",
-        "@babel/helper-plugin-utils": "^7.24.0",
-        "@babel/helper-validator-option": "^7.23.5",
-        "@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": "^7.23.3",
-        "@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining": "^7.23.3",
-        "@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": "^7.23.7",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/preset-env/-/preset-env-7.24.7.tgz",
+      "integrity": "sha512-1YZNsc+y6cTvWlDHidMBsQZrZfEFjRIo/BZCT906PMdzOyXtSLTgqGdrpcuTDCXyd11Am5uQULtDIcCfnTc8fQ==",
+      "dev": true,
+      "dependencies": {
+        "@babel/compat-data": "^7.24.7",
+        "@babel/helper-compilation-targets": "^7.24.7",
+        "@babel/helper-plugin-utils": "^7.24.7",
+        "@babel/helper-validator-option": "^7.24.7",
+        "@babel/plugin-bugfix-firefox-class-in-computed-class-key": "^7.24.7",
+        "@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": "^7.24.7",
+        "@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining": "^7.24.7",
+        "@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": "^7.24.7",
         "@babel/plugin-proposal-private-property-in-object": "7.21.0-placeholder-for-preset-env.2",
         "@babel/plugin-syntax-async-generators": "^7.8.4",
         "@babel/plugin-syntax-class-properties": "^7.12.13",
         "@babel/plugin-syntax-class-static-block": "^7.14.5",
         "@babel/plugin-syntax-dynamic-import": "^7.8.3",
         "@babel/plugin-syntax-export-namespace-from": "^7.8.3",
-        "@babel/plugin-syntax-import-assertions": "^7.23.3",
-        "@babel/plugin-syntax-import-attributes": "^7.23.3",
+        "@babel/plugin-syntax-import-assertions": "^7.24.7",
+        "@babel/plugin-syntax-import-attributes": "^7.24.7",
         "@babel/plugin-syntax-import-meta": "^7.10.4",
         "@babel/plugin-syntax-json-strings": "^7.8.3",
         "@babel/plugin-syntax-logical-assignment-operators": "^7.10.4",
@@ -2227,58 +2213,58 @@
         "@babel/plugin-syntax-private-property-in-object": "^7.14.5",
         "@babel/plugin-syntax-top-level-await": "^7.14.5",
         "@babel/plugin-syntax-unicode-sets-regex": "^7.18.6",
-        "@babel/plugin-transform-arrow-functions": "^7.23.3",
-        "@babel/plugin-transform-async-generator-functions": "^7.23.9",
-        "@babel/plugin-transform-async-to-generator": "^7.23.3",
-        "@babel/plugin-transform-block-scoped-functions": "^7.23.3",
-        "@babel/plugin-transform-block-scoping": "^7.23.4",
-        "@babel/plugin-transform-class-properties": "^7.23.3",
-        "@babel/plugin-transform-class-static-block": "^7.23.4",
-        "@babel/plugin-transform-classes": "^7.23.8",
-        "@babel/plugin-transform-computed-properties": "^7.23.3",
-        "@babel/plugin-transform-destructuring": "^7.23.3",
-        "@babel/plugin-transform-dotall-regex": "^7.23.3",
-        "@babel/plugin-transform-duplicate-keys": "^7.23.3",
-        "@babel/plugin-transform-dynamic-import": "^7.23.4",
-        "@babel/plugin-transform-exponentiation-operator": "^7.23.3",
-        "@babel/plugin-transform-export-namespace-from": "^7.23.4",
-        "@babel/plugin-transform-for-of": "^7.23.6",
-        "@babel/plugin-transform-function-name": "^7.23.3",
-        "@babel/plugin-transform-json-strings": "^7.23.4",
-        "@babel/plugin-transform-literals": "^7.23.3",
-        "@babel/plugin-transform-logical-assignment-operators": "^7.23.4",
-        "@babel/plugin-transform-member-expression-literals": "^7.23.3",
-        "@babel/plugin-transform-modules-amd": "^7.23.3",
-        "@babel/plugin-transform-modules-commonjs": "^7.23.3",
-        "@babel/plugin-transform-modules-systemjs": "^7.23.9",
-        "@babel/plugin-transform-modules-umd": "^7.23.3",
-        "@babel/plugin-transform-named-capturing-groups-regex": "^7.22.5",
-        "@babel/plugin-transform-new-target": "^7.23.3",
-        "@babel/plugin-transform-nullish-coalescing-operator": "^7.23.4",
-        "@babel/plugin-transform-numeric-separator": "^7.23.4",
-        "@babel/plugin-transform-object-rest-spread": "^7.24.0",
-        "@babel/plugin-transform-object-super": "^7.23.3",
-        "@babel/plugin-transform-optional-catch-binding": "^7.23.4",
-        "@babel/plugin-transform-optional-chaining": "^7.23.4",
-        "@babel/plugin-transform-parameters": "^7.23.3",
-        "@babel/plugin-transform-private-methods": "^7.23.3",
-        "@babel/plugin-transform-private-property-in-object": "^7.23.4",
-        "@babel/plugin-transform-property-literals": "^7.23.3",
-        "@babel/plugin-transform-regenerator": "^7.23.3",
-        "@babel/plugin-transform-reserved-words": "^7.23.3",
-        "@babel/plugin-transform-shorthand-properties": "^7.23.3",
-        "@babel/plugin-transform-spread": "^7.23.3",
-        "@babel/plugin-transform-sticky-regex": "^7.23.3",
-        "@babel/plugin-transform-template-literals": "^7.23.3",
-        "@babel/plugin-transform-typeof-symbol": "^7.23.3",
-        "@babel/plugin-transform-unicode-escapes": "^7.23.3",
-        "@babel/plugin-transform-unicode-property-regex": "^7.23.3",
-        "@babel/plugin-transform-unicode-regex": "^7.23.3",
-        "@babel/plugin-transform-unicode-sets-regex": "^7.23.3",
+        "@babel/plugin-transform-arrow-functions": "^7.24.7",
+        "@babel/plugin-transform-async-generator-functions": "^7.24.7",
+        "@babel/plugin-transform-async-to-generator": "^7.24.7",
+        "@babel/plugin-transform-block-scoped-functions": "^7.24.7",
+        "@babel/plugin-transform-block-scoping": "^7.24.7",
+        "@babel/plugin-transform-class-properties": "^7.24.7",
+        "@babel/plugin-transform-class-static-block": "^7.24.7",
+        "@babel/plugin-transform-classes": "^7.24.7",
+        "@babel/plugin-transform-computed-properties": "^7.24.7",
+        "@babel/plugin-transform-destructuring": "^7.24.7",
+        "@babel/plugin-transform-dotall-regex": "^7.24.7",
+        "@babel/plugin-transform-duplicate-keys": "^7.24.7",
+        "@babel/plugin-transform-dynamic-import": "^7.24.7",
+        "@babel/plugin-transform-exponentiation-operator": "^7.24.7",
+        "@babel/plugin-transform-export-namespace-from": "^7.24.7",
+        "@babel/plugin-transform-for-of": "^7.24.7",
+        "@babel/plugin-transform-function-name": "^7.24.7",
+        "@babel/plugin-transform-json-strings": "^7.24.7",
+        "@babel/plugin-transform-literals": "^7.24.7",
+        "@babel/plugin-transform-logical-assignment-operators": "^7.24.7",
+        "@babel/plugin-transform-member-expression-literals": "^7.24.7",
+        "@babel/plugin-transform-modules-amd": "^7.24.7",
+        "@babel/plugin-transform-modules-commonjs": "^7.24.7",
+        "@babel/plugin-transform-modules-systemjs": "^7.24.7",
+        "@babel/plugin-transform-modules-umd": "^7.24.7",
+        "@babel/plugin-transform-named-capturing-groups-regex": "^7.24.7",
+        "@babel/plugin-transform-new-target": "^7.24.7",
+        "@babel/plugin-transform-nullish-coalescing-operator": "^7.24.7",
+        "@babel/plugin-transform-numeric-separator": "^7.24.7",
+        "@babel/plugin-transform-object-rest-spread": "^7.24.7",
+        "@babel/plugin-transform-object-super": "^7.24.7",
+        "@babel/plugin-transform-optional-catch-binding": "^7.24.7",
+        "@babel/plugin-transform-optional-chaining": "^7.24.7",
+        "@babel/plugin-transform-parameters": "^7.24.7",
+        "@babel/plugin-transform-private-methods": "^7.24.7",
+        "@babel/plugin-transform-private-property-in-object": "^7.24.7",
+        "@babel/plugin-transform-property-literals": "^7.24.7",
+        "@babel/plugin-transform-regenerator": "^7.24.7",
+        "@babel/plugin-transform-reserved-words": "^7.24.7",
+        "@babel/plugin-transform-shorthand-properties": "^7.24.7",
+        "@babel/plugin-transform-spread": "^7.24.7",
+        "@babel/plugin-transform-sticky-regex": "^7.24.7",
+        "@babel/plugin-transform-template-literals": "^7.24.7",
+        "@babel/plugin-transform-typeof-symbol": "^7.24.7",
+        "@babel/plugin-transform-unicode-escapes": "^7.24.7",
+        "@babel/plugin-transform-unicode-property-regex": "^7.24.7",
+        "@babel/plugin-transform-unicode-regex": "^7.24.7",
+        "@babel/plugin-transform-unicode-sets-regex": "^7.24.7",
         "@babel/preset-modules": "0.1.6-no-external-plugins",
-        "babel-plugin-polyfill-corejs2": "^0.4.8",
-        "babel-plugin-polyfill-corejs3": "^0.9.0",
-        "babel-plugin-polyfill-regenerator": "^0.5.5",
+        "babel-plugin-polyfill-corejs2": "^0.4.10",
+        "babel-plugin-polyfill-corejs3": "^0.10.4",
+        "babel-plugin-polyfill-regenerator": "^0.6.1",
         "core-js-compat": "^3.31.0",
         "semver": "^6.3.1"
       },
@@ -2319,9 +2305,9 @@
       "dev": true
     },
     "node_modules/@babel/runtime": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.24.0.tgz",
-      "integrity": "sha512-Chk32uHMg6TnQdvw2e9IlqPpFX/6NLuK0Ys2PqLb7/gL5uFn9mXvK715FGLlOLQrcO4qIkNHkvPGktzzXexsFw==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.24.7.tgz",
+      "integrity": "sha512-UwgBRMjJP+xv857DCngvqXI3Iq6J4v0wXmwc6sapg+zyhbwmQX67LUEFrkK5tbyJ30jGuG3ZvWpBiB9LCy1kWw==",
       "dev": true,
       "dependencies": {
         "regenerator-runtime": "^0.14.0"
@@ -2331,33 +2317,33 @@
       }
     },
     "node_modules/@babel/template": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.24.0.tgz",
-      "integrity": "sha512-Bkf2q8lMB0AFpX0NFEqSbx1OkTHf0f+0j82mkw+ZpzBnkk7e9Ql0891vlfgi+kHwOk8tQjiQHpqh4LaSa0fKEA==",
+      "version": "7.24.7",
+      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.24.7.tgz",
+      "integrity": "sha512-jYqfPrU9JTF0PmPy1tLYHW4Mp4KlgxJD9l2nP9fD6yT/ICi554DmrWBAEYpIelzjHf1msDP3PxJIRt/nFNfBig==",
       "dev": true,
       "dependencies": {
-        "@babel/code-frame": "^7.23.5",
-        "@babel/parser": "^7.24.0",
-        "@babel/types": "^7.24.0"
+        "@babel/code-frame": "^7.24.7",
+        "@babel/parser": "^7.24.7",
+        "@babel/types": "^7.24.7"
       },
       "engines": {
         "node": ">=6.9.0"
       }
     },
     "node_modules/@babel/traverse": {
-      "version": "7.24.1",
-      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.24.1.tgz",
-      "integrity": "sha512-xuU6o9m68KeqZbQuDt2TcKSxUw/mrsvavlEqQ1leZ/B+C9tk6E4sRWy97WaXgvq5E+nU3cXMxv3WKOCanVMCmQ==",
-      "dev": true,
-      "dependencies": {
-        "@babel/code-frame": "^7.24.1",
-        "@babel/generator": "^7.24.1",
-        "@babel/helper-environment-visitor": "^7.22.20",
-        "@babel/helper-function-name": "^7.23.0",
-        "@babel/helper-hoist-variables": "^7.22.5",
-        "@babel/helper-split-export-declaration": "^7.22.6",
-        "@babel/parser": "^7.24.1",
-        "@babel/types": "^7.24.0",
+      "version": "7.24.8",
+      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.24.8.tgz",
+      "integrity": "sha512-t0P1xxAPzEDcEPmjprAQq19NWum4K0EQPjMwZQZbHt+GiZqvjCHjj755Weq1YRPVzBI+3zSfvScfpnuIecVFJQ==",
+      "dev": true,
+      "dependencies": {
+        "@babel/code-frame": "^7.24.7",
+        "@babel/generator": "^7.24.8",
+        "@babel/helper-environment-visitor": "^7.24.7",
+        "@babel/helper-function-name": "^7.24.7",
+        "@babel/helper-hoist-variables": "^7.24.7",
+        "@babel/helper-split-export-declaration": "^7.24.7",
+        "@babel/parser": "^7.24.8",
+        "@babel/types": "^7.24.8",
         "debug": "^4.3.1",
         "globals": "^11.1.0"
       },
@@ -2366,12 +2352,12 @@
       }
     },
     "node_modules/@babel/traverse/node_modules/@babel/generator": {
-      "version": "7.24.4",
-      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.24.4.tgz",
-      "integrity": "sha512-Xd6+v6SnjWVx/nus+y0l1sxMOTOMBkyL4+BIdbALyatQnAe/SRVjANeDPSCYaX+i1iJmuGSKf3Z+E+V/va1Hvw==",
+      "version": "7.24.10",
+      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.24.10.tgz",
+      "integrity": "sha512-o9HBZL1G2129luEUlG1hB4N/nlYNWHnpwlND9eOMclRqqu1YDy2sSYVCFUZwl8I1Gxh+QSRrP2vD7EpUmFVXxg==",
       "dev": true,
       "dependencies": {
-        "@babel/types": "^7.24.0",
+        "@babel/types": "^7.24.9",
         "@jridgewell/gen-mapping": "^0.3.5",
         "@jridgewell/trace-mapping": "^0.3.25",
         "jsesc": "^2.5.1"
@@ -2381,13 +2367,13 @@
       }
     },
     "node_modules/@babel/types": {
-      "version": "7.24.0",
-      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.24.0.tgz",
-      "integrity": "sha512-+j7a5c253RfKh8iABBhywc8NSfP5LURe7Uh4qpsh6jc+aLJguvmIUBdjSdEMQv2bENrCR5MfRdjGo7vzS/ob7w==",
+      "version": "7.24.9",
+      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.24.9.tgz",
+      "integrity": "sha512-xm8XrMKz0IlUdocVbYJe0Z9xEgidU7msskG8BbhnTPK/HZ2z/7FP7ykqPgrUH+C+r414mNfNWam1f2vqOjqjYQ==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-string-parser": "^7.23.4",
-        "@babel/helper-validator-identifier": "^7.22.20",
+        "@babel/helper-string-parser": "^7.24.8",
+        "@babel/helper-validator-identifier": "^7.24.7",
         "to-fast-properties": "^2.0.0"
       },
       "engines": {
@@ -2413,9 +2399,9 @@
       }
     },
     "node_modules/@esbuild/aix-ppc64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.20.1.tgz",
-      "integrity": "sha512-m55cpeupQ2DbuRGQMMZDzbv9J9PgVelPjlcmM5kxHnrBdBx6REaEd7LamYV7Dm8N7rCyR/XwU6rVP8ploKtIkA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
+      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
       "cpu": [
         "ppc64"
       ],
@@ -2429,9 +2415,9 @@
       }
     },
     "node_modules/@esbuild/android-arm": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.20.1.tgz",
-      "integrity": "sha512-4j0+G27/2ZXGWR5okcJi7pQYhmkVgb4D7UKwxcqrjhvp5TKWx3cUjgB1CGj1mfdmJBQ9VnUGgUhign+FPF2Zgw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
+      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
       "cpu": [
         "arm"
       ],
@@ -2445,9 +2431,9 @@
       }
     },
     "node_modules/@esbuild/android-arm64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.20.1.tgz",
-      "integrity": "sha512-hCnXNF0HM6AjowP+Zou0ZJMWWa1VkD77BXe959zERgGJBBxB+sV+J9f/rcjeg2c5bsukD/n17RKWXGFCO5dD5A==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
+      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
       "cpu": [
         "arm64"
       ],
@@ -2461,9 +2447,9 @@
       }
     },
     "node_modules/@esbuild/android-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.20.1.tgz",
-      "integrity": "sha512-MSfZMBoAsnhpS+2yMFYIQUPs8Z19ajwfuaSZx+tSl09xrHZCjbeXXMsUF/0oq7ojxYEpsSo4c0SfjxOYXRbpaA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
+      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
       "cpu": [
         "x64"
       ],
@@ -2477,9 +2463,9 @@
       }
     },
     "node_modules/@esbuild/darwin-arm64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.20.1.tgz",
-      "integrity": "sha512-Ylk6rzgMD8klUklGPzS414UQLa5NPXZD5tf8JmQU8GQrj6BrFA/Ic9tb2zRe1kOZyCbGl+e8VMbDRazCEBqPvA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
+      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
       "cpu": [
         "arm64"
       ],
@@ -2493,9 +2479,9 @@
       }
     },
     "node_modules/@esbuild/darwin-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.20.1.tgz",
-      "integrity": "sha512-pFIfj7U2w5sMp52wTY1XVOdoxw+GDwy9FsK3OFz4BpMAjvZVs0dT1VXs8aQm22nhwoIWUmIRaE+4xow8xfIDZA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
+      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
       "cpu": [
         "x64"
       ],
@@ -2509,9 +2495,9 @@
       }
     },
     "node_modules/@esbuild/freebsd-arm64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.20.1.tgz",
-      "integrity": "sha512-UyW1WZvHDuM4xDz0jWun4qtQFauNdXjXOtIy7SYdf7pbxSWWVlqhnR/T2TpX6LX5NI62spt0a3ldIIEkPM6RHw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
+      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
       "cpu": [
         "arm64"
       ],
@@ -2525,9 +2511,9 @@
       }
     },
     "node_modules/@esbuild/freebsd-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.20.1.tgz",
-      "integrity": "sha512-itPwCw5C+Jh/c624vcDd9kRCCZVpzpQn8dtwoYIt2TJF3S9xJLiRohnnNrKwREvcZYx0n8sCSbvGH349XkcQeg==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
+      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
       "cpu": [
         "x64"
       ],
@@ -2541,9 +2527,9 @@
       }
     },
     "node_modules/@esbuild/linux-arm": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.20.1.tgz",
-      "integrity": "sha512-LojC28v3+IhIbfQ+Vu4Ut5n3wKcgTu6POKIHN9Wpt0HnfgUGlBuyDDQR4jWZUZFyYLiz4RBBBmfU6sNfn6RhLw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
+      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
       "cpu": [
         "arm"
       ],
@@ -2557,9 +2543,9 @@
       }
     },
     "node_modules/@esbuild/linux-arm64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.20.1.tgz",
-      "integrity": "sha512-cX8WdlF6Cnvw/DO9/X7XLH2J6CkBnz7Twjpk56cshk9sjYVcuh4sXQBy5bmTwzBjNVZze2yaV1vtcJS04LbN8w==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
+      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
       "cpu": [
         "arm64"
       ],
@@ -2573,9 +2559,9 @@
       }
     },
     "node_modules/@esbuild/linux-ia32": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.20.1.tgz",
-      "integrity": "sha512-4H/sQCy1mnnGkUt/xszaLlYJVTz3W9ep52xEefGtd6yXDQbz/5fZE5dFLUgsPdbUOQANcVUa5iO6g3nyy5BJiw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
+      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
       "cpu": [
         "ia32"
       ],
@@ -2589,9 +2575,9 @@
       }
     },
     "node_modules/@esbuild/linux-loong64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.20.1.tgz",
-      "integrity": "sha512-c0jgtB+sRHCciVXlyjDcWb2FUuzlGVRwGXgI+3WqKOIuoo8AmZAddzeOHeYLtD+dmtHw3B4Xo9wAUdjlfW5yYA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
+      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
       "cpu": [
         "loong64"
       ],
@@ -2605,9 +2591,9 @@
       }
     },
     "node_modules/@esbuild/linux-mips64el": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.20.1.tgz",
-      "integrity": "sha512-TgFyCfIxSujyuqdZKDZ3yTwWiGv+KnlOeXXitCQ+trDODJ+ZtGOzLkSWngynP0HZnTsDyBbPy7GWVXWaEl6lhA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
+      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
       "cpu": [
         "mips64el"
       ],
@@ -2621,9 +2607,9 @@
       }
     },
     "node_modules/@esbuild/linux-ppc64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.20.1.tgz",
-      "integrity": "sha512-b+yuD1IUeL+Y93PmFZDZFIElwbmFfIKLKlYI8M6tRyzE6u7oEP7onGk0vZRh8wfVGC2dZoy0EqX1V8qok4qHaw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
+      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
       "cpu": [
         "ppc64"
       ],
@@ -2637,9 +2623,9 @@
       }
     },
     "node_modules/@esbuild/linux-riscv64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.20.1.tgz",
-      "integrity": "sha512-wpDlpE0oRKZwX+GfomcALcouqjjV8MIX8DyTrxfyCfXxoKQSDm45CZr9fanJ4F6ckD4yDEPT98SrjvLwIqUCgg==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
+      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
       "cpu": [
         "riscv64"
       ],
@@ -2653,9 +2639,9 @@
       }
     },
     "node_modules/@esbuild/linux-s390x": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.20.1.tgz",
-      "integrity": "sha512-5BepC2Au80EohQ2dBpyTquqGCES7++p7G+7lXe1bAIvMdXm4YYcEfZtQrP4gaoZ96Wv1Ute61CEHFU7h4FMueQ==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
+      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
       "cpu": [
         "s390x"
       ],
@@ -2669,9 +2655,9 @@
       }
     },
     "node_modules/@esbuild/linux-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.20.1.tgz",
-      "integrity": "sha512-5gRPk7pKuaIB+tmH+yKd2aQTRpqlf1E4f/mC+tawIm/CGJemZcHZpp2ic8oD83nKgUPMEd0fNanrnFljiruuyA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
+      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
       "cpu": [
         "x64"
       ],
@@ -2685,9 +2671,9 @@
       }
     },
     "node_modules/@esbuild/netbsd-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.20.1.tgz",
-      "integrity": "sha512-4fL68JdrLV2nVW2AaWZBv3XEm3Ae3NZn/7qy2KGAt3dexAgSVT+Hc97JKSZnqezgMlv9x6KV0ZkZY7UO5cNLCg==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
+      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
       "cpu": [
         "x64"
       ],
@@ -2701,9 +2687,9 @@
       }
     },
     "node_modules/@esbuild/openbsd-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.20.1.tgz",
-      "integrity": "sha512-GhRuXlvRE+twf2ES+8REbeCb/zeikNqwD3+6S5y5/x+DYbAQUNl0HNBs4RQJqrechS4v4MruEr8ZtAin/hK5iw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
+      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
       "cpu": [
         "x64"
       ],
@@ -2717,9 +2703,9 @@
       }
     },
     "node_modules/@esbuild/sunos-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.20.1.tgz",
-      "integrity": "sha512-ZnWEyCM0G1Ex6JtsygvC3KUUrlDXqOihw8RicRuQAzw+c4f1D66YlPNNV3rkjVW90zXVsHwZYWbJh3v+oQFM9Q==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
+      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
       "cpu": [
         "x64"
       ],
@@ -2733,9 +2719,9 @@
       }
     },
     "node_modules/@esbuild/win32-arm64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.20.1.tgz",
-      "integrity": "sha512-QZ6gXue0vVQY2Oon9WyLFCdSuYbXSoxaZrPuJ4c20j6ICedfsDilNPYfHLlMH7vGfU5DQR0czHLmJvH4Nzis/A==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
+      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
       "cpu": [
         "arm64"
       ],
@@ -2749,9 +2735,9 @@
       }
     },
     "node_modules/@esbuild/win32-ia32": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.20.1.tgz",
-      "integrity": "sha512-HzcJa1NcSWTAU0MJIxOho8JftNp9YALui3o+Ny7hCh0v5f90nprly1U3Sj1Ldj/CvKKdvvFsCRvDkpsEMp4DNw==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
+      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
       "cpu": [
         "ia32"
       ],
@@ -2765,9 +2751,9 @@
       }
     },
     "node_modules/@esbuild/win32-x64": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.20.1.tgz",
-      "integrity": "sha512-0MBh53o6XtI6ctDnRMeQ+xoCN8kD2qI1rY1KgF/xdWQwoFeKou7puvDfV8/Wv4Ctx2rRpET/gGdz3YlNtNACSA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
+      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
       "cpu": [
         "x64"
       ],
@@ -2780,148 +2766,478 @@
         "node": ">=12"
       }
     },
-    "node_modules/@isaacs/cliui": {
-      "version": "8.0.2",
-      "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
-      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
+    "node_modules/@inquirer/checkbox": {
+      "version": "2.4.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/checkbox/-/checkbox-2.4.0.tgz",
+      "integrity": "sha512-XHOCmntitRBD8SJcrv+6X9YakxO1wfsvezOnU5MBIXeTlSBRCVk9DOIrx6Cgi9BS3qkcy7oQb+fUGEKrP6xecQ==",
       "dev": true,
       "dependencies": {
-        "string-width": "^5.1.2",
-        "string-width-cjs": "npm:string-width@^4.2.0",
-        "strip-ansi": "^7.0.1",
-        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
-        "wrap-ansi": "^8.1.0",
-        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "ansi-escapes": "^4.3.2",
+        "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       }
     },
-    "node_modules/@isaacs/cliui/node_modules/ansi-regex": {
-      "version": "6.0.1",
-      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
-      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+    "node_modules/@inquirer/checkbox/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
       "dev": true,
-      "engines": {
-        "node": ">=12"
+      "dependencies": {
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
       },
-      "funding": {
-        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
-      }
-    },
-    "node_modules/@isaacs/cliui/node_modules/ansi-styles": {
-      "version": "6.2.1",
-      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
-      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
-      "dev": true,
       "engines": {
-        "node": ">=12"
-      },
-      "funding": {
-        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+        "node": ">=18"
       }
     },
-    "node_modules/@isaacs/cliui/node_modules/emoji-regex": {
-      "version": "9.2.2",
-      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
-      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
-      "dev": true
-    },
-    "node_modules/@isaacs/cliui/node_modules/string-width": {
-      "version": "5.1.2",
-      "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
-      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
+    "node_modules/@inquirer/confirm": {
+      "version": "3.1.11",
+      "resolved": "https://registry.npmjs.org/@inquirer/confirm/-/confirm-3.1.11.tgz",
+      "integrity": "sha512-3wWw10VPxQP279FO4bzWsf8YjIAq7NdwATJ4xS2h1uwsXZu/RmtOVV95rZ7yllS1h/dzu+uLewjMAzNDEj8h2w==",
       "dev": true,
       "dependencies": {
-        "eastasianwidth": "^0.2.0",
-        "emoji-regex": "^9.2.2",
-        "strip-ansi": "^7.0.1"
+        "@inquirer/core": "^8.2.4",
+        "@inquirer/type": "^1.3.3"
       },
       "engines": {
-        "node": ">=12"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
+        "node": ">=18"
       }
     },
-    "node_modules/@isaacs/cliui/node_modules/strip-ansi": {
-      "version": "7.1.0",
-      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
-      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
+    "node_modules/@inquirer/core": {
+      "version": "8.2.4",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-8.2.4.tgz",
+      "integrity": "sha512-7vsXSfxtrrbwMTirfaKwPcjqJy7pzeuF/bP62yo1NQrRJ5HjmMlrhZml/Ljm9ODc1RnbhJlTeSnCkjtFddKjwA==",
       "dev": true,
       "dependencies": {
-        "ansi-regex": "^6.0.1"
+        "@inquirer/figures": "^1.0.3",
+        "@inquirer/type": "^1.3.3",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.9",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "picocolors": "^1.0.1",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0"
       },
       "engines": {
-        "node": ">=12"
-      },
-      "funding": {
-        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+        "node": ">=18"
       }
     },
-    "node_modules/@isaacs/cliui/node_modules/wrap-ansi": {
-      "version": "8.1.0",
-      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
-      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
+    "node_modules/@inquirer/editor": {
+      "version": "2.1.15",
+      "resolved": "https://registry.npmjs.org/@inquirer/editor/-/editor-2.1.15.tgz",
+      "integrity": "sha512-UmtZnY36rGLS/4cCzvdRmk0xxsGgH2AsF0v1SSlBZ3C5JK/Bxm2gNW8fmUVzQ5vm8kpdWASXPapbUx4iV49ScA==",
       "dev": true,
       "dependencies": {
-        "ansi-styles": "^6.1.0",
-        "string-width": "^5.0.1",
-        "strip-ansi": "^7.0.1"
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/type": "^1.5.0",
+        "external-editor": "^3.1.0"
       },
       "engines": {
-        "node": ">=12"
-      },
-      "funding": {
-        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+        "node": ">=18"
       }
     },
-    "node_modules/@istanbuljs/load-nyc-config": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/@istanbuljs/load-nyc-config/-/load-nyc-config-1.1.0.tgz",
-      "integrity": "sha512-VjeHSlIzpv/NyD3N0YuHfXOPDIixcA1q2ZV98wsMqcYlPmv2n3Yb2lYP9XMElnaFVXg5A7YLTeLu6V84uQDjmQ==",
+    "node_modules/@inquirer/editor/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
       "dev": true,
       "dependencies": {
-        "camelcase": "^5.3.1",
-        "find-up": "^4.1.0",
-        "get-package-type": "^0.1.0",
-        "js-yaml": "^3.13.1",
-        "resolve-from": "^5.0.0"
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
-        "node": ">=8"
+        "node": ">=18"
       }
     },
-    "node_modules/@istanbuljs/schema": {
-      "version": "0.1.3",
-      "resolved": "https://registry.npmjs.org/@istanbuljs/schema/-/schema-0.1.3.tgz",
-      "integrity": "sha512-ZXRY4jNvVgSVQ8DL3LTcakaAtXwTVUxE81hslsyD2AtoXW/wVob10HkOJ1X/pAlcI7D+2YoZKg5do8G/w6RYgA==",
+    "node_modules/@inquirer/expand": {
+      "version": "2.1.15",
+      "resolved": "https://registry.npmjs.org/@inquirer/expand/-/expand-2.1.15.tgz",
+      "integrity": "sha512-aBnnrBw9vbFJROUlDCsbq8H/plX6JHfPwLmSphxaVqOR+b1hgLdw+oRhZkpcJhG2AZOlc8IKzGdZhji93gQg4w==",
       "dev": true,
+      "dependencies": {
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/type": "^1.5.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
       "engines": {
-        "node": ">=8"
+        "node": ">=18"
       }
     },
-    "node_modules/@jridgewell/gen-mapping": {
-      "version": "0.3.5",
-      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.5.tgz",
-      "integrity": "sha512-IzL8ZoEDIBRWEzlCcRhOaCupYyN5gdIK+Q6fbFdPDg6HqX6jpkItn7DFIpW9LQzXG6Df9sA7+OKnq0qlz/GaQg==",
+    "node_modules/@inquirer/expand/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
       "dev": true,
       "dependencies": {
-        "@jridgewell/set-array": "^1.2.1",
-        "@jridgewell/sourcemap-codec": "^1.4.10",
-        "@jridgewell/trace-mapping": "^0.3.24"
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
       },
       "engines": {
-        "node": ">=6.0.0"
+        "node": ">=18"
       }
     },
-    "node_modules/@jridgewell/resolve-uri": {
-      "version": "3.1.2",
-      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
-      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
+    "node_modules/@inquirer/figures": {
+      "version": "1.0.4",
+      "resolved": "https://registry.npmjs.org/@inquirer/figures/-/figures-1.0.4.tgz",
+      "integrity": "sha512-R7Gsg6elpuqdn55fBH2y9oYzrU/yKrSmIsDX4ROT51vohrECFzTf2zw9BfUbOW8xjfmM2QbVoVYdTwhrtEKWSQ==",
       "dev": true,
       "engines": {
-        "node": ">=6.0.0"
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/input": {
+      "version": "2.2.2",
+      "resolved": "https://registry.npmjs.org/@inquirer/input/-/input-2.2.2.tgz",
+      "integrity": "sha512-VjkzYSVH0606nLi9HHiSb4QYs2idwRgneiMoFoTAIwQ1Qwx6OIDugOYLtLta3gP8AWZx7qUvgDtj+/SJuiiKuQ==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/type": "^1.5.0"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/input/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/password": {
+      "version": "2.1.15",
+      "resolved": "https://registry.npmjs.org/@inquirer/password/-/password-2.1.15.tgz",
+      "integrity": "sha512-/JmiTtIcSYbZdPucEW5q2rhC71vGKPivm3LFqNDQEI6lJyffq7hlfKKFC+R1Qp19dMqkaG+O5L1XmcHpmlAUUQ==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/type": "^1.5.0",
+        "ansi-escapes": "^4.3.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/password/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/prompts": {
+      "version": "5.0.7",
+      "resolved": "https://registry.npmjs.org/@inquirer/prompts/-/prompts-5.0.7.tgz",
+      "integrity": "sha512-GFcigCxJTKCH3aECzMIu4FhgLJWnFvMXzpI4CCSoELWFtkOOU2P+goYA61+OKpGrB8fPE7q6n8zAXBSlZRrHjQ==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/checkbox": "^2.3.7",
+        "@inquirer/confirm": "^3.1.11",
+        "@inquirer/editor": "^2.1.11",
+        "@inquirer/expand": "^2.1.11",
+        "@inquirer/input": "^2.1.11",
+        "@inquirer/password": "^2.1.11",
+        "@inquirer/rawlist": "^2.1.11",
+        "@inquirer/select": "^2.3.7"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/rawlist": {
+      "version": "2.1.15",
+      "resolved": "https://registry.npmjs.org/@inquirer/rawlist/-/rawlist-2.1.15.tgz",
+      "integrity": "sha512-zwU6aWDMyuQNiY5Z0iYXkxi7pliRFXqUmiS7vG6lAGxqcbOSptYgIxGJnd3AU4Y91N0Tbt57+koJL0S2p6vSkA==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/type": "^1.5.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/rawlist/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/select": {
+      "version": "2.4.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/select/-/select-2.4.0.tgz",
+      "integrity": "sha512-iU1eRkHirVNs43zWk6anMIMKc7tCXlJ+I5DcpIV7JzMe+45TuPPOGGCgeGIkZ4xYJ3cXdFoh7GJpm84PNC8veg==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/core": "^9.0.3",
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "ansi-escapes": "^4.3.2",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/select/node_modules/@inquirer/core": {
+      "version": "9.0.3",
+      "resolved": "https://registry.npmjs.org/@inquirer/core/-/core-9.0.3.tgz",
+      "integrity": "sha512-p2BRZv/vMmpwlU4ZR966vKQzGVCi4VhLjVofwnFLziTQia541T7i1Ar8/LPh+LzjkXzocme+g5Io6MRtzlCcNA==",
+      "dev": true,
+      "dependencies": {
+        "@inquirer/figures": "^1.0.4",
+        "@inquirer/type": "^1.5.0",
+        "@types/mute-stream": "^0.0.4",
+        "@types/node": "^20.14.11",
+        "@types/wrap-ansi": "^3.0.0",
+        "ansi-escapes": "^4.3.2",
+        "cli-spinners": "^2.9.2",
+        "cli-width": "^4.1.0",
+        "mute-stream": "^1.0.0",
+        "signal-exit": "^4.1.0",
+        "strip-ansi": "^6.0.1",
+        "wrap-ansi": "^6.2.0",
+        "yoctocolors-cjs": "^2.1.2"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@inquirer/type": {
+      "version": "1.5.0",
+      "resolved": "https://registry.npmjs.org/@inquirer/type/-/type-1.5.0.tgz",
+      "integrity": "sha512-L/UdayX9Z1lLN+itoTKqJ/X4DX5DaWu2Sruwt4XgZzMNv32x4qllbzMX4MbJlz0yxAQtU19UvABGOjmdq1u3qA==",
+      "dev": true,
+      "dependencies": {
+        "mute-stream": "^1.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/@isaacs/cliui": {
+      "version": "8.0.2",
+      "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
+      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
+      "dev": true,
+      "dependencies": {
+        "string-width": "^5.1.2",
+        "string-width-cjs": "npm:string-width@^4.2.0",
+        "strip-ansi": "^7.0.1",
+        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
+        "wrap-ansi": "^8.1.0",
+        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
+      },
+      "engines": {
+        "node": ">=12"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/ansi-regex": {
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
+      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/ansi-styles": {
+      "version": "6.2.1",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
+      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/emoji-regex": {
+      "version": "9.2.2",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
+      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
+      "dev": true
+    },
+    "node_modules/@isaacs/cliui/node_modules/string-width": {
+      "version": "5.1.2",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
+      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
+      "dev": true,
+      "dependencies": {
+        "eastasianwidth": "^0.2.0",
+        "emoji-regex": "^9.2.2",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/strip-ansi": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
+      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/wrap-ansi": {
+      "version": "8.1.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
+      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-styles": "^6.1.0",
+        "string-width": "^5.0.1",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/@istanbuljs/schema": {
+      "version": "0.1.3",
+      "resolved": "https://registry.npmjs.org/@istanbuljs/schema/-/schema-0.1.3.tgz",
+      "integrity": "sha512-ZXRY4jNvVgSVQ8DL3LTcakaAtXwTVUxE81hslsyD2AtoXW/wVob10HkOJ1X/pAlcI7D+2YoZKg5do8G/w6RYgA==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/@jridgewell/gen-mapping": {
+      "version": "0.3.5",
+      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.5.tgz",
+      "integrity": "sha512-IzL8ZoEDIBRWEzlCcRhOaCupYyN5gdIK+Q6fbFdPDg6HqX6jpkItn7DFIpW9LQzXG6Df9sA7+OKnq0qlz/GaQg==",
+      "dev": true,
+      "dependencies": {
+        "@jridgewell/set-array": "^1.2.1",
+        "@jridgewell/sourcemap-codec": "^1.4.10",
+        "@jridgewell/trace-mapping": "^0.3.24"
+      },
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
+    "node_modules/@jridgewell/resolve-uri": {
+      "version": "3.1.2",
+      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
+      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
+      "dev": true,
+      "engines": {
+        "node": ">=6.0.0"
       }
     },
     "node_modules/@jridgewell/set-array": {
@@ -2944,9 +3260,9 @@
       }
     },
     "node_modules/@jridgewell/sourcemap-codec": {
-      "version": "1.4.15",
-      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.4.15.tgz",
-      "integrity": "sha512-eF2rxCRulEKXHTRiDrDy6erMYWqNw4LPdQ8UQA4huuxaQsVeRPFl2oM8oDGxMFhJUWZf9McpLtJasDDZb/Bpeg==",
+      "version": "1.5.0",
+      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.0.tgz",
+      "integrity": "sha512-gv3ZRaISU3fjPAgNsriBRqGWQL6quFx04YMPW/zD8XMLsU32mhCCbfbO6KZFLjvYpCZ8zyDEgqsgf+PwPaM7GQ==",
       "dev": true
     },
     "node_modules/@jridgewell/trace-mapping": {
@@ -2959,24 +3275,159 @@
         "@jridgewell/sourcemap-codec": "^1.4.14"
       }
     },
+    "node_modules/@jsonjoy.com/base64": {
+      "version": "1.1.2",
+      "resolved": "https://registry.npmjs.org/@jsonjoy.com/base64/-/base64-1.1.2.tgz",
+      "integrity": "sha512-q6XAnWQDIMA3+FTiOYajoYqySkO+JSat0ytXGSuRdq9uXE7o92gzuQwQM14xaCRlBLGq3v5miDGC4vkVTn54xA==",
+      "dev": true,
+      "engines": {
+        "node": ">=10.0"
+      },
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
+      },
+      "peerDependencies": {
+        "tslib": "2"
+      }
+    },
+    "node_modules/@jsonjoy.com/json-pack": {
+      "version": "1.0.4",
+      "resolved": "https://registry.npmjs.org/@jsonjoy.com/json-pack/-/json-pack-1.0.4.tgz",
+      "integrity": "sha512-aOcSN4MeAtFROysrbqG137b7gaDDSmVrl5mpo6sT/w+kcXpWnzhMjmY/Fh/sDx26NBxyIE7MB1seqLeCAzy9Sg==",
+      "dev": true,
+      "dependencies": {
+        "@jsonjoy.com/base64": "^1.1.1",
+        "@jsonjoy.com/util": "^1.1.2",
+        "hyperdyperid": "^1.2.0",
+        "thingies": "^1.20.0"
+      },
+      "engines": {
+        "node": ">=10.0"
+      },
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
+      },
+      "peerDependencies": {
+        "tslib": "2"
+      }
+    },
+    "node_modules/@jsonjoy.com/util": {
+      "version": "1.2.0",
+      "resolved": "https://registry.npmjs.org/@jsonjoy.com/util/-/util-1.2.0.tgz",
+      "integrity": "sha512-4B8B+3vFsY4eo33DMKyJPlQ3sBMpPFUZK2dr3O3rXrOGKKbYG44J0XSFkDo1VOQiri5HFEhIeVvItjR2xcazmg==",
+      "dev": true,
+      "engines": {
+        "node": ">=10.0"
+      },
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
+      },
+      "peerDependencies": {
+        "tslib": "2"
+      }
+    },
     "node_modules/@leichtgewicht/ip-codec": {
       "version": "2.0.5",
       "resolved": "https://registry.npmjs.org/@leichtgewicht/ip-codec/-/ip-codec-2.0.5.tgz",
       "integrity": "sha512-Vo+PSpZG2/fmgmiNzYK9qWRh8h/CHrwD0mo1h1DzL4yzHNSfWYujGTYsWGreD000gcgmZ7K4Ys6Tx9TxtsKdDw==",
       "dev": true
     },
-    "node_modules/@ljharb/through": {
-      "version": "2.3.13",
-      "resolved": "https://registry.npmjs.org/@ljharb/through/-/through-2.3.13.tgz",
-      "integrity": "sha512-/gKJun8NNiWGZJkGzI/Ragc53cOdcLNdzjLaIa+GEjguQs0ulsurx8WN0jijdK9yPqDvziX995sMRLyLt1uZMQ==",
+    "node_modules/@listr2/prompt-adapter-inquirer": {
+      "version": "2.0.13",
+      "resolved": "https://registry.npmjs.org/@listr2/prompt-adapter-inquirer/-/prompt-adapter-inquirer-2.0.13.tgz",
+      "integrity": "sha512-nAl6teTt7EWSjttNavAnv3uFR3w3vPP3OTYmHyPNHzKhAj2NoBDHmbS3MGpvvO8KXXPASnHjEGrrKrdKTMKPnQ==",
       "dev": true,
       "dependencies": {
-        "call-bind": "^1.0.7"
+        "@inquirer/type": "^1.3.3"
       },
       "engines": {
-        "node": ">= 0.4"
+        "node": ">=18.0.0"
+      },
+      "peerDependencies": {
+        "@inquirer/prompts": ">= 3 < 6"
       }
     },
+    "node_modules/@lmdb/lmdb-darwin-arm64": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-arm64/-/lmdb-darwin-arm64-3.0.12.tgz",
+      "integrity": "sha512-vgTwzNUD3Hy4aqtGhX2+nV/usI0mwy3hDRuTjs8VcK0BLiMVEpNQXgzwlWEgPmA8AAPloUgyOs2nK5clJF5oIg==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
+    },
+    "node_modules/@lmdb/lmdb-darwin-x64": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-darwin-x64/-/lmdb-darwin-x64-3.0.12.tgz",
+      "integrity": "sha512-qOt0hAhj2ZLY6aEWu85rzt5zcyCAQITMhCMEPNlo1tuYekpVAdkQNiwXxEkCjBYvwTskvXuwXOOUpjuSc+aJnA==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
+    },
+    "node_modules/@lmdb/lmdb-linux-arm": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm/-/lmdb-linux-arm-3.0.12.tgz",
+      "integrity": "sha512-Ggd/UXpE+alMncbELCXA3OKpDj9bDBR3qVO7WRTxstloDglRAHfZmUJgTkeaNKjFO1JHqS7AKy0jba9XebZB1w==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@lmdb/lmdb-linux-arm64": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-arm64/-/lmdb-linux-arm64-3.0.12.tgz",
+      "integrity": "sha512-Qy4cFXFe9h1wAWMsojex8x1ifvw2kqiZv686YiRTdQEzAfc3vJASHFcD/QejHUCx7YHMYdnUoCS45rG2AiGDTQ==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@lmdb/lmdb-linux-x64": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-linux-x64/-/lmdb-linux-x64-3.0.12.tgz",
+      "integrity": "sha512-c+noT9IofktxktFllKHFmci8ka2SYGSLN17pj/KSl1hg7mmfAiGp4xxFxEwMLTb+SX95vP1DFiR++1I3WLVxvA==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@lmdb/lmdb-win32-x64": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/@lmdb/lmdb-win32-x64/-/lmdb-win32-x64-3.0.12.tgz",
+      "integrity": "sha512-CO3MFV8gUx16NU/CyyuumAKblESwvoGVA2XhQKZ976OTOxaTbb8F8D3f0iiZ4MYqsN74jIrFuCmXpPnpjbhfOQ==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "win32"
+      ]
+    },
     "node_modules/@material/animation": {
       "version": "15.0.0-canary.7f224ddd4.0",
       "resolved": "https://registry.npmjs.org/@material/animation/-/animation-15.0.0-canary.7f224ddd4.0.tgz",
@@ -3719,29 +4170,107 @@
         "tslib": "^2.1.0"
       }
     },
-    "node_modules/@material/typography": {
-      "version": "15.0.0-canary.7f224ddd4.0",
-      "resolved": "https://registry.npmjs.org/@material/typography/-/typography-15.0.0-canary.7f224ddd4.0.tgz",
-      "integrity": "sha512-kBaZeCGD50iq1DeRRH5OM5Jl7Gdk+/NOfKArkY4ksBZvJiStJ7ACAhpvb8MEGm4s3jvDInQFLsDq3hL+SA79sQ==",
-      "dependencies": {
-        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
-        "@material/theme": "15.0.0-canary.7f224ddd4.0",
-        "tslib": "^2.1.0"
-      }
+    "node_modules/@material/typography": {
+      "version": "15.0.0-canary.7f224ddd4.0",
+      "resolved": "https://registry.npmjs.org/@material/typography/-/typography-15.0.0-canary.7f224ddd4.0.tgz",
+      "integrity": "sha512-kBaZeCGD50iq1DeRRH5OM5Jl7Gdk+/NOfKArkY4ksBZvJiStJ7ACAhpvb8MEGm4s3jvDInQFLsDq3hL+SA79sQ==",
+      "dependencies": {
+        "@material/feature-targeting": "15.0.0-canary.7f224ddd4.0",
+        "@material/theme": "15.0.0-canary.7f224ddd4.0",
+        "tslib": "^2.1.0"
+      }
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-arm64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-arm64/-/msgpackr-extract-darwin-arm64-3.0.3.tgz",
+      "integrity": "sha512-QZHtlVgbAdy2zAqNA9Gu1UpIuI8Xvsd1v8ic6B2pZmeFnFcMWiPLfWXh7TVw4eGEZ/C9TH281KwhVoeQUKbyjw==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-darwin-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-darwin-x64/-/msgpackr-extract-darwin-x64-3.0.3.tgz",
+      "integrity": "sha512-mdzd3AVzYKuUmiWOQ8GNhl64/IoFGol569zNRdkLReh6LRLHOXxU4U8eq0JwaD8iFHdVGqSy4IjFL4reoWCDFw==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "darwin"
+      ]
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm/-/msgpackr-extract-linux-arm-3.0.3.tgz",
+      "integrity": "sha512-fg0uy/dG/nZEXfYilKoRe7yALaNmHoYeIoJuJ7KJ+YyU2bvY8vPv27f7UKhGRpY6euFYqEVhxCFZgAUNQBM3nw==",
+      "cpu": [
+        "arm"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-arm64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-arm64/-/msgpackr-extract-linux-arm64-3.0.3.tgz",
+      "integrity": "sha512-YxQL+ax0XqBJDZiKimS2XQaf+2wDGVa1enVRGzEvLLVFeqa5kx2bWbtcSXgsxjQB7nRqqIGFIcLteF/sHeVtQg==",
+      "cpu": [
+        "arm64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-linux-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-linux-x64/-/msgpackr-extract-linux-x64-3.0.3.tgz",
+      "integrity": "sha512-cvwNfbP07pKUfq1uH+S6KJ7dT9K8WOE4ZiAcsrSes+UY55E/0jLYc+vq+DO7jlmqRb5zAggExKm0H7O/CBaesg==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "linux"
+      ]
+    },
+    "node_modules/@msgpackr-extract/msgpackr-extract-win32-x64": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/@msgpackr-extract/msgpackr-extract-win32-x64/-/msgpackr-extract-win32-x64-3.0.3.tgz",
+      "integrity": "sha512-x0fWaQtYp4E6sktbsdAqnehxDgEc/VwM7uLsRCYWaiGu0ykYdZPiS8zCWdnjHwyiumousxfBm4SO31eXqwEZhQ==",
+      "cpu": [
+        "x64"
+      ],
+      "dev": true,
+      "optional": true,
+      "os": [
+        "win32"
+      ]
     },
     "node_modules/@ngtools/webpack": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@ngtools/webpack/-/webpack-17.3.5.tgz",
-      "integrity": "sha512-0heI0yHUckdGI8uywu/wkp24KR/tdYMKYJOaYIU+9JydyN1zJRpbR7x0thddl7+k/zu2ZGbfFdv1779Ecw/xdA==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@ngtools/webpack/-/webpack-18.1.1.tgz",
+      "integrity": "sha512-mjlfnWcHtBZJUJaVyffJZZL8U1o1XUQwrFIKeiFUeatLDsjtv8EbLW9Ed1v3eAJyVuaTNKpsdZma1XdxzeLONw==",
       "dev": true,
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       },
       "peerDependencies": {
-        "@angular/compiler-cli": "^17.0.0",
-        "typescript": ">=5.2 <5.5",
+        "@angular/compiler-cli": "^18.0.0",
+        "typescript": ">=5.4 <5.6",
         "webpack": "^5.54.0"
       }
     },
@@ -3797,18 +4326,15 @@
       }
     },
     "node_modules/@npmcli/agent/node_modules/lru-cache": {
-      "version": "10.2.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.2.0.tgz",
-      "integrity": "sha512-2bIM8x+VAf6JT4bKAljS1qUWgMsqZRPGJS6FSahIMPVvctcNhyVp7AJu7quxOW9jwkryBReKZY5tY5JYv2n/7Q==",
-      "dev": true,
-      "engines": {
-        "node": "14 || >=16.14"
-      }
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
     "node_modules/@npmcli/fs": {
-      "version": "3.1.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/fs/-/fs-3.1.0.tgz",
-      "integrity": "sha512-7kZUAaLscfgbwBQRbvdMYaZOWyMEcPTH/tJjnyAWJ/dvvs9Ef+CERx/qJb9GExJpl1qipaDGn7KqHnFGGixd0w==",
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/@npmcli/fs/-/fs-3.1.1.tgz",
+      "integrity": "sha512-q9CRWjpHCMIh5sVyefoD1cA7PkvILqCZsnSOEUUivORLjxCO/Irmue2DprETiNgEqktDBZaM1Bi+jrarx1XdCg==",
       "dev": true,
       "dependencies": {
         "semver": "^7.3.5"
@@ -3818,12 +4344,13 @@
       }
     },
     "node_modules/@npmcli/git": {
-      "version": "5.0.6",
-      "resolved": "https://registry.npmjs.org/@npmcli/git/-/git-5.0.6.tgz",
-      "integrity": "sha512-4x/182sKXmQkf0EtXxT26GEsaOATpD7WVtza5hrYivWZeo6QefC6xq9KAXrnjtFKBZ4rZwR7aX/zClYYXgtwLw==",
+      "version": "5.0.8",
+      "resolved": "https://registry.npmjs.org/@npmcli/git/-/git-5.0.8.tgz",
+      "integrity": "sha512-liASfw5cqhjNW9UFd+ruwwdEf/lbOAQjLL2XY2dFW/bkJheXDYZgOyul/4gVvEV4BWkTXjYGmDqMw9uegdbJNQ==",
       "dev": true,
       "dependencies": {
         "@npmcli/promise-spawn": "^7.0.0",
+        "ini": "^4.1.3",
         "lru-cache": "^10.0.1",
         "npm-pick-manifest": "^9.0.0",
         "proc-log": "^4.0.0",
@@ -3846,22 +4373,10 @@
       }
     },
     "node_modules/@npmcli/git/node_modules/lru-cache": {
-      "version": "10.2.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.2.0.tgz",
-      "integrity": "sha512-2bIM8x+VAf6JT4bKAljS1qUWgMsqZRPGJS6FSahIMPVvctcNhyVp7AJu7quxOW9jwkryBReKZY5tY5JYv2n/7Q==",
-      "dev": true,
-      "engines": {
-        "node": "14 || >=16.14"
-      }
-    },
-    "node_modules/@npmcli/git/node_modules/proc-log": {
-      "version": "4.2.0",
-      "resolved": "https://registry.npmjs.org/proc-log/-/proc-log-4.2.0.tgz",
-      "integrity": "sha512-g8+OnU/L2v+wyiVK+D5fA34J7EH8jZ8DDlvwhRCMxmMj7UCBvxiO1mGeN+36JXIKF4zevU4kRBd8lVgG9vLelA==",
-      "dev": true,
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
     "node_modules/@npmcli/git/node_modules/which": {
       "version": "4.0.0",
@@ -3879,16 +4394,16 @@
       }
     },
     "node_modules/@npmcli/installed-package-contents": {
-      "version": "2.0.2",
-      "resolved": "https://registry.npmjs.org/@npmcli/installed-package-contents/-/installed-package-contents-2.0.2.tgz",
-      "integrity": "sha512-xACzLPhnfD51GKvTOOuNX2/V4G4mz9/1I2MfDoye9kBM3RYe5g2YbscsaGoTlaWqkxeiapBWyseULVKpSVHtKQ==",
+      "version": "2.1.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/installed-package-contents/-/installed-package-contents-2.1.0.tgz",
+      "integrity": "sha512-c8UuGLeZpm69BryRykLuKRyKFZYJsZSCT4aVY5ds4omyZqJ172ApzgfKJ5eV/r3HgLdUYgFVe54KSFVjKoe27w==",
       "dev": true,
       "dependencies": {
         "npm-bundled": "^3.0.0",
         "npm-normalize-package-bin": "^3.0.0"
       },
       "bin": {
-        "installed-package-contents": "lib/index.js"
+        "installed-package-contents": "bin/index.js"
       },
       "engines": {
         "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
@@ -3904,9 +4419,9 @@
       }
     },
     "node_modules/@npmcli/package-json": {
-      "version": "5.1.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/package-json/-/package-json-5.1.0.tgz",
-      "integrity": "sha512-1aL4TuVrLS9sf8quCLerU3H9J4vtCtgu8VauYozrmEyU57i/EdKleCnsQ7vpnABIH6c9mnTxcH5sFkO3BlV8wQ==",
+      "version": "5.2.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/package-json/-/package-json-5.2.0.tgz",
+      "integrity": "sha512-qe/kiqqkW0AGtvBjL8TJKZk/eBBSpnJkUWvHdQ9jM2lKHXRYYJuyNpJPlJw3c8QjC2ow6NZYiLExhUaeJelbxQ==",
       "dev": true,
       "dependencies": {
         "@npmcli/git": "^5.0.0",
@@ -3931,31 +4446,29 @@
       }
     },
     "node_modules/@npmcli/package-json/node_modules/glob": {
-      "version": "10.3.12",
-      "resolved": "https://registry.npmjs.org/glob/-/glob-10.3.12.tgz",
-      "integrity": "sha512-TCNv8vJ+xz4QiqTpfOJA7HvYv+tNIRHKfUWw/q+v2jdgN4ebz+KY9tGx5J4rHP0o84mNP+ApH66HRX8us3Khqg==",
+      "version": "10.4.5",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
+      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
       "dev": true,
       "dependencies": {
         "foreground-child": "^3.1.0",
-        "jackspeak": "^2.3.6",
-        "minimatch": "^9.0.1",
-        "minipass": "^7.0.4",
-        "path-scurry": "^1.10.2"
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
       },
       "bin": {
         "glob": "dist/esm/bin.mjs"
       },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       }
     },
     "node_modules/@npmcli/package-json/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
       "dev": true,
       "dependencies": {
         "brace-expansion": "^2.0.1"
@@ -3967,19 +4480,10 @@
         "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/@npmcli/package-json/node_modules/proc-log": {
-      "version": "4.2.0",
-      "resolved": "https://registry.npmjs.org/proc-log/-/proc-log-4.2.0.tgz",
-      "integrity": "sha512-g8+OnU/L2v+wyiVK+D5fA34J7EH8jZ8DDlvwhRCMxmMj7UCBvxiO1mGeN+36JXIKF4zevU4kRBd8lVgG9vLelA==",
-      "dev": true,
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
-    },
     "node_modules/@npmcli/promise-spawn": {
-      "version": "7.0.1",
-      "resolved": "https://registry.npmjs.org/@npmcli/promise-spawn/-/promise-spawn-7.0.1.tgz",
-      "integrity": "sha512-P4KkF9jX3y+7yFUxgcUdDtLy+t4OlDGuEBLNs57AZsfSfg+uV6MLndqGpnl4831ggaEdXwR50XFoZP4VFtHolg==",
+      "version": "7.0.2",
+      "resolved": "https://registry.npmjs.org/@npmcli/promise-spawn/-/promise-spawn-7.0.2.tgz",
+      "integrity": "sha512-xhfYPXoV5Dy4UkY0D+v2KkwvnDfiA/8Mt3sWCGI/hM03NsYIH8ZaG6QzS9x7pje5vHZBZJ2v6VRFVTWACnqcmQ==",
       "dev": true,
       "dependencies": {
         "which": "^4.0.0"
@@ -4013,24 +4517,25 @@
       }
     },
     "node_modules/@npmcli/redact": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/@npmcli/redact/-/redact-1.1.0.tgz",
-      "integrity": "sha512-PfnWuOkQgu7gCbnSsAisaX7hKOdZ4wSAhAzH3/ph5dSGau52kCRrMMGbiSQLwyTZpgldkZ49b0brkOr1AzGBHQ==",
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/@npmcli/redact/-/redact-2.0.1.tgz",
+      "integrity": "sha512-YgsR5jCQZhVmTJvjduTOIHph0L73pK8xwMVaDY0PatySqVM9AZj93jpoXYSJqfHFxFkN9dmqTw6OiqExsS3LPw==",
       "dev": true,
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
     "node_modules/@npmcli/run-script": {
-      "version": "7.0.4",
-      "resolved": "https://registry.npmjs.org/@npmcli/run-script/-/run-script-7.0.4.tgz",
-      "integrity": "sha512-9ApYM/3+rBt9V80aYg6tZfzj3UWdiYyCt7gJUD1VJKvWF5nwKDSICXbYIQbspFTq6TOpbsEtIC0LArB8d9PFmg==",
+      "version": "8.1.0",
+      "resolved": "https://registry.npmjs.org/@npmcli/run-script/-/run-script-8.1.0.tgz",
+      "integrity": "sha512-y7efHHwghQfk28G2z3tlZ67pLG0XdfYbcVG26r7YIXALRsrVQcTq4/tdenSmdOrEsNahIYA/eh8aEVROWGFUDg==",
       "dev": true,
       "dependencies": {
         "@npmcli/node-gyp": "^3.0.0",
         "@npmcli/package-json": "^5.0.0",
         "@npmcli/promise-spawn": "^7.0.0",
         "node-gyp": "^10.0.0",
+        "proc-log": "^4.0.0",
         "which": "^4.0.0"
       },
       "engines": {
@@ -4072,9 +4577,9 @@
       }
     },
     "node_modules/@rollup/rollup-android-arm-eabi": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.16.4.tgz",
-      "integrity": "sha512-GkhjAaQ8oUTOKE4g4gsZ0u8K/IHU1+2WQSgS1TwTcYvL+sjbaQjNHFXbOJ6kgqGHIO1DfUhI/Sphi9GkRT9K+Q==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.18.0.tgz",
+      "integrity": "sha512-Tya6xypR10giZV1XzxmH5wr25VcZSncG0pZIjfePT0OVBvqNEurzValetGNarVrGiq66EBVAFn15iYX4w6FKgQ==",
       "cpu": [
         "arm"
       ],
@@ -4085,9 +4590,9 @@
       ]
     },
     "node_modules/@rollup/rollup-android-arm64": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.16.4.tgz",
-      "integrity": "sha512-Bvm6D+NPbGMQOcxvS1zUl8H7DWlywSXsphAeOnVeiZLQ+0J6Is8T7SrjGTH29KtYkiY9vld8ZnpV3G2EPbom+w==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.18.0.tgz",
+      "integrity": "sha512-avCea0RAP03lTsDhEyfy+hpfr85KfyTctMADqHVhLAF3MlIkq83CP8UfAHUssgXTYd+6er6PaAhx/QGv4L1EiA==",
       "cpu": [
         "arm64"
       ],
@@ -4098,9 +4603,9 @@
       ]
     },
     "node_modules/@rollup/rollup-darwin-arm64": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.16.4.tgz",
-      "integrity": "sha512-i5d64MlnYBO9EkCOGe5vPR/EeDwjnKOGGdd7zKFhU5y8haKhQZTN2DgVtpODDMxUr4t2K90wTUJg7ilgND6bXw==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.18.0.tgz",
+      "integrity": "sha512-IWfdwU7KDSm07Ty0PuA/W2JYoZ4iTj3TUQjkVsO/6U+4I1jN5lcR71ZEvRh52sDOERdnNhhHU57UITXz5jC1/w==",
       "cpu": [
         "arm64"
       ],
@@ -4111,9 +4616,9 @@
       ]
     },
     "node_modules/@rollup/rollup-darwin-x64": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.16.4.tgz",
-      "integrity": "sha512-WZupV1+CdUYehaZqjaFTClJI72fjJEgTXdf4NbW69I9XyvdmztUExBtcI2yIIU6hJtYvtwS6pkTkHJz+k08mAQ==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.18.0.tgz",
+      "integrity": "sha512-n2LMsUz7Ynu7DoQrSQkBf8iNrjOGyPLrdSg802vk6XT3FtsgX6JbE8IHRvposskFm9SNxzkLYGSq9QdpLYpRNA==",
       "cpu": [
         "x64"
       ],
@@ -4124,9 +4629,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.16.4.tgz",
-      "integrity": "sha512-ADm/xt86JUnmAfA9mBqFcRp//RVRt1ohGOYF6yL+IFCYqOBNwy5lbEK05xTsEoJq+/tJzg8ICUtS82WinJRuIw==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.18.0.tgz",
+      "integrity": "sha512-C/zbRYRXFjWvz9Z4haRxcTdnkPt1BtCkz+7RtBSuNmKzMzp3ZxdM28Mpccn6pt28/UWUCTXa+b0Mx1k3g6NOMA==",
       "cpu": [
         "arm"
       ],
@@ -4137,9 +4642,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-arm-musleabihf": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.16.4.tgz",
-      "integrity": "sha512-tJfJaXPiFAG+Jn3cutp7mCs1ePltuAgRqdDZrzb1aeE3TktWWJ+g7xK9SNlaSUFw6IU4QgOxAY4rA+wZUT5Wfg==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.18.0.tgz",
+      "integrity": "sha512-l3m9ewPgjQSXrUMHg93vt0hYCGnrMOcUpTz6FLtbwljo2HluS4zTXFy2571YQbisTnfTKPZ01u/ukJdQTLGh9A==",
       "cpu": [
         "arm"
       ],
@@ -4150,9 +4655,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-arm64-gnu": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.16.4.tgz",
-      "integrity": "sha512-7dy1BzQkgYlUTapDTvK997cgi0Orh5Iu7JlZVBy1MBURk7/HSbHkzRnXZa19ozy+wwD8/SlpJnOOckuNZtJR9w==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.18.0.tgz",
+      "integrity": "sha512-rJ5D47d8WD7J+7STKdCUAgmQk49xuFrRi9pZkWoRD1UeSMakbcepWXPF8ycChBoAqs1pb2wzvbY6Q33WmN2ftw==",
       "cpu": [
         "arm64"
       ],
@@ -4163,9 +4668,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-arm64-musl": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.16.4.tgz",
-      "integrity": "sha512-zsFwdUw5XLD1gQe0aoU2HVceI6NEW7q7m05wA46eUAyrkeNYExObfRFQcvA6zw8lfRc5BHtan3tBpo+kqEOxmg==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.18.0.tgz",
+      "integrity": "sha512-be6Yx37b24ZwxQ+wOQXXLZqpq4jTckJhtGlWGZs68TgdKXJgw54lUUoFYrg6Zs/kjzAQwEwYbp8JxZVzZLRepQ==",
       "cpu": [
         "arm64"
       ],
@@ -4176,9 +4681,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-powerpc64le-gnu": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-powerpc64le-gnu/-/rollup-linux-powerpc64le-gnu-4.16.4.tgz",
-      "integrity": "sha512-p8C3NnxXooRdNrdv6dBmRTddEapfESEUflpICDNKXpHvTjRRq1J82CbU5G3XfebIZyI3B0s074JHMWD36qOW6w==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-powerpc64le-gnu/-/rollup-linux-powerpc64le-gnu-4.18.0.tgz",
+      "integrity": "sha512-hNVMQK+qrA9Todu9+wqrXOHxFiD5YmdEi3paj6vP02Kx1hjd2LLYR2eaN7DsEshg09+9uzWi2W18MJDlG0cxJA==",
       "cpu": [
         "ppc64"
       ],
@@ -4189,9 +4694,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-riscv64-gnu": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.16.4.tgz",
-      "integrity": "sha512-Lh/8ckoar4s4Id2foY7jNgitTOUQczwMWNYi+Mjt0eQ9LKhr6sK477REqQkmy8YHY3Ca3A2JJVdXnfb3Rrwkng==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.18.0.tgz",
+      "integrity": "sha512-ROCM7i+m1NfdrsmvwSzoxp9HFtmKGHEqu5NNDiZWQtXLA8S5HBCkVvKAxJ8U+CVctHwV2Gb5VUaK7UAkzhDjlg==",
       "cpu": [
         "riscv64"
       ],
@@ -4202,9 +4707,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-s390x-gnu": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.16.4.tgz",
-      "integrity": "sha512-1xwwn9ZCQYuqGmulGsTZoKrrn0z2fAur2ujE60QgyDpHmBbXbxLaQiEvzJWDrscRq43c8DnuHx3QorhMTZgisQ==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.18.0.tgz",
+      "integrity": "sha512-0UyyRHyDN42QL+NbqevXIIUnKA47A+45WyasO+y2bGJ1mhQrfrtXUpTxCOrfxCR4esV3/RLYyucGVPiUsO8xjg==",
       "cpu": [
         "s390x"
       ],
@@ -4215,9 +4720,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-x64-gnu": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.16.4.tgz",
-      "integrity": "sha512-LuOGGKAJ7dfRtxVnO1i3qWc6N9sh0Em/8aZ3CezixSTM+E9Oq3OvTsvC4sm6wWjzpsIlOCnZjdluINKESflJLA==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.18.0.tgz",
+      "integrity": "sha512-xuglR2rBVHA5UsI8h8UbX4VJ470PtGCf5Vpswh7p2ukaqBGFTnsfzxUBetoWBWymHMxbIG0Cmx7Y9qDZzr648w==",
       "cpu": [
         "x64"
       ],
@@ -4228,9 +4733,9 @@
       ]
     },
     "node_modules/@rollup/rollup-linux-x64-musl": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.16.4.tgz",
-      "integrity": "sha512-ch86i7KkJKkLybDP2AtySFTRi5fM3KXp0PnHocHuJMdZwu7BuyIKi35BE9guMlmTpwwBTB3ljHj9IQXnTCD0vA==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.18.0.tgz",
+      "integrity": "sha512-LKaqQL9osY/ir2geuLVvRRs+utWUNilzdE90TpyoX0eNqPzWjRm14oMEE+YLve4k/NAqCdPkGYDaDF5Sw+xBfg==",
       "cpu": [
         "x64"
       ],
@@ -4241,9 +4746,9 @@
       ]
     },
     "node_modules/@rollup/rollup-win32-arm64-msvc": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.16.4.tgz",
-      "integrity": "sha512-Ma4PwyLfOWZWayfEsNQzTDBVW8PZ6TUUN1uFTBQbF2Chv/+sjenE86lpiEwj2FiviSmSZ4Ap4MaAfl1ciF4aSA==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.18.0.tgz",
+      "integrity": "sha512-7J6TkZQFGo9qBKH0pk2cEVSRhJbL6MtfWxth7Y5YmZs57Pi+4x6c2dStAUvaQkHQLnEQv1jzBUW43GvZW8OFqA==",
       "cpu": [
         "arm64"
       ],
@@ -4254,9 +4759,9 @@
       ]
     },
     "node_modules/@rollup/rollup-win32-ia32-msvc": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.16.4.tgz",
-      "integrity": "sha512-9m/ZDrQsdo/c06uOlP3W9G2ENRVzgzbSXmXHT4hwVaDQhYcRpi9bgBT0FTG9OhESxwK0WjQxYOSfv40cU+T69w==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.18.0.tgz",
+      "integrity": "sha512-Txjh+IxBPbkUB9+SXZMpv+b/vnTEtFyfWZgJ6iyCmt2tdx0OF5WhFowLmnh8ENGNpfUlUZkdI//4IEmhwPieNg==",
       "cpu": [
         "ia32"
       ],
@@ -4267,9 +4772,9 @@
       ]
     },
     "node_modules/@rollup/rollup-win32-x64-msvc": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.16.4.tgz",
-      "integrity": "sha512-YunpoOAyGLDseanENHmbFvQSfVL5BxW3k7hhy0eN4rb3gS/ct75dVD0EXOWIqFT/nE8XYW6LP6vz6ctKRi0k9A==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.18.0.tgz",
+      "integrity": "sha512-UOo5FdvOL0+eIVTgS4tIdbW+TtnBLWg1YBCcU2KWM7nuNwRz9bksDX1bekJJCpu25N1DVWaCwnT39dVQxzqS8g==",
       "cpu": [
         "x64"
       ],
@@ -4280,28 +4785,28 @@
       ]
     },
     "node_modules/@schematics/angular": {
-      "version": "17.3.5",
-      "resolved": "https://registry.npmjs.org/@schematics/angular/-/angular-17.3.5.tgz",
-      "integrity": "sha512-SWCK16Eob0K86hpZ3NHmrTS6LSzTlhvnIdf3BXC6nzoiyDhcAS0oJ2Tjdq1opW/PaL1hB7MulcbIhxYln5du0w==",
+      "version": "18.1.1",
+      "resolved": "https://registry.npmjs.org/@schematics/angular/-/angular-18.1.1.tgz",
+      "integrity": "sha512-6nQUSuFSP7un5Bmm6/MpQXq3jnkdEYg2MUPv7JStsqnT1YYzUsDjkUv7Hsci0xQmeUAzVz3ueg4znviJoQxWdg==",
       "dev": true,
       "dependencies": {
-        "@angular-devkit/core": "17.3.5",
-        "@angular-devkit/schematics": "17.3.5",
-        "jsonc-parser": "3.2.1"
+        "@angular-devkit/core": "18.1.1",
+        "@angular-devkit/schematics": "18.1.1",
+        "jsonc-parser": "3.3.1"
       },
       "engines": {
-        "node": "^18.13.0 || >=20.9.0",
+        "node": "^18.19.1 || ^20.11.1 || >=22.0.0",
         "npm": "^6.11.0 || ^7.5.6 || >=8.0.0",
         "yarn": ">= 1.13.0"
       }
     },
     "node_modules/@sigstore/bundle": {
-      "version": "2.3.1",
-      "resolved": "https://registry.npmjs.org/@sigstore/bundle/-/bundle-2.3.1.tgz",
-      "integrity": "sha512-eqV17lO3EIFqCWK3969Rz+J8MYrRZKw9IBHpSo6DEcEX2c+uzDFOgHE9f2MnyDpfs48LFO4hXmk9KhQ74JzU1g==",
+      "version": "2.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/bundle/-/bundle-2.3.2.tgz",
+      "integrity": "sha512-wueKWDk70QixNLB363yHc2D2ItTgYiMTdPwK8D9dKQMR3ZQ0c35IxP5xnwQ8cNLoCgCRcHf14kE+CLIvNX1zmA==",
       "dev": true,
       "dependencies": {
-        "@sigstore/protobuf-specs": "^0.3.1"
+        "@sigstore/protobuf-specs": "^0.3.2"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
@@ -4317,60 +4822,74 @@
       }
     },
     "node_modules/@sigstore/protobuf-specs": {
-      "version": "0.3.1",
-      "resolved": "https://registry.npmjs.org/@sigstore/protobuf-specs/-/protobuf-specs-0.3.1.tgz",
-      "integrity": "sha512-aIL8Z9NsMr3C64jyQzE0XlkEyBLpgEJJFDHLVVStkFV5Q3Il/r/YtY6NJWKQ4cy4AE7spP1IX5Jq7VCAxHHMfQ==",
+      "version": "0.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/protobuf-specs/-/protobuf-specs-0.3.2.tgz",
+      "integrity": "sha512-c6B0ehIWxMI8wiS/bj6rHMPqeFvngFV7cDU/MY+B16P9Z3Mp9k8L93eYZ7BYzSickzuqAQqAq0V956b3Ju6mLw==",
       "dev": true,
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
     "node_modules/@sigstore/sign": {
-      "version": "2.3.0",
-      "resolved": "https://registry.npmjs.org/@sigstore/sign/-/sign-2.3.0.tgz",
-      "integrity": "sha512-tsAyV6FC3R3pHmKS880IXcDJuiFJiKITO1jxR1qbplcsBkZLBmjrEw5GbC7ikD6f5RU1hr7WnmxB/2kKc1qUWQ==",
+      "version": "2.3.2",
+      "resolved": "https://registry.npmjs.org/@sigstore/sign/-/sign-2.3.2.tgz",
+      "integrity": "sha512-5Vz5dPVuunIIvC5vBb0APwo7qKA4G9yM48kPWJT+OEERs40md5GoUR1yedwpekWZ4m0Hhw44m6zU+ObsON+iDA==",
       "dev": true,
       "dependencies": {
-        "@sigstore/bundle": "^2.3.0",
+        "@sigstore/bundle": "^2.3.2",
         "@sigstore/core": "^1.0.0",
-        "@sigstore/protobuf-specs": "^0.3.1",
-        "make-fetch-happen": "^13.0.0"
+        "@sigstore/protobuf-specs": "^0.3.2",
+        "make-fetch-happen": "^13.0.1",
+        "proc-log": "^4.2.0",
+        "promise-retry": "^2.0.1"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
     "node_modules/@sigstore/tuf": {
-      "version": "2.3.2",
-      "resolved": "https://registry.npmjs.org/@sigstore/tuf/-/tuf-2.3.2.tgz",
-      "integrity": "sha512-mwbY1VrEGU4CO55t+Kl6I7WZzIl+ysSzEYdA1Nv/FTrl2bkeaPXo5PnWZAVfcY2zSdhOpsUTJW67/M2zHXGn5w==",
+      "version": "2.3.4",
+      "resolved": "https://registry.npmjs.org/@sigstore/tuf/-/tuf-2.3.4.tgz",
+      "integrity": "sha512-44vtsveTPUpqhm9NCrbU8CWLe3Vck2HO1PNLw7RIajbB7xhtn5RBPm1VNSCMwqGYHhDsBJG8gDF0q4lgydsJvw==",
       "dev": true,
       "dependencies": {
-        "@sigstore/protobuf-specs": "^0.3.0",
-        "tuf-js": "^2.2.0"
+        "@sigstore/protobuf-specs": "^0.3.2",
+        "tuf-js": "^2.2.1"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
     "node_modules/@sigstore/verify": {
-      "version": "1.2.0",
-      "resolved": "https://registry.npmjs.org/@sigstore/verify/-/verify-1.2.0.tgz",
-      "integrity": "sha512-hQF60nc9yab+Csi4AyoAmilGNfpXT+EXdBgFkP9OgPwIBPwyqVf7JAWPtmqrrrneTmAT6ojv7OlH1f6Ix5BG4Q==",
+      "version": "1.2.1",
+      "resolved": "https://registry.npmjs.org/@sigstore/verify/-/verify-1.2.1.tgz",
+      "integrity": "sha512-8iKx79/F73DKbGfRf7+t4dqrc0bRr0thdPrxAtCKWRm/F0tG71i6O1rvlnScncJLLBZHn3h8M3c1BSUAb9yu8g==",
       "dev": true,
       "dependencies": {
-        "@sigstore/bundle": "^2.3.1",
+        "@sigstore/bundle": "^2.3.2",
         "@sigstore/core": "^1.1.0",
-        "@sigstore/protobuf-specs": "^0.3.1"
+        "@sigstore/protobuf-specs": "^0.3.2"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
+    "node_modules/@sindresorhus/merge-streams": {
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@sindresorhus/merge-streams/-/merge-streams-2.3.0.tgz",
+      "integrity": "sha512-LtoMMhxAlorcGhmFYI+LhPgbPZCkgP6ra1YL604EeF6U98pLlQ3iWIGMdWSC+vWmPBWBNgmDBAhnAobLROJmwg==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/@socket.io/component-emitter": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/@socket.io/component-emitter/-/component-emitter-3.1.1.tgz",
-      "integrity": "sha512-dzJtaDAAoXx4GCOJpbB2eG/Qj8VDpdwkLsWGzGm+0L7E8/434RyMbAHmk9ubXWVAb9nXmc44jUf8GKqVDiKezg==",
+      "version": "3.1.2",
+      "resolved": "https://registry.npmjs.org/@socket.io/component-emitter/-/component-emitter-3.1.2.tgz",
+      "integrity": "sha512-9BCxFwvbGg/RsZK9tjXd8s4UcwR0MWeFQ1XEKIQVVvAGJyINdrqKMcTRyLoK8Rse1GjzLV9cwjWV1olXRWEXVA==",
       "dev": true
     },
     "node_modules/@tufjs/canonical-json": {
@@ -4383,13 +4902,13 @@
       }
     },
     "node_modules/@tufjs/models": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/@tufjs/models/-/models-2.0.0.tgz",
-      "integrity": "sha512-c8nj8BaOExmZKO2DXhDfegyhSGcG9E/mPN3U13L+/PsoWm1uaGiHHjxqSHQiasDBQwDA3aHuw9+9spYAP1qvvg==",
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/@tufjs/models/-/models-2.0.1.tgz",
+      "integrity": "sha512-92F7/SFyufn4DXsha9+QfKnN03JGqtMFMXgSHbZOo8JG59WkTni7UzAouNQDf7AuP9OAMxVOPQcqG3sB7w+kkg==",
       "dev": true,
       "dependencies": {
         "@tufjs/canonical-json": "2.0.0",
-        "minimatch": "^9.0.3"
+        "minimatch": "^9.0.4"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
@@ -4405,9 +4924,9 @@
       }
     },
     "node_modules/@tufjs/models/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
       "dev": true,
       "dependencies": {
         "brace-expansion": "^2.0.1"
@@ -4511,9 +5030,9 @@
       }
     },
     "node_modules/@types/express-serve-static-core": {
-      "version": "4.19.0",
-      "resolved": "https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.0.tgz",
-      "integrity": "sha512-bGyep3JqPCRry1wq+O5n7oiBgGWmeIJXPjXXCo8EK0u8duZGSYar7cGqd3ML2JUsLGeB7fmc06KYo9fLGWqPvQ==",
+      "version": "4.19.5",
+      "resolved": "https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.5.tgz",
+      "integrity": "sha512-y6W03tvrACO72aijJ5uF02FRq5cgDR9lUxddQ8vyF+GvmjJQqbzDcJngEjURc+ZsG31VI3hODNZJ2URj86pzmg==",
       "dev": true,
       "dependencies": {
         "@types/node": "*",
@@ -4555,10 +5074,19 @@
       "integrity": "sha512-/pyBZWSLD2n0dcHE3hq8s8ZvcETHtEuF+3E7XVt0Ig2nvsVQXdghHVcEkIWjy9A0wKfTn97a/PSDYohKIlnP/w==",
       "dev": true
     },
+    "node_modules/@types/mute-stream": {
+      "version": "0.0.4",
+      "resolved": "https://registry.npmjs.org/@types/mute-stream/-/mute-stream-0.0.4.tgz",
+      "integrity": "sha512-CPM9nzrCPPJHQNA9keH9CVkVI+WR5kMa+7XEs5jcGQ0VoAGnLv242w8lIVgwAEfmE4oufJRaTc9PNLQl0ioAow==",
+      "dev": true,
+      "dependencies": {
+        "@types/node": "*"
+      }
+    },
     "node_modules/@types/node": {
-      "version": "20.12.7",
-      "resolved": "https://registry.npmjs.org/@types/node/-/node-20.12.7.tgz",
-      "integrity": "sha512-wq0cICSkRLVaf3UGLMGItu/PtdY7oaXaI/RVU+xliKVOtRna3PRY57ZDfztpDL0n11vfymMUnXv8QwYCO7L1wg==",
+      "version": "20.14.11",
+      "resolved": "https://registry.npmjs.org/@types/node/-/node-20.14.11.tgz",
+      "integrity": "sha512-kprQpL8MMeszbz6ojB5/tU8PLN4kesnN8Gjzw349rDlNgsSzg90lAVj3llK99Dh7JON+t9AuscPPFW6mPbTnSA==",
       "dev": true,
       "dependencies": {
         "undici-types": "~5.26.4"
@@ -4586,9 +5114,9 @@
       "dev": true
     },
     "node_modules/@types/retry": {
-      "version": "0.12.0",
-      "resolved": "https://registry.npmjs.org/@types/retry/-/retry-0.12.0.tgz",
-      "integrity": "sha512-wWKOClTTiizcZhXnPY4wikVAwmdYHp8q6DmC+EJUzAMsycb7HB32Kh9RN4+0gExjmPmZSAQjgURXIGATPegAvA==",
+      "version": "0.12.2",
+      "resolved": "https://registry.npmjs.org/@types/retry/-/retry-0.12.2.tgz",
+      "integrity": "sha512-XISRgDJ2Tc5q4TRqvgJtzsRkFYNJzZrhTdtMoGVBttwzzQJkPnS3WWTFc7kuDRoPtPakl+T+OfdEUjYJj7Jbow==",
       "dev": true
     },
     "node_modules/@types/send": {
@@ -4630,10 +5158,16 @@
         "@types/node": "*"
       }
     },
+    "node_modules/@types/wrap-ansi": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/@types/wrap-ansi/-/wrap-ansi-3.0.0.tgz",
+      "integrity": "sha512-ltIpx+kM7g/MLRZfkbL7EsCEjfzCcScLpkg37eXEtx5kmrAKBkTJwd1GIAjDSL8wTpM6Hzn5YO4pSb91BEwu1g==",
+      "dev": true
+    },
     "node_modules/@types/ws": {
-      "version": "8.5.10",
-      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-8.5.10.tgz",
-      "integrity": "sha512-vmQSUcfalpIq0R9q7uTo2lXs6eGIpt9wtnLdMv9LVpIjCA/+ufZRozlVoVelIYixx1ugCBKDhn89vnsEGOCx9A==",
+      "version": "8.5.11",
+      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-8.5.11.tgz",
+      "integrity": "sha512-4+q7P5h3SpJxaBft0Dzpbr6lmMaqh0Jr2tbhJZ/luAwvD7ohSCniYkwz/pLxuT2h0EOa6QADgJj1Ko+TzRfZ+w==",
       "dev": true,
       "dependencies": {
         "@types/node": "*"
@@ -4838,9 +5372,9 @@
       }
     },
     "node_modules/acorn": {
-      "version": "8.11.3",
-      "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.11.3.tgz",
-      "integrity": "sha512-Y9rRfJG5jcKOE0CLisYbojUjIrIEE7AGMzA/Sm4BslANhbS+cDMpgBdcPT91oJ7OuJ9hYJBx59RjbhxVnrF8Xg==",
+      "version": "8.12.1",
+      "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.12.1.tgz",
+      "integrity": "sha512-tcpGyI9zbizT9JbV6oYE477V6mTlXvvi0T0G3SNIYE2apm/G5huBa1+K89VGeovbg+jycCrfhl3ADxErOuO6Jg==",
       "dev": true,
       "bin": {
         "acorn": "bin/acorn"
@@ -4849,10 +5383,10 @@
         "node": ">=0.4.0"
       }
     },
-    "node_modules/acorn-import-assertions": {
-      "version": "1.9.0",
-      "resolved": "https://registry.npmjs.org/acorn-import-assertions/-/acorn-import-assertions-1.9.0.tgz",
-      "integrity": "sha512-cmMwop9x+8KFhxvKrKfPYmN6/pKTYYHBqLa0DfvVZcKMJWNyWLnaqND7dx/qn66R7ewM1UX5XMaDVP5wlVTaVA==",
+    "node_modules/acorn-import-attributes": {
+      "version": "1.9.5",
+      "resolved": "https://registry.npmjs.org/acorn-import-attributes/-/acorn-import-attributes-1.9.5.tgz",
+      "integrity": "sha512-n02Vykv5uA3eHGM/Z2dQrcD56kL8TyDb2p1+0P83PClMnC/nc+anbQRhIOWnSq4Ke/KvDPrY3C9hDtC/A3eHnQ==",
       "dev": true,
       "peerDependencies": {
         "acorn": "^8"
@@ -4911,15 +5445,15 @@
       }
     },
     "node_modules/ajv": {
-      "version": "8.12.0",
-      "resolved": "https://registry.npmjs.org/ajv/-/ajv-8.12.0.tgz",
-      "integrity": "sha512-sRu1kpcO9yLtYxBKvqfTeh9KzZEwO3STyX1HT+4CaDzC6HpTGYhIhPIzj9XuKU7KYDwnaeh5hcOwjy1QuJzBPA==",
+      "version": "8.16.0",
+      "resolved": "https://registry.npmjs.org/ajv/-/ajv-8.16.0.tgz",
+      "integrity": "sha512-F0twR8U1ZU67JIEtekUcLkXkoO5mMMmgGD8sK/xUFzJ805jxHQl92hImFAqqXMyMYjSPOyUPAwHYhB72g5sTXw==",
       "dev": true,
       "dependencies": {
-        "fast-deep-equal": "^3.1.1",
+        "fast-deep-equal": "^3.1.3",
         "json-schema-traverse": "^1.0.0",
         "require-from-string": "^2.0.2",
-        "uri-js": "^4.2.2"
+        "uri-js": "^4.4.1"
       },
       "funding": {
         "type": "github",
@@ -4927,9 +5461,9 @@
       }
     },
     "node_modules/ajv-formats": {
-      "version": "2.1.1",
-      "resolved": "https://registry.npmjs.org/ajv-formats/-/ajv-formats-2.1.1.tgz",
-      "integrity": "sha512-Wx0Kx52hxE7C18hkMEggYlEifqWZtYaRgouJor+WMdPnQyEK13vgEWyVNup7SoeeoLMsr4kf5h6dOW11I15MUA==",
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/ajv-formats/-/ajv-formats-3.0.1.tgz",
+      "integrity": "sha512-8iUql50EUR+uUcdRQ3HDqa6EVyo3docL8g5WJ3FNcWmu62IbkGUue/pEyLBW8VGKKucTPgqeks4fIU1DA4yowQ==",
       "dev": true,
       "dependencies": {
         "ajv": "^8.0.0"
@@ -5038,13 +5572,10 @@
       }
     },
     "node_modules/argparse": {
-      "version": "1.0.10",
-      "resolved": "https://registry.npmjs.org/argparse/-/argparse-1.0.10.tgz",
-      "integrity": "sha512-o5Roy6tNG4SL/FOkCAN6RzjiakZS25RLYFrcMttJqbdd8BWrnA+fGz57iN5Pb06pvBGvl5gQ0B48dJlslXvoTg==",
-      "dev": true,
-      "dependencies": {
-        "sprintf-js": "~1.0.2"
-      }
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
+      "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
+      "dev": true
     },
     "node_modules/array-flatten": {
       "version": "1.1.1",
@@ -5053,9 +5584,9 @@
       "dev": true
     },
     "node_modules/autoprefixer": {
-      "version": "10.4.18",
-      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.18.tgz",
-      "integrity": "sha512-1DKbDfsr6KUElM6wg+0zRNkB/Q7WcKYAaK+pzXn+Xqmszm/5Xa9coeNdtP88Vi+dPzZnMjhge8GIV49ZQkDa+g==",
+      "version": "10.4.19",
+      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.19.tgz",
+      "integrity": "sha512-BaENR2+zBZ8xXhM4pUaKUxlVdxZ0EZhjvbopwnXmxRUfqDmwSpC2lAi/QXvx7NRdPCo1WKEcEF6mV64si1z4Ew==",
       "dev": true,
       "funding": [
         {
@@ -5073,7 +5604,7 @@
       ],
       "dependencies": {
         "browserslist": "^4.23.0",
-        "caniuse-lite": "^1.0.30001591",
+        "caniuse-lite": "^1.0.30001599",
         "fraction.js": "^4.3.7",
         "normalize-range": "^0.1.2",
         "picocolors": "^1.0.0",
@@ -5106,22 +5637,6 @@
         "webpack": ">=5"
       }
     },
-    "node_modules/babel-plugin-istanbul": {
-      "version": "6.1.1",
-      "resolved": "https://registry.npmjs.org/babel-plugin-istanbul/-/babel-plugin-istanbul-6.1.1.tgz",
-      "integrity": "sha512-Y1IQok9821cC9onCx5otgFfRm7Lm+I+wwxOx738M/WLPZ9Q42m4IG5W0FNX8WLL2gYMZo3JkuXIH2DOpWM+qwA==",
-      "dev": true,
-      "dependencies": {
-        "@babel/helper-plugin-utils": "^7.0.0",
-        "@istanbuljs/load-nyc-config": "^1.0.0",
-        "@istanbuljs/schema": "^0.1.2",
-        "istanbul-lib-instrument": "^5.0.4",
-        "test-exclude": "^6.0.0"
-      },
-      "engines": {
-        "node": ">=8"
-      }
-    },
     "node_modules/babel-plugin-polyfill-corejs2": {
       "version": "0.4.11",
       "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-corejs2/-/babel-plugin-polyfill-corejs2-0.4.11.tgz",
@@ -5146,57 +5661,25 @@
       }
     },
     "node_modules/babel-plugin-polyfill-corejs3": {
-      "version": "0.9.0",
-      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-corejs3/-/babel-plugin-polyfill-corejs3-0.9.0.tgz",
-      "integrity": "sha512-7nZPG1uzK2Ymhy/NbaOWTg3uibM2BmGASS4vHS4szRZAIR8R6GwA/xAujpdrXU5iyklrimWnLWU+BLF9suPTqg==",
-      "dev": true,
-      "dependencies": {
-        "@babel/helper-define-polyfill-provider": "^0.5.0",
-        "core-js-compat": "^3.34.0"
-      },
-      "peerDependencies": {
-        "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
-      }
-    },
-    "node_modules/babel-plugin-polyfill-corejs3/node_modules/@babel/helper-define-polyfill-provider": {
-      "version": "0.5.0",
-      "resolved": "https://registry.npmjs.org/@babel/helper-define-polyfill-provider/-/helper-define-polyfill-provider-0.5.0.tgz",
-      "integrity": "sha512-NovQquuQLAQ5HuyjCz7WQP9MjRj7dx++yspwiyUiGl9ZyadHRSql1HZh5ogRd8W8w6YM6EQ/NTB8rgjLt5W65Q==",
+      "version": "0.10.4",
+      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-corejs3/-/babel-plugin-polyfill-corejs3-0.10.4.tgz",
+      "integrity": "sha512-25J6I8NGfa5YkCDogHRID3fVCadIR8/pGl1/spvCkzb6lVn6SR3ojpx9nOn9iEBcUsjY24AmdKm5khcfKdylcg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-compilation-targets": "^7.22.6",
-        "@babel/helper-plugin-utils": "^7.22.5",
-        "debug": "^4.1.1",
-        "lodash.debounce": "^4.0.8",
-        "resolve": "^1.14.2"
+        "@babel/helper-define-polyfill-provider": "^0.6.1",
+        "core-js-compat": "^3.36.1"
       },
       "peerDependencies": {
         "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
       }
     },
     "node_modules/babel-plugin-polyfill-regenerator": {
-      "version": "0.5.5",
-      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-regenerator/-/babel-plugin-polyfill-regenerator-0.5.5.tgz",
-      "integrity": "sha512-OJGYZlhLqBh2DDHeqAxWB1XIvr49CxiJ2gIt61/PU55CQK4Z58OzMqjDe1zwQdQk+rBYsRc+1rJmdajM3gimHg==",
-      "dev": true,
-      "dependencies": {
-        "@babel/helper-define-polyfill-provider": "^0.5.0"
-      },
-      "peerDependencies": {
-        "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
-      }
-    },
-    "node_modules/babel-plugin-polyfill-regenerator/node_modules/@babel/helper-define-polyfill-provider": {
-      "version": "0.5.0",
-      "resolved": "https://registry.npmjs.org/@babel/helper-define-polyfill-provider/-/helper-define-polyfill-provider-0.5.0.tgz",
-      "integrity": "sha512-NovQquuQLAQ5HuyjCz7WQP9MjRj7dx++yspwiyUiGl9ZyadHRSql1HZh5ogRd8W8w6YM6EQ/NTB8rgjLt5W65Q==",
+      "version": "0.6.2",
+      "resolved": "https://registry.npmjs.org/babel-plugin-polyfill-regenerator/-/babel-plugin-polyfill-regenerator-0.6.2.tgz",
+      "integrity": "sha512-2R25rQZWP63nGwaAswvDazbPXfrM3HwVoBXK6HcqeKrSrL/JqcC/rDcf95l4r7LXLyxDXc8uQDa064GubtCABg==",
       "dev": true,
       "dependencies": {
-        "@babel/helper-compilation-targets": "^7.22.6",
-        "@babel/helper-plugin-utils": "^7.22.5",
-        "debug": "^4.1.1",
-        "lodash.debounce": "^4.0.8",
-        "resolve": "^1.14.2"
+        "@babel/helper-define-polyfill-provider": "^0.6.2"
       },
       "peerDependencies": {
         "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
@@ -5341,21 +5824,21 @@
       }
     },
     "node_modules/braces": {
-      "version": "3.0.2",
-      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.2.tgz",
-      "integrity": "sha512-b8um+L1RzM3WDSzvhm6gIz1yfTbBt6YTlcEKAvsmqCZZFw46z626lVj9j1yEPW33H5H+lBQpZMP1k8l+78Ha0A==",
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
+      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
       "dev": true,
       "dependencies": {
-        "fill-range": "^7.0.1"
+        "fill-range": "^7.1.1"
       },
       "engines": {
         "node": ">=8"
       }
     },
     "node_modules/browserslist": {
-      "version": "4.23.0",
-      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.23.0.tgz",
-      "integrity": "sha512-QW8HiM1shhT2GuzkvklfjcKDiWFXHOeFCIA/huJPwHsslwcydgk7X+z2zXpEijP98UCY7HbubZt5J2Zgvf0CaQ==",
+      "version": "4.23.2",
+      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.23.2.tgz",
+      "integrity": "sha512-qkqSyistMYdxAcw+CzbZwlBy8AGmS/eEWs+sEV5TnLRGDOL+C5M2EnH6tlZyg0YoAxGJAFKh61En9BR941GnHA==",
       "dev": true,
       "funding": [
         {
@@ -5372,10 +5855,10 @@
         }
       ],
       "dependencies": {
-        "caniuse-lite": "^1.0.30001587",
-        "electron-to-chromium": "^1.4.668",
+        "caniuse-lite": "^1.0.30001640",
+        "electron-to-chromium": "^1.4.820",
         "node-releases": "^2.0.14",
-        "update-browserslist-db": "^1.0.13"
+        "update-browserslist-db": "^1.1.0"
       },
       "bin": {
         "browserslist": "cli.js"
@@ -5414,13 +5897,19 @@
       "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
       "dev": true
     },
-    "node_modules/builtins": {
-      "version": "5.1.0",
-      "resolved": "https://registry.npmjs.org/builtins/-/builtins-5.1.0.tgz",
-      "integrity": "sha512-SW9lzGTLvWTP1AY8xeAMZimqDrIaSdLQUcVr9DMef51niJ022Ri87SwRRKYm4A6iHfkPaiVUu/Duw2Wc4J7kKg==",
+    "node_modules/bundle-name": {
+      "version": "4.1.0",
+      "resolved": "https://registry.npmjs.org/bundle-name/-/bundle-name-4.1.0.tgz",
+      "integrity": "sha512-tjwM5exMg6BGRI+kNmTntNsvdZS1X8BFYS6tnJ2hdH0kVxM6/eVZ2xy+FqStSWvYmtfFMDLIxurorHwDKfDz5Q==",
       "dev": true,
       "dependencies": {
-        "semver": "^7.0.0"
+        "run-applescript": "^7.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/bytes": {
@@ -5433,9 +5922,9 @@
       }
     },
     "node_modules/cacache": {
-      "version": "18.0.2",
-      "resolved": "https://registry.npmjs.org/cacache/-/cacache-18.0.2.tgz",
-      "integrity": "sha512-r3NU8h/P+4lVUHfeRw1dtgQYar3DZMm4/cm2bZgOvrFC/su7budSOeqh52VJIC4U4iG1WWwV6vRW0znqBvxNuw==",
+      "version": "18.0.4",
+      "resolved": "https://registry.npmjs.org/cacache/-/cacache-18.0.4.tgz",
+      "integrity": "sha512-B+L5iIa9mgcjLbliir2th36yEwPftrzteHYujzsx3dFP/31GCHcIeS8f5MGd80odLOjaOvSpU3EEAmRQptkxLQ==",
       "dev": true,
       "dependencies": {
         "@npmcli/fs": "^3.1.0",
@@ -5465,40 +5954,35 @@
       }
     },
     "node_modules/cacache/node_modules/glob": {
-      "version": "10.3.12",
-      "resolved": "https://registry.npmjs.org/glob/-/glob-10.3.12.tgz",
-      "integrity": "sha512-TCNv8vJ+xz4QiqTpfOJA7HvYv+tNIRHKfUWw/q+v2jdgN4ebz+KY9tGx5J4rHP0o84mNP+ApH66HRX8us3Khqg==",
+      "version": "10.4.5",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
+      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
       "dev": true,
       "dependencies": {
         "foreground-child": "^3.1.0",
-        "jackspeak": "^2.3.6",
-        "minimatch": "^9.0.1",
-        "minipass": "^7.0.4",
-        "path-scurry": "^1.10.2"
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
       },
       "bin": {
         "glob": "dist/esm/bin.mjs"
       },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       }
     },
     "node_modules/cacache/node_modules/lru-cache": {
-      "version": "10.2.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.2.0.tgz",
-      "integrity": "sha512-2bIM8x+VAf6JT4bKAljS1qUWgMsqZRPGJS6FSahIMPVvctcNhyVp7AJu7quxOW9jwkryBReKZY5tY5JYv2n/7Q==",
-      "dev": true,
-      "engines": {
-        "node": "14 || >=16.14"
-      }
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
     "node_modules/cacache/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
       "dev": true,
       "dependencies": {
         "brace-expansion": "^2.0.1"
@@ -5538,19 +6022,10 @@
         "node": ">=6"
       }
     },
-    "node_modules/camelcase": {
-      "version": "5.3.1",
-      "resolved": "https://registry.npmjs.org/camelcase/-/camelcase-5.3.1.tgz",
-      "integrity": "sha512-L28STB170nwWS63UjtlEOE3dldQApaJXZkOI1uMFfzf3rRuPegHaHesyee+YxQ+W6SvRDQV6UrdOdRiR153wJg==",
-      "dev": true,
-      "engines": {
-        "node": ">=6"
-      }
-    },
     "node_modules/caniuse-lite": {
-      "version": "1.0.30001612",
-      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001612.tgz",
-      "integrity": "sha512-lFgnZ07UhaCcsSZgWW0K5j4e69dK1u/ltrL9lTUiFOwNHs12S3UMIEYgBV0Z6C6hRDev7iRnMzzYmKabYdXF9g==",
+      "version": "1.0.30001642",
+      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001642.tgz",
+      "integrity": "sha512-3XQ0DoRgLijXJErLSl+bLnJ+Et4KqV1PY6JJBGAFlsNsz31zeAIncyeZfLCabHK/jtSh+671RM9YMldxjUPZtA==",
       "dev": true,
       "funding": [
         {
@@ -5621,9 +6096,9 @@
       }
     },
     "node_modules/chrome-trace-event": {
-      "version": "1.0.3",
-      "resolved": "https://registry.npmjs.org/chrome-trace-event/-/chrome-trace-event-1.0.3.tgz",
-      "integrity": "sha512-p3KULyQg4S7NIHixdwbGX+nFHkoBiA4YQmyWtjb8XngSKV124nJmRysgAeujbUVb15vh+RvFUfCPqU7rXk+hZg==",
+      "version": "1.0.4",
+      "resolved": "https://registry.npmjs.org/chrome-trace-event/-/chrome-trace-event-1.0.4.tgz",
+      "integrity": "sha512-rNjApaLzuwaOTjCiT8lSDdGN1APCiqkChLMJxJPWLunPAt5fy8xgU9/jNOchV84wfIxrA0lRQB7oCT8jrn/wrQ==",
       "dev": true,
       "engines": {
         "node": ">=6.0"
@@ -5639,15 +6114,18 @@
       }
     },
     "node_modules/cli-cursor": {
-      "version": "3.1.0",
-      "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-3.1.0.tgz",
-      "integrity": "sha512-I/zHAwsKf9FqGoXM4WWRACob9+SNukZTd94DWF57E4toouRulbCxcUh6RKUEOQlYTHJnzkPMySvPNaaSLNfLZw==",
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-4.0.0.tgz",
+      "integrity": "sha512-VGtlMu3x/4DOtIUwEkRezxUZ2lBacNJCHash0N0WeZDBS+7Ux1dm3XWAgWYxLJFMMdOeXMHXorshEFhbMSGelg==",
       "dev": true,
       "dependencies": {
-        "restore-cursor": "^3.1.0"
+        "restore-cursor": "^4.0.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/cli-spinners": {
@@ -5662,6 +6140,22 @@
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
+    "node_modules/cli-truncate": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/cli-truncate/-/cli-truncate-4.0.0.tgz",
+      "integrity": "sha512-nPdaFdQ0h/GEigbPClz11D0v/ZJEwxmeVZGeMo3Z5StPtUTkA9o1lD6QwoirYiSDzbcwn2XcjwmCp68W1IS4TA==",
+      "dev": true,
+      "dependencies": {
+        "slice-ansi": "^5.0.0",
+        "string-width": "^7.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/cli-width": {
       "version": "4.1.0",
       "resolved": "https://registry.npmjs.org/cli-width/-/cli-width-4.1.0.tgz",
@@ -5718,6 +6212,35 @@
       "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
       "dev": true
     },
+    "node_modules/cliui/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/cliui/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/cliui/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/cliui/node_modules/wrap-ansi": {
       "version": "7.0.0",
       "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
@@ -5951,20 +6474,20 @@
       }
     },
     "node_modules/copy-webpack-plugin": {
-      "version": "11.0.0",
-      "resolved": "https://registry.npmjs.org/copy-webpack-plugin/-/copy-webpack-plugin-11.0.0.tgz",
-      "integrity": "sha512-fX2MWpamkW0hZxMEg0+mYnA40LTosOSa5TqZ9GYIBzyJa9C3QUaMPSE2xAi/buNr8u89SfD9wHSQVBzrRa/SOQ==",
+      "version": "12.0.2",
+      "resolved": "https://registry.npmjs.org/copy-webpack-plugin/-/copy-webpack-plugin-12.0.2.tgz",
+      "integrity": "sha512-SNwdBeHyII+rWvee/bTnAYyO8vfVdcSTud4EIb6jcZ8inLeWucJE0DnxXQBjlQ5zlteuuvooGQy3LIyGxhvlOA==",
       "dev": true,
       "dependencies": {
-        "fast-glob": "^3.2.11",
+        "fast-glob": "^3.3.2",
         "glob-parent": "^6.0.1",
-        "globby": "^13.1.1",
+        "globby": "^14.0.0",
         "normalize-path": "^3.0.0",
-        "schema-utils": "^4.0.0",
-        "serialize-javascript": "^6.0.0"
+        "schema-utils": "^4.2.0",
+        "serialize-javascript": "^6.0.2"
       },
       "engines": {
-        "node": ">= 14.15.0"
+        "node": ">= 18.12.0"
       },
       "funding": {
         "type": "opencollective",
@@ -5987,9 +6510,9 @@
       }
     },
     "node_modules/core-js-compat": {
-      "version": "3.37.0",
-      "resolved": "https://registry.npmjs.org/core-js-compat/-/core-js-compat-3.37.0.tgz",
-      "integrity": "sha512-vYq4L+T8aS5UuFg4UwDhc7YNRWVeVZwltad9C/jV3R2LgVOpS9BDr7l/WL6BN0dbV3k1XejPTHqqEzJgsa0frA==",
+      "version": "3.37.1",
+      "resolved": "https://registry.npmjs.org/core-js-compat/-/core-js-compat-3.37.1.tgz",
+      "integrity": "sha512-9TNiImhKvQqSUkOvk/mMRZzOANTiEVC7WaBNhHcKM7x+/5E1l5NvsysR19zuDQScE8k+kfQXWRN3AtS/eOSHpg==",
       "dev": true,
       "dependencies": {
         "browserslist": "^4.23.0"
@@ -6032,40 +6555,22 @@
       "engines": {
         "node": ">=14"
       },
-      "funding": {
-        "url": "https://github.com/sponsors/d-fischer"
-      },
-      "peerDependencies": {
-        "typescript": ">=4.9.5"
-      },
-      "peerDependenciesMeta": {
-        "typescript": {
-          "optional": true
-        }
-      }
-    },
-    "node_modules/cosmiconfig/node_modules/argparse": {
-      "version": "2.0.1",
-      "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
-      "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
-      "dev": true
-    },
-    "node_modules/cosmiconfig/node_modules/js-yaml": {
-      "version": "4.1.0",
-      "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.0.tgz",
-      "integrity": "sha512-wpxZs9NoxZaJESJGIZTyDEaYpl0FKSA+FB9aJiyemKhMwkxQg63h4T1KJgUGHpTqPDNRcmmYLugrRjJlBtWvRA==",
-      "dev": true,
-      "dependencies": {
-        "argparse": "^2.0.1"
-      },
-      "bin": {
-        "js-yaml": "bin/js-yaml.js"
+      "funding": {
+        "url": "https://github.com/sponsors/d-fischer"
+      },
+      "peerDependencies": {
+        "typescript": ">=4.9.5"
+      },
+      "peerDependenciesMeta": {
+        "typescript": {
+          "optional": true
+        }
       }
     },
     "node_modules/critters": {
-      "version": "0.0.22",
-      "resolved": "https://registry.npmjs.org/critters/-/critters-0.0.22.tgz",
-      "integrity": "sha512-NU7DEcQZM2Dy8XTKFHxtdnIM/drE312j2T4PCVaSUcS0oBeyT/NImpRw/Ap0zOr/1SE7SgPK9tGPg1WK/sVakw==",
+      "version": "0.0.24",
+      "resolved": "https://registry.npmjs.org/critters/-/critters-0.0.24.tgz",
+      "integrity": "sha512-Oyqew0FGM0wYUSNqR0L6AteO5MpMoUU0rhKRieXeiKs+PmRTxiJMyaunYB2KF6fQ3dzChXKCpbFOEJx3OQ1v/Q==",
       "dev": true,
       "dependencies": {
         "chalk": "^4.1.0",
@@ -6177,22 +6682,22 @@
       }
     },
     "node_modules/css-loader": {
-      "version": "6.10.0",
-      "resolved": "https://registry.npmjs.org/css-loader/-/css-loader-6.10.0.tgz",
-      "integrity": "sha512-LTSA/jWbwdMlk+rhmElbDR2vbtQoTBPr7fkJE+mxrHj+7ru0hUmHafDRzWIjIHTwpitWVaqY2/UWGRca3yUgRw==",
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/css-loader/-/css-loader-7.1.2.tgz",
+      "integrity": "sha512-6WvYYn7l/XEGN8Xu2vWFt9nVzrCn39vKyTEFf/ExEyoksJjjSZV/0/35XPlMbpnr6VGhZIUg5yJrL8tGfes/FA==",
       "dev": true,
       "dependencies": {
         "icss-utils": "^5.1.0",
         "postcss": "^8.4.33",
-        "postcss-modules-extract-imports": "^3.0.0",
-        "postcss-modules-local-by-default": "^4.0.4",
-        "postcss-modules-scope": "^3.1.1",
+        "postcss-modules-extract-imports": "^3.1.0",
+        "postcss-modules-local-by-default": "^4.0.5",
+        "postcss-modules-scope": "^3.2.0",
         "postcss-modules-values": "^4.0.0",
         "postcss-value-parser": "^4.2.0",
         "semver": "^7.5.4"
       },
       "engines": {
-        "node": ">= 12.13.0"
+        "node": ">= 18.12.0"
       },
       "funding": {
         "type": "opencollective",
@@ -6200,7 +6705,7 @@
       },
       "peerDependencies": {
         "@rspack/core": "0.x || 1.x",
-        "webpack": "^5.0.0"
+        "webpack": "^5.27.0"
       },
       "peerDependenciesMeta": {
         "@rspack/core": {
@@ -6267,9 +6772,9 @@
       }
     },
     "node_modules/debug": {
-      "version": "4.3.4",
-      "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.4.tgz",
-      "integrity": "sha512-PRWFHuSU3eDtQJPvnNY7Jcket1j0t5OuOsFzPPzsekD52Zl8qUfFIPEiswXqIvHWGVHOgX+7G/vCNNhehwxfkQ==",
+      "version": "4.3.5",
+      "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.5.tgz",
+      "integrity": "sha512-pt0bNEmneDIvdL1Xsd9oDQ/wrQRkXDT4AUWlNZNPKvW5x/jyO9VFXkJUP07vQ2upmw5PlaITaPKc31jK13V+jg==",
       "dev": true,
       "dependencies": {
         "ms": "2.1.2"
@@ -6283,6 +6788,34 @@
         }
       }
     },
+    "node_modules/default-browser": {
+      "version": "5.2.1",
+      "resolved": "https://registry.npmjs.org/default-browser/-/default-browser-5.2.1.tgz",
+      "integrity": "sha512-WY/3TUME0x3KPYdRRxEJJvXRHV4PyPoUsxtZa78lwItwRQRHhd2U9xOscaT/YTf8uCXIAjeJOFBVEh/7FtD8Xg==",
+      "dev": true,
+      "dependencies": {
+        "bundle-name": "^4.1.0",
+        "default-browser-id": "^5.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/default-browser-id": {
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/default-browser-id/-/default-browser-id-5.0.0.tgz",
+      "integrity": "sha512-A6p/pu/6fyBcA1TRz/GqWYPViplrftcW2gZC9q79ngNCKAeR/X3gcEdXQHl4KNXV+3wgIJ1CPkJQ3IHM6lcsyA==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/default-gateway": {
       "version": "6.0.3",
       "resolved": "https://registry.npmjs.org/default-gateway/-/default-gateway-6.0.3.tgz",
@@ -6325,12 +6858,15 @@
       }
     },
     "node_modules/define-lazy-prop": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/define-lazy-prop/-/define-lazy-prop-2.0.0.tgz",
-      "integrity": "sha512-Ds09qNh8yw3khSjiJjiUInaGX9xlqZDY7JVryGxdxV7NPeuqQfplOpQ66yJFZut3jLa5zOwkXw1g9EI2uKh4Og==",
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/define-lazy-prop/-/define-lazy-prop-3.0.0.tgz",
+      "integrity": "sha512-N+MeXYoqr3pOgn8xfyRPREN7gHakLYjhsHhWGT3fWAiL4IkAt0iDw14QiiEm2bE30c5XX5q0FtAA3CK5f9/BUg==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/depd": {
@@ -6352,6 +6888,15 @@
         "npm": "1.2.8000 || >= 1.4.16"
       }
     },
+    "node_modules/detect-libc": {
+      "version": "2.0.3",
+      "resolved": "https://registry.npmjs.org/detect-libc/-/detect-libc-2.0.3.tgz",
+      "integrity": "sha512-bwy0MGW55bG41VqxxypOsdSdGqLwXPI/focwgTYCFMbdUiBAxLg9CFzG08sz2aqzknwiX7Hkl0bQENjg8iLByw==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/detect-node": {
       "version": "2.1.0",
       "resolved": "https://registry.npmjs.org/detect-node/-/detect-node-2.1.0.tgz",
@@ -6364,18 +6909,6 @@
       "integrity": "sha512-uJaamHkagcZtHPqCIHZxnFrXlunQXgBOsZSUOWwFw31QJCAbyTBoHMW75YOTur5ZNx8pIeAKgf6GWIgaqqiLhA==",
       "dev": true
     },
-    "node_modules/dir-glob": {
-      "version": "3.0.1",
-      "resolved": "https://registry.npmjs.org/dir-glob/-/dir-glob-3.0.1.tgz",
-      "integrity": "sha512-WkrWp9GR4KXfKGYzOLmTuGVi1UWFfws377n9cc55/tb6DuqyF6pcQ5AbiHEshaDpY9v6oaSr2XCDidGmMwdzIA==",
-      "dev": true,
-      "dependencies": {
-        "path-type": "^4.0.0"
-      },
-      "engines": {
-        "node": ">=8"
-      }
-    },
     "node_modules/dns-packet": {
       "version": "5.6.1",
       "resolved": "https://registry.npmjs.org/dns-packet/-/dns-packet-5.6.1.tgz",
@@ -6468,15 +7001,15 @@
       "dev": true
     },
     "node_modules/electron-to-chromium": {
-      "version": "1.4.746",
-      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.4.746.tgz",
-      "integrity": "sha512-jeWaIta2rIG2FzHaYIhSuVWqC6KJYo7oSBX4Jv7g+aVujKztfvdpf+n6MGwZdC5hQXbax4nntykLH2juIQrfPg==",
+      "version": "1.4.829",
+      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.4.829.tgz",
+      "integrity": "sha512-5qp1N2POAfW0u1qGAxXEtz6P7bO1m6gpZr5hdf5ve6lxpLM7MpiM4jIPz7xcrNlClQMafbyUDDWjlIQZ1Mw0Rw==",
       "dev": true
     },
     "node_modules/emoji-regex": {
-      "version": "8.0.0",
-      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
-      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "version": "10.3.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-10.3.0.tgz",
+      "integrity": "sha512-QpLs9D9v9kArv4lfDEgg1X/gN5XLnf/A6l9cs8SPZLRZR3ZkY9+kwIQTxm+fsSej5UMYGE8fdoaZVIBlqG0XTw==",
       "dev": true
     },
     "node_modules/emojis-list": {
@@ -6521,9 +7054,9 @@
       }
     },
     "node_modules/engine.io": {
-      "version": "6.5.4",
-      "resolved": "https://registry.npmjs.org/engine.io/-/engine.io-6.5.4.tgz",
-      "integrity": "sha512-KdVSDKhVKyOi+r5uEabrDLZw2qXStVvCsEB/LN3mw4WFi6Gx50jTyuxYVCwAAC0U46FdnzP/ScKRBTXb/NiEOg==",
+      "version": "6.5.5",
+      "resolved": "https://registry.npmjs.org/engine.io/-/engine.io-6.5.5.tgz",
+      "integrity": "sha512-C5Pn8Wk+1vKBoHghJODM63yk8MvrO9EWZUfkAt5HAqIgPE4/8FF0PEGHXtEd40l223+cE5ABWuPzm38PHFXfMA==",
       "dev": true,
       "dependencies": {
         "@types/cookie": "^0.4.1",
@@ -6535,25 +7068,25 @@
         "cors": "~2.8.5",
         "debug": "~4.3.1",
         "engine.io-parser": "~5.2.1",
-        "ws": "~8.11.0"
+        "ws": "~8.17.1"
       },
       "engines": {
         "node": ">=10.2.0"
       }
     },
     "node_modules/engine.io-parser": {
-      "version": "5.2.2",
-      "resolved": "https://registry.npmjs.org/engine.io-parser/-/engine.io-parser-5.2.2.tgz",
-      "integrity": "sha512-RcyUFKA93/CXH20l4SoVvzZfrSDMOTUS3bWVpTt2FuFP+XYrL8i8oonHP7WInRyVHXh0n/ORtoeiE1os+8qkSw==",
+      "version": "5.2.3",
+      "resolved": "https://registry.npmjs.org/engine.io-parser/-/engine.io-parser-5.2.3.tgz",
+      "integrity": "sha512-HqD3yTBfnBxIrbnM1DoD6Pcq8NECnh8d4As1Qgh0z5Gg3jRRIqijury0CL3ghu/edArpUYiYqQiDUQBIs4np3Q==",
       "dev": true,
       "engines": {
         "node": ">=10.0.0"
       }
     },
     "node_modules/enhanced-resolve": {
-      "version": "5.16.0",
-      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.16.0.tgz",
-      "integrity": "sha512-O+QWCviPNSSLAD9Ucn8Awv+poAkqn3T1XY5/N7kR7rQO9yfSGWkYZDwpJ+iKF7B8rxaQKWngSqACpgzeapSyoA==",
+      "version": "5.17.0",
+      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.17.0.tgz",
+      "integrity": "sha512-dwDPwZL0dmye8Txp2gzFmA6sxALaSvdRDjPH0viLcKrtlOL3tw62nWWweVD1SdILDTJrbrL6tdWVN58Wo6U3eA==",
       "dev": true,
       "dependencies": {
         "graceful-fs": "^4.2.4",
@@ -6564,10 +7097,16 @@
       }
     },
     "node_modules/ent": {
-      "version": "2.2.0",
-      "resolved": "https://registry.npmjs.org/ent/-/ent-2.2.0.tgz",
-      "integrity": "sha512-GHrMyVZQWvTIdDtpiEXdHZnFQKzeO09apj8Cbl4pKWy4i0Oprcq17usfDt5aO63swf0JOeMWjWQE/LzgSRuWpA==",
-      "dev": true
+      "version": "2.2.1",
+      "resolved": "https://registry.npmjs.org/ent/-/ent-2.2.1.tgz",
+      "integrity": "sha512-QHuXVeZx9d+tIQAz/XztU0ZwZf2Agg9CcXcgE1rurqvdBeDBrpSwjl8/6XUqMg7tw2Y7uAdKb2sRv+bSEFqQ5A==",
+      "dev": true,
+      "dependencies": {
+        "punycode": "^1.4.1"
+      },
+      "engines": {
+        "node": ">= 0.4"
+      }
     },
     "node_modules/entities": {
       "version": "4.5.0",
@@ -6640,18 +7179,17 @@
       }
     },
     "node_modules/es-module-lexer": {
-      "version": "1.5.0",
-      "resolved": "https://registry.npmjs.org/es-module-lexer/-/es-module-lexer-1.5.0.tgz",
-      "integrity": "sha512-pqrTKmwEIgafsYZAGw9kszYzmagcE/n4dbgwGWLEXg7J4QFJVQRBld8j3Q3GNez79jzxZshq0bcT962QHOghjw==",
+      "version": "1.5.4",
+      "resolved": "https://registry.npmjs.org/es-module-lexer/-/es-module-lexer-1.5.4.tgz",
+      "integrity": "sha512-MVNK56NiMrOwitFB7cqDwq0CQutbw+0BvLshJSse0MUNU+y1FC3bUS/AQg7oUng+/wKrrki7JfmwtVHkVfPLlw==",
       "dev": true
     },
     "node_modules/esbuild": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.20.1.tgz",
-      "integrity": "sha512-OJwEgrpWm/PCMsLVWXKqvcjme3bHNpOgN7Tb6cQnR5n0TPbQx1/Xrn7rqM+wn17bYeT6MGB5sn1Bh5YiGi70nA==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
+      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
       "dev": true,
       "hasInstallScript": true,
-      "optional": true,
       "bin": {
         "esbuild": "bin/esbuild"
       },
@@ -6659,35 +7197,35 @@
         "node": ">=12"
       },
       "optionalDependencies": {
-        "@esbuild/aix-ppc64": "0.20.1",
-        "@esbuild/android-arm": "0.20.1",
-        "@esbuild/android-arm64": "0.20.1",
-        "@esbuild/android-x64": "0.20.1",
-        "@esbuild/darwin-arm64": "0.20.1",
-        "@esbuild/darwin-x64": "0.20.1",
-        "@esbuild/freebsd-arm64": "0.20.1",
-        "@esbuild/freebsd-x64": "0.20.1",
-        "@esbuild/linux-arm": "0.20.1",
-        "@esbuild/linux-arm64": "0.20.1",
-        "@esbuild/linux-ia32": "0.20.1",
-        "@esbuild/linux-loong64": "0.20.1",
-        "@esbuild/linux-mips64el": "0.20.1",
-        "@esbuild/linux-ppc64": "0.20.1",
-        "@esbuild/linux-riscv64": "0.20.1",
-        "@esbuild/linux-s390x": "0.20.1",
-        "@esbuild/linux-x64": "0.20.1",
-        "@esbuild/netbsd-x64": "0.20.1",
-        "@esbuild/openbsd-x64": "0.20.1",
-        "@esbuild/sunos-x64": "0.20.1",
-        "@esbuild/win32-arm64": "0.20.1",
-        "@esbuild/win32-ia32": "0.20.1",
-        "@esbuild/win32-x64": "0.20.1"
+        "@esbuild/aix-ppc64": "0.21.5",
+        "@esbuild/android-arm": "0.21.5",
+        "@esbuild/android-arm64": "0.21.5",
+        "@esbuild/android-x64": "0.21.5",
+        "@esbuild/darwin-arm64": "0.21.5",
+        "@esbuild/darwin-x64": "0.21.5",
+        "@esbuild/freebsd-arm64": "0.21.5",
+        "@esbuild/freebsd-x64": "0.21.5",
+        "@esbuild/linux-arm": "0.21.5",
+        "@esbuild/linux-arm64": "0.21.5",
+        "@esbuild/linux-ia32": "0.21.5",
+        "@esbuild/linux-loong64": "0.21.5",
+        "@esbuild/linux-mips64el": "0.21.5",
+        "@esbuild/linux-ppc64": "0.21.5",
+        "@esbuild/linux-riscv64": "0.21.5",
+        "@esbuild/linux-s390x": "0.21.5",
+        "@esbuild/linux-x64": "0.21.5",
+        "@esbuild/netbsd-x64": "0.21.5",
+        "@esbuild/openbsd-x64": "0.21.5",
+        "@esbuild/sunos-x64": "0.21.5",
+        "@esbuild/win32-arm64": "0.21.5",
+        "@esbuild/win32-ia32": "0.21.5",
+        "@esbuild/win32-x64": "0.21.5"
       }
     },
     "node_modules/esbuild-wasm": {
-      "version": "0.20.1",
-      "resolved": "https://registry.npmjs.org/esbuild-wasm/-/esbuild-wasm-0.20.1.tgz",
-      "integrity": "sha512-6v/WJubRsjxBbQdz6izgvx7LsVFvVaGmSdwrFHmEzoVgfXL89hkKPoQHsnVI2ngOkcBUQT9kmAM1hVL1k/Av4A==",
+      "version": "0.21.5",
+      "resolved": "https://registry.npmjs.org/esbuild-wasm/-/esbuild-wasm-0.21.5.tgz",
+      "integrity": "sha512-L/FlOPMMFtw+6qPAbuPvJXdrOYOp9yx/PEwSrIZW0qghY4vgV003evdYDwqQ/9ENMQI0B6RMod9xT4FHtto6OQ==",
       "dev": true,
       "bin": {
         "esbuild": "bin/esbuild"
@@ -6733,19 +7271,6 @@
         "node": ">=8.0.0"
       }
     },
-    "node_modules/esprima": {
-      "version": "4.0.1",
-      "resolved": "https://registry.npmjs.org/esprima/-/esprima-4.0.1.tgz",
-      "integrity": "sha512-eGuFFw7Upda+g4p+QHvnW0RyTX/SVeJBDM/gCtMARO0cLuT2HcEKnTPvhjV6aGeqrCB/sbNop0Kszm0jsaWU4A==",
-      "dev": true,
-      "bin": {
-        "esparse": "bin/esparse.js",
-        "esvalidate": "bin/esvalidate.js"
-      },
-      "engines": {
-        "node": ">=4"
-      }
-    },
     "node_modules/esrecurse": {
       "version": "4.3.0",
       "resolved": "https://registry.npmjs.org/esrecurse/-/esrecurse-4.3.0.tgz",
@@ -6832,6 +7357,12 @@
         "url": "https://github.com/sindresorhus/execa?sponsor=1"
       }
     },
+    "node_modules/execa/node_modules/signal-exit": {
+      "version": "3.0.7",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
+      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
+      "dev": true
+    },
     "node_modules/exponential-backoff": {
       "version": "3.1.1",
       "resolved": "https://registry.npmjs.org/exponential-backoff/-/exponential-backoff-3.1.1.tgz",
@@ -7000,25 +7531,10 @@
         "node": ">=0.8.0"
       }
     },
-    "node_modules/figures": {
-      "version": "3.2.0",
-      "resolved": "https://registry.npmjs.org/figures/-/figures-3.2.0.tgz",
-      "integrity": "sha512-yaduQFRKLXYOGgEn6AZau90j3ggSOyiqXU0F9JZfeXYhNa+Jk4X+s45A2zg5jns87GAFa34BBm2kXw4XpNcbdg==",
-      "dev": true,
-      "dependencies": {
-        "escape-string-regexp": "^1.0.5"
-      },
-      "engines": {
-        "node": ">=8"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
     "node_modules/fill-range": {
-      "version": "7.0.1",
-      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.0.1.tgz",
-      "integrity": "sha512-qOo9F+dMUmC2Lcb4BbVvnKJxTPjCm+RRpe4gDuGrzkL7mEVl/djYSu2OdQ2Pa302N4oqkSg9ir6jaLWJ2USVpQ==",
+      "version": "7.1.1",
+      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
+      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
       "dev": true,
       "dependencies": {
         "to-regex-range": "^5.0.1"
@@ -7089,16 +7605,19 @@
       }
     },
     "node_modules/find-up": {
-      "version": "4.1.0",
-      "resolved": "https://registry.npmjs.org/find-up/-/find-up-4.1.0.tgz",
-      "integrity": "sha512-PpOwAdQ/YlXQ2vj8a3h8IipDuYRi3wceVQQGYWxNINccq40Anw7BlsEXCMbt1Zt+OLA6Fq9suIpIWD0OsnISlw==",
+      "version": "6.3.0",
+      "resolved": "https://registry.npmjs.org/find-up/-/find-up-6.3.0.tgz",
+      "integrity": "sha512-v2ZsoEuVHYy8ZIlYqwPe/39Cy+cFDzp4dXPaxNvkEuouymu+2Jbz0PxpKarJHYJTmv2HWT3O382qY8l4jMWthw==",
       "dev": true,
       "dependencies": {
-        "locate-path": "^5.0.0",
-        "path-exists": "^4.0.0"
+        "locate-path": "^7.1.0",
+        "path-exists": "^5.0.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/flat": {
@@ -7137,9 +7656,9 @@
       }
     },
     "node_modules/foreground-child": {
-      "version": "3.1.1",
-      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.1.1.tgz",
-      "integrity": "sha512-TMKDUnIte6bfb5nWv7V/caI169OHgvwjb7V4WkeUvbQQdjr5rWKqHFiKWb/fcOwB+CzBT+qbWjvj+DVwRskpIg==",
+      "version": "3.2.1",
+      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.2.1.tgz",
+      "integrity": "sha512-PXUUyLqrR2XCWICfv6ukppP96sdFwWbNEnfEMt7jNsISjMsvaLNinAHNDYyvkyU+SZG2BTSbT5NjG+vZslfGTA==",
       "dev": true,
       "dependencies": {
         "cross-spawn": "^7.0.0",
@@ -7152,18 +7671,6 @@
         "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/foreground-child/node_modules/signal-exit": {
-      "version": "4.1.0",
-      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
-      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
-      "dev": true,
-      "engines": {
-        "node": ">=14"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/isaacs"
-      }
-    },
     "node_modules/forwarded": {
       "version": "0.2.0",
       "resolved": "https://registry.npmjs.org/forwarded/-/forwarded-0.2.0.tgz",
@@ -7221,12 +7728,6 @@
         "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/fs-monkey": {
-      "version": "1.0.5",
-      "resolved": "https://registry.npmjs.org/fs-monkey/-/fs-monkey-1.0.5.tgz",
-      "integrity": "sha512-8uMbBjrhzW76TYgEV27Y5E//W2f/lTFmx78P2w19FZSxarhI/798APGQyuGCwmkNxgwGRhrLfvWyLBvNtuOmew==",
-      "dev": true
-    },
     "node_modules/fs.realpath": {
       "version": "1.0.0",
       "resolved": "https://registry.npmjs.org/fs.realpath/-/fs.realpath-1.0.0.tgz",
@@ -7274,6 +7775,18 @@
         "node": "6.* || 8.* || >= 10.*"
       }
     },
+    "node_modules/get-east-asian-width": {
+      "version": "1.2.0",
+      "resolved": "https://registry.npmjs.org/get-east-asian-width/-/get-east-asian-width-1.2.0.tgz",
+      "integrity": "sha512-2nk+7SIVb14QrgXFHcm84tD4bKQz0RxPuMT8Ag5KPOq7J5fEmAg0UbXdTOSHqNuHSU28k55qnceesxXRZGzKWA==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/get-intrinsic": {
       "version": "1.2.4",
       "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.2.4.tgz",
@@ -7293,15 +7806,6 @@
         "url": "https://github.com/sponsors/ljharb"
       }
     },
-    "node_modules/get-package-type": {
-      "version": "0.1.0",
-      "resolved": "https://registry.npmjs.org/get-package-type/-/get-package-type-0.1.0.tgz",
-      "integrity": "sha512-pjzuKtY64GYfWizNAJ0fr9VqttZkNiK2iS430LtIHzjBEr6bX8Am2zm4sW4Ro5wjWW5cAlRL1qAMTcXbjNAO2Q==",
-      "dev": true,
-      "engines": {
-        "node": ">=8.0.0"
-      }
-    },
     "node_modules/get-stream": {
       "version": "6.0.1",
       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-6.0.1.tgz",
@@ -7318,6 +7822,7 @@
       "version": "7.2.3",
       "resolved": "https://registry.npmjs.org/glob/-/glob-7.2.3.tgz",
       "integrity": "sha512-nFR0zLpU2YCaRxwoCJvL6UvCH2JFyFVIvwTLsIf21AuHlMskA1hhTdk+LlYJtOlYt9v6dvszD2BGRqBL+iQK9Q==",
+      "deprecated": "Glob versions prior to v9 are no longer supported",
       "dev": true,
       "dependencies": {
         "fs.realpath": "^1.0.0",
@@ -7362,19 +7867,20 @@
       }
     },
     "node_modules/globby": {
-      "version": "13.2.2",
-      "resolved": "https://registry.npmjs.org/globby/-/globby-13.2.2.tgz",
-      "integrity": "sha512-Y1zNGV+pzQdh7H39l9zgB4PJqjRNqydvdYCDG4HFXM4XuvSaQQlEc91IU1yALL8gUTDomgBAfz3XJdmUS+oo0w==",
+      "version": "14.0.2",
+      "resolved": "https://registry.npmjs.org/globby/-/globby-14.0.2.tgz",
+      "integrity": "sha512-s3Fq41ZVh7vbbe2PN3nrW7yC7U7MFVc5c98/iTl9c2GawNMKx/J648KQRW6WKkuU8GIbbh2IXfIRQjOZnXcTnw==",
       "dev": true,
       "dependencies": {
-        "dir-glob": "^3.0.1",
-        "fast-glob": "^3.3.0",
+        "@sindresorhus/merge-streams": "^2.1.0",
+        "fast-glob": "^3.3.2",
         "ignore": "^5.2.4",
-        "merge2": "^1.4.1",
-        "slash": "^4.0.0"
+        "path-type": "^5.0.0",
+        "slash": "^5.1.0",
+        "unicorn-magic": "^0.1.0"
       },
       "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
@@ -7462,9 +7968,9 @@
       }
     },
     "node_modules/hosted-git-info": {
-      "version": "7.0.1",
-      "resolved": "https://registry.npmjs.org/hosted-git-info/-/hosted-git-info-7.0.1.tgz",
-      "integrity": "sha512-+K84LB1DYwMHoHSgaOY/Jfhw3ucPmSET5v98Ke/HdNSw4a0UktWzyW1mjhjpuxxTqOOsfWT/7iVshHmVZ4IpOA==",
+      "version": "7.0.2",
+      "resolved": "https://registry.npmjs.org/hosted-git-info/-/hosted-git-info-7.0.2.tgz",
+      "integrity": "sha512-puUZAUKT5m8Zzvs72XWy3HtvVbTWljRE66cP60bxJzAqf2DgICo7lYTY2IHUmLnNpjYvw5bvmoHvPc0QO2a62w==",
       "dev": true,
       "dependencies": {
         "lru-cache": "^10.0.1"
@@ -7474,13 +7980,10 @@
       }
     },
     "node_modules/hosted-git-info/node_modules/lru-cache": {
-      "version": "10.2.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.2.0.tgz",
-      "integrity": "sha512-2bIM8x+VAf6JT4bKAljS1qUWgMsqZRPGJS6FSahIMPVvctcNhyVp7AJu7quxOW9jwkryBReKZY5tY5JYv2n/7Q==",
-      "dev": true,
-      "engines": {
-        "node": "14 || >=16.14"
-      }
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
     "node_modules/hpack.js": {
       "version": "2.1.6",
@@ -7636,33 +8139,26 @@
       }
     },
     "node_modules/http-proxy-middleware": {
-      "version": "2.0.6",
-      "resolved": "https://registry.npmjs.org/http-proxy-middleware/-/http-proxy-middleware-2.0.6.tgz",
-      "integrity": "sha512-ya/UeJ6HVBYxrgYotAZo1KvPWlgB48kUJLDePFeneHsVujFaW5WNj2NgWCAE//B1Dl02BIfYlpNgBy8Kf8Rjmw==",
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/http-proxy-middleware/-/http-proxy-middleware-3.0.0.tgz",
+      "integrity": "sha512-36AV1fIaI2cWRzHo+rbcxhe3M3jUDCNzc4D5zRl57sEWRAxdXYtw7FSQKYY6PDKssiAKjLYypbssHk+xs/kMXw==",
       "dev": true,
       "dependencies": {
-        "@types/http-proxy": "^1.17.8",
+        "@types/http-proxy": "^1.17.10",
+        "debug": "^4.3.4",
         "http-proxy": "^1.18.1",
         "is-glob": "^4.0.1",
         "is-plain-obj": "^3.0.0",
-        "micromatch": "^4.0.2"
+        "micromatch": "^4.0.5"
       },
       "engines": {
-        "node": ">=12.0.0"
-      },
-      "peerDependencies": {
-        "@types/express": "^4.17.13"
-      },
-      "peerDependenciesMeta": {
-        "@types/express": {
-          "optional": true
-        }
+        "node": "^14.15.0 || ^16.10.0 || >=18.0.0"
       }
     },
     "node_modules/https-proxy-agent": {
-      "version": "7.0.4",
-      "resolved": "https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-7.0.4.tgz",
-      "integrity": "sha512-wlwpilI7YdjSkWaQ/7omYBMTliDcmCN8OLihO6I9B86g06lMyAoqgoDpV0XqoaPOKj+0DIdAvnsWfyAAhmimcg==",
+      "version": "7.0.5",
+      "resolved": "https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-7.0.5.tgz",
+      "integrity": "sha512-1e4Wqeblerz+tMKPIq2EMGiiWW1dIjZOksyHWSUm1rmuvw/how9hBHZ38lAGj5ID4Ik6EdkOw7NmWPy6LAwalw==",
       "dev": true,
       "dependencies": {
         "agent-base": "^7.0.2",
@@ -7681,6 +8177,15 @@
         "node": ">=10.17.0"
       }
     },
+    "node_modules/hyperdyperid": {
+      "version": "1.2.0",
+      "resolved": "https://registry.npmjs.org/hyperdyperid/-/hyperdyperid-1.2.0.tgz",
+      "integrity": "sha512-Y93lCzHYgGWdrJ66yIktxiaGULYc6oGiABxhcO5AufBeOyoIdZF7bIfLaOrbM0iGIOXQQgxxRrFEnb+Y6w1n4A==",
+      "dev": true,
+      "engines": {
+        "node": ">=10.18"
+      }
+    },
     "node_modules/iconv-lite": {
       "version": "0.4.24",
       "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.4.24.tgz",
@@ -7735,9 +8240,9 @@
       }
     },
     "node_modules/ignore-walk": {
-      "version": "6.0.4",
-      "resolved": "https://registry.npmjs.org/ignore-walk/-/ignore-walk-6.0.4.tgz",
-      "integrity": "sha512-t7sv42WkwFkyKbivUCglsQW5YWMskWtbEf4MNKX5u/CCWHKSPzN4FtBQGsQZgCLbxOzpVlcbWVK5KB3auIOjSw==",
+      "version": "6.0.5",
+      "resolved": "https://registry.npmjs.org/ignore-walk/-/ignore-walk-6.0.5.tgz",
+      "integrity": "sha512-VuuG0wCnjhnylG1ABXT3dAuIpTNDs/G8jlpmwXY03fXoXy/8ZK8/T+hMzt8L4WnrLCJgdybqgPagnF/f97cg3A==",
       "dev": true,
       "dependencies": {
         "minimatch": "^9.0.0"
@@ -7756,9 +8261,9 @@
       }
     },
     "node_modules/ignore-walk/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
       "dev": true,
       "dependencies": {
         "brace-expansion": "^2.0.1"
@@ -7784,9 +8289,9 @@
       }
     },
     "node_modules/immutable": {
-      "version": "4.3.5",
-      "resolved": "https://registry.npmjs.org/immutable/-/immutable-4.3.5.tgz",
-      "integrity": "sha512-8eabxkth9gZatlwl5TBuJnCsoTADlL6ftEr7A4qgdaTsPyreilDSnUk57SO+jfKcNtxPa22U5KK6DSeAYhpBJw==",
+      "version": "4.3.6",
+      "resolved": "https://registry.npmjs.org/immutable/-/immutable-4.3.6.tgz",
+      "integrity": "sha512-Ju0+lEMyzMVZarkTn/gqRpdqd5dOPaz1mCZ0SH3JV6iFw81PldE/PEB1hWVEA288HPt4WXW8O7AWxB10M+03QQ==",
       "dev": true
     },
     "node_modules/import-fresh": {
@@ -7805,15 +8310,6 @@
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/import-fresh/node_modules/resolve-from": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
-      "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
-      "dev": true,
-      "engines": {
-        "node": ">=4"
-      }
-    },
     "node_modules/imurmurhash": {
       "version": "0.1.4",
       "resolved": "https://registry.npmjs.org/imurmurhash/-/imurmurhash-0.1.4.tgz",
@@ -7836,6 +8332,7 @@
       "version": "1.0.6",
       "resolved": "https://registry.npmjs.org/inflight/-/inflight-1.0.6.tgz",
       "integrity": "sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==",
+      "deprecated": "This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.",
       "dev": true,
       "dependencies": {
         "once": "^1.3.0",
@@ -7849,52 +8346,14 @@
       "dev": true
     },
     "node_modules/ini": {
-      "version": "4.1.2",
-      "resolved": "https://registry.npmjs.org/ini/-/ini-4.1.2.tgz",
-      "integrity": "sha512-AMB1mvwR1pyBFY/nSevUX6y8nJWS63/SzUKD3JyQn97s4xgIdgQPT75IRouIiBAN4yLQBUShNYVW0+UG25daCw==",
+      "version": "4.1.3",
+      "resolved": "https://registry.npmjs.org/ini/-/ini-4.1.3.tgz",
+      "integrity": "sha512-X7rqawQBvfdjS10YU1y1YVreA3SsLrW9dX2CewP2EbBJM4ypVNLDkO5y04gejPwKIY9lR+7r9gn3rFPt/kmWFg==",
       "dev": true,
       "engines": {
         "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/inquirer": {
-      "version": "9.2.15",
-      "resolved": "https://registry.npmjs.org/inquirer/-/inquirer-9.2.15.tgz",
-      "integrity": "sha512-vI2w4zl/mDluHt9YEQ/543VTCwPKWiHzKtm9dM2V0NdFcqEexDAjUHzO1oA60HRNaVifGXXM1tRRNluLVHa0Kg==",
-      "dev": true,
-      "dependencies": {
-        "@ljharb/through": "^2.3.12",
-        "ansi-escapes": "^4.3.2",
-        "chalk": "^5.3.0",
-        "cli-cursor": "^3.1.0",
-        "cli-width": "^4.1.0",
-        "external-editor": "^3.1.0",
-        "figures": "^3.2.0",
-        "lodash": "^4.17.21",
-        "mute-stream": "1.0.0",
-        "ora": "^5.4.1",
-        "run-async": "^3.0.0",
-        "rxjs": "^7.8.1",
-        "string-width": "^4.2.3",
-        "strip-ansi": "^6.0.1",
-        "wrap-ansi": "^6.2.0"
-      },
-      "engines": {
-        "node": ">=18"
-      }
-    },
-    "node_modules/inquirer/node_modules/chalk": {
-      "version": "5.3.0",
-      "resolved": "https://registry.npmjs.org/chalk/-/chalk-5.3.0.tgz",
-      "integrity": "sha512-dLitG79d+GV1Nb/VYcCDFivJeK1hiukt9QjRNVOsUtTy1rR1YJsmpGGTZ3qJos+uw7WmWF4wUwBd9jxjocFC2w==",
-      "dev": true,
-      "engines": {
-        "node": "^12.17.0 || ^14.13 || >=16.0.0"
-      },
-      "funding": {
-        "url": "https://github.com/chalk/chalk?sponsor=1"
-      }
-    },
     "node_modules/ip-address": {
       "version": "9.0.5",
       "resolved": "https://registry.npmjs.org/ip-address/-/ip-address-9.0.5.tgz",
@@ -7908,12 +8367,6 @@
         "node": ">= 12"
       }
     },
-    "node_modules/ip-address/node_modules/sprintf-js": {
-      "version": "1.1.3",
-      "resolved": "https://registry.npmjs.org/sprintf-js/-/sprintf-js-1.1.3.tgz",
-      "integrity": "sha512-Oo+0REFV59/rz3gfJNKQiBlwfHaSESl1pcGyABQsnnIfWOFt6JNj5gCog2U6MLZ//IGYD+nA8nI+mTShREReaA==",
-      "dev": true
-    },
     "node_modules/ipaddr.js": {
       "version": "2.2.0",
       "resolved": "https://registry.npmjs.org/ipaddr.js/-/ipaddr.js-2.2.0.tgz",
@@ -7942,27 +8395,30 @@
       }
     },
     "node_modules/is-core-module": {
-      "version": "2.13.1",
-      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.13.1.tgz",
-      "integrity": "sha512-hHrIjvZsftOsvKSn2TRYl63zvxsgE0K+0mYMoH6gD4omR5IWB2KynivBQczo3+wF1cCkjzvptnI9Q0sPU66ilw==",
+      "version": "2.15.0",
+      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.15.0.tgz",
+      "integrity": "sha512-Dd+Lb2/zvk9SKy1TGCt1wFJFo/MWBPMX5x7KcvLajWTGuomczdQX61PvY5yK6SVACwpoexWo81IfFyoKY2QnTA==",
       "dev": true,
       "dependencies": {
-        "hasown": "^2.0.0"
+        "hasown": "^2.0.2"
+      },
+      "engines": {
+        "node": ">= 0.4"
       },
       "funding": {
         "url": "https://github.com/sponsors/ljharb"
       }
     },
     "node_modules/is-docker": {
-      "version": "2.2.1",
-      "resolved": "https://registry.npmjs.org/is-docker/-/is-docker-2.2.1.tgz",
-      "integrity": "sha512-F+i2BKsFrH66iaUFc0woD8sLy8getkwTwtOBjvs56Cx4CgJDeKQeqfz8wAYiSb8JOprWhHH5p77PbmYCvvUuXQ==",
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-docker/-/is-docker-3.0.0.tgz",
+      "integrity": "sha512-eljcgEDlEns/7AXFosB5K/2nCM4P7FQPkGc/DWLy5rmFEWvZayGrik1d9/QIY5nJ4f9YsVvBkA6kJpHn9rISdQ==",
       "dev": true,
       "bin": {
         "is-docker": "cli.js"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
@@ -7978,12 +8434,15 @@
       }
     },
     "node_modules/is-fullwidth-code-point": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
-      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-4.0.0.tgz",
+      "integrity": "sha512-O4L094N2/dZ7xqVdrXhh9r1KODPJpFms8B5sGdJLPy664AgvXsreZUyCQQNItZRDlYug4xStLjNp/sz3HvBowQ==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/is-glob": {
@@ -7998,6 +8457,24 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/is-inside-container": {
+      "version": "1.0.0",
+      "resolved": "https://registry.npmjs.org/is-inside-container/-/is-inside-container-1.0.0.tgz",
+      "integrity": "sha512-KIYLCCJghfHZxqjYBE7rEy0OBuTd5xCHS7tHVgvCLkx7StIoaxwNW3hCALgEUjFfeRk+MG/Qxmp/vtETEF3tRA==",
+      "dev": true,
+      "dependencies": {
+        "is-docker": "^3.0.0"
+      },
+      "bin": {
+        "is-inside-container": "cli.js"
+      },
+      "engines": {
+        "node": ">=14.16"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/is-interactive": {
       "version": "1.0.0",
       "resolved": "https://registry.npmjs.org/is-interactive/-/is-interactive-1.0.0.tgz",
@@ -8013,6 +8490,18 @@
       "integrity": "sha512-z7CMFGNrENq5iFB9Bqo64Xk6Y9sg+epq1myIcdHaGnbMTYOxvzsEtdYqQUylB7LxfkvgrrjP32T6Ywciio9UIQ==",
       "dev": true
     },
+    "node_modules/is-network-error": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/is-network-error/-/is-network-error-1.1.0.tgz",
+      "integrity": "sha512-tUdRRAnhT+OtCZR/LxZelH/C7QtjtFrTu5tXCA8pl55eTUElUHT+GPYV8MBMBvea/j+NxQqVt3LbWMRir7Gx9g==",
+      "dev": true,
+      "engines": {
+        "node": ">=16"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/is-number": {
       "version": "7.0.0",
       "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
@@ -8077,15 +8566,18 @@
       "dev": true
     },
     "node_modules/is-wsl": {
-      "version": "2.2.0",
-      "resolved": "https://registry.npmjs.org/is-wsl/-/is-wsl-2.2.0.tgz",
-      "integrity": "sha512-fKzAra0rGJUUBwGBgNkHZuToZcn+TtXHpeCgmkMJMMYx1sQDYaCSyjJBSCa2nH1DGm7s3n1oBnohoVTBaN7Lww==",
+      "version": "3.1.0",
+      "resolved": "https://registry.npmjs.org/is-wsl/-/is-wsl-3.1.0.tgz",
+      "integrity": "sha512-UcVfVfaK4Sc4m7X3dUSoHoozQGBEFeDC+zVo06t98xe8CzHSZZBekNXH+tu0NalHolcJ/QAGqS46Hef7QXBIMw==",
       "dev": true,
       "dependencies": {
-        "is-docker": "^2.0.0"
+        "is-inside-container": "^1.0.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": ">=16"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/isarray": {
@@ -8131,28 +8623,19 @@
       }
     },
     "node_modules/istanbul-lib-instrument": {
-      "version": "5.2.1",
-      "resolved": "https://registry.npmjs.org/istanbul-lib-instrument/-/istanbul-lib-instrument-5.2.1.tgz",
-      "integrity": "sha512-pzqtp31nLv/XFOzXGuvhCb8qhjmTVo5vjVk19XE4CRlSWz0KoeJ3bw9XsA7nOp9YBf4qHjwBxkDzKcME/J29Yg==",
+      "version": "6.0.2",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-instrument/-/istanbul-lib-instrument-6.0.2.tgz",
+      "integrity": "sha512-1WUsZ9R1lA0HtBSohTkm39WTPlNKSJ5iFk7UwqXkBLoHQT+hfqPsfsTDVuZdKGaBwn7din9bS7SsnoAr943hvw==",
       "dev": true,
       "dependencies": {
-        "@babel/core": "^7.12.3",
-        "@babel/parser": "^7.14.7",
-        "@istanbuljs/schema": "^0.1.2",
+        "@babel/core": "^7.23.9",
+        "@babel/parser": "^7.23.9",
+        "@istanbuljs/schema": "^0.1.3",
         "istanbul-lib-coverage": "^3.2.0",
-        "semver": "^6.3.0"
+        "semver": "^7.5.4"
       },
       "engines": {
-        "node": ">=8"
-      }
-    },
-    "node_modules/istanbul-lib-instrument/node_modules/semver": {
-      "version": "6.3.1",
-      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
-      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
-      "dev": true,
-      "bin": {
-        "semver": "bin/semver.js"
+        "node": ">=10"
       }
     },
     "node_modules/istanbul-lib-report": {
@@ -8227,16 +8710,13 @@
       }
     },
     "node_modules/jackspeak": {
-      "version": "2.3.6",
-      "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-2.3.6.tgz",
-      "integrity": "sha512-N3yCS/NegsOBokc8GAdM8UcmfsKiSS8cipheD/nivzr700H+nsMOxJjQnvwOcRYVuFkdH0wGUvW2WbXGmrZGbQ==",
+      "version": "3.4.3",
+      "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-3.4.3.tgz",
+      "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
       "dev": true,
       "dependencies": {
         "@isaacs/cliui": "^8.0.2"
       },
-      "engines": {
-        "node": ">=14"
-      },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       },
@@ -8289,9 +8769,9 @@
       }
     },
     "node_modules/jiti": {
-      "version": "1.21.0",
-      "resolved": "https://registry.npmjs.org/jiti/-/jiti-1.21.0.tgz",
-      "integrity": "sha512-gFqAIbuKyyso/3G2qhiO2OM6shY6EPP/R0+mkDbyspxKazh8BXDC5FiFsUjlczgdNz/vfra0da2y+aHrusLG/Q==",
+      "version": "1.21.6",
+      "resolved": "https://registry.npmjs.org/jiti/-/jiti-1.21.6.tgz",
+      "integrity": "sha512-2yTgeWTWzMWkHu6Jp9NKgePDaYHbntiwvYuuJLbbN9vl7DC9DvXKOB2BC3ZZ92D3cvV/aflH0osDfwpHepQ53w==",
       "dev": true,
       "bin": {
         "jiti": "bin/jiti.js"
@@ -8304,13 +8784,12 @@
       "dev": true
     },
     "node_modules/js-yaml": {
-      "version": "3.14.1",
-      "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-3.14.1.tgz",
-      "integrity": "sha512-okMH7OXXJ7YrN9Ok3/SXrnu4iX9yOk+25nqX4imS2npuvTYDmo/QEZoqwZkYaIDk3jVvBOTOIEgEhaLOynBS9g==",
+      "version": "4.1.0",
+      "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.0.tgz",
+      "integrity": "sha512-wpxZs9NoxZaJESJGIZTyDEaYpl0FKSA+FB9aJiyemKhMwkxQg63h4T1KJgUGHpTqPDNRcmmYLugrRjJlBtWvRA==",
       "dev": true,
       "dependencies": {
-        "argparse": "^1.0.7",
-        "esprima": "^4.0.0"
+        "argparse": "^2.0.1"
       },
       "bin": {
         "js-yaml": "bin/js-yaml.js"
@@ -8335,9 +8814,9 @@
       }
     },
     "node_modules/json-parse-even-better-errors": {
-      "version": "3.0.1",
-      "resolved": "https://registry.npmjs.org/json-parse-even-better-errors/-/json-parse-even-better-errors-3.0.1.tgz",
-      "integrity": "sha512-aatBvbL26wVUCLmbWdCpeu9iF5wOyWpagiKkInA+kfws3sWdBrTnsvN2CKcyCYyUrc7rebNBlK6+kteg7ksecg==",
+      "version": "3.0.2",
+      "resolved": "https://registry.npmjs.org/json-parse-even-better-errors/-/json-parse-even-better-errors-3.0.2.tgz",
+      "integrity": "sha512-fi0NG4bPjCHunUJffmLd0gxssIgkNmArMvis4iNah6Owg1MCJjWhEcDLmsK6iGkJq3tHwbDkTlce70/tmXN4cQ==",
       "dev": true,
       "engines": {
         "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
@@ -8362,9 +8841,9 @@
       }
     },
     "node_modules/jsonc-parser": {
-      "version": "3.2.1",
-      "resolved": "https://registry.npmjs.org/jsonc-parser/-/jsonc-parser-3.2.1.tgz",
-      "integrity": "sha512-AilxAyFOAcK5wA1+LeaySVBrHsGQvUFCDWXKpZjzaL0PqW+xfBOttn8GNtWKFWqneyMZj41MWF9Kl6iPWLwgOA==",
+      "version": "3.3.1",
+      "resolved": "https://registry.npmjs.org/jsonc-parser/-/jsonc-parser-3.3.1.tgz",
+      "integrity": "sha512-HUgH65KyejrUFPvHFPbqOY0rsFip3Bo5wb4ngvdi1EpCYWUQDC5V+Y7mZws+DLkr4M//zQJoanu1SP+87Dv1oQ==",
       "dev": true
     },
     "node_modules/jsonfile": {
@@ -8449,6 +8928,31 @@
         "node": ">=10.0.0"
       }
     },
+    "node_modules/karma-coverage/node_modules/istanbul-lib-instrument": {
+      "version": "5.2.1",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-instrument/-/istanbul-lib-instrument-5.2.1.tgz",
+      "integrity": "sha512-pzqtp31nLv/XFOzXGuvhCb8qhjmTVo5vjVk19XE4CRlSWz0KoeJ3bw9XsA7nOp9YBf4qHjwBxkDzKcME/J29Yg==",
+      "dev": true,
+      "dependencies": {
+        "@babel/core": "^7.12.3",
+        "@babel/parser": "^7.14.7",
+        "@istanbuljs/schema": "^0.1.2",
+        "istanbul-lib-coverage": "^3.2.0",
+        "semver": "^6.3.0"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/karma-coverage/node_modules/semver": {
+      "version": "6.3.1",
+      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
+      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
+      "dev": true,
+      "bin": {
+        "semver": "bin/semver.js"
+      }
+    },
     "node_modules/karma-jasmine": {
       "version": "5.1.0",
       "resolved": "https://registry.npmjs.org/karma-jasmine/-/karma-jasmine-5.1.0.tgz",
@@ -8476,9 +8980,9 @@
       }
     },
     "node_modules/karma-jasmine/node_modules/jasmine-core": {
-      "version": "4.6.0",
-      "resolved": "https://registry.npmjs.org/jasmine-core/-/jasmine-core-4.6.0.tgz",
-      "integrity": "sha512-O236+gd0ZXS8YAjFx8xKaJ94/erqUliEkJTDedyE7iHvv4ZVqi+q+8acJxu05/WJDKm512EUNn809In37nWlAQ==",
+      "version": "4.6.1",
+      "resolved": "https://registry.npmjs.org/jasmine-core/-/jasmine-core-4.6.1.tgz",
+      "integrity": "sha512-VYz/BjjmC3klLJlLwA4Kw8ytk0zDSmbbDLNs794VnWmkcCB7I9aAL/D48VNQtmITyPvea2C3jdUMfc3kAoy0PQ==",
       "dev": true
     },
     "node_modules/karma-source-map-support": {
@@ -8534,6 +9038,21 @@
       "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
       "dev": true
     },
+    "node_modules/karma/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/karma/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/karma/node_modules/source-map": {
       "version": "0.6.1",
       "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.6.1.tgz",
@@ -8543,6 +9062,20 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/karma/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/karma/node_modules/tmp": {
       "version": "0.2.3",
       "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.2.3.tgz",
@@ -8605,19 +9138,10 @@
         "node": ">=0.10.0"
       }
     },
-    "node_modules/klona": {
-      "version": "2.0.6",
-      "resolved": "https://registry.npmjs.org/klona/-/klona-2.0.6.tgz",
-      "integrity": "sha512-dhG34DXATL5hSxJbIexCft8FChFXtmskoZYnoPWjXQuebWYCNkVeV3KkGegCK9CP1oswI/vQibS2GY7Em/sJJA==",
-      "dev": true,
-      "engines": {
-        "node": ">= 8"
-      }
-    },
     "node_modules/launch-editor": {
-      "version": "2.6.1",
-      "resolved": "https://registry.npmjs.org/launch-editor/-/launch-editor-2.6.1.tgz",
-      "integrity": "sha512-eB/uXmFVpY4zezmGp5XtU21kwo7GBbKB+EQ+UZeWtGb9yAM5xt/Evk+lYH3eRNAtId+ej4u7TYPFZ07w4s7rRw==",
+      "version": "2.8.0",
+      "resolved": "https://registry.npmjs.org/launch-editor/-/launch-editor-2.8.0.tgz",
+      "integrity": "sha512-vJranOAJrI/llyWGRQqiDM+adrw+k83fvmmx3+nV47g3+36xM15jE+zyZ6Ffel02+xSvuM0b2GDRosXZkbb6wA==",
       "dev": true,
       "dependencies": {
         "picocolors": "^1.0.0",
@@ -8651,23 +9175,29 @@
       }
     },
     "node_modules/less-loader": {
-      "version": "11.1.0",
-      "resolved": "https://registry.npmjs.org/less-loader/-/less-loader-11.1.0.tgz",
-      "integrity": "sha512-C+uDBV7kS7W5fJlUjq5mPBeBVhYpTIm5gB09APT9o3n/ILeaXVsiSFTbZpTJCJwQ/Crczfn3DmfQFwxYusWFug==",
+      "version": "12.2.0",
+      "resolved": "https://registry.npmjs.org/less-loader/-/less-loader-12.2.0.tgz",
+      "integrity": "sha512-MYUxjSQSBUQmowc0l5nPieOYwMzGPUaTzB6inNW/bdPEG9zOL3eAAD1Qw5ZxSPk7we5dMojHwNODYMV1hq4EVg==",
       "dev": true,
-      "dependencies": {
-        "klona": "^2.0.4"
-      },
       "engines": {
-        "node": ">= 14.15.0"
+        "node": ">= 18.12.0"
       },
       "funding": {
         "type": "opencollective",
         "url": "https://opencollective.com/webpack"
       },
       "peerDependencies": {
+        "@rspack/core": "0.x || 1.x",
         "less": "^3.5.0 || ^4.0.0",
         "webpack": "^5.0.0"
+      },
+      "peerDependenciesMeta": {
+        "@rspack/core": {
+          "optional": true
+        },
+        "webpack": {
+          "optional": true
+        }
       }
     },
     "node_modules/less/node_modules/make-dir": {
@@ -8740,6 +9270,110 @@
       "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
       "dev": true
     },
+    "node_modules/listr2": {
+      "version": "8.2.3",
+      "resolved": "https://registry.npmjs.org/listr2/-/listr2-8.2.3.tgz",
+      "integrity": "sha512-Lllokma2mtoniUOS94CcOErHWAug5iu7HOmDrvWgpw8jyQH2fomgB+7lZS4HWZxytUuQwkGOwe49FvwVaA85Xw==",
+      "dev": true,
+      "dependencies": {
+        "cli-truncate": "^4.0.0",
+        "colorette": "^2.0.20",
+        "eventemitter3": "^5.0.1",
+        "log-update": "^6.0.0",
+        "rfdc": "^1.4.1",
+        "wrap-ansi": "^9.0.0"
+      },
+      "engines": {
+        "node": ">=18.0.0"
+      }
+    },
+    "node_modules/listr2/node_modules/ansi-regex": {
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
+      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/listr2/node_modules/ansi-styles": {
+      "version": "6.2.1",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
+      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
+    "node_modules/listr2/node_modules/eventemitter3": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/eventemitter3/-/eventemitter3-5.0.1.tgz",
+      "integrity": "sha512-GWkBvjiSZK87ELrYOSESUYeVIc9mvLLf/nXalMOS5dYrgZq9o5OVkbZAVM06CVxYsCwH9BDZFPlQTlPA1j4ahA==",
+      "dev": true
+    },
+    "node_modules/listr2/node_modules/strip-ansi": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
+      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
+    "node_modules/listr2/node_modules/wrap-ansi": {
+      "version": "9.0.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-9.0.0.tgz",
+      "integrity": "sha512-G8ura3S+3Z2G+mkgNRq8dqaFZAuxfsxpBB8OCTGRTCtp+l/v9nbFNmCUP1BZMts3G1142MsZfn6eeUKrr4PD1Q==",
+      "dev": true,
+      "dependencies": {
+        "ansi-styles": "^6.2.1",
+        "string-width": "^7.0.0",
+        "strip-ansi": "^7.1.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/lmdb": {
+      "version": "3.0.12",
+      "resolved": "https://registry.npmjs.org/lmdb/-/lmdb-3.0.12.tgz",
+      "integrity": "sha512-JnoEulTgveoC64vlYJ9sufGLuNkk6TcxSYpKxSC9aM42I61jIv3pQH0fgb6qW7HV0+FNqA3g1WCQQYfhfawGoQ==",
+      "dev": true,
+      "hasInstallScript": true,
+      "dependencies": {
+        "msgpackr": "^1.10.2",
+        "node-addon-api": "^6.1.0",
+        "node-gyp-build-optional-packages": "5.2.2",
+        "ordered-binary": "^1.4.1",
+        "weak-lru-cache": "^1.2.2"
+      },
+      "bin": {
+        "download-lmdb-prebuilds": "bin/download-prebuilds.js"
+      },
+      "optionalDependencies": {
+        "@lmdb/lmdb-darwin-arm64": "3.0.12",
+        "@lmdb/lmdb-darwin-x64": "3.0.12",
+        "@lmdb/lmdb-linux-arm": "3.0.12",
+        "@lmdb/lmdb-linux-arm64": "3.0.12",
+        "@lmdb/lmdb-linux-x64": "3.0.12",
+        "@lmdb/lmdb-win32-x64": "3.0.12"
+      }
+    },
     "node_modules/loader-runner": {
       "version": "4.3.0",
       "resolved": "https://registry.npmjs.org/loader-runner/-/loader-runner-4.3.0.tgz",
@@ -8750,24 +9384,27 @@
       }
     },
     "node_modules/loader-utils": {
-      "version": "3.2.1",
-      "resolved": "https://registry.npmjs.org/loader-utils/-/loader-utils-3.2.1.tgz",
-      "integrity": "sha512-ZvFw1KWS3GVyYBYb7qkmRM/WwL2TQQBxgCK62rlvm4WpVQ23Nb4tYjApUlfjrEGvOs7KHEsmyUn75OHZrJMWPw==",
+      "version": "3.3.1",
+      "resolved": "https://registry.npmjs.org/loader-utils/-/loader-utils-3.3.1.tgz",
+      "integrity": "sha512-FMJTLMXfCLMLfJxcX9PFqX5qD88Z5MRGaZCVzfuqeZSPsyiBzs+pahDQjbIWz2QIzPZz0NX9Zy4FX3lmK6YHIg==",
       "dev": true,
       "engines": {
         "node": ">= 12.13.0"
       }
     },
     "node_modules/locate-path": {
-      "version": "5.0.0",
-      "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-5.0.0.tgz",
-      "integrity": "sha512-t7hw9pI+WvuwNJXwk5zVHpyhIqzg2qTlklJOf0mVxGSbe3Fp2VieZcduNYjaLDoy6p9uGpQEGWG87WpMKlNq8g==",
+      "version": "7.2.0",
+      "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-7.2.0.tgz",
+      "integrity": "sha512-gvVijfZvn7R+2qyPX8mAuKcFGDf6Nc61GdvGafQsHL0sBIxfKzA+usWn4GFC/bk+QdwPUD4kWFJLhElipq+0VA==",
       "dev": true,
       "dependencies": {
-        "p-locate": "^4.1.0"
+        "p-locate": "^6.0.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/lodash": {
@@ -8853,19 +9490,137 @@
       "integrity": "sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": ">=8"
+      }
+    },
+    "node_modules/log-symbols/node_modules/supports-color": {
+      "version": "7.2.0",
+      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
+      "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
+      "dev": true,
+      "dependencies": {
+        "has-flag": "^4.0.0"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/log-update": {
+      "version": "6.0.0",
+      "resolved": "https://registry.npmjs.org/log-update/-/log-update-6.0.0.tgz",
+      "integrity": "sha512-niTvB4gqvtof056rRIrTZvjNYE4rCUzO6X/X+kYjd7WFxXeJ0NwEFnRxX6ehkvv3jTwrXnNdtAak5XYZuIyPFw==",
+      "dev": true,
+      "dependencies": {
+        "ansi-escapes": "^6.2.0",
+        "cli-cursor": "^4.0.0",
+        "slice-ansi": "^7.0.0",
+        "strip-ansi": "^7.1.0",
+        "wrap-ansi": "^9.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/log-update/node_modules/ansi-escapes": {
+      "version": "6.2.1",
+      "resolved": "https://registry.npmjs.org/ansi-escapes/-/ansi-escapes-6.2.1.tgz",
+      "integrity": "sha512-4nJ3yixlEthEJ9Rk4vPcdBRkZvQZlYyu8j4/Mqz5sgIkddmEnH2Yj2ZrnP9S3tQOvSNRUIgVNF/1yPpRAGNRig==",
+      "dev": true,
+      "engines": {
+        "node": ">=14.16"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/log-update/node_modules/ansi-regex": {
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
+      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/log-update/node_modules/ansi-styles": {
+      "version": "6.2.1",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
+      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
+    "node_modules/log-update/node_modules/is-fullwidth-code-point": {
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-5.0.0.tgz",
+      "integrity": "sha512-OVa3u9kkBbw7b8Xw5F9P+D/T9X+Z4+JruYVNapTjPYZYUznQ5YfWeFkOj606XYYW8yugTfC8Pj0hYqvi4ryAhA==",
+      "dev": true,
+      "dependencies": {
+        "get-east-asian-width": "^1.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/log-update/node_modules/slice-ansi": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/slice-ansi/-/slice-ansi-7.1.0.tgz",
+      "integrity": "sha512-bSiSngZ/jWeX93BqeIAbImyTbEihizcwNjFoRUIY/T1wWQsfsm2Vw1agPKylXvQTU7iASGdHhyqRlqQzfz+Htg==",
+      "dev": true,
+      "dependencies": {
+        "ansi-styles": "^6.2.1",
+        "is-fullwidth-code-point": "^5.0.0"
+      },
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/slice-ansi?sponsor=1"
+      }
+    },
+    "node_modules/log-update/node_modules/strip-ansi": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
+      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
       }
     },
-    "node_modules/log-symbols/node_modules/supports-color": {
-      "version": "7.2.0",
-      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
-      "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
+    "node_modules/log-update/node_modules/wrap-ansi": {
+      "version": "9.0.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-9.0.0.tgz",
+      "integrity": "sha512-G8ura3S+3Z2G+mkgNRq8dqaFZAuxfsxpBB8OCTGRTCtp+l/v9nbFNmCUP1BZMts3G1142MsZfn6eeUKrr4PD1Q==",
       "dev": true,
       "dependencies": {
-        "has-flag": "^4.0.0"
+        "ansi-styles": "^6.2.1",
+        "string-width": "^7.0.0",
+        "strip-ansi": "^7.1.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
       }
     },
     "node_modules/log4js": {
@@ -8894,15 +9649,12 @@
       }
     },
     "node_modules/magic-string": {
-      "version": "0.30.8",
-      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.8.tgz",
-      "integrity": "sha512-ISQTe55T2ao7XtlAStud6qwYPZjE4GK1S/BeVPus4jrq6JuOnQ00YKQC581RWhR122W7msZV263KzVeLoqidyQ==",
+      "version": "0.30.10",
+      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.10.tgz",
+      "integrity": "sha512-iIRwTIf0QKV3UAnYK4PU8uiEc4SRh5jX0mwpIwETPpHdhVM4f53RSwS/vXvN1JhGX+Cs7B8qIq3d6AH49O5fAQ==",
       "dev": true,
       "dependencies": {
         "@jridgewell/sourcemap-codec": "^1.4.15"
-      },
-      "engines": {
-        "node": ">=12"
       }
     },
     "node_modules/make-dir": {
@@ -8921,9 +9673,9 @@
       }
     },
     "node_modules/make-fetch-happen": {
-      "version": "13.0.0",
-      "resolved": "https://registry.npmjs.org/make-fetch-happen/-/make-fetch-happen-13.0.0.tgz",
-      "integrity": "sha512-7ThobcL8brtGo9CavByQrQi+23aIfgYU++wg4B87AIS8Rb2ZBt/MEaDqzA00Xwv/jUjAjYkLHjVolYuTLKda2A==",
+      "version": "13.0.1",
+      "resolved": "https://registry.npmjs.org/make-fetch-happen/-/make-fetch-happen-13.0.1.tgz",
+      "integrity": "sha512-cKTUFc/rbKUd/9meOvgrpJ2WrNzymt6jfRDdwg5UCnVzv9dTpEj9JS5m3wtziXVCjluIXyL8pcaukYqezIzZQA==",
       "dev": true,
       "dependencies": {
         "@npmcli/agent": "^2.0.0",
@@ -8935,6 +9687,7 @@
         "minipass-flush": "^1.0.5",
         "minipass-pipeline": "^1.2.4",
         "negotiator": "^0.6.3",
+        "proc-log": "^4.2.0",
         "promise-retry": "^2.0.1",
         "ssri": "^10.0.0"
       },
@@ -8952,15 +9705,22 @@
       }
     },
     "node_modules/memfs": {
-      "version": "3.5.3",
-      "resolved": "https://registry.npmjs.org/memfs/-/memfs-3.5.3.tgz",
-      "integrity": "sha512-UERzLsxzllchadvbPs5aolHh65ISpKpM+ccLbOJ8/vvpBKmAWf+la7dXFy7Mr0ySHbdHrFv5kGFCUHHe6GFEmw==",
+      "version": "4.9.3",
+      "resolved": "https://registry.npmjs.org/memfs/-/memfs-4.9.3.tgz",
+      "integrity": "sha512-bsYSSnirtYTWi1+OPMFb0M048evMKyUYe0EbtuGQgq6BVQM1g1W8/KIUJCCvjgI/El0j6Q4WsmMiBwLUBSw8LA==",
       "dev": true,
       "dependencies": {
-        "fs-monkey": "^1.0.4"
+        "@jsonjoy.com/json-pack": "^1.0.3",
+        "@jsonjoy.com/util": "^1.1.2",
+        "tree-dump": "^1.0.1",
+        "tslib": "^2.0.0"
       },
       "engines": {
         "node": ">= 4.0.0"
+      },
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
       }
     },
     "node_modules/merge-descriptors": {
@@ -8994,12 +9754,12 @@
       }
     },
     "node_modules/micromatch": {
-      "version": "4.0.5",
-      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.5.tgz",
-      "integrity": "sha512-DMy+ERcEW2q8Z2Po+WNXuw3c5YaUSFjAO5GsJqfEl7UjvtIuFKO6ZrKvcItdy98dwFI2N1tg3zNIdKaQT+aNdA==",
+      "version": "4.0.7",
+      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.7.tgz",
+      "integrity": "sha512-LPP/3KorzCwBxfeUuZmaR6bG2kdeHSbe0P2tY3FLRU4vYrjYz5hI4QZwV0njUx3jeuKe67YukQ1LSPZBKDqO/Q==",
       "dev": true,
       "dependencies": {
-        "braces": "^3.0.2",
+        "braces": "^3.0.3",
         "picomatch": "^2.3.1"
       },
       "engines": {
@@ -9061,9 +9821,9 @@
       }
     },
     "node_modules/mini-css-extract-plugin": {
-      "version": "2.8.1",
-      "resolved": "https://registry.npmjs.org/mini-css-extract-plugin/-/mini-css-extract-plugin-2.8.1.tgz",
-      "integrity": "sha512-/1HDlyFRxWIZPI1ZpgqlZ8jMw/1Dp/dl3P0L1jtZ+zVcHqwPhGwaJwKL00WVgfnBy6PWCde9W65or7IIETImuA==",
+      "version": "2.9.0",
+      "resolved": "https://registry.npmjs.org/mini-css-extract-plugin/-/mini-css-extract-plugin-2.9.0.tgz",
+      "integrity": "sha512-Zs1YsZVfemekSZG+44vBsYTLQORkPMwnlv+aehcxK/NLKC+EGhDB39/YePYYqx/sTk6NnYpuqikhSn7+JIevTA==",
       "dev": true,
       "dependencies": {
         "schema-utils": "^4.0.0",
@@ -9108,9 +9868,9 @@
       }
     },
     "node_modules/minipass": {
-      "version": "7.0.4",
-      "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.0.4.tgz",
-      "integrity": "sha512-jYofLM5Dam9279rdkWzqHozUo4ybjdZmCsDHePy5V/PbBcVMiSZR97gmAy45aqi8CK1lG2ECd356FU86avfwUQ==",
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
+      "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
       "dev": true,
       "engines": {
         "node": ">=16 || 14 >=14.17"
@@ -9129,9 +9889,9 @@
       }
     },
     "node_modules/minipass-fetch": {
-      "version": "3.0.4",
-      "resolved": "https://registry.npmjs.org/minipass-fetch/-/minipass-fetch-3.0.4.tgz",
-      "integrity": "sha512-jHAqnA728uUpIaFm7NWsCnqKT6UqZz7GcI/bDpPATuwYyKwJwW0remxSCxUlKiEty+eopHGa3oc8WxgQ1FFJqg==",
+      "version": "3.0.5",
+      "resolved": "https://registry.npmjs.org/minipass-fetch/-/minipass-fetch-3.0.5.tgz",
+      "integrity": "sha512-2N8elDQAtSnFV0Dk7gt15KHsS0Fyz6CbYZ360h0WTYV1Ty46li3rAXVOQj1THMNLdmrD9Vt5pBPtWtVkpwGBqg==",
       "dev": true,
       "dependencies": {
         "minipass": "^7.0.3",
@@ -9175,34 +9935,6 @@
       "integrity": "sha512-3wdGidZyq5PB084XLES5TpOSRA3wjXAlIWMhum2kRcv/41Sn2emQ0dycQW4uZXLejwKvg6EsvbdlVL+FYEct7A==",
       "dev": true
     },
-    "node_modules/minipass-json-stream": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/minipass-json-stream/-/minipass-json-stream-1.0.1.tgz",
-      "integrity": "sha512-ODqY18UZt/I8k+b7rl2AENgbWE8IDYam+undIJONvigAz8KR5GWblsFTEfQs0WODsjbSXWlm+JHEv8Gr6Tfdbg==",
-      "dev": true,
-      "dependencies": {
-        "jsonparse": "^1.3.1",
-        "minipass": "^3.0.0"
-      }
-    },
-    "node_modules/minipass-json-stream/node_modules/minipass": {
-      "version": "3.3.6",
-      "resolved": "https://registry.npmjs.org/minipass/-/minipass-3.3.6.tgz",
-      "integrity": "sha512-DxiNidxSEK+tHG6zOIklvNOwm3hvCrbUrdtzY74U6HKTJxvIDfOUL5W5P2Ghd3DTkhhKPYGqeNUIh5qcM4YBfw==",
-      "dev": true,
-      "dependencies": {
-        "yallist": "^4.0.0"
-      },
-      "engines": {
-        "node": ">=8"
-      }
-    },
-    "node_modules/minipass-json-stream/node_modules/yallist": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz",
-      "integrity": "sha512-3wdGidZyq5PB084XLES5TpOSRA3wjXAlIWMhum2kRcv/41Sn2emQ0dycQW4uZXLejwKvg6EsvbdlVL+FYEct7A==",
-      "dev": true
-    },
     "node_modules/minipass-pipeline": {
       "version": "1.2.4",
       "resolved": "https://registry.npmjs.org/minipass-pipeline/-/minipass-pipeline-1.2.4.tgz",
@@ -9321,6 +10053,37 @@
       "integrity": "sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w==",
       "dev": true
     },
+    "node_modules/msgpackr": {
+      "version": "1.11.0",
+      "resolved": "https://registry.npmjs.org/msgpackr/-/msgpackr-1.11.0.tgz",
+      "integrity": "sha512-I8qXuuALqJe5laEBYoFykChhSXLikZmUhccjGsPuSJ/7uPip2TJ7lwdIQwWSAi0jGZDXv4WOP8Qg65QZRuXxXw==",
+      "dev": true,
+      "optionalDependencies": {
+        "msgpackr-extract": "^3.0.2"
+      }
+    },
+    "node_modules/msgpackr-extract": {
+      "version": "3.0.3",
+      "resolved": "https://registry.npmjs.org/msgpackr-extract/-/msgpackr-extract-3.0.3.tgz",
+      "integrity": "sha512-P0efT1C9jIdVRefqjzOQ9Xml57zpOXnIuS+csaB4MdZbTdmGDLo8XhzBG1N7aO11gKDDkJvBLULeFTo46wwreA==",
+      "dev": true,
+      "hasInstallScript": true,
+      "optional": true,
+      "dependencies": {
+        "node-gyp-build-optional-packages": "5.2.2"
+      },
+      "bin": {
+        "download-msgpackr-prebuilds": "bin/download-prebuilds.js"
+      },
+      "optionalDependencies": {
+        "@msgpackr-extract/msgpackr-extract-darwin-arm64": "3.0.3",
+        "@msgpackr-extract/msgpackr-extract-darwin-x64": "3.0.3",
+        "@msgpackr-extract/msgpackr-extract-linux-arm": "3.0.3",
+        "@msgpackr-extract/msgpackr-extract-linux-arm64": "3.0.3",
+        "@msgpackr-extract/msgpackr-extract-linux-x64": "3.0.3",
+        "@msgpackr-extract/msgpackr-extract-win32-x64": "3.0.3"
+      }
+    },
     "node_modules/multicast-dns": {
       "version": "7.2.5",
       "resolved": "https://registry.npmjs.org/multicast-dns/-/multicast-dns-7.2.5.tgz",
@@ -9406,6 +10169,22 @@
       "integrity": "sha512-Yd3UES5mWCSqR+qNT93S3UoYUkqAZ9lLg8a7g9rimsWmYGK8cVToA4/sF3RrshdyV3sAGMXVUmpMYOw+dLpOuw==",
       "dev": true
     },
+    "node_modules/ng-keyboard-shortcuts": {
+      "version": "13.0.8",
+      "resolved": "https://registry.npmjs.org/ng-keyboard-shortcuts/-/ng-keyboard-shortcuts-13.0.8.tgz",
+      "integrity": "sha512-xmEFgmxfp+ssoLRAbDn/QJYyi5CmNm8AfCZiwEk6XlZGl8DN7uRuticEP3J0Nxop+HeoS9YSpQzPrrYo9h9juQ==",
+      "dependencies": {
+        "tslib": "^2.3.0"
+      },
+      "peerDependencies": {
+        "@angular/animations": ">=9.0.0",
+        "@angular/common": ">=9.0.0",
+        "@angular/compiler": ">=9.0.0",
+        "@angular/core": ">=9.0.0",
+        "@angular/platform-browser": ">=9.0.0",
+        "rxjs": ">=6.0.0"
+      }
+    },
     "node_modules/nice-napi": {
       "version": "1.0.2",
       "resolved": "https://registry.npmjs.org/nice-napi/-/nice-napi-1.0.2.tgz",
@@ -9421,13 +10200,19 @@
         "node-gyp-build": "^4.2.2"
       }
     },
-    "node_modules/node-addon-api": {
+    "node_modules/nice-napi/node_modules/node-addon-api": {
       "version": "3.2.1",
       "resolved": "https://registry.npmjs.org/node-addon-api/-/node-addon-api-3.2.1.tgz",
       "integrity": "sha512-mmcei9JghVNDYydghQmeDX8KoAm0FAiYyIcUt/N4nhyAipB17pllZQDOJD2fotxABnt4Mdz+dKTO7eftLg4d0A==",
       "dev": true,
       "optional": true
     },
+    "node_modules/node-addon-api": {
+      "version": "6.1.0",
+      "resolved": "https://registry.npmjs.org/node-addon-api/-/node-addon-api-6.1.0.tgz",
+      "integrity": "sha512-+eawOlIgy680F0kBzPUNFhMZGtJ1YmqM6l4+Crf4IkImjYrO/mqPwRMh352g23uIaQKFItcQ64I7KMaJxHgAVA==",
+      "dev": true
+    },
     "node_modules/node-forge": {
       "version": "1.3.1",
       "resolved": "https://registry.npmjs.org/node-forge/-/node-forge-1.3.1.tgz",
@@ -9438,9 +10223,9 @@
       }
     },
     "node_modules/node-gyp": {
-      "version": "10.1.0",
-      "resolved": "https://registry.npmjs.org/node-gyp/-/node-gyp-10.1.0.tgz",
-      "integrity": "sha512-B4J5M1cABxPc5PwfjhbV5hoy2DP9p8lFXASnEN6hugXOa61416tnTZ29x9sSwAd0o99XNIcpvDDy1swAExsVKA==",
+      "version": "10.2.0",
+      "resolved": "https://registry.npmjs.org/node-gyp/-/node-gyp-10.2.0.tgz",
+      "integrity": "sha512-sp3FonBAaFe4aYTcFdZUn2NYkbP7xroPGYvQmP4Nl5PxamznItBnNCgjrVTKrEfQynInMsJvZrdmqUnysCJ8rw==",
       "dev": true,
       "dependencies": {
         "env-paths": "^2.2.0",
@@ -9449,9 +10234,9 @@
         "graceful-fs": "^4.2.6",
         "make-fetch-happen": "^13.0.0",
         "nopt": "^7.0.0",
-        "proc-log": "^3.0.0",
+        "proc-log": "^4.1.0",
         "semver": "^7.3.5",
-        "tar": "^6.1.2",
+        "tar": "^6.2.1",
         "which": "^4.0.0"
       },
       "bin": {
@@ -9462,9 +10247,9 @@
       }
     },
     "node_modules/node-gyp-build": {
-      "version": "4.8.0",
-      "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.0.tgz",
-      "integrity": "sha512-u6fs2AEUljNho3EYTJNBfImO5QTo/J/1Etd+NVdCj7qWKUSN/bSLkZwhDv7I+w/MSC6qJ4cknepkAYykDdK8og==",
+      "version": "4.8.1",
+      "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.1.tgz",
+      "integrity": "sha512-OSs33Z9yWr148JZcbZd5WiAXhh/n9z8TxQcdMhIOlpN9AhWpLfvVFO73+m77bBABQMaY9XSvIa+qk0jlI7Gcaw==",
       "dev": true,
       "optional": true,
       "bin": {
@@ -9473,6 +10258,20 @@
         "node-gyp-build-test": "build-test.js"
       }
     },
+    "node_modules/node-gyp-build-optional-packages": {
+      "version": "5.2.2",
+      "resolved": "https://registry.npmjs.org/node-gyp-build-optional-packages/-/node-gyp-build-optional-packages-5.2.2.tgz",
+      "integrity": "sha512-s+w+rBWnpTMwSFbaE0UXsRlg7hU4FjekKU4eyAih5T8nJuNZT1nNsskXpxmeqSK9UzkBl6UgRlnKc8hz8IEqOw==",
+      "dev": true,
+      "dependencies": {
+        "detect-libc": "^2.0.1"
+      },
+      "bin": {
+        "node-gyp-build-optional-packages": "bin.js",
+        "node-gyp-build-optional-packages-optional": "optional.js",
+        "node-gyp-build-optional-packages-test": "build-test.js"
+      }
+    },
     "node_modules/node-gyp/node_modules/brace-expansion": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
@@ -9483,23 +10282,21 @@
       }
     },
     "node_modules/node-gyp/node_modules/glob": {
-      "version": "10.3.12",
-      "resolved": "https://registry.npmjs.org/glob/-/glob-10.3.12.tgz",
-      "integrity": "sha512-TCNv8vJ+xz4QiqTpfOJA7HvYv+tNIRHKfUWw/q+v2jdgN4ebz+KY9tGx5J4rHP0o84mNP+ApH66HRX8us3Khqg==",
+      "version": "10.4.5",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
+      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
       "dev": true,
       "dependencies": {
         "foreground-child": "^3.1.0",
-        "jackspeak": "^2.3.6",
-        "minimatch": "^9.0.1",
-        "minipass": "^7.0.4",
-        "path-scurry": "^1.10.2"
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
       },
       "bin": {
         "glob": "dist/esm/bin.mjs"
       },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       }
@@ -9514,9 +10311,9 @@
       }
     },
     "node_modules/node-gyp/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
       "dev": true,
       "dependencies": {
         "brace-expansion": "^2.0.1"
@@ -9544,15 +10341,15 @@
       }
     },
     "node_modules/node-releases": {
-      "version": "2.0.14",
-      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.14.tgz",
-      "integrity": "sha512-y10wOWt8yZpqXmOgRo77WaHEmhYQYGNA6y421PKsKYWEK8aW+cqAphborZDhqfyKrbZEN92CN1X2KbafY2s7Yw==",
+      "version": "2.0.17",
+      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.17.tgz",
+      "integrity": "sha512-Ww6ZlOiEQfPfXM45v17oabk77Z7mg5bOt7AjDyzy7RjK9OrLrLC8dyZQoAPEOtFX9SaNf1Tdvr5gRJWdTJj7GA==",
       "dev": true
     },
     "node_modules/nopt": {
-      "version": "7.2.0",
-      "resolved": "https://registry.npmjs.org/nopt/-/nopt-7.2.0.tgz",
-      "integrity": "sha512-CVDtwCdhYIvnAzFoJ6NJ6dX3oga9/HyciQDnG1vQDjSLMeKLJ4A93ZqYKDrgYSr1FBY5/hMYC+2VCi24pgpkGA==",
+      "version": "7.2.1",
+      "resolved": "https://registry.npmjs.org/nopt/-/nopt-7.2.1.tgz",
+      "integrity": "sha512-taM24ViiimT/XntxbPyJQzCG+p4EKOpgD3mxFwW38mGjVUrfERQOeY4EDHjdnptttfHuHQXFx+lTP08Q+mLa/w==",
       "dev": true,
       "dependencies": {
         "abbrev": "^2.0.0"
@@ -9565,13 +10362,12 @@
       }
     },
     "node_modules/normalize-package-data": {
-      "version": "6.0.0",
-      "resolved": "https://registry.npmjs.org/normalize-package-data/-/normalize-package-data-6.0.0.tgz",
-      "integrity": "sha512-UL7ELRVxYBHBgYEtZCXjxuD5vPxnmvMGq0jp/dGPKKrN7tfsBh2IY7TlJ15WWwdjRWD3RJbnsygUurTK3xkPkg==",
+      "version": "6.0.2",
+      "resolved": "https://registry.npmjs.org/normalize-package-data/-/normalize-package-data-6.0.2.tgz",
+      "integrity": "sha512-V6gygoYb/5EmNI+MEGrWkC+e6+Rr7mTmfHrxDbLzxQogBkgzo76rkok0Am6thgSF7Mv2nLOajAJj5vDJZEFn7g==",
       "dev": true,
       "dependencies": {
         "hosted-git-info": "^7.0.0",
-        "is-core-module": "^2.8.1",
         "semver": "^7.3.5",
         "validate-npm-package-license": "^3.0.4"
       },
@@ -9598,9 +10394,9 @@
       }
     },
     "node_modules/npm-bundled": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/npm-bundled/-/npm-bundled-3.0.0.tgz",
-      "integrity": "sha512-Vq0eyEQy+elFpzsKjMss9kxqb9tG3YHg4dsyWuUENuzvSUWe1TCnW/vV9FkhvBk/brEDoDiVd+M1Btosa6ImdQ==",
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/npm-bundled/-/npm-bundled-3.0.1.tgz",
+      "integrity": "sha512-+AvaheE/ww1JEwRHOrn4WHNzOxGtVp+adrg2AeZS/7KuxGUYFuBta98wYpfHBbJp6Tg6j1NKSEVHNcfZzJHQwQ==",
       "dev": true,
       "dependencies": {
         "npm-normalize-package-bin": "^3.0.0"
@@ -9631,13 +10427,13 @@
       }
     },
     "node_modules/npm-package-arg": {
-      "version": "11.0.1",
-      "resolved": "https://registry.npmjs.org/npm-package-arg/-/npm-package-arg-11.0.1.tgz",
-      "integrity": "sha512-M7s1BD4NxdAvBKUPqqRW957Xwcl/4Zvo8Aj+ANrzvIPzGJZElrH7Z//rSaec2ORcND6FHHLnZeY8qgTpXDMFQQ==",
+      "version": "11.0.2",
+      "resolved": "https://registry.npmjs.org/npm-package-arg/-/npm-package-arg-11.0.2.tgz",
+      "integrity": "sha512-IGN0IAwmhDJwy13Wc8k+4PEbTPhpJnMtfR53ZbOyjkvmEcLS4nCwp6mvMWjS5sUjeiW3mpx6cHmuhKEu9XmcQw==",
       "dev": true,
       "dependencies": {
         "hosted-git-info": "^7.0.0",
-        "proc-log": "^3.0.0",
+        "proc-log": "^4.0.0",
         "semver": "^7.3.5",
         "validate-npm-package-name": "^5.0.0"
       },
@@ -9658,9 +10454,9 @@
       }
     },
     "node_modules/npm-pick-manifest": {
-      "version": "9.0.0",
-      "resolved": "https://registry.npmjs.org/npm-pick-manifest/-/npm-pick-manifest-9.0.0.tgz",
-      "integrity": "sha512-VfvRSs/b6n9ol4Qb+bDwNGUXutpy76x6MARw/XssevE0TnctIKcmklJZM5Z7nqs5z5aW+0S63pgCNbpkUNNXBg==",
+      "version": "9.0.1",
+      "resolved": "https://registry.npmjs.org/npm-pick-manifest/-/npm-pick-manifest-9.0.1.tgz",
+      "integrity": "sha512-Udm1f0l2nXb3wxDpKjfohwgdFUSV50UVwzEIpDXVsbDMXVIEF81a/i0UhuQbhrPMMmdiq3+YMFLFIRVLs3hxQw==",
       "dev": true,
       "dependencies": {
         "npm-install-checks": "^6.0.0",
@@ -9673,16 +10469,16 @@
       }
     },
     "node_modules/npm-registry-fetch": {
-      "version": "16.2.1",
-      "resolved": "https://registry.npmjs.org/npm-registry-fetch/-/npm-registry-fetch-16.2.1.tgz",
-      "integrity": "sha512-8l+7jxhim55S85fjiDGJ1rZXBWGtRLi1OSb4Z3BPLObPuIaeKRlPRiYMSHU4/81ck3t71Z+UwDDl47gcpmfQQA==",
+      "version": "17.1.0",
+      "resolved": "https://registry.npmjs.org/npm-registry-fetch/-/npm-registry-fetch-17.1.0.tgz",
+      "integrity": "sha512-5+bKQRH0J1xG1uZ1zMNvxW0VEyoNWgJpY9UDuluPFLKDfJ9u2JmmjmTJV1srBGQOROfdBMiVvnH2Zvpbm+xkVA==",
       "dev": true,
       "dependencies": {
-        "@npmcli/redact": "^1.1.0",
+        "@npmcli/redact": "^2.0.0",
+        "jsonparse": "^1.3.1",
         "make-fetch-happen": "^13.0.0",
         "minipass": "^7.0.2",
         "minipass-fetch": "^3.0.0",
-        "minipass-json-stream": "^1.0.1",
         "minizlib": "^2.1.2",
         "npm-package-arg": "^11.0.0",
         "proc-log": "^4.0.0"
@@ -9691,15 +10487,6 @@
         "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/npm-registry-fetch/node_modules/proc-log": {
-      "version": "4.2.0",
-      "resolved": "https://registry.npmjs.org/proc-log/-/proc-log-4.2.0.tgz",
-      "integrity": "sha512-g8+OnU/L2v+wyiVK+D5fA34J7EH8jZ8DDlvwhRCMxmMj7UCBvxiO1mGeN+36JXIKF4zevU4kRBd8lVgG9vLelA==",
-      "dev": true,
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
-    },
     "node_modules/npm-run-path": {
       "version": "4.0.1",
       "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-4.0.1.tgz",
@@ -9734,10 +10521,13 @@
       }
     },
     "node_modules/object-inspect": {
-      "version": "1.13.1",
-      "resolved": "https://registry.npmjs.org/object-inspect/-/object-inspect-1.13.1.tgz",
-      "integrity": "sha512-5qoj1RUiKOMsCCNLV1CBiPYE10sziTsnmNxkAI/rZhiD63CF7IqdFGC/XzjWjpSgLf0LxXX3bDFIh0E18f6UhQ==",
+      "version": "1.13.2",
+      "resolved": "https://registry.npmjs.org/object-inspect/-/object-inspect-1.13.2.tgz",
+      "integrity": "sha512-IRZSRuzJiynemAXPYtPe5BoI/RESNYR7TYm50MC5Mqbd3Jmw5y790sErYw3V6SryFJD64b74qQQs9wn5Bg/k3g==",
       "dev": true,
+      "engines": {
+        "node": ">= 0.4"
+      },
       "funding": {
         "url": "https://github.com/sponsors/ljharb"
       }
@@ -9794,17 +10584,18 @@
       }
     },
     "node_modules/open": {
-      "version": "8.4.2",
-      "resolved": "https://registry.npmjs.org/open/-/open-8.4.2.tgz",
-      "integrity": "sha512-7x81NCL719oNbsq/3mh+hVrAWmFuEYUqrq/Iw3kUzH8ReypT9QQ0BLoJS7/G9k6N81XjW4qHWtjWwe/9eLy1EQ==",
+      "version": "10.1.0",
+      "resolved": "https://registry.npmjs.org/open/-/open-10.1.0.tgz",
+      "integrity": "sha512-mnkeQ1qP5Ue2wd+aivTD3NHd/lZ96Lu0jgf0pwktLPtx6cTZiH7tyeGRRHs0zX0rbrahXPnXlUnbeXyaBBuIaw==",
       "dev": true,
       "dependencies": {
-        "define-lazy-prop": "^2.0.0",
-        "is-docker": "^2.1.1",
-        "is-wsl": "^2.2.0"
+        "default-browser": "^5.2.1",
+        "define-lazy-prop": "^3.0.0",
+        "is-inside-container": "^1.0.0",
+        "is-wsl": "^3.1.0"
       },
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
@@ -9864,6 +10655,18 @@
         "url": "https://github.com/chalk/chalk?sponsor=1"
       }
     },
+    "node_modules/ora/node_modules/cli-cursor": {
+      "version": "3.1.0",
+      "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-3.1.0.tgz",
+      "integrity": "sha512-I/zHAwsKf9FqGoXM4WWRACob9+SNukZTd94DWF57E4toouRulbCxcUh6RKUEOQlYTHJnzkPMySvPNaaSLNfLZw==",
+      "dev": true,
+      "dependencies": {
+        "restore-cursor": "^3.1.0"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/ora/node_modules/color-convert": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
@@ -9891,6 +10694,25 @@
         "node": ">=8"
       }
     },
+    "node_modules/ora/node_modules/restore-cursor": {
+      "version": "3.1.0",
+      "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-3.1.0.tgz",
+      "integrity": "sha512-l+sSefzHpj5qimhFSE5a8nufZYAM3sBSVMAPtYkmC+4EH2anSGaEMXSD0izRQbu9nfyQ9y5JrVmp7E8oZrUjvA==",
+      "dev": true,
+      "dependencies": {
+        "onetime": "^5.1.0",
+        "signal-exit": "^3.0.2"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/ora/node_modules/signal-exit": {
+      "version": "3.0.7",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
+      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
+      "dev": true
+    },
     "node_modules/ora/node_modules/supports-color": {
       "version": "7.2.0",
       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
@@ -9903,6 +10725,12 @@
         "node": ">=8"
       }
     },
+    "node_modules/ordered-binary": {
+      "version": "1.5.1",
+      "resolved": "https://registry.npmjs.org/ordered-binary/-/ordered-binary-1.5.1.tgz",
+      "integrity": "sha512-5VyHfHY3cd0iza71JepYG50My+YUbrFtGoUz2ooEydPyPM7Aai/JW098juLr+RG6+rDJuzNNTsEQu2DZa1A41A==",
+      "dev": true
+    },
     "node_modules/os-tmpdir": {
       "version": "1.0.2",
       "resolved": "https://registry.npmjs.org/os-tmpdir/-/os-tmpdir-1.0.2.tgz",
@@ -9913,30 +10741,33 @@
       }
     },
     "node_modules/p-limit": {
-      "version": "2.3.0",
-      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-2.3.0.tgz",
-      "integrity": "sha512-//88mFWSJx8lxCzwdAABTJL2MyWB12+eIY7MDL2SqLmAkeKU9qxRvWuSyTjm3FUmpBEMuFfckAIqEaVGUDxb6w==",
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-4.0.0.tgz",
+      "integrity": "sha512-5b0R4txpzjPWVw/cXXUResoD4hb6U/x9BH08L7nw+GN1sezDzPdxeRvpc9c433fZhBan/wusjbCsqwqm4EIBIQ==",
       "dev": true,
       "dependencies": {
-        "p-try": "^2.0.0"
+        "yocto-queue": "^1.0.0"
       },
       "engines": {
-        "node": ">=6"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/p-locate": {
-      "version": "4.1.0",
-      "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-4.1.0.tgz",
-      "integrity": "sha512-R79ZZ/0wAxKGu3oYMlz8jy/kbhsNrS7SKZ7PxEHBgJ5+F2mtFW2fK2cOtBh1cHYkQsbzFV7I+EoRKe6Yt0oK7A==",
+      "version": "6.0.0",
+      "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-6.0.0.tgz",
+      "integrity": "sha512-wPrq66Llhl7/4AGC6I+cqxT07LhXvWL08LNXz1fENOw0Ap4sRZZ/gZpTTJ5jpurzzzfS2W/Ge9BY3LgLjCShcw==",
       "dev": true,
       "dependencies": {
-        "p-limit": "^2.2.0"
+        "p-limit": "^4.0.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/p-map": {
@@ -9955,16 +10786,20 @@
       }
     },
     "node_modules/p-retry": {
-      "version": "4.6.2",
-      "resolved": "https://registry.npmjs.org/p-retry/-/p-retry-4.6.2.tgz",
-      "integrity": "sha512-312Id396EbJdvRONlngUx0NydfrIQ5lsYu0znKVUzVvArzEIt08V1qhtyESbGVd1FGX7UKtiFp5uwKZdM8wIuQ==",
+      "version": "6.2.0",
+      "resolved": "https://registry.npmjs.org/p-retry/-/p-retry-6.2.0.tgz",
+      "integrity": "sha512-JA6nkq6hKyWLLasXQXUrO4z8BUZGUt/LjlJxx8Gb2+2ntodU/SS63YZ8b0LUTbQ8ZB9iwOfhEPhg4ykKnn2KsA==",
       "dev": true,
       "dependencies": {
-        "@types/retry": "0.12.0",
+        "@types/retry": "0.12.2",
+        "is-network-error": "^1.0.0",
         "retry": "^0.13.1"
       },
       "engines": {
-        "node": ">=8"
+        "node": ">=16.17"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/p-retry/node_modules/retry": {
@@ -9976,42 +10811,38 @@
         "node": ">= 4"
       }
     },
-    "node_modules/p-try": {
-      "version": "2.2.0",
-      "resolved": "https://registry.npmjs.org/p-try/-/p-try-2.2.0.tgz",
-      "integrity": "sha512-R4nPAVTAU0B9D35/Gk3uJf/7XYbQcyohSKdvAxIRSNghFl4e71hVoGnBNQz9cWaXxO2I10KTC+3jMdvvoKw6dQ==",
-      "dev": true,
-      "engines": {
-        "node": ">=6"
-      }
+    "node_modules/package-json-from-dist": {
+      "version": "1.0.0",
+      "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.0.tgz",
+      "integrity": "sha512-dATvCeZN/8wQsGywez1mzHtTlP22H8OEfPrVMLNr4/eGa+ijtLn/6M5f0dY8UKNrC2O9UCU6SSoG3qRKnt7STw==",
+      "dev": true
     },
     "node_modules/pacote": {
-      "version": "17.0.6",
-      "resolved": "https://registry.npmjs.org/pacote/-/pacote-17.0.6.tgz",
-      "integrity": "sha512-cJKrW21VRE8vVTRskJo78c/RCvwJCn1f4qgfxL4w77SOWrTCRcmfkYHlHtS0gqpgjv3zhXflRtgsrUCX5xwNnQ==",
+      "version": "18.0.6",
+      "resolved": "https://registry.npmjs.org/pacote/-/pacote-18.0.6.tgz",
+      "integrity": "sha512-+eK3G27SMwsB8kLIuj4h1FUhHtwiEUo21Tw8wNjmvdlpOEr613edv+8FUsTj/4F/VN5ywGE19X18N7CC2EJk6A==",
       "dev": true,
       "dependencies": {
         "@npmcli/git": "^5.0.0",
         "@npmcli/installed-package-contents": "^2.0.1",
+        "@npmcli/package-json": "^5.1.0",
         "@npmcli/promise-spawn": "^7.0.0",
-        "@npmcli/run-script": "^7.0.0",
+        "@npmcli/run-script": "^8.0.0",
         "cacache": "^18.0.0",
         "fs-minipass": "^3.0.0",
         "minipass": "^7.0.2",
         "npm-package-arg": "^11.0.0",
         "npm-packlist": "^8.0.0",
         "npm-pick-manifest": "^9.0.0",
-        "npm-registry-fetch": "^16.0.0",
-        "proc-log": "^3.0.0",
+        "npm-registry-fetch": "^17.0.0",
+        "proc-log": "^4.0.0",
         "promise-retry": "^2.0.1",
-        "read-package-json": "^7.0.0",
-        "read-package-json-fast": "^3.0.0",
         "sigstore": "^2.2.0",
         "ssri": "^10.0.0",
         "tar": "^6.1.11"
       },
       "bin": {
-        "pacote": "lib/bin.js"
+        "pacote": "bin/index.js"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
@@ -10110,12 +10941,12 @@
       }
     },
     "node_modules/path-exists": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-4.0.0.tgz",
-      "integrity": "sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==",
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-5.0.0.tgz",
+      "integrity": "sha512-RjhtfwJOxzcFmNOi6ltcbcu4Iu+FL3zEj83dk4kAS+fVpTxXLO1b38RvJgT/0QwvV/L3aY9TAnyv0EOqW4GoMQ==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
       }
     },
     "node_modules/path-is-absolute": {
@@ -10143,29 +10974,26 @@
       "dev": true
     },
     "node_modules/path-scurry": {
-      "version": "1.10.2",
-      "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.10.2.tgz",
-      "integrity": "sha512-7xTavNy5RQXnsjANvVvMkEjvloOinkAjv/Z6Ildz9v2RinZ4SBKTWFOVRbaF8p0vpHnyjV/UwNDdKuUv6M5qcA==",
+      "version": "1.11.1",
+      "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.11.1.tgz",
+      "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
       "dev": true,
       "dependencies": {
         "lru-cache": "^10.2.0",
         "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
       },
       "engines": {
-        "node": ">=16 || 14 >=14.17"
+        "node": ">=16 || 14 >=14.18"
       },
       "funding": {
         "url": "https://github.com/sponsors/isaacs"
       }
     },
     "node_modules/path-scurry/node_modules/lru-cache": {
-      "version": "10.2.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.2.0.tgz",
-      "integrity": "sha512-2bIM8x+VAf6JT4bKAljS1qUWgMsqZRPGJS6FSahIMPVvctcNhyVp7AJu7quxOW9jwkryBReKZY5tY5JYv2n/7Q==",
-      "dev": true,
-      "engines": {
-        "node": "14 || >=16.14"
-      }
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true
     },
     "node_modules/path-to-regexp": {
       "version": "0.1.7",
@@ -10174,24 +11002,27 @@
       "dev": true
     },
     "node_modules/path-type": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/path-type/-/path-type-4.0.0.tgz",
-      "integrity": "sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==",
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/path-type/-/path-type-5.0.0.tgz",
+      "integrity": "sha512-5HviZNaZcfqP95rwpv+1HDgUamezbqdSYTyzjTvwtJSnIH+3vnbmWsItli8OFEndS984VT55M3jduxZbX351gg==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/picocolors": {
-      "version": "1.0.0",
-      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.0.0.tgz",
-      "integrity": "sha512-1fygroTLlHu66zi26VoTDv8yRgm0Fccecssto+MhsZ0D/DGW2sm8E8AjW7NU5VVTRt5GxbeZ5qBuJr+HyLYkjQ==",
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.0.1.tgz",
+      "integrity": "sha512-anP1Z8qwhkbmu7MFP5iTt+wQKXgwzf7zTyGlcdzabySa9vd0Xt392U0rVmz9poOaBj0uHJKyyo9/upk0HrEQew==",
       "dev": true
     },
     "node_modules/picomatch": {
-      "version": "4.0.1",
-      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.1.tgz",
-      "integrity": "sha512-xUXwsxNjwTQ8K3GnT4pCJm+xq3RUPQbmkYJTP5aFIfNIvbcc/4MUxgBaaRSZJ6yGJZiGSyYlM6MzwTsRk8SYCg==",
+      "version": "4.0.2",
+      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.2.tgz",
+      "integrity": "sha512-M7BAV6Rlcy5u+m6oPhAPFgJTzAioX/6B0DxyvDlo9l8+T3nLKbrczg2WLUyzd45L8RqfUMyGPzekbMvX2Ldkwg==",
       "dev": true,
       "engines": {
         "node": ">=12"
@@ -10211,103 +11042,33 @@
       }
     },
     "node_modules/piscina": {
-      "version": "4.4.0",
-      "resolved": "https://registry.npmjs.org/piscina/-/piscina-4.4.0.tgz",
-      "integrity": "sha512-+AQduEJefrOApE4bV7KRmp3N2JnnyErlVqq4P/jmko4FPz9Z877BCccl/iB3FdrWSUkvbGV9Kan/KllJgat3Vg==",
-      "dev": true,
-      "optionalDependencies": {
-        "nice-napi": "^1.0.2"
-      }
-    },
-    "node_modules/pkg-dir": {
-      "version": "7.0.0",
-      "resolved": "https://registry.npmjs.org/pkg-dir/-/pkg-dir-7.0.0.tgz",
-      "integrity": "sha512-Ie9z/WINcxxLp27BKOCHGde4ITq9UklYKDzVo1nhk5sqGEXU3FpkwP5GM2voTGJkGd9B3Otl+Q4uwSOeSUtOBA==",
-      "dev": true,
-      "dependencies": {
-        "find-up": "^6.3.0"
-      },
-      "engines": {
-        "node": ">=14.16"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
-    "node_modules/pkg-dir/node_modules/find-up": {
-      "version": "6.3.0",
-      "resolved": "https://registry.npmjs.org/find-up/-/find-up-6.3.0.tgz",
-      "integrity": "sha512-v2ZsoEuVHYy8ZIlYqwPe/39Cy+cFDzp4dXPaxNvkEuouymu+2Jbz0PxpKarJHYJTmv2HWT3O382qY8l4jMWthw==",
-      "dev": true,
-      "dependencies": {
-        "locate-path": "^7.1.0",
-        "path-exists": "^5.0.0"
-      },
-      "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
-    "node_modules/pkg-dir/node_modules/locate-path": {
-      "version": "7.2.0",
-      "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-7.2.0.tgz",
-      "integrity": "sha512-gvVijfZvn7R+2qyPX8mAuKcFGDf6Nc61GdvGafQsHL0sBIxfKzA+usWn4GFC/bk+QdwPUD4kWFJLhElipq+0VA==",
-      "dev": true,
-      "dependencies": {
-        "p-locate": "^6.0.0"
-      },
-      "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
-    "node_modules/pkg-dir/node_modules/p-limit": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-4.0.0.tgz",
-      "integrity": "sha512-5b0R4txpzjPWVw/cXXUResoD4hb6U/x9BH08L7nw+GN1sezDzPdxeRvpc9c433fZhBan/wusjbCsqwqm4EIBIQ==",
+      "version": "4.6.1",
+      "resolved": "https://registry.npmjs.org/piscina/-/piscina-4.6.1.tgz",
+      "integrity": "sha512-z30AwWGtQE+Apr+2WBZensP2lIvwoaMcOPkQlIEmSGMJNUvaYACylPYrQM6wSdUNJlnDVMSpLv7xTMJqlVshOA==",
       "dev": true,
-      "dependencies": {
-        "yocto-queue": "^1.0.0"
-      },
-      "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
+      "optionalDependencies": {
+        "nice-napi": "^1.0.2"
       }
     },
-    "node_modules/pkg-dir/node_modules/p-locate": {
-      "version": "6.0.0",
-      "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-6.0.0.tgz",
-      "integrity": "sha512-wPrq66Llhl7/4AGC6I+cqxT07LhXvWL08LNXz1fENOw0Ap4sRZZ/gZpTTJ5jpurzzzfS2W/Ge9BY3LgLjCShcw==",
+    "node_modules/pkg-dir": {
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/pkg-dir/-/pkg-dir-7.0.0.tgz",
+      "integrity": "sha512-Ie9z/WINcxxLp27BKOCHGde4ITq9UklYKDzVo1nhk5sqGEXU3FpkwP5GM2voTGJkGd9B3Otl+Q4uwSOeSUtOBA==",
       "dev": true,
       "dependencies": {
-        "p-limit": "^4.0.0"
+        "find-up": "^6.3.0"
       },
       "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+        "node": ">=14.16"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/pkg-dir/node_modules/path-exists": {
-      "version": "5.0.0",
-      "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-5.0.0.tgz",
-      "integrity": "sha512-RjhtfwJOxzcFmNOi6ltcbcu4Iu+FL3zEj83dk4kAS+fVpTxXLO1b38RvJgT/0QwvV/L3aY9TAnyv0EOqW4GoMQ==",
-      "dev": true,
-      "engines": {
-        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
-      }
-    },
     "node_modules/postcss": {
-      "version": "8.4.35",
-      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.35.tgz",
-      "integrity": "sha512-u5U8qYpBCpN13BsiEB0CbR1Hhh4Gc0zLFuedrHJKMctHCHAGrMdG0PRM/KErzAL3CU6/eckEtmHNB3x6e3c0vA==",
+      "version": "8.4.38",
+      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.4.38.tgz",
+      "integrity": "sha512-Wglpdk03BSfXkHoQa3b/oulrotAkwrlLDRSOb9D0bN86FdRyE9lppSp33aHNPgBa0JKCoB+drFLZkQoRRYae5A==",
       "dev": true,
       "funding": [
         {
@@ -10326,7 +11087,7 @@
       "dependencies": {
         "nanoid": "^3.3.7",
         "picocolors": "^1.0.0",
-        "source-map-js": "^1.0.2"
+        "source-map-js": "^1.2.0"
       },
       "engines": {
         "node": "^10 || ^12 || >=14"
@@ -10429,9 +11190,9 @@
       }
     },
     "node_modules/postcss-selector-parser": {
-      "version": "6.0.16",
-      "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.0.16.tgz",
-      "integrity": "sha512-A0RVJrX+IUkVZbW3ClroRWurercFhieevHB38sr2+l9eUClMqome3LmEmnhlNy+5Mr2EYN6B2Kaw9wYdd+VHiw==",
+      "version": "6.1.1",
+      "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.1.tgz",
+      "integrity": "sha512-b4dlw/9V8A71rLIDsSwVmak9z2DuBUB7CA1/wSdelNEzqsjoSPeADTWNO09lpH49Diy3/JIZ2bSPB1dI3LJCHg==",
       "dev": true,
       "dependencies": {
         "cssesc": "^3.0.0",
@@ -10448,9 +11209,9 @@
       "dev": true
     },
     "node_modules/prettier": {
-      "version": "3.2.5",
-      "resolved": "https://registry.npmjs.org/prettier/-/prettier-3.2.5.tgz",
-      "integrity": "sha512-3/GWa9aOC0YeD7LUfvOG2NiDyhOWRvt1k+rcKhOuYnMY24iiCphgneUfJDyFXd6rZCAnuLBv6UeAULtrhT/F4A==",
+      "version": "3.3.3",
+      "resolved": "https://registry.npmjs.org/prettier/-/prettier-3.3.3.tgz",
+      "integrity": "sha512-i2tDNA0O5IrMO757lfrdQZCc2jPNDVntV0m/+4whiDfWaTKfMNgR7Qz0NAeGz/nRqF4m5/6CLzbP4/liHt12Ew==",
       "dev": true,
       "bin": {
         "prettier": "bin/prettier.cjs"
@@ -10463,9 +11224,9 @@
       }
     },
     "node_modules/proc-log": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/proc-log/-/proc-log-3.0.0.tgz",
-      "integrity": "sha512-++Vn7NS4Xf9NacaU9Xq3URUuqZETPsf8L4j5/ckhaRYsfPeRyzGw+iDjFhV/Jr3uNmTvvddEJFWh5R1gRgUH8A==",
+      "version": "4.2.0",
+      "resolved": "https://registry.npmjs.org/proc-log/-/proc-log-4.2.0.tgz",
+      "integrity": "sha512-g8+OnU/L2v+wyiVK+D5fA34J7EH8jZ8DDlvwhRCMxmMj7UCBvxiO1mGeN+36JXIKF4zevU4kRBd8lVgG9vLelA==",
       "dev": true,
       "engines": {
         "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
@@ -10526,13 +11287,10 @@
       "optional": true
     },
     "node_modules/punycode": {
-      "version": "2.3.1",
-      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
-      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
-      "dev": true,
-      "engines": {
-        "node": ">=6"
-      }
+      "version": "1.4.1",
+      "resolved": "https://registry.npmjs.org/punycode/-/punycode-1.4.1.tgz",
+      "integrity": "sha512-jmYNElW7yvO7TV33CjSmvSiE2yco3bV2czu/OzDKdMNVZQWfxCblURLhf+47syQRBntjfLdd/H0egrzIG+oaFQ==",
+      "dev": true
     },
     "node_modules/qjobs": {
       "version": "1.2.0",
@@ -10611,80 +11369,6 @@
         "node": ">= 0.8"
       }
     },
-    "node_modules/read-package-json": {
-      "version": "7.0.0",
-      "resolved": "https://registry.npmjs.org/read-package-json/-/read-package-json-7.0.0.tgz",
-      "integrity": "sha512-uL4Z10OKV4p6vbdvIXB+OzhInYtIozl/VxUBPgNkBuUi2DeRonnuspmaVAMcrkmfjKGNmRndyQAbE7/AmzGwFg==",
-      "dev": true,
-      "dependencies": {
-        "glob": "^10.2.2",
-        "json-parse-even-better-errors": "^3.0.0",
-        "normalize-package-data": "^6.0.0",
-        "npm-normalize-package-bin": "^3.0.0"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/read-package-json-fast": {
-      "version": "3.0.2",
-      "resolved": "https://registry.npmjs.org/read-package-json-fast/-/read-package-json-fast-3.0.2.tgz",
-      "integrity": "sha512-0J+Msgym3vrLOUB3hzQCuZHII0xkNGCtz/HJH9xZshwv9DbDwkw1KaE3gx/e2J5rpEY5rtOy6cyhKOPrkP7FZw==",
-      "dev": true,
-      "dependencies": {
-        "json-parse-even-better-errors": "^3.0.0",
-        "npm-normalize-package-bin": "^3.0.0"
-      },
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
-    },
-    "node_modules/read-package-json/node_modules/brace-expansion": {
-      "version": "2.0.1",
-      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
-      "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
-      "dev": true,
-      "dependencies": {
-        "balanced-match": "^1.0.0"
-      }
-    },
-    "node_modules/read-package-json/node_modules/glob": {
-      "version": "10.3.12",
-      "resolved": "https://registry.npmjs.org/glob/-/glob-10.3.12.tgz",
-      "integrity": "sha512-TCNv8vJ+xz4QiqTpfOJA7HvYv+tNIRHKfUWw/q+v2jdgN4ebz+KY9tGx5J4rHP0o84mNP+ApH66HRX8us3Khqg==",
-      "dev": true,
-      "dependencies": {
-        "foreground-child": "^3.1.0",
-        "jackspeak": "^2.3.6",
-        "minimatch": "^9.0.1",
-        "minipass": "^7.0.4",
-        "path-scurry": "^1.10.2"
-      },
-      "bin": {
-        "glob": "dist/esm/bin.mjs"
-      },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/isaacs"
-      }
-    },
-    "node_modules/read-package-json/node_modules/minimatch": {
-      "version": "9.0.4",
-      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.4.tgz",
-      "integrity": "sha512-KqWh+VchfxcMNRAJjj2tnsSJdNbHsVgnkBhTNrW7AjVo6OvLtxw8zfT9oLw1JSohlFzJ8jCoTgaoXvJ+kHt6fw==",
-      "dev": true,
-      "dependencies": {
-        "brace-expansion": "^2.0.1"
-      },
-      "engines": {
-        "node": ">=16 || 14 >=14.17"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/isaacs"
-      }
-    },
     "node_modules/readable-stream": {
       "version": "3.6.2",
       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
@@ -10848,12 +11532,12 @@
       }
     },
     "node_modules/resolve-from": {
-      "version": "5.0.0",
-      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-5.0.0.tgz",
-      "integrity": "sha512-qYg9KP24dD5qka9J47d0aVky0N+b4fTU89LN9iDnjB5waksiC49rvMB0PrUJQGoTmH50XPiqOvAjDfaijGxYZw==",
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
+      "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
       "dev": true,
       "engines": {
-        "node": ">=8"
+        "node": ">=4"
       }
     },
     "node_modules/resolve-url-loader": {
@@ -10896,18 +11580,27 @@
       }
     },
     "node_modules/restore-cursor": {
-      "version": "3.1.0",
-      "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-3.1.0.tgz",
-      "integrity": "sha512-l+sSefzHpj5qimhFSE5a8nufZYAM3sBSVMAPtYkmC+4EH2anSGaEMXSD0izRQbu9nfyQ9y5JrVmp7E8oZrUjvA==",
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-4.0.0.tgz",
+      "integrity": "sha512-I9fPXU9geO9bHOt9pHHOhOkYerIMsmVaWB0rA2AI9ERh/+x/i7MV5HKBNrg+ljO5eoPVgCcnFuRjJ9uH6I/3eg==",
       "dev": true,
       "dependencies": {
         "onetime": "^5.1.0",
         "signal-exit": "^3.0.2"
       },
       "engines": {
-        "node": ">=8"
+        "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
+    "node_modules/restore-cursor/node_modules/signal-exit": {
+      "version": "3.0.7",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
+      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
+      "dev": true
+    },
     "node_modules/retry": {
       "version": "0.12.0",
       "resolved": "https://registry.npmjs.org/retry/-/retry-0.12.0.tgz",
@@ -10928,15 +11621,16 @@
       }
     },
     "node_modules/rfdc": {
-      "version": "1.3.1",
-      "resolved": "https://registry.npmjs.org/rfdc/-/rfdc-1.3.1.tgz",
-      "integrity": "sha512-r5a3l5HzYlIC68TpmYKlxWjmOP6wiPJ1vWv2HeLhNsRZMrCkxeqxiHlQ21oXmQ4F3SiryXBHhAD7JZqvOJjFmg==",
+      "version": "1.4.1",
+      "resolved": "https://registry.npmjs.org/rfdc/-/rfdc-1.4.1.tgz",
+      "integrity": "sha512-q1b3N5QkRUWUl7iyylaaj3kOpIT0N2i9MqIEQXP73GVsN9cw3fdx8X63cEmWhJGi2PPCF23Ijp7ktmd39rawIA==",
       "dev": true
     },
     "node_modules/rimraf": {
       "version": "3.0.2",
       "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-3.0.2.tgz",
       "integrity": "sha512-JZkJMZkAGFFPP2YqXZXPbMlMBgsxzE8ILs4lMIX/2o0L9UBw9O/Y3o6wFw/i9YLapcUJWwqbi3kdxIPdC62TIA==",
+      "deprecated": "Rimraf versions prior to v4 are no longer supported",
       "dev": true,
       "dependencies": {
         "glob": "^7.1.3"
@@ -10949,9 +11643,9 @@
       }
     },
     "node_modules/rollup": {
-      "version": "4.16.4",
-      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.16.4.tgz",
-      "integrity": "sha512-kuaTJSUbz+Wsb2ATGvEknkI12XV40vIiHmLuFlejoo7HtDok/O5eDDD0UpCVY5bBX5U5RYo8wWP83H7ZsqVEnA==",
+      "version": "4.18.0",
+      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.18.0.tgz",
+      "integrity": "sha512-QmJz14PX3rzbJCN1SG4Xe/bAAX2a6NpCP8ab2vfu2GiUr8AQcr2nCV/oEO3yneFarB67zk8ShlIyWb2LGTb3Sg==",
       "dev": true,
       "dependencies": {
         "@types/estree": "1.0.5"
@@ -10964,32 +11658,35 @@
         "npm": ">=8.0.0"
       },
       "optionalDependencies": {
-        "@rollup/rollup-android-arm-eabi": "4.16.4",
-        "@rollup/rollup-android-arm64": "4.16.4",
-        "@rollup/rollup-darwin-arm64": "4.16.4",
-        "@rollup/rollup-darwin-x64": "4.16.4",
-        "@rollup/rollup-linux-arm-gnueabihf": "4.16.4",
-        "@rollup/rollup-linux-arm-musleabihf": "4.16.4",
-        "@rollup/rollup-linux-arm64-gnu": "4.16.4",
-        "@rollup/rollup-linux-arm64-musl": "4.16.4",
-        "@rollup/rollup-linux-powerpc64le-gnu": "4.16.4",
-        "@rollup/rollup-linux-riscv64-gnu": "4.16.4",
-        "@rollup/rollup-linux-s390x-gnu": "4.16.4",
-        "@rollup/rollup-linux-x64-gnu": "4.16.4",
-        "@rollup/rollup-linux-x64-musl": "4.16.4",
-        "@rollup/rollup-win32-arm64-msvc": "4.16.4",
-        "@rollup/rollup-win32-ia32-msvc": "4.16.4",
-        "@rollup/rollup-win32-x64-msvc": "4.16.4",
+        "@rollup/rollup-android-arm-eabi": "4.18.0",
+        "@rollup/rollup-android-arm64": "4.18.0",
+        "@rollup/rollup-darwin-arm64": "4.18.0",
+        "@rollup/rollup-darwin-x64": "4.18.0",
+        "@rollup/rollup-linux-arm-gnueabihf": "4.18.0",
+        "@rollup/rollup-linux-arm-musleabihf": "4.18.0",
+        "@rollup/rollup-linux-arm64-gnu": "4.18.0",
+        "@rollup/rollup-linux-arm64-musl": "4.18.0",
+        "@rollup/rollup-linux-powerpc64le-gnu": "4.18.0",
+        "@rollup/rollup-linux-riscv64-gnu": "4.18.0",
+        "@rollup/rollup-linux-s390x-gnu": "4.18.0",
+        "@rollup/rollup-linux-x64-gnu": "4.18.0",
+        "@rollup/rollup-linux-x64-musl": "4.18.0",
+        "@rollup/rollup-win32-arm64-msvc": "4.18.0",
+        "@rollup/rollup-win32-ia32-msvc": "4.18.0",
+        "@rollup/rollup-win32-x64-msvc": "4.18.0",
         "fsevents": "~2.3.2"
       }
     },
-    "node_modules/run-async": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/run-async/-/run-async-3.0.0.tgz",
-      "integrity": "sha512-540WwVDOMxA6dN6We19EcT9sc3hkXPw5mzRNGM3FkdN/vtE9NFvj5lFAPNwUDmJjXidm3v7TC1cTE7t17Ulm1Q==",
+    "node_modules/run-applescript": {
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/run-applescript/-/run-applescript-7.0.0.tgz",
+      "integrity": "sha512-9by4Ij99JUr/MCFBUkDKLWK3G9HVXmabKz9U5MlIAIuvuzkiOicRYs8XJLxX+xahD+mLiiCYDqF9dKAgtzKP1A==",
       "dev": true,
       "engines": {
-        "node": ">=0.12.0"
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/run-parallel": {
@@ -11055,9 +11752,9 @@
       "integrity": "sha512-LRneZZRXNgjzwG4bDQdOTSbze3fHm1EAKN/8bePxnlEZiBmkYEDggaHbuvHI9/hoqHbGfsEA7tWS9GhYHZBBsw=="
     },
     "node_modules/sass": {
-      "version": "1.71.1",
-      "resolved": "https://registry.npmjs.org/sass/-/sass-1.71.1.tgz",
-      "integrity": "sha512-wovtnV2PxzteLlfNzbgm1tFXPLoZILYAMJtvoXXkD7/+1uP41eKkIt1ypWq5/q2uT94qHjXehEYfmjKOvjL9sg==",
+      "version": "1.77.6",
+      "resolved": "https://registry.npmjs.org/sass/-/sass-1.77.6.tgz",
+      "integrity": "sha512-ByXE1oLD79GVq9Ht1PeHWCPMPB8XHpBuz1r85oByKHjZY6qV6rWnQovQzXJXuQ/XyE1Oj3iPk3lo28uzaRA2/Q==",
       "dev": true,
       "dependencies": {
         "chokidar": ">=3.0.0 <4.0.0",
@@ -11072,9 +11769,9 @@
       }
     },
     "node_modules/sass-loader": {
-      "version": "14.1.1",
-      "resolved": "https://registry.npmjs.org/sass-loader/-/sass-loader-14.1.1.tgz",
-      "integrity": "sha512-QX8AasDg75monlybel38BZ49JP5Z+uSKfKwF2rO7S74BywaRmGQMUBw9dtkS+ekyM/QnP+NOrRYq8ABMZ9G8jw==",
+      "version": "14.2.1",
+      "resolved": "https://registry.npmjs.org/sass-loader/-/sass-loader-14.2.1.tgz",
+      "integrity": "sha512-G0VcnMYU18a4N7VoNDegg2OuMjYtxnqzQWARVWCIVSZwJeiL9kg8QMsuIZOplsJgTzZLF6jGxI3AClj8I9nRdQ==",
       "dev": true,
       "dependencies": {
         "neo-async": "^2.6.2"
@@ -11112,9 +11809,9 @@
       }
     },
     "node_modules/sax": {
-      "version": "1.3.0",
-      "resolved": "https://registry.npmjs.org/sax/-/sax-1.3.0.tgz",
-      "integrity": "sha512-0s+oAmw9zLl1V1cS9BtZN7JAd0cW5e0QH4W3LWEK6a4LaLEA2OTpGYWDY+6XasBLtz6wkm3u1xRw95mRuJ59WA==",
+      "version": "1.4.1",
+      "resolved": "https://registry.npmjs.org/sax/-/sax-1.4.1.tgz",
+      "integrity": "sha512-+aWOz7yVScEGoKNd4PA10LZ8sk0A/z5+nXQG5giUO5rprX9jgYsTdov9qCchZiPIZezbZH+jRut8nPodFAX4Jg==",
       "dev": true,
       "optional": true
     },
@@ -11137,6 +11834,23 @@
         "url": "https://opencollective.com/webpack"
       }
     },
+    "node_modules/schema-utils/node_modules/ajv-formats": {
+      "version": "2.1.1",
+      "resolved": "https://registry.npmjs.org/ajv-formats/-/ajv-formats-2.1.1.tgz",
+      "integrity": "sha512-Wx0Kx52hxE7C18hkMEggYlEifqWZtYaRgouJor+WMdPnQyEK13vgEWyVNup7SoeeoLMsr4kf5h6dOW11I15MUA==",
+      "dev": true,
+      "dependencies": {
+        "ajv": "^8.0.0"
+      },
+      "peerDependencies": {
+        "ajv": "^8.0.0"
+      },
+      "peerDependenciesMeta": {
+        "ajv": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/select-hose": {
       "version": "2.0.0",
       "resolved": "https://registry.npmjs.org/select-hose/-/select-hose-2.0.0.tgz",
@@ -11157,13 +11871,10 @@
       }
     },
     "node_modules/semver": {
-      "version": "7.6.0",
-      "resolved": "https://registry.npmjs.org/semver/-/semver-7.6.0.tgz",
-      "integrity": "sha512-EnwXhrlwXMk9gKu5/flx5sv/an57AkRplG3hTK68W7FRDN+k+OWBj65M7719OkA82XLBxrcX0KSHj+X5COhOVg==",
+      "version": "7.6.2",
+      "resolved": "https://registry.npmjs.org/semver/-/semver-7.6.2.tgz",
+      "integrity": "sha512-FNAIBWCx9qcRhoHcgcJ0gvU7SN1lYU2ZXuSfl04bSC5OpvDHFyJCjdNHomPXxjQlCBU67YW64PzY7/VIEH7F2w==",
       "dev": true,
-      "dependencies": {
-        "lru-cache": "^6.0.0"
-      },
       "bin": {
         "semver": "bin/semver.js"
       },
@@ -11171,24 +11882,6 @@
         "node": ">=10"
       }
     },
-    "node_modules/semver/node_modules/lru-cache": {
-      "version": "6.0.0",
-      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-6.0.0.tgz",
-      "integrity": "sha512-Jo6dJ04CmSjuznwJSS3pUeWmd/H0ffTlkXXgwZi+eq1UCmqQwCh+eLsYOYCwY991i2Fah4h1BEMCx4qThGbsiA==",
-      "dev": true,
-      "dependencies": {
-        "yallist": "^4.0.0"
-      },
-      "engines": {
-        "node": ">=10"
-      }
-    },
-    "node_modules/semver/node_modules/yallist": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz",
-      "integrity": "sha512-3wdGidZyq5PB084XLES5TpOSRA3wjXAlIWMhum2kRcv/41Sn2emQ0dycQW4uZXLejwKvg6EsvbdlVL+FYEct7A==",
-      "dev": true
-    },
     "node_modules/send": {
       "version": "0.18.0",
       "resolved": "https://registry.npmjs.org/send/-/send-0.18.0.tgz",
@@ -11432,40 +12125,74 @@
       }
     },
     "node_modules/signal-exit": {
-      "version": "3.0.7",
-      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
-      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
-      "dev": true
+      "version": "4.1.0",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
+      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
+      "dev": true,
+      "engines": {
+        "node": ">=14"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
     },
     "node_modules/sigstore": {
-      "version": "2.3.0",
-      "resolved": "https://registry.npmjs.org/sigstore/-/sigstore-2.3.0.tgz",
-      "integrity": "sha512-q+o8L2ebiWD1AxD17eglf1pFrl9jtW7FHa0ygqY6EKvibK8JHyq9Z26v9MZXeDiw+RbfOJ9j2v70M10Hd6E06A==",
+      "version": "2.3.1",
+      "resolved": "https://registry.npmjs.org/sigstore/-/sigstore-2.3.1.tgz",
+      "integrity": "sha512-8G+/XDU8wNsJOQS5ysDVO0Etg9/2uA5gR9l4ZwijjlwxBcrU6RPfwi2+jJmbP+Ap1Hlp/nVAaEO4Fj22/SL2gQ==",
       "dev": true,
       "dependencies": {
-        "@sigstore/bundle": "^2.3.1",
+        "@sigstore/bundle": "^2.3.2",
         "@sigstore/core": "^1.0.0",
-        "@sigstore/protobuf-specs": "^0.3.1",
-        "@sigstore/sign": "^2.3.0",
-        "@sigstore/tuf": "^2.3.1",
-        "@sigstore/verify": "^1.2.0"
+        "@sigstore/protobuf-specs": "^0.3.2",
+        "@sigstore/sign": "^2.3.2",
+        "@sigstore/tuf": "^2.3.4",
+        "@sigstore/verify": "^1.2.1"
       },
       "engines": {
         "node": "^16.14.0 || >=18.0.0"
       }
     },
     "node_modules/slash": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/slash/-/slash-4.0.0.tgz",
-      "integrity": "sha512-3dOsAHXXUkQTpOYcoAxLIorMTp4gIQr5IW3iVb7A7lFIp0VHhnynm9izx6TssdrIcVIESAlVjtnO2K8bg+Coew==",
+      "version": "5.1.0",
+      "resolved": "https://registry.npmjs.org/slash/-/slash-5.1.0.tgz",
+      "integrity": "sha512-ZA6oR3T/pEyuqwMgAKT0/hAv8oAXckzbkmR0UkUosQ+Mc4RxGoJkRmwHgHufaenlyAgE1Mxgpdcrf75y6XcnDg==",
       "dev": true,
       "engines": {
-        "node": ">=12"
+        "node": ">=14.16"
       },
       "funding": {
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
+    "node_modules/slice-ansi": {
+      "version": "5.0.0",
+      "resolved": "https://registry.npmjs.org/slice-ansi/-/slice-ansi-5.0.0.tgz",
+      "integrity": "sha512-FC+lgizVPfie0kkhqUScwRu1O/lF6NOgJmlCgK+/LYxDCTk8sGelYaHDhFcDN+Sn3Cv+3VSa4Byeo+IMCzpMgQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-styles": "^6.0.0",
+        "is-fullwidth-code-point": "^4.0.0"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/slice-ansi?sponsor=1"
+      }
+    },
+    "node_modules/slice-ansi/node_modules/ansi-styles": {
+      "version": "6.2.1",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
+      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
     "node_modules/smart-buffer": {
       "version": "4.2.0",
       "resolved": "https://registry.npmjs.org/smart-buffer/-/smart-buffer-4.2.0.tgz",
@@ -11495,13 +12222,13 @@
       }
     },
     "node_modules/socket.io-adapter": {
-      "version": "2.5.4",
-      "resolved": "https://registry.npmjs.org/socket.io-adapter/-/socket.io-adapter-2.5.4.tgz",
-      "integrity": "sha512-wDNHGXGewWAjQPt3pyeYBtpWSq9cLE5UW1ZUPL/2eGK9jtse/FpXib7epSTsz0Q0m+6sg6Y4KtcFTlah1bdOVg==",
+      "version": "2.5.5",
+      "resolved": "https://registry.npmjs.org/socket.io-adapter/-/socket.io-adapter-2.5.5.tgz",
+      "integrity": "sha512-eLDQas5dzPgOWCk9GuuJC2lBqItuhKI4uxGgo9aIV7MYbk2h9Q6uULEh8WBzThoI7l+qU9Ast9fVUmkqPP9wYg==",
       "dev": true,
       "dependencies": {
         "debug": "~4.3.4",
-        "ws": "~8.11.0"
+        "ws": "~8.17.1"
       }
     },
     "node_modules/socket.io-parser": {
@@ -11543,14 +12270,14 @@
       }
     },
     "node_modules/socks-proxy-agent": {
-      "version": "8.0.3",
-      "resolved": "https://registry.npmjs.org/socks-proxy-agent/-/socks-proxy-agent-8.0.3.tgz",
-      "integrity": "sha512-VNegTZKhuGq5vSD6XNKlbqWhyt/40CgoEw8XxD6dhnm8Jq9IEa3nIa4HwnM8XOqU0CdB0BwWVXusqiFXfHB3+A==",
+      "version": "8.0.4",
+      "resolved": "https://registry.npmjs.org/socks-proxy-agent/-/socks-proxy-agent-8.0.4.tgz",
+      "integrity": "sha512-GNAq/eg8Udq2x0eNiFkr9gRg5bA7PXEWagQdeRX4cPSG+X/8V38v637gim9bjFptMk1QWsCTr0ttrJEiXbNnRw==",
       "dev": true,
       "dependencies": {
         "agent-base": "^7.1.1",
         "debug": "^4.3.4",
-        "socks": "^2.7.1"
+        "socks": "^2.8.3"
       },
       "engines": {
         "node": ">= 14"
@@ -11652,9 +12379,9 @@
       }
     },
     "node_modules/spdx-license-ids": {
-      "version": "3.0.17",
-      "resolved": "https://registry.npmjs.org/spdx-license-ids/-/spdx-license-ids-3.0.17.tgz",
-      "integrity": "sha512-sh8PWc/ftMqAAdFiBu6Fy6JUOYjqDJBJvIhpfDMyHrr0Rbp5liZqd4TjtQ/RgfLjKFZb+LMx5hpml5qOWy0qvg==",
+      "version": "3.0.18",
+      "resolved": "https://registry.npmjs.org/spdx-license-ids/-/spdx-license-ids-3.0.18.tgz",
+      "integrity": "sha512-xxRs31BqRYHwiMzudOrpSiHtZ8i/GeionCBDSilhYRj+9gIcI8wCZTlXZKu9vZIVqViP3dcp9qE5G6AlIaD+TQ==",
       "dev": true
     },
     "node_modules/spdy": {
@@ -11688,15 +12415,15 @@
       }
     },
     "node_modules/sprintf-js": {
-      "version": "1.0.3",
-      "resolved": "https://registry.npmjs.org/sprintf-js/-/sprintf-js-1.0.3.tgz",
-      "integrity": "sha512-D9cPgkvLlV3t3IzL0D0YLvGA9Ahk4PcvVwUbN0dSGr1aP0Nrt4AEnTUbuGvquEC0mA64Gqt1fzirlRs5ibXx8g==",
+      "version": "1.1.3",
+      "resolved": "https://registry.npmjs.org/sprintf-js/-/sprintf-js-1.1.3.tgz",
+      "integrity": "sha512-Oo+0REFV59/rz3gfJNKQiBlwfHaSESl1pcGyABQsnnIfWOFt6JNj5gCog2U6MLZ//IGYD+nA8nI+mTShREReaA==",
       "dev": true
     },
     "node_modules/ssri": {
-      "version": "10.0.5",
-      "resolved": "https://registry.npmjs.org/ssri/-/ssri-10.0.5.tgz",
-      "integrity": "sha512-bSf16tAFkGeRlUNDjXu8FzaMQt6g2HZJrun7mtMbIPOddxt3GLMSz5VWUWcqTJUPfLEaDIepGxv+bYQW49596A==",
+      "version": "10.0.6",
+      "resolved": "https://registry.npmjs.org/ssri/-/ssri-10.0.6.tgz",
+      "integrity": "sha512-MGrFH9Z4NP9Iyhqn16sDtBpRRNJ0Y2hNa6D65h736fVSaPCHr4DM4sWUNvVaSuC+0OBGhwsrydQwmgfg5LncqQ==",
       "dev": true,
       "dependencies": {
         "minipass": "^7.0.3"
@@ -11738,17 +12465,20 @@
       }
     },
     "node_modules/string-width": {
-      "version": "4.2.3",
-      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
-      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "version": "7.2.0",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-7.2.0.tgz",
+      "integrity": "sha512-tsaTIkKW9b4N+AEj+SVA+WhJzV7/zMhcSu78mLKWSk7cXMOSHsBKFWUs0fWwq8QyK3MgJBQRX6Gbi4kYbdvGkQ==",
       "dev": true,
       "dependencies": {
-        "emoji-regex": "^8.0.0",
-        "is-fullwidth-code-point": "^3.0.0",
-        "strip-ansi": "^6.0.1"
+        "emoji-regex": "^10.3.0",
+        "get-east-asian-width": "^1.0.0",
+        "strip-ansi": "^7.1.0"
       },
       "engines": {
-        "node": ">=8"
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
     "node_modules/string-width-cjs": {
@@ -11766,6 +12496,48 @@
         "node": ">=8"
       }
     },
+    "node_modules/string-width-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/string-width-cjs/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/string-width/node_modules/ansi-regex": {
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.0.1.tgz",
+      "integrity": "sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==",
+      "dev": true,
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/string-width/node_modules/strip-ansi": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
+      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
+      "dev": true,
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
     "node_modules/strip-ansi": {
       "version": "6.0.1",
       "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
@@ -11911,9 +12683,9 @@
       "dev": true
     },
     "node_modules/terser": {
-      "version": "5.29.1",
-      "resolved": "https://registry.npmjs.org/terser/-/terser-5.29.1.tgz",
-      "integrity": "sha512-lZQ/fyaIGxsbGxApKmoPTODIzELy3++mXhS5hOqaAWZjQtpq/hFHAc+rm29NND1rYRxRWKcjuARNwULNXa5RtQ==",
+      "version": "5.29.2",
+      "resolved": "https://registry.npmjs.org/terser/-/terser-5.29.2.tgz",
+      "integrity": "sha512-ZiGkhUBIM+7LwkNjXYJq8svgkd+QK3UUr0wJqY4MieaezBSAIPgbSPZyIx0idM6XWK5CMzSWa8MJIzmRcB8Caw==",
       "dev": true,
       "dependencies": {
         "@jridgewell/source-map": "^0.3.3",
@@ -11973,851 +12745,477 @@
         "json-schema-traverse": "^0.4.1",
         "uri-js": "^4.2.2"
       },
-      "funding": {
-        "type": "github",
-        "url": "https://github.com/sponsors/epoberezkin"
-      }
-    },
-    "node_modules/terser-webpack-plugin/node_modules/ajv-keywords": {
-      "version": "3.5.2",
-      "resolved": "https://registry.npmjs.org/ajv-keywords/-/ajv-keywords-3.5.2.tgz",
-      "integrity": "sha512-5p6WTN0DdTGVQk6VjcEju19IgaHudalcfabD7yhDGeA6bcQnmL+CpveLJq/3hvfwd1aof6L386Ougkx6RfyMIQ==",
-      "dev": true,
-      "peerDependencies": {
-        "ajv": "^6.9.1"
-      }
-    },
-    "node_modules/terser-webpack-plugin/node_modules/json-schema-traverse": {
-      "version": "0.4.1",
-      "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
-      "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
-      "dev": true
-    },
-    "node_modules/terser-webpack-plugin/node_modules/schema-utils": {
-      "version": "3.3.0",
-      "resolved": "https://registry.npmjs.org/schema-utils/-/schema-utils-3.3.0.tgz",
-      "integrity": "sha512-pN/yOAvcC+5rQ5nERGuwrjLlYvLTbCibnZ1I7B1LaiAz9BRBlE9GMgE/eqV30P7aJQUf7Ddimy/RsbYO/GrVGg==",
-      "dev": true,
-      "dependencies": {
-        "@types/json-schema": "^7.0.8",
-        "ajv": "^6.12.5",
-        "ajv-keywords": "^3.5.2"
-      },
-      "engines": {
-        "node": ">= 10.13.0"
-      },
-      "funding": {
-        "type": "opencollective",
-        "url": "https://opencollective.com/webpack"
-      }
-    },
-    "node_modules/test-exclude": {
-      "version": "6.0.0",
-      "resolved": "https://registry.npmjs.org/test-exclude/-/test-exclude-6.0.0.tgz",
-      "integrity": "sha512-cAGWPIyOHU6zlmg88jwm7VRyXnMN7iV68OGAbYDk/Mh/xC/pzVPlQtY6ngoIH/5/tciuhGfvESU8GrHrcxD56w==",
-      "dev": true,
-      "dependencies": {
-        "@istanbuljs/schema": "^0.1.2",
-        "glob": "^7.1.4",
-        "minimatch": "^3.0.4"
-      },
-      "engines": {
-        "node": ">=8"
-      }
-    },
-    "node_modules/thunky": {
-      "version": "1.1.0",
-      "resolved": "https://registry.npmjs.org/thunky/-/thunky-1.1.0.tgz",
-      "integrity": "sha512-eHY7nBftgThBqOyHGVN+l8gF0BucP09fMo0oO/Lb0w1OF80dJv+lDVpXG60WMQvkcxAkNybKsrEIE3ZtKGmPrA==",
-      "dev": true
-    },
-    "node_modules/tmp": {
-      "version": "0.0.33",
-      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.0.33.tgz",
-      "integrity": "sha512-jRCJlojKnZ3addtTOjdIqoRuPEKBvNXcGYqzO6zWZX8KfKEpnGY5jfggJQ3EjKuu8D4bJRr0y+cYJFmYbImXGw==",
-      "dev": true,
-      "dependencies": {
-        "os-tmpdir": "~1.0.2"
-      },
-      "engines": {
-        "node": ">=0.6.0"
-      }
-    },
-    "node_modules/to-fast-properties": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
-      "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
-      "dev": true,
-      "engines": {
-        "node": ">=4"
-      }
-    },
-    "node_modules/to-regex-range": {
-      "version": "5.0.1",
-      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
-      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
-      "dev": true,
-      "dependencies": {
-        "is-number": "^7.0.0"
-      },
-      "engines": {
-        "node": ">=8.0"
-      }
-    },
-    "node_modules/toidentifier": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
-      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
-      "dev": true,
-      "engines": {
-        "node": ">=0.6"
-      }
-    },
-    "node_modules/tree-kill": {
-      "version": "1.2.2",
-      "resolved": "https://registry.npmjs.org/tree-kill/-/tree-kill-1.2.2.tgz",
-      "integrity": "sha512-L0Orpi8qGpRG//Nd+H90vFB+3iHnue1zSSGmNOOCh1GLJ7rUKVwV2HvijphGQS2UmhUZewS9VgvxYIdgr+fG1A==",
-      "dev": true,
-      "bin": {
-        "tree-kill": "cli.js"
-      }
-    },
-    "node_modules/tslib": {
-      "version": "2.6.2",
-      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.6.2.tgz",
-      "integrity": "sha512-AEYxH93jGFPn/a2iVAwW87VuUIkR1FVUKB77NwMF7nBTDkDrrT/Hpt/IrCJ0QXhW27jTBDcf5ZY7w6RiqTMw2Q=="
-    },
-    "node_modules/tuf-js": {
-      "version": "2.2.0",
-      "resolved": "https://registry.npmjs.org/tuf-js/-/tuf-js-2.2.0.tgz",
-      "integrity": "sha512-ZSDngmP1z6zw+FIkIBjvOp/II/mIub/O7Pp12j1WNsiCpg5R5wAc//i555bBQsE44O94btLt0xM/Zr2LQjwdCg==",
-      "dev": true,
-      "dependencies": {
-        "@tufjs/models": "2.0.0",
-        "debug": "^4.3.4",
-        "make-fetch-happen": "^13.0.0"
-      },
-      "engines": {
-        "node": "^16.14.0 || >=18.0.0"
-      }
-    },
-    "node_modules/type-fest": {
-      "version": "0.21.3",
-      "resolved": "https://registry.npmjs.org/type-fest/-/type-fest-0.21.3.tgz",
-      "integrity": "sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==",
-      "dev": true,
-      "engines": {
-        "node": ">=10"
-      },
-      "funding": {
-        "url": "https://github.com/sponsors/sindresorhus"
-      }
-    },
-    "node_modules/type-is": {
-      "version": "1.6.18",
-      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
-      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
-      "dev": true,
-      "dependencies": {
-        "media-typer": "0.3.0",
-        "mime-types": "~2.1.24"
-      },
-      "engines": {
-        "node": ">= 0.6"
-      }
-    },
-    "node_modules/typed-assert": {
-      "version": "1.0.9",
-      "resolved": "https://registry.npmjs.org/typed-assert/-/typed-assert-1.0.9.tgz",
-      "integrity": "sha512-KNNZtayBCtmnNmbo5mG47p1XsCyrx6iVqomjcZnec/1Y5GGARaxPs6r49RnSPeUP3YjNYiU9sQHAtY4BBvnZwg==",
-      "dev": true
-    },
-    "node_modules/typescript": {
-      "version": "5.4.5",
-      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.4.5.tgz",
-      "integrity": "sha512-vcI4UpRgg81oIRUFwR0WSIHKt11nJ7SAVlYNIu+QpqeyXP+gpQJy/Z4+F0aGxSE4MqwjyXvW/TzgkLAx2AGHwQ==",
-      "dev": true,
-      "bin": {
-        "tsc": "bin/tsc",
-        "tsserver": "bin/tsserver"
-      },
-      "engines": {
-        "node": ">=14.17"
-      }
-    },
-    "node_modules/ua-parser-js": {
-      "version": "0.7.37",
-      "resolved": "https://registry.npmjs.org/ua-parser-js/-/ua-parser-js-0.7.37.tgz",
-      "integrity": "sha512-xV8kqRKM+jhMvcHWUKthV9fNebIzrNy//2O9ZwWcfiBFR5f25XVZPLlEajk/sf3Ra15V92isyQqnIEXRDaZWEA==",
-      "dev": true,
-      "funding": [
-        {
-          "type": "opencollective",
-          "url": "https://opencollective.com/ua-parser-js"
-        },
-        {
-          "type": "paypal",
-          "url": "https://paypal.me/faisalman"
-        },
-        {
-          "type": "github",
-          "url": "https://github.com/sponsors/faisalman"
-        }
-      ],
-      "engines": {
-        "node": "*"
-      }
-    },
-    "node_modules/undici": {
-      "version": "6.11.1",
-      "resolved": "https://registry.npmjs.org/undici/-/undici-6.11.1.tgz",
-      "integrity": "sha512-KyhzaLJnV1qa3BSHdj4AZ2ndqI0QWPxYzaIOio0WzcEJB9gvuysprJSLtpvc2D9mhR9jPDUk7xlJlZbH2KR5iw==",
-      "dev": true,
-      "engines": {
-        "node": ">=18.0"
-      }
-    },
-    "node_modules/undici-types": {
-      "version": "5.26.5",
-      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-5.26.5.tgz",
-      "integrity": "sha512-JlCMO+ehdEIKqlFxk6IfVoAUVmgz7cU7zD/h9XZ0qzeosSHmUJVOzSQvvYSYWXkFXC+IfLKSIffhv0sVZup6pA==",
-      "dev": true
-    },
-    "node_modules/unicode-canonical-property-names-ecmascript": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/unicode-canonical-property-names-ecmascript/-/unicode-canonical-property-names-ecmascript-2.0.0.tgz",
-      "integrity": "sha512-yY5PpDlfVIU5+y/BSCxAJRBIS1Zc2dDG3Ujq+sR0U+JjUevW2JhocOF+soROYDSaAezOzOKuyyixhD6mBknSmQ==",
-      "dev": true,
-      "engines": {
-        "node": ">=4"
-      }
-    },
-    "node_modules/unicode-match-property-ecmascript": {
-      "version": "2.0.0",
-      "resolved": "https://registry.npmjs.org/unicode-match-property-ecmascript/-/unicode-match-property-ecmascript-2.0.0.tgz",
-      "integrity": "sha512-5kaZCrbp5mmbz5ulBkDkbY0SsPOjKqVS35VpL9ulMPfSl0J0Xsm+9Evphv9CoIZFwre7aJoa94AY6seMKGVN5Q==",
-      "dev": true,
-      "dependencies": {
-        "unicode-canonical-property-names-ecmascript": "^2.0.0",
-        "unicode-property-aliases-ecmascript": "^2.0.0"
-      },
-      "engines": {
-        "node": ">=4"
-      }
-    },
-    "node_modules/unicode-match-property-value-ecmascript": {
-      "version": "2.1.0",
-      "resolved": "https://registry.npmjs.org/unicode-match-property-value-ecmascript/-/unicode-match-property-value-ecmascript-2.1.0.tgz",
-      "integrity": "sha512-qxkjQt6qjg/mYscYMC0XKRn3Rh0wFPlfxB0xkt9CfyTvpX1Ra0+rAmdX2QyAobptSEvuy4RtpPRui6XkV+8wjA==",
-      "dev": true,
-      "engines": {
-        "node": ">=4"
-      }
-    },
-    "node_modules/unicode-property-aliases-ecmascript": {
-      "version": "2.1.0",
-      "resolved": "https://registry.npmjs.org/unicode-property-aliases-ecmascript/-/unicode-property-aliases-ecmascript-2.1.0.tgz",
-      "integrity": "sha512-6t3foTQI9qne+OZoVQB/8x8rk2k1eVy1gRXhV3oFQ5T6R1dqQ1xtin3XqSlx3+ATBkliTaR/hHyJBm+LVPNM8w==",
-      "dev": true,
-      "engines": {
-        "node": ">=4"
-      }
-    },
-    "node_modules/unique-filename": {
-      "version": "3.0.0",
-      "resolved": "https://registry.npmjs.org/unique-filename/-/unique-filename-3.0.0.tgz",
-      "integrity": "sha512-afXhuC55wkAmZ0P18QsVE6kp8JaxrEokN2HGIoIVv2ijHQd419H0+6EigAFcIzXeMIkcIkNBpB3L/DXB3cTS/g==",
-      "dev": true,
-      "dependencies": {
-        "unique-slug": "^4.0.0"
-      },
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
-      }
-    },
-    "node_modules/unique-slug": {
-      "version": "4.0.0",
-      "resolved": "https://registry.npmjs.org/unique-slug/-/unique-slug-4.0.0.tgz",
-      "integrity": "sha512-WrcA6AyEfqDX5bWige/4NQfPZMtASNVxdmWR76WESYQVAACSgWcR6e9i0mofqqBxYFtL4oAxPIptY73/0YE1DQ==",
-      "dev": true,
-      "dependencies": {
-        "imurmurhash": "^0.1.4"
-      },
-      "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+      "funding": {
+        "type": "github",
+        "url": "https://github.com/sponsors/epoberezkin"
       }
     },
-    "node_modules/universalify": {
-      "version": "0.1.2",
-      "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.1.2.tgz",
-      "integrity": "sha512-rBJeI5CXAlmy1pV+617WB9J63U6XcazHHF2f2dbJix4XzpUF0RS3Zbj0FGIOCAva5P/d/GBOYaACQ1w+0azUkg==",
+    "node_modules/terser-webpack-plugin/node_modules/ajv-keywords": {
+      "version": "3.5.2",
+      "resolved": "https://registry.npmjs.org/ajv-keywords/-/ajv-keywords-3.5.2.tgz",
+      "integrity": "sha512-5p6WTN0DdTGVQk6VjcEju19IgaHudalcfabD7yhDGeA6bcQnmL+CpveLJq/3hvfwd1aof6L386Ougkx6RfyMIQ==",
       "dev": true,
-      "engines": {
-        "node": ">= 4.0.0"
+      "peerDependencies": {
+        "ajv": "^6.9.1"
       }
     },
-    "node_modules/unpipe": {
-      "version": "1.0.0",
-      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
-      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
-      "dev": true,
-      "engines": {
-        "node": ">= 0.8"
-      }
+    "node_modules/terser-webpack-plugin/node_modules/json-schema-traverse": {
+      "version": "0.4.1",
+      "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
+      "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
+      "dev": true
     },
-    "node_modules/update-browserslist-db": {
-      "version": "1.0.13",
-      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.0.13.tgz",
-      "integrity": "sha512-xebP81SNcPuNpPP3uzeW1NYXxI3rxyJzF3pD6sH4jE7o/IX+WtSpwnVU+qIsDPyk0d3hmFQ7mjqc6AtV604hbg==",
+    "node_modules/terser-webpack-plugin/node_modules/schema-utils": {
+      "version": "3.3.0",
+      "resolved": "https://registry.npmjs.org/schema-utils/-/schema-utils-3.3.0.tgz",
+      "integrity": "sha512-pN/yOAvcC+5rQ5nERGuwrjLlYvLTbCibnZ1I7B1LaiAz9BRBlE9GMgE/eqV30P7aJQUf7Ddimy/RsbYO/GrVGg==",
       "dev": true,
-      "funding": [
-        {
-          "type": "opencollective",
-          "url": "https://opencollective.com/browserslist"
-        },
-        {
-          "type": "tidelift",
-          "url": "https://tidelift.com/funding/github/npm/browserslist"
-        },
-        {
-          "type": "github",
-          "url": "https://github.com/sponsors/ai"
-        }
-      ],
       "dependencies": {
-        "escalade": "^3.1.1",
-        "picocolors": "^1.0.0"
+        "@types/json-schema": "^7.0.8",
+        "ajv": "^6.12.5",
+        "ajv-keywords": "^3.5.2"
       },
-      "bin": {
-        "update-browserslist-db": "cli.js"
+      "engines": {
+        "node": ">= 10.13.0"
       },
-      "peerDependencies": {
-        "browserslist": ">= 4.21.0"
+      "funding": {
+        "type": "opencollective",
+        "url": "https://opencollective.com/webpack"
       }
     },
-    "node_modules/uri-js": {
-      "version": "4.4.1",
-      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
-      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
+    "node_modules/thingies": {
+      "version": "1.21.0",
+      "resolved": "https://registry.npmjs.org/thingies/-/thingies-1.21.0.tgz",
+      "integrity": "sha512-hsqsJsFMsV+aD4s3CWKk85ep/3I9XzYV/IXaSouJMYIoDlgyi11cBhsqYe9/geRfB0YIikBQg6raRaM+nIMP9g==",
       "dev": true,
-      "dependencies": {
-        "punycode": "^2.1.0"
+      "engines": {
+        "node": ">=10.18"
+      },
+      "peerDependencies": {
+        "tslib": "^2"
       }
     },
-    "node_modules/util-deprecate": {
-      "version": "1.0.2",
-      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
-      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
+    "node_modules/thunky": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/thunky/-/thunky-1.1.0.tgz",
+      "integrity": "sha512-eHY7nBftgThBqOyHGVN+l8gF0BucP09fMo0oO/Lb0w1OF80dJv+lDVpXG60WMQvkcxAkNybKsrEIE3ZtKGmPrA==",
       "dev": true
     },
-    "node_modules/utils-merge": {
-      "version": "1.0.1",
-      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
-      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
+    "node_modules/tmp": {
+      "version": "0.0.33",
+      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.0.33.tgz",
+      "integrity": "sha512-jRCJlojKnZ3addtTOjdIqoRuPEKBvNXcGYqzO6zWZX8KfKEpnGY5jfggJQ3EjKuu8D4bJRr0y+cYJFmYbImXGw==",
       "dev": true,
+      "dependencies": {
+        "os-tmpdir": "~1.0.2"
+      },
       "engines": {
-        "node": ">= 0.4.0"
-      }
-    },
-    "node_modules/uuid": {
-      "version": "8.3.2",
-      "resolved": "https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz",
-      "integrity": "sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==",
-      "dev": true,
-      "bin": {
-        "uuid": "dist/bin/uuid"
+        "node": ">=0.6.0"
       }
     },
-    "node_modules/validate-npm-package-license": {
-      "version": "3.0.4",
-      "resolved": "https://registry.npmjs.org/validate-npm-package-license/-/validate-npm-package-license-3.0.4.tgz",
-      "integrity": "sha512-DpKm2Ui/xN7/HQKCtpZxoRWBhZ9Z0kqtygG8XCgNQ8ZlDnxuQmWhj566j8fN4Cu3/JmbhsDo7fcAJq4s9h27Ew==",
+    "node_modules/to-fast-properties": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
+      "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
       "dev": true,
-      "dependencies": {
-        "spdx-correct": "^3.0.0",
-        "spdx-expression-parse": "^3.0.0"
+      "engines": {
+        "node": ">=4"
       }
     },
-    "node_modules/validate-npm-package-name": {
-      "version": "5.0.0",
-      "resolved": "https://registry.npmjs.org/validate-npm-package-name/-/validate-npm-package-name-5.0.0.tgz",
-      "integrity": "sha512-YuKoXDAhBYxY7SfOKxHBDoSyENFeW5VvIIQp2TGQuit8gpK6MnWaQelBKxso72DoxTZfZdcP3W90LqpSkgPzLQ==",
+    "node_modules/to-regex-range": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
+      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
       "dev": true,
       "dependencies": {
-        "builtins": "^5.0.0"
+        "is-number": "^7.0.0"
       },
       "engines": {
-        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
+        "node": ">=8.0"
       }
     },
-    "node_modules/vary": {
-      "version": "1.1.2",
-      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
-      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
+    "node_modules/toidentifier": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
+      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
       "dev": true,
       "engines": {
-        "node": ">= 0.8"
+        "node": ">=0.6"
       }
     },
-    "node_modules/vite": {
-      "version": "5.1.7",
-      "resolved": "https://registry.npmjs.org/vite/-/vite-5.1.7.tgz",
-      "integrity": "sha512-sgnEEFTZYMui/sTlH1/XEnVNHMujOahPLGMxn1+5sIT45Xjng1Ec1K78jRP15dSmVgg5WBin9yO81j3o9OxofA==",
+    "node_modules/tree-dump": {
+      "version": "1.0.2",
+      "resolved": "https://registry.npmjs.org/tree-dump/-/tree-dump-1.0.2.tgz",
+      "integrity": "sha512-dpev9ABuLWdEubk+cIaI9cHwRNNDjkBBLXTwI4UCUFdQ5xXKqNXoK4FEciw/vxf+NQ7Cb7sGUyeUtORvHIdRXQ==",
       "dev": true,
-      "dependencies": {
-        "esbuild": "^0.19.3",
-        "postcss": "^8.4.35",
-        "rollup": "^4.2.0"
-      },
-      "bin": {
-        "vite": "bin/vite.js"
-      },
       "engines": {
-        "node": "^18.0.0 || >=20.0.0"
+        "node": ">=10.0"
       },
       "funding": {
-        "url": "https://github.com/vitejs/vite?sponsor=1"
-      },
-      "optionalDependencies": {
-        "fsevents": "~2.3.3"
+        "type": "github",
+        "url": "https://github.com/sponsors/streamich"
       },
       "peerDependencies": {
-        "@types/node": "^18.0.0 || >=20.0.0",
-        "less": "*",
-        "lightningcss": "^1.21.0",
-        "sass": "*",
-        "stylus": "*",
-        "sugarss": "*",
-        "terser": "^5.4.0"
-      },
-      "peerDependenciesMeta": {
-        "@types/node": {
-          "optional": true
-        },
-        "less": {
-          "optional": true
-        },
-        "lightningcss": {
-          "optional": true
-        },
-        "sass": {
-          "optional": true
-        },
-        "stylus": {
-          "optional": true
-        },
-        "sugarss": {
-          "optional": true
-        },
-        "terser": {
-          "optional": true
-        }
+        "tslib": "2"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/aix-ppc64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.19.12.tgz",
-      "integrity": "sha512-bmoCYyWdEL3wDQIVbcyzRyeKLgk2WtWLTWz1ZIAZF/EGbNOwSA6ew3PftJ1PqMiOOGu0OyFMzG53L0zqIpPeNA==",
-      "cpu": [
-        "ppc64"
-      ],
+    "node_modules/tree-kill": {
+      "version": "1.2.2",
+      "resolved": "https://registry.npmjs.org/tree-kill/-/tree-kill-1.2.2.tgz",
+      "integrity": "sha512-L0Orpi8qGpRG//Nd+H90vFB+3iHnue1zSSGmNOOCh1GLJ7rUKVwV2HvijphGQS2UmhUZewS9VgvxYIdgr+fG1A==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "aix"
-      ],
+      "bin": {
+        "tree-kill": "cli.js"
+      }
+    },
+    "node_modules/tslib": {
+      "version": "2.6.3",
+      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.6.3.tgz",
+      "integrity": "sha512-xNvxJEOUiWPGhUuUdQgAJPKOOJfGnIyKySOc09XkKsgdUV/3E2zvwZYdejjmRgPCgcym1juLH3226yA7sEFJKQ=="
+    },
+    "node_modules/tuf-js": {
+      "version": "2.2.1",
+      "resolved": "https://registry.npmjs.org/tuf-js/-/tuf-js-2.2.1.tgz",
+      "integrity": "sha512-GwIJau9XaA8nLVbUXsN3IlFi7WmQ48gBUrl3FTkkL/XLu/POhBzfmX9hd33FNMX1qAsfl6ozO1iMmW9NC8YniA==",
+      "dev": true,
+      "dependencies": {
+        "@tufjs/models": "2.0.1",
+        "debug": "^4.3.4",
+        "make-fetch-happen": "^13.0.1"
+      },
       "engines": {
-        "node": ">=12"
+        "node": "^16.14.0 || >=18.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/android-arm": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.19.12.tgz",
-      "integrity": "sha512-qg/Lj1mu3CdQlDEEiWrlC4eaPZ1KztwGJ9B6J+/6G+/4ewxJg7gqj8eVYWvao1bXrqGiW2rsBZFSX3q2lcW05w==",
-      "cpu": [
-        "arm"
-      ],
+    "node_modules/type-fest": {
+      "version": "0.21.3",
+      "resolved": "https://registry.npmjs.org/type-fest/-/type-fest-0.21.3.tgz",
+      "integrity": "sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "android"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/android-arm64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.19.12.tgz",
-      "integrity": "sha512-P0UVNGIienjZv3f5zq0DP3Nt2IE/3plFzuaS96vihvD0Hd6H/q4WXUGpCxD/E8YrSXfNyRPbpTq+T8ZQioSuPA==",
-      "cpu": [
-        "arm64"
-      ],
+    "node_modules/type-is": {
+      "version": "1.6.18",
+      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
+      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "android"
-      ],
+      "dependencies": {
+        "media-typer": "0.3.0",
+        "mime-types": "~2.1.24"
+      },
       "engines": {
-        "node": ">=12"
+        "node": ">= 0.6"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/android-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.19.12.tgz",
-      "integrity": "sha512-3k7ZoUW6Q6YqhdhIaq/WZ7HwBpnFBlW905Fa4s4qWJyiNOgT1dOqDiVAQFwBH7gBRZr17gLrlFCRzF6jFh7Kew==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/typed-assert": {
+      "version": "1.0.9",
+      "resolved": "https://registry.npmjs.org/typed-assert/-/typed-assert-1.0.9.tgz",
+      "integrity": "sha512-KNNZtayBCtmnNmbo5mG47p1XsCyrx6iVqomjcZnec/1Y5GGARaxPs6r49RnSPeUP3YjNYiU9sQHAtY4BBvnZwg==",
+      "dev": true
+    },
+    "node_modules/typescript": {
+      "version": "5.4.5",
+      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.4.5.tgz",
+      "integrity": "sha512-vcI4UpRgg81oIRUFwR0WSIHKt11nJ7SAVlYNIu+QpqeyXP+gpQJy/Z4+F0aGxSE4MqwjyXvW/TzgkLAx2AGHwQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "android"
-      ],
+      "bin": {
+        "tsc": "bin/tsc",
+        "tsserver": "bin/tsserver"
+      },
       "engines": {
-        "node": ">=12"
+        "node": ">=14.17"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/darwin-arm64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.19.12.tgz",
-      "integrity": "sha512-B6IeSgZgtEzGC42jsI+YYu9Z3HKRxp8ZT3cqhvliEHovq8HSX2YX8lNocDn79gCKJXOSaEot9MVYky7AKjCs8g==",
-      "cpu": [
-        "arm64"
-      ],
+    "node_modules/ua-parser-js": {
+      "version": "0.7.38",
+      "resolved": "https://registry.npmjs.org/ua-parser-js/-/ua-parser-js-0.7.38.tgz",
+      "integrity": "sha512-fYmIy7fKTSFAhG3fuPlubeGaMoAd6r0rSnfEsO5nEY55i26KSLt9EH7PLQiiqPUhNqYIJvSkTy1oArIcXAbPbA==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "darwin"
+      "funding": [
+        {
+          "type": "opencollective",
+          "url": "https://opencollective.com/ua-parser-js"
+        },
+        {
+          "type": "paypal",
+          "url": "https://paypal.me/faisalman"
+        },
+        {
+          "type": "github",
+          "url": "https://github.com/sponsors/faisalman"
+        }
       ],
       "engines": {
-        "node": ">=12"
+        "node": "*"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/darwin-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.19.12.tgz",
-      "integrity": "sha512-hKoVkKzFiToTgn+41qGhsUJXFlIjxI/jSYeZf3ugemDYZldIXIxhvwN6erJGlX4t5h417iFuheZ7l+YVn05N3A==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/undici": {
+      "version": "6.19.2",
+      "resolved": "https://registry.npmjs.org/undici/-/undici-6.19.2.tgz",
+      "integrity": "sha512-JfjKqIauur3Q6biAtHJ564e3bWa8VvT+7cSiOJHFbX4Erv6CLGDpg8z+Fmg/1OI/47RA+GI2QZaF48SSaLvyBA==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "darwin"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18.17"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/freebsd-arm64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.19.12.tgz",
-      "integrity": "sha512-4aRvFIXmwAcDBw9AueDQ2YnGmz5L6obe5kmPT8Vd+/+x/JMVKCgdcRwH6APrbpNXsPz+K653Qg8HB/oXvXVukA==",
-      "cpu": [
-        "arm64"
-      ],
+    "node_modules/undici-types": {
+      "version": "5.26.5",
+      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-5.26.5.tgz",
+      "integrity": "sha512-JlCMO+ehdEIKqlFxk6IfVoAUVmgz7cU7zD/h9XZ0qzeosSHmUJVOzSQvvYSYWXkFXC+IfLKSIffhv0sVZup6pA==",
+      "dev": true
+    },
+    "node_modules/unicode-canonical-property-names-ecmascript": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/unicode-canonical-property-names-ecmascript/-/unicode-canonical-property-names-ecmascript-2.0.0.tgz",
+      "integrity": "sha512-yY5PpDlfVIU5+y/BSCxAJRBIS1Zc2dDG3Ujq+sR0U+JjUevW2JhocOF+soROYDSaAezOzOKuyyixhD6mBknSmQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "freebsd"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=4"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/freebsd-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.19.12.tgz",
-      "integrity": "sha512-EYoXZ4d8xtBoVN7CEwWY2IN4ho76xjYXqSXMNccFSx2lgqOG/1TBPW0yPx1bJZk94qu3tX0fycJeeQsKovA8gg==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/unicode-match-property-ecmascript": {
+      "version": "2.0.0",
+      "resolved": "https://registry.npmjs.org/unicode-match-property-ecmascript/-/unicode-match-property-ecmascript-2.0.0.tgz",
+      "integrity": "sha512-5kaZCrbp5mmbz5ulBkDkbY0SsPOjKqVS35VpL9ulMPfSl0J0Xsm+9Evphv9CoIZFwre7aJoa94AY6seMKGVN5Q==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "freebsd"
-      ],
+      "dependencies": {
+        "unicode-canonical-property-names-ecmascript": "^2.0.0",
+        "unicode-property-aliases-ecmascript": "^2.0.0"
+      },
       "engines": {
-        "node": ">=12"
+        "node": ">=4"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-arm": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.19.12.tgz",
-      "integrity": "sha512-J5jPms//KhSNv+LO1S1TX1UWp1ucM6N6XuL6ITdKWElCu8wXP72l9MM0zDTzzeikVyqFE6U8YAV9/tFyj0ti+w==",
-      "cpu": [
-        "arm"
-      ],
+    "node_modules/unicode-match-property-value-ecmascript": {
+      "version": "2.1.0",
+      "resolved": "https://registry.npmjs.org/unicode-match-property-value-ecmascript/-/unicode-match-property-value-ecmascript-2.1.0.tgz",
+      "integrity": "sha512-qxkjQt6qjg/mYscYMC0XKRn3Rh0wFPlfxB0xkt9CfyTvpX1Ra0+rAmdX2QyAobptSEvuy4RtpPRui6XkV+8wjA==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=4"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-arm64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.19.12.tgz",
-      "integrity": "sha512-EoTjyYyLuVPfdPLsGVVVC8a0p1BFFvtpQDB/YLEhaXyf/5bczaGeN15QkR+O4S5LeJ92Tqotve7i1jn35qwvdA==",
-      "cpu": [
-        "arm64"
-      ],
+    "node_modules/unicode-property-aliases-ecmascript": {
+      "version": "2.1.0",
+      "resolved": "https://registry.npmjs.org/unicode-property-aliases-ecmascript/-/unicode-property-aliases-ecmascript-2.1.0.tgz",
+      "integrity": "sha512-6t3foTQI9qne+OZoVQB/8x8rk2k1eVy1gRXhV3oFQ5T6R1dqQ1xtin3XqSlx3+ATBkliTaR/hHyJBm+LVPNM8w==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=4"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-ia32": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.19.12.tgz",
-      "integrity": "sha512-Thsa42rrP1+UIGaWz47uydHSBOgTUnwBwNq59khgIwktK6x60Hivfbux9iNR0eHCHzOLjLMLfUMLCypBkZXMHA==",
-      "cpu": [
-        "ia32"
-      ],
+    "node_modules/unicorn-magic": {
+      "version": "0.1.0",
+      "resolved": "https://registry.npmjs.org/unicorn-magic/-/unicorn-magic-0.1.0.tgz",
+      "integrity": "sha512-lRfVq8fE8gz6QMBuDM6a+LO3IAzTi05H6gCVaUpir2E1Rwpo4ZUog45KpNXKC/Mn3Yb9UDuHumeFTo9iV/D9FQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-loong64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.19.12.tgz",
-      "integrity": "sha512-LiXdXA0s3IqRRjm6rV6XaWATScKAXjI4R4LoDlvO7+yQqFdlr1Bax62sRwkVvRIrwXxvtYEHHI4dm50jAXkuAA==",
-      "cpu": [
-        "loong64"
-      ],
+    "node_modules/unique-filename": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/unique-filename/-/unique-filename-3.0.0.tgz",
+      "integrity": "sha512-afXhuC55wkAmZ0P18QsVE6kp8JaxrEokN2HGIoIVv2ijHQd419H0+6EigAFcIzXeMIkcIkNBpB3L/DXB3cTS/g==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
+      "dependencies": {
+        "unique-slug": "^4.0.0"
+      },
       "engines": {
-        "node": ">=12"
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-mips64el": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.19.12.tgz",
-      "integrity": "sha512-fEnAuj5VGTanfJ07ff0gOA6IPsvrVHLVb6Lyd1g2/ed67oU1eFzL0r9WL7ZzscD+/N6i3dWumGE1Un4f7Amf+w==",
-      "cpu": [
-        "mips64el"
-      ],
+    "node_modules/unique-slug": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/unique-slug/-/unique-slug-4.0.0.tgz",
+      "integrity": "sha512-WrcA6AyEfqDX5bWige/4NQfPZMtASNVxdmWR76WESYQVAACSgWcR6e9i0mofqqBxYFtL4oAxPIptY73/0YE1DQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
+      "dependencies": {
+        "imurmurhash": "^0.1.4"
+      },
       "engines": {
-        "node": ">=12"
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-ppc64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.19.12.tgz",
-      "integrity": "sha512-nYJA2/QPimDQOh1rKWedNOe3Gfc8PabU7HT3iXWtNUbRzXS9+vgB0Fjaqr//XNbd82mCxHzik2qotuI89cfixg==",
-      "cpu": [
-        "ppc64"
-      ],
+    "node_modules/universalify": {
+      "version": "0.1.2",
+      "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.1.2.tgz",
+      "integrity": "sha512-rBJeI5CXAlmy1pV+617WB9J63U6XcazHHF2f2dbJix4XzpUF0RS3Zbj0FGIOCAva5P/d/GBOYaACQ1w+0azUkg==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">= 4.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-riscv64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.19.12.tgz",
-      "integrity": "sha512-2MueBrlPQCw5dVJJpQdUYgeqIzDQgw3QtiAHUC4RBz9FXPrskyyU3VI1hw7C0BSKB9OduwSJ79FTCqtGMWqJHg==",
-      "cpu": [
-        "riscv64"
-      ],
+    "node_modules/unpipe": {
+      "version": "1.0.0",
+      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
+      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">= 0.8"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-s390x": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.19.12.tgz",
-      "integrity": "sha512-+Pil1Nv3Umes4m3AZKqA2anfhJiVmNCYkPchwFJNEJN5QxmTs1uzyy4TvmDrCRNT2ApwSari7ZIgrPeUx4UZDg==",
-      "cpu": [
-        "s390x"
-      ],
+    "node_modules/update-browserslist-db": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.0.tgz",
+      "integrity": "sha512-EdRAaAyk2cUE1wOf2DkEhzxqOQvFOoRJFNS6NeyJ01Gp2beMRpBAINjM2iDXE3KCuKhwnvHIQCJm6ThL2Z+HzQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
+      "funding": [
+        {
+          "type": "opencollective",
+          "url": "https://opencollective.com/browserslist"
+        },
+        {
+          "type": "tidelift",
+          "url": "https://tidelift.com/funding/github/npm/browserslist"
+        },
+        {
+          "type": "github",
+          "url": "https://github.com/sponsors/ai"
+        }
       ],
-      "engines": {
-        "node": ">=12"
+      "dependencies": {
+        "escalade": "^3.1.2",
+        "picocolors": "^1.0.1"
+      },
+      "bin": {
+        "update-browserslist-db": "cli.js"
+      },
+      "peerDependencies": {
+        "browserslist": ">= 4.21.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/linux-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.19.12.tgz",
-      "integrity": "sha512-B71g1QpxfwBvNrfyJdVDexenDIt1CiDN1TIXLbhOw0KhJzE78KIFGX6OJ9MrtC0oOqMWf+0xop4qEU8JrJTwCg==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/uri-js": {
+      "version": "4.4.1",
+      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
+      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "linux"
-      ],
-      "engines": {
-        "node": ">=12"
+      "dependencies": {
+        "punycode": "^2.1.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/netbsd-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.19.12.tgz",
-      "integrity": "sha512-3ltjQ7n1owJgFbuC61Oj++XhtzmymoCihNFgT84UAmJnxJfm4sYCiSLTXZtE00VWYpPMYc+ZQmB6xbSdVh0JWA==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/uri-js/node_modules/punycode": {
+      "version": "2.3.1",
+      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
+      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "netbsd"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">=6"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/openbsd-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.19.12.tgz",
-      "integrity": "sha512-RbrfTB9SWsr0kWmb9srfF+L933uMDdu9BIzdA7os2t0TXhCRjrQyCeOt6wVxr79CKD4c+p+YhCj31HBkYcXebw==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/util-deprecate": {
+      "version": "1.0.2",
+      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
+      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
+      "dev": true
+    },
+    "node_modules/utils-merge": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
+      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "openbsd"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">= 0.4.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/sunos-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.19.12.tgz",
-      "integrity": "sha512-HKjJwRrW8uWtCQnQOz9qcU3mUZhTUQvi56Q8DPTLLB+DawoiQdjsYq+j+D3s9I8VFtDr+F9CjgXKKC4ss89IeA==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/uuid": {
+      "version": "8.3.2",
+      "resolved": "https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz",
+      "integrity": "sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "sunos"
-      ],
-      "engines": {
-        "node": ">=12"
+      "bin": {
+        "uuid": "dist/bin/uuid"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/win32-arm64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.19.12.tgz",
-      "integrity": "sha512-URgtR1dJnmGvX864pn1B2YUYNzjmXkuJOIqG2HdU62MVS4EHpU2946OZoTMnRUHklGtJdJZ33QfzdjGACXhn1A==",
-      "cpu": [
-        "arm64"
-      ],
+    "node_modules/validate-npm-package-license": {
+      "version": "3.0.4",
+      "resolved": "https://registry.npmjs.org/validate-npm-package-license/-/validate-npm-package-license-3.0.4.tgz",
+      "integrity": "sha512-DpKm2Ui/xN7/HQKCtpZxoRWBhZ9Z0kqtygG8XCgNQ8ZlDnxuQmWhj566j8fN4Cu3/JmbhsDo7fcAJq4s9h27Ew==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ],
-      "engines": {
-        "node": ">=12"
+      "dependencies": {
+        "spdx-correct": "^3.0.0",
+        "spdx-expression-parse": "^3.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/win32-ia32": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.19.12.tgz",
-      "integrity": "sha512-+ZOE6pUkMOJfmxmBZElNOx72NKpIa/HFOMGzu8fqzQJ5kgf6aTGrcJaFsNiVMH4JKpMipyK+7k0n2UXN7a8YKQ==",
-      "cpu": [
-        "ia32"
-      ],
+    "node_modules/validate-npm-package-name": {
+      "version": "5.0.1",
+      "resolved": "https://registry.npmjs.org/validate-npm-package-name/-/validate-npm-package-name-5.0.1.tgz",
+      "integrity": "sha512-OljLrQ9SQdOUqTaQxqL5dEfZWrXExyyWsozYlAWFawPVNuD83igl7uJD2RTkNMbniIYgt8l81eCJGIdQF7avLQ==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": "^14.17.0 || ^16.13.0 || >=18.0.0"
       }
     },
-    "node_modules/vite/node_modules/@esbuild/win32-x64": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.19.12.tgz",
-      "integrity": "sha512-T1QyPSDCyMXaO3pzBkF96E8xMkiRYbUEZADd29SyPGabqxMViNoii+NcK7eWJAEoU6RZyEm5lVSIjTmcdoB9HA==",
-      "cpu": [
-        "x64"
-      ],
+    "node_modules/vary": {
+      "version": "1.1.2",
+      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
+      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
       "dev": true,
-      "optional": true,
-      "os": [
-        "win32"
-      ],
       "engines": {
-        "node": ">=12"
+        "node": ">= 0.8"
       }
     },
-    "node_modules/vite/node_modules/esbuild": {
-      "version": "0.19.12",
-      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.19.12.tgz",
-      "integrity": "sha512-aARqgq8roFBj054KvQr5f1sFu0D65G+miZRCuJyJ0G13Zwx7vRar5Zhn2tkQNzIXcBrNVsv/8stehpj+GAjgbg==",
+    "node_modules/vite": {
+      "version": "5.3.2",
+      "resolved": "https://registry.npmjs.org/vite/-/vite-5.3.2.tgz",
+      "integrity": "sha512-6lA7OBHBlXUxiJxbO5aAY2fsHHzDr1q7DvXYnyZycRs2Dz+dXBWuhpWHvmljTRTpQC2uvGmUFFkSHF2vGo90MA==",
       "dev": true,
-      "hasInstallScript": true,
+      "dependencies": {
+        "esbuild": "^0.21.3",
+        "postcss": "^8.4.38",
+        "rollup": "^4.13.0"
+      },
       "bin": {
-        "esbuild": "bin/esbuild"
+        "vite": "bin/vite.js"
       },
       "engines": {
-        "node": ">=12"
+        "node": "^18.0.0 || >=20.0.0"
+      },
+      "funding": {
+        "url": "https://github.com/vitejs/vite?sponsor=1"
       },
       "optionalDependencies": {
-        "@esbuild/aix-ppc64": "0.19.12",
-        "@esbuild/android-arm": "0.19.12",
-        "@esbuild/android-arm64": "0.19.12",
-        "@esbuild/android-x64": "0.19.12",
-        "@esbuild/darwin-arm64": "0.19.12",
-        "@esbuild/darwin-x64": "0.19.12",
-        "@esbuild/freebsd-arm64": "0.19.12",
-        "@esbuild/freebsd-x64": "0.19.12",
-        "@esbuild/linux-arm": "0.19.12",
-        "@esbuild/linux-arm64": "0.19.12",
-        "@esbuild/linux-ia32": "0.19.12",
-        "@esbuild/linux-loong64": "0.19.12",
-        "@esbuild/linux-mips64el": "0.19.12",
-        "@esbuild/linux-ppc64": "0.19.12",
-        "@esbuild/linux-riscv64": "0.19.12",
-        "@esbuild/linux-s390x": "0.19.12",
-        "@esbuild/linux-x64": "0.19.12",
-        "@esbuild/netbsd-x64": "0.19.12",
-        "@esbuild/openbsd-x64": "0.19.12",
-        "@esbuild/sunos-x64": "0.19.12",
-        "@esbuild/win32-arm64": "0.19.12",
-        "@esbuild/win32-ia32": "0.19.12",
-        "@esbuild/win32-x64": "0.19.12"
+        "fsevents": "~2.3.3"
+      },
+      "peerDependencies": {
+        "@types/node": "^18.0.0 || >=20.0.0",
+        "less": "*",
+        "lightningcss": "^1.21.0",
+        "sass": "*",
+        "stylus": "*",
+        "sugarss": "*",
+        "terser": "^5.4.0"
+      },
+      "peerDependenciesMeta": {
+        "@types/node": {
+          "optional": true
+        },
+        "less": {
+          "optional": true
+        },
+        "lightningcss": {
+          "optional": true
+        },
+        "sass": {
+          "optional": true
+        },
+        "stylus": {
+          "optional": true
+        },
+        "sugarss": {
+          "optional": true
+        },
+        "terser": {
+          "optional": true
+        }
       }
     },
     "node_modules/void-elements": {
@@ -12830,9 +13228,9 @@
       }
     },
     "node_modules/watchpack": {
-      "version": "2.4.0",
-      "resolved": "https://registry.npmjs.org/watchpack/-/watchpack-2.4.0.tgz",
-      "integrity": "sha512-Lcvm7MGST/4fup+ifyKi2hjyIAwcdI4HRgtvTpIUxBRhB+RFtUh8XtDOxUfctVCnhVi+QQj49i91OyvzkJl6cg==",
+      "version": "2.4.1",
+      "resolved": "https://registry.npmjs.org/watchpack/-/watchpack-2.4.1.tgz",
+      "integrity": "sha512-8wrBCMtVhqcXP2Sup1ctSkga6uc2Bx0IIvKyT7yTFier5AXHooSI+QyQQAtTb7+E0IUCCKyTFmXqdqgum2XWGg==",
       "dev": true,
       "dependencies": {
         "glob-to-regexp": "^0.4.1",
@@ -12860,27 +13258,33 @@
         "defaults": "^1.0.3"
       }
     },
+    "node_modules/weak-lru-cache": {
+      "version": "1.2.2",
+      "resolved": "https://registry.npmjs.org/weak-lru-cache/-/weak-lru-cache-1.2.2.tgz",
+      "integrity": "sha512-DEAoo25RfSYMuTGc9vPJzZcZullwIqRDSI9LOy+fkCJPi6hykCnfKaXTuPBDuXAUcqHXyOgFtHNp/kB2FjYHbw==",
+      "dev": true
+    },
     "node_modules/webpack": {
-      "version": "5.90.3",
-      "resolved": "https://registry.npmjs.org/webpack/-/webpack-5.90.3.tgz",
-      "integrity": "sha512-h6uDYlWCctQRuXBs1oYpVe6sFcWedl0dpcVaTf/YF67J9bKvwJajFulMVSYKHrksMB3I/pIagRzDxwxkebuzKA==",
+      "version": "5.92.1",
+      "resolved": "https://registry.npmjs.org/webpack/-/webpack-5.92.1.tgz",
+      "integrity": "sha512-JECQ7IwJb+7fgUFBlrJzbyu3GEuNBcdqr1LD7IbSzwkSmIevTm8PF+wej3Oxuz/JFBUZ6O1o43zsPkwm1C4TmA==",
       "dev": true,
       "dependencies": {
         "@types/eslint-scope": "^3.7.3",
         "@types/estree": "^1.0.5",
-        "@webassemblyjs/ast": "^1.11.5",
-        "@webassemblyjs/wasm-edit": "^1.11.5",
-        "@webassemblyjs/wasm-parser": "^1.11.5",
+        "@webassemblyjs/ast": "^1.12.1",
+        "@webassemblyjs/wasm-edit": "^1.12.1",
+        "@webassemblyjs/wasm-parser": "^1.12.1",
         "acorn": "^8.7.1",
-        "acorn-import-assertions": "^1.9.0",
+        "acorn-import-attributes": "^1.9.5",
         "browserslist": "^4.21.10",
         "chrome-trace-event": "^1.0.2",
-        "enhanced-resolve": "^5.15.0",
+        "enhanced-resolve": "^5.17.0",
         "es-module-lexer": "^1.2.1",
         "eslint-scope": "5.1.1",
         "events": "^3.2.0",
         "glob-to-regexp": "^0.4.1",
-        "graceful-fs": "^4.2.9",
+        "graceful-fs": "^4.2.11",
         "json-parse-even-better-errors": "^2.3.1",
         "loader-runner": "^4.2.0",
         "mime-types": "^2.1.27",
@@ -12888,7 +13292,7 @@
         "schema-utils": "^3.2.0",
         "tapable": "^2.1.1",
         "terser-webpack-plugin": "^5.3.10",
-        "watchpack": "^2.4.0",
+        "watchpack": "^2.4.1",
         "webpack-sources": "^3.2.3"
       },
       "bin": {
@@ -12908,19 +13312,20 @@
       }
     },
     "node_modules/webpack-dev-middleware": {
-      "version": "6.1.2",
-      "resolved": "https://registry.npmjs.org/webpack-dev-middleware/-/webpack-dev-middleware-6.1.2.tgz",
-      "integrity": "sha512-Wu+EHmX326YPYUpQLKmKbTyZZJIB8/n6R09pTmB03kJmnMsVPTo9COzHZFr01txwaCAuZvfBJE4ZCHRcKs5JaQ==",
+      "version": "7.2.1",
+      "resolved": "https://registry.npmjs.org/webpack-dev-middleware/-/webpack-dev-middleware-7.2.1.tgz",
+      "integrity": "sha512-hRLz+jPQXo999Nx9fXVdKlg/aehsw1ajA9skAneGmT03xwmyuhvF93p6HUKKbWhXdcERtGTzUCtIQr+2IQegrA==",
       "dev": true,
       "dependencies": {
         "colorette": "^2.0.10",
-        "memfs": "^3.4.12",
+        "memfs": "^4.6.0",
         "mime-types": "^2.1.31",
+        "on-finished": "^2.4.1",
         "range-parser": "^1.2.1",
         "schema-utils": "^4.0.0"
       },
       "engines": {
-        "node": ">= 14.15.0"
+        "node": ">= 18.12.0"
       },
       "funding": {
         "type": "opencollective",
@@ -12936,54 +13341,54 @@
       }
     },
     "node_modules/webpack-dev-server": {
-      "version": "4.15.1",
-      "resolved": "https://registry.npmjs.org/webpack-dev-server/-/webpack-dev-server-4.15.1.tgz",
-      "integrity": "sha512-5hbAst3h3C3L8w6W4P96L5vaV0PxSmJhxZvWKYIdgxOQm8pNZ5dEOmmSLBVpP85ReeyRt6AS1QJNyo/oFFPeVA==",
-      "dev": true,
-      "dependencies": {
-        "@types/bonjour": "^3.5.9",
-        "@types/connect-history-api-fallback": "^1.3.5",
-        "@types/express": "^4.17.13",
-        "@types/serve-index": "^1.9.1",
-        "@types/serve-static": "^1.13.10",
-        "@types/sockjs": "^0.3.33",
-        "@types/ws": "^8.5.5",
+      "version": "5.0.4",
+      "resolved": "https://registry.npmjs.org/webpack-dev-server/-/webpack-dev-server-5.0.4.tgz",
+      "integrity": "sha512-dljXhUgx3HqKP2d8J/fUMvhxGhzjeNVarDLcbO/EWMSgRizDkxHQDZQaLFL5VJY9tRBj2Gz+rvCEYYvhbqPHNA==",
+      "dev": true,
+      "dependencies": {
+        "@types/bonjour": "^3.5.13",
+        "@types/connect-history-api-fallback": "^1.5.4",
+        "@types/express": "^4.17.21",
+        "@types/serve-index": "^1.9.4",
+        "@types/serve-static": "^1.15.5",
+        "@types/sockjs": "^0.3.36",
+        "@types/ws": "^8.5.10",
         "ansi-html-community": "^0.0.8",
-        "bonjour-service": "^1.0.11",
-        "chokidar": "^3.5.3",
+        "bonjour-service": "^1.2.1",
+        "chokidar": "^3.6.0",
         "colorette": "^2.0.10",
         "compression": "^1.7.4",
         "connect-history-api-fallback": "^2.0.0",
         "default-gateway": "^6.0.3",
         "express": "^4.17.3",
         "graceful-fs": "^4.2.6",
-        "html-entities": "^2.3.2",
+        "html-entities": "^2.4.0",
         "http-proxy-middleware": "^2.0.3",
-        "ipaddr.js": "^2.0.1",
-        "launch-editor": "^2.6.0",
-        "open": "^8.0.9",
-        "p-retry": "^4.5.0",
-        "rimraf": "^3.0.2",
-        "schema-utils": "^4.0.0",
-        "selfsigned": "^2.1.1",
+        "ipaddr.js": "^2.1.0",
+        "launch-editor": "^2.6.1",
+        "open": "^10.0.3",
+        "p-retry": "^6.2.0",
+        "rimraf": "^5.0.5",
+        "schema-utils": "^4.2.0",
+        "selfsigned": "^2.4.1",
         "serve-index": "^1.9.1",
         "sockjs": "^0.3.24",
         "spdy": "^4.0.2",
-        "webpack-dev-middleware": "^5.3.1",
-        "ws": "^8.13.0"
+        "webpack-dev-middleware": "^7.1.0",
+        "ws": "^8.16.0"
       },
       "bin": {
         "webpack-dev-server": "bin/webpack-dev-server.js"
       },
       "engines": {
-        "node": ">= 12.13.0"
+        "node": ">= 18.12.0"
       },
       "funding": {
         "type": "opencollective",
         "url": "https://opencollective.com/webpack"
       },
       "peerDependencies": {
-        "webpack": "^4.37.0 || ^5.0.0"
+        "webpack": "^5.0.0"
       },
       "peerDependenciesMeta": {
         "webpack": {
@@ -12994,50 +13399,92 @@
         }
       }
     },
-    "node_modules/webpack-dev-server/node_modules/webpack-dev-middleware": {
-      "version": "5.3.4",
-      "resolved": "https://registry.npmjs.org/webpack-dev-middleware/-/webpack-dev-middleware-5.3.4.tgz",
-      "integrity": "sha512-BVdTqhhs+0IfoeAf7EoH5WE+exCmqGerHfDM0IL096Px60Tq2Mn9MAbnaGUe6HiMa41KMCYF19gyzZmBcq/o4Q==",
+    "node_modules/webpack-dev-server/node_modules/brace-expansion": {
+      "version": "2.0.1",
+      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.1.tgz",
+      "integrity": "sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==",
       "dev": true,
       "dependencies": {
-        "colorette": "^2.0.10",
-        "memfs": "^3.4.3",
-        "mime-types": "^2.1.31",
-        "range-parser": "^1.2.1",
-        "schema-utils": "^4.0.0"
+        "balanced-match": "^1.0.0"
+      }
+    },
+    "node_modules/webpack-dev-server/node_modules/glob": {
+      "version": "10.4.5",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
+      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
+      "dev": true,
+      "dependencies": {
+        "foreground-child": "^3.1.0",
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
       },
-      "engines": {
-        "node": ">= 12.13.0"
+      "bin": {
+        "glob": "dist/esm/bin.mjs"
       },
       "funding": {
-        "type": "opencollective",
-        "url": "https://opencollective.com/webpack"
-      },
-      "peerDependencies": {
-        "webpack": "^4.0.0 || ^5.0.0"
+        "url": "https://github.com/sponsors/isaacs"
       }
     },
-    "node_modules/webpack-dev-server/node_modules/ws": {
-      "version": "8.16.0",
-      "resolved": "https://registry.npmjs.org/ws/-/ws-8.16.0.tgz",
-      "integrity": "sha512-HS0c//TP7Ina87TfiPUz1rQzMhHrl/SG2guqRcTOIUYD2q8uhUdNHZYJUaQ8aTGPzCh+c6oawMKW35nFl1dxyQ==",
+    "node_modules/webpack-dev-server/node_modules/http-proxy-middleware": {
+      "version": "2.0.6",
+      "resolved": "https://registry.npmjs.org/http-proxy-middleware/-/http-proxy-middleware-2.0.6.tgz",
+      "integrity": "sha512-ya/UeJ6HVBYxrgYotAZo1KvPWlgB48kUJLDePFeneHsVujFaW5WNj2NgWCAE//B1Dl02BIfYlpNgBy8Kf8Rjmw==",
       "dev": true,
+      "dependencies": {
+        "@types/http-proxy": "^1.17.8",
+        "http-proxy": "^1.18.1",
+        "is-glob": "^4.0.1",
+        "is-plain-obj": "^3.0.0",
+        "micromatch": "^4.0.2"
+      },
       "engines": {
-        "node": ">=10.0.0"
+        "node": ">=12.0.0"
       },
       "peerDependencies": {
-        "bufferutil": "^4.0.1",
-        "utf-8-validate": ">=5.0.2"
+        "@types/express": "^4.17.13"
       },
       "peerDependenciesMeta": {
-        "bufferutil": {
-          "optional": true
-        },
-        "utf-8-validate": {
+        "@types/express": {
           "optional": true
         }
       }
     },
+    "node_modules/webpack-dev-server/node_modules/minimatch": {
+      "version": "9.0.5",
+      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
+      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
+      "dev": true,
+      "dependencies": {
+        "brace-expansion": "^2.0.1"
+      },
+      "engines": {
+        "node": ">=16 || 14 >=14.17"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
+    "node_modules/webpack-dev-server/node_modules/rimraf": {
+      "version": "5.0.9",
+      "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-5.0.9.tgz",
+      "integrity": "sha512-3i7b8OcswU6CpU8Ej89quJD4O98id7TtVM5U4Mybh84zQXdrFmDLouWBEEaD/QfO3gDDfH+AGFCGsR7kngzQnA==",
+      "dev": true,
+      "dependencies": {
+        "glob": "^10.3.7"
+      },
+      "bin": {
+        "rimraf": "dist/esm/bin.mjs"
+      },
+      "engines": {
+        "node": "14 >=14.20 || 16 >=16.20 || >=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/webpack-merge": {
       "version": "5.10.0",
       "resolved": "https://registry.npmjs.org/webpack-merge/-/webpack-merge-5.10.0.tgz",
@@ -13243,6 +13690,35 @@
       "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
       "dev": true
     },
+    "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/wrap-ansi/node_modules/ansi-styles": {
       "version": "4.3.0",
       "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
@@ -13276,6 +13752,35 @@
       "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
       "dev": true
     },
+    "node_modules/wrap-ansi/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/wrap-ansi/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/wrappy": {
       "version": "1.0.2",
       "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
@@ -13283,16 +13788,16 @@
       "dev": true
     },
     "node_modules/ws": {
-      "version": "8.11.0",
-      "resolved": "https://registry.npmjs.org/ws/-/ws-8.11.0.tgz",
-      "integrity": "sha512-HPG3wQd9sNQoT9xHyNCXoDUa+Xw/VevmY9FoHyQ+g+rrMn4j6FB4np7Z0OhdTgjx6MgQLK7jwSy1YecU1+4Asg==",
+      "version": "8.17.1",
+      "resolved": "https://registry.npmjs.org/ws/-/ws-8.17.1.tgz",
+      "integrity": "sha512-6XQFvXTkbfUOZOKKILFG1PDK2NDQs4azKQl26T0YS5CxqWLgXajbPZ+h4gZekJyRqFU8pvnbAbbs/3TgRPy+GQ==",
       "dev": true,
       "engines": {
         "node": ">=10.0.0"
       },
       "peerDependencies": {
         "bufferutil": "^4.0.1",
-        "utf-8-validate": "^5.0.2"
+        "utf-8-validate": ">=5.0.2"
       },
       "peerDependenciesMeta": {
         "bufferutil": {
@@ -13345,10 +13850,39 @@
         "node": ">=12"
       }
     },
+    "node_modules/yargs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true
+    },
+    "node_modules/yargs/node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/yargs/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/yocto-queue": {
-      "version": "1.0.0",
-      "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-1.0.0.tgz",
-      "integrity": "sha512-9bnSc/HEW2uRy67wc+T8UwauLuPJVn28jb+GtJY16iiKWyvmYJRXVT4UamsAEGQfPohgr2q4Tq0sQbQlxTfi1g==",
+      "version": "1.1.1",
+      "resolved": "https://registry.npmjs.org/yocto-queue/-/yocto-queue-1.1.1.tgz",
+      "integrity": "sha512-b4JR1PFR10y1mKjhHY9LaGo6tmrgjit7hxVIeAmyMw3jegXR4dhYqLaQF5zMXZxY7tLpMyJeLjr1C4rLmkVe8g==",
       "dev": true,
       "engines": {
         "node": ">=12.20"
@@ -13357,13 +13891,22 @@
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
-    "node_modules/zone.js": {
-      "version": "0.14.4",
-      "resolved": "https://registry.npmjs.org/zone.js/-/zone.js-0.14.4.tgz",
-      "integrity": "sha512-NtTUvIlNELez7Q1DzKVIFZBzNb646boQMgpATo9z3Ftuu/gWvzxCW7jdjcUDoRGxRikrhVHB/zLXh1hxeJawvw==",
-      "dependencies": {
-        "tslib": "^2.3.0"
+    "node_modules/yoctocolors-cjs": {
+      "version": "2.1.2",
+      "resolved": "https://registry.npmjs.org/yoctocolors-cjs/-/yoctocolors-cjs-2.1.2.tgz",
+      "integrity": "sha512-cYVsTjKl8b+FrnidjibDWskAv7UKOfcwaVZdp/it9n1s9fU3IkgDbhdIRKCW4JDsAlECJY0ytoVPT3sK6kideA==",
+      "dev": true,
+      "engines": {
+        "node": ">=18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
       }
+    },
+    "node_modules/zone.js": {
+      "version": "0.14.8",
+      "resolved": "https://registry.npmjs.org/zone.js/-/zone.js-0.14.8.tgz",
+      "integrity": "sha512-48uh7MnVp4/OQDuCHeFdXw5d8xwPqFTvlHgPJ1LBFb5GaustLSZV+YUH0to5ygNyGpqTsjpbpt141U/j3pCfqQ=="
     }
   }
 }
diff --git a/tools/motion/motion_test_watcher_app/package.json b/tools/motion/motion_test_watcher_app/package.json
index fd3287490..db2a24635 100644
--- a/tools/motion/motion_test_watcher_app/package.json
+++ b/tools/motion/motion_test_watcher_app/package.json
@@ -12,24 +12,24 @@
   },
   "private": true,
   "dependencies": {
-    "@angular/cdk": "^17.3.5",
-    "@angular/common": "^17.3.0",
-    "@angular/compiler": "^17.3.0",
-    "@angular/core": "^17.3.0",
-    "@angular/forms": "^17.3.0",
-    "@angular/material": "^17.3.5",
-    "@angular/material-experimental": "^17.3.5",
-    "@angular/platform-browser": "^17.3.0",
-    "@angular/platform-browser-dynamic": "^17.3.0",
-    "@angular/router": "^17.3.0",
+    "@angular/cdk": "^18.0.0",
+    "@angular/common": "^18.0.0",
+    "@angular/compiler": "^18.0.0",
+    "@angular/core": "^18.0.0",
+    "@angular/forms": "^18.0.0",
+    "@angular/material": "^18.0.0",
+    "@angular/platform-browser": "^18.0.0",
+    "@angular/platform-browser-dynamic": "^18.0.0",
+    "@angular/router": "^18.0.0",
+    "ng-keyboard-shortcuts": "^13.0.8",
     "rxjs": "~7.8.0",
     "tslib": "^2.3.0",
     "zone.js": "~0.14.3"
   },
   "devDependencies": {
-    "@angular-devkit/build-angular": "^17.3.5",
-    "@angular/cli": "^17.3.5",
-    "@angular/compiler-cli": "^17.3.0",
+    "@angular-devkit/build-angular": "^18.0.1",
+    "@angular/cli": "^18.0.1",
+    "@angular/compiler-cli": "^18.0.0",
     "@types/jasmine": "~5.1.0",
     "jasmine-core": "~5.1.0",
     "karma": "~6.4.0",
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.component.html b/tools/motion/motion_test_watcher_app/src/app/app.component.html
index b373f6304..4be87cbdc 100644
--- a/tools/motion/motion_test_watcher_app/src/app/app.component.html
+++ b/tools/motion/motion_test_watcher_app/src/app/app.component.html
@@ -1,4 +1,4 @@
-<mat-toolbar color="primary">
+<mat-toolbar color="accent">
   <span>Motion Test Watcher</span>
   <span class="header-spacer"></span>
 
@@ -9,9 +9,10 @@
     <mat-icon>delete</mat-icon>
   </button>
 </mat-toolbar>
+<mat-progress-bar
+  [class.show]="showProgress"
+  mode="indeterminate"
+></mat-progress-bar>
 <div class="content mat-app-background">
-  @if (showProgress) {
-    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
-  }
   <app-test-overview [goldens]="goldens"></app-test-overview>
 </div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.component.scss b/tools/motion/motion_test_watcher_app/src/app/app.component.scss
index 1930abdc6..d1413be8f 100644
--- a/tools/motion/motion_test_watcher_app/src/app/app.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/app.component.scss
@@ -22,8 +22,8 @@ mat-toolbar button {
   position: relative;
   display: flex;
   flex-grow: 1;
-  overflow: scroll;
   align-content: stretch;
+  overflow: hidden;
 }
 
 mat-progress-bar {
@@ -31,4 +31,8 @@ mat-progress-bar {
   top: 0;
   left: 0;
   right: 0;
+  display: none;
+  &.show {
+    display: block;
+  }
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.component.spec.ts b/tools/motion/motion_test_watcher_app/src/app/app.component.spec.ts
deleted file mode 100644
index 5d44cf9e5..000000000
--- a/tools/motion/motion_test_watcher_app/src/app/app.component.spec.ts
+++ /dev/null
@@ -1,31 +0,0 @@
-import { TestBed } from '@angular/core/testing';
-import { AppComponent } from './app.component';
-
-describe('AppComponent', () => {
-  beforeEach(async () => {
-    await TestBed.configureTestingModule({
-      imports: [AppComponent],
-    }).compileComponents();
-  });
-
-  it('should create the app', () => {
-    const fixture = TestBed.createComponent(AppComponent);
-    const app = fixture.componentInstance;
-    expect(app).toBeTruthy();
-  });
-
-  it(`should have the 'watch_web_app' title`, () => {
-    const fixture = TestBed.createComponent(AppComponent);
-    const app = fixture.componentInstance;
-    expect(app.title).toEqual('watch_web_app');
-  });
-
-  it('should render title', () => {
-    const fixture = TestBed.createComponent(AppComponent);
-    fixture.detectChanges();
-    const compiled = fixture.nativeElement as HTMLElement;
-    expect(compiled.querySelector('h1')?.textContent).toContain(
-      'Hello, watch_web_app',
-    );
-  });
-});
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.component.ts b/tools/motion/motion_test_watcher_app/src/app/app.component.ts
index 166b23cc7..c09569a88 100644
--- a/tools/motion/motion_test_watcher_app/src/app/app.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/app.component.ts
@@ -1,4 +1,4 @@
-import { Component } from '@angular/core';
+import { Component, DoCheck } from '@angular/core';
 import { MatButtonModule } from '@angular/material/button';
 import { MatDividerModule } from '@angular/material/divider';
 import { MatIconModule } from '@angular/material/icon';
@@ -7,9 +7,10 @@ import { MatToolbarModule } from '@angular/material/toolbar';
 import { RouterOutlet } from '@angular/router';
 import { finalize } from 'rxjs';
 
-import { Golden } from './golden';
+import { MotionGolden } from './golden';
 import { GoldensService } from './goldens.service';
 import { TestOverviewComponent } from './test-overview/test-overview.component';
+import { ProgressTracker } from '../utils/progress';
 
 @Component({
   selector: 'app-root',
@@ -21,39 +22,43 @@ import { TestOverviewComponent } from './test-overview/test-overview.component';
     MatIconModule,
     MatDividerModule,
     MatButtonModule,
+    MatDividerModule,
     MatProgressBarModule,
   ],
   templateUrl: './app.component.html',
   styleUrl: './app.component.scss',
 })
-export class AppComponent {
-  constructor(private goldenService: GoldensService) {}
+export class AppComponent implements DoCheck {
+  constructor(
+    private goldenService: GoldensService,
+    private progressTracker: ProgressTracker,
+  ) {}
 
-  _progressTracker = 0;
+  ngDoCheck() {
+    this.showProgress = this.progressTracker.isActive;
+  }
 
-  goldens: Golden[] = [];
+  goldens: MotionGolden[] = [];
 
-  get showProgress() {
-    return this._progressTracker > 0;
-  }
+  showProgress = false;
 
   ngOnInit(): void {
     this.fetchGoldens();
   }
 
   fetchGoldens(): void {
-    this._progressTracker++;
+    this.progressTracker.beginProgress();
     this.goldenService
       .getGoldens()
-      .pipe(finalize(() => this._progressTracker--))
+      .pipe(finalize(() => this.progressTracker.endProgress()))
       .subscribe((goldens) => (this.goldens = goldens));
   }
 
   refreshGoldens(clear: boolean): void {
-    this._progressTracker++;
+    this.progressTracker.beginProgress();
     this.goldenService
       .refreshGoldens(clear)
-      .pipe(finalize(() => this._progressTracker--))
+      .pipe(finalize(() => this.progressTracker.endProgress()))
       .subscribe((goldens) => (this.goldens = goldens));
   }
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.config.ts b/tools/motion/motion_test_watcher_app/src/app/app.config.ts
index 5e86617e7..0bfefc81c 100644
--- a/tools/motion/motion_test_watcher_app/src/app/app.config.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/app.config.ts
@@ -1,19 +1,66 @@
 import { provideHttpClient } from '@angular/common/http';
 import { ApplicationConfig } from '@angular/core';
 import { provideRouter } from '@angular/router';
+import { provideAnimationsAsync } from '@angular/platform-browser/animations/async';
 
 import { routes } from './app.routes';
 import { ACCESS_TOKEN, SERVICE_PORT } from './goldens.service';
+import { ProgressTracker } from '../utils/progress';
+import { Preferences } from '../utils/preferences';
+import {
+  APP_BASE_HREF,
+  LocationStrategy,
+  PathLocationStrategy,
+  PlatformLocation,
+} from '@angular/common';
+import { Inject, Injectable, Optional } from '@angular/core';
+import { UrlSerializer } from '@angular/router';
 
 const urlParams = new URLSearchParams(window.location.search);
 const token = urlParams.get('token');
 const port = urlParams.get('port');
 
+@Injectable()
+export class PreserveQueryParamsPathLocationStrategy extends PathLocationStrategy {
+  private get search(): string {
+    return this.platformLocation?.search ?? '';
+  }
+
+  constructor(
+    private platformLocation: PlatformLocation,
+    private urlSerializer: UrlSerializer,
+    @Optional() @Inject(APP_BASE_HREF) _baseHref?: string,
+  ) {
+    super(platformLocation, _baseHref);
+  }
+
+  override prepareExternalUrl(internal: string): string {
+    const path = super.prepareExternalUrl(internal);
+    const urlTree = this.urlSerializer.parse(path);
+
+    const nextQueryParams = urlTree.queryParams;
+    const existingURLSearchParams = new URLSearchParams(this.search);
+    // const existingQueryParams = Object.fromEntries(
+    //   existingURLSearchParams.entries(),
+    // );
+    urlTree.queryParams = { ...existingURLSearchParams, ...nextQueryParams };
+
+    return urlTree.toString();
+  }
+}
+
 export const appConfig: ApplicationConfig = {
   providers: [
     provideRouter(routes),
     provideHttpClient(),
+    provideAnimationsAsync(),
+    ProgressTracker,
+    Preferences,
     { provide: ACCESS_TOKEN, useValue: token },
     { provide: SERVICE_PORT, useValue: port },
+    {
+      provide: LocationStrategy,
+      useClass: PreserveQueryParamsPathLocationStrategy,
+    },
   ],
 };
diff --git a/tools/motion/motion_test_watcher_app/src/app/app.routes.ts b/tools/motion/motion_test_watcher_app/src/app/app.routes.ts
index dc39edb5f..a22f194f3 100644
--- a/tools/motion/motion_test_watcher_app/src/app/app.routes.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/app.routes.ts
@@ -1,3 +1,3 @@
 import { Routes } from '@angular/router';
 
-export const routes: Routes = [];
+export const routes: Routes = [{ path: `index.html` }];
diff --git a/tools/motion/motion_test_watcher_app/src/app/feature.ts b/tools/motion/motion_test_watcher_app/src/app/feature.ts
new file mode 100644
index 000000000..281eb7a70
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/feature.ts
@@ -0,0 +1,76 @@
+import { Derivate } from './feature_derivate';
+import { DataPoint, MotionGoldenFeature } from './golden';
+import {
+  DataPointVisualization,
+  LineGraphVisualization,
+  Visualization,
+} from './visualization';
+
+export interface Feature {
+  id: string;
+  name: string;
+  dataPoints: Array<DataPoint>;
+  visualization: Visualization;
+  derivates: Array<Derivate>;
+}
+
+export class RecordedFeature implements Feature {
+  constructor(
+    private readonly featureData: MotionGoldenFeature,
+    readonly visualization: Visualization,
+    readonly derivates: Array<Derivate>,
+  ) {}
+
+  get id(): string {
+    return this.featureData.name;
+  }
+
+  get name(): string {
+    return this.featureData.name;
+  }
+
+  get dataPoints(): Array<DataPoint> {
+    return this.featureData.data_points;
+  }
+}
+
+export function recordedFeatureFactory(
+  featureData: MotionGoldenFeature,
+): RecordedFeature {
+  const visualization = createVisualization(featureData);
+  const derivatives = createDerivatives(featureData);
+
+  return new RecordedFeature(featureData, visualization, derivatives);
+}
+
+function createVisualization(featureData: MotionGoldenFeature): Visualization {
+  const { name, type } = featureData;
+
+  if (name === 'alpha' && type === 'float') {
+    return new LineGraphVisualization(/* minValue */ 0, /*maxValue*/ 1);
+  }
+
+  if (['float', 'int', 'dp'].includes(type)) {
+    const numericValues = featureData.data_points.filter(
+      (it): it is number => typeof it === 'number',
+    );
+    const minValue = Math.min(...numericValues) ?? 0;
+    let maxValue = Math.max(...numericValues) ?? 1;
+
+    if (minValue === maxValue) {
+      maxValue += 1;
+    }
+
+    return new LineGraphVisualization(minValue, maxValue);
+  }
+
+  return new DataPointVisualization();
+}
+
+function createDerivatives(featureData: MotionGoldenFeature): Derivate[] {
+  const { name, type } = featureData;
+
+  const result: Derivate[] = [];
+
+  return result;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts b/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts
new file mode 100644
index 000000000..87a925cdb
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/feature_derivate.ts
@@ -0,0 +1,22 @@
+import { Feature } from './feature';
+import { DataPoint } from './golden';
+import { Visualization } from './visualization';
+
+export interface Derivate {
+  name: string;
+
+  create(feature: Feature): DerivedFeature;
+}
+
+export class DerivedFeature implements Feature {
+  constructor(
+    readonly id: string,
+    readonly name: string,
+
+    private readonly source: Feature,
+    readonly dataPoints: Array<DataPoint>,
+    readonly visualization: Visualization,
+
+    readonly derivates: Array<Derivate>,
+  ) {}
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/golden.ts b/tools/motion/motion_test_watcher_app/src/app/golden.ts
index 2b28ae670..557c73b70 100644
--- a/tools/motion/motion_test_watcher_app/src/app/golden.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/golden.ts
@@ -4,25 +4,45 @@ export interface MotionGolden {
   label: string;
   goldenRepoPath: string;
   updated: boolean;
+  testClassName: string;
+  testMethodName: string;
+  testTime: string;
 
-  type: 'motion';
-
-  actualUrl: String;
-  filmstripUrl: String | undefined;
+  actualUrl: string;
+  videoUrl: string | undefined;
 }
 
-export interface ScreenshotGolden {
-  id: string;
-  result: 'PASSED' | 'FAILED' | 'MISSING_REFERENCE';
-  label: string;
-  goldenRepoPath: string;
-  updated: boolean;
+export interface MotionGoldenData {
+  frame_ids: Array<string | number>;
+  features: MotionGoldenFeature[];
+}
 
-  type: 'screenshot';
+export interface MotionGoldenFeature {
+  name: string;
+  type: string;
+  data_points: Array<DataPoint>;
+}
 
-  actualUrl: String;
-  expectedUrl: String | undefined;
-  diffUrl: String | undefined;
+type DataPointTypes =
+  | string
+  | number
+  | boolean
+  | null
+  | DataPointArray
+  | DataPointObject;
+export interface DataPointObject {
+  [member: string]: DataPointTypes;
 }
+export interface DataPointArray extends Array<DataPointTypes> {}
+export interface NotFound {
+  type: 'not_found';
+}
+export type DataPoint = DataPointTypes | NotFound;
 
-export type Golden = MotionGolden | ScreenshotGolden;
+export function isNotFound(dataPoint: DataPoint) {
+  return (
+    dataPoint instanceof Object &&
+    'type' in dataPoint &&
+    dataPoint.type === 'not_found'
+  );
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/goldens.service.ts b/tools/motion/motion_test_watcher_app/src/app/goldens.service.ts
index aa7172bc7..4e497989c 100644
--- a/tools/motion/motion_test_watcher_app/src/app/goldens.service.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/goldens.service.ts
@@ -1,9 +1,14 @@
 import { HttpClient, HttpHeaders } from '@angular/common/http';
 import { Inject, Injectable, InjectionToken } from '@angular/core';
 import { Observable, of } from 'rxjs';
-import { catchError, map, tap } from 'rxjs/operators';
+import { catchError, filter, map, tap } from 'rxjs/operators';
 
-import { Golden } from './golden';
+import { MotionGolden, MotionGoldenData } from './golden';
+import { RecordedMotion } from './recorded-motion';
+import { Timeline } from './timeline';
+import { VideoSource } from './video-source';
+import { checkNotNull } from '../utils/preconditions';
+import { Feature, recordedFeatureFactory } from './feature';
 
 export const ACCESS_TOKEN = new InjectionToken<string>('token');
 export const SERVICE_PORT = new InjectionToken<string>('port');
@@ -24,20 +29,44 @@ export class GoldensService {
     };
   }
 
-  getGoldens(): Observable<Golden[]> {
+  getGoldens(): Observable<MotionGolden[]> {
     return this.http
       .get<
-        Golden[]
+        MotionGolden[]
       >(`${this.serverRoot}/service/list`, { headers: this.defaultHeaders })
       .pipe(
         tap((x) => console.log(`listed goldens, got ${x.length} results`)),
-        catchError(this.handleError<Golden[]>('e')),
+        catchError(this.handleError<MotionGolden[]>('e')),
       );
   }
 
-  refreshGoldens(clear: boolean): Observable<Golden[]> {
+  loadRecordedMotion(golden: MotionGolden): Observable<RecordedMotion> {
+    const videoUrl = checkNotNull(golden.videoUrl);
+    return this.getMotionGoldenData(golden).pipe(
+      map((data) => {
+        const timeline = new Timeline(data.frame_ids);
+        const videoSource = new VideoSource(videoUrl, timeline);
+        const features = data.features.map((it) => recordedFeatureFactory(it));
+
+        return new RecordedMotion(videoSource, timeline, features);
+      }),
+    );
+  }
+
+  getMotionGoldenData(golden: MotionGolden): Observable<MotionGoldenData> {
+    return this.http
+      .get<MotionGoldenData>(`${golden.actualUrl}`, {
+        headers: this.defaultHeaders,
+      })
+      .pipe(
+        tap((x) => console.log(`listed loaded golden data`)),
+        catchError(this.handleError<MotionGoldenData>('e')),
+      );
+  }
+
+  refreshGoldens(clear: boolean): Observable<MotionGolden[]> {
     return this.http
-      .post<Golden[]>(
+      .post<MotionGolden[]>(
         `${this.serverRoot}/service/refresh`,
         { clear },
         {
@@ -49,11 +78,11 @@ export class GoldensService {
       )
       .pipe(
         tap((_) => console.log(`refreshed goldens (clear)`)),
-        catchError(this.handleError<Golden[]>('e')),
+        catchError(this.handleError<MotionGolden[]>('e')),
       );
   }
 
-  updateGolden(golden: Golden): Observable<void> {
+  updateGolden(golden: MotionGolden): Observable<void> {
     return this.http
       .put<void>(
         `${this.serverRoot}/service/update?id=${golden.id}`,
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss b/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss
new file mode 100644
index 000000000..97ebbb8e1
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/_theme.scss
@@ -0,0 +1,23 @@
+@use "sass:map";
+@use "@angular/material" as mat;
+
+@mixin color($theme) {
+  .golden-card {
+    background-color: mat.get-theme-color($theme, surface-container-low);
+  }
+}
+
+@mixin typography($theme) {
+  .wrapper {
+    font: mat.get-theme-typography($theme, label-large, font);
+  }
+}
+
+@mixin theme($theme) {
+  @if mat.theme-has($theme, color) {
+    @include color($theme);
+  }
+  @if mat.theme-has($theme, typography) {
+    @include typography($theme);
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.html b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.html
index a514451ce..276ce5cda 100644
--- a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.html
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.html
@@ -1,15 +1,40 @@
-<div class="wrapper">
-  <div class=".mat-app-background label">Motion Golden result</div>
-  <div class="toolbar">
-    <button mat-icon-button (click)="updateGolden()">
+<mat-card class="golden-card">
+  <mat-card-title>
+    <button
+      mat-flat-button
+      (click)="updateGolden()"
+      [matTooltip]="golden.goldenRepoPath"
+      [matTooltipPosition]="tooltipPosition"
+    >
       <mat-icon>save</mat-icon>
+      Update golden file
     </button>
-  </div>
-  <div>Repo file: {{ golden.goldenRepoPath }}</div>
+  </mat-card-title>
+  <mat-card-content>
+    @if (recordedMotion) {
+      <div class="golden-content">
+        <app-timeline-view
+          [recordedMotion]="recordedMotion"
+        ></app-timeline-view>
+      </div>
+    }
+  </mat-card-content>
+</mat-card>
 
-  @if (golden.filmstripUrl) {
-    <div class="screenshot-container">
-      <img class="screenshot" [src]="golden.filmstripUrl" />
+<div class="overlay">
+  <mat-card class="video-card" cdkDrag cdkDragBoundary=".overlay">
+    <mat-card-title class="header">
+      <div class="button-drag" cdkDragHandle>
+        <mat-icon class="drag-icon">drag_indicator</mat-icon>
+        Recording
+      </div>
+    </mat-card-title>
+    <div class="video-container" cdkDragHandle>
+      @if (recordedMotion?.videoSource) {
+        <app-video-view [source]="recordedMotion?.videoSource"></app-video-view>
+      } @else {
+        <p class="mat-body-2">No screen recording frame to show.</p>
+      }
     </div>
-  }
+  </mat-card>
 </div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
index 33d5d41a1..253f18bbc 100644
--- a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.scss
@@ -1,48 +1,74 @@
 :host {
+  padding: 24px;
   display: flex;
-  flex: 0 0 100%;
   flex-direction: column;
 }
 
-.wrapper {
-  position: relative;
-  margin: 16px;
-  padding: 16px;
+.golden-card {
+  mat-card-title {
+    margin: 16px;
+  }
+}
+
+.golden-content {
   display: flex;
-  flex-direction: column;
+  flex-direction: row;
 
-  border-radius: 12px;
-  border: 1px solid #c4c6d0;
+  app-timeline-view {
+    display: flex;
+    flex-direction: column;
+    flex-grow: 1;
+  }
 }
 
-.label {
-  position: absolute;
-  top: -12px;
-  padding: 0 16px;
-  background: var(--mat-app-background-color);
+.overlay {
+  z-index: 30;
+  position: fixed;
+  top: 0px;
+  left: 0px;
+  width: 100%;
+  height: 100%;
+  pointer-events: none;
 }
 
-img.screenshot {
-  width: fit-content;
+.video-card {
+  pointer-events: all;
+  width: max(250px, 15vw);
+  min-width: 165px;
+  resize: both;
+  overflow: hidden;
+  display: flex;
+  flex-direction: column;
+  padding: 0;
+  right: -50px;
+  top: 20vh;
 }
 
-.screenshot-container {
-  width: fit-content;
+.header {
+  display: flex;
+  flex-direction: row;
+  margin: 0px;
+  border: 1px solid var(--border-color);
+  border-radius: 4px;
+}
+.button-drag {
+  flex-grow: 1;
+  cursor: grab;
+  padding: 2px;
+}
 
-  border-radius: 8px;
-  background-color: black;
-  padding: 12px;
+.drag-icon {
+  float: left;
+  margin: 5px 0;
 }
-img.screenshot {
-  width: fit-content;
-  background-image: linear-gradient(45deg, #808080 25%, transparent 25%),
-    linear-gradient(-45deg, #808080 25%, transparent 25%),
-    linear-gradient(45deg, transparent 75%, #808080 75%),
-    linear-gradient(-45deg, transparent 75%, #808080 75%);
-  background-size: 20px 20px;
-  background-position:
-    0 0,
-    0 10px,
-    10px -10px,
-    -10px 0px;
+
+.video-container,
+app-video-view {
+  border: 1px solid var(--default-border);
+  width: 100%;
+  height: auto;
+  cursor: grab;
+  overflow: hidden;
+  min-width: 100px;
+  min-height: 100px;
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.ts b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.ts
index 244f37cb1..b8b582242 100644
--- a/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/motion-golden/motion-golden.component.ts
@@ -1,31 +1,77 @@
-import { Component, Input } from '@angular/core';
+import { Component, Input, OnChanges, SimpleChanges } from '@angular/core';
 import { MatButtonModule } from '@angular/material/button';
 import { MatIconModule } from '@angular/material/icon';
 import { MatSnackBar } from '@angular/material/snack-bar';
-import { finalize } from 'rxjs';
-
+import { filter, finalize } from 'rxjs';
+import { MatTooltipModule, TooltipPosition } from '@angular/material/tooltip';
 import { MotionGolden } from '../golden';
 import { GoldensService } from '../goldens.service';
+import { RecordedMotion } from '../recorded-motion';
+import { ProgressTracker } from '../../utils/progress';
+import { VideoViewComponent } from '../video-view/video-view.component';
+import { TimelineViewComponent } from '../timeline-view/timeline-view.component';
+import { MatToolbarModule } from '@angular/material/toolbar';
+import { VideoControlsComponent } from '../video-controls/video-controls.component';
+import { MatCardModule } from '@angular/material/card';
+import { DragDropModule } from '@angular/cdk/drag-drop';
 
 @Component({
   selector: 'app-motion-golden',
   standalone: true,
-  imports: [MatIconModule, MatButtonModule],
+  imports: [
+    MatIconModule,
+    MatButtonModule,
+    MatToolbarModule,
+    VideoControlsComponent,
+    MatTooltipModule,
+    VideoViewComponent,
+    MatCardModule,
+    TimelineViewComponent,
+    DragDropModule,
+  ],
   templateUrl: './motion-golden.component.html',
   styleUrl: './motion-golden.component.scss',
 })
-export class MotionGoldenComponent {
+export class MotionGoldenComponent implements OnChanges {
   constructor(
     private goldenService: GoldensService,
-    private _snackBar: MatSnackBar,
+    private snackBar: MatSnackBar,
+    private progressTracker: ProgressTracker,
   ) {}
 
   @Input() golden!: MotionGolden;
+  tooltipPosition: TooltipPosition = 'right';
+
+  recordedMotion: RecordedMotion | undefined;
+
+  private goldenChangeId = 0;
+  ngOnChanges(changes: SimpleChanges): void {
+    if (changes['golden']) {
+      this.goldenChangeId++;
+      if (this.golden) {
+        this.fetchRecordedMotion(this.golden, this.goldenChangeId);
+      } else {
+        this.recordedMotion = undefined;
+      }
+    }
+  }
+
+  fetchRecordedMotion(golden: MotionGolden, goldenChangeId: number): void {
+    this.progressTracker.beginProgress();
+    this.goldenService
+      .loadRecordedMotion(golden)
+      .pipe(
+        filter((_) => goldenChangeId === this.goldenChangeId),
+        finalize(() => this.progressTracker.endProgress()),
+      )
+      .subscribe((recordedMotion) => (this.recordedMotion = recordedMotion));
+  }
 
   updateGolden(): void {
+    this.progressTracker.beginProgress();
     this.goldenService
       .updateGolden(this.golden)
-      .pipe(finalize(() => {}))
-      .subscribe((_) => this._snackBar.open('updated'));
+      .pipe(finalize(() => this.progressTracker.endProgress()))
+      .subscribe((_) => this.snackBar.open('updated'));
   }
 }
diff --git a/tools/motion/motion_test_watcher_app/src/app/recorded-motion.ts b/tools/motion/motion_test_watcher_app/src/app/recorded-motion.ts
new file mode 100644
index 000000000..84d198782
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/recorded-motion.ts
@@ -0,0 +1,11 @@
+import { Feature } from './feature';
+import { Timeline } from './timeline';
+import { VideoSource } from './video-source';
+
+export class RecordedMotion {
+  constructor(
+    readonly videoSource: VideoSource,
+    readonly timeline: Timeline,
+    readonly features: ReadonlyArray<Feature>,
+  ) {}
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.html b/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.html
deleted file mode 100644
index 64442bec1..000000000
--- a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.html
+++ /dev/null
@@ -1,30 +0,0 @@
-<div class="wrapper">
-  <div class=".mat-app-background label">Screenshot Golden result</div>
-
-  <div class="toolbar">
-    <mat-button-toggle-group
-      [(ngModel)]="selectedImage"
-      aria-label="Favorite Color"
-    >
-      <mat-button-toggle value="actual">Actual</mat-button-toggle>
-
-      <mat-button-toggle value="diff" [disabled]="!golden.diffUrl"
-        >Diff</mat-button-toggle
-      >
-      <mat-button-toggle value="expected" [disabled]="!golden.expectedUrl"
-        >Expected</mat-button-toggle
-      >
-    </mat-button-toggle-group>
-
-    <button mat-icon-button (click)="updateGolden()">
-      <mat-icon>save</mat-icon>
-    </button>
-  </div>
-  <div>Repo file: {{ golden.goldenRepoPath }}</div>
-
-  @if (selectedImageUrl) {
-    <div class="screenshot-container">
-      <img class="screenshot" [src]="selectedImageUrl" />
-    </div>
-  }
-</div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.scss b/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.scss
deleted file mode 100644
index e2c473436..000000000
--- a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.scss
+++ /dev/null
@@ -1,44 +0,0 @@
-:host {
-  display: flex;
-  flex: 0 0 100%;
-  flex-direction: column;
-}
-
-.wrapper {
-  position: relative;
-  margin: 16px;
-  padding: 16px;
-  display: flex;
-  flex-direction: column;
-
-  border-radius: 12px;
-  border: 1px solid #c4c6d0;
-}
-
-.label {
-  position: absolute;
-  top: -12px;
-  padding: 0 16px;
-  background: var(--mat-app-background-color);
-}
-
-.screenshot-container {
-  width: fit-content;
-
-  border-radius: 8px;
-  background-color: black;
-  padding: 12px;
-}
-img.screenshot {
-  width: fit-content;
-  background-image: linear-gradient(45deg, #808080 25%, transparent 25%),
-    linear-gradient(-45deg, #808080 25%, transparent 25%),
-    linear-gradient(45deg, transparent 75%, #808080 75%),
-    linear-gradient(-45deg, transparent 75%, #808080 75%);
-  background-size: 20px 20px;
-  background-position:
-    0 0,
-    0 10px,
-    10px -10px,
-    -10px 0px;
-}
diff --git a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.ts b/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.ts
deleted file mode 100644
index c784680cd..000000000
--- a/tools/motion/motion_test_watcher_app/src/app/screenshot-golden/screenshot-golden.component.ts
+++ /dev/null
@@ -1,57 +0,0 @@
-import { Component, Input, OnChanges, SimpleChanges } from '@angular/core';
-import { FormsModule } from '@angular/forms';
-import { MatButtonModule } from '@angular/material/button';
-import { MatButtonToggleModule } from '@angular/material/button-toggle';
-import { MatIconModule } from '@angular/material/icon';
-import { MatSnackBar } from '@angular/material/snack-bar';
-import { finalize } from 'rxjs';
-
-import { ScreenshotGolden } from '../golden';
-import { GoldensService } from '../goldens.service';
-
-@Component({
-  selector: 'app-screenshot-golden',
-  standalone: true,
-  imports: [MatIconModule, MatButtonModule, MatButtonToggleModule, FormsModule],
-  templateUrl: './screenshot-golden.component.html',
-  styleUrl: './screenshot-golden.component.scss',
-})
-export class ScreenshotGoldenComponent implements OnChanges {
-  constructor(
-    private goldenService: GoldensService,
-    private _snackBar: MatSnackBar,
-  ) {}
-
-  @Input() golden!: ScreenshotGolden;
-
-  ngOnChanges(changes: SimpleChanges): void {
-    if (changes['golden']) {
-      if (
-        (this.selectedImage == 'diff' && !this.golden.diffUrl) ||
-        (this.selectedImage == 'expected' && !this.golden.expectedUrl)
-      ) {
-        this.selectedImage = 'actual';
-      }
-    }
-  }
-
-  selectedImage: 'actual' | 'diff' | 'expected' = 'actual';
-  get selectedImageUrl(): String | undefined {
-    switch (this.selectedImage) {
-      case 'actual':
-        return this.golden.actualUrl;
-      case 'diff':
-        return this.golden.diffUrl;
-      case 'expected':
-        return this.golden.expectedUrl;
-    }
-    return undefined;
-  }
-
-  updateGolden(): void {
-    this.goldenService
-      .updateGolden(this.golden)
-      .pipe(finalize(() => {}))
-      .subscribe((_) => this._snackBar.open('updated'));
-  }
-}
diff --git a/tools/motion/motion_test_watcher_app/src/app/test-overview/_test-overview-theme.scss b/tools/motion/motion_test_watcher_app/src/app/test-overview/_test-overview-theme.scss
new file mode 100644
index 000000000..b1cf64ec0
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/test-overview/_test-overview-theme.scss
@@ -0,0 +1,59 @@
+@use "sass:map";
+@use "@angular/material" as mat;
+
+@mixin color($theme) {
+  .contents {
+    background-color: mat.get-theme-color($theme, surface);
+    color: mat.get-theme-color($theme, on-surface);
+  }
+
+  .status {
+    background-color: mat.get-theme-color($theme, surface);
+    color: mat.get-theme-color($theme, on-surface);
+
+    &.passing {
+      background-color: green;
+      color: white;
+
+      mat-paginator {
+        background-color: transparent;
+        color: white;
+        --mat-paginator-disabled-icon-color: lightgreen;
+        --mat-paginator-enabled-icon-color: white;
+      }
+    }
+
+    &.failing {
+      background-color: mat.get-theme-color($theme, error);
+      color: mat.get-theme-color($theme, on-error);
+      mat-paginator {
+        background-color: transparent;
+        color: white;
+        --mat-paginator-disabled-icon-color: lightred;
+        --mat-paginator-enabled-icon-color: white;
+      }
+    }
+  }
+  .mat-mdc-row:hover {
+    background-color: mat.get-theme-color($theme, surface-bright);
+  }
+}
+
+@mixin typography($theme) {
+  .status {
+    font: mat.get-theme-typography($theme, label-large, font);
+  }
+
+  .mat-mdc-row.selected {
+    font: mat.get-theme-typography($theme, label-large, font);
+  }
+}
+
+@mixin theme($theme) {
+  @if mat.theme-has($theme, color) {
+    @include color($theme);
+  }
+  @if mat.theme-has($theme, typography) {
+    @include typography($theme);
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.html b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.html
index 5f57fb1f5..865e95ef6 100644
--- a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.html
+++ b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.html
@@ -1,32 +1,82 @@
-<div class="wrapper">
-  <div class=".mat-app-background label">
-    {{ passingTestCount }} of {{ totalTestCount }} test pass
-  </div>
-
-  <mat-selection-list
-    (selectionChange)="goldenSelected($event)"
-    [multiple]="false"
-  >
-    @for (golden of goldens; track golden.id) {
-      <mat-list-option [value]="golden.id">
-        {{ golden.label }}
-
-        @if (golden.updated) {
-          <span class="tag updated">UPDATED</span>
-        } @else {
-          <span class="tag {{ golden.result }}">{{ golden.result }}</span>
-        }
-      </mat-list-option>
+<div class="status {{ testStatusClass }}">
+  <div class="count">
+    @if (totalTestCount == 0) {
+      No tests results found
+    } @else if (failingTestCount > 0) {
+      {{ failingTestCount }} of {{ totalTestCount }} test fail
+    } @else if (passingTestCount == totalTestCount) {
+      All tests passed
+    } @else {
+      {{ passingTestCount }} of {{ totalTestCount }} test passed
     }
-  </mat-selection-list>
+  </div>
+  <div class="spacer"></div>
+  <mat-paginator [hidePageSize]="true" [pageSize]="5"></mat-paginator>
 </div>
 
-@if (selectedGolden?.type === "motion") {
-  <app-motion-golden [golden]="$any(selectedGolden)"></app-motion-golden>
-}
+<div class="contents">
+  @if (totalTestCount > 0) {
+    <table mat-table [dataSource]="dataSource" [fixedLayout]="true" matSort>
+      <ng-container matColumnDef="select">
+        <th mat-header-cell *matHeaderCellDef></th>
+        <td mat-cell *matCellDef="let golden">
+          <mat-radio-button
+            (click)="$event.stopPropagation()"
+            (change)="goldenSelected($event ? golden : null)"
+            [checked]="selectedGoldenId == golden.id"
+          >
+          </mat-radio-button>
+        </td>
+      </ng-container>
+
+      <ng-container matColumnDef="golden">
+        <th mat-header-cell *matHeaderCellDef>Golden</th>
+        <td mat-cell *matCellDef="let golden">
+          {{ golden.label }}
+        </td>
+      </ng-container>
+
+      <ng-container matColumnDef="status">
+        <th mat-header-cell *matHeaderCellDef mat-sort-header>Result</th>
+        <td mat-cell *matCellDef="let golden">
+          @if (golden.updated) {
+            <span class="tag updated">UPDATED</span>
+          } @else {
+            <span class="tag {{ golden.result }}">{{ golden.result }}</span>
+          }
+        </td>
+      </ng-container>
+
+      <ng-container matColumnDef="testClassName">
+        <th mat-header-cell *matHeaderCellDef mat-sort-header>Test Class</th>
+        <td mat-cell *matCellDef="let element">{{ element.testClassName }}</td>
+      </ng-container>
 
-@if (selectedGolden?.type === "screenshot") {
-  <app-screenshot-golden
-    [golden]="$any(selectedGolden)"
-  ></app-screenshot-golden>
-}
+      <ng-container matColumnDef="testMethodName">
+        <th mat-header-cell *matHeaderCellDef mat-sort-header>Test Method</th>
+        <td mat-cell *matCellDef="let element">{{ element.testMethodName }}</td>
+      </ng-container>
+
+      <ng-container matColumnDef="testTime">
+        <th mat-header-cell *matHeaderCellDef mat-sort-header>Test Time</th>
+        <td mat-cell *matCellDef="let element">{{ element.testTime }}</td>
+      </ng-container>
+
+      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
+      <tr
+        mat-row
+        (click)="goldenSelected(row)"
+        [class.selected]="selectedGolden == row"
+        *matRowDef="let row; columns: displayedColumns"
+      ></tr>
+
+      <tr class="mat-row" *matNoDataRow>
+        <td class="mat-cell" colspan="*"></td>
+      </tr>
+    </table>
+
+    @if (selectedGolden) {
+      <app-motion-golden [golden]="selectedGolden"></app-motion-golden>
+    }
+  }
+</div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.scss b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.scss
index f76f98a41..b69dffa74 100644
--- a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.scss
+++ b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.scss
@@ -4,22 +4,15 @@
   flex-direction: column;
 }
 
-.wrapper {
-  position: relative;
-  margin: 16px;
+.status {
   padding: 16px;
   display: flex;
-  flex-direction: column;
-
-  border-radius: 12px;
-  border: 1px solid #c4c6d0;
-}
+  flex-direction: row;
+  align-items: baseline;
 
-.label {
-  position: absolute;
-  top: -12px;
-  padding: 0 16px;
-  background: var(--mat-app-background-color);
+  .spacer {
+    flex-grow: 1;
+  }
 }
 
 .tag {
@@ -43,3 +36,10 @@
     background-color: red;
   }
 }
+
+.contents {
+  display: flex;
+  flex-direction: column;
+  flex-grow: 1;
+  overflow: overlay;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
index 328a13ab6..8cf3b7ef0 100644
--- a/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
+++ b/tools/motion/motion_test_watcher_app/src/app/test-overview/test-overview.component.ts
@@ -1,19 +1,78 @@
-import { Component, Input, OnChanges, SimpleChanges } from '@angular/core';
+import {
+  Component,
+  Input,
+  OnChanges,
+  AfterViewInit,
+  ViewChild,
+  SimpleChanges,
+} from '@angular/core';
 import { MatListModule, MatSelectionListChange } from '@angular/material/list';
 
-import { Golden } from '../golden';
+import { MotionGolden } from '../golden';
 import { MotionGoldenComponent } from '../motion-golden/motion-golden.component';
-import { ScreenshotGoldenComponent } from '../screenshot-golden/screenshot-golden.component';
+import { MatDividerModule } from '@angular/material/divider';
+
+import {
+  MatPaginator,
+  MatPaginatorModule,
+  PageEvent,
+} from '@angular/material/paginator';
+import { MatSort, MatSortModule } from '@angular/material/sort';
+import {
+  MatTableDataSource,
+  MatTable,
+  MatTableModule,
+} from '@angular/material/table';
+import { MatRadioModule } from '@angular/material/radio';
+import { MatButtonModule } from '@angular/material/button';
+import { MatIconModule } from '@angular/material/icon';
 
 @Component({
   selector: 'app-test-overview',
   standalone: true,
-  imports: [MatListModule, MotionGoldenComponent, ScreenshotGoldenComponent],
+  imports: [
+    MatListModule,
+    MotionGoldenComponent,
+    MatDividerModule,
+    MatTableModule,
+    MatRadioModule,
+    MatSortModule,
+    MatIconModule,
+    MatButtonModule,
+    MatPaginatorModule,
+  ],
   templateUrl: './test-overview.component.html',
   styleUrl: './test-overview.component.scss',
 })
-export class TestOverviewComponent implements OnChanges {
-  @Input() goldens: Golden[] = [];
+export class TestOverviewComponent implements OnChanges, AfterViewInit {
+  dataSource: MatTableDataSource<MotionGolden> = new MatTableDataSource();
+  displayedColumns: string[] = [
+    'select',
+    'status',
+    'golden',
+    'testClassName',
+    'testMethodName',
+    'testTime',
+  ];
+
+  constructor() {
+    this.dataSource.sortingDataAccessor = (data, sortHeaderIdstring) => {
+      console.log(sortHeaderIdstring);
+      switch (sortHeaderIdstring) {
+        case 'status':
+          return data.result;
+        case 'testClassName':
+          return data.testClassName;
+        case 'testMethodName':
+          return data.testMethodName;
+        case 'testTime':
+          return Date.parse(data.testTime);
+      }
+      return 0;
+    };
+  }
+
+  @Input() goldens: MotionGolden[] = [];
 
   totalTestCount = 0;
   passingTestCount = 0;
@@ -26,19 +85,34 @@ export class TestOverviewComponent implements OnChanges {
         (golden) => golden.result !== 'PASSED',
       ).length;
       this.passingTestCount = this.totalTestCount - this.failingTestCount;
+      this.dataSource.data = this.goldens;
     }
   }
-
+  @ViewChild(MatPaginator) paginator!: MatPaginator;
+  @ViewChild(MatSort) sort!: MatSort;
   get selectedGolden() {
     return this.goldens.find((it) => it.id == this.selectedGoldenId);
   }
 
-  selectedGoldenId: String | null = null;
+  ngAfterViewInit() {
+    this.dataSource.paginator = this.paginator;
+    this.dataSource.sort = this.sort;
+  }
+
+  get testStatusClass() {
+    if (this.failingTestCount > 0) {
+      return 'failing';
+    } else if (this.passingTestCount === this.totalTestCount) {
+      return 'passing';
+    } else {
+      return 'no-status';
+    }
+  }
+
+  selectedGoldenId: string | null = null;
 
-  goldenSelected(ev: MatSelectionListChange) {
-    const selection = ev.source.selectedOptions;
-    this.selectedGoldenId = selection.hasValue()
-      ? selection.selected[0].value
-      : null;
+  goldenSelected(golden: MotionGolden) {
+    this.selectedGoldenId =
+      golden.id !== this.selectedGoldenId ? golden.id : null;
   }
 }
diff --git a/samples/VirtualDeviceManager/virtualcamera/com.example.android.vdmdemo.virtualcamera.xml b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
similarity index 55%
rename from samples/VirtualDeviceManager/virtualcamera/com.example.android.vdmdemo.virtualcamera.xml
rename to tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
index 2e7b0b47a..50e8fdc5b 100644
--- a/samples/VirtualDeviceManager/virtualcamera/com.example.android.vdmdemo.virtualcamera.xml
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.html
@@ -1,6 +1,5 @@
-<?xml version="1.0" encoding="utf-8"?>
 <!--
-  ~ Copyright (C) 2023 The Android Open Source Project
+  ~ Copyright 2024 Google LLC
   ~
   ~ Licensed under the Apache License, Version 2.0 (the "License");
   ~ you may not use this file except in compliance with the License.
@@ -15,10 +14,5 @@
   ~ limitations under the License.
   -->
 
-<permissions>
-    <privapp-permissions package="com.example.android.vdmdemo.virtualcamera">
-        <permission name="android.permission.CREATE_VIRTUAL_DEVICE" />
-        <permission name="android.permission.REQUEST_COMPANION_SELF_MANAGED" />
-        <permission name="android.permission.REQUEST_COMPANION_PROFILE_APP_STREAMING" />
-    </privapp-permissions>
-</permissions>
\ No newline at end of file
+<div class="graph-container"><canvas #canvas></canvas></div>
+<div class="label" [style.left]="labelLeft">{{ feature.name }}</div>
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss
new file mode 100644
index 000000000..50d4e7d93
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.scss
@@ -0,0 +1,38 @@
+/*!
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+:host {
+  padding: 8px 0;
+}
+
+.label {
+  background-color: #e1e1e1 !important;
+  color: #212121;
+  border-radius: 32px;
+  margin-top: 48px;
+  margin-bottom: 8px;
+  display: inline-block;
+  padding: 4px 8px;
+  font-size: 12px;
+
+  position: relative;
+}
+
+.graph-container {
+  position: absolute;
+  height: 64px;
+  width: 100%;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts
new file mode 100644
index 000000000..4ed67780e
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/graph/graph.component.ts
@@ -0,0 +1,81 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {
+  Component,
+  ElementRef,
+  Input,
+  OnChanges,
+  SimpleChanges,
+  ViewChild,
+} from '@angular/core';
+import { checkNotNull } from '../../../utils/preconditions';
+import { VisualTimeline } from '../../visual-timeline';
+import { Feature } from '../../feature';
+
+@Component({
+  selector: 'app-graph',
+  standalone: true,
+  templateUrl: './graph.component.html',
+  styleUrls: ['./graph.component.scss'],
+})
+export class GraphComponent implements OnChanges {
+  constructor() {}
+
+  @ViewChild('canvas', { read: ElementRef })
+  canvas!: ElementRef<HTMLCanvasElement>;
+
+  @Input()
+  feature!: Feature;
+
+  @Input()
+  timeline!: VisualTimeline;
+
+  ngOnChanges(changes: SimpleChanges): void {
+    if (!this.canvas) return;
+    this._renderGraph();
+  }
+
+  updateCanvasSize(width: number) {
+    if (!this.canvas) return;
+
+    const canvasElement = this.canvas.nativeElement;
+
+    if (canvasElement.width == width) {
+      return;
+    }
+
+    canvasElement.width = width;
+    canvasElement.height = 64;
+    this._renderGraph();
+  }
+
+  get labelLeft() {
+    return 0;
+    // const ranges = this.feature?.property?.series?.activeRanges;
+    // return ranges && ranges.length && this.timeline
+    //   ? `${this.timeline.frameToPx(ranges[0].start)}px`
+    //   : 0;
+  }
+
+  private _renderGraph() {
+    this.feature.visualization.render(
+      this.timeline,
+      this.feature.dataPoints,
+      this.canvas.nativeElement,
+    );
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.html b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.html
new file mode 100644
index 000000000..ea1c57b6a
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.html
@@ -0,0 +1,34 @@
+<!--
+  ~ Copyright 2024 Google LLC
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<div class="timeline">
+  <canvas #canvas></canvas>
+  <div
+    id="handle"
+    cdkDrag
+    [cdkDragConstrainPosition]="computeTimeHandleSnap"
+    [cdkDragFreeDragPosition]="timeHandlePosition"
+    (cdkDragStarted)="onDragTimeHandleStart($event)"
+    (cdkDragReleased)="onDragTimeHandleEnd($event)"
+  ></div>
+  <div class="graph-viewport">
+    @for (feature of features; track feature.id) {
+      <app-graph [feature]="feature" [timeline]="visualTimeline!"></app-graph>
+    }
+  </div>
+</div>
+
+<app-video-controls [videoSource]="videoSource"></app-video-controls>
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss
new file mode 100644
index 000000000..4466853b4
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.scss
@@ -0,0 +1,54 @@
+/*!
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+:host {
+  display: flex;
+  flex-direction: column;
+}
+
+.timeline {
+  position: relative;
+  display: flex;
+  flex-grow: 1;
+}
+
+canvas {
+  position: absolute;
+}
+
+#handle {
+  position: absolute;
+  width: 1px;
+  background-color: red;
+  background-clip: padding-box;
+  border: 5px solid transparent;
+  border-bottom: 5px solid red;
+  top: 0;
+  bottom: 20px;
+  margin-left: -5px;
+  z-index: 3;
+}
+
+.graph-viewport {
+  display: flex;
+  flex-grow: 1;
+  margin-bottom: 24px;
+  flex-direction: column;
+}
+
+ui-graph {
+  display: flex;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts
new file mode 100644
index 000000000..e12cf0c3e
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline-view/timeline-view.component.ts
@@ -0,0 +1,298 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {
+  AfterViewChecked,
+  AfterViewInit,
+  Component,
+  ElementRef,
+  Input,
+  NgZone,
+  OnChanges,
+  OnDestroy,
+  QueryList,
+  SimpleChanges,
+  ViewChild,
+  ViewChildren,
+  ViewContainerRef,
+} from '@angular/core';
+import { checkNotNull } from '../../utils/preconditions';
+import {
+  CdkDrag,
+  CdkDragRelease,
+  CdkDragStart,
+  DragRef,
+  Point,
+} from '@angular/cdk/drag-drop';
+import { GraphComponent } from './graph/graph.component';
+import { VisualTimeline } from '../visual-timeline';
+import { Disposer } from '../../utils/disposer';
+import { RecordedMotion } from '../recorded-motion';
+import { VideoSource } from '../video-source';
+import { VideoControlsComponent } from '../video-controls/video-controls.component';
+import { Feature } from '../feature';
+
+@Component({
+  selector: 'app-timeline-view',
+  standalone: true,
+  imports: [GraphComponent, VideoControlsComponent, CdkDrag],
+
+  templateUrl: './timeline-view.component.html',
+  styleUrls: ['./timeline-view.component.scss'],
+})
+export class TimelineViewComponent
+  implements AfterViewInit, AfterViewChecked, OnDestroy, OnChanges
+{
+  private _recordingInputDisposer = new Disposer(true);
+
+  constructor(
+    private readonly viewRef: ViewContainerRef,
+    private zone: NgZone,
+  ) {}
+
+  ngOnDestroy(): void {
+    this._recordingInputDisposer.dispose();
+  }
+
+  private _observer = new ResizeObserver(() => {
+    this.zone.run(() => {
+      this._updateCanvasSize();
+    });
+  });
+
+  @ViewChildren(GraphComponent) graphs!: QueryList<GraphComponent>;
+
+  @ViewChild('canvas')
+  canvas!: ElementRef<HTMLCanvasElement>;
+
+  @Input()
+  recordedMotion: RecordedMotion | undefined;
+
+  ngOnChanges(changes: SimpleChanges): void {
+    if (changes['recordedMotion']) {
+      this.onRecordedMotionChanged();
+    }
+  }
+
+  get videoSource(): VideoSource | undefined {
+    return this.recordedMotion?.videoSource;
+  }
+  features: Feature[] = [];
+
+  onRecordedMotionChanged() {
+    this._recordingInputDisposer.dispose();
+
+    if (this.recordedMotion) {
+      this.visualTimeline = new VisualTimeline(
+        this.canvas?.nativeElement?.width ?? 1,
+        this.recordedMotion.timeline,
+      );
+      this.features = [...this.recordedMotion.features];
+
+      this._recordingInputDisposer.addListener(
+        this.recordedMotion.videoSource,
+        'timeupdate',
+        () => this._updatePlayHead(),
+      );
+    } else {
+      this.visualTimeline = undefined;
+      this.features = [];
+    }
+
+    this._scheduleRender();
+  }
+
+  visualTimeline?: VisualTimeline;
+
+  ngAfterViewInit() {
+    this._observer.observe(this.viewRef.element.nativeElement);
+    this.graphs.changes.subscribe((r) => {
+      const width = this.canvas.nativeElement.width;
+      this.graphs.forEach((graph) => graph.updateCanvasSize(width));
+    });
+    this._updateCanvasSize();
+  }
+
+  timeHandlePosition = { x: 0, y: 0 };
+
+  _isPlaying = false;
+
+  ngAfterViewChecked() {
+    const isPlaying = this.videoSource?.state === 'play';
+    if (isPlaying == this._isPlaying) return;
+
+    this._isPlaying = isPlaying;
+    if (isPlaying) {
+      const self = this;
+      function continuouslyUpdatePlayhead() {
+        self._updatePlayHead();
+        if (self._isPlaying) requestAnimationFrame(continuouslyUpdatePlayhead);
+      }
+      requestAnimationFrame(continuouslyUpdatePlayhead);
+    }
+  }
+
+  private _updatePlayHead() {
+    if (!this.visualTimeline || !this.videoSource) return;
+    const playheadX = this.visualTimeline.timeToPxClamped(
+      this.videoSource.currentTime,
+    );
+    if (isFinite(playheadX)) {
+      this.timeHandlePosition = { x: playheadX, y: 0 };
+    }
+  }
+
+  private _wasPlayingBeforeDrag = false;
+  onDragTimeHandleStart(event: CdkDragStart) {
+    this._wasPlayingBeforeDrag = this.videoSource?.state == 'play';
+    if (this._wasPlayingBeforeDrag) {
+      this.videoSource?.stop();
+    }
+  }
+
+  computeTimeHandleSnap = (
+    pos: Point,
+    dragRef: DragRef,
+    dimensions: ClientRect,
+    pickupPositionInElement: Point,
+  ) => {
+    if (!this.visualTimeline) return { x: 0, y: 0 };
+
+    const canvasBounds = this.canvas.nativeElement.getBoundingClientRect();
+
+    let frame = this.visualTimeline.pxToFrame(pos.x - canvasBounds.x);
+
+    if (frame === Number.NEGATIVE_INFINITY) frame = 0;
+    else if (frame === Number.POSITIVE_INFINITY)
+      frame = this.visualTimeline.timeline.frameCount;
+
+    if (this.videoSource) {
+      this.videoSource.seek(this.visualTimeline.timeline.frameToTime(frame));
+    }
+
+    return {
+      x: canvasBounds.x + this.visualTimeline.frameToPx(frame) - 5,
+      y: dimensions.y,
+    };
+  };
+
+  onDragTimeHandleEnd(event: CdkDragRelease) {
+    if (this._wasPlayingBeforeDrag) {
+      this.videoSource?.play();
+    }
+  }
+
+  private _updateCanvasSize() {
+    const canvasElement = this.canvas.nativeElement;
+    const parentElement = checkNotNull(this.canvas.nativeElement.parentElement);
+    const height = parentElement.clientHeight;
+    const width = parentElement.clientWidth;
+    if (canvasElement.width == width && canvasElement.height == height) {
+      return;
+    }
+
+    canvasElement.width = width;
+    canvasElement.height = height;
+    if (this.visualTimeline) {
+      this.visualTimeline.width = width;
+    }
+    this._render();
+    this._updatePlayHead();
+
+    this.graphs.forEach((graph) => graph.updateCanvasSize(width));
+  }
+
+  private _scheduledRender?: number;
+  private _scheduleRender() {
+    if (this._scheduledRender) return;
+
+    this._scheduledRender = requestAnimationFrame(() => {
+      this._render();
+      this._scheduledRender = undefined;
+    });
+  }
+
+  private _render() {
+    const ctx = checkNotNull(this.canvas.nativeElement.getContext('2d'));
+    const { width, height } = ctx.canvas;
+
+    const minMinorGap = 10;
+    const minMajorGap = 50;
+
+    ctx.clearRect(0, 0, width, height);
+    if (!this.recordedMotion) return;
+
+    const timeline = this.recordedMotion.timeline;
+    const framesCount = timeline.frameCount;
+
+    const maxMinorTicks = Math.min(
+      Math.floor(width / minMinorGap),
+      framesCount,
+    );
+
+    const minorGap = width / maxMinorTicks;
+
+    ctx.beginPath();
+    for (let x = 0.5 + minorGap; x <= width; x += minorGap) {
+      // Adding the gap skips the initial line at 0
+      const xr = Math.round(x);
+      let nx;
+
+      if (xr >= x) {
+        nx = xr - 0.5;
+      } else {
+        nx = xr + 0.5;
+      }
+      ctx.moveTo(nx, 0);
+      ctx.lineTo(nx, height - 20);
+    }
+
+    ctx.strokeStyle = '#EEEEEE';
+    ctx.lineWidth = 1;
+    ctx.stroke();
+
+    const majorGap = Math.max(2, Math.floor(minMajorGap / minorGap)) * minorGap;
+
+    ctx.strokeStyle = '#DDDDDD';
+    ctx.fillStyle = '#222222';
+    ctx.lineWidth = 2;
+
+    ctx.beginPath();
+    for (let x = majorGap; x < width; x += majorGap) {
+      // Adding the gap skips the initial line at 0
+      const xr = Math.round(x);
+
+      ctx.moveTo(xr, 0);
+      ctx.lineTo(xr, height - 15);
+
+      const frameNo = Math.floor((x / width) * framesCount);
+      const frameLabel = timeline.frameLabels[frameNo];
+
+      ctx.textAlign = 'center';
+      ctx.fillText(frameLabel, xr, height - 5);
+    }
+
+    // Always draw start
+    ctx.moveTo(1, 0);
+    ctx.lineTo(1, height - 15);
+
+    // Always draw end
+    ctx.moveTo(width - 1, 0);
+    ctx.lineTo(width - 1, height - 15);
+
+    ctx.stroke();
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/timeline.ts b/tools/motion/motion_test_watcher_app/src/app/timeline.ts
new file mode 100644
index 000000000..5574834db
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/timeline.ts
@@ -0,0 +1,107 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+// golden recordings from motion tests produces frames at exactly 16ms each
+const frameDuration = 0.016;
+
+/** Maps frame time to frame number and vice versa. */
+export class Timeline {
+  /** Duration , represented as a double-precision floating-point value in seconds. */
+  readonly duration: number;
+  /**
+   * The labels of all
+   */
+  readonly frameLabels: ReadonlyArray<string>;
+  readonly frameTimes: ReadonlyArray<number>;
+
+  constructor(frameIds: ReadonlyArray<string | number>) {
+    this.frameLabels = frameIds.map((it) =>
+      typeof it === 'string' ? it : `${it}ms`,
+    );
+
+    let lastFrameTime = 0;
+
+    const frameTimes = [lastFrameTime];
+
+    for (let i = 0; i < frameIds.length - 1; i++) {
+      const thisFrame = frameIds[i];
+      const nextFrame = frameIds[i + 1];
+
+      if (typeof thisFrame === 'number' && typeof nextFrame === 'number') {
+        lastFrameTime += (nextFrame - thisFrame) / 1000;
+      } else {
+        lastFrameTime += frameDuration;
+      }
+      frameTimes.push(lastFrameTime);
+    }
+    this.frameTimes = frameTimes;
+
+    this.duration = frameTimes[frameTimes.length - 1] + frameDuration;
+  }
+
+  /** Number of frames in this timeline. */
+  get frameCount(): number {
+    return this.frameLabels.length;
+  }
+
+  /**
+   * Compute the frame number associated the time in seconds.
+   *
+   * Each frame starts at the frame time, and just before the next frame's start time, or duration
+   * if it's the last frame.
+   */
+  timeToFrame(timeSeconds: number): number {
+    if (timeSeconds < 0) return Number.NEGATIVE_INFINITY;
+    if (timeSeconds >= this.duration) return Number.POSITIVE_INFINITY;
+
+    const frameTimes = this.frameTimes;
+
+    let start = 0;
+    let end = frameTimes.length - 1;
+
+    while (start <= end) {
+      let mid = (start + end) >> 1;
+
+      if (frameTimes[mid] === timeSeconds) {
+        return mid;
+      }
+
+      if (timeSeconds < frameTimes[mid]) {
+        end = mid - 1;
+      } else {
+        start = mid + 1;
+      }
+    }
+
+    return end;
+  }
+
+  /**
+   * Start time of the frame with `frameNumber`.
+   */
+  frameToTime(frameNumber: number): number {
+    frameNumber = Math.floor(frameNumber);
+    if (frameNumber < 0) return Number.NEGATIVE_INFINITY;
+    const frameTimes = this.frameTimes;
+    if (frameNumber >= frameTimes.length) return Number.POSITIVE_INFINITY;
+
+    return frameTimes[frameNumber];
+  }
+
+  clampTimeToFrame(timeSeconds: number): number {
+    return this.frameToTime(this.timeToFrame(timeSeconds));
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.html b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.html
new file mode 100644
index 000000000..4b1dd113f
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.html
@@ -0,0 +1,42 @@
+<!--
+  ~ Copyright 2024 Google LLC
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<div class="toolbar">
+  <button mat-icon-button (click)="togglePlay()">
+    <mat-icon>{{ playStateIcon }}</mat-icon>
+  </button>
+
+  <div class="spacer"></div>
+  <div class="playbackRate">
+    <button mat-button [matMenuTriggerFor]="playbackRateMenu">
+      <mat-icon>speed</mat-icon>
+      {{ formatPlaybackRateLabel(playbackRate) }}
+    </button>
+
+    <mat-menu #playbackRateMenu="matMenu">
+      @for (rate of playbackRateOptions; track $index) {
+        <button mat-menu-item (click)="setPlaybackRate(rate)">
+          <span>{{ formatPlaybackRateLabel(rate) }}</span>
+        </button>
+      }
+    </mat-menu>
+  </div>
+
+  <button mat-icon-button (click)="toggleRepeat()" class="repeat">
+    <mat-icon>{{ repeatStateIcon }}</mat-icon>
+  </button>
+</div>
+<ng-keyboard-shortcuts [shortcuts]="shortcuts"></ng-keyboard-shortcuts>
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.scss b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.scss
new file mode 100644
index 000000000..5137c503a
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.scss
@@ -0,0 +1,28 @@
+/*!
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+.toolbar {
+  display: flex;
+  flex-direction: row;
+  gap: 16px;
+}
+
+.playbackRate,
+.loop {
+  display: flex;
+  align-items: center;
+  gap: 8px;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.ts b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.ts
new file mode 100644
index 000000000..2c05808f5
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-controls/video-controls.component.ts
@@ -0,0 +1,142 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { Component, Input, OnDestroy } from '@angular/core';
+import { MatButtonModule } from '@angular/material/button';
+import { MatIconModule } from '@angular/material/icon';
+import { MatMenuModule } from '@angular/material/menu';
+import { Disposer } from '../../utils/disposer';
+import { checkNotNull } from '../../utils/preconditions';
+import { Preferences } from '../../utils/preferences';
+import { VideoSource } from '../video-source';
+import {
+  KeyboardShortcutsModule,
+  ShortcutEventOutput,
+  ShortcutInput,
+} from 'ng-keyboard-shortcuts';
+
+@Component({
+  selector: 'app-video-controls',
+  standalone: true,
+  imports: [
+    MatIconModule,
+    MatButtonModule,
+    MatMenuModule,
+    KeyboardShortcutsModule,
+  ],
+
+  templateUrl: './video-controls.component.html',
+  styleUrls: ['./video-controls.component.scss'],
+})
+export class VideoControlsComponent implements OnDestroy {
+  private _disposer = new Disposer();
+
+  private _source?: VideoSource;
+  private _sourceDisposer = new Disposer(true);
+
+  constructor(private _preferences: Preferences) {}
+
+  @Input()
+  set videoSource(newSource: VideoSource | undefined) {
+    if (this._source === newSource) return;
+
+    this._sourceDisposer.dispose();
+    this._source = newSource;
+    if (this._source) {
+      this._source.loop = this._preferences.loopVideo;
+      this._source.playbackRate = this._preferences.playbackRate;
+    }
+  }
+
+  ngOnDestroy(): void {
+    this._disposer.dispose();
+  }
+
+  get playStateIcon() {
+    return this._source?.state == 'play' ? 'pause' : 'play_arrow';
+  }
+
+  moveFrame(framesOffset: number) {
+    const videoSource = checkNotNull(this._source);
+    const timeline = videoSource.timeline;
+    videoSource.stop();
+
+    const currentTime = videoSource.currentTime;
+    const thisFrame = timeline.timeToFrame(currentTime);
+
+    const nextFrame = Math.min(
+      Math.max(thisFrame + framesOffset, 0),
+      timeline.frameCount - 1,
+    );
+
+    const targetTime = timeline.frameToTime(nextFrame) + 0.008;
+
+    return videoSource.seek(targetTime);
+  }
+
+  togglePlay() {
+    const videoSource = checkNotNull(this._source);
+    if (videoSource.state == 'play') {
+      videoSource.stop();
+    } else {
+      videoSource.play();
+    }
+  }
+
+  get repeatStateIcon() {
+    return this._preferences.loopVideo ? 'repeat_on' : 'repeat';
+  }
+
+  toggleRepeat() {
+    const loopVideo = !this._preferences.loopVideo;
+    this._preferences.loopVideo = loopVideo;
+    checkNotNull(this._source).loop = loopVideo;
+  }
+
+  playbackRateOptions: number[] = [1, 0.5, 0.25, 0.125];
+
+  get playbackRate() {
+    return this._preferences.playbackRate;
+  }
+
+  formatPlaybackRateLabel(rate: number): string {
+    return `${rate}x`;
+  }
+
+  setPlaybackRate(rate: number) {
+    this._preferences.playbackRate = rate;
+    checkNotNull(this._source).playbackRate = rate;
+  }
+  shortcuts: ShortcutInput[] = [
+    {
+      key: ['left'],
+      label: 'Previous frame',
+      command: (output: ShortcutEventOutput) => this.moveFrame(-1),
+    },
+
+    {
+      key: ['right'],
+      label: 'Next frame',
+      command: (output: ShortcutEventOutput) => this.moveFrame(+1),
+    },
+
+    {
+      key: ['space'],
+      label: 'play/pause',
+      command: (output: ShortcutEventOutput) => this.togglePlay(),
+    },
+  ];
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-source.ts b/tools/motion/motion_test_watcher_app/src/app/video-source.ts
new file mode 100644
index 000000000..8bcd623f6
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-source.ts
@@ -0,0 +1,148 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { Disposable, Disposer } from '../utils/disposer';
+import { checkNotNull } from '../utils/preconditions';
+import { Deferred } from '../utils/utils';
+import { Timeline } from './timeline';
+
+export type VideoSourceState = 'stop' | 'play' | 'seek';
+
+export class VideoSource
+  extends EventTarget
+  implements VideoSource, Disposable
+{
+  readonly seekable = true;
+  private _videoElement: HTMLVideoElement | null = null;
+
+  constructor(
+    recordingUrl: string,
+    readonly timeline: Timeline,
+  ) {
+    super();
+    const videoElement = document.createElement('video');
+    videoElement.muted = true;
+    videoElement.src = recordingUrl;
+    videoElement.addEventListener('timeupdate', (e) => {
+      this.dispatchEvent(new Event('timeupdate'));
+    }),
+      videoElement.addEventListener('resize', (e) =>
+        this.dispatchEvent(new Event('metadata-changed')),
+      );
+
+    this._videoElement = videoElement;
+  }
+
+  drawCurrentFrame(ctx: CanvasRenderingContext2D): void {
+    if (!this._videoElement) return;
+    ctx.drawImage(
+      this._videoElement,
+      0,
+      0,
+      ctx.canvas.width,
+      ctx.canvas.height,
+    );
+  }
+
+  get width(): number {
+    return this._videoElement?.videoWidth ?? 0;
+  }
+
+  get height(): number {
+    return this._videoElement?.videoHeight ?? 0;
+  }
+
+  get loop(): boolean {
+    return this._videoElement?.loop ?? false;
+  }
+
+  set loop(value: boolean) {
+    checkNotNull(this._videoElement).loop = value;
+  }
+
+  get playbackRate(): number {
+    return this._videoElement?.playbackRate ?? 1;
+  }
+
+  set playbackRate(value: number) {
+    checkNotNull(this._videoElement).playbackRate = value;
+  }
+
+  get state() {
+    if (!this._videoElement) return 'stop';
+    if (this._currentSeekPromise) return 'seek';
+    if (this._videoElement.paused) return 'stop';
+    if (this._videoElement.ended) return 'stop';
+
+    return 'play';
+  }
+
+  async play(): Promise<void> {
+    this._videoElement?.play();
+  }
+
+  async stop(): Promise<void> {
+    this._videoElement?.pause();
+    this._cancelSeek();
+  }
+
+  dispose(): void {
+    this._cancelSeek();
+    if (this._videoElement) {
+      this._videoElement.pause();
+      URL.revokeObjectURL(this._videoElement.src);
+      this._videoElement.src = '';
+    }
+  }
+
+  get currentTime() {
+    return this._videoElement?.currentTime ?? 0;
+  }
+
+  _currentSeekPromise: Deferred<boolean> | null = null;
+
+  async seek(time: number): Promise<boolean> {
+    if (!this._videoElement) return false;
+
+    this._cancelSeek();
+
+    if (this._videoElement.currentTime == time) return true;
+
+    const currentSeekPromise = new Deferred<boolean>();
+    this._currentSeekPromise = currentSeekPromise;
+
+    const seekSetup = new Disposer();
+    seekSetup.addListener(this._videoElement, 'seeked', () => {
+      currentSeekPromise.resolve(true);
+    });
+
+    this._videoElement.currentTime = time;
+
+    try {
+      return await currentSeekPromise;
+    } finally {
+      seekSetup.dispose();
+      if (this._currentSeekPromise == currentSeekPromise) {
+        this._currentSeekPromise = null;
+      }
+    }
+  }
+
+  private _cancelSeek() {
+    this._currentSeekPromise?.resolve(false);
+    this._currentSeekPromise = null;
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.html b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.html
new file mode 100644
index 000000000..2a51499b7
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.html
@@ -0,0 +1,7 @@
+@if (source) {
+  <div #container class="canvas-container">
+    <canvas #canvas></canvas>
+  </div>
+} @else {
+  <div class="no-source" label="No video source!"></div>
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.scss b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.scss
new file mode 100644
index 000000000..a728561d1
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.scss
@@ -0,0 +1,43 @@
+/*!
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+:host {
+  display: flex;
+  flex-grow: 1;
+  flex-direction: column;
+  justify-content: center;
+  align-items: stretch;
+}
+
+.canvas-container {
+  display: flex;
+  flex-direction: column;
+  flex-grow: 1;
+  overflow: hidden;
+
+  align-content: center;
+  justify-items: center;
+}
+
+canvas {
+  height: fit-content;
+  width: auto;
+}
+
+.no-source {
+  align-self: center;
+  font-size: 96px;
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.ts b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.ts
new file mode 100644
index 000000000..4a33f2e29
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/video-view/video-view.component.ts
@@ -0,0 +1,129 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {
+  AfterViewInit,
+  Component,
+  ElementRef,
+  Input,
+  NgZone,
+  OnDestroy,
+  ViewChild,
+} from '@angular/core';
+import { VideoSource } from '../video-source';
+import { Disposer } from '../../utils/disposer';
+import { checkNotNull } from '../../utils/preconditions';
+
+@Component({
+  selector: 'app-video-view',
+  standalone: true,
+  templateUrl: './video-view.component.html',
+  styleUrls: ['./video-view.component.scss'],
+})
+export class VideoViewComponent implements AfterViewInit, OnDestroy {
+  private _source?: VideoSource;
+  private _sourceDisposer = new Disposer(true);
+
+  private _observerDisposer = new Disposer(true);
+  private _observer = new ResizeObserver(() => {
+    this.zone.run(() => {
+      this.updateVideoSize();
+    });
+  });
+
+  constructor(private zone: NgZone) {}
+
+  private _container?: ElementRef<HTMLDivElement>;
+
+  @ViewChild('container', { read: ElementRef })
+  set container(value: ElementRef<HTMLDivElement> | undefined) {
+    this._observerDisposer.dispose();
+
+    this._container = value;
+
+    if (this._container) {
+      const containerElement = this._container.nativeElement;
+      this._observer.observe(containerElement);
+      this._observerDisposer.addFunction(() => {
+        this._observer.unobserve(containerElement);
+      });
+      this.updateVideoSize();
+    }
+  }
+
+  @ViewChild('canvas', { read: ElementRef })
+  canvas?: ElementRef<HTMLCanvasElement>;
+
+  @Input()
+  set source(newSource: VideoSource | undefined) {
+    if (this._source === newSource) return;
+
+    this._sourceDisposer.dispose();
+    this._source = newSource;
+    this.updateVideoSize();
+
+    if (newSource) {
+      newSource.play();
+      this._sourceDisposer.addListener(newSource, `metadata-changed`, () => {
+        this.updateVideoSize();
+      });
+      requestAnimationFrame(() => this._onFrameAvailable());
+    }
+  }
+
+  get source() {
+    return this._source;
+  }
+
+  ngAfterViewInit(): void {
+    this.updateVideoSize();
+  }
+
+  ngOnDestroy() {
+    this._observerDisposer.dispose();
+  }
+
+  updateVideoSize() {
+    if (!this.canvas) return;
+    const canvasElement = this.canvas.nativeElement;
+    if (!this._container || !this._source) {
+      canvasElement.width = canvasElement.height = 0;
+      return;
+    }
+
+    // Determine the scaling ratio for both, witdth and height, to fit the video into the container.
+    const widthScale =
+      this._container.nativeElement.clientWidth / this._source.width;
+    const heightScale =
+      this._container.nativeElement.clientHeight / this._source.height;
+    // Pick the smaller scale factor to ensure both width and height will fit, however do not allow
+    // scaling up.
+    const scale = Math.min(widthScale, heightScale, 1);
+
+    canvasElement.width = this._source.width * scale;
+    canvasElement.height = this._source.height * scale;
+
+    this._source.drawCurrentFrame(checkNotNull(canvasElement.getContext('2d')));
+  }
+
+  _onFrameAvailable() {
+    if (!this._source) return;
+
+    const canvasElement = this.canvas?.nativeElement?.getContext('2d');
+    this._source.drawCurrentFrame(checkNotNull(canvasElement));
+    requestAnimationFrame(() => this._onFrameAvailable());
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/visual-timeline.ts b/tools/motion/motion_test_watcher_app/src/app/visual-timeline.ts
new file mode 100644
index 000000000..e20c7e9e4
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/visual-timeline.ts
@@ -0,0 +1,84 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { Timeline } from './timeline';
+
+/** Translates pixel values to frames / video timestamps, and vice-versa. */
+export class VisualTimeline extends EventTarget {
+  constructor(
+    width: number,
+    public readonly timeline: Timeline,
+  ) {
+    super();
+    this._width = width;
+  }
+
+  private _width: number;
+
+  get width(): number {
+    return this._width;
+  }
+
+  /**
+   * Pixel-width of the interaction area.
+   *
+   * `0`px  `0`s, while `width`px  the duration.
+   */
+  set width(value: number) {
+    if (value == this._width) return;
+    this._width = value;
+    this.dispatchEvent(new Event('timeline-changed'));
+  }
+
+  /** Pixel-value that marks the given time. */
+  timeToPx(timeSeconds: number): number {
+    if (timeSeconds < 0) return Number.NEGATIVE_INFINITY;
+    const duration = this.timeline.duration;
+    if (timeSeconds > duration) return Number.POSITIVE_INFINITY;
+
+    return this.width * (timeSeconds / duration);
+  }
+
+  /** Pixel-value that marks the given time. */
+  timeToPxClamped(timeSeconds: number): number {
+    if (timeSeconds < 0) return Number.NEGATIVE_INFINITY;
+    const duration = this.timeline.duration;
+    if (timeSeconds > duration) return Number.POSITIVE_INFINITY;
+
+    return (
+      this.width * (this.timeline.clampTimeToFrame(timeSeconds) / duration)
+    );
+  }
+
+  /** Pixel-value that marks the beginning of the given frame. */
+  frameToPx(frame: number): number {
+    return this.timeToPx(this.timeline.frameToTime(frame));
+  }
+
+  /** Video-time associated with the given pixel value. */
+  pxToTime(px: number): number {
+    if (px < 0) return Number.NEGATIVE_INFINITY;
+    const width = this.width;
+    if (px > width) return Number.POSITIVE_INFINITY;
+
+    return this.timeline.duration * (px / width);
+  }
+
+  /** Frame number associated with the given pixel value. */
+  pxToFrame(px: number): number {
+    return this.timeline.timeToFrame(this.pxToTime(px));
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/app/visualization.ts b/tools/motion/motion_test_watcher_app/src/app/visualization.ts
new file mode 100644
index 000000000..c359d2f6d
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/app/visualization.ts
@@ -0,0 +1,156 @@
+import { checkArgument, checkNotNull } from '../utils/preconditions';
+import { DataPoint, isNotFound } from './golden';
+import { VisualTimeline } from './visual-timeline';
+
+export interface Visualization {
+  render(
+    timeline: VisualTimeline,
+    dataPoints: Array<DataPoint>,
+    canvas: HTMLCanvasElement,
+  ): void;
+}
+
+const PROBE_COLORS = [
+  '#E51C23',
+  '#9C27B0',
+  '#5677FC',
+  '#00BCD4',
+  '#259B24',
+  '#CDDC39',
+  '#FFC107',
+  '#795548',
+  '#737373',
+];
+
+function lighten(hex: string): string {
+  hex = hex.replace(/[^0-9A-F]/gi, '');
+  var bigint = parseInt(hex, 16);
+  var r = (bigint >> 16) & 255;
+  var g = (bigint >> 8) & 255;
+  var b = bigint & 255;
+
+  return 'rgba(' + r + ',' + g + ',' + b + ',0.15)';
+}
+
+export class LineGraphVisualization implements Visualization {
+  color: string = PROBE_COLORS[0];
+  fillColor: string = lighten(this.color);
+
+  constructor(
+    public minValue: number,
+    public maxValue: number,
+  ) {
+    checkArgument(
+      minValue < maxValue,
+      `minValue ${minValue} >= maxValue ${maxValue}`,
+    );
+  }
+
+  render(
+    timeline: VisualTimeline,
+    dataPoints: Array<DataPoint>,
+    canvas: HTMLCanvasElement,
+  ) {
+    const cw = canvas.width;
+    const ch = 30;
+
+    const ctx = checkNotNull(canvas.getContext('2d'));
+    ctx.clearRect(0, 0, cw, canvas.height);
+
+    const min = this.minValue;
+    const max = this.maxValue;
+    const color = this.color;
+
+    for (let i = 0; i < dataPoints.length; i++) {
+      if (isNotFound(dataPoints[i])) {
+        continue;
+      }
+      const start = i;
+
+      while (i < dataPoints.length && !isNotFound(dataPoints[i])) {
+        i++;
+      }
+      const end = i;
+
+      const bottomLineWidth = 2;
+      // solid bottom line
+      ctx.fillStyle = color;
+      ctx.arc(
+        timeline.frameToPx(start),
+        ch - bottomLineWidth / 2,
+        5,
+        0,
+        2 * Math.PI,
+      );
+      ctx.arc(
+        timeline.frameToPx(end - 1),
+        ch - bottomLineWidth / 2,
+        5,
+        0,
+        2 * Math.PI,
+      );
+      ctx.fill();
+
+      ctx.save();
+      try {
+        ctx.fillStyle = this.fillColor;
+        ctx.beginPath();
+        ctx.moveTo(timeline.frameToPx(start), ch - bottomLineWidth);
+        for (let i = start; i < end; i++) {
+          const value = dataPoints.at(i);
+          if (typeof value !== 'number') {
+            continue;
+          }
+          ctx.lineTo(
+            timeline.frameToPx(i),
+            (1 - (value - min) / (max - min)) * ch,
+          );
+        }
+        ctx.lineTo(timeline.frameToPx(end - 1), ch - bottomLineWidth);
+        ctx.fill();
+      } finally {
+        ctx.restore();
+      }
+
+      ctx.beginPath();
+      ctx.strokeStyle = color;
+      ctx.lineWidth = bottomLineWidth;
+
+      ctx.moveTo(timeline.frameToPx(start), ch - bottomLineWidth / 2);
+      ctx.lineTo(timeline.frameToPx(end - 1), ch - bottomLineWidth / 2);
+
+      ctx.stroke();
+    }
+  }
+}
+
+export class DataPointVisualization implements Visualization {
+  color: string = PROBE_COLORS[0];
+
+  render(
+    timeline: VisualTimeline,
+    dataPoints: Array<DataPoint>,
+    canvas: HTMLCanvasElement,
+  ) {
+    const cw = canvas.width;
+
+    const ctx = checkNotNull(canvas.getContext('2d'));
+    ctx.clearRect(0, 0, cw, canvas.height);
+
+    ctx.fillStyle = this.color;
+
+    dataPoints.forEach((dataPoint, idx) => {
+      if (isNotFound(dataPoint)) return;
+      ctx.beginPath();
+
+      ctx.arc(
+        /* x */ timeline.frameToPx(idx),
+        /* y */ 15,
+        /* radius */ 5,
+        /* startAngle */ 0,
+        /* endAngle */ 2 * Math.PI,
+      );
+      ctx.fill();
+    });
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/styles.scss b/tools/motion/motion_test_watcher_app/src/styles.scss
index 5256e9abb..4fee8b693 100644
--- a/tools/motion/motion_test_watcher_app/src/styles.scss
+++ b/tools/motion/motion_test_watcher_app/src/styles.scss
@@ -1,4 +1,24 @@
-/* You can add global styles to this file, and also import other style files */
+@use "@angular/material" as mat;
+@use "./app/test-overview/test-overview-theme" as test-overview;
+@use "./app/motion-golden/theme" as golden;
+
+$theme: mat.define-theme(
+  (
+    color: (
+      theme-type: light,
+      primary: mat.$rose-palette,
+      tertiary: mat.$red-palette,
+    ),
+  )
+);
+
+@include mat.core();
+
+html {
+  @include mat.all-component-themes($theme);
+  @include test-overview.theme($theme);
+  @include golden.theme($theme);
+}
 
 html,
 body {
@@ -6,5 +26,4 @@ body {
 }
 body {
   margin: 0;
-  font-family: Roboto, "Helvetica Neue", sans-serif;
 }
diff --git a/tools/motion/motion_test_watcher_app/src/utils/disposer.ts b/tools/motion/motion_test_watcher_app/src/utils/disposer.ts
new file mode 100644
index 000000000..b8f72aae4
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/disposer.ts
@@ -0,0 +1,100 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+/** Function type to be invoked when a disposer clear. */
+export type DisposableFn = () => void;
+
+/** Objects disposable with an `Disposer`. */
+export interface Disposable {
+  dispose(): void;
+}
+
+/**
+ * Tracks cleanup code and runs it upon calling `dispose`.
+ *
+ * By default, the disposer must not be used after it has been disposed. This
+ * helps avoid memory leaks by preventing accidental registration of cleanup
+ * code. Create the Disposer with `multiShot` set to
+ */
+export class Disposer implements Disposable {
+  // null after a one-shot disposer was disposed.
+  private _disposables?: Array<DisposableFn> = [];
+
+  /**
+   * @param multiShot Whether the disposer can be used for multiple dispose
+   * cycles.
+   */
+  constructor(private multiShot: boolean = false) {}
+
+  /**
+   * Registers the function to be called upon `dispose()`.
+   *
+   * Must not be called on a one-shot Disposer after it has been disposed.
+   */
+  addFunction(disposable: DisposableFn) {
+    if (!this._disposables) {
+      throw new Error(
+        'Adding new disposabled to already disposed one-shot disposer',
+      );
+    }
+    this._disposables!.push(disposable);
+  }
+
+  /**
+   * Registers the listener at the `eventTarget` and unregisters it upon
+   * `dispose()`.
+   *
+   * Must not be called on a one-shot Disposer after it has been disposed.
+   */
+  addListener(
+    eventTarget: EventTarget,
+    type: string,
+    callback: EventListenerOrEventListenerObject,
+    options?: AddEventListenerOptions | boolean,
+  ) {
+    this.addFunction(() =>
+      eventTarget.removeEventListener(type, callback, options),
+    );
+    eventTarget.addEventListener(type, callback, options);
+  }
+
+  /**
+   * Registers the Disposable to be cleaned up upon `dispose()`.
+   *
+   * Must not be called on a one-shot Disposer after it has been disposed.
+   */
+  addDisposable(disposable: Disposable) {
+    this.addFunction(disposable.dispose.bind(disposable));
+  }
+
+  /**
+   * Disposes all registered cleanup code.
+   *
+   * Must be called exactly once for one-shot Disposers, or at least once for
+   * multi-shot disposers.
+   */
+  dispose(): void {
+    if (!this._disposables) {
+      throw new Error('dispose() an already disposed one-shot disposer.');
+    }
+
+    const toDispose = this._disposables;
+    this._disposables = this.multiShot ? [] : undefined;
+    for (const disposable of toDispose) {
+      disposable();
+    }
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/utils/preconditions.ts b/tools/motion/motion_test_watcher_app/src/utils/preconditions.ts
new file mode 100644
index 000000000..f2308a49a
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/preconditions.ts
@@ -0,0 +1,49 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+/**
+ * Ensures the truth of an expression involving one or more parameters to the
+ * calling method.
+ */
+export function checkArgument(condition: boolean, message?: string) {
+  if (!condition) {
+    throw new Error(`Invalid argument [detail: ${message}]`);
+  }
+}
+
+/**
+ * Ensures that an object reference passed as a parameter to the calling method
+ * is not null or undefined.
+ */
+export function checkNotNull<T>(
+  reference: T | null | undefined,
+  message?: string,
+): T {
+  if (reference === null || reference === undefined) {
+    throw new Error(`null reference exception [detail: ${message}]`);
+  }
+  return reference;
+}
+
+/**
+ * Ensures the truth of an expression involving the state of the calling
+ * instance, but not involving any parameters to the calling method.
+ */
+export function checkState(condition: boolean, message?: string) {
+  if (!condition) {
+    throw new Error(`Invalid state [detail: ${message}]`);
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/utils/preferences.ts b/tools/motion/motion_test_watcher_app/src/utils/preferences.ts
new file mode 100644
index 000000000..d55f08745
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/preferences.ts
@@ -0,0 +1,75 @@
+/*
+ * Copyright 2024 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { Injectable } from '@angular/core';
+
+export const LOOP_VIDEO = 'loop_video';
+
+type PreferencesData = {
+  loopVideo: boolean;
+  playbackRate: number;
+};
+
+const PREFERENCES_DEFAULT_JSON = JSON.stringify({
+  loopVideo: false,
+  playbackRate: 1,
+});
+
+@Injectable()
+export class Preferences {
+  private _preferences: PreferencesData;
+
+  constructor() {
+    this._preferences = loadPreferences();
+  }
+
+  get loopVideo(): boolean {
+    return this._preferences.loopVideo;
+  }
+
+  set loopVideo(value: boolean) {
+    if (this.loopVideo == value) return;
+    this._preferences.loopVideo = value;
+    storePreferences(this._preferences);
+  }
+
+  get playbackRate(): number {
+    return this._preferences.playbackRate;
+  }
+
+  set playbackRate(value: number) {
+    if (this.playbackRate == value) return;
+    this._preferences.playbackRate = value;
+    storePreferences(this._preferences);
+  }
+}
+
+function loadPreferences(): PreferencesData {
+  const defaults = JSON.parse(PREFERENCES_DEFAULT_JSON);
+  try {
+    return {
+      ...defaults,
+      ...JSON.parse(localStorage.getItem('preferences') ?? '{}'),
+    };
+  } catch (e) {
+    console.error('Unable to restore preferences', e);
+    return defaults;
+  }
+}
+
+function storePreferences(preferences: PreferencesData) {
+  localStorage.setItem('preferences', JSON.stringify(preferences));
+}
diff --git a/tools/motion/motion_test_watcher_app/src/utils/progress.ts b/tools/motion/motion_test_watcher_app/src/utils/progress.ts
new file mode 100644
index 000000000..ad0679680
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/progress.ts
@@ -0,0 +1,60 @@
+/*
+ * Copyright 2022 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { Injectable } from '@angular/core';
+
+/**
+ * Tracks activity that should show a progress bar.
+ */
+@Injectable()
+export class ProgressTracker extends EventTarget {
+  private progressCount = 0;
+
+  get isActive() {
+    return this.progressCount > 0;
+  }
+
+  trackPromise<T>(promise: Promise<T>): Promise<T> {
+    queueMicrotask(() => {
+      this.beginProgress();
+      promise.finally(() => this.endProgress());
+    });
+    return promise;
+  }
+
+  /**
+   *  Marks the beginning of the progress.
+   *
+   *  Must be followed by exactly one endProgress` call.
+   */
+  beginProgress() {
+    this.progressCount++;
+    if (this.progressCount == 1) {
+      this.dispatchEvent(new Event('progress-started'));
+    }
+  }
+
+  /**
+   *  Ends a previously started progress.
+   */
+  endProgress() {
+    console.assert(this.progressCount > 0);
+    this.progressCount--;
+    if (this.progressCount == 0) {
+      this.dispatchEvent(new Event('progress-ended'));
+    }
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/utils/retry.ts b/tools/motion/motion_test_watcher_app/src/utils/retry.ts
new file mode 100644
index 000000000..0a3cb1b07
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/retry.ts
@@ -0,0 +1,88 @@
+/*
+ * Copyright 2022 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import { delay } from './utils';
+
+/** Starts the promise to try executing. */
+type RetryableFunction<T> = () => Promise<T>;
+
+/** Determines whether a next retry should be attempted. */
+type RetryIf = (attempt: number, error: unknown) => boolean;
+
+/** A `RetryIf` that limits the number of attempts to `maxAttempts`. */
+export function maxAttempts(maxAttempts: number): RetryIf {
+  console.assert(maxAttempts > 0);
+  return (retry) => retry < maxAttempts - 1;
+}
+
+/**
+ * Delays the next retry, after failing the `attempt`th attempt.
+ */
+type RetryDelay = (attempt: number, error: unknown) => Promise<void>;
+
+/** A `RetryDelay` that pauses the fixed amount of `delayMs` between reties */
+export function fixedRetryDelay(delayMs: number): RetryDelay {
+  return () => delay(delayMs);
+}
+
+/** Callback after the `attempt`th attempt failed with `error` */
+type AttemptFailed = (attempt: number, error: unknown) => Promise<void>;
+
+/**
+ * Awaits the completion of the `Promise` returned by `code`, and retries if the
+ * promise fails to complete.
+ */
+export async function retry<T>(
+  code: RetryableFunction<T>,
+  options?: {
+    /** Whether to retry the failed invocation (default maxAttempts(3)) */
+    shouldRerty?: RetryIf;
+    /** Delays the next retry (defaults to a fixed delay of 100ms) */
+    delay?: RetryDelay;
+    /** When an invocation failed. */
+    attemptFailed?: AttemptFailed;
+  },
+): Promise<T> {
+  const shouldRerty = options?.shouldRerty || maxAttempts(3);
+  const delay = options?.delay || fixedRetryDelay(100);
+  const attemptFailed = options?.attemptFailed || (() => Promise.resolve());
+
+  for (let attempt = 0; ; attempt++) {
+    try {
+      return await code();
+    } catch (e: unknown) {
+      if (e instanceof NonRetryableError) {
+        throw e;
+      }
+
+      await attemptFailed(attempt, e);
+
+      if (shouldRerty(attempt, e)) {
+        await delay(attempt, e);
+      } else {
+        // permanently fail.
+        throw e;
+      }
+    }
+  }
+}
+
+/** Promises failing with this type of error will not be retried by `retry`. */
+export class NonRetryableError extends Error {
+  constructor(msg: string) {
+    super(msg);
+  }
+}
diff --git a/tools/motion/motion_test_watcher_app/src/utils/utils.ts b/tools/motion/motion_test_watcher_app/src/utils/utils.ts
new file mode 100644
index 000000000..afc6af970
--- /dev/null
+++ b/tools/motion/motion_test_watcher_app/src/utils/utils.ts
@@ -0,0 +1,74 @@
+/*
+ * Copyright 2022 Google LLC
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+/** Promise that completes after the specified `timeMs` */
+export function delay(timeMs: number): Promise<void> {
+  return new Promise<void>((complete) => setTimeout(complete, timeMs));
+}
+
+/**
+ * A `Promise` to be completed
+ */
+export class Deferred<T> extends Promise<T> {
+  readonly resolve: (value: T) => void;
+  readonly reject: (reason?: any) => void;
+
+  constructor() {
+    let capturedResolve: (value: T) => void;
+    let capturedReject: (reason?: any) => void;
+
+    super((resolve, reject) => {
+      capturedResolve = resolve;
+      capturedReject = reject;
+    });
+
+    this.resolve = capturedResolve!;
+    this.reject = capturedReject!;
+  }
+}
+
+export function namedError(name: string, message?: string): Error {
+  const result = new Error(message);
+  result.name = name;
+  return result;
+}
+
+export function isNamedError(e: unknown, name: string): e is Error {
+  return e instanceof Error && e.name === name;
+}
+
+/** Checks whether both `Uint8Array` have the same contents. */
+export function arrayBufferEquals(
+  left: Uint8Array,
+  right: Uint8Array,
+): boolean {
+  if (left.byteLength != right.byteLength) return false;
+
+  for (let i = 0; i < left.byteLength; i++) {
+    if (left.at(i) != right.at(i)) return false;
+  }
+
+  return true;
+}
+
+export function asciiStringToBytes(contents: string): Uint8Array {
+  const result = new TextEncoder().encode(contents);
+  if (result.length != contents.length) {
+    // non-ascii characters require multiple bytes in utf-8.
+    throw new Error(`non-ascii characters found in '${contents}'`);
+  }
+  return result;
+}
diff --git a/tools/winscope/.eslintrc.js b/tools/winscope/.eslintrc.js
index e38cfad62..55aa70399 100644
--- a/tools/winscope/.eslintrc.js
+++ b/tools/winscope/.eslintrc.js
@@ -45,6 +45,12 @@ module.exports = {
     'prefer-const': ['error', {destructuring: 'all'}],
     'prefer-rest-params': 'error',
     'prefer-spread': 'error',
+    'no-restricted-imports': [
+      'error',
+      {
+        'patterns': ['..*'],
+      },
+    ],
   },
   globals: {
     // Specify NodeJS global as temporary workaround for eslint bug:
diff --git a/tools/winscope/protos/build.js b/tools/winscope/protos/build.js
index a69c10d48..8f869de14 100644
--- a/tools/winscope/protos/build.js
+++ b/tools/winscope/protos/build.js
@@ -78,6 +78,9 @@ async function build() {
         // WindowManager
         buildProtos([
             '../../../../frameworks/base/core/proto/android/server/windowmanagertrace.proto',
+        ], 'windowmanager/udc'),
+        buildProtos([
+            'windowmanager/latest/wrapper.proto',
         ], 'windowmanager/latest'),
 
         // Input
diff --git a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoApplication.java b/tools/winscope/protos/windowmanager/latest/wrapper.proto
similarity index 67%
rename from samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoApplication.java
rename to tools/winscope/protos/windowmanager/latest/wrapper.proto
index 70b6dc385..ef30b3077 100644
--- a/samples/VirtualDeviceManager/virtualcamera/src/com/example/android/vdmdemo/virtualcamera/VirtualCameraDemoApplication.java
+++ b/tools/winscope/protos/windowmanager/latest/wrapper.proto
@@ -14,12 +14,12 @@
  * limitations under the License.
  */
 
-package com.example.android.vdmdemo.virtualcamera;
+syntax = "proto2";
 
-import android.app.Application;
+package perfetto.protos;
 
-import dagger.hilt.android.HiltAndroidApp;
+import "protos/perfetto/trace/android/windowmanager.proto";
 
-/** Virtual camera demo application class. */
-@HiltAndroidApp(Application.class)
-public class VirtualCameraDemoApplication extends Hilt_VirtualCameraDemoApplication {}
+message Wrapper {
+  optional WindowManagerTraceEntry windowmanager_trace_entry = 1;
+}
diff --git a/tools/winscope/src/adb/winscope_proxy.py b/tools/winscope/src/adb/winscope_proxy.py
index 477dd1d0e..772b9470e 100644
--- a/tools/winscope/src/adb/winscope_proxy.py
+++ b/tools/winscope/src/adb/winscope_proxy.py
@@ -17,7 +17,7 @@
 #
 # This is an ADB proxy for Winscope.
 #
-# Requirements: python3.5 and ADB installed and in system PATH.
+# Requirements: python3.10 and ADB installed and in system PATH.
 #
 # Usage:
 #     run: python3 winscope_proxy.py
@@ -25,6 +25,7 @@
 
 import argparse
 import base64
+import gzip
 import json
 import logging
 import os
@@ -41,6 +42,7 @@ from http import HTTPStatus
 from http.server import HTTPServer, BaseHTTPRequestHandler
 from logging import DEBUG, INFO, WARNING
 from tempfile import NamedTemporaryFile
+from typing import Callable
 
 # GLOBALS #
 
@@ -60,54 +62,14 @@ def create_argument_parser() -> argparse.ArgumentParser:
 
     return parser
 
-# Keep in sync with ProxyClient#VERSION in Winscope
-VERSION = '2.1.1'
+# Keep in sync with ProxyConnection#VERSION in Winscope
+VERSION = '4.0.0'
 
 PERFETTO_TRACE_CONFIG_FILE = '/data/misc/perfetto-configs/winscope-proxy-trace.conf'
 PERFETTO_DUMP_CONFIG_FILE = '/data/misc/perfetto-configs/winscope-proxy-dump.conf'
-PERFETTO_SF_CONFIG_FILE = '/data/misc/perfetto-configs/winscope-proxy.surfaceflinger.conf'
 PERFETTO_TRACE_FILE = '/data/misc/perfetto-traces/winscope-proxy-trace.perfetto-trace'
 PERFETTO_DUMP_FILE = '/data/misc/perfetto-traces/winscope-proxy-dump.perfetto-trace'
 PERFETTO_UNIQUE_SESSION_NAME = 'winscope proxy perfetto tracing'
-PERFETTO_UTILS = f"""
-function is_perfetto_data_source_available {{
-    local data_source_name=$1
-    if perfetto --query | grep $data_source_name 2>&1 >/dev/null; then
-        return 0
-    else
-        return 1
-    fi
-}}
-
-function is_perfetto_tracing_session_running {{
-    if perfetto --query | grep "{PERFETTO_UNIQUE_SESSION_NAME}" 2>&1 >/dev/null; then
-        return 0
-    else
-        return 1
-    fi
-}}
-
-function is_any_perfetto_data_source_available {{
-    if is_perfetto_data_source_available android.inputmethod || \
-       is_perfetto_data_source_available android.protolog || \
-       is_perfetto_data_source_available android.surfaceflinger.layers || \
-       is_perfetto_data_source_available android.surfaceflinger.transactions || \
-       is_perfetto_data_source_available com.android.wm.shell.transition; then
-        return 0
-    else
-        return 1
-    fi
-}}
-
-function is_flag_set {{
-    local flag_name=$1
-    if dumpsys device_config | grep $flag_name=true 2>&1 >/dev/null; then
-        return 0
-    else
-        return 1
-    fi
-}}
-"""
 
 WINSCOPE_VERSION_HEADER = "Winscope-Proxy-Version"
 WINSCOPE_TOKEN_HEADER = "Winscope-Token"
@@ -120,8 +82,13 @@ WINSCOPE_EXT = ".winscope"
 WINSCOPE_EXT_LEGACY = ".pb"
 WINSCOPE_EXTS = [WINSCOPE_EXT, WINSCOPE_EXT_LEGACY]
 
-# Winscope traces directory
+# Winscope traces directories
 WINSCOPE_DIR = "/data/misc/wmtrace/"
+WINSCOPE_BACKUP_DIR = "/data/local/tmp/last_winscope_tracing_session/"
+
+# Tracing handlers
+SIGNAL_HANDLER_LOG = "/data/local/tmp/winscope_signal_handler.log"
+WINSCOPE_STATUS = "/data/local/tmp/winscope_status"
 
 # Max interval between the client keep-alive requests in seconds
 KEEP_ALIVE_INTERVAL_S = 5
@@ -131,10 +98,10 @@ class File:
         self.file = file
         self.type = filetype
 
-    def get_filepaths(self, device_id):
+    def get_filepaths(self, device_id) -> list[str]:
         return [self.file]
 
-    def get_filetype(self):
+    def get_filetype(self) -> str:
         return self.type
 
 
@@ -144,14 +111,19 @@ class FileMatcher:
         self.matcher = matcher
         self.type = filetype
 
-    def get_filepaths(self, device_id):
-        matchingFiles = call_adb(
-            f"shell su root find {self.path} -name {self.matcher}", device_id)
+    def get_filepaths(self, device_id) -> list[str]:
+        if len(self.matcher) > 0:
+            matchingFiles = call_adb(
+                f"shell su root find {self.path} -name {self.matcher}", device_id)
+        else:
+            matchingFiles = call_adb(
+                f"shell su root find {self.path}", device_id)
 
-        log.debug("Found file %s", matchingFiles.split('\n')[:-1])
-        return matchingFiles.split('\n')[:-1]
+        files = matchingFiles.split('\n')[:-1]
+        log.debug("Found files %s", files)
+        return files
 
-    def get_filetype(self):
+    def get_filetype(self) -> str:
         return self.type
 
 
@@ -162,7 +134,7 @@ class WinscopeFileMatcher(FileMatcher):
             WINSCOPE_EXTS))
         self.type = filetype
 
-    def get_filepaths(self, device_id):
+    def get_filepaths(self, device_id) -> list[str]:
         for matcher in self.internal_matchers:
             files = matcher.get_filepaths(device_id)
             if len(files) > 0:
@@ -171,219 +143,611 @@ class WinscopeFileMatcher(FileMatcher):
         return []
 
 
+def get_shell_args(device_id: str, type: str) -> list[str]:
+    shell = ['adb', '-s', device_id, 'shell']
+    log.debug(f"Starting {type} shell {' '.join(shell)}")
+    return shell
+
+def is_perfetto_data_source_available(name: str, query_result: str) -> bool:
+    return name in query_result
+
+def is_any_perfetto_data_source_available(query_result: str) -> bool:
+    return is_perfetto_data_source_available('android.inputmethod', query_result) or \
+       is_perfetto_data_source_available('android.protolog', query_result) or \
+       is_perfetto_data_source_available('android.surfaceflinger.layers', query_result) or \
+       is_perfetto_data_source_available('android.surfaceflinger.transactions', query_result) or \
+       is_perfetto_data_source_available('com.android.wm.shell.transition', query_result) or \
+       is_perfetto_data_source_available('android.viewcapture', query_result) or \
+       is_perfetto_data_source_available('android.windowmanager', query_result) or \
+       is_perfetto_data_source_available('android.input.inputevent', query_result)
+
+
+class TraceConfig:
+    def __init__(self, is_perfetto: bool) -> None:
+        self.is_perfetto = is_perfetto
+
+    @abstractmethod
+    def add(self, config: str, value: str | list[str] | None) -> None:
+        pass
+
+    @abstractmethod
+    def is_valid(self, config: str) -> bool:
+        pass
+
+    @abstractmethod
+    def execute_command(self, server, device_id):
+        pass
+
+    def get_trace_identifiers(self)-> list[str]:
+        return [""]
+
+    def get_optional_start_args(self, identifier)-> str:
+        return ""
+
+    def execute_optional_config_command(self, server, device_id, shell, command, config_key, config_value):
+        process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
+                                    stdin=subprocess.PIPE, start_new_session=True)
+        log.debug(f"Changing optional trace config on device {device_id} {config_key}:{config_value}")
+        out, err = process.communicate(command.encode('utf-8'))
+        if process.returncode != 0:
+            raise AdbError(
+                f"Error executing command:\n {command}\n\n### OUTPUT ###{out.decode('utf-8')}\n{err.decode('utf-8')}")
+        log.debug(f"Optional trace config changed on device {device_id}")
+        server.respond(HTTPStatus.OK, b'', "text/plain")
+
+    def execute_perfetto_config_command(self, server, shell, command, trace_name):
+        process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
+                                    stdin=subprocess.PIPE, start_new_session=True)
+        out, err = process.communicate(command.encode('utf-8'))
+        if process.returncode != 0:
+            raise AdbError(
+                f"Error executing command:\n {command}\n\n### OUTPUT ###{out.decode('utf-8')}\n{err.decode('utf-8')}")
+        log.debug(f'{trace_name} (perfetto) configured to start along the other perfetto traces.')
+        server.respond(HTTPStatus.OK, b'', "text/plain")
+
+
+class SurfaceFlingerTraceConfig(TraceConfig):
+    """Handles optional configuration for Surface Flinger traces.
+    """
+    LEGACY_FLAGS_MAP = {
+        "input": 1 << 1,
+        "composition": 1 << 2,
+        "metadata": 1 << 3,
+        "hwc": 1 << 4,
+        "tracebuffers": 1 << 5,
+        "virtualdisplays": 1 << 6
+    }
+
+    PERFETTO_FLAGS_MAP = {
+        "input": "TRACE_FLAG_INPUT",
+        "composition": "TRACE_FLAG_COMPOSITION",
+        "metadata": "TRACE_FLAG_EXTRA",
+        "hwc": "TRACE_FLAG_HWC",
+        "tracebuffers": "TRACE_FLAG_BUFFERS",
+        "virtualdisplays": "TRACE_FLAG_VIRTUAL_DISPLAYS",
+    }
+
+    def __init__(self, is_perfetto: bool) -> None:
+        super().__init__(is_perfetto)
+        self.flags = []
+        self.perfetto_flags = []
+
+        # defaults set for all configs
+        self.selected_configs = {
+            "sfbuffersize": "16000"
+        }
+
+    def add(self, config: str, value: str | None) -> None:
+        if config in SurfaceFlingerTraceConfig.LEGACY_FLAGS_MAP:
+            self.flags.append(config)
+        elif config in self.selected_configs:
+            self.selected_configs[config] = value
+
+    def is_valid(self, config: str) -> bool:
+        return config in SurfaceFlingerTraceConfig.LEGACY_FLAGS_MAP or config in self.selected_configs
+
+    def execute_command(self, server, device_id):
+        shell = get_shell_args(device_id, "sf config")
+
+        if self.is_perfetto:
+            self.execute_perfetto_config_command(server, shell, self._perfetto_config_command(), "SurfaceFlinger")
+        else:
+            self.execute_optional_config_command(server, device_id, shell, self._legacy_flags_command(), "sf flags", self.flags)
+            self.execute_optional_config_command(server, device_id, shell, self._legacy_buffer_size_command(), "sf buffer size", self.selected_configs["sfbuffersize"])
+
+    def _perfetto_config_command(self) -> str:
+        flags = "\n".join([f"""trace_flags: {SurfaceFlingerTraceConfig.PERFETTO_FLAGS_MAP[flag]}""" for flag in self.flags])
+
+        return f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.surfaceflinger.layers"
+        surfaceflinger_layers_config: {{
+            mode: MODE_ACTIVE
+            {flags}
+        }}
+    }}
+}}
+EOF
+"""
+
+    def _legacy_buffer_size_command(self) -> str:
+        return f'su root service call SurfaceFlinger 1029 i32 {self.selected_configs["sfbuffersize"]}'
+
+    def _legacy_flags_command(self) -> str:
+        flags = 0
+        for flag in self.flags:
+            flags |= SurfaceFlingerTraceConfig.LEGACY_FLAGS_MAP[flag]
+
+        return f"su root service call SurfaceFlinger 1033 i32 {flags}"
+
+
+class WindowManagerTraceConfig(TraceConfig):
+    PERFETTO_LOG_LEVEL_MAP = {
+       "verbose": "LOG_LEVEL_VERBOSE",
+       "debug": "LOG_LEVEL_DEBUG",
+       "critical": "LOG_LEVEL_CRITICAL",
+    }
+
+    PERFETTO_LOG_FREQUENCY_MAP = {
+       "frame": "LOG_FREQUENCY_FRAME",
+       "transaction": "LOG_FREQUENCY_TRANSACTION",
+    }
+
+    """Handles optional selected configuration for Window Manager traces.
+    """
+
+    def __init__(self, is_perfetto: bool) -> None:
+        super().__init__(is_perfetto)
+        # defaults set for all configs
+        self.selected_configs = {
+            "wmbuffersize": "16000",
+            "tracinglevel": "debug",
+            "tracingtype": "frame",
+        }
+
+    def add(self, config_type: str, config_value: str | None) -> None:
+        self.selected_configs[config_type] = config_value
+
+    def is_valid(self, config_type: str) -> bool:
+        return config_type in self.selected_configs
+
+    def execute_command(self, server, device_id):
+        shell = get_shell_args(device_id, "wm config")
+
+        if self.is_perfetto:
+            self.execute_perfetto_config_command(server, shell, self._perfetto_config_command(), "WM")
+        else:
+            self.execute_optional_config_command(server, device_id, shell, self._legacy_tracing_type_command(), "tracing type", self.selected_configs["tracingtype"])
+            self.execute_optional_config_command(server, device_id, shell, self._legacy_tracing_level_command(), "tracing level", self.selected_configs["tracinglevel"])
+            # /!\ buffer size must be configured last
+            # otherwise the other configurations might override it
+            self.execute_optional_config_command(server, device_id, shell, self._legacy_buffer_size_command(), "wm buffer size", self.selected_configs["wmbuffersize"])
+
+    def _perfetto_config_command(self) -> str:
+        log_level = WindowManagerTraceConfig.PERFETTO_LOG_LEVEL_MAP[self.selected_configs["tracinglevel"]]
+        log_frequency = WindowManagerTraceConfig.PERFETTO_LOG_FREQUENCY_MAP[self.selected_configs["tracingtype"]]
+        return f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.windowmanager"
+        windowmanager_config: {{
+            log_level: {log_level}
+            log_frequency: {log_frequency}
+        }}
+    }}
+}}
+EOF
+"""
+
+    def _legacy_tracing_type_command(self) -> str:
+        return f'su root cmd window tracing {self.selected_configs["tracingtype"]}'
+
+    def _legacy_tracing_level_command(self) -> str:
+        return f'su root cmd window tracing level {self.selected_configs["tracinglevel"]}'
+
+    def _legacy_buffer_size_command(self) -> str:
+        return f'su root cmd window tracing size {self.selected_configs["wmbuffersize"]}'
+
+
+class ViewCaptureTraceConfig(TraceConfig):
+    """Handles perfetto config for View Capture traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.viewcapture"
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config view capture")
+            self.execute_perfetto_config_command(server, shell, ViewCaptureTraceConfig.COMMAND, "View Capture")
+
+class TransactionsConfig(TraceConfig):
+    """Handles perfetto config for Transactions traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.surfaceflinger.transactions"
+        surfaceflinger_transactions_config: {{
+            mode: MODE_ACTIVE
+        }}
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config transactions")
+            self.execute_perfetto_config_command(server, shell, TransactionsConfig.COMMAND, "SF transactions")
+
+
+class ProtoLogConfig(TraceConfig):
+    """Handles perfetto config for ProtoLog traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.protolog"
+        protolog_config: {{
+            tracing_mode: ENABLE_ALL
+        }}
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config protolog")
+            self.execute_perfetto_config_command(server, shell, ProtoLogConfig.COMMAND, "ProtoLog")
+
+
+class ImeConfig(TraceConfig):
+    """Handles perfetto config for IME traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.inputmethod"
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config ime")
+            self.execute_perfetto_config_command(server, shell, ImeConfig.COMMAND, "IME tracing")
+
+
+class TransitionTracesConfig(TraceConfig):
+    """Handles perfetto config for Transition traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "com.android.wm.shell.transition"
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config transitions")
+            self.execute_perfetto_config_command(server, shell, TransitionTracesConfig.COMMAND, "Transitions")
+
+
+class InputConfig(TraceConfig):
+    """Handles perfetto config for Input traces."""
+
+    COMMAND = f"""
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.input.inputevent"
+        android_input_event_config {{
+            mode: TRACE_MODE_TRACE_ALL
+        }}
+    }}
+}}
+EOF
+    """
+
+    def execute_command(self, server, device_id):
+        if (self.is_perfetto):
+            shell = get_shell_args(device_id, "perfetto config input")
+            self.execute_perfetto_config_command(server, shell, InputConfig.COMMAND, "Input trace")
+
+
+class MediaBasedConfig(TraceConfig):
+    """Creates trace identifiers for Screen Recording traces and Screenshots."""
+    trace_identifiers = ["active"]
+
+    def get_trace_identifiers(self):
+        return self.trace_identifiers
+
+    def is_valid(self, config_type: str) -> bool:
+        return config_type == "displays"
+
+    def add(self, config_type: str, config_value: str | list[str] | None):
+        if config_type != "displays":
+           return
+        if config_value and len(config_value) > 0:
+            if type(config_value) == str:
+                self.trace_identifiers = [config_value.split(" ")[0]]
+            else:
+                self.trace_identifiers = list(map(lambda d: d.split(" ")[0], config_value))
+
+    def execute_command(self, server, device_id):
+        pass
+
+class ScreenRecordingConfig(MediaBasedConfig):
+    """Creates display args for Screen Recording traces."""
+    def get_optional_start_args(self, identifier):
+        if identifier == "active":
+            return ""
+        return f"--display-id {identifier}"
+
+class ScreenshotConfig(MediaBasedConfig):
+    """Creates display args for Screenshots."""
+    def get_optional_start_args(self, identifier):
+        if identifier == "active":
+            return ""
+        return f"-d {identifier}"
+
+
+class SurfaceFlingerDumpConfig(TraceConfig):
+    """Handles perfetto config for SurfaceFlinger dumps."""
+    def __init__(self, is_perfetto: bool) -> None:
+        super().__init__(is_perfetto)
+
+    def add(self, config: str, value: str | None) -> None:
+        pass
+
+    def is_valid(self, config: str) -> bool:
+        return False
+
+    def execute_command(self, server, device_id):
+        shell = get_shell_args(device_id, "sf config")
+
+        if self.is_perfetto:
+            self.execute_perfetto_config_command(server, shell, self._perfetto_config_command(), "SurfaceFlinger")
+
+    def _perfetto_config_command(self) -> str:
+        return f"""
+cat << EOF >> {PERFETTO_DUMP_CONFIG_FILE}
+data_sources: {{
+    config {{
+        name: "android.surfaceflinger.layers"
+        surfaceflinger_layers_config: {{
+            mode: MODE_DUMP
+            trace_flags: TRACE_FLAG_INPUT
+            trace_flags: TRACE_FLAG_COMPOSITION
+            trace_flags: TRACE_FLAG_HWC
+            trace_flags: TRACE_FLAG_BUFFERS
+            trace_flags: TRACE_FLAG_VIRTUAL_DISPLAYS
+        }}
+    }}
+}}
+EOF
+"""
+
+    def _legacy_buffer_size_command(self) -> str:
+        return f'su root service call SurfaceFlinger 1029 i32 {self.selected_configs["sfbuffersize"]}'
+
+    def _legacy_flags_command(self) -> str:
+        flags = 0
+        for flag in self.flags:
+            flags |= SurfaceFlingerTraceConfig.LEGACY_FLAGS_MAP[flag]
+
+        return f"su root service call SurfaceFlinger 1033 i32 {flags}"
+
+
 class TraceTarget:
     """Defines a single parameter to trace.
 
     Attributes:
-        file_matchers: the matchers used to identify the paths on the device the trace results are saved to.
+        trace_name: used as a key to access config and log statements during Start/End endpoints.
+        files: the matchers used to identify the paths on the device the trace results are saved to.
+        is_perfetto_available: callback to determine if perfetto tracing is available for target.
         trace_start: command to start the trace from adb shell, must not block.
         trace_stop: command to stop the trace, should block until the trace is stopped.
+        get_trace_config: getter for optional setup to execute pre-tracing adb commands and define start command arguments.
     """
 
-    def __init__(self, files, trace_start: str, trace_stop: str) -> None:
+    def __init__(
+            self,
+            trace_name: str,
+            files: list[File | FileMatcher],
+            is_perfetto_available: Callable[[str], bool],
+            trace_start: str,
+            trace_stop: str,
+            get_trace_config: Callable[[bool], TraceConfig] | None = None
+        ) -> None:
+        self.trace_name = trace_name
         if type(files) is not list:
             files = [files]
         self.files = files
+        self.is_perfetto_available = is_perfetto_available
         self.trace_start = trace_start
         self.trace_stop = trace_stop
+        self.get_trace_config = get_trace_config
 
 
 # Order of files matters as they will be expected in that order and decoded in that order
 TRACE_TARGETS = {
     "view_capture_trace": TraceTarget(
+        "view_capture_trace",
         File('/data/misc/wmtrace/view_capture_trace.zip', "view_capture_trace.zip"),
-    f"""
-if is_flag_set windowing_tools/android.tracing.perfetto_view_capture_tracing; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.viewcapture"
-    }}
-}}
-EOF
-    echo 'ViewCapture tracing (perfetto) configured to start along the other perfetto traces'
-else
-    su root settings put global view_capture_enabled 1
-    echo 'ViewCapture tracing (legacy) started.'
-fi
-""",
-    """
-if ! is_flag_set windowing_tools/android.tracing.perfetto_view_capture_tracing; then
-    su root sh -c 'cmd launcherapps dump-view-hierarchies >/data/misc/wmtrace/view_capture_trace.zip'
-    su root settings put global view_capture_enabled 0
-    echo 'ViewCapture tracing (legacy) stopped.'
-fi
-"""
+        lambda res: is_perfetto_data_source_available("android.viewcapture", res),
+        """
+su root settings put global view_capture_enabled 1
+echo 'ViewCapture tracing (legacy) started.'
+        """,
+        """
+su root sh -c 'cmd launcherapps dump-view-hierarchies >/data/misc/wmtrace/view_capture_trace.zip'
+su root settings put global view_capture_enabled 0
+echo 'ViewCapture tracing (legacy) stopped.'
+        """,
+        lambda is_perfetto: ViewCaptureTraceConfig(is_perfetto)
     ),
     "window_trace": TraceTarget(
+        "window_trace",
         WinscopeFileMatcher(WINSCOPE_DIR, "wm_trace", "window_trace"),
-        'su root cmd window tracing start\necho "WM trace started."',
-        'su root cmd window tracing stop >/dev/null 2>&1'
+        lambda res: is_perfetto_data_source_available('android.windowmanager', res),
+        """
+su root cmd window tracing start
+echo 'WM trace (legacy) started.'
+        """,
+        """
+su root cmd window tracing stop >/dev/null 2>&1
+echo 'WM trace (legacy) stopped.'
+        """,
+        lambda is_perfetto: WindowManagerTraceConfig(is_perfetto)
     ),
     "layers_trace": TraceTarget(
+        "layers_trace",
         WinscopeFileMatcher(WINSCOPE_DIR, "layers_trace", "layers_trace"),
-        f"""
-if is_perfetto_data_source_available android.surfaceflinger.layers; then
-    cat {PERFETTO_SF_CONFIG_FILE} >> {PERFETTO_TRACE_CONFIG_FILE}
-    echo 'SF trace (perfetto) configured to start along the other perfetto traces'
-else
-    su root service call SurfaceFlinger 1025 i32 1
-    echo 'SF layers trace (legacy) started'
-fi
+        lambda res: is_perfetto_data_source_available('android.surfaceflinger.layers', res),
+        """
+su root service call SurfaceFlinger 1025 i32 1
+echo 'SF layers trace (legacy) started.'
         """,
         """
-if ! is_perfetto_data_source_available android.surfaceflinger.layers; then
-    su root service call SurfaceFlinger 1025 i32 0 >/dev/null 2>&1
-    echo 'SF layers trace (legacy) stopped.'
-fi
-"""
-),
+su root service call SurfaceFlinger 1025 i32 0 >/dev/null 2>&1
+echo 'SF layers trace (legacy) stopped.'
+        """,
+        lambda is_perfetto: SurfaceFlingerTraceConfig(is_perfetto)
+    ),
     "screen_recording": TraceTarget(
-        File(f'/data/local/tmp/screen.mp4', "screen_recording"),
-        f'''
+        "screen_recording",
+        File(
+            '/data/local/tmp/screen_{trace_identifier}.mp4',
+            "screen_recording_{trace_identifier}"),
+        lambda res: False,
+        '''
         settings put system show_touches 1 && \
         settings put system pointer_location 1 && \
-        screenrecord --bugreport --bit-rate 8M /data/local/tmp/screen.mp4 >/dev/null 2>&1 & \
+        screenrecord --bugreport --bit-rate 8M {options} /data/local/tmp/screen_{trace_identifier}.mp4 & \
         echo "ScreenRecorder started."
         ''',
         '''settings put system pointer_location 0 && \
         settings put system show_touches 0 && \
         pkill -l SIGINT screenrecord >/dev/null 2>&1
-        '''.strip()
+        '''.strip(),
+        lambda is_perfetto: ScreenRecordingConfig(is_perfetto)
     ),
     "transactions": TraceTarget(
+        "transactions",
         WinscopeFileMatcher(WINSCOPE_DIR, "transactions_trace", "transactions"),
-        f"""
-if is_perfetto_data_source_available android.surfaceflinger.transactions; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.surfaceflinger.transactions"
-        surfaceflinger_transactions_config: {{
-            mode: MODE_ACTIVE
-        }}
-    }}
-}}
-EOF
-    echo 'SF transactions trace (perfetto) configured to start along the other perfetto traces'
-else
-    su root service call SurfaceFlinger 1041 i32 1
-    echo 'SF transactions trace (legacy) started'
-fi
-""",
+        lambda res: is_perfetto_data_source_available('android.surfaceflinger.transactions', res),
         """
-if ! is_perfetto_data_source_available android.surfaceflinger.transactions; then
-    su root service call SurfaceFlinger 1041 i32 0 >/dev/null 2>&1
-fi
-"""
+su root service call SurfaceFlinger 1041 i32 1
+echo 'SF transactions trace (legacy) started.'
+        """,
+        "su root service call SurfaceFlinger 1041 i32 0 >/dev/null 2>&1",
+        lambda is_perfetto: TransactionsConfig(is_perfetto)
     ),
     "transactions_legacy": TraceTarget(
+        "transactions_legacy",
         [
             WinscopeFileMatcher(WINSCOPE_DIR, "transaction_trace", "transactions_legacy"),
             FileMatcher(WINSCOPE_DIR, f'transaction_merges_*', "transaction_merges"),
         ],
+        lambda res: False,
         'su root service call SurfaceFlinger 1020 i32 1\necho "SF transactions recording started."',
-        'su root service call SurfaceFlinger 1020 i32 0 >/dev/null 2>&1'
+        'su root service call SurfaceFlinger 1020 i32 0 >/dev/null 2>&1',
     ),
     "proto_log": TraceTarget(
+         "proto_log",
         WinscopeFileMatcher(WINSCOPE_DIR, "wm_log", "proto_log"),
-        f"""
-if is_perfetto_data_source_available android.protolog && \
-    is_flag_set windowing_tools/android.tracing.perfetto_protolog_tracing; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.protolog"
-        protolog_config: {{
-            tracing_mode: ENABLE_ALL
-        }}
-    }}
-}}
-EOF
-    echo 'ProtoLog (perfetto) configured to start along the other perfetto traces'
-else
-    su root cmd window logging start
-    echo "ProtoLog (legacy) started."
-fi
-        """,
+        lambda res: is_perfetto_data_source_available('android.protolog', res),
         """
-if ! is_perfetto_data_source_available android.protolog && \
-    ! is_flag_set windowing_tools/android.tracing.perfetto_protolog_tracing; then
-    su root cmd window logging stop >/dev/null 2>&1
-    echo "ProtoLog (legacy) stopped."
-fi
+su root cmd window logging start
+echo "ProtoLog (legacy) started."
+        """,
         """
+su root cmd window logging stop >/dev/null 2>&1
+echo "ProtoLog (legacy) stopped."
+        """,
+        lambda is_perfetto: ProtoLogConfig(is_perfetto)
     ),
     "ime": TraceTarget(
+        "ime",
         [WinscopeFileMatcher(WINSCOPE_DIR, "ime_trace_clients", "ime_trace_clients"),
          WinscopeFileMatcher(WINSCOPE_DIR, "ime_trace_service", "ime_trace_service"),
          WinscopeFileMatcher(WINSCOPE_DIR, "ime_trace_managerservice", "ime_trace_managerservice")],
-         f"""
-if is_flag_set windowing_tools/android.tracing.perfetto_ime; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.inputmethod"
-    }}
-}}
-EOF
-    echo 'IME tracing (perfetto) configured to start along the other perfetto traces'
-else
-    su root ime tracing start
-    echo "IME tracing (legacy) started."
-fi
-""",
-    """
-if ! is_flag_set windowing_tools/android.tracing.perfetto_ime; then
-    su root ime tracing stop >/dev/null 2>&1
-    echo "IME tracing (legacy) stopped."
-fi
-"""
+        lambda res: is_perfetto_data_source_available('android.inputmethod', res),
+        """
+su root ime tracing start
+echo "IME tracing (legacy) started."
+        """,
+        """
+su root ime tracing stop >/dev/null 2>&1
+echo "IME tracing (legacy) stopped."
+        """,
+        lambda is_perfetto: ImeConfig(is_perfetto)
     ),
     "wayland_trace": TraceTarget(
+        "wayland_trace",
         WinscopeFileMatcher("/data/misc/wltrace", "wl_trace", "wl_trace"),
+        lambda res: False,
         'su root service call Wayland 26 i32 1 >/dev/null\necho "Wayland trace started."',
         'su root service call Wayland 26 i32 0 >/dev/null'
     ),
     "eventlog": TraceTarget(
+        "eventlog",
         WinscopeFileMatcher("/data/local/tmp", "eventlog", "eventlog"),
+        lambda res: False,
         'rm -f /data/local/tmp/eventlog.winscope && EVENT_LOG_TRACING_START_TIME=$EPOCHREALTIME\necho "Event Log trace started."',
         'echo "EventLog\\n" > /data/local/tmp/eventlog.winscope && su root logcat -b events -v threadtime -v printable -v uid -v nsec -v epoch -b events -t $EVENT_LOG_TRACING_START_TIME >> /data/local/tmp/eventlog.winscope',
     ),
     "transition_traces": TraceTarget(
+        "transition_traces",
         [WinscopeFileMatcher(WINSCOPE_DIR, "wm_transition_trace", "wm_transition_trace"),
          WinscopeFileMatcher(WINSCOPE_DIR, "shell_transition_trace", "shell_transition_trace")],
-         f"""
-if is_perfetto_data_source_available com.android.wm.shell.transition && \
-    is_flag_set windowing_tools/android.tracing.perfetto_transition_tracing; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "com.android.wm.shell.transition"
-    }}
-}}
-EOF
-    echo 'Transition trace (perfetto) configured to start along the other perfetto traces'
-else
-    su root cmd window shell tracing start && su root dumpsys activity service SystemUIService WMShell transitions tracing start
-    echo "Transition traces (legacy) started."
-fi
+        lambda res: is_perfetto_data_source_available('com.android.wm.shell.transition', res),
+        """
+su root cmd window shell tracing start && su root dumpsys activity service SystemUIService WMShell transitions tracing start
+echo "Transition traces (legacy) started."
         """,
         """
-if ! is_perfetto_data_source_available com.android.wm.shell.transition && \
-    ! is_flag_set windowing_tools/android.tracing.perfetto_transition_tracing; then
-    su root cmd window shell tracing stop && su root dumpsys activity service SystemUIService WMShell transitions tracing stop >/dev/null 2>&1
-    echo 'Transition traces (legacy) stopped.'
-fi
-"""
+su root cmd window shell tracing stop && su root dumpsys activity service SystemUIService WMShell transitions tracing stop >/dev/null 2>&1
+echo 'Transition traces (legacy) stopped.'
+        """,
+        lambda is_perfetto: TransitionTracesConfig(is_perfetto)
+    ),
+    "input": TraceTarget(
+        "input",
+        [WinscopeFileMatcher(WINSCOPE_DIR, "input_trace", "input_trace")],
+        lambda res: is_perfetto_data_source_available('android.input.inputevent', res),
+        "",
+        "",
+        lambda is_perfetto: InputConfig(is_perfetto)
     ),
     "perfetto_trace": TraceTarget(
+         "perfetto_trace",
         File(PERFETTO_TRACE_FILE, "trace.perfetto-trace"),
+        lambda res: is_any_perfetto_data_source_available(res),
         f"""
-if is_any_perfetto_data_source_available; then
-    cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
+cat << EOF >> {PERFETTO_TRACE_CONFIG_FILE}
 buffers: {{
-    size_kb: 80000
+    size_kb: 500000
     fill_policy: RING_BUFFER
 }}
 duration_ms: 0
@@ -392,217 +756,95 @@ write_into_file: true
 unique_session_name: "{PERFETTO_UNIQUE_SESSION_NAME}"
 EOF
 
-    if is_perfetto_tracing_session_running; then
-        perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop
-        echo 'Stopped already-running winscope perfetto session'
-    fi
+if is_perfetto_tracing_session_running; then
+    perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop
+    echo 'Stopped already-running winscope perfetto session.'
+fi
 
-    echo 'Concurrent Perfetto Sessions'
-    perfetto --query | sed -n '/^TRACING SESSIONS:$/,$p'
+echo 'Concurrent Perfetto Sessions'
+perfetto --query | sed -n '/^TRACING SESSIONS:$/,$p'
 
-    rm -f {PERFETTO_TRACE_FILE}
-    perfetto --out {PERFETTO_TRACE_FILE} --txt --config {PERFETTO_TRACE_CONFIG_FILE} --detach=WINSCOPE-PROXY-TRACING-SESSION
-    echo 'Started perfetto trace'
-fi
+rm -f {PERFETTO_TRACE_FILE}
+perfetto --out {PERFETTO_TRACE_FILE} --txt --config {PERFETTO_TRACE_CONFIG_FILE} --detach=WINSCOPE-PROXY-TRACING-SESSION
+echo 'Started perfetto trace.'
 """,
         """
-if is_any_perfetto_data_source_available; then
-    perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop
-    echo 'Stopped perfetto trace'
-fi
+perfetto --attach=WINSCOPE-PROXY-TRACING-SESSION --stop
+echo 'Stopped perfetto trace.'
 """,
-    )
-}
-
-
-class SurfaceFlingerTraceConfig:
-    """Handles optional configuration for surfaceflinger traces.
-    """
-
-    def __init__(self) -> None:
-        self.flags = []
-        self.perfetto_flags = []
-
-    def add(self, config: str) -> None:
-        self.flags.append(config)
-
-    def is_valid(self, config: str) -> bool:
-        return config in SF_LEGACY_FLAGS_MAP
-
-    def command(self) -> str:
-        legacy_flags = 0
-        for flag in self.flags:
-            legacy_flags |= SF_LEGACY_FLAGS_MAP[flag]
-
-        perfetto_flags = "\n".join([f"""trace_flags: {SF_PERFETTO_FLAGS_MAP[flag]}""" for flag in self.flags])
-
-        return f"""
-{PERFETTO_UTILS}
-
-if is_perfetto_data_source_available android.surfaceflinger.layers; then
-    cat << EOF > {PERFETTO_SF_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.surfaceflinger.layers"
-        surfaceflinger_layers_config: {{
-            mode: MODE_ACTIVE
-            {perfetto_flags}
-        }}
-    }}
-}}
-EOF
-    echo 'SF trace (perfetto) configured.'
-else
-    su root service call SurfaceFlinger 1033 i32 {legacy_flags}
-    echo 'SF trace (legacy) configured'
-fi
-"""
-
-class SurfaceFlingerTraceSelectedConfig:
-    """Handles optional selected configuration for surfaceflinger traces.
-    """
-
-    def __init__(self) -> None:
-        # defaults set for all configs
-        self.selectedConfigs = {
-            "sfbuffersize": "16000"
-        }
-
-    def add(self, configType, configValue) -> None:
-        self.selectedConfigs[configType] = configValue
-
-    def is_valid(self, configType) -> bool:
-        return configType in CONFIG_SF_SELECTION
-
-    def setBufferSize(self) -> str:
-        return f'su root service call SurfaceFlinger 1029 i32 {self.selectedConfigs["sfbuffersize"]}'
-
-class WindowManagerTraceSelectedConfig:
-    """Handles optional selected configuration for windowmanager traces.
-    """
-
-    def __init__(self) -> None:
-        # defaults set for all configs
-        self.selectedConfigs = {
-            "wmbuffersize": "16000",
-            "tracinglevel": "debug",
-            "tracingtype": "frame",
-        }
-
-    def add(self, configType, configValue) -> None:
-        self.selectedConfigs[configType] = configValue
-
-    def is_valid(self, configType) -> bool:
-        return configType in CONFIG_WM_SELECTION
-
-    def setBufferSize(self) -> str:
-        return f'su root cmd window tracing size {self.selectedConfigs["wmbuffersize"]}'
-
-    def setTracingLevel(self) -> str:
-        return f'su root cmd window tracing level {self.selectedConfigs["tracinglevel"]}'
-
-    def setTracingType(self) -> str:
-        return f'su root cmd window tracing {self.selectedConfigs["tracingtype"]}'
-
-
-SF_LEGACY_FLAGS_MAP = {
-    "input": 1 << 1,
-    "composition": 1 << 2,
-    "metadata": 1 << 3,
-    "hwc": 1 << 4,
-    "tracebuffers": 1 << 5,
-    "virtualdisplays": 1 << 6
-}
-
-SF_PERFETTO_FLAGS_MAP = {
-    "input": "TRACE_FLAG_INPUT",
-    "composition": "TRACE_FLAG_COMPOSITION",
-    "metadata": "TRACE_FLAG_EXTRA",
-    "hwc": "TRACE_FLAG_HWC",
-    "tracebuffers": "TRACE_FLAG_BUFFERS",
-    "virtualdisplays": "TRACE_FLAG_VIRTUAL_DISPLAYS",
+    ),
 }
 
-#Keep up to date with options in trace_collection_utils.ts
-CONFIG_SF_SELECTION = [
-    "sfbuffersize",
-]
-
-#Keep up to date with options in trace_collection_utils.ts
-CONFIG_WM_SELECTION = [
-    "wmbuffersize",
-    "tracingtype",
-    "tracinglevel",
-]
 
 class DumpTarget:
-    """Defines a single parameter to trace.
+    """Defines a single parameter to dump.
 
     Attributes:
-        file: the path on the device the dump results are saved to.
+        trace_name: used as a key to access config and log statements during Dump endpoint.
+        files: the matchers used to identify the paths on the device the dump results are saved to.
         dump_command: command to dump state to file.
+        get_trace_config: getter for optional setup to execute pre-tracing adb commands and define start command arguments.
     """
 
-    def __init__(self, files, dump_command: str) -> None:
+    def __init__(
+            self,
+            trace_name: str,
+            files: list[File | FileMatcher],
+            is_perfetto_available: Callable[[str], bool],
+            dump_command: str,
+            get_trace_config: Callable[[bool], TraceConfig] | None = None
+        ) -> None:
+        self.trace_name = trace_name
         if type(files) is not list:
             files = [files]
         self.files = files
+        self.is_perfetto_available = is_perfetto_available
         self.dump_command = dump_command
+        self.get_trace_config = get_trace_config
 
 
 DUMP_TARGETS = {
     "window_dump": DumpTarget(
+        "window_dump",
         File(f'/data/local/tmp/wm_dump{WINSCOPE_EXT}', "window_dump"),
+        lambda res: False,
         f'su root dumpsys window --proto > /data/local/tmp/wm_dump{WINSCOPE_EXT}'
     ),
 
     "layers_dump": DumpTarget(
+        "layers_dump",
         File(f'/data/local/tmp/sf_dump{WINSCOPE_EXT}', "layers_dump"),
+        lambda res: is_perfetto_data_source_available('android.surfaceflinger.layers', res),
         f"""
-if is_perfetto_data_source_available android.surfaceflinger.layers; then
-    cat << EOF >> {PERFETTO_DUMP_CONFIG_FILE}
-data_sources: {{
-    config {{
-        name: "android.surfaceflinger.layers"
-        surfaceflinger_layers_config: {{
-            mode: MODE_DUMP
-            trace_flags: TRACE_FLAG_INPUT
-            trace_flags: TRACE_FLAG_COMPOSITION
-            trace_flags: TRACE_FLAG_HWC
-            trace_flags: TRACE_FLAG_BUFFERS
-            trace_flags: TRACE_FLAG_VIRTUAL_DISPLAYS
-        }}
-    }}
-}}
-EOF
-    echo 'SF transactions trace (perfetto) configured to start along the other perfetto traces'
-else
-    su root dumpsys SurfaceFlinger --proto > /data/local/tmp/sf_dump{WINSCOPE_EXT}
-fi
-"""
+su root dumpsys SurfaceFlinger --proto > /data/local/tmp/sf_dump{WINSCOPE_EXT}
+        """,
+        lambda is_perfetto: SurfaceFlingerDumpConfig(is_perfetto)
     ),
 
     "screenshot": DumpTarget(
-        File("/data/local/tmp/screenshot.png", "screenshot.png"),
-        "screencap -p > /data/local/tmp/screenshot.png"
+        "screenshot",
+        File("/data/local/tmp/screenshot_{trace_identifier}.png", "screenshot_{trace_identifier}.png"),
+        lambda res: False,
+        "screencap -p {options}> /data/local/tmp/screenshot_{trace_identifier}.png",
+        lambda is_perfetto: ScreenshotConfig(is_perfetto)
     ),
 
     "perfetto_dump": DumpTarget(
+        "perfetto_dump",
         File(PERFETTO_DUMP_FILE, "dump.perfetto-trace"),
+        lambda res: is_any_perfetto_data_source_available(res),
         f"""
-if is_any_perfetto_data_source_available; then
-    cat << EOF >> {PERFETTO_DUMP_CONFIG_FILE}
+cat << EOF >> {PERFETTO_DUMP_CONFIG_FILE}
 buffers: {{
-    size_kb: 50000
+    size_kb: 500000
     fill_policy: RING_BUFFER
 }}
 duration_ms: 1
 EOF
 
-    rm -f {PERFETTO_DUMP_FILE}
-    perfetto --out {PERFETTO_DUMP_FILE} --txt --config {PERFETTO_DUMP_CONFIG_FILE}
-    echo 'Recorded perfetto dump'
-fi
+rm -f {PERFETTO_DUMP_FILE}
+perfetto --out {PERFETTO_DUMP_FILE} --txt --config {PERFETTO_DUMP_CONFIG_FILE}
+echo 'Recorded perfetto dump.'
         """
     )
 }
@@ -680,39 +922,41 @@ class RequestRouter:
     def register_endpoint(self, method: RequestType, name: str, endpoint: RequestEndpoint):
         self.endpoints[(method, name)] = endpoint
 
-    def __bad_request(self, error: str):
+    def _bad_request(self, error: str):
         log.warning("Bad request: " + error)
         self.request.respond(HTTPStatus.BAD_REQUEST, b"Bad request!\nThis is Winscope ADB proxy.\n\n"
                              + error.encode("utf-8"), 'text/txt')
 
-    def __internal_error(self, error: str):
+    def _internal_error(self, error: str):
         log.error("Internal error: " + error)
         self.request.respond(HTTPStatus.INTERNAL_SERVER_ERROR,
                              error.encode("utf-8"), 'text/txt')
 
-    def __bad_token(self):
+    def _bad_token(self):
         log.info("Bad token")
-        self.request.respond(HTTPStatus.FORBIDDEN, b"Bad Winscope authorisation token!\nThis is Winscope ADB proxy.\n",
+        self.request.respond(HTTPStatus.FORBIDDEN, b"Bad Winscope authorization token!\nThis is Winscope ADB proxy.\n",
                              'text/txt')
 
     def process(self, method: RequestType):
         token = self.request.headers[WINSCOPE_TOKEN_HEADER]
         if not token or token != secret_token:
-            return self.__bad_token()
+            return self._bad_token()
         path = self.request.path.strip('/').split('/')
         if path and len(path) > 0:
             endpoint_name = path[0]
             try:
                 return self.endpoints[(method, endpoint_name)].process(self.request, path[1:])
-            except KeyError:
-                return self.__bad_request("Unknown endpoint /{}/".format(endpoint_name))
+            except KeyError as ex:
+                if "RequestType" in repr(ex):
+                    return self._bad_request("Unknown endpoint /{}/".format(endpoint_name))
+                return self._internal_error(repr(ex))
             except AdbError as ex:
-                return self.__internal_error(str(ex))
+                return self._internal_error(str(ex))
             except BadRequest as ex:
-                return self.__bad_request(str(ex))
+                return self._bad_request(str(ex))
             except Exception as ex:
-                return self.__internal_error(repr(ex))
-        self.__bad_request("No endpoint specified")
+                return self._internal_error(repr(ex))
+        self._bad_request("No endpoint specified")
 
 
 def call_adb(params: str, device: str = None, stdin: bytes = None):
@@ -750,43 +994,69 @@ def call_adb_outfile(params: str, outfile, device: str = None, stdin: bytes = No
             'Error executing adb command: adb {}\n{}'.format(params, repr(ex)))
 
 
-class CheckWaylandServiceEndpoint(RequestEndpoint):
-    _listDevicesEndpoint = None
+class ListDevicesEndpoint(RequestEndpoint):
+    ADB_INFO_RE = re.compile("^([A-Za-z0-9._:\\-]+)\\s+(\\w+)(.*model:(\\w+))?")
+    foundDevices: dict[str | int, dict[str, bool | str]] = {}
+
+    def process(self, server, path):
+        lines = list(filter(None, call_adb('devices -l').split('\n')))
+        devices = {}
+        for m in [ListDevicesEndpoint.ADB_INFO_RE.match(d) for d in lines[1:]]:
+            if m:
+                authorized = str(m.group(2)) != 'unauthorized'
+                try:
+                    screen_record_version = call_adb('shell screenrecord --version', m.group(1)) if authorized else '0'
+                except AdbError:
+                    try:
+                        help_text = call_adb('shell screenrecord --help', m.group(1))
+                        version_start_index = help_text.find('v') + 1
+                        screen_record_version = help_text[version_start_index:version_start_index + 3]
+                    except AdbError:
+                        screen_record_version = '0'
+
+                try:
+                    displays = list(filter(None, call_adb('shell su root dumpsys SurfaceFlinger --display-id',
+                                                          m.group(1)).split('\n'))) if authorized else []
+                except AdbError:
+                    displays = []
+
+                devices[m.group(1)] = {
+                    'authorized': authorized,
+                    'model': m.group(4).replace('_', ' ') if m.group(4) else '',
+                    'displays': displays,
+                    'screenrecord_version': screen_record_version,
+                }
+        self.foundDevices = devices
+        j = json.dumps(devices)
+        log.debug("Detected devices: " + j)
+        server.respond(HTTPStatus.OK, j.encode("utf-8"), "text/json")
+
+
 
-    def __init__(self, listDevicesEndpoint):
+class CheckWaylandServiceEndpoint(RequestEndpoint):
+    def __init__(self, listDevicesEndpoint: ListDevicesEndpoint):
       self._listDevicesEndpoint = listDevicesEndpoint
 
     def process(self, server, path):
         self._listDevicesEndpoint.process(server, path)
-        foundDevices = self._listDevicesEndpoint._foundDevices
+        foundDevices = self._listDevicesEndpoint.foundDevices
 
-        if len(foundDevices) > 1:
-          res = 'false'
+        if len(foundDevices) != 1:
+            res = 'false'
         else:
-          raw_res = call_adb('shell service check Wayland')
-          res = 'false' if 'not found' in raw_res else 'true'
+            device = list(foundDevices.values())[0]
+            if not device.get('authorized') or not device.get('model'):
+                res = 'false'
+            else:
+                raw_res = call_adb('shell service check Wayland')
+                res = 'false' if 'not found' in raw_res else 'true'
         server.respond(HTTPStatus.OK, res.encode("utf-8"), "text/json")
 
 
-class ListDevicesEndpoint(RequestEndpoint):
-    ADB_INFO_RE = re.compile("^([A-Za-z0-9._:\\-]+)\\s+(\\w+)(.*model:(\\w+))?")
-    _foundDevices = None
-
-    def process(self, server, path):
-        lines = list(filter(None, call_adb('devices -l').split('\n')))
-        devices = {m.group(1): {
-            'authorised': str(m.group(2)) != 'unauthorized',
-            'model': m.group(4).replace('_', ' ') if m.group(4) else ''
-        } for m in [ListDevicesEndpoint.ADB_INFO_RE.match(d) for d in lines[1:]] if m}
-        self._foundDevices = devices
-        j = json.dumps(devices)
-        log.debug("Detected devices: " + j)
-        server.respond(HTTPStatus.OK, j.encode("utf-8"), "text/json")
-
 
 class DeviceRequestEndpoint(RequestEndpoint):
     def process(self, server, path):
-        if len(path) > 0 and re.fullmatch("[A-Za-z0-9.:\\-]+", path[0]):
+        if len(path) > 0 and re.fullmatch("[A-Za-z0-9._:\\-]+", path[0]):
             self.process_with_device(server, path[1:], path[0])
         else:
             raise BadRequest("Device id not specified")
@@ -804,97 +1074,151 @@ class DeviceRequestEndpoint(RequestEndpoint):
             raise BadRequest("Content length unreadable\n" + str(err))
         return json.loads(server.rfile.read(length).decode("utf-8"))
 
-    def move_perfetto_target_to_end_of_list(self, targets):
+    def get_targets_and_prepare_for_tracing(self, server, device_id, perfetto_config_file, targets_map: dict[str, TraceTarget | DumpTarget], perfetto_name):
+        log.debug("Clearing perfetto config file for previous tracing session")
+        call_adb(f"shell su root rm -f {perfetto_config_file}", device_id)
+
+        trace_requests: list[dict] = self.get_request(server)
+        trace_types = [t.get("name") for t in trace_requests]
+        log.debug(f"Received client request of {trace_types} for {device_id}")
+        perfetto_query_result = call_adb("shell perfetto --query", device_id)
+
+        trace_targets: list[tuple[DumpTarget | TraceTarget, TraceConfig | None]] = []
+        for t in trace_requests:
+            try:
+                trace_name = t.get("name")
+                target = targets_map[trace_name]
+                is_perfetto = target.is_perfetto_available(perfetto_query_result)
+                config = None
+                if target.get_trace_config is not None:
+                    config = target.get_trace_config(is_perfetto)
+                    self.apply_config(config, t.get("config"), server, device_id)
+                if trace_name == perfetto_name or not is_perfetto:
+                    trace_targets.append((target, config))
+
+            except KeyError as err:
+                log.warning("Unsupported trace target\n" + str(err))
+        trace_targets = self.move_perfetto_target_to_end_of_list(trace_targets)
+
+        self.check_device_and_permissions(server, device_id)
+        self.clear_last_tracing_session(device_id)
+
+        log.debug("Trace requested for {} with targets {}".format(
+            device_id, ','.join([target.trace_name for target, config in trace_targets])))
+
+        return trace_targets
+
+    def apply_config(self, trace_config: TraceConfig, requested_configs: list[dict], server, device_id):
+        for requested_config in requested_configs:
+            config_key = requested_config.get("key")
+            if not trace_config.is_valid(config_key):
+                raise BadRequest(
+                    f"Unsupported config {config_key}\n")
+            trace_config.add(config_key, requested_config.get("value"))
+
+        if device_id in TRACE_THREADS:
+            BadRequest(f"Trace in progress for {device_id}")
+        if not self.check_root(device_id):
+            raise AdbError(
+                f"Unable to acquire root privileges on the device - check the output of 'adb -s {device_id} shell su root id'")
+        trace_config.execute_command(server, device_id)
+
+    def check_root(self, device_id):
+        log.debug("Checking root access on {}".format(device_id))
+        return int(call_adb('shell su root id -u', device_id)) == 0
+
+    def move_perfetto_target_to_end_of_list(self, targets: list[tuple[TraceTarget, TraceConfig | None]]) -> list[tuple[TraceTarget, TraceConfig | None]]:
         # Make sure a perfetto target (if present) comes last in the list of targets, i.e. will
         # be processed last.
         # A perfetto target must be processed last, so that perfetto tracing is started only after
         # the other targets have been processed and have configured the perfetto config file.
-        def is_perfetto_target(target):
+        def is_perfetto_target(target: TraceTarget):
             return target == TRACE_TARGETS["perfetto_trace"] or target == DUMP_TARGETS["perfetto_dump"]
-        non_perfetto_targets = [t for t in targets if not is_perfetto_target(t)]
-        perfetto_targets = [t for t in targets if is_perfetto_target(t)]
+        non_perfetto_targets = [t for t in targets if not is_perfetto_target(t[0])]
+        perfetto_targets = [t for t in targets if is_perfetto_target(t[0])]
         return non_perfetto_targets + perfetto_targets
 
+    def check_device_and_permissions(self, server, device_id):
+        if device_id in TRACE_THREADS:
+            log.warning("Trace already in progress for {}", device_id)
+            server.respond(HTTPStatus.OK, b'', "text/plain")
+        if not self.check_root(device_id):
+            raise AdbError(
+                "Unable to acquire root privileges on the device - check the output of 'adb -s {} shell su root id'"
+                .format( device_id))
+
+    def clear_last_tracing_session(self, device_id):
+        log.debug("Clearing previous tracing session files from device")
+        call_adb(f"shell su root rm -rf {WINSCOPE_BACKUP_DIR}", device_id)
+        call_adb(f"shell su root mkdir {WINSCOPE_BACKUP_DIR}", device_id)
 
 
 class FetchFilesEndpoint(DeviceRequestEndpoint):
     def process_with_device(self, server, path, device_id):
-        if len(path) != 1:
-            raise BadRequest("File not specified")
-        if path[0] in TRACE_TARGETS:
-            files = TRACE_TARGETS[path[0]].files
-        elif path[0] in DUMP_TARGETS:
-            files = DUMP_TARGETS[path[0]].files
-        else:
-            raise BadRequest("Unknown file specified")
+        file_buffers = self.fetch_existing_files(device_id)
 
-        file_buffers = dict()
-
-        for f in files:
-            file_type = f.get_filetype()
-            file_paths = f.get_filepaths(device_id)
+        j = json.dumps(file_buffers)
+        server.respond(HTTPStatus.OK, j.encode("utf-8"), "text/json")
 
+    def fetch_existing_files(self, device_id):
+        file_buffers = dict()
+        file = FileMatcher(f"{WINSCOPE_BACKUP_DIR}*", "", "")
+        try:
+            file_paths = file.get_filepaths(device_id)
             for file_path in file_paths:
                 with NamedTemporaryFile() as tmp:
+                    file_name = file_path.split('/')[-1] + ".gz"
                     log.debug(
                         f"Fetching file {file_path} from device to {tmp.name}")
-                    call_adb_outfile('exec-out su root cat ' +
-                                     file_path, tmp, device_id)
-                    log.debug(f"Deleting file {file_path} from device")
-                    call_adb('shell su root rm -f ' + file_path, device_id)
+                    try:
+                        call_adb_outfile('exec-out su root cat ' +
+                                            file_path, tmp, device_id)
+                    except AdbError as ex:
+                        log.warning(f"Unable to fetch file {file_path} - {repr(ex)}")
+                        return
                     log.debug(f"Uploading file {tmp.name}")
-                    if file_type not in file_buffers:
-                        file_buffers[file_type] = []
-                    buf = base64.encodebytes(tmp.read()).decode("utf-8")
-                    file_buffers[file_type].append(buf)
-
-        if (len(file_buffers) == 0):
-            log.error("Proxy didn't find any file to fetch")
-
-        # server.send_header('X-Content-Type-Options', 'nosniff')
-        # add_standard_headers(server)
-        j = json.dumps(file_buffers)
-        server.respond(HTTPStatus.OK, j.encode("utf-8"), "text/json")
-
+                    if file_name not in file_buffers:
+                        file_buffers[file_name] = []
+                    buf = base64.encodebytes(gzip.compress(tmp.read())).decode("utf-8")
+                    file_buffers[file_name].append(buf)
+        except:
+            self.log_no_files_warning()
+        return file_buffers
 
-def check_root(device_id):
-    log.debug("Checking root access on {}".format(device_id))
-    return int(call_adb('shell su root id -u', device_id)) == 0
+    def log_no_files_warning(self):
+        log.warning("Proxy didn't find any file to fetch")
 
 
 TRACE_THREADS = {}
 
-
 class TraceThread(threading.Thread):
-    def __init__(self, device_id, command):
-        self._keep_alive_timer = None
+    def __init__(self, trace_name: str, device_id: str, command: str, trace_identifier: str):
         self.trace_command = command
+        self.trace_name = trace_name
+        self.trace_identifier = trace_identifier
         self._device_id = device_id
+        self._keep_alive_timer = None
         self.out = None,
         self.err = None,
         self._success = False
         try:
-            shell = ['adb', '-s', self._device_id, 'shell']
-            log.debug("Starting trace shell {}".format(' '.join(shell)))
+            shell = get_shell_args(self._device_id, "trace")
             self.process = subprocess.Popen(shell, stdout=subprocess.PIPE,
                                             stderr=subprocess.PIPE, stdin=subprocess.PIPE, start_new_session=True)
         except OSError as ex:
             raise AdbError(
-                'Error executing adb command: adb shell\n{}'.format(repr(ex)))
+                'Error executing adb command for trace {}: adb shell\n{}'.format(trace_name, repr(ex)))
 
         super().__init__()
 
     def timeout(self):
         if self.is_alive():
-            log.warning(
-                "Keep-alive timeout for trace on {}".format(self._device_id))
+            log.warning("Keep-alive timeout for {} trace on {}".format(self.trace_name, self._device_id))
             self.end_trace()
-            if self._device_id in TRACE_THREADS:
-                TRACE_THREADS.pop(self._device_id)
 
     def reset_timer(self):
         log.debug(
-            "Resetting keep-alive clock for trace on {}".format(self._device_id))
+            "Resetting keep-alive clock for {} trace on {}".format(self.trace_name, self._device_id))
         if self._keep_alive_timer:
             self._keep_alive_timer.cancel()
         self._keep_alive_timer = threading.Timer(
@@ -904,69 +1228,68 @@ class TraceThread(threading.Thread):
     def end_trace(self):
         if self._keep_alive_timer:
             self._keep_alive_timer.cancel()
-        log.debug("Sending SIGINT to the trace process on {}".format(
+        log.debug("Sending SIGINT to the {} process on {}".format(
+            self.trace_name,
             self._device_id))
         self.process.send_signal(signal.SIGINT)
         try:
-            log.debug("Waiting for trace shell to exit for {}".format(
+            log.debug("Waiting for {} trace shell to exit for {}".format(
+                self.trace_name,
                 self._device_id))
             self.process.wait(timeout=5)
         except TimeoutError:
             log.debug(
-                "TIMEOUT - sending SIGKILL to the trace process on {}".format(self._device_id))
+                "TIMEOUT - sending SIGKILL to the {} trace process on {}".format(self.trace_name, self._device_id))
             self.process.kill()
         self.join()
 
     def run(self):
-        log.debug("Trace started on {}".format(self._device_id))
+        log.debug("Trace {} started on {}".format(self.trace_name, self._device_id))
         self.reset_timer()
         self.out, self.err = self.process.communicate(self.trace_command)
-        log.debug("Trace ended on {}, waiting for cleanup".format(self._device_id))
+        log.debug("Trace {} ended on {}, waiting for cleanup".format(self.trace_name, self._device_id))
         time.sleep(0.2)
         for i in range(50):
-            if call_adb("shell su root cat /data/local/tmp/winscope_status", device=self._device_id) == 'TRACE_OK\n':
-                call_adb(
-                    "shell su root rm /data/local/tmp/winscope_status", device=self._device_id)
-                log.debug("Trace finished successfully on {}".format(
+            if call_adb(f"shell su root cat {WINSCOPE_STATUS}", device=self._device_id) == 'TRACE_OK\n':
+                log.debug("Trace {} finished successfully on {}".format(
+                    self.trace_name,
                     self._device_id))
-                self._success = True
+                if self.trace_name == "perfetto_trace":
+                    self._success = True
+                else:
+                    self._success = len(self.err) == 0
                 break
-            log.debug("Still waiting for cleanup on {}".format(self._device_id))
+            log.debug("Still waiting for cleanup on {} for {}".format(self._device_id, self.trace_name))
             time.sleep(0.1)
 
     def success(self):
         return self._success
 
 
-class StartTrace(DeviceRequestEndpoint):
+class StartTraceEndpoint(DeviceRequestEndpoint):
     TRACE_COMMAND = """
 set -e
 
-{perfetto_utils}
-
 echo "Starting trace..."
-echo "TRACE_START" > /data/local/tmp/winscope_status
+echo "TRACE_START" > {winscope_status}
 
 # Do not print anything to stdout/stderr in the handler
 function stop_trace() {{
-  echo "start" >/data/local/tmp/winscope_signal_handler.log
+  echo "start" >{signal_handler_log}
 
   # redirect stdout/stderr to log file
-  exec 1>>/data/local/tmp/winscope_signal_handler.log
-  exec 2>>/data/local/tmp/winscope_signal_handler.log
+  exec 1>>{signal_handler_log}
+  exec 2>>{signal_handler_log}
 
   set -x
   trap - EXIT HUP INT
   {stop_commands}
-  echo "TRACE_OK" > /data/local/tmp/winscope_status
+  echo "TRACE_OK" > {winscope_status}
 }}
 
 trap stop_trace EXIT HUP INT
 echo "Signal handler registered."
 
-# Clear perfetto config file. The start commands below are going to populate it.
-rm -f {perfetto_config_file}
-
 {start_commands}
 
 # ADB shell does not handle hung up well and does not call HUP handler when a child is active in foreground,
@@ -975,187 +1298,140 @@ while true; do sleep 0.1; done
 """
 
     def process_with_device(self, server, path, device_id):
-        try:
-            requested_types = self.get_request(server)
-            log.debug(f"Clienting requested trace types {requested_types}")
-            requested_traces = [TRACE_TARGETS[t] for t in requested_types]
-            requested_traces = self.move_perfetto_target_to_end_of_list(requested_traces)
-        except KeyError as err:
-            raise BadRequest("Unsupported trace target\n" + str(err))
-        if device_id in TRACE_THREADS:
-            log.warning("Trace already in progress for {}", device_id)
-            server.respond(HTTPStatus.OK, b'', "text/plain")
-        if not check_root(device_id):
-            raise AdbError(
-                "Unable to acquire root privileges on the device - check the output of 'adb -s {} shell su root id'".format(
-                    device_id))
-        command = StartTrace.TRACE_COMMAND.format(
-            perfetto_utils=PERFETTO_UTILS,
-            stop_commands='\n'.join([t.trace_stop for t in requested_traces]),
-            perfetto_config_file=PERFETTO_TRACE_CONFIG_FILE,
-            start_commands='\n'.join([t.trace_start for t in requested_traces]))
-        log.debug("Trace requested for {} with targets {}".format(
-            device_id, ','.join(requested_types)))
-        log.debug(f"Executing command \"{command}\" on {device_id}...")
-        TRACE_THREADS[device_id] = TraceThread(
-            device_id, command.encode('utf-8'))
-        TRACE_THREADS[device_id].start()
-        server.respond(HTTPStatus.OK, b'', "text/plain")
+        trace_targets = self.get_targets_and_prepare_for_tracing(
+            server, device_id, PERFETTO_TRACE_CONFIG_FILE, TRACE_TARGETS, "perfetto_trace")
 
+        for t, config in trace_targets:
+            if config:
+                trace_identifiers = config.get_trace_identifiers()
+            else:
+                trace_identifiers = [""]
+
+            for trace_identifier in trace_identifiers:
+                if trace_identifier:
+                    if config:
+                        options = config.get_optional_start_args(trace_identifier)
+                    else:
+                        options = ""
+                    start_cmd = t.trace_start.format(trace_identifier=trace_identifier, options=options)
+                else:
+                    start_cmd = t.trace_start
+
+                command = StartTraceEndpoint.TRACE_COMMAND.format(
+                    winscope_status=WINSCOPE_STATUS,
+                    signal_handler_log=SIGNAL_HANDLER_LOG,
+                    stop_commands=t.trace_stop,
+                    perfetto_config_file=PERFETTO_TRACE_CONFIG_FILE,
+                    start_commands=start_cmd,
+                )
+                log.debug(f"Executing start command for {t.trace_name} on {device_id}...")
+                thread = TraceThread(t.trace_name, device_id, command.encode('utf-8'), trace_identifier)
+                if device_id not in TRACE_THREADS:
+                    TRACE_THREADS[device_id] = [thread]
+                else:
+                    TRACE_THREADS[device_id].append(thread)
+                thread.start()
 
-class EndTrace(DeviceRequestEndpoint):
-    def process_with_device(self, server, path, device_id):
-        if device_id not in TRACE_THREADS:
-            raise BadRequest("No trace in progress for {}".format(device_id))
-        if TRACE_THREADS[device_id].is_alive():
-            TRACE_THREADS[device_id].end_trace()
-
-        success = TRACE_THREADS[device_id].success()
-
-        signal_handler_log = call_adb("shell su root cat /data/local/tmp/winscope_signal_handler.log", device=device_id).encode('utf-8')
-
-        out = b"### Shell script's stdout - start\n" + \
-            TRACE_THREADS[device_id].out + \
-            b"### Shell script's stdout - end\n" + \
-            b"### Shell script's stderr - start\n" + \
-            TRACE_THREADS[device_id].err + \
-            b"### Shell script's stderr - end\n" + \
-            b"### Signal handler log - start\n" + \
-            signal_handler_log + \
-            b"### Signal handler log - end\n"
-        command = TRACE_THREADS[device_id].trace_command
-        TRACE_THREADS.pop(device_id)
-        if success:
-            server.respond(HTTPStatus.OK, out, "text/plain")
-        else:
-            raise AdbError(
-                "Error tracing the device\n### Output ###\n" + out.decode(
-                    "utf-8") + "\n### Command: adb -s {} shell ###\n### Input ###\n".format(device_id) + command.decode(
-                    "utf-8"))
-
+        server.respond(HTTPStatus.OK, b'', "text/plain")
 
-def execute_command(server, device_id, shell, configType, configValue):
-    process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
-                                   stdin=subprocess.PIPE, start_new_session=True)
-    log.debug(f"Changing trace config on device {device_id} {configType}:{configValue}")
-    out, err = process.communicate(configValue.encode('utf-8'))
-    if process.returncode != 0:
-        raise AdbError(
-            f"Error executing command:\n {configValue}\n\n### OUTPUT ###{out.decode('utf-8')}\n{err.decode('utf-8')}")
-    log.debug(f"Changing trace config finished on device {device_id}")
-    server.respond(HTTPStatus.OK, b'', "text/plain")
 
+def move_collected_files(files: list[File | FileMatcher], device_id, trace_identifier):
+    for f in files:
+        file_paths = f.get_filepaths(device_id)
+        file_type = f.get_filetype().format(trace_identifier=trace_identifier)
 
-class ConfigTrace(DeviceRequestEndpoint):
-    def process_with_device(self, server, path, device_id):
-        try:
-            requested_configs = self.get_request(server)
-            config = SurfaceFlingerTraceConfig()
-            for requested_config in requested_configs:
-                if not config.is_valid(requested_config):
-                    raise BadRequest(
-                        f"Unsupported config {requested_config}\n")
-                config.add(requested_config)
-        except KeyError as err:
-            raise BadRequest("Unsupported trace target\n" + str(err))
-        if device_id in TRACE_THREADS:
-            BadRequest(f"Trace in progress for {device_id}")
-        if not check_root(device_id):
-            raise AdbError(
-                f"Unable to acquire root privileges on the device - check the output of 'adb -s {device_id} shell su root id'")
-        command = config.command()
-        shell = ['adb', '-s', device_id, 'shell']
-        log.debug(f"Starting shell {' '.join(shell)}")
-        execute_command(server, device_id, shell, "sf buffer size", command)
-
-
-def add_selected_request_to_config(self, server, device_id, config):
-    try:
-        requested_configs = self.get_request(server)
-        for requested_config in requested_configs:
-            if config.is_valid(requested_config):
-                config.add(requested_config, requested_configs[requested_config])
-            else:
-                raise BadRequest(
-                        f"Unsupported config {requested_config}\n")
-    except KeyError as err:
-        raise BadRequest("Unsupported trace target\n" + str(err))
-    if device_id in TRACE_THREADS:
-        BadRequest(f"Trace in progress for {device_id}")
-    if not check_root(device_id):
-        raise AdbError(
-            f"Unable to acquire root privileges on the device - check the output of 'adb -s {device_id} shell su root id'")
-    return config
+        for file_path in file_paths:
+            formatted_path = file_path.format(trace_identifier=trace_identifier)
+            log.debug(f"Moving file {formatted_path} to {WINSCOPE_BACKUP_DIR}{file_type} on device")
+            try:
+                call_adb(
+                    f"shell su root [ ! -f {formatted_path} ] || su root mv {formatted_path} {WINSCOPE_BACKUP_DIR}{file_type}",
+                    device_id)
+            except AdbError as ex:
+                log.warning(f"Unable to move file {formatted_path} - {repr(ex)}")
 
 
-class SurfaceFlingerSelectedConfigTrace(DeviceRequestEndpoint):
+class EndTraceEndpoint(DeviceRequestEndpoint):
     def process_with_device(self, server, path, device_id):
-        config = SurfaceFlingerTraceSelectedConfig()
-        config = add_selected_request_to_config(self, server, device_id, config)
-        setBufferSize = config.setBufferSize()
-        shell = ['adb', '-s', device_id, 'shell']
-        log.debug(f"Starting shell {' '.join(shell)}")
-        execute_command(server, device_id, shell, "sf buffer size", setBufferSize)
+        if device_id not in TRACE_THREADS:
+            raise BadRequest("No trace in progress for {}".format(device_id))
 
+        errors: list[str] = []
+
+        for thread in TRACE_THREADS[device_id]:
+            if thread.is_alive():
+                thread.end_trace()
+            success = thread.success()
+            signal_handler_log = call_adb(f"shell su root cat {SIGNAL_HANDLER_LOG}", device=device_id).encode('utf-8')
+            out = b"### Shell script's stdout - start\n" + \
+                thread.out + \
+                b"### Shell script's stdout - end\n" + \
+                b"### Shell script's stderr - start\n" + \
+                thread.err + \
+                b"### Shell script's stderr - end\n" + \
+                b"### Signal handler log - start\n" + \
+                signal_handler_log + \
+                b"### Signal handler log - end\n"
+            if not success:
+                log.error(
+                    "Error ending trace {} on the device\n### Output ###\n".format(thread.trace_name) + out.decode(
+                        "utf-8")
+                )
+                errors.append("Error ending trace {} on the device: {}".format(thread.trace_name, thread.err))
+            if thread.trace_name in TRACE_TARGETS:
+                files = TRACE_TARGETS[thread.trace_name].files
+                move_collected_files(files, device_id, thread.trace_identifier)
+            else:
+                errors.append(f"File location unknown for {thread.trace_name}")
 
-class WindowManagerSelectedConfigTrace(DeviceRequestEndpoint):
-    def process_with_device(self, server, path, device_id):
-        config = WindowManagerTraceSelectedConfig()
-        config = add_selected_request_to_config(self, server, device_id, config)
-        setBufferSize = config.setBufferSize()
-        setTracingType = config.setTracingType()
-        setTracingLevel = config.setTracingLevel()
-        shell = ['adb', '-s', device_id, 'shell']
-        log.debug(f"Starting shell {' '.join(shell)}")
-        execute_command(server, device_id, shell, "tracing type", setTracingType)
-        execute_command(server, device_id, shell, "tracing level", setTracingLevel)
-        # /!\ buffer size must be configured last
-        # otherwise the other configurations might override it
-        execute_command(server, device_id, shell, "wm buffer size", setBufferSize)
+        call_adb(f"shell su root rm {WINSCOPE_STATUS}", device=device_id)
+        TRACE_THREADS.pop(device_id)
+        server.respond(HTTPStatus.OK, json.dumps(errors).encode("utf-8"), "text/plain")
 
 
 class StatusEndpoint(DeviceRequestEndpoint):
     def process_with_device(self, server, path, device_id):
         if device_id not in TRACE_THREADS:
             raise BadRequest("No trace in progress for {}".format(device_id))
-        TRACE_THREADS[device_id].reset_timer()
-        server.respond(HTTPStatus.OK, str(
-            TRACE_THREADS[device_id].is_alive()).encode("utf-8"), "text/plain")
+        for thread in TRACE_THREADS[device_id]:
+            thread.reset_timer()
+        server.respond(HTTPStatus.OK, str(TRACE_THREADS[device_id][0].is_alive()).encode("utf-8"), "text/plain")
 
 
 class DumpEndpoint(DeviceRequestEndpoint):
     def process_with_device(self, server, path, device_id):
-        try:
-            requested_types = self.get_request(server)
-            requested_traces = [DUMP_TARGETS[t] for t in requested_types]
-            requested_traces = self.move_perfetto_target_to_end_of_list(requested_traces)
-        except KeyError as err:
-            raise BadRequest("Unsupported trace target\n" + str(err))
-        if device_id in TRACE_THREADS:
-            BadRequest("Trace in progress for {}".format(device_id))
-        if not check_root(device_id):
-            raise AdbError(
-                "Unable to acquire root privileges on the device - check the output of 'adb -s {} shell su root id'"
-                .format(device_id))
-        dump_commands = '\n'.join(t.dump_command for t in requested_traces)
-        command = f"""
-{PERFETTO_UTILS}
+        dump_targets = self.get_targets_and_prepare_for_tracing(
+            server, device_id, PERFETTO_DUMP_CONFIG_FILE, DUMP_TARGETS, "perfetto_dump")
+
+        dump_commands = []
+        for t, config in dump_targets:
+            if config:
+                for trace_identifier in config.get_trace_identifiers():
+                    dump_commands.append(
+                        t.dump_command.format(trace_identifier=trace_identifier, options=config.get_optional_start_args(trace_identifier)))
+            else:
+                dump_commands.append(t.dump_command)
 
-# Clear perfetto config file. The commands below are going to populate it.
-rm -f {PERFETTO_DUMP_CONFIG_FILE}
+        dump_commands = '\n'.join(dump_commands)
 
-{dump_commands}
-"""
-        shell = ['adb', '-s', device_id, 'shell']
-        log.debug("Starting dump shell {}".format(' '.join(shell)))
+        shell = get_shell_args(device_id, "dump")
         process = subprocess.Popen(shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                                    stdin=subprocess.PIPE, start_new_session=True)
         log.debug("Starting dump on device {}".format(device_id))
-        out, err = process.communicate(command.encode('utf-8'))
+        out, err = process.communicate(dump_commands.encode('utf-8'))
         if process.returncode != 0:
-            raise AdbError("Error executing command:\n" + command + "\n\n### OUTPUT ###" + out.decode('utf-8') + "\n"
+            raise AdbError("Error executing dump command." + "\n\n### OUTPUT ###" + out.decode('utf-8') + "\n"
                            + err.decode('utf-8'))
         log.debug("Dump finished on device {}".format(device_id))
+
+        for target, config in dump_targets:
+            if config:
+                trace_identifiers = config.get_trace_identifiers()
+                for trace_identifier in trace_identifiers:
+                    move_collected_files(target.files, device_id, trace_identifier)
+            else:
+                move_collected_files(target.files, device_id, "")
+
         server.respond(HTTPStatus.OK, b'', "text/plain")
 
 
@@ -1169,15 +1445,9 @@ class ADBWinscopeProxy(BaseHTTPRequestHandler):
             RequestType.GET, "status", StatusEndpoint())
         self.router.register_endpoint(
             RequestType.GET, "fetch", FetchFilesEndpoint())
-        self.router.register_endpoint(RequestType.POST, "start", StartTrace())
-        self.router.register_endpoint(RequestType.POST, "end", EndTrace())
+        self.router.register_endpoint(RequestType.POST, "start", StartTraceEndpoint())
+        self.router.register_endpoint(RequestType.POST, "end", EndTraceEndpoint())
         self.router.register_endpoint(RequestType.POST, "dump", DumpEndpoint())
-        self.router.register_endpoint(
-            RequestType.POST, "configtrace", ConfigTrace())
-        self.router.register_endpoint(
-            RequestType.POST, "selectedsfconfigtrace", SurfaceFlingerSelectedConfigTrace())
-        self.router.register_endpoint(
-            RequestType.POST, "selectedwmconfigtrace", WindowManagerSelectedConfigTrace())
         self.router.register_endpoint(
             RequestType.GET, "checkwayland", CheckWaylandServiceEndpoint(listDevicesEndpoint))
         super().__init__(request, client_address, server)
diff --git a/tools/winscope/src/app/app_module.ts b/tools/winscope/src/app/app_module.ts
index 5a1c7d42b..e0fea16ad 100644
--- a/tools/winscope/src/app/app_module.ts
+++ b/tools/winscope/src/app/app_module.ts
@@ -17,6 +17,7 @@
 import {ClipboardModule} from '@angular/cdk/clipboard';
 import {DragDropModule} from '@angular/cdk/drag-drop';
 import {CdkMenuModule} from '@angular/cdk/menu';
+import {OverlayModule} from '@angular/cdk/overlay';
 import {ScrollingModule} from '@angular/cdk/scrolling';
 import {CommonModule} from '@angular/common';
 import {HttpClientModule} from '@angular/common/http';
@@ -38,11 +39,13 @@ import {MatRadioModule} from '@angular/material/radio';
 import {MatSelectModule} from '@angular/material/select';
 import {MatSliderModule} from '@angular/material/slider';
 import {MatSnackBarModule} from '@angular/material/snack-bar';
+import {MatTableModule} from '@angular/material/table';
 import {MatTabsModule} from '@angular/material/tabs';
 import {MatToolbarModule} from '@angular/material/toolbar';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserModule, Title} from '@angular/platform-browser';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {LogComponent} from 'viewers/common/log_component';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
 import {CoordinatesTableComponent} from 'viewers/components/coordinates_table_component';
@@ -53,6 +56,7 @@ import {PropertiesComponent} from 'viewers/components/properties_component';
 import {PropertiesTableComponent} from 'viewers/components/properties_table_component';
 import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
 import {RectsComponent} from 'viewers/components/rects/rects_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {SurfaceFlingerPropertyGroupsComponent} from 'viewers/components/surface_flinger_property_groups_component';
 import {TransformMatrixComponent} from 'viewers/components/transform_matrix_component';
@@ -61,9 +65,11 @@ import {TreeNodeComponent} from 'viewers/components/tree_node_component';
 import {UserOptionsComponent} from 'viewers/components/user_options_component';
 import {ViewerInputMethodComponent} from 'viewers/components/viewer_input_method_component';
 import {ViewCapturePropertyGroupsComponent} from 'viewers/components/view_capture_property_groups_component';
+import {ViewerInputComponent} from 'viewers/viewer_input/viewer_input_component';
+import {ViewerJankCujsComponent} from 'viewers/viewer_jank_cujs/viewer_jank_cujs_component';
+import {ViewerMediaBasedComponent} from 'viewers/viewer_media_based/viewer_media_based_component';
 import {ProtologScrollDirective} from 'viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive';
 import {ViewerProtologComponent} from 'viewers/viewer_protolog/viewer_protolog_component';
-import {ViewerScreenRecordingComponent} from 'viewers/viewer_screen_recording/viewer_screen_recording_component';
 import {ViewerSurfaceFlingerComponent} from 'viewers/viewer_surface_flinger/viewer_surface_flinger_component';
 import {TransactionsScrollDirective} from 'viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive';
 import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_transactions_component';
@@ -90,6 +96,7 @@ import {TimelineComponent} from './components/timeline/timeline_component';
 import {TraceConfigComponent} from './components/trace_config_component';
 import {TraceViewComponent} from './components/trace_view_component';
 import {UploadTracesComponent} from './components/upload_traces_component';
+import {WarningDialogComponent} from './components/warning_dialog_component';
 import {WebAdbComponent} from './components/web_adb_component';
 import {GlobalErrorHandler} from './global_error_handler';
 
@@ -98,10 +105,12 @@ import {GlobalErrorHandler} from './global_error_handler';
     AppComponent,
     ViewerWindowManagerComponent,
     ViewerSurfaceFlingerComponent,
+    ViewerInputComponent,
     ViewerInputMethodComponent,
     ViewerProtologComponent,
+    ViewerJankCujsComponent,
     ViewerTransactionsComponent,
-    ViewerScreenRecordingComponent,
+    ViewerMediaBasedComponent,
     ViewerTransitionsComponent,
     ViewerViewCaptureComponent,
     CollectTracesComponent,
@@ -141,6 +150,9 @@ import {GlobalErrorHandler} from './global_error_handler';
     CollapsedSectionsComponent,
     CollapsibleSectionTitleComponent,
     UserOptionsComponent,
+    LogComponent,
+    WarningDialogComponent,
+    SearchBoxComponent,
   ],
   imports: [
     BrowserModule,
@@ -173,6 +185,8 @@ import {GlobalErrorHandler} from './global_error_handler';
     ReactiveFormsModule,
     CdkMenuModule,
     MatDialogModule,
+    MatTableModule,
+    OverlayModule,
   ],
   providers: [Title, {provide: ErrorHandler, useClass: GlobalErrorHandler}],
   schemas: [CUSTOM_ELEMENTS_SCHEMA],
diff --git a/tools/winscope/src/app/colors.ts b/tools/winscope/src/app/colors.ts
index e6f42beaf..005ebaab4 100644
--- a/tools/winscope/src/app/colors.ts
+++ b/tools/winscope/src/app/colors.ts
@@ -15,18 +15,12 @@
  */
 
 export enum Color {
-  ACTIVE_POINTER = '#1967D2',
+  ACTIVE_BORDER = '#1967D2',
+  ACTIVE_POINTER = ACTIVE_BORDER,
   BOOKMARK = '#E88C65',
+  CHIP_BLUE = '#b4c8ef',
   GUIDE_BAR = '#9AA0A6',
-  ACTIVE_BORDER = ACTIVE_POINTER,
-  HOVER_ELEMENT_BACKGROUND = 'rgba(127, 127, 127, 0.5)',
-  ADDED_ELEMENT_BACKGROUND = 'rgba(3, 255, 53, 0.5)',
-  DELETED_ELEMENT_BACKGROUND = 'rgba(255, 107, 107, 0.5)',
-  MODIFIED_ELEMENT_BACKGROUND = 'rgba(0, 255, 255, 0.4)',
+  PINNED_ITEM_BORDER = '#FFC24B',
   TEXT_BLACK = 'rgba(0, 0, 0, 0.87)',
   TEXT_GRAY = '#9b9b9b',
-  CHIP_BLUE = '#448aff',
-  CHIP_GREEN = '#00c853',
-  CHIP_RED = '#ff6b6b',
-  CHIP_ORANGE = '#ffaa6b',
 }
diff --git a/tools/winscope/src/app/components/adb_proxy_component.ts b/tools/winscope/src/app/components/adb_proxy_component.ts
index 6254c8e94..ade5b7357 100644
--- a/tools/winscope/src/app/components/adb_proxy_component.ts
+++ b/tools/winscope/src/app/components/adb_proxy_component.ts
@@ -14,23 +14,21 @@
  * limitations under the License.
  */
 import {Component, EventEmitter, Input, Output} from '@angular/core';
+import {Download} from 'common/download';
 import {UrlUtils} from 'common/url_utils';
-import {
-  proxyClient,
-  ProxyClient,
-  ProxyState,
-} from 'trace_collection/proxy_client';
+import {ConnectionState} from 'trace_collection/connection_state';
+import {ProxyConnection} from 'trace_collection/proxy_connection';
 
 @Component({
   selector: 'adb-proxy',
   template: `
-    <ng-container [ngSwitch]="proxy.state">
-      <ng-container *ngSwitchCase="states.NO_PROXY">
+    <ng-container [ngSwitch]="state">
+      <ng-container *ngSwitchCase="${ConnectionState.NOT_FOUND}">
         <div class="further-adb-info-text">
           <p class="mat-body-1">
             Launch the Winscope ADB Connect proxy to capture traces directly from your browser.
           </p>
-          <p class="mat-body-1">Python 3.5+ and ADB are required. Run this command:</p>
+          <p class="mat-body-1">Python 3.10+ and ADB are required. Run this command:</p>
           <mat-form-field class="proxy-command-form" appearance="outline">
             <input matInput readonly [value]="proxyCommand" />
             <button
@@ -58,7 +56,7 @@ import {
         </div>
       </ng-container>
 
-      <ng-container *ngSwitchCase="states.INVALID_VERSION">
+      <ng-container *ngSwitchCase="${ConnectionState.INVALID_VERSION}">
         <div class="further-adb-info-text">
           <p class="icon-information mat-body-1">
             <mat-icon class="adb-icon">update</mat-icon>
@@ -94,17 +92,17 @@ import {
         </div>
       </ng-container>
 
-      <ng-container *ngSwitchCase="states.UNAUTH">
+      <ng-container *ngSwitchCase="${ConnectionState.UNAUTH}">
         <div class="further-adb-info-text">
           <p class="icon-information mat-body-1">
             <mat-icon class="adb-icon">lock</mat-icon>
-            <span class="adb-info">Proxy authorisation required.</span>
+            <span class="adb-info">Proxy authorization required.</span>
           </p>
           <p class="mat-body-1">Enter Winscope proxy token:</p>
           <mat-form-field
-            class="proxy-key-input-field"
-            (keydown.enter)="onKeydownEnterProxyKeyInput($event)">
-            <input matInput [(ngModel)]="proxyKeyItem" name="proxy-key" />
+            class="proxy-token-input-field"
+            (keydown.enter)="onKeydownEnterProxyTokenInput($event)">
+            <input matInput [(ngModel)]="proxyToken" name="proxy-token" />
           </mat-form-field>
           <p class="mat-body-1">
             The proxy token is printed to console on proxy launch, copy and paste it above.
@@ -156,37 +154,28 @@ import {
   ],
 })
 export class AdbProxyComponent {
-  @Input()
-  proxy: ProxyClient = proxyClient;
+  @Input() state: ConnectionState | undefined;
+  @Output() readonly retryConnection = new EventEmitter<string>();
 
-  @Output()
-  readonly proxyChange = new EventEmitter<ProxyClient>();
-
-  @Output()
-  readonly addKey = new EventEmitter<string>();
-
-  states = ProxyState;
-  proxyKeyItem = '';
-  readonly proxyVersion = this.proxy.VERSION;
   readonly downloadProxyUrl: string =
     UrlUtils.getRootUrl() + 'winscope_proxy.py';
   readonly proxyCommand: string =
     'python3 $ANDROID_BUILD_TOP/development/tools/winscope/src/adb/winscope_proxy.py';
+  readonly proxyVersion = ProxyConnection.VERSION;
+  proxyToken = '';
 
-  async onRetryButtonClick() {
-    if (this.proxyKeyItem.length > 0) {
-      this.addKey.emit(this.proxyKeyItem);
+  onRetryButtonClick() {
+    if (this.state !== ConnectionState.UNAUTH || this.proxyToken.length > 0) {
+      this.retryConnection.emit(this.proxyToken);
     }
-    await this.proxy.setState(this.states.CONNECTING);
-    this.proxyChange.emit(this.proxy);
   }
 
-  async onKeydownEnterProxyKeyInput(event: MouseEvent) {
+  onKeydownEnterProxyTokenInput(event: MouseEvent) {
     (event.target as HTMLInputElement).blur();
-    await this.onRetryButtonClick();
+    this.onRetryButtonClick();
   }
 
   onDownloadProxyClick() {
-    window.open(this.downloadProxyUrl, '_blank')?.focus();
+    Download.fromUrl(this.downloadProxyUrl, 'winscope_proxy.py');
   }
 }
diff --git a/tools/winscope/src/app/components/adb_proxy_component_test.ts b/tools/winscope/src/app/components/adb_proxy_component_test.ts
index 427ac0267..aacdc056a 100644
--- a/tools/winscope/src/app/components/adb_proxy_component_test.ts
+++ b/tools/winscope/src/app/components/adb_proxy_component_test.ts
@@ -16,13 +16,15 @@
 import {CommonModule} from '@angular/common';
 import {NO_ERRORS_SCHEMA} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
 import {MatButtonModule} from '@angular/material/button';
 import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatIconModule} from '@angular/material/icon';
 import {MatInputModule} from '@angular/material/input';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
-import {proxyClient, ProxyState} from 'trace_collection/proxy_client';
+import {Download} from 'common/download';
+import {ConnectionState} from 'trace_collection/connection_state';
 import {AdbProxyComponent} from './adb_proxy_component';
 
 describe('AdbProxyComponent', () => {
@@ -39,106 +41,125 @@ describe('AdbProxyComponent', () => {
         MatInputModule,
         BrowserAnimationsModule,
         MatButtonModule,
+        FormsModule,
       ],
       declarations: [AdbProxyComponent],
       schemas: [NO_ERRORS_SCHEMA],
     }).compileComponents();
     fixture = TestBed.createComponent(AdbProxyComponent);
     component = fixture.componentInstance;
-    component.proxy = proxyClient;
     htmlElement = fixture.nativeElement;
+    component.state = ConnectionState.CONNECTING;
   });
 
   it('can be created', () => {
     expect(component).toBeTruthy();
   });
 
-  it('check correct icon and message displays if no proxy', async () => {
-    await component.proxy.setState(ProxyState.NO_PROXY);
+  it('correct icon and message displays if no proxy', () => {
+    component.state = ConnectionState.NOT_FOUND;
     fixture.detectChanges();
     expect(
-      htmlElement.querySelector('.further-adb-info-text')?.innerHTML,
+      htmlElement.querySelector('.further-adb-info-text')?.textContent,
     ).toContain('Launch the Winscope ADB Connect proxy');
   });
 
-  it('check correct icon and message displays if invalid proxy', async () => {
-    await component.proxy.setState(ProxyState.INVALID_VERSION);
+  it('correct icon and message displays if invalid proxy', () => {
+    component.state = ConnectionState.INVALID_VERSION;
     fixture.detectChanges();
-    expect(htmlElement.querySelector('.adb-info')?.innerHTML).toBe(
-      'Your local proxy version is incompatible with Winscope.',
+    expect(
+      htmlElement.querySelector('.further-adb-info-text')?.textContent,
+    ).toContain(
+      `Your local proxy version is incompatible with Winscope. Please update the proxy to version ${component.proxyVersion}.`,
+    );
+    expect(htmlElement.querySelector('.adb-icon')?.textContent).toEqual(
+      'update',
     );
-    expect(htmlElement.querySelector('.adb-icon')?.innerHTML).toBe('update');
   });
 
-  it('check correct icon and message displays if unauthorised proxy', async () => {
-    await component.proxy.setState(ProxyState.UNAUTH);
+  it('correct icon and message displays if unauthorized proxy', () => {
+    component.state = ConnectionState.UNAUTH;
     fixture.detectChanges();
-    expect(htmlElement.querySelector('.adb-info')?.innerHTML).toBe(
-      'Proxy authorisation required.',
+    expect(htmlElement.querySelector('.adb-info')?.textContent).toEqual(
+      'Proxy authorization required.',
     );
-    expect(htmlElement.querySelector('.adb-icon')?.innerHTML).toBe('lock');
+    expect(htmlElement.querySelector('.adb-icon')?.textContent).toEqual('lock');
   });
 
-  it('check download proxy button downloads proxy', async () => {
-    await component.proxy.setState(ProxyState.NO_PROXY);
+  it('download proxy button downloads proxy', () => {
+    component.state = ConnectionState.NOT_FOUND;
     fixture.detectChanges();
-    const spy = spyOn(window, 'open');
-    const button: HTMLButtonElement | null = htmlElement.querySelector(
-      '.download-proxy-btn',
+    const spy = spyOn(Download, 'fromUrl');
+    const button = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.download-proxy-btn'),
     );
-    expect(button).toBeInstanceOf(HTMLButtonElement);
-    button?.click();
+    button.click();
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalledWith(component.downloadProxyUrl, '_blank');
+    expect(spy).toHaveBeenCalledWith(
+      component.downloadProxyUrl,
+      'winscope_proxy.py',
+    );
   });
 
-  it('check retry button if no proxy trys to reconnect proxy', async () => {
-    await component.proxy.setState(ProxyState.NO_PROXY);
+  it('retry button emits event', () => {
+    component.state = ConnectionState.NOT_FOUND;
     fixture.detectChanges();
-    const button: HTMLButtonElement | null =
-      htmlElement.querySelector('.retry');
-    expect(button).toBeInstanceOf(HTMLButtonElement);
-    button?.click();
+
+    const spy = spyOn(assertDefined(component.retryConnection), 'emit');
+    const button = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.retry'),
+    );
+    button.click();
     fixture.detectChanges();
-    expect(component.proxy.state).toBe(ProxyState.CONNECTING);
+    expect(spy).toHaveBeenCalledWith('');
   });
 
-  it('check input proxy token saved as expected', async () => {
-    const spy = spyOn(component.addKey, 'emit');
-
-    await component.proxy.setState(ProxyState.UNAUTH);
+  it('input proxy token saved as expected', () => {
+    const spy = spyOn(assertDefined(component.retryConnection), 'emit');
+    component.state = ConnectionState.UNAUTH;
     fixture.detectChanges();
-    let button: HTMLButtonElement | null = htmlElement.querySelector('.retry');
-    button?.click();
+
+    const button = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.retry'),
+    );
+    button.click();
     fixture.detectChanges();
     expect(spy).not.toHaveBeenCalled();
 
-    await component.proxy.setState(ProxyState.UNAUTH);
-    component.proxyKeyItem = '12345';
+    const proxyTokenInput = assertDefined(
+      htmlElement.querySelector<HTMLInputElement>(
+        '.proxy-token-input-field input',
+      ),
+    );
+    proxyTokenInput.value = '12345';
+    proxyTokenInput.dispatchEvent(new Event('input'));
     fixture.detectChanges();
-    button = htmlElement.querySelector('.retry');
-    button?.click();
+
+    assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.retry'),
+    ).click();
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalled();
+    expect(spy).toHaveBeenCalledWith('12345');
   });
 
-  it('retries proxy connection on enter key', async () => {
-    const spy = spyOn(component.proxyChange, 'emit');
-    await component.proxy.setState(ProxyState.UNAUTH);
+  it('emits event on enter key', () => {
+    const spy = spyOn(assertDefined(component.retryConnection), 'emit');
+    component.state = ConnectionState.UNAUTH;
     fixture.detectChanges();
-    const proxyKeyInputField = assertDefined(
-      htmlElement.querySelector('.proxy-key-input-field'),
-    ) as HTMLInputElement;
-    const proxyKeyInput = assertDefined(
-      proxyKeyInputField.querySelector('input'),
-    ) as HTMLInputElement;
-
-    proxyKeyInput.value = '12345';
-    proxyKeyInputField.dispatchEvent(
+
+    const proxyTokenInputField = assertDefined(
+      htmlElement.querySelector('.proxy-token-input-field'),
+    );
+    const proxyTokenInput = assertDefined(
+      proxyTokenInputField.querySelector<HTMLInputElement>('input'),
+    );
+
+    proxyTokenInput.value = '12345';
+    proxyTokenInput.dispatchEvent(new Event('input'));
+    proxyTokenInputField.dispatchEvent(
       new KeyboardEvent('keydown', {key: 'Enter'}),
     );
     fixture.detectChanges();
-    await fixture.whenStable();
-    expect(spy).toHaveBeenCalled();
+    expect(spy).toHaveBeenCalledWith('12345');
   });
 });
diff --git a/tools/winscope/src/app/components/app_component.ts b/tools/winscope/src/app/components/app_component.ts
index 5b2c19ac5..f2cb1a0a6 100644
--- a/tools/winscope/src/app/components/app_component.ts
+++ b/tools/winscope/src/app/components/app_component.ts
@@ -31,15 +31,18 @@ import {AbtChromeExtensionProtocol} from 'abt_chrome_extension/abt_chrome_extens
 import {Mediator} from 'app/mediator';
 import {TimelineData} from 'app/timeline_data';
 import {TracePipeline} from 'app/trace_pipeline';
+import {Download} from 'common/download';
 import {FileUtils} from 'common/file_utils';
 import {globalConfig} from 'common/global_config';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {PersistentStore} from 'common/persistent_store';
-import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {Timestamp} from 'common/time';
 import {UrlUtils} from 'common/url_utils';
+import {UserNotifier} from 'common/user_notifier';
 import {CrossToolProtocol} from 'cross_tool/cross_tool_protocol';
 import {Analytics} from 'logging/analytics';
+import {ProgressListener} from 'messaging/progress_listener';
 import {
   AppFilesCollected,
   AppFilesUploaded,
@@ -52,16 +55,16 @@ import {
   WinscopeEventType,
 } from 'messaging/winscope_event';
 import {WinscopeEventListener} from 'messaging/winscope_event_listener';
-import {proxyClient, ProxyState} from 'trace_collection/proxy_client';
-import {
-  TraceConfigurationMap,
-  TRACES,
-} from 'trace_collection/trace_collection_utils';
+import {AdbConnection} from 'trace_collection/adb_connection';
+import {AdbFiles} from 'trace_collection/adb_files';
+import {ProxyConnection} from 'trace_collection/proxy_connection';
 import {iconDividerStyle} from 'viewers/components/styles/icon_divider.styles';
 import {ViewerInputMethodComponent} from 'viewers/components/viewer_input_method_component';
 import {Viewer} from 'viewers/viewer';
+import {ViewerInputComponent} from 'viewers/viewer_input/viewer_input_component';
+import {ViewerJankCujsComponent} from 'viewers/viewer_jank_cujs/viewer_jank_cujs_component';
+import {ViewerMediaBasedComponent} from 'viewers/viewer_media_based/viewer_media_based_component';
 import {ViewerProtologComponent} from 'viewers/viewer_protolog/viewer_protolog_component';
-import {ViewerScreenRecordingComponent} from 'viewers/viewer_screen_recording/viewer_screen_recording_component';
 import {ViewerSurfaceFlingerComponent} from 'viewers/viewer_surface_flinger/viewer_surface_flinger_component';
 import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_transactions_component';
 import {ViewerTransitionsComponent} from 'viewers/viewer_transitions/viewer_transitions_component';
@@ -84,55 +87,62 @@ import {UploadTracesComponent} from './upload_traces_component';
       </div>
 
       <div class="horizontal-align vertical-align">
-        <div *ngIf="showDataLoadedElements" class="file-descriptor vertical-align">
-          <button
-            mat-icon-button
-            *ngIf="showCrossToolSyncButton()"
-            [matTooltip]="getCrossToolSyncTooltip()"
-            class="cross-tool-sync-button"
-            (click)="onCrossToolSyncButtonClick()"
-            [color]="getCrossToolSyncButtonColor()">
-            <mat-icon class="material-symbols-outlined">cloud_sync</mat-icon>
-          </button>
-          <span *ngIf="!isEditingFilename" class="download-file-info mat-body-2">
-            {{ filenameFormControl.value }}
-          </span>
-          <span *ngIf="!isEditingFilename" class="download-file-ext mat-body-2">.zip</span>
-          <mat-form-field
-            class="file-name-input-field"
-            *ngIf="isEditingFilename"
-            floatLabel="always"
-            (keydown.enter)="onCheckIconClick()"
-            (focusout)="onCheckIconClick()"
-            matTooltip="Allowed: A-Z a-z 0-9 . _ - #">
-            <mat-label>Edit file name</mat-label>
-            <input matInput class="right-align" [formControl]="filenameFormControl" />
-            <span matSuffix>.zip</span>
-          </mat-form-field>
-          <button
-            *ngIf="isEditingFilename"
-            mat-icon-button
-            class="check-button"
-            matTooltip="Submit file name"
-            (click)="onCheckIconClick()">
-            <mat-icon>check</mat-icon>
-          </button>
-          <button
-            *ngIf="!isEditingFilename"
-            mat-icon-button
-            class="edit-button"
-            matTooltip="Edit file name"
-            (click)="onPencilIconClick()">
-            <mat-icon>edit</mat-icon>
-          </button>
-          <button
-            mat-icon-button
-            [disabled]="isEditingFilename"
-            matTooltip="Download all traces"
-            class="save-button"
-            (click)="onDownloadTracesButtonClick()">
-            <mat-icon class="material-symbols-outlined">download</mat-icon>
-          </button>
+        <div *ngIf="showDataLoadedElements" class="download-files-section">
+          <div class="file-descriptor vertical-align">
+            <button
+              mat-icon-button
+              *ngIf="showCrossToolSyncButton()"
+              [matTooltip]="getCrossToolSyncTooltip()"
+              class="cross-tool-sync-button"
+              (click)="onCrossToolSyncButtonClick()"
+              [color]="getCrossToolSyncButtonColor()">
+              <mat-icon class="material-symbols-outlined">cloud_sync</mat-icon>
+            </button>
+            <span *ngIf="!isEditingFilename" class="download-file-info mat-body-2">
+              {{ filenameFormControl.value }}
+            </span>
+            <span *ngIf="!isEditingFilename" class="download-file-ext mat-body-2">.zip</span>
+            <mat-form-field
+              class="file-name-input-field"
+              *ngIf="isEditingFilename"
+              floatLabel="always"
+              (keydown.enter)="onCheckIconClick()"
+              (focusout)="onCheckIconClick()"
+              matTooltip="Allowed: A-Z a-z 0-9 . _ - #">
+              <mat-label>Edit file name</mat-label>
+              <input matInput class="right-align" [formControl]="filenameFormControl" />
+              <span matSuffix>.zip</span>
+            </mat-form-field>
+            <button
+              *ngIf="isEditingFilename"
+              mat-icon-button
+              class="check-button"
+              matTooltip="Submit file name"
+              (click)="onCheckIconClick()">
+              <mat-icon>check</mat-icon>
+            </button>
+            <button
+              *ngIf="!isEditingFilename"
+              mat-icon-button
+              class="edit-button"
+              matTooltip="Edit file name"
+              (click)="onPencilIconClick()">
+              <mat-icon>edit</mat-icon>
+            </button>
+            <button
+              mat-icon-button
+              [disabled]="isEditingFilename"
+              matTooltip="Download all traces"
+              class="save-button"
+              (click)="onDownloadTracesButtonClick()">
+              <mat-icon class="material-symbols-outlined">download</mat-icon>
+            </button>
+          </div>
+          <mat-progress-bar
+            *ngIf="downloadProgress !== undefined"
+            mode="determinate"
+            [value]="downloadProgress">
+          </mat-progress-bar>
         </div>
 
         <div *ngIf="showDataLoadedElements" class="icon-divider toolbar-icon-divider"></div>
@@ -204,6 +214,7 @@ import {UploadTracesComponent} from './upload_traces_component';
       <mat-drawer #drawer mode="overlay" opened="true" [baseHeight]="collapsedTimelineHeight">
         <timeline
           *ngIf="dataLoaded"
+          [allTraces]="tracePipeline.getTraces()"
           [timelineData]="timelineData"
           [store]="store"
           (collapsedTimelineSizeChanged)="onCollapsedTimelineSizeChanged($event)"></timeline>
@@ -220,16 +231,17 @@ import {UploadTracesComponent} from './upload_traces_component';
           <div class="card-grid landing-grid">
             <collect-traces
               class="collect-traces-card homepage-card"
-              [traceConfig]="traceConfig"
-              [dumpConfig]="dumpConfig"
               [storage]="traceConfigStorage"
+              [adbConnection]="adbConnection"
               (filesCollected)="onFilesCollected($event)"></collect-traces>
 
             <upload-traces
+              #uploadTraces
               class="upload-traces-card homepage-card"
               [tracePipeline]="tracePipeline"
               (filesUploaded)="onFilesUploaded($event)"
-              (viewTracesButtonClick)="onViewTracesButtonClick()"></upload-traces>
+              (viewTracesButtonClick)="onViewTracesButtonClick()"
+              (downloadTracesClick)="onDownloadTracesButtonClick(uploadTraces)"></upload-traces>
           </div>
         </div>
       </div>
@@ -254,7 +266,7 @@ import {UploadTracesComponent} from './upload_traces_component';
         flex-direction: column;
         flex: 1;
         overflow: auto;
-        height: 820px;
+        height: 870px;
       }
       .horizontal-align {
         justify-content: center;
@@ -268,6 +280,9 @@ import {UploadTracesComponent} from './upload_traces_component';
       .fixed {
         min-width: fit-content;
       }
+      .download-files-section {
+        overflow-x: hidden;
+      }
       .file-descriptor {
         font-size: 14px;
         padding-left: 10px;
@@ -327,7 +342,6 @@ export class AppComponent implements WinscopeEventListener {
   timelineData = new TimelineData();
   abtChromeExtensionProtocol = new AbtChromeExtensionProtocol();
   crossToolProtocol: CrossToolProtocol;
-  states = ProxyState;
   dataLoaded = false;
   showDataLoadedElements = false;
   collapsedTimelineHeight = 0;
@@ -337,7 +351,6 @@ export class AppComponent implements WinscopeEventListener {
 
   isDarkModeOn = false;
   changeDetectorRef: ChangeDetectorRef;
-  snackbarOpener: SnackBarOpener;
   tracePipeline: TracePipeline;
   mediator: Mediator;
   currentTimestamp?: Timestamp;
@@ -348,9 +361,9 @@ export class AppComponent implements WinscopeEventListener {
       Validators.pattern(FileUtils.DOWNLOAD_FILENAME_REGEX),
     ]),
   );
-  traceConfig: TraceConfigurationMap;
-  dumpConfig: TraceConfigurationMap;
-  traceConfigStorage: Storage;
+  adbConnection: AdbConnection = new ProxyConnection();
+  traceConfigStorage: Store;
+  downloadProgress: number | undefined;
 
   @ViewChild(UploadTracesComponent)
   uploadTracesComponent?: UploadTracesComponent;
@@ -362,13 +375,13 @@ export class AppComponent implements WinscopeEventListener {
   constructor(
     @Inject(Injector) injector: Injector,
     @Inject(ChangeDetectorRef) changeDetectorRef: ChangeDetectorRef,
-    @Inject(SnackBarOpener) snackBar: SnackBarOpener,
+    @Inject(SnackBarOpener) snackbarOpener: SnackBarOpener,
     @Inject(Title) private pageTitle: Title,
     @Inject(NgZone) private ngZone: NgZone,
     @Inject(MatDialog) private dialog: MatDialog,
   ) {
     this.changeDetectorRef = changeDetectorRef;
-    this.snackbarOpener = snackBar;
+    UserNotifier.setSnackBarOpener(snackbarOpener);
     this.tracePipeline = new TracePipeline();
     this.crossToolProtocol = new CrossToolProtocol(
       this.tracePipeline.getTimestampConverter(),
@@ -379,8 +392,7 @@ export class AppComponent implements WinscopeEventListener {
       this.abtChromeExtensionProtocol,
       this.crossToolProtocol,
       this,
-      this.snackbarOpener,
-      localStorage,
+      new PersistentStore(),
     );
 
     const storeDarkMode = this.store.get('dark-mode');
@@ -403,10 +415,10 @@ export class AppComponent implements WinscopeEventListener {
         createCustomElement(ViewerProtologComponent, {injector}),
       );
     }
-    if (!customElements.get('viewer-screen-recording')) {
+    if (!customElements.get('viewer-media-based')) {
       customElements.define(
-        'viewer-screen-recording',
-        createCustomElement(ViewerScreenRecordingComponent, {injector}),
+        'viewer-media-based',
+        createCustomElement(ViewerMediaBasedComponent, {injector}),
       );
     }
     if (!customElements.get('viewer-surface-flinger')) {
@@ -439,36 +451,23 @@ export class AppComponent implements WinscopeEventListener {
         createCustomElement(ViewerViewCaptureComponent, {injector}),
       );
     }
+    if (!customElements.get('viewer-jank-cujs')) {
+      customElements.define(
+        'viewer-jank-cujs',
+        createCustomElement(ViewerJankCujsComponent, {injector}),
+      );
+    }
+    if (!customElements.get('viewer-input')) {
+      customElements.define(
+        'viewer-input',
+        createCustomElement(ViewerInputComponent, {injector}),
+      );
+    }
 
     this.traceConfigStorage =
-      globalConfig.MODE === 'PROD' ? localStorage : new InMemoryStorage();
-
-    this.traceConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
-      'TracingSettings',
-      TRACES['default'],
-      this.traceConfigStorage,
-    );
-    this.dumpConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
-      'DumpSettings',
-      {
-        window_dump: {
-          name: 'Window Manager',
-          run: true,
-          config: undefined,
-        },
-        layers_dump: {
-          name: 'Surface Flinger',
-          run: true,
-          config: undefined,
-        },
-        screenshot: {
-          name: 'Screenshot',
-          run: true,
-          config: undefined,
-        },
-      },
-      this.traceConfigStorage,
-    );
+      globalConfig.MODE === 'PROD'
+        ? new PersistentStore()
+        : new InMemoryStorage();
 
     window.onunhandledrejection = (evt) => {
       Analytics.Error.logGlobalException(evt.reason);
@@ -517,14 +516,26 @@ export class AppComponent implements WinscopeEventListener {
     this.pageTitle.setTitle(`Winscope | ${this.filenameFormControl.value}`);
   }
 
-  async onDownloadTracesButtonClick() {
+  async onDownloadTracesButtonClick(progressListener: ProgressListener = this) {
     if (this.filenameFormControl.invalid) {
       return;
     }
-    await this.downloadTraces();
+    const archiveBlob =
+      await this.tracePipeline.makeZipArchiveWithLoadedTraceFiles(
+        (perc: number) => {
+          progressListener.onProgressUpdate('Downloading', 90 * perc);
+        },
+      );
+    const archiveFilename = `${
+      this.showDataLoadedElements
+        ? this.filenameFormControl.value
+        : this.tracePipeline.getDownloadArchiveFilename()
+    }.zip`;
+    this.downloadTraces(archiveBlob, archiveFilename);
+    progressListener.onOperationFinished(true);
   }
 
-  async onFilesCollected(files: File[]) {
+  async onFilesCollected(files: AdbFiles) {
     await this.mediator.onWinscopeEvent(new AppFilesCollected(files));
   }
 
@@ -546,19 +557,21 @@ export class AppComponent implements WinscopeEventListener {
     await this.mediator.onWinscopeEvent(new AppTraceViewRequest());
   }
 
-  async downloadTraces() {
-    const archiveBlob =
-      await this.tracePipeline.makeZipArchiveWithLoadedTraceFiles();
-    const archiveFilename = `${this.filenameFormControl.value}.zip`;
-
-    const a = document.createElement('a');
-    document.body.appendChild(a);
-    const url = window.URL.createObjectURL(archiveBlob);
-    a.href = url;
-    a.download = archiveFilename;
-    a.click();
-    window.URL.revokeObjectURL(url);
-    document.body.removeChild(a);
+  onProgressUpdate(message: string, progressPercentage: number | undefined) {
+    this.ngZone.run(() => {
+      this.downloadProgress = progressPercentage;
+    });
+  }
+
+  onOperationFinished(success: boolean) {
+    this.ngZone.run(() => {
+      this.downloadProgress = undefined;
+    });
+  }
+
+  downloadTraces(blob: Blob, filename: string) {
+    const url = window.URL.createObjectURL(blob);
+    Download.fromUrl(url, filename);
   }
 
   async onWinscopeEvent(event: WinscopeEvent) {
@@ -582,7 +595,6 @@ export class AppComponent implements WinscopeEventListener {
     });
 
     await event.visit(WinscopeEventType.VIEWERS_UNLOADED, async (event) => {
-      proxyClient.adbData = [];
       this.dataLoaded = false;
       this.showDataLoadedElements = false;
       this.pageTitle.setTitle('Winscope');
diff --git a/tools/winscope/src/app/components/app_component_test.ts b/tools/winscope/src/app/components/app_component_test.ts
index 85b1ad22d..70ca1cad7 100644
--- a/tools/winscope/src/app/components/app_component_test.ts
+++ b/tools/winscope/src/app/components/app_component_test.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 import {ClipboardModule} from '@angular/cdk/clipboard';
+import {OverlayModule} from '@angular/cdk/overlay';
 import {CommonModule} from '@angular/common';
 import {HttpClientModule} from '@angular/common/http';
 import {ChangeDetectionStrategy} from '@angular/core';
@@ -35,6 +36,8 @@ import {MatDividerModule} from '@angular/material/divider';
 import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatIconModule} from '@angular/material/icon';
 import {MatInputModule} from '@angular/material/input';
+import {MatListModule} from '@angular/material/list';
+import {MatProgressBarModule} from '@angular/material/progress-bar';
 import {MatSelectModule} from '@angular/material/select';
 import {MatSliderModule} from '@angular/material/slider';
 import {MatSnackBarModule} from '@angular/material/snack-bar';
@@ -44,6 +47,11 @@ import {Title} from '@angular/platform-browser';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {FileUtils} from 'common/file_utils';
+import {UserNotifier} from 'common/user_notifier';
+import {
+  FailedToInitializeTimelineData,
+  NoValidFiles,
+} from 'messaging/user_warnings';
 import {
   AppRefreshDumpsRequest,
   ViewersLoaded,
@@ -51,6 +59,7 @@ import {
 } from 'messaging/winscope_event';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
+import {waitToBeCalled} from 'test/utils';
 import {ViewerSurfaceFlingerComponent} from 'viewers/viewer_surface_flinger/viewer_surface_flinger_component';
 import {AdbProxyComponent} from './adb_proxy_component';
 import {AppComponent} from './app_component';
@@ -61,6 +70,7 @@ import {
 } from './bottomnav/bottom_drawer_component';
 import {CollectTracesComponent} from './collect_traces_component';
 import {ShortcutsComponent} from './shortcuts_component';
+import {SnackBarComponent} from './snack_bar_component';
 import {MiniTimelineComponent} from './timeline/mini-timeline/mini_timeline_component';
 import {TimelineComponent} from './timeline/timeline_component';
 import {TraceConfigComponent} from './trace_config_component';
@@ -72,6 +82,7 @@ describe('AppComponent', () => {
   let fixture: ComponentFixture<AppComponent>;
   let component: AppComponent;
   let htmlElement: HTMLElement;
+  let downloadTracesSpy: jasmine.Spy;
 
   beforeEach(async () => {
     await TestBed.configureTestingModule({
@@ -95,6 +106,9 @@ describe('AppComponent', () => {
         ClipboardModule,
         MatDialogModule,
         HttpClientModule,
+        MatListModule,
+        MatProgressBarModule,
+        OverlayModule,
       ],
       declarations: [
         AdbProxyComponent,
@@ -111,6 +125,7 @@ describe('AppComponent', () => {
         ViewerSurfaceFlingerComponent,
         WebAdbComponent,
         ShortcutsComponent,
+        SnackBarComponent,
       ],
     })
       .overrideComponent(AppComponent, {
@@ -127,6 +142,7 @@ describe('AppComponent', () => {
         Validators.pattern(FileUtils.DOWNLOAD_FILENAME_REGEX),
       ]),
     );
+    downloadTracesSpy = spyOn(component, 'downloadTraces');
     fixture.detectChanges();
   });
 
@@ -162,7 +178,13 @@ describe('AppComponent', () => {
     goToTraceView();
     checkTraceViewPage();
 
-    (htmlElement.querySelector('.upload-new') as HTMLButtonElement).click();
+    (
+      assertDefined(
+        htmlElement.querySelector('.upload-new'),
+      ) as HTMLButtonElement
+    ).click();
+    fixture.detectChanges();
+    await fixture.whenStable();
     fixture.detectChanges();
     await fixture.whenStable();
     checkHomepage();
@@ -177,38 +199,71 @@ describe('AppComponent', () => {
       component.mediator,
       'onWinscopeEvent',
     ).and.callThrough();
-    (htmlElement.querySelector('.refresh-dumps') as HTMLButtonElement).click();
+    (
+      assertDefined(
+        htmlElement.querySelector('.refresh-dumps'),
+      ) as HTMLButtonElement
+    ).click();
+    fixture.detectChanges();
+    await fixture.whenStable();
     fixture.detectChanges();
     await fixture.whenStable();
     checkHomepage();
     expect(winscopeEventSpy).toHaveBeenCalledWith(new AppRefreshDumpsRequest());
   });
 
-  it('downloads traces on download button click', () => {
+  it('shows download progress bar', () => {
     component.showDataLoadedElements = true;
     fixture.detectChanges();
-    const spy = spyOn(component, 'downloadTraces');
+    expect(
+      htmlElement.querySelector('.download-files-section mat-progress-bar'),
+    ).toBeNull();
 
-    clickDownloadTracesButton();
-    expect(spy).toHaveBeenCalledTimes(1);
+    component.onProgressUpdate('Progress update', 10);
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.download-files-section mat-progress-bar'),
+    ).toBeTruthy();
+
+    component.onOperationFinished(true);
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.download-files-section mat-progress-bar'),
+    ).toBeNull();
+  });
 
+  it('downloads traces on download button click and shows download progress bar', async () => {
+    component.showDataLoadedElements = true;
+    fixture.detectChanges();
     clickDownloadTracesButton();
-    expect(spy).toHaveBeenCalledTimes(2);
+    expect(
+      htmlElement.querySelector('.download-files-section mat-progress-bar'),
+    ).toBeTruthy();
+    await waitToBeCalled(downloadTracesSpy);
   });
 
-  it('downloads traces after valid file name change', () => {
+  it('downloads traces after valid file name change', async () => {
     component.showDataLoadedElements = true;
     fixture.detectChanges();
-    const spy = spyOn(component, 'downloadTraces');
 
     clickEditFilenameButton();
     updateFilenameInputAndDownloadTraces('Winscope2', true);
-    expect(spy).toHaveBeenCalledTimes(1);
+    await waitToBeCalled(downloadTracesSpy);
+    expect(downloadTracesSpy).toHaveBeenCalledOnceWith(
+      jasmine.any(Blob),
+      'Winscope2.zip',
+    );
+
+    downloadTracesSpy.calls.reset();
 
     // check it works twice in a row
     clickEditFilenameButton();
     updateFilenameInputAndDownloadTraces('win_scope', true);
-    expect(spy).toHaveBeenCalledTimes(2);
+    await waitToBeCalled(downloadTracesSpy);
+    expect(downloadTracesSpy).toHaveBeenCalledOnceWith(
+      jasmine.any(Blob),
+      'win_scope.zip',
+    );
   });
 
   it('changes page title based on archive name', async () => {
@@ -233,29 +288,35 @@ describe('AppComponent', () => {
   it('does not download traces if invalid file name chosen', () => {
     component.showDataLoadedElements = true;
     fixture.detectChanges();
-    const spy = spyOn(component, 'downloadTraces');
 
     clickEditFilenameButton();
     updateFilenameInputAndDownloadTraces('w?n$cope', false);
-    expect(spy).not.toHaveBeenCalled();
+    expect(downloadTracesSpy).not.toHaveBeenCalled();
   });
 
-  it('behaves as expected when entering valid then invalid then valid file names', () => {
+  it('behaves as expected when entering valid then invalid then valid file names', async () => {
     component.showDataLoadedElements = true;
     fixture.detectChanges();
 
-    const spy = spyOn(component, 'downloadTraces');
-
     clickEditFilenameButton();
     updateFilenameInputAndDownloadTraces('Winscope2', true);
-    expect(spy).toHaveBeenCalled();
+    await waitToBeCalled(downloadTracesSpy);
+    expect(downloadTracesSpy).toHaveBeenCalledOnceWith(
+      jasmine.any(Blob),
+      'Winscope2.zip',
+    );
+    downloadTracesSpy.calls.reset();
 
     clickEditFilenameButton();
     updateFilenameInputAndDownloadTraces('w?n$cope', false);
-    expect(spy).toHaveBeenCalledTimes(1);
+    expect(downloadTracesSpy).not.toHaveBeenCalled();
 
     updateFilenameInputAndDownloadTraces('win.scope', true);
-    expect(spy).toHaveBeenCalledTimes(2);
+    await waitToBeCalled(downloadTracesSpy);
+    expect(downloadTracesSpy).toHaveBeenCalledOnceWith(
+      jasmine.any(Blob),
+      'win.scope.zip',
+    );
   });
 
   it('validates filename on enter key', () => {
@@ -279,6 +340,25 @@ describe('AppComponent', () => {
     expect(spy).toHaveBeenCalled();
   });
 
+  it('downloads traces from upload traces section', () => {
+    const traces = assertDefined(component.tracePipeline.getTraces());
+    spyOn(traces, 'getSize').and.returnValue(1);
+    fixture.detectChanges();
+    const downloadButtonClickSpy = spyOn(
+      component,
+      'onDownloadTracesButtonClick',
+    );
+
+    const downloadButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('upload-traces .download-btn'),
+    );
+    downloadButton.click();
+    fixture.detectChanges();
+    expect(downloadButtonClickSpy).toHaveBeenCalledOnceWith(
+      component.uploadTracesComponent,
+    );
+  });
+
   it('opens shortcuts dialog', () => {
     expect(document.querySelector('shortcuts-panel')).toBeFalsy();
     const shortcutsButton = assertDefined(
@@ -289,6 +369,41 @@ describe('AppComponent', () => {
     expect(document.querySelector('shortcuts-panel')).toBeTruthy();
   });
 
+  it('sets snackbar opener to global user notifier', () => {
+    expect(document.querySelector('snack-bar')).toBeFalsy();
+    UserNotifier.add(new NoValidFiles());
+    UserNotifier.notify();
+    expect(document.querySelector('snack-bar')).toBeTruthy();
+  });
+
+  it('does not open new snackbar until existing snackbar has been dismissed', async () => {
+    expect(document.querySelector('snack-bar')).toBeFalsy();
+    const firstMessage = new NoValidFiles();
+    UserNotifier.add(firstMessage);
+    UserNotifier.notify();
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+    let snackbar = assertDefined(document.querySelector('snack-bar'));
+    expect(snackbar.textContent).toContain(firstMessage.getMessage());
+
+    const secondMessage = new FailedToInitializeTimelineData();
+    UserNotifier.add(secondMessage);
+    UserNotifier.notify();
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+    snackbar = assertDefined(document.querySelector('snack-bar'));
+    expect(snackbar.textContent).toContain(firstMessage.getMessage());
+
+    const closeButton = assertDefined(
+      snackbar.querySelector('.snack-bar-action'),
+    ) as HTMLElement;
+    closeButton.click();
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+    snackbar = assertDefined(document.querySelector('snack-bar'));
+    expect(snackbar.textContent).toContain(secondMessage.getMessage());
+  });
+
   function goToTraceView() {
     component.dataLoaded = true;
     component.showDataLoadedElements = true;
diff --git a/tools/winscope/src/app/components/collect_traces_component.ts b/tools/winscope/src/app/components/collect_traces_component.ts
index f49a0927e..07b0cf0ca 100644
--- a/tools/winscope/src/app/components/collect_traces_component.ts
+++ b/tools/winscope/src/app/components/collect_traces_component.ts
@@ -20,27 +20,49 @@ import {
   EventEmitter,
   Inject,
   Input,
-  OnDestroy,
-  OnInit,
+  NgZone,
   Output,
   ViewEncapsulation,
 } from '@angular/core';
+import {MatDialog} from '@angular/material/dialog';
 import {assertDefined} from 'common/assert_utils';
+import {FunctionUtils} from 'common/function_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
+import {UserNotifier} from 'common/user_notifier';
 import {Analytics} from 'logging/analytics';
 import {ProgressListener} from 'messaging/progress_listener';
-import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
+import {ProxyTraceTimeout} from 'messaging/user_warnings';
+import {
+  NoTraceTargetsSelected,
+  WinscopeEvent,
+  WinscopeEventType,
+} from 'messaging/winscope_event';
+import {
+  EmitEvent,
+  WinscopeEventEmitter,
+} from 'messaging/winscope_event_emitter';
 import {WinscopeEventListener} from 'messaging/winscope_event_listener';
-import {Connection} from 'trace_collection/connection';
-import {ProxyState} from 'trace_collection/proxy_client';
+import {AdbConnection} from 'trace_collection/adb_connection';
+import {AdbDevice} from 'trace_collection/adb_device';
+import {AdbFiles, RequestedTraceTypes} from 'trace_collection/adb_files';
+import {ConnectionState} from 'trace_collection/connection_state';
 import {ProxyConnection} from 'trace_collection/proxy_connection';
 import {
-  ConfigMap,
   EnableConfiguration,
+  makeDefaultDumpConfigMap,
+  makeDefaultTraceConfigMap,
+  makeScreenRecordingConfigs,
   SelectionConfiguration,
   TraceConfigurationMap,
-} from 'trace_collection/trace_collection_utils';
+} from 'trace_collection/trace_configuration';
+import {TraceRequest, TraceRequestConfig} from 'trace_collection/trace_request';
 import {LoadProgressComponent} from './load_progress_component';
+import {
+  WarningDialogComponent,
+  WarningDialogData,
+  WarningDialogResult,
+} from './warning_dialog_component';
 
 @Component({
   selector: 'collect-traces',
@@ -48,52 +70,51 @@ import {LoadProgressComponent} from './load_progress_component';
     <mat-card class="collect-card">
       <mat-card-title class="title">Collect Traces</mat-card-title>
 
-      <mat-card-content class="collect-card-content">
-        <p *ngIf="connect.isConnectingState()" class="connecting-message mat-body-1">
+      <mat-card-content *ngIf="adbConnection" class="collect-card-content">
+        <p *ngIf="adbConnection.getState() === ${ConnectionState.CONNECTING}" class="connecting-message mat-body-1">
           Connecting...
         </p>
 
-        <div *ngIf="!connect.adbSuccess()" class="set-up-adb">
+        <div *ngIf="!adbSuccess()" class="set-up-adb">
           <button
             class="proxy-tab"
             color="primary"
             mat-stroked-button
-            [ngClass]="tabClass(true)"
-            (click)="displayAdbProxyTab()">
+            [ngClass]="tabClass(true)">
             ADB Proxy
           </button>
           <!-- <button class="web-tab" color="primary" mat-raised-button [ngClass]="tabClass(false)" (click)="displayWebAdbTab()">Web ADB</button> -->
           <adb-proxy
-            *ngIf="isAdbProxy"
-            [(proxy)]="connect.proxy"
-            (addKey)="onAddKey($event)"></adb-proxy>
-          <!-- <web-adb *ngIf="!isAdbProxy"></web-adb> TODO: fix web adb workflow -->
+            *ngIf="isAdbProxy()"
+            [state]="adbConnection.getState()"
+            (retryConnection)="onRetryConnection($event)"></adb-proxy>
+          <!-- <web-adb *ngIf="!isAdbProxy()"></web-adb> TODO: fix web adb workflow -->
         </div>
 
-        <div *ngIf="connect.isDevicesState()" class="devices-connecting">
-          <div *ngIf="objectKeys(connect.devices()).length === 0" class="no-device-detected">
+        <div *ngIf="showAllDevices()" class="devices-connecting">
+          <div *ngIf="adbConnection.getDevices().length === 0" class="no-device-detected">
             <p class="mat-body-3 icon"><mat-icon inline fontIcon="phonelink_erase"></mat-icon></p>
             <p class="mat-body-1">No devices detected</p>
           </div>
-          <div *ngIf="objectKeys(connect.devices()).length > 0" class="device-selection">
+          <div *ngIf="adbConnection.getDevices().length > 0" class="device-selection">
             <p class="mat-body-1 instruction">Select a device:</p>
-            <mat-list *ngIf="objectKeys(connect.devices()).length > 0">
+            <mat-list>
               <mat-list-item
-                *ngFor="let deviceId of objectKeys(connect.devices())"
-                (click)="onDeviceClick(deviceId)"
+                *ngFor="let device of adbConnection.getDevices()"
+                (click)="onDeviceClick(device)"
                 class="available-device">
                 <mat-icon matListIcon>
                   {{
-                    connect.devices()[deviceId].authorised ? 'smartphone' : 'screen_lock_portrait'
+                    device.authorized ? 'smartphone' : 'screen_lock_portrait'
                   }}
                 </mat-icon>
                 <p matLine>
                   {{
-                    connect.devices()[deviceId].authorised
-                      ? connect.devices()[deviceId]?.model
-                      : 'unauthorised'
+                    device.authorized
+                      ? device.model
+                      : 'unauthorized'
                   }}
-                  ({{ deviceId }})
+                  ({{ device.id }})
                 </p>
               </mat-list-item>
             </mat-list>
@@ -104,38 +125,53 @@ import {LoadProgressComponent} from './load_progress_component';
           *ngIf="showTraceCollectionConfig()"
           class="trace-collection-config">
           <mat-list>
-            <mat-list-item>
+            <mat-list-item class="selected-device">
               <mat-icon matListIcon>smartphone</mat-icon>
               <p matLine>
-                {{ connect.selectedDevice()?.model }} ({{ connect.selectedDeviceId() }})
+                {{ getSelectedDevice()}}
+              </p>
 
+              <div class="device-actions">
                 <button
                   color="primary"
                   class="change-btn"
-                  mat-button
+                  mat-stroked-button
                   (click)="onChangeDeviceButton()"
-                  [disabled]="connect.isEndTraceState() || isOperationInProgress()">
+                  [disabled]="isTracingOrLoading()">
                   Change device
                 </button>
-              </p>
+                <button
+                  color="primary"
+                  class="fetch-btn"
+                  mat-stroked-button
+                  (click)="fetchExistingTraces()"
+                  [disabled]="isTracingOrLoading()">
+                  Fetch traces from last session
+                </button>
+              </div>
             </mat-list-item>
           </mat-list>
 
           <mat-tab-group [selectedIndex]="selectedTabIndex" class="tracing-tabs">
             <mat-tab
               label="Trace"
-              [disabled]="connect.isEndTraceState() || isOperationInProgress() || refreshDumps">
+              [disabled]="disableTraceSection()">
               <div class="tabbed-section">
-                <div class="trace-section" *ngIf="connect.isStartTraceState()">
-                  <trace-config [(traceConfig)]="traceConfig"></trace-config>
+                <div class="trace-section" *ngIf="adbConnection.getState() === ${ConnectionState.IDLE}">
+                  <trace-config
+                    title="Trace targets"
+                    [initialTraceConfig]="traceConfig"
+                    [storage]="storage"
+                    traceConfigStoreKey="TraceSettings"
+                    (traceConfigChange)="onTraceConfigChange($event)"></trace-config>
                   <div class="start-btn">
-                    <button color="primary" mat-stroked-button (click)="startTracing()">
+                    <button color="primary" mat-raised-button (click)="startTracing()">
                       Start trace
                     </button>
                   </div>
                 </div>
 
-                <div *ngIf="connect.isStartingTraceState()" class="starting-trace">
+                <div *ngIf="adbConnection.getState() === ${ConnectionState.STARTING_TRACE}" class="starting-trace">
                   <load-progress
                     message="Starting trace...">
                   </load-progress>
@@ -146,7 +182,7 @@ import {LoadProgressComponent} from './load_progress_component';
                   </div>
                 </div>
 
-                <div *ngIf="connect.isEndTraceState()" class="end-tracing">
+                <div *ngIf="adbConnection.getState() === ${ConnectionState.TRACING}" class="tracing">
                   <load-progress
                     icon="cable"
                     message="Tracing...">
@@ -158,7 +194,19 @@ import {LoadProgressComponent} from './load_progress_component';
                   </div>
                 </div>
 
-                <div *ngIf="isOperationInProgress()" class="load-data">
+                <div *ngIf="adbConnection.getState() === ${ConnectionState.ENDING_TRACE}" class="ending-trace">
+                  <load-progress
+                    icon="cable"
+                    message="Ending trace...">
+                  </load-progress>
+                  <div class="end-btn">
+                    <button color="primary" mat-raised-button [disabled]="true">
+                      End trace
+                    </button>
+                  </div>
+                </div>
+
+                <div *ngIf="isLoadOperationInProgress()" class="load-data">
                   <load-progress
                     [progressPercentage]="progressPercentage"
                     [message]="progressMessage">
@@ -171,28 +219,25 @@ import {LoadProgressComponent} from './load_progress_component';
                 </div>
               </div>
             </mat-tab>
-            <mat-tab label="Dump" [disabled]="connect.isEndTraceState() || isOperationInProgress()">
+            <mat-tab label="Dump" [disabled]="isTracingOrLoading()">
               <div class="tabbed-section">
-                <div class="dump-section" *ngIf="connect.isStartTraceState() && !refreshDumps">
-                  <h3 class="mat-subheading-2">Dump targets</h3>
-                  <div class="selection">
-                    <mat-checkbox
-                      *ngFor="let dumpKey of objectKeys(dumpConfig)"
-                      color="primary"
-                      class="dump-checkbox"
-                      [(ngModel)]="dumpConfig[dumpKey].run"
-                      >{{ dumpConfig[dumpKey].name }}</mat-checkbox
-                    >
-                  </div>
+                <div class="dump-section" *ngIf="adbConnection.getState() === ${ConnectionState.IDLE} && !refreshDumps">
+                  <trace-config
+                    title="Dump targets"
+                    [initialTraceConfig]="dumpConfig"
+                    [storage]="storage"
+                    [traceConfigStoreKey]="storeKeyDumpConfig"
+                    (traceConfigChange)="onDumpConfigChange($event)"></trace-config>
                   <div class="dump-btn" *ngIf="!refreshDumps">
-                    <button color="primary" mat-stroked-button (click)="dumpState()">
+                    <button color="primary" mat-raised-button (click)="dumpState()">
                       Dump state
                     </button>
                   </div>
                 </div>
 
                 <load-progress
-                  *ngIf="refreshDumps || isOperationInProgress()"
+                  class="dumping-state"
+                  *ngIf="isDumpingState()"
                   [progressPercentage]="progressPercentage"
                   [message]="progressMessage">
                 </load-progress>
@@ -201,12 +246,12 @@ import {LoadProgressComponent} from './load_progress_component';
           </mat-tab-group>
         </div>
 
-        <div *ngIf="connect.isErrorState()" class="unknown-error">
+        <div *ngIf="adbConnection.getState() === ${ConnectionState.ERROR}" class="unknown-error">
           <p class="error-wrapper mat-body-1">
             <mat-icon class="error-icon">error</mat-icon>
             Error:
           </p>
-          <pre> {{ connect.proxy?.errorText }} </pre>
+          <pre> {{ adbConnection.getErrorText() }} </pre>
           <button color="primary" class="retry-btn" mat-raised-button (click)="onRetryButton()">
             Retry
           </button>
@@ -217,9 +262,16 @@ import {LoadProgressComponent} from './load_progress_component';
   styles: [
     `
       .change-btn,
-      .retry-btn {
+      .retry-btn,
+      .fetch-btn {
         margin-left: 5px;
       }
+      .fetch-btn {
+        margin-top: 5px;
+      }
+      .selected-device {
+        height: fit-content !important;
+      }
       .mat-card.collect-card {
         display: flex;
       }
@@ -243,7 +295,8 @@ import {LoadProgressComponent} from './load_progress_component';
       .trace-section,
       .dump-section,
       .starting-trace,
-      .end-tracing,
+      .tracing,
+      .ending-trace,
       .load-data,
       trace-config {
         display: flex;
@@ -253,7 +306,8 @@ import {LoadProgressComponent} from './load_progress_component';
       .trace-section,
       .dump-section,
       .starting-trace,
-      .end-tracing,
+      .tracing,
+      .ending-trace,
       .load-data {
         height: 100%;
       }
@@ -356,51 +410,69 @@ import {LoadProgressComponent} from './load_progress_component';
   encapsulation: ViewEncapsulation.None,
 })
 export class CollectTracesComponent
-  implements OnInit, OnDestroy, ProgressListener, WinscopeEventListener
+  implements ProgressListener, WinscopeEventListener, WinscopeEventEmitter
 {
   objectKeys = Object.keys;
-  isAdbProxy = true;
-  connect: Connection | undefined;
   isExternalOperationInProgress = false;
   progressMessage = 'Fetching...';
   progressPercentage: number | undefined;
   lastUiProgressUpdateTimeMs?: number;
   refreshDumps = false;
   selectedTabIndex = 0;
+  traceConfig: TraceConfigurationMap;
+  dumpConfig: TraceConfigurationMap;
+  requestedTraceTypes: RequestedTraceTypes[] = [];
 
-  @Input() traceConfig: TraceConfigurationMap | undefined;
-  @Input() dumpConfig: TraceConfigurationMap | undefined;
-  @Input() storage: Storage | undefined;
+  private readonly storeKeyImeWarning = 'doNotShowImeWarningDialog';
+  private readonly storeKeyLastDevice = 'adb.lastDevice';
+  private readonly storeKeyDumpConfig = 'DumpSettings';
 
-  @Output() readonly filesCollected = new EventEmitter<File[]>();
+  private selectedDevice: AdbDevice | undefined;
+  private emitEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
+
+  private readonly notConnected = [
+    ConnectionState.NOT_FOUND,
+    ConnectionState.UNAUTH,
+    ConnectionState.INVALID_VERSION,
+  ];
+
+  @Input() adbConnection: AdbConnection | undefined;
+  @Input() storage: Store | undefined;
+
+  @Output() readonly filesCollected = new EventEmitter<AdbFiles>();
 
   constructor(
     @Inject(ChangeDetectorRef) private changeDetectorRef: ChangeDetectorRef,
-  ) {}
-
-  ngOnInit() {
-    if (this.isAdbProxy) {
-      this.connect = new ProxyConnection(
-        (newState) => this.onProxyStateChange(),
-        (progress) => this.onLoadProgressUpdate(progress),
-        this.setTraceConfigForAvailableTraces,
-      );
-    } else {
-      // TODO: change to WebAdbConnection
-      this.connect = new ProxyConnection(
-        (newState) => this.onProxyStateChange(),
-        (progress) => this.onLoadProgressUpdate(progress),
-        this.setTraceConfigForAvailableTraces,
-      );
+    @Inject(MatDialog) private dialog: MatDialog,
+    @Inject(NgZone) private ngZone: NgZone,
+  ) {
+    this.traceConfig = makeDefaultTraceConfigMap();
+    this.dumpConfig = makeDefaultDumpConfigMap();
+  }
+
+  ngOnChanges() {
+    if (!this.adbConnection) {
+      throw new Error('component created without adb connection');
     }
+    this.adbConnection.initialize(
+      () => this.onConnectionStateChange(),
+      this.toggleAvailabilityOfTraces,
+      this.handleDevicesChange,
+    );
+  }
+
+  ngOnDestroy() {
+    this.adbConnection?.onDestroy();
   }
 
-  ngOnDestroy(): void {
-    assertDefined(this.connect).proxy?.removeOnProxyChange(this.onProxyChange);
+  setEmitEvent(callback: EmitEvent) {
+    this.emitEvent = callback;
   }
 
-  async onDeviceClick(deviceId: string) {
-    await assertDefined(this.connect).selectDevice(deviceId);
+  onDeviceClick(device: AdbDevice) {
+    this.selectedDevice = device;
+    this.storage?.add(this.storeKeyLastDevice, device.id);
+    this.changeDetectorRef.detectChanges();
   }
 
   async onWinscopeEvent(event: WinscopeEvent) {
@@ -408,8 +480,13 @@ export class CollectTracesComponent
       WinscopeEventType.APP_REFRESH_DUMPS_REQUEST,
       async (event) => {
         this.selectedTabIndex = 1;
-        this.progressMessage = 'Refreshing dumps...';
-        this.progressPercentage = 0;
+        this.dumpConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
+          assertDefined('DumpSettings'),
+          assertDefined(
+            JSON.parse(JSON.stringify(assertDefined(this.dumpConfig))),
+          ),
+          assertDefined(this.storage),
+        );
         this.refreshDumps = true;
       },
     );
@@ -428,128 +505,317 @@ export class CollectTracesComponent
     this.changeDetectorRef.detectChanges();
   }
 
-  onOperationFinished() {
+  onOperationFinished(success: boolean) {
     this.isExternalOperationInProgress = false;
     this.lastUiProgressUpdateTimeMs = undefined;
+    if (!success) {
+      this.adbConnection?.restartConnection();
+    }
     this.changeDetectorRef.detectChanges();
   }
 
-  isOperationInProgress(): boolean {
+  isLoadOperationInProgress(): boolean {
     return (
-      assertDefined(this.connect).isLoadDataState() ||
-      this.isExternalOperationInProgress
+      assertDefined(this.adbConnection).getState() ===
+        ConnectionState.LOADING_DATA || this.isExternalOperationInProgress
     );
   }
 
-  async onAddKey(key: string) {
-    if (this.connect?.setProxyKey) {
-      this.connect.setProxyKey(key);
+  async onRetryConnection(token: string) {
+    const connection = assertDefined(this.adbConnection);
+    connection.setSecurityToken(token);
+    await connection.restartConnection();
+  }
+
+  showAllDevices(): boolean {
+    const connection = assertDefined(this.adbConnection);
+    const state = connection.getState();
+    if (state !== ConnectionState.IDLE) {
+      return false;
     }
-    await assertDefined(this.connect).restart();
+
+    const devices = connection.getDevices();
+    const lastId = this.storage?.get(this.storeKeyLastDevice) ?? undefined;
+    if (
+      this.selectedDevice &&
+      !devices.find((d) => d.id === this.selectedDevice?.id)
+    ) {
+      this.selectedDevice = undefined;
+    }
+
+    if (this.selectedDevice === undefined && lastId !== undefined) {
+      const device = devices.find((d) => d.id === lastId);
+      if (device && device.authorized) {
+        this.selectedDevice = device;
+        this.storage?.add(this.storeKeyLastDevice, device.id);
+        return false;
+      }
+    }
+
+    return this.selectedDevice === undefined;
   }
 
-  displayAdbProxyTab() {
-    this.isAdbProxy = true;
-    this.connect = new ProxyConnection(
-      (newState) => this.onProxyStateChange(),
-      (progress) => this.onLoadProgressUpdate(progress),
-      this.setTraceConfigForAvailableTraces,
+  showTraceCollectionConfig(): boolean {
+    if (this.selectedDevice === undefined) {
+      return false;
+    }
+    return (
+      assertDefined(this.adbConnection).getState() === ConnectionState.IDLE ||
+      this.isTracingOrLoading()
     );
   }
 
-  displayWebAdbTab() {
-    this.isAdbProxy = false;
-    //TODO: change to WebAdbConnection
-    this.connect = new ProxyConnection(
-      (newState) => this.onProxyStateChange(),
-      (progress) => this.onLoadProgressUpdate(progress),
-      this.setTraceConfigForAvailableTraces,
-    );
+  onTraceConfigChange(newConfig: TraceConfigurationMap) {
+    this.traceConfig = newConfig;
   }
 
-  showTraceCollectionConfig() {
-    const connect = assertDefined(this.connect);
-    return (
-      connect.isStartTraceState() ||
-      connect.isStartingTraceState() ||
-      connect.isEndTraceState() ||
-      this.isOperationInProgress()
-    );
+  onDumpConfigChange(newConfig: TraceConfigurationMap) {
+    this.dumpConfig = newConfig;
   }
 
   async onChangeDeviceButton() {
-    await assertDefined(this.connect).resetLastDevice();
+    this.storage?.add(this.storeKeyLastDevice, '');
+    this.selectedDevice = undefined;
+    await this.adbConnection?.restartConnection();
   }
 
   async onRetryButton() {
-    await assertDefined(this.connect).restart();
+    await assertDefined(this.adbConnection).restartConnection();
+  }
+
+  adbSuccess() {
+    const state = this.adbConnection?.getState();
+    return !!state && !this.notConnected.includes(state);
   }
 
   async startTracing() {
-    console.log('begin tracing');
     const requestedTraces = this.getRequestedTraces();
-    Analytics.Tracing.logCollectTraces(requestedTraces);
-    const reqEnableConfig = this.requestedEnableConfig();
-    const reqSelectedSfConfig = this.requestedSelection('layers_trace');
-    const reqSelectedWmConfig = this.requestedSelection('window_trace');
-    if (requestedTraces.length < 1) {
-      await assertDefined(this.connect).throwNoTargetsError();
+
+    const imeReq = requestedTraces.includes('ime');
+    const doNotShowDialog = !!this.storage?.get(this.storeKeyImeWarning);
+
+    if (!imeReq || doNotShowDialog) {
+      await this.requestTraces(requestedTraces);
       return;
     }
 
-    await assertDefined(this.connect).startTrace(
-      requestedTraces,
-      reqEnableConfig,
-      reqSelectedSfConfig,
-      reqSelectedWmConfig,
-    );
+    const sfReq = requestedTraces.includes('layers_trace');
+    const transactionsReq = requestedTraces.includes('transactions');
+    const wmReq = requestedTraces.includes('window_trace');
+    const imeValidFrameMapping = sfReq && transactionsReq && wmReq;
+
+    if (imeValidFrameMapping) {
+      await this.requestTraces(requestedTraces);
+      return;
+    }
+
+    this.ngZone.run(() => {
+      const closeText = 'Collect traces anyway';
+      const optionText = 'Do not show again';
+      const data: WarningDialogData = {
+        message: `Cannot build frame mapping for IME with selected traces - some Winscope features may not work properly.
+        Consider the following selection for valid frame mapping:
+        Surface Flinger, Transactions, Window Manager, IME`,
+        actions: ['Go back'],
+        options: [optionText],
+        closeText,
+      };
+      const dialogRef = this.dialog.open(WarningDialogComponent, {
+        data,
+        disableClose: true,
+      });
+      dialogRef
+        .beforeClosed()
+        .subscribe((result: WarningDialogResult | undefined) => {
+          if (this.storage && result?.selectedOptions.includes(optionText)) {
+            this.storage.add(this.storeKeyImeWarning, 'true');
+          }
+          if (result?.closeActionText === closeText) {
+            this.requestTraces(requestedTraces);
+          }
+        });
+    });
   }
 
   async dumpState() {
-    console.log('begin dump');
     const requestedDumps = this.getRequestedDumps();
+    const requestedTraceTypes = requestedDumps.map((req) => {
+      return {
+        name: this.dumpConfig[req].name,
+        types: this.dumpConfig[req].types,
+      };
+    });
     Analytics.Tracing.logCollectDumps(requestedDumps);
-    const dumpSuccessful = await assertDefined(this.connect).dumpState(
-      requestedDumps,
+
+    if (requestedDumps.length === 0) {
+      this.emitEvent(new NoTraceTargetsSelected());
+      return;
+    }
+    requestedDumps.push('perfetto_dump'); // always dump/fetch perfetto dump
+
+    const requestedDumpsWithConfig: TraceRequest[] = requestedDumps.map(
+      (dumpName) => {
+        const enabledConfig = this.requestedEnabledConfig(
+          dumpName,
+          this.dumpConfig,
+        );
+        const selectedConfig = this.requestedSelectedConfig(
+          dumpName,
+          this.dumpConfig,
+        );
+        return {
+          name: dumpName,
+          config: enabledConfig.concat(selectedConfig),
+        };
+      },
     );
+
+    this.progressMessage = 'Dumping state...';
+
+    const connection = assertDefined(this.adbConnection);
+    const device = assertDefined(this.selectedDevice);
+    await connection.dumpState(device, requestedDumpsWithConfig);
     this.refreshDumps = false;
-    if (dumpSuccessful) {
-      this.filesCollected.emit(assertDefined(this.connect).adbData());
+    if (connection.getState() === ConnectionState.DUMPING_STATE) {
+      this.filesCollected.emit({
+        requested: requestedTraceTypes,
+        collected: await connection.fetchLastTracingSessionData(device),
+      });
     }
   }
 
   async endTrace() {
-    console.log('end tracing');
-    await assertDefined(this.connect).endTrace();
-    this.filesCollected.emit(assertDefined(this.connect).adbData());
+    const connection = assertDefined(this.adbConnection);
+    const device = assertDefined(this.selectedDevice);
+    await connection.endTrace(device);
+    if (connection.getState() === ConnectionState.ENDING_TRACE) {
+      this.filesCollected.emit({
+        requested: this.requestedTraceTypes,
+        collected: await connection.fetchLastTracingSessionData(device),
+      });
+    }
+  }
+
+  isAdbProxy(): boolean {
+    return this.adbConnection instanceof ProxyConnection;
   }
 
   tabClass(adbTab: boolean) {
     let isActive: string;
     if (adbTab) {
-      isActive = this.isAdbProxy ? 'active' : 'inactive';
+      isActive = this.isAdbProxy() ? 'active' : 'inactive';
     } else {
-      isActive = !this.isAdbProxy ? 'active' : 'inactive';
+      isActive = !this.isAdbProxy() ? 'active' : 'inactive';
     }
     return ['tab', isActive];
   }
 
-  private async onProxyChange(newState: ProxyState) {
-    await assertDefined(this.connect).onConnectChange.bind(this.connect)(
-      newState,
+  getSelectedDevice(): string {
+    const device = assertDefined(this.selectedDevice);
+    return device.model + `(${device.id})`;
+  }
+
+  isTracingOrLoading(): boolean {
+    const state = this.adbConnection?.getState();
+    const tracingStates = [
+      ConnectionState.STARTING_TRACE,
+      ConnectionState.TRACING,
+      ConnectionState.ENDING_TRACE,
+      ConnectionState.DUMPING_STATE,
+    ];
+    return (
+      (!!state && tracingStates.includes(state)) ||
+      this.isLoadOperationInProgress()
+    );
+  }
+
+  isDumpingState(): boolean {
+    return (
+      this.refreshDumps ||
+      this.adbConnection?.getState() === ConnectionState.DUMPING_STATE ||
+      this.isLoadOperationInProgress()
+    );
+  }
+
+  disableTraceSection(): boolean {
+    return this.isTracingOrLoading() || this.refreshDumps;
+  }
+
+  async fetchExistingTraces() {
+    const connection = assertDefined(this.adbConnection);
+    const files = await connection.fetchLastTracingSessionData(
+      assertDefined(this.selectedDevice),
     );
+    this.filesCollected.emit({
+      requested: [],
+      collected: files,
+    });
+    if (files.length === 0) {
+      await connection.restartConnection();
+    }
   }
 
-  private onProxyStateChange() {
+  private async requestTraces(requestedTraces: string[]) {
+    this.requestedTraceTypes = requestedTraces.map((req) => {
+      return {
+        name: this.traceConfig[req].name,
+        types: this.traceConfig[req].types,
+      };
+    });
+    Analytics.Tracing.logCollectTraces(requestedTraces);
+
+    if (requestedTraces.length === 0) {
+      this.emitEvent(new NoTraceTargetsSelected());
+      return;
+    }
+    requestedTraces.push('perfetto_trace'); // always start/stop/fetch perfetto trace
+
+    const requestedTracesWithConfig: TraceRequest[] = requestedTraces.map(
+      (traceName) => {
+        const enabledConfig = this.requestedEnabledConfig(
+          traceName,
+          this.traceConfig,
+        );
+        const selectedConfig = this.requestedSelectedConfig(
+          traceName,
+          this.traceConfig,
+        );
+        return {
+          name: traceName,
+          config: enabledConfig.concat(selectedConfig),
+        };
+      },
+    );
+    await assertDefined(this.adbConnection).startTrace(
+      assertDefined(this.selectedDevice),
+      requestedTracesWithConfig,
+    );
+  }
+
+  private async onConnectionStateChange() {
     this.changeDetectorRef.detectChanges();
+
+    const connection = assertDefined(this.adbConnection);
+    const state = connection.getState();
+    if (state === ConnectionState.TRACE_TIMEOUT) {
+      UserNotifier.add(new ProxyTraceTimeout());
+      this.filesCollected.emit({
+        requested: this.requestedTraceTypes,
+        collected: await connection.fetchLastTracingSessionData(
+          assertDefined(this.selectedDevice),
+        ),
+      });
+      return;
+    }
+
     if (
       !this.refreshDumps ||
-      this.connect?.isLoadDataState() ||
-      this.connect?.isConnectingState()
+      state === ConnectionState.LOADING_DATA ||
+      state === ConnectionState.CONNECTING
     ) {
       return;
     }
-    if (this.connect?.isStartTraceState()) {
+    if (state === ConnectionState.IDLE && this.selectedDevice) {
       this.dumpState();
     } else {
       // device is not connected or proxy is not started/invalid/in error state
@@ -558,67 +824,106 @@ export class CollectTracesComponent
     }
   }
 
-  private getRequestedTraces() {
-    const tracesFromCollection: string[] = [];
+  private getRequestedTraces(): string[] {
     const tracingConfig = assertDefined(this.traceConfig);
-    const requested = Object.keys(tracingConfig).filter((traceKey: string) => {
-      return tracingConfig[traceKey].run;
+    return Object.keys(tracingConfig).filter((traceKey: string) => {
+      return tracingConfig[traceKey].enabled;
     });
-    requested.push(...tracesFromCollection);
-    requested.push('perfetto_trace'); // always start/stop/fetch perfetto trace
-    return requested;
   }
 
-  private getRequestedDumps() {
-    const dumpConfig = assertDefined(this.dumpConfig);
-    const requested = Object.keys(dumpConfig).filter((dumpKey: string) => {
-      return dumpConfig[dumpKey].run;
+  private getRequestedDumps(): string[] {
+    let dumpConfig = assertDefined(this.dumpConfig);
+    if (this.refreshDumps && this.storage) {
+      const storedConfig = this.storage.get(this.storeKeyDumpConfig);
+      if (storedConfig) {
+        dumpConfig = JSON.parse(storedConfig);
+      }
+    }
+    return Object.keys(dumpConfig).filter((dumpKey: string) => {
+      return dumpConfig[dumpKey].enabled;
     });
-    requested.push('perfetto_dump'); // always dump/fetch perfetto dump
-    return requested;
   }
 
-  private requestedEnableConfig(): string[] {
-    const req: string[] = [];
-    const tracingConfig = assertDefined(this.traceConfig);
-    Object.keys(tracingConfig).forEach((traceKey: string) => {
-      const trace = tracingConfig[traceKey];
-      if (trace.run && trace.config && trace.config.enableConfigs) {
-        trace.config.enableConfigs.forEach((con: EnableConfiguration) => {
-          if (con.enabled) {
-            req.push(con.key);
-          }
-        });
-      }
-    });
+  private requestedEnabledConfig(
+    traceName: string,
+    configMap: TraceConfigurationMap,
+  ): TraceRequestConfig[] {
+    const req: TraceRequestConfig[] = [];
+    const trace = configMap[traceName];
+    if (trace?.enabled) {
+      trace.config?.enableConfigs?.forEach((con: EnableConfiguration) => {
+        if (con.enabled) {
+          req.push({key: con.key});
+        }
+      });
+    }
     return req;
   }
 
-  private requestedSelection(traceType: string): ConfigMap | undefined {
-    const tracingConfig = assertDefined(this.traceConfig);
-    if (!tracingConfig[traceType].run) {
-      return undefined;
+  private requestedSelectedConfig(
+    traceName: string,
+    configMap: TraceConfigurationMap,
+  ): TraceRequestConfig[] {
+    const trace = configMap[traceName];
+    if (!trace?.enabled) {
+      return [];
     }
-    const selected: ConfigMap = {};
-    tracingConfig[traceType].config?.selectionConfigs.forEach(
-      (con: SelectionConfiguration) => {
-        selected[con.key] = con.value;
-      },
+    return (
+      trace.config?.selectionConfigs.map((con: SelectionConfiguration) => {
+        return {key: con.key, value: con.value};
+      }) ?? []
     );
-    return selected;
   }
 
-  private onLoadProgressUpdate(progressPercentage: number) {
-    this.progressPercentage = progressPercentage;
-    this.changeDetectorRef.detectChanges();
-  }
+  private toggleAvailabilityOfTraces = (traces: string[]) =>
+    traces.forEach((trace) => {
+      const config = assertDefined(this.traceConfig)[trace];
+      config.available = !config.available;
+    });
 
-  private setTraceConfigForAvailableTraces = (
-    availableTracesConfig: TraceConfigurationMap,
-  ) =>
-    (this.traceConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
-      'TraceConfiguration',
-      availableTracesConfig,
-      assertDefined(this.storage),
-    ));
+  private handleDevicesChange = (devices: AdbDevice[]) => {
+    if (!this.selectedDevice) {
+      return;
+    }
+    const selectedDevice = devices.find(
+      (d) => d.id === assertDefined(this.selectedDevice).id,
+    );
+    if (!selectedDevice) {
+      return;
+    }
+    const screenRecordingConfig = assertDefined(
+      this.traceConfig['screen_recording'].config,
+    );
+    const displays = assertDefined(
+      screenRecordingConfig?.selectionConfigs.find((c) => c.key === 'displays'),
+    );
+    if (
+      selectedDevice.multiDisplayScreenRecordingAvailable &&
+      !Array.isArray(displays.value)
+    ) {
+      screenRecordingConfig.selectionConfigs = makeScreenRecordingConfigs(
+        selectedDevice.displays,
+        [],
+      );
+    } else if (
+      !selectedDevice.multiDisplayScreenRecordingAvailable &&
+      Array.isArray(displays.value)
+    ) {
+      screenRecordingConfig.selectionConfigs = makeScreenRecordingConfigs(
+        selectedDevice.displays,
+        '',
+      );
+    } else {
+      screenRecordingConfig.selectionConfigs[0].options =
+        selectedDevice.displays;
+    }
+
+    const screenshotConfig = assertDefined(this.dumpConfig)['screenshot']
+      .config;
+    assertDefined(
+      screenshotConfig?.selectionConfigs.find((c) => c.key === 'displays'),
+    ).options = selectedDevice.displays;
+
+    this.changeDetectorRef.detectChanges();
+  };
 }
diff --git a/tools/winscope/src/app/components/collect_traces_component_test.ts b/tools/winscope/src/app/components/collect_traces_component_test.ts
index 5476a3bb2..44e5f422a 100644
--- a/tools/winscope/src/app/components/collect_traces_component_test.ts
+++ b/tools/winscope/src/app/components/collect_traces_component_test.ts
@@ -13,10 +13,19 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {NO_ERRORS_SCHEMA} from '@angular/core';
+import {CommonModule} from '@angular/common';
+import {
+  Component,
+  NO_ERRORS_SCHEMA,
+  QueryList,
+  ViewChildren,
+} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
 import {MatButtonModule} from '@angular/material/button';
 import {MatCardModule} from '@angular/material/card';
+import {MatCheckboxModule} from '@angular/material/checkbox';
+import {MatDialogModule} from '@angular/material/dialog';
 import {MatDividerModule} from '@angular/material/divider';
 import {MatIconModule} from '@angular/material/icon';
 import {MatListModule} from '@angular/material/list';
@@ -25,25 +34,45 @@ import {MatSnackBar, MatSnackBarModule} from '@angular/material/snack-bar';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {PersistentStoreProxy} from 'common/persistent_store_proxy';
-import {
-  TraceConfigurationMap,
-  TRACES,
-} from 'trace_collection/trace_collection_utils';
+import {ProxyTraceTimeout} from 'messaging/user_warnings';
+import {NoTraceTargetsSelected, WinscopeEvent} from 'messaging/winscope_event';
+import {MockAdbConnection} from 'test/unit/mock_adb_connection';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {TraceType} from 'trace/trace_type';
+import {AdbConnection} from 'trace_collection/adb_connection';
+import {AdbDevice} from 'trace_collection/adb_device';
+import {ConnectionState} from 'trace_collection/connection_state';
+import {ProxyConnection} from 'trace_collection/proxy_connection';
 import {AdbProxyComponent} from './adb_proxy_component';
 import {CollectTracesComponent} from './collect_traces_component';
 import {LoadProgressComponent} from './load_progress_component';
 import {TraceConfigComponent} from './trace_config_component';
+import {WarningDialogComponent} from './warning_dialog_component';
 import {WebAdbComponent} from './web_adb_component';
 
 describe('CollectTracesComponent', () => {
-  let fixture: ComponentFixture<CollectTracesComponent>;
-  let component: CollectTracesComponent;
+  let fixture: ComponentFixture<TestHostComponent>;
+  let component: TestHostComponent;
   let htmlElement: HTMLElement;
+  const mockDevice: AdbDevice = {
+    id: '35562',
+    model: 'Pixel 6',
+    authorized: true,
+    displays: [],
+    multiDisplayScreenRecordingAvailable: false,
+  };
+  const mockDeviceWatch: AdbDevice = {
+    id: '75432',
+    model: 'Pixel Watch',
+    authorized: true,
+    displays: [],
+    multiDisplayScreenRecordingAvailable: false,
+  };
 
   beforeEach(async () => {
     await TestBed.configureTestingModule({
       imports: [
+        CommonModule,
         MatIconModule,
         MatCardModule,
         MatListModule,
@@ -52,43 +81,25 @@ describe('CollectTracesComponent', () => {
         MatProgressBarModule,
         BrowserAnimationsModule,
         MatSnackBarModule,
+        MatDialogModule,
+        MatCheckboxModule,
+        FormsModule,
       ],
       providers: [MatSnackBar],
       declarations: [
+        TestHostComponent,
         CollectTracesComponent,
         AdbProxyComponent,
         WebAdbComponent,
         TraceConfigComponent,
         LoadProgressComponent,
+        WarningDialogComponent,
       ],
       schemas: [NO_ERRORS_SCHEMA],
     }).compileComponents();
-    fixture = TestBed.createComponent(CollectTracesComponent);
+    fixture = TestBed.createComponent(TestHostComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
-    component.isAdbProxy = true;
-    component.storage = new InMemoryStorage();
-    component.traceConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
-      'TracingSettings',
-      TRACES['default'],
-      component.storage,
-    );
-    component.dumpConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
-      'DumpSettings',
-      {
-        window_dump: {
-          name: 'Window Manager',
-          run: true,
-          config: undefined,
-        },
-        layers_dump: {
-          name: 'Surface Flinger',
-          run: true,
-          config: undefined,
-        },
-      },
-      component.storage,
-    );
     fixture.detectChanges();
   });
 
@@ -102,9 +113,7 @@ describe('CollectTracesComponent', () => {
   });
 
   it('displays connecting message', () => {
-    assertDefined(component.connect).isConnectingState = jasmine
-      .createSpy()
-      .and.returnValue(true);
+    getConnection().state = ConnectionState.CONNECTING;
     fixture.detectChanges();
 
     const connectingMessage = assertDefined(
@@ -114,7 +123,7 @@ describe('CollectTracesComponent', () => {
   });
 
   it('displays adb set up', () => {
-    assertDefined(component.connect).adbSuccess = jasmine
+    getCollectTracesComponent().adbSuccess = jasmine
       .createSpy()
       .and.returnValue(false);
     fixture.detectChanges();
@@ -123,32 +132,18 @@ describe('CollectTracesComponent', () => {
     expect(setUpAdbEl.querySelector('.proxy-tab')).toBeTruthy();
   });
 
-  it('displays adb proxy element', () => {
-    assertDefined(component.connect).adbSuccess = jasmine
-      .createSpy()
-      .and.returnValue(false);
-    component.isAdbProxy = true;
-    fixture.detectChanges();
-
-    expect(htmlElement.querySelector('adb-proxy')).toBeTruthy();
-  });
-
   it('displays no connected devices', () => {
-    const connect = assertDefined(component.connect);
-    connect.isDevicesState = jasmine.createSpy().and.returnValue(true);
-    connect.devices = jasmine.createSpy().and.returnValue({});
+    getConnection().state = ConnectionState.IDLE;
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
     expect(el.innerHTML).toContain('No devices detected');
   });
 
-  it('displays connected authorised devices', () => {
-    const connect = assertDefined(component.connect);
-    connect.isDevicesState = jasmine.createSpy().and.returnValue(true);
-    connect.devices = jasmine
-      .createSpy()
-      .and.returnValue({'35562': {model: 'Pixel 6', authorised: true}});
+  it('displays connected authorized devices', () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    connection.devices = [mockDevice];
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
@@ -156,45 +151,98 @@ describe('CollectTracesComponent', () => {
     expect(el.innerHTML).toContain('smartphone');
   });
 
-  it('displays connected unauthorised devices', () => {
-    const connect = assertDefined(component.connect);
-    connect.isDevicesState = jasmine.createSpy().and.returnValue(true);
-    connect.devices = jasmine
-      .createSpy()
-      .and.returnValue({'35562': {model: 'Pixel 6', authorised: false}});
+  it('displays connected unauthorized devices', () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    connection.devices = [
+      {
+        id: '35562',
+        model: 'Pixel 6',
+        authorized: false,
+        displays: [],
+        multiDisplayScreenRecordingAvailable: false,
+      },
+    ];
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
-    expect(el.innerHTML).toContain('unauthorised');
+    expect(el.innerHTML).toContain('unauthorized');
     expect(el.innerHTML).toContain('screen_lock_portrait');
   });
 
-  it('auto detects changes in devices', async () => {
-    const connect = assertDefined(component.connect);
-    connect.isDevicesState = jasmine.createSpy().and.returnValue(true);
+  it('detects changes in devices', async () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
     expect(el.textContent).toContain('No devices detected');
 
-    connect.devices = jasmine
-      .createSpy()
-      .and.returnValue({'35562': {model: 'Pixel 6', authorised: true}});
-
+    connection.devices = [mockDevice];
+    fixture.detectChanges();
     await fixture.whenStable();
+
     expect(el.textContent).toContain(
       'Select a device: smartphone  Pixel 6 (35562)',
     );
   });
 
-  it('displays trace collection config elements', () => {
-    const connect = assertDefined(component.connect);
-    connect.isStartTraceState = jasmine.createSpy().and.returnValue(true);
-    const mock = {model: 'Pixel 6', authorised: true};
-    connect.devices = jasmine.createSpy().and.returnValue({'35562': mock});
-    connect.selectedDevice = jasmine.createSpy().and.returnValue(mock);
-    connect.selectedDeviceId = jasmine.createSpy().and.returnValue('35562');
+  it('displays connected devices again if selected device no longer present', () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    connection.devices = [mockDevice];
+    fixture.detectChanges();
+
+    const device = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.available-device'),
+    );
+    device.click();
+    fixture.detectChanges();
+
+    connection.devices = [mockDeviceWatch];
+    fixture.detectChanges();
+
+    const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
+    expect(el.textContent).toContain(
+      'Select a device: smartphone  Pixel Watch (75432)',
+    );
+  });
+
+  it('auto selects last device', () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    connection.devices = [mockDevice];
+    fixture.detectChanges();
+
+    const device = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.available-device'),
+    );
+    device.click();
+    fixture.detectChanges();
+    let configSection = assertDefined(
+      htmlElement.querySelector('.trace-collection-config'),
+    );
+    expect(configSection.textContent).toContain('Pixel 6');
+
+    connection.devices = [mockDeviceWatch];
+    fixture.detectChanges();
+
+    const el = assertDefined(htmlElement.querySelector('.devices-connecting'));
+    expect(el.textContent).toContain(
+      'Select a device: smartphone  Pixel Watch (75432)',
+    );
+    expect(htmlElement.querySelector('.trace-collection-config')).toBeNull();
+
+    connection.devices = [mockDevice];
     fixture.detectChanges();
+    configSection = assertDefined(
+      htmlElement.querySelector('.trace-collection-config'),
+    );
+    expect(configSection.textContent).toContain('Pixel 6');
+  });
+
+  it('displays trace collection config elements', () => {
+    goToConfigSection();
 
     const el = assertDefined(
       htmlElement.querySelector('.trace-collection-config'),
@@ -203,86 +251,195 @@ describe('CollectTracesComponent', () => {
     expect(el.innerHTML).toContain('Pixel 6');
     expect(el.innerHTML).toContain('35562');
 
-    const traceSection = htmlElement.querySelector('.trace-section');
-    expect(traceSection).toBeTruthy();
+    const traceSection = assertDefined(
+      htmlElement.querySelector('.trace-section'),
+    );
+    expect(traceSection.querySelector('trace-config')?.textContent).toContain(
+      'Trace targets',
+    );
+    expect(traceSection.querySelector('.start-btn')?.textContent).toContain(
+      'Start trace',
+    );
 
-    const dumpSection = htmlElement.querySelector('.dump-section');
-    expect(dumpSection).toBeTruthy();
+    const dumpSection = assertDefined(
+      htmlElement.querySelector('.dump-section'),
+    );
+    expect(dumpSection.querySelector('trace-config')?.textContent).toContain(
+      'Dump targets',
+    );
+    expect(dumpSection.querySelector('.dump-btn')?.textContent).toContain(
+      'Dump state',
+    );
   });
 
-  it('start trace button works as expected', () => {
-    const connect = assertDefined(component.connect);
-    connect.isStartTraceState = jasmine.createSpy().and.returnValue(true);
-    const mock = {model: 'Pixel 6', authorised: true};
-    connect.devices = jasmine.createSpy().and.returnValue({'35562': mock});
-    connect.selectedDevice = jasmine.createSpy().and.returnValue(mock);
+  it('updates config on change in trace config component', async () => {
+    goToConfigSection();
+    await fixture.whenStable();
     fixture.detectChanges();
 
-    const spy = spyOn(connect, 'startTrace');
-    const start = assertDefined(
-      htmlElement.querySelector('.start-btn button'),
-    ) as HTMLButtonElement;
-    start.click();
-    expect(spy).toHaveBeenCalled();
+    clickCheckboxAndCheckTraceConfig('window_trace', false);
+    clickCheckboxAndCheckTraceConfig('window_dump', true);
   });
 
-  it('dump state button works as expected', () => {
-    const connect = assertDefined(component.connect);
-    connect.isStartTraceState = jasmine.createSpy().and.returnValue(true);
-    const mock = {model: 'Pixel 6', authorised: true};
-    connect.devices = jasmine.createSpy().and.returnValue({'35562': mock});
-    connect.selectedDevice = jasmine.createSpy().and.returnValue(mock);
-    fixture.detectChanges();
+  it('start trace button works as expected', async () => {
+    goToConfigSection();
 
-    const spy = spyOn(connect, 'dumpState');
-    const dump = assertDefined(
-      htmlElement.querySelector('.dump-btn button'),
-    ) as HTMLButtonElement;
-    dump.click();
+    const spy = spyOn(getConnection(), 'startTrace');
+    await clickStartTraceButton();
     expect(spy).toHaveBeenCalled();
   });
 
+  it('emits event if no trace targets selected', async () => {
+    goToConfigSection();
+    const collectTracesComponent = getCollectTracesComponent();
+
+    let lastEvent: WinscopeEvent | undefined;
+    collectTracesComponent.setEmitEvent(async (event: WinscopeEvent) => {
+      lastEvent = event;
+    });
+
+    Object.values(collectTracesComponent.traceConfig).forEach(
+      (c) => (c.enabled = false),
+    );
+    const spy = spyOn(getConnection(), 'startTrace');
+    await clickStartTraceButton();
+
+    expect(lastEvent).toEqual(new NoTraceTargetsSelected());
+    expect(spy).not.toHaveBeenCalled();
+  });
+
+  it('dump state button works as expected', async () => {
+    goToConfigSection();
+
+    const filesSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    await clickDumpStateButton();
+
+    expect(filesSpy).toHaveBeenCalledOnceWith({
+      requested: [
+        {name: 'Window Manager', types: [TraceType.WINDOW_MANAGER]},
+        {name: 'Surface Flinger', types: [TraceType.SURFACE_FLINGER]},
+        {name: 'Screenshot', types: [TraceType.SCREENSHOT]},
+      ],
+      collected: getConnection().files,
+    });
+  });
+
+  it('emits event if no dump targets selected', async () => {
+    goToConfigSection();
+    const collectTracesComponent = getCollectTracesComponent();
+
+    let lastEvent: WinscopeEvent | undefined;
+    collectTracesComponent.setEmitEvent(async (event: WinscopeEvent) => {
+      lastEvent = event;
+    });
+
+    Object.values(collectTracesComponent.dumpConfig).forEach(
+      (c) => (c.enabled = false),
+    );
+    const filesSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    await clickDumpStateButton();
+
+    expect(lastEvent).toEqual(new NoTraceTargetsSelected());
+    expect(filesSpy).not.toHaveBeenCalled();
+  });
+
+  it('does not collect files if dumping fails', async () => {
+    goToConfigSection();
+
+    const filesSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    const connection = getConnection();
+    spyOn(connection, 'dumpState').and.callFake(async () => {
+      connection.state = ConnectionState.ERROR;
+    });
+    await clickDumpStateButton();
+
+    expect(filesSpy).not.toHaveBeenCalled();
+  });
+
   it('change device button works as expected', () => {
-    const connect = assertDefined(component.connect);
-    connect.isStartTraceState = jasmine.createSpy().and.returnValue(true);
-    const mock = {model: 'Pixel 6', authorised: true};
-    connect.devices = jasmine.createSpy().and.returnValue({'35562': mock});
-    connect.selectedDevice = jasmine.createSpy().and.returnValue(mock);
-    fixture.detectChanges();
+    goToConfigSection();
+    expect(getCollectTracesComponent().getSelectedDevice()).toBeDefined();
+
+    const spy = spyOn(getConnection(), 'restartConnection');
 
-    const spy = spyOn(connect, 'resetLastDevice');
     const change = assertDefined(
-      htmlElement.querySelector('.change-btn'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>('.change-btn'),
+    );
     change.click();
+
     expect(spy).toHaveBeenCalled();
   });
 
+  it('fetch existing traces button emits files and restarts connection if no files found', async () => {
+    const connection = getConnection();
+    connection.files = [];
+    const emitSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    const restartSpy = spyOn(connection, 'restartConnection');
+    goToConfigSection();
+
+    const fetchButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.fetch-btn'),
+    );
+
+    fetchButton.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(emitSpy).toHaveBeenCalledOnceWith({
+      requested: [],
+      collected: [],
+    });
+    expect(restartSpy).toHaveBeenCalledTimes(1);
+  });
+
+  it('fetch existing traces button emits files and does not restart connection if files found', async () => {
+    const connection = getConnection();
+    const testFile = new File([], 'test_file');
+    connection.files = [testFile];
+    const emitSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    const restartSpy = spyOn(connection, 'restartConnection');
+    goToConfigSection();
+
+    const fetchButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.fetch-btn'),
+    );
+
+    fetchButton.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(emitSpy).toHaveBeenCalledWith({
+      requested: [],
+      collected: [testFile],
+    });
+    expect(restartSpy).not.toHaveBeenCalled();
+  });
+
   it('displays unknown error message', () => {
-    const connect = assertDefined(component.connect);
-    connect.isErrorState = jasmine.createSpy().and.returnValue(true);
+    const connection = getConnection();
+    connection.state = ConnectionState.ERROR;
     fixture.detectChanges();
 
     const testErrorMessage = 'bad things are happening';
-    assertDefined(connect.proxy).errorText = testErrorMessage;
+    connection.errorText = testErrorMessage;
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.unknown-error'));
     expect(el.innerHTML).toContain('Error:');
     expect(el.innerHTML).toContain(testErrorMessage);
 
-    const spy = spyOn(connect, 'restart').and.callThrough();
+    const spy = spyOn(connection, 'restartConnection').and.callThrough();
     const retryButton = assertDefined(
-      htmlElement.querySelector('.retry-btn'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>('.retry-btn'),
+    );
     retryButton.click();
     expect(spy).toHaveBeenCalled();
   });
 
   it('displays starting trace elements', () => {
-    assertDefined(component.connect).isStartingTraceState = jasmine
-      .createSpy()
-      .and.returnValue(true);
+    goToConfigSection();
+    const connection = getConnection();
+    connection.state = ConnectionState.STARTING_TRACE;
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.starting-trace'));
@@ -290,34 +447,65 @@ describe('CollectTracesComponent', () => {
     expect(progress.innerHTML).toContain('Starting trace...');
 
     const endButton = assertDefined(
-      el.querySelector('.end-btn button'),
-    ) as HTMLButtonElement;
+      el.querySelector<HTMLButtonElement>('.end-btn button'),
+    );
     expect(endButton.disabled).toBeTrue();
   });
 
-  it('displays end tracing elements', () => {
-    const connect = assertDefined(component.connect);
-    connect.isEndTraceState = jasmine.createSpy().and.returnValue(true);
+  it('displays tracing elements and ends trace correctly', async () => {
+    goToConfigSection();
+    const connection = getConnection();
+    connection.state = ConnectionState.TRACING;
     fixture.detectChanges();
 
-    const el = assertDefined(htmlElement.querySelector('.end-tracing'));
+    const el = assertDefined(htmlElement.querySelector('.tracing'));
     const progress = assertDefined(el.querySelector('load-progress'));
     expect(progress.innerHTML).toContain('Tracing...');
     expect(progress.innerHTML).toContain('cable');
 
-    const spy = spyOn(connect, 'endTrace');
+    const endSpy = spyOn(connection, 'endTrace').and.callThrough();
+    const fetchSpy = spyOn(connection, 'fetchLastTracingSessionData');
     const endButton = assertDefined(
-      el.querySelector('.end-btn button'),
-    ) as HTMLButtonElement;
-    expect(endButton.disabled).toBeFalse();
+      el.querySelector<HTMLElement>('.end-btn button'),
+    );
     endButton.click();
-    expect(spy).toHaveBeenCalled();
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(endSpy).toHaveBeenCalled();
+    expect(fetchSpy).toHaveBeenCalled();
+  });
+
+  it('displays ending trace elements', () => {
+    goToConfigSection();
+    const connection = getConnection();
+    connection.state = ConnectionState.ENDING_TRACE;
+    fixture.detectChanges();
+
+    const el = assertDefined(htmlElement.querySelector('.ending-trace'));
+    const progress = assertDefined(el.querySelector('load-progress'));
+    expect(progress.innerHTML).toContain('Ending trace...');
+    expect(progress.innerHTML).toContain('cable');
+
+    const endButton = assertDefined(
+      el.querySelector<HTMLButtonElement>('.end-btn button'),
+    );
+    expect(endButton.disabled).toBeTrue();
+  });
+
+  it('displays dumping state elements', () => {
+    goToConfigSection();
+    const connection = getConnection();
+    connection.state = ConnectionState.DUMPING_STATE;
+    fixture.detectChanges();
+
+    const progress = assertDefined(htmlElement.querySelector('.dumping-state'));
+    expect(progress.querySelector('.end-btn button')).toBeNull();
   });
 
   it('displays loading data elements', () => {
-    assertDefined(component.connect).isLoadDataState = jasmine
-      .createSpy()
-      .and.returnValue(true);
+    goToConfigSection();
+    const connection = getConnection();
+    connection.state = ConnectionState.LOADING_DATA;
     fixture.detectChanges();
 
     const el = assertDefined(htmlElement.querySelector('.load-data'));
@@ -325,8 +513,400 @@ describe('CollectTracesComponent', () => {
     expect(progress.innerHTML).toContain('Fetching...');
 
     const endButton = assertDefined(
-      el.querySelector('.end-btn button'),
-    ) as HTMLButtonElement;
+      el.querySelector<HTMLButtonElement>('.end-btn button'),
+    );
     expect(endButton.disabled).toBeTrue();
   });
+
+  it('starts traces after IME warning dialog', async () => {
+    const spy = spyOn(getConnection(), 'startTrace');
+    goToConfigSection();
+    const dialog = await openAndReturnDialog();
+
+    const buttons = dialog.querySelectorAll<HTMLElement>(
+      '.warning-action-buttons button',
+    );
+    buttons.item(buttons.length - 1).click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(spy).toHaveBeenCalled();
+  });
+
+  it('goes back to edit config display after IME warning dialog', async () => {
+    const spy = spyOn(getConnection(), 'startTrace');
+    goToConfigSection();
+    const dialog = await openAndReturnDialog();
+
+    const button = assertDefined(
+      dialog.querySelector<HTMLElement>('.warning-action-buttons button'),
+    );
+    button.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(spy).not.toHaveBeenCalled();
+    expect(htmlElement.querySelector('trace-config')).toBeTruthy();
+  });
+
+  it('does not show IME warning dialog again in same session if user selects "Do not show again"', async () => {
+    const spy = spyOn(getConnection(), 'startTrace');
+    goToConfigSection();
+    const dialog = await openAndReturnDialog();
+
+    const option = assertDefined(
+      dialog.querySelector<HTMLInputElement>(
+        '.warning-action-boxes mat-checkbox input',
+      ),
+    );
+    option.checked = true;
+    option.click();
+    fixture.detectChanges();
+
+    const button = assertDefined(
+      dialog.querySelector<HTMLElement>('.warning-action-buttons button'),
+    );
+    button.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(spy).not.toHaveBeenCalled();
+    expect(htmlElement.querySelector('trace-config')).toBeTruthy();
+
+    await clickStartTraceButton();
+
+    expect(spy).toHaveBeenCalled();
+    expect(document.querySelector('warning-dialog')).toBeNull();
+  });
+
+  it('handles successful external operations', () => {
+    goToConfigSection();
+    const collectTracesComponent = getCollectTracesComponent();
+
+    collectTracesComponent.onProgressUpdate('test operation', 0);
+    const el = assertDefined(htmlElement.querySelector('.load-data'));
+    const progress = assertDefined(el.querySelector('load-progress'));
+    expect(progress.textContent).toContain('test operation');
+
+    collectTracesComponent.onOperationFinished(true);
+    expect(htmlElement.querySelector('.load-data')).toBeNull();
+    expect(htmlElement.querySelector('.trace-collection-config')).toBeTruthy();
+  });
+
+  it('restarts connection on unsuccessful external operation', () => {
+    goToConfigSection();
+    const collectTracesComponent = getCollectTracesComponent();
+
+    collectTracesComponent.onProgressUpdate('test operation', 0);
+
+    const spy = spyOn(getConnection(), 'restartConnection');
+    collectTracesComponent.onOperationFinished(false);
+    expect(spy).toHaveBeenCalledTimes(1);
+  });
+
+  it('refreshes dumps', async () => {
+    goToConfigSection();
+    const collectTracesComponent = getCollectTracesComponent();
+    const spy = spyOn(getConnection(), 'dumpState');
+    collectTracesComponent.refreshDumps = true;
+    fixture.detectChanges();
+
+    getConnection().setState(ConnectionState.IDLE);
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(spy).toHaveBeenCalledOnceWith(mockDevice, [
+      {name: 'window_dump', config: []},
+      {name: 'layers_dump', config: []},
+      {name: 'screenshot', config: [{key: 'displays', value: []}]},
+      {name: 'perfetto_dump', config: []},
+    ]);
+  });
+
+  it('does not refresh dumps if no device selected', async () => {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    const collectTracesComponent = getCollectTracesComponent();
+    collectTracesComponent.refreshDumps = true;
+    const spy = spyOn(connection, 'dumpState');
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(spy).not.toHaveBeenCalled();
+  });
+
+  it('refreshes dumps using stored dump config', async () => {
+    goToConfigSection();
+    await fixture.whenStable();
+    fixture.detectChanges();
+    clickCheckboxAndCheckTraceConfig('window_dump', true);
+
+    component.showSecondComponent = true;
+    fixture.detectChanges();
+    const newComponent = getCollectTracesComponent(1);
+    const spy = spyOn(getConnection(), 'dumpState');
+    newComponent.refreshDumps = true;
+    fixture.detectChanges();
+
+    getConnection().setState(ConnectionState.IDLE);
+    fixture.detectChanges();
+    await fixture.whenStable();
+    expect(spy).toHaveBeenCalledOnceWith(mockDevice, [
+      {name: 'layers_dump', config: []},
+      {name: 'screenshot', config: [{key: 'displays', value: []}]},
+      {name: 'perfetto_dump', config: []},
+    ]);
+  });
+
+  it('update available traces from connection', () => {
+    const config = getCollectTracesComponent().traceConfig;
+    expect(config['wayland_trace']?.available).toBeFalse();
+    getConnection().availableTracesChangeCallback(['wayland_trace']);
+    fixture.detectChanges();
+    expect(config['wayland_trace']?.available).toBeTrue();
+  });
+
+  it('fetches tracing data if trace times out', async () => {
+    goToConfigSection();
+    const userNotifierChecker = new UserNotifierChecker();
+    const connection = getConnection();
+    const emitSpy = spyOn(getCollectTracesComponent().filesCollected, 'emit');
+    connection.setState(ConnectionState.TRACE_TIMEOUT);
+
+    await fixture.whenStable();
+    expect(emitSpy).toHaveBeenCalledOnceWith({
+      requested: [],
+      collected: connection.files,
+    });
+    userNotifierChecker.expectAdded([new ProxyTraceTimeout()]);
+  });
+
+  it('updates options in media based config on devices change from connection', () => {
+    checkMediaBasedConfigUpdates(false);
+  });
+
+  it('updates multiple selection in screen recording config on devices change from connection', () => {
+    checkMediaBasedConfigUpdates(true);
+  });
+
+  describe('ProxyConnection', () => {
+    beforeEach(async () => {
+      await startProxyConnection();
+    });
+
+    it('displays adb proxy element', () => {
+      expect(htmlElement.querySelector('adb-proxy')).toBeTruthy();
+    });
+
+    it('adds security token and restarts connection', async () => {
+      spyOn(assertDefined(component.adbConnection), 'getState').and.returnValue(
+        ConnectionState.UNAUTH,
+      );
+      fixture.detectChanges();
+
+      const connection = assertDefined(component.adbConnection);
+      const securityTokenSpy = spyOn(connection, 'setSecurityToken');
+      const restartSpy = spyOn(connection, 'restartConnection');
+
+      const proxyTokenInput = assertDefined(
+        htmlElement.querySelector<HTMLInputElement>(
+          '.proxy-token-input-field input',
+        ),
+      );
+      proxyTokenInput.value = '12345';
+      proxyTokenInput.dispatchEvent(new Event('input'));
+      fixture.detectChanges();
+
+      assertDefined(htmlElement.querySelector<HTMLElement>('.retry')).click();
+      fixture.detectChanges();
+      await fixture.whenStable();
+
+      expect(securityTokenSpy).toHaveBeenCalledOnceWith('12345');
+      expect(restartSpy).toHaveBeenCalledTimes(1);
+    });
+  });
+
+  function goToConfigSection() {
+    const connection = getConnection();
+    connection.state = ConnectionState.IDLE;
+    connection.devices = [mockDevice];
+    fixture.detectChanges();
+    const device = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.available-device'),
+    );
+    device.click();
+    fixture.detectChanges();
+  }
+
+  function clickCheckboxAndCheckTraceConfig(key: string, isDump: boolean) {
+    const collectTracesComponent = getCollectTracesComponent();
+    expect(
+      isDump
+        ? collectTracesComponent.dumpConfig[key].enabled
+        : collectTracesComponent.traceConfig[key].enabled,
+    ).toBeTrue();
+
+    const checkboxSection = assertDefined(
+      htmlElement.querySelector(isDump ? '.dump-section' : '.trace-section'),
+    );
+    const traceBoxes = Array.from(
+      checkboxSection.querySelectorAll<HTMLElement>('.trace-checkbox'),
+    );
+
+    const expectedName = isDump
+      ? collectTracesComponent.dumpConfig[key].name
+      : collectTracesComponent.traceConfig[key].name;
+    const traceBox = assertDefined(
+      traceBoxes.find((box) => box.textContent?.includes(expectedName)),
+    );
+    const traceCheckboxInput = assertDefined(
+      traceBox.querySelector<HTMLInputElement>('input'),
+    );
+    traceCheckboxInput.click();
+    fixture.detectChanges();
+    expect(
+      isDump
+        ? collectTracesComponent.dumpConfig[key].enabled
+        : collectTracesComponent.traceConfig[key].enabled,
+    ).toBeFalse();
+  }
+
+  async function startProxyConnection() {
+    const collectTracesComponent = getCollectTracesComponent();
+    collectTracesComponent.adbSuccess = jasmine
+      .createSpy()
+      .and.returnValue(false);
+    component.adbConnection = new ProxyConnection();
+    fixture.detectChanges();
+    await fixture.whenStable();
+  }
+
+  function updateTraceConfigToInvalidIMEFrameMapping() {
+    const config = assertDefined(getCollectTracesComponent().traceConfig);
+    config['ime'].enabled = true;
+    config['layers_trace'].enabled = false;
+  }
+
+  async function clickStartTraceButton() {
+    const start = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.start-btn button'),
+    );
+    start.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+  }
+
+  async function clickDumpStateButton() {
+    const dump = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.dump-btn button'),
+    );
+    dump.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+  }
+
+  async function openAndReturnDialog(): Promise<HTMLElement> {
+    updateTraceConfigToInvalidIMEFrameMapping();
+    await clickStartTraceButton();
+    const dialog = assertDefined(
+      document.querySelector<HTMLElement>('warning-dialog'),
+    );
+    expect(dialog.textContent).toContain(
+      'Cannot build frame mapping for IME with selected traces',
+    );
+    return dialog;
+  }
+
+  function getCollectTracesComponent(index = 0): CollectTracesComponent {
+    return assertDefined(component.collectTracesComponents?.get(index));
+  }
+
+  function getConnection(): MockAdbConnection {
+    const connection = assertDefined(component.adbConnection);
+    expect(connection).toBeInstanceOf(MockAdbConnection);
+    return connection as MockAdbConnection;
+  }
+
+  function checkMediaBasedConfigUpdates(
+    multiDisplayScreenRecordingAvailable: boolean,
+  ) {
+    checkMediaBasedConfig([], false);
+
+    const validDeviceWithDisplays: AdbDevice = {
+      id: '35562',
+      model: 'Pixel 6',
+      authorized: true,
+      displays: ['12345 Extra Info'],
+      multiDisplayScreenRecordingAvailable,
+    };
+
+    // does not update if no selected device
+    getConnection().devicesChangeCallback([validDeviceWithDisplays]);
+    fixture.detectChanges();
+    checkMediaBasedConfig([], false);
+
+    goToConfigSection();
+
+    // does not update if selected device not in new devices
+    getConnection().devicesChangeCallback([
+      {
+        id: '99',
+        model: 'Pixel 6',
+        authorized: true,
+        displays: ['12345 Extra Info'],
+        multiDisplayScreenRecordingAvailable,
+      },
+    ]);
+    fixture.detectChanges();
+    checkMediaBasedConfig([], false);
+
+    getConnection().devicesChangeCallback([validDeviceWithDisplays]);
+    fixture.detectChanges();
+    checkMediaBasedConfig(
+      ['12345 Extra Info'],
+      multiDisplayScreenRecordingAvailable,
+    );
+
+    if (multiDisplayScreenRecordingAvailable) {
+      validDeviceWithDisplays.multiDisplayScreenRecordingAvailable = false;
+      getConnection().devicesChangeCallback([validDeviceWithDisplays]);
+      fixture.detectChanges();
+      checkMediaBasedConfig(['12345 Extra Info'], false);
+    }
+  }
+
+  function checkMediaBasedConfig(
+    displays: string[],
+    multiDisplayScreenRecordingAvailable: boolean,
+  ) {
+    const screenRecordingConfig = assertDefined(
+      getCollectTracesComponent().traceConfig['screen_recording'].config,
+    ).selectionConfigs[0];
+    const screenshotConfig = assertDefined(
+      getCollectTracesComponent().dumpConfig['screenshot'].config,
+    ).selectionConfigs[0];
+    expect(screenRecordingConfig.options).toEqual(displays);
+    expect(screenshotConfig.options).toEqual(displays);
+    expect(screenRecordingConfig.value).toEqual(
+      multiDisplayScreenRecordingAvailable ? [] : '',
+    );
+  }
+
+  @Component({
+    selector: 'host-component',
+    template: `
+      <collect-traces
+        [adbConnection]="adbConnection"
+        [storage]="storage"></collect-traces>
+
+      <collect-traces
+        *ngIf="showSecondComponent"
+        [adbConnection]="adbConnection"
+        [storage]="storage"></collect-traces>
+    `,
+  })
+  class TestHostComponent {
+    adbConnection: AdbConnection = new MockAdbConnection();
+    storage = new InMemoryStorage();
+    showSecondComponent = false;
+
+    @ViewChildren(CollectTracesComponent)
+    collectTracesComponents: QueryList<CollectTracesComponent> | undefined;
+  }
 });
diff --git a/tools/winscope/src/app/components/shortcuts_component.ts b/tools/winscope/src/app/components/shortcuts_component.ts
index 42faa2236..26bf218d8 100644
--- a/tools/winscope/src/app/components/shortcuts_component.ts
+++ b/tools/winscope/src/app/components/shortcuts_component.ts
@@ -16,6 +16,7 @@
 import {Component, Inject} from '@angular/core';
 import {MatIconRegistry} from '@angular/material/icon';
 import {DomSanitizer} from '@angular/platform-browser';
+import {overlayPanelStyles} from 'app/styles/overlay_panel.styles';
 import {UrlUtils} from 'common/url_utils';
 
 @Component({
@@ -105,11 +106,6 @@ import {UrlUtils} from 'common/url_utils';
         display: flex;
         justify-content: space-between;
       }
-      .close-button {
-        width: 24px;
-        height: 24px;
-        line-height: 24px;
-      }
       .shortcuts-row {
         display: flex;
         flex-direction: row;
@@ -170,6 +166,7 @@ import {UrlUtils} from 'common/url_utils';
         font-style: italic;
       }
     `,
+    overlayPanelStyles,
   ],
 })
 export class ShortcutsComponent {
diff --git a/tools/winscope/src/app/components/snack_bar_opener.ts b/tools/winscope/src/app/components/snack_bar_opener.ts
index e3fa3227c..77a7fe618 100644
--- a/tools/winscope/src/app/components/snack_bar_opener.ts
+++ b/tools/winscope/src/app/components/snack_bar_opener.ts
@@ -18,11 +18,16 @@ import {Inject, Injectable, NgZone} from '@angular/core';
 import {MatSnackBar} from '@angular/material/snack-bar';
 import {assertDefined} from 'common/assert_utils';
 import {NotificationType, UserNotification} from 'messaging/user_notification';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
 import {SnackBarComponent} from './snack_bar_component';
 
+type Messages = string[];
+
 @Injectable({providedIn: 'root'})
-export class SnackBarOpener implements UserNotificationsListener {
+export class SnackBarOpener {
+  private static CROP_THRESHOLD = 5;
+  private isOpen = false;
+  private queue: Messages[] = [];
+
   constructor(
     @Inject(NgZone) private ngZone: NgZone,
     @Inject(MatSnackBar) private snackBar: MatSnackBar,
@@ -35,20 +40,18 @@ export class SnackBarOpener implements UserNotificationsListener {
       return;
     }
 
-    this.ngZone.run(() => {
-      // The snackbar needs to be opened within ngZone,
-      // otherwise it will first display on the left and then will jump to the center
-      this.snackBar.openFromComponent(SnackBarComponent, {
-        data: messages,
-        duration: 10000,
-      });
-    });
+    if (this.isOpen) {
+      this.queue.push(messages);
+      return;
+    }
+
+    this.displayMessages(messages);
   }
 
   private convertNotificationsToMessages(
     notifications: UserNotification[],
-  ): string[] {
-    const messages: string[] = [];
+  ): Messages {
+    const messages: Messages = [];
 
     const warnings = notifications.filter(
       (n) => n.getNotificationType() === NotificationType.WARNING,
@@ -56,8 +59,10 @@ export class SnackBarOpener implements UserNotificationsListener {
     const groups = this.groupNotificationsByDescriptor(warnings);
 
     for (const groupedWarnings of groups) {
-      const CROP_THRESHOLD = 5;
-      const countUsed = Math.min(groupedWarnings.length, CROP_THRESHOLD);
+      const countUsed = Math.min(
+        groupedWarnings.length,
+        SnackBarOpener.CROP_THRESHOLD,
+      );
       const countCropped = groupedWarnings.length - countUsed;
 
       groupedWarnings.slice(0, countUsed).forEach((warning) => {
@@ -66,7 +71,9 @@ export class SnackBarOpener implements UserNotificationsListener {
 
       if (countCropped > 0) {
         messages.push(
-          `... (cropped ${countCropped} '${groupedWarnings[0].getDescriptor()}' messages)`,
+          `... (cropped ${countCropped} '${groupedWarnings[0].getDescriptor()}' message${
+            countCropped > 1 ? 's' : ''
+          })`,
         );
       }
     }
@@ -88,4 +95,23 @@ export class SnackBarOpener implements UserNotificationsListener {
 
     return new Set(groups.values());
   }
+
+  private displayMessages(messages: Messages) {
+    this.ngZone.run(() => {
+      // The snackbar needs to be opened within ngZone,
+      // otherwise it will first display on the left and then will jump to the center
+      this.isOpen = true;
+      const ref = this.snackBar.openFromComponent(SnackBarComponent, {
+        data: messages,
+        duration: 5000 * messages.length,
+      });
+      ref.afterDismissed().subscribe(() => {
+        this.isOpen = false;
+        const next = this.queue.shift();
+        if (next !== undefined) {
+          this.displayMessages(next);
+        }
+      });
+    });
+  }
 }
diff --git a/tools/winscope/src/app/components/snack_bar_opener_test.ts b/tools/winscope/src/app/components/snack_bar_opener_test.ts
new file mode 100644
index 000000000..2f96dc3c1
--- /dev/null
+++ b/tools/winscope/src/app/components/snack_bar_opener_test.ts
@@ -0,0 +1,154 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Overlay} from '@angular/cdk/overlay';
+import {TestBed} from '@angular/core/testing';
+import {MatSnackBar, MatSnackBarRef} from '@angular/material/snack-bar';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {
+  FailedToInitializeTimelineData,
+  NoValidFiles,
+} from 'messaging/user_warnings';
+import {waitToBeCalled} from 'test/utils';
+import {SnackBarComponent} from './snack_bar_component';
+import {SnackBarOpener} from './snack_bar_opener';
+
+describe('SnackBarOpener', () => {
+  let snackBarOpener: SnackBarOpener;
+  let snackBar: MatSnackBar;
+  let openSpy: jasmine.Spy<jasmine.Func>;
+  const filesNotif = new NoValidFiles();
+  const filesMessage = filesNotif.getMessage();
+
+  const timelineNotif = new FailedToInitializeTimelineData();
+  const timelineMessage = timelineNotif.getMessage();
+
+  beforeEach(() => {
+    TestBed.configureTestingModule({
+      providers: [SnackBarOpener, MatSnackBar, Overlay],
+      imports: [BrowserAnimationsModule],
+      declarations: [SnackBarComponent],
+    });
+    snackBarOpener = TestBed.inject(SnackBarOpener);
+    snackBar = TestBed.inject(MatSnackBar);
+    openSpy = createOpenComponentSpy();
+  });
+
+  it('shows notifications in snackbar', () => {
+    snackBarOpener.onNotifications([filesNotif]);
+    const expectedMessages = [filesMessage];
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 5000,
+    });
+  });
+
+  it('handles empty notifications', () => {
+    snackBarOpener.onNotifications([]);
+    expect(openSpy).not.toHaveBeenCalled();
+  });
+
+  it('does not crop notifications below threshold', () => {
+    snackBarOpener.onNotifications(Array.from({length: 5}, () => filesNotif));
+    const expectedMessages = Array.from({length: 5}, () => filesMessage);
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 25000,
+    });
+  });
+
+  it('crops notifications if one above threshold', () => {
+    const notifications = Array.from({length: 6}, () => filesNotif);
+    snackBarOpener.onNotifications(notifications);
+
+    const expectedMessages = Array.from({length: 5}, () => filesMessage);
+    expectedMessages.push("... (cropped 1 'no valid files' message)");
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 30000,
+    });
+  });
+
+  it('crops notifications if more than one above threshold', () => {
+    const notifications = Array.from({length: 7}, () => filesNotif);
+    snackBarOpener.onNotifications(notifications);
+
+    const expectedMessages = Array.from({length: 5}, () => filesMessage);
+    expectedMessages.push("... (cropped 2 'no valid files' messages)");
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 30000,
+    });
+  });
+
+  it('does not apply crop if total notifications above threshold but not in same group', () => {
+    const notifications = Array.from({length: 5}, () => filesNotif).concat([
+      timelineNotif,
+    ]);
+    snackBarOpener.onNotifications(notifications);
+
+    const expectedMessages = Array.from({length: 5}, () => filesMessage).concat(
+      [timelineMessage],
+    );
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 30000,
+    });
+  });
+
+  it('only applies crop to notifications in same group', () => {
+    const notifications = Array.from({length: 5}, () => filesNotif).concat([
+      timelineNotif,
+      filesNotif,
+    ]);
+    snackBarOpener.onNotifications(notifications);
+
+    const expectedMessages = Array.from({length: 5}, () => filesMessage).concat(
+      ["... (cropped 1 'no valid files' message)", timelineMessage],
+    );
+    expect(openSpy).toHaveBeenCalledWith(SnackBarComponent, {
+      data: expectedMessages,
+      duration: 35000,
+    });
+  });
+
+  it('queues notifications', async () => {
+    snackBarOpener.onNotifications([filesNotif]);
+    expect(openSpy).toHaveBeenCalledOnceWith(SnackBarComponent, {
+      data: [filesMessage],
+      duration: 5000,
+    });
+    const ref: MatSnackBarRef<SnackBarComponent> =
+      openSpy.calls.mostRecent().returnValue;
+
+    openSpy.calls.reset();
+    snackBarOpener.onNotifications([filesNotif]);
+    expect(openSpy).not.toHaveBeenCalled();
+
+    const afterDismissedSpy = jasmine.createSpy('test', () => {});
+    ref.afterDismissed().subscribe(afterDismissedSpy);
+    ref.dismiss();
+    await waitToBeCalled(afterDismissedSpy);
+    expect(openSpy).toHaveBeenCalledOnceWith(SnackBarComponent, {
+      data: [filesMessage],
+      duration: 5000,
+    });
+  });
+
+  function createOpenComponentSpy(): jasmine.Spy<jasmine.Func> {
+    return spyOn(snackBar, 'openFromComponent').and.callThrough();
+  }
+});
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/abstract_timeline_row_component.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/abstract_timeline_row_component.ts
index 64756e4f4..23bca5d61 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/abstract_timeline_row_component.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/abstract_timeline_row_component.ts
@@ -23,7 +23,7 @@ import {
   ViewChild,
 } from '@angular/core';
 import {assertDefined} from 'common/assert_utils';
-import {Point} from 'common/geometry_types';
+import {Point} from 'common/geometry/point';
 import {TimeRange} from 'common/time';
 import {ComponentTimestampConverter} from 'common/timestamp_converter';
 import {Trace, TraceEntry} from 'trace/trace';
@@ -58,7 +58,7 @@ export abstract class AbstractTimelineRowComponent<T extends {}> {
   }
 
   getBackgroundColor() {
-    return this.isActive ? 'var(--drawer-block-secondary)' : undefined;
+    return this.isActive ? 'var(--selected-element-color)' : undefined;
   }
 
   ngAfterViewInit() {
@@ -101,12 +101,12 @@ export abstract class AbstractTimelineRowComponent<T extends {}> {
 
     canvas.width = HiPPIwidth;
     canvas.height = HiPPIheight;
-    canvas.style.width = width + 'px';
-    canvas.style.height = height + 'px';
+    canvas.style.width = '100%';
+    canvas.style.height = '100%';
 
     // ensure all drawing operations are scaled
     if (window.devicePixelRatio !== 1) {
-      const context = canvas.getContext('2d')!;
+      const context = assertDefined(canvas.getContext('2d'));
       context.scale(window.devicePixelRatio, window.devicePixelRatio);
     }
 
@@ -126,7 +126,7 @@ export abstract class AbstractTimelineRowComponent<T extends {}> {
     this.viewInitialized = true;
   }
 
-  async handleMouseDown(e: MouseEvent) {
+  handleMouseDown(e: MouseEvent) {
     e.preventDefault();
     e.stopPropagation();
     const mousePoint = {
@@ -134,15 +134,13 @@ export abstract class AbstractTimelineRowComponent<T extends {}> {
       y: e.offsetY,
     };
 
-    const transitionEntry = this.getEntryAt(mousePoint);
+    const entry = this.getEntryAt(mousePoint);
     // TODO: This can probably get made better by getting the transition and checking both the end and start timestamps match
-    if (transitionEntry && transitionEntry !== this.selectedEntry) {
+    if (entry && entry !== this.selectedEntry) {
       this.redraw();
-      this.selectedEntry = transitionEntry;
-      this.onTracePositionUpdate.emit(
-        TracePosition.fromTraceEntry(transitionEntry),
-      );
-    } else if (!transitionEntry && this.trace) {
+      this.selectedEntry = entry;
+      this.onTracePositionUpdate.emit(TracePosition.fromTraceEntry(entry));
+    } else if (!entry && this.trace) {
       this.onTraceClicked.emit(this.trace);
     }
   }
@@ -160,6 +158,7 @@ export abstract class AbstractTimelineRowComponent<T extends {}> {
 
   @HostListener('wheel', ['$event'])
   updateScroll(event: WheelEvent) {
+    event.preventDefault();
     this.onScrollEvent.emit(event);
   }
 
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer.ts
index 232a1a5f7..b1481b285 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer.ts
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
+import {TimelineUtils} from 'app/components/timeline/timeline_utils';
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
 
 export class CanvasDrawer {
   private canvas: HTMLCanvasElement | undefined;
@@ -30,27 +31,91 @@ export class CanvasDrawer {
     this.ctx = ctx;
   }
 
-  drawRect(rect: Rect, color: string, alpha: number) {
+  drawRect(
+    rect: Rect,
+    hexColor: string,
+    alpha: number,
+    withGradientStart = false,
+    withGradientEnd = false,
+  ) {
     if (!this.ctx) {
-      throw Error('Canvas not set');
+      throw new Error('Canvas not set');
     }
 
-    const rgbColor = this.hexToRgb(color);
+    const rgbColor = TimelineUtils.convertHexToRgb(hexColor);
     if (rgbColor === undefined) {
       throw new Error('Failed to parse provided hex color');
     }
     const {r, g, b} = rgbColor;
+    const rgbaColor = `rgba(${r},${g},${b},${alpha})`;
+    const transparentColor = `rgba(${r},${g},${b},${0})`;
 
     this.defineRectPath(rect, this.ctx);
-    this.ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
+    if (withGradientStart || withGradientEnd) {
+      const gradient = this.ctx.createLinearGradient(
+        rect.x,
+        0,
+        rect.x + rect.w,
+        0,
+      );
+      const gradientRatio = Math.max(0, Math.min(25 / rect.w, 1));
+      gradient.addColorStop(
+        0,
+        withGradientStart ? transparentColor : rgbaColor,
+      );
+      gradient.addColorStop(1, withGradientEnd ? transparentColor : rgbaColor);
+      gradient.addColorStop(gradientRatio, rgbaColor);
+      gradient.addColorStop(1 - gradientRatio, rgbaColor);
+      this.ctx.fillStyle = gradient;
+    } else {
+      this.ctx.fillStyle = rgbaColor;
+    }
     this.ctx.fill();
 
+    this.ctx.fillStyle = 'black';
+    const centerY = rect.y + rect.h / 2;
+    const marginOffset = 5;
+    if (withGradientStart) {
+      this.drawEllipsis(centerY, rect.x + marginOffset, true, rect.x + rect.w);
+    }
+
+    if (withGradientEnd) {
+      this.drawEllipsis(centerY, rect.x + rect.w - marginOffset, false, rect.x);
+    }
+
     this.ctx.restore();
   }
 
+  private drawEllipsis(
+    centerY: number,
+    startX: number,
+    forwards: boolean,
+    xLim: number,
+  ) {
+    if (!this.ctx) {
+      return;
+    }
+    let centerX = startX;
+    let i = 0;
+    const radius = 2;
+    while (i < 3) {
+      if (forwards && centerX + radius >= xLim) {
+        break;
+      }
+      if (!forwards && centerX + radius <= xLim) {
+        break;
+      }
+      this.ctx.beginPath();
+      this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
+      this.ctx.fill();
+      centerX = forwards ? centerX + 7 : centerX - 7;
+      i++;
+    }
+  }
+
   drawRectBorder(rect: Rect) {
     if (!this.ctx) {
-      throw Error('Canvas not set');
+      throw new Error('Canvas not set');
     }
     this.defineRectPath(rect, this.ctx);
     this.highlightPath(this.ctx);
@@ -102,24 +167,4 @@ export class CanvasDrawer {
     ctx.lineTo(rect.x, rect.y);
     ctx.closePath();
   }
-
-  private hexToRgb(hex: string): {r: number; g: number; b: number} | undefined {
-    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
-    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
-    hex = hex.replace(shorthandRegex, (m, r, g, b) => {
-      return r + r + g + g + b + b;
-    });
-
-    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
-    return result
-      ? {
-          // tslint:disable-next-line:ban
-          r: parseInt(result[1], 16),
-          // tslint:disable-next-line:ban
-          g: parseInt(result[2], 16),
-          // tslint:disable-next-line:ban
-          b: parseInt(result[3], 16),
-        }
-      : undefined;
-  }
 }
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer_test.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer_test.ts
index e0425aa96..7799fa261 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer_test.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/canvas_drawer_test.ts
@@ -15,64 +15,103 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
 import {CanvasDrawer} from './canvas_drawer';
 
 describe('CanvasDrawer', () => {
-  it('erases the canvas', async () => {
-    const actualCanvas = createCanvas(100, 100);
-    const expectedCanvas = createCanvas(100, 100);
-
-    const canvasDrawer = new CanvasDrawer();
+  let actualCanvas: HTMLCanvasElement;
+  let expectedCanvas: HTMLCanvasElement;
+  let canvasDrawer: CanvasDrawer;
+
+  const testRect = new Rect(10, 10, 10, 10);
+  const hexColor = '#333333';
+  const expectedRgbaColor = 'rgba(51,51,51,1)';
+  const expectedTransparentColor = 'rgba(51,51,51,0)';
+
+  beforeEach(() => {
+    actualCanvas = createCanvas(100, 100);
+    expectedCanvas = createCanvas(100, 100);
+    canvasDrawer = new CanvasDrawer();
     canvasDrawer.setCanvas(actualCanvas);
-    canvasDrawer.drawRect(new Rect(10, 10, 10, 10), '#333333', 1.0);
+  });
 
+  it('erases the canvas', async () => {
+    canvasDrawer.drawRect(testRect, hexColor, 1.0);
     expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeFalse();
 
     canvasDrawer.clear();
-
     expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
   });
 
   it('can draw opaque rect', () => {
-    const actualCanvas = createCanvas(100, 100);
-    const expectedCanvas = createCanvas(100, 100);
-
-    const canvasDrawer = new CanvasDrawer();
-    canvasDrawer.setCanvas(actualCanvas);
-    canvasDrawer.drawRect(new Rect(10, 10, 10, 10), '#333333', 1.0);
+    canvasDrawer.drawRect(testRect, hexColor, 1.0);
 
     const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
-    expectedCtx.fillStyle = '#333333';
-    expectedCtx.rect(10, 10, 10, 10);
+    expectedCtx.fillStyle = hexColor;
+    expectedCtx.rect(testRect.x, testRect.y, testRect.w, testRect.h);
     expectedCtx.fill();
 
     expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
   });
 
   it('can draw translucent rect', () => {
-    const actualCanvas = createCanvas(100, 100);
-    const expectedCanvas = createCanvas(100, 100);
-
-    const canvasDrawer = new CanvasDrawer();
-    canvasDrawer.setCanvas(actualCanvas);
-    canvasDrawer.drawRect(new Rect(10, 10, 10, 10), '#333333', 0.5);
+    canvasDrawer.drawRect(testRect, hexColor, 0.5);
 
     const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
     expectedCtx.fillStyle = 'rgba(51,51,51,0.5)';
-    expectedCtx.rect(10, 10, 10, 10);
+    expectedCtx.rect(testRect.x, testRect.y, testRect.w, testRect.h);
     expectedCtx.fill();
 
     expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
   });
 
-  it('can draw rect border', () => {
-    const actualCanvas = createCanvas(100, 100);
-    const expectedCanvas = createCanvas(100, 100);
+  it('can draw rect with start gradient and full ellipsis', () => {
+    const testGradientRect = new Rect(50, 10, 50, 10);
+    canvasDrawer.drawRect(testGradientRect, hexColor, 1, true, false);
 
-    const canvasDrawer = new CanvasDrawer();
-    canvasDrawer.setCanvas(actualCanvas);
-    canvasDrawer.drawRectBorder(new Rect(10, 10, 10, 10));
+    const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
+    fillGradient(expectedCtx, testGradientRect, 0.5, true, false);
+    addEllipsis(expectedCtx, testGradientRect, true);
+
+    expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
+  });
+
+  it('can draw rect with partial start ellipsis', () => {
+    canvasDrawer.drawRect(testRect, hexColor, 1, true, false);
+
+    const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
+    expectedCtx.fillStyle = hexColor;
+    expectedCtx.rect(testRect.x, testRect.y, testRect.w, testRect.h);
+    expectedCtx.fill();
+
+    addEllipsis(expectedCtx, testRect, true);
+
+    expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
+  });
+
+  it('can draw rect with end gradient and full ellipsis', () => {
+    const testGradientRect = new Rect(50, 10, 50, 10);
+    canvasDrawer.drawRect(testGradientRect, hexColor, 1, false, true);
+
+    const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
+    fillGradient(expectedCtx, testGradientRect, 0.5, false, true);
+    addEllipsis(expectedCtx, testGradientRect, false);
+
+    expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
+  });
+
+  it('can draw rect with partial end ellipsis', () => {
+    canvasDrawer.drawRect(testRect, hexColor, 1, false, true);
+
+    const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
+    fillGradient(expectedCtx, testRect, 1, false, true);
+    addEllipsis(expectedCtx, testRect, false);
+
+    expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
+  });
+
+  it('can draw rect border', () => {
+    canvasDrawer.drawRectBorder(testRect);
 
     const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
 
@@ -89,56 +128,114 @@ describe('CanvasDrawer', () => {
   });
 
   it('can draw rect outside bounds', () => {
-    const actualCanvas = createCanvas(100, 100);
-    const expectedCanvas = createCanvas(100, 100);
-
-    const canvasDrawer = new CanvasDrawer();
-    canvasDrawer.setCanvas(actualCanvas);
-    canvasDrawer.drawRect(new Rect(200, 200, 10, 10), '#333333', 1.0);
-    canvasDrawer.drawRect(new Rect(95, 95, 50, 50), '#333333', 1.0);
+    canvasDrawer.drawRect(new Rect(200, 200, 10, 10), hexColor, 1.0);
+    canvasDrawer.drawRect(new Rect(95, 95, 50, 50), hexColor, 1.0);
 
     const expectedCtx = assertDefined(expectedCanvas.getContext('2d'));
-    expectedCtx.fillStyle = '#333333';
+    expectedCtx.fillStyle = hexColor;
     expectedCtx.rect(95, 95, 5, 5);
     expectedCtx.fill();
 
     expect(pixelsAllMatch(actualCanvas, expectedCanvas)).toBeTrue();
   });
-});
 
-function createCanvas(width: number, height: number): HTMLCanvasElement {
-  const canvas = document.createElement('canvas') as HTMLCanvasElement;
-  canvas.width = width;
-  canvas.height = height;
-  return canvas;
-}
-
-function pixelsAllMatch(
-  canvasA: HTMLCanvasElement,
-  canvasB: HTMLCanvasElement,
-): boolean {
-  if (canvasA.width !== canvasB.width || canvasA.height !== canvasB.height) {
-    return false;
+  function createCanvas(width: number, height: number): HTMLCanvasElement {
+    const canvas = document.createElement('canvas') as HTMLCanvasElement;
+    canvas.width = width;
+    canvas.height = height;
+    return canvas;
   }
 
-  const imgA = assertDefined(canvasA.getContext('2d')).getImageData(
-    0,
-    0,
-    canvasA.width,
-    canvasA.height,
-  ).data;
-  const imgB = assertDefined(canvasB.getContext('2d')).getImageData(
-    0,
-    0,
-    canvasB.width,
-    canvasB.height,
-  ).data;
-
-  for (let i = 0; i < imgA.length; i++) {
-    if (imgA[i] !== imgB[i]) {
+  function pixelsAllMatch(
+    canvasA: HTMLCanvasElement,
+    canvasB: HTMLCanvasElement,
+  ): boolean {
+    if (canvasA.width !== canvasB.width || canvasA.height !== canvasB.height) {
       return false;
     }
+
+    const imgA = assertDefined(canvasA.getContext('2d')).getImageData(
+      0,
+      0,
+      canvasA.width,
+      canvasA.height,
+    ).data;
+    const imgB = assertDefined(canvasB.getContext('2d')).getImageData(
+      0,
+      0,
+      canvasB.width,
+      canvasB.height,
+    ).data;
+
+    for (let i = 0; i < imgA.length; i++) {
+      if (imgA[i] !== imgB[i]) {
+        return false;
+      }
+    }
+
+    return true;
+  }
+
+  function fillGradient(
+    ctx: CanvasRenderingContext2D,
+    testGradientRect: Rect,
+    gradientRatio: number,
+    startGradient: boolean,
+    endGradient: boolean,
+  ) {
+    const gradient = ctx.createLinearGradient(
+      testGradientRect.x,
+      0,
+      testGradientRect.x + testGradientRect.w,
+      0,
+    );
+    gradient.addColorStop(
+      0,
+      startGradient ? expectedTransparentColor : expectedRgbaColor,
+    );
+    gradient.addColorStop(
+      1,
+      endGradient ? expectedTransparentColor : expectedRgbaColor,
+    );
+    gradient.addColorStop(gradientRatio, expectedRgbaColor);
+    gradient.addColorStop(1 - gradientRatio, expectedRgbaColor);
+    ctx.fillStyle = gradient;
+    ctx.rect(
+      testGradientRect.x,
+      testGradientRect.y,
+      testGradientRect.w,
+      testGradientRect.h,
+    );
+    ctx.fill();
   }
 
-  return true;
-}
+  function addEllipsis(
+    ctx: CanvasRenderingContext2D,
+    testGradientRect: Rect,
+    forwards: boolean,
+  ) {
+    ctx.fillStyle = 'black';
+    const centerY = testGradientRect.y + testGradientRect.h / 2;
+    const xLim = forwards
+      ? testGradientRect.x + testGradientRect.w
+      : testGradientRect.x;
+    let centerX = forwards
+      ? testGradientRect.x + 5
+      : testGradientRect.x + testGradientRect.w - 5;
+    let i = 0;
+    const radius = 2;
+    while (i < 3) {
+      if (forwards && centerX + radius >= xLim) {
+        break;
+      }
+      if (!forwards && centerX + radius <= xLim) {
+        break;
+      }
+      ctx.beginPath();
+      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
+      ctx.fill();
+      centerX = forwards ? centerX + 7 : centerX - 7;
+      i++;
+    }
+  }
+});
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component.ts
index f17f6383d..f68dda0d1 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component.ts
@@ -16,8 +16,8 @@
 
 import {Component, Input} from '@angular/core';
 import {assertDefined} from 'common/assert_utils';
-import {Point} from 'common/geometry_types';
-import {Rect} from 'common/rect';
+import {Point} from 'common/geometry/point';
+import {Rect} from 'common/geometry/rect';
 import {Timestamp} from 'common/time';
 import {Trace, TraceEntry} from 'trace/trace';
 import {AbstractTimelineRowComponent} from './abstract_timeline_row_component';
@@ -167,7 +167,6 @@ export class DefaultTimelineRowComponent extends AbstractTimelineRowComponent<{}
 
   private drawEntry(entry: Timestamp) {
     const rect = this.entryRect(entry);
-
     this.canvasDrawer.drawRect(rect, this.color, 0.2);
   }
 
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component_test.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component_test.ts
index e32f11ea4..411f040e2 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/default_timeline_row_component_test.ts
@@ -15,7 +15,6 @@
  */
 
 import {DragDropModule} from '@angular/cdk/drag-drop';
-import {ChangeDetectionStrategy} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
 import {FormsModule, ReactiveFormsModule} from '@angular/forms';
 import {MatButtonModule} from '@angular/material/button';
@@ -26,7 +25,7 @@ import {MatSelectModule} from '@angular/material/select';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
 import {TimeRange} from 'common/time';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
@@ -37,6 +36,7 @@ import {DefaultTimelineRowComponent} from './default_timeline_row_component';
 describe('DefaultTimelineRowComponent', () => {
   let fixture: ComponentFixture<DefaultTimelineRowComponent>;
   let component: DefaultTimelineRowComponent;
+  let htmlElement: HTMLElement;
 
   beforeEach(async () => {
     await TestBed.configureTestingModule({
@@ -53,13 +53,10 @@ describe('DefaultTimelineRowComponent', () => {
         DragDropModule,
       ],
       declarations: [DefaultTimelineRowComponent],
-    })
-      .overrideComponent(DefaultTimelineRowComponent, {
-        set: {changeDetection: ChangeDetectionStrategy.Default},
-      })
-      .compileComponents();
+    }).compileComponents();
     fixture = TestBed.createComponent(DefaultTimelineRowComponent);
     component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
   });
 
   it('can be created', () => {
@@ -150,12 +147,12 @@ describe('DefaultTimelineRowComponent', () => {
       waitToBeCalled(drawRectSpy, 1),
     ];
 
-    component.handleMouseMove({
-      offsetX: 5,
-      offsetY: component.canvasDrawer.getScaledCanvasHeight() / 2,
-      preventDefault: () => {},
-      stopPropagation: () => {},
-    } as MouseEvent);
+    const event = new MouseEvent('mousemove');
+    spyOnProperty(event, 'offsetX').and.returnValue(5);
+    spyOnProperty(event, 'offsetY').and.returnValue(
+      component.canvasDrawer.getScaledCanvasHeight() / 2,
+    );
+    component.getCanvas().dispatchEvent(event);
 
     fixture.detectChanges();
     await fixture.whenRenderingDone();
@@ -237,14 +234,14 @@ describe('DefaultTimelineRowComponent', () => {
     await drawCorrectEntryOnClick(entryPos, 70n, 3);
   });
 
-  //TODO(b/304982982): test via dom interactions, not calling listener directly
   it('emits scroll event', async () => {
     setTraceAndSelectionRange(10n, 110n);
     fixture.detectChanges();
     await fixture.whenRenderingDone();
 
     const spy = spyOn(component.onScrollEvent, 'emit');
-    component.updateScroll(new WheelEvent('scroll'));
+    htmlElement.dispatchEvent(new WheelEvent('wheel'));
+    fixture.detectChanges();
     expect(spy).toHaveBeenCalled();
   });
 
@@ -294,26 +291,20 @@ describe('DefaultTimelineRowComponent', () => {
     expectedTimestampNs: bigint,
     rectSpyCalls: number,
   ) {
-    const drawRectSpy = spyOn(
-      component.canvasDrawer,
-      'drawRect',
-    ).and.callThrough();
-    const drawRectBorderSpy = spyOn(
-      component.canvasDrawer,
-      'drawRectBorder',
-    ).and.callThrough();
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    const drawRectBorderSpy = spyOn(component.canvasDrawer, 'drawRectBorder');
 
     const waitPromises = [
       waitToBeCalled(drawRectSpy, rectSpyCalls),
       waitToBeCalled(drawRectBorderSpy, 1),
     ];
 
-    await component.handleMouseDown({
-      offsetX: xPos + 1,
-      offsetY: component.canvasDrawer.getScaledCanvasHeight() / 2,
-      preventDefault: () => {},
-      stopPropagation: () => {},
-    } as MouseEvent);
+    const event = new MouseEvent('mousedown');
+    spyOnProperty(event, 'offsetX').and.returnValue(xPos + 1);
+    spyOnProperty(event, 'offsetY').and.returnValue(
+      component.canvasDrawer.getScaledCanvasHeight() / 2,
+    );
+    component.getCanvas().dispatchEvent(event);
 
     fixture.detectChanges();
     await fixture.whenRenderingDone();
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component.ts
index 73b04fe45..5af80d1a6 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component.ts
@@ -52,9 +52,10 @@ import {TransitionTimelineComponent} from './transition_timeline_component';
             *ngIf="trace.type === TraceType.TRANSITION"
             [color]="TRACE_INFO[trace.type].color"
             [trace]="trace"
-            [traceEntries]="timelineData.getTransitions()"
+            [transitionEntries]="timelineData.getTransitionEntries()"
             [selectedEntry]="timelineData.findCurrentEntryFor(trace)"
             [selectionRange]="timelineData.getSelectionTimeRange()"
+            [fullRange]="timelineData.getFullTimeRange()"
             [timestampConverter]="timelineData.getTimestampConverter()"
             [isActive]="isActiveTrace(trace)"
             (onTracePositionUpdate)="onTracePositionUpdate.emit($event)"
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component_test.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component_test.ts
index c71ba8ef1..bc8aff450 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/expanded_timeline_component_test.ts
@@ -118,7 +118,7 @@ describe('ExpandedTimelineComponent', () => {
           .build(),
       ])
       .setTimestamps(TraceType.TRANSITION, [time10, time60])
-      .setTimestamps(TraceType.PROTO_LOG, [])
+      .setTimestamps(TraceType.PROTO_LOG, [time12])
       .build();
     await timelineData.initialize(
       traces,
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component.ts
index 158f2bf94..39cf0aa66 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component.ts
@@ -16,11 +16,11 @@
 
 import {Component, Input} from '@angular/core';
 import {TimelineUtils} from 'app/components/timeline/timeline_utils';
-import {assertDefined} from 'common/assert_utils';
-import {Point} from 'common/geometry_types';
-import {Rect} from 'common/rect';
-import {Timestamp} from 'common/time';
-import {Trace, TraceEntry} from 'trace/trace';
+import {assertDefined, assertTrue} from 'common/assert_utils';
+import {Point} from 'common/geometry/point';
+import {Rect} from 'common/geometry/rect';
+import {TimeRange, Timestamp} from 'common/time';
+import {AbsoluteEntryIndex, Trace, TraceEntry} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {AbstractTimelineRowComponent} from './abstract_timeline_row_component';
@@ -30,7 +30,7 @@ import {AbstractTimelineRowComponent} from './abstract_timeline_row_component';
   template: `
     <div
       class="transition-timeline"
-      matTooltip="Some or all transitions will not be rendered in timeline due to unknown dispatch time"
+      matTooltip="Some or all transitions will not be rendered in timeline due to unknown dispatch and finish or abort time"
       [matTooltipDisabled]="shouldNotRenderEntries.length === 0"
       [style.background-color]="getBackgroundColor()"
       (click)="onTimelineClick($event)"
@@ -56,7 +56,8 @@ import {AbstractTimelineRowComponent} from './abstract_timeline_row_component';
 export class TransitionTimelineComponent extends AbstractTimelineRowComponent<PropertyTreeNode> {
   @Input() selectedEntry: TraceEntry<PropertyTreeNode> | undefined;
   @Input() trace: Trace<PropertyTreeNode> | undefined;
-  @Input() traceEntries: PropertyTreeNode[] | undefined;
+  @Input() transitionEntries: Array<PropertyTreeNode | undefined> | undefined;
+  @Input() fullRange: TimeRange | undefined;
 
   hoveringEntry?: TraceEntry<PropertyTreeNode>;
   rowsToUse = new Map<number, number>();
@@ -65,9 +66,11 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
 
   ngOnInit() {
     assertDefined(this.trace);
+    assertTrue(this.trace?.type === TraceType.TRANSITION);
     assertDefined(this.selectionRange);
-    assertDefined(this.traceEntries);
-    this.processTraceEntries();
+    assertDefined(this.transitionEntries);
+    assertDefined(this.fullRange);
+    this.computeRowsToUse();
   }
 
   getAvailableWidth() {
@@ -87,58 +90,58 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
   }
 
   override drawTimeline() {
-    (this.trace as Trace<PropertyTreeNode>).mapEntry((entry) => {
-      const transition = this.traceEntries?.at(entry.getIndex());
-      if (!transition) {
+    let selectedRect: Rect | undefined;
+    assertDefined(this.trace).forEachEntry((entry) => {
+      const index = entry.getIndex();
+      const rect = this.getRectFromIndex(entry.getIndex());
+      if (!rect) {
         return;
       }
-      const timeRange = TimelineUtils.getTimeRangeForTransition(
-        transition,
-        assertDefined(this.selectionRange),
-        assertDefined(this.timestampConverter),
-      );
-      if (!timeRange) {
-        return;
+      const transition = assertDefined(this.transitionEntries?.at(index));
+      this.drawSegment(rect, transition);
+      if (index === this.selectedEntry?.getIndex()) {
+        selectedRect = rect;
       }
-      const rowToUse = this.getRowToUseFor(entry);
-      const aborted = assertDefined(
-        transition.getChildByName('aborted'),
-      ).getValue();
-      this.drawSegment(timeRange.from, timeRange.to, rowToUse, aborted);
     });
-    this.drawSelectedTransitionEntry();
+    if (selectedRect) {
+      this.canvasDrawer.drawRectBorder(selectedRect);
+    }
   }
 
-  protected override getEntryAt(
-    mousePoint: Point,
-  ): TraceEntry<PropertyTreeNode> | undefined {
-    if (assertDefined(this.trace).type !== TraceType.TRANSITION) {
+  private getRectFromIndex(entryIndex: AbsoluteEntryIndex): Rect | undefined {
+    if (this.shouldNotRenderEntries.includes(entryIndex)) {
+      return undefined;
+    }
+    const transition = this.transitionEntries?.at(entryIndex);
+    if (!transition) {
+      return undefined;
+    }
+    const timeRange = TimelineUtils.getTimeRangeForTransition(
+      transition,
+      assertDefined(this.selectionRange),
+      assertDefined(this.timestampConverter),
+    );
+    if (!timeRange) {
       return undefined;
     }
+    const row = this.getRowToUseFor(entryIndex);
+    return this.getSegmentRect(timeRange.from, timeRange.to, row);
+  }
 
-    const transitions = assertDefined(this.trace).mapEntry((entry) => {
-      const transition = this.traceEntries?.at(entry.getIndex());
-      if (!transition) {
-        return;
-      }
-      const timeRange = TimelineUtils.getTimeRangeForTransition(
-        transition,
-        assertDefined(this.selectionRange),
-        assertDefined(this.timestampConverter),
-      );
+  protected override getEntryAt(
+    mousePoint: Point,
+  ): TraceEntry<PropertyTreeNode> | undefined {
+    const transitionEntries = assertDefined(this.trace).mapEntry(
+      (entry) => entry,
+    );
 
-      if (!timeRange) {
-        return undefined;
-      }
-      const rowToUse = this.getRowToUseFor(entry);
-      const rect = this.getSegmentRect(timeRange.from, timeRange.to, rowToUse);
-      if (rect.containsPoint(mousePoint)) {
+    for (const entry of transitionEntries) {
+      const rect = this.getRectFromIndex(entry.getIndex());
+      if (rect?.containsPoint(mousePoint)) {
         return entry;
       }
-      return undefined;
-    });
-
-    return transitions.find((entry) => entry !== undefined);
+    }
+    return undefined;
   }
 
   private drawSegmentHover(mousePoint: Point) {
@@ -154,23 +157,10 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
       return;
     }
 
-    const transition = this.traceEntries?.at(this.hoveringEntry.getIndex());
-    if (!transition) {
-      return;
+    const rect = this.getRectFromIndex(this.hoveringEntry.getIndex());
+    if (rect) {
+      this.canvasDrawer.drawRectBorder(rect);
     }
-    const timeRange = TimelineUtils.getTimeRangeForTransition(
-      transition,
-      assertDefined(this.selectionRange),
-      assertDefined(this.timestampConverter),
-    );
-
-    if (!timeRange) {
-      return;
-    }
-
-    const rowToUse = this.getRowToUseFor(this.hoveringEntry);
-    const rect = this.getSegmentRect(timeRange.from, timeRange.to, rowToUse);
-    this.canvasDrawer.drawRectBorder(rect);
   }
 
   private getXPosOf(entry: Timestamp): number {
@@ -192,12 +182,6 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
     const selectionStart = assertDefined(this.selectionRange).from.getValueNs();
     const selectionEnd = assertDefined(this.selectionRange).to.getValueNs();
 
-    const width = Number(
-      (BigInt(this.getAvailableWidth()) *
-        (end.getValueNs() - start.getValueNs())) /
-        (selectionEnd - selectionStart),
-    );
-
     const borderPadding = 5;
     let totalRowHeight =
       (this.canvasDrawer.getScaledCanvasHeight() - 2 * borderPadding) /
@@ -212,6 +196,15 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
     const padding = 5;
     const rowHeight = totalRowHeight - padding;
 
+    const width = Math.max(
+      Number(
+        (BigInt(this.getAvailableWidth()) *
+          (end.getValueNs() - start.getValueNs())) /
+          (selectionEnd - selectionStart),
+      ),
+      rowHeight,
+    );
+
     return new Rect(
       xPosStart,
       borderPadding + rowToUse * totalRowHeight,
@@ -220,82 +213,58 @@ export class TransitionTimelineComponent extends AbstractTimelineRowComponent<Pr
     );
   }
 
-  private drawSegment(
-    start: Timestamp,
-    end: Timestamp,
-    rowToUse: number,
-    aborted: boolean,
-  ) {
-    const rect = this.getSegmentRect(start, end, rowToUse);
+  private drawSegment(rect: Rect, transition: PropertyTreeNode) {
+    const aborted = assertDefined(
+      transition.getChildByName('aborted'),
+    ).getValue();
     const alpha = aborted ? 0.25 : 1.0;
-    this.canvasDrawer.drawRect(rect, this.color, alpha);
-  }
 
-  private drawSelectedTransitionEntry() {
-    if (this.selectedEntry === undefined) {
-      return;
-    }
-
-    const transition = this.traceEntries?.at(this.selectedEntry.getIndex());
-    if (!transition) {
-      return;
-    }
-    const timeRange = TimelineUtils.getTimeRangeForTransition(
-      transition,
-      assertDefined(this.selectionRange),
-      assertDefined(this.timestampConverter),
+    const hasUnknownStart =
+      TimelineUtils.isTransitionWithUnknownStart(transition);
+    const hasUnknownEnd = TimelineUtils.isTransitionWithUnknownEnd(transition);
+    this.canvasDrawer.drawRect(
+      rect,
+      this.color,
+      alpha,
+      hasUnknownStart,
+      hasUnknownEnd,
     );
-    if (!timeRange) {
-      return;
-    }
-
-    const rowIndex = this.getRowToUseFor(this.selectedEntry);
-    const rect = this.getSegmentRect(timeRange.from, timeRange.to, rowIndex);
-    const alpha = transition.getChildByName('aborted') ? 0.25 : 1.0;
-    this.canvasDrawer.drawRect(rect, this.color, alpha);
-    this.canvasDrawer.drawRectBorder(rect);
   }
 
-  private getRowToUseFor(entry: TraceEntry<PropertyTreeNode>): number {
-    const rowToUse = this.rowsToUse.get(entry.getIndex());
+  private getRowToUseFor(entryIndex: AbsoluteEntryIndex): number {
+    const rowToUse = this.rowsToUse.get(entryIndex);
     if (rowToUse === undefined) {
-      console.error('Failed to find', entry, 'in', this.rowsToUse);
-      throw new Error('Could not find entry in rowsToUse');
+      throw new Error(`Could not find entry ${entryIndex} in rowsToUse`);
     }
     return rowToUse;
   }
 
-  private processTraceEntries(): void {
+  private computeRowsToUse(): void {
     const rowAvailableFrom: Array<bigint | undefined> = [];
-    assertDefined(this.trace).mapEntry((entry) => {
+    assertDefined(this.trace).forEachEntry((entry) => {
       const index = entry.getIndex();
-      const transition = this.traceEntries?.at(entry.getIndex());
+      const transition = this.transitionEntries?.at(entry.getIndex());
       if (!transition) {
         return;
       }
 
       const timeRange = TimelineUtils.getTimeRangeForTransition(
         transition,
-        assertDefined(this.selectionRange),
+        assertDefined(this.fullRange),
         assertDefined(this.timestampConverter),
       );
 
-      if (!timeRange) {
+      if (timeRange === undefined) {
         this.shouldNotRenderEntries.push(index);
+        return;
       }
 
       let rowToUse = 0;
-      while (
-        (rowAvailableFrom[rowToUse] ?? 0n) >
-        (timeRange?.from.getValueNs() ??
-          assertDefined(this.selectionRange).from.getValueNs())
-      ) {
+      while ((rowAvailableFrom[rowToUse] ?? 0n) > timeRange.from.getValueNs()) {
         rowToUse++;
       }
 
-      rowAvailableFrom[rowToUse] =
-        timeRange?.to.getValueNs() ??
-        assertDefined(this.selectionRange).to.getValueNs();
+      rowAvailableFrom[rowToUse] = timeRange.to.getValueNs();
 
       if (rowToUse + 1 > this.maxRowsRequires) {
         this.maxRowsRequires = rowToUse + 1;
diff --git a/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component_test.ts b/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component_test.ts
index b295ede96..d68ecf2f5 100644
--- a/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/expanded-timeline/transition_timeline_component_test.ts
@@ -26,8 +26,8 @@ import {MatSelectModule} from '@angular/material/select';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
-import {TimeRange} from 'common/time';
+import {Rect} from 'common/geometry/rect';
+import {TimeRange, Timestamp} from 'common/time';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
@@ -39,8 +39,10 @@ import {TransitionTimelineComponent} from './transition_timeline_component';
 describe('TransitionTimelineComponent', () => {
   let fixture: ComponentFixture<TransitionTimelineComponent>;
   let component: TransitionTimelineComponent;
+  let htmlElement: HTMLElement;
 
   const time0 = TimestampConverterUtils.makeRealTimestamp(0n);
+  const time5 = TimestampConverterUtils.makeRealTimestamp(5n);
   const time10 = TimestampConverterUtils.makeRealTimestamp(10n);
   const time20 = TimestampConverterUtils.makeRealTimestamp(20n);
   const time30 = TimestampConverterUtils.makeRealTimestamp(30n);
@@ -48,8 +50,12 @@ describe('TransitionTimelineComponent', () => {
   const time60 = TimestampConverterUtils.makeRealTimestamp(60n);
   const time85 = TimestampConverterUtils.makeRealTimestamp(85n);
   const time110 = TimestampConverterUtils.makeRealTimestamp(110n);
+  const time120 = TimestampConverterUtils.makeRealTimestamp(120n);
   const time160 = TimestampConverterUtils.makeRealTimestamp(160n);
 
+  const range10to110 = new TimeRange(time10, time110);
+  const range0to160 = new TimeRange(time0, time160);
+
   beforeEach(async () => {
     await TestBed.configureTestingModule({
       imports: [
@@ -72,7 +78,9 @@ describe('TransitionTimelineComponent', () => {
       .compileComponents();
     fixture = TestBed.createComponent(TransitionTimelineComponent);
     component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
     component.timestampConverter = TimestampConverterUtils.TIMESTAMP_CONVERTER;
+    component.fullRange = range0to160;
   });
 
   it('can be created', () => {
@@ -80,56 +88,13 @@ describe('TransitionTimelineComponent', () => {
   });
 
   it('can draw non-overlapping transitions', async () => {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time30}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time10}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time110}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time60}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-    ];
-    component.trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([
-        TimestampConverterUtils.makeRealTimestamp(10n),
-        TimestampConverterUtils.makeRealTimestamp(60n),
-      ])
-      .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
-
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
 
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    const transitions = [
+      makeTransition(time10, time30),
+      makeTransition(time60, time110),
+    ];
+    await setTraceAndSelectionRange(transitions, [time10, time60]);
 
     const padding = 5;
     const oneRowTotalHeight = 30;
@@ -141,6 +106,8 @@ describe('TransitionTimelineComponent', () => {
       new Rect(0, padding, Math.floor(width / 5), oneRowHeight),
       component.color,
       1,
+      false,
+      false,
     );
     expect(drawRectSpy).toHaveBeenCalledWith(
       new Rect(
@@ -151,191 +118,140 @@ describe('TransitionTimelineComponent', () => {
       ),
       component.color,
       1,
+      false,
+      false,
     );
   });
 
   it('can draw transitions zoomed in', async () => {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time20}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time0}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time160}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time60}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-    ];
-    component.trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([time10, time60])
-      .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
-
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
 
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    const transitions = [
+      makeTransition(time10, time20), // drawn
+      makeTransition(time60, time160), // drawn
+      makeTransition(time120, time160), // not drawn - starts after selection range
+      makeTransition(time0, time5), // not drawn - finishes before selection range
+      makeTransition(time5, undefined), // not drawn - starts before selection range with unknown finish time
+    ];
+    await setTraceAndSelectionRange(transitions, [
+      time10,
+      time60,
+      time120,
+      time0,
+      time5,
+    ]);
 
     const padding = 5;
-    const oneRowTotalHeight = 30;
+    const oneRowTotalHeight =
+      (component.canvasDrawer.getScaledCanvasHeight() - 2 * padding) / 3;
     const oneRowHeight = oneRowTotalHeight - padding;
     const width = component.canvasDrawer.getScaledCanvasWidth();
 
-    expect(drawRectSpy).toHaveBeenCalledTimes(2);
+    expect(drawRectSpy).toHaveBeenCalledTimes(2); // does not draw final transition
     expect(drawRectSpy).toHaveBeenCalledWith(
       new Rect(0, padding, Math.floor(width / 10), oneRowHeight),
       component.color,
       1,
+      false,
+      false,
     );
     expect(drawRectSpy).toHaveBeenCalledWith(
       new Rect(Math.floor(width / 2), padding, Math.floor(width), oneRowHeight),
       component.color,
       1,
+      false,
+      false,
     );
   });
 
   it('can draw selected entry', async () => {
-    setDefaultTraceAndSelectionRange();
-    component.selectedEntry = assertDefined(component.trace).getEntry(0);
-
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
     const drawRectBorderSpy = spyOn(component.canvasDrawer, 'drawRectBorder');
     const waitPromises = [
       waitToBeCalled(drawRectSpy, 1),
       waitToBeCalled(drawRectBorderSpy, 1),
     ];
-
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    await setDefaultTraceAndSelectionRange(true);
     await Promise.all(waitPromises);
 
-    const padding = 5;
-    const oneRowTotalHeight = 30;
-    const oneRowHeight = oneRowTotalHeight - padding;
-    const width = component.canvasDrawer.getScaledCanvasWidth();
-    const expectedRect = new Rect(
-      Math.floor((width * 1) / 4),
-      padding,
-      Math.floor(width / 2),
-      oneRowHeight,
+    const expectedRect = getExpectedBorderedRect();
+    expect(drawRectSpy).toHaveBeenCalledOnceWith(
+      expectedRect,
+      component.color,
+      1,
+      false,
+      false,
     );
-    expect(drawRectSpy).toHaveBeenCalledTimes(2); // once drawn as a normal entry another time with rect border
-    expect(drawRectSpy).toHaveBeenCalledWith(expectedRect, component.color, 1);
     expect(drawRectBorderSpy).toHaveBeenCalledTimes(1);
     expect(drawRectBorderSpy).toHaveBeenCalledWith(expectedRect);
   });
 
   it('can draw hovering entry', async () => {
-    setDefaultTraceAndSelectionRange();
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    await setDefaultTraceAndSelectionRange();
+    const expectedRect = getExpectedBorderedRect();
 
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
-
-    const padding = 5;
-    const oneRowTotalHeight = 30;
-    const oneRowHeight = oneRowTotalHeight - padding;
-    const width = component.canvasDrawer.getScaledCanvasWidth();
-    const expectedRect = new Rect(
-      Math.floor((width * 1) / 4),
-      padding,
-      Math.floor(width / 2),
-      oneRowHeight,
+    expect(drawRectSpy).toHaveBeenCalledOnceWith(
+      expectedRect,
+      component.color,
+      1,
+      false,
+      false,
     );
 
-    expect(drawRectSpy).toHaveBeenCalledTimes(1);
-    expect(drawRectSpy).toHaveBeenCalledWith(expectedRect, component.color, 1);
-
     const drawRectBorderSpy = spyOn(
       component.canvasDrawer,
       'drawRectBorder',
     ).and.callThrough();
 
-    component.handleMouseMove({
-      offsetX: Math.floor(width / 2),
-      offsetY: oneRowTotalHeight / 2,
-      preventDefault: () => {},
-      stopPropagation: () => {},
-    } as MouseEvent);
-    await fixture.whenRenderingDone();
+    await dispatchMousemoveEvent();
+    expect(drawRectBorderSpy).toHaveBeenCalledOnceWith(expectedRect);
 
-    expect(drawRectBorderSpy).toHaveBeenCalledTimes(1);
-    expect(drawRectBorderSpy).toHaveBeenCalledWith(expectedRect);
-  });
+    drawRectSpy.calls.reset();
+    drawRectBorderSpy.calls.reset();
 
-  it('can draw overlapping transitions (default)', async () => {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time85}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time10}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time110}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time60}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-    ];
-    component.trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([time10, time60])
-      .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
+    await dispatchMousemoveEvent();
+    expect(drawRectSpy).toHaveBeenCalledOnceWith(
+      expectedRect,
+      component.color,
+      1,
+      false,
+      false,
+    );
+    expect(drawRectBorderSpy).toHaveBeenCalledOnceWith(expectedRect);
+  });
 
+  it('redraws timeline to clear hover entry after mouse out', async () => {
+    await setDefaultTraceAndSelectionRange();
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
 
+    const mouseoutEvent = new MouseEvent('mouseout');
+    component.getCanvas().dispatchEvent(mouseoutEvent);
     fixture.detectChanges();
     await fixture.whenRenderingDone();
+    expect(drawRectSpy).not.toHaveBeenCalled();
+
+    await dispatchMousemoveEvent();
+    component.getCanvas().dispatchEvent(mouseoutEvent);
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+
+    expect(drawRectSpy).toHaveBeenCalledOnceWith(
+      getExpectedBorderedRect(),
+      component.color,
+      1,
+      false,
+      false,
+    );
+  });
+
+  it('can draw overlapping transitions (default)', async () => {
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    const transitions = [
+      makeTransition(time10, time85),
+      makeTransition(time60, time110),
+    ];
+    await setTraceAndSelectionRange(transitions, [time10, time60]);
 
     const padding = 5;
     const rows = 2;
@@ -349,6 +265,8 @@ describe('TransitionTimelineComponent', () => {
       new Rect(0, padding, Math.floor((width * 3) / 4), oneRowHeight),
       component.color,
       1,
+      false,
+      false,
     );
     expect(drawRectSpy).toHaveBeenCalledWith(
       new Rect(
@@ -359,56 +277,18 @@ describe('TransitionTimelineComponent', () => {
       ),
       component.color,
       1,
+      false,
+      false,
     );
   });
 
   it('can draw overlapping transitions (contained)', async () => {
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
     const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time85}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time10}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time60}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time35}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
+      makeTransition(time10, time85),
+      makeTransition(time35, time60),
     ];
-    component.trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([time10, time35])
-      .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
-
-    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
-
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    await setTraceAndSelectionRange(transitions, [time10, time35]);
 
     const padding = 5;
     const rows = 2;
@@ -422,6 +302,8 @@ describe('TransitionTimelineComponent', () => {
       new Rect(0, padding, Math.floor((width * 3) / 4), oneRowHeight),
       component.color,
       1,
+      false,
+      false,
     );
     expect(drawRectSpy).toHaveBeenCalledWith(
       new Rect(
@@ -432,43 +314,15 @@ describe('TransitionTimelineComponent', () => {
       ),
       component.color,
       1,
+      false,
+      false,
     );
   });
 
   it('can draw aborted transitions', async () => {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            value: null,
-          },
-          {
-            name: 'shellData',
-            children: [
-              {name: 'dispatchTimeNs', value: time35},
-              {name: 'abortTimeNs', value: time85},
-            ],
-          },
-          {name: 'aborted', value: true},
-        ])
-        .build(),
-    ];
-    component.trace = new TraceBuilder<PropertyTreeNode>()
-      .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([time35])
-      .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
-
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
-
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    const transitions = [makeTransition(time35, undefined, time85)];
+    await setTraceAndSelectionRange(transitions, [time35]);
 
     const padding = 5;
     const oneRowTotalHeight = 30;
@@ -485,58 +339,97 @@ describe('TransitionTimelineComponent', () => {
       ),
       component.color,
       0.25,
+      false,
+      false,
+    );
+  });
+
+  it('can draw transition with unknown start time', async () => {
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    const transitions = [makeTransition(undefined, time85)];
+    await setTraceAndSelectionRange(transitions, [time0]);
+
+    const padding = 5;
+    const oneRowTotalHeight = 30;
+    const oneRowHeight = oneRowTotalHeight - padding;
+
+    expect(drawRectSpy).toHaveBeenCalledTimes(1);
+    expect(drawRectSpy).toHaveBeenCalledWith(
+      new Rect(
+        Math.floor((component.canvasDrawer.getScaledCanvasWidth() * 74) / 100),
+        padding,
+        oneRowHeight,
+        oneRowHeight,
+      ),
+      component.color,
+      1,
+      true,
+      false,
+    );
+  });
+
+  it('can draw transition with unknown end time', async () => {
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    const transitions = [makeTransition(time35, undefined)];
+    await setTraceAndSelectionRange(transitions, [time35]);
+
+    const padding = 5;
+    const oneRowTotalHeight = 30;
+    const oneRowHeight = oneRowTotalHeight - padding;
+
+    expect(drawRectSpy).toHaveBeenCalledTimes(1);
+    expect(drawRectSpy).toHaveBeenCalledWith(
+      new Rect(
+        Math.floor((component.canvasDrawer.getScaledCanvasWidth() * 1) / 4),
+        padding,
+        oneRowHeight,
+        oneRowHeight,
+      ),
+      component.color,
+      1,
+      false,
+      true,
     );
   });
 
   it('does not render transition with create time but no dispatch time', async () => {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [
-              {name: 'createTimeNs', value: time10},
-              {name: 'finishTimeNs', value: time85},
-            ],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-    ];
+    const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
+    const transitions = [makeTransition(undefined, time85, undefined, time10)];
+    await setTraceAndSelectionRange(transitions, [time10]);
+    expect(drawRectSpy).not.toHaveBeenCalled();
+  });
+
+  it('handles missing trace entries', async () => {
+    const transition0 = makeTransition(time10, time30);
+    const transition1 = makeTransition(time60, time110);
+
     component.trace = new TraceBuilder<PropertyTreeNode>()
       .setType(TraceType.TRANSITION)
-      .setEntries(transitions)
-      .setTimestamps([time10])
+      .setEntries([transition0, transition1])
+      .setTimestamps([time10, time20])
       .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(time10, time110);
+    component.transitionEntries = [transition0, undefined];
+    component.selectionRange = range10to110;
+
     const drawRectSpy = spyOn(component.canvasDrawer, 'drawRect');
 
     fixture.detectChanges();
     await fixture.whenRenderingDone();
 
-    expect(drawRectSpy).not.toHaveBeenCalled();
+    expect(drawRectSpy).toHaveBeenCalledTimes(1);
   });
 
-  //TODO(b/304982982): test via dom interactions, not calling listener directly
   it('emits scroll event', async () => {
-    setDefaultTraceAndSelectionRange();
-
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    await setDefaultTraceAndSelectionRange();
 
     const spy = spyOn(component.onScrollEvent, 'emit');
-    component.updateScroll(new WheelEvent('scroll'));
+    htmlElement.dispatchEvent(new WheelEvent('wheel'));
+    fixture.detectChanges();
     expect(spy).toHaveBeenCalled();
   });
 
   it('tracks mouse position', async () => {
-    setDefaultTraceAndSelectionRange();
-    fixture.detectChanges();
-    await fixture.whenRenderingDone();
+    await setDefaultTraceAndSelectionRange();
 
     const spy = spyOn(component.onMouseXRatioUpdate, 'emit');
     const canvas = assertDefined(component.canvasRef).nativeElement;
@@ -555,34 +448,97 @@ describe('TransitionTimelineComponent', () => {
     expect(spy).toHaveBeenCalledWith(undefined);
   });
 
-  function setDefaultTraceAndSelectionRange() {
-    const transitions = [
-      new PropertyTreeBuilder()
-        .setIsRoot(true)
-        .setRootId('TransitionsTraceEntry')
-        .setName('transition')
-        .setChildren([
-          {
-            name: 'wmData',
-            children: [{name: 'finishTimeNs', value: time85}],
-          },
-          {
-            name: 'shellData',
-            children: [{name: 'dispatchTimeNs', value: time35}],
-          },
-          {name: 'aborted', value: false},
-        ])
-        .build(),
-    ];
+  async function setDefaultTraceAndSelectionRange(setSelectedEntry = false) {
+    const transitions = [makeTransition(time35, time85)];
     component.trace = new TraceBuilder<PropertyTreeNode>()
       .setType(TraceType.TRANSITION)
       .setEntries(transitions)
       .setTimestamps([time35])
       .build();
-    component.traceEntries = transitions;
-    component.selectionRange = new TimeRange(
-      TimestampConverterUtils.makeRealTimestamp(10n),
-      TimestampConverterUtils.makeRealTimestamp(110n),
+    component.transitionEntries = transitions;
+    component.selectionRange = range10to110;
+    if (setSelectedEntry) component.selectedEntry = component.trace.getEntry(0);
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+  }
+
+  function makeTransition(
+    dispatchTime: Timestamp | undefined,
+    finishTime: Timestamp | undefined,
+    abortTime?: Timestamp,
+    createTime?: Timestamp,
+  ): PropertyTreeNode {
+    const shellDataChildren = [];
+    if (dispatchTime !== undefined) {
+      shellDataChildren.push({name: 'dispatchTimeNs', value: dispatchTime});
+    }
+    if (dispatchTime !== undefined) {
+      shellDataChildren.push({name: 'abortTimeNs', value: abortTime});
+    }
+
+    const wmDataChildren = [];
+    if (finishTime !== undefined) {
+      wmDataChildren.push({name: 'finishTimeNs', value: finishTime});
+    }
+    if (createTime !== undefined) {
+      wmDataChildren.push({name: 'createTimeNs', value: createTime});
+    }
+
+    return new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('TransitionsTraceEntry')
+      .setName('transition')
+      .setChildren([
+        {
+          name: 'wmData',
+          children: wmDataChildren,
+        },
+        {
+          name: 'shellData',
+          children: shellDataChildren,
+        },
+        {name: 'aborted', value: abortTime !== undefined},
+      ])
+      .build();
+  }
+
+  async function setTraceAndSelectionRange(
+    transitions: PropertyTreeNode[],
+    timestamps: Timestamp[],
+    range = range10to110,
+  ) {
+    component.trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSITION)
+      .setEntries(transitions)
+      .setTimestamps(timestamps)
+      .build();
+    component.transitionEntries = transitions;
+    component.selectionRange = range;
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+  }
+
+  function getExpectedBorderedRect(): Rect {
+    const padding = 5;
+    const oneRowTotalHeight = 30;
+    const oneRowHeight = oneRowTotalHeight - padding;
+    const width = component.canvasDrawer.getScaledCanvasWidth();
+    return new Rect(
+      Math.floor((width * 1) / 4),
+      padding,
+      Math.floor(width / 2),
+      oneRowHeight,
     );
   }
+
+  async function dispatchMousemoveEvent() {
+    const mousemoveEvent = new MouseEvent('mousemove');
+    spyOnProperty(mousemoveEvent, 'offsetX').and.returnValue(
+      Math.floor(component.canvasDrawer.getScaledCanvasWidth() / 2),
+    );
+    spyOnProperty(mousemoveEvent, 'offsetY').and.returnValue(25 / 2);
+    component.getCanvas().dispatchEvent(mousemoveEvent);
+    fixture.detectChanges();
+    await fixture.whenRenderingDone();
+  }
 });
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/canvas_mouse_handler_impl.ts b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/canvas_mouse_handler_impl.ts
index c158ebb4a..0132a4872 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/canvas_mouse_handler_impl.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/canvas_mouse_handler_impl.ts
@@ -15,7 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Point} from 'common/geometry_types';
+import {Point} from 'common/geometry/point';
 import {Trace} from 'trace/trace';
 import {
   CanvasMouseHandler,
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/draggable_canvas_object_impl.ts b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/draggable_canvas_object_impl.ts
index c52c199a1..94fbdaa76 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/draggable_canvas_object_impl.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/draggable_canvas_object_impl.ts
@@ -37,7 +37,7 @@ export class DraggableCanvasObjectImpl implements DraggableCanvasObject {
     private drawConfig: DrawConfig,
     private onDrag: (x: number) => void,
     private onDrop: (x: number) => void,
-    private rangeGetter: () => Segment,
+    private getRange: () => Segment,
   ) {
     this.drawer.handler.registerDraggableObject(
       this,
@@ -54,18 +54,8 @@ export class DraggableCanvasObjectImpl implements DraggableCanvasObject {
     );
   }
 
-  get range(): Segment {
-    return this.rangeGetter();
-  }
-
-  get position(): number {
-    return this.draggingPosition !== undefined
-      ? this.draggingPosition
-      : this.positionGetter();
-  }
-
   definePath(ctx: CanvasRenderingContext2D) {
-    this.definePathFunc(ctx, this.position);
+    this.definePathFunc(ctx, this.getPosition());
   }
 
   draw(ctx: CanvasRenderingContext2D) {
@@ -73,6 +63,12 @@ export class DraggableCanvasObjectImpl implements DraggableCanvasObject {
     this.drawer.handler.notifyDrawnOnTop(this);
   }
 
+  private getPosition(): number {
+    return this.draggingPosition !== undefined
+      ? this.draggingPosition
+      : this.positionGetter();
+  }
+
   private doDraw(ctx: CanvasRenderingContext2D) {
     this.definePath(ctx);
     ctx.fillStyle = this.drawConfig.fillStyle;
@@ -82,6 +78,7 @@ export class DraggableCanvasObjectImpl implements DraggableCanvasObject {
   }
 
   private clampPositionToRange(x: number): number {
-    return MathUtils.clamp(x, this.range.from, this.range.to);
+    const range = this.getRange();
+    return MathUtils.clamp(x, range.from, range.to);
   }
 }
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer.ts b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer.ts
index b01b08466..5f110027b 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {Point} from 'common/geometry_types';
+import {Point} from 'common/geometry/point';
 import {Padding} from 'common/padding';
 import {Trace} from 'trace/trace';
 import {CanvasMouseHandler} from './canvas_mouse_handler';
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_impl.ts b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_impl.ts
index f0c5bfca5..d953792ef 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_impl.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_impl.ts
@@ -15,7 +15,9 @@
  */
 
 import {Color} from 'app/colors';
-import {Point} from 'common/geometry_types';
+import {Segment} from 'app/components/timeline/segment';
+import {TimelineUtils} from 'app/components/timeline/timeline_utils';
+import {Point} from 'common/geometry/point';
 import {MouseEventButton} from 'common/mouse_event_button';
 import {Padding} from 'common/padding';
 import {Timestamp} from 'common/time';
@@ -43,6 +45,7 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
   private activePointer: DraggableCanvasObject;
   private lastMousePoint: Point | undefined;
   private static readonly MARKER_CLICK_REGION_WIDTH = 2;
+  private static readonly TRACE_ENTRY_ALPHA = 0.7;
 
   constructor(
     public canvas: HTMLCanvasElement,
@@ -57,7 +60,7 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
     const ctx = canvas.getContext('2d');
 
     if (ctx === null) {
-      throw Error('MiniTimeline canvas context was null!');
+      throw new Error('MiniTimeline canvas context was null!');
     }
 
     this.ctx = ctx;
@@ -267,7 +270,7 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
     fromTop: number,
     lineHeight: number,
   ) {
-    this.ctx.globalAlpha = 0.7;
+    this.ctx.globalAlpha = MiniTimelineDrawerImpl.TRACE_ENTRY_ALPHA;
     this.ctx.fillStyle = TRACE_INFO[trace.type].color;
     this.ctx.strokeStyle = 'blue';
 
@@ -277,8 +280,12 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
     }
 
     for (const entry of timelineTrace.segments) {
-      const width = Math.max(entry.to - entry.from, 3);
-      this.ctx.fillRect(entry.from, fromTop, width, lineHeight);
+      this.drawTransitionEntry(
+        entry,
+        fromTop,
+        TRACE_INFO[trace.type].color,
+        lineHeight,
+      );
     }
 
     this.ctx.fillStyle = Color.ACTIVE_POINTER;
@@ -289,14 +296,89 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
     }
 
     if (timelineTrace.activeSegment) {
-      const entry = timelineTrace.activeSegment;
-      const width = Math.max(entry.to - entry.from, 3);
-      this.ctx.fillRect(entry.from, fromTop, width, lineHeight);
+      this.drawTransitionEntry(
+        timelineTrace.activeSegment,
+        fromTop,
+        Color.ACTIVE_POINTER,
+        lineHeight,
+      );
     }
 
     this.ctx.globalAlpha = 1.0;
   }
 
+  private drawTransitionEntry(
+    entry: Segment,
+    fromTop: number,
+    hexColor: string,
+    lineHeight: number,
+  ) {
+    const width = Math.max(entry.to - entry.from, 3);
+
+    if (!(entry.unknownStart || entry.unknownEnd)) {
+      this.ctx.globalAlpha = MiniTimelineDrawerImpl.TRACE_ENTRY_ALPHA;
+      this.ctx.fillStyle = hexColor;
+      this.ctx.fillRect(entry.from, fromTop, width, lineHeight);
+      return;
+    }
+
+    const rgbColor = TimelineUtils.convertHexToRgb(hexColor);
+    if (rgbColor === undefined) {
+      throw new Error('Failed to parse provided hex color');
+    }
+    const {r, g, b} = rgbColor;
+    const rgbaColor = `rgba(${r},${g},${b},${MiniTimelineDrawerImpl.TRACE_ENTRY_ALPHA})`;
+    const transparentColor = `rgba(${r},${g},${b},${0})`;
+
+    const gradientWidthOutsideEntry = 12;
+    const gradientWidthInsideEntry = Math.min(6, width);
+
+    const startGradientx0 = entry.from - gradientWidthOutsideEntry;
+    const endGradientx1 = entry.to + gradientWidthOutsideEntry;
+
+    const start = entry.unknownStart ? startGradientx0 : entry.from;
+    const end = entry.unknownEnd ? endGradientx1 : entry.to;
+
+    const gradient = this.ctx.createLinearGradient(start, 0, end, 0);
+    const gradientRatio = Math.max(
+      0,
+      Math.min(
+        (gradientWidthOutsideEntry + gradientWidthInsideEntry) / (end - start),
+        1,
+      ),
+    );
+    gradient.addColorStop(0, entry.unknownStart ? transparentColor : rgbaColor);
+    gradient.addColorStop(1, entry.unknownEnd ? transparentColor : rgbaColor);
+    gradient.addColorStop(gradientRatio, rgbaColor);
+    gradient.addColorStop(1 - gradientRatio, rgbaColor);
+    this.ctx.fillStyle = gradient;
+
+    this.ctx.globalAlpha = 1;
+    this.ctx.fillRect(start, fromTop, end - start, lineHeight);
+
+    if (entry.unknownStart) {
+      this.drawEllipsis(entry.from - 8.5, fromTop, lineHeight);
+    }
+    if (entry.unknownEnd) {
+      this.drawEllipsis(entry.from + width + 1.5, fromTop, lineHeight);
+    }
+  }
+
+  private getEllipsisColor() {
+    return this.inputGetter().isDarkMode ? 'white' : 'black';
+  }
+
+  private drawEllipsis(start: number, fromTop: number, lineHeight: number) {
+    this.ctx.fillStyle = this.getEllipsisColor();
+    let center = start;
+    for (let i = 0; i < 3; i++) {
+      this.ctx.beginPath();
+      this.ctx.arc(center, fromTop + lineHeight / 2, 1, 0, 2 * Math.PI);
+      this.ctx.fill();
+      center += 3.5;
+    }
+  }
+
   private drawHoverCursor() {
     if (!this.lastMousePoint) {
       return;
@@ -342,13 +424,17 @@ export class MiniTimelineDrawerImpl implements MiniTimelineDrawer {
 
   private fillActiveTimelineBackground(fromTop: number, lineHeight: number) {
     this.ctx.globalAlpha = 1.0;
-    this.ctx.fillStyle = this.inputGetter().isDarkMode ? '#696563' : '#eeeff0'; // Keep in sync with var(--drawer-block-primary) in material-theme.scss;
+    this.ctx.fillStyle = getComputedStyle(this.canvas).getPropertyValue(
+      '--selected-element-color',
+    );
     this.ctx.fillRect(0, fromTop, this.getUsableRange().to, lineHeight);
   }
 
   private fillHoverTimelineBackground(fromTop: number, lineHeight: number) {
     this.ctx.globalAlpha = 1.0;
-    this.ctx.fillStyle = this.inputGetter().isDarkMode ? '#4e5767' : '#E8F0FE'; // Keep in sync with var(--hover-element-color) in material-theme.scss;
+    this.ctx.fillStyle = getComputedStyle(this.canvas).getPropertyValue(
+      '--hover-element-color',
+    );
     this.ctx.fillRect(0, fromTop, this.getUsableRange().to, lineHeight);
   }
 
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_input.ts b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_input.ts
index 9905a69e2..e9a8453cd 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_input.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/drawer/mini_timeline_drawer_input.ts
@@ -120,8 +120,12 @@ export class MiniTimelineDrawerInput {
     transformer: Transformer,
     entry: TraceEntry<PropertyTreeNode>,
   ): Segment | undefined {
-    const transition: PropertyTreeNode =
-      this.timelineData.getTransitions()[entry.getIndex()];
+    const transition: PropertyTreeNode | undefined = this.timelineData
+      .getTransitionEntries()
+      .at(entry.getIndex());
+    if (!transition) {
+      return undefined;
+    }
 
     const timeRange = TimelineUtils.getTimeRangeForTransition(
       transition,
@@ -136,6 +140,8 @@ export class MiniTimelineDrawerInput {
     return {
       from: transformer.transform(timeRange.from),
       to: transformer.transform(timeRange.to),
+      unknownStart: TimelineUtils.isTransitionWithUnknownStart(transition),
+      unknownEnd: TimelineUtils.isTransitionWithUnknownEnd(transition),
     };
   }
 
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component.ts b/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component.ts
index 0f4dbf844..b5bf0e414 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component.ts
@@ -46,10 +46,10 @@ import {Transformer} from './transformer';
   template: `
     <div class="mini-timeline-outer-wrapper">
       <div class="zoom-buttons">
-        <button mat-icon-button id="zoom-in-btn" (click)="zoomIn()">
+        <button mat-icon-button id="zoom-in-btn" (click)="onZoomInButtonClick()">
           <mat-icon>zoom_in</mat-icon>
         </button>
-        <button mat-icon-button id="zoom-out-btn" (click)="zoomOut()">
+        <button mat-icon-button id="zoom-out-btn" (click)="onZoomOutButtonClick()">
           <mat-icon>zoom_out</mat-icon>
         </button>
         <button mat-icon-button id="reset-zoom-btn" (click)="resetZoom()">
@@ -139,7 +139,9 @@ export class MiniTimelineComponent {
     range: TimeRange;
     rangeContainsBookmark: boolean;
   }>();
-  @Output() readonly onTraceClicked = new EventEmitter<Trace<object>>();
+  @Output() readonly onTraceClicked = new EventEmitter<
+    [Trace<object>, Timestamp]
+  >();
 
   @ViewChild('miniTimelineWrapper', {static: false})
   miniTimelineWrapper: ElementRef | undefined;
@@ -196,9 +198,11 @@ export class MiniTimelineComponent {
       trace: Trace<object> | undefined,
     ) => {
       if (trace) {
-        this.onTraceClicked.emit(trace);
+        this.onTraceClicked.emit([trace, timestamp]);
+        this.onSeekTimestampUpdate.emit(undefined);
+      } else {
+        updateTimestampCallback(timestamp);
       }
-      updateTimestampCallback(timestamp);
     };
 
     this.drawer = new MiniTimelineDrawerImpl(
@@ -278,6 +282,9 @@ export class MiniTimelineComponent {
 
   @HostListener('document:keydown', ['$event'])
   async handleKeyboardEvent(event: KeyboardEvent) {
+    if ((event.target as HTMLElement).tagName === 'INPUT') {
+      return;
+    }
     if (event.code === 'KeyA') {
       this.updateSliderPosition(-MiniTimelineComponent.SLIDER_HORIZONTAL_STEP);
     }
@@ -290,7 +297,9 @@ export class MiniTimelineComponent {
     }
 
     const zoomTo = this.hoverTimestamp;
-    event.code === 'KeyW' ? this.zoomIn(zoomTo) : this.zoomOut(zoomTo);
+    const isZoomIn = event.code === 'KeyW';
+    Analytics.Navigation.logZoom('key', 'timeline', isZoomIn ? 'in' : 'out');
+    isZoomIn ? this.zoomIn(zoomTo) : this.zoomOut(zoomTo);
   }
 
   onZoomChanged(zoom: TimeRange) {
@@ -308,83 +317,19 @@ export class MiniTimelineComponent {
 
   resetZoom() {
     Analytics.Navigation.logZoom('reset', 'timeline');
-    this.onZoomChanged(assertDefined(this.timelineData).getFullTimeRange());
-  }
-
-  zoomIn(zoomOn?: Timestamp) {
-    Analytics.Navigation.logZoom(this.getZoomSource(zoomOn), 'timeline', 'in');
-    this.zoom({nominator: 6n, denominator: 7n}, zoomOn);
+    this.onZoomChanged(
+      this.initialZoom ?? assertDefined(this.timelineData).getFullTimeRange(),
+    );
   }
 
-  zoomOut(zoomOn?: Timestamp) {
-    Analytics.Navigation.logZoom(this.getZoomSource(zoomOn), 'timeline', 'out');
-    this.zoom({nominator: 8n, denominator: 7n}, zoomOn);
+  onZoomInButtonClick() {
+    Analytics.Navigation.logZoom('button', 'timeline', 'in');
+    this.zoomIn();
   }
 
-  zoom(
-    zoomRatio: {nominator: bigint; denominator: bigint},
-    zoomOn?: Timestamp,
-  ) {
-    const timelineData = assertDefined(this.timelineData);
-    const fullRange = timelineData.getFullTimeRange();
-    const currentZoomRange = timelineData.getZoomRange();
-    const currentZoomWidth = currentZoomRange.to.minus(
-      currentZoomRange.from.getValueNs(),
-    );
-    const zoomToWidth = currentZoomWidth
-      .times(zoomRatio.nominator)
-      .div(zoomRatio.denominator);
-
-    const cursorPosition = this.currentTracePosition?.timestamp;
-    const currentMiddle = currentZoomRange.from
-      .add(currentZoomRange.to.getValueNs())
-      .div(2n);
-
-    let newFrom: Timestamp;
-    let newTo: Timestamp;
-
-    let zoomTowards = currentMiddle;
-    if (zoomOn === undefined) {
-      if (cursorPosition !== undefined && cursorPosition.in(currentZoomRange)) {
-        zoomTowards = cursorPosition;
-      }
-    } else if (zoomOn.in(currentZoomRange)) {
-      zoomTowards = zoomOn;
-    }
-
-    newFrom = zoomTowards.minus(
-      zoomToWidth
-        .times(
-          zoomTowards.minus(currentZoomRange.from.getValueNs()).getValueNs(),
-        )
-        .div(currentZoomWidth.getValueNs())
-        .getValueNs(),
-    );
-
-    newTo = zoomTowards.add(
-      zoomToWidth
-        .times(currentZoomRange.to.minus(zoomTowards.getValueNs()).getValueNs())
-        .div(currentZoomWidth.getValueNs())
-        .getValueNs(),
-    );
-
-    if (newFrom.getValueNs() < fullRange.from.getValueNs()) {
-      newTo = TimestampUtils.min(
-        fullRange.to,
-        newFrom.add(zoomToWidth.getValueNs()),
-      );
-      newFrom = fullRange.from;
-    }
-
-    if (newTo.getValueNs() > fullRange.to.getValueNs()) {
-      newFrom = TimestampUtils.max(
-        fullRange.from,
-        fullRange.to.minus(zoomToWidth.getValueNs()),
-      );
-      newTo = fullRange.to;
-    }
-
-    this.onZoomChanged(new TimeRange(newFrom, newTo));
+  onZoomOutButtonClick() {
+    Analytics.Navigation.logZoom('button', 'timeline', 'out');
+    this.zoomOut();
   }
 
   @HostListener('wheel', ['$event'])
@@ -439,14 +384,6 @@ export class MiniTimelineComponent {
     this.onRemoveAllBookmarks.emit();
   }
 
-  private getZoomSource(zoomOn?: Timestamp): 'scroll' | 'button' {
-    if (zoomOn === undefined) {
-      return 'button';
-    }
-
-    return 'scroll';
-  }
-
   private getMiniCanvasDrawerInput() {
     const timelineData = assertDefined(this.timelineData);
     return new MiniTimelineDrawerInput(
@@ -517,7 +454,9 @@ export class MiniTimelineComponent {
         (drawer.getWidth() * event.offsetX) / canvas.offsetWidth;
       this.updateHoverTimestamp();
     }
-    if (event.deltaY < 0) {
+    const isZoomIn = event.deltaY < 0;
+    Analytics.Navigation.logZoom('scroll', 'timeline', isZoomIn ? 'in' : 'out');
+    if (isZoomIn) {
       this.zoomIn(this.hoverTimestamp);
     } else {
       this.zoomOut(this.hoverTimestamp);
@@ -565,4 +504,78 @@ export class MiniTimelineComponent {
     this.onZoomChanged(new TimeRange(newFrom, newTo));
     this.updateHoverTimestamp();
   }
+
+  private zoomIn(zoomOn?: Timestamp) {
+    this.zoom({nominator: 6n, denominator: 7n}, zoomOn);
+  }
+
+  private zoomOut(zoomOn?: Timestamp) {
+    this.zoom({nominator: 8n, denominator: 7n}, zoomOn);
+  }
+
+  private zoom(
+    zoomRatio: {nominator: bigint; denominator: bigint},
+    zoomOn?: Timestamp,
+  ) {
+    const timelineData = assertDefined(this.timelineData);
+    const fullRange = timelineData.getFullTimeRange();
+    const currentZoomRange = timelineData.getZoomRange();
+    const currentZoomWidth = currentZoomRange.to.minus(
+      currentZoomRange.from.getValueNs(),
+    );
+    const zoomToWidth = currentZoomWidth
+      .times(zoomRatio.nominator)
+      .div(zoomRatio.denominator);
+
+    const cursorPosition = this.currentTracePosition?.timestamp;
+    const currentMiddle = currentZoomRange.from
+      .add(currentZoomRange.to.getValueNs())
+      .div(2n);
+
+    let newFrom: Timestamp;
+    let newTo: Timestamp;
+
+    let zoomTowards = currentMiddle;
+    if (zoomOn === undefined) {
+      if (cursorPosition !== undefined && cursorPosition.in(currentZoomRange)) {
+        zoomTowards = cursorPosition;
+      }
+    } else if (zoomOn.in(currentZoomRange)) {
+      zoomTowards = zoomOn;
+    }
+
+    newFrom = zoomTowards.minus(
+      zoomToWidth
+        .times(
+          zoomTowards.minus(currentZoomRange.from.getValueNs()).getValueNs(),
+        )
+        .div(currentZoomWidth.getValueNs())
+        .getValueNs(),
+    );
+
+    newTo = zoomTowards.add(
+      zoomToWidth
+        .times(currentZoomRange.to.minus(zoomTowards.getValueNs()).getValueNs())
+        .div(currentZoomWidth.getValueNs())
+        .getValueNs(),
+    );
+
+    if (newFrom.getValueNs() < fullRange.from.getValueNs()) {
+      newTo = TimestampUtils.min(
+        fullRange.to,
+        newFrom.add(zoomToWidth.getValueNs()),
+      );
+      newFrom = fullRange.from;
+    }
+
+    if (newTo.getValueNs() > fullRange.to.getValueNs()) {
+      newFrom = TimestampUtils.max(
+        fullRange.from,
+        fullRange.to.minus(zoomToWidth.getValueNs()),
+      );
+      newTo = fullRange.to;
+    }
+
+    this.onZoomChanged(new TimeRange(newFrom, newTo));
+  }
 }
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component_test.ts b/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component_test.ts
index 4279f2426..5960e207b 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/mini_timeline_component_test.ts
@@ -120,31 +120,49 @@ describe('MiniTimelineComponent', () => {
     const spy = spyOn(assertDefined(miniTimelineComponent.drawer), 'draw');
     expect(spy).not.toHaveBeenCalled();
 
-    miniTimelineComponent.onResize({} as Event);
+    window.dispatchEvent(new Event('resize'));
+    fixture.detectChanges();
 
     expect(spy).toHaveBeenCalled();
   });
 
-  it('resets zoom on reset zoom button click', () => {
+  it('resets zoom to full time range on reset button click if initial zoom unavailable', () => {
     const expectedZoomRange = new TimeRange(timestamp15, timestamp16);
     timelineData.setZoom(expectedZoomRange);
+    const fullRange = timelineData.getFullTimeRange();
+    const zoomRange = timelineData.getZoomRange();
+    expect(zoomRange).toEqual(expectedZoomRange);
+    expect(zoomRange).not.toEqual(fullRange);
+    fixture.detectChanges();
 
-    let zoomRange = timelineData.getZoomRange();
-    let fullRange = timelineData.getFullTimeRange();
-    expect(zoomRange).toBe(expectedZoomRange);
-    expect(fullRange.from).toBe(timestamp10);
-    expect(fullRange.to).toBe(timestamp20);
+    const zoomButton = assertDefined(
+      htmlElement.querySelector('button#reset-zoom-btn'),
+    ) as HTMLButtonElement;
+    zoomButton.click();
+    fixture.detectChanges();
 
+    expect(timelineData.getZoomRange()).toEqual(fullRange);
+  });
+
+  it('resets zoom to initial zoom on reset button click if available', () => {
+    const initialZoom = new TimeRange(timestamp15, timestamp16);
+    component.initialZoom = initialZoom;
+    fixture.detectChanges();
+    expect(timelineData.getZoomRange()).toEqual(initialZoom);
+
+    const newZoom = new TimeRange(timestamp10, timestamp16);
+    timelineData.setZoom(newZoom);
+    expect(timelineData.getZoomRange()).toEqual(newZoom);
     fixture.detectChanges();
 
     const zoomButton = assertDefined(
       htmlElement.querySelector('button#reset-zoom-btn'),
     ) as HTMLButtonElement;
     zoomButton.click();
+    fixture.detectChanges();
 
-    zoomRange = timelineData.getZoomRange();
-    fullRange = timelineData.getFullTimeRange();
-    expect(zoomRange).toBe(fullRange);
+    expect(timelineData.getZoomRange()).toEqual(initialZoom);
+    expect(timelineData.getFullTimeRange()).not.toEqual(initialZoom);
   });
 
   it('show zoom controls when zoomed out', () => {
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/slider_component.ts b/tools/winscope/src/app/components/timeline/mini-timeline/slider_component.ts
index 9f73983c6..32894ada5 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/slider_component.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/slider_component.ts
@@ -28,7 +28,7 @@ import {
 } from '@angular/core';
 import {Color} from 'app/colors';
 import {assertDefined} from 'common/assert_utils';
-import {Point} from 'common/geometry_types';
+import {Point} from 'common/geometry/point';
 import {TimeRange, Timestamp} from 'common/time';
 import {ComponentTimestampConverter} from 'common/timestamp_converter';
 import {TracePosition} from 'trace/trace_position';
diff --git a/tools/winscope/src/app/components/timeline/mini-timeline/slider_component_test.ts b/tools/winscope/src/app/components/timeline/mini-timeline/slider_component_test.ts
index 2e6827225..7b0efa3da 100644
--- a/tools/winscope/src/app/components/timeline/mini-timeline/slider_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/mini-timeline/slider_component_test.ts
@@ -135,7 +135,7 @@ describe('SliderComponent', () => {
     expect(component.sliderBox.nativeElement.offsetWidth).toBe(100);
 
     htmlElement.style.width = '587px';
-    component.onResize({} as Event);
+    window.dispatchEvent(new Event('resize'));
     fixture.detectChanges();
 
     expect(initialSliderXPos).not.toBe(slider.getBoundingClientRect().left);
diff --git a/tools/winscope/src/app/components/timeline/segment.ts b/tools/winscope/src/app/components/timeline/segment.ts
index 241ad0944..8a58db501 100644
--- a/tools/winscope/src/app/components/timeline/segment.ts
+++ b/tools/winscope/src/app/components/timeline/segment.ts
@@ -17,4 +17,6 @@
 export interface Segment {
   from: number;
   to: number;
+  unknownStart?: boolean;
+  unknownEnd?: boolean;
 }
diff --git a/tools/winscope/src/app/components/timeline/timeline_component.ts b/tools/winscope/src/app/components/timeline/timeline_component.ts
index 0992c02bf..bbd490c1a 100644
--- a/tools/winscope/src/app/components/timeline/timeline_component.ts
+++ b/tools/winscope/src/app/components/timeline/timeline_component.ts
@@ -40,7 +40,7 @@ import {assertDefined} from 'common/assert_utils';
 import {FunctionUtils} from 'common/function_utils';
 import {PersistentStore} from 'common/persistent_store';
 import {StringUtils} from 'common/string_utils';
-import {TimeRange, Timestamp} from 'common/time';
+import {TimeRange, Timestamp, TimestampFormatType} from 'common/time';
 import {TimestampUtils} from 'common/timestamp_utils';
 import {Analytics} from 'logging/analytics';
 import {
@@ -56,6 +56,7 @@ import {
 } from 'messaging/winscope_event_emitter';
 import {WinscopeEventListener} from 'messaging/winscope_event_listener';
 import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
 import {TracePosition} from 'trace/trace_position';
 import {TraceType, TraceTypeUtils} from 'trace/trace_type';
@@ -93,13 +94,13 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         [timelineData]="timelineData"
         (onTracePositionUpdate)="updatePosition($event)"
         (onScrollEvent)="updateScrollEvent($event)"
-        (onTraceClicked)="onTimelineTraceClicked($event)"
+        (onTraceClicked)="onExpandedTimelineTraceClicked($event)"
         (onMouseXRatioUpdate)="updateExpandedTimelineMouseXRatio($event)"
         id="expanded-timeline"></expanded-timeline>
     </div>
     <div class="navbar-toggle">
       <div class="navbar" #collapsedTimeline>
-        <ng-template [ngIf]="timelineData.hasMoreThanOneDistinctTimestamp()">
+        <ng-template [ngIf]="timelineData.hasTimestamps()">
           <div id="time-selector">
             <form [formGroup]="timestampForm" class="time-selector-form">
               <mat-form-field
@@ -180,7 +181,7 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
                 <div class="select-traces-panel">
                   <div class="tip">Filter traces in the timeline</div>
                   <mat-option
-                    *ngFor="let trace of sortedAvailableTraces"
+                    *ngFor="let trace of sortedTraces"
                     [value]="trace"
                     [style]="{
                       color: 'var(--blue-text-color)',
@@ -193,7 +194,7 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
                         color: TRACE_INFO[trace.type].color
                       }"
                     >{{ TRACE_INFO[trace.type].icon }}</mat-icon>
-                    {{ TRACE_INFO[trace.type].name }}
+                    {{ getTitle(trace) }}
                   </mat-option>
                   <div class="actions">
                     <button mat-flat-button color="primary" (click)="traceSelector.close()">
@@ -212,7 +213,7 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
                       class="trace-icon"
                       *ngFor="let selectedTrace of getSelectedTracesToShow()"
                       [style]="{color: TRACE_INFO[selectedTrace.type].color}"
-                      [matTooltip]="TRACE_INFO[selectedTrace.type].name"
+                      [matTooltip]="getTraceTooltip(selectedTrace)"
                       #tooltip="matTooltip"
                       (mouseenter)="tooltip.disabled = false"
                       (mouseleave)="tooltip.disabled = true">
@@ -229,6 +230,7 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
             </mat-form-field>
           </div>
           <mini-timeline
+            *ngIf="timelineData.hasMoreThanOneDistinctTimestamp()"
             [timelineData]="timelineData"
             [currentTracePosition]="getCurrentTracePosition()"
             [selectedTraces]="selectedTraces"
@@ -241,19 +243,20 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
             (onSeekTimestampUpdate)="updateSeekTimestamp($event)"
             (onRemoveAllBookmarks)="removeAllBookmarks()"
             (onToggleBookmark)="toggleBookmarkRange($event.range, $event.rangeContainsBookmark)"
-            (onTraceClicked)="onTimelineTraceClicked($event)"
+            (onTraceClicked)="onMiniTimelineTraceClicked($event)"
             id="mini-timeline"
             #miniTimeline></mini-timeline>
         </ng-template>
-        <div *ngIf="!timelineData.hasTimestamps()" class="no-timestamps-msg">
-          <p class="mat-body-2">No timeline to show!</p>
-          <p class="mat-body-1">All loaded traces contain no timestamps.</p>
-        </div>
         <div
-          *ngIf="timelineData.hasTimestamps() && !timelineData.hasMoreThanOneDistinctTimestamp()"
-          class="no-timestamps-msg">
-          <p class="mat-body-2">No timeline to show!</p>
-          <p class="mat-body-1">Only a single timestamp has been recorded.</p>
+          *ngIf="!timelineData.hasMoreThanOneDistinctTimestamp()"
+          class="no-timeline-msg">
+            <p class="mat-body-2">No timeline to show!</p>
+            <p
+              *ngIf="timelineData.hasTimestamps()"
+              class="mat-body-1">Only a single timestamp has been recorded.</p>
+            <p
+              *ngIf="!timelineData.hasTimestamps()"
+              class="mat-body-1">All loaded traces contain no timestamps.</p>
         </div>
       </div>
     </div>
@@ -265,6 +268,8 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         flex-direction: column;
         align-items: end;
         position: relative;
+        max-height: 20vh;
+        overflow: auto;
       }
       #toggle {
         width: fit-content;
@@ -291,6 +296,8 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         flex-direction: row;
         border-bottom: 1px solid #3333;
         border-top: 1px solid #3333;
+        max-height: 60vh;
+        overflow: hidden;
       }
       #time-selector {
         display: flex;
@@ -378,7 +385,7 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
       #video-content {
         position: relative;
         min-width: 20rem;
-        min-height: 35rem;
+        max-height: 60vh;
         align-self: stretch;
         text-align: center;
         border: 2px solid black;
@@ -396,6 +403,8 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
       }
       #expanded-timeline {
         flex-grow: 1;
+        overflow-y: auto;
+        overflow-x: hidden;
       }
       #trace-selector .mat-form-field-infix {
         width: 80px;
@@ -437,6 +446,11 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         position: relative;
         bottom: 120px;
       }
+      .select-traces-panel {
+        max-height: 60vh;
+        overflow-y: auto;
+        overflow-x: hidden;
+      }
       .tip {
         padding: 16px;
         font-weight: 300;
@@ -452,11 +466,12 @@ import {MiniTimelineComponent} from './mini-timeline/mini_timeline_component';
         padding: 1rem;
         font-family: 'Roboto', sans-serif;
       }
-      .no-timestamps-msg {
+      .no-timeline-msg {
         padding: 1rem;
         align-items: center;
         display: flex;
         flex-direction: column;
+        width: 100%;
       }
     `,
     multlineTooltip,
@@ -469,6 +484,7 @@ export class TimelineComponent
   readonly MAX_SELECTED_TRACES = 3;
 
   @Input() timelineData: TimelineData | undefined;
+  @Input() allTraces: Traces | undefined;
   @Input() store: PersistentStore | undefined;
 
   @Output() readonly collapsedTimelineSizeChanged = new EventEmitter<number>();
@@ -483,7 +499,7 @@ export class TimelineComponent
 
   initialZoom: TimeRange | undefined = undefined;
   selectedTraces: Array<Trace<object>> = [];
-  sortedAvailableTraces: Array<Trace<object>> = [];
+  sortedTraces: Array<Trace<object>> = [];
   selectedTracesFormControl = new FormControl<Array<Trace<object>>>([]);
   selectedTimeFormControl = new FormControl('undefined');
   selectedNsFormControl = new FormControl(
@@ -532,22 +548,26 @@ export class TimelineComponent
     }
 
     // sorted to be displayed in order corresponding to viewer tabs
-    this.sortedAvailableTraces =
-      this.timelineData
-        ?.getTraces()
-        .mapTrace((trace) => trace)
+    this.sortedTraces =
+      this.allTraces
+        ?.mapTrace((trace) => trace)
         .sort((a, b) => TraceTypeUtils.compareByDisplayOrder(a.type, b.type)) ??
       [];
 
     const storedDeselectedTraces = this.getStoredDeselectedTraceTypes();
-    this.selectedTraces = this.sortedAvailableTraces.filter((trace) => {
-      return !storedDeselectedTraces.includes(trace.type);
+    this.selectedTraces = this.sortedTraces.filter((trace) => {
+      return (
+        timelineData.hasTrace(trace) &&
+        (!storedDeselectedTraces.includes(trace.type) ||
+          timelineData.getActiveTrace() === trace ||
+          !timelineData.hasMoreThanOneDistinctTimestamp())
+      );
     });
     this.selectedTracesFormControl = new FormControl<Array<Trace<object>>>(
       this.selectedTraces,
     );
 
-    const initialTraceToCropZoom = this.sortedAvailableTraces.find((trace) => {
+    const initialTraceToCropZoom = this.selectedTraces.find((trace) => {
       return (
         trace.type !== TraceType.SCREEN_RECORDING &&
         TraceTypeUtils.isTraceTypeWithViewer(trace.type) &&
@@ -587,7 +607,7 @@ export class TimelineComponent
 
     const position = assertDefined(this.timelineData).getCurrentPosition();
     if (position === undefined) {
-      throw Error(
+      throw new Error(
         'A trace position should be available by the time the timeline is loaded',
       );
     }
@@ -645,15 +665,25 @@ export class TimelineComponent
   }
 
   isOptionDisabled(trace: Trace<object>) {
-    return this.timelineData?.getActiveTrace() === trace;
+    const timelineData = assertDefined(this.timelineData);
+    return (
+      !timelineData.hasTrace(trace) || timelineData.getActiveTrace() === trace
+    );
   }
 
   applyNewTraceSelection(clickedTrace: Trace<object>) {
     this.selectedTraces =
-      this.selectedTracesFormControl.value ?? this.sortedAvailableTraces;
+      this.selectedTracesFormControl.value ??
+      this.sortedTraces.filter((trace) => {
+        return assertDefined(this.timelineData).hasTrace(trace);
+      });
     this.updateStoredDeselectedTraceTypes(clickedTrace);
   }
 
+  getTitle(trace: Trace<object>): string {
+    return TRACE_INFO[trace.type].name + (trace.isDump() ? ' Dump' : '');
+  }
+
   @HostListener('document:focusin', ['$event'])
   handleFocusInEvent(event: FocusEvent) {
     if (
@@ -680,7 +710,7 @@ export class TimelineComponent
   async handleKeyboardEvent(event: KeyboardEvent) {
     if (
       this.isInputFormFocused ||
-      !assertDefined(this.timelineData).hasTimestamps()
+      !assertDefined(this.timelineData).hasMoreThanOneDistinctTimestamp()
     ) {
       return;
     }
@@ -872,17 +902,34 @@ export class TimelineComponent
         ).makeTimestampFromNs(clickedNs),
       ]);
     }
+    Analytics.Navigation.logTimeBookmark();
   }
 
   removeAllBookmarks() {
     this.bookmarks = [];
   }
 
-  async onTimelineTraceClicked(trace: Trace<object>) {
+  async onMiniTimelineTraceClicked(eventData: [Trace<object>, Timestamp]) {
+    const [trace, timestamp] = eventData;
+    await this.emitEvent(new ActiveTraceChanged(trace));
+    await this.updatePosition(
+      assertDefined(this.timelineData).makePositionFromActiveTrace(timestamp),
+    );
+    this.changeDetectorRef.detectChanges();
+  }
+
+  async onExpandedTimelineTraceClicked(trace: Trace<object>) {
     await this.emitEvent(new ActiveTraceChanged(trace));
     this.changeDetectorRef.detectChanges();
   }
 
+  getTraceTooltip(trace: Trace<object>) {
+    if (trace.type === TraceType.SCREEN_RECORDING) {
+      return trace.getDescriptors()[0].split('.')[0];
+    }
+    return TRACE_INFO[trace.type].name;
+  }
+
   private updateSelectedTraces(trace: Trace<object> | undefined) {
     if (!trace) {
       return;
@@ -900,16 +947,11 @@ export class TimelineComponent
       this.getCurrentTracePosition().timestamp.getValueNs();
     const timelineData = assertDefined(this.timelineData);
 
-    let formattedCurrentTimestamp = assertDefined(
+    const formattedCurrentTimestamp = assertDefined(
       timelineData.getTimestampConverter(),
     )
       .makeTimestampFromNs(currentTimestampNs)
-      .format();
-    if (TimestampUtils.isHumanRealTimestampFormat(formattedCurrentTimestamp)) {
-      formattedCurrentTimestamp = assertDefined(
-        TimestampUtils.extractTimeFromHumanTimestamp(formattedCurrentTimestamp),
-      );
-    }
+      .format(TimestampFormatType.DROP_DATE);
     this.selectedTimeFormControl.setValue(formattedCurrentTimestamp);
     this.selectedNsFormControl.setValue(`${currentTimestampNs} ns`);
   }
diff --git a/tools/winscope/src/app/components/timeline/timeline_component_test.ts b/tools/winscope/src/app/components/timeline/timeline_component_test.ts
index 195a89029..778a28e7e 100644
--- a/tools/winscope/src/app/components/timeline/timeline_component_test.ts
+++ b/tools/winscope/src/app/components/timeline/timeline_component_test.ts
@@ -40,11 +40,13 @@ import {TimeRange} from 'common/time';
 import {
   ActiveTraceChanged,
   ExpandedTimelineToggled,
+  TracePositionUpdate,
   WinscopeEvent,
 } from 'messaging/winscope_event';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
 import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
 import {TracePosition} from 'trace/trace_position';
 import {TraceType} from 'trace/trace_type';
@@ -63,7 +65,6 @@ describe('TimelineComponent', () => {
   const time110 = TimestampConverterUtils.makeRealTimestamp(110n);
   const time112 = TimestampConverterUtils.makeRealTimestamp(112n);
 
-  const time1000 = TimestampConverterUtils.makeRealTimestamp(1000n);
   const time2000 = TimestampConverterUtils.makeRealTimestamp(2000n);
   const time3000 = TimestampConverterUtils.makeRealTimestamp(3000n);
   const time4000 = TimestampConverterUtils.makeRealTimestamp(4000n);
@@ -177,50 +178,39 @@ describe('TimelineComponent', () => {
     );
     fixture.detectChanges();
 
-    const timelineComponent = assertDefined(component.timeline);
-
-    // no expand button
-    const button = htmlElement.querySelector(
-      `.${timelineComponent.TOGGLE_BUTTON_CLASS}`,
-    );
-    expect(button).toBeFalsy();
-
-    // no timelines shown
-    const miniTimelineElement = fixture.debugElement.query(
-      By.directive(MiniTimelineComponent),
-    );
-    expect(miniTimelineElement).toBeFalsy();
+    expect(htmlElement.querySelector('.time-selector')).toBeNull();
+    expect(htmlElement.querySelector('.trace-selector')).toBeNull();
 
-    // error message shown
     const errorMessageContainer = assertDefined(
-      htmlElement.querySelector('.no-timestamps-msg'),
+      htmlElement.querySelector('.no-timeline-msg'),
     );
     expect(errorMessageContainer.textContent).toContain('No timeline to show!');
+    expect(errorMessageContainer.textContent).toContain(
+      'All loaded traces contain no timestamps.',
+    );
 
-    // arrow key presses don't do anything
-    const spyNextEntry = spyOn(timelineComponent, 'moveToNextEntry');
-    const spyPrevEntry = spyOn(timelineComponent, 'moveToPreviousEntry');
+    checkNoTimelineNavigation();
+  });
 
-    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}));
-    fixture.detectChanges();
-    expect(spyNextEntry).not.toHaveBeenCalled();
+  it('handles some empty traces and some with one timestamp', async () => {
+    await loadTracesWithOneTimestamp();
 
-    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}));
-    fixture.detectChanges();
-    expect(spyPrevEntry).not.toHaveBeenCalled();
-  });
+    expect(htmlElement.querySelector('#time-selector')).toBeTruthy();
+    const shownSelection = assertDefined(
+      htmlElement.querySelector('#trace-selector .shown-selection'),
+    );
+    expect(shownSelection.innerHTML).toContain('Window Manager');
+    expect(shownSelection.innerHTML).not.toContain('Surface Flinger');
 
-  it('handles some empty traces', () => {
-    const traces = new TracesBuilder()
-      .setTimestamps(TraceType.SURFACE_FLINGER, [])
-      .setTimestamps(TraceType.WINDOW_MANAGER, [time100])
-      .build();
-    assertDefined(component.timelineData).initialize(
-      traces,
-      undefined,
-      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    const errorMessageContainer = assertDefined(
+      htmlElement.querySelector('.no-timeline-msg'),
     );
-    fixture.detectChanges();
+    expect(errorMessageContainer.textContent).toContain('No timeline to show!');
+    expect(errorMessageContainer.textContent).toContain(
+      'Only a single timestamp has been recorded.',
+    );
+
+    checkNoTimelineNavigation();
   });
 
   it('processes active trace input and updates selected traces', async () => {
@@ -229,11 +219,11 @@ describe('TimelineComponent', () => {
 
     const timelineComponent = assertDefined(component.timeline);
     const nextEntryButton = assertDefined(
-      htmlElement.querySelector('#next_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#next_entry_button'),
+    );
     const prevEntryButton = assertDefined(
-      htmlElement.querySelector('#prev_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#prev_entry_button'),
+    );
 
     timelineComponent.selectedTraces = [
       getLoadedTrace(TraceType.SURFACE_FLINGER),
@@ -297,11 +287,11 @@ describe('TimelineComponent', () => {
     timelineData.setPosition(position100);
     fixture.detectChanges();
     const nextEntryButton = assertDefined(
-      htmlElement.querySelector('#next_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#next_entry_button'),
+    );
     const prevEntryButton = assertDefined(
-      htmlElement.querySelector('#prev_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#prev_entry_button'),
+    );
     expect(timelineData.getActiveTrace()).toBeUndefined();
     expect(timelineData.getCurrentPosition()?.timestamp.getValueNs()).toEqual(
       100n,
@@ -317,11 +307,11 @@ describe('TimelineComponent', () => {
 
     const timelineComponent = assertDefined(component.timeline);
     const nextEntryButton = assertDefined(
-      htmlElement.querySelector('#next_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#next_entry_button'),
+    );
     const prevEntryButton = assertDefined(
-      htmlElement.querySelector('#prev_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#prev_entry_button'),
+    );
     const spy = spyOn(
       assertDefined(timelineComponent.miniTimeline?.drawer),
       'draw',
@@ -345,39 +335,48 @@ describe('TimelineComponent', () => {
 
     await openSelectPanel();
 
-    const matOptions = assertDefined(
-      document.documentElement.querySelectorAll('mat-option'),
-    );
-    const sfOption = assertDefined(matOptions.item(1)) as HTMLInputElement;
+    const matOptions =
+      document.documentElement.querySelectorAll<HTMLInputElement>('mat-option');
+    const sfOption = matOptions.item(1);
     expect(sfOption.textContent).toContain('Surface Flinger');
     expect(sfOption.ariaDisabled).toEqual('true');
     for (const i of [0, 2, 3]) {
-      expect((matOptions.item(i) as HTMLInputElement).ariaDisabled).toEqual(
-        'false',
-      );
+      expect(matOptions.item(i).ariaDisabled).toEqual('false');
     }
 
-    (matOptions.item(2) as HTMLElement).click();
+    matOptions.item(2).click();
     fixture.detectChanges();
-    expectSelectedTraceTypes([
+    const expectedTypes = [
       TraceType.SCREEN_RECORDING,
       TraceType.SURFACE_FLINGER,
       TraceType.PROTO_LOG,
-    ]);
+    ];
+    expectSelectedTraceTypes(expectedTypes);
     const icons = htmlElement.querySelectorAll(
       '#trace-selector .shown-selection .mat-icon',
     );
-    expect(
-      Array.from(icons)
-        .map((icon) => icon.textContent?.trim())
-        .slice(1),
-    ).toEqual([
-      TRACE_INFO[TraceType.SCREEN_RECORDING].icon,
-      TRACE_INFO[TraceType.SURFACE_FLINGER].icon,
-      TRACE_INFO[TraceType.PROTO_LOG].icon,
-    ]);
-
-    (matOptions.item(2) as HTMLElement).click();
+    Array.from(icons)
+      .slice(1)
+      .forEach((icon, index) => {
+        const iconText = icon.textContent?.trim();
+        const expectedType = expectedTypes[index];
+        expect(iconText).toEqual(TRACE_INFO[expectedType].icon);
+
+        icon.dispatchEvent(new Event('mouseenter'));
+        fixture.detectChanges();
+        expect(
+          document.querySelector<HTMLElement>('.mat-tooltip-panel')
+            ?.textContent,
+        ).toEqual(
+          expectedType === TraceType.SCREEN_RECORDING
+            ? 'mock_screen_recording'
+            : TRACE_INFO[expectedType].name,
+        );
+        icon.dispatchEvent(new Event('mouseleave'));
+        fixture.detectChanges();
+      });
+
+    matOptions.item(2).click();
     fixture.detectChanges();
     expectSelectedTraceTypes(allTraceTypes);
     const newIcons = htmlElement.querySelectorAll(
@@ -387,12 +386,23 @@ describe('TimelineComponent', () => {
       Array.from(newIcons)
         .map((icon) => icon.textContent?.trim())
         .slice(1),
-    ).toEqual([
-      TRACE_INFO[TraceType.SCREEN_RECORDING].icon,
-      TRACE_INFO[TraceType.SURFACE_FLINGER].icon,
-      TRACE_INFO[TraceType.WINDOW_MANAGER].icon,
-      TRACE_INFO[TraceType.PROTO_LOG].icon,
-    ]);
+    ).toEqual(allTraceTypes.map((type) => TRACE_INFO[type].icon));
+  });
+
+  it('update name and disables option for dumps', async () => {
+    loadAllTraces(component, fixture, false);
+    await openSelectPanel();
+
+    const matOptions =
+      document.documentElement.querySelectorAll<HTMLInputElement>('mat-option'); // [WM, SF, SR, ProtoLog]
+
+    for (const i of [0, 2]) {
+      expect(matOptions.item(i).ariaDisabled).toEqual('false');
+    }
+    for (const i of [1, 3]) {
+      expect(matOptions.item(i).ariaDisabled).toEqual('true');
+    }
+    expect(matOptions.item(3).textContent).toContain('ProtoLog Dump');
   });
 
   it('next button disabled if no next entry', () => {
@@ -469,8 +479,8 @@ describe('TimelineComponent', () => {
         ?.timestamp.getValueNs(),
     ).toEqual(100n);
     const nextEntryButton = assertDefined(
-      htmlElement.querySelector('#next_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#next_entry_button'),
+    );
 
     testCurrentTimestampOnButtonClick(nextEntryButton, position105, 110n);
 
@@ -494,8 +504,8 @@ describe('TimelineComponent', () => {
         ?.timestamp.getValueNs(),
     ).toEqual(100n);
     const prevEntryButton = assertDefined(
-      htmlElement.querySelector('#prev_entry_button'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('#prev_entry_button'),
+    );
 
     // In this state we are already on the first entry at timestamp 100, so
     // there is no entry to move to before and we just don't update the timestamp
@@ -554,8 +564,8 @@ describe('TimelineComponent', () => {
     ).toEqual(100n);
 
     const timeInputField = assertDefined(
-      document.querySelector('.time-input.nano'),
-    ) as HTMLInputElement;
+      document.querySelector<HTMLInputElement>('.time-input.nano'),
+    );
 
     testCurrentTimestampOnTimeInput(
       timeInputField,
@@ -600,8 +610,8 @@ describe('TimelineComponent', () => {
     ).toEqual(100n);
 
     const timeInputField = assertDefined(
-      document.querySelector('.time-input.human'),
-    ) as HTMLInputElement;
+      document.querySelector<HTMLInputElement>('.time-input.human'),
+    );
 
     testCurrentTimestampOnTimeInput(
       timeInputField,
@@ -651,8 +661,8 @@ describe('TimelineComponent', () => {
     ).toEqual(100n);
 
     const timeInputField = assertDefined(
-      document.querySelector('.time-input.human'),
-    ) as HTMLInputElement;
+      document.querySelector<HTMLInputElement>('.time-input.human'),
+    );
 
     testCurrentTimestampOnTimeInput(
       timeInputField,
@@ -672,8 +682,8 @@ describe('TimelineComponent', () => {
     ).toEqual(100n);
 
     const timeInputField = assertDefined(
-      document.querySelector('.time-input.human'),
-    ) as HTMLInputElement;
+      document.querySelector<HTMLInputElement>('.time-input.human'),
+    );
 
     testCurrentTimestampOnTimeInput(
       timeInputField,
@@ -740,6 +750,63 @@ describe('TimelineComponent', () => {
     );
   });
 
+  it('does not apply stored trace deselection on active trace', async () => {
+    loadAllTraces();
+    const firstTimeline = assertDefined(component.timeline);
+    expectSelectedTraceTypes(
+      [
+        TraceType.SCREEN_RECORDING,
+        TraceType.SURFACE_FLINGER,
+        TraceType.WINDOW_MANAGER,
+        TraceType.PROTO_LOG,
+      ],
+      firstTimeline,
+    );
+    await updateActiveTrace(TraceType.PROTO_LOG);
+    await openSelectPanel();
+    clickTraceFromSelectPanel(1);
+    expectSelectedTraceTypes(
+      [
+        TraceType.SCREEN_RECORDING,
+        TraceType.WINDOW_MANAGER,
+        TraceType.PROTO_LOG,
+      ],
+      firstTimeline,
+    );
+
+    const secondFixture = TestBed.createComponent(TestHostComponent);
+    const secondHost = secondFixture.componentInstance;
+    loadAllTraces(secondHost, secondFixture);
+    const secondTimeline = assertDefined(secondHost.timeline);
+    expectSelectedTraceTypes(
+      [
+        TraceType.SCREEN_RECORDING,
+        TraceType.SURFACE_FLINGER,
+        TraceType.WINDOW_MANAGER,
+        TraceType.PROTO_LOG,
+      ],
+      secondTimeline,
+    );
+  });
+
+  it('does not apply stored trace deselection if only one timestamp available', async () => {
+    loadAllTraces();
+    await updateActiveTrace(TraceType.PROTO_LOG);
+    await openSelectPanel();
+    clickTraceFromSelectPanel(2);
+
+    const secondFixture = TestBed.createComponent(TestHostComponent);
+    const secondHost = secondFixture.componentInstance;
+    const secondElement = secondFixture.nativeElement;
+    await loadTracesWithOneTimestamp(secondHost, secondFixture);
+
+    const shownSelection = assertDefined(
+      secondElement.querySelector('#trace-selector .shown-selection'),
+    );
+    expect(shownSelection.innerHTML).toContain('Window Manager');
+    expect(shownSelection.textContent).not.toContain('Surface Flinger');
+  });
+
   it('does not store traces based on active view trace type', async () => {
     loadAllTraces();
     expectSelectedTraceTypes(
@@ -863,8 +930,8 @@ describe('TimelineComponent', () => {
     expect(timelineComponent.currentPositionBookmarked()).toBeFalse();
 
     const bookmarkIcon = assertDefined(
-      htmlElement.querySelector('.bookmark-icon'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('.bookmark-icon'),
+    );
     bookmarkIcon.click();
     fixture.detectChanges();
 
@@ -922,6 +989,42 @@ describe('TimelineComponent', () => {
     expect(timelineComponent.bookmarks).toEqual([]);
   });
 
+  it('updates active trace then trace position on mini timeline click', async () => {
+    loadAllTraces();
+    const timelineComponent = assertDefined(component.timeline);
+
+    let firstEvent: WinscopeEvent | undefined;
+    let activeTrace: Trace<object> | undefined;
+    let position: TracePosition | undefined;
+    timelineComponent.setEmitEvent(async (event: WinscopeEvent) => {
+      if (!firstEvent) {
+        expect(event).toBeInstanceOf(ActiveTraceChanged);
+        firstEvent = event;
+        activeTrace = (event as ActiveTraceChanged).trace;
+      } else {
+        expect(event).toBeInstanceOf(TracePositionUpdate);
+        position = (event as TracePositionUpdate).position;
+      }
+    });
+    const miniTimelineComponent = assertDefined(timelineComponent.miniTimeline);
+    const trace = assertDefined(
+      component.timelineData.getTraces().getTrace(TraceType.WINDOW_MANAGER),
+    );
+    spyOn(
+      assertDefined(miniTimelineComponent.drawer),
+      'getTraceClicked',
+    ).and.returnValue(Promise.resolve(trace));
+    const canvas = miniTimelineComponent.getCanvas();
+    canvas.dispatchEvent(new MouseEvent('mousedown'));
+    fixture.detectChanges();
+    await fixture.whenStable();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(activeTrace).toEqual(trace);
+    expect(position).toBeDefined();
+  });
+
   function loadSfWmTraces(hostComponent = component, hostFixture = fixture) {
     const traces = new TracesBuilder()
       .setTimestamps(TraceType.SURFACE_FLINGER, [time100, time110])
@@ -940,10 +1043,15 @@ describe('TimelineComponent', () => {
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
     );
     timelineData.setPosition(position100);
+    hostComponent.allTraces = hostComponent.timelineData.getTraces();
     hostFixture.detectChanges();
   }
 
-  function loadAllTraces(hostComponent = component, hostFixture = fixture) {
+  function loadAllTraces(
+    hostComponent = component,
+    hostFixture = fixture,
+    loadAllTraces = true,
+  ) {
     const traces = new TracesBuilder()
       .setTimestamps(TraceType.SURFACE_FLINGER, [time100, time110])
       .setTimestamps(TraceType.WINDOW_MANAGER, [
@@ -952,15 +1060,32 @@ describe('TimelineComponent', () => {
         time110,
         time112,
       ])
-      .setTimestamps(TraceType.SCREEN_RECORDING, [time110])
+      .setTimestamps(
+        TraceType.SCREEN_RECORDING,
+        [time110],
+        ['mock_screen_recording'],
+      )
       .setTimestamps(TraceType.PROTO_LOG, [time100])
       .build();
 
+    let timelineDataTraces: Traces | undefined;
+    if (loadAllTraces) {
+      timelineDataTraces = traces;
+    } else {
+      timelineDataTraces = new Traces();
+      traces.forEachTrace((trace) => {
+        if (trace.type !== TraceType.PROTO_LOG) {
+          assertDefined(timelineDataTraces).addTrace(trace);
+        }
+      });
+    }
+
     assertDefined(hostComponent.timelineData).initialize(
-      traces,
+      timelineDataTraces,
       undefined,
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
     );
+    hostComponent.allTraces = traces;
     hostFixture.detectChanges();
   }
 
@@ -987,6 +1112,7 @@ describe('TimelineComponent', () => {
       TimestampConverterUtils.TIMESTAMP_CONVERTER,
     );
     timelineData.setPosition(position100);
+    component.allTraces = timelineData.getTraces();
     fixture.detectChanges();
   }
 
@@ -998,6 +1124,25 @@ describe('TimelineComponent', () => {
     return trace;
   }
 
+  async function loadTracesWithOneTimestamp(
+    hostComponent = component,
+    hostFixture = fixture,
+  ) {
+    const traces = new TracesBuilder()
+      .setTimestamps(TraceType.SURFACE_FLINGER, [])
+      .setTimestamps(TraceType.WINDOW_MANAGER, [time100])
+      .build();
+    assertDefined(hostComponent.timelineData).initialize(
+      traces,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    hostComponent.allTraces = traces;
+    hostFixture.detectChanges();
+    await hostFixture.whenStable();
+    hostFixture.detectChanges();
+  }
+
   async function updateActiveTrace(type: TraceType) {
     const trace = getLoadedTrace(type);
     const timelineData = assertDefined(component.timelineData);
@@ -1052,18 +1197,18 @@ describe('TimelineComponent', () => {
 
   async function openSelectPanel() {
     const selectTrigger = assertDefined(
-      htmlElement.querySelector('.mat-select-trigger'),
+      htmlElement.querySelector<HTMLElement>('.mat-select-trigger'),
     );
-    (selectTrigger as HTMLElement).click();
+    selectTrigger.click();
     fixture.detectChanges();
     await fixture.whenStable();
   }
 
   function clickTraceFromSelectPanel(index: number) {
     const matOptions = assertDefined(
-      document.documentElement.querySelectorAll('mat-option'),
+      document.documentElement.querySelectorAll<HTMLElement>('mat-option'),
     );
-    (matOptions.item(index) as HTMLElement).click();
+    matOptions.item(index).click();
     fixture.detectChanges();
   }
 
@@ -1102,38 +1247,70 @@ describe('TimelineComponent', () => {
     expect(nextEntryButton.getAttribute('disabled')).toEqual('true');
   }
 
+  function checkNoTimelineNavigation() {
+    const timelineComponent = assertDefined(component.timeline);
+    // no expand button
+    expect(
+      htmlElement.querySelector(`.${timelineComponent.TOGGLE_BUTTON_CLASS}`),
+    ).toBeNull();
+
+    // no timelines shown
+    const miniTimelineElement = fixture.debugElement.query(
+      By.directive(MiniTimelineComponent),
+    );
+    expect(miniTimelineElement).toBeFalsy();
+
+    // arrow key presses don't do anything
+    const spyNextEntry = spyOn(timelineComponent, 'moveToNextEntry');
+    const spyPrevEntry = spyOn(timelineComponent, 'moveToPreviousEntry');
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}));
+    fixture.detectChanges();
+    expect(spyNextEntry).not.toHaveBeenCalled();
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}));
+    fixture.detectChanges();
+    expect(spyPrevEntry).not.toHaveBeenCalled();
+  }
+
   function openContextMenu(xOffset = 0, clickBelowMarker = false) {
     const miniTimelineCanvas = assertDefined(
-      htmlElement.querySelector('#mini-timeline-canvas'),
-    ) as HTMLElement;
-    const clickPosX =
+      htmlElement.querySelector<HTMLElement>('#mini-timeline-canvas'),
+    );
+    const yOffset = clickBelowMarker
+      ? assertDefined(component.timeline?.miniTimeline?.drawer?.getHeight()) /
+          6 +
+        1
+      : 0;
+
+    const event = new MouseEvent('contextmenu');
+    spyOnProperty(event, 'offsetX').and.returnValue(
       miniTimelineCanvas.offsetLeft +
-      miniTimelineCanvas.offsetWidth / 2 +
-      xOffset;
-    const clickPosY =
-      miniTimelineCanvas.offsetTop + (clickBelowMarker ? 1000 : 0);
-    miniTimelineCanvas.dispatchEvent(
-      new MouseEvent('contextmenu', {
-        clientX: clickPosX,
-        clientY: clickPosY,
-      }),
+        miniTimelineCanvas.offsetWidth / 2 +
+        xOffset,
+    );
+    spyOnProperty(event, 'offsetY').and.returnValue(
+      miniTimelineCanvas.offsetTop + yOffset,
     );
+    miniTimelineCanvas.dispatchEvent(event);
     fixture.detectChanges();
   }
 
   function clickToggleBookmarkOption() {
     const menu = assertDefined(document.querySelector('.context-menu'));
     const toggleOption = assertDefined(
-      menu.querySelector('.context-menu-item'),
-    ) as HTMLElement;
+      menu.querySelector<HTMLElement>('.context-menu-item'),
+    );
     toggleOption.click();
     fixture.detectChanges();
   }
 
   function clickRemoveAllBookmarksOption() {
     const menu = assertDefined(document.querySelector('.context-menu'));
-    const options = assertDefined(menu.querySelectorAll('.context-menu-item'));
-    (options.item(1) as HTMLElement).click();
+    const options = assertDefined(
+      menu.querySelectorAll<HTMLElement>('.context-menu-item'),
+    );
+    options.item(1).click();
     fixture.detectChanges();
   }
 
@@ -1141,12 +1318,14 @@ describe('TimelineComponent', () => {
     selector: 'host-component',
     template: `
       <timeline
+        [allTraces]="allTraces"
         [timelineData]="timelineData"
         [store]="store"></timeline>
     `,
   })
   class TestHostComponent {
     timelineData = new TimelineData();
+    allTraces = new Traces();
     store = new PersistentStore();
 
     @ViewChild(TimelineComponent)
diff --git a/tools/winscope/src/app/components/timeline/timeline_utils.ts b/tools/winscope/src/app/components/timeline/timeline_utils.ts
index a024152bf..bf4094671 100644
--- a/tools/winscope/src/app/components/timeline/timeline_utils.ts
+++ b/tools/winscope/src/app/components/timeline/timeline_utils.ts
@@ -14,11 +14,32 @@
  * limitations under the License.
  */
 
+import {assertDefined} from 'common/assert_utils';
 import {TimeRange, Timestamp} from 'common/time';
 import {ComponentTimestampConverter} from 'common/timestamp_converter';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
 export class TimelineUtils {
+  static isTransitionWithUnknownStart(transition: PropertyTreeNode): boolean {
+    const shellData = transition.getChildByName('shellData');
+    const dispatchTimestamp: Timestamp | undefined = shellData
+      ?.getChildByName('dispatchTimeNs')
+      ?.getValue();
+    return dispatchTimestamp === undefined;
+  }
+
+  static isTransitionWithUnknownEnd(transition: PropertyTreeNode): boolean {
+    const shellData = transition.getChildByName('shellData');
+    const wmData = transition.getChildByName('wmData');
+    const aborted: boolean = assertDefined(
+      transition.getChildByName('aborted'),
+    ).getValue();
+    const finishOrAbortTimestamp: Timestamp | undefined = aborted
+      ? shellData?.getChildByName('abortTimeNs')?.getValue()
+      : wmData?.getChildByName('finishTimeNs')?.getValue();
+    return finishOrAbortTimestamp === undefined;
+  }
+
   static getTimeRangeForTransition(
     transition: PropertyTreeNode,
     fullTimeRange: TimeRange,
@@ -27,7 +48,9 @@ export class TimelineUtils {
     const shellData = transition.getChildByName('shellData');
     const wmData = transition.getChildByName('wmData');
 
-    const aborted = transition.getChildByName('aborted')?.getValue() ?? false;
+    const aborted: boolean = assertDefined(
+      transition.getChildByName('aborted'),
+    ).getValue();
 
     const dispatchTimestamp: Timestamp | undefined = shellData
       ?.getChildByName('dispatchTimeNs')
@@ -53,12 +76,35 @@ export class TimelineUtils {
     const timeRangeMin = fullTimeRange.from.getValueNs();
     const timeRangeMax = fullTimeRange.to.getValueNs();
 
+    if (
+      finishOrAbortTimestamp &&
+      finishOrAbortTimestamp.getValueNs() < timeRangeMin
+    ) {
+      return undefined;
+    }
+
+    if (
+      !finishOrAbortTimestamp &&
+      assertDefined(dispatchTimestamp).getValueNs() < timeRangeMin
+    ) {
+      return undefined;
+    }
+
+    if (
+      dispatchTimestamp &&
+      finishOrAbortTimestamp &&
+      dispatchTimestamp.getValueNs() > timeRangeMax
+    ) {
+      return undefined;
+    }
+
     const dispatchTimeNs = dispatchTimestamp
       ? dispatchTimestamp.getValueNs()
-      : timeRangeMin;
+      : assertDefined(finishOrAbortTimestamp).getValueNs() - 1n;
+
     const finishTimeNs = finishOrAbortTimestamp
       ? finishOrAbortTimestamp.getValueNs()
-      : timeRangeMax;
+      : dispatchTimeNs + 1n;
 
     const startTime = converter.makeTimestampFromNs(
       dispatchTimeNs > timeRangeMin ? dispatchTimeNs : timeRangeMin,
@@ -67,4 +113,26 @@ export class TimelineUtils {
 
     return new TimeRange(startTime, finishTime);
   }
+
+  static convertHexToRgb(
+    hex: string,
+  ): {r: number; g: number; b: number} | undefined {
+    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
+    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
+    hex = hex.replace(shorthandRegex, (m, r, g, b) => {
+      return r + r + g + g + b + b;
+    });
+
+    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
+    return result
+      ? {
+          // tslint:disable-next-line:ban
+          r: parseInt(result[1], 16),
+          // tslint:disable-next-line:ban
+          g: parseInt(result[2], 16),
+          // tslint:disable-next-line:ban
+          b: parseInt(result[3], 16),
+        }
+      : undefined;
+  }
 }
diff --git a/tools/winscope/src/app/components/trace_config_component.ts b/tools/winscope/src/app/components/trace_config_component.ts
index 26e7d9323..3cc5938df 100644
--- a/tools/winscope/src/app/components/trace_config_component.ts
+++ b/tools/winscope/src/app/components/trace_config_component.ts
@@ -13,76 +13,122 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {Component, EventEmitter, Input, Output} from '@angular/core';
+import {
+  ChangeDetectorRef,
+  Component,
+  EventEmitter,
+  Inject,
+  Input,
+  NgZone,
+  Output,
+} from '@angular/core';
+import {MatSelect, MatSelectChange} from '@angular/material/select';
 import {assertDefined} from 'common/assert_utils';
+import {globalConfig} from 'common/global_config';
+import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {
   EnableConfiguration,
   SelectionConfiguration,
-  TraceConfiguration,
   TraceConfigurationMap,
-} from 'trace_collection/trace_collection_utils';
+} from 'trace_collection/trace_configuration';
+import {userOptionStyle} from 'viewers/components/styles/user_option.styles';
 
 @Component({
   selector: 'trace-config',
   template: `
-    <h3 class="mat-subheading-2">Trace targets</h3>
+    <h3 class="mat-subheading-2">{{title}}</h3>
 
-    <div class="checkboxes">
+    <div class="checkboxes" [style.height]="getTraceCheckboxContainerHeight()">
       <mat-checkbox
-        *ngFor="let traceKey of objectKeys(this.traceConfig)"
+        *ngFor="let traceKey of getSortedTraceKeys()"
         color="primary"
         class="trace-checkbox"
-        [checked]="this.traceConfig[traceKey].run"
-        (change)="changeRunTrace($event.checked, this.traceConfig[traceKey])"
-        >{{ this.traceConfig[traceKey].name }}</mat-checkbox
-      >
+        [disabled]="!this.traceConfig[traceKey].available"
+        [(ngModel)]="this.traceConfig[traceKey].enabled"
+        (ngModelChange)="onTraceConfigChange()"
+        >{{ this.traceConfig[traceKey].name }}</mat-checkbox>
     </div>
 
-    <ng-container *ngFor="let traceKey of advancedConfigTraces()">
+    <ng-container *ngFor="let traceKey of getSortedConfigKeys()">
       <mat-divider></mat-divider>
 
-      <h3 class="mat-subheading-2">{{ this.traceConfig[traceKey].name }} configuration</h3>
+      <h3 class="config-heading mat-subheading-2">{{ this.traceConfig[traceKey].name }} configuration</h3>
 
       <div
-        *ngIf="this.traceConfig[traceKey].config?.enableConfigs.length > 0"
+        *ngIf="this.traceConfig[traceKey].config && this.traceConfig[traceKey].config.enableConfigs.length > 0"
         class="enable-config-opt">
         <mat-checkbox
-          *ngFor="let enableConfig of traceEnableConfigs(this.traceConfig[traceKey])"
+          *ngFor="let enableConfig of getSortedConfigs(this.traceConfig[traceKey].config.enableConfigs)"
           color="primary"
           class="enable-config"
-          [disabled]="!this.traceConfig[traceKey].run"
+          [disabled]="!this.traceConfig[traceKey].enabled"
           [(ngModel)]="enableConfig.enabled"
+          (ngModelChange)="onTraceConfigChange()"
           >{{ enableConfig.name }}</mat-checkbox
         >
       </div>
 
       <div
-        *ngIf="this.traceConfig[traceKey].config?.selectionConfigs.length > 0"
+        *ngIf="this.traceConfig[traceKey].config && this.traceConfig[traceKey].config.selectionConfigs.length > 0"
         class="selection-config-opt">
-        <mat-form-field
-          *ngFor="let selectionConfig of traceSelectionConfigs(this.traceConfig[traceKey])"
-          class="config-selection"
-          appearance="fill">
-          <mat-label>{{ selectionConfig.name }}</mat-label>
-
-          <mat-select
-            class="selected-value"
-            [(value)]="selectionConfig.value"
-            [disabled]="!this.traceConfig[traceKey].run">
-            <mat-option *ngFor="let option of selectionConfig.options" value="{{ option }}">{{
-              option
-            }}</mat-option>
-          </mat-select>
-        </mat-form-field>
+        <ng-container *ngFor="let selectionConfig of getSortedConfigs(this.traceConfig[traceKey].config.selectionConfigs)">
+          <div class="config-selection-with-desc" [class.wide-field]="selectionConfig.wideField">
+            <mat-form-field
+              class="config-selection"
+              [class.wide-field]="selectionConfig.wideField"
+              appearance="fill">
+              <mat-label>{{ selectionConfig.name }}</mat-label>
+
+              <mat-select
+                #matSelect
+                [multiple]="isMultipleSelect(selectionConfig)"
+                disableOptionCentering
+                class="selected-value"
+                [attr.label]="traceKey + selectionConfig.name"
+                [value]="selectionConfig.value"
+                [disabled]="!this.traceConfig[traceKey].enabled || selectionConfig.options.length === 0"
+                (selectionChange)="onSelectChange($event, selectionConfig)">
+                <span class="mat-option" *ngIf="matSelect.multiple || selectionConfig.optional">
+                  <button
+                    *ngIf="matSelect.multiple"
+                    mat-flat-button
+                    class="user-option"
+                    [color]="matSelect.value.length === selectionConfig.options.length ? 'primary' : undefined"
+                    [class.not-enabled]="matSelect.value.length !== selectionConfig.options.length"
+                    (click)="onAllButtonClick(matSelect, selectionConfig)"> All </button>
+                  <button
+                    *ngIf="selectionConfig.optional && !matSelect.multiple"
+                    mat-flat-button
+                    class="user-option"
+                    [color]="matSelect.value.length === 0 ? 'primary' : undefined"
+                    [class.not-enabled]="matSelect.value.length > 0"
+                    (click)="onNoneButtonClick(matSelect, selectionConfig)"> None </button>
+                </span>
+                <mat-option
+                  *ngFor="let option of selectionConfig.options"
+                  (click)="onOptionClick(matSelect, option, traceKey + selectionConfig.name)"
+                  [value]="option"
+                  (mouseenter)="onSelectOptionHover($event, option)"
+                  [matTooltip]="option"
+                  [matTooltipDisabled]="disableOptionTooltip(option, optionEl)"
+                  matTooltipPosition="right">
+                    <span #optionEl> {{ option }} </span>
+                </mat-option>
+              </mat-select>
+            </mat-form-field>
+            <span class="config-desc" *ngIf="selectionConfig.desc"> {{selectionConfig.desc}} </span>
+          </div>
+        </ng-container>
       </div>
     </ng-container>
   `,
   styles: [
     `
       .checkboxes {
-        display: grid;
-        grid-template-columns: repeat(3, 1fr);
-        column-gap: 10px;
+        display: flex;
+        flex-direction: column;
+        flex-wrap: wrap;
       }
       .enable-config-opt,
       .selection-config-opt {
@@ -91,50 +137,155 @@ import {
         flex-wrap: wrap;
         gap: 10px;
       }
+      .config-selection-with-desc {
+        display: flex;
+        flex-direction: column;
+      }
+      .wide-field {
+        width: 100%;
+      }
+      .config-panel {
+        position: absolute;
+        left: 0px;
+        top: 100px;
+      }
     `,
+    userOptionStyle,
   ],
 })
 export class TraceConfigComponent {
-  objectKeys = Object.keys;
+  changeDetectionWorker: number | undefined;
+  traceConfig: TraceConfigurationMap | undefined;
 
-  @Input() traceConfig: TraceConfigurationMap | undefined;
+  @Input() title: string | undefined;
+  @Input() traceConfigStoreKey: string | undefined;
+  @Input() initialTraceConfig: TraceConfigurationMap | undefined;
+  @Input() storage: Store | undefined;
   @Output() readonly traceConfigChange =
     new EventEmitter<TraceConfigurationMap>();
 
-  advancedConfigTraces() {
+  private tooltipsWithStablePosition = new Set<string>();
+
+  constructor(
+    @Inject(ChangeDetectorRef) private changeDetectorRef: ChangeDetectorRef,
+    @Inject(NgZone) private ngZone: NgZone,
+  ) {}
+
+  ngOnInit() {
+    this.traceConfig = PersistentStoreProxy.new<TraceConfigurationMap>(
+      assertDefined(this.traceConfigStoreKey),
+      assertDefined(
+        JSON.parse(JSON.stringify(assertDefined(this.initialTraceConfig))),
+        () => 'component initialized without config',
+      ),
+      assertDefined(this.storage),
+    );
+    if (globalConfig.MODE !== 'KARMA_TEST') {
+      this.changeDetectionWorker = window.setInterval(
+        () => this.changeDetectorRef.detectChanges(),
+        200,
+      );
+    }
+    this.traceConfigChange.emit(this.traceConfig);
+  }
+
+  ngOnDestroy() {
+    window.clearInterval(this.changeDetectionWorker);
+  }
+
+  getTraceCheckboxContainerHeight(): string {
+    const config = assertDefined(this.traceConfig);
+    return Math.ceil(Object.keys(config).length / 3) * 24 + 'px';
+  }
+
+  getSortedTraceKeys(): string[] {
+    const config = assertDefined(this.traceConfig);
+    return Object.keys(config).sort((a, b) => {
+      return config[a].name < config[b].name ? -1 : 1;
+    });
+  }
+
+  getSortedConfigKeys(): string[] {
     const advancedConfigs: string[] = [];
     Object.keys(assertDefined(this.traceConfig)).forEach((traceKey: string) => {
       if (assertDefined(this.traceConfig)[traceKey].config) {
         advancedConfigs.push(traceKey);
       }
     });
-    return advancedConfigs;
+    return advancedConfigs.sort();
   }
 
-  traceEnableConfigs(trace: TraceConfiguration): EnableConfiguration[] {
-    if (trace.config) {
-      return trace.config.enableConfigs;
-    } else {
-      return [];
-    }
+  getSortedConfigs(
+    configs: EnableConfiguration[] | SelectionConfiguration[],
+  ): EnableConfiguration[] | SelectionConfiguration[] {
+    return configs.sort((a, b) => {
+      return a.name < b.name ? -1 : 1;
+    });
   }
 
-  traceSelectionConfigs(trace: TraceConfiguration): SelectionConfiguration[] {
-    if (trace.config) {
-      return trace.config.selectionConfigs;
-    } else {
-      return [];
+  onSelectOptionHover(event: MouseEvent, option: string) {
+    if (this.tooltipsWithStablePosition.has(option)) {
+      return;
     }
+    this.ngZone.run(() => {
+      (event.target as HTMLElement).dispatchEvent(new Event('mouseleave'));
+      this.tooltipsWithStablePosition.add(option);
+      this.changeDetectorRef.detectChanges();
+      (event.target as HTMLElement).dispatchEvent(new Event('mouseenter'));
+    });
   }
 
-  someTraces(trace: TraceConfiguration): boolean {
+  disableOptionTooltip(option: string, optionText: HTMLElement): boolean {
+    const optionEl = assertDefined(optionText.parentElement);
     return (
-      !trace.run &&
-      this.traceEnableConfigs(trace).filter((trace) => trace.enabled).length > 0
+      !this.tooltipsWithStablePosition.has(option) ||
+      optionEl.offsetWidth >= optionText.offsetWidth
     );
   }
 
-  changeRunTrace(run: boolean, trace: TraceConfiguration): void {
-    trace.run = run;
+  onSelectChange(event: MatSelectChange, config: SelectionConfiguration) {
+    config.value = event.value;
+    if (!event.source.multiple) {
+      event.source.close();
+    }
+    this.onTraceConfigChange();
+  }
+
+  onNoneButtonClick(select: MatSelect, config: SelectionConfiguration) {
+    if (config.value.length > 0) {
+      select.value = '';
+      config.value = '';
+      this.onTraceConfigChange();
+    }
+  }
+
+  onAllButtonClick(select: MatSelect, config: SelectionConfiguration) {
+    if (config.value.length !== config.options.length) {
+      config.value = config.options;
+      select.value = config.options;
+    } else {
+      config.value = [];
+      select.value = [];
+    }
+    this.onTraceConfigChange();
+  }
+
+  onOptionClick(select: MatSelect, option: string, configName: string) {
+    if (select.value === option) {
+      const selectElement = assertDefined(
+        document.querySelector<HTMLElement>(
+          `mat-select[label="${configName}"]`,
+        ),
+      );
+      selectElement.blur();
+    }
+  }
+
+  onTraceConfigChange() {
+    this.traceConfigChange.emit(this.traceConfig);
+  }
+
+  isMultipleSelect(config: SelectionConfiguration): boolean {
+    return Array.isArray(config.value);
   }
 }
diff --git a/tools/winscope/src/app/components/trace_config_component_test.ts b/tools/winscope/src/app/components/trace_config_component_test.ts
index 5eacb54b8..9e40d90ac 100644
--- a/tools/winscope/src/app/components/trace_config_component_test.ts
+++ b/tools/winscope/src/app/components/trace_config_component_test.ts
@@ -14,21 +14,27 @@
  * limitations under the License.
  */
 import {CommonModule} from '@angular/common';
-import {NO_ERRORS_SCHEMA} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {FormsModule, ReactiveFormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
 import {MatCheckboxModule} from '@angular/material/checkbox';
 import {MatDividerModule} from '@angular/material/divider';
 import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatInputModule} from '@angular/material/input';
 import {MatSelectModule} from '@angular/material/select';
+import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {Store} from 'common/store';
+import {TraceType} from 'trace/trace_type';
 import {TraceConfigComponent} from './trace_config_component';
 
 describe('TraceConfigComponent', () => {
   let fixture: ComponentFixture<TraceConfigComponent>;
   let component: TraceConfigComponent;
   let htmlElement: HTMLElement;
+  let configChangeSpy: jasmine.Spy;
 
   beforeEach(async () => {
     await TestBed.configureTestingModule({
@@ -40,59 +46,151 @@ describe('TraceConfigComponent', () => {
         MatInputModule,
         MatSelectModule,
         BrowserAnimationsModule,
+        FormsModule,
+        ReactiveFormsModule,
+        MatTooltipModule,
+        MatButtonModule,
       ],
       declarations: [TraceConfigComponent],
-      schemas: [NO_ERRORS_SCHEMA],
     }).compileComponents();
     fixture = TestBed.createComponent(TraceConfigComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
-    component.traceConfig = {
-      layers_trace: {
-        name: 'layers_trace',
-        run: false,
-        config: {
-          enableConfigs: [
-            {
-              name: 'trace buffers',
-              key: 'tracebuffers',
-              enabled: true,
-            },
-          ],
-          selectionConfigs: [
-            {
-              key: 'tracinglevel',
-              name: 'tracing level',
-              options: ['verbose', 'debug', 'critical'],
-              value: 'debug',
-            },
-          ],
-        },
-      },
-    };
-    fixture.detectChanges();
+    configChangeSpy = spyOn(component.traceConfigChange, 'emit');
+    await setComponentInputs(component);
   });
 
   it('can be created', () => {
     expect(component).toBeTruthy();
   });
 
-  it('check that trace checkbox ticked on default run', () => {
-    assertDefined(component.traceConfig)['layers_trace'].run = true;
+  it('displays config alphabetically by name', () => {
+    expect(
+      Array.from(
+        htmlElement.querySelectorAll<HTMLElement>('.trace-checkbox'),
+      ).map((box) => box.textContent?.trim()),
+    ).toEqual([
+      'layers_trace',
+      'multiple_selection_trace',
+      'optional_multiple_selection_trace',
+      'optional_selection_trace',
+      'unavailable_trace',
+      'window_trace',
+    ]);
+  });
+
+  it('displays advanced config alphabetically by name', () => {
+    expect(
+      Array.from(
+        htmlElement.querySelectorAll<HTMLElement>('.config-heading'),
+      ).map((box) => box.textContent?.trim()),
+    ).toEqual([
+      'layers_trace configuration',
+      'multiple_selection_trace configuration',
+      'optional_multiple_selection_trace configuration',
+      'optional_selection_trace configuration',
+    ]);
+  });
+
+  it('applies stored config and emits event on init', async () => {
+    expect(
+      assertDefined(component.traceConfig)['layers_trace'].enabled,
+    ).toBeTrue();
+    const inputElement = assertDefined(
+      htmlElement.querySelector<HTMLInputElement>('.trace-checkbox input'),
+    );
+    inputElement.click();
+    fixture.detectChanges();
+    expect(
+      assertDefined(component.traceConfig)['layers_trace'].enabled,
+    ).toBeFalse();
+
+    const newFixture = TestBed.createComponent(TraceConfigComponent);
+    const newComponent = newFixture.componentInstance;
+    const spy = spyOn(newComponent.traceConfigChange, 'emit');
+    await setComponentInputs(
+      newComponent,
+      newFixture,
+      assertDefined(component.storage),
+    );
+    expect(spy).toHaveBeenCalledTimes(1);
+    expect(
+      assertDefined(newComponent.traceConfig)['layers_trace'].enabled,
+    ).toBeFalse();
+  });
+
+  it('handles proxy initial trace config', async () => {
+    const newFixture = TestBed.createComponent(TraceConfigComponent);
+    const newComponent = newFixture.componentInstance;
+    const spy = spyOn(newComponent.traceConfigChange, 'emit');
+
+    newComponent.title = 'Targets';
+    newComponent.initialTraceConfig = component.traceConfig;
+    newComponent.traceConfigStoreKey = 'TestConfigSettings';
+    newComponent.storage = component.storage;
+    await detectNgModelChanges(newFixture);
+    newFixture.detectChanges();
+
+    expect(spy).toHaveBeenCalledTimes(1);
+  });
+
+  it('trace checkbox enabled by default', () => {
+    const traceKey = 'layers_trace';
+    configChangeSpy.calls.reset();
+    const config = assertDefined(component.traceConfig);
+
+    const box = getTraceBoxForKey('layers_trace');
+    const inputElement = assertDefined(
+      box.querySelector<HTMLInputElement>('input'),
+    );
+
+    expect(box.textContent).toContain(traceKey);
+    expect(inputElement.checked).toBeTrue();
+    expect(inputElement.ariaChecked).toEqual('true');
+    expect(config[traceKey].enabled).toBeTrue();
+
+    inputElement.click();
     fixture.detectChanges();
-    const box = assertDefined(htmlElement.querySelector('.trace-checkbox'));
-    expect(box.innerHTML).toContain('aria-checked="true"');
-    expect(box.innerHTML).toContain('layers_trace');
+    expect(inputElement.checked).toBeFalse();
+    expect(inputElement.ariaChecked).toEqual('false');
+    expect(config[traceKey].enabled).toBeFalse();
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
   });
 
-  it('check that trace checkbox not ticked on default run', () => {
-    assertDefined(component.traceConfig)['layers_trace'].run = false;
+  it('trace checkbox not enabled by default', () => {
+    const traceKey = 'window_trace';
+    configChangeSpy.calls.reset();
+    const config = assertDefined(component.traceConfig);
+
+    const box = getTraceBoxForKey(traceKey);
+    const inputElement = assertDefined(
+      box.querySelector<HTMLInputElement>('input'),
+    );
+
+    expect(box.textContent).toContain(traceKey);
+    expect(inputElement.checked).toBeFalse();
+    expect(inputElement.ariaChecked).toEqual('false');
+    expect(config[traceKey].enabled).toBeFalse();
+
+    inputElement.click();
     fixture.detectChanges();
-    const box = assertDefined(htmlElement.querySelector('.trace-checkbox'));
-    expect(box.innerHTML).toContain('aria-checked="false"');
+    expect(inputElement.checked).toBeTrue();
+    expect(inputElement.ariaChecked).toEqual('true');
+    expect(config[traceKey].enabled).toBeTrue();
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
+  });
+
+  it('disables checkbox for unavailable trace', () => {
+    const traceKey = 'unavailable_trace';
+    const box = getTraceBoxForKey(traceKey);
+    const inputElement = assertDefined(
+      box.querySelector<HTMLInputElement>('input'),
+    );
+    expect(inputElement.disabled).toBeTrue();
+    expect(box.textContent).toContain(traceKey);
   });
 
-  it('check that advanced configs show', () => {
+  it('enable and select configs show', () => {
     const enable_config_opt = assertDefined(
       htmlElement.querySelector('.enable-config-opt'),
     );
@@ -106,29 +204,269 @@ describe('TraceConfigComponent', () => {
     expect(selection_config_opt.innerHTML).toContain('tracing level');
   });
 
-  it('check that changing enable config causes box to change', async () => {
-    assertDefined(component.traceConfig)[
-      'layers_trace'
-    ].config!.enableConfigs[0].enabled = false;
+  it('changing enable config model value causes box to change', async () => {
+    const inputElement = assertDefined(
+      htmlElement.querySelector<HTMLInputElement>('.enable-config input'),
+    );
+    assertDefined(
+      assertDefined(component.traceConfig)['layers_trace'].config,
+    ).enableConfigs[0].enabled = false;
+    await detectNgModelChanges();
+    expect(inputElement.checked).toBeFalse();
+    expect(inputElement.ariaChecked).toEqual('false');
+
+    assertDefined(
+      assertDefined(component.traceConfig)['layers_trace'].config,
+    ).enableConfigs[0].enabled = true;
+    await detectNgModelChanges();
+    expect(inputElement.checked).toBeTrue();
+    expect(inputElement.ariaChecked).toEqual('true');
+  });
+
+  it('changing enable config by DOM interaction emits event', async () => {
+    configChangeSpy.calls.reset();
+    const inputElement = assertDefined(
+      htmlElement.querySelector<HTMLInputElement>('.enable-config input'),
+    );
+    inputElement.click();
     fixture.detectChanges();
-    await fixture.whenStable();
-    expect(htmlElement.querySelector('.enable-config')?.innerHTML).toContain(
-      'aria-checked="false"',
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
+  });
+
+  it('changing selected config causes select to change', async () => {
+    configChangeSpy.calls.reset();
+    await openSelect(0);
+
+    const panel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-select-panel'),
     );
+    expect(panel.querySelector('.user-option')).toBeNull();
+
+    clickFirstOption(panel);
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
   });
 
-  it('check that changing selected config causes select to change', async () => {
+  it('clicking None button clears optional single selection config value', async () => {
+    configChangeSpy.calls.reset();
+    await openSelect(getIndexForConfigKey('optional_selection_trace'));
+
+    const panel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-select-panel'),
+    );
+    clickFirstOption(panel);
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
+    expect(
+      configChangeSpy.calls.mostRecent().args[0]['optional_selection_trace']
+        .config.selectionConfigs[0].value,
+    ).toEqual('12345');
+
+    const noneButton = assertDefined(
+      panel.querySelectorAll<HTMLElement>('.user-option').item(0),
+    );
+    noneButton.click();
     fixture.detectChanges();
-    expect(htmlElement.querySelector('.config-selection')?.innerHTML).toContain(
-      'value="debug"',
+    expect(configChangeSpy).toHaveBeenCalledTimes(2);
+    expect(
+      configChangeSpy.calls.mostRecent().args[0]['optional_selection_trace']
+        .config.selectionConfigs[0].value,
+    ).toEqual('');
+  });
+
+  it('clicking All button selects or clears all options for multiple selection config', async () => {
+    configChangeSpy.calls.reset();
+    await openSelect(getIndexForConfigKey('multiple_selection_trace'));
+
+    const panel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-select-panel'),
     );
-    assertDefined(component.traceConfig)[
-      'layers_trace'
-    ].config!.selectionConfigs[0].value = 'verbose';
+    const allButton = assertDefined(
+      panel.querySelector<HTMLElement>('.user-option'),
+    );
+    allButton.click();
     fixture.detectChanges();
-    await fixture.whenStable();
-    expect(htmlElement.querySelector('.config-selection')?.innerHTML).toContain(
-      'value="verbose"',
+    expect(configChangeSpy).toHaveBeenCalledTimes(1);
+    expect(
+      configChangeSpy.calls.mostRecent().args[0]['multiple_selection_trace']
+        .config.selectionConfigs[0].value,
+    ).toEqual(['12345', '67890']);
+
+    allButton.click();
+    fixture.detectChanges();
+    expect(configChangeSpy).toHaveBeenCalledTimes(2);
+    expect(
+      configChangeSpy.calls.mostRecent().args[0]['multiple_selection_trace']
+        .config.selectionConfigs[0].value,
+    ).toEqual([]);
+  });
+
+  it('stabilizes tooltip position', async () => {
+    await openSelect(getIndexForConfigKey('optional_selection_trace'));
+
+    const panel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-select-panel'),
     );
+    const options = panel.querySelectorAll<HTMLElement>('mat-option');
+
+    const shortOption = options.item(0);
+    shortOption.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    expect(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+    ).toBeNull();
+
+    const longOption = options.item(1);
+    longOption.dispatchEvent(new Event('mouseenter'));
+    fixture.detectChanges();
+    const tooltipPanel = assertDefined(
+      document.querySelector<HTMLElement>('.mat-tooltip-panel'),
+    );
+    expect(tooltipPanel?.style.top.length).toBeGreaterThan(0);
+    expect(tooltipPanel?.style.left.length).toBeGreaterThan(0);
   });
+
+  async function setComponentInputs(
+    c: TraceConfigComponent,
+    f: ComponentFixture<TraceConfigComponent> = fixture,
+    storage: Store = new InMemoryStorage(),
+  ) {
+    c.title = 'Targets';
+    c.initialTraceConfig = {
+      layers_trace: {
+        name: 'layers_trace',
+        enabled: true,
+        available: true,
+        types: [TraceType.SURFACE_FLINGER],
+        config: {
+          enableConfigs: [
+            {
+              name: 'trace buffers',
+              key: 'tracebuffers',
+              enabled: true,
+            },
+          ],
+          selectionConfigs: [
+            {
+              key: 'tracinglevel',
+              name: 'tracing level',
+              options: ['verbose', 'debug', 'critical'],
+              value: 'debug',
+            },
+          ],
+        },
+      },
+      window_trace: {
+        name: 'window_trace',
+        enabled: false,
+        available: true,
+        types: [TraceType.WINDOW_MANAGER],
+        config: undefined,
+      },
+      unavailable_trace: {
+        name: 'unavailable_trace',
+        enabled: false,
+        available: false,
+        types: [TraceType.TEST_TRACE_STRING],
+        config: undefined,
+      },
+      optional_selection_trace: {
+        name: 'optional_selection_trace',
+        enabled: true,
+        available: true,
+        types: [TraceType.TEST_TRACE_STRING],
+        config: {
+          enableConfigs: [],
+          selectionConfigs: [
+            {
+              key: 'displays',
+              name: 'displays',
+              options: ['12345', 'long_option'.repeat(20)],
+              value: '',
+              optional: true,
+            },
+          ],
+        },
+      },
+      multiple_selection_trace: {
+        name: 'multiple_selection_trace',
+        enabled: true,
+        available: true,
+        types: [TraceType.TEST_TRACE_STRING],
+        config: {
+          enableConfigs: [],
+          selectionConfigs: [
+            {
+              key: 'displays',
+              name: 'displays',
+              options: ['12345', '67890'],
+              value: [],
+            },
+          ],
+        },
+      },
+      optional_multiple_selection_trace: {
+        name: 'optional_multiple_selection_trace',
+        enabled: true,
+        available: true,
+        types: [TraceType.TEST_TRACE_STRING],
+        config: {
+          enableConfigs: [],
+          selectionConfigs: [
+            {
+              key: 'displays',
+              name: 'displays',
+              options: ['12345', '67890'],
+              value: [],
+              optional: true,
+            },
+          ],
+        },
+      },
+    };
+    c.traceConfigStoreKey = 'TestConfigSettings';
+    c.storage = storage;
+    await detectNgModelChanges(f);
+    f.detectChanges();
+  }
+
+  async function detectNgModelChanges(
+    f: ComponentFixture<TraceConfigComponent> = fixture,
+  ) {
+    f.detectChanges();
+    await f.whenStable();
+    f.detectChanges();
+  }
+
+  function getTraceBoxForKey(traceKey: string): HTMLElement {
+    const index = component
+      .getSortedTraceKeys()
+      .findIndex((key) => key === traceKey);
+    return assertDefined(
+      htmlElement.querySelectorAll<HTMLElement>('.trace-checkbox').item(index),
+    );
+  }
+
+  function getIndexForConfigKey(configKey: string): number {
+    return component
+      .getSortedConfigKeys()
+      .findIndex((key) => key === configKey);
+  }
+
+  async function openSelect(index: number) {
+    const selectTrigger = assertDefined(
+      htmlElement
+        .querySelectorAll<HTMLElement>('.mat-select-trigger')
+        .item(index),
+    );
+    selectTrigger.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+  }
+
+  function clickFirstOption(panel: HTMLElement) {
+    const newOption = assertDefined(
+      panel.querySelector<HTMLElement>('mat-option'),
+    );
+    newOption.click();
+    fixture.detectChanges();
+  }
 });
diff --git a/tools/winscope/src/app/components/trace_view_component.ts b/tools/winscope/src/app/components/trace_view_component.ts
index 0fe7caab6..47ca86ccb 100644
--- a/tools/winscope/src/app/components/trace_view_component.ts
+++ b/tools/winscope/src/app/components/trace_view_component.ts
@@ -15,17 +15,23 @@
  */
 
 import {
+  ChangeDetectorRef,
   Component,
   ElementRef,
   Inject,
   Input,
+  NgZone,
   SimpleChanges,
 } from '@angular/core';
+import {FormControl, ValidationErrors, Validators} from '@angular/forms';
+import {overlayPanelStyles} from 'app/styles/overlay_panel.styles';
 import {assertDefined} from 'common/assert_utils';
 import {FunctionUtils} from 'common/function_utils';
-import {PersistentStore} from 'common/persistent_store';
+import {Store} from 'common/store';
 import {Analytics} from 'logging/analytics';
 import {
+  FilterPresetApplyRequest,
+  FilterPresetSaveRequest,
   TabbedViewSwitched,
   WinscopeEvent,
   WinscopeEventType,
@@ -36,6 +42,8 @@ import {
 } from 'messaging/winscope_event_emitter';
 import {WinscopeEventListener} from 'messaging/winscope_event_listener';
 import {TRACE_INFO} from 'trace/trace_info';
+import {TraceType} from 'trace/trace_type';
+import {inlineButtonStyle} from 'viewers/components/styles/clickable_property.styles';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 
 interface Tab {
@@ -49,26 +57,95 @@ interface Tab {
       <div class="overlay-container">
       </div>
       <div class="header-items-wrapper">
+        <div class="trace-tabs-wrapper header-items-wrapper">
           <nav mat-tab-nav-bar class="tabs-navigation-bar">
-              <a
-                  *ngFor="let tab of tabs; last as isLast"
-                  mat-tab-link
-                  [active]="isCurrentActiveTab(tab)"
-                  [class.active]="isCurrentActiveTab(tab)"
-                  (click)="onTabClick(tab)"
-                  (focus)="$event.target.blur()"
-                  [class.last]="isLast"
-                  class="tab">
-                <mat-icon
-                  class="icon"
-                  [style]="{color: TRACE_INFO[tab.view.traces[0].type].color, marginRight: '0.5rem'}">
-                    {{ TRACE_INFO[tab.view.traces[0].type].icon }}
-                </mat-icon>
-                <span>
-                  {{ tab.view.title }}
-                </span>
-              </a>
+            <a
+                *ngFor="let tab of tabs; last as isLast"
+                mat-tab-link
+                [active]="isCurrentActiveTab(tab)"
+                [class.active]="isCurrentActiveTab(tab)"
+                [matTooltip]="getTabTooltip(tab.view)"
+                matTooltipPosition="above"
+                [matTooltipShowDelay]="300"
+                (click)="onTabClick(tab)"
+                (focus)="$event.target.blur()"
+                [class.last]="isLast"
+                class="tab">
+              <mat-icon
+                class="icon"
+                [style]="{color: TRACE_INFO[tab.view.traces[0].type].color, marginRight: '0.5rem'}">
+                  {{ TRACE_INFO[tab.view.traces[0].type].icon }}
+              </mat-icon>
+              <span>
+                {{ getTitle(tab.view) }}
+              </span>
+            </a>
           </nav>
+        </div>
+
+        <button
+          [disabled]="!currentTabHasFilterPresets()"
+          mat-flat-button
+          cdkOverlayOrigin
+          #filterPresetsTrigger="cdkOverlayOrigin"
+          color="primary"
+          class="filter-presets"
+          (click)="onFilterPresetsClick()">
+          <span class="filter-presets-label">
+            <mat-icon class="material-symbols-outlined">save</mat-icon>
+            <span> Filter Presets </span>
+          </span>
+        </button>
+
+        <ng-template
+          cdkConnectedOverlay
+          [cdkConnectedOverlayOrigin]="filterPresetsTrigger"
+          [cdkConnectedOverlayOpen]="isFilterPresetsPanelOpen"
+          [cdkConnectedOverlayHasBackdrop]="true"
+          cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
+          (backdropClick)="onFilterPresetsClick()"
+        >
+          <div class="overlay-panel filter-presets-panel">
+            <h2 class="overlay-panel-title">
+              <span> FILTER PRESETS </span>
+              <button (click)="onFilterPresetsClick()" class="close-button" mat-icon-button>
+                <mat-icon> close </mat-icon>
+              </button>
+            </h2>
+            <div class="overlay-panel-content">
+              <span class="mat-body-1"> Save the current configuration of filters for this trace type to access later, or select one of the existing configurations below. </span>
+
+              <div class="overlay-panel-section save-section">
+                <span class="mat-body-2 overlay-panel-section-title"> Preset Name </span>
+                <div class="save-field outline-field">
+                  <mat-form-field appearance="outline">
+                    <input matInput [formControl]="filterPresetNameControl" (keydown.enter)="savePreset()"/>
+                    <mat-error *ngIf="filterPresetNameControl.invalid && filterPresetNameControl.value">Preset with that name already exists.</mat-error>
+                  </mat-form-field>
+                  <button mat-flat-button color="primary" [disabled]="filterPresetNameControl.invalid" (click)="savePreset()"> Save </button>
+                </div>
+              </div>
+
+              <mat-divider></mat-divider>
+
+              <div class="overlay-panel-section existing-presets-section">
+                <span class="mat-body-2 overlay-panel-section-title"> Apply a preset </span>
+                <span class="mat-body-1" *ngIf="getCurrentFilterPresets().length === 0"> No existing presets found. </span>
+                <div *ngFor="let preset of getCurrentFilterPresets()" class="existing-preset inline">
+                  <button
+                      mat-button
+                      color="primary"
+                      (click)="onExistingPresetClick(preset)">
+                    {{ preset.split(".")[0] }}
+                  </button>
+                  <button mat-icon-button class="delete-button" (click)="deletePreset(preset)">
+                    <mat-icon class="material-symbols-outlined"> delete </mat-icon>
+                  </button>
+                </div>
+              </div>
+            </div>
+          </div>
+        </ng-template>
       </div>
       <mat-divider></mat-divider>
       <div class="trace-view-content"></div>
@@ -83,6 +160,11 @@ interface Tab {
         display: flex;
         flex-direction: row;
         justify-content: space-between;
+        align-items: center;
+      }
+
+      .trace-tabs-wrapper {
+        overflow-x: auto;
       }
 
       .tabs-navigation-bar {
@@ -109,27 +191,114 @@ interface Tab {
         width: 1px;
         background-color: #C4C0C0;
       }
+
+      .filter-presets {
+        line-height: 24px;
+        padding: 0 10px;
+        margin-inline: 10px;
+        min-width: fit-content;
+        min-height: fit-content;
+      }
+
+      .filter-presets-label {
+        display: flex;
+        flex-direction: row;
+        align-items: center;
+      }
+
+      .filter-presets-label .mat-icon {
+        margin-inline-end: 5px;
+      }
+
+      .filter-presets-panel {
+        max-width: 440px;
+        max-height: 500px;
+        overflow-y: auto;
+        border-radius: 15px;
+      }
+
+      .save-field {
+        display: flex;
+        align-items: center;
+        font-size: 14px;
+        width: 100%;
+      }
+
+      .save-field mat-form-field {
+        width: 100%;
+      }
+
+      .save-field button {
+        height: fit-content;
+        margin-inline-start: 10px;
+      }
+
+      .existing-preset {
+        display: flex;
+        flex-direction: row;
+        justify-content: space-between;
+        align-items: center;
+        width: 100%:
+      }
+
+      .existing-preset:hover {
+        background-color: var(--hover-element-color);
+      }
+
+      .existing-preset:not(:hover) .delete-button {
+        opacity: 0.5;
+      }
     `,
+    overlayPanelStyles,
+    inlineButtonStyle,
   ],
 })
 export class TraceViewComponent
   implements WinscopeEventEmitter, WinscopeEventListener
 {
   @Input() viewers: Viewer[] = [];
-  @Input() store: PersistentStore | undefined;
+  @Input() store: Store | undefined;
 
   TRACE_INFO = TRACE_INFO;
   tabs: Tab[] = [];
+  isFilterPresetsPanelOpen = false;
+  filterPresetNameControl = new FormControl(
+    '',
+    assertDefined(
+      Validators.compose([
+        Validators.required,
+        (control: FormControl) =>
+          this.validateFilterPresetName(
+            control,
+            this.allFilterPresets,
+            (input: string) =>
+              this.makeFilterPresetName(
+                input,
+                assertDefined(this.getCurrentTabTraceType()),
+              ),
+          ),
+      ]),
+    ),
+  );
 
-  private elementRef: ElementRef;
   private currentActiveTab: undefined | Tab;
   private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
+  private filterPresetsStoreKey = 'filterPresets';
+  private allFilterPresets: string[] = [];
 
-  constructor(@Inject(ElementRef) elementRef: ElementRef) {
-    this.elementRef = elementRef;
-  }
+  constructor(
+    @Inject(ElementRef) private elementRef: ElementRef,
+    @Inject(ChangeDetectorRef) private changeDetectorRef: ChangeDetectorRef,
+    @Inject(NgZone) private ngZone: NgZone,
+  ) {}
 
   ngOnChanges(changes: SimpleChanges) {
+    if (changes['store']?.firstChange) {
+      const storedPresets = this.store?.get(this.filterPresetsStoreKey);
+      if (storedPresets) {
+        this.allFilterPresets = JSON.parse(storedPresets);
+      }
+    }
     this.renderViewsTab(changes['viewers']?.firstChange ?? false);
     this.renderViewsOverlay();
   }
@@ -158,6 +327,92 @@ export class TraceViewComponent
     return tab === this.currentActiveTab;
   }
 
+  getTabTooltip(view: View): string {
+    return view.traces.flatMap((trace) => trace.getDescriptors()).join(', ');
+  }
+
+  getTitle(view: View): string {
+    const isDump = view.traces.length === 1 && view.traces[0].isDump();
+    return view.title + (isDump ? ' Dump' : '');
+  }
+
+  getCurrentFilterPresets(): string[] {
+    const currentTabTraceType = this.getCurrentTabTraceType();
+    if (currentTabTraceType === undefined) return [];
+    return this.allFilterPresets.filter((preset) =>
+      preset.includes(TRACE_INFO[currentTabTraceType].name),
+    );
+  }
+
+  onFilterPresetsClick() {
+    this.ngZone.run(() => {
+      this.isFilterPresetsPanelOpen = !this.isFilterPresetsPanelOpen;
+      this.changeDetectorRef.detectChanges();
+    });
+  }
+
+  async savePreset() {
+    if (this.filterPresetNameControl.invalid) return;
+    await this.ngZone.run(async () => {
+      const value = assertDefined(this.filterPresetNameControl.value);
+      const currentTabTraceType = assertDefined(this.getCurrentTabTraceType());
+      const presetName = this.makeFilterPresetName(value, currentTabTraceType);
+
+      this.allFilterPresets.push(presetName);
+      if (this.store) {
+        this.store?.add(
+          this.filterPresetsStoreKey,
+          JSON.stringify(this.allFilterPresets),
+        );
+      }
+
+      this.filterPresetNameControl.reset();
+      this.changeDetectorRef.detectChanges();
+      await this.emitAppEvent(
+        new FilterPresetSaveRequest(presetName, currentTabTraceType),
+      );
+    });
+  }
+
+  onExistingPresetClick(preset: string) {
+    this.emitAppEvent(
+      new FilterPresetApplyRequest(
+        preset,
+        assertDefined(this.getCurrentTabTraceType()),
+      ),
+    );
+  }
+
+  deletePreset(preset: string) {
+    this.allFilterPresets = this.allFilterPresets.filter((p) => p !== preset);
+    this.store?.clear(preset);
+    this.store?.add(
+      this.filterPresetsStoreKey,
+      JSON.stringify(this.allFilterPresets),
+    );
+    this.filterPresetNameControl.updateValueAndValidity();
+    this.changeDetectorRef.detectChanges();
+  }
+
+  currentTabHasFilterPresets(): boolean {
+    const currentTabTraceType = this.getCurrentTabTraceType();
+    return (
+      currentTabTraceType !== undefined &&
+      [
+        TraceType.SURFACE_FLINGER,
+        TraceType.WINDOW_MANAGER,
+        TraceType.INPUT_METHOD_CLIENTS,
+        TraceType.INPUT_METHOD_MANAGER_SERVICE,
+        TraceType.INPUT_METHOD_SERVICE,
+        TraceType.VIEW_CAPTURE,
+      ].includes(currentTabTraceType)
+    );
+  }
+
+  private getCurrentTabTraceType(): TraceType | undefined {
+    return this.currentActiveTab?.view.traces[0].type;
+  }
+
   private renderViewsTab(firstToRender: boolean) {
     this.tabs = this.viewers
       .map((viewer) => viewer.getViews())
@@ -234,4 +489,19 @@ export class TraceViewComponent
       await this.emitAppEvent(new TabbedViewSwitched(tab.view));
     }
   }
+
+  private validateFilterPresetName(
+    control: FormControl,
+    filterPresets: string[],
+    makeFilterPresetName: (input: string) => string,
+  ): ValidationErrors | null {
+    const valid =
+      control.value &&
+      !filterPresets.includes(makeFilterPresetName(control.value));
+    return !valid ? {invalidInput: control.value} : null;
+  }
+
+  private makeFilterPresetName(input: string, traceType: TraceType) {
+    return input + '.' + TRACE_INFO[traceType].name;
+  }
 }
diff --git a/tools/winscope/src/app/components/trace_view_component_test.ts b/tools/winscope/src/app/components/trace_view_component_test.ts
index 8d6df3fc9..fbef1cc39 100644
--- a/tools/winscope/src/app/components/trace_view_component_test.ts
+++ b/tools/winscope/src/app/components/trace_view_component_test.ts
@@ -14,18 +14,30 @@
  * limitations under the License.
  */
 
+import {OverlayModule} from '@angular/cdk/overlay';
 import {CommonModule} from '@angular/common';
 import {Component, CUSTOM_ELEMENTS_SCHEMA, ViewChild} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {ReactiveFormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
 import {MatCardModule} from '@angular/material/card';
 import {MatDividerModule} from '@angular/material/divider';
+import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
 import {MatTabsModule} from '@angular/material/tabs';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
 import {
+  FilterPresetApplyRequest,
+  FilterPresetSaveRequest,
   TabbedViewSwitchRequest,
   WinscopeEvent,
   WinscopeEventType,
 } from 'messaging/winscope_event';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {TraceType} from 'trace/trace_type';
 import {Viewer, ViewType} from 'viewers/viewer';
@@ -39,12 +51,17 @@ describe('TraceViewComponent', () => {
     .build();
   const traceWm = new TraceBuilder<object>()
     .setType(TraceType.WINDOW_MANAGER)
-    .setEntries([])
+    .setEntries([{}])
+    .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
     .build();
   const traceSr = new TraceBuilder<object>()
     .setType(TraceType.SCREEN_RECORDING)
     .setEntries([])
     .build();
+  const traceProtolog = new TraceBuilder<object>()
+    .setType(TraceType.PROTO_LOG)
+    .setEntries([])
+    .build();
 
   let fixture: ComponentFixture<TestHostComponent>;
   let component: TestHostComponent;
@@ -53,7 +70,20 @@ describe('TraceViewComponent', () => {
   beforeEach(async () => {
     await TestBed.configureTestingModule({
       declarations: [TestHostComponent, TraceViewComponent],
-      imports: [CommonModule, MatCardModule, MatDividerModule, MatTabsModule],
+      imports: [
+        CommonModule,
+        MatCardModule,
+        MatDividerModule,
+        MatTabsModule,
+        MatTooltipModule,
+        OverlayModule,
+        MatButtonModule,
+        MatIconModule,
+        MatFormFieldModule,
+        BrowserAnimationsModule,
+        MatInputModule,
+        ReactiveFormsModule,
+      ],
       schemas: [CUSTOM_ELEMENTS_SCHEMA],
     }).compileComponents();
     fixture = TestBed.createComponent(TestHostComponent);
@@ -63,6 +93,7 @@ describe('TraceViewComponent', () => {
       new ViewerStub('Title0', 'Content0', traceSf, ViewType.TAB),
       new ViewerStub('Title1', 'Content1', traceWm, ViewType.TAB),
       new ViewerStub('Title2', 'Content2', traceSr, ViewType.OVERLAY),
+      new ViewerStub('Title3', 'Content3', traceProtolog, ViewType.TAB),
     ];
     fixture.detectChanges();
   });
@@ -73,9 +104,9 @@ describe('TraceViewComponent', () => {
 
   it('creates viewer tabs', () => {
     const tabs = htmlElement.querySelectorAll('.tab');
-    expect(tabs.length).toEqual(2);
+    expect(tabs.length).toEqual(3);
     expect(tabs.item(0).textContent).toContain('Title0');
-    expect(tabs.item(1).textContent).toContain('Title1');
+    expect(tabs.item(1).textContent).toContain('Title1 Dump');
   });
 
   it('creates viewer overlay', () => {
@@ -97,7 +128,7 @@ describe('TraceViewComponent', () => {
   });
 
   it('switches view on click', () => {
-    const tabButtons = htmlElement.querySelectorAll('.tab');
+    const tabButtons = htmlElement.querySelectorAll<HTMLElement>('.tab');
 
     // Initially tab 0
     fixture.detectChanges();
@@ -106,14 +137,14 @@ describe('TraceViewComponent', () => {
     expect(visibleTabContents[0].innerHTML).toEqual('Content0');
 
     // Switch to tab 1
-    (tabButtons[1] as HTMLButtonElement).click();
+    tabButtons.item(1).click();
     fixture.detectChanges();
     visibleTabContents = getVisibleTabContents();
     expect(visibleTabContents.length).toEqual(1);
     expect(visibleTabContents[0].innerHTML).toEqual('Content1');
 
     // Switch to tab 0
-    (tabButtons[0] as HTMLButtonElement).click();
+    tabButtons.item(0).click();
     fixture.detectChanges();
     visibleTabContents = getVisibleTabContents();
     expect(visibleTabContents.length).toEqual(1);
@@ -122,14 +153,14 @@ describe('TraceViewComponent', () => {
 
   it("emits 'view switched' events", () => {
     const traceViewComponent = assertDefined(component.traceViewComponent);
-    const tabButtons = htmlElement.querySelectorAll('.tab');
+    const tabButtons = htmlElement.querySelectorAll<HTMLElement>('.tab');
 
     const emitAppEvent = jasmine.createSpy();
     traceViewComponent.setEmitEvent(emitAppEvent);
 
     expect(emitAppEvent).not.toHaveBeenCalled();
 
-    (tabButtons[1] as HTMLButtonElement).click();
+    tabButtons.item(1).click();
     expect(emitAppEvent).toHaveBeenCalledTimes(1);
     expect(emitAppEvent).toHaveBeenCalledWith(
       jasmine.objectContaining({
@@ -137,7 +168,7 @@ describe('TraceViewComponent', () => {
       } as WinscopeEvent),
     );
 
-    (tabButtons[0] as HTMLButtonElement).click();
+    tabButtons.item(0).click();
     expect(emitAppEvent).toHaveBeenCalledTimes(2);
     expect(emitAppEvent).toHaveBeenCalledWith(
       jasmine.objectContaining({
@@ -191,27 +222,223 @@ describe('TraceViewComponent', () => {
     );
   });
 
-  const getVisibleTabContents = () => {
+  it('disables filter presets button for viewers without presets', () => {
+    const filterPresets = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.filter-presets'),
+    );
+    expect(filterPresets.textContent).toContain('Filter Presets');
+    expect(filterPresets.disabled).toBeFalse();
+    const tabButtons = htmlElement.querySelectorAll<HTMLElement>('.tab');
+    tabButtons.item(2).click();
+    fixture.detectChanges();
+    expect(filterPresets.disabled).toBeTrue();
+  });
+
+  it('saves preset by button', () => {
+    const emitAppEvent = jasmine.createSpy();
+    component.traceViewComponent?.setEmitEvent(emitAppEvent);
+    openFilterPresets();
+
+    const overlayPanel = assertDefined(
+      document.querySelector('.overlay-panel'),
+    );
+    const existingPresets = assertDefined(
+      overlayPanel.querySelector('.existing-presets-section'),
+    );
+    expect(existingPresets.textContent).toContain('No existing presets found');
+
+    const saveButton = assertDefined(
+      overlayPanel.querySelector<HTMLButtonElement>('.save-field button'),
+    );
+    expect(saveButton.disabled).toBeTrue();
+
+    const inputEl = assertDefined(
+      overlayPanel.querySelector<HTMLInputElement>('.save-field input'),
+    );
+    updateInputField(inputEl, 'Test Preset');
+    saveButton.click();
+    fixture.detectChanges();
+
+    expect(emitAppEvent).toHaveBeenCalledWith(
+      new FilterPresetSaveRequest(
+        'Test Preset.Surface Flinger',
+        TraceType.SURFACE_FLINGER,
+      ),
+    );
+    expect(existingPresets.textContent).toContain('Test Preset');
+    expect(inputEl.value).toEqual('');
+    expect(saveButton.disabled).toBeTrue();
+  });
+
+  it('saves preset by keydown', () => {
+    const emitAppEvent = jasmine.createSpy();
+    component.traceViewComponent?.setEmitEvent(emitAppEvent);
+    openFilterPresets();
+
+    const overlayPanel = assertDefined(
+      document.querySelector('.overlay-panel'),
+    );
+
+    const inputEl = assertDefined(
+      overlayPanel.querySelector<HTMLInputElement>('.save-field input'),
+    );
+    inputEl.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter'}));
+    fixture.detectChanges();
+    expect(emitAppEvent).not.toHaveBeenCalled();
+
+    updateInputField(inputEl, 'Test Preset');
+    inputEl.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter'}));
+    fixture.detectChanges();
+
+    expect(emitAppEvent).toHaveBeenCalledWith(
+      new FilterPresetSaveRequest(
+        'Test Preset.Surface Flinger',
+        TraceType.SURFACE_FLINGER,
+      ),
+    );
+  });
+
+  it('saves preset between sessions', () => {
+    savePresetByButton('Test Preset');
+
+    component.showSecondComponent = true;
+    fixture.detectChanges();
+
+    openFilterPresets();
+    const existingPresets = assertDefined(
+      document.querySelector('.overlay-panel .existing-presets-section'),
+    );
+    expect(existingPresets.textContent).toContain('Test Preset');
+  });
+
+  it('deletes preset', () => {
+    savePresetByButton('Test Preset');
+    const saveButton = assertDefined(
+      document.querySelector<HTMLButtonElement>('.save-field button'),
+    );
+    updateInputField(
+      assertDefined(
+        document.querySelector<HTMLInputElement>('.save-field input'),
+      ),
+      'Test Preset',
+    );
+    expect(saveButton.disabled).toBeTrue();
+
+    assertDefined(
+      document.querySelector<HTMLElement>('.delete-button'),
+    ).click();
+    fixture.detectChanges();
+    expect(
+      document.querySelector<HTMLElement>('.existing-presets-section')
+        ?.textContent,
+    ).toContain('No existing presets found');
+    expect(saveButton.disabled).toBeFalse();
+  });
+
+  it('does not show presets for different trace', () => {
+    savePresetByButton('Test Preset');
+    closeFilterPresets();
+
+    const tabs = htmlElement.querySelectorAll<HTMLElement>('.tab');
+    tabs.item(1).click();
+    fixture.detectChanges();
+
+    openFilterPresets();
+    const existingPresets = assertDefined(
+      document.querySelector('.overlay-panel'),
+    );
+    expect(existingPresets.textContent).toContain('No existing presets found');
+  });
+
+  it('emits apply preset request', () => {
+    const emitAppEvent = jasmine.createSpy();
+    component.traceViewComponent?.setEmitEvent(emitAppEvent);
+    savePresetByButton('Test Preset');
+
+    const preset = assertDefined(
+      document.querySelector<HTMLElement>(
+        '.overlay-panel .existing-preset button',
+      ),
+    );
+    preset.click();
+    fixture.detectChanges();
+
+    expect(emitAppEvent).toHaveBeenCalledWith(
+      new FilterPresetApplyRequest(
+        'Test Preset.Surface Flinger',
+        TraceType.SURFACE_FLINGER,
+      ),
+    );
+  });
+
+  function getVisibleTabContents() {
     const contents: HTMLElement[] = [];
     htmlElement
-      .querySelectorAll('.trace-view-content div')
+      .querySelectorAll<HTMLElement>('.trace-view-content div')
       .forEach((content) => {
-        if ((content as HTMLElement).style.display !== 'none') {
-          contents.push(content as HTMLElement);
+        if (content.style.display !== 'none') {
+          contents.push(content);
         }
       });
     return contents;
-  };
+  }
+
+  function savePresetByButton(presetName: string) {
+    openFilterPresets();
+    const overlayPanel = assertDefined(
+      document.querySelector('.overlay-panel'),
+    );
+    const saveButton = assertDefined(
+      overlayPanel.querySelector<HTMLButtonElement>('.save-field button'),
+    );
+
+    const inputEl = assertDefined(
+      overlayPanel.querySelector<HTMLInputElement>('.save-field input'),
+    );
+    updateInputField(inputEl, presetName);
+    saveButton.click();
+    fixture.detectChanges();
+  }
+
+  function openFilterPresets() {
+    const filterPresets = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.filter-presets'),
+    );
+    filterPresets.click();
+    fixture.detectChanges();
+  }
+
+  function closeFilterPresets() {
+    assertDefined(
+      document.querySelector<HTMLElement>('.cdk-overlay-backdrop'),
+    ).click();
+    fixture.detectChanges();
+  }
+
+  function updateInputField(inputEl: HTMLInputElement, value: string) {
+    inputEl.value = value;
+    inputEl.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+  }
 
   @Component({
     selector: 'host-component',
     template: `
       <trace-view
-        [viewers]="viewers"></trace-view>
+        *ngIf="!showSecondComponent"
+        [viewers]="viewers"
+        [store]="store"></trace-view>
+
+      <trace-view
+        *ngIf="showSecondComponent"
+        [viewers]="viewers"
+        [store]="store"></trace-view>
     `,
   })
   class TestHostComponent {
     viewers: Viewer[] = [];
+    store = new InMemoryStorage();
+    showSecondComponent = false;
 
     @ViewChild(TraceViewComponent)
     traceViewComponent: TraceViewComponent | undefined;
diff --git a/tools/winscope/src/app/components/upload_traces_component.ts b/tools/winscope/src/app/components/upload_traces_component.ts
index 3751da1d0..b59f759b7 100644
--- a/tools/winscope/src/app/components/upload_traces_component.ts
+++ b/tools/winscope/src/app/components/upload_traces_component.ts
@@ -49,6 +49,10 @@ import {LoadProgressComponent} from './load_progress_component';
             View traces
           </button>
 
+          <button class="download-btn" color="primary" mat-stroked-button (click)="downloadTracesClick.emit()">
+            Download all
+          </button>
+
           <button color="primary" mat-stroked-button for="fileDropRef" (click)="fileDropRef.click()">
             Upload another file
           </button>
@@ -86,23 +90,25 @@ import {LoadProgressComponent} from './load_progress_component';
         </load-progress>
 
         <mat-list
-          *ngIf="!isLoadingFiles && this.tracePipeline.getTraces().getSize() > 0"
+          *ngIf="!isLoadingFiles && tracePipeline.getTraces().getSize() > 0"
           class="uploaded-files">
-          <mat-list-item [class.no-visualization]="!canVisualizeTrace(trace)" *ngFor="let trace of this.tracePipeline.getTraces()">
-            <mat-icon matListIcon>
+          <mat-list-item [class.no-visualization]="!canVisualizeTrace(trace)" [class.trace-error]="trace.isCorrupted()" *ngFor="let trace of tracePipeline.getTraces()">
+            <mat-icon
+              matListIcon
+              [style]="{color: TRACE_INFO[trace.type].color}">
               {{ TRACE_INFO[trace.type].icon }}
             </mat-icon>
 
             <p matLine>{{ TRACE_INFO[trace.type].name }}</p>
             <p matLine *ngFor="let descriptor of trace.getDescriptors()">{{ descriptor }}</p>
 
-            <mat-icon class="info-icon" *ngIf="traceUploadInfo(trace)" [matTooltip]="traceUploadInfo(trace)">
-              info
-            </mat-icon>
             <mat-icon class="warning-icon" *ngIf="!canVisualizeTrace(trace)" [matTooltip]="cannotVisualizeTraceTooltip(trace)">
               warning
             </mat-icon>
-            <button color="primary" mat-icon-button (click)="onRemoveTrace($event, trace)">
+            <mat-icon class="trace-error-icon" *ngIf="trace.isCorrupted()" [matTooltip]="traceErrorTooltip(trace)">
+              error
+            </mat-icon>
+            <button mat-icon-button (click)="onRemoveTrace($event, trace)">
               <mat-icon>close</mat-icon>
             </button>
           </mat-list-item>
@@ -142,6 +148,7 @@ import {LoadProgressComponent} from './load_progress_component';
         flex-direction: row;
         flex-wrap: wrap;
         gap: 10px;
+        padding: 4px 0px;
       }
       .drop-box {
         display: flex;
@@ -195,9 +202,18 @@ import {LoadProgressComponent} from './load_progress_component';
       .no-visualization {
         background-color: var(--warning-background-color);
       }
-      .info-icon, .warning-icon {
+      .trace-error {
+        background-color: var(--error-background-color);
+      }
+      .warning-icon, .trace-error-icon {
         flex-shrink: 0;
       }
+      .warning-icon {
+        color: var(--warning-color);
+      }
+      .trace-error-icon {
+        color: var(--error-color);
+      }
     `,
   ],
 })
@@ -208,9 +224,10 @@ export class UploadTracesComponent implements ProgressListener {
   progressPercentage?: number;
   lastUiProgressUpdateTimeMs?: number;
 
-  @Input() tracePipeline!: TracePipeline;
+  @Input() tracePipeline: TracePipeline | undefined;
   @Output() filesUploaded = new EventEmitter<File[]>();
   @Output() viewTracesButtonClick = new EventEmitter<void>();
+  @Output() downloadTracesClick = new EventEmitter<void>();
 
   constructor(
     @Inject(ChangeDetectorRef) private changeDetectorRef: ChangeDetectorRef,
@@ -218,7 +235,7 @@ export class UploadTracesComponent implements ProgressListener {
   ) {}
 
   ngOnInit() {
-    this.tracePipeline.clear();
+    this.tracePipeline?.clear();
   }
 
   onProgressUpdate(
@@ -253,7 +270,7 @@ export class UploadTracesComponent implements ProgressListener {
   }
 
   onClearButtonClick() {
-    this.tracePipeline.clear();
+    this.tracePipeline?.clear();
     this.onOperationFinished();
   }
 
@@ -278,15 +295,18 @@ export class UploadTracesComponent implements ProgressListener {
   onRemoveTrace(event: MouseEvent, trace: Trace<object>) {
     event.preventDefault();
     event.stopPropagation();
-    this.tracePipeline.removeTrace(trace);
+    this.tracePipeline?.removeTrace(trace);
     this.onOperationFinished();
   }
 
   hasLoadedFilesWithViewers(): boolean {
     return this.ngZone.run(() => {
       let hasFilesWithViewers = false;
-      this.tracePipeline.getTraces().forEachTrace((trace) => {
-        if (TraceTypeUtils.isTraceTypeWithViewer(trace.type)) {
+      this.tracePipeline?.getTraces().forEachTrace((trace) => {
+        if (
+          !trace.isCorrupted() &&
+          TraceTypeUtils.isTraceTypeWithViewer(trace.type)
+        ) {
           hasFilesWithViewers = true;
         }
       });
@@ -295,18 +315,19 @@ export class UploadTracesComponent implements ProgressListener {
     });
   }
 
-  traceUploadInfo(trace: Trace<object>): string | undefined {
-    return TraceTypeUtils.traceUploadInfo(trace.type);
-  }
-
   canVisualizeTrace(trace: Trace<object>): boolean {
-    return TraceTypeUtils.canVisualizeTrace(trace.type);
+    return TraceTypeUtils.isTraceTypeWithViewer(trace.type);
   }
 
   cannotVisualizeTraceTooltip(trace: Trace<object>): string {
     return TraceTypeUtils.getReasonForNoTraceVisualization(trace.type);
   }
 
+  traceErrorTooltip(trace: Trace<object>): string {
+    const reason = trace.getCorruptedReason() ?? 'Trace is corrupted.';
+    return 'Cannot visualize trace. ' + reason;
+  }
+
   private getInputFiles(event: Event): File[] {
     const files: FileList | null = (event?.target as HTMLInputElement)?.files;
     if (!files || !files[0]) {
diff --git a/tools/winscope/src/app/components/upload_traces_component_test.ts b/tools/winscope/src/app/components/upload_traces_component_test.ts
index 9b6b77bae..e97a6d208 100644
--- a/tools/winscope/src/app/components/upload_traces_component_test.ts
+++ b/tools/winscope/src/app/components/upload_traces_component_test.ts
@@ -23,8 +23,10 @@ import {MatTooltipModule} from '@angular/material/tooltip';
 import {FilesSource} from 'app/files_source';
 import {TracePipeline} from 'app/trace_pipeline';
 import {assertDefined} from 'common/assert_utils';
-import {UserNotificationsListenerStub} from 'messaging/user_notifications_listener_stub';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
+import {Traces} from 'trace/traces';
 import {LoadProgressComponent} from './load_progress_component';
 import {UploadTracesComponent} from './upload_traces_component';
 
@@ -98,7 +100,7 @@ describe('UploadTracesComponent', () => {
   it('can remove one of two uploaded traces', async () => {
     await loadFiles([validSfFile, validWmFile]);
     fixture.detectChanges();
-    expect(component.tracePipeline.getTraces().getSize()).toBe(2);
+    expect(component.tracePipeline?.getTraces().getSize()).toBe(2);
 
     const spy = spyOn(component, 'onOperationFinished');
     const removeButton = assertDefined(
@@ -108,7 +110,7 @@ describe('UploadTracesComponent', () => {
     fixture.detectChanges();
     assertDefined(htmlElement.querySelector('.uploaded-files'));
     expect(spy).toHaveBeenCalled();
-    expect(component.tracePipeline.getTraces().getSize()).toBe(1);
+    expect(component.tracePipeline?.getTraces().getSize()).toBe(1);
   });
 
   it('handles removal of the only uploaded trace', async () => {
@@ -123,13 +125,13 @@ describe('UploadTracesComponent', () => {
     fixture.detectChanges();
     assertDefined(htmlElement.querySelector('.drop-info'));
     expect(spy).toHaveBeenCalled();
-    expect(component.tracePipeline.getTraces().getSize()).toBe(0);
+    expect(component.tracePipeline?.getTraces().getSize()).toBe(0);
   });
 
   it('can remove all uploaded traces', async () => {
     await loadFiles([validSfFile, validWmFile]);
     fixture.detectChanges();
-    expect(component.tracePipeline.getTraces().getSize()).toBe(2);
+    expect(component.tracePipeline?.getTraces().getSize()).toBe(2);
 
     const spy = spyOn(component, 'onOperationFinished');
     const clearAllButton = assertDefined(
@@ -139,10 +141,10 @@ describe('UploadTracesComponent', () => {
     fixture.detectChanges();
     assertDefined(htmlElement.querySelector('.drop-info'));
     expect(spy).toHaveBeenCalled();
-    expect(component.tracePipeline.getTraces().getSize()).toBe(0);
+    expect(component.tracePipeline?.getTraces().getSize()).toBe(0);
   });
 
-  it('can triggers view traces event', async () => {
+  it('can emit view traces event', async () => {
     await loadFiles([validSfFile]);
     fixture.detectChanges();
 
@@ -155,54 +157,57 @@ describe('UploadTracesComponent', () => {
     expect(spy).toHaveBeenCalled();
   });
 
-  it('disables view traces button unless files with viewers uploaded', async () => {
-    const validEventlogFile = await UnitTestUtils.getFixtureFile(
-      'traces/eventlog.winscope',
+  it('shows warning elements for traces without visualization', async () => {
+    const shellTransitionFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/shell_transition_trace.pb',
     );
-    await loadFiles([validEventlogFile]);
+    await loadFiles([shellTransitionFile]);
     fixture.detectChanges();
 
+    expect(htmlElement.querySelector('.warning-icon')).toBeTruthy();
     const viewTracesButton = assertDefined(
       htmlElement.querySelector('.load-btn'),
     );
     expect((viewTracesButton as HTMLButtonElement).disabled).toBeTrue();
-
-    await loadFiles([validSfFile]);
-    fixture.detectChanges();
-    expect((viewTracesButton as HTMLButtonElement).disabled).toBeFalse();
   });
 
-  it('shows warning elements for traces without visualization', async () => {
-    const shellTransitionFile = await UnitTestUtils.getFixtureFile(
-      'traces/elapsed_and_real_timestamp/shell_transition_trace.pb',
+  it('shows error elements for corrupted traces', async () => {
+    const corruptedTrace = new TraceBuilder<string>()
+      .setEntries(['entry-0'])
+      .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
+      .build();
+    corruptedTrace.setCorruptedState(true);
+    const traces = new Traces();
+    traces.addTrace(corruptedTrace);
+    spyOn(assertDefined(component.tracePipeline), 'getTraces').and.returnValue(
+      traces,
     );
-    await loadFiles([shellTransitionFile]);
     fixture.detectChanges();
 
-    expect(htmlElement.querySelector('.warning-icon')).toBeTruthy();
     const viewTracesButton = assertDefined(
-      htmlElement.querySelector('.load-btn'),
+      htmlElement.querySelector<HTMLButtonElement>('.load-btn'),
     );
-    expect((viewTracesButton as HTMLButtonElement).disabled).toBeTrue();
+
+    expect(htmlElement.querySelector('.trace-error-icon')).toBeTruthy();
+    expect(viewTracesButton.disabled).toBeTrue();
   });
 
-  it('shows info elements for traces with upload info for the user', async () => {
-    const shellTransitionFile = await UnitTestUtils.getFixtureFile(
-      'traces/eventlog.winscope',
-    );
-    await loadFiles([shellTransitionFile]);
+  it('emits download traces event', async () => {
+    await loadFiles([validSfFile]);
     fixture.detectChanges();
 
-    expect(htmlElement.querySelector('.info-icon')).toBeTruthy();
+    const spy = spyOn(component.downloadTracesClick, 'emit');
+    const downloadTracesButton = assertDefined(
+      htmlElement.querySelector('.download-btn'),
+    );
+    (downloadTracesButton as HTMLButtonElement).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalled();
   });
 
   async function loadFiles(files: File[]) {
-    component.tracePipeline.clear();
-    await component.tracePipeline.loadFiles(
-      files,
-      FilesSource.TEST,
-      new UserNotificationsListenerStub(),
-      undefined,
-    );
+    const tracePipeline = assertDefined(component.tracePipeline);
+    tracePipeline.clear();
+    await tracePipeline.loadFiles(files, FilesSource.TEST, undefined);
   }
 });
diff --git a/tools/winscope/src/app/components/warning_dialog_component.ts b/tools/winscope/src/app/components/warning_dialog_component.ts
new file mode 100644
index 000000000..daaa66f33
--- /dev/null
+++ b/tools/winscope/src/app/components/warning_dialog_component.ts
@@ -0,0 +1,102 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {Component, Inject} from '@angular/core';
+import {MAT_DIALOG_DATA} from '@angular/material/dialog';
+
+@Component({
+  selector: 'warning-dialog',
+  template: `
+    <h2 class="warning-dialog-title" mat-dialog-title>
+      <span> Warning </span>
+    </h2>
+    <mat-dialog-content class="warning-content">
+      <p class="warning-message mat-body-1"> {{data.message}} </p>
+
+      <div class="warning-actions">
+        <div class="warning-action-boxes">
+          <mat-checkbox
+            *ngFor="let option of data.options; let i = index"
+            color="primary"
+            (change)="updateSelectedOptions(option)"
+            [class.not-last]="i < data.options.length - 1"
+            >{{ option }}</mat-checkbox>
+        </div>
+        <div class="warning-action-buttons">
+          <button *ngFor="let action of data.actions" [mat-dialog-close]="getDialogResult(action)" class="not-last" color="primary" mat-stroked-button> {{ action }} </button>
+          <button [mat-dialog-close]="getDialogResult(data.closeText)" color="primary" mat-raised-button> {{ data.closeText }} </button>
+        </div>
+      </div>
+    </mat-dialog-content>
+  `,
+  styles: [
+    `
+      .warning-dialog-title {
+        display: flex;
+        justify-content: space-between;
+      }
+      .warning-close-button {
+        width: 24px;
+        height: 24px;
+        line-height: 24px;
+      }
+      .warning-content {
+        overflow: visible;
+      }
+      .warning-message {
+        white-space: pre-line;
+        font-size: 16px;
+      }
+      .warning-actions {
+        display: flex;
+        justify-content: space-between;
+        align-items: center;
+        margin-top: 8px;
+      }
+      .warning-actions .not-last {
+        margin-right: 8px;
+      }
+    `,
+  ],
+})
+export class WarningDialogComponent {
+  selectedOptions: string[] = [];
+
+  constructor(@Inject(MAT_DIALOG_DATA) public data: WarningDialogData) {}
+
+  updateSelectedOptions(clickedOption: string) {
+    if (!this.selectedOptions.includes(clickedOption)) {
+      this.selectedOptions.push(clickedOption);
+    } else {
+      this.selectedOptions.filter((opt) => opt !== clickedOption);
+    }
+  }
+
+  getDialogResult(closeActionText?: string): WarningDialogResult {
+    return {closeActionText, selectedOptions: this.selectedOptions};
+  }
+}
+
+export interface WarningDialogData {
+  message: string | undefined;
+  actions: string[] | undefined;
+  options: string[] | undefined;
+  closeText: string;
+}
+
+export interface WarningDialogResult {
+  closeActionText: string | undefined;
+  selectedOptions: string[];
+}
diff --git a/tools/winscope/src/app/components/warning_dialog_component_test.ts b/tools/winscope/src/app/components/warning_dialog_component_test.ts
new file mode 100644
index 000000000..45c92905b
--- /dev/null
+++ b/tools/winscope/src/app/components/warning_dialog_component_test.ts
@@ -0,0 +1,173 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {Component, Inject} from '@angular/core';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {MatButtonModule} from '@angular/material/button';
+import {MatCheckboxModule} from '@angular/material/checkbox';
+import {
+  MatDialog,
+  MatDialogModule,
+  MatDialogRef,
+} from '@angular/material/dialog';
+import {MatIconModule} from '@angular/material/icon';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {
+  WarningDialogComponent,
+  WarningDialogData,
+  WarningDialogResult,
+} from './warning_dialog_component';
+
+describe('WarningDialogComponent', () => {
+  let fixture: ComponentFixture<TestHostComponent>;
+  let component: TestHostComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      imports: [
+        MatIconModule,
+        MatDialogModule,
+        MatCheckboxModule,
+        MatButtonModule,
+        BrowserAnimationsModule,
+      ],
+      declarations: [TestHostComponent, WarningDialogComponent],
+    }).compileComponents();
+    fixture = TestBed.createComponent(TestHostComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(document.querySelector('warning-dialog')).toBeNull();
+    openAndReturnDialog();
+  });
+
+  it('renders warning message, action boxes and buttons', () => {
+    const dialog = openAndReturnDialog();
+
+    const content = assertDefined(dialog.querySelector('.warning-content'));
+    expect(content.querySelector('.warning-message')?.textContent).toContain(
+      'test message',
+    );
+
+    const actionBoxContainer = assertDefined(
+      content.querySelector('.warning-action-boxes'),
+    );
+    expect(actionBoxContainer.textContent).toContain('option1');
+    expect(actionBoxContainer.textContent).toContain('option2');
+
+    const actionButtonContainer = assertDefined(
+      content.querySelector('.warning-action-buttons'),
+    );
+    expect(actionButtonContainer.textContent).toContain('action1');
+    expect(actionButtonContainer.textContent).toContain('action2');
+    expect(actionButtonContainer.textContent).toContain('close message');
+  });
+
+  it('provides action text and selected options as dialog result on close', async () => {
+    const dialog = openAndReturnDialog();
+
+    const actionButton = assertDefined(
+      dialog.querySelector('.warning-action-buttons button'),
+    ) as HTMLElement;
+    actionButton.click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(component.dialogResult).toEqual({
+      closeActionText: 'action1',
+      selectedOptions: [],
+    });
+  });
+
+  it('provides close text and selected options as dialog result on close', async () => {
+    const dialog = openAndReturnDialog();
+
+    const buttons = assertDefined(
+      dialog.querySelectorAll('.warning-action-buttons button'),
+    );
+    (buttons.item(buttons.length - 1) as HTMLElement).click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(component.dialogResult).toEqual({
+      closeActionText: 'close message',
+      selectedOptions: [],
+    });
+  });
+
+  it('updates selected options and provides selected options in dialog result', async () => {
+    const dialog = openAndReturnDialog();
+
+    const option = assertDefined(
+      dialog.querySelector('.warning-action-boxes mat-checkbox input'),
+    ) as HTMLInputElement;
+    option.checked = true;
+    option.click();
+    fixture.detectChanges();
+
+    const buttons = assertDefined(
+      dialog.querySelectorAll('.warning-action-buttons button'),
+    );
+    (buttons.item(buttons.length - 1) as HTMLElement).click();
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    expect(component.dialogResult).toEqual({
+      closeActionText: 'close message',
+      selectedOptions: ['option1'],
+    });
+  });
+
+  function openAndReturnDialog(): HTMLElement {
+    htmlElement.querySelector('button')?.click();
+    fixture.detectChanges();
+    return assertDefined(
+      document.querySelector('warning-dialog'),
+    ) as HTMLElement;
+  }
+
+  @Component({
+    selector: 'host-component',
+    template: `
+      <button (click)="onClick()"></button>
+    `,
+  })
+  class TestHostComponent {
+    dialogRef: MatDialogRef<WarningDialogComponent> | undefined;
+    dialogResult: WarningDialogResult | undefined;
+
+    constructor(@Inject(MatDialog) public dialog: MatDialog) {}
+
+    onClick() {
+      const data: WarningDialogData = {
+        message: 'test message',
+        actions: ['action1', 'action2'],
+        options: ['option1', 'option2'],
+        closeText: 'close message',
+      };
+      this.dialogRef = this.dialog.open(WarningDialogComponent, {data});
+      this.dialogRef
+        .afterClosed()
+        .subscribe(async (result: WarningDialogResult) => {
+          this.dialogResult = result;
+        });
+    }
+  }
+});
diff --git a/tools/winscope/src/app/loaded_parsers.ts b/tools/winscope/src/app/loaded_parsers.ts
index 2845105ae..bf9cd2edf 100644
--- a/tools/winscope/src/app/loaded_parsers.ts
+++ b/tools/winscope/src/app/loaded_parsers.ts
@@ -16,16 +16,17 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {FileUtils} from 'common/file_utils';
+import {OnProgressUpdateType} from 'common/function_utils';
 import {INVALID_TIME_NS, TimeRange, Timestamp} from 'common/time';
 import {TIME_UNIT_TO_NANO} from 'common/time_units';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
+import {UserNotifier} from 'common/user_notifier';
 import {TraceHasOldData, TraceOverridden} from 'messaging/user_warnings';
 import {FileAndParser} from 'parsers/file_and_parser';
 import {FileAndParsers} from 'parsers/file_and_parsers';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
 import {TRACE_INFO} from 'trace/trace_info';
-import {TraceType} from 'trace/trace_type';
+import {TraceEntryTypeMap, TraceType} from 'trace/trace_type';
 
 export class LoadedParsers {
   static readonly MAX_ALLOWED_TIME_GAP_BETWEEN_TRACES_NS = BigInt(
@@ -41,14 +42,15 @@ export class LoadedParsers {
 
   private legacyParsers = new Array<FileAndParser>();
   private perfettoParsers = new Array<FileAndParser>();
+  private legacyParsersKeptForDownload = new Array<FileAndParser>();
+  private perfettoParsersKeptForDownload = new Array<FileAndParser>();
 
   addParsers(
     legacyParsers: FileAndParser[],
     perfettoParsers: FileAndParsers | undefined,
-    userNotificationsListener: UserNotificationsListener,
   ) {
     if (perfettoParsers) {
-      this.addPerfettoParsers(perfettoParsers, userNotificationsListener);
+      this.addPerfettoParsers(perfettoParsers);
     }
     // Traces were simultaneously upgraded to contain real-to-boottime or real-to-monotonic offsets.
     // If we have a mix of parsers with and without offsets, the ones without must be dangling
@@ -56,22 +58,11 @@ export class LoadedParsers {
     legacyParsers = this.filterOutParsersWithoutOffsetsIfRequired(
       legacyParsers,
       perfettoParsers,
-      userNotificationsListener,
     );
-    legacyParsers = this.filterOutLegacyParsersWithOldData(
-      legacyParsers,
-      userNotificationsListener,
-    );
-    legacyParsers = this.filterScreenshotParsersIfRequired(
-      legacyParsers,
-      userNotificationsListener,
-    );
-
-    this.addLegacyParsers(legacyParsers, userNotificationsListener);
+    legacyParsers = this.filterOutLegacyParsersWithOldData(legacyParsers);
+    legacyParsers = this.filterScreenshotParsersIfRequired(legacyParsers);
 
-    this.enforceLimitOfSingleScreenshotOrScreenRecordingParser(
-      userNotificationsListener,
-    );
+    this.addLegacyParsers(legacyParsers);
   }
 
   getParsers(): Array<Parser<object>> {
@@ -82,12 +73,27 @@ export class LoadedParsers {
     return fileAndParsers.map((fileAndParser) => fileAndParser.parser);
   }
 
-  remove(parser: Parser<object>) {
+  remove<T extends TraceType>(
+    parser: Parser<TraceEntryTypeMap[T]>,
+    keepForDownload = false,
+  ) {
+    const predicate = (
+      fileAndParser: FileAndParser,
+      parsersToKeep: FileAndParser[],
+    ) => {
+      const shouldRemove = fileAndParser.parser === parser;
+      if (shouldRemove && keepForDownload) {
+        parsersToKeep.push(fileAndParser);
+      }
+      return !shouldRemove;
+    };
     this.legacyParsers = this.legacyParsers.filter(
-      (fileAndParser) => fileAndParser.parser !== parser,
+      (fileAndParser: FileAndParser) =>
+        predicate(fileAndParser, this.legacyParsersKeptForDownload),
     );
     this.perfettoParsers = this.perfettoParsers.filter(
-      (fileAndParser) => fileAndParser.parser !== parser,
+      (fileAndParser: FileAndParser) =>
+        predicate(fileAndParser, this.perfettoParsersKeptForDownload),
     );
   }
 
@@ -96,10 +102,18 @@ export class LoadedParsers {
     this.perfettoParsers = [];
   }
 
-  async makeZipArchive(): Promise<Blob> {
+  async makeZipArchive(onProgressUpdate?: OnProgressUpdateType): Promise<Blob> {
     const outputFilesSoFar = new Set<File>();
     const outputFilenameToFiles = new Map<string, File[]>();
 
+    if (onProgressUpdate) onProgressUpdate(0);
+    const totalParsers =
+      this.perfettoParsers.length +
+      this.perfettoParsersKeptForDownload.length +
+      this.legacyParsers.length +
+      this.legacyParsersKeptForDownload.length;
+    let progress = 0;
+
     const tryPushOutputFile = (file: File, filename: string) => {
       // Remove duplicates because some parsers (e.g. view capture) could share the same file
       if (outputFilesSoFar.has(file)) {
@@ -136,16 +150,29 @@ export class LoadedParsers {
       );
     };
 
-    if (this.perfettoParsers.length > 0) {
-      const file: TraceFile = this.perfettoParsers.values().next().value.file;
+    const tryPushOutPerfettoFile = (parsers: FileAndParser[]) => {
+      const file: TraceFile = parsers.values().next().value.file;
       let outputFilename = FileUtils.removeDirFromFileName(file.file.name);
       if (FileUtils.getFileExtension(file.file.name) === undefined) {
         outputFilename += '.perfetto-trace';
       }
       tryPushOutputFile(file.file, outputFilename);
+    };
+
+    if (this.perfettoParsers.length > 0) {
+      tryPushOutPerfettoFile(this.perfettoParsers);
+    } else if (this.perfettoParsersKeptForDownload.length > 0) {
+      tryPushOutPerfettoFile(this.perfettoParsersKeptForDownload);
+    }
+    if (onProgressUpdate) {
+      progress =
+        this.perfettoParsers.length +
+        this.perfettoParsersKeptForDownload.length;
+      onProgressUpdate((0.5 * progress) / totalParsers);
     }
 
-    this.legacyParsers.forEach(({file, parser}) => {
+    const tryPushOutputLegacyFile = (fileAndParser: FileAndParser) => {
+      const {file, parser} = fileAndParser;
       const traceType = parser.getTraceType();
       const archiveDir =
         TRACE_INFO[traceType].downloadArchiveDir.length > 0
@@ -157,7 +184,14 @@ export class LoadedParsers {
         outputFilename += TRACE_INFO[traceType].legacyExt;
       }
       tryPushOutputFile(file.file, outputFilename);
-    });
+      if (onProgressUpdate) {
+        progress++;
+        onProgressUpdate((0.5 * progress) / totalParsers);
+      }
+    };
+
+    this.legacyParsers.forEach(tryPushOutputLegacyFile);
+    this.legacyParsersKeptForDownload.forEach(tryPushOutputLegacyFile);
 
     const archiveFiles = [...outputFilenameToFiles.entries()]
       .map(([filename, files]) => {
@@ -167,7 +201,12 @@ export class LoadedParsers {
       })
       .flat();
 
-    return await FileUtils.createZipArchive(archiveFiles);
+    return await FileUtils.createZipArchive(
+      archiveFiles,
+      onProgressUpdate
+        ? (perc: number) => onProgressUpdate(0.5 * (1 + perc))
+        : undefined,
+    );
   }
 
   getLatestRealToMonotonicOffset(
@@ -200,31 +239,19 @@ export class LoadedParsers {
     return p?.getRealToBootTimeOffsetNs();
   }
 
-  private addLegacyParsers(
-    parsers: FileAndParser[],
-    userNotificationsListener: UserNotificationsListener,
-  ) {
+  private addLegacyParsers(parsers: FileAndParser[]) {
     const legacyParsersBeingLoaded = new Map<TraceType, Parser<object>>();
 
     parsers.forEach((fileAndParser) => {
       const {parser} = fileAndParser;
-      if (
-        this.shouldUseLegacyParser(
-          parser,
-          legacyParsersBeingLoaded,
-          userNotificationsListener,
-        )
-      ) {
+      if (this.shouldUseLegacyParser(parser)) {
         legacyParsersBeingLoaded.set(parser.getTraceType(), parser);
         this.legacyParsers.push(fileAndParser);
       }
     });
   }
 
-  private addPerfettoParsers(
-    {file, parsers}: FileAndParsers,
-    userNotificationsListener: UserNotificationsListener,
-  ) {
+  private addPerfettoParsers({file, parsers}: FileAndParsers) {
     // We currently run only one Perfetto TP WebWorker at a time, so Perfetto parsers previously
     // loaded are now invalid and must be removed (previous WebWorker is not running anymore).
     this.perfettoParsers = [];
@@ -239,20 +266,16 @@ export class LoadedParsers {
         const isOverriddenByPerfettoParser =
           fileAndParser.parser.getTraceType() === parser.getTraceType();
         if (isOverriddenByPerfettoParser) {
-          userNotificationsListener.onNotifications([
+          UserNotifier.add(
             new TraceOverridden(fileAndParser.parser.getDescriptors().join()),
-          ]);
+          );
         }
         return !isOverriddenByPerfettoParser;
       });
     });
   }
 
-  private shouldUseLegacyParser(
-    newParser: Parser<object>,
-    parsersBeingLoaded: Map<TraceType, Parser<object>>,
-    userNotificationsListener: UserNotificationsListener,
-  ): boolean {
+  private shouldUseLegacyParser(newParser: Parser<object>): boolean {
     // While transitioning to the Perfetto format, devices might still have old legacy trace files
     // dangling in the disk that get automatically included into bugreports. Hence, Perfetto parsers
     // must always override legacy ones so that dangling legacy files are ignored.
@@ -261,9 +284,7 @@ export class LoadedParsers {
         fileAndParser.parser.getTraceType() === newParser.getTraceType(),
     );
     if (isOverriddenByPerfettoParser) {
-      userNotificationsListener.onNotifications([
-        new TraceOverridden(newParser.getDescriptors().join()),
-      ]);
+      UserNotifier.add(new TraceOverridden(newParser.getDescriptors().join()));
       return false;
     }
 
@@ -272,7 +293,6 @@ export class LoadedParsers {
 
   private filterOutLegacyParsersWithOldData(
     newLegacyParsers: FileAndParser[],
-    userNotificationsListener: UserNotificationsListener,
   ): FileAndParser[] {
     let allParsers = [
       ...newLegacyParsers,
@@ -294,9 +314,7 @@ export class LoadedParsers {
           Math.abs(Number(monotonicOffset - latestMonotonicOffset)) >
           LoadedParsers.MAX_ALLOWED_TIME_GAP_BETWEEN_RTE_OFFSET;
         if (isOldData) {
-          userNotificationsListener.onNotifications([
-            new TraceHasOldData(file.getDescriptor()),
-          ]);
+          UserNotifier.add(new TraceHasOldData(file.getDescriptor()));
           return false;
         }
       }
@@ -307,9 +325,7 @@ export class LoadedParsers {
           Math.abs(Number(bootTimeOffset - latestBootTimeOffset)) >
           LoadedParsers.MAX_ALLOWED_TIME_GAP_BETWEEN_RTE_OFFSET;
         if (isOldData) {
-          userNotificationsListener.onNotifications([
-            new TraceHasOldData(file.getDescriptor()),
-          ]);
+          UserNotifier.add(new TraceHasOldData(file.getDescriptor()));
           return false;
         }
       }
@@ -354,9 +370,7 @@ export class LoadedParsers {
       const endTimestamp = timestamps[timestamps.length - 1];
       const isOldData = endTimestamp.getValueNs() <= timeGap.from.getValueNs();
       if (isOldData) {
-        userNotificationsListener.onNotifications([
-          new TraceHasOldData(file.getDescriptor(), timeGap),
-        ]);
+        UserNotifier.add(new TraceHasOldData(file.getDescriptor(), timeGap));
         return false;
       }
 
@@ -366,7 +380,6 @@ export class LoadedParsers {
 
   private filterScreenshotParsersIfRequired(
     newLegacyParsers: FileAndParser[],
-    userNotificationsListener: UserNotificationsListener,
   ): FileAndParser[] {
     const hasOldScreenRecordingParsers = this.legacyParsers.some(
       (entry) => entry.parser.getTraceType() === TraceType.SCREEN_RECORDING,
@@ -391,22 +404,22 @@ export class LoadedParsers {
     );
 
     oldScreenshotParsers.forEach((fileAndParser) => {
-      userNotificationsListener.onNotifications([
+      UserNotifier.add(
         new TraceOverridden(
           fileAndParser.parser.getDescriptors().join(),
           TraceType.SCREEN_RECORDING,
         ),
-      ]);
+      );
       this.remove(fileAndParser.parser);
     });
 
     newScreenshotParsers.forEach((newScreenshotParser) => {
-      userNotificationsListener.onNotifications([
+      UserNotifier.add(
         new TraceOverridden(
           newScreenshotParser.parser.getDescriptors().join(),
           TraceType.SCREEN_RECORDING,
         ),
-      ]);
+      );
     });
 
     return newLegacyParsers.filter(
@@ -418,7 +431,6 @@ export class LoadedParsers {
   private filterOutParsersWithoutOffsetsIfRequired(
     newLegacyParsers: FileAndParser[],
     perfettoParsers: FileAndParsers | undefined,
-    userNotificationsListener: UserNotificationsListener,
   ): FileAndParser[] {
     const hasParserWithOffset =
       perfettoParsers ||
@@ -450,9 +462,7 @@ export class LoadedParsers {
           parser.getRealToMonotonicTimeOffsetNs() !== undefined ||
           parser.getRealToBootTimeOffsetNs() !== undefined;
         if (!hasOffset) {
-          userNotificationsListener.onNotifications([
-            new TraceHasOldData(parser.getDescriptors().join()),
-          ]);
+          UserNotifier.add(new TraceHasOldData(parser.getDescriptors().join()));
         }
         return hasOffset;
       });
@@ -461,35 +471,6 @@ export class LoadedParsers {
     return newLegacyParsers;
   }
 
-  private enforceLimitOfSingleScreenshotOrScreenRecordingParser(
-    userNotificationsListener: UserNotificationsListener,
-  ) {
-    let firstScreenshotOrScreenrecordingParser: Parser<object> | undefined;
-
-    this.legacyParsers = this.legacyParsers.filter((fileAndParser) => {
-      const parser = fileAndParser.parser;
-      if (
-        parser.getTraceType() !== TraceType.SCREENSHOT &&
-        parser.getTraceType() !== TraceType.SCREEN_RECORDING
-      ) {
-        return true;
-      }
-
-      if (firstScreenshotOrScreenrecordingParser) {
-        userNotificationsListener.onNotifications([
-          new TraceOverridden(
-            parser.getDescriptors().join(),
-            firstScreenshotOrScreenrecordingParser.getTraceType(),
-          ),
-        ]);
-        return false;
-      }
-
-      firstScreenshotOrScreenrecordingParser = parser;
-      return true;
-    });
-  }
-
   private findLastTimeGapAboveThreshold(
     ranges: readonly TimeRange[],
   ): TimeRange | undefined {
diff --git a/tools/winscope/src/app/loaded_parsers_test.ts b/tools/winscope/src/app/loaded_parsers_test.ts
index 33bc5756a..ed30fb89d 100644
--- a/tools/winscope/src/app/loaded_parsers_test.ts
+++ b/tools/winscope/src/app/loaded_parsers_test.ts
@@ -23,6 +23,7 @@ import {FileAndParser} from 'parsers/file_and_parser';
 import {FileAndParsers} from 'parsers/file_and_parsers';
 import {ParserBuilder} from 'test/unit/parser_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
 import {TraceType} from 'trace/trace_type';
@@ -134,11 +135,16 @@ describe('LoadedParsers', () => {
     .build();
 
   let loadedParsers: LoadedParsers;
-  let warnings: UserWarning[] = [];
+  let userNotifierChecker: UserNotifierChecker;
 
-  beforeEach(async () => {
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
+  beforeEach(() => {
     loadedParsers = new LoadedParsers();
     expect(loadedParsers.getParsers().length).toEqual(0);
+    userNotifierChecker.reset();
   });
 
   it('can load a single legacy parser', () => {
@@ -388,13 +394,8 @@ describe('LoadedParsers', () => {
       expectLoadResult([parserScreenRecording0], []);
     });
 
-    it('discards screenshot parser in favour of screen recording parser', () => {
-      loadParsers([parserScreenshot0, parserScreenRecording0], []);
-      expectLoadResult([parserScreenRecording0], [overrideError]);
-    });
-
     it('does not load screenshot parser after loading screen recording parser in same call', () => {
-      loadParsers([parserScreenRecording0, parserScreenshot0], []);
+      loadParsers([parserScreenshot0, parserScreenRecording0], []);
       expectLoadResult([parserScreenRecording0], [overrideError]);
     });
 
@@ -414,32 +415,12 @@ describe('LoadedParsers', () => {
       expectLoadResult([parserScreenRecording0], [overrideError]);
     });
 
-    it('enforces limit of single screenshot or screenrecord parser', () => {
-      loadParsers([parserScreenshot0], []);
-      expectLoadResult([parserScreenshot0], []);
-
-      loadParsers([parserScreenshot1], []);
-      expectLoadResult(
-        [parserScreenshot0],
-        [new TraceOverridden('screenshot.png', TraceType.SCREENSHOT)],
-      );
-
+    it('loads multiple screen recordings', () => {
       loadParsers([parserScreenRecording0], []);
-      expectLoadResult(
-        [parserScreenRecording0],
-        [new TraceOverridden('screenshot.png', TraceType.SCREEN_RECORDING)],
-      );
+      expectLoadResult([parserScreenRecording0], []);
 
       loadParsers([parserScreenRecording1], []);
-      expectLoadResult(
-        [parserScreenRecording0],
-        [
-          new TraceOverridden(
-            'screen_recording.mp4',
-            TraceType.SCREEN_RECORDING,
-          ),
-        ],
-      );
+      expectLoadResult([parserScreenRecording0, parserScreenRecording1], []);
     });
   });
 
@@ -454,6 +435,19 @@ describe('LoadedParsers', () => {
     expectLoadResult([], []);
   });
 
+  it('can remove parsers but keep for download', async () => {
+    loadParsers([parserSf0, parserWm0], []);
+    expectLoadResult([parserSf0, parserWm0], []);
+
+    loadedParsers.remove(parserWm0, true);
+    expectLoadResult([parserSf0], []);
+
+    await expectDownloadResult([
+      'sf/filename.winscope',
+      'wm/filename.winscope',
+    ]);
+  });
+
   it('can be cleared', () => {
     loadedParsers.clear();
     loadParsers([parserSf0], [parserWm0]);
@@ -512,20 +506,28 @@ describe('LoadedParsers', () => {
       [],
     );
 
-    const zipArchive = await loadedParsers.makeZipArchive();
-    const zipFile = new File([zipArchive], 'winscope.zip');
-    const actualArchiveContents = (await FileUtils.unzipFile(zipFile))
-      .map((file) => file.name)
-      .sort();
-
-    const expectedArchiveContents = [
+    await expectDownloadResult([
       'filename.mp4',
       'filename.perfetto-trace',
       'vc/filename.winscope',
       'wm/filename (1).pb',
       'wm/filename.pb',
-    ];
-    expect(actualArchiveContents).toEqual(expectedArchiveContents);
+    ]);
+  });
+
+  it('makes zip archive with progress listener', async () => {
+    loadParsers([parserSf0], [parserWm0]);
+    expectLoadResult([parserSf0, parserWm0], []);
+
+    const progressSpy = jasmine.createSpy();
+    await loadedParsers.makeZipArchive(progressSpy);
+
+    expect(progressSpy).toHaveBeenCalledTimes(5);
+    expect(progressSpy).toHaveBeenCalledWith(0);
+    expect(progressSpy).toHaveBeenCalledWith(0.25);
+    expect(progressSpy).toHaveBeenCalledWith(0.5);
+    expect(progressSpy).toHaveBeenCalledWith(0.75);
+    expect(progressSpy).toHaveBeenCalledWith(1);
   });
 
   function loadParsers(
@@ -544,18 +546,7 @@ describe('LoadedParsers', () => {
         ? new FileAndParsers(perfettoTraceFile, perfetto)
         : undefined;
 
-    warnings = [];
-    const listener = {
-      onNotifications(notifications: UserWarning[]) {
-        warnings.push(...notifications);
-      },
-    };
-
-    loadedParsers.addParsers(
-      legacyFileAndParsers,
-      perfettoFileAndParsers,
-      listener,
-    );
+    loadedParsers.addParsers(legacyFileAndParsers, perfettoFileAndParsers);
   }
 
   function expectLoadResult(
@@ -566,6 +557,14 @@ describe('LoadedParsers', () => {
     expect(actualParsers.length).toEqual(expectedParsers.length);
     expect(new Set([...actualParsers])).toEqual(new Set([...expectedParsers]));
 
-    expect(warnings).toEqual(expectedWarnings);
+    userNotifierChecker.expectAdded(expectedWarnings);
+  }
+
+  async function expectDownloadResult(expectedArchiveContents: string[]) {
+    const zipArchive = await loadedParsers.makeZipArchive();
+    const actualArchiveContents = (await FileUtils.unzipFile(zipArchive))
+      .map((file) => file.name)
+      .sort();
+    expect(actualArchiveContents).toEqual(expectedArchiveContents);
   }
 });
diff --git a/tools/winscope/src/app/mediator.ts b/tools/winscope/src/app/mediator.ts
index 31c7bf1f2..2482793b5 100644
--- a/tools/winscope/src/app/mediator.ts
+++ b/tools/winscope/src/app/mediator.ts
@@ -14,13 +14,22 @@
  * limitations under the License.
  */
 
+import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
 import {Timestamp} from 'common/time';
 import {TimeUtils} from 'common/time_utils';
+import {UserNotifier} from 'common/user_notifier';
 import {CrossToolProtocol} from 'cross_tool/cross_tool_protocol';
 import {Analytics} from 'logging/analytics';
 import {ProgressListener} from 'messaging/progress_listener';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
 import {UserWarning} from 'messaging/user_warning';
+import {
+  CannotVisualizeTraceEntry,
+  FailedToInitializeTimelineData,
+  IncompleteFrameMapping,
+  NoTraceTargetsSelected,
+  NoValidFiles,
+} from 'messaging/user_warnings';
 import {
   ActiveTraceChanged,
   ExpandedTimelineToggled,
@@ -33,7 +42,10 @@ import {
 import {WinscopeEventEmitter} from 'messaging/winscope_event_emitter';
 import {WinscopeEventListener} from 'messaging/winscope_event_listener';
 import {TraceEntry} from 'trace/trace';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TracePosition} from 'trace/trace_position';
+import {TraceType} from 'trace/trace_type';
+import {RequestedTraceTypes} from 'trace_collection/adb_files';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {ViewerFactory} from 'viewers/viewer_factory';
 import {FilesSource} from './files_source';
@@ -45,12 +57,13 @@ export class Mediator {
     WinscopeEventListener;
   private crossToolProtocol: CrossToolProtocol;
   private uploadTracesComponent?: ProgressListener;
-  private collectTracesComponent?: ProgressListener & WinscopeEventListener;
+  private collectTracesComponent?: ProgressListener &
+    WinscopeEventEmitter &
+    WinscopeEventListener;
   private traceViewComponent?: WinscopeEventEmitter & WinscopeEventListener;
   private timelineComponent?: WinscopeEventEmitter & WinscopeEventListener;
   private appComponent: WinscopeEventListener;
-  private userNotificationsListener: UserNotificationsListener;
-  private storage: Storage;
+  private storage: Store;
 
   private tracePipeline: TracePipeline;
   private timelineData: TimelineData;
@@ -66,15 +79,13 @@ export class Mediator {
     abtChromeExtensionProtocol: WinscopeEventEmitter & WinscopeEventListener,
     crossToolProtocol: CrossToolProtocol,
     appComponent: WinscopeEventListener,
-    userNotificationsListener: UserNotificationsListener,
-    storage: Storage,
+    storage: Store,
   ) {
     this.tracePipeline = tracePipeline;
     this.timelineData = timelineData;
     this.abtChromeExtensionProtocol = abtChromeExtensionProtocol;
     this.crossToolProtocol = crossToolProtocol;
     this.appComponent = appComponent;
-    this.userNotificationsListener = userNotificationsListener;
     this.storage = storage;
 
     this.crossToolProtocol.setEmitEvent(async (event) => {
@@ -91,9 +102,14 @@ export class Mediator {
   }
 
   setCollectTracesComponent(
-    component: (ProgressListener & WinscopeEventListener) | undefined,
+    component:
+      | (ProgressListener & WinscopeEventEmitter & WinscopeEventListener)
+      | undefined,
   ) {
     this.collectTracesComponent = component;
+    this.collectTracesComponent?.setEmitEvent(async (event) => {
+      await this.onWinscopeEvent(event);
+    });
   }
 
   setTraceViewComponent(
@@ -122,12 +138,34 @@ export class Mediator {
     await event.visit(WinscopeEventType.APP_FILES_UPLOADED, async (event) => {
       this.currentProgressListener = this.uploadTracesComponent;
       await this.loadFiles(event.files, FilesSource.UPLOADED);
+      UserNotifier.notify();
     });
 
     await event.visit(WinscopeEventType.APP_FILES_COLLECTED, async (event) => {
       this.currentProgressListener = this.collectTracesComponent;
-      await this.loadFiles(event.files, FilesSource.COLLECTED);
-      await this.loadViewers();
+      if (event.files.collected.length > 0) {
+        await this.loadFiles(event.files.collected, FilesSource.COLLECTED);
+        const traces = this.tracePipeline.getTraces();
+        if (traces.getSize() > 0) {
+          const failedTraces: string[] = [];
+          event.files.requested.forEach((requested: RequestedTraceTypes) => {
+            if (
+              !requested.types.some((type) => traces.getTraces(type).length > 0)
+            ) {
+              failedTraces.push(requested.name);
+            }
+          });
+          if (failedTraces.length > 0) {
+            UserNotifier.add(new NoValidFiles(failedTraces));
+          }
+          await this.loadViewers();
+        } else {
+          this.currentProgressListener?.onOperationFinished(false);
+        }
+      } else {
+        UserNotifier.add(new NoValidFiles());
+      }
+      UserNotifier.notify();
     });
 
     await event.visit(WinscopeEventType.APP_RESET_REQUEST, async () => {
@@ -144,6 +182,7 @@ export class Mediator {
 
     await event.visit(WinscopeEventType.APP_TRACE_VIEW_REQUEST, async () => {
       await this.loadViewers();
+      UserNotifier.notify();
     });
 
     await event.visit(
@@ -201,6 +240,7 @@ export class Mediator {
         this.timelineData.getCurrentPosition(),
         false,
       );
+      UserNotifier.notify();
     });
 
     await event.visit(
@@ -210,6 +250,7 @@ export class Mediator {
           this.timelineData.setPosition(event.position);
         }
         await this.propagateTracePosition(event.position, false);
+        UserNotifier.notify();
       },
     );
 
@@ -227,26 +268,39 @@ export class Mediator {
 
     await event.visit(WinscopeEventType.DARK_MODE_TOGGLED, async (event) => {
       await this.timelineComponent?.onWinscopeEvent(event);
+      for (const viewer of this.viewers) {
+        await viewer.onWinscopeEvent(event);
+      }
     });
+
+    await event.visit(
+      WinscopeEventType.NO_TRACE_TARGETS_SELECTED,
+      async (event) => {
+        UserNotifier.add(new NoTraceTargetsSelected()).notify();
+      },
+    );
+
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_SAVE_REQUEST,
+      async (event) => {
+        await this.findViewerByType(event.traceType)?.onWinscopeEvent(event);
+      },
+    );
+
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        await this.findViewerByType(event.traceType)?.onWinscopeEvent(event);
+      },
+    );
   }
 
   private async loadFiles(files: File[], source: FilesSource) {
-    const warnings: UserWarning[] = [];
-    const notificationsListener: UserNotificationsListener = {
-      onNotifications(notifications: UserWarning[]) {
-        warnings.push(...notifications);
-      },
-    };
     await this.tracePipeline.loadFiles(
       files,
       source,
-      notificationsListener,
       this.currentProgressListener,
     );
-
-    if (warnings.length > 0) {
-      this.userNotificationsListener.onNotifications(warnings);
-    }
   }
 
   private async propagateTracePosition(
@@ -258,23 +312,36 @@ export class Mediator {
     }
 
     const event = new TracePositionUpdate(position);
-    const receivers: WinscopeEventListener[] = [...this.viewers].filter(
-      (viewer) => this.isViewerVisible(viewer),
+    const viewers: Viewer[] = [...this.viewers].filter((viewer) =>
+      this.isViewerVisible(viewer),
     );
-    if (this.timelineComponent) {
-      receivers.push(this.timelineComponent);
+
+    const warnings: UserWarning[] = [];
+
+    for (const viewer of viewers) {
+      try {
+        await viewer.onWinscopeEvent(event);
+      } catch (e) {
+        const traceType = assertDefined(viewer.getTraces().at(0)?.type);
+        warnings.push(
+          new CannotVisualizeTraceEntry(
+            `Cannot parse entry for ${TRACE_INFO[traceType].name} trace: Trace may be corrupted.`,
+          ),
+        );
+      }
     }
 
-    const promises = receivers.map((receiver) => {
-      return receiver.onWinscopeEvent(event);
-    });
+    if (this.timelineComponent) {
+      await this.timelineComponent.onWinscopeEvent(event);
+    }
 
     if (!omitCrossToolProtocol) {
-      const event = new TracePositionUpdate(position);
-      promises.push(this.crossToolProtocol.onWinscopeEvent(event));
+      await this.crossToolProtocol.onWinscopeEvent(event);
     }
 
-    await Promise.all(promises);
+    if (warnings.length > 0) {
+      warnings.forEach((w) => UserNotifier.add(w));
+    }
   }
 
   private isViewerVisible(viewer: Viewer): boolean {
@@ -317,12 +384,14 @@ export class Mediator {
       this.timelineData.getCurrentPosition(),
       true,
     );
+    UserNotifier.notify();
   }
 
   private async processRemoteFilesReceived(files: File[], source: FilesSource) {
     await this.resetAppToInitialState();
     this.currentProgressListener = this.uploadTracesComponent;
     await this.loadFiles(files, source);
+    UserNotifier.notify();
   }
 
   private async loadViewers() {
@@ -336,8 +405,18 @@ export class Mediator {
     await TimeUtils.sleepMs(10);
 
     this.tracePipeline.filterTracesWithoutVisualization();
-    await this.tracePipeline.buildTraces();
-    this.currentProgressListener?.onOperationFinished();
+    if (this.tracePipeline.getTraces().getSize() === 0) {
+      this.currentProgressListener?.onOperationFinished(false);
+      return;
+    }
+
+    try {
+      await this.tracePipeline.buildTraces();
+      this.currentProgressListener?.onOperationFinished(true);
+    } catch (e) {
+      UserNotifier.add(new IncompleteFrameMapping((e as Error).message));
+      this.currentProgressListener?.onOperationFinished(false);
+    }
 
     this.currentProgressListener?.onProgressUpdate(
       'Initializing UI...',
@@ -348,11 +427,17 @@ export class Mediator {
     // allow the UI to update before making the main thread very busy
     await TimeUtils.sleepMs(10);
 
-    await this.timelineData.initialize(
-      this.tracePipeline.getTraces(),
-      await this.tracePipeline.getScreenRecordingVideo(),
-      this.tracePipeline.getTimestampConverter(),
-    );
+    try {
+      await this.timelineData.initialize(
+        this.tracePipeline.getTraces(),
+        await this.tracePipeline.getScreenRecordingVideo(),
+        this.tracePipeline.getTimestampConverter(),
+      );
+    } catch {
+      this.currentProgressListener?.onOperationFinished(false);
+      UserNotifier.add(new FailedToInitializeTimelineData());
+      return;
+    }
 
     this.viewers = new ViewerFactory().createViewers(
       this.tracePipeline.getTraces(),
@@ -451,4 +536,8 @@ export class Mediator {
       await overlay.onWinscopeEvent(event);
     }
   }
+
+  private findViewerByType(type: TraceType): Viewer | undefined {
+    return this.viewers.find((viewer) => viewer.getTraces()[0].type === type);
+  }
 }
diff --git a/tools/winscope/src/app/mediator_test.ts b/tools/winscope/src/app/mediator_test.ts
index 17024c59a..743787eb4 100644
--- a/tools/winscope/src/app/mediator_test.ts
+++ b/tools/winscope/src/app/mediator_test.ts
@@ -17,21 +17,33 @@
 import {assertDefined} from 'common/assert_utils';
 import {FunctionUtils} from 'common/function_utils';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {INVALID_TIME_NS, TimezoneInfo} from 'common/time';
+import {TimezoneInfo} from 'common/time';
 import {TimestampConverter} from 'common/timestamp_converter';
 import {CrossToolProtocol} from 'cross_tool/cross_tool_protocol';
 import {ProgressListener} from 'messaging/progress_listener';
 import {ProgressListenerStub} from 'messaging/progress_listener_stub';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
-import {UserNotificationsListenerStub} from 'messaging/user_notifications_listener_stub';
+import {UserWarning} from 'messaging/user_warning';
+import {
+  FailedToCreateTracesParser,
+  IncompleteFrameMapping,
+  InvalidLegacyTrace,
+  NoTraceTargetsSelected,
+  NoValidFiles,
+  UnsupportedFileFormat,
+} from 'messaging/user_warnings';
 import {
   ActiveTraceChanged,
   AppFilesCollected,
   AppFilesUploaded,
   AppInitialized,
   AppRefreshDumpsRequest,
+  AppResetRequest,
   AppTraceViewRequest,
+  DarkModeToggled,
   ExpandedTimelineToggled,
+  FilterPresetApplyRequest,
+  FilterPresetSaveRequest,
+  NoTraceTargetsSelected as NoTraceTargetsSelectedEvent,
   RemoteToolDownloadStart,
   RemoteToolFilesReceived,
   RemoteToolTimestampReceived,
@@ -39,6 +51,7 @@ import {
   TabbedViewSwitchRequest,
   TracePositionUpdate,
   ViewersLoaded,
+  ViewersUnloaded,
   WinscopeEvent,
   WinscopeEventType,
 } from 'messaging/winscope_event';
@@ -48,6 +61,7 @@ import {WinscopeEventListener} from 'messaging/winscope_event_listener';
 import {WinscopeEventListenerStub} from 'messaging/winscope_event_listener_stub';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Trace} from 'trace/trace';
 import {TracePosition} from 'trace/trace_position';
@@ -61,21 +75,27 @@ import {TimelineData} from './timeline_data';
 import {TracePipeline} from './trace_pipeline';
 
 describe('Mediator', () => {
+  const TIMESTAMP_10 = TimestampConverterUtils.makeRealTimestamp(10n);
+  const TIMESTAMP_11 = TimestampConverterUtils.makeRealTimestamp(11n);
+
+  const POSITION_10 = TracePosition.fromTimestamp(TIMESTAMP_10);
+  const POSITION_11 = TracePosition.fromTimestamp(TIMESTAMP_11);
+
   const traceSf = new TraceBuilder<HierarchyTreeNode>()
     .setType(TraceType.SURFACE_FLINGER)
-    .setEntries([])
+    .setTimestamps([TIMESTAMP_10])
     .build();
   const traceWm = new TraceBuilder<HierarchyTreeNode>()
     .setType(TraceType.WINDOW_MANAGER)
-    .setEntries([])
+    .setTimestamps([TIMESTAMP_11])
     .build();
   const traceDump = new TraceBuilder<HierarchyTreeNode>()
     .setType(TraceType.SURFACE_FLINGER)
-    .setTimestamps([TimestampConverterUtils.makeRealTimestamp(INVALID_TIME_NS)])
+    .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
     .build();
 
   let inputFiles: File[];
-  let userNotificationsListener: UserNotificationsListener;
+  let eventLogFile: File;
   let tracePipeline: TracePipeline;
   let timelineData: TimelineData;
   let abtChromeExtensionProtocol: WinscopeEventEmitter & WinscopeEventListener;
@@ -83,10 +103,13 @@ describe('Mediator', () => {
   let appComponent: WinscopeEventListener;
   let timelineComponent: WinscopeEventEmitter & WinscopeEventListener;
   let uploadTracesComponent: ProgressListenerStub;
-  let collectTracesComponent: ProgressListenerStub & WinscopeEventListenerStub;
+  let collectTracesComponent: ProgressListenerStub &
+    WinscopeEventEmitterStub &
+    WinscopeEventListenerStub;
   let traceViewComponent: WinscopeEventEmitter & WinscopeEventListener;
   let mediator: Mediator;
-  let spies: Array<jasmine.Spy<any>>;
+  let spies: Array<jasmine.Spy<jasmine.Func>>;
+  let userNotifierChecker: UserNotifierChecker;
 
   const viewerStub0 = new ViewerStub('Title0', undefined, traceSf);
   const viewerStub1 = new ViewerStub('Title1', undefined, traceWm);
@@ -100,12 +123,6 @@ describe('Mediator', () => {
   const viewers = [viewerStub0, viewerStub1, viewerOverlay, viewerDump];
   let tracePositionUpdateListeners: WinscopeEventListener[];
 
-  const TIMESTAMP_10 = TimestampConverterUtils.makeRealTimestamp(10n);
-  const TIMESTAMP_11 = TimestampConverterUtils.makeRealTimestamp(11n);
-
-  const POSITION_10 = TracePosition.fromTimestamp(TIMESTAMP_10);
-  const POSITION_11 = TracePosition.fromTimestamp(TIMESTAMP_11);
-
   beforeAll(async () => {
     inputFiles = [
       await UnitTestUtils.getFixtureFile(
@@ -118,11 +135,15 @@ describe('Mediator', () => {
         'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
       ),
     ];
+    eventLogFile = await UnitTestUtils.getFixtureFile(
+      'traces/eventlog_no_cujs.winscope',
+    );
+    userNotifierChecker = new UserNotifierChecker();
   });
 
-  beforeEach(async () => {
+  beforeEach(() => {
+    userNotifierChecker.reset();
     jasmine.addCustomEqualityTester(tracePositionUpdateEqualityTester);
-    userNotificationsListener = new UserNotificationsListenerStub();
     tracePipeline = new TracePipeline();
     timelineData = new TimelineData();
     abtChromeExtensionProtocol = FunctionUtils.mixin(
@@ -139,8 +160,11 @@ describe('Mediator', () => {
     );
     uploadTracesComponent = new ProgressListenerStub();
     collectTracesComponent = FunctionUtils.mixin(
-      new ProgressListenerStub(),
-      new WinscopeEventListenerStub(),
+      FunctionUtils.mixin(
+        new ProgressListenerStub(),
+        new WinscopeEventListenerStub(),
+      ),
+      new WinscopeEventEmitterStub(),
     );
     traceViewComponent = FunctionUtils.mixin(
       new WinscopeEventEmitterStub(),
@@ -152,7 +176,6 @@ describe('Mediator', () => {
       abtChromeExtensionProtocol,
       crossToolProtocol,
       appComponent,
-      userNotificationsListener,
       new InMemoryStorage(),
     );
     mediator.setTimelineComponent(timelineComponent);
@@ -180,7 +203,6 @@ describe('Mediator', () => {
       spyOn(traceViewComponent, 'onWinscopeEvent'),
       spyOn(uploadTracesComponent, 'onProgressUpdate'),
       spyOn(uploadTracesComponent, 'onOperationFinished'),
-      spyOn(userNotificationsListener, 'onNotifications'),
       spyOn(viewerStub0, 'onWinscopeEvent'),
       spyOn(viewerStub1, 'onWinscopeEvent'),
       spyOn(viewerOverlay, 'onWinscopeEvent'),
@@ -209,13 +231,120 @@ describe('Mediator', () => {
     resetSpyCalls();
     await mediator.onWinscopeEvent(new AppTraceViewRequest());
     await checkLoadTraceViewEvents(uploadTracesComponent);
+    userNotifierChecker.expectNotified([]);
   });
 
   it('handles collected traces from Winscope', async () => {
-    await mediator.onWinscopeEvent(new AppFilesCollected(inputFiles));
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({requested: [], collected: inputFiles}),
+    );
+    userNotifierChecker.expectNotified([]);
     await checkLoadTraceViewEvents(collectTracesComponent);
   });
 
+  it('handles invalid collected traces from Winscope', async () => {
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({
+        requested: [],
+        collected: [await UnitTestUtils.getFixtureFile('traces/empty.pb')],
+      }),
+    );
+    expect(
+      userNotifierChecker.expectNotified([
+        new UnsupportedFileFormat('empty.pb'),
+      ]),
+    );
+    expect(appComponent.onWinscopeEvent).not.toHaveBeenCalled();
+  });
+
+  it('handles collected traces with no entries from Winscope', async () => {
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({
+        requested: [],
+        collected: [
+          await UnitTestUtils.getFixtureFile(
+            'traces/no_entries_InputMethodClients.pb',
+          ),
+        ],
+      }),
+    );
+    expect(
+      userNotifierChecker.expectNotified([
+        new InvalidLegacyTrace(
+          'no_entries_InputMethodClients.pb',
+          'Trace has no entries',
+        ),
+      ]),
+    );
+    expect(appComponent.onWinscopeEvent).not.toHaveBeenCalled();
+  });
+
+  it('handles collected trace with no visualization from Winscope', async () => {
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({
+        requested: [],
+        collected: [eventLogFile],
+      }),
+    );
+    expect(
+      userNotifierChecker.expectNotified([
+        new FailedToCreateTracesParser(
+          TraceType.CUJS,
+          'eventlog_no_cujs.winscope has no relevant entries',
+        ),
+      ]),
+    );
+    expect(appComponent.onWinscopeEvent).not.toHaveBeenCalled();
+  });
+
+  it('handles empty collected traces from Winscope', async () => {
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({
+        requested: [],
+        collected: [],
+      }),
+    );
+    expect(userNotifierChecker.expectNotified([new NoValidFiles()]));
+    expect(appComponent.onWinscopeEvent).not.toHaveBeenCalled();
+  });
+
+  it('handles requested traces with missing collected traces from Winscope', async () => {
+    await mediator.onWinscopeEvent(
+      new AppFilesCollected({
+        requested: [
+          {
+            name: 'Collected Trace',
+            types: [TraceType.EVENT_LOG, TraceType.CUJS],
+          },
+          {
+            name: 'Uncollected Trace',
+            types: [TraceType.TRANSITION],
+          },
+        ],
+        collected: inputFiles.concat([eventLogFile]),
+      }),
+    );
+    expect(
+      userNotifierChecker.expectNotified([
+        new NoValidFiles(['Uncollected Trace']),
+      ]),
+    );
+    expect(appComponent.onWinscopeEvent).toHaveBeenCalled();
+  });
+
+  it('handles app reset request', async () => {
+    await mediator.onWinscopeEvent(new AppFilesUploaded(inputFiles));
+    const clearSpies = [
+      spyOn(tracePipeline, 'clear'),
+      spyOn(timelineData, 'clear'),
+    ];
+    await mediator.onWinscopeEvent(new AppResetRequest());
+    clearSpies.forEach((spy) => expect(spy).toHaveBeenCalled());
+    expect(appComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(
+      new ViewersUnloaded(),
+    );
+  });
+
   it('handles request to refresh dumps', async () => {
     const dumpFiles = [
       await UnitTestUtils.getFixtureFile(
@@ -270,6 +399,7 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(new TracePositionUpdate(POSITION_10));
     checkTracePositionUpdateEvents(
       [viewerStub0, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       POSITION_10,
     );
 
@@ -278,6 +408,7 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(new TracePositionUpdate(POSITION_11));
     checkTracePositionUpdateEvents(
       [viewerStub0, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       POSITION_11,
     );
   });
@@ -300,6 +431,7 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(new TracePositionUpdate(expectedPosition));
     checkTracePositionUpdateEvents(
       [viewerStub0, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       expectedPosition,
       POSITION_10,
     );
@@ -319,6 +451,7 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(new TracePositionUpdate(position, true));
     checkTracePositionUpdateEvents(
       [viewerStub0, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       position,
     );
     expect(
@@ -335,6 +468,7 @@ describe('Mediator', () => {
     resetSpyCalls();
     await mediator.onWinscopeEvent(new AppTraceViewRequest());
     await checkLoadTraceViewEvents(uploadTracesComponent);
+    userNotifierChecker.expectNotified([]);
   });
 
   it('filters traces without visualization on loading viewers', async () => {
@@ -348,30 +482,39 @@ describe('Mediator', () => {
     await loadTraceView();
   });
 
+  it('warns user if frame mapping fails', async () => {
+    const errorMsg = 'frame mapping failed';
+    spyOn(tracePipeline, 'buildTraces').and.throwError(errorMsg);
+    const dumpFile = await UnitTestUtils.getFixtureFile(
+      'traces/dump_WindowManager.pb',
+    );
+    await mediator.onWinscopeEvent(new AppFilesUploaded([dumpFile]));
+
+    resetSpyCalls();
+    await mediator.onWinscopeEvent(new AppTraceViewRequest());
+    await checkLoadTraceViewEvents(uploadTracesComponent);
+    userNotifierChecker.expectNotified([new IncompleteFrameMapping(errorMsg)]);
+  });
+
   describe('timestamp received from remote tool', () => {
     it('propagates trace position update', async () => {
       tracePipeline.getTimestampConverter().setRealToMonotonicTimeOffsetNs(0n);
       await loadFiles();
       await loadTraceView();
+      const traceSfEntry = assertDefined(
+        tracePipeline.getTraces().getTrace(TraceType.SURFACE_FLINGER),
+      ).getEntry(2);
 
       // receive timestamp
       resetSpyCalls();
       await mediator.onWinscopeEvent(
-        new RemoteToolTimestampReceived(() => TIMESTAMP_10),
-      );
-      checkTracePositionUpdateEvents(
-        [viewerStub0, viewerOverlay, timelineComponent],
-        POSITION_10,
+        new RemoteToolTimestampReceived(() => traceSfEntry.getTimestamp()),
       );
 
-      // receive timestamp
-      resetSpyCalls();
-      await mediator.onWinscopeEvent(
-        new RemoteToolTimestampReceived(() => TIMESTAMP_11),
-      );
       checkTracePositionUpdateEvents(
         [viewerStub0, viewerOverlay, timelineComponent],
-        POSITION_11,
+        [],
+        TracePosition.fromTraceEntry(traceSfEntry),
       );
     });
 
@@ -385,34 +528,46 @@ describe('Mediator', () => {
       await mediator.onWinscopeEvent(
         new RemoteToolTimestampReceived(() => TIMESTAMP_10),
       );
-      checkTracePositionUpdateEvents([
-        viewerStub0,
-        viewerOverlay,
-        timelineComponent,
-      ]);
+      checkTracePositionUpdateEvents(
+        [viewerStub0, viewerOverlay, timelineComponent],
+        [],
+      );
     });
 
     it('defers trace position propagation till traces are loaded and visualized', async () => {
       // ensure converter has been used to create real timestamps
       tracePipeline.getTimestampConverter().makeTimestampFromRealNs(0n);
+
+      // load files but do not load trace view
+      await loadFiles();
+      expect(timelineComponent.onWinscopeEvent).not.toHaveBeenCalled();
+      const traceSf = assertDefined(
+        tracePipeline.getTraces().getTrace(TraceType.SURFACE_FLINGER),
+      );
+
       // keep timestamp for later
       await mediator.onWinscopeEvent(
-        new RemoteToolTimestampReceived(() => TIMESTAMP_10),
+        new RemoteToolTimestampReceived(() =>
+          traceSf.getEntry(1).getTimestamp(),
+        ),
       );
       expect(timelineComponent.onWinscopeEvent).not.toHaveBeenCalled();
 
       // keep timestamp for later (replace previous one)
       await mediator.onWinscopeEvent(
-        new RemoteToolTimestampReceived(() => TIMESTAMP_11),
+        new RemoteToolTimestampReceived(() =>
+          traceSf.getEntry(2).getTimestamp(),
+        ),
       );
       expect(timelineComponent.onWinscopeEvent).not.toHaveBeenCalled();
 
       // apply timestamp
-      await loadFiles();
       await loadTraceView();
 
       expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
-        makeExpectedTracePositionUpdate(POSITION_11),
+        makeExpectedTracePositionUpdate(
+          TracePosition.fromTraceEntry(traceSf.getEntry(2)),
+        ),
       );
     });
   });
@@ -428,11 +583,14 @@ describe('Mediator', () => {
       expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledWith(
         new ActiveTraceChanged(view.traces[0]),
       );
+      userNotifierChecker.expectNotified([]);
+      userNotifierChecker.reset();
       const viewDump = viewerDump.getViews()[0];
       await mediator.onWinscopeEvent(new TabbedViewSwitched(viewDump));
       expect(timelineComponent.onWinscopeEvent).not.toHaveBeenCalledWith(
         new ActiveTraceChanged(viewDump.traces[0]),
       );
+      userNotifierChecker.expectNotified([]);
     });
 
     it('forwards switch requests from viewers to trace view component', async () => {
@@ -446,6 +604,7 @@ describe('Mediator', () => {
       expect(traceViewComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(
         new TabbedViewSwitchRequest(traceSf),
       );
+      userNotifierChecker.expectNotified([]);
     });
   });
 
@@ -459,6 +618,7 @@ describe('Mediator', () => {
     await mediator.onWinscopeEvent(new TracePositionUpdate(POSITION_10));
     checkTracePositionUpdateEvents(
       [viewerStub0, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       POSITION_10,
     );
 
@@ -470,6 +630,7 @@ describe('Mediator', () => {
     );
     checkTracePositionUpdateEvents(
       [viewerStub1, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
       undefined,
       undefined,
       true,
@@ -482,12 +643,16 @@ describe('Mediator', () => {
     // Note: overlay viewer is considered always visible
     resetSpyCalls();
     await mediator.onWinscopeEvent(new TracePositionUpdate(POSITION_10));
-    checkTracePositionUpdateEvents([
-      viewerStub1,
-      viewerOverlay,
-      timelineComponent,
-      crossToolProtocol,
-    ]);
+    checkTracePositionUpdateEvents(
+      [viewerStub1, viewerOverlay, timelineComponent, crossToolProtocol],
+      [],
+    );
+  });
+
+  it('notifies timeline of dark mode toggle', async () => {
+    const event = new DarkModeToggled(true);
+    await mediator.onWinscopeEvent(event);
+    expect(timelineComponent.onWinscopeEvent).toHaveBeenCalledOnceWith(event);
   });
 
   it('notifies timeline of active trace change', async () => {
@@ -499,9 +664,42 @@ describe('Mediator', () => {
     );
   });
 
+  it('notifies user of no trace targets selected', async () => {
+    await mediator.onWinscopeEvent(new NoTraceTargetsSelectedEvent());
+    userNotifierChecker.expectNotified([new NoTraceTargetsSelected()]);
+  });
+
+  it('notifies correct viewer of filter preset requests', async () => {
+    await loadFiles();
+    await loadTraceView();
+    resetSpyCalls();
+
+    const saveRequest = new FilterPresetSaveRequest(
+      'test_preset',
+      TraceType.SURFACE_FLINGER,
+    );
+    await mediator.onWinscopeEvent(saveRequest);
+
+    const applyRequest = new FilterPresetApplyRequest(
+      'test_preset',
+      TraceType.WINDOW_MANAGER,
+    );
+    await mediator.onWinscopeEvent(applyRequest);
+
+    await mediator.onWinscopeEvent(
+      new FilterPresetSaveRequest('test_preset', TraceType.PROTO_LOG),
+    );
+    await mediator.onWinscopeEvent(
+      new FilterPresetApplyRequest('test_preset', TraceType.PROTO_LOG),
+    );
+
+    expect(viewerStub0.onWinscopeEvent).toHaveBeenCalledOnceWith(saveRequest);
+    expect(viewerStub1.onWinscopeEvent).toHaveBeenCalledOnceWith(applyRequest);
+  });
+
   async function loadFiles(files = inputFiles) {
     await mediator.onWinscopeEvent(new AppFilesUploaded(files));
-    expect(userNotificationsListener.onNotifications).not.toHaveBeenCalled();
+    userNotifierChecker.expectNone();
     reassignViewerStubTrace(viewerStub0);
     reassignViewerStubTrace(viewerStub1);
   }
@@ -530,6 +728,7 @@ describe('Mediator', () => {
       makeExpectedTracePositionUpdate(),
     );
     expect(viewerStub1.onWinscopeEvent).not.toHaveBeenCalled();
+    userNotifierChecker.expectNotified([]);
   }
 
   async function checkLoadTraceViewEvents(progressListener: ProgressListener) {
@@ -542,21 +741,20 @@ describe('Mediator', () => {
 
     // Mediator triggers the viewers initialization
     // by sending them a "trace position update" event
-    checkTracePositionUpdateEvents([
-      viewerStub0,
-      viewerStub1,
-      viewerOverlay,
-      viewerDump,
-      timelineComponent,
-    ]);
+    checkTracePositionUpdateEvents(
+      [viewerStub0, viewerStub1, viewerOverlay, viewerDump, timelineComponent],
+      [],
+    );
   }
 
   function checkTracePositionUpdateEvents(
     listenersToBeNotified: WinscopeEventListener[],
+    userNotifications: UserWarning[],
     position?: TracePosition,
     crossToolProtocolPosition = position,
     multipleTimelineEvents = false,
   ) {
+    userNotifierChecker.expectNotified(userNotifications);
     const event = makeExpectedTracePositionUpdate(position);
     const crossToolProtocolEvent =
       crossToolProtocolPosition !== position
@@ -582,6 +780,7 @@ describe('Mediator', () => {
     spies.forEach((spy) => {
       spy.calls.reset();
     });
+    userNotifierChecker.reset();
   }
 
   function makeExpectedTracePositionUpdate(
diff --git a/tools/winscope/src/app/styles/overlay_panel.styles.ts b/tools/winscope/src/app/styles/overlay_panel.styles.ts
new file mode 100644
index 000000000..7cfef55ad
--- /dev/null
+++ b/tools/winscope/src/app/styles/overlay_panel.styles.ts
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export const overlayPanelStyles = `
+  .close-button {
+    width: 24px;
+    height: 24px;
+    line-height: 24px;
+  }
+
+  .overlay-panel {
+    font-family: 'Roboto', sans-serif;
+    background: var(--overlay-panel-background-color);
+    box-shadow: 0px 0px 9px 0px rgba(0, 0, 0, 0.36);
+  }
+
+  .overlay-panel-title {
+    display: flex;
+    flex-direction: row;
+    justify-content: space-between;
+    align-items: center;
+    margin: 15px;
+    font-size: 20px;
+  }
+  .overlay-panel-content {
+    margin: 15px;
+    display: flex;
+    flex-direction: column;
+  }
+
+  .overlay-panel-section {
+    margin: 10px 0px;
+  }
+
+  .overlay-panel-section-title {
+    display: block;
+    width: 100%;
+  }
+`;
diff --git a/tools/winscope/src/app/timeline_data.ts b/tools/winscope/src/app/timeline_data.ts
index 34eaf7458..da9b82194 100644
--- a/tools/winscope/src/app/timeline_data.ts
+++ b/tools/winscope/src/app/timeline_data.ts
@@ -16,6 +16,8 @@
 
 import {TimeRange, Timestamp} from 'common/time';
 import {ComponentTimestampConverter} from 'common/timestamp_converter';
+import {UserNotifier} from 'common/user_notifier';
+import {CannotParseAllTransitions} from 'messaging/user_warnings';
 import {ScreenRecordingUtils} from 'trace/screen_recording_utils';
 import {Trace, TraceEntry} from 'trace/trace';
 import {Traces} from 'trace/traces';
@@ -39,7 +41,7 @@ export class TimelineData {
     TraceEntry<any> | undefined
   >();
   private activeTrace: Trace<object> | undefined;
-  private transitions: PropertyTreeNode[] = []; // cached trace entries to avoid TP and object creation latencies each time transition timeline is redrawn
+  private transitionEntries: Array<PropertyTreeNode | undefined> = []; // cached trace entries to avoid TP and object creation latencies each time transition timeline is redrawn
   private timestampConverter: ComponentTimestampConverter | undefined;
 
   async initialize(
@@ -53,8 +55,8 @@ export class TimelineData {
 
     this.traces = new Traces();
     traces.forEachTrace((trace, type) => {
-      // Filter out dumps with invalid timestamp (would mess up the timeline)
-      if (trace.isDumpWithoutTimestamp()) {
+      // Filter out empty traces or dumps with invalid timestamp (would mess up the timeline)
+      if (trace.lengthEntries === 0 || trace.isDumpWithoutTimestamp()) {
         return;
       }
 
@@ -63,9 +65,21 @@ export class TimelineData {
 
     const transitionTrace = this.traces.getTrace(TraceType.TRANSITION);
     if (transitionTrace) {
-      this.transitions = await Promise.all(
-        transitionTrace.mapEntry(async (entry) => await entry.getValue()),
+      let someCorrupted = false;
+      await Promise.all(
+        transitionTrace.mapEntry(async (entry) => {
+          let transition: PropertyTreeNode | undefined;
+          try {
+            transition = await entry.getValue();
+          } catch (e) {
+            someCorrupted = true;
+          }
+          this.transitionEntries.push(transition);
+        }),
       );
+      if (someCorrupted) {
+        UserNotifier.add(new CannotParseAllTransitions());
+      }
     }
 
     this.screenRecordingVideo = screenRecordingVideo;
@@ -87,8 +101,8 @@ export class TimelineData {
     }
   }
 
-  getTransitions(): PropertyTreeNode[] {
-    return this.transitions;
+  getTransitionEntries(): Array<PropertyTreeNode | undefined> {
+    return this.transitionEntries;
   }
 
   getTimestampConverter(): ComponentTimestampConverter | undefined {
@@ -129,6 +143,30 @@ export class TimelineData {
       return;
     }
 
+    if (this.firstEntry && position) {
+      if (
+        this.firstEntry.getTimestamp().getValueNs() >
+        position.timestamp.getValueNs()
+      ) {
+        this.explicitlySetPosition = TracePosition.fromTraceEntry(
+          this.firstEntry,
+        );
+        return;
+      }
+    }
+
+    if (this.lastEntry && position) {
+      if (
+        this.lastEntry.getTimestamp().getValueNs() <
+        position.timestamp.getValueNs()
+      ) {
+        this.explicitlySetPosition = TracePosition.fromTraceEntry(
+          this.lastEntry,
+        );
+        return;
+      }
+    }
+
     this.explicitlySetPosition = position;
   }
 
@@ -160,7 +198,9 @@ export class TimelineData {
 
   getFullTimeRange(): TimeRange {
     if (!this.firstEntry || !this.lastEntry) {
-      throw Error('Trying to get full time range when there are no timestamps');
+      throw new Error(
+        'Trying to get full time range when there are no timestamps',
+      );
     }
 
     const fullTimeRange = new TimeRange(
@@ -209,6 +249,10 @@ export class TimelineData {
     return this.traces;
   }
 
+  hasTrace(trace: Trace<object>): boolean {
+    return this.traces.hasTrace(trace);
+  }
+
   getScreenRecordingVideo(): Blob | undefined {
     return this.screenRecordingVideo;
   }
@@ -217,7 +261,7 @@ export class TimelineData {
     position: TracePosition,
   ): number | undefined {
     const trace = this.traces.getTrace(TraceType.SCREEN_RECORDING);
-    if (!trace || trace.lengthEntries === 0) {
+    if (!trace) {
       return undefined;
     }
 
@@ -321,14 +365,21 @@ export class TimelineData {
   }
 
   private findFirstEntry(): TraceEntry<{}> | undefined {
-    let first: TraceEntry<{}> | undefined = undefined;
+    let first: TraceEntry<{}> | undefined;
 
     this.traces.forEachTrace((trace) => {
-      if (trace.lengthEntries === 0) {
-        return;
+      let candidate: TraceEntry<{}> | undefined;
+      for (let i = 0; i < trace.lengthEntries; i++) {
+        const entry = trace.getEntry(i);
+        if (entry.hasValidTimestamp()) {
+          candidate = entry;
+          break;
+        }
       }
-      const candidate = trace.getEntry(0);
-      if (!first || candidate.getTimestamp() < first.getTimestamp()) {
+      if (
+        candidate &&
+        (!first || candidate.getTimestamp() < first.getTimestamp())
+      ) {
         first = candidate;
       }
     });
@@ -340,9 +391,6 @@ export class TimelineData {
     let last: TraceEntry<{}> | undefined = undefined;
 
     this.traces.forEachTrace((trace) => {
-      if (trace.lengthEntries === 0) {
-        return;
-      }
       const candidate = trace.getEntry(trace.lengthEntries - 1);
       if (!last || candidate.getTimestamp() > last.getTimestamp()) {
         last = candidate;
@@ -353,7 +401,7 @@ export class TimelineData {
   }
 
   private getFirstEntryOfActiveViewTrace(): TraceEntry<{}> | undefined {
-    if (!this.activeTrace || this.activeTrace.lengthEntries === 0) {
+    if (!this.activeTrace) {
       return undefined;
     }
     return this.activeTrace.getEntry(0);
diff --git a/tools/winscope/src/app/timeline_data_test.ts b/tools/winscope/src/app/timeline_data_test.ts
index 6031f08fb..a6a0a7de2 100644
--- a/tools/winscope/src/app/timeline_data_test.ts
+++ b/tools/winscope/src/app/timeline_data_test.ts
@@ -16,11 +16,17 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {TimeRange} from 'common/time';
+import {CannotParseAllTransitions} from 'messaging/user_warnings';
+import {ParserBuilder} from 'test/unit/parser_builder';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {Traces} from 'trace/traces';
 import {TracePosition} from 'trace/trace_position';
 import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {TimelineData} from './timeline_data';
 
 describe('TimelineData', () => {
@@ -37,6 +43,7 @@ describe('TimelineData', () => {
     .setTimestamps(TraceType.EVENT_LOG, [timestamp9])
     .setTimestamps(TraceType.SURFACE_FLINGER, [timestamp10])
     .setTimestamps(TraceType.WINDOW_MANAGER, [timestamp11])
+    .setTimestamps(TraceType.TRANSACTIONS, [])
     .build();
 
   const traceSf = assertDefined(traces.getTrace(TraceType.SURFACE_FLINGER));
@@ -99,6 +106,30 @@ describe('TimelineData', () => {
     });
   });
 
+  it('drops empty trace', () => {
+    timelineData.initialize(
+      traces,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    expect(
+      timelineData.getTraces().getTrace(TraceType.TRANSACTIONS),
+    ).toBeUndefined();
+  });
+
+  it('sets first entry as that with valid timestamp', async () => {
+    const traces = new TracesBuilder()
+      .setTimestamps(TraceType.TRANSITION, [timestamp0, timestamp9])
+      .setTimestamps(TraceType.SURFACE_FLINGER, [timestamp9, timestamp10])
+      .build();
+    await timelineData.initialize(
+      traces,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    expect(timelineData.getFullTimeRange().from).toEqual(timestamp9);
+  });
+
   it('uses first entry of first active trace by default', () => {
     timelineData.initialize(
       traces,
@@ -108,7 +139,7 @@ describe('TimelineData', () => {
     expect(timelineData.getCurrentPosition()).toEqual(position10);
   });
 
-  it('uses explicit position if set', () => {
+  it('uses explicit position if set and valid within time range', () => {
     timelineData.initialize(
       traces,
       undefined,
@@ -116,14 +147,35 @@ describe('TimelineData', () => {
     );
     expect(timelineData.getCurrentPosition()).toEqual(position10);
 
-    timelineData.setPosition(position1000);
-    expect(timelineData.getCurrentPosition()).toEqual(position1000);
+    timelineData.setPosition(position11);
+    expect(timelineData.getCurrentPosition()).toEqual(position11);
 
     timelineData.trySetActiveTrace(traceSf);
-    expect(timelineData.getCurrentPosition()).toEqual(position1000);
+    expect(timelineData.getCurrentPosition()).toEqual(position11);
 
     timelineData.trySetActiveTrace(traceWm);
-    expect(timelineData.getCurrentPosition()).toEqual(position1000);
+    expect(timelineData.getCurrentPosition()).toEqual(position11);
+
+    timelineData.setPosition(position1000);
+    expect(timelineData.getCurrentPosition()).not.toEqual(position1000);
+  });
+
+  it('crops explicit position to within timeline range', () => {
+    timelineData.initialize(
+      traces,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+
+    timelineData.setPosition(TracePosition.fromTimestamp(timestamp0));
+    expect(timelineData.getCurrentPosition()).toEqual(
+      TracePosition.fromTraceEntry(
+        assertDefined(traces.getTrace(TraceType.PROTO_LOG)).getEntry(0),
+      ),
+    );
+
+    timelineData.setPosition(position1000);
+    expect(timelineData.getCurrentPosition()).toEqual(position11);
   });
 
   it('sets active trace and update current position accordingly', () => {
@@ -344,4 +396,34 @@ describe('TimelineData', () => {
 
     expect(timelineData.getCurrentPosition()?.timestamp).toBe(timestamp11);
   });
+
+  it('handles partially corrupted transitions trace', async () => {
+    const userNotifierChecker = new UserNotifierChecker();
+
+    const traces = new Traces();
+    const trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSITION)
+      .setParser(
+        new ParserBuilder<PropertyTreeNode>()
+          .setIsCorrupted(true)
+          .setEntries([
+            new PropertyTreeBuilder()
+              .setRootId('TransitionsTraceEntry')
+              .setName('transition')
+              .build(),
+          ])
+          .setTimestamps([timestamp9])
+          .build(),
+      )
+      .build();
+    traces.addTrace(trace);
+
+    await timelineData.initialize(
+      traces,
+      undefined,
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    userNotifierChecker.expectAdded([new CannotParseAllTransitions()]);
+    expect(timelineData.getTransitionEntries()).toEqual([undefined]);
+  });
 });
diff --git a/tools/winscope/src/app/trace_file_filter.ts b/tools/winscope/src/app/trace_file_filter.ts
index 9d07158d3..4770c4273 100644
--- a/tools/winscope/src/app/trace_file_filter.ts
+++ b/tools/winscope/src/app/trace_file_filter.ts
@@ -17,7 +17,7 @@
 import {assertDefined} from 'common/assert_utils';
 import {FileUtils} from 'common/file_utils';
 import {TimezoneInfo} from 'common/time';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
+import {UserNotifier} from 'common/user_notifier';
 import {TraceOverridden} from 'messaging/user_warnings';
 import {TraceFile} from 'trace/trace_file';
 
@@ -43,10 +43,7 @@ export class TraceFileFilter {
     '.perfetto',
   ];
 
-  async filter(
-    files: TraceFile[],
-    UserNotificationsListener: UserNotificationsListener,
-  ): Promise<FilterResult> {
+  async filter(files: TraceFile[]): Promise<FilterResult> {
     const bugreportMainEntry = files.find((file) =>
       file.file.name.endsWith('main_entry.txt'),
     );
@@ -54,10 +51,7 @@ export class TraceFileFilter {
     const perfettoFiles = files.filter((file) => this.isPerfettoFile(file));
     const legacyFiles = files.filter((file) => !this.isPerfettoFile(file));
     if (!(await this.isBugreport(bugreportMainEntry, files))) {
-      const perfettoFile = this.pickLargestFile(
-        perfettoFiles,
-        UserNotificationsListener,
-      );
+      const perfettoFile = this.pickLargestFile(perfettoFiles);
       return {
         perfetto: perfettoFile,
         legacy: legacyFiles,
@@ -187,10 +181,7 @@ export class TraceFileFilter {
     });
   }
 
-  private pickLargestFile(
-    files: TraceFile[],
-    UserNotificationsListener: UserNotificationsListener,
-  ): TraceFile | undefined {
+  private pickLargestFile(files: TraceFile[]): TraceFile | undefined {
     if (files.length === 0) {
       return undefined;
     }
@@ -199,9 +190,7 @@ export class TraceFileFilter {
         largestSoFar.file.size > file.file.size
           ? [largestSoFar, file]
           : [file, largestSoFar];
-      UserNotificationsListener.onNotifications([
-        new TraceOverridden(overridden.getDescriptor()),
-      ]);
+      UserNotifier.add(new TraceOverridden(overridden.getDescriptor()));
       return largest;
     });
   }
diff --git a/tools/winscope/src/app/trace_file_filter_test.ts b/tools/winscope/src/app/trace_file_filter_test.ts
index 5645ee735..5b157c711 100644
--- a/tools/winscope/src/app/trace_file_filter_test.ts
+++ b/tools/winscope/src/app/trace_file_filter_test.ts
@@ -14,9 +14,8 @@
  * limitations under the License.
  */
 
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
-import {UserWarning} from 'messaging/user_warning';
 import {TraceOverridden} from 'messaging/user_warnings';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {TraceFile} from 'trace/trace_file';
 import {TraceFileFilter} from './trace_file_filter';
@@ -30,16 +29,14 @@ describe('TraceFileFilter', () => {
     'test_bugreport.zip',
   ) as unknown as File;
 
-  let warnings: UserWarning[];
-  let notificationListener: UserNotificationsListener;
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
 
   beforeEach(() => {
-    warnings = [];
-    notificationListener = {
-      onNotifications(notifications: UserWarning[]) {
-        warnings.push(...notifications);
-      },
-    };
+    userNotifierChecker.reset();
   });
 
   describe('bugreport (detects it is a bugreport)', () => {
@@ -78,15 +75,13 @@ describe('TraceFileFilter', () => {
         'would-be-ignored-if-was-part-of-bugreport/input_method_clients.pb',
       );
 
-      const result = await filter.filter(
-        [...bugreportFiles, plainTraceFile],
-        notificationListener,
-      );
+      const result = await filter.filter([...bugreportFiles, plainTraceFile]);
       expect(result.perfetto).toBeUndefined();
 
       const expectedLegacy = new Set([...pickedBugreportFiles, plainTraceFile]);
       const actualLegacy = new Set(result.legacy);
       expect(actualLegacy).toEqual(expectedLegacy);
+      userNotifierChecker.expectNone();
     });
 
     it('picks perfetto systrace.pftrace', async () => {
@@ -107,10 +102,10 @@ describe('TraceFileFilter', () => {
           bugreportArchive,
         ),
       ];
-      const result = await filter.filter(bugreportFiles, notificationListener);
+      const result = await filter.filter(bugreportFiles);
       expect(result.perfetto).toEqual(perfettoSystemTrace);
       expect(result.legacy).toEqual([]);
-      expect(warnings).toEqual([]);
+      userNotifierChecker.expectNone();
     });
 
     it('ignores perfetto traces other than systrace.pftrace', async () => {
@@ -126,10 +121,10 @@ describe('TraceFileFilter', () => {
           bugreportArchive,
         ),
       ];
-      const result = await filter.filter(bugreportFiles, notificationListener);
+      const result = await filter.filter(bugreportFiles);
       expect(result.perfetto).toBeUndefined();
       expect(result.legacy).toEqual([]);
-      expect(warnings).toEqual([]);
+      userNotifierChecker.expectNone();
     });
 
     it('identifies timezone information from bugreport codename file', async () => {
@@ -142,14 +137,14 @@ describe('TraceFileFilter', () => {
         await makeBugreportCodenameTraceFile(),
         legacyFile,
       ];
-      const result = await filter.filter(bugreportFiles, notificationListener);
+      const result = await filter.filter(bugreportFiles);
       expect(result.legacy).toEqual([legacyFile]);
       expect(result.perfetto).toBeUndefined();
       expect(result.timezoneInfo).toEqual({
         timezone: 'Asia/Kolkata',
         locale: 'en-US',
       });
-      expect(warnings).toEqual([]);
+      userNotifierChecker.expectNone();
     });
 
     it('unzips trace files within bugreport zip', async () => {
@@ -161,13 +156,13 @@ describe('TraceFileFilter', () => {
         zippedTraceFile,
       ];
 
-      const result = await filter.filter(bugreportFiles, notificationListener);
+      const result = await filter.filter(bugreportFiles);
       expect(result.perfetto).toBeUndefined();
       expect(result.legacy.map((file) => file.file.name)).toEqual([
         'Surface Flinger/SurfaceFlinger.pb',
         'Window Manager/WindowManager.pb',
       ]);
-      expect(warnings).toEqual([]);
+      userNotifierChecker.expectNone();
     });
   });
 
@@ -206,13 +201,10 @@ describe('TraceFileFilter', () => {
       const small = makeTraceFile('small.perfetto-trace', undefined, 10);
       const medium = makeTraceFile('medium.perfetto-trace', undefined, 20);
       const large = makeTraceFile('large.perfetto-trace', undefined, 30);
-      const result = await filter.filter(
-        [small, large, medium],
-        notificationListener,
-      );
+      const result = await filter.filter([small, large, medium]);
       expect(result.perfetto).toEqual(large);
       expect(result.legacy).toEqual([]);
-      expect(warnings).toEqual([
+      userNotifierChecker.expectAdded([
         new TraceOverridden(small.getDescriptor()),
         new TraceOverridden(medium.getDescriptor()),
       ]);
@@ -221,10 +213,10 @@ describe('TraceFileFilter', () => {
     async function checkPerfettoFilePickedWithoutErrors(
       perfettoFile: TraceFile,
     ) {
-      const result = await filter.filter([perfettoFile], notificationListener);
+      const result = await filter.filter([perfettoFile]);
       expect(result.perfetto).toEqual(perfettoFile);
       expect(result.legacy).toEqual([]);
-      expect(warnings).toEqual([]);
+      userNotifierChecker.expectNone();
     }
   });
 
diff --git a/tools/winscope/src/app/trace_pipeline.ts b/tools/winscope/src/app/trace_pipeline.ts
index 0e2171b06..4aaae5b17 100644
--- a/tools/winscope/src/app/trace_pipeline.ts
+++ b/tools/winscope/src/app/trace_pipeline.ts
@@ -15,23 +15,24 @@
  */
 
 import {FileUtils} from 'common/file_utils';
+import {OnProgressUpdateType} from 'common/function_utils';
 import {
   TimestampConverter,
   UTC_TIMEZONE_INFO,
 } from 'common/timestamp_converter';
+import {UserNotifier} from 'common/user_notifier';
 import {Analytics} from 'logging/analytics';
 import {ProgressListener} from 'messaging/progress_listener';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
-import {CorruptedArchive, NoInputFiles} from 'messaging/user_warnings';
+import {CorruptedArchive, NoValidFiles} from 'messaging/user_warnings';
 import {FileAndParsers} from 'parsers/file_and_parsers';
 import {ParserFactory as LegacyParserFactory} from 'parsers/legacy/parser_factory';
-import {TracesParserFactory} from 'parsers/legacy/traces_parser_factory';
 import {ParserFactory as PerfettoParserFactory} from 'parsers/perfetto/parser_factory';
+import {TracesParserFactory} from 'parsers/traces/traces_parser_factory';
 import {FrameMapper} from 'trace/frame_mapper';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceFile} from 'trace/trace_file';
-import {TraceType, TraceTypeUtils} from 'trace/trace_type';
+import {TraceEntryTypeMap, TraceType, TraceTypeUtils} from 'trace/trace_type';
 import {FilesSource} from './files_source';
 import {LoadedParsers} from './loaded_parsers';
 import {TraceFileFilter} from './trace_file_filter';
@@ -49,7 +50,6 @@ export class TracePipeline {
   async loadFiles(
     files: File[],
     source: FilesSource,
-    notificationListener: UserNotificationsListener,
     progressListener: ProgressListener | undefined,
   ) {
     this.downloadArchiveFilename = this.makeDownloadArchiveFilename(
@@ -58,23 +58,15 @@ export class TracePipeline {
     );
 
     try {
-      const unzippedArchives = await this.unzipFiles(
-        files,
-        progressListener,
-        notificationListener,
-      );
+      const unzippedArchives = await this.unzipFiles(files, progressListener);
 
       if (unzippedArchives.length === 0) {
-        notificationListener.onNotifications([new NoInputFiles()]);
+        UserNotifier.add(new NoValidFiles());
         return;
       }
 
       for (const unzippedArchive of unzippedArchives) {
-        await this.loadUnzippedArchive(
-          unzippedArchive,
-          notificationListener,
-          progressListener,
-        );
+        await this.loadUnzippedArchive(unzippedArchive, progressListener);
       }
 
       this.traces = new Traces();
@@ -98,32 +90,44 @@ export class TracePipeline {
       const hasTransitionTrace =
         this.traces.getTrace(TraceType.TRANSITION) !== undefined;
       if (hasTransitionTrace) {
-        this.traces.deleteTracesByType(TraceType.WM_TRANSITION);
-        this.traces.deleteTracesByType(TraceType.SHELL_TRANSITION);
+        this.removeTracesAndParsersByType(TraceType.WM_TRANSITION);
+        this.removeTracesAndParsersByType(TraceType.SHELL_TRANSITION);
       }
 
-      const hasCujTrace = this.traces.getTrace(TraceType.CUJS);
+      const hasCujTrace = this.traces.getTrace(TraceType.CUJS) !== undefined;
       if (hasCujTrace) {
-        this.traces.deleteTracesByType(TraceType.EVENT_LOG);
+        this.removeTracesAndParsersByType(TraceType.EVENT_LOG);
+      }
+
+      const hasMergedInputTrace =
+        this.traces.getTrace(TraceType.INPUT_EVENT_MERGED) !== undefined;
+      if (hasMergedInputTrace) {
+        this.removeTracesAndParsersByType(TraceType.INPUT_KEY_EVENT);
+        this.removeTracesAndParsersByType(TraceType.INPUT_MOTION_EVENT);
       }
     } finally {
-      progressListener?.onOperationFinished();
+      progressListener?.onOperationFinished(true);
     }
   }
 
-  removeTrace(trace: Trace<object>) {
-    this.loadedParsers.remove(trace.getParser());
+  removeTrace<T extends TraceType>(
+    trace: Trace<TraceEntryTypeMap[T]>,
+    keepFileForDownload = false,
+  ) {
+    this.loadedParsers.remove(trace.getParser(), keepFileForDownload);
     this.traces.deleteTrace(trace);
   }
 
-  async makeZipArchiveWithLoadedTraceFiles(): Promise<Blob> {
-    return this.loadedParsers.makeZipArchive();
+  async makeZipArchiveWithLoadedTraceFiles(
+    onProgressUpdate?: OnProgressUpdateType,
+  ): Promise<Blob> {
+    return this.loadedParsers.makeZipArchive(onProgressUpdate);
   }
 
   filterTracesWithoutVisualization() {
     const tracesWithoutVisualization = this.traces
       .mapTrace((trace) => {
-        if (!TraceTypeUtils.canVisualizeTrace(trace.type)) {
+        if (!TraceTypeUtils.isTraceTypeWithViewer(trace.type)) {
           return trace;
         }
         return undefined;
@@ -179,13 +183,9 @@ export class TracePipeline {
 
   private async loadUnzippedArchive(
     unzippedArchive: UnzippedArchive,
-    notificationListener: UserNotificationsListener,
     progressListener: ProgressListener | undefined,
   ) {
-    const filterResult = await this.traceFileFilter.filter(
-      unzippedArchive,
-      notificationListener,
-    );
+    const filterResult = await this.traceFileFilter.filter(unzippedArchive);
     if (filterResult.timezoneInfo) {
       this.timestampConverter = new TimestampConverter(
         filterResult.timezoneInfo,
@@ -193,7 +193,7 @@ export class TracePipeline {
     }
 
     if (!filterResult.perfetto && filterResult.legacy.length === 0) {
-      notificationListener.onNotifications([new NoInputFiles()]);
+      UserNotifier.add(new NoValidFiles());
       return;
     }
 
@@ -201,7 +201,6 @@ export class TracePipeline {
       filterResult.legacy,
       this.timestampConverter,
       progressListener,
-      notificationListener,
     );
 
     let perfettoParsers: FileAndParsers | undefined;
@@ -211,7 +210,6 @@ export class TracePipeline {
         filterResult.perfetto,
         this.timestampConverter,
         progressListener,
-        notificationListener,
       );
       perfettoParsers = new FileAndParsers(filterResult.perfetto, parsers);
     }
@@ -244,11 +242,7 @@ export class TracePipeline {
       fileAndParser.parser.createTimestamps(),
     );
 
-    this.loadedParsers.addParsers(
-      legacyParsers,
-      perfettoParsers,
-      notificationListener,
-    );
+    this.loadedParsers.addParsers(legacyParsers, perfettoParsers);
   }
 
   private makeDownloadArchiveFilename(
@@ -284,7 +278,6 @@ export class TracePipeline {
   private async unzipFiles(
     files: File[],
     progressListener: ProgressListener | undefined,
-    notificationListener: UserNotificationsListener,
   ): Promise<UnzippedArchive[]> {
     const unzippedArchives: UnzippedArchive[] = [];
     const progressMessage = 'Unzipping files...';
@@ -292,7 +285,7 @@ export class TracePipeline {
     progressListener?.onProgressUpdate(progressMessage, 0);
 
     for (let i = 0; i < files.length; i++) {
-      const file = files[i];
+      let file = files[i];
 
       const onSubProgressUpdate = (subPercentage: number) => {
         const totalPercentage =
@@ -300,6 +293,10 @@ export class TracePipeline {
         progressListener?.onProgressUpdate(progressMessage, totalPercentage);
       };
 
+      if (await FileUtils.isGZipFile(file)) {
+        file = await FileUtils.decompressGZipFile(file);
+      }
+
       if (await FileUtils.isZipFile(file)) {
         try {
           const subFiles = await FileUtils.unzipFile(file, onSubProgressUpdate);
@@ -309,12 +306,8 @@ export class TracePipeline {
           unzippedArchives.push([...subTraceFiles]);
           onSubProgressUpdate(100);
         } catch (e) {
-          notificationListener.onNotifications([new CorruptedArchive(file)]);
+          UserNotifier.add(new CorruptedArchive(file));
         }
-      } else if (await FileUtils.isGZipFile(file)) {
-        const unzippedFile = await FileUtils.decompressGZipFile(file);
-        unzippedArchives.push([new TraceFile(unzippedFile, file)]);
-        onSubProgressUpdate(100);
       } else {
         unzippedArchives.push([new TraceFile(file, undefined)]);
         onSubProgressUpdate(100);
@@ -325,4 +318,11 @@ export class TracePipeline {
 
     return unzippedArchives;
   }
+
+  private removeTracesAndParsersByType(type: TraceType) {
+    const traces = this.traces.getTraces(type);
+    traces.forEach((trace) => {
+      this.removeTrace(trace, true);
+    });
+  }
 }
diff --git a/tools/winscope/src/app/trace_pipeline_test.ts b/tools/winscope/src/app/trace_pipeline_test.ts
index 4737243f0..77b3cef2e 100644
--- a/tools/winscope/src/app/trace_pipeline_test.ts
+++ b/tools/winscope/src/app/trace_pipeline_test.ts
@@ -21,12 +21,13 @@ import {UserWarning} from 'messaging/user_warning';
 import {
   CorruptedArchive,
   InvalidPerfettoTrace,
-  NoInputFiles,
+  NoValidFiles,
   TraceOverridden,
   UnsupportedFileFormat,
 } from 'messaging/user_warnings';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesUtils} from 'test/unit/traces_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {TraceType} from 'trace/trace_type';
 import {FilesSource} from './files_source';
@@ -35,24 +36,61 @@ import {TracePipeline} from './trace_pipeline';
 describe('TracePipeline', () => {
   let validSfFile: File;
   let validWmFile: File;
-  let warnings: UserWarning[];
+  let shellTransitionFile: File;
+  let wmTransitionFile: File;
+  let screenshotFile: File;
+  let screenRecordingFile: File;
+  let brMainEntryFile: File;
+  let brCodenameFile: File;
+  let brSfFile: File;
+  let jpgFile: File;
+
   let progressListener: ProgressListenerStub;
   let tracePipeline: TracePipeline;
+  let userNotifierChecker: UserNotifierChecker;
 
-  beforeEach(async () => {
-    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+  beforeAll(async () => {
+    userNotifierChecker = new UserNotifierChecker();
+    wmTransitionFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/wm_transition_trace.pb',
+    );
+    shellTransitionFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/shell_transition_trace.pb',
+    );
     validSfFile = await UnitTestUtils.getFixtureFile(
       'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
     );
     validWmFile = await UnitTestUtils.getFixtureFile(
       'traces/elapsed_and_real_timestamp/WindowManager.pb',
     );
+    screenshotFile = await UnitTestUtils.getFixtureFile(
+      'traces/screenshot.png',
+    );
+    screenRecordingFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
+    );
+    brMainEntryFile = await UnitTestUtils.getFixtureFile(
+      'bugreports/main_entry.txt',
+      'main_entry.txt',
+    );
+    brCodenameFile = await UnitTestUtils.getFixtureFile(
+      'bugreports/bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
+      'bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
+    );
+    brSfFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
+      'FS/data/misc/wmtrace/surface_flinger.bp',
+    );
+    jpgFile = await UnitTestUtils.getFixtureFile('winscope_homepage.jpg');
+  });
 
-    warnings = [];
+  beforeEach(async () => {
+    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
 
     progressListener = new ProgressListenerStub();
     spyOn(progressListener, 'onProgressUpdate');
     spyOn(progressListener, 'onOperationFinished');
+    userNotifierChecker.reset();
 
     tracePipeline = new TracePipeline();
   });
@@ -79,21 +117,24 @@ describe('TracePipeline', () => {
     );
   });
 
-  it('can load valid gzipped file', async () => {
+  it('can load valid gzipped file and archive', async () => {
     expect(tracePipeline.getTraces().getSize()).toEqual(0);
 
     const gzippedFile = await UnitTestUtils.getFixtureFile(
       'traces/WindowManager.pb.gz',
     );
+    const gzippedArchive = await UnitTestUtils.getFixtureFile(
+      'traces/WindowManager.zip.gz',
+    );
 
-    await loadFiles([gzippedFile], FilesSource.TEST);
-    await expectLoadResult(1, []);
+    await loadFiles([gzippedFile, gzippedArchive], FilesSource.TEST);
+    await expectLoadResult(2, []);
 
-    expect(tracePipeline.getTraces().getSize()).toEqual(1);
+    const traces = tracePipeline.getTraces();
+    expect(traces.getSize()).toEqual(2);
+    expect(traces.getTraces(TraceType.WINDOW_MANAGER).length).toEqual(2);
 
-    const traceEntries = await TracesUtils.extractEntries(
-      tracePipeline.getTraces(),
-    );
+    const traceEntries = await TracesUtils.extractEntries(traces);
     expect(traceEntries.get(TraceType.WINDOW_MANAGER)?.length).toBeGreaterThan(
       0,
     );
@@ -129,18 +170,9 @@ describe('TracePipeline', () => {
     expect(tracePipeline.getTraces().getSize()).toEqual(0);
 
     const bugreportFiles = [
-      await UnitTestUtils.getFixtureFile(
-        'bugreports/main_entry.txt',
-        'main_entry.txt',
-      ),
-      await UnitTestUtils.getFixtureFile(
-        'bugreports/bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
-        'bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
-      ),
-      await UnitTestUtils.getFixtureFile(
-        'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
-        'FS/data/misc/wmtrace/surface_flinger.bp',
-      ),
+      brMainEntryFile,
+      brCodenameFile,
+      brSfFile,
       await UnitTestUtils.getFixtureFile(
         'traces/elapsed_and_real_timestamp/wm_transition_trace.pb',
         'FS/data/misc/ignored-dir/window_manager.bp',
@@ -173,20 +205,7 @@ describe('TracePipeline', () => {
   });
 
   it('detects bugreports and extracts timezone info, then calculates utc offset', async () => {
-    const bugreportFiles = [
-      await UnitTestUtils.getFixtureFile(
-        'bugreports/main_entry.txt',
-        'main_entry.txt',
-      ),
-      await UnitTestUtils.getFixtureFile(
-        'bugreports/bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
-        'bugreport-codename_beta-UPB2.230407.019-2023-05-30-14-33-48.txt',
-      ),
-      await UnitTestUtils.getFixtureFile(
-        'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
-        'FS/data/misc/wmtrace/surface_flinger.bp',
-      ),
-    ];
+    const bugreportFiles = [brMainEntryFile, brCodenameFile, brSfFile];
     const bugreportArchive = new File(
       [await FileUtils.createZipArchive(bugreportFiles)],
       'bugreport.zip',
@@ -217,15 +236,12 @@ describe('TracePipeline', () => {
 
     await expectLoadResult(0, [
       new CorruptedArchive(corruptedArchive),
-      new NoInputFiles(),
+      new NoValidFiles(),
     ]);
   });
 
   it('is robust to invalid trace files', async () => {
-    const invalidFiles = [
-      await UnitTestUtils.getFixtureFile('winscope_homepage.jpg'),
-    ];
-
+    const invalidFiles = [jpgFile];
     await loadFiles(invalidFiles);
 
     await expectLoadResult(0, [
@@ -252,6 +268,7 @@ describe('TracePipeline', () => {
         'Perfetto trace has no Transactions entries',
         'Perfetto trace has no Transitions entries',
         'Perfetto trace has no ViewCapture windows',
+        'Perfetto trace has no Window Manager entries',
         'Perfetto trace has no Motion Events entries',
         'Perfetto trace has no Key Events entries',
       ]),
@@ -261,7 +278,7 @@ describe('TracePipeline', () => {
   it('is robust to mixed valid and invalid trace files', async () => {
     expect(tracePipeline.getTraces().getSize()).toEqual(0);
     const files = [
-      await UnitTestUtils.getFixtureFile('winscope_homepage.jpg'),
+      jpgFile,
       await UnitTestUtils.getFixtureFile('traces/dump_WindowManager.pb'),
     ];
 
@@ -290,6 +307,63 @@ describe('TracePipeline', () => {
     await expectLoadResult(0, []);
   });
 
+  it('removes constituent traces of transitions trace but keeps for download', async () => {
+    const files = [wmTransitionFile, wmTransitionFile, shellTransitionFile];
+    await loadFiles(files);
+    await expectLoadResult(1, []);
+
+    const transitionTrace = assertDefined(
+      tracePipeline.getTraces().getTrace(TraceType.TRANSITION),
+    );
+
+    tracePipeline.removeTrace(transitionTrace);
+    await expectLoadResult(0, []);
+
+    await loadFiles([wmTransitionFile]);
+    await expectLoadResult(1, []);
+    expect(
+      tracePipeline.getTraces().getTrace(TraceType.WM_TRANSITION),
+    ).toBeDefined();
+    await expectDownloadResult([
+      'transition/shell_transition_trace.pb',
+      'transition/wm_transition_trace.pb',
+    ]);
+  });
+
+  it('removes constituent traces of CUJs trace but keeps for download', async () => {
+    const files = [
+      await UnitTestUtils.getFixtureFile('traces/eventlog.winscope'),
+    ];
+    await loadFiles(files);
+    await expectLoadResult(1, []);
+
+    const cujTrace = assertDefined(
+      tracePipeline.getTraces().getTrace(TraceType.CUJS),
+    );
+
+    tracePipeline.removeTrace(cujTrace);
+    await expectLoadResult(0, []);
+    await expectDownloadResult(['eventlog/eventlog.winscope']);
+  });
+
+  it('removes constituent traces of input trace but keeps for download', async () => {
+    const files = [
+      await UnitTestUtils.getFixtureFile(
+        'traces/perfetto/input-events.perfetto-trace',
+      ),
+    ];
+    await loadFiles(files);
+    await expectLoadResult(1, []);
+
+    const inputTrace = assertDefined(
+      tracePipeline.getTraces().getTrace(TraceType.INPUT_EVENT_MERGED),
+    );
+
+    tracePipeline.removeTrace(inputTrace);
+    await expectLoadResult(0, []);
+    await expectDownloadResult(['input-events.perfetto-trace']);
+  });
+
   it('gets loaded traces', async () => {
     await loadFiles([validSfFile, validWmFile]);
     await expectLoadResult(2, []);
@@ -308,11 +382,7 @@ describe('TracePipeline', () => {
   });
 
   it('gets screenrecording data', async () => {
-    const files = [
-      await UnitTestUtils.getFixtureFile(
-        'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-      ),
-    ];
+    const files = [screenRecordingFile];
     await loadFiles(files);
     await expectLoadResult(1, []);
 
@@ -322,7 +392,7 @@ describe('TracePipeline', () => {
   });
 
   it('gets screenshot data', async () => {
-    const files = [await UnitTestUtils.getFixtureFile('traces/screenshot.png')];
+    const files = [screenshotFile];
     await loadFiles(files);
     await expectLoadResult(1, []);
 
@@ -331,13 +401,8 @@ describe('TracePipeline', () => {
     expect(video?.size).toBeGreaterThan(0);
   });
 
-  it('prioritises screenrecording over screenshot data', async () => {
-    const files = [
-      await UnitTestUtils.getFixtureFile('traces/screenshot.png'),
-      await UnitTestUtils.getFixtureFile(
-        'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-      ),
-    ];
+  it('prioritizes screenrecording over screenshot data', async () => {
+    const files = [screenshotFile, screenRecordingFile];
     await loadFiles(files);
     await expectLoadResult(1, [
       new TraceOverridden('screenshot.png', TraceType.SCREEN_RECORDING),
@@ -360,9 +425,7 @@ describe('TracePipeline', () => {
 
   it('creates zip archive with loaded trace files', async () => {
     const files = [
-      await UnitTestUtils.getFixtureFile(
-        'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-      ),
+      screenRecordingFile,
       await UnitTestUtils.getFixtureFile(
         'traces/perfetto/transactions_trace.perfetto-trace',
       ),
@@ -370,21 +433,10 @@ describe('TracePipeline', () => {
     await loadFiles(files);
     await expectLoadResult(2, []);
 
-    const archiveBlob =
-      await tracePipeline.makeZipArchiveWithLoadedTraceFiles();
-    const actualFiles = await FileUtils.unzipFile(archiveBlob);
-    const actualFilenames = actualFiles
-      .map((file) => {
-        return file.name;
-      })
-      .sort();
-
-    const expectedFilenames = [
+    await expectDownloadResult([
       'screen_recording_metadata_v2.mp4',
       'transactions_trace.perfetto-trace',
-    ];
-
-    expect(actualFilenames).toEqual(expectedFilenames);
+    ]);
   });
 
   it('can be cleared', async () => {
@@ -396,9 +448,6 @@ describe('TracePipeline', () => {
   });
 
   it('can filter traces without visualization', async () => {
-    const shellTransitionFile = await UnitTestUtils.getFixtureFile(
-      'traces/elapsed_and_real_timestamp/shell_transition_trace.pb',
-    );
     await loadFiles([validSfFile, shellTransitionFile]);
     await expectLoadResult(2, []);
 
@@ -413,17 +462,7 @@ describe('TracePipeline', () => {
     files: File[],
     source: FilesSource = FilesSource.TEST,
   ) {
-    const notificationListener = {
-      onNotifications(notifications: UserWarning[]) {
-        warnings.push(...notifications);
-      },
-    };
-    await tracePipeline.loadFiles(
-      files,
-      source,
-      notificationListener,
-      progressListener,
-    );
+    await tracePipeline.loadFiles(files, source, progressListener);
     expect(progressListener.onOperationFinished).toHaveBeenCalled();
     await tracePipeline.buildTraces();
   }
@@ -432,7 +471,15 @@ describe('TracePipeline', () => {
     numberOfTraces: number,
     expectedWarnings: UserWarning[],
   ) {
-    expect(warnings).toEqual(expectedWarnings);
+    userNotifierChecker.expectAdded(expectedWarnings);
     expect(tracePipeline.getTraces().getSize()).toEqual(numberOfTraces);
   }
+
+  async function expectDownloadResult(expectedArchiveContents: string[]) {
+    const zipArchive = await tracePipeline.makeZipArchiveWithLoadedTraceFiles();
+    const actualArchiveContents = (await FileUtils.unzipFile(zipArchive))
+      .map((file) => file.name)
+      .sort();
+    expect(actualArchiveContents).toEqual(expectedArchiveContents);
+  }
 });
diff --git a/tools/winscope/src/common/array_utils.ts b/tools/winscope/src/common/array_utils.ts
index 7d081a070..145036a80 100644
--- a/tools/winscope/src/common/array_utils.ts
+++ b/tools/winscope/src/common/array_utils.ts
@@ -24,14 +24,18 @@ type TypedArray =
   | Float32Array
   | Float64Array;
 
-class ArrayUtils {
-  static equal<T>(a: T[] | TypedArray, b: T[] | TypedArray): boolean {
+export class ArrayUtils {
+  static equal<T>(
+    a: T[] | TypedArray,
+    b: T[] | TypedArray,
+    predicate: (a: T | number, b: T | number) => boolean = (a, b) => a === b,
+  ): boolean {
     if (a.length !== b.length) {
       return false;
     }
 
     for (let i = 0; i < a.length; i++) {
-      if (a[i] !== b[i]) {
+      if (!predicate(a[i], b[i])) {
         return false;
       }
     }
@@ -157,5 +161,3 @@ class ArrayUtils {
     return result;
   }
 }
-
-export {ArrayUtils};
diff --git a/tools/winscope/src/common/array_utils_test.ts b/tools/winscope/src/common/array_utils_test.ts
index 643b9116b..444be2240 100644
--- a/tools/winscope/src/common/array_utils_test.ts
+++ b/tools/winscope/src/common/array_utils_test.ts
@@ -28,7 +28,6 @@ describe('ArrayUtils', () => {
     expect(ArrayUtils.equal([], new Uint8Array(1))).toBeFalse();
     expect(ArrayUtils.equal([1], new Uint8Array(1))).toBeFalse();
 
-    expect(ArrayUtils.equal([], new Uint8Array())).toBeTrue();
     expect(ArrayUtils.equal([], new Uint8Array())).toBeTrue();
     expect(ArrayUtils.equal([1, 2, 3], new Uint8Array([1, 2, 3]))).toBeTrue();
 
@@ -45,6 +44,49 @@ describe('ArrayUtils', () => {
     ).toBeTrue();
   });
 
+  it('equal with predicate', () => {
+    const predicate = (a: number, b: number) => a !== b;
+    expect(ArrayUtils.equal([], [1], predicate)).toBeFalse();
+    expect(ArrayUtils.equal([1], [], predicate)).toBeFalse();
+
+    expect(ArrayUtils.equal([], [], predicate)).toBeTrue();
+    expect(ArrayUtils.equal([1, 2, 3], [1, 2, 3], predicate)).toBeFalse();
+
+    expect(ArrayUtils.equal([], new Uint8Array(1), predicate)).toBeFalse();
+    expect(ArrayUtils.equal([1], new Uint8Array(1), predicate)).toBeTrue();
+
+    expect(ArrayUtils.equal([], new Uint8Array(), predicate)).toBeTrue();
+    expect(
+      ArrayUtils.equal([1, 2, 3], new Uint8Array([1, 2, 3]), predicate),
+    ).toBeFalse();
+
+    expect(
+      ArrayUtils.equal(new Uint8Array([]), new Uint8Array([1]), predicate),
+    ).toBeFalse();
+    expect(
+      ArrayUtils.equal(new Uint8Array([1]), new Uint8Array([]), predicate),
+    ).toBeFalse();
+
+    expect(
+      ArrayUtils.equal(new Uint8Array([]), new Uint8Array([]), predicate),
+    ).toBeTrue();
+    expect(
+      ArrayUtils.equal(
+        new Uint8Array([1, 2, 3]),
+        new Uint8Array([1, 2, 3]),
+        predicate,
+      ),
+    ).toBeFalse();
+
+    const predicateWithNonNumberType = (
+      a: number | undefined,
+      b: number | undefined,
+    ) => a !== b;
+    expect(
+      ArrayUtils.equal([undefined], [undefined], predicateWithNonNumberType),
+    ).toBeFalse();
+  });
+
   it('searchSubarray', () => {
     expect(ArrayUtils.searchSubarray([], [0])).toEqual(undefined);
     expect(ArrayUtils.searchSubarray([], [])).toEqual(0);
diff --git a/tools/winscope/src/common/assert_utils.ts b/tools/winscope/src/common/assert_utils.ts
index acb79245f..f3ad97719 100644
--- a/tools/winscope/src/common/assert_utils.ts
+++ b/tools/winscope/src/common/assert_utils.ts
@@ -14,9 +14,16 @@
  * limitations under the License.
  */
 
-export function assertDefined<A>(value: A | null | undefined): A {
+export function assertDefined<A>(
+  value: A | null | undefined,
+  lazyErrorMessage?: () => string,
+): A {
   if (value === undefined || value === null) {
-    throw new Error(`Expected value, but found '${value}'`);
+    throw new Error(
+      lazyErrorMessage
+        ? lazyErrorMessage()
+        : `Expected value, but found '${value}'`,
+    );
   }
   return value;
 }
diff --git a/tools/winscope/src/common/bigint_math.ts b/tools/winscope/src/common/bigint_math.ts
new file mode 100644
index 000000000..518e9eb1e
--- /dev/null
+++ b/tools/winscope/src/common/bigint_math.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export class BigintMath {
+  static divideAndRound(ns: bigint, div: bigint): bigint {
+    let quot = ns / div;
+    if (ns % div >= div / 2n) {
+      quot += 1n;
+    }
+    return quot;
+  }
+}
diff --git a/tools/winscope/src/common/bigint_math_test.ts b/tools/winscope/src/common/bigint_math_test.ts
new file mode 100644
index 000000000..55174edb9
--- /dev/null
+++ b/tools/winscope/src/common/bigint_math_test.ts
@@ -0,0 +1,30 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {BigintMath} from './bigint_math';
+
+describe('BigintMath', () => {
+  it('divideAndRound()', () => {
+    expect(BigintMath.divideAndRound(0n, 10n)).toEqual(0n);
+    expect(BigintMath.divideAndRound(10n, 10n)).toEqual(1n);
+    expect(BigintMath.divideAndRound(10n, 6n)).toEqual(2n);
+    expect(BigintMath.divideAndRound(10n, 5n)).toEqual(2n);
+    expect(BigintMath.divideAndRound(10n, 4n)).toEqual(3n);
+    expect(() => BigintMath.divideAndRound(1n, 0n)).toThrowError();
+    expect(BigintMath.divideAndRound(10000n + 4999n, 10000n)).toEqual(1n);
+    expect(BigintMath.divideAndRound(10000n + 5000n, 10000n)).toEqual(2n);
+  });
+});
diff --git a/tools/winscope/src/messaging/user_notifications_listener_stub.ts b/tools/winscope/src/common/download.ts
similarity index 62%
rename from tools/winscope/src/messaging/user_notifications_listener_stub.ts
rename to tools/winscope/src/common/download.ts
index 13c6f3132..1d464d188 100644
--- a/tools/winscope/src/messaging/user_notifications_listener_stub.ts
+++ b/tools/winscope/src/common/download.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2023 The Android Open Source Project
+ * Copyright (C) 2024 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,13 +14,14 @@
  * limitations under the License.
  */
 
-import {UserNotification} from './user_notification';
-import {UserNotificationsListener} from './user_notifications_listener';
-
-export class UserNotificationsListenerStub
-  implements UserNotificationsListener
-{
-  onNotifications(notifications: UserNotification[]) {
-    // do nothing
+export class Download {
+  static fromUrl(url: string, filename: string) {
+    const a = document.createElement('a');
+    document.body.appendChild(a);
+    a.href = url;
+    a.download = filename;
+    a.click();
+    window.URL.revokeObjectURL(url);
+    document.body.removeChild(a);
   }
 }
diff --git a/tools/winscope/src/common/download_test.ts b/tools/winscope/src/common/download_test.ts
new file mode 100644
index 000000000..350b39bf8
--- /dev/null
+++ b/tools/winscope/src/common/download_test.ts
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Download} from './download';
+
+describe('Download', () => {
+  it('fromUrl', () => {
+    const testElement = document.createElement('a');
+    testElement.className = 'test-download-link';
+    const clickSpy = spyOn(testElement, 'click');
+
+    spyOn(document, 'createElement').and.returnValue(testElement);
+
+    Download.fromUrl('test_url', 'test_file_name');
+
+    expect(testElement.href.endsWith('test_url')).toBeTrue();
+    expect(testElement.download).toEqual('test_file_name');
+    expect(clickSpy).toHaveBeenCalled();
+
+    expect(document.querySelector('.test-download-link')).toBeNull();
+  });
+});
diff --git a/tools/winscope/src/common/file_utils.ts b/tools/winscope/src/common/file_utils.ts
index 8d524f926..d8450d988 100644
--- a/tools/winscope/src/common/file_utils.ts
+++ b/tools/winscope/src/common/file_utils.ts
@@ -50,12 +50,16 @@ export class FileUtils {
     }
   }
 
-  static async createZipArchive(files: File[]): Promise<Blob> {
+  static async createZipArchive(
+    files: File[],
+    progressCallback?: OnProgressUpdateType,
+  ): Promise<Blob> {
     const zip = new JSZip();
     for (let i = 0; i < files.length; i++) {
       const file = files[i];
       const blob = await file.arrayBuffer();
       zip.file(file.name, blob);
+      if (progressCallback) progressCallback((i + 1) / files.length);
     }
     return await zip.generateAsync({type: 'blob'});
   }
@@ -77,7 +81,11 @@ export class FileUtils {
       } else {
         const fileBlob = await file.async('blob');
         const unzippedFile = new File([fileBlob], filename);
-        unzippedFiles.push(unzippedFile);
+        if (await FileUtils.isZipFile(unzippedFile)) {
+          unzippedFiles.push(...(await FileUtils.unzipFile(fileBlob)));
+        } else {
+          unzippedFiles.push(unzippedFile);
+        }
       }
 
       onProgressUpdate((100 * (index + 1)) / filenames.length);
diff --git a/tools/winscope/src/common/file_utils_test.ts b/tools/winscope/src/common/file_utils_test.ts
index 25d33f69d..7dd60297d 100644
--- a/tools/winscope/src/common/file_utils_test.ts
+++ b/tools/winscope/src/common/file_utils_test.ts
@@ -48,12 +48,45 @@ describe('FileUtils', () => {
     expect(zip).toBeInstanceOf(Blob);
   });
 
+  it('creates zip archive with progress listener', async () => {
+    const progressSpy = jasmine.createSpy();
+    const zip = await FileUtils.createZipArchive(
+      [
+        new File([], 'test_file.txt'),
+        new File([], 'test_file_2.txt'),
+        new File([], 'test_file_3.txt'),
+        new File([], 'test_file_4.txt'),
+      ],
+      progressSpy,
+    );
+    expect(zip).toBeInstanceOf(Blob);
+    expect(progressSpy).toHaveBeenCalledTimes(4);
+    expect(progressSpy).toHaveBeenCalledWith(0.25);
+    expect(progressSpy).toHaveBeenCalledWith(0.5);
+    expect(progressSpy).toHaveBeenCalledWith(0.75);
+    expect(progressSpy).toHaveBeenCalledWith(1);
+  });
+
   it('unzips archive', async () => {
     const validZipFile = await UnitTestUtils.getFixtureFile(
       'traces/winscope.zip',
     );
     const unzippedFiles = await FileUtils.unzipFile(validZipFile);
-    expect(unzippedFiles.length).toBe(2);
+    expect(unzippedFiles.map((f) => f.name)).toEqual([
+      'Surface Flinger/SurfaceFlinger.pb',
+      'Window Manager/WindowManager.pb',
+    ]);
+  });
+
+  it('recursively unzips archive', async () => {
+    const validZipFile = await UnitTestUtils.getFixtureFile(
+      'traces/recursive_winscope.zip',
+    );
+    const unzippedFiles = await FileUtils.unzipFile(validZipFile);
+    expect(unzippedFiles.map((f) => f.name)).toEqual([
+      'Surface Flinger/SurfaceFlinger.pb',
+      'Window Manager/WindowManager.pb',
+    ]);
   });
 
   it('decompresses gzipped file', async () => {
@@ -65,6 +98,15 @@ describe('FileUtils', () => {
     expect(unzippedFile.size).toEqual(377137);
   });
 
+  it('decompresses gzipped archive', async () => {
+    const gzippedFile = await UnitTestUtils.getFixtureFile(
+      'traces/WindowManager.zip.gz',
+    );
+    const unzippedFile = await FileUtils.decompressGZipFile(gzippedFile);
+    expect(unzippedFile.name).toEqual('traces/WindowManager.zip');
+    expect(unzippedFile.size).toEqual(10158);
+  });
+
   it('has download filename regex that accepts all expected inputs', () => {
     expect(FileUtils.DOWNLOAD_FILENAME_REGEX.test('Winscope2')).toBeTrue();
     expect(FileUtils.DOWNLOAD_FILENAME_REGEX.test('win_scope')).toBeTrue();
diff --git a/tools/winscope/src/common/filter_flag.ts b/tools/winscope/src/common/filter_flag.ts
new file mode 100644
index 000000000..c748eb907
--- /dev/null
+++ b/tools/winscope/src/common/filter_flag.ts
@@ -0,0 +1,78 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {StringUtils} from './string_utils';
+
+export enum FilterFlag {
+  MATCH_CASE,
+  MATCH_WORD,
+  USE_REGEX,
+}
+
+export type StringFilterPredicate = (value: string) => boolean;
+
+export function makeFilterPredicate(
+  filterString: string,
+  flags: FilterFlag[],
+): StringFilterPredicate {
+  const matchCase = flags.includes(FilterFlag.MATCH_CASE);
+  const matchWord = flags.includes(FilterFlag.MATCH_WORD);
+  const useRegex = flags.includes(FilterFlag.USE_REGEX);
+
+  let filter: StringFilterPredicate;
+  if (useRegex) {
+    const regexFlags = useRegex && !matchCase ? 'i' : '';
+    const regexString = matchWord
+      ? '\\b(?:' + filterString + ')\\b'
+      : filterString;
+    try {
+      const regex = new RegExp(regexString, regexFlags);
+      filter = (entryString: string) => {
+        if (filterString.length === 0) return true;
+        return regex.test(entryString);
+      };
+    } catch (e) {
+      filter = (entryString: string) => false;
+    }
+  } else {
+    const testString = matchCase ? filterString : filterString.toLowerCase();
+    filter = (entryString: string) => {
+      if (filterString.length === 0) return true;
+
+      let entrySubstring = matchCase ? entryString : entryString.toLowerCase();
+      let testStringIndex = entrySubstring.indexOf(testString);
+
+      while (testStringIndex !== -1) {
+        if (!matchWord) return true;
+
+        const nextChar = entrySubstring.at(testStringIndex + testString.length);
+        if (
+          nextChar === undefined ||
+          !(StringUtils.isAlpha(nextChar) || StringUtils.isDigit(nextChar))
+        ) {
+          return true;
+        }
+
+        entrySubstring = entrySubstring.slice(
+          testStringIndex + testString.length,
+        );
+        testStringIndex = entrySubstring.indexOf(testString);
+      }
+      return false;
+    };
+  }
+  return filter;
+}
diff --git a/tools/winscope/src/common/filter_flag_test.ts b/tools/winscope/src/common/filter_flag_test.ts
new file mode 100644
index 000000000..a55882704
--- /dev/null
+++ b/tools/winscope/src/common/filter_flag_test.ts
@@ -0,0 +1,122 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FilterFlag, makeFilterPredicate} from './filter_flag';
+
+describe('makeFilterPredicate', () => {
+  it('with empty filter string', () => {
+    const predicate = makeFilterPredicate('', []);
+    expect(predicate('')).toBeTrue();
+    expect(predicate('foobar')).toBeTrue();
+    expect(predicate(' ')).toBeTrue();
+  });
+
+  it('without flags', () => {
+    const predicate = makeFilterPredicate('foo', []);
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('Foo')).toBeTrue();
+    expect(predicate('foobar')).toBeTrue();
+    expect(predicate('fo')).toBeFalse();
+    expect(predicate('fo o')).toBeFalse();
+
+    // does not interpret regex
+    const predicateWithRegexExp = makeFilterPredicate('foo|bar', []);
+    expect(predicateWithRegexExp('foo')).toBeFalse();
+    expect(predicateWithRegexExp('foo|bar')).toBeTrue();
+  });
+
+  it('with MATCH_CASE', () => {
+    const predicate = makeFilterPredicate('Foo', [FilterFlag.MATCH_CASE]);
+    expect(predicate('Foo')).toBeTrue();
+    expect(predicate('Foobar')).toBeTrue();
+    expect(predicate('foo')).toBeFalse();
+  });
+
+  it('with MATCH_WORD', () => {
+    const predicate = makeFilterPredicate('Foo', [FilterFlag.MATCH_WORD]);
+    expect(predicate('Foo')).toBeTrue();
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('Foo.bar')).toBeTrue();
+    expect(predicate('Foo_bar')).toBeTrue();
+    expect(predicate('Foo bar')).toBeTrue();
+    expect(predicate('Foobar')).toBeFalse();
+    expect(predicate('Foo123')).toBeFalse();
+  });
+
+  it('with USE_REGEX', () => {
+    const predicate = makeFilterPredicate('foo|bar', [FilterFlag.USE_REGEX]);
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('bar')).toBeTrue();
+    expect(predicate('Foo')).toBeTrue();
+    expect(predicate('foobar')).toBeTrue();
+    expect(predicate('foo123bar123')).toBeTrue();
+
+    const predicateWithInvalidRegex = makeFilterPredicate('foo|bar)', [
+      FilterFlag.USE_REGEX,
+    ]);
+    expect(predicateWithInvalidRegex('foo')).toBeFalse();
+    expect(predicateWithInvalidRegex('bar')).toBeFalse();
+    expect(predicateWithInvalidRegex('Foo')).toBeFalse();
+    expect(predicateWithInvalidRegex('foobar')).toBeFalse();
+    expect(predicateWithInvalidRegex('foo123bar123')).toBeFalse();
+  });
+
+  it('with MATCH_CASE and MATCH_WORD', () => {
+    const predicate = makeFilterPredicate('foo', [
+      FilterFlag.MATCH_CASE,
+      FilterFlag.MATCH_WORD,
+    ]);
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('Foo')).toBeFalse();
+    expect(predicate('Foobar')).toBeFalse();
+  });
+
+  it('with MATCH_CASE and USE_REGEX', () => {
+    const predicate = makeFilterPredicate('foo|bar', [
+      FilterFlag.MATCH_CASE,
+      FilterFlag.USE_REGEX,
+    ]);
+    expect(predicate('bar')).toBeTrue();
+    expect(predicate('foobar')).toBeTrue();
+    expect(predicate('Bar')).toBeFalse();
+  });
+
+  it('with MATCH_WORD and USE_REGEX', () => {
+    const predicate = makeFilterPredicate('foo|bar', [
+      FilterFlag.MATCH_WORD,
+      FilterFlag.USE_REGEX,
+    ]);
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('Bar')).toBeTrue();
+    expect(predicate('123 Bar')).toBeTrue();
+    expect(predicate('foobar')).toBeFalse();
+    expect(predicate('foo123bar123')).toBeFalse();
+  });
+
+  it('with MATCH_CASE, MATCH_WORD and USE_REGEX', () => {
+    const predicate = makeFilterPredicate('foo|bar', [
+      FilterFlag.MATCH_CASE,
+      FilterFlag.MATCH_WORD,
+      FilterFlag.USE_REGEX,
+    ]);
+    expect(predicate('foo')).toBeTrue();
+    expect(predicate('123 bar')).toBeTrue();
+
+    expect(predicate('foobar')).toBeFalse();
+    expect(predicate('Bar')).toBeFalse();
+    expect(predicate('123 Bar')).toBeFalse();
+  });
+});
diff --git a/tools/winscope/src/messaging/user_notifications_listener.ts b/tools/winscope/src/common/geometry/box3d.ts
similarity index 72%
rename from tools/winscope/src/messaging/user_notifications_listener.ts
rename to tools/winscope/src/common/geometry/box3d.ts
index 97c12d2e7..318ae86bb 100644
--- a/tools/winscope/src/messaging/user_notifications_listener.ts
+++ b/tools/winscope/src/common/geometry/box3d.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2023 The Android Open Source Project
+ * Copyright (C) 2024 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,8 +14,12 @@
  * limitations under the License.
  */
 
-import {UserNotification} from './user_notification';
+import {Point3D} from './point3d';
 
-export interface UserNotificationsListener {
-  onNotifications(notifications: UserNotification[]): void;
+export interface Box3D {
+  width: number;
+  height: number;
+  depth: number;
+  center: Point3D;
+  diagonal: number;
 }
diff --git a/tools/winscope/src/common/geometry/circle3d.ts b/tools/winscope/src/common/geometry/circle3d.ts
new file mode 100644
index 000000000..d6aec9cde
--- /dev/null
+++ b/tools/winscope/src/common/geometry/circle3d.ts
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Point3D} from './point3d';
+
+export interface Circle3D {
+  radius: number;
+  center: Point3D;
+}
diff --git a/tools/winscope/src/common/geometry/distance.ts b/tools/winscope/src/common/geometry/distance.ts
new file mode 100644
index 000000000..e4438f50e
--- /dev/null
+++ b/tools/winscope/src/common/geometry/distance.ts
@@ -0,0 +1,19 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export class Distance {
+  constructor(public dx: number, public dy: number) {}
+}
diff --git a/tools/winscope/src/common/geometry/point.ts b/tools/winscope/src/common/geometry/point.ts
new file mode 100644
index 000000000..77b17ac9b
--- /dev/null
+++ b/tools/winscope/src/common/geometry/point.ts
@@ -0,0 +1,20 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export interface Point {
+  x: number;
+  y: number;
+}
diff --git a/tools/winscope/src/common/geometry/point3d.ts b/tools/winscope/src/common/geometry/point3d.ts
new file mode 100644
index 000000000..6c524f707
--- /dev/null
+++ b/tools/winscope/src/common/geometry/point3d.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Point} from './point';
+
+export class Point3D implements Point {
+  constructor(public x: number, public y: number, public z: number) {}
+
+  isEqual(other: Point3D): boolean {
+    return this.x === other.x && this.y === other.y && this.z === other.z;
+  }
+}
diff --git a/tools/winscope/src/common/rect.ts b/tools/winscope/src/common/geometry/rect.ts
similarity index 83%
rename from tools/winscope/src/common/rect.ts
rename to tools/winscope/src/common/geometry/rect.ts
index 106c1cb14..b874434c0 100644
--- a/tools/winscope/src/common/rect.ts
+++ b/tools/winscope/src/common/geometry/rect.ts
@@ -14,8 +14,7 @@
  * limitations under the License.
  */
 
-import {Point} from 'common/geometry_types';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {Point} from 'common/geometry/point';
 
 export class Rect {
   constructor(
@@ -25,12 +24,14 @@ export class Rect {
     readonly h: number,
   ) {}
 
-  static from(node: PropertyTreeNode): Rect {
-    const left = node.getChildByName('left')?.getValue() ?? 0;
-    const top = node.getChildByName('top')?.getValue() ?? 0;
-    const right = node.getChildByName('right')?.getValue() ?? 0;
-    const bottom = node.getChildByName('bottom')?.getValue() ?? 0;
-    return new Rect(left, top, right - left, bottom - top);
+  isAlmostEqual(other: Rect, eps: number): boolean {
+    const isClose = (a: number, b: number) => Math.abs(a - b) <= eps;
+    return (
+      isClose(this.x, other.x) &&
+      isClose(this.y, other.y) &&
+      isClose(this.w, other.w) &&
+      isClose(this.h, other.h)
+    );
   }
 
   containsPoint(point: Point): boolean {
diff --git a/tools/winscope/src/common/geometry/rect3d.ts b/tools/winscope/src/common/geometry/rect3d.ts
new file mode 100644
index 000000000..cd94ff1f7
--- /dev/null
+++ b/tools/winscope/src/common/geometry/rect3d.ts
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Point3D} from './point3d';
+
+export interface Rect3D {
+  topLeft: Point3D;
+  bottomRight: Point3D;
+}
diff --git a/tools/winscope/src/common/geometry/region.ts b/tools/winscope/src/common/geometry/region.ts
new file mode 100644
index 000000000..0b0c17d0a
--- /dev/null
+++ b/tools/winscope/src/common/geometry/region.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Rect} from './rect';
+
+export class Region {
+  constructor(readonly rects: Rect[]) {}
+
+  static createEmpty(): Region {
+    return new Region([]);
+  }
+}
diff --git a/tools/winscope/src/common/geometry/size.ts b/tools/winscope/src/common/geometry/size.ts
new file mode 100644
index 000000000..3b91b9c3e
--- /dev/null
+++ b/tools/winscope/src/common/geometry/size.ts
@@ -0,0 +1,20 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export interface Size {
+  width: number;
+  height: number;
+}
diff --git a/tools/winscope/src/common/geometry/transform_matrix.ts b/tools/winscope/src/common/geometry/transform_matrix.ts
new file mode 100644
index 000000000..fa8cb9a78
--- /dev/null
+++ b/tools/winscope/src/common/geometry/transform_matrix.ts
@@ -0,0 +1,138 @@
+/*
+ * Copyright (C) 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Point} from './point';
+import {Point3D} from './point3d';
+import {Rect} from './rect';
+import {Region} from './region';
+
+// These values correspond to the values from the gui::Transform class in the platform, defined in:
+//     frameworks/native/libs/ui/include/ui/Transform.h
+// The values are listed in row-major order:
+//     [ dsdx, dtdx,  tx ]
+//     [ dtdy, dsdy,  ty ]
+//     [    0,    0,   1 ]
+export class TransformMatrix {
+  constructor(
+    readonly dsdx: number,
+    readonly dtdx: number,
+    readonly tx: number,
+    readonly dtdy: number,
+    readonly dsdy: number,
+    readonly ty: number,
+  ) {}
+
+  static from(
+    m: {
+      dsdx?: number;
+      dtdx?: number;
+      tx?: number;
+      dtdy?: number;
+      dsdy?: number;
+      ty?: number;
+    } = {},
+    fallback: TransformMatrix = IDENTITY_MATRIX,
+  ): TransformMatrix {
+    return new TransformMatrix(
+      m.dsdx ?? fallback.dsdx,
+      m.dtdx ?? fallback.dtdx,
+      m.tx ?? fallback.tx,
+      m.dtdy ?? fallback.dtdy,
+      m.dsdy ?? fallback.dsdy,
+      m.ty ?? fallback.ty,
+    );
+  }
+
+  isValid(): boolean {
+    return this.dsdx * this.dsdy !== this.dtdx * this.dtdy;
+  }
+
+  transformPoint(point: Point): Point {
+    return {
+      x: this.dsdx * point.x + this.dtdx * point.y + this.tx,
+      y: this.dtdy * point.x + this.dsdy * point.y + this.ty,
+    };
+  }
+
+  transformPoint3D(point: Point3D): Point3D {
+    const p = this.transformPoint(point);
+    return new Point3D(p.x, p.y, point.z);
+  }
+
+  transformRect(r: Rect): Rect {
+    const ltPrime = this.transformPoint({x: r.x, y: r.y});
+    const rbPrime = this.transformPoint({x: r.x + r.w, y: r.y + r.h});
+    const x = Math.min(ltPrime.x, rbPrime.x);
+    const y = Math.min(ltPrime.y, rbPrime.y);
+    return new Rect(
+      x,
+      y,
+      Math.max(ltPrime.x, rbPrime.x) - x,
+      Math.max(ltPrime.y, rbPrime.y) - y,
+    );
+  }
+
+  transformRegion(region: Region): Region {
+    return new Region(region.rects.map((rect) => this.transformRect(rect)));
+  }
+
+  inverse(): TransformMatrix {
+    const ident = 1.0 / this.det();
+    const result = {
+      dsdx: this.dsdy * ident,
+      dtdx: -this.dtdx * ident,
+      tx: 0,
+      dsdy: this.dsdx * ident,
+      dtdy: -this.dtdy * ident,
+      ty: 0,
+    };
+    const t = TransformMatrix.from(result).transformPoint({
+      x: -this.tx,
+      y: -this.ty,
+    });
+    result.tx = t.x;
+    result.ty = t.y;
+    return TransformMatrix.from(result);
+  }
+
+  addTy(ty: number): TransformMatrix {
+    return new TransformMatrix(
+      this.dsdx,
+      this.dtdx,
+      this.tx,
+      this.dtdy,
+      this.dsdy,
+      this.ty + ty,
+    );
+  }
+
+  isEqual(other: TransformMatrix): boolean {
+    return (
+      this.dsdx === other.dsdx &&
+      this.dtdx === other.dtdx &&
+      this.tx === other.tx &&
+      this.dtdy === other.dtdy &&
+      this.dsdy === other.dsdy &&
+      this.ty === other.ty
+    );
+  }
+
+  private det(): number {
+    return this.dsdx * this.dsdy - this.dtdx * this.dtdy;
+  }
+}
+
+export const IDENTITY_MATRIX = new TransformMatrix(1, 0, 0, 0, 1, 0);
diff --git a/tools/winscope/src/common/http_request.ts b/tools/winscope/src/common/http_request.ts
new file mode 100644
index 000000000..4e62d2133
--- /dev/null
+++ b/tools/winscope/src/common/http_request.ts
@@ -0,0 +1,111 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+
+export type HttpRequestHeaderType = Array<[string, string]>;
+
+export enum HttpRequestStatus {
+  UNSENT,
+  UNAUTH,
+  SUCCESS,
+  ERROR,
+}
+
+export interface HttpResponse {
+  status: HttpRequestStatus;
+  type: XMLHttpRequestResponseType; //eslint-disable-line no-undef
+  text: string;
+  body: any;
+  getHeader: (name: string) => string | undefined;
+}
+
+export class HttpRequest {
+  static async get(
+    path: string,
+    headers: HttpRequestHeaderType,
+    type?: XMLHttpRequest['responseType'],
+  ): Promise<HttpResponse> {
+    return await HttpRequest.call('GET', path, headers, type);
+  }
+
+  static async post(
+    path: string,
+    headers: HttpRequestHeaderType,
+    jsonRequest?: object,
+  ): Promise<HttpResponse> {
+    return await HttpRequest.call(
+      'POST',
+      path,
+      headers,
+      undefined,
+      jsonRequest,
+    );
+  }
+
+  private static async call(
+    method: string,
+    path: string,
+    headers: HttpRequestHeaderType,
+    type?: XMLHttpRequest['responseType'],
+    jsonRequest?: object,
+  ): Promise<HttpResponse> {
+    const req = new XMLHttpRequest();
+    let status: HttpRequestStatus | undefined;
+
+    await new Promise<void>((resolve) => {
+      req.onreadystatechange = async () => {
+        if (req.readyState !== XMLHttpRequest.DONE) {
+          return;
+        }
+        if (req.status === XMLHttpRequest.UNSENT) {
+          status = HttpRequestStatus.UNSENT;
+        } else if (req.status === 200) {
+          status = HttpRequestStatus.SUCCESS;
+        } else if (req.status === 403) {
+          status = HttpRequestStatus.UNAUTH;
+        } else {
+          status = HttpRequestStatus.ERROR;
+        }
+        resolve();
+      };
+      req.responseType = type || '';
+      req.open(method, path);
+      headers.forEach(([header, value]) => {
+        req.setRequestHeader(header, value);
+      });
+
+      if (jsonRequest) {
+        const json = JSON.stringify(jsonRequest);
+        req.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
+        req.send(json);
+      } else {
+        req.send();
+      }
+    });
+
+    const hasResponseText =
+      req.responseType === '' || req.responseType === 'text';
+
+    return {
+      status: assertDefined(status),
+      type: req.responseType,
+      text: hasResponseText ? req.responseText : '',
+      body: req.response,
+      getHeader: (name: string) => req.getResponseHeader(name) ?? undefined,
+    };
+  }
+}
diff --git a/tools/winscope/src/common/in_memory_storage.ts b/tools/winscope/src/common/in_memory_storage.ts
index b62e3a63d..ed1120123 100644
--- a/tools/winscope/src/common/in_memory_storage.ts
+++ b/tools/winscope/src/common/in_memory_storage.ts
@@ -14,27 +14,20 @@
  * limitations under the License.
  */
 
-export class InMemoryStorage implements Storage {
+import {Store} from './store';
+
+export class InMemoryStorage implements Store {
   private store: {[key: string]: string} = {};
 
-  [name: string]: any;
-  get length(): number {
-    return Object.keys(this.store).length;
+  add(key: string, value: string): void {
+    this.store[key] = value;
   }
 
-  clear(): void {
-    throw new Error('Method not implemented.');
-  }
-  getItem(key: string): string | null {
-    return this.store[key];
-  }
-  key(index: number): string | null {
-    return Object.keys(this.store)[index];
+  get(key: string): string | undefined {
+    return this.store[key] ?? undefined;
   }
-  removeItem(key: string): void {
-    delete this.store[key];
-  }
-  setItem(key: string, value: string): void {
-    this.store[key] = value;
+
+  clear(keySubstring: string): void {
+    delete this.store[keySubstring];
   }
 }
diff --git a/tools/winscope/src/common/in_memory_storage_test.ts b/tools/winscope/src/common/in_memory_storage_test.ts
index 7b519bc0c..e9413cb43 100644
--- a/tools/winscope/src/common/in_memory_storage_test.ts
+++ b/tools/winscope/src/common/in_memory_storage_test.ts
@@ -17,11 +17,19 @@
 import {InMemoryStorage} from './in_memory_storage';
 
 describe('InMemoryStorage', () => {
-  it('can store values', () => {
+  it('can store and retrieve values', () => {
     const mockStorage = new InMemoryStorage();
+    expect(mockStorage.get('key')).toBeUndefined();
+    mockStorage.add('key', 'value');
+    expect(mockStorage.get('key')).toEqual('value');
+  });
 
-    mockStorage.setItem('key', 'value');
-
-    expect(mockStorage.getItem('key')).toBe('value');
+  it('can clear values', () => {
+    const mockStorage = new InMemoryStorage();
+    // robust to value not found in store
+    mockStorage.clear('key');
+    mockStorage.add('key', 'value');
+    mockStorage.clear('key');
+    expect(mockStorage.get('key')).toBeUndefined();
   });
 });
diff --git a/tools/winscope/src/common/intDefMapping.json b/tools/winscope/src/common/intDefMapping.json
index 94569801b..82269068b 100644
--- a/tools/winscope/src/common/intDefMapping.json
+++ b/tools/winscope/src/common/intDefMapping.json
@@ -299,15 +299,23 @@
   "android.app.ActivityManager.RestrictionReason": {
     "flag": false,
     "values": {
-      "0": "RESTRICTION_REASON_UNKNOWN",
       "1": "RESTRICTION_REASON_DEFAULT",
       "2": "RESTRICTION_REASON_DORMANT",
       "3": "RESTRICTION_REASON_USAGE",
       "4": "RESTRICTION_REASON_USER",
-      "5": "RESTRICTION_REASON_USER_NUDGED",
-      "6": "RESTRICTION_REASON_SYSTEM_HEALTH",
-      "7": "RESTRICTION_REASON_REMOTE_TRIGGER",
-      "8": "RESTRICTION_REASON_OTHER"
+      "5": "RESTRICTION_REASON_SYSTEM_HEALTH",
+      "6": "RESTRICTION_REASON_POLICY",
+      "7": "RESTRICTION_REASON_OTHER"
+    }
+  },
+  "android.app.ActivityManager.RestrictionSource": {
+    "flag": false,
+    "values": {
+      "1": "RESTRICTION_SOURCE_USER",
+      "2": "RESTRICTION_SOURCE_USER_NUDGED",
+      "3": "RESTRICTION_SOURCE_SYSTEM",
+      "4": "RESTRICTION_SOURCE_COMMAND_LINE",
+      "5": "RESTRICTION_SOURCE_REMOTE_TRIGGER"
     }
   },
   "android.app.ActivityManager.RunningAppProcessInfo.Importance": {
@@ -371,7 +379,8 @@
       "19": "OOM_ADJ_REASON_STOP_SERVICE",
       "20": "OOM_ADJ_REASON_EXECUTING_SERVICE",
       "21": "OOM_ADJ_REASON_RESTRICTION_CHANGE",
-      "22": "OOM_ADJ_REASON_COMPONENT_DISABLED"
+      "22": "OOM_ADJ_REASON_COMPONENT_DISABLED",
+      "23": "OOM_ADJ_REASON_FOLLOW_UP"
     }
   },
   "android.app.ActivityOptions.BackgroundActivityStartMode": {
@@ -380,7 +389,9 @@
       "0": "MODE_BACKGROUND_ACTIVITY_START_SYSTEM_DEFINED",
       "1": "MODE_BACKGROUND_ACTIVITY_START_ALLOWED",
       "2": "MODE_BACKGROUND_ACTIVITY_START_DENIED",
-      "-1": "MODE_BACKGROUND_ACTIVITY_START_COMPAT"
+      "-1": "MODE_BACKGROUND_ACTIVITY_START_COMPAT",
+      "3": "MODE_BACKGROUND_ACTIVITY_START_ALLOW_ALWAYS",
+      "4": "MODE_BACKGROUND_ACTIVITY_START_ALLOW_IF_VISIBLE"
     }
   },
   "android.app.ActivityOptions.SourceInfo.SourceType": {
@@ -608,7 +619,8 @@
     "flag": true,
     "values": {
       "1": "FIELD_NAME",
-      "2": "FIELD_INTERRUPTION_FILTER"
+      "2": "FIELD_INTERRUPTION_FILTER",
+      "4": "FIELD_ICON"
     }
   },
   "android.app.AutomaticZenRule.Type": {
@@ -838,7 +850,8 @@
       "4096": "FLAG_BUBBLE",
       "8192": "FLAG_NO_DISMISS",
       "16384": "FLAG_FSI_REQUESTED_BUT_DENIED",
-      "32768": "FLAG_USER_INITIATED_JOB"
+      "32768": "FLAG_USER_INITIATED_JOB",
+      "131072": "FLAG_SILENT"
     }
   },
   "android.app.Notification.NotificationVisibilityOverride": {
@@ -2331,7 +2344,8 @@
     "values": {
       "2": "POLICY_TYPE_RECENTS",
       "3": "POLICY_TYPE_ACTIVITY",
-      "4": "POLICY_TYPE_CLIPBOARD"
+      "4": "POLICY_TYPE_CLIPBOARD",
+      "6": "POLICY_TYPE_BLOCKED_ACTIVITY_BEHAVIOR"
     }
   },
   "android.companion.virtual.VirtualDeviceParams.LockState": {
@@ -2745,7 +2759,9 @@
       "8192": "CONFIG_LAYOUT_DIRECTION",
       "16384": "CONFIG_COLOR_MODE",
       "1073741824": "CONFIG_FONT_SCALE",
-      "32768": "CONFIG_GRAMMATICAL_GENDER"
+      "32768": "CONFIG_GRAMMATICAL_GENDER",
+      "-2147483648": "CONFIG_ASSETS_PATHS",
+      "134217728": "CONFIG_RESOURCES_UNUSED"
     }
   },
   "android.content.pm.ActivityInfo.LaunchMode": {
@@ -4564,7 +4580,8 @@
       "15": "BIOMETRIC_STRONG",
       "255": "BIOMETRIC_WEAK",
       "4095": "BIOMETRIC_CONVENIENCE",
-      "32768": "DEVICE_CREDENTIAL"
+      "32768": "DEVICE_CREDENTIAL",
+      "65536": "MANDATORY_BIOMETRICS"
     }
   },
   "android.hardware.biometrics.BiometricManager.BiometricError": {
@@ -9644,6 +9661,14 @@
       "2": "POWER_MODEL_ENERGY_CONSUMPTION"
     }
   },
+  "android.os.BatteryConsumer.PowerState": {
+    "flag": false,
+    "values": {
+      "0": "POWER_STATE_ANY",
+      "1": "POWER_STATE_BATTERY",
+      "2": "POWER_STATE_OTHER"
+    }
+  },
   "android.os.BatteryConsumer.ProcessState": {
     "flag": false,
     "values": {
@@ -9654,6 +9679,14 @@
       "4": "PROCESS_STATE_CACHED"
     }
   },
+  "android.os.BatteryConsumer.ScreenState": {
+    "flag": false,
+    "values": {
+      "0": "SCREEN_STATE_ANY",
+      "1": "SCREEN_STATE_ON",
+      "2": "SCREEN_STATE_OTHER"
+    }
+  },
   "android.os.BatteryStats.RadioAccessTechnology": {
     "flag": false,
     "values": {
@@ -10025,8 +10058,7 @@
       "0": "BRIGHTNESS_CONSTRAINT_TYPE_MINIMUM",
       "1": "BRIGHTNESS_CONSTRAINT_TYPE_MAXIMUM",
       "2": "BRIGHTNESS_CONSTRAINT_TYPE_DEFAULT",
-      "3": "BRIGHTNESS_CONSTRAINT_TYPE_DIM",
-      "4": "BRIGHTNESS_CONSTRAINT_TYPE_DOZE"
+      "3": "BRIGHTNESS_CONSTRAINT_TYPE_DIM"
     }
   },
   "android.os.PowerManager.GoToSleepReason": {
@@ -11453,6 +11485,16 @@
       "2": "RESULT_FLAG_ON_LOAD_ITEM_NOT_IMPLEMENTED"
     }
   },
+  "android.service.notification.Adjustment.Types": {
+    "flag": false,
+    "values": {
+      "0": "TYPE_OTHER",
+      "1": "TYPE_PROMOTION",
+      "2": "TYPE_SOCIAL_MEDIA",
+      "3": "TYPE_NEWS",
+      "4": "TYPE_CONTENT_RECOMMENDATION"
+    }
+  },
   "android.service.notification.Condition.Source": {
     "flag": false,
     "values": {
@@ -12549,6 +12591,22 @@
       "-2": "CARRIER_PRIVILEGE_STATUS_ERROR_LOADING_RULES"
     }
   },
+  "android.telephony.Annotation.ConnectivityTransport": {
+    "flag": false,
+    "values": {
+      "0": "TRANSPORT_CELLULAR",
+      "1": "TRANSPORT_WIFI",
+      "2": "TRANSPORT_BLUETOOTH",
+      "3": "TRANSPORT_ETHERNET",
+      "4": "TRANSPORT_VPN",
+      "5": "TRANSPORT_WIFI_AWARE",
+      "6": "TRANSPORT_LOWPAN",
+      "7": "TRANSPORT_TEST",
+      "8": "TRANSPORT_USB",
+      "9": "TRANSPORT_THREAD",
+      "10": "TRANSPORT_SATELLITE"
+    }
+  },
   "android.telephony.Annotation.DataActivityType": {
     "flag": false,
     "values": {
@@ -13527,6 +13585,14 @@
       "11": "ID_TYPE_KEY_ID"
     }
   },
+  "android.telephony.CarrierConfigManager.SATELLITE_DATA_SUPPORT_MODE": {
+    "flag": false,
+    "values": {
+      "0": "SATELLITE_DATA_SUPPORT_ONLY_RESTRICTED",
+      "1": "SATELLITE_DATA_SUPPORT_BANDWIDTH_CONSTRAINED",
+      "2": "SATELLITE_DATA_SUPPORT_ALL"
+    }
+  },
   "android.telephony.CarrierRestrictionRules.CarrierRestrictionDefault": {
     "flag": false,
     "values": {
@@ -16217,7 +16283,8 @@
       "2": "DATAGRAM_TYPE_LOCATION_SHARING",
       "3": "DATAGRAM_TYPE_KEEP_ALIVE",
       "4": "DATAGRAM_TYPE_LAST_SOS_MESSAGE_STILL_NEED_HELP",
-      "5": "DATAGRAM_TYPE_LAST_SOS_MESSAGE_NO_HELP_NEEDED"
+      "5": "DATAGRAM_TYPE_LAST_SOS_MESSAGE_NO_HELP_NEEDED",
+      "6": "DATAGRAM_TYPE_SMS"
     }
   },
   "android.telephony.satellite.SatelliteManager.DeviceHoldPosition": {
@@ -16314,7 +16381,9 @@
       "21": "SATELLITE_RESULT_REQUEST_IN_PROGRESS",
       "22": "SATELLITE_RESULT_MODEM_BUSY",
       "23": "SATELLITE_RESULT_ILLEGAL_STATE",
-      "24": "SATELLITE_RESULT_MODEM_TIMEOUT"
+      "24": "SATELLITE_RESULT_MODEM_TIMEOUT",
+      "25": "SATELLITE_RESULT_LOCATION_DISABLED",
+      "26": "SATELLITE_RESULT_LOCATION_NOT_AVAILABLE"
     }
   },
   "android.text.FontConfig.Customization.LocaleFallback.Operation": {
@@ -16661,6 +16730,19 @@
       "0": "NO_GRAVITY"
     }
   },
+  "android.view.HapticFeedbackConstants.Flags": {
+    "flag": true,
+    "values": {
+      "1": "FLAG_IGNORE_VIEW_SETTING",
+      "2": "FLAG_IGNORE_GLOBAL_SETTING"
+    }
+  },
+  "android.view.HapticFeedbackConstants.PrivateFlags": {
+    "flag": true,
+    "values": {
+      "1": "PRIVATE_FLAG_APPLY_INPUT_METHOD_SETTINGS"
+    }
+  },
   "android.view.InputDevice.InputSourceClass": {
     "flag": true,
     "values": {
@@ -16945,6 +17027,24 @@
       "5": "ERROR_DESTINATION_INVALID"
     }
   },
+  "android.view.PointerIcon.PointerIconVectorStyleFill": {
+    "flag": false,
+    "values": {
+      "0": "POINTER_ICON_VECTOR_STYLE_FILL_BLACK",
+      "1": "POINTER_ICON_VECTOR_STYLE_FILL_GREEN",
+      "2": "POINTER_ICON_VECTOR_STYLE_FILL_YELLOW",
+      "3": "POINTER_ICON_VECTOR_STYLE_FILL_PINK",
+      "4": "POINTER_ICON_VECTOR_STYLE_FILL_BLUE"
+    }
+  },
+  "android.view.PointerIcon.PointerIconVectorStyleStroke": {
+    "flag": false,
+    "values": {
+      "0": "POINTER_ICON_VECTOR_STYLE_STROKE_WHITE",
+      "1": "POINTER_ICON_VECTOR_STYLE_STROKE_BLACK",
+      "2": "POINTER_ICON_VECTOR_STYLE_STROKE_NONE"
+    }
+  },
   "android.view.RemoteAnimationTarget.Mode": {
     "flag": false,
     "values": {
@@ -17479,6 +17579,7 @@
       "16": "SYSTEM_FLAG_SHOW_FOR_ALL_USERS",
       "32": "PRIVATE_FLAG_UNRESTRICTED_GESTURE_EXCLUSION",
       "64": "PRIVATE_FLAG_NO_MOVE_ANIMATION",
+      "128": "PRIVATE_FLAG_APP_PROGRESS_GENERATION_ALLOWED",
       "256": "PRIVATE_FLAG_SYSTEM_ERROR",
       "512": "PRIVATE_FLAG_OPTIMIZE_MEASURE",
       "1024": "PRIVATE_FLAG_DISABLE_WALLPAPER_TOUCH_EVENTS",
@@ -18051,7 +18152,25 @@
       "44": "PHASE_IME_SHOW_WINDOW",
       "45": "PHASE_IME_HIDE_WINDOW",
       "46": "PHASE_IME_PRIVILEGED_OPERATIONS",
-      "47": "PHASE_SERVER_CURRENT_ACTIVE_IME"
+      "47": "PHASE_SERVER_CURRENT_ACTIVE_IME",
+      "48": "PHASE_CLIENT_REPORT_REQUESTED_VISIBLE_TYPES",
+      "49": "PHASE_WM_SET_REMOTE_TARGET_IME_VISIBILITY",
+      "50": "PHASE_WM_POST_LAYOUT_NOTIFY_CONTROLS_CHANGED",
+      "51": "PHASE_CLIENT_HANDLE_DISPATCH_IME_VISIBILITY_CHANGED",
+      "52": "PHASE_CLIENT_NOTIFY_IME_VISIBILITY_CHANGED",
+      "53": "PHASE_CLIENT_UPDATE_REQUESTED_VISIBLE_TYPES",
+      "54": "PHASE_WM_REMOTE_INSETS_CONTROL_TARGET_SET_REQUESTED_VISIBILITY",
+      "55": "PHASE_WM_GET_CONTROL_WITH_LEASH",
+      "56": "PHASE_WM_UPDATE_REQUESTED_VISIBLE_TYPES",
+      "57": "PHASE_SERVER_SET_VISIBILITY_ON_FOCUSED_WINDOW",
+      "58": "PHASE_CLIENT_HANDLE_SET_IME_VISIBILITY",
+      "59": "PHASE_CLIENT_SET_IME_VISIBILITY",
+      "60": "PHASE_WM_DISPATCH_IME_REQUESTED_CHANGED",
+      "61": "PHASE_CLIENT_NO_ONGOING_USER_ANIMATION",
+      "62": "PHASE_WM_NOTIFY_IME_VISIBILITY_CHANGED_FROM_CLIENT",
+      "63": "PHASE_WM_POSTING_CHANGED_IME_VISIBILITY",
+      "64": "PHASE_WM_INVOKING_IME_REQUESTED_LISTENER",
+      "65": "PHASE_CLIENT_ALREADY_HIDDEN"
     }
   },
   "android.view.inputmethod.ImeTracker.Status": {
@@ -18776,7 +18895,7 @@
     }
   },
   "android.window.TransitionInfo.ChangeFlags": {
-    "flag": false,
+    "flag": true,
     "values": {
       "0": "FLAG_NONE",
       "1": "FLAG_SHOW_WALLPAPER",
@@ -18863,7 +18982,8 @@
       "2": "HARDWARE",
       "4": "TRIPLETAP",
       "8": "TWOFINGER_DOUBLETAP",
-      "16": "QUICK_SETTINGS"
+      "16": "QUICK_SETTINGS",
+      "32": "GESTURE"
     }
   },
   "com.android.internal.accessibility.util.AccessibilityUtils.A11yTextChangeType": {
@@ -19176,7 +19296,20 @@
       "99": "CUJ_LAUNCHER_WIDGET_PICKER_SEARCH_BACK",
       "100": "CUJ_LAUNCHER_WIDGET_BOTTOM_SHEET_CLOSE_BACK",
       "102": "CUJ_LAUNCHER_PRIVATE_SPACE_LOCK",
-      "103": "CUJ_LAUNCHER_PRIVATE_SPACE_UNLOCK"
+      "103": "CUJ_LAUNCHER_PRIVATE_SPACE_UNLOCK",
+      "104": "CUJ_DESKTOP_MODE_MAXIMIZE_WINDOW",
+      "105": "CUJ_FOLD_ANIM",
+      "106": "CUJ_DESKTOP_MODE_RESIZE_WINDOW",
+      "107": "CUJ_DESKTOP_MODE_ENTER_APP_HANDLE_DRAG_HOLD",
+      "112": "CUJ_DESKTOP_MODE_ENTER_MODE_APP_HANDLE_MENU",
+      "108": "CUJ_DESKTOP_MODE_EXIT_MODE",
+      "109": "CUJ_DESKTOP_MODE_MINIMIZE_WINDOW",
+      "110": "CUJ_DESKTOP_MODE_DRAG_WINDOW",
+      "111": "CUJ_STATUS_BAR_LAUNCH_DIALOG_FROM_CHIP",
+      "113": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_OPEN",
+      "114": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_CLOSE",
+      "115": "CUJ_LAUNCHER_KEYBOARD_QUICK_SWITCH_APP_LAUNCH",
+      "116": "CUJ_DESKTOP_MODE_ENTER_APP_HANDLE_DRAG_RELEASE"
     }
   },
   "com.android.internal.jank.DisplayRefreshRate.RefreshRate": {
@@ -19224,8 +19357,7 @@
       "6": "CONTENT_PROVIDER",
       "7": "APP_REGISTERED",
       "8": "SHORT_FGS_TIMEOUT",
-      "9": "JOB_SERVICE",
-      "11": "FGS_TIMEOUT"
+      "9": "JOB_SERVICE"
     }
   },
   "com.android.internal.os.anr.AnrLatencyTracker.EarlyDumpStatus": {
@@ -19349,7 +19481,8 @@
       "24": "ACTION_KEYGUARD_FPS_UNLOCK_TO_HOME",
       "25": "ACTION_BACK_SYSTEM_ANIMATION",
       "26": "ACTION_NOTIFICATIONS_HIDDEN_FOR_MEASURE",
-      "27": "ACTION_NOTIFICATIONS_HIDDEN_FOR_MEASURE_WITH_SHADE_OPEN"
+      "27": "ACTION_NOTIFICATIONS_HIDDEN_FOR_MEASURE_WITH_SHADE_OPEN",
+      "28": "ACTION_KEYGUARD_FACE_UNLOCK_TO_HOME"
     }
   },
   "com.android.internal.util.ObservableServiceConnection.DisconnectReason": {
diff --git a/tools/winscope/src/common/persistent_store.ts b/tools/winscope/src/common/persistent_store.ts
index ea03555db..f145b3bf1 100644
--- a/tools/winscope/src/common/persistent_store.ts
+++ b/tools/winscope/src/common/persistent_store.ts
@@ -14,7 +14,9 @@
  * limitations under the License.
  */
 
-export class PersistentStore {
+import {Store} from './store';
+
+export class PersistentStore implements Store {
   add(key: string, value: string) {
     localStorage.setItem(key, value);
   }
diff --git a/tools/winscope/src/common/persistent_store_proxy.ts b/tools/winscope/src/common/persistent_store_proxy.ts
index 3db340018..af7087c6c 100644
--- a/tools/winscope/src/common/persistent_store_proxy.ts
+++ b/tools/winscope/src/common/persistent_store_proxy.ts
@@ -14,13 +14,15 @@
  * limitations under the License.
  */
 
+import {Store} from './store';
+
 export class PersistentStoreProxy {
   static new<T extends object>(
     key: string,
     defaultState: T,
-    storage: Storage,
+    storage: Store,
   ): T {
-    const storedState = JSON.parse(storage.getItem(key) ?? '{}');
+    const storedState = JSON.parse(storage.get(key) ?? '{}', parseMap);
     const currentState = mergeDeep({}, structuredClone(defaultState));
     mergeDeepKeepingStructure(currentState, storedState);
     return wrapWithPersistentStoreProxy(key, currentState, storage) as T;
@@ -30,7 +32,7 @@ export class PersistentStoreProxy {
 function wrapWithPersistentStoreProxy(
   storeKey: string,
   object: object,
-  storage: Storage,
+  storage: Store,
   baseObject: object = object,
 ): object {
   const updatableProps: string[] = [];
@@ -39,6 +41,7 @@ function wrapWithPersistentStoreProxy(
     if (
       typeof value === 'string' ||
       typeof value === 'boolean' ||
+      typeof value === 'number' ||
       value === undefined
     ) {
       if (!Array.isArray(object)) {
@@ -53,23 +56,35 @@ function wrapWithPersistentStoreProxy(
       );
     }
   }
-
   const proxyObj = new Proxy(object, {
     set: (target, prop, newValue) => {
       if (typeof prop === 'symbol') {
-        throw Error("Can't use symbol keys only strings");
+        throw new Error("Can't use symbol keys only strings");
       }
-      if (Array.isArray(target) && typeof prop === 'number') {
-        target[prop] = newValue;
-        storage.setItem(storeKey, JSON.stringify(baseObject));
+      if (
+        Array.isArray(target) &&
+        (typeof prop === 'number' || !Number.isNaN(Number(prop)))
+      ) {
+        target[Number(prop)] = newValue;
+        storage.add(storeKey, JSON.stringify(baseObject, stringifyMap));
+        return true;
+      }
+      if (!Array.isArray(target) && Array.isArray(newValue)) {
+        (target as any)[prop] = wrapWithPersistentStoreProxy(
+          storeKey,
+          newValue,
+          storage,
+          baseObject,
+        );
+        storage.add(storeKey, JSON.stringify(baseObject, stringifyMap));
         return true;
       }
       if (!Array.isArray(target) && updatableProps.includes(prop)) {
         (target as any)[prop] = newValue;
-        storage.setItem(storeKey, JSON.stringify(baseObject));
+        storage.add(storeKey, JSON.stringify(baseObject, stringifyMap));
         return true;
       }
-      throw Error(
+      throw new Error(
         `Object property '${prop}' is not updatable. Can only update leaf keys: [${updatableProps}]`,
       );
     },
@@ -127,3 +142,20 @@ function mergeDeep(target: any, ...sources: any): any {
 
   return mergeDeep(target, ...sources);
 }
+
+export function stringifyMap(key: string, value: any) {
+  if (value instanceof Map) {
+    return {
+      type: 'Map',
+      value: [...value],
+    };
+  }
+  return value;
+}
+
+export function parseMap(key: string, value: any) {
+  if (value && value.type === 'Map') {
+    return new Map(value.value);
+  }
+  return value;
+}
diff --git a/tools/winscope/src/common/persistent_store_proxy_test.ts b/tools/winscope/src/common/persistent_store_proxy_test.ts
index 986807d21..eaeb05d43 100644
--- a/tools/winscope/src/common/persistent_store_proxy_test.ts
+++ b/tools/winscope/src/common/persistent_store_proxy_test.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {InMemoryStorage} from 'common/in_memory_storage';
+import {InMemoryStorage} from './in_memory_storage';
 import {PersistentStoreProxy} from './persistent_store_proxy';
 
 describe('PersistentStoreObject', () => {
diff --git a/tools/winscope/src/common/store.ts b/tools/winscope/src/common/store.ts
new file mode 100644
index 000000000..1be137b73
--- /dev/null
+++ b/tools/winscope/src/common/store.ts
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export interface Store {
+  add(key: string, value: string): void;
+  get(key: string): string | undefined;
+  clear(keySubstring: string): void;
+}
diff --git a/tools/winscope/src/common/time.ts b/tools/winscope/src/common/time.ts
index cbf04779e..e3fbe6d2f 100644
--- a/tools/winscope/src/common/time.ts
+++ b/tools/winscope/src/common/time.ts
@@ -32,7 +32,12 @@ export interface TimezoneInfo {
 }
 
 export interface TimestampFormatter {
-  format(timestamp: Timestamp): string;
+  format(timestamp: Timestamp, type: TimestampFormatType): string;
+}
+
+export enum TimestampFormatType {
+  FULL,
+  DROP_DATE,
 }
 
 export class Timestamp {
@@ -75,7 +80,7 @@ export class Timestamp {
     return new Timestamp(this.getValueNs() / n, this.formatter);
   }
 
-  format(): string {
-    return this.formatter.format(this);
+  format(type = TimestampFormatType.FULL): string {
+    return this.formatter.format(this, type);
   }
 }
diff --git a/tools/winscope/src/common/time_duration.ts b/tools/winscope/src/common/time_duration.ts
index b7b3b0dd7..65b0720e4 100644
--- a/tools/winscope/src/common/time_duration.ts
+++ b/tools/winscope/src/common/time_duration.ts
@@ -14,7 +14,8 @@
  * limitations under the License.
  */
 
-import {TimestampUtils} from './timestamp_utils';
+import {BigintMath} from './bigint_math';
+import {TIME_UNIT_TO_NANO} from './time_units';
 
 export class TimeDuration {
   constructor(private timeDiffNs: bigint) {}
@@ -23,6 +24,10 @@ export class TimeDuration {
   }
 
   format(): string {
-    return TimestampUtils.formatElapsedNs(this.timeDiffNs);
+    const msString = BigintMath.divideAndRound(
+      this.timeDiffNs,
+      BigInt(TIME_UNIT_TO_NANO.ms),
+    );
+    return msString.toLocaleString() + ' ms';
   }
 }
diff --git a/tools/winscope/src/common/time_duration_test.ts b/tools/winscope/src/common/time_duration_test.ts
new file mode 100644
index 000000000..8b265d8fd
--- /dev/null
+++ b/tools/winscope/src/common/time_duration_test.ts
@@ -0,0 +1,56 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TimeDuration} from './time_duration';
+import {TIME_UNIT_TO_NANO} from './time_units';
+
+describe('TimeDuration', () => {
+  const MILLISECOND = BigInt(TIME_UNIT_TO_NANO.ms);
+  const SECOND = BigInt(TIME_UNIT_TO_NANO.s);
+  const MINUTE = BigInt(TIME_UNIT_TO_NANO.m);
+
+  it('formats to nearest ms, using locale format for number', () => {
+    const expected0 = makeExpectedString(0);
+    expect(new TimeDuration(0n).format()).toEqual(expected0);
+    expect(new TimeDuration(1000n).format()).toEqual(expected0);
+    expect(new TimeDuration(10n * MILLISECOND).format()).toEqual(
+      makeExpectedString(10),
+    );
+
+    const expected1000 = makeExpectedString(1000);
+    expect(new TimeDuration(SECOND - 1n).format()).toEqual(expected1000);
+    expect(new TimeDuration(SECOND).format()).toEqual(expected1000);
+    expect(new TimeDuration(SECOND + MILLISECOND).format()).toEqual(
+      makeExpectedString(1001),
+    );
+
+    const expected60000 = makeExpectedString(60000);
+    expect(new TimeDuration(MINUTE - 1n).format()).toEqual(expected60000);
+    expect(new TimeDuration(MINUTE).format()).toEqual(expected60000);
+
+    const expected61001 = makeExpectedString(61001);
+    expect(new TimeDuration(MINUTE + SECOND + MILLISECOND).format()).toEqual(
+      expected61001,
+    );
+    expect(
+      new TimeDuration(MINUTE + SECOND + MILLISECOND + 1n).format(),
+    ).toEqual(expected61001);
+  });
+
+  function makeExpectedString(value: number) {
+    return BigInt(value).toLocaleString() + ' ms';
+  }
+});
diff --git a/tools/winscope/src/common/timestamp_converter.ts b/tools/winscope/src/common/timestamp_converter.ts
index 97b6956f5..81184e7aa 100644
--- a/tools/winscope/src/common/timestamp_converter.ts
+++ b/tools/winscope/src/common/timestamp_converter.ts
@@ -15,10 +15,12 @@
  */
 
 import {assertDefined, assertTrue} from './assert_utils';
+import {BigintMath} from './bigint_math';
 import {
   INVALID_TIME_NS,
   Timestamp,
   TimestampFormatter,
+  TimestampFormatType,
   TimezoneInfo,
 } from './time';
 import {TimestampUtils} from './timestamp_utils';
@@ -40,15 +42,22 @@ class RealTimestampFormatter implements TimestampFormatter {
     this.utcOffset = value;
   }
 
-  format(timestamp: Timestamp): string {
+  format(timestamp: Timestamp, type: TimestampFormatType): string {
     const timestampNanos =
       timestamp.getValueNs() + (this.utcOffset.getValueNs() ?? 0n);
-    const ms = timestampNanos / 1000000n;
+    const ms = BigintMath.divideAndRound(
+      timestampNanos,
+      BigInt(TIME_UNIT_TO_NANO.ms),
+    );
     const formattedTimestamp = new Date(Number(ms))
       .toISOString()
       .replace('Z', '')
       .replace('T', ', ');
-
+    if (type === TimestampFormatType.DROP_DATE) {
+      return assertDefined(
+        TimestampUtils.extractTimeFromHumanTimestamp(formattedTimestamp),
+      );
+    }
     return formattedTimestamp;
   }
 }
@@ -58,8 +67,24 @@ const REAL_TIMESTAMP_FORMATTER_UTC = new RealTimestampFormatter(
 
 class ElapsedTimestampFormatter {
   format(timestamp: Timestamp): string {
-    const timestampNanos = timestamp.getValueNs();
-    return TimestampUtils.formatElapsedNs(timestampNanos);
+    let leftNanos = timestamp.getValueNs();
+    const parts: Array<{value: bigint; unit: string}> = TIME_UNITS.slice()
+      .reverse()
+      .map(({nanosInUnit, unit}) => {
+        let amountOfUnit = BigInt(0);
+        if (leftNanos >= nanosInUnit) {
+          amountOfUnit = leftNanos / BigInt(nanosInUnit);
+        }
+        leftNanos = leftNanos % BigInt(nanosInUnit);
+        return {value: amountOfUnit, unit};
+      });
+
+    // Remove all 0ed units at start
+    while (parts.length > 1 && parts[0].value === 0n) {
+      parts.shift();
+    }
+
+    return parts.map((part) => `${part.value}${part.unit}`).join('');
   }
 }
 const ELAPSED_TIMESTAMP_FORMATTER = new ElapsedTimestampFormatter();
@@ -167,7 +192,7 @@ export class TimestampConverter
       return this.makeTimestampFromHumanReal(timestampHuman);
     }
 
-    throw Error('Invalid timestamp format');
+    throw new Error('Invalid timestamp format');
   }
 
   makeTimestampFromNs(valueNs: bigint): Timestamp {
diff --git a/tools/winscope/src/common/timestamp_converter_test.ts b/tools/winscope/src/common/timestamp_converter_test.ts
index d83240b41..81a09d0d8 100644
--- a/tools/winscope/src/common/timestamp_converter_test.ts
+++ b/tools/winscope/src/common/timestamp_converter_test.ts
@@ -524,7 +524,7 @@ describe('TimestampConverter', () => {
       testMakeTimestampFromHumanReal(
         '2022-11-10T11:34:54.0175328',
         NOV_10_2022 + 6n * HOUR + 4n * MINUTE + 54n * SECOND + 17532800n,
-        '2022-11-10, 11:34:54.017',
+        '2022-11-10, 11:34:54.018',
       );
     });
 
diff --git a/tools/winscope/src/common/timestamp_utils.ts b/tools/winscope/src/common/timestamp_utils.ts
index 956a5dbc9..62b23eda7 100644
--- a/tools/winscope/src/common/timestamp_utils.ts
+++ b/tools/winscope/src/common/timestamp_utils.ts
@@ -15,7 +15,6 @@
  */
 
 import {Timestamp} from 'common/time';
-import {TIME_UNITS} from './time_units';
 
 export class TimestampUtils {
   // (?=.) checks there is at least one character with a lookahead match
@@ -103,25 +102,4 @@ export class TimestampUtils {
 
     return ts1;
   }
-
-  static formatElapsedNs(timestampNanos: bigint): string {
-    let leftNanos = timestampNanos;
-    const parts: Array<{value: bigint; unit: string}> = TIME_UNITS.slice()
-      .reverse()
-      .map(({nanosInUnit, unit}) => {
-        let amountOfUnit = BigInt(0);
-        if (leftNanos >= nanosInUnit) {
-          amountOfUnit = leftNanos / BigInt(nanosInUnit);
-        }
-        leftNanos = leftNanos % BigInt(nanosInUnit);
-        return {value: amountOfUnit, unit};
-      });
-
-    // Remove all 0ed units at start
-    while (parts.length > 1 && parts[0].value === 0n) {
-      parts.shift();
-    }
-
-    return parts.map((part) => `${part.value}${part.unit}`).join('');
-  }
 }
diff --git a/tools/winscope/src/common/user_notifier.ts b/tools/winscope/src/common/user_notifier.ts
new file mode 100644
index 000000000..e0d800c83
--- /dev/null
+++ b/tools/winscope/src/common/user_notifier.ts
@@ -0,0 +1,45 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {SnackBarOpener} from 'app/components/snack_bar_opener';
+import {Analytics} from 'logging/analytics';
+import {UserNotification} from 'messaging/user_notification';
+
+export class UserNotifier {
+  static setSnackBarOpener(snackBarOpener: SnackBarOpener) {
+    UserNotifier.snackBarOpener = snackBarOpener;
+  }
+
+  static add(notification: UserNotification): typeof UserNotifier {
+    UserNotifier.notifications.push(notification);
+    return UserNotifier;
+  }
+
+  static notify() {
+    if (UserNotifier.notifications.length === 0) return;
+    UserNotifier.notifications.forEach((notif) => {
+      Analytics.UserNotification.logUserWarning(
+        notif.getDescriptor(),
+        notif.getMessage(),
+      );
+    });
+    UserNotifier.snackBarOpener?.onNotifications(UserNotifier.notifications);
+    UserNotifier.notifications = [];
+  }
+
+  private static notifications: UserNotification[] = [];
+  private static snackBarOpener: SnackBarOpener | undefined;
+}
diff --git a/tools/winscope/src/logging/analytics.ts b/tools/winscope/src/logging/analytics.ts
index 07c89e9fd..c0b81d886 100644
--- a/tools/winscope/src/logging/analytics.ts
+++ b/tools/winscope/src/logging/analytics.ts
@@ -21,17 +21,21 @@ import {TraceType} from 'trace/trace_type';
 
 /* eslint-disable no-undef */
 export class Analytics {
-  private static GLOBAL_EXCEPTION = 'global_exception';
+  private static BUGANIZER_OPENED = 'buganizer_opened';
   private static CROSS_TOOL_SYNC = 'cross_tool_sync';
   private static DARK_MODE_ENABLED = 'dark_mode_enabled';
   private static DOCUMENTATION_OPENED = 'documentation_opened';
-  private static BUGANIZER_OPENED = 'buganizer_opened';
   private static EXPANDED_TIMELINE_OPENED = 'expanded_timeline_opened';
+  private static GLOBAL_EXCEPTION = 'global_exception';
   private static HIERARCHY_SETTINGS = 'hierarchy_settings';
   private static NAVIGATION_ZOOM_EVENT = 'navigation_zoom';
   private static PROPERTIES_SETTINGS = 'properties_settings';
+  private static PROXY_ERROR = 'proxy_error';
+  private static PROXY_SERVER_NOT_FOUND = 'proxy_server_not_found';
+  private static PROXY_NO_FILES_FOUND = 'proxy_no_files_found';
   private static RECT_SETTINGS = 'rect_settings';
   private static REFRESH_DUMPS = 'refresh_dumps';
+  private static TIME_BOOKMARK = 'time_bookmark';
   private static TIME_COPIED = 'time_copied';
   private static TIME_INPUT = 'time_input';
   private static TRACE_TAB_SWITCHED = 'trace_tab_switched';
@@ -48,6 +52,11 @@ export class Analytics {
         description,
       } as Gtag.CustomParams);
     }
+    static logProxyError(description: string) {
+      Analytics.doLogEvent(Analytics.PROXY_ERROR, {
+        description,
+      } as Gtag.CustomParams);
+    }
   };
 
   static Help = class {
@@ -60,17 +69,6 @@ export class Analytics {
     }
   };
 
-  static Settings = class {
-    static logDarkModeEnabled() {
-      Analytics.doLogEvent(Analytics.DARK_MODE_ENABLED);
-    }
-    static logCrossToolSync(value: boolean) {
-      Analytics.doLogEvent(Analytics.CROSS_TOOL_SYNC, {
-        value,
-      } as Gtag.CustomParams);
-    }
-  };
-
   static Navigation = class {
     static logExpandedTimelineOpened() {
       Analytics.doLogEvent(Analytics.EXPANDED_TIMELINE_OPENED);
@@ -130,6 +128,10 @@ export class Analytics {
       } as Gtag.CustomParams);
     }
 
+    static logTimeBookmark() {
+      Analytics.doLogEvent(Analytics.TIME_BOOKMARK);
+    }
+
     static logTraceTimelineDeselected(type: string) {
       Analytics.doLogEvent(Analytics.TRACE_TIMELINE_DESELECTED, {
         type,
@@ -137,7 +139,7 @@ export class Analytics {
     }
 
     static logZoom(
-      type: 'scroll' | 'button' | 'reset',
+      type: 'scroll' | 'button' | 'reset' | 'key',
       component: 'rects' | 'timeline',
       direction?: 'in' | 'out',
     ) {
@@ -149,6 +151,27 @@ export class Analytics {
     }
   };
 
+  static Proxy = class {
+    static logServerNotFound() {
+      Analytics.doLogEvent(Analytics.PROXY_SERVER_NOT_FOUND);
+    }
+
+    static logNoFilesFound() {
+      Analytics.doLogEvent(Analytics.PROXY_NO_FILES_FOUND);
+    }
+  };
+
+  static Settings = class {
+    static logDarkModeEnabled() {
+      Analytics.doLogEvent(Analytics.DARK_MODE_ENABLED);
+    }
+    static logCrossToolSync(value: boolean) {
+      Analytics.doLogEvent(Analytics.CROSS_TOOL_SYNC, {
+        value,
+      } as Gtag.CustomParams);
+    }
+  };
+
   static Tracing = class {
     static logTraceLoaded(parser: Parser<object>) {
       Analytics.doLogEvent(Analytics.TRACING_LOADED_EVENT, {
@@ -183,9 +206,10 @@ export class Analytics {
   };
 
   static UserNotification = class {
-    static logUserWarning(description: string) {
+    static logUserWarning(description: string, message: string) {
       Analytics.doLogEvent(Analytics.USER_WARNING, {
         description,
+        message,
       } as Gtag.CustomParams);
     }
   };
diff --git a/tools/winscope/src/material-theme.scss b/tools/winscope/src/material-theme.scss
index 109081f12..1a4ab0ac1 100644
--- a/tools/winscope/src/material-theme.scss
+++ b/tools/winscope/src/material-theme.scss
@@ -78,50 +78,70 @@ $dark-theme: mat.define-dark-theme((
 @include mat.all-component-themes($light-theme);
 
 body:not(.dark-mode) {
+  --added-element-color: #D8EAC5;
   @include background-color($light-theme);
   --blue-text-color: #{map.get(mat.$indigo-palette, A200)};
   @include border-color($light-theme);
   --card-title-background-color: #f1f1f1;
   --contrast-text-color: white;
   --current-element-color: #7b9ccc;
+  --default-text-color: rgba(0, 0, 0, 0.87);
+  --deleted-element-color: #FFCFD0;
   --disabled-color: rgba(0, 0, 0, 0.12);
   --drawer-block-primary: #EEEFF0;
   --drawer-block-secondary: #DDDDDD;
   --drawer-color: var(--background-color);
-  --green-text-color: #1f912c;
-  --hover-element-color: #E8F0FE;
+  --gray-text-color: #7f7f7f;
+  --green-text-color: #4e9c00;
+  --hover-element-color: #eaeaea;
+  --modified-element-color: #b8eaea;
+  --overlay-panel-background-color: white;
+  --primary: #{mat.get-color-from-palette(mat.$blue-palette, 700)};
   --purple-text-color: #a357e9;
-  --red-text-color: #d3251b;
-  --selected-element-color: #d2e3fc;
+  --red-text-color: #b30000;
+  --selected-element-color: #E2ECFF;
   --side-bar-color: #6E6E6E;
   --slider-background-color: #E8F0FE;
   --slider-border-color: #8AB4F8;
   --trace-view-background-color: #E4E4E4;
-  --warning-background-color: #{mat.get-color-from-palette(mat.$amber-palette, 50)};
+  --warning-background-color: #ffe9bd;
+  --warning-color: #e37400;
+  --error-background-color: #ffdada;
+  --error-color: #d93025;
   --icon-accent-color: #d9d9d9;
 }
 
 body.dark-mode {
   @include mat.all-component-colors($dark-theme);
+  --added-element-color: #6D8358;
   @include background-color($dark-theme);
   --blue-text-color: #b8e3fd;
   @include border-color($dark-theme);
   --card-title-background-color: #343434;
   --contrast-text-color: rgba(0, 0, 0, 0.87);
   --current-element-color: #365179;
+  --default-text-color: white;
+  --deleted-element-color: #856566;
   --disabled-color: rgba(255, 255, 255, 0.12);
   --drawer-block-primary: #696563;
   --drawer-block-secondary: #5e5b5a;
   @include drawer-color($dark-theme);
-  --green-text-color: #89e593;
-  --hover-element-color: #4e5767;
+  --gray-text-color: #aeaeae;
+  --green-text-color: #6ad400;
+  --hover-element-color: #656565;
+  --modified-element-color: #619696;
+  --overlay-panel-background-color: #424242;
+  --primary: #{mat.get-color-from-palette(mat.$blue-palette, 400)};
   --purple-text-color: #dbb4ff;
-  --red-text-color: #f19993;
-  --selected-element-color: #5f718a;
+  --red-text-color: #f85252;
+  --selected-element-color: #546481;
   --side-bar-color: #dedcdc;
   --slider-background-color: #8AB4F8;
   --slider-border-color: #E8F0FE;
   --trace-view-background-color: #383838;
-  --warning-background-color: #{mat.get-color-from-palette(mat.$brown-palette, 700)};
+  --warning-background-color: #FFE9BD80;
+  --warning-color: #fbbc04;
+  --error-background-color: #FFDADA80;
+  --error-color: #f6aea9;
   --icon-accent-color: #969696;
 }
diff --git a/tools/winscope/src/messaging/progress_listener.ts b/tools/winscope/src/messaging/progress_listener.ts
index 4dbc8efcc..f774dec1c 100644
--- a/tools/winscope/src/messaging/progress_listener.ts
+++ b/tools/winscope/src/messaging/progress_listener.ts
@@ -19,5 +19,5 @@ export interface ProgressListener {
     message: string,
     progressPercentage: number | undefined,
   ): void;
-  onOperationFinished(): void;
+  onOperationFinished(success: boolean): void;
 }
diff --git a/tools/winscope/src/messaging/progress_listener_stub.ts b/tools/winscope/src/messaging/progress_listener_stub.ts
index c665c45fc..f980c08e6 100644
--- a/tools/winscope/src/messaging/progress_listener_stub.ts
+++ b/tools/winscope/src/messaging/progress_listener_stub.ts
@@ -21,7 +21,7 @@ export class ProgressListenerStub implements ProgressListener {
     // do nothing
   }
 
-  onOperationFinished() {
+  onOperationFinished(success = true) {
     // do nothing
   }
 }
diff --git a/tools/winscope/src/messaging/user_warning.ts b/tools/winscope/src/messaging/user_warning.ts
index 99adab1e0..233901058 100644
--- a/tools/winscope/src/messaging/user_warning.ts
+++ b/tools/winscope/src/messaging/user_warning.ts
@@ -14,13 +14,9 @@
  * limitations under the License.
  */
 
-import {Analytics} from 'logging/analytics';
 import {NotificationType, UserNotification} from './user_notification';
 
 export abstract class UserWarning implements UserNotification {
-  constructor() {
-    Analytics.UserNotification.logUserWarning(this.getDescriptor());
-  }
   getNotificationType(): NotificationType {
     return NotificationType.WARNING;
   }
diff --git a/tools/winscope/src/messaging/user_warnings.ts b/tools/winscope/src/messaging/user_warnings.ts
index bddf3dfe7..2dd1fe4d0 100644
--- a/tools/winscope/src/messaging/user_warnings.ts
+++ b/tools/winscope/src/messaging/user_warnings.ts
@@ -16,6 +16,7 @@
 
 import {TimeRange} from 'common/time';
 import {TimeDuration} from 'common/time_duration';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {UserWarning} from './user_warning';
 
@@ -33,13 +34,19 @@ export class CorruptedArchive extends UserWarning {
   }
 }
 
-export class NoInputFiles extends UserWarning {
+export class NoValidFiles extends UserWarning {
+  constructor(private traces?: string[]) {
+    super();
+  }
   getDescriptor(): string {
-    return 'no input';
+    return 'no valid files';
   }
 
   getMessage(): string {
-    return `Input has no valid trace files`;
+    return (
+      'No valid trace files found' +
+      (this.traces ? ` for ${this.traces.join(', ')}` : '')
+    );
   }
 }
 
@@ -104,10 +111,27 @@ export class UnsupportedFileFormat extends UserWarning {
   }
 }
 
+export class InvalidLegacyTrace extends UserWarning {
+  constructor(
+    private readonly descriptor: string,
+    private readonly errorMessage: string,
+  ) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'invalid legacy trace';
+  }
+
+  getMessage(): string {
+    return `${this.descriptor}: ${this.errorMessage}`;
+  }
+}
+
 export class InvalidPerfettoTrace extends UserWarning {
   constructor(
     private readonly descriptor: string,
-    private readonly parserErrorMessages: string[],
+    private readonly errorMessages: string[],
   ) {
     super();
   }
@@ -117,6 +141,156 @@ export class InvalidPerfettoTrace extends UserWarning {
   }
 
   getMessage(): string {
-    return `${this.descriptor}: ${this.parserErrorMessages.join(', ')}`;
+    return `${this.descriptor}: ${this.errorMessages.join(', ')}`;
+  }
+}
+
+export class FailedToCreateTracesParser extends UserWarning {
+  constructor(
+    private readonly traceType: TraceType,
+    private readonly errorMessage: string,
+  ) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'failed to create traces parser';
+  }
+
+  getMessage(): string {
+    return `Failed to create ${TRACE_INFO[this.traceType].name} parser: ${
+      this.errorMessage
+    }`;
+  }
+}
+
+export class CannotVisualizeTraceEntry extends UserWarning {
+  constructor(private readonly errorMessage: string) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'cannot visualize trace entry';
+  }
+
+  getMessage(): string {
+    return this.errorMessage;
+  }
+}
+
+export class FailedToInitializeTimelineData extends UserWarning {
+  getDescriptor(): string {
+    return 'failed to initialize timeline data';
+  }
+
+  getMessage(): string {
+    return 'Cannot visualize all traces: Failed to initialize timeline data.\nTry removing some traces.';
+  }
+}
+
+export class IncompleteFrameMapping extends UserWarning {
+  constructor(private readonly errorMessage: string) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'incomplete frame mapping';
+  }
+
+  getMessage(): string {
+    return `Error occurred in frame mapping: ${this.errorMessage}`;
+  }
+}
+
+export class NoTraceTargetsSelected extends UserWarning {
+  getDescriptor(): string {
+    return 'No trace targets selected';
+  }
+
+  getMessage(): string {
+    return 'No trace targets selected.';
+  }
+}
+
+export class MissingVsyncId extends UserWarning {
+  constructor(private readonly tableName: string) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'missing vsync id';
+  }
+
+  getMessage(): string {
+    return `missing vsync_id value for one or more entries in ${this.tableName}`;
+  }
+}
+
+export class ProxyTraceTimeout extends UserWarning {
+  getDescriptor(): string {
+    return 'proxy trace timeout';
+  }
+
+  getMessage(): string {
+    return 'Errors occurred during tracing: trace timed out';
+  }
+}
+
+export class ProxyTracingErrors extends UserWarning {
+  constructor(private readonly errorMessages: string[]) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'proxy tracing errors';
+  }
+
+  getMessage(): string {
+    return `Errors occurred during tracing: ${this.errorMessages.join(', ')}`;
+  }
+}
+
+export class MissingLayerIds extends UserWarning {
+  getDescriptor(): string {
+    return 'missing layer ids';
+  }
+
+  getMessage(): string {
+    return 'Cannot parse some layers due to null or undefined layer id';
+  }
+}
+
+export class DuplicateLayerId extends UserWarning {
+  constructor(private readonly layerId: string) {
+    super();
+  }
+
+  getDescriptor(): string {
+    return 'duplicate layer id';
+  }
+
+  getMessage(): string {
+    return `Duplicate SF layer id ${this.layerId} found - adding it as "Duplicate" to the hierarchy`;
+  }
+}
+
+export class MonotonicScreenRecording extends UserWarning {
+  getDescriptor(): string {
+    return 'monotonic screen recording';
+  }
+
+  getMessage(): string {
+    return `Screen recording may not be synchronized with the
+      other traces. Metadata contains monotonic time instead of elapsed.`;
+  }
+}
+
+export class CannotParseAllTransitions extends UserWarning {
+  getDescriptor(): string {
+    return 'cannot parse all transitions';
+  }
+
+  getMessage(): string {
+    return 'Cannot parse all transitions. Some may be missing in Transitions viewer.';
   }
 }
diff --git a/tools/winscope/src/messaging/winscope_event.ts b/tools/winscope/src/messaging/winscope_event.ts
index c2ad94cf0..e0982a6f8 100644
--- a/tools/winscope/src/messaging/winscope_event.ts
+++ b/tools/winscope/src/messaging/winscope_event.ts
@@ -18,6 +18,8 @@ import {assertTrue} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {Trace, TraceEntry} from 'trace/trace';
 import {TracePosition} from 'trace/trace_position';
+import {TraceType} from 'trace/trace_type';
+import {AdbFiles} from 'trace_collection/adb_files';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 
 export enum WinscopeEventType {
@@ -38,6 +40,9 @@ export enum WinscopeEventType {
   EXPANDED_TIMELINE_TOGGLED,
   ACTIVE_TRACE_CHANGED,
   DARK_MODE_TOGGLED,
+  NO_TRACE_TARGETS_SELECTED,
+  FILTER_PRESET_SAVE_REQUEST,
+  FILTER_PRESET_APPLY_REQUEST,
 }
 
 interface TypeMap {
@@ -58,6 +63,9 @@ interface TypeMap {
   [WinscopeEventType.EXPANDED_TIMELINE_TOGGLED]: ExpandedTimelineToggled;
   [WinscopeEventType.ACTIVE_TRACE_CHANGED]: ActiveTraceChanged;
   [WinscopeEventType.DARK_MODE_TOGGLED]: DarkModeToggled;
+  [WinscopeEventType.NO_TRACE_TARGETS_SELECTED]: NoTraceTargetsSelected;
+  [WinscopeEventType.FILTER_PRESET_SAVE_REQUEST]: FilterPresetSaveRequest;
+  [WinscopeEventType.FILTER_PRESET_APPLY_REQUEST]: FilterPresetApplyRequest;
 }
 
 export abstract class WinscopeEvent {
@@ -81,7 +89,7 @@ export class AppInitialized extends WinscopeEvent {
 export class AppFilesCollected extends WinscopeEvent {
   override readonly type = WinscopeEventType.APP_FILES_COLLECTED;
 
-  constructor(readonly files: File[]) {
+  constructor(readonly files: AdbFiles) {
     super();
   }
 }
@@ -171,7 +179,7 @@ export class TracePositionUpdate extends WinscopeEvent {
   }
 
   static fromTraceEntry(
-    entry: TraceEntry<object>,
+    entry: TraceEntry<any>,
     updateTimeline = false,
   ): TracePositionUpdate {
     const position = TracePosition.fromTraceEntry(entry);
@@ -211,3 +219,21 @@ export class DarkModeToggled extends WinscopeEvent {
     super();
   }
 }
+
+export class NoTraceTargetsSelected extends WinscopeEvent {
+  override readonly type = WinscopeEventType.NO_TRACE_TARGETS_SELECTED;
+}
+
+export class FilterPresetSaveRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.FILTER_PRESET_SAVE_REQUEST;
+  constructor(readonly name: string, readonly traceType: TraceType) {
+    super();
+  }
+}
+
+export class FilterPresetApplyRequest extends WinscopeEvent {
+  override readonly type = WinscopeEventType.FILTER_PRESET_APPLY_REQUEST;
+  constructor(readonly name: string, readonly traceType: TraceType) {
+    super();
+  }
+}
diff --git a/tools/winscope/src/parsers/events/cuj_type.ts b/tools/winscope/src/parsers/events/cuj_type.ts
deleted file mode 100644
index a0ec1b1bc..000000000
--- a/tools/winscope/src/parsers/events/cuj_type.ts
+++ /dev/null
@@ -1,100 +0,0 @@
-/*
- * Copyright 2024, The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-// copied from platform: https://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:frameworks/base/core/java/com/android/internal/jank/Cuj.java
-export enum CujType {
-  CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE = 0,
-  CUJ_NOTIFICATION_SHADE_SCROLL_FLING = 2,
-  CUJ_NOTIFICATION_SHADE_ROW_EXPAND = 3,
-  CUJ_NOTIFICATION_SHADE_ROW_SWIPE = 4,
-  CUJ_NOTIFICATION_SHADE_QS_EXPAND_COLLAPSE = 5,
-  CUJ_NOTIFICATION_SHADE_QS_SCROLL_SWIPE = 6,
-  CUJ_LAUNCHER_APP_LAUNCH_FROM_RECENTS = 7,
-  CUJ_LAUNCHER_APP_LAUNCH_FROM_ICON = 8,
-  CUJ_LAUNCHER_APP_CLOSE_TO_HOME = 9,
-  CUJ_LAUNCHER_APP_CLOSE_TO_PIP = 10,
-  CUJ_LAUNCHER_QUICK_SWITCH = 11,
-  CUJ_NOTIFICATION_HEADS_UP_APPEAR = 12,
-  CUJ_NOTIFICATION_HEADS_UP_DISAPPEAR = 13,
-  CUJ_NOTIFICATION_ADD = 14,
-  CUJ_NOTIFICATION_REMOVE = 15,
-  CUJ_NOTIFICATION_APP_START = 16,
-  CUJ_LOCKSCREEN_PASSWORD_APPEAR = 17,
-  CUJ_LOCKSCREEN_PATTERN_APPEAR = 18,
-  CUJ_LOCKSCREEN_PIN_APPEAR = 19,
-  CUJ_LOCKSCREEN_PASSWORD_DISAPPEAR = 20,
-  CUJ_LOCKSCREEN_PATTERN_DISAPPEAR = 21,
-  CUJ_LOCKSCREEN_PIN_DISAPPEAR = 22,
-  CUJ_LOCKSCREEN_TRANSITION_FROM_AOD = 23,
-  CUJ_LOCKSCREEN_TRANSITION_TO_AOD = 24,
-  CUJ_LAUNCHER_OPEN_ALL_APPS = 25,
-  CUJ_LAUNCHER_ALL_APPS_SCROLL = 26,
-  CUJ_LAUNCHER_APP_LAUNCH_FROM_WIDGET = 27,
-  CUJ_SETTINGS_PAGE_SCROLL = 28,
-  CUJ_LOCKSCREEN_UNLOCK_ANIMATION = 29,
-  CUJ_SHADE_APP_LAUNCH_FROM_HISTORY_BUTTON = 30,
-  CUJ_SHADE_APP_LAUNCH_FROM_MEDIA_PLAYER = 31,
-  CUJ_SHADE_APP_LAUNCH_FROM_QS_TILE = 32,
-  CUJ_SHADE_APP_LAUNCH_FROM_SETTINGS_BUTTON = 33,
-  CUJ_STATUS_BAR_APP_LAUNCH_FROM_CALL_CHIP = 34,
-  CUJ_PIP_TRANSITION = 35,
-  CUJ_WALLPAPER_TRANSITION = 36,
-  CUJ_USER_SWITCH = 37,
-  CUJ_SPLASHSCREEN_AVD = 38,
-  CUJ_SPLASHSCREEN_EXIT_ANIM = 39,
-  CUJ_SCREEN_OFF = 40,
-  CUJ_SCREEN_OFF_SHOW_AOD = 41,
-  CUJ_ONE_HANDED_ENTER_TRANSITION = 42,
-  CUJ_ONE_HANDED_EXIT_TRANSITION = 43,
-  CUJ_UNFOLD_ANIM = 44,
-  CUJ_SUW_LOADING_TO_SHOW_INFO_WITH_ACTIONS = 45,
-  CUJ_SUW_SHOW_FUNCTION_SCREEN_WITH_ACTIONS = 46,
-  CUJ_SUW_LOADING_TO_NEXT_FLOW = 47,
-  CUJ_SUW_LOADING_SCREEN_FOR_STATUS = 48,
-  CUJ_SPLIT_SCREEN_ENTER = 49,
-  CUJ_SPLIT_SCREEN_EXIT = 50,
-  CUJ_LOCKSCREEN_LAUNCH_CAMERA = 51,
-  CUJ_SPLIT_SCREEN_RESIZE = 52,
-  CUJ_SETTINGS_SLIDER = 53,
-  CUJ_TAKE_SCREENSHOT = 54,
-  CUJ_VOLUME_CONTROL = 55,
-  CUJ_BIOMETRIC_PROMPT_TRANSITION = 56,
-  CUJ_SETTINGS_TOGGLE = 57,
-  CUJ_SHADE_DIALOG_OPEN = 58,
-  CUJ_USER_DIALOG_OPEN = 59,
-  CUJ_TASKBAR_EXPAND = 60,
-  CUJ_TASKBAR_COLLAPSE = 61,
-  CUJ_SHADE_CLEAR_ALL = 62,
-  CUJ_LAUNCHER_UNLOCK_ENTRANCE_ANIMATION = 63,
-  CUJ_LOCKSCREEN_OCCLUSION = 64,
-  CUJ_RECENTS_SCROLLING = 65,
-  CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS = 66,
-  CUJ_LAUNCHER_CLOSE_ALL_APPS_SWIPE = 67,
-  CUJ_LAUNCHER_CLOSE_ALL_APPS_TO_HOME = 68,
-  CUJ_LOCKSCREEN_CLOCK_MOVE_ANIMATION = 70,
-  CUJ_LAUNCHER_OPEN_SEARCH_RESULT = 71,
-
-  // 72 - 77 are reserved for b/281564325.
-
-  CUJ_LAUNCHER_APP_CLOSE_TO_HOME_FALLBACK = 78,
-  CUJ_SHADE_EXPAND_FROM_STATUS_BAR = 79,
-  CUJ_IME_INSETS_SHOW_ANIMATION = 80,
-  CUJ_IME_INSETS_HIDE_ANIMATION = 81,
-
-  // KEEP AS LAST TYPE
-  // used to handle new types that haven't been added here yet but might be dumped by the platform
-  UNKNOWN = -1,
-}
diff --git a/tools/winscope/src/parsers/events/operations/add_cuj_properties.ts b/tools/winscope/src/parsers/events/operations/add_cuj_properties.ts
index 2dfead4d4..439cd00d5 100644
--- a/tools/winscope/src/parsers/events/operations/add_cuj_properties.ts
+++ b/tools/winscope/src/parsers/events/operations/add_cuj_properties.ts
@@ -16,8 +16,8 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {StringUtils} from 'common/string_utils';
-import {CujType} from 'parsers/events/cuj_type';
 import {EventTag} from 'parsers/events/event_tag';
+import {CujType} from 'trace/cuj_type';
 import {AddOperation} from 'trace/tree_node/operations/add_operation';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
@@ -78,19 +78,18 @@ export class AddCujProperties extends AddOperation<PropertyTreeNode> {
       !StringUtils.isNumeric(elapsedNs) ||
       !StringUtils.isNumeric(uptimeNs)
     ) {
-      throw Error(`Data ${data} didn't match expected format`);
+      throw new Error(`CUJ Data ${data} didn't match expected format`);
     }
 
     return data.slice(1, data.length - 2).split(',');
   }
 
-  private getCujTypeFromData(dataEntries: string[]): CujType {
+  private getCujTypeFromData(dataEntries: string[]): number {
     const eventId = Number(dataEntries[0]);
-    const cujType = Object.values(CujType).find((type) => type === eventId);
-    if (!cujType || typeof cujType === 'string') {
-      return CujType.UNKNOWN;
+    if (eventId in CujType) {
+      return eventId;
     }
-    return cujType;
+    return -1;
   }
 
   private getUnixNanosFromData(dataEntries: string[]): bigint {
diff --git a/tools/winscope/src/parsers/events/operations/add_cuj_properties_test.ts b/tools/winscope/src/parsers/events/operations/add_cuj_properties_test.ts
index ddea73032..63c70a2d8 100644
--- a/tools/winscope/src/parsers/events/operations/add_cuj_properties_test.ts
+++ b/tools/winscope/src/parsers/events/operations/add_cuj_properties_test.ts
@@ -14,7 +14,6 @@
  * limitations under the License.
  */
 
-import {CujType} from 'parsers/events/cuj_type';
 import {EventTag} from 'parsers/events/event_tag';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {AddCujProperties} from './add_cuj_properties';
@@ -58,7 +57,7 @@ describe('AddCujProperties', () => {
           name: 'eventData',
           value: '[66,1681207048025580000,2661012903966,2661012904007,]',
         },
-        {name: 'cujType', value: CujType.CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS},
+        {name: 'cujType', value: 66},
         {
           name: 'cujTimestamp',
           children: [
diff --git a/tools/winscope/src/parsers/events/traces_parser_cujs.ts b/tools/winscope/src/parsers/events/traces_parser_cujs.ts
index 677595d7c..85ff35b17 100644
--- a/tools/winscope/src/parsers/events/traces_parser_cujs.ts
+++ b/tools/winscope/src/parsers/events/traces_parser_cujs.ts
@@ -17,13 +17,15 @@
 import {assertDefined} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
-import {AbstractTracesParser} from 'parsers/legacy/abstract_traces_parser';
+import {SetFormatters} from 'parsers/operations/set_formatters';
+import {AbstractTracesParser} from 'parsers/traces/abstract_traces_parser';
+import {CoarseVersion} from 'trace/coarse_version';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
+import {CUJ_TYPE_FORMATTER} from 'trace/tree_node/formatters';
 import {PropertyTreeBuilderFromProto} from 'trace/tree_node/property_tree_builder_from_proto';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {CujType} from './cuj_type';
 import {EventTag} from './event_tag';
 import {AddCujProperties} from './operations/add_cuj_properties';
 
@@ -45,6 +47,10 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     }
   }
 
+  override getCoarseVersion(): CoarseVersion {
+    return CoarseVersion.LEGACY;
+  }
+
   override async parse() {
     if (this.eventLogTrace === undefined) {
       throw new Error('EventLog trace not defined');
@@ -66,6 +72,15 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     await this.createTimestamps();
   }
 
+  override async createTimestamps() {
+    this.timestamps = [];
+    for (let index = 0; index < this.getLengthEntries(); index++) {
+      const entry = await this.getEntry(index);
+      const timestamp = entry?.getChildByName('startTimestamp')?.getValue();
+      this.timestamps.push(timestamp);
+    }
+  }
+
   getLengthEntries(): number {
     return assertDefined(this.decodedEntries).length;
   }
@@ -83,13 +98,6 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     return TraceType.CUJS;
   }
 
-  protected override getTimestamp(cuj: PropertyTreeNode): Timestamp {
-    const cujTimestamp = assertDefined(cuj.getChildByName('startTimestamp'));
-    return this.timestampConverter.makeTimestampFromRealNs(
-      assertDefined(cujTimestamp.getChildByName('unixNanos')).getValue(),
-    );
-  }
-
   override getRealToMonotonicTimeOffsetNs(): bigint | undefined {
     return undefined;
   }
@@ -98,18 +106,10 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     return undefined;
   }
 
-  private makeCujTimestampObject(timestamp: PropertyTreeNode): CujTimestamp {
-    return {
-      unixNanos: assertDefined(
-        timestamp.getChildByName('unixNanos'),
-      ).getValue(),
-      elapsedNanos: assertDefined(
-        timestamp.getChildByName('elapsedNanos'),
-      ).getValue(),
-      systemUptimeNanos: assertDefined(
-        timestamp.getChildByName('systemUptimeNanos'),
-      ).getValue(),
-    };
+  private makeCujTimestampObject(timestamp: PropertyTreeNode): Timestamp {
+    return this.timestampConverter.makeTimestampFromRealNs(
+      assertDefined(timestamp.getChildByName('unixNanos')).getValue(),
+    );
   }
 
   private makeCujsFromEvents(events: PropertyTreeNode[]): PropertyTreeNode[] {
@@ -128,7 +128,7 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     const cujs: PropertyTreeNode[] = [];
 
     for (const startEvent of startEvents) {
-      const startCujType: CujType = assertDefined(
+      const cujType = assertDefined(
         startEvent.getChildByName('cujType'),
       ).getValue();
       const startTimestamp = assertDefined(
@@ -137,12 +137,12 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
 
       const matchingEndEvent = this.findMatchingEvent(
         endEvents,
-        startCujType,
+        cujType,
         startTimestamp,
       );
       const matchingCancelEvent = this.findMatchingEvent(
         canceledEvents,
-        startCujType,
+        cujType,
         startTimestamp,
       );
 
@@ -163,7 +163,7 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
         EventTag.JANK_CUJ_CANCEL_TAG;
 
       const cuj: Cuj = {
-        startCujType,
+        cujType,
         startTimestamp: this.makeCujTimestampObject(startTimestamp),
         endTimestamp: this.makeCujTimestampObject(closingEventTimestamp),
         canceled,
@@ -186,14 +186,14 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
 
   private findMatchingEvent(
     events: PropertyTreeNode[],
-    startCujType: CujType,
+    targetCujType: number,
     startTimestamp: PropertyTreeNode,
   ): PropertyTreeNode | undefined {
     return events.find((event) => {
       const cujType = assertDefined(event.getChildByName('cujType')).getValue();
       const timestamp = assertDefined(event.getChildByName('cujTimestamp'));
       return (
-        startCujType === cujType &&
+        targetCujType === cujType &&
         this.cujTimestampIsGreaterThan(timestamp, startTimestamp)
       );
     });
@@ -225,7 +225,7 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     } else if (!cancelTimestamp) {
       closingEvent = endEvent;
     } else {
-      const canceledBeforeEnd = !this.cujTimestampIsGreaterThan(
+      const canceledBeforeEnd = this.cujTimestampIsGreaterThan(
         endTimestamp,
         cancelTimestamp,
       );
@@ -233,30 +233,30 @@ export class TracesParserCujs extends AbstractTracesParser<PropertyTreeNode> {
     }
 
     if (!closingEvent) {
-      throw Error('Should have found one matching closing event');
+      throw new Error('Should have found one matching closing event for CUJ');
     }
 
     return closingEvent;
   }
 
   private makeCujPropertyTree(cuj: Cuj): PropertyTreeNode {
-    return new PropertyTreeBuilderFromProto()
+    const tree = new PropertyTreeBuilderFromProto()
       .setData(cuj)
       .setRootId('CujTrace')
       .setRootName('cuj')
       .build();
+
+    new SetFormatters(
+      undefined,
+      new Map([['cujType', CUJ_TYPE_FORMATTER]]),
+    ).apply(tree);
+    return tree;
   }
 }
 
 interface Cuj {
-  startCujType: CujType;
-  startTimestamp: CujTimestamp;
-  endTimestamp: CujTimestamp;
+  cujType: number;
+  startTimestamp: Timestamp;
+  endTimestamp: Timestamp;
   canceled: boolean;
 }
-
-interface CujTimestamp {
-  unixNanos: bigint;
-  elapsedNanos: bigint;
-  systemUptimeNanos: bigint;
-}
diff --git a/tools/winscope/src/parsers/events/traces_parser_cujs_test.ts b/tools/winscope/src/parsers/events/traces_parser_cujs_test.ts
index 724bde4d8..3d3e5817f 100644
--- a/tools/winscope/src/parsers/events/traces_parser_cujs_test.ts
+++ b/tools/winscope/src/parsers/events/traces_parser_cujs_test.ts
@@ -18,12 +18,16 @@ import {assertDefined} from 'common/assert_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {UnitTestUtils} from 'test/unit/utils';
+import {CoarseVersion} from 'trace/coarse_version';
 import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
+import {
+  CUJ_TYPE_FORMATTER,
+  DEFAULT_PROPERTY_FORMATTER,
+} from 'trace/tree_node/formatters';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {CujType} from './cuj_type';
 
-describe('ParserCujs', () => {
+describe('TracesParserCujs', () => {
   let parser: Parser<PropertyTreeNode>;
 
   beforeAll(async () => {
@@ -37,6 +41,14 @@ describe('ParserCujs', () => {
     expect(parser.getTraceType()).toEqual(TraceType.CUJS);
   });
 
+  it('has expected coarse version', () => {
+    expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LEGACY);
+  });
+
+  it('has expected descriptors', () => {
+    expect(parser.getDescriptors()).toEqual(['eventlog.winscope']);
+  });
+
   it('provides timestamps', () => {
     const expected = [
       TimestampConverterUtils.makeRealTimestamp(1681207048025446000n),
@@ -58,26 +70,27 @@ describe('ParserCujs', () => {
       .setIsRoot(true)
       .setChildren([
         {
-          name: 'startCujType',
-          value: CujType.CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS,
+          name: 'cujType',
+          value: 66,
+          formatter: CUJ_TYPE_FORMATTER,
         },
         {
           name: 'startTimestamp',
-          children: [
-            {name: 'unixNanos', value: 1681207048025580000n},
-            {name: 'elapsedNanos', value: 2661012903966n},
-            {name: 'systemUptimeNanos', value: 2661012904007n},
-          ],
+          value:
+            TimestampConverterUtils.TIMESTAMP_CONVERTER.makeTimestampFromNs(
+              1681207048025580000n,
+            ),
+          formatter: DEFAULT_PROPERTY_FORMATTER,
         },
         {
           name: 'endTimestamp',
-          children: [
-            {name: 'unixNanos', value: 1681207048656617000n},
-            {name: 'elapsedNanos', value: 2661643941035n},
-            {name: 'systemUptimeNanos', value: 266164394123n},
-          ],
+          value:
+            TimestampConverterUtils.TIMESTAMP_CONVERTER.makeTimestampFromNs(
+              1681207048643085000n,
+            ),
+          formatter: DEFAULT_PROPERTY_FORMATTER,
         },
-        {name: 'canceled', value: false},
+        {name: 'canceled', value: true, formatter: DEFAULT_PROPERTY_FORMATTER},
       ])
       .build();
 
diff --git a/tools/winscope/src/parsers/hierarchy_tree_builder.ts b/tools/winscope/src/parsers/hierarchy_tree_builder.ts
index 53f755c68..78aa783be 100644
--- a/tools/winscope/src/parsers/hierarchy_tree_builder.ts
+++ b/tools/winscope/src/parsers/hierarchy_tree_builder.ts
@@ -40,11 +40,11 @@ export abstract class HierarchyTreeBuilder {
 
   build(): HierarchyTreeNode {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set');
     }
 
     if (!this.children) {
-      throw Error('children not set');
+      throw new Error('children not set');
     }
 
     const identifierToChildren = this.buildIdentifierToChildrenMap(
diff --git a/tools/winscope/src/parsers/input/perfetto/abstract_input_event_parser.ts b/tools/winscope/src/parsers/input/perfetto/abstract_input_event_parser.ts
index 4f5d825c5..74a7236e9 100644
--- a/tools/winscope/src/parsers/input/perfetto/abstract_input_event_parser.ts
+++ b/tools/winscope/src/parsers/input/perfetto/abstract_input_event_parser.ts
@@ -21,9 +21,16 @@ import {TranslateIntDef} from 'parsers/operations/translate_intdef';
 import {AbstractParser} from 'parsers/perfetto/abstract_parser';
 import {FakeProtoBuilder} from 'parsers/perfetto/fake_proto_builder';
 import {FakeProtoTransformer} from 'parsers/perfetto/fake_proto_transformer';
+import {Utils} from 'parsers/perfetto/utils';
 import {TamperedMessageType} from 'parsers/tampered_message_type';
 import root from 'protos/input/latest/json';
 import {perfetto} from 'protos/input/latest/static';
+import {
+  CustomQueryParserResultTypeMap,
+  CustomQueryType,
+  VisitableParserCustomQuery,
+} from 'trace/custom_query';
+import {EntriesRange} from 'trace/index_types';
 import {TraceFile} from 'trace/trace_file';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
@@ -105,4 +112,46 @@ export abstract class AbstractInputEventParser extends AbstractParser<PropertyTr
       operation.apply(tree);
     });
   }
+
+  override async customQuery<Q extends CustomQueryType>(
+    type: Q,
+    entriesRange: EntriesRange,
+  ): Promise<CustomQueryParserResultTypeMap[Q]> {
+    return new VisitableParserCustomQuery(type)
+      .visit(CustomQueryType.VSYNCID, async () => {
+        return Utils.queryVsyncId(
+          this.traceProcessor,
+          this.getTableName(),
+          this.entryIndexToRowIdMap,
+          entriesRange,
+          AbstractInputEventParser.createVsyncIdQuery,
+        );
+      })
+      .getResult();
+  }
+
+  // Use a custom sql query to get the vsync_id of the first dispatch
+  // entry associated with an input event, if any.
+  private static createVsyncIdQuery(
+    tableName: string,
+    minRowId: number,
+    maxRowId: number,
+  ): string {
+    return `
+      SELECT
+        tbl.id AS id,
+        args.key,
+        args.value_type,
+        args.int_value
+      FROM ${tableName} AS tbl
+      INNER JOIN ${AbstractInputEventParser.DispatchTableName} AS d
+          ON tbl.event_id = d.event_id
+      INNER JOIN args ON d.arg_set_id = args.arg_set_id
+      WHERE
+        tbl.id BETWEEN ${minRowId} AND ${maxRowId}
+        AND args.key = 'vsync_id'
+      GROUP BY tbl.id
+      ORDER BY tbl.id;
+    `;
+  }
 }
diff --git a/tools/winscope/src/parsers/input/perfetto/parser_key_event_test.ts b/tools/winscope/src/parsers/input/perfetto/parser_key_event_test.ts
index ac744b80b..234e16093 100644
--- a/tools/winscope/src/parsers/input/perfetto/parser_key_event_test.ts
+++ b/tools/winscope/src/parsers/input/perfetto/parser_key_event_test.ts
@@ -15,8 +15,10 @@
  */
 import {assertDefined} from 'common/assert_utils';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
+import {CustomQueryType} from 'trace/custom_query';
 import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -46,8 +48,8 @@ describe('Perfetto ParserKeyEvent', () => {
     expect(timestamps.length).toEqual(2);
 
     const expected = [
-      TimestampConverterUtils.makeRealTimestamp(1718163697925999410n),
-      TimestampConverterUtils.makeRealTimestamp(1718163698025920410n),
+      TimestampConverterUtils.makeRealTimestamp(1718386905115026232n),
+      TimestampConverterUtils.makeRealTimestamp(1718386905123057319n),
     ];
     expect(timestamps).toEqual(expected);
   });
@@ -61,7 +63,7 @@ describe('Perfetto ParserKeyEvent', () => {
     const entry = await parser.getEntry(0);
     const keyEvent = assertDefined(entry.getChildByName('keyEvent'));
 
-    expect(keyEvent?.getChildByName('eventId')?.getValue()).toEqual(263024268);
+    expect(keyEvent?.getChildByName('eventId')?.getValue()).toEqual(759309047);
     expect(keyEvent?.getChildByName('action')?.formattedValue()).toEqual(
       'ACTION_DOWN',
     );
@@ -92,12 +94,24 @@ describe('Perfetto ParserKeyEvent', () => {
         ?.getChildByName('0')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(461));
+    ).toEqual(212n);
     expect(
       windowDispatchEvents
         ?.getChildByName('1')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(0));
+    ).toEqual(0n);
+  });
+
+  it('supports VSYNCID custom query', async () => {
+    const trace = new TraceBuilder()
+      .setType(TraceType.INPUT_KEY_EVENT)
+      .setParser(parser)
+      .build();
+    const entries = await trace
+      .sliceEntries(0, 2)
+      .customQuery(CustomQueryType.VSYNCID);
+    const values = entries.map((entry) => entry.getValue());
+    expect(values).toEqual([89114n, 89115n]);
   });
 });
diff --git a/tools/winscope/src/parsers/input/perfetto/parser_motion_event_test.ts b/tools/winscope/src/parsers/input/perfetto/parser_motion_event_test.ts
index 98bd18cb4..591bd88db 100644
--- a/tools/winscope/src/parsers/input/perfetto/parser_motion_event_test.ts
+++ b/tools/winscope/src/parsers/input/perfetto/parser_motion_event_test.ts
@@ -15,8 +15,10 @@
  */
 import {assertDefined} from 'common/assert_utils';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
+import {CustomQueryType} from 'trace/custom_query';
 import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -43,13 +45,15 @@ describe('Perfetto ParserMotionEvent', () => {
   it('provides timestamps', () => {
     const timestamps = assertDefined(parser.getTimestamps());
 
-    expect(timestamps.length).toEqual(4);
+    expect(timestamps.length).toEqual(6);
 
     const expected = [
-      TimestampConverterUtils.makeRealTimestamp(1718163696245804410n),
-      TimestampConverterUtils.makeRealTimestamp(1718163696254923410n),
-      TimestampConverterUtils.makeRealTimestamp(1718163696262592410n),
-      TimestampConverterUtils.makeRealTimestamp(1718163696271081410n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903800330430n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903800330430n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903821511338n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903827304592n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903836681382n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903841727281n),
     ];
     expect(timestamps).toEqual(expected);
   });
@@ -64,7 +68,7 @@ describe('Perfetto ParserMotionEvent', () => {
     const motionEvent = assertDefined(entry.getChildByName('motionEvent'));
 
     expect(motionEvent?.getChildByName('eventId')?.getValue()).toEqual(
-      856299947,
+      330184796,
     );
     expect(motionEvent?.getChildByName('action')?.formattedValue()).toEqual(
       'ACTION_DOWN',
@@ -114,7 +118,7 @@ describe('Perfetto ParserMotionEvent', () => {
         ?.getChildByName('0')
         ?.getChildByName('value')
         ?.getValue(),
-    ).toEqual(350);
+    ).toEqual(431);
 
     expect(
       firstPointer
@@ -130,7 +134,7 @@ describe('Perfetto ParserMotionEvent', () => {
         ?.getChildByName('1')
         ?.getChildByName('value')
         ?.getValue(),
-    ).toEqual(370);
+    ).toEqual(624);
   });
 
   it('merges motion event with all associated dispatch events', async () => {
@@ -139,42 +143,48 @@ describe('Perfetto ParserMotionEvent', () => {
       entry.getChildByName('windowDispatchEvents'),
     );
 
-    expect(windowDispatchEvents?.getAllChildren().length).toEqual(6);
+    expect(windowDispatchEvents?.getAllChildren().length).toEqual(5);
     expect(
       windowDispatchEvents
         ?.getChildByName('0')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(292));
+    ).toEqual(212n);
     expect(
       windowDispatchEvents
         ?.getChildByName('1')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(247));
+    ).toEqual(64n);
     expect(
       windowDispatchEvents
         ?.getChildByName('2')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(240));
+    ).toEqual(82n);
     expect(
       windowDispatchEvents
         ?.getChildByName('3')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(370));
+    ).toEqual(75n);
     expect(
       windowDispatchEvents
         ?.getChildByName('4')
         ?.getChildByName('windowId')
         ?.getValue(),
-    ).toEqual(BigInt(229));
-    expect(
-      windowDispatchEvents
-        ?.getChildByName('5')
-        ?.getChildByName('windowId')
-        ?.getValue(),
-    ).toEqual(BigInt(0));
+    ).toEqual(0n);
+  });
+
+  it('supports VSYNCID custom query', async () => {
+    const trace = new TraceBuilder()
+      .setType(TraceType.INPUT_MOTION_EVENT)
+      .setParser(parser)
+      .build();
+    const entries = await trace
+      .sliceEntries(1, 4)
+      .customQuery(CustomQueryType.VSYNCID);
+    const values = entries.map((entry) => entry.getValue());
+    expect(values).toEqual([89110n, 89111n, 89112n]);
   });
 });
diff --git a/tools/winscope/src/parsers/input/perfetto/traces_parser_input.ts b/tools/winscope/src/parsers/input/perfetto/traces_parser_input.ts
new file mode 100644
index 000000000..900d2e4a6
--- /dev/null
+++ b/tools/winscope/src/parsers/input/perfetto/traces_parser_input.ts
@@ -0,0 +1,221 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined, assertTrue} from 'common/assert_utils';
+import {ParserTimestampConverter} from 'common/timestamp_converter';
+import {AbstractTracesParser} from 'parsers/traces/abstract_traces_parser';
+import {CoarseVersion} from 'trace/coarse_version';
+import {
+  CustomQueryParserResultTypeMap,
+  CustomQueryType,
+  VisitableParserCustomQuery,
+} from 'trace/custom_query';
+import {EntriesRange, Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+
+type OriginalTraceIndex = number;
+
+export class TracesParserInput extends AbstractTracesParser<PropertyTreeNode> {
+  private readonly keyEventTrace: Trace<PropertyTreeNode> | undefined;
+  private readonly motionEventTrace: Trace<PropertyTreeNode> | undefined;
+  private readonly descriptors: string[];
+  private mergedEntryIndexMap:
+    | Array<[OriginalTraceIndex, TraceType]>
+    | undefined;
+
+  constructor(traces: Traces, timestampConverter: ParserTimestampConverter) {
+    super(timestampConverter);
+    this.keyEventTrace = traces.getTrace(TraceType.INPUT_KEY_EVENT);
+    this.motionEventTrace = traces.getTrace(TraceType.INPUT_MOTION_EVENT);
+    this.descriptors = this.keyEventTrace?.getDescriptors() ?? [];
+    this.motionEventTrace?.getDescriptors().forEach((d) => {
+      if (!this.descriptors.includes(d)) {
+        this.descriptors.push(d);
+      }
+    });
+  }
+
+  override async parse() {
+    if (
+      this.keyEventTrace === undefined &&
+      this.motionEventTrace === undefined
+    ) {
+      throw new Error('Missing input traces');
+    }
+    this.mergedEntryIndexMap = TracesParserInput.createMergedEntryIndexMap(
+      this.keyEventTrace,
+      this.motionEventTrace,
+    );
+    await this.createTimestamps();
+  }
+
+  override getCoarseVersion(): CoarseVersion {
+    return CoarseVersion.LATEST;
+  }
+
+  override getLengthEntries(): number {
+    return assertDefined(this.mergedEntryIndexMap).length;
+  }
+
+  override getEntry(index: number): Promise<PropertyTreeNode> {
+    const [subIndex, type] = assertDefined(this.mergedEntryIndexMap)[index];
+    const trace = assertDefined(
+      type === TraceType.INPUT_KEY_EVENT
+        ? this.keyEventTrace
+        : this.motionEventTrace,
+    );
+    return trace.getEntry(subIndex).getValue();
+  }
+
+  override getDescriptors(): string[] {
+    return this.descriptors;
+  }
+
+  override getTraceType(): TraceType {
+    return TraceType.INPUT_EVENT_MERGED;
+  }
+
+  override getRealToMonotonicTimeOffsetNs(): bigint | undefined {
+    return undefined;
+  }
+
+  override getRealToBootTimeOffsetNs(): bigint | undefined {
+    return undefined;
+  }
+
+  override async createTimestamps() {
+    this.timestamps = [];
+    assertDefined(this.mergedEntryIndexMap).forEach(([index, traceType]) => {
+      const trace = assertDefined(
+        traceType === TraceType.INPUT_KEY_EVENT
+          ? this.keyEventTrace
+          : this.motionEventTrace,
+      );
+      this.timestamps?.push(
+        assertDefined(trace.getParser().getTimestamps())[index],
+      );
+    });
+  }
+
+  // Given two traces, merge the two traces into one based on their timestamps.
+  // Returns the mapping from the index of the merged trace to the index in the
+  // sub-trace.
+  private static createMergedEntryIndexMap(
+    trace1: Trace<PropertyTreeNode> | undefined,
+    trace2: Trace<PropertyTreeNode> | undefined,
+  ): Array<[OriginalTraceIndex, TraceType]> {
+    // We are assuming the parsers entries are sorted by timestamps.
+    const timestamps1 = trace1?.getParser().getTimestamps() ?? [];
+    const timestamps2 = trace2?.getParser().getTimestamps() ?? [];
+    const type1 = trace1?.type ?? TraceType.INPUT_EVENT_MERGED;
+    const type2 = trace2?.type ?? TraceType.INPUT_EVENT_MERGED;
+    const mergedIndices: Array<[OriginalTraceIndex, TraceType]> = [];
+
+    let curIndex1 = 0;
+    let curIndex2 = 0;
+    while (curIndex1 < timestamps1.length && curIndex2 < timestamps2.length) {
+      if (
+        timestamps1[curIndex1].getValueNs() <=
+        timestamps2[curIndex2].getValueNs()
+      ) {
+        mergedIndices.push([curIndex1++, type1]);
+        continue;
+      }
+      mergedIndices.push([curIndex2++, type2]);
+    }
+    while (curIndex1 < timestamps1.length) {
+      mergedIndices.push([curIndex1++, type1]);
+    }
+    while (curIndex2 < timestamps2.length) {
+      mergedIndices.push([curIndex2++, type2]);
+    }
+
+    return mergedIndices;
+  }
+
+  override async customQuery<Q extends CustomQueryType>(
+    type: Q,
+    entriesRange: EntriesRange,
+  ): Promise<CustomQueryParserResultTypeMap[Q]> {
+    return new VisitableParserCustomQuery(type)
+      .visit(CustomQueryType.VSYNCID, async () => {
+        assertTrue(entriesRange.start < entriesRange.end);
+
+        const {keyRange, motionRange} = this.getSubTraceRanges(entriesRange);
+
+        let keyResult: Array<bigint> = [];
+        if (keyRange !== undefined) {
+          keyResult =
+            (await this.keyEventTrace
+              ?.getParser()
+              .customQuery(CustomQueryType.VSYNCID, keyRange)) ?? [];
+        }
+
+        let motionResult: Array<bigint> = [];
+        if (motionRange !== undefined) {
+          motionResult =
+            (await this.motionEventTrace
+              ?.getParser()
+              .customQuery(CustomQueryType.VSYNCID, motionRange)) ?? [];
+        }
+
+        const mergedResult: Array<bigint> = [];
+        let curKeyIndex = 0;
+        let curMotionIndex = 0;
+        for (let i = entriesRange.start; i < entriesRange.end; i++) {
+          if (
+            assertDefined(this.mergedEntryIndexMap)[i][1] ===
+            TraceType.INPUT_KEY_EVENT
+          ) {
+            mergedResult.push(keyResult[curKeyIndex++]);
+          } else {
+            mergedResult.push(motionResult[curMotionIndex++]);
+          }
+        }
+        return mergedResult;
+      })
+      .getResult();
+  }
+
+  // Given the entries range for the merged trace, get the entries ranges for
+  // the individual sub-traces that make up this merged trace.
+  private getSubTraceRanges(entriesRange: EntriesRange): {
+    keyRange?: EntriesRange;
+    motionRange?: EntriesRange;
+  } {
+    const ranges: {keyRange?: EntriesRange; motionRange?: EntriesRange} = {};
+
+    for (let i = entriesRange.start; i < entriesRange.end; i++) {
+      const [subEventIndex, type] = assertDefined(this.mergedEntryIndexMap)[i];
+      if (type === TraceType.INPUT_KEY_EVENT) {
+        if (ranges.keyRange === undefined) {
+          ranges.keyRange = {start: subEventIndex, end: subEventIndex + 1};
+        } else {
+          ranges.keyRange.end = subEventIndex + 1;
+        }
+      } else {
+        if (ranges.motionRange === undefined) {
+          ranges.motionRange = {start: subEventIndex, end: subEventIndex + 1};
+        } else {
+          ranges.motionRange.end = subEventIndex + 1;
+        }
+      }
+    }
+    return ranges;
+  }
+}
diff --git a/tools/winscope/src/parsers/input/perfetto/traces_parser_input_test.ts b/tools/winscope/src/parsers/input/perfetto/traces_parser_input_test.ts
new file mode 100644
index 000000000..7d5f809c9
--- /dev/null
+++ b/tools/winscope/src/parsers/input/perfetto/traces_parser_input_test.ts
@@ -0,0 +1,109 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {UnitTestUtils} from 'test/unit/utils';
+import {CoarseVersion} from 'trace/coarse_version';
+import {CustomQueryType} from 'trace/custom_query';
+import {Parser} from 'trace/parser';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+
+describe('TracesParserInput', () => {
+  let parser: Parser<PropertyTreeNode>;
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
+  beforeEach(async () => {
+    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+    parser = (await UnitTestUtils.getTracesParser([
+      'traces/perfetto/input-events.perfetto-trace',
+    ])) as Parser<PropertyTreeNode>;
+    userNotifierChecker.reset();
+  });
+
+  it('has expected trace type', () => {
+    expect(parser.getTraceType()).toEqual(TraceType.INPUT_EVENT_MERGED);
+  });
+
+  it('has expected coarse version', () => {
+    expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LATEST);
+  });
+
+  it('has expected descriptors', () => {
+    expect(parser.getDescriptors()).toEqual(['input-events.perfetto-trace']);
+  });
+
+  it('provides timestamps', () => {
+    const timestamps = assertDefined(parser.getTimestamps());
+    const expected = [
+      TimestampConverterUtils.makeRealTimestamp(1718386903800330430n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903800330430n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903821511338n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903827304592n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903836681382n),
+      TimestampConverterUtils.makeRealTimestamp(1718386903841727281n),
+      TimestampConverterUtils.makeRealTimestamp(1718386905115026232n),
+      TimestampConverterUtils.makeRealTimestamp(1718386905123057319n),
+    ];
+    expect(timestamps).toEqual(expected);
+  });
+
+  it('provides correct entries from individual event traces', async () => {
+    const keyEntry = await parser.getEntry(6);
+    const keyEvent = assertDefined(keyEntry.getChildByName('keyEvent'));
+    expect(keyEvent?.getChildByName('eventId')?.getValue()).toEqual(759309047);
+
+    const motionEntry = await parser.getEntry(0);
+    const motionEvent = assertDefined(
+      motionEntry.getChildByName('motionEvent'),
+    );
+    expect(motionEvent?.getChildByName('eventId')?.getValue()).toEqual(
+      330184796,
+    );
+  });
+
+  it('supports VSYNCID custom query', async () => {
+    const trace = new TraceBuilder()
+      .setType(TraceType.INPUT_EVENT_MERGED)
+      .setParser(parser)
+      .build();
+    const entries = await trace
+      .sliceEntries(4, 7)
+      .customQuery(CustomQueryType.VSYNCID);
+    const values = entries.map((entry) => entry.getValue());
+    expect(values).toEqual([89113n, 89113n, 89114n]);
+    userNotifierChecker.expectNone();
+  });
+
+  it('supports VSYNCID custom query with missing vsync_ids', async () => {
+    const missingVsyncIdsParser = (await UnitTestUtils.getTracesParser([
+      'traces/perfetto/input-missing-vsync-ids.perfetto-trace',
+    ])) as Parser<PropertyTreeNode>;
+    const trace = new TraceBuilder()
+      .setType(TraceType.INPUT_EVENT_MERGED)
+      .setParser(missingVsyncIdsParser)
+      .build();
+    const entries = await trace.customQuery(CustomQueryType.VSYNCID);
+    expect(entries).toHaveSize(missingVsyncIdsParser.getLengthEntries());
+  });
+});
diff --git a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_clients.ts b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_clients.ts
index 545ce5dc7..83ad7e793 100644
--- a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_clients.ts
+++ b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_clients.ts
@@ -94,7 +94,7 @@ class ParserInputMethodClients extends AbstractParser<HierarchyTreeNode> {
       entry.elapsedRealtimeNanos === undefined ||
       entry.elapsedRealtimeNanos === null
     ) {
-      throw Error('Missing elapsedRealtimeNanos on entry');
+      throw new Error('Missing elapsedRealtimeNanos on IME Clients entry');
     }
 
     return ParserInputMethodClients.HIERARCHY_TREE_FACTORY.makeHierarchyTree(
diff --git a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_manager_service.ts b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_manager_service.ts
index 8007e4a99..e6d31c1cb 100644
--- a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_manager_service.ts
+++ b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_manager_service.ts
@@ -95,7 +95,9 @@ class ParserInputMethodManagerService extends AbstractParser<HierarchyTreeNode>
       entry.elapsedRealtimeNanos === undefined ||
       entry.elapsedRealtimeNanos === null
     ) {
-      throw Error('Missing elapsedRealtimeNanos on entry');
+      throw new Error(
+        'Missing elapsedRealtimeNanos on IME Manager Service entry',
+      );
     }
     return ParserInputMethodManagerService.HIERARCHY_TREE_FACTORY.makeHierarchyTree(
       entry,
diff --git a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_service.ts b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_service.ts
index 2fa409183..e26af12c5 100644
--- a/tools/winscope/src/parsers/input_method/legacy/parser_input_method_service.ts
+++ b/tools/winscope/src/parsers/input_method/legacy/parser_input_method_service.ts
@@ -95,7 +95,7 @@ class ParserInputMethodService extends AbstractParser<HierarchyTreeNode> {
       entry.elapsedRealtimeNanos === undefined ||
       entry.elapsedRealtimeNanos === null
     ) {
-      throw Error('Missing elapsedRealtimeNanos on entry');
+      throw new Error('Missing elapsedRealtimeNanos on IME Service entry');
     }
     return ParserInputMethodService.HIERARCHY_TREE_FACTORY.makeHierarchyTree(
       entry,
diff --git a/tools/winscope/src/parsers/legacy/parser_common_test.ts b/tools/winscope/src/parsers/legacy/parser_common_test.ts
index 48945dbce..4f2257fa3 100644
--- a/tools/winscope/src/parsers/legacy/parser_common_test.ts
+++ b/tools/winscope/src/parsers/legacy/parser_common_test.ts
@@ -18,7 +18,6 @@ import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
-import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {ParserFactory} from './parser_factory';
 
@@ -40,12 +39,29 @@ describe('Parser', () => {
   });
 
   it('is robust to trace with no entries', async () => {
-    const parser = await UnitTestUtils.getParser(
-      'traces/no_entries_InputMethodClients.pb',
+    const trace = new TraceFile(
+      await UnitTestUtils.getFixtureFile(
+        'traces/no_entries_InputMethodClients.pb',
+      ),
+      undefined,
     );
+    const parsers = await new ParserFactory().createParsers(
+      [trace],
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    expect(parsers.length).toEqual(0);
+  });
 
-    expect(parser.getTraceType()).toEqual(TraceType.INPUT_METHOD_CLIENTS);
-    expect(parser.getTimestamps()).toEqual([]);
+  it('is robust to view capture trace with no entries', async () => {
+    const trace = new TraceFile(
+      await UnitTestUtils.getFixtureFile('traces/no_entries_view_capture.vc'),
+      undefined,
+    );
+    const parsers = await new ParserFactory().createParsers(
+      [trace],
+      TimestampConverterUtils.TIMESTAMP_CONVERTER,
+    );
+    expect(parsers.length).toEqual(0);
   });
 
   describe('real timestamp', () => {
@@ -57,6 +73,10 @@ describe('Parser', () => {
       )) as Parser<HierarchyTreeNode>;
     });
 
+    it('has expected descriptors', () => {
+      expect(parser.getDescriptors()).toEqual(['WindowManager.pb']);
+    });
+
     it('provides timestamps', () => {
       const expected = [
         TimestampConverterUtils.makeRealTimestamp(1659107089075566202n),
diff --git a/tools/winscope/src/parsers/legacy/parser_factory.ts b/tools/winscope/src/parsers/legacy/parser_factory.ts
index bc31d992f..9ad701256 100644
--- a/tools/winscope/src/parsers/legacy/parser_factory.ts
+++ b/tools/winscope/src/parsers/legacy/parser_factory.ts
@@ -13,17 +13,21 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+import {assertTrue} from 'common/assert_utils';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
+import {UserNotifier} from 'common/user_notifier';
 import {ProgressListener} from 'messaging/progress_listener';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
-import {UnsupportedFileFormat} from 'messaging/user_warnings';
+import {
+  InvalidLegacyTrace,
+  UnsupportedFileFormat,
+} from 'messaging/user_warnings';
 import {ParserEventLog} from 'parsers/events/parser_eventlog';
 import {FileAndParser} from 'parsers/file_and_parser';
 import {ParserInputMethodClients} from 'parsers/input_method/legacy/parser_input_method_clients';
 import {ParserInputMethodManagerService} from 'parsers/input_method/legacy/parser_input_method_manager_service';
 import {ParserInputMethodService} from 'parsers/input_method/legacy/parser_input_method_service';
 import {ParserProtoLog} from 'parsers/protolog/legacy/parser_protolog';
-import {ParserScreenshot} from 'parsers/screen_recording/parser_screenshot';
+import {ParserScreenshot} from 'parsers/screenshot/parser_screenshot';
 import {ParserScreenRecording} from 'parsers/screen_recording/parser_screen_recording';
 import {ParserScreenRecordingLegacy} from 'parsers/screen_recording/parser_screen_recording_legacy';
 import {ParserSurfaceFlinger} from 'parsers/surface_flinger/legacy/parser_surface_flinger';
@@ -31,8 +35,8 @@ import {ParserTransactions} from 'parsers/transactions/legacy/parser_transaction
 import {ParserTransitionsShell} from 'parsers/transitions/legacy/parser_transitions_shell';
 import {ParserTransitionsWm} from 'parsers/transitions/legacy/parser_transitions_wm';
 import {ParserViewCapture} from 'parsers/view_capture/legacy/parser_view_capture';
-import {ParserWindowManager} from 'parsers/window_manager/parser_window_manager';
-import {ParserWindowManagerDump} from 'parsers/window_manager/parser_window_manager_dump';
+import {ParserWindowManager} from 'parsers/window_manager/legacy/parser_window_manager';
+import {ParserWindowManagerDump} from 'parsers/window_manager/legacy/parser_window_manager_dump';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
 
@@ -59,7 +63,6 @@ export class ParserFactory {
     traceFiles: TraceFile[],
     timestampConverter: ParserTimestampConverter,
     progressListener?: ProgressListener,
-    notificationListener?: UserNotificationsListener,
   ): Promise<FileAndParser[]> {
     const parsers = new Array<{file: TraceFile; parser: Parser<object>}>();
 
@@ -78,22 +81,34 @@ export class ParserFactory {
           hasFoundParser = true;
 
           if (p instanceof ParserViewCapture) {
-            p.getWindowParsers().forEach((subParser) =>
-              parsers.push(new FileAndParser(traceFile, subParser)),
-            );
+            p.getWindowParsers().forEach((subParser) => {
+              assertTrue(
+                subParser.getLengthEntries() > 0,
+                () => 'Trace has no entries',
+              );
+              parsers.push(new FileAndParser(traceFile, subParser));
+            });
           } else {
+            assertTrue(p.getLengthEntries() > 0, () => 'Trace has no entries');
             parsers.push({file: traceFile, parser: p});
           }
           break;
         } catch (error) {
+          if (hasFoundParser) {
+            UserNotifier.add(
+              new InvalidLegacyTrace(
+                traceFile.getDescriptor(),
+                (error as Error).message,
+              ),
+            );
+            break;
+          }
           // skip current parser
         }
       }
 
       if (!hasFoundParser) {
-        notificationListener?.onNotifications([
-          new UnsupportedFileFormat(traceFile.getDescriptor()),
-        ]);
+        UserNotifier.add(new UnsupportedFileFormat(traceFile.getDescriptor()));
       }
     }
     return parsers;
diff --git a/tools/winscope/src/parsers/legacy/parsing_utils.ts b/tools/winscope/src/parsers/legacy/parsing_utils.ts
index 334ef92ff..ddd394dd8 100644
--- a/tools/winscope/src/parsers/legacy/parsing_utils.ts
+++ b/tools/winscope/src/parsers/legacy/parsing_utils.ts
@@ -27,7 +27,7 @@ export class ParsingUtils {
         traceBuffer.slice(0, magicNumber.length),
       );
       if (!bufferContainsMagicNumber) {
-        throw TypeError("buffer doesn't contain expected magic number");
+        throw new TypeError("buffer doesn't contain expected magic number");
       }
     }
   }
diff --git a/tools/winscope/src/parsers/operations/set_formatters_test.ts b/tools/winscope/src/parsers/operations/set_formatters_test.ts
index c0b994bf3..0beeb6c63 100644
--- a/tools/winscope/src/parsers/operations/set_formatters_test.ts
+++ b/tools/winscope/src/parsers/operations/set_formatters_test.ts
@@ -15,7 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {TransformType} from 'parsers/surface_flinger/transform_utils';
+import {TransformTypeFlags} from 'parsers/surface_flinger/transform_utils';
 import {
   TamperedMessageType,
   TamperedProtoField,
@@ -198,7 +198,7 @@ describe('SetFormatters', () => {
       .setName('node')
       .build();
     propertyRoot.addOrReplaceChild(
-      TreeNodeUtils.makeTransformNode(TransformType.EMPTY),
+      TreeNodeUtils.makeTransformNode(TransformTypeFlags.EMPTY),
     );
     operation = new SetFormatters();
     operation.apply(propertyRoot);
diff --git a/tools/winscope/src/parsers/operations/translate_intdef.ts b/tools/winscope/src/parsers/operations/translate_intdef.ts
index bed1ab0c6..ad84cf314 100644
--- a/tools/winscope/src/parsers/operations/translate_intdef.ts
+++ b/tools/winscope/src/parsers/operations/translate_intdef.ts
@@ -167,5 +167,7 @@ export class TranslateIntDef implements Operation<PropertyTreeNode> {
       'android.view.WindowInsets.Type.InsetsType',
     'InsetsSourceConsumerProto.typeNumber':
       'android.view.WindowInsets.Type.InsetsType',
+    'WindowStateProto.requestedVisibleTypes':
+      'android.view.WindowInsets.Type.InsetsType',
   };
 }
diff --git a/tools/winscope/src/parsers/perfetto/abstract_parser.ts b/tools/winscope/src/parsers/perfetto/abstract_parser.ts
index 0951cddf6..952e339ac 100644
--- a/tools/winscope/src/parsers/perfetto/abstract_parser.ts
+++ b/tools/winscope/src/parsers/perfetto/abstract_parser.ts
@@ -15,7 +15,7 @@
  */
 
 import {assertDefined, assertTrue} from 'common/assert_utils';
-import {Timestamp} from 'common/time';
+import {INVALID_TIME_NS, Timestamp} from 'common/time';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
 import {CoarseVersion} from 'trace/coarse_version';
 import {
@@ -83,6 +83,9 @@ export abstract class AbstractParser<T> implements Parser<T> {
 
   createTimestamps() {
     this.timestamps = this.bootTimeTimestampsNs.map((ns) => {
+      if (ns === INVALID_TIME_NS) {
+        return this.timestampConverter.makeZeroTimestamp();
+      }
       return this.timestampConverter.makeTimestampFromBootTimeNs(ns);
     });
   }
diff --git a/tools/winscope/src/parsers/perfetto/abstract_parser_test.ts b/tools/winscope/src/parsers/perfetto/abstract_parser_test.ts
index 8dfb95975..f922f5701 100644
--- a/tools/winscope/src/parsers/perfetto/abstract_parser_test.ts
+++ b/tools/winscope/src/parsers/perfetto/abstract_parser_test.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 import {UnitTestUtils} from 'test/unit/utils';
+import {TraceType} from 'trace/trace_type';
 
 describe('Perfetto AbstractParser', () => {
   it('fails parsing if there are no trace entries', async () => {
@@ -22,4 +23,12 @@ describe('Perfetto AbstractParser', () => {
     );
     expect(parsers.length).toEqual(0);
   });
+
+  it('has expected descriptors', async () => {
+    const parser = await UnitTestUtils.getPerfettoParser(
+      TraceType.SURFACE_FLINGER,
+      'traces/perfetto/layers_trace.perfetto-trace',
+    );
+    expect(parser.getDescriptors()).toEqual(['layers_trace.perfetto-trace']);
+  });
 });
diff --git a/tools/winscope/src/parsers/perfetto/parser_factory.ts b/tools/winscope/src/parsers/perfetto/parser_factory.ts
index 4e1698130..f8fb9f86d 100644
--- a/tools/winscope/src/parsers/perfetto/parser_factory.ts
+++ b/tools/winscope/src/parsers/perfetto/parser_factory.ts
@@ -17,8 +17,8 @@
 import {globalConfig} from 'common/global_config';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
 import {UrlUtils} from 'common/url_utils';
+import {UserNotifier} from 'common/user_notifier';
 import {ProgressListener} from 'messaging/progress_listener';
-import {UserNotificationsListener} from 'messaging/user_notifications_listener';
 import {InvalidPerfettoTrace} from 'messaging/user_warnings';
 import {ParserKeyEvent} from 'parsers/input/perfetto/parser_key_event';
 import {ParserMotionEvent} from 'parsers/input/perfetto/parser_motion_event';
@@ -30,6 +30,7 @@ import {ParserSurfaceFlinger} from 'parsers/surface_flinger/perfetto/parser_surf
 import {ParserTransactions} from 'parsers/transactions/perfetto/parser_transactions';
 import {ParserTransitions} from 'parsers/transitions/perfetto/parser_transitions';
 import {ParserViewCapture} from 'parsers/view_capture/perfetto/parser_view_capture';
+import {ParserWindowManager} from 'parsers/window_manager/perfetto/parser_window_manager';
 import {Parser} from 'trace/parser';
 import {TraceFile} from 'trace/trace_file';
 import {
@@ -48,6 +49,7 @@ export class ParserFactory {
     ParserTransactions,
     ParserTransitions,
     ParserViewCapture,
+    ParserWindowManager,
     ParserMotionEvent,
     ParserKeyEvent,
   ];
@@ -58,7 +60,6 @@ export class ParserFactory {
     traceFile: TraceFile,
     timestampConverter: ParserTimestampConverter,
     progressListener?: ProgressListener,
-    notificationListener?: UserNotificationsListener,
   ): Promise<Array<Parser<object>>> {
     const traceProcessor = await this.initializeTraceProcessor();
     for (
@@ -113,9 +114,9 @@ export class ParserFactory {
     }
 
     if (!hasFoundParser) {
-      notificationListener?.onNotifications([
+      UserNotifier.add(
         new InvalidPerfettoTrace(traceFile.getDescriptor(), errors),
-      ]);
+      );
     }
 
     return parsers;
diff --git a/tools/winscope/src/parsers/perfetto/utils.ts b/tools/winscope/src/parsers/perfetto/utils.ts
index 369be9a0b..fc9361f43 100644
--- a/tools/winscope/src/parsers/perfetto/utils.ts
+++ b/tools/winscope/src/parsers/perfetto/utils.ts
@@ -14,7 +14,9 @@
  * limitations under the License.
  */
 
-import {assertTrue} from 'common/assert_utils';
+import {assertDefined, assertTrue} from 'common/assert_utils';
+import {UserNotifier} from 'common/user_notifier';
+import {MissingVsyncId} from 'messaging/user_warnings';
 import {AbsoluteEntryIndex, EntriesRange} from 'trace/trace';
 import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
 import {FakeProto, FakeProtoBuilder} from './fake_proto_builder';
@@ -59,6 +61,11 @@ export class Utils {
     tableName: string,
     entryIndexToRowIdMap: number[],
     entriesRange: EntriesRange,
+    createVsyncIdQuery: (
+      tableName: string,
+      minRowId: number,
+      maxRowId: number,
+    ) => string = Utils.createDefaultVsyncIdQuery,
   ): Promise<Array<bigint>> {
     let minRowId = Number.MAX_VALUE;
     let maxRowId = Number.MIN_VALUE;
@@ -71,32 +78,41 @@ export class Utils {
       minRowId = Math.min(minRowId, rowId);
       maxRowId = Math.max(maxRowId, rowId);
     }
+    const numEntries = maxRowId - minRowId + 1;
 
-    const sql = `
-      SELECT
-        tbl.id,
-        args.key,
-        args.value_type,
-        args.int_value
-      FROM ${tableName} AS tbl
-      INNER JOIN args ON tbl.arg_set_id = args.arg_set_id
-      WHERE
-        tbl.id BETWEEN ${minRowId} AND ${maxRowId}
-        AND args.key = 'vsync_id'
-        ORDER BY tbl.id;
-    `;
-
+    const sql = createVsyncIdQuery(tableName, minRowId, maxRowId);
     const result = await traceProcessor.query(sql).waitAllRows();
 
     const vsyncIdOrderedByRow: Array<bigint> = [];
+    let curRowId = BigInt(minRowId);
     for (const it = result.iter({}); it.valid(); it.next()) {
+      const id = assertDefined(it.get('id') as bigint | undefined);
+      while (curRowId < id) {
+        // Handle missing table rows that don't have a vsync_id
+        vsyncIdOrderedByRow.push(-1n);
+        curRowId++;
+      }
+      assertTrue(
+        curRowId === id,
+        () => 'query for vsyncId contains duplicate rows with the same id',
+      );
       const value = it.get('int_value') as bigint | undefined;
       const valueType = it.get('value_type') as string;
       assertTrue(
         valueType === 'uint' || valueType === 'int',
-        () => 'expected vsyncid to have integer type',
+        () => 'expected vsync_id to have integer type',
       );
       vsyncIdOrderedByRow.push(value ?? -1n);
+      curRowId++;
+    }
+    while (curRowId <= maxRowId) {
+      // Handle missing table rows at the end of the trace
+      vsyncIdOrderedByRow.push(-1n);
+      curRowId++;
+    }
+
+    if (vsyncIdOrderedByRow.length !== numEntries) {
+      UserNotifier.add(new MissingVsyncId(tableName));
     }
 
     const vsyncIdOrderedByEntry: Array<bigint> = [];
@@ -112,4 +128,27 @@ export class Utils {
 
     return vsyncIdOrderedByEntry;
   }
+
+  // Creates a sql query for the vsync_id of the table rows that have
+  // an id in the range [minRowId, maxRowId]. The query may be created in a way
+  // where rows that don't have a vsync_id can be omitted from the query result.
+  private static createDefaultVsyncIdQuery(
+    tableName: string,
+    minRowId: number,
+    maxRowId: number,
+  ): string {
+    return `
+      SELECT
+        tbl.id AS id,
+        args.key,
+        args.value_type,
+        args.int_value
+      FROM ${tableName} AS tbl
+      INNER JOIN args ON tbl.arg_set_id = args.arg_set_id
+      WHERE
+        tbl.id BETWEEN ${minRowId} AND ${maxRowId}
+        AND args.key = 'vsync_id'
+        ORDER BY tbl.id;
+    `;
+  }
 }
diff --git a/tools/winscope/src/parsers/protolog/legacy/parser_protolog.ts b/tools/winscope/src/parsers/protolog/legacy/parser_protolog.ts
index bf44ac4ad..1b0aaa010 100644
--- a/tools/winscope/src/parsers/protolog/legacy/parser_protolog.ts
+++ b/tools/winscope/src/parsers/protolog/legacy/parser_protolog.ts
@@ -23,8 +23,8 @@ import root from 'protos/protolog/udc/json';
 import {com} from 'protos/protolog/udc/static';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import configJson32 from '../../../../configs/services.core.protolog32.json';
-import configJson64 from '../../../../configs/services.core.protolog64.json';
+import configJson32 from '../../../../configs/services.core.protolog32.json'; // eslint-disable-line no-restricted-imports
+import configJson64 from '../../../../configs/services.core.protolog64.json'; // eslint-disable-line no-restricted-imports
 
 class ParserProtoLog extends AbstractParser {
   private static readonly ProtoLogFileProto = root.lookupType(
@@ -148,7 +148,7 @@ class ParserProtoLog extends AbstractParser {
       if (error instanceof FormatStringMismatchError) {
         return this.makeLogMessageWithoutFormat(entry);
       }
-      throw error;
+      throw this.createParsingError((error as Error).message);
     }
   }
 
@@ -175,7 +175,7 @@ class ParserProtoLog extends AbstractParser {
       if (messageFormat[i] === '%') {
         if (i + 1 >= messageFormat.length) {
           // Should never happen - protologtool checks for that
-          throw new Error('Invalid format string');
+          throw this.createParsingError('invalid format string');
         }
         switch (messageFormat[i + 1]) {
           case '%':
@@ -210,8 +210,8 @@ class ParserProtoLog extends AbstractParser {
             break;
           default:
             // Should never happen - protologtool checks for that
-            throw new Error(
-              'Invalid format string conversion: ' + messageFormat[i + 1],
+            throw this.createParsingError(
+              'invalid format string conversion: ' + messageFormat[i + 1],
             );
         }
         i += 2;
@@ -232,7 +232,7 @@ class ParserProtoLog extends AbstractParser {
 
   private getParam<T>(arr: T[], idx: number): T {
     if (arr.length <= idx) {
-      throw new Error('No param for format string conversion');
+      throw this.createParsingError('no param for format string conversion');
     }
     return arr[idx];
   }
@@ -260,6 +260,10 @@ class ParserProtoLog extends AbstractParser {
       timestamp: BigInt(assertDefined(entry.elapsedRealtimeNanos).toString()),
     };
   }
+
+  private createParsingError(msg: string) {
+    return new Error(`Protolog parsing error: ${msg}`);
+  }
 }
 
 class FormatStringMismatchError extends Error {
diff --git a/tools/winscope/src/parsers/protolog/legacy/parser_protolog_test.ts b/tools/winscope/src/parsers/protolog/legacy/parser_protolog_test.ts
index 4eedbb0d7..e3496a9fe 100644
--- a/tools/winscope/src/parsers/protolog/legacy/parser_protolog_test.ts
+++ b/tools/winscope/src/parsers/protolog/legacy/parser_protolog_test.ts
@@ -141,7 +141,7 @@ describe('ParserProtoLog', () => {
       ],
       {
         'message': 'Starting activity when config will change = false',
-        'ts': '2024-02-29, 08:53:26.399',
+        'ts': '2024-02-29, 08:53:26.400',
         'tag': 'WindowManager',
         'level': 'VERBOSE',
         'at': 'com/android/server/wm/ActivityStarter.java',
diff --git a/tools/winscope/src/parsers/protolog/perfetto/parser_protolog.ts b/tools/winscope/src/parsers/protolog/perfetto/parser_protolog.ts
index f5a776a2a..827898226 100644
--- a/tools/winscope/src/parsers/protolog/perfetto/parser_protolog.ts
+++ b/tools/winscope/src/parsers/protolog/perfetto/parser_protolog.ts
@@ -27,11 +27,18 @@ class PerfettoLogMessageTableRow {
   location = '<NO_LOC>';
   timestamp: bigint = 0n;
 
-  constructor(timestamp: bigint, tag: string, level: string, message: string) {
+  constructor(
+    timestamp: bigint,
+    tag: string,
+    level: string,
+    message: string,
+    location: string,
+  ) {
     this.timestamp = timestamp ?? this.timestamp;
     this.tag = tag ?? this.tag;
     this.level = level ?? this.level;
     this.message = message ?? this.message;
+    this.location = location ?? this.location;
   }
 }
 
@@ -64,7 +71,7 @@ export class ParserProtolog extends AbstractParser<PropertyTreeNode> {
   private async queryEntry(index: number): Promise<PerfettoLogMessageTableRow> {
     const sql = `
       SELECT
-        ts, tag, level, message
+        ts, tag, level, location, message
       FROM
         protolog
       WHERE protolog.id = ${this.entryIndexToRowIdMap[index]};
@@ -84,6 +91,7 @@ export class ParserProtolog extends AbstractParser<PropertyTreeNode> {
       entry.get('tag') as string,
       entry.get('level') as string,
       entry.get('message') as string,
+      entry.get('location') as string,
     );
   }
 }
diff --git a/tools/winscope/src/parsers/protolog/perfetto/parser_protolog_test.ts b/tools/winscope/src/parsers/protolog/perfetto/parser_protolog_test.ts
index ebe38b850..88e6c1572 100644
--- a/tools/winscope/src/parsers/protolog/perfetto/parser_protolog_test.ts
+++ b/tools/winscope/src/parsers/protolog/perfetto/parser_protolog_test.ts
@@ -54,7 +54,7 @@ describe('Perfetto ParserProtolog', () => {
     expect(
       assertDefined(message.getChildByName('text')).formattedValue(),
     ).toEqual(
-      'Test message with different int formats: 1776, 0o3360, 0x6f0, 888.000000, 8.880000e+02.',
+      'Test message with different int formats: 888, 0o1570, 0x378, 888.000000, 8.880000e+02.',
     );
     expect(
       assertDefined(message.getChildByName('timestamp')).formattedValue(),
diff --git a/tools/winscope/src/parsers/raw_data_utils.ts b/tools/winscope/src/parsers/raw_data_utils.ts
index 698bb6ff1..24df71634 100644
--- a/tools/winscope/src/parsers/raw_data_utils.ts
+++ b/tools/winscope/src/parsers/raw_data_utils.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {Rect} from 'common/rect';
+import {GeometryFactory} from 'trace/geometry_factory';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
 export class RawDataUtils {
@@ -24,7 +24,7 @@ export class RawDataUtils {
     }
 
     if (RawDataUtils.isRect(obj)) {
-      return Rect.from(obj).isEmpty();
+      return GeometryFactory.makeRect(obj).isEmpty();
     }
 
     return false;
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
index 89c0b7380..4472b14bd 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording.ts
@@ -16,9 +16,11 @@
 
 import {ArrayUtils} from 'common/array_utils';
 import {Timestamp} from 'common/time';
+import {UserNotifier} from 'common/user_notifier';
+import {MonotonicScreenRecording} from 'messaging/user_warnings';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {CoarseVersion} from 'trace/coarse_version';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {ScreenRecordingUtils} from 'trace/screen_recording_utils';
 import {TraceType} from 'trace/trace_type';
 
@@ -53,7 +55,9 @@ class ParserScreenRecording extends AbstractParser {
     );
 
     if (metadataVersion !== 1 && metadataVersion !== 2) {
-      throw TypeError(`Metadata version "${metadataVersion}" not supported`);
+      throw new TypeError(
+        `Metadata version "${metadataVersion}" not supported`,
+      );
     }
 
     if (metadataVersion === 1) {
@@ -66,8 +70,7 @@ class ParserScreenRecording extends AbstractParser {
       // If no device suspensions are involved, SYSTEM_TIME_MONOTONIC should
       // indeed correspond to SYSTEM_TIME_BOOTTIME and things will work as
       // expected.
-      console.warn(`Screen recording may not be synchronized with the
-        other traces. Metadata contains monotonic time instead of elapsed.`);
+      UserNotifier.add(new MonotonicScreenRecording());
     }
 
     const [posCount, timeOffsetNs] = this.parserealToBootTimeOffsetNs(
@@ -92,13 +95,13 @@ class ParserScreenRecording extends AbstractParser {
   override processDecodedEntry(
     index: number,
     entry: bigint,
-  ): ScreenRecordingTraceEntry {
+  ): MediaBasedTraceEntry {
     const videoTimeSeconds = ScreenRecordingUtils.timestampToVideoTimeSeconds(
       this.decodedEntries[0],
       entry,
     );
     const videoData = this.traceFile.file;
-    return new ScreenRecordingTraceEntry(videoTimeSeconds, videoData);
+    return new MediaBasedTraceEntry(videoTimeSeconds, videoData);
   }
 
   private searchMagicString(videoData: Uint8Array): number {
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy.ts
index f58c56727..903966d44 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy.ts
@@ -17,7 +17,7 @@
 import {ArrayUtils} from 'common/array_utils';
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {ScreenRecordingUtils} from 'trace/screen_recording_utils';
 import {TraceType} from 'trace/trace_type';
 
@@ -51,13 +51,13 @@ class ParserScreenRecordingLegacy extends AbstractParser {
   override processDecodedEntry(
     index: number,
     entry: bigint,
-  ): ScreenRecordingTraceEntry {
+  ): MediaBasedTraceEntry {
     const videoTimeSeconds = ScreenRecordingUtils.timestampToVideoTimeSeconds(
       this.decodedEntries[0],
       entry,
     );
     const videoData = this.traceFile.file;
-    return new ScreenRecordingTraceEntry(videoTimeSeconds, videoData);
+    return new MediaBasedTraceEntry(videoTimeSeconds, videoData);
   }
 
   private searchMagicString(videoData: Uint8Array): number {
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy_test.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy_test.ts
index 16cf41d6c..ae7aff5f3 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy_test.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_legacy_test.ts
@@ -18,17 +18,17 @@ import {assertDefined} from 'common/assert_utils';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {Parser} from 'trace/parser';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
 import {TraceType} from 'trace/trace_type';
 
 describe('ParserScreenRecordingLegacy', () => {
-  let parser: Parser<ScreenRecordingTraceEntry>;
+  let parser: Parser<MediaBasedTraceEntry>;
 
   beforeAll(async () => {
     parser = (await UnitTestUtils.getParser(
       'traces/elapsed_timestamp/screen_recording.mp4',
-    )) as Parser<ScreenRecordingTraceEntry>;
+    )) as Parser<MediaBasedTraceEntry>;
   });
 
   it('has expected trace type', () => {
@@ -64,12 +64,12 @@ describe('ParserScreenRecordingLegacy', () => {
   it('retrieves trace entry', async () => {
     {
       const entry = await parser.getEntry(0);
-      expect(entry).toBeInstanceOf(ScreenRecordingTraceEntry);
+      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
       expect(Number(entry.videoTimeSeconds)).toBeCloseTo(0);
     }
     {
       const entry = await parser.getEntry(parser.getLengthEntries() - 1);
-      expect(entry).toBeInstanceOf(ScreenRecordingTraceEntry);
+      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
       expect(Number(entry.videoTimeSeconds)).toBeCloseTo(2.37, 0.001);
     }
   });
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
index ff9c27972..9d2eacd97 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
+++ b/tools/winscope/src/parsers/screen_recording/parser_screen_recording_test.ts
@@ -17,18 +17,18 @@ import {assertDefined} from 'common/assert_utils';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {Parser} from 'trace/parser';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
 import {TraceType} from 'trace/trace_type';
 
 describe('ParserScreenRecording', () => {
-  let parser: Parser<ScreenRecordingTraceEntry>;
+  let parser: Parser<MediaBasedTraceEntry>;
 
   beforeAll(async () => {
     jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
     parser = (await UnitTestUtils.getParser(
       'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-    )) as Parser<ScreenRecordingTraceEntry>;
+    )) as Parser<MediaBasedTraceEntry>;
   });
 
   it('has expected trace type', () => {
@@ -55,12 +55,12 @@ describe('ParserScreenRecording', () => {
   it('retrieves trace entry', async () => {
     {
       const entry = await parser.getEntry(0);
-      expect(entry).toBeInstanceOf(ScreenRecordingTraceEntry);
+      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
       expect(Number(entry.videoTimeSeconds)).toBeCloseTo(0);
     }
     {
       const entry = await parser.getEntry(parser.getLengthEntries() - 1);
-      expect(entry).toBeInstanceOf(ScreenRecordingTraceEntry);
+      expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
       expect(Number(entry.videoTimeSeconds)).toBeCloseTo(1.371077, 0.001);
     }
   });
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screenshot.ts b/tools/winscope/src/parsers/screenshot/parser_screenshot.ts
similarity index 88%
rename from tools/winscope/src/parsers/screen_recording/parser_screenshot.ts
rename to tools/winscope/src/parsers/screenshot/parser_screenshot.ts
index 06dfc9b9c..ea52968e6 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screenshot.ts
+++ b/tools/winscope/src/parsers/screenshot/parser_screenshot.ts
@@ -17,10 +17,10 @@
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {CoarseVersion} from 'trace/coarse_version';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {TraceType} from 'trace/trace_type';
 
-class ParserScreenshot extends AbstractParser<ScreenRecordingTraceEntry> {
+class ParserScreenshot extends AbstractParser<MediaBasedTraceEntry> {
   private static readonly MAGIC_NUMBER = [
     0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,
   ]; // currently only support png files
@@ -56,9 +56,9 @@ class ParserScreenshot extends AbstractParser<ScreenRecordingTraceEntry> {
   override processDecodedEntry(
     index: number,
     entry: number,
-  ): ScreenRecordingTraceEntry {
+  ): MediaBasedTraceEntry {
     const screenshotData = this.traceFile.file;
-    return new ScreenRecordingTraceEntry(0, screenshotData, true);
+    return new MediaBasedTraceEntry(0, screenshotData, true);
   }
 }
 
diff --git a/tools/winscope/src/parsers/screen_recording/parser_screenshot_test.ts b/tools/winscope/src/parsers/screenshot/parser_screenshot_test.ts
similarity index 95%
rename from tools/winscope/src/parsers/screen_recording/parser_screenshot_test.ts
rename to tools/winscope/src/parsers/screenshot/parser_screenshot_test.ts
index e8bccd8fc..613282b10 100644
--- a/tools/winscope/src/parsers/screen_recording/parser_screenshot_test.ts
+++ b/tools/winscope/src/parsers/screenshot/parser_screenshot_test.ts
@@ -19,7 +19,7 @@ import {TimestampConverter} from 'common/timestamp_converter';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
 import {TraceFile} from 'trace/trace_file';
 import {TraceType} from 'trace/trace_type';
 import {ParserScreenshot} from './parser_screenshot';
@@ -69,7 +69,7 @@ describe('ParserScreenshot', () => {
 
   it('retrieves entry', async () => {
     const entry = await parser.getEntry(0);
-    expect(entry).toBeInstanceOf(ScreenRecordingTraceEntry);
+    expect(entry).toBeInstanceOf(MediaBasedTraceEntry);
     expect(entry.isImage).toBeTrue();
   });
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/common_operations.ts b/tools/winscope/src/parsers/surface_flinger/common_operations.ts
new file mode 100644
index 000000000..d55cc815d
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/common_operations.ts
@@ -0,0 +1,30 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {AddCompositionType} from './operations/add_composition_type';
+import {AddDisplayProperties} from './operations/add_display_properties';
+import {AddExcludesCompositionState} from './operations/add_excludes_composition_state';
+import {AddVerboseFlags} from './operations/add_verbose_flags';
+import {UpdateTransforms} from './operations/update_transforms';
+
+export const COMMON_OPERATIONS = {
+  UpdateTransforms: new UpdateTransforms(),
+  AddVerboseFlags: new AddVerboseFlags(),
+  AddExcludesCompositionStateTrue: new AddExcludesCompositionState(true),
+  AddExcludesCompositionStateFalse: new AddExcludesCompositionState(false),
+  AddDisplayProperties: new AddDisplayProperties(),
+  AddCompositionType: new AddCompositionType(),
+};
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts
new file mode 100644
index 000000000..eb3d8d5c5
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/computations/layer_extractor.ts
@@ -0,0 +1,64 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+
+export class LayerExtractor {
+  static extractLayersSortedByZ(layer: HierarchyTreeNode): HierarchyTreeNode[] {
+    const traverseList: HierarchyTreeNode[] = [];
+
+    if (!layer.isRoot()) traverseList.push(layer);
+
+    const allChildrenSortedByZ = layer
+      .getAllChildren()
+      .slice()
+      .sort(LayerExtractor.compareByZOrderPath);
+
+    allChildrenSortedByZ.forEach((c) => {
+      traverseList.push(...LayerExtractor.extractLayersSortedByZ(c));
+    });
+
+    traverseList.sort(LayerExtractor.compareByZOrderPath);
+    return traverseList;
+  }
+
+  private static compareByZOrderPath(
+    a: HierarchyTreeNode,
+    b: HierarchyTreeNode,
+  ): number {
+    const aZOrderPath: number[] = assertDefined(
+      a.getEagerPropertyByName('zOrderPath'),
+    )
+      .getAllChildren()
+      .map((child) => child.getValue());
+    const bZOrderPath: number[] = assertDefined(
+      b.getEagerPropertyByName('zOrderPath'),
+    )
+      .getAllChildren()
+      .map((child) => child.getValue());
+
+    const zipLength = Math.min(aZOrderPath.length, bZOrderPath.length);
+    for (let i = 0; i < zipLength; ++i) {
+      const zOrderA = aZOrderPath[i];
+      const zOrderB = bZOrderPath[i];
+      if (zOrderA > zOrderB) return -1;
+      if (zOrderA < zOrderB) return 1;
+    }
+    // When z-order is the same, the layer with larger ID is on top
+    return a.id > b.id ? -1 : 1;
+  }
+}
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
index 8aa07162d..8ba2f2628 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation.ts
@@ -15,22 +15,62 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
-import {Transform} from 'parsers/surface_flinger/transform_utils';
+import {Rect} from 'common/geometry/rect';
+import {Region} from 'common/geometry/region';
+import {Size} from 'common/geometry/size';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
+import {
+  Transform,
+  TransformType,
+} from 'parsers/surface_flinger/transform_utils';
+import {GeometryFactory} from 'trace/geometry_factory';
 import {TraceRect} from 'trace/trace_rect';
 import {TraceRectBuilder} from 'trace/trace_rect_builder';
 import {Computation} from 'trace/tree_node/computation';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LayerExtractor} from './layer_extractor';
+
+function getDisplaySize(display: PropertyTreeNode): Size {
+  const displaySize = assertDefined(display.getChildByName('size'));
+  const w = assertDefined(displaySize.getChildByName('w')?.getValue());
+  const h = assertDefined(displaySize.getChildByName('h')?.getValue());
+  const transformType =
+    display.getChildByName('transform')?.getChildByName('type')?.getValue() ??
+    0;
+  const typeFlags = TransformType.getTypeFlags(transformType);
+  const isRotated =
+    typeFlags.includes('ROT_90') || typeFlags.includes('ROT_270');
+  return {
+    width: isRotated ? h : w,
+    height: isRotated ? w : h,
+  };
+}
+
+// InputConfig constants defined in the platform:
+//   frameworks/native/libs/input/android/os/InputConfig.aidl
+export enum InputConfig {
+  NOT_TOUCHABLE = 1 << 3,
+  IS_WALLPAPER = 1 << 6,
+  SPY = 1 << 14,
+}
 
 class RectSfFactory {
-  makeDisplayRects(displays: readonly PropertyTreeNode[]): TraceRect[] {
+  static makeDisplayRects(displays: readonly PropertyTreeNode[]): TraceRect[] {
     const nameCounts = new Map<string, number>();
     return displays.map((display, index) => {
       const layerStackSpaceRect = assertDefined(
         display.getChildByName('layerStackSpaceRect'),
       );
-      const displayRect = Rect.from(layerStackSpaceRect);
+
+      let displayRect = GeometryFactory.makeRect(layerStackSpaceRect);
+      const isEmptyLayerStackRect = displayRect.isEmpty();
+
+      if (isEmptyLayerStackRect) {
+        const size = getDisplaySize(display);
+        displayRect = new Rect(0, 0, size.width, size.height);
+      }
+
       const layerStack = assertDefined(
         display.getChildByName('layerStack'),
       ).getValue();
@@ -49,6 +89,10 @@ class RectSfFactory {
         nameCounts.set(displayName, 1);
       }
 
+      const isOn = display.getChildByName('isOn')?.getValue() ?? false;
+      const isVirtual =
+        display.getChildByName('isVirtual')?.getValue() ?? false;
+
       return new TraceRectBuilder()
         .setX(displayRect.x)
         .setY(displayRect.y)
@@ -61,13 +105,14 @@ class RectSfFactory {
         .setGroupId(layerStack)
         .setIsVisible(false)
         .setIsDisplay(true)
-        .setIsVirtual(display.getChildByName('isVirtual')?.getValue() ?? false)
+        .setIsActiveDisplay(isOn && !isVirtual)
         .setDepth(index)
+        .setIsSpy(false)
         .build();
     });
   }
 
-  makeLayerRect(
+  static makeLayerRect(
     layer: HierarchyTreeNode,
     layerStack: number,
     absoluteZ: number,
@@ -78,7 +123,7 @@ class RectSfFactory {
 
     const name = assertDefined(layer.getEagerPropertyByName('name')).getValue();
     const bounds = assertDefined(layer.getEagerPropertyByName('bounds'));
-    const boundsRect = Rect.from(bounds);
+    const boundsRect = GeometryFactory.makeRect(bounds);
 
     let opacity = layer
       .getEagerPropertyByName('color')
@@ -98,7 +143,7 @@ class RectSfFactory {
       )
       .setName(name)
       .setCornerRadius(
-        layer.getEagerPropertyByName('cornerRadius')?.getValue() ?? 0,
+        assertDefined(layer.getEagerPropertyByName('cornerRadius')).getValue(),
       )
       .setTransform(
         Transform.from(assertDefined(layer.getEagerPropertyByName('transform')))
@@ -107,106 +152,319 @@ class RectSfFactory {
       .setGroupId(layerStack)
       .setIsVisible(isVisible)
       .setIsDisplay(false)
-      .setIsVirtual(false)
       .setDepth(absoluteZ)
       .setOpacity(opacity)
+      .setIsSpy(false)
+      .build();
+  }
+
+  static makeInputWindowRect(
+    layer: HierarchyTreeNode,
+    layerStack: number,
+    absoluteZ: number,
+    invalidBoundsFromDisplays: Rect[],
+    display?: TraceRect,
+    displayTransform?: TransformMatrix,
+  ): TraceRect {
+    const name = assertDefined(layer.getEagerPropertyByName('name')).getValue();
+    const inputWindowInfo = assertDefined(
+      layer.getEagerPropertyByName('inputWindowInfo'),
+    );
+    let inputWindowRect = GeometryFactory.makeRect(
+      assertDefined(layer.getEagerPropertyByName('bounds')),
+    );
+    const inputConfig = assertDefined(
+      inputWindowInfo.getChildByName('inputConfig'),
+    ).getValue();
+
+    const shouldCropToDisplay =
+      (inputConfig & InputConfig.IS_WALLPAPER) !== 0 ||
+      (invalidBoundsFromDisplays !== undefined &&
+        invalidBoundsFromDisplays.some((invalid) =>
+          inputWindowRect.isAlmostEqual(invalid, 0.01),
+        ));
+    if (shouldCropToDisplay && display !== undefined) {
+      inputWindowRect = inputWindowRect.cropRect(display);
+    }
+
+    const isVisible =
+      inputWindowInfo.getChildByName('visible')?.getValue() ??
+      assertDefined(
+        layer.getEagerPropertyByName('isComputedVisible'),
+      ).getValue();
+
+    const layerTransform = Transform.from(
+      assertDefined(layer.getEagerPropertyByName('transform')),
+    ).matrix;
+
+    let touchableRegion: Region | undefined;
+    const isTouchable = (inputConfig & InputConfig.NOT_TOUCHABLE) === 0;
+    const touchableRegionNode =
+      inputWindowInfo.getChildByName('touchableRegion');
+
+    if (!isTouchable) {
+      touchableRegion = Region.createEmpty();
+    } else if (touchableRegionNode !== undefined) {
+      // The touchable region is given in the display space, not layer space.
+      touchableRegion = GeometryFactory.makeRegion(touchableRegionNode);
+      // First, transform the region into layer stack space.
+      touchableRegion =
+        displayTransform?.transformRegion(touchableRegion) ?? touchableRegion;
+      // Second, transform the region into layer space.
+      touchableRegion = layerTransform
+        .inverse()
+        .transformRegion(touchableRegion);
+      if (shouldCropToDisplay && display !== undefined) {
+        touchableRegion = new Region(
+          touchableRegion.rects.map((rect) => {
+            return rect.cropRect(display);
+          }),
+        );
+      }
+    }
+
+    return new TraceRectBuilder()
+      .setX(inputWindowRect.x)
+      .setY(inputWindowRect.y)
+      .setWidth(inputWindowRect.w)
+      .setHeight(inputWindowRect.h)
+      .setId(`${assertDefined(layer.getEagerPropertyByName('id')).getValue()}`)
+      .setName(name)
+      .setCornerRadius(0)
+      .setTransform(layerTransform)
+      .setGroupId(layerStack)
+      .setIsVisible(isVisible)
+      .setIsDisplay(false)
+      .setDepth(absoluteZ)
+      .setIsSpy((inputConfig & InputConfig.SPY) !== 0)
+      .setFillRegion(touchableRegion)
       .build();
   }
 }
 
 export class RectsComputation implements Computation {
-  private root: HierarchyTreeNode | undefined;
-  private readonly rectsFactory = new RectSfFactory();
+  private static readonly DEFAULT_INVALID_BOUNDS = new Rect(
+    -50000,
+    -50000,
+    100000,
+    100000,
+  );
+
+  private root?: HierarchyTreeNode;
+  private displaysByLayerStack?: Map<number, TraceRect>;
+  private displayTransformsByLayerStack?: Map<number, TransformMatrix>;
+  private invalidBoundsFromDisplays?: Rect[];
 
   setRoot(value: HierarchyTreeNode): this {
     this.root = value;
     return this;
   }
 
+  // synced with getMaxDisplayBounds() in main/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp
+  private static getInvalidBoundsFromDisplays(
+    displays: readonly PropertyTreeNode[],
+  ): Rect[] {
+    if (displays.length === 0) return [];
+
+    // foldables expand rects to fill display space before all displays are available
+    // make invalid bounds for each individual display, and for the rect of max dimensions
+
+    const invalidBounds: Rect[] = [];
+
+    const maxSize = displays.reduce(
+      (size, display) => {
+        const displaySize = getDisplaySize(display);
+        invalidBounds.push(
+          ...RectsComputation.makeInvalidBoundsFromSize(displaySize),
+        );
+        return {
+          width: Math.max(size.width, displaySize.width),
+          height: Math.max(size.height, displaySize.height),
+        };
+      },
+      {width: 0, height: 0},
+    );
+    invalidBounds.push(...RectsComputation.makeInvalidBoundsFromSize(maxSize));
+
+    return invalidBounds;
+  }
+
+  private static makeInvalidBoundsFromSize(size: Size): Rect[] {
+    const [invalidX, invalidY] = [size.width * 10, size.height * 10];
+    const invalidBounds = new Rect(
+      -invalidX,
+      -invalidY,
+      invalidX * 2,
+      invalidY * 2,
+    );
+    const rotatedInvalidBounds = new Rect(
+      invalidBounds.y,
+      invalidBounds.x,
+      invalidBounds.h,
+      invalidBounds.w,
+    );
+    return [invalidBounds, rotatedInvalidBounds];
+  }
+
   executeInPlace(): void {
+    this.processDisplays();
+    this.processLayers(
+      RectsComputation.hasLayerRect,
+      RectSfFactory.makeLayerRect,
+      true,
+    );
+    this.processLayers(
+      RectsComputation.hasInputWindowRect,
+      RectSfFactory.makeInputWindowRect,
+      false,
+    );
+  }
+
+  private processDisplays() {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set in SF rects computation');
     }
-    const groupIdToAbsoluteZ = new Map<number, number>();
-
     const displays =
       this.root.getEagerPropertyByName('displays')?.getAllChildren() ?? [];
-    const displayRects = this.rectsFactory.makeDisplayRects(displays);
+    const displayRects = RectSfFactory.makeDisplayRects(displays);
     this.root.setRects(displayRects);
 
-    displayRects.forEach((displayRect) =>
-      groupIdToAbsoluteZ.set(displayRect.groupId, 1),
+    this.displaysByLayerStack = new Map(
+      displayRects.map((rect) => [rect.groupId, rect]),
+    );
+
+    this.invalidBoundsFromDisplays =
+      RectsComputation.getInvalidBoundsFromDisplays(displays);
+
+    this.displayTransformsByLayerStack = new Map();
+    displays.forEach((display) => {
+      const layerStack = assertDefined(
+        display.getChildByName('layerStack'),
+      ).getValue();
+      const matrix = RectsComputation.extractDisplayTransform(display);
+      if (matrix) {
+        assertDefined(this.displayTransformsByLayerStack).set(
+          layerStack,
+          matrix,
+        );
+      }
+    });
+  }
+
+  private static extractDisplayTransform(
+    display: PropertyTreeNode,
+  ): TransformMatrix | undefined {
+    const transformNode = display.getChildByName('transform');
+    const layerStackSpaceRectNode = assertDefined(
+      display.getChildByName('layerStackSpaceRect'),
+    );
+    if (!transformNode || !layerStackSpaceRectNode) {
+      return undefined;
+    }
+    const transform = Transform.from(transformNode);
+    let tx = transform.matrix.tx;
+    let ty = transform.matrix.ty;
+    const layerStackSpaceRect = GeometryFactory.makeRect(
+      layerStackSpaceRectNode,
     );
 
-    const layersWithRects = this.extractLayersWithRects(this.root);
-    layersWithRects.sort(this.compareLayerZ);
+    const typeFlags = TransformType.getTypeFlags(transform.type);
+    if (typeFlags.includes('ROT_180')) {
+      tx += layerStackSpaceRect.w;
+      ty += layerStackSpaceRect.h;
+    } else if (typeFlags.includes('ROT_270')) {
+      tx += layerStackSpaceRect.w;
+    } else if (typeFlags.includes('ROT_90')) {
+      ty += layerStackSpaceRect.h;
+    }
+    return TransformMatrix.from({tx, ty}, transform.matrix);
+  }
+
+  private processLayers(
+    shouldIncludeLayer: (
+      node: HierarchyTreeNode,
+      invalidBoundsFromDisplays: Rect[],
+    ) => boolean,
+    makeTraceRect: (
+      layer: HierarchyTreeNode,
+      layerStack: number,
+      absoluteZ: number,
+      invalidBoundsFromDisplays: Rect[],
+      display?: TraceRect,
+      displayTransform?: TransformMatrix,
+    ) => TraceRect,
+    isPrimaryRects: boolean,
+  ) {
+    const curAbsoluteZByLayerStack = new Map<number, number>();
+    for (const layerStack of assertDefined(this.displaysByLayerStack).keys()) {
+      curAbsoluteZByLayerStack.set(layerStack, 1);
+    }
+
+    const layersWithRects = LayerExtractor.extractLayersSortedByZ(
+      assertDefined(this.root),
+    ).filter((node) =>
+      shouldIncludeLayer(node, assertDefined(this.invalidBoundsFromDisplays)),
+    );
 
     for (let i = layersWithRects.length - 1; i > -1; i--) {
       const layer = layersWithRects[i];
       const layerStack = assertDefined(
         layer.getEagerPropertyByName('layerStack'),
       ).getValue();
-      const absoluteZ = groupIdToAbsoluteZ.get(layerStack) ?? 0;
-      const rect = this.rectsFactory.makeLayerRect(
+      const absoluteZ = curAbsoluteZByLayerStack.get(layerStack) ?? 0;
+      const rect = makeTraceRect(
         layer,
         layerStack,
         absoluteZ,
+        assertDefined(this.invalidBoundsFromDisplays),
+        this.displaysByLayerStack?.get(layerStack),
+        this.displayTransformsByLayerStack?.get(layerStack),
       );
-      layer.setRects([rect]);
-      groupIdToAbsoluteZ.set(layerStack, absoluteZ + 1);
+      isPrimaryRects ? layer.setRects([rect]) : layer.setSecondaryRects([rect]);
+      curAbsoluteZByLayerStack.set(layerStack, absoluteZ + 1);
     }
   }
 
-  private extractLayersWithRects(
-    hierarchyRoot: HierarchyTreeNode,
-  ): HierarchyTreeNode[] {
-    return hierarchyRoot.filterDfs(this.hasLayerRect);
-  }
-
-  private hasLayerRect(node: HierarchyTreeNode): boolean {
-    if (node.isRoot()) return false;
-
+  private static hasLayerRect(
+    node: HierarchyTreeNode,
+    invalidBoundsFromDisplays: Rect[],
+  ): boolean {
     const isVisible = node
       .getEagerPropertyByName('isComputedVisible')
       ?.getValue();
     if (isVisible === undefined) {
-      throw Error('Visibility has not been computed');
+      throw new Error(
+        'SF rects computation attempted before visibility computation',
+      );
     }
 
-    const occludedBy = node.getEagerPropertyByName('occludedBy');
-    if (
-      !isVisible &&
-      (occludedBy === undefined || occludedBy.getAllChildren().length === 0)
-    ) {
-      return false;
-    }
+    const screenBounds = node.getEagerPropertyByName('screenBounds');
+    if (!screenBounds) return false;
 
-    const bounds = node.getEagerPropertyByName('bounds');
-    if (!bounds) return false;
+    if (screenBounds && !isVisible) {
+      const screenBoundsRect = GeometryFactory.makeRect(screenBounds);
+      const isInvalidFromDisplays =
+        invalidBoundsFromDisplays.length > 0 &&
+        invalidBoundsFromDisplays.some((invalid) => {
+          return screenBoundsRect.isAlmostEqual(invalid, 0.01);
+        });
+      return (
+        !isInvalidFromDisplays &&
+        !screenBoundsRect.isAlmostEqual(
+          RectsComputation.DEFAULT_INVALID_BOUNDS,
+          0.01,
+        )
+      );
+    }
 
     return true;
   }
 
-  private compareLayerZ(a: HierarchyTreeNode, b: HierarchyTreeNode): number {
-    const aZOrderPath: number[] = assertDefined(
-      a.getEagerPropertyByName('zOrderPath'),
-    )
-      .getAllChildren()
-      .map((child) => child.getValue());
-    const bZOrderPath: number[] = assertDefined(
-      b.getEagerPropertyByName('zOrderPath'),
-    )
-      .getAllChildren()
-      .map((child) => child.getValue());
-
-    const zipLength = Math.min(aZOrderPath.length, bZOrderPath.length);
-    for (let i = 0; i < zipLength; ++i) {
-      const zOrderA = aZOrderPath[i];
-      const zOrderB = bZOrderPath[i];
-      if (zOrderA > zOrderB) return -1;
-      if (zOrderA < zOrderB) return 1;
-    }
-    // When z-order is the same, the layer with larger ID is on top
-    return a.id > b.id ? -1 : 1;
+  private static hasInputWindowRect(node: HierarchyTreeNode): boolean {
+    const inputWindowInfo = node.getEagerPropertyByName('inputWindowInfo');
+    return (
+      inputWindowInfo !== undefined &&
+      inputWindowInfo.getChildByName('inputConfig') !== undefined
+    );
   }
 }
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
index 4d671f347..5c9a9ab00 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/rects_computation_test.ts
@@ -14,21 +14,62 @@
  * limitations under the License.
  */
 
-import {Transform} from 'parsers/surface_flinger/transform_utils';
+import {Rect} from 'common/geometry/rect';
+import {Region} from 'common/geometry/region';
+import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {
+  Transform,
+  TransformTypeFlags,
+} from 'parsers/surface_flinger/transform_utils';
 import {android} from 'protos/surfaceflinger/udc/static';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceRect} from 'trace/trace_rect';
 import {TraceRectBuilder} from 'trace/trace_rect_builder';
-import {RectsComputation} from './rects_computation';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {InputConfig, RectsComputation} from './rects_computation';
 
-describe('RectsComputation', () => {
+describe('SurfaceFlinger RectsComputation', () => {
+  const rotationTransform = new Transform(
+    TransformTypeFlags.ROT_90_VAL,
+    IDENTITY_MATRIX,
+  );
   let computation: RectsComputation;
 
   beforeEach(() => {
     computation = new RectsComputation();
   });
 
-  it('makes layer rects', () => {
+  it('throws error if root not set', () => {
+    expect(() => computation.executeInPlace()).toThrowError();
+  });
+
+  it('throws error if visibility not already computed', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            name: 'layer1',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
+            zOrderPath: [0],
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+    expect(() =>
+      computation.setRoot(hierarchyRoot).executeInPlace(),
+    ).toThrowError();
+  });
+
+  it('makes layer rects according to z order paths', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -42,6 +83,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
             zOrderPath: [0],
             isComputedVisible: true,
             transform: Transform.EMPTY,
@@ -56,6 +98,7 @@ describe('RectsComputation', () => {
                 cornerRadius: 2,
                 layerStack: 0,
                 bounds: {left: 0, top: 0, right: 2, bottom: 2},
+                screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
                 zOrderPath: [0, 1],
                 occludedBy: [1],
                 isComputedVisible: false,
@@ -64,6 +107,21 @@ describe('RectsComputation', () => {
             },
           ],
         },
+        {
+          id: 3,
+          name: 'layer3',
+          properties: {
+            id: 3,
+            name: 'layer3',
+            cornerRadius: 2,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 2, bottom: 2},
+            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
         {
           id: 4,
           name: 'layerRelativeZ',
@@ -73,12 +131,29 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
             zOrderPath: [0, 2],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
             transform: Transform.EMPTY,
           } as android.surfaceflinger.ILayerProto,
         },
+        {
+          id: 5,
+          name: 'layerNegativeZ',
+          properties: {
+            id: 5,
+            name: 'layerNegativeZ',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [-5],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
       ])
       .build();
 
@@ -92,12 +167,12 @@ describe('RectsComputation', () => {
         .setName('layer1')
         .setCornerRadius(0)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(0)
+        .setDepth(1)
         .setGroupId(0)
         .setIsVisible(true)
         .setOpacity(0)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -109,11 +184,27 @@ describe('RectsComputation', () => {
         .setName('layer2')
         .setCornerRadius(2)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(1)
+        .setDepth(2)
+        .setGroupId(0)
+        .setIsVisible(false)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(2)
+        .setHeight(2)
+        .setId('3 layer3')
+        .setName('layer3')
+        .setCornerRadius(2)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(3)
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -125,27 +216,34 @@ describe('RectsComputation', () => {
         .setName('layerRelativeZ')
         .setCornerRadius(0)
         .setTransform(Transform.EMPTY.matrix)
-        .setDepth(2)
+        .setDepth(4)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setOpacity(1)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('5 layerNegativeZ')
+        .setName('layerNegativeZ')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(0)
         .setGroupId(0)
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
     ];
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-
-    const rects: TraceRect[] = [];
-    hierarchyRoot.forEachNodeDfs((node) => {
-      if (node.id === 'LayerTraceEntry root') {
-        return;
-      }
-      const nodeRects = node.getRects();
-      if (nodeRects) rects.push(...nodeRects);
-    });
-
-    expect(rects).toEqual(expectedRects);
+    checkLayerRects(hierarchyRoot, expectedRects);
   });
 
   it('handles layer rects with different group ids', () => {
@@ -162,6 +260,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
             zOrderPath: [0],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -177,6 +276,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 1,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
             zOrderPath: [0],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -201,7 +301,7 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -218,22 +318,12 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
     ];
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-
-    const rects: TraceRect[] = [];
-    hierarchyRoot.forEachNodeDfs((node) => {
-      if (node.id === 'LayerTraceEntry root') {
-        return;
-      }
-      const nodeRects = node.getRects();
-      if (nodeRects) rects.push(...nodeRects);
-    });
-
-    expect(rects).toEqual(expectedRects);
+    checkLayerRects(hierarchyRoot, expectedRects);
   });
 
   it('makes display rects', () => {
@@ -248,6 +338,28 @@ describe('RectsComputation', () => {
             layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
             transform: Transform.EMPTY,
             name: 'Test Display',
+            size: {w: 5, h: 5},
+            isOn: true,
+          },
+          {
+            id: 2,
+            layerStack: 0,
+            layerStackSpaceRect: null,
+            size: {w: 5, h: 10},
+            transform: Transform.EMPTY,
+            name: 'Test Display 2',
+            isOn: true,
+            isVirtual: true,
+          },
+          {
+            id: 3,
+            layerStack: 0,
+            layerStackSpaceRect: null,
+            size: {w: 5, h: 10},
+            transform: rotationTransform,
+            name: 'Test Display',
+            isOn: false,
+            isVirtual: true,
           },
         ],
       })
@@ -267,7 +379,40 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(true)
-        .setIsVirtual(false)
+        .setIsActiveDisplay(true)
+        .setIsSpy(false)
+        .build(),
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(10)
+        .setId('Display - 2')
+        .setName('Test Display 2')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(0)
+        .setIsVisible(false)
+        .setIsDisplay(true)
+        .setIsActiveDisplay(false)
+        .setIsSpy(false)
+        .build(),
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(10)
+        .setHeight(5)
+        .setId('Display - 3')
+        .setName('Test Display (Mirror 2)')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(2)
+        .setGroupId(0)
+        .setIsVisible(false)
+        .setIsDisplay(true)
+        .setIsActiveDisplay(false)
+        .setIsSpy(false)
         .build(),
     ];
 
@@ -286,6 +431,7 @@ describe('RectsComputation', () => {
             layerStack: 0,
             layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
             transform: Transform.EMPTY,
+            size: {w: 5, h: 5},
           },
           {
             id: 1,
@@ -293,6 +439,7 @@ describe('RectsComputation', () => {
             layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
             transform: Transform.EMPTY,
             name: '',
+            size: {w: 5, h: 5},
           },
         ],
       })
@@ -312,7 +459,7 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(true)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
       new TraceRectBuilder()
         .setX(0)
@@ -327,7 +474,7 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(true)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
     ];
 
@@ -349,6 +496,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
             zOrderPath: [0, 1],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -364,6 +512,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 2, bottom: 2},
+            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
             zOrderPath: [0, 0, 0],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -388,7 +537,7 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -405,22 +554,12 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
     ];
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-
-    const rects: TraceRect[] = [];
-    hierarchyRoot.forEachNodeDfs((node) => {
-      if (node.id === 'LayerTraceEntry root') {
-        return;
-      }
-      const nodeRects = node.getRects();
-      if (nodeRects) rects.push(...nodeRects);
-    });
-
-    expect(rects).toEqual(expectedRects);
+    checkLayerRects(hierarchyRoot, expectedRects);
   });
 
   it('handles z-order paths with equal values (fall back to Layer ID comparison)', () => {
@@ -437,6 +576,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
             zOrderPath: [0, 1],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -452,6 +592,7 @@ describe('RectsComputation', () => {
             cornerRadius: 0,
             layerStack: 0,
             bounds: {left: 0, top: 0, right: 2, bottom: 2},
+            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
             zOrderPath: [0, 1, 0],
             isComputedVisible: true,
             color: {r: 0, g: 0, b: 0, a: 1},
@@ -476,7 +617,7 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -493,21 +634,599 @@ describe('RectsComputation', () => {
         .setIsVisible(true)
         .setOpacity(1)
         .setIsDisplay(false)
-        .setIsVirtual(false)
+        .setIsSpy(false)
         .build(),
     ];
 
     computation.setRoot(hierarchyRoot).executeInPlace();
+    checkLayerRects(hierarchyRoot, expectedRects);
+  });
 
-    const rects: TraceRect[] = [];
-    hierarchyRoot.forEachNodeDfs((node) => {
-      if (node.id === 'LayerTraceEntry root') {
-        return;
-      }
-      const nodeRects = node.getRects();
-      if (nodeRects) rects.push(...nodeRects);
-    });
+  it('does not make non-visible rects with missing or invalid screen bounds', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setProperties({
+        displays: [
+          {
+            id: 1,
+            layerStack: 0,
+            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 10},
+            transform: Transform.EMPTY,
+            name: 'Test Display',
+            size: {w: 5, h: 10},
+          },
+        ],
+      })
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            name: 'layer1',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50, top: -100, right: 50, bottom: 100},
+            screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: true,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 2,
+          name: 'layer2',
+          properties: {
+            id: 2,
+            name: 'layer2',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50, top: -100, right: 50, bottom: 100},
+            screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 3,
+          name: 'layer3',
+          properties: {
+            id: 3,
+            name: 'layer3',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50, top: -100, right: 50, bottom: 100},
+            screenBounds: {left: -49.991, top: -100, right: 50, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 4,
+          name: 'layer4',
+          properties: {
+            id: 4,
+            name: 'layer4',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50000, top: -50000, right: 50000, bottom: 50000},
+            screenBounds: {
+              left: -50000,
+              top: -50000,
+              right: 50000,
+              bottom: 50000,
+            },
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 5,
+          name: 'layer5',
+          properties: {
+            id: 5,
+            name: 'layer5',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -100, top: -50, right: 100, bottom: 50},
+            screenBounds: {left: -100, top: -50, right: 100, bottom: 50},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 6,
+          name: 'layer6',
+          properties: {
+            id: 6,
+            name: 'layer6',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50, top: -100, right: 50, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: true,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
 
-    expect(rects).toEqual(expectedRects);
+    const expectedRects = [
+      new TraceRectBuilder()
+        .setX(-50)
+        .setY(-100)
+        .setWidth(100)
+        .setHeight(200)
+        .setId('1 layer1')
+        .setName('layer1')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setOpacity(0)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+    ];
+
+    computation.setRoot(hierarchyRoot).executeInPlace();
+    checkLayerRects(hierarchyRoot, expectedRects);
   });
+
+  it('calculates invalid screen bounds from all displays present', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setProperties({
+        displays: [
+          {
+            id: 1,
+            layerStack: 0,
+            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 10},
+            transform: Transform.EMPTY,
+            name: 'Test Display',
+            size: {w: 5, h: 10},
+          },
+          {
+            id: 2,
+            layerStack: 0,
+            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 10},
+            transform: rotationTransform,
+            name: 'Test Display 2',
+            size: {w: 5, h: 10},
+          },
+        ],
+      })
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            name: 'layer1',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -50, top: -100, right: 50, bottom: 100},
+            screenBounds: {left: -50, top: -100, right: 50, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 2,
+          name: 'layer2',
+          properties: {
+            id: 2,
+            name: 'layer2',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: -100, top: -100, right: 100, bottom: 100},
+            screenBounds: {left: -100, top: -100, right: 100, bottom: 100},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+
+    computation.setRoot(hierarchyRoot).executeInPlace();
+    checkLayerRects(hierarchyRoot, []);
+  });
+
+  it('makes input window rects', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setProperties({
+        displays: [
+          {
+            id: 1,
+            layerStack: 0,
+            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
+            transform: Transform.EMPTY,
+            name: 'Test Display',
+            size: {w: 5, h: 5},
+          },
+          {
+            id: 2,
+            layerStack: 1,
+            layerStackSpaceRect: {left: 0, top: 0, right: 5, bottom: 5},
+            name: 'Test Display 2',
+            size: {w: 5, h: 5},
+          },
+        ],
+      })
+      .setChildren([
+        {
+          id: 1,
+          name: 'layer1',
+          properties: {
+            id: 1,
+            name: 'layer1',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 1, bottom: 1},
+            screenBounds: {left: 0, top: 0, right: 1, bottom: 1},
+            zOrderPath: [0],
+            isComputedVisible: true,
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: InputConfig.SPY,
+              visible: true,
+            },
+          } as android.surfaceflinger.ILayerProto,
+          children: [
+            {
+              id: 2,
+              name: 'layer2',
+              properties: {
+                id: 2,
+                name: 'layer2',
+                cornerRadius: 2,
+                layerStack: 0,
+                bounds: {left: 0, top: 0, right: 2, bottom: 2},
+                screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
+                zOrderPath: [0, 1],
+                occludedBy: [1],
+                isComputedVisible: false,
+                transform: Transform.EMPTY,
+                inputWindowInfo: {
+                  inputConfig: 0,
+                  visible: false,
+                },
+              } as android.surfaceflinger.ILayerProto,
+            },
+          ],
+        },
+        {
+          id: 3,
+          name: 'wallpaper',
+          properties: {
+            id: 3,
+            name: 'layer3',
+            cornerRadius: 2,
+            layerStack: 0,
+            bounds: {left: -999, top: -999, right: 999, bottom: 999},
+            screenBounds: {left: 0, top: 0, right: 2, bottom: 2},
+            zOrderPath: [0],
+            isComputedVisible: false,
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: InputConfig.IS_WALLPAPER,
+              visible: true,
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 4,
+          name: 'layerRelativeZ',
+          properties: {
+            id: 4,
+            name: 'layerRelativeZ',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [0, 2],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: 0,
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 5,
+          name: 'noInputLayer',
+          properties: {
+            id: 5,
+            name: 'noInputLayer',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [0],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {},
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 6,
+          name: 'notTouchableLayer',
+          properties: {
+            id: 6,
+            name: 'notTouchableLayer',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [0, 2],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: InputConfig.NOT_TOUCHABLE,
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 7,
+          name: 'touchableLayer',
+          properties: {
+            id: 7,
+            name: 'touchableLayer',
+            cornerRadius: 0,
+            layerStack: 0,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [0, 2],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: 0,
+              touchableRegion: {
+                rect: [
+                  {
+                    left: 0,
+                    top: 0,
+                    right: 2,
+                    bottom: 2,
+                  },
+                ],
+              },
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
+        {
+          id: 8,
+          name: 'touchableLayer',
+          properties: {
+            id: 8,
+            name: 'touchableLayer',
+            cornerRadius: 0,
+            layerStack: 1,
+            bounds: {left: 0, top: 0, right: 5, bottom: 5},
+            screenBounds: {left: 0, top: 0, right: 5, bottom: 5},
+            zOrderPath: [0, 2],
+            isComputedVisible: true,
+            color: {r: 0, g: 0, b: 0, a: 1},
+            transform: Transform.EMPTY,
+            inputWindowInfo: {
+              inputConfig: 0,
+              touchableRegion: {
+                rect: [
+                  {
+                    left: 0,
+                    top: 0,
+                    right: 2,
+                    bottom: 2,
+                  },
+                ],
+              },
+            },
+          } as android.surfaceflinger.ILayerProto,
+        },
+      ])
+      .build();
+
+    const expectedInputRects: TraceRect[] = [
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(1)
+        .setHeight(1)
+        .setId('1')
+        .setName('layer1')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(true)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(2)
+        .setHeight(2)
+        .setId('2')
+        .setName('layer2')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(2)
+        .setGroupId(0)
+        .setIsVisible(false)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      // This is a wallpaper window, so it is cropped to display bounds.
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('3')
+        .setName('layer3')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(3)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('4')
+        .setName('layerRelativeZ')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(4)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('6')
+        .setName('notTouchableLayer')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(5)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .setFillRegion(Region.createEmpty())
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('7')
+        .setName('touchableLayer')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(6)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .setFillRegion(new Region([new Rect(0, 0, 2, 2)]))
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('8')
+        .setName('touchableLayer')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(1)
+        .setIsVisible(true)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .setFillRegion(new Region([new Rect(0, 0, 2, 2)]))
+        .build(),
+    ];
+
+    const expectedDisplayRects = [
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('Display - 1')
+        .setName('Test Display')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(0)
+        .setGroupId(0)
+        .setIsVisible(false)
+        .setIsDisplay(true)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('Display - 2')
+        .setName('Test Display 2')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(1)
+        .setIsVisible(false)
+        .setIsDisplay(true)
+        .setIsSpy(false)
+        .build(),
+    ];
+
+    computation.setRoot(hierarchyRoot).executeInPlace();
+    checkInputRects(hierarchyRoot, expectedInputRects);
+    expect(hierarchyRoot.getRects()).toEqual(expectedDisplayRects);
+  });
+
+  function checkRects(
+    hierarchyRoot: HierarchyTreeNode,
+    expectedRects: TraceRect[],
+    usePrimaryRects: boolean,
+  ) {
+    const rects: TraceRect[] = [];
+    hierarchyRoot.forEachNodeDfs((node) => {
+      if (node.id === 'LayerTraceEntry root') {
+        return;
+      }
+      const nodeRects = usePrimaryRects
+        ? node.getRects()
+        : node.getSecondaryRects();
+      if (nodeRects) rects.push(...nodeRects);
+    });
+    expect(rects).toEqual(expectedRects);
+  }
+
+  function checkLayerRects(
+    hierarchyRoot: HierarchyTreeNode,
+    expectedRects: TraceRect[],
+  ) {
+    checkRects(hierarchyRoot, expectedRects, true);
+  }
+
+  function checkInputRects(
+    hierarchyRoot: HierarchyTreeNode,
+    expectedRects: TraceRect[],
+  ) {
+    checkRects(hierarchyRoot, expectedRects, false);
+  }
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
index 07d13b98f..9bcb54738 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation.ts
@@ -15,17 +15,19 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
 import {RawDataUtils} from 'parsers/raw_data_utils';
 import {LayerFlag} from 'parsers/surface_flinger/layer_flag';
 import {
   Transform,
-  TransformUtils,
+  TransformType,
 } from 'parsers/surface_flinger/transform_utils';
+import {GeometryFactory} from 'trace/geometry_factory';
 import {Computation} from 'trace/tree_node/computation';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
+import {LayerExtractor} from './layer_extractor';
 
 export class VisibilityPropertiesComputation implements Computation {
   private root: HierarchyTreeNode | undefined;
@@ -41,25 +43,21 @@ export class VisibilityPropertiesComputation implements Computation {
 
   executeInPlace(): void {
     if (!this.root || !this.rootLayers) {
-      throw Error('root not set');
+      throw new Error('root not set in SF visibility computation');
     }
 
     this.displays =
       this.root.getEagerPropertyByName('displays')?.getAllChildren().slice() ??
       [];
 
-    const sortedLayers = this.rootLayers.sort(this.sortLayerZ);
-
-    const rootLayersOrderedByZ = sortedLayers
-      .flatMap((layer) => {
-        return this.layerTopDownTraversal(layer);
-      })
-      .reverse();
+    const layersOrderedByZ = LayerExtractor.extractLayersSortedByZ(
+      assertDefined(this.root),
+    );
 
     const opaqueLayers: HierarchyTreeNode[] = [];
-    const transparentLayers: HierarchyTreeNode[] = [];
+    const translucentLayers: HierarchyTreeNode[] = [];
 
-    for (const layer of rootLayersOrderedByZ) {
+    for (const layer of layersOrderedByZ) {
       let isVisible = this.getIsVisible(layer);
       if (!isVisible) {
         layer.addEagerProperty(
@@ -72,103 +70,112 @@ export class VisibilityPropertiesComputation implements Computation {
         layer.addEagerProperty(
           DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
             layer.id,
-            'visibilityReason',
-            this.getVisibilityReasons(layer),
+            'isHiddenByPolicy',
+            this.isHiddenByPolicy(layer),
           ),
         );
-        continue;
-      }
+      } else {
+        const displaySize = this.getDisplaySize(layer);
+
+        const occludedBy = opaqueLayers
+          .filter((other) => {
+            if (
+              this.getDefinedValue(other, 'layerStack') !==
+              this.getDefinedValue(layer, 'layerStack')
+            ) {
+              return false;
+            }
+            if (!this.layerContains(other, layer, displaySize)) {
+              return false;
+            }
+            const cornerRadiusOther = this.getDefinedValue(
+              other,
+              'cornerRadius',
+            );
+
+            return (
+              cornerRadiusOther <= 0 ||
+              cornerRadiusOther === this.getDefinedValue(layer, 'cornerRadius')
+            );
+          })
+          .map((other) => other.id);
+
+        if (occludedBy.length > 0) {
+          isVisible = false;
+        }
 
-      const displaySize = this.getDisplaySize(layer);
-
-      const occludedBy = opaqueLayers
-        .filter((other) => {
-          if (
-            this.getDefinedValue(other, 'layerStack') !==
-            this.getDefinedValue(layer, 'layerStack')
-          ) {
-            return false;
-          }
-          if (!this.layerContains(other, layer, displaySize)) {
-            return false;
-          }
-          const cornerRadiusOther =
-            other.getEagerPropertyByName('cornerRadius')?.getValue() ?? 0;
-
-          return (
-            cornerRadiusOther <= 0 ||
-            (cornerRadiusOther ===
-              layer.getEagerPropertyByName('cornerRadius')?.getValue() ??
-              0)
-          );
-        })
-        .map((other) => other.id);
-
-      if (occludedBy.length > 0) {
-        isVisible = false;
-      }
+        layer.addEagerProperty(
+          DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+            layer.id,
+            'isComputedVisible',
+            isVisible,
+          ),
+        );
+        layer.addEagerProperty(
+          DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+            layer.id,
+            'occludedBy',
+            occludedBy,
+          ),
+        );
 
-      layer.addEagerProperty(
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          layer.id,
-          'isComputedVisible',
-          isVisible,
-        ),
-      );
-      layer.addEagerProperty(
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          layer.id,
-          'occludedBy',
-          occludedBy,
-        ),
-      );
+        const partiallyOccludedBy = opaqueLayers
+          .filter((other) => {
+            if (
+              this.getDefinedValue(other, 'layerStack') !==
+              this.getDefinedValue(layer, 'layerStack')
+            ) {
+              return false;
+            }
+            if (!this.layerOverlaps(other, layer, displaySize)) {
+              return false;
+            }
+            return !occludedBy.includes(other.id);
+          })
+          .map((other) => other.id);
 
-      const partiallyOccludedBy = opaqueLayers
-        .filter((other) => {
-          if (
-            this.getDefinedValue(other, 'layerStack') !==
-            this.getDefinedValue(layer, 'layerStack')
-          ) {
-            return false;
-          }
-          if (!this.layerOverlaps(other, layer, displaySize)) {
-            return false;
-          }
-          return !occludedBy.includes(other.id);
-        })
-        .map((other) => other.id);
-
-      layer.addEagerProperty(
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          layer.id,
-          'partiallyOccludedBy',
-          partiallyOccludedBy,
-        ),
-      );
+        layer.addEagerProperty(
+          DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+            layer.id,
+            'partiallyOccludedBy',
+            partiallyOccludedBy,
+          ),
+        );
 
-      const coveredBy = transparentLayers
-        .filter((other) => {
-          if (
-            this.getDefinedValue(other, 'layerStack') !==
-            this.getDefinedValue(layer, 'layerStack')
-          ) {
-            return false;
-          }
-          return this.layerOverlaps(other, layer, displaySize);
-        })
-        .map((other) => other.id);
-
-      layer.addEagerProperty(
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          layer.id,
-          'coveredBy',
-          coveredBy,
-        ),
-      );
+        const coveredBy = translucentLayers
+          .filter((other) => {
+            if (
+              this.getDefinedValue(other, 'layerStack') !==
+              this.getDefinedValue(layer, 'layerStack')
+            ) {
+              return false;
+            }
+            return this.layerOverlaps(other, layer, displaySize);
+          })
+          .map((other) => other.id);
 
-      this.isOpaque(layer)
-        ? opaqueLayers.push(layer)
-        : transparentLayers.push(layer);
+        layer.addEagerProperty(
+          DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+            layer.id,
+            'coveredBy',
+            coveredBy,
+          ),
+        );
+
+        this.isOpaque(layer)
+          ? opaqueLayers.push(layer)
+          : translucentLayers.push(layer);
+      }
+
+      if (!isVisible) {
+        layer.addEagerProperty(
+          DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+            layer.id,
+            'visibilityReason',
+            this.getVisibilityReasons(layer),
+          ),
+        );
+      }
     }
   }
 
@@ -254,10 +261,7 @@ export class VisibilityPropertiesComputation implements Computation {
       reasons.push('crop is 0x0');
     }
     const transform = layer.getEagerPropertyByName('transform');
-    if (
-      transform &&
-      !TransformUtils.isValidTransform(Transform.from(transform))
-    ) {
+    if (transform && !Transform.from(transform).matrix.isValid()) {
       reasons.push('transform is invalid');
     }
 
@@ -291,24 +295,18 @@ export class VisibilityPropertiesComputation implements Computation {
       reasons.push('null visible region');
     }
 
+    const occludedByNode = layer.getEagerPropertyByName('occludedBy');
+    if (occludedByNode && occludedByNode.getAllChildren().length > 0) {
+      reasons.push('occluded');
+    }
+
     if (reasons.length === 0) reasons.push('unknown');
     return reasons;
   }
 
-  private layerTopDownTraversal(layer: HierarchyTreeNode): HierarchyTreeNode[] {
-    const traverseList: HierarchyTreeNode[] = [layer];
-    const children: HierarchyTreeNode[] = [
-      ...layer.getAllChildren().values(),
-    ].slice();
-    children.sort(this.sortLayerZ).forEach((child) => {
-      traverseList.push(...this.layerTopDownTraversal(child));
-    });
-    return traverseList;
-  }
-
   private getRect(rectNode: PropertyTreeNode): Rect | undefined {
     if (rectNode.getAllChildren().length === 0) return undefined;
-    return Rect.from(rectNode);
+    return GeometryFactory.makeRect(rectNode);
   }
 
   private getColor(layer: HierarchyTreeNode): PropertyTreeNode | undefined {
@@ -336,15 +334,15 @@ export class VisibilityPropertiesComputation implements Computation {
   private layerContains(
     layer: HierarchyTreeNode,
     other: HierarchyTreeNode,
-    crop = new Rect(0, 0, 0, 0),
+    crop: Rect,
   ): boolean {
     if (
-      !TransformUtils.isSimpleRotation(
+      !TransformType.isSimpleRotation(
         assertDefined(layer.getEagerPropertyByName('transform'))
           .getChildByName('type')
           ?.getValue() ?? 0,
       ) ||
-      !TransformUtils.isSimpleRotation(
+      !TransformType.isSimpleRotation(
         assertDefined(other.getEagerPropertyByName('transform'))
           .getChildByName('type')
           ?.getValue() ?? 0,
@@ -363,7 +361,7 @@ export class VisibilityPropertiesComputation implements Computation {
   private layerOverlaps(
     layer: HierarchyTreeNode,
     other: HierarchyTreeNode,
-    crop = new Rect(0, 0, 0, 0),
+    crop: Rect,
   ): boolean {
     const layerBounds = this.getCroppedScreenBounds(layer, crop);
     const otherBounds = this.getCroppedScreenBounds(other, crop);
@@ -443,13 +441,6 @@ export class VisibilityPropertiesComputation implements Computation {
     );
   }
 
-  private sortLayerZ(a: HierarchyTreeNode, b: HierarchyTreeNode): number {
-    return a.getEagerPropertyByName('z')?.getValue() <
-      b.getEagerPropertyByName('z')?.getValue()
-      ? -1
-      : 1;
-  }
-
   private getDefinedValue(
     node: HierarchyTreeNode | PropertyTreeNode,
     name: string,
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
index ca92d01d3..f0520da99 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/visibility_properties_computation_test.ts
@@ -17,18 +17,51 @@
 import {assertDefined} from 'common/assert_utils';
 import {LayerFlag} from 'parsers/surface_flinger/layer_flag';
 import {android} from 'protos/surfaceflinger/udc/static';
-import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {
+  ChildHierarchy,
+  HierarchyTreeBuilder,
+} from 'test/unit/hierarchy_tree_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {VisibilityPropertiesComputation} from './visibility_properties_computation';
 import {ZOrderPathsComputation} from './z_order_paths_computation';
 
 describe('VisibilityPropertiesComputation', () => {
   let computation: VisibilityPropertiesComputation;
+  const rect1x1 = {left: 0, top: 0, bottom: 1, right: 1};
+  const rect2x2 = {left: 0, top: 0, bottom: 2, right: 2};
+  const rect5x5 = {left: 0, right: 5, top: 0, bottom: 5};
+
+  const commonProperties: android.surfaceflinger.ILayerProto = {
+    cornerRadius: 0,
+    shadowRadius: 0,
+    backgroundBlurRadius: 0,
+    transform: {
+      type: 0,
+      dsdx: 1,
+      dtdx: 0,
+      dsdy: 0,
+      dtdy: 1,
+    },
+  };
+
+  const visibleLayerProperties: android.surfaceflinger.ILayerProto =
+    Object.assign(
+      {
+        flags: 0,
+        activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
+        color: {r: 0, g: 0, b: 0, a: 1},
+      },
+      commonProperties,
+    );
 
   beforeEach(() => {
     computation = new VisibilityPropertiesComputation();
   });
 
+  it('throws error if root not set', () => {
+    expect(() => computation.executeInPlace()).toThrowError();
+  });
+
   it('detects visible layer due to non-empty visible region', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
@@ -37,30 +70,20 @@ describe('VisibilityPropertiesComputation', () => {
         {
           id: 1,
           name: 'layerVisibleRegionNonEmpty',
-          properties: {
-            id: 1,
-            name: 'layerVisibleRegionNonEmpty',
-            parent: -1,
-            children: [],
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 1,
+              name: 'layerVisibleRegionNonEmpty',
+              parent: -1,
+              children: [],
+              visibleRegion: {rect: [rect1x1]},
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            visibleLayerProperties,
+          ),
         },
       ])
       .build();
@@ -84,34 +107,7 @@ describe('VisibilityPropertiesComputation', () => {
       .setId('LayerTraceEntry')
       .setName('root')
       .setChildren([
-        {
-          id: 1,
-          name: 'layerHiddenByPolicy',
-          properties: {
-            id: 1,
-            name: 'layerHiddenByPolicy',
-            parent: -1,
-            children: [],
-            flags: LayerFlag.HIDDEN,
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyForHiddenLayer(1, 'layerHiddenByPolicy', []),
       ])
       .build();
 
@@ -125,6 +121,11 @@ describe('VisibilityPropertiesComputation', () => {
       ).getValue(),
     ).toBeFalse();
     expect(getVisibilityReasons(invisibleLayer)).toEqual(['flag is hidden']);
+    expect(
+      assertDefined(
+        invisibleLayer.getEagerPropertyByName('isHiddenByPolicy'),
+      ).getValue(),
+    ).toBeTrue();
   });
 
   it('detects non-visible layer that is hidden by parent, even if rel-z parent is not hidden', () => {
@@ -132,107 +133,66 @@ describe('VisibilityPropertiesComputation', () => {
       .setId('LayerTraceEntry')
       .setName('root')
       .setChildren([
-        {
-          id: 1,
-          name: 'parent',
-          properties: {
-            id: 1,
-            name: 'parent',
-            parent: -1,
-            children: [2],
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            flags: LayerFlag.HIDDEN,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
-          children: [
-            {
-              id: 2,
-              name: 'childHiddenByParent',
-              properties: {
+        getChildHierarchyForHiddenLayer(1, 'parent', [
+          {
+            id: 2,
+            name: 'childHiddenByParent',
+            properties: Object.assign(
+              {
                 id: 2,
                 name: 'childHiddenByParent',
                 parent: 1,
                 children: [],
-                flags: 0,
-                visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-                activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-                color: {r: 0, g: 0, b: 0, a: 1},
-                cornerRadius: 0,
-                shadowRadius: 0,
-                backgroundBlurRadius: 0,
+                visibleRegion: {rect: [rect1x1]},
                 layerStack: 0,
-                z: 0,
+                zOrderPath: [0, 0],
                 zOrderRelativeOf: 3,
-                transform: {
-                  type: 0,
-                  dsdx: 1,
-                  dtdx: 0,
-                  dsdy: 0,
-                  dtdy: 1,
-                },
                 screenBounds: null,
                 isOpaque: false,
               } as android.surfaceflinger.ILayerProto,
-            },
-          ],
-        },
+              visibleLayerProperties,
+            ),
+          },
+        ]),
         {
           id: 3,
           name: 'relZParent',
-          properties: {
-            id: 3,
-            name: 'relZParent',
-            parent: -1,
-            children: [],
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 3,
+              name: 'relZParent',
+              parent: -1,
+              children: [],
+              visibleRegion: {rect: [rect1x1]},
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            visibleLayerProperties,
+          ),
         },
       ])
       .build();
     new ZOrderPathsComputation().setRoot(hierarchyRoot).executeInPlace();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    const visibleLayer = assertDefined(hierarchyRoot.getChildByName('parent'));
+    const nonVisibleLayer = assertDefined(
+      hierarchyRoot.getChildByName('parent'),
+    );
     expect(
       assertDefined(
-        visibleLayer.getEagerPropertyByName('isComputedVisible'),
+        nonVisibleLayer.getEagerPropertyByName('isComputedVisible'),
       ).getValue(),
     ).toBeFalse();
+    expect(
+      assertDefined(
+        nonVisibleLayer.getEagerPropertyByName('isHiddenByPolicy'),
+      ).getValue(),
+    ).toBeTrue();
 
     const hiddenLayer = assertDefined(
-      visibleLayer.getChildByName('childHiddenByParent'),
+      nonVisibleLayer.getChildByName('childHiddenByParent'),
     );
     expect(
       assertDefined(
@@ -240,6 +200,11 @@ describe('VisibilityPropertiesComputation', () => {
       ).getValue(),
     ).toBeFalse();
     expect(getVisibilityReasons(hiddenLayer)).toEqual(['hidden by parent 1']);
+    expect(
+      assertDefined(
+        hiddenLayer.getEagerPropertyByName('isHiddenByPolicy'),
+      ).getValue(),
+    ).toBeFalse();
   });
 
   it('detects non-visible layer due to zero alpha', () => {
@@ -250,30 +215,23 @@ describe('VisibilityPropertiesComputation', () => {
         {
           id: 1,
           name: 'layerZeroAlpha',
-          properties: {
-            id: 1,
-            name: 'layerZeroAlpha',
-            parent: -1,
-            children: [],
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 0},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 1,
+              name: 'layerZeroAlpha',
+              parent: -1,
+              children: [],
+              visibleRegion: {rect: [rect1x1]},
+              activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
+              flags: 0,
+              color: {r: 0, g: 0, b: 0, a: 0},
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            commonProperties,
+          ),
         },
       ])
       .build();
@@ -291,56 +249,30 @@ describe('VisibilityPropertiesComputation', () => {
     expect(getVisibilityReasons(layerZeroAlpha)).toEqual(['alpha is 0']);
   });
 
-  it('detects non-visible layer due to null active buffer and no effects', () => {
+  it('detects non-visible layer due to null, undefined or empty active buffer and no effects', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
       .setChildren([
-        {
-          id: 1,
-          name: 'layerNoActiveBuffer',
-          properties: {
-            id: 1,
-            name: 'layerNoActiveBuffer',
-            parent: -1,
-            children: [],
-            activeBuffer: null,
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 0},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyWithActiveBuffer(1, 'layerNullActiveBuffer', null),
+        getChildHierarchyWithActiveBuffer(
+          2,
+          'layerMissingActiveBuffer',
+          undefined,
+        ),
+        getChildHierarchyWithActiveBuffer(3, 'layerEmptyActiveBuffer', {
+          width: 0,
+          height: 0,
+          stride: 0,
+          format: 0,
+        }),
       ])
       .build();
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    const invisibleLayer = assertDefined(
-      hierarchyRoot.getChildByName('layerNoActiveBuffer'),
-    );
-    expect(
-      assertDefined(
-        invisibleLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeFalse();
-    expect(getVisibilityReasons(invisibleLayer)).toEqual([
-      'buffer is empty',
-      'alpha is 0',
-      'does not have color fill, shadow or blur',
-    ]);
+    checkInvisibleDueToActiveBuffer(hierarchyRoot, 'layerNullActiveBuffer');
+    checkInvisibleDueToActiveBuffer(hierarchyRoot, 'layerMissingActiveBuffer');
+    checkInvisibleDueToActiveBuffer(hierarchyRoot, 'layerEmptyActiveBuffer');
   });
 
   it('detects non-visible layer due to empty bounds', () => {
@@ -351,32 +283,22 @@ describe('VisibilityPropertiesComputation', () => {
         {
           id: 1,
           name: 'layerEmptyBounds',
-          properties: {
-            id: 1,
-            name: 'layerEmptyBounds',
-            parent: -1,
-            children: [],
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 1}]},
-            bounds: {left: 0, right: 0, top: 0, bottom: 0},
-            excludesCompositionState: true,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 1,
+              name: 'layerEmptyBounds',
+              parent: -1,
+              children: [],
+              visibleRegion: {rect: [rect1x1]},
+              bounds: {left: 0, right: 0, top: 0, bottom: 0},
+              excludesCompositionState: true,
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            visibleLayerProperties,
+          ),
         },
       ])
       .build();
@@ -401,30 +323,20 @@ describe('VisibilityPropertiesComputation', () => {
         {
           id: 1,
           name: 'layerNoVisibleRegion',
-          properties: {
-            id: 1,
-            name: 'layerNoVisibleRegion',
-            parent: -1,
-            children: [],
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            visibleRegion: null,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 1,
+              name: 'layerNoVisibleRegion',
+              parent: -1,
+              children: [],
+              visibleRegion: null,
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            visibleLayerProperties,
+          ),
         },
       ])
       .build();
@@ -451,30 +363,20 @@ describe('VisibilityPropertiesComputation', () => {
         {
           id: 1,
           name: 'layerEmptyVisibleRegion',
-          properties: {
-            id: 1,
-            name: 'layerEmptyVisibleRegion',
-            parent: -1,
-            children: [],
-            visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 0}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            cornerRadius: 0,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            layerStack: 0,
-            z: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-            screenBounds: null,
-            isOpaque: false,
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 1,
+              name: 'layerEmptyVisibleRegion',
+              parent: -1,
+              children: [],
+              visibleRegion: {rect: [{left: 0, right: 1, top: 0, bottom: 0}]},
+              layerStack: 0,
+              zOrderPath: [0],
+              screenBounds: null,
+              isOpaque: false,
+            } as android.surfaceflinger.ILayerProto,
+            visibleLayerProperties,
+          ),
         },
       ])
       .build();
@@ -493,7 +395,7 @@ describe('VisibilityPropertiesComputation', () => {
     ]);
   });
 
-  it('adds occludedBy layers and updates isVisible', () => {
+  it('adds occludedBy layers and updates isVisible and visibilityReason', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -501,67 +403,13 @@ describe('VisibilityPropertiesComputation', () => {
         displays: [
           {
             layerStack: 0,
-            layerStackSpaceRect: {left: 0, right: 5, top: 0, bottom: 5},
+            layerStackSpaceRect: rect5x5,
           },
         ],
       })
       .setChildren([
-        {
-          id: 1,
-          name: 'occludedLayer',
-          properties: {
-            id: 1,
-            name: 'occludedLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: true,
-            z: 0,
-            screenBounds: {left: 0, top: 0, bottom: 1, right: 1},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 1, right: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'occludingLayer',
-          properties: {
-            id: 2,
-            name: 'occludingLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: true,
-            z: 1,
-            screenBounds: {left: 0, top: 0, bottom: 2, right: 2},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 2, right: 2}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', [0], rect1x1),
+        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', [1], rect2x2),
       ])
       .build();
 
@@ -574,35 +422,8 @@ describe('VisibilityPropertiesComputation', () => {
       hierarchyRoot.getChildByName('occludingLayer'),
     );
 
-    expect(
-      assertDefined(
-        invisibleLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeFalse();
-    expect(
-      invisibleLayer
-        .getEagerPropertyByName('occludedBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('2 occludingLayer');
-    expect(
-      invisibleLayer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      invisibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
-
-    expect(
-      assertDefined(
-        visibleLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeTrue();
-    expect(
-      visibleLayer.getEagerPropertyByName('occludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      visibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+    checkOccludedLayer(invisibleLayer, ['2 occludingLayer'], []);
+    checkVisibleLayer(visibleLayer, [], []);
   });
 
   it('distinguishes occluding and covering layers by alpha', () => {
@@ -613,94 +434,33 @@ describe('VisibilityPropertiesComputation', () => {
         displays: [
           {
             layerStack: 0,
-            layerStackSpaceRect: {left: 0, right: 5, top: 0, bottom: 5},
+            layerStackSpaceRect: rect5x5,
           },
         ],
       })
       .setChildren([
-        {
-          id: 1,
-          name: 'occludedLayer',
-          properties: {
-            id: 1,
-            name: 'occludedLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            z: 0,
-            screenBounds: {left: 0, top: 0, bottom: 1, right: 1},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 1, right: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            isOpaque: true,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'occludingLayer',
-          properties: {
-            id: 2,
-            name: 'occludingLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            z: 1,
-            screenBounds: {left: 0, top: 0, bottom: 2, right: 2},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 2, right: 2}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            isOpaque: true,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyForOpaqueLayer(1, 'occludedLayer', [0], rect1x1),
+        getChildHierarchyForOpaqueLayer(2, 'occludingLayer', [1], rect2x2),
         {
           id: 3,
           name: 'coveringLayer',
-          properties: {
-            id: 3,
-            name: 'coveringLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            z: 2,
-            screenBounds: {left: 0, top: 0, bottom: 2, right: 2},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 2, right: 2}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 0.5},
-            isOpaque: true,
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
+          properties: Object.assign(
+            {
+              id: 3,
+              name: 'coveringLayer',
+              parent: -1,
+              children: [],
+              layerStack: 0,
+              zOrderPath: [2],
+              screenBounds: rect2x2,
+              visibleRegion: {rect: [rect2x2]},
+              activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
+              flags: 0,
+              color: {r: 0, g: 0, b: 0, a: 0.5},
+              isOpaque: true,
+            } as android.surfaceflinger.ILayerProto,
+            commonProperties,
+          ),
         },
       ])
       .build();
@@ -717,80 +477,48 @@ describe('VisibilityPropertiesComputation', () => {
       hierarchyRoot.getChildByName('coveringLayer'),
     );
 
-    expect(
-      assertDefined(
-        occludedLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeFalse();
-    expect(
-      occludedLayer.getEagerPropertyByName('occludedBy')?.getAllChildren()
-        .length,
-    ).toEqual(1);
-    expect(
-      occludedLayer
-        .getEagerPropertyByName('occludedBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('2 occludingLayer');
-    expect(
-      coveringLayer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      occludedLayer.getEagerPropertyByName('coveredBy')?.getAllChildren()
-        .length,
-    ).toEqual(1);
-    expect(
-      occludedLayer
-        .getEagerPropertyByName('coveredBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('3 coveringLayer');
-    expect(
-      occludedLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+    checkOccludedLayer(
+      occludedLayer,
+      ['2 occludingLayer'],
+      ['3 coveringLayer'],
+    );
+    checkVisibleLayer(occludingLayer, [], ['3 coveringLayer']);
+    checkVisibleLayer(coveringLayer, [], []);
+  });
 
-    expect(
-      assertDefined(
-        occludingLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeTrue();
-    expect(
-      occludingLayer.getEagerPropertyByName('occludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      coveringLayer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      occludingLayer.getEagerPropertyByName('coveredBy')?.getAllChildren()
-        .length,
-    ).toEqual(1);
-    expect(
-      occludingLayer
-        .getEagerPropertyByName('coveredBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('3 coveringLayer');
-    expect(
-      occludingLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+  it('accounts for layer stack in occlusion calculations', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setProperties({
+        displays: [
+          {
+            layerStack: 0,
+            layerStackSpaceRect: rect5x5,
+          },
+          {
+            layerStack: 1,
+            layerStackSpaceRect: rect5x5,
+          },
+        ],
+      })
+      .setChildren([
+        getChildHierarchyForOpaqueLayer(1, 'visibleLayer1', [0], rect1x1, 0),
+        getChildHierarchyForOpaqueLayer(2, 'visibleLayer2', [0], rect1x1, 1),
+      ])
+      .build();
 
-    expect(
-      assertDefined(
-        coveringLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeTrue();
-    expect(
-      coveringLayer.getEagerPropertyByName('occludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      coveringLayer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      coveringLayer.getEagerPropertyByName('coveredBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      coveringLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+    computation.setRoot(hierarchyRoot).executeInPlace();
+
+    const visibleLayer1 = assertDefined(
+      hierarchyRoot.getChildByName('visibleLayer1'),
+    );
+    const visibleLayer2 = assertDefined(
+      hierarchyRoot.getChildByName('visibleLayer2'),
+    );
+
+    checkVisibleLayer(visibleLayer1, [], []);
+    checkVisibleLayer(visibleLayer2, [], []);
   });
 
   it('adds partiallyOccludedBy layers and updates isVisible', () => {
@@ -801,67 +529,29 @@ describe('VisibilityPropertiesComputation', () => {
         displays: [
           {
             layerStack: 0,
-            layerStackSpaceRect: {left: 0, right: 5, top: 0, bottom: 5},
+            layerStackSpaceRect: rect5x5,
           },
         ],
       })
       .setChildren([
-        {
-          id: 1,
-          name: 'partiallyOccludedLayer',
-          properties: {
-            id: 1,
-            name: 'partiallyOccludedLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: true,
-            z: 0,
-            screenBounds: {left: 0, top: 0, bottom: 2, right: 2},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 2, right: 2}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'partiallyOccludingLayer',
-          properties: {
-            id: 2,
-            name: 'partiallyOccludingLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: true,
-            z: 1,
-            screenBounds: {left: 0, top: 0, bottom: 1, right: 1},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 1, right: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 1,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyForOpaqueLayer(
+          1,
+          'partiallyOccludedLayer',
+          [0],
+          rect2x2,
+        ),
+        getChildHierarchyForOpaqueLayer(
+          2,
+          'partiallyOccludingLayer',
+          [1],
+          rect1x1,
+        ),
+        getChildHierarchyForOpaqueLayer(3, 'nonOccludingLayer', [1], {
+          left: 3,
+          top: 3,
+          bottom: 4,
+          right: 4,
+        }),
       ])
       .build();
 
@@ -873,33 +563,13 @@ describe('VisibilityPropertiesComputation', () => {
     const visibleLayer = assertDefined(
       hierarchyRoot.getChildByName('partiallyOccludingLayer'),
     );
+    const nonOccludingLayer = assertDefined(
+      hierarchyRoot.getChildByName('nonOccludingLayer'),
+    );
 
-    expect(
-      assertDefined(
-        partiallyVisibleLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeTrue();
-    expect(
-      partiallyVisibleLayer
-        .getEagerPropertyByName('partiallyOccludedBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('2 partiallyOccludingLayer');
-    expect(
-      visibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
-
-    expect(
-      assertDefined(
-        visibleLayer.getEagerPropertyByName('isComputedVisible'),
-      ).getValue(),
-    ).toBeTrue();
-    expect(
-      visibleLayer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
-    ).toEqual([]);
-    expect(
-      visibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+    checkVisibleLayer(partiallyVisibleLayer, ['2 partiallyOccludingLayer'], []);
+    checkVisibleLayer(visibleLayer, [], []);
+    checkVisibleLayer(nonOccludingLayer, [], []);
   });
 
   it('adds coveredByLayers layers and updates isVisible', () => {
@@ -910,67 +580,13 @@ describe('VisibilityPropertiesComputation', () => {
         displays: [
           {
             layerStack: 0,
-            layerStackSpaceRect: {left: 0, right: 5, top: 0, bottom: 5},
+            layerStackSpaceRect: rect5x5,
           },
         ],
       })
       .setChildren([
-        {
-          id: 1,
-          name: 'coveredLayer',
-          properties: {
-            id: 1,
-            name: 'coveredLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: false,
-            z: 0,
-            screenBounds: {left: 0, top: 0, bottom: 2, right: 2},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 2, right: 2}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
-        {
-          id: 2,
-          name: 'coveringLayer',
-          properties: {
-            id: 2,
-            name: 'coveringLayer',
-            parent: -1,
-            children: [],
-            layerStack: 0,
-            isOpaque: false,
-            z: 1,
-            screenBounds: {left: 0, top: 0, bottom: 1, right: 1},
-            visibleRegion: {rect: [{left: 0, top: 0, bottom: 1, right: 1}]},
-            activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
-            cornerRadius: 0,
-            flags: 0,
-            color: {r: 0, g: 0, b: 0, a: 1},
-            shadowRadius: 0,
-            backgroundBlurRadius: 0,
-            transform: {
-              type: 0,
-              dsdx: 1,
-              dtdx: 0,
-              dsdy: 0,
-              dtdy: 1,
-            },
-          } as android.surfaceflinger.ILayerProto,
-        },
+        getChildHierarchyForTranslucentLayer(1, 'coveredLayer', [0], rect2x2),
+        getChildHierarchyForTranslucentLayer(2, 'coveringLayer', [1], rect1x1),
       ])
       .build();
 
@@ -983,37 +599,226 @@ describe('VisibilityPropertiesComputation', () => {
       hierarchyRoot.getChildByName('coveringLayer'),
     );
 
+    checkVisibleLayer(coveredVisibleLayer, [], ['2 coveringLayer']);
+    checkVisibleLayer(visibleLayer, [], []);
+  });
+
+  it('computes occlusion state based on z order path', () => {
+    const hierarchyRoot = new HierarchyTreeBuilder()
+      .setId('LayerTraceEntry')
+      .setName('root')
+      .setProperties({
+        displays: [
+          {
+            layerStack: 0,
+            layerStackSpaceRect: rect5x5,
+          },
+        ],
+      })
+      .setChildren([
+        getChildHierarchyForOpaqueLayer(1, 'occludingLayer', [1], rect2x2),
+        getChildHierarchyForOpaqueLayer(2, 'occludedLayer', [0], rect1x1),
+      ])
+      .build();
+
+    computation.setRoot(hierarchyRoot).executeInPlace();
+
+    const invisibleLayer = assertDefined(
+      hierarchyRoot.getChildByName('occludedLayer'),
+    );
+    const visibleLayer = assertDefined(
+      hierarchyRoot.getChildByName('occludingLayer'),
+    );
+
+    checkOccludedLayer(invisibleLayer, ['1 occludingLayer'], []);
+    checkVisibleLayer(visibleLayer, [], []);
+  });
+
+  function getChildHierarchyForHiddenLayer(
+    id: number,
+    name: string,
+    children: ChildHierarchy[],
+  ): ChildHierarchy {
+    return {
+      id,
+      name,
+      properties: Object.assign(
+        {
+          id,
+          name,
+          parent: -1,
+          children: children.map((c) => c.id),
+          flags: LayerFlag.HIDDEN,
+          visibleRegion: {rect: [rect1x1]},
+          activeBuffer: {width: 1, height: 1, stride: 1, format: 1},
+          color: {r: 0, g: 0, b: 0, a: 1},
+          layerStack: 0,
+          zOrderPath: [0],
+          screenBounds: null,
+          isOpaque: false,
+        } as android.surfaceflinger.ILayerProto,
+        commonProperties,
+      ),
+      children,
+    };
+  }
+
+  function getChildHierarchyWithActiveBuffer(
+    id: number,
+    name: string,
+    activeBuffer: android.surfaceflinger.IActiveBufferProto | null | undefined,
+  ): ChildHierarchy {
+    return {
+      id,
+      name,
+      properties: Object.assign(
+        {
+          id,
+          name,
+          parent: -1,
+          children: [],
+          visibleRegion: {rect: [rect1x1]},
+          flags: 0,
+          color: {r: 0, g: 0, b: 0, a: 0},
+          activeBuffer,
+          layerStack: 0,
+          zOrderPath: [0],
+          screenBounds: null,
+          isOpaque: false,
+        } as android.surfaceflinger.ILayerProto,
+        commonProperties,
+      ),
+    };
+  }
+
+  function checkInvisibleDueToActiveBuffer(
+    hierarchyRoot: HierarchyTreeNode,
+    layerName: string,
+  ) {
+    const layer = assertDefined(hierarchyRoot.getChildByName(layerName));
     expect(
       assertDefined(
-        coveredVisibleLayer.getEagerPropertyByName('isComputedVisible'),
+        layer.getEagerPropertyByName('isComputedVisible'),
       ).getValue(),
-    ).toBeTrue();
+    ).toBeFalse();
+    expect(getVisibilityReasons(layer)).toEqual([
+      'buffer is empty',
+      'alpha is 0',
+      'does not have color fill, shadow or blur',
+    ]);
+  }
+
+  function getChildHierarchyForOpaqueLayer(
+    id: number,
+    name: string,
+    zOrderPath: number[],
+    bounds: android.surfaceflinger.IRectProto,
+    layerStack = 0,
+  ) {
+    return {
+      id,
+      name,
+      properties: Object.assign(
+        {
+          id,
+          name,
+          parent: -1,
+          children: [],
+          layerStack,
+          isOpaque: true,
+          zOrderPath,
+          screenBounds: bounds,
+          visibleRegion: {rect: [bounds]},
+        } as android.surfaceflinger.ILayerProto,
+        visibleLayerProperties,
+      ),
+    };
+  }
+
+  function getChildHierarchyForTranslucentLayer(
+    id: number,
+    name: string,
+    zOrderPath: number[],
+    bounds: android.surfaceflinger.IRectProto,
+    layerStack = 0,
+  ) {
+    return {
+      id,
+      name,
+      properties: Object.assign(
+        {
+          id,
+          name,
+          parent: -1,
+          children: [],
+          layerStack,
+          isOpaque: false,
+          zOrderPath,
+          screenBounds: bounds,
+          visibleRegion: {rect: [bounds]},
+        } as android.surfaceflinger.ILayerProto,
+        visibleLayerProperties,
+      ),
+    };
+  }
+
+  function getVisibilityReasons(layer: HierarchyTreeNode): string[] {
+    return assertDefined(layer.getEagerPropertyByName('visibilityReason'))
+      .getAllChildren()
+      .map((child) => child.getValue());
+  }
+
+  function checkOccludedLayer(
+    layer: HierarchyTreeNode,
+    occludedBy: string[],
+    coveredBy: string[],
+  ) {
     expect(
-      coveredVisibleLayer
-        .getEagerPropertyByName('coveredBy')
-        ?.getChildByName('0')
-        ?.getValue(),
-    ).toEqual('2 coveringLayer');
+      assertDefined(
+        layer.getEagerPropertyByName('isComputedVisible'),
+      ).getValue(),
+    ).toBeFalse();
+    expect(getVisibilityReasons(layer)).toEqual(['occluded']);
     expect(
-      visibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
+      layer
+        .getEagerPropertyByName('occludedBy')
+        ?.getAllChildren()
+        .map((c) => c.getValue()),
+    ).toEqual(occludedBy);
+    expect(
+      layer.getEagerPropertyByName('partiallyOccludedBy')?.getValue(),
+    ).toEqual([]);
+    expect(
+      layer
+        .getEagerPropertyByName('coveredBy')
+        ?.getAllChildren()
+        .map((c) => c.getValue()),
+    ).toEqual(coveredBy);
+  }
 
+  function checkVisibleLayer(
+    layer: HierarchyTreeNode,
+    partiallyOccludedBy: string[],
+    coveredBy: string[],
+  ) {
     expect(
       assertDefined(
-        visibleLayer.getEagerPropertyByName('isComputedVisible'),
+        layer.getEagerPropertyByName('isComputedVisible'),
       ).getValue(),
     ).toBeTrue();
+    expect(layer.getEagerPropertyByName('occludedBy')?.getValue()).toEqual([]);
+    expect(layer.getEagerPropertyByName('visibilityReason')).toBeUndefined();
     expect(
-      visibleLayer.getEagerPropertyByName('coveredBy')?.getValue(),
-    ).toEqual([]);
+      layer
+        .getEagerPropertyByName('partiallyOccludedBy')
+        ?.getAllChildren()
+        .map((c) => c.getValue()),
+    ).toEqual(partiallyOccludedBy);
     expect(
-      visibleLayer.getEagerPropertyByName('visibilityReason'),
-    ).toBeUndefined();
-  });
-
-  function getVisibilityReasons(layer: HierarchyTreeNode): string[] {
-    return assertDefined(layer.getEagerPropertyByName('visibilityReason'))
-      .getAllChildren()
-      .map((child) => child.getValue());
+      layer
+        .getEagerPropertyByName('coveredBy')
+        ?.getAllChildren()
+        .map((c) => c.getValue()),
+    ).toEqual(coveredBy);
   }
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
index e11c8f493..7c17bc711 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation.ts
@@ -29,7 +29,7 @@ export class ZOrderPathsComputation implements Computation {
 
   executeInPlace(): void {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set in SF z-order paths computation');
     }
 
     this.updateZOrderParents(this.root);
@@ -73,6 +73,30 @@ export class ZOrderPathsComputation implements Computation {
           return;
         }
         node.setZParent(zParent);
+
+        // add rel-z children to zParent
+        const existingRelZChildren =
+          zParent.getEagerPropertyByName('relZChildren');
+        if (existingRelZChildren) {
+          zParent.addEagerProperty(
+            DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+              zParent.id,
+              'relZChildren',
+              existingRelZChildren
+                .getAllChildren()
+                .map((c) => c.getValue())
+                .concat([node.id]),
+            ),
+          );
+        } else {
+          zParent.addEagerProperty(
+            DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
+              zParent.id,
+              'relZChildren',
+              [node.id],
+            ),
+          );
+        }
       }
     });
   }
diff --git a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
index d3bd49bd2..c78db305b 100644
--- a/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/computations/z_order_paths_computation_test.ts
@@ -27,6 +27,10 @@ describe('ZOrderPathsComputation', () => {
     computation = new ZOrderPathsComputation();
   });
 
+  it('throws error if root not set', () => {
+    expect(() => computation.executeInPlace()).toThrowError();
+  });
+
   it('calculates zOrderPath for tree without rel z parent', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
@@ -115,7 +119,7 @@ describe('ZOrderPathsComputation', () => {
     ).toEqual([0, 2]);
   });
 
-  it('calculates zOrderPath for tree with rel z parent', () => {
+  it('calculates zOrderPath and adds rel z children properties for tree with rel z parent', () => {
     const hierarchyRoot = new HierarchyTreeBuilder()
       .setId('LayerTraceEntry')
       .setName('root')
@@ -156,6 +160,18 @@ describe('ZOrderPathsComputation', () => {
                 zOrderRelativeOf: 2,
               } as android.surfaceflinger.ILayerProto,
             },
+            {
+              id: 5,
+              name: 'layer5',
+              properties: {
+                id: 5,
+                name: 'layer5',
+                parent: 1,
+                children: [],
+                z: 2,
+                zOrderRelativeOf: 2,
+              } as android.surfaceflinger.ILayerProto,
+            },
           ],
         },
       ])
@@ -171,6 +187,9 @@ describe('ZOrderPathsComputation', () => {
     const layer4WithPath = assertDefined(
       layer1WithPath.getChildByName('layer4'),
     );
+    const layer5WithPath = assertDefined(
+      layer1WithPath.getChildByName('layer5'),
+    );
 
     expect(
       getZOrderPathArray(layer1WithPath.getEagerPropertyByName('zOrderPath')),
@@ -181,6 +200,25 @@ describe('ZOrderPathsComputation', () => {
     expect(
       getZOrderPathArray(layer4WithPath.getEagerPropertyByName('zOrderPath')),
     ).toEqual([0, 1, 2]);
+    expect(
+      getZOrderPathArray(layer5WithPath.getEagerPropertyByName('zOrderPath')),
+    ).toEqual([0, 1, 2]);
+
+    expect(
+      layer1WithPath.getEagerPropertyByName('relZChildren'),
+    ).toBeUndefined();
+    expect(
+      layer2WithPath
+        .getEagerPropertyByName('relZChildren')
+        ?.getAllChildren()
+        .map((c) => c.formattedValue()),
+    ).toEqual([layer4WithPath.id, layer5WithPath.id]);
+    expect(
+      layer4WithPath.getEagerPropertyByName('relZChildren'),
+    ).toBeUndefined();
+    expect(
+      layer5WithPath.getEagerPropertyByName('relZChildren'),
+    ).toBeUndefined();
   });
 
   it('adds isMissingZParent chip', () => {
diff --git a/tools/winscope/src/parsers/surface_flinger/denylist_properties.ts b/tools/winscope/src/parsers/surface_flinger/denylist_properties.ts
new file mode 100644
index 000000000..7dd94b002
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/denylist_properties.ts
@@ -0,0 +1,26 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export const DENYLIST_PROPERTIES = [
+  'length',
+  'prototype',
+  'ref',
+  'parent',
+  'timestamp',
+  'layers',
+  'children',
+  'name',
+];
diff --git a/tools/winscope/src/parsers/surface_flinger/eager_properties.ts b/tools/winscope/src/parsers/surface_flinger/eager_properties.ts
new file mode 100644
index 000000000..d5b135e16
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/eager_properties.ts
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export const EAGER_PROPERTIES = [
+  'id',
+  'name',
+  'type',
+  'parent',
+  'children',
+  'bounds',
+  'transform',
+  'position',
+  'requestedTransform',
+  'requestedPosition',
+  'bufferTransform',
+  'inputWindowInfo',
+  'flags',
+  'z',
+  'cornerRadius',
+  'layerStack',
+  'isOpaque',
+  'activeBuffer',
+  'visibleRegion',
+  'color',
+  'isRelativeOf',
+  'zOrderRelativeOf',
+  'screenBounds',
+  'shadowRadius',
+  'backgroundBlurRadius',
+  'hwcCompositionType',
+];
diff --git a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts
new file mode 100644
index 000000000..c17a58e68
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory.ts
@@ -0,0 +1,208 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {UserNotifier} from 'common/user_notifier';
+import {MissingLayerIds} from 'messaging/user_warnings';
+import {perfetto} from 'protos/surfaceflinger/latest/static';
+import {android} from 'protos/surfaceflinger/udc/static';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {
+  LazyPropertiesStrategyType,
+  PropertiesProvider,
+} from 'trace/tree_node/properties_provider';
+import {PropertiesProviderBuilder} from 'trace/tree_node/properties_provider_builder';
+import {PropertyTreeBuilderFromProto} from 'trace/tree_node/property_tree_builder_from_proto';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {COMMON_OPERATIONS} from './common_operations';
+import {RectsComputation} from './computations/rects_computation';
+import {VisibilityPropertiesComputation} from './computations/visibility_properties_computation';
+import {ZOrderPathsComputation} from './computations/z_order_paths_computation';
+import {DENYLIST_PROPERTIES} from './denylist_properties';
+import {EAGER_PROPERTIES} from './eager_properties';
+import {HierarchyTreeBuilderSf} from './hierarchy_tree_builder_sf';
+import {ParserSurfaceFlinger as LegacyParserSurfaceFlinger} from './legacy/parser_surface_flinger';
+import {ParserSurfaceFlinger as PerfettoParserSurfaceFlinger} from './perfetto/parser_surface_flinger';
+
+export class EntryHierarchyTreeFactory {
+  makeEntryHierarchyTree(
+    entryProto: EntryType,
+    layerProtos: LayerType[],
+    ParserSurfaceFlinger: ParserSurfaceFlinger,
+  ): HierarchyTreeNode {
+    const excludesCompositionState =
+      entryProto?.excludesCompositionState ?? false;
+    const addExcludesCompositionState = excludesCompositionState
+      ? COMMON_OPERATIONS.AddExcludesCompositionStateTrue
+      : COMMON_OPERATIONS.AddExcludesCompositionStateFalse;
+
+    const processed = new Map<number, number>();
+    let missingLayerIds = false;
+
+    const layers = layerProtos.reduce(
+      (allLayerProps: PropertiesProvider[], layer: LayerType) => {
+        if (layer.id === null || layer.id === undefined) {
+          missingLayerIds = true;
+          return allLayerProps;
+        }
+        const duplicateCount = processed.get(assertDefined(layer.id)) ?? 0;
+        processed.set(assertDefined(layer.id), duplicateCount + 1);
+        const eagerProperties = this.makeEagerPropertiesTree(
+          layer,
+          duplicateCount,
+        );
+        const lazyPropertiesStrategy = this.makeLayerLazyPropertiesStrategy(
+          layer,
+          duplicateCount,
+        );
+
+        const layerProps = new PropertiesProviderBuilder()
+          .setEagerProperties(eagerProperties)
+          .setLazyPropertiesStrategy(lazyPropertiesStrategy)
+          .setCommonOperations([
+            ParserSurfaceFlinger.Operations.SetFormattersLayer,
+            ParserSurfaceFlinger.Operations.TranslateIntDefLayer,
+          ])
+          .setEagerOperations([
+            ParserSurfaceFlinger.Operations.AddDefaultsLayerEager,
+            COMMON_OPERATIONS.AddCompositionType,
+            COMMON_OPERATIONS.UpdateTransforms,
+            COMMON_OPERATIONS.AddVerboseFlags,
+            addExcludesCompositionState,
+          ])
+          .setLazyOperations([
+            ParserSurfaceFlinger.Operations.AddDefaultsLayerLazy,
+          ])
+          .build();
+        allLayerProps.push(layerProps);
+        return allLayerProps;
+      },
+      [] as PropertiesProvider[],
+    );
+
+    if (missingLayerIds) {
+      UserNotifier.add(new MissingLayerIds());
+    }
+
+    const entry = new PropertiesProviderBuilder()
+      .setEagerProperties(this.makeEntryEagerPropertiesTree(entryProto))
+      .setLazyPropertiesStrategy(
+        this.makeEntryLazyPropertiesStrategy(entryProto),
+      )
+      .setCommonOperations([
+        COMMON_OPERATIONS.AddDisplayProperties,
+        ParserSurfaceFlinger.Operations.SetFormattersEntry,
+        ParserSurfaceFlinger.Operations.TranslateIntDefEntry,
+      ])
+      .setEagerOperations([
+        ParserSurfaceFlinger.Operations.AddDefaultsEntryEager,
+      ])
+      .setLazyOperations([ParserSurfaceFlinger.Operations.AddDefaultsEntryLazy])
+      .build();
+
+    const tree = new HierarchyTreeBuilderSf()
+      .setRoot(entry)
+      .setChildren(layers)
+      .setComputations([
+        new ZOrderPathsComputation(),
+        new VisibilityPropertiesComputation(),
+        new RectsComputation(),
+      ])
+      .build();
+    UserNotifier.notify();
+    return tree;
+  }
+
+  private makeEagerPropertiesTree(
+    layer: LayerType,
+    duplicateCount: number,
+  ): PropertyTreeNode {
+    const denyList: string[] = [];
+    let obj = layer;
+    do {
+      Object.getOwnPropertyNames(obj).forEach((it) => {
+        if (!EAGER_PROPERTIES.includes(it)) denyList.push(it);
+      });
+      obj = Object.getPrototypeOf(obj);
+    } while (obj);
+
+    return new PropertyTreeBuilderFromProto()
+      .setData(layer)
+      .setRootId(assertDefined(layer.id))
+      .setRootName(assertDefined(layer.name))
+      .setDenyList(denyList)
+      .setDuplicateCount(duplicateCount)
+      .build();
+  }
+
+  private makeEntryEagerPropertiesTree(entry: EntryType): PropertyTreeNode {
+    const denyList: string[] = [];
+    let obj = entry;
+    do {
+      Object.getOwnPropertyNames(obj).forEach((it) => {
+        if (it !== 'displays') denyList.push(it);
+      });
+      obj = Object.getPrototypeOf(obj);
+    } while (obj);
+
+    return new PropertyTreeBuilderFromProto()
+      .setData(entry)
+      .setRootId('LayerTraceEntry')
+      .setRootName('root')
+      .setDenyList(denyList)
+      .build();
+  }
+
+  private makeLayerLazyPropertiesStrategy(
+    layer: LayerType,
+    duplicateCount: number,
+  ): LazyPropertiesStrategyType {
+    return async () => {
+      return new PropertyTreeBuilderFromProto()
+        .setData(layer)
+        .setRootId(assertDefined(layer.id))
+        .setRootName(assertDefined(layer.name))
+        .setDenyList(EAGER_PROPERTIES.concat(DENYLIST_PROPERTIES))
+        .setDuplicateCount(duplicateCount)
+        .build();
+    };
+  }
+
+  private makeEntryLazyPropertiesStrategy(
+    entry: EntryType,
+  ): LazyPropertiesStrategyType {
+    return async () => {
+      return new PropertyTreeBuilderFromProto()
+        .setData(entry)
+        .setRootId('LayerTraceEntry')
+        .setRootName('root')
+        .setDenyList(DENYLIST_PROPERTIES)
+        .build();
+    };
+  }
+}
+
+type EntryType =
+  | android.surfaceflinger.ILayersTraceProto
+  | perfetto.protos.ILayersSnapshotProto;
+
+type LayerType =
+  | android.surfaceflinger.ILayerProto
+  | perfetto.protos.ILayerProto;
+
+type ParserSurfaceFlinger =
+  | typeof PerfettoParserSurfaceFlinger
+  | typeof LegacyParserSurfaceFlinger;
diff --git a/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts
new file mode 100644
index 000000000..5a87371d1
--- /dev/null
+++ b/tools/winscope/src/parsers/surface_flinger/entry_hierarchy_tree_factory_test.ts
@@ -0,0 +1,51 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {MissingLayerIds} from 'messaging/user_warnings';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {EntryHierarchyTreeFactory} from './entry_hierarchy_tree_factory';
+import {ParserSurfaceFlinger} from './legacy/parser_surface_flinger';
+
+describe('EntryHierarchyTreeFactory', () => {
+  const factory = new EntryHierarchyTreeFactory();
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeEach(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
+  it('handles missing layer ids', () => {
+    const entryProto = {};
+    const layerProtos = [
+      {
+        id: 0,
+        name: 'Test layer',
+      },
+      {
+        id: undefined,
+        name: 'Second test layer',
+      },
+    ];
+    const tree = factory.makeEntryHierarchyTree(
+      entryProto,
+      layerProtos,
+      ParserSurfaceFlinger,
+    );
+    expect(tree.getAllChildren().length).toEqual(1);
+    expect(tree.getChildByName('Test layer')).toBeDefined();
+    userNotifierChecker.expectNotified([new MissingLayerIds()]);
+  });
+});
diff --git a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
index 5159e8b3a..0e9570999 100644
--- a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
+++ b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf.ts
@@ -15,10 +15,15 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {UserNotifier} from 'common/user_notifier';
+import {DuplicateLayerId} from 'messaging/user_warnings';
 import {HierarchyTreeBuilder} from 'parsers/hierarchy_tree_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  PropertySource,
+  PropertyTreeNode,
+} from 'trace/tree_node/property_tree_node';
 import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
 
 export class HierarchyTreeBuilderSf extends HierarchyTreeBuilder {
@@ -39,9 +44,7 @@ export class HierarchyTreeBuilderSf extends HierarchyTreeBuilder {
       const curr = map.get(layerId);
       if (curr) {
         curr.push(layerNode);
-        console.warn(
-          `Duplicate layer id ${layerId} found. Adding it as duplicate to the hierarchy`,
-        );
+        UserNotifier.add(new DuplicateLayerId(layerId.toString()));
         layer.addEagerProperty(
           DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
             layerProperties.id,
@@ -67,9 +70,10 @@ export class HierarchyTreeBuilderSf extends HierarchyTreeBuilder {
         const parentIdNode = assertDefined(
           child.getEagerPropertyByName('parent'),
         );
+        const isDefault = parentIdNode.source === PropertySource.DEFAULT;
         const parentId = this.getIdentifierValue(parentIdNode);
         const parent = identifierToChildren.get(parentId)?.at(0);
-        if (parent) {
+        if (!isDefault && parent) {
           this.setParentChildRelationship(parent, child);
         } else {
           this.setParentChildRelationship(root, child);
diff --git a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
index 47a1e09a0..e87a71de9 100644
--- a/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/hierarchy_tree_builder_sf_test.ts
@@ -14,34 +14,35 @@
  * limitations under the License.
  */
 
+import {DuplicateLayerId} from 'messaging/user_warnings';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {OperationChain} from 'trace/tree_node/operations/operation_chain';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  PropertySource,
+  PropertyTreeNode,
+} from 'trace/tree_node/property_tree_node';
 import {HierarchyTreeBuilderSf} from './hierarchy_tree_builder_sf';
 import {LayerFlag} from './layer_flag';
 
 describe('HierarchyTreeBuilderSf', () => {
   let builder: HierarchyTreeBuilderSf;
   let entry: PropertiesProvider;
+  let expectedRoot: HierarchyTreeNode;
 
   beforeEach(() => {
     jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
     builder = new HierarchyTreeBuilderSf();
-    const testPropertyNode = new PropertyTreeBuilder()
+    const propertiesTree = new PropertyTreeBuilder()
       .setIsRoot(true)
       .setRootId('LayerTraceEntry')
       .setName('root')
       .build();
-    entry = new PropertiesProvider(
-      testPropertyNode,
-      async () => testPropertyNode,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    entry = makePropertiesProvider(propertiesTree);
+    expectedRoot = new HierarchyTreeNode('LayerTraceEntry root', 'root', entry);
   });
 
   it('throws error if entry not set', () => {
@@ -56,25 +57,6 @@ describe('HierarchyTreeBuilderSf', () => {
 
   it('builds root with no children correctly', () => {
     const root = builder.setRoot(entry).setChildren([]).build();
-
-    const propertiesTree = new PropertyTreeBuilder()
-      .setIsRoot(true)
-      .setRootId('LayerTraceEntry')
-      .setName('root')
-      .build();
-
-    const expectedRoot = new HierarchyTreeNode(
-      'LayerTraceEntry root',
-      'root',
-      new PropertiesProvider(
-        propertiesTree,
-        async () => propertiesTree,
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-      ),
-    );
-
     expect(root).toEqual(expectedRoot);
   });
 
@@ -91,34 +73,10 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-
-    const layer1Provider = new PropertiesProvider(
-      layer1Props,
-      async () => layer1Props,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer1Provider = makePropertiesProvider(layer1Props);
 
     const root = builder.setRoot(entry).setChildren([layer1Provider]).build();
 
-    const propertiesTree = new PropertyTreeBuilder()
-      .setIsRoot(true)
-      .setRootId('LayerTraceEntry')
-      .setName('root')
-      .build();
-
-    const expectedRoot = new HierarchyTreeNode(
-      'LayerTraceEntry root',
-      'root',
-      new PropertiesProvider(
-        propertiesTree,
-        async () => propertiesTree,
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-      ),
-    );
     expectedRoot.addOrReplaceChild(
       new HierarchyTreeNode('1 layer1', 'layer1', layer1Provider),
     );
@@ -148,13 +106,7 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-    const layer1Provider = new PropertiesProvider(
-      layer1Props,
-      async () => layer1Props,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer1Provider = makePropertiesProvider(layer1Props);
 
     const layer2Props = new PropertyTreeBuilder()
       .setIsRoot(true)
@@ -168,36 +120,13 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-    const layer2Provider = new PropertiesProvider(
-      layer2Props,
-      async () => layer2Props,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer2Provider = makePropertiesProvider(layer2Props);
 
     const root = builder
       .setRoot(entry)
       .setChildren([layer1Provider, layer2Provider])
       .build();
 
-    const propertiesTree = new PropertyTreeBuilder()
-      .setIsRoot(true)
-      .setRootId('LayerTraceEntry')
-      .setName('root')
-      .build();
-
-    const expectedRoot = new HierarchyTreeNode(
-      'LayerTraceEntry root',
-      'root',
-      new PropertiesProvider(
-        propertiesTree,
-        async () => propertiesTree,
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-      ),
-    );
     const expectedRootLayer = new HierarchyTreeNode(
       '1 layer1',
       'layer1',
@@ -215,6 +144,7 @@ describe('HierarchyTreeBuilderSf', () => {
   });
 
   it('builds root with duplicate id layers', () => {
+    const userNotifierChecker = new UserNotifierChecker();
     const layer1Props = new PropertyTreeBuilder()
       .setIsRoot(true)
       .setRootId('1')
@@ -236,13 +166,7 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-    const layer1Provider = new PropertiesProvider(
-      layer1Props,
-      async () => layer1Props,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer1Provider = makePropertiesProvider(layer1Props);
 
     const layer2Props = new PropertyTreeBuilder()
       .setIsRoot(true)
@@ -256,13 +180,7 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-    const layer2Provider = new PropertiesProvider(
-      layer2Props,
-      async () => layer2Props,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer2Provider = makePropertiesProvider(layer2Props);
 
     const layer2DupProps = new PropertyTreeBuilder()
       .setIsRoot(true)
@@ -276,36 +194,13 @@ describe('HierarchyTreeBuilderSf', () => {
         {name: 'flags', value: LayerFlag.HIDDEN},
       ])
       .build();
-    const layer2DupProvider = new PropertiesProvider(
-      layer2DupProps,
-      async () => layer2DupProps,
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-      OperationChain.emptyChain<PropertyTreeNode>(),
-    );
+    const layer2DupProvider = makePropertiesProvider(layer2DupProps);
 
     const root = builder
       .setRoot(entry)
       .setChildren([layer1Provider, layer2Provider, layer2DupProvider])
       .build();
 
-    const propertiesTree = new PropertyTreeBuilder()
-      .setIsRoot(true)
-      .setRootId('LayerTraceEntry')
-      .setName('root')
-      .build();
-
-    const expectedRoot = new HierarchyTreeNode(
-      'LayerTraceEntry root',
-      'root',
-      new PropertiesProvider(
-        propertiesTree,
-        async () => propertiesTree,
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-        OperationChain.emptyChain<PropertyTreeNode>(),
-      ),
-    );
     const expectedRootLayer = new HierarchyTreeNode(
       '1 layer1',
       'layer1',
@@ -325,6 +220,76 @@ describe('HierarchyTreeBuilderSf', () => {
     expectedRootLayer.addOrReplaceChild(expectedDupNestedLayer);
     expectedRoot.addOrReplaceChild(expectedRootLayer);
 
+    expect(root).toEqual(expectedRoot);
+    userNotifierChecker.expectAdded([new DuplicateLayerId('2')]);
+  });
+
+  it('builds root with default parent values correctly', () => {
+    const layer1Props = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('1')
+      .setName('layer1')
+      .setChildren([
+        {name: 'id', value: 1},
+        {name: 'name', value: 'layer1'},
+        {name: 'parent', value: -1},
+        {
+          name: 'children',
+          value: undefined,
+          children: [
+            {
+              name: '0',
+              value: 2,
+            },
+          ],
+        },
+        {name: 'flags', value: LayerFlag.HIDDEN},
+      ])
+      .build();
+    const layer1Provider = makePropertiesProvider(layer1Props);
+
+    const layer2Props = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('2')
+      .setName('layer2')
+      .setChildren([
+        {name: 'id', value: 2},
+        {name: 'name', value: 'layer2'},
+        {name: 'parent', value: 1, source: PropertySource.DEFAULT},
+        {name: 'children', value: []},
+        {name: 'flags', value: LayerFlag.HIDDEN},
+      ])
+      .build();
+    const layer2Provider = makePropertiesProvider(layer2Props);
+
+    const root = builder
+      .setRoot(entry)
+      .setChildren([layer1Provider, layer2Provider])
+      .build();
+
+    const expectedLayer1 = new HierarchyTreeNode(
+      '1 layer1',
+      'layer1',
+      layer1Provider,
+    );
+    const expectedLayer2 = new HierarchyTreeNode(
+      '2 layer2',
+      'layer2',
+      layer2Provider,
+    );
+    expectedRoot.addOrReplaceChild(expectedLayer1);
+    expectedRoot.addOrReplaceChild(expectedLayer2);
+
     expect(root).toEqual(expectedRoot);
   });
+
+  function makePropertiesProvider(node: PropertyTreeNode): PropertiesProvider {
+    return new PropertiesProvider(
+      node,
+      async () => node,
+      OperationChain.emptyChain<PropertyTreeNode>(),
+      OperationChain.emptyChain<PropertyTreeNode>(),
+      OperationChain.emptyChain<PropertyTreeNode>(),
+    );
+  }
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger.ts b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger.ts
index 068a25272..601eccd3f 100644
--- a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger.ts
+++ b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger.ts
@@ -20,11 +20,9 @@ import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {AddDefaults} from 'parsers/operations/add_defaults';
 import {SetFormatters} from 'parsers/operations/set_formatters';
 import {TranslateIntDef} from 'parsers/operations/translate_intdef';
-import {RectsComputation} from 'parsers/surface_flinger/computations/rects_computation';
-import {VisibilityPropertiesComputation} from 'parsers/surface_flinger/computations/visibility_properties_computation';
-import {ZOrderPathsComputation} from 'parsers/surface_flinger/computations/z_order_paths_computation';
-import {HierarchyTreeBuilderSf} from 'parsers/surface_flinger/hierarchy_tree_builder_sf';
-import {ParserSfUtils} from 'parsers/surface_flinger/parser_surface_flinger_utils';
+import {DENYLIST_PROPERTIES} from 'parsers/surface_flinger/denylist_properties';
+import {EAGER_PROPERTIES} from 'parsers/surface_flinger/eager_properties';
+import {EntryHierarchyTreeFactory} from 'parsers/surface_flinger/entry_hierarchy_tree_factory';
 import {TamperedMessageType} from 'parsers/tampered_message_type';
 import root from 'protos/surfaceflinger/udc/json';
 import {android} from 'protos/surfaceflinger/udc/static';
@@ -37,8 +35,6 @@ import {EntriesRange} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {EnumFormatter, LAYER_ID_FORMATTER} from 'trace/tree_node/formatters';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {PropertiesProviderBuilder} from 'trace/tree_node/properties_provider_builder';
 
 class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
   private static readonly MAGIC_NUMBER = [
@@ -63,7 +59,7 @@ class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
       .tamperedMessageType,
   ).fields['layers'];
 
-  private static readonly Operations = {
+  static readonly Operations = {
     SetFormattersLayer: new SetFormatters(
       ParserSurfaceFlinger.layerField,
       ParserSurfaceFlinger.CUSTOM_FORMATTERS,
@@ -71,12 +67,12 @@ class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     TranslateIntDefLayer: new TranslateIntDef(ParserSurfaceFlinger.layerField),
     AddDefaultsLayerEager: new AddDefaults(
       ParserSurfaceFlinger.layerField,
-      ParserSfUtils.EAGER_PROPERTIES,
+      EAGER_PROPERTIES,
     ),
     AddDefaultsLayerLazy: new AddDefaults(
       ParserSurfaceFlinger.layerField,
       undefined,
-      ParserSfUtils.EAGER_PROPERTIES.concat(ParserSfUtils.DENYLIST_PROPERTIES),
+      EAGER_PROPERTIES.concat(DENYLIST_PROPERTIES),
     ),
     SetFormattersEntry: new SetFormatters(
       ParserSurfaceFlinger.entryField,
@@ -89,10 +85,11 @@ class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     AddDefaultsEntryLazy: new AddDefaults(
       ParserSurfaceFlinger.entryField,
       undefined,
-      ParserSfUtils.DENYLIST_PROPERTIES,
+      DENYLIST_PROPERTIES,
     ),
   };
 
+  private readonly factory = new EntryHierarchyTreeFactory();
   private realToMonotonicTimeOffsetNs: bigint | undefined;
   private isDump = false;
 
@@ -147,7 +144,11 @@ class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     index: number,
     entry: android.surfaceflinger.ILayersTraceProto,
   ): HierarchyTreeNode {
-    return this.makeHierarchyTree(entry);
+    return this.factory.makeEntryHierarchyTree(
+      entry,
+      assertDefined(entry.layers?.layers),
+      ParserSurfaceFlinger,
+    );
   }
 
   override customQuery<Q extends CustomQueryType>(
@@ -181,81 +182,6 @@ class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
       })
       .getResult();
   }
-
-  private makeHierarchyTree(
-    entryProto: android.surfaceflinger.ILayersTraceProto,
-  ): HierarchyTreeNode {
-    const excludesCompositionState =
-      entryProto?.excludesCompositionState ?? false;
-    const addExcludesCompositionState = excludesCompositionState
-      ? ParserSfUtils.OPERATIONS.AddExcludesCompositionStateTrue
-      : ParserSfUtils.OPERATIONS.AddExcludesCompositionStateFalse;
-
-    const processed = new Map<number, number>();
-
-    const layers: PropertiesProvider[] = assertDefined(
-      entryProto.layers?.layers,
-    ).map((layer: android.surfaceflinger.ILayerProto) => {
-      const duplicateCount = processed.get(assertDefined(layer.id)) ?? 0;
-      processed.set(assertDefined(layer.id), duplicateCount + 1);
-      const eagerProperties = ParserSfUtils.makeEagerPropertiesTree(
-        layer,
-        duplicateCount,
-      );
-      const lazyPropertiesStrategy =
-        ParserSfUtils.makeLayerLazyPropertiesStrategy(layer, duplicateCount);
-
-      const layerProps = new PropertiesProviderBuilder()
-        .setEagerProperties(eagerProperties)
-        .setLazyPropertiesStrategy(lazyPropertiesStrategy)
-        .setCommonOperations([
-          ParserSurfaceFlinger.Operations.SetFormattersLayer,
-          ParserSurfaceFlinger.Operations.TranslateIntDefLayer,
-        ])
-        .setEagerOperations([
-          ParserSurfaceFlinger.Operations.AddDefaultsLayerEager,
-          ParserSfUtils.OPERATIONS.AddCompositionType,
-          ParserSfUtils.OPERATIONS.UpdateTransforms,
-          ParserSfUtils.OPERATIONS.AddVerboseFlags,
-          addExcludesCompositionState,
-        ])
-        .setLazyOperations([
-          ParserSurfaceFlinger.Operations.AddDefaultsLayerLazy,
-        ])
-        .build();
-      return layerProps;
-    });
-
-    const entry = new PropertiesProviderBuilder()
-      .setEagerProperties(
-        ParserSfUtils.makeEntryEagerPropertiesTree(entryProto),
-      )
-      .setLazyPropertiesStrategy(
-        ParserSfUtils.makeEntryLazyPropertiesStrategy(entryProto),
-      )
-      .setCommonOperations([
-        ParserSurfaceFlinger.Operations.SetFormattersEntry,
-        ParserSurfaceFlinger.Operations.TranslateIntDefEntry,
-      ])
-      .setEagerOperations([
-        ParserSurfaceFlinger.Operations.AddDefaultsEntryEager,
-      ])
-      .setLazyOperations([
-        ParserSurfaceFlinger.Operations.AddDefaultsEntryLazy,
-        ParserSfUtils.OPERATIONS.AddDisplayProperties,
-      ])
-      .build();
-
-    return new HierarchyTreeBuilderSf()
-      .setRoot(entry)
-      .setChildren(layers)
-      .setComputations([
-        new ZOrderPathsComputation(),
-        new VisibilityPropertiesComputation(),
-        new RectsComputation(),
-      ])
-      .build();
-  }
 }
 
 export {ParserSurfaceFlinger};
diff --git a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_dump_test.ts b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_dump_test.ts
index 0b62e0503..1ecc3bf6f 100644
--- a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_dump_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_dump_test.ts
@@ -15,6 +15,7 @@
  */
 
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
 import {Parser} from 'trace/parser';
@@ -22,8 +23,11 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 
 describe('ParserSurfaceFlingerDump', () => {
+  let userNotifierChecker: UserNotifierChecker;
+
   beforeAll(() => {
     jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+    userNotifierChecker = new UserNotifierChecker();
   });
 
   describe('trace with real timestamps', () => {
@@ -35,6 +39,11 @@ describe('ParserSurfaceFlingerDump', () => {
       )) as Parser<HierarchyTreeNode>;
     });
 
+    afterEach(() => {
+      userNotifierChecker.expectNone();
+      userNotifierChecker.reset();
+    });
+
     it('has expected trace type', () => {
       expect(parser.getTraceType()).toEqual(TraceType.SURFACE_FLINGER);
     });
diff --git a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
index d925ad74b..79209e5a2 100644
--- a/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/legacy/parser_surface_flinger_test.ts
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
+import {DuplicateLayerId} from 'messaging/user_warnings';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
 import {CustomQueryType} from 'trace/custom_query';
@@ -26,6 +28,12 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 
 describe('ParserSurfaceFlinger', () => {
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
   describe('trace with real timestamps', () => {
     let parser: Parser<HierarchyTreeNode>;
     let trace: Trace<HierarchyTreeNode>;
@@ -167,6 +175,7 @@ describe('ParserSurfaceFlinger', () => {
         'Input Consumer recents_animation_input_consumer#408(Mirror) duplicate(1)',
       );
       expect(dupLayer.getAllChildren().length).toEqual(0);
+      userNotifierChecker.expectNotified([new DuplicateLayerId('-2147483595')]);
     });
   });
 
diff --git a/tools/winscope/src/parsers/surface_flinger/operations/update_transforms.ts b/tools/winscope/src/parsers/surface_flinger/operations/update_transforms.ts
index dd79402e6..0e8cf4e2a 100644
--- a/tools/winscope/src/parsers/surface_flinger/operations/update_transforms.ts
+++ b/tools/winscope/src/parsers/surface_flinger/operations/update_transforms.ts
@@ -21,34 +21,39 @@ import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_
 
 export class UpdateTransforms implements Operation<PropertyTreeNode> {
   apply(value: PropertyTreeNode): void {
-    this.updateTransform(
+    this.updateDeprecatedTransform(
       value.getChildByName('transform'),
       value.getChildByName('position'),
     );
 
-    this.updateTransform(
+    this.updateDeprecatedTransform(
       value.getChildByName('requestedTransform'),
       value.getChildByName('requestedPosition'),
     );
 
-    this.updateTransform(value.getChildByName('bufferTransform'), undefined);
+    this.updateDeprecatedTransform(
+      value.getChildByName('bufferTransform'),
+      undefined,
+    );
 
     const inputWindowInfo = value.getChildByName('inputWindowInfo');
     if (inputWindowInfo) {
-      this.updateTransform(
+      this.updateDeprecatedTransform(
         inputWindowInfo.getChildByName('transform'),
         undefined,
       );
     }
   }
 
-  private updateTransform(
+  private updateDeprecatedTransform(
     transformNode: PropertyTreeNode | undefined,
     positionNode: PropertyTreeNode | undefined,
   ) {
     if (!transformNode) return;
     if (transformNode.getChildByName('matrix')) return;
 
+    this.adjustDeprecatedTransformNode(transformNode);
+
     const newMatrix = Transform.from(transformNode, positionNode).matrix;
     transformNode.addOrReplaceChild(
       DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
@@ -62,4 +67,29 @@ export class UpdateTransforms implements Operation<PropertyTreeNode> {
     transformNode.removeChild(`${transformNode.id}.dsdy`);
     transformNode.removeChild(`${transformNode.id}.dtdy`);
   }
+
+  // Adjust the transform node to correct for the transforms that were incorrectly
+  // written to the proto. Any transforms that are newly logged from the platform should
+  // be carefully written to the proto correctly, and should not be adjusted here.
+  private adjustDeprecatedTransformNode(transformNode: PropertyTreeNode) {
+    // Get the corrected values from the transform node.
+    const dsdx = transformNode.getChildByName('dsdx')?.getValue() ?? 0;
+    const dtdx = transformNode.getChildByName('dsdy')?.getValue() ?? 0;
+    const dtdy = transformNode.getChildByName('dtdx')?.getValue() ?? 0;
+    const dsdy = transformNode.getChildByName('dtdy')?.getValue() ?? 0;
+
+    const id = transformNode.id;
+    transformNode.addOrReplaceChild(
+      DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeProtoProperty(id, 'dsdx', dsdx),
+    );
+    transformNode.addOrReplaceChild(
+      DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeProtoProperty(id, 'dtdx', dtdx),
+    );
+    transformNode.addOrReplaceChild(
+      DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeProtoProperty(id, 'dtdy', dtdy),
+    );
+    transformNode.addOrReplaceChild(
+      DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeProtoProperty(id, 'dsdy', dsdy),
+    );
+  }
 }
diff --git a/tools/winscope/src/parsers/surface_flinger/operations/update_transforms_test.ts b/tools/winscope/src/parsers/surface_flinger/operations/update_transforms_test.ts
index 82b992dfc..e92bcd9be 100644
--- a/tools/winscope/src/parsers/surface_flinger/operations/update_transforms_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/operations/update_transforms_test.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {TransformTypeFlags} from 'parsers/surface_flinger/transform_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -23,7 +24,7 @@ import {UpdateTransforms} from './update_transforms';
 describe('UpdateTransforms', () => {
   let propertyRoot: PropertyTreeNode;
   let operation: UpdateTransforms;
-  let protoTransform: any;
+  let deprecatedProtoTransform: any;
   let protoPosition: any;
 
   beforeEach(() => {
@@ -33,12 +34,12 @@ describe('UpdateTransforms', () => {
       .setName('node')
       .setIsRoot(true)
       .build();
-    protoTransform = {
-      dsdx: 0,
-      dtdx: 0,
-      dsdy: 0,
-      dtdy: 0,
-      type: 0,
+    deprecatedProtoTransform = {
+      dsdx: 1,
+      dtdx: 2,
+      dtdy: 3,
+      dsdy: 4,
+      type: TransformTypeFlags.ROT_INVALID_VAL,
     };
     protoPosition = {
       x: 0,
@@ -50,7 +51,7 @@ describe('UpdateTransforms', () => {
       TreeNodeUtils.makePropertyNode(
         propertyRoot.id,
         'transform',
-        protoTransform,
+        deprecatedProtoTransform,
       ),
     );
     propertyRoot.addOrReplaceChild(
@@ -75,7 +76,7 @@ describe('UpdateTransforms', () => {
       TreeNodeUtils.makePropertyNode(
         propertyRoot.id,
         'requestedTransform',
-        protoTransform,
+        deprecatedProtoTransform,
       ),
     );
     propertyRoot.addOrReplaceChild(
@@ -103,7 +104,7 @@ describe('UpdateTransforms', () => {
       TreeNodeUtils.makePropertyNode(
         propertyRoot.id,
         'bufferTransform',
-        protoTransform,
+        deprecatedProtoTransform,
       ),
     );
 
@@ -124,7 +125,7 @@ describe('UpdateTransforms', () => {
       propertyRoot.id,
       'inputWindowInfo',
       {
-        transform: protoTransform,
+        transform: deprecatedProtoTransform,
       },
     );
 
@@ -154,10 +155,10 @@ describe('UpdateTransforms', () => {
       'matrix',
       {
         dsdx: 1,
-        dtdx: 0,
+        dtdx: 4,
         tx: 0,
-        dsdy: 0,
-        dtdy: 1,
+        dtdy: 2,
+        dsdy: 3,
         ty: 0,
       },
     );
diff --git a/tools/winscope/src/parsers/surface_flinger/parser_surface_flinger_utils.ts b/tools/winscope/src/parsers/surface_flinger/parser_surface_flinger_utils.ts
deleted file mode 100644
index 5d49ddd97..000000000
--- a/tools/winscope/src/parsers/surface_flinger/parser_surface_flinger_utils.ts
+++ /dev/null
@@ -1,156 +0,0 @@
-/*
- * Copyright (C) 2023 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {assertDefined} from 'common/assert_utils';
-import {perfetto} from 'protos/surfaceflinger/latest/static';
-import {android} from 'protos/surfaceflinger/udc/static';
-import {LazyPropertiesStrategyType} from 'trace/tree_node/properties_provider';
-import {PropertyTreeBuilderFromProto} from 'trace/tree_node/property_tree_builder_from_proto';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {AddCompositionType} from './operations/add_composition_type';
-import {AddDisplayProperties} from './operations/add_display_properties';
-import {AddExcludesCompositionState} from './operations/add_excludes_composition_state';
-import {AddVerboseFlags} from './operations/add_verbose_flags';
-import {UpdateTransforms} from './operations/update_transforms';
-
-export class ParserSfUtils {
-  static readonly EAGER_PROPERTIES = [
-    'id',
-    'name',
-    'type',
-    'parent',
-    'children',
-    'bounds',
-    'transform',
-    'position',
-    'requestedTransform',
-    'requestedPosition',
-    'bufferTransform',
-    'inputWindowInfo',
-    'flags',
-    'z',
-    'cornerRadius',
-    'layerStack',
-    'isOpaque',
-    'activeBuffer',
-    'visibleRegion',
-    'color',
-    'isRelativeOf',
-    'zOrderRelativeOf',
-    'screenBounds',
-    'shadowRadius',
-    'backgroundBlurRadius',
-    'hwcCompositionType',
-  ];
-
-  static readonly DENYLIST_PROPERTIES = [
-    'length',
-    'prototype',
-    'ref',
-    'parent',
-    'timestamp',
-    'layers',
-    'children',
-    'name',
-  ];
-
-  static readonly OPERATIONS = {
-    UpdateTransforms: new UpdateTransforms(),
-    AddVerboseFlags: new AddVerboseFlags(),
-    AddExcludesCompositionStateTrue: new AddExcludesCompositionState(true),
-    AddExcludesCompositionStateFalse: new AddExcludesCompositionState(false),
-    AddDisplayProperties: new AddDisplayProperties(),
-    AddCompositionType: new AddCompositionType(),
-  };
-
-  static makeEagerPropertiesTree(
-    layer: android.surfaceflinger.ILayerProto | perfetto.protos.ILayerProto,
-    duplicateCount: number,
-  ): PropertyTreeNode {
-    const denyList: string[] = [];
-    let obj = layer;
-    do {
-      Object.getOwnPropertyNames(obj).forEach((it) => {
-        if (!ParserSfUtils.EAGER_PROPERTIES.includes(it)) denyList.push(it);
-      });
-      obj = Object.getPrototypeOf(obj);
-    } while (obj);
-
-    return new PropertyTreeBuilderFromProto()
-      .setData(layer)
-      .setRootId(assertDefined(layer.id))
-      .setRootName(assertDefined(layer.name))
-      .setDenyList(denyList)
-      .setDuplicateCount(duplicateCount)
-      .build();
-  }
-
-  static makeEntryEagerPropertiesTree(
-    entry:
-      | android.surfaceflinger.ILayersTraceProto
-      | perfetto.protos.ILayersSnapshotProto,
-  ): PropertyTreeNode {
-    const denyList: string[] = [];
-    let obj = entry;
-    do {
-      Object.getOwnPropertyNames(obj).forEach((it) => {
-        if (it !== 'displays') denyList.push(it);
-      });
-      obj = Object.getPrototypeOf(obj);
-    } while (obj);
-
-    return new PropertyTreeBuilderFromProto()
-      .setData(entry)
-      .setRootId('LayerTraceEntry')
-      .setRootName('root')
-      .setDenyList(denyList)
-      .build();
-  }
-
-  static makeLayerLazyPropertiesStrategy(
-    layer: android.surfaceflinger.ILayerProto | perfetto.protos.ILayerProto,
-    duplicateCount: number,
-  ): LazyPropertiesStrategyType {
-    return async () => {
-      return new PropertyTreeBuilderFromProto()
-        .setData(layer)
-        .setRootId(assertDefined(layer.id))
-        .setRootName(assertDefined(layer.name))
-        .setDenyList(
-          ParserSfUtils.EAGER_PROPERTIES.concat(
-            ParserSfUtils.DENYLIST_PROPERTIES,
-          ),
-        )
-        .setDuplicateCount(duplicateCount)
-        .build();
-    };
-  }
-
-  static makeEntryLazyPropertiesStrategy(
-    entry:
-      | android.surfaceflinger.ILayersTraceProto
-      | perfetto.protos.ILayersSnapshotProto,
-  ): LazyPropertiesStrategyType {
-    return async () => {
-      return new PropertyTreeBuilderFromProto()
-        .setData(entry)
-        .setRootId('LayerTraceEntry')
-        .setRootName('root')
-        .setDenyList(ParserSfUtils.DENYLIST_PROPERTIES)
-        .build();
-    };
-  }
-}
diff --git a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger.ts b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger.ts
index 21c8002ae..327875655 100644
--- a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger.ts
+++ b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger.ts
@@ -23,11 +23,9 @@ import {AbstractParser} from 'parsers/perfetto/abstract_parser';
 import {FakeProtoBuilder} from 'parsers/perfetto/fake_proto_builder';
 import {FakeProtoTransformer} from 'parsers/perfetto/fake_proto_transformer';
 import {Utils} from 'parsers/perfetto/utils';
-import {RectsComputation} from 'parsers/surface_flinger/computations/rects_computation';
-import {VisibilityPropertiesComputation} from 'parsers/surface_flinger/computations/visibility_properties_computation';
-import {ZOrderPathsComputation} from 'parsers/surface_flinger/computations/z_order_paths_computation';
-import {HierarchyTreeBuilderSf} from 'parsers/surface_flinger/hierarchy_tree_builder_sf';
-import {ParserSfUtils} from 'parsers/surface_flinger/parser_surface_flinger_utils';
+import {DENYLIST_PROPERTIES} from 'parsers/surface_flinger/denylist_properties';
+import {EAGER_PROPERTIES} from 'parsers/surface_flinger/eager_properties';
+import {EntryHierarchyTreeFactory} from 'parsers/surface_flinger/entry_hierarchy_tree_factory';
 import {TamperedMessageType} from 'parsers/tampered_message_type';
 import root from 'protos/surfaceflinger/latest/json';
 import {perfetto} from 'protos/surfaceflinger/latest/static';
@@ -41,8 +39,6 @@ import {TraceFile} from 'trace/trace_file';
 import {TraceType} from 'trace/trace_type';
 import {EnumFormatter, LAYER_ID_FORMATTER} from 'trace/tree_node/formatters';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {PropertiesProviderBuilder} from 'trace/tree_node/properties_provider_builder';
 import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
 
 export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
@@ -65,7 +61,7 @@ export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
       .tamperedMessageType,
   ).fields['layers'];
 
-  private static readonly Operations = {
+  static readonly Operations = {
     SetFormattersLayer: new SetFormatters(
       ParserSurfaceFlinger.layerField,
       ParserSurfaceFlinger.CUSTOM_FORMATTERS,
@@ -73,12 +69,12 @@ export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     TranslateIntDefLayer: new TranslateIntDef(ParserSurfaceFlinger.layerField),
     AddDefaultsLayerEager: new AddDefaults(
       ParserSurfaceFlinger.layerField,
-      ParserSfUtils.EAGER_PROPERTIES,
+      EAGER_PROPERTIES,
     ),
     AddDefaultsLayerLazy: new AddDefaults(
       ParserSurfaceFlinger.layerField,
       undefined,
-      ParserSfUtils.EAGER_PROPERTIES.concat(ParserSfUtils.DENYLIST_PROPERTIES),
+      EAGER_PROPERTIES.concat(DENYLIST_PROPERTIES),
     ),
     SetFormattersEntry: new SetFormatters(
       ParserSurfaceFlinger.entryField,
@@ -91,10 +87,11 @@ export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     AddDefaultsEntryLazy: new AddDefaults(
       ParserSurfaceFlinger.entryField,
       undefined,
-      ParserSfUtils.DENYLIST_PROPERTIES,
+      DENYLIST_PROPERTIES,
     ),
   };
 
+  private readonly factory = new EntryHierarchyTreeFactory();
   private layersSnapshotProtoTransformer: FakeProtoTransformer;
   private layerProtoTransformer: FakeProtoTransformer;
 
@@ -130,7 +127,11 @@ export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
       (layerProto) => this.layerProtoTransformer.transform(layerProto),
     );
 
-    return this.makeHierarchyTree(snapshotProto, layerProtos);
+    return this.factory.makeEntryHierarchyTree(
+      snapshotProto,
+      layerProtos,
+      ParserSurfaceFlinger,
+    );
   }
 
   override async customQuery<Q extends CustomQueryType>(
@@ -180,83 +181,6 @@ export class ParserSurfaceFlinger extends AbstractParser<HierarchyTreeNode> {
     return 'surfaceflinger_layers_snapshot';
   }
 
-  private makeHierarchyTree(
-    snapshotProto: perfetto.protos.ILayersSnapshotProto,
-    layerProtos: perfetto.protos.ILayerProto[],
-  ): HierarchyTreeNode {
-    const excludesCompositionState =
-      snapshotProto?.excludesCompositionState ?? false;
-    const addExcludesCompositionState = excludesCompositionState
-      ? ParserSfUtils.OPERATIONS.AddExcludesCompositionStateTrue
-      : ParserSfUtils.OPERATIONS.AddExcludesCompositionStateFalse;
-
-    const processed = new Map<number, number>();
-
-    const layers: PropertiesProvider[] = layerProtos.map(
-      (layer: perfetto.protos.ILayerProto) => {
-        const duplicateCount = processed.get(assertDefined(layer.id)) ?? 0;
-        processed.set(assertDefined(layer.id), duplicateCount + 1);
-        const eagerProperties = ParserSfUtils.makeEagerPropertiesTree(
-          layer,
-          duplicateCount,
-        );
-        const lazyPropertiesStrategy =
-          ParserSfUtils.makeLayerLazyPropertiesStrategy(layer, duplicateCount); //TODO: fetch these lazily instead
-
-        const layerProps = new PropertiesProviderBuilder()
-          .setEagerProperties(eagerProperties)
-          .setLazyPropertiesStrategy(lazyPropertiesStrategy)
-          .setCommonOperations([
-            ParserSurfaceFlinger.Operations.SetFormattersLayer,
-            ParserSurfaceFlinger.Operations.TranslateIntDefLayer,
-          ])
-          .setEagerOperations([
-            ParserSurfaceFlinger.Operations.AddDefaultsLayerEager,
-            ParserSfUtils.OPERATIONS.AddCompositionType,
-            ParserSfUtils.OPERATIONS.UpdateTransforms,
-            ParserSfUtils.OPERATIONS.AddVerboseFlags,
-            addExcludesCompositionState,
-          ])
-          .setLazyOperations([
-            ParserSurfaceFlinger.Operations.AddDefaultsLayerLazy,
-          ])
-          .build();
-        return layerProps;
-      },
-    );
-
-    const entry = new PropertiesProviderBuilder()
-      .setEagerProperties(
-        ParserSfUtils.makeEntryEagerPropertiesTree(snapshotProto),
-      )
-      .setLazyPropertiesStrategy(
-        ParserSfUtils.makeEntryLazyPropertiesStrategy(snapshotProto),
-      )
-      .setCommonOperations([
-        ParserSfUtils.OPERATIONS.AddDisplayProperties,
-        ParserSurfaceFlinger.Operations.SetFormattersEntry,
-        ParserSurfaceFlinger.Operations.TranslateIntDefEntry,
-      ])
-      .setEagerOperations([
-        ParserSurfaceFlinger.Operations.AddDefaultsEntryEager,
-      ])
-      .setLazyOperations([
-        ParserSurfaceFlinger.Operations.AddDefaultsEntryLazy,
-        ParserSfUtils.OPERATIONS.AddDisplayProperties,
-      ])
-      .build();
-
-    return new HierarchyTreeBuilderSf()
-      .setRoot(entry)
-      .setChildren(layers)
-      .setComputations([
-        new ZOrderPathsComputation(),
-        new VisibilityPropertiesComputation(),
-        new RectsComputation(),
-      ])
-      .build();
-  }
-
   private async querySnapshotLayers(
     index: number,
   ): Promise<perfetto.protos.ILayerProto[]> {
diff --git a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
index a93fafb4e..4ee00ad9a 100644
--- a/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
+++ b/tools/winscope/src/parsers/surface_flinger/perfetto/parser_surface_flinger_test.ts
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
+import {DuplicateLayerId} from 'messaging/user_warnings';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CoarseVersion} from 'trace/coarse_version';
 import {CustomQueryType} from 'trace/custom_query';
@@ -26,6 +28,12 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 
 describe('Perfetto ParserSurfaceFlinger', () => {
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
   describe('valid trace', () => {
     let parser: Parser<HierarchyTreeNode>;
     let trace: Trace<HierarchyTreeNode>;
@@ -170,6 +178,7 @@ describe('Perfetto ParserSurfaceFlinger', () => {
         'Input Consumer recents_animation_input_consumer#408(Mirror) duplicate(1)',
       );
       expect(dupLayer.getAllChildren().length).toEqual(0);
+      userNotifierChecker.expectNotified([new DuplicateLayerId('-2147483595')]);
     });
   });
 });
diff --git a/tools/winscope/src/parsers/surface_flinger/transform_utils.ts b/tools/winscope/src/parsers/surface_flinger/transform_utils.ts
index 1c3be24c7..4527b103f 100644
--- a/tools/winscope/src/parsers/surface_flinger/transform_utils.ts
+++ b/tools/winscope/src/parsers/surface_flinger/transform_utils.ts
@@ -15,10 +15,13 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {IDENTITY_MATRIX, TransformMatrix} from 'common/geometry_types';
+import {
+  IDENTITY_MATRIX,
+  TransformMatrix,
+} from 'common/geometry/transform_matrix';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 
-export enum TransformType {
+export enum TransformTypeFlags {
   EMPTY = 0x0,
   TRANSLATE_VAL = 0x0001,
   ROTATE_VAL = 0x0002,
@@ -30,9 +33,12 @@ export enum TransformType {
 }
 
 export class Transform {
-  static EMPTY = new Transform(TransformType.EMPTY, IDENTITY_MATRIX);
+  static EMPTY = new Transform(TransformTypeFlags.EMPTY, IDENTITY_MATRIX);
 
-  constructor(public type: TransformType, public matrix: TransformMatrix) {}
+  constructor(
+    public type: TransformTypeFlags,
+    public matrix: TransformMatrix,
+  ) {}
 
   static from(
     transformNode: PropertyTreeNode,
@@ -44,204 +50,222 @@ export class Transform {
     const matrixNode = transformNode.getChildByName('matrix');
 
     if (matrixNode) {
-      return new Transform(transformType, {
-        dsdx: assertDefined(matrixNode.getChildByName('dsdx')).getValue(),
-        dtdx: assertDefined(matrixNode.getChildByName('dtdx')).getValue(),
-        tx: assertDefined(matrixNode.getChildByName('tx')).getValue(),
-        dsdy: assertDefined(matrixNode.getChildByName('dsdy')).getValue(),
-        dtdy: assertDefined(matrixNode.getChildByName('dtdy')).getValue(),
-        ty: assertDefined(matrixNode.getChildByName('ty')).getValue(),
-      });
+      return new Transform(
+        transformType,
+        TransformMatrix.from({
+          dsdx: assertDefined(matrixNode.getChildByName('dsdx')).getValue(),
+          dtdx: assertDefined(matrixNode.getChildByName('dtdx')).getValue(),
+          tx: assertDefined(matrixNode.getChildByName('tx')).getValue(),
+          dtdy: assertDefined(matrixNode.getChildByName('dtdy')).getValue(),
+          dsdy: assertDefined(matrixNode.getChildByName('dsdy')).getValue(),
+          ty: assertDefined(matrixNode.getChildByName('ty')).getValue(),
+        }),
+      );
     }
 
     const x = position?.getChildByName('x')?.getValue() ?? 0;
     const y = position?.getChildByName('y')?.getValue() ?? 0;
 
-    if (TransformUtils.isSimpleTransform(transformType)) {
-      return TransformUtils.getDefaultTransform(transformType, x, y);
+    if (TransformType.isSimpleTransform(transformType)) {
+      return TransformType.getDefaultTransform(transformType, x, y);
     }
 
-    return new Transform(transformType, {
-      dsdx: transformNode.getChildByName('dsdx')?.getValue() ?? 0,
-      dtdx: transformNode.getChildByName('dtdx')?.getValue() ?? 0,
-      tx: x,
-      dsdy: transformNode.getChildByName('dsdy')?.getValue() ?? 0,
-      dtdy: transformNode.getChildByName('dtdy')?.getValue() ?? 0,
-      ty: y,
-    });
-  }
-}
-
-export class TransformUtils {
-  static isValidTransform(transform: Transform): boolean {
-    return (
-      transform.matrix.dsdx * transform.matrix.dtdy !==
-      transform.matrix.dtdx * transform.matrix.dsdy
+    return new Transform(
+      transformType,
+      TransformMatrix.from({
+        dsdx: transformNode.getChildByName('dsdx')?.getValue() ?? 0,
+        dtdx: transformNode.getChildByName('dtdx')?.getValue() ?? 0,
+        tx: x,
+        dtdy: transformNode.getChildByName('dtdy')?.getValue() ?? 0,
+        dsdy: transformNode.getChildByName('dsdy')?.getValue() ?? 0,
+        ty: y,
+      }),
     );
   }
+}
 
-  static isSimpleRotation(type: TransformType | undefined): boolean {
+export class TransformType {
+  static isSimpleRotation(type: TransformTypeFlags | undefined): boolean {
     return !(type
-      ? TransformUtils.isFlagSet(type, TransformType.ROT_INVALID_VAL)
+      ? TransformType.isFlagSet(type, TransformTypeFlags.ROT_INVALID_VAL)
       : false);
   }
 
-  static getTypeFlags(type: TransformType): string {
+  static getTypeFlags(type: TransformTypeFlags): string {
     const typeFlags: string[] = [];
 
     if (
-      TransformUtils.isFlagClear(
+      TransformType.isFlagClear(
         type,
-        TransformType.SCALE_VAL |
-          TransformType.ROTATE_VAL |
-          TransformType.TRANSLATE_VAL,
+        TransformTypeFlags.SCALE_VAL |
+          TransformTypeFlags.ROTATE_VAL |
+          TransformTypeFlags.TRANSLATE_VAL,
       )
     ) {
       typeFlags.push('IDENTITY');
     }
 
-    if (TransformUtils.isFlagSet(type, TransformType.SCALE_VAL)) {
+    if (TransformType.isFlagSet(type, TransformTypeFlags.SCALE_VAL)) {
       typeFlags.push('SCALE');
     }
 
-    if (TransformUtils.isFlagSet(type, TransformType.TRANSLATE_VAL)) {
+    if (TransformType.isFlagSet(type, TransformTypeFlags.TRANSLATE_VAL)) {
       typeFlags.push('TRANSLATE');
     }
 
-    if (TransformUtils.isFlagSet(type, TransformType.ROT_INVALID_VAL)) {
+    if (TransformType.isFlagSet(type, TransformTypeFlags.ROT_INVALID_VAL)) {
       typeFlags.push('ROT_INVALID');
     } else if (
-      TransformUtils.isFlagSet(
+      TransformType.isFlagSet(
         type,
-        TransformType.ROT_90_VAL |
-          TransformType.FLIP_V_VAL |
-          TransformType.FLIP_H_VAL,
+        TransformTypeFlags.ROT_90_VAL |
+          TransformTypeFlags.FLIP_V_VAL |
+          TransformTypeFlags.FLIP_H_VAL,
       )
     ) {
       typeFlags.push('ROT_270');
     } else if (
-      TransformUtils.isFlagSet(
+      TransformType.isFlagSet(
         type,
-        TransformType.FLIP_V_VAL | TransformType.FLIP_H_VAL,
+        TransformTypeFlags.FLIP_V_VAL | TransformTypeFlags.FLIP_H_VAL,
       )
     ) {
       typeFlags.push('ROT_180');
     } else {
-      if (TransformUtils.isFlagSet(type, TransformType.ROT_90_VAL)) {
+      if (TransformType.isFlagSet(type, TransformTypeFlags.ROT_90_VAL)) {
         typeFlags.push('ROT_90');
       }
-      if (TransformUtils.isFlagSet(type, TransformType.FLIP_V_VAL)) {
+      if (TransformType.isFlagSet(type, TransformTypeFlags.FLIP_V_VAL)) {
         typeFlags.push('FLIP_V');
       }
-      if (TransformUtils.isFlagSet(type, TransformType.FLIP_H_VAL)) {
+      if (TransformType.isFlagSet(type, TransformTypeFlags.FLIP_H_VAL)) {
         typeFlags.push('FLIP_H');
       }
     }
 
     if (typeFlags.length === 0) {
-      throw Error(`Unknown transform type ${type}`);
+      throw TransformType.makeUnknownTransformTypeError(type);
     }
     return typeFlags.join('|');
   }
 
   static getDefaultTransform(
-    type: TransformType,
+    type: TransformTypeFlags,
     x: number,
     y: number,
   ): Transform {
     // IDENTITY
     if (!type) {
-      return new Transform(type, {
-        dsdx: 1,
-        dtdx: 0,
-        tx: x,
-        dsdy: 0,
-        dtdy: 1,
-        ty: y,
-      });
+      return new Transform(
+        type,
+        TransformMatrix.from({
+          dsdx: 1,
+          dtdx: 0,
+          tx: x,
+          dtdy: 0,
+          dsdy: 1,
+          ty: y,
+        }),
+      );
     }
 
     // ROT_270 = ROT_90|FLIP_H|FLIP_V
     if (
-      TransformUtils.isFlagSet(
+      TransformType.isFlagSet(
         type,
-        TransformType.ROT_90_VAL |
-          TransformType.FLIP_V_VAL |
-          TransformType.FLIP_H_VAL,
+        TransformTypeFlags.ROT_90_VAL |
+          TransformTypeFlags.FLIP_V_VAL |
+          TransformTypeFlags.FLIP_H_VAL,
       )
     ) {
-      return new Transform(type, {
-        dsdx: 0,
-        dtdx: -1,
-        tx: x,
-        dsdy: 1,
-        dtdy: 0,
-        ty: y,
-      });
+      return new Transform(
+        type,
+        TransformMatrix.from({
+          dsdx: 0,
+          dtdx: -1,
+          tx: x,
+          dtdy: 1,
+          dsdy: 0,
+          ty: y,
+        }),
+      );
     }
 
     // ROT_180 = FLIP_H|FLIP_V
     if (
-      TransformUtils.isFlagSet(
+      TransformType.isFlagSet(
         type,
-        TransformType.FLIP_V_VAL | TransformType.FLIP_H_VAL,
+        TransformTypeFlags.FLIP_V_VAL | TransformTypeFlags.FLIP_H_VAL,
       )
     ) {
-      return new Transform(type, {
-        dsdx: -1,
-        dtdx: 0,
-        tx: x,
-        dsdy: 0,
-        dtdy: -1,
-        ty: y,
-      });
+      return new Transform(
+        type,
+        TransformMatrix.from({
+          dsdx: -1,
+          dtdx: 0,
+          tx: x,
+          dtdy: 0,
+          dsdy: -1,
+          ty: y,
+        }),
+      );
     }
 
     // ROT_90
-    if (TransformUtils.isFlagSet(type, TransformType.ROT_90_VAL)) {
-      return new Transform(type, {
-        dsdx: 0,
-        dtdx: 1,
-        tx: x,
-        dsdy: -1,
-        dtdy: 0,
-        ty: y,
-      });
+    if (TransformType.isFlagSet(type, TransformTypeFlags.ROT_90_VAL)) {
+      return new Transform(
+        type,
+        TransformMatrix.from({
+          dsdx: 0,
+          dtdx: 1,
+          tx: x,
+          dtdy: -1,
+          dsdy: 0,
+          ty: y,
+        }),
+      );
     }
 
     // IDENTITY
     if (
-      TransformUtils.isFlagClear(
+      TransformType.isFlagClear(
         type,
-        TransformType.SCALE_VAL | TransformType.ROTATE_VAL,
+        TransformTypeFlags.SCALE_VAL | TransformTypeFlags.ROTATE_VAL,
       )
     ) {
-      return new Transform(type, {
-        dsdx: 1,
-        dtdx: 0,
-        tx: x,
-        dsdy: 0,
-        dtdy: 1,
-        ty: y,
-      });
+      return new Transform(
+        type,
+        TransformMatrix.from({
+          dsdx: 1,
+          dtdx: 0,
+          tx: x,
+          dtdy: 0,
+          dsdy: 1,
+          ty: y,
+        }),
+      );
     }
 
-    throw new Error(`Unknown transform type ${type}`);
+    throw TransformType.makeUnknownTransformTypeError(type);
+  }
+
+  static makeUnknownTransformTypeError(type: TransformTypeFlags): Error {
+    return new Error(`Unknown transform type ${type} found in SF trace entry`);
   }
 
-  static isSimpleTransform(type: TransformType): boolean {
-    return TransformUtils.isFlagClear(
+  static isSimpleTransform(type: TransformTypeFlags): boolean {
+    return TransformType.isFlagClear(
       type,
-      TransformType.ROT_INVALID_VAL | TransformType.SCALE_VAL,
+      TransformTypeFlags.ROT_INVALID_VAL | TransformTypeFlags.SCALE_VAL,
     );
   }
 
-  private static isFlagSet(type: TransformType, bits: number): boolean {
+  private static isFlagSet(type: TransformTypeFlags, bits: number): boolean {
     type = type || 0;
     return (type & bits) === bits;
   }
 
-  private static isFlagClear(type: TransformType, bits: number): boolean {
+  private static isFlagClear(type: TransformTypeFlags, bits: number): boolean {
     return (type & bits) === 0;
   }
 }
diff --git a/tools/winscope/src/parsers/legacy/abstract_traces_parser.ts b/tools/winscope/src/parsers/traces/abstract_traces_parser.ts
similarity index 76%
rename from tools/winscope/src/parsers/legacy/abstract_traces_parser.ts
rename to tools/winscope/src/parsers/traces/abstract_traces_parser.ts
index 3194c8959..8e3c578aa 100644
--- a/tools/winscope/src/parsers/legacy/abstract_traces_parser.ts
+++ b/tools/winscope/src/parsers/traces/abstract_traces_parser.ts
@@ -26,19 +26,13 @@ import {Parser} from 'trace/parser';
 import {TraceType} from 'trace/trace_type';
 
 export abstract class AbstractTracesParser<T> implements Parser<T> {
-  private timestamps: Timestamp[] | undefined;
+  protected timestamps: Timestamp[] | undefined;
   protected timestampConverter: ParserTimestampConverter;
 
-  protected abstract getTimestamp(decodedEntry: any): Timestamp;
-
   constructor(timestampConverter: ParserTimestampConverter) {
     this.timestampConverter = timestampConverter;
   }
 
-  getCoarseVersion(): CoarseVersion {
-    return CoarseVersion.LEGACY;
-  }
-
   customQuery<Q extends CustomQueryType>(
     type: Q,
     entriesRange: EntriesRange,
@@ -50,21 +44,9 @@ export abstract class AbstractTracesParser<T> implements Parser<T> {
     return this.timestamps;
   }
 
-  async createTimestamps() {
-    this.timestamps = await this.decodeTimestamps();
-  }
-
-  private async decodeTimestamps() {
-    const timestampsNs = [];
-    for (let index = 0; index < this.getLengthEntries(); index++) {
-      const entry = await this.getEntry(index);
-      const timestamp = this.getTimestamp(entry);
-      timestampsNs.push(timestamp);
-    }
-    return timestampsNs;
-  }
-
+  abstract getCoarseVersion(): CoarseVersion;
   abstract parse(): Promise<void>;
+  abstract createTimestamps(): Promise<void>;
   abstract getDescriptors(): string[];
   abstract getTraceType(): TraceType;
   abstract getEntry(index: AbsoluteEntryIndex): Promise<T>;
diff --git a/tools/winscope/src/parsers/legacy/traces_parser_factory.ts b/tools/winscope/src/parsers/traces/traces_parser_factory.ts
similarity index 58%
rename from tools/winscope/src/parsers/legacy/traces_parser_factory.ts
rename to tools/winscope/src/parsers/traces/traces_parser_factory.ts
index b8cca7909..d438d1bf2 100644
--- a/tools/winscope/src/parsers/legacy/traces_parser_factory.ts
+++ b/tools/winscope/src/parsers/traces/traces_parser_factory.ts
@@ -14,14 +14,22 @@
  * limitations under the License.
  */
 
+import {assertTrue} from 'common/assert_utils';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
+import {UserNotifier} from 'common/user_notifier';
+import {FailedToCreateTracesParser} from 'messaging/user_warnings';
 import {TracesParserCujs} from 'parsers/events/traces_parser_cujs';
+import {TracesParserInput} from 'parsers/input/perfetto/traces_parser_input';
 import {TracesParserTransitions} from 'parsers/transitions/legacy/traces_parser_transitions';
 import {Parser} from 'trace/parser';
 import {Traces} from 'trace/traces';
 
 export class TracesParserFactory {
-  static readonly PARSERS = [TracesParserCujs, TracesParserTransitions];
+  static readonly PARSERS = [
+    TracesParserCujs,
+    TracesParserTransitions,
+    TracesParserInput,
+  ];
 
   async createParsers(
     traces: Traces,
@@ -30,12 +38,27 @@ export class TracesParserFactory {
     const parsers: Array<Parser<object>> = [];
 
     for (const ParserType of TracesParserFactory.PARSERS) {
+      let hasFoundParser = false;
+      const parser = new ParserType(traces, timestampConverter);
       try {
-        const parser = new ParserType(traces, timestampConverter);
         await parser.parse();
+        hasFoundParser = true;
+        assertTrue(parser.getLengthEntries() > 0, () => {
+          const descriptors = parser.getDescriptors();
+          return `${descriptors.join(', ')} ${
+            descriptors.length > 1 ? 'files have' : 'has'
+          } no relevant entries`;
+        });
         parsers.push(parser);
       } catch (error) {
-        // skip current parser
+        if (hasFoundParser) {
+          UserNotifier.add(
+            new FailedToCreateTracesParser(
+              parser.getTraceType(),
+              (error as Error).message,
+            ),
+          );
+        }
       }
     }
 
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
index c3ac4a4c2..5de877462 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_shell.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {INVALID_TIME_NS, Timestamp} from 'common/time';
+import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
 import root from 'protos/transitions/udc/json';
@@ -73,12 +73,11 @@ export class ParserTransitionsShell extends AbstractParser<PropertyTreeNode> {
   protected override getTimestamp(
     entry: com.android.wm.shell.ITransition,
   ): Timestamp {
-    // for consistency with all transitions, elapsed nanos are defined as shell dispatch time else 0n
     return entry.dispatchTimeNs
       ? this.timestampConverter.makeTimestampFromBootTimeNs(
           BigInt(entry.dispatchTimeNs.toString()),
         )
-      : this.timestampConverter.makeTimestampFromBootTimeNs(INVALID_TIME_NS);
+      : this.timestampConverter.makeZeroTimestamp();
   }
 
   protected getMagicNumber(): number[] | undefined {
@@ -89,7 +88,7 @@ export class ParserTransitionsShell extends AbstractParser<PropertyTreeNode> {
     entry: com.android.wm.shell.ITransition,
   ) {
     if (entry.id === 0) {
-      throw new Error('Proto needs a non-null id');
+      throw new Error('Shell Transitions entry needs non-null id');
     }
     if (
       !entry.dispatchTimeNs &&
@@ -97,13 +96,15 @@ export class ParserTransitionsShell extends AbstractParser<PropertyTreeNode> {
       !entry.mergeTimeNs &&
       !entry.abortTimeNs
     ) {
-      throw new Error('Requires at least one non-null timestamp');
+      throw new Error(
+        'Shell Transitions entry requires at least one non-null timestamp',
+      );
     }
     if (this.realToBootTimeOffsetNs === undefined) {
-      throw new Error('missing realToBootTimeOffsetNs');
+      throw new Error('Shell Transitions trace missing realToBootTimeOffsetNs');
     }
     if (this.handlerMapping === undefined) {
-      throw new Error('Missing handler mapping');
+      throw new Error('Shell Transitions trace missing handler mapping');
     }
   }
 
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
index 77c4bd3ea..bf46a9da8 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {INVALID_TIME_NS, Timestamp} from 'common/time';
+import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
 import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
 import root from 'protos/transitions/udc/json';
@@ -71,14 +71,14 @@ export class ParserTransitionsWm extends AbstractParser<PropertyTreeNode> {
     entry: com.android.server.wm.shell.ITransition,
   ): Timestamp {
     // for consistency with all transitions, elapsed nanos are defined as shell dispatch time else INVALID_TIME_NS
-    return this.timestampConverter.makeTimestampFromBootTimeNs(INVALID_TIME_NS);
+    return this.timestampConverter.makeZeroTimestamp();
   }
 
   private validateWmTransitionEntry(
     entry: com.android.server.wm.shell.ITransition,
   ) {
     if (entry.id === 0) {
-      throw new Error('Entry need a non null id');
+      throw new Error('WM Transition entry needs non-null id');
     }
     if (
       !entry.createTimeNs &&
@@ -86,10 +86,12 @@ export class ParserTransitionsWm extends AbstractParser<PropertyTreeNode> {
       !entry.abortTimeNs &&
       !entry.finishTimeNs
     ) {
-      throw new Error('Requires at least one non-null timestamp');
+      throw new Error(
+        'WM Transition entry requires at least one non-null timestamp',
+      );
     }
     if (this.realToBootTimeOffsetNs === undefined) {
-      throw new Error('missing realToBootTimeOffsetNs');
+      throw new Error('WM Transition trace missing realToBootTimeOffsetNs');
     }
   }
 
diff --git a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
index 7bdb84dd3..ff25c3ef6 100644
--- a/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/parser_transitions_wm_test.ts
@@ -42,8 +42,7 @@ describe('WmFileParserTransitions', () => {
   it('provides timestamps', () => {
     const timestamps = assertDefined(parser.getTimestamps());
     expect(timestamps.length).toEqual(8);
-    const expected =
-      TimestampConverterUtils.makeRealTimestamp(1683130827956652323n);
+    const expected = TimestampConverterUtils.makeZeroTimestamp();
     timestamps.forEach((timestamp) => expect(timestamp).toEqual(expected));
   });
 });
diff --git a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
index edd088094..551f71ec2 100644
--- a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions.ts
@@ -17,8 +17,9 @@
 import {assertDefined} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {ParserTimestampConverter} from 'common/timestamp_converter';
-import {AbstractTracesParser} from 'parsers/legacy/abstract_traces_parser';
+import {AbstractTracesParser} from 'parsers/traces/abstract_traces_parser';
 import {ParserTransitionsUtils} from 'parsers/transitions/parser_transitions_utils';
+import {CoarseVersion} from 'trace/coarse_version';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
@@ -45,6 +46,10 @@ export class TracesParserTransitions extends AbstractTracesParser<PropertyTreeNo
     }
   }
 
+  override getCoarseVersion(): CoarseVersion {
+    return CoarseVersion.LEGACY;
+  }
+
   override async parse() {
     if (this.wmTransitionTrace === undefined) {
       throw new Error('Missing WM Transition trace');
@@ -69,6 +74,32 @@ export class TracesParserTransitions extends AbstractTracesParser<PropertyTreeNo
     await this.createTimestamps();
   }
 
+  override async createTimestamps() {
+    this.timestamps = [];
+    for (let index = 0; index < this.getLengthEntries(); index++) {
+      const entry = await this.getEntry(index);
+
+      const shellData = entry.getChildByName('shellData');
+      const dispatchTimestamp: Timestamp | undefined = shellData
+        ?.getChildByName('dispatchTimeNs')
+        ?.getValue();
+
+      const realToBootTimeOffsetNs: bigint =
+        shellData
+          ?.getChildByName('realToBootTimeOffsetTimestamp')
+          ?.getValue()
+          ?.getValueNs() ?? 0n;
+
+      // for consistency with all transitions, elapsed nanos are defined as shell dispatch time else 0n
+      const timestampNs: bigint = dispatchTimestamp
+        ? dispatchTimestamp.getValueNs()
+        : realToBootTimeOffsetNs;
+      const timestamp =
+        this.timestampConverter.makeTimestampFromRealNs(timestampNs);
+      this.timestamps.push(timestamp);
+    }
+  }
+
   override getLengthEntries(): number {
     return assertDefined(this.decodedEntries).length;
   }
@@ -94,25 +125,6 @@ export class TracesParserTransitions extends AbstractTracesParser<PropertyTreeNo
     return undefined;
   }
 
-  protected override getTimestamp(decodedEntry: PropertyTreeNode): Timestamp {
-    // for consistency with all transitions, elapsed nanos are defined as shell dispatch time else 0n
-    const shellData = decodedEntry.getChildByName('shellData');
-    const dispatchTimestamp: Timestamp | undefined = shellData
-      ?.getChildByName('dispatchTimeNs')
-      ?.getValue();
-
-    const realToBootTimeOffsetNs: bigint =
-      shellData
-        ?.getChildByName('realToBootTimeOffsetTimestamp')
-        ?.getValue()
-        ?.getValueNs() ?? 0n;
-
-    const timestampNs: bigint = dispatchTimestamp
-      ? dispatchTimestamp.getValueNs()
-      : realToBootTimeOffsetNs;
-    return this.timestampConverter.makeTimestampFromRealNs(timestampNs);
-  }
-
   private compressEntries(
     allTransitions: PropertyTreeNode[],
   ): PropertyTreeNode[] {
@@ -171,7 +183,7 @@ export class TracesParserTransitions extends AbstractTracesParser<PropertyTreeNo
       assertDefined(transition1.getChildByName('id')).getValue() !==
       assertDefined(transition2.getChildByName('id')).getValue()
     ) {
-      throw Error("Can't merge transitions with mismatching ids");
+      throw new Error("Can't merge transitions with mismatching ids");
     }
 
     const mergedTransition = this.mergeProperties(
diff --git a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions_test.ts b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions_test.ts
index 8d4927ba5..c81114964 100644
--- a/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions_test.ts
+++ b/tools/winscope/src/parsers/transitions/legacy/traces_parser_transitions_test.ts
@@ -41,6 +41,13 @@ describe('ParserTransitions', () => {
     expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LEGACY);
   });
 
+  it('has expected descriptors', () => {
+    expect(parser.getDescriptors()).toEqual([
+      'wm_transition_trace.pb',
+      'shell_transition_trace.pb',
+    ]);
+  });
+
   it('provides timestamps', () => {
     const timestamps = assertDefined(parser.getTimestamps());
     const expected = [
diff --git a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
index a2161b119..2c54cf385 100644
--- a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
+++ b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions.ts
@@ -142,7 +142,7 @@ export class ParserTransitions extends AbstractParser<PropertyTreeNode> {
     transition: perfetto.protos.IShellTransition,
   ) {
     if (transition.id === 0) {
-      throw new Error('Entry need a non null id');
+      throw new Error('Transitions entry need a non null id');
     }
     if (
       !transition.createTimeNs &&
@@ -154,7 +154,9 @@ export class ParserTransitions extends AbstractParser<PropertyTreeNode> {
       !transition.mergeTimeNs &&
       !transition.shellAbortTimeNs
     ) {
-      throw new Error('Requires at least one non-null timestamp');
+      throw new Error(
+        'Transitions entry requires at least one non-null timestamp',
+      );
     }
   }
 }
diff --git a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
index a428c646e..3f6118b9c 100644
--- a/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
+++ b/tools/winscope/src/parsers/transitions/perfetto/parser_transitions_test.ts
@@ -44,7 +44,7 @@ describe('Perfetto ParserTransitions', () => {
 
     it('provides timestamps', () => {
       const expected = [
-        TimestampConverterUtils.makeRealTimestamp(1700572945845474854n),
+        TimestampConverterUtils.makeZeroTimestamp(),
         TimestampConverterUtils.makeRealTimestamp(1700573425448299306n),
         TimestampConverterUtils.makeRealTimestamp(1700573426522433299n),
       ];
@@ -60,9 +60,9 @@ describe('Perfetto ParserTransitions', () => {
       expect(entry.getChildByName('id')?.getValue()).toEqual(32n);
       expect(
         wmDataNode.getChildByName('createTimeNs')?.formattedValue(),
-      ).toEqual('2023-11-21, 13:30:25.428');
+      ).toEqual('2023-11-21, 13:30:25.429');
       expect(wmDataNode.getChildByName('sendTimeNs')?.formattedValue()).toEqual(
-        '2023-11-21, 13:30:25.441',
+        '2023-11-21, 13:30:25.442',
       );
       expect(
         wmDataNode.getChildByName('finishTimeNs')?.formattedValue(),
diff --git a/tools/winscope/src/parsers/view_capture/computations/rects_computation.ts b/tools/winscope/src/parsers/view_capture/computations/rects_computation.ts
index 07406029d..f53f27d1b 100644
--- a/tools/winscope/src/parsers/view_capture/computations/rects_computation.ts
+++ b/tools/winscope/src/parsers/view_capture/computations/rects_computation.ts
@@ -76,9 +76,10 @@ class RectVcFactory {
         node.getEagerPropertyByName('isComputedVisible')?.getValue() ?? false,
       )
       .setIsDisplay(false)
-      .setIsVirtual(false)
+      .setIsActiveDisplay(false)
       .setDepth(depth * RectVcFactory.DEPTH_MAGNIFICATION)
       .setOpacity(nodeAlpha)
+      .setIsSpy(false)
       .build();
 
     return rect;
@@ -97,7 +98,7 @@ export class RectsComputation {
 
   executeInPlace(): void {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set in VC rects computation');
     }
 
     this.addRects(this.root, 0, 0, 1, 1, 0);
diff --git a/tools/winscope/src/parsers/view_capture/computations/rects_computation_test.ts b/tools/winscope/src/parsers/view_capture/computations/rects_computation_test.ts
index ec0a72c7f..76465d814 100644
--- a/tools/winscope/src/parsers/view_capture/computations/rects_computation_test.ts
+++ b/tools/winscope/src/parsers/view_capture/computations/rects_computation_test.ts
@@ -21,7 +21,7 @@ import {TraceRectBuilder} from 'trace/trace_rect_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {RectsComputation} from './rects_computation';
 
-describe('RectsComputation', () => {
+describe('ViewCapture RectsComputation', () => {
   let hierarchyRoot: HierarchyTreeNode;
   let computation: RectsComputation;
 
@@ -100,9 +100,9 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(true)
         .setIsDisplay(false)
-        .setIsVirtual(false)
         .setDepth(0)
         .setOpacity(1)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -116,9 +116,9 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(false)
-        .setIsVirtual(false)
         .setDepth(4)
         .setOpacity(1)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -132,9 +132,9 @@ describe('RectsComputation', () => {
         .setGroupId(0)
         .setIsVisible(false)
         .setIsDisplay(false)
-        .setIsVirtual(false)
         .setDepth(8)
         .setOpacity(1)
+        .setIsSpy(false)
         .build(),
     ];
 
diff --git a/tools/winscope/src/parsers/view_capture/computations/visibility_computation.ts b/tools/winscope/src/parsers/view_capture/computations/visibility_computation.ts
index 16e10d80a..2117f8501 100644
--- a/tools/winscope/src/parsers/view_capture/computations/visibility_computation.ts
+++ b/tools/winscope/src/parsers/view_capture/computations/visibility_computation.ts
@@ -31,7 +31,7 @@ export class VisibilityComputation implements Computation {
 
   executeInPlace(): void {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set in VC visibility computation');
     }
 
     this.root.forEachNodeDfs((node) => {
diff --git a/tools/winscope/src/parsers/window_manager/computations/rects_computation.ts b/tools/winscope/src/parsers/window_manager/computations/rects_computation.ts
index 1ab2158ad..65f0b903b 100644
--- a/tools/winscope/src/parsers/window_manager/computations/rects_computation.ts
+++ b/tools/winscope/src/parsers/window_manager/computations/rects_computation.ts
@@ -21,13 +21,21 @@ import {Computation} from 'trace/tree_node/computation';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 
 class RectWmFactory {
-  makeDisplayRect(display: HierarchyTreeNode, absoluteZ: number): TraceRect {
+  makeDisplayRect(
+    display: HierarchyTreeNode,
+    absoluteZ: number,
+    focusedApp: string,
+  ): TraceRect {
     const displayInfo = display.getEagerPropertyByName('displayInfo');
     const displayRectWidth =
       displayInfo?.getChildByName('logicalWidth')?.getValue() ?? 0;
     const displayRectHeight =
       displayInfo?.getChildByName('logicalHeight')?.getValue() ?? 0;
 
+    const displayFocusedApp = display
+      .getEagerPropertyByName('focusedApp')
+      ?.getValue();
+
     return new TraceRectBuilder()
       .setX(0)
       .setY(0)
@@ -41,8 +49,9 @@ class RectWmFactory {
       )
       .setIsVisible(false)
       .setIsDisplay(true)
-      .setIsVirtual(false)
+      .setIsActiveDisplay(focusedApp === displayFocusedApp)
       .setDepth(absoluteZ)
+      .setIsSpy(false)
       .build();
   }
 
@@ -88,9 +97,9 @@ class RectWmFactory {
       .setGroupId(displayId)
       .setIsVisible(isVisible)
       .setIsDisplay(false)
-      .setIsVirtual(false)
       .setDepth(absoluteZ)
       .setOpacity(alpha)
+      .setIsSpy(false)
       .build();
   }
 }
@@ -106,11 +115,19 @@ export class RectsComputation implements Computation {
 
   executeInPlace(): void {
     if (!this.root) {
-      throw Error('root not set');
+      throw new Error('root not set in WM rects computation');
     }
 
+    const focusedApp = this.root
+      .getEagerPropertyByName('focusedApp')
+      ?.getValue();
+
     this.root.getAllChildren().forEach((displayContent) => {
-      const displayRect = this.rectsFactory.makeDisplayRect(displayContent, 0);
+      const displayRect = this.rectsFactory.makeDisplayRect(
+        displayContent,
+        0,
+        focusedApp,
+      );
       displayContent.setRects([displayRect]);
 
       let absoluteZ = 1;
diff --git a/tools/winscope/src/parsers/window_manager/computations/rects_computation_test.ts b/tools/winscope/src/parsers/window_manager/computations/rects_computation_test.ts
index 2369bc602..a67f6db44 100644
--- a/tools/winscope/src/parsers/window_manager/computations/rects_computation_test.ts
+++ b/tools/winscope/src/parsers/window_manager/computations/rects_computation_test.ts
@@ -15,7 +15,8 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {com} from 'protos/windowmanager/latest/static';
+import {perfetto} from 'protos/windowmanager/latest/static';
+import {com} from 'protos/windowmanager/udc/static';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {TraceRect} from 'trace/trace_rect';
@@ -23,7 +24,14 @@ import {TraceRectBuilder} from 'trace/trace_rect_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {RectsComputation} from './rects_computation';
 
-describe('RectsComputation', () => {
+type DisplayContentProto =
+  | com.android.server.wm.IDisplayContentProto
+  | perfetto.protos.IDisplayContentProto;
+type WindowStateProto =
+  | com.android.server.wm.IWindowStateProto
+  | perfetto.protos.IWindowStateProto;
+
+describe('WindowManager RectsComputation', () => {
   let hierarchyRoot: HierarchyTreeNode;
   let computation: RectsComputation;
   let displayContent: HierarchyTreeNode;
@@ -32,6 +40,7 @@ describe('RectsComputation', () => {
     hierarchyRoot = new HierarchyTreeBuilder()
       .setId('WindowManagerState')
       .setName('root')
+      .setProperties({focusedApp: 'testApp'})
       .setChildren([
         {
           id: 1,
@@ -43,7 +52,20 @@ describe('RectsComputation', () => {
               logicalWidth: 5,
               logicalHeight: 5,
             },
-          } as com.android.server.wm.IDisplayContentProto,
+          } as DisplayContentProto,
+        },
+        {
+          id: 2,
+          name: 'Focused Display',
+          properties: {
+            id: 2,
+            name: 'Focused Display',
+            displayInfo: {
+              logicalWidth: 5,
+              logicalHeight: 5,
+            },
+            focusedApp: 'testApp',
+          } as DisplayContentProto,
         },
       ])
       .build();
@@ -67,12 +89,38 @@ describe('RectsComputation', () => {
         .setGroupId(1)
         .setIsVisible(false)
         .setIsDisplay(true)
-        .setIsVirtual(false)
+        .setIsActiveDisplay(false)
+        .setIsSpy(false)
+        .build(),
+
+      new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(5)
+        .setHeight(5)
+        .setId('2 Focused Display')
+        .setName('Display - Focused Display')
+        .setCornerRadius(0)
+        .setDepth(0)
+        .setGroupId(2)
+        .setIsVisible(false)
+        .setIsDisplay(true)
+        .setIsActiveDisplay(true)
+        .setIsSpy(false)
         .build(),
     ];
 
     computation.setRoot(hierarchyRoot).executeInPlace();
-    expect(displayContent.getRects()).toEqual(expectedDisplayRects);
+
+    const displayRects = displayContent
+      .getRects()
+      ?.concat(
+        assertDefined(
+          hierarchyRoot.getChildByName('Focused Display')?.getRects(),
+        ),
+      );
+
+    expect(displayRects).toEqual(expectedDisplayRects);
   });
 
   it('makes window state rects', () => {
@@ -87,7 +135,7 @@ describe('RectsComputation', () => {
       attributes: {
         alpha: 0.5,
       },
-    } as com.android.server.wm.IWindowStateProto);
+    } as WindowStateProto);
 
     state1Node.addOrReplaceChild(
       TreeNodeUtils.makeHierarchyNode({
@@ -101,7 +149,7 @@ describe('RectsComputation', () => {
         attributes: {
           alpha: 0.5,
         },
-      } as com.android.server.wm.IWindowStateProto),
+      } as WindowStateProto),
     );
     displayContent.addOrReplaceChild(state1Node);
 
@@ -118,8 +166,8 @@ describe('RectsComputation', () => {
         .setGroupId(1)
         .setIsVisible(true)
         .setIsDisplay(false)
-        .setIsVirtual(false)
         .setOpacity(0.5)
+        .setIsSpy(false)
         .build(),
 
       new TraceRectBuilder()
@@ -134,8 +182,8 @@ describe('RectsComputation', () => {
         .setGroupId(1)
         .setIsVisible(false)
         .setIsDisplay(false)
-        .setIsVirtual(false)
         .setOpacity(0.5)
+        .setIsSpy(false)
         .build(),
     ];
 
diff --git a/tools/winscope/src/parsers/window_manager/custom_query_utils.ts b/tools/winscope/src/parsers/window_manager/custom_query_utils.ts
index 67bcb7d8d..d8e99f6b9 100644
--- a/tools/winscope/src/parsers/window_manager/custom_query_utils.ts
+++ b/tools/winscope/src/parsers/window_manager/custom_query_utils.ts
@@ -13,7 +13,8 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {com} from 'protos/windowmanager/latest/static';
+import {perfetto} from 'protos/windowmanager/latest/static';
+import {com} from 'protos/windowmanager/udc/static';
 import {
   CustomQueryParserResultTypeMap,
   CustomQueryType,
@@ -22,11 +23,37 @@ import {
 type WindowsTokenAndTitle =
   CustomQueryParserResultTypeMap[CustomQueryType.WM_WINDOWS_TOKEN_AND_TITLE];
 
+type ActivityRecordProto =
+  | com.android.server.wm.IActivityRecordProto
+  | perfetto.protos.IActivityRecordProto;
+type DisplayAreaProto =
+  | com.android.server.wm.IDisplayAreaProto
+  | perfetto.protos.DisplayAreaProto;
+type DisplayContentProto =
+  | com.android.server.wm.IDisplayContentProto
+  | perfetto.protos.DisplayContentProto;
+type RootWindowContainerProto =
+  | com.android.server.wm.IRootWindowContainerProto
+  | perfetto.protos.IRootWindowContainerProto;
+type TaskFragmentProto =
+  | com.android.server.wm.ITaskFragmentProto
+  | perfetto.protos.ITaskFragmentProto;
+type TaskProto = com.android.server.wm.ITaskProto | perfetto.protos.ITaskProto;
+type WindowContainerProto =
+  | com.android.server.wm.IWindowContainerProto
+  | perfetto.protos.IWindowContainerProto;
+type WindowStateProto =
+  | com.android.server.wm.IWindowStateProto
+  | perfetto.protos.IWindowStateProto;
+type WindowTokenProto =
+  | com.android.server.wm.IWindowTokenProto
+  | perfetto.protos.IWindowTokenProto;
+
 export class WmCustomQueryUtils {
   private static readonly NA = 'n/a';
 
   static parseWindowsTokenAndTitle(
-    rootWindowContainer: com.android.server.wm.IRootWindowContainerProto,
+    rootWindowContainer: RootWindowContainerProto,
     result: WindowsTokenAndTitle,
   ) {
     const token =
@@ -44,7 +71,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseWindowContainerProto(
-    proto: com.android.server.wm.IWindowContainerProto | null | undefined,
+    proto: WindowContainerProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -85,7 +112,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseActivityRecordProto(
-    proto: com.android.server.wm.IActivityRecordProto | null | undefined,
+    proto: ActivityRecordProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -102,7 +129,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseDisplayAreaProto(
-    proto: com.android.server.wm.IDisplayAreaProto | null | undefined,
+    proto: DisplayAreaProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -117,7 +144,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseDisplayContentProto(
-    proto: com.android.server.wm.IDisplayContentProto | null | undefined,
+    proto: DisplayContentProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -136,7 +163,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseTaskProto(
-    proto: com.android.server.wm.ITaskProto | null | undefined,
+    proto: TaskProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -156,7 +183,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseTaskFragmentProto(
-    proto: com.android.server.wm.ITaskFragmentProto | null | undefined,
+    proto: TaskFragmentProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -169,7 +196,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseWindowStateProto(
-    proto: com.android.server.wm.IWindowStateProto | null | undefined,
+    proto: WindowStateProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
@@ -185,7 +212,7 @@ export class WmCustomQueryUtils {
   }
 
   private static parseWindowTokenProto(
-    proto: com.android.server.wm.IWindowTokenProto | null | undefined,
+    proto: WindowTokenProto | null | undefined,
     result: WindowsTokenAndTitle,
   ) {
     if (!proto) {
diff --git a/tools/winscope/src/parsers/window_manager/wm_denylist_properties.ts b/tools/winscope/src/parsers/window_manager/denylist_properties.ts
similarity index 59%
rename from tools/winscope/src/parsers/window_manager/wm_denylist_properties.ts
rename to tools/winscope/src/parsers/window_manager/denylist_properties.ts
index 2d4e77f8d..663bd0079 100644
--- a/tools/winscope/src/parsers/window_manager/wm_denylist_properties.ts
+++ b/tools/winscope/src/parsers/window_manager/denylist_properties.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {WmProtoType} from './wm_proto_type';
+import {ProtoType} from './proto_type';
 
 const commonDenylistProperties = [
   'prototype',
@@ -22,24 +22,24 @@ const commonDenylistProperties = [
   'children',
 ];
 
-export const WM_DENYLIST_PROPERTIES = new Map<WmProtoType, string[]>([
+export const DENYLIST_PROPERTIES = new Map<ProtoType, string[]>([
   [
-    WmProtoType.WindowManagerService,
+    ProtoType.WindowManagerService,
     commonDenylistProperties.concat(['windowContainer']),
   ],
-  [WmProtoType.RootWindowContainer, commonDenylistProperties],
-  [WmProtoType.WindowContainer, commonDenylistProperties],
+  [ProtoType.RootWindowContainer, commonDenylistProperties],
+  [ProtoType.WindowContainer, commonDenylistProperties],
   [
-    WmProtoType.DisplayContent,
+    ProtoType.DisplayContent,
     commonDenylistProperties.concat(['windowContainer']),
   ],
-  [WmProtoType.DisplayArea, commonDenylistProperties],
-  [WmProtoType.Task, commonDenylistProperties.concat(['windowContainer'])],
-  [WmProtoType.Activity, commonDenylistProperties],
-  [WmProtoType.WindowToken, commonDenylistProperties],
-  [WmProtoType.WindowState, commonDenylistProperties],
+  [ProtoType.DisplayArea, commonDenylistProperties],
+  [ProtoType.Task, commonDenylistProperties.concat(['windowContainer'])],
+  [ProtoType.Activity, commonDenylistProperties],
+  [ProtoType.WindowToken, commonDenylistProperties],
+  [ProtoType.WindowState, commonDenylistProperties],
   [
-    WmProtoType.TaskFragment,
+    ProtoType.TaskFragment,
     commonDenylistProperties.concat(['windowContainer']),
   ],
 ]);
diff --git a/tools/winscope/src/parsers/window_manager/wm_eager_properties.ts b/tools/winscope/src/parsers/window_manager/eager_properties.ts
similarity index 69%
rename from tools/winscope/src/parsers/window_manager/wm_eager_properties.ts
rename to tools/winscope/src/parsers/window_manager/eager_properties.ts
index 41680b33c..70ab65b39 100644
--- a/tools/winscope/src/parsers/window_manager/wm_eager_properties.ts
+++ b/tools/winscope/src/parsers/window_manager/eager_properties.ts
@@ -14,23 +14,23 @@
  * limitations under the License.
  */
 
-import {WmProtoType} from './wm_proto_type';
+import {ProtoType} from './proto_type';
 
 const commonEagerProperties = ['identifier', 'id', 'name'];
 
-export const WM_EAGER_PROPERTIES = new Map<WmProtoType, string[]>([
+export const EAGER_PROPERTIES = new Map<ProtoType, string[]>([
   [
-    WmProtoType.WindowManagerService,
+    ProtoType.WindowManagerService,
     commonEagerProperties.concat([
       'focusedApp',
       'focusedWindow',
       'focusedDisplayId',
     ]),
   ],
-  [WmProtoType.RootWindowContainer, commonEagerProperties],
-  [WmProtoType.WindowContainer, commonEagerProperties.concat(['visible'])],
+  [ProtoType.RootWindowContainer, commonEagerProperties.concat('focusedApp')],
+  [ProtoType.WindowContainer, commonEagerProperties.concat(['visible'])],
   [
-    WmProtoType.DisplayContent,
+    ProtoType.DisplayContent,
     commonEagerProperties.concat([
       'resumedActivity',
       'displayInfo',
@@ -39,21 +39,22 @@ export const WM_EAGER_PROPERTIES = new Map<WmProtoType, string[]>([
       'inputMethodTarget',
       'imeInsetsSourceProvider',
       'windowContainer',
+      'focusedApp',
     ]),
   ],
-  [WmProtoType.DisplayArea, commonEagerProperties],
+  [ProtoType.DisplayArea, commonEagerProperties],
   [
-    WmProtoType.Task,
+    ProtoType.Task,
     commonEagerProperties.concat([
       'displayId',
       'rootTaskId',
       'createdByOrganizer',
     ]),
   ],
-  [WmProtoType.Activity, commonEagerProperties.concat(['state', 'visible'])],
-  [WmProtoType.WindowToken, commonEagerProperties],
+  [ProtoType.Activity, commonEagerProperties.concat(['state', 'visible'])],
+  [ProtoType.WindowToken, commonEagerProperties],
   [
-    WmProtoType.WindowState,
+    ProtoType.WindowState,
     commonEagerProperties.concat([
       'isVisible',
       'windowFrames',
@@ -66,5 +67,5 @@ export const WM_EAGER_PROPERTIES = new Map<WmProtoType, string[]>([
       'animatingExit',
     ]),
   ],
-  [WmProtoType.TaskFragment, commonEagerProperties.concat(['displayId'])],
+  [ProtoType.TaskFragment, commonEagerProperties.concat(['displayId'])],
 ]);
diff --git a/tools/winscope/src/parsers/window_manager/parser_window_manager.ts b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager.ts
similarity index 77%
rename from tools/winscope/src/parsers/window_manager/parser_window_manager.ts
rename to tools/winscope/src/parsers/window_manager/legacy/parser_window_manager.ts
index 44f646dcf..29d0b1379 100644
--- a/tools/winscope/src/parsers/window_manager/parser_window_manager.ts
+++ b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager.ts
@@ -17,7 +17,13 @@
 import {assertDefined} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
-import {com} from 'protos/windowmanager/latest/static';
+import {TamperedMessageType} from 'parsers/tampered_message_type';
+import {RectsComputation} from 'parsers/window_manager/computations/rects_computation';
+import {WmCustomQueryUtils} from 'parsers/window_manager/custom_query_utils';
+import {HierarchyTreeBuilderWm} from 'parsers/window_manager/hierarchy_tree_builder_wm';
+import {PropertiesProviderFactory} from 'parsers/window_manager/properties_provider_factory';
+import root from 'protos/windowmanager/udc/json';
+import {com} from 'protos/windowmanager/udc/static';
 import {
   CustomQueryParserResultTypeMap,
   CustomQueryType,
@@ -27,17 +33,18 @@ import {EntriesRange} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {RectsComputation} from './computations/rects_computation';
-import {WmCustomQueryUtils} from './custom_query_utils';
-import {HierarchyTreeBuilderWm} from './hierarchy_tree_builder_wm';
-import {ParserWmUtils} from './parser_window_manager_utils';
-import {WindowManagerTraceFileProto} from './wm_tampered_protos';
+import {TAMPERED_PROTOS_UDC} from './tampered_protos_udc';
 
 export class ParserWindowManager extends AbstractParser<HierarchyTreeNode> {
   private static readonly MAGIC_NUMBER = [
     0x09, 0x57, 0x49, 0x4e, 0x54, 0x52, 0x41, 0x43, 0x45,
   ]; // .WINTRACE
+  private static readonly WindowManagerTraceFileProto =
+    TamperedMessageType.tamper(
+      root.lookupType('com.android.server.wm.WindowManagerTraceFileProto'),
+    );
 
+  private readonly factory = new PropertiesProviderFactory(TAMPERED_PROTOS_UDC);
   private realToBootTimeOffsetNs: bigint | undefined;
 
   override getTraceType(): TraceType {
@@ -59,7 +66,7 @@ export class ParserWindowManager extends AbstractParser<HierarchyTreeNode> {
   override decodeTrace(
     buffer: Uint8Array,
   ): com.android.server.wm.IWindowManagerTraceProto[] {
-    const decoded = WindowManagerTraceFileProto.decode(
+    const decoded = ParserWindowManager.WindowManagerTraceFileProto.decode(
       buffer,
     ) as com.android.server.wm.IWindowManagerTraceFileProto;
     const timeOffset = BigInt(
@@ -109,11 +116,12 @@ export class ParserWindowManager extends AbstractParser<HierarchyTreeNode> {
   private makeHierarchyTree(
     entryProto: com.android.server.wm.IWindowManagerTraceProto,
   ): HierarchyTreeNode {
-    const containers: PropertiesProvider[] = ParserWmUtils.extractContainers(
-      assertDefined(entryProto.windowManagerService),
-    );
+    const containers: PropertiesProvider[] =
+      this.factory.makeContainerProperties(
+        assertDefined(entryProto.windowManagerService),
+      );
 
-    const entry = ParserWmUtils.makeEntryProperties(
+    const entry = this.factory.makeEntryProperties(
       assertDefined(entryProto.windowManagerService),
     );
 
diff --git a/tools/winscope/src/parsers/window_manager/parser_window_manager_dump.ts b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_dump.ts
similarity index 82%
rename from tools/winscope/src/parsers/window_manager/parser_window_manager_dump.ts
rename to tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_dump.ts
index f6ec0636c..7461e6e7a 100644
--- a/tools/winscope/src/parsers/window_manager/parser_window_manager_dump.ts
+++ b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_dump.ts
@@ -17,7 +17,11 @@
 import {assertDefined} from 'common/assert_utils';
 import {Timestamp} from 'common/time';
 import {AbstractParser} from 'parsers/legacy/abstract_parser';
-import {com} from 'protos/windowmanager/latest/static';
+import {RectsComputation} from 'parsers/window_manager/computations/rects_computation';
+import {WmCustomQueryUtils} from 'parsers/window_manager/custom_query_utils';
+import {HierarchyTreeBuilderWm} from 'parsers/window_manager/hierarchy_tree_builder_wm';
+import {PropertiesProviderFactory} from 'parsers/window_manager/properties_provider_factory';
+import {com} from 'protos/windowmanager/udc/static';
 import {
   CustomQueryParserResultTypeMap,
   CustomQueryType,
@@ -27,13 +31,11 @@ import {EntriesRange} from 'trace/index_types';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
-import {RectsComputation} from './computations/rects_computation';
-import {WmCustomQueryUtils} from './custom_query_utils';
-import {HierarchyTreeBuilderWm} from './hierarchy_tree_builder_wm';
-import {ParserWmUtils} from './parser_window_manager_utils';
-import {WindowManagerServiceField} from './wm_tampered_protos';
+import {TAMPERED_PROTOS_UDC} from './tampered_protos_udc';
 
 class ParserWindowManagerDump extends AbstractParser {
+  private readonly factory = new PropertiesProviderFactory(TAMPERED_PROTOS_UDC);
+
   override getTraceType(): TraceType {
     return TraceType.WINDOW_MANAGER;
   }
@@ -54,7 +56,7 @@ class ParserWindowManagerDump extends AbstractParser {
     buffer: Uint8Array,
   ): com.android.server.wm.IWindowManagerServiceDumpProto[] {
     const entryProto = assertDefined(
-      WindowManagerServiceField.tamperedMessageType,
+      TAMPERED_PROTOS_UDC.windowManagerServiceField.tamperedMessageType,
     ).decode(buffer) as com.android.server.wm.IWindowManagerServiceDumpProto;
 
     // This parser is prone to accepting invalid inputs because it lacks a magic
@@ -83,11 +85,10 @@ class ParserWindowManagerDump extends AbstractParser {
   private makeHierarchyTree(
     entryProto: com.android.server.wm.IWindowManagerServiceDumpProto,
   ): HierarchyTreeNode {
-    const containers: PropertiesProvider[] = ParserWmUtils.extractContainers(
-      assertDefined(entryProto),
-    );
+    const containers: PropertiesProvider[] =
+      this.factory.makeContainerProperties(assertDefined(entryProto));
 
-    const entry = ParserWmUtils.makeEntryProperties(entryProto);
+    const entry = this.factory.makeEntryProperties(entryProto);
 
     return new HierarchyTreeBuilderWm()
       .setRoot(entry)
diff --git a/tools/winscope/src/parsers/window_manager/parser_window_manager_dump_test.ts b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_dump_test.ts
similarity index 100%
rename from tools/winscope/src/parsers/window_manager/parser_window_manager_dump_test.ts
rename to tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_dump_test.ts
diff --git a/tools/winscope/src/parsers/window_manager/parser_window_manager_test.ts b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_test.ts
similarity index 79%
rename from tools/winscope/src/parsers/window_manager/parser_window_manager_test.ts
rename to tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_test.ts
index c2e2beaca..cdf3ddd64 100644
--- a/tools/winscope/src/parsers/window_manager/parser_window_manager_test.ts
+++ b/tools/winscope/src/parsers/window_manager/legacy/parser_window_manager_test.ts
@@ -102,4 +102,33 @@ describe('ParserWindowManager', () => {
       expect(entry.id).toEqual('WindowManagerState root');
     });
   });
+
+  describe('critical mode trace', () => {
+    let parser: Parser<HierarchyTreeNode>;
+
+    beforeAll(async () => {
+      parser = (await UnitTestUtils.getParser(
+        'traces/elapsed_and_real_timestamp/window_trace_critical.winscope',
+      )) as Parser<HierarchyTreeNode>;
+    });
+
+    it('has expected trace type', () => {
+      expect(parser.getTraceType()).toEqual(TraceType.WINDOW_MANAGER);
+    });
+
+    it('provides timestamps', () => {
+      const expected = [
+        TimestampConverterUtils.makeRealTimestamp(1721405245732015868n),
+        TimestampConverterUtils.makeRealTimestamp(1721405246510267496n),
+        TimestampConverterUtils.makeRealTimestamp(1721405246549639200n),
+      ];
+      expect(parser.getTimestamps()?.slice(0, 3)).toEqual(expected);
+    });
+
+    it('retrieves trace entry', async () => {
+      const entry = await parser.getEntry(0);
+      expect(entry).toBeInstanceOf(HierarchyTreeNode);
+      expect(entry.id).toEqual('WindowManagerState root');
+    });
+  });
 });
diff --git a/tools/winscope/src/parsers/window_manager/legacy/tampered_protos_udc.ts b/tools/winscope/src/parsers/window_manager/legacy/tampered_protos_udc.ts
new file mode 100644
index 000000000..665c27441
--- /dev/null
+++ b/tools/winscope/src/parsers/window_manager/legacy/tampered_protos_udc.ts
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TamperedMessageType} from 'parsers/tampered_message_type';
+import {TamperedProtos} from 'parsers/window_manager/tampered_protos';
+import root from 'protos/windowmanager/udc/json';
+
+const windowManagerTraceFileProto = TamperedMessageType.tamper(
+  root.lookupType('com.android.server.wm.WindowManagerTraceFileProto'),
+);
+
+const entryField = assertDefined(windowManagerTraceFileProto.fields['entry']);
+
+const windowManagerServiceField = assertDefined(entryField.tamperedMessageType)
+  .fields['windowManagerService'];
+
+const rootWindowContainerField = assertDefined(
+  windowManagerServiceField.tamperedMessageType,
+).fields['rootWindowContainer'];
+
+const windowContainerField = assertDefined(
+  rootWindowContainerField.tamperedMessageType,
+).fields['windowContainer'];
+
+const windowContainerChildField = assertDefined(
+  windowContainerField.tamperedMessageType,
+).fields['children'];
+
+export const TAMPERED_PROTOS_UDC: TamperedProtos = {
+  entryField,
+
+  windowManagerServiceField: assertDefined(
+    windowManagerTraceFileProto.fields['entry'].tamperedMessageType,
+  ).fields['windowManagerService'],
+
+  rootWindowContainerField: assertDefined(
+    windowManagerServiceField.tamperedMessageType,
+  ).fields['rootWindowContainer'],
+
+  windowContainerField: assertDefined(
+    rootWindowContainerField.tamperedMessageType,
+  ).fields['windowContainer'],
+
+  windowContainerChildField: assertDefined(
+    windowContainerField.tamperedMessageType,
+  ).fields['children'],
+
+  displayContentField: assertDefined(
+    windowContainerChildField.tamperedMessageType,
+  ).fields['displayContent'],
+
+  displayAreaField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['displayArea'],
+
+  taskField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['task'],
+
+  activityField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['activity'],
+
+  windowTokenField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['windowToken'],
+
+  windowStateField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['window'],
+
+  taskFragmentField: assertDefined(
+    windowContainerChildField.tamperedMessageType,
+  ).fields['taskFragment'],
+};
diff --git a/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts b/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
index f777c6365..43e499dab 100644
--- a/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
+++ b/tools/winscope/src/parsers/window_manager/operations/operation_lists.ts
@@ -14,13 +14,14 @@
  * limitations under the License.
  */
 
+import {assertDefined} from 'common/assert_utils';
 import {AddDefaults} from 'parsers/operations/add_defaults';
 import {SetFormatters} from 'parsers/operations/set_formatters';
 import {TranslateIntDef} from 'parsers/operations/translate_intdef';
-import {WM_DENYLIST_PROPERTIES} from 'parsers/window_manager/wm_denylist_properties';
-import {WM_EAGER_PROPERTIES} from 'parsers/window_manager/wm_eager_properties';
-import {WmProtoType} from 'parsers/window_manager/wm_proto_type';
-import * as WmTamperedProtos from 'parsers/window_manager/wm_tampered_protos';
+import {DENYLIST_PROPERTIES} from 'parsers/window_manager/denylist_properties';
+import {EAGER_PROPERTIES} from 'parsers/window_manager/eager_properties';
+import {ProtoType} from 'parsers/window_manager/proto_type';
+import {TamperedProtos} from 'parsers/window_manager/tampered_protos';
 import {RECT_FORMATTER} from 'trace/tree_node/formatters';
 import {Operation} from 'trace/tree_node/operations/operation';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
@@ -33,244 +34,252 @@ export interface OperationLists {
   lazy: Array<Operation<PropertyTreeNode>>;
 }
 
-export const WM_OPERATION_LISTS = new Map<WmProtoType, OperationLists>([
-  [
-    WmProtoType.WindowManagerService,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.WindowManagerServiceField),
-        new TranslateIntDef(WmTamperedProtos.WindowManagerServiceField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.WindowManagerServiceField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.WindowManagerService),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.WindowManagerServiceField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.WindowManagerService),
-        ),
-      ],
-    },
-  ],
+export class WmOperationLists {
+  private readonly LISTS = new Map<ProtoType, OperationLists>([
+    [
+      ProtoType.WindowManagerService,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.windowManagerServiceField),
+          new TranslateIntDef(this.tamperedProtos.windowManagerServiceField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.windowManagerServiceField,
+            EAGER_PROPERTIES.get(ProtoType.WindowManagerService),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.windowManagerServiceField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.WindowManagerService),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.RootWindowContainer,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.RootWindowContainerField),
-        new TranslateIntDef(WmTamperedProtos.RootWindowContainerField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.RootWindowContainerField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.RootWindowContainer),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.RootWindowContainerField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.RootWindowContainer),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.RootWindowContainer,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.rootWindowContainerField),
+          new TranslateIntDef(this.tamperedProtos.rootWindowContainerField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.rootWindowContainerField,
+            EAGER_PROPERTIES.get(ProtoType.RootWindowContainer),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.rootWindowContainerField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.RootWindowContainer),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.WindowContainer,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.WindowContainerField),
-        new TranslateIntDef(WmTamperedProtos.WindowContainerField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.WindowContainerField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.WindowContainer),
-        ),
-        new AddIsVisible(),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.WindowContainerField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.WindowContainer),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.WindowContainer,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.windowContainerField),
+          new TranslateIntDef(this.tamperedProtos.windowContainerField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.windowContainerField,
+            EAGER_PROPERTIES.get(ProtoType.WindowContainer),
+          ),
+          new AddIsVisible(),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.windowContainerField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.WindowContainer),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.DisplayContent,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.DisplayContentField),
-        new TranslateIntDef(WmTamperedProtos.DisplayContentField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.DisplayContentField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.DisplayContent),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.DisplayContentField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.DisplayContent),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.DisplayContent,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.displayContentField),
+          new TranslateIntDef(this.tamperedProtos.displayContentField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.displayContentField,
+            EAGER_PROPERTIES.get(ProtoType.DisplayContent),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.displayContentField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.DisplayContent),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.DisplayArea,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.DisplayAreaField),
-        new TranslateIntDef(WmTamperedProtos.DisplayAreaField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.DisplayAreaField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.DisplayArea),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.DisplayAreaField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.DisplayArea),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.DisplayArea,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.displayAreaField),
+          new TranslateIntDef(this.tamperedProtos.displayAreaField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.displayAreaField,
+            EAGER_PROPERTIES.get(ProtoType.DisplayArea),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.displayAreaField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.DisplayArea),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.Task,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.TaskField),
-        new TranslateIntDef(WmTamperedProtos.TaskField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.TaskField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.Task),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.TaskField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.Task),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.Task,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.taskField),
+          new TranslateIntDef(this.tamperedProtos.taskField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.taskField,
+            EAGER_PROPERTIES.get(ProtoType.Task),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.taskField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.Task),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.Activity,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.ActivityField),
-        new TranslateIntDef(WmTamperedProtos.ActivityField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.ActivityField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.Activity),
-        ),
-        new AddIsVisible(),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.ActivityField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.Activity),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.Activity,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.activityField),
+          new TranslateIntDef(this.tamperedProtos.activityField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.activityField,
+            EAGER_PROPERTIES.get(ProtoType.Activity),
+          ),
+          new AddIsVisible(),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.activityField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.Activity),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.WindowToken,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.WindowTokenField),
-        new TranslateIntDef(WmTamperedProtos.WindowTokenField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.WindowTokenField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.WindowToken),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.WindowTokenField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.WindowToken),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.WindowToken,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.windowTokenField),
+          new TranslateIntDef(this.tamperedProtos.windowTokenField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.windowTokenField,
+            EAGER_PROPERTIES.get(ProtoType.WindowToken),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.windowTokenField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.WindowToken),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.WindowState,
-    {
-      common: [
-        new SetFormatters(
-          WmTamperedProtos.WindowStateField,
-          new Map([
-            ['containingFrame', RECT_FORMATTER],
-            ['parentFrame', RECT_FORMATTER],
-          ]),
-        ),
-        new TranslateIntDef(WmTamperedProtos.WindowStateField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.WindowStateField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.WindowState),
-        ),
-        new AddWindowType(),
-        new AddIsVisible(),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.WindowStateField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.WindowState),
-        ),
-      ],
-    },
-  ],
+    [
+      ProtoType.WindowState,
+      {
+        common: [
+          new SetFormatters(
+            this.tamperedProtos.windowStateField,
+            new Map([
+              ['containingFrame', RECT_FORMATTER],
+              ['parentFrame', RECT_FORMATTER],
+            ]),
+          ),
+          new TranslateIntDef(this.tamperedProtos.windowStateField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.windowStateField,
+            EAGER_PROPERTIES.get(ProtoType.WindowState),
+          ),
+          new AddWindowType(),
+          new AddIsVisible(),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.windowStateField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.WindowState),
+          ),
+        ],
+      },
+    ],
 
-  [
-    WmProtoType.TaskFragment,
-    {
-      common: [
-        new SetFormatters(WmTamperedProtos.TaskFragmentField),
-        new TranslateIntDef(WmTamperedProtos.TaskFragmentField),
-      ],
-      eager: [
-        new AddDefaults(
-          WmTamperedProtos.TaskFragmentField,
-          WM_EAGER_PROPERTIES.get(WmProtoType.TaskFragment),
-        ),
-      ],
-      lazy: [
-        new AddDefaults(
-          WmTamperedProtos.TaskFragmentField,
-          undefined,
-          WM_DENYLIST_PROPERTIES.get(WmProtoType.TaskFragment),
-        ),
-      ],
-    },
-  ],
-]);
+    [
+      ProtoType.TaskFragment,
+      {
+        common: [
+          new SetFormatters(this.tamperedProtos.taskFragmentField),
+          new TranslateIntDef(this.tamperedProtos.taskFragmentField),
+        ],
+        eager: [
+          new AddDefaults(
+            this.tamperedProtos.taskFragmentField,
+            EAGER_PROPERTIES.get(ProtoType.TaskFragment),
+          ),
+        ],
+        lazy: [
+          new AddDefaults(
+            this.tamperedProtos.taskFragmentField,
+            undefined,
+            DENYLIST_PROPERTIES.get(ProtoType.TaskFragment),
+          ),
+        ],
+      },
+    ],
+  ]);
+
+  constructor(private readonly tamperedProtos: TamperedProtos) {}
+
+  get(type: ProtoType): OperationLists {
+    return assertDefined(this.LISTS.get(type));
+  }
+}
diff --git a/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager.ts b/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager.ts
new file mode 100644
index 000000000..6c61d77df
--- /dev/null
+++ b/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager.ts
@@ -0,0 +1,135 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {ParserTimestampConverter} from 'common/timestamp_converter';
+import {AbstractParser} from 'parsers/perfetto/abstract_parser';
+import {FakeProtoTransformer} from 'parsers/perfetto/fake_proto_transformer';
+import {Utils} from 'parsers/perfetto/utils';
+import {RectsComputation} from 'parsers/window_manager/computations/rects_computation';
+import {WmCustomQueryUtils} from 'parsers/window_manager/custom_query_utils';
+import {HierarchyTreeBuilderWm} from 'parsers/window_manager/hierarchy_tree_builder_wm';
+import {PropertiesProviderFactory} from 'parsers/window_manager/properties_provider_factory';
+import {perfetto} from 'protos/windowmanager/latest/static';
+import {
+  CustomQueryParserResultTypeMap,
+  CustomQueryType,
+  VisitableParserCustomQuery,
+} from 'trace/custom_query';
+import {AbsoluteEntryIndex, EntriesRange} from 'trace/trace';
+import {TraceFile} from 'trace/trace_file';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertiesProvider} from 'trace/tree_node/properties_provider';
+import {WasmEngineProxy} from 'trace_processor/wasm_engine_proxy';
+import {TAMPERED_PROTOS_LATEST} from './tampered_protos_latest';
+
+export class ParserWindowManager extends AbstractParser<HierarchyTreeNode> {
+  private readonly protoTransformer = new FakeProtoTransformer(
+    assertDefined(TAMPERED_PROTOS_LATEST.entryField.tamperedMessageType),
+  );
+  private readonly factory = new PropertiesProviderFactory(
+    TAMPERED_PROTOS_LATEST,
+  );
+
+  constructor(
+    traceFile: TraceFile,
+    traceProcessor: WasmEngineProxy,
+    timestampConverter: ParserTimestampConverter,
+  ) {
+    super(traceFile, traceProcessor, timestampConverter);
+  }
+
+  override getTraceType(): TraceType {
+    return TraceType.WINDOW_MANAGER;
+  }
+
+  override async getEntry(index: number): Promise<HierarchyTreeNode> {
+    let entryProto = await Utils.queryEntry(
+      this.traceProcessor,
+      this.getTableName(),
+      this.entryIndexToRowIdMap,
+      index,
+    );
+    entryProto = this.protoTransformer.transform(entryProto);
+    return this.makeHierarchyTree(entryProto);
+  }
+
+  protected override getTableName(): string {
+    return 'android_windowmanager';
+  }
+
+  protected override getStdLibModuleName(): string {
+    return 'android.winscope.windowmanager';
+  }
+
+  override customQuery<Q extends CustomQueryType>(
+    type: Q,
+    entriesRange: EntriesRange,
+  ): Promise<CustomQueryParserResultTypeMap[Q]> {
+    return new VisitableParserCustomQuery(type)
+      .visit(CustomQueryType.WM_WINDOWS_TOKEN_AND_TITLE, () => {
+        const result: CustomQueryParserResultTypeMap[CustomQueryType.WM_WINDOWS_TOKEN_AND_TITLE] =
+          [];
+
+        const fetchAndParseEntry = async (index: AbsoluteEntryIndex) => {
+          const entryProto = await Utils.queryEntry(
+            this.traceProcessor,
+            this.getTableName(),
+            this.entryIndexToRowIdMap,
+            index,
+          );
+          WmCustomQueryUtils.parseWindowsTokenAndTitle(
+            entryProto?.windowManagerService?.rootWindowContainer,
+            result,
+          );
+        };
+
+        const promises: Array<Promise<void>> = [];
+        for (
+          let index = entriesRange.start;
+          index < entriesRange.end;
+          ++index
+        ) {
+          promises.push(fetchAndParseEntry(index));
+        }
+
+        return Promise.all(promises).then(() => {
+          return result;
+        });
+      })
+      .getResult();
+  }
+
+  private makeHierarchyTree(
+    entryProto: perfetto.protos.IWindowManagerTraceEntry,
+  ): HierarchyTreeNode {
+    const containers: PropertiesProvider[] =
+      this.factory.makeContainerProperties(
+        assertDefined(entryProto.windowManagerService),
+      );
+
+    const entry = this.factory.makeEntryProperties(
+      assertDefined(entryProto.windowManagerService),
+    );
+
+    return new HierarchyTreeBuilderWm()
+      .setRoot(entry)
+      .setChildren(containers)
+      .setComputations([new RectsComputation()])
+      .build();
+  }
+}
diff --git a/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager_test.ts b/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager_test.ts
new file mode 100644
index 000000000..06a183738
--- /dev/null
+++ b/tools/winscope/src/parsers/window_manager/perfetto/parser_window_manager_test.ts
@@ -0,0 +1,73 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {assertDefined} from 'common/assert_utils';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {CoarseVersion} from 'trace/coarse_version';
+import {CustomQueryType} from 'trace/custom_query';
+import {Parser} from 'trace/parser';
+import {Trace} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+
+describe('Perfetto ParserWindowManager', () => {
+  let parser: Parser<HierarchyTreeNode>;
+  let trace: Trace<HierarchyTreeNode>;
+
+  beforeAll(async () => {
+    jasmine.addCustomEqualityTester(UnitTestUtils.timestampEqualityTester);
+    parser = (await UnitTestUtils.getPerfettoParser(
+      TraceType.WINDOW_MANAGER,
+      'traces/perfetto/windowmanager.perfetto-trace',
+    )) as Parser<HierarchyTreeNode>;
+    trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.WINDOW_MANAGER)
+      .setParser(parser)
+      .build();
+  });
+
+  it('has expected trace type', () => {
+    expect(parser.getTraceType()).toEqual(TraceType.WINDOW_MANAGER);
+  });
+
+  it('has expected coarse version', () => {
+    expect(parser.getCoarseVersion()).toEqual(CoarseVersion.LATEST);
+  });
+
+  it('provides timestamps', () => {
+    const expected = [
+      TimestampConverterUtils.makeRealTimestamp(1719409456335086006n),
+      TimestampConverterUtils.makeRealTimestamp(1719409456922787137n),
+      TimestampConverterUtils.makeRealTimestamp(1719409456929933622n),
+    ];
+    expect(assertDefined(parser.getTimestamps()).slice(0, 3)).toEqual(expected);
+  });
+
+  it('retrieves trace entry', async () => {
+    const entry = await parser.getEntry(1);
+    expect(entry).toBeInstanceOf(HierarchyTreeNode);
+    expect(entry.id).toEqual('WindowManagerState root');
+  });
+
+  it('supports WM_WINDOWS_TOKEN_AND_TITLE custom query', async () => {
+    const tokenAndTitles = await trace
+      .sliceEntries(0, 1)
+      .customQuery(CustomQueryType.WM_WINDOWS_TOKEN_AND_TITLE);
+    expect(tokenAndTitles.length).toEqual(69);
+    expect(tokenAndTitles).toContain({token: '86f4c23', title: 'Leaf:36:36'});
+  });
+});
diff --git a/tools/winscope/src/parsers/window_manager/perfetto/tampered_protos_latest.ts b/tools/winscope/src/parsers/window_manager/perfetto/tampered_protos_latest.ts
new file mode 100644
index 000000000..ce190665a
--- /dev/null
+++ b/tools/winscope/src/parsers/window_manager/perfetto/tampered_protos_latest.ts
@@ -0,0 +1,82 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TamperedMessageType} from 'parsers/tampered_message_type';
+import {TamperedProtos} from 'parsers/window_manager/tampered_protos';
+import root from 'protos/windowmanager/latest/json';
+
+const Wrapper = TamperedMessageType.tamper(
+  root.lookupType('perfetto.protos.Wrapper'),
+);
+
+const entryField = assertDefined(Wrapper.fields['windowmanagerTraceEntry']);
+
+const windowManagerServiceField = assertDefined(entryField.tamperedMessageType)
+  .fields['windowManagerService'];
+
+const rootWindowContainerField = assertDefined(
+  windowManagerServiceField.tamperedMessageType,
+).fields['rootWindowContainer'];
+
+const windowContainerField = assertDefined(
+  rootWindowContainerField.tamperedMessageType,
+).fields['windowContainer'];
+
+const windowContainerChildField = assertDefined(
+  windowContainerField.tamperedMessageType,
+).fields['children'];
+
+export const TAMPERED_PROTOS_LATEST: TamperedProtos = {
+  entryField,
+
+  windowManagerServiceField,
+
+  rootWindowContainerField: assertDefined(
+    windowManagerServiceField.tamperedMessageType,
+  ).fields['rootWindowContainer'],
+
+  windowContainerField: assertDefined(
+    rootWindowContainerField.tamperedMessageType,
+  ).fields['windowContainer'],
+
+  windowContainerChildField: assertDefined(
+    windowContainerField.tamperedMessageType,
+  ).fields['children'],
+
+  displayContentField: assertDefined(
+    windowContainerChildField.tamperedMessageType,
+  ).fields['displayContent'],
+
+  displayAreaField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['displayArea'],
+
+  taskField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['task'],
+
+  activityField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['activity'],
+
+  windowTokenField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['windowToken'],
+
+  windowStateField: assertDefined(windowContainerChildField.tamperedMessageType)
+    .fields['window'],
+
+  taskFragmentField: assertDefined(
+    windowContainerChildField.tamperedMessageType,
+  ).fields['taskFragment'],
+};
diff --git a/tools/winscope/src/parsers/window_manager/parser_window_manager_utils.ts b/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
similarity index 73%
rename from tools/winscope/src/parsers/window_manager/parser_window_manager_utils.ts
rename to tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
index a0cf4717e..0b55e13f7 100644
--- a/tools/winscope/src/parsers/window_manager/parser_window_manager_utils.ts
+++ b/tools/winscope/src/parsers/window_manager/properties_provider_factory.ts
@@ -15,7 +15,8 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {com} from 'protos/windowmanager/latest/static';
+import {perfetto} from 'protos/windowmanager/latest/static';
+import {com} from 'protos/windowmanager/udc/static';
 import {
   LazyPropertiesStrategyType,
   PropertiesProvider,
@@ -25,12 +26,13 @@ import {PropertyTreeBuilderFromProto} from 'trace/tree_node/property_tree_builde
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
 import {WindowTypePrefix} from 'trace/window_type';
-import {OperationLists, WM_OPERATION_LISTS} from './operations/operation_lists';
-import {WM_DENYLIST_PROPERTIES} from './wm_denylist_properties';
-import {WM_EAGER_PROPERTIES} from './wm_eager_properties';
-import {WmProtoType} from './wm_proto_type';
+import {DENYLIST_PROPERTIES} from './denylist_properties';
+import {EAGER_PROPERTIES} from './eager_properties';
+import {OperationLists, WmOperationLists} from './operations/operation_lists';
+import {ProtoType} from './proto_type';
+import {TamperedProtos} from './tampered_protos';
 
-type WindowContainerChildType =
+type WindowContainerChildTypeUdc =
   | com.android.server.wm.IWindowContainerProto
   | com.android.server.wm.IDisplayContentProto
   | com.android.server.wm.IDisplayAreaProto
@@ -39,13 +41,41 @@ type WindowContainerChildType =
   | com.android.server.wm.IWindowTokenProto
   | com.android.server.wm.IWindowStateProto
   | com.android.server.wm.ITaskFragmentProto;
+type WindowContainerChildTypeLatest =
+  | perfetto.protos.IWindowContainerProto
+  | perfetto.protos.IDisplayContentProto
+  | perfetto.protos.IDisplayAreaProto
+  | perfetto.protos.ITaskProto
+  | perfetto.protos.IActivityRecordProto
+  | perfetto.protos.IWindowTokenProto
+  | perfetto.protos.IWindowStateProto
+  | perfetto.protos.ITaskFragmentProto;
+type WindowContainerChildType =
+  | WindowContainerChildTypeUdc
+  | WindowContainerChildTypeLatest;
+
+type IdentifierProto =
+  | com.android.server.wm.IIdentifierProto
+  | perfetto.protos.IIdentifierProto;
+type WindowManagerServiceDumpProto =
+  | com.android.server.wm.IWindowManagerServiceDumpProto
+  | perfetto.protos.WindowManagerServiceDumpProto;
+type WindowContainerChildProto =
+  | com.android.server.wm.IWindowContainerChildProto
+  | perfetto.protos.IWindowContainerChildProto;
+
+export class PropertiesProviderFactory {
+  private readonly operationLists: WmOperationLists;
+
+  constructor(tamperedProtos: TamperedProtos) {
+    this.operationLists = new WmOperationLists(tamperedProtos);
+  }
 
-class ParserWindowManagerUtils {
   makeEntryProperties(
-    entryProto: com.android.server.wm.IWindowManagerServiceDumpProto,
+    entryProto: WindowManagerServiceDumpProto,
   ): PropertiesProvider {
     const operations = assertDefined(
-      WM_OPERATION_LISTS.get(WmProtoType.WindowManagerService),
+      this.operationLists.get(ProtoType.WindowManagerService),
     );
     return new PropertiesProviderBuilder()
       .setEagerProperties(
@@ -60,38 +90,34 @@ class ParserWindowManagerUtils {
       .build();
   }
 
-  extractContainers(
-    entryProto: com.android.server.wm.IWindowManagerServiceDumpProto,
+  makeContainerProperties(
+    entryProto: WindowManagerServiceDumpProto,
   ): PropertiesProvider[] {
-    let currChildren: com.android.server.wm.IWindowContainerChildProto[] =
-      assertDefined(entryProto.rootWindowContainer?.windowContainer?.children);
+    let currChildren: WindowContainerChildProto[] = assertDefined(
+      entryProto.rootWindowContainer?.windowContainer?.children,
+    );
 
     const rootContainer = assertDefined(entryProto.rootWindowContainer);
     const rootContainerProperties = this.getContainerChildProperties(
       rootContainer,
       currChildren,
-      WM_OPERATION_LISTS.get(WmProtoType.RootWindowContainer),
+      this.operationLists.get(ProtoType.RootWindowContainer),
     );
 
     const containers = [rootContainerProperties];
 
     while (currChildren && currChildren.length > 0) {
-      const nextChildren: com.android.server.wm.IWindowContainerChildProto[] =
-        [];
+      const nextChildren: WindowContainerChildProto[] = [];
       containers.push(
-        ...currChildren.map(
-          (
-            containerChild: com.android.server.wm.IWindowContainerChildProto,
-          ) => {
-            const children = this.getChildren(containerChild);
-            nextChildren.push(...children);
-            const containerProperties = this.getContainerChildProperties(
-              containerChild,
-              children,
-            );
-            return containerProperties;
-          },
-        ),
+        ...currChildren.map((containerChild: WindowContainerChildProto) => {
+          const children = this.getChildren(containerChild);
+          nextChildren.push(...children);
+          const containerProperties = this.getContainerChildProperties(
+            containerChild,
+            children,
+          );
+          return containerProperties;
+        }),
       );
       currChildren = nextChildren;
     }
@@ -100,11 +126,11 @@ class ParserWindowManagerUtils {
   }
 
   private makeEntryEagerPropertiesTree(
-    entry: com.android.server.wm.IWindowManagerServiceDumpProto,
+    entry: WindowManagerServiceDumpProto,
   ): PropertyTreeNode {
     const denyList: string[] = [];
     const eagerProperties = assertDefined(
-      WM_EAGER_PROPERTIES.get(WmProtoType.WindowManagerService),
+      EAGER_PROPERTIES.get(ProtoType.WindowManagerService),
     );
     let obj = entry;
     do {
@@ -125,7 +151,7 @@ class ParserWindowManagerUtils {
   }
 
   private makeEntryLazyPropertiesStrategy(
-    entry: com.android.server.wm.IWindowManagerServiceDumpProto,
+    entry: WindowManagerServiceDumpProto,
   ): LazyPropertiesStrategyType {
     return async () => {
       return new PropertyTreeBuilderFromProto()
@@ -134,7 +160,7 @@ class ParserWindowManagerUtils {
         .setRootName('root')
         .setDenyList(
           assertDefined(
-            WM_DENYLIST_PROPERTIES.get(WmProtoType.WindowManagerService),
+            DENYLIST_PROPERTIES.get(ProtoType.WindowManagerService),
           ),
         )
         .build();
@@ -142,9 +168,9 @@ class ParserWindowManagerUtils {
   }
 
   private getChildren(
-    child: com.android.server.wm.IWindowContainerChildProto,
-  ): com.android.server.wm.IWindowContainerChildProto[] {
-    let children: com.android.server.wm.IWindowContainerChildProto[] = [];
+    child: WindowContainerChildProto,
+  ): WindowContainerChildProto[] {
+    let children: WindowContainerChildProto[] = [];
     if (child.displayContent) {
       children =
         child.displayContent.rootDisplayArea?.windowContainer?.children ?? [];
@@ -166,12 +192,12 @@ class ParserWindowManagerUtils {
       children = child.windowContainer?.children ?? [];
     }
 
-    return children;
+    return children.filter((c) => Object.keys(c).length > 0);
   }
 
   private getContainerChildProperties(
-    containerChild: com.android.server.wm.IWindowContainerChildProto,
-    children: com.android.server.wm.IWindowContainerChildProto[],
+    containerChild: WindowContainerChildProto,
+    children: WindowContainerChildProto[],
     operations?: OperationLists,
   ): PropertiesProvider {
     const containerChildType = this.getContainerChildType(containerChild);
@@ -188,7 +214,7 @@ class ParserWindowManagerUtils {
       );
 
     if (!operations) {
-      operations = assertDefined(WM_OPERATION_LISTS.get(containerChildType));
+      operations = assertDefined(this.operationLists.get(containerChildType));
     }
 
     const containerProperties = new PropertiesProviderBuilder()
@@ -201,39 +227,37 @@ class ParserWindowManagerUtils {
     return containerProperties;
   }
 
-  private getContainerChildType(
-    child: com.android.server.wm.IWindowContainerChildProto,
-  ): WmProtoType {
+  private getContainerChildType(child: WindowContainerChildProto): ProtoType {
     if (child.displayContent) {
-      return WmProtoType.DisplayContent;
+      return ProtoType.DisplayContent;
     } else if (child.displayArea) {
-      return WmProtoType.DisplayArea;
+      return ProtoType.DisplayArea;
     } else if (child.task) {
-      return WmProtoType.Task;
+      return ProtoType.Task;
     } else if (child.taskFragment) {
-      return WmProtoType.TaskFragment;
+      return ProtoType.TaskFragment;
     } else if (child.activity) {
-      return WmProtoType.Activity;
+      return ProtoType.Activity;
     } else if (child.windowToken) {
-      return WmProtoType.WindowToken;
+      return ProtoType.WindowToken;
     } else if (child.window) {
-      return WmProtoType.WindowState;
+      return ProtoType.WindowState;
     }
 
-    return WmProtoType.WindowContainer;
+    return ProtoType.WindowContainer;
   }
 
   private makeContainerChildEagerPropertiesTree(
-    containerChild: com.android.server.wm.IWindowContainerChildProto,
-    children: com.android.server.wm.IWindowContainerChildProto[],
-    containerChildType: WmProtoType,
+    containerChild: WindowContainerChildProto,
+    children: WindowContainerChildProto[],
+    containerChildType: ProtoType,
   ): PropertyTreeNode {
     const identifier = this.getIdentifier(containerChild);
     const name = this.getName(containerChild, identifier);
     const token = this.makeToken(identifier);
 
     const eagerProperties = assertDefined(
-      WM_EAGER_PROPERTIES.get(containerChildType),
+      EAGER_PROPERTIES.get(containerChildType),
     );
 
     const denyList: string[] = [];
@@ -276,15 +300,15 @@ class ParserWindowManagerUtils {
   }
 
   private makeContainerChildLazyPropertiesStrategy(
-    containerChild: com.android.server.wm.IWindowContainerChildProto,
-    containerChildType: WmProtoType,
+    containerChild: WindowContainerChildProto,
+    containerChildType: ProtoType,
   ): LazyPropertiesStrategyType {
     return async () => {
       const identifier = this.getIdentifier(containerChild);
       const name = this.getName(containerChild, identifier);
       const token = this.makeToken(identifier);
       const containerDenylistProperties = assertDefined(
-        WM_DENYLIST_PROPERTIES.get(containerChildType),
+        DENYLIST_PROPERTIES.get(containerChildType),
       );
 
       const container = this.getContainer(containerChild);
@@ -299,8 +323,8 @@ class ParserWindowManagerUtils {
   }
 
   private getIdentifier(
-    child: com.android.server.wm.IWindowContainerChildProto,
-  ): com.android.server.wm.IIdentifierProto | undefined {
+    child: WindowContainerChildProto,
+  ): IdentifierProto | undefined {
     if (child.displayContent) {
       return (
         child.displayContent.rootDisplayArea?.windowContainer?.identifier ??
@@ -344,8 +368,8 @@ class ParserWindowManagerUtils {
   }
 
   private getName(
-    child: com.android.server.wm.IWindowContainerChildProto,
-    identifier: com.android.server.wm.IIdentifierProto | undefined,
+    child: WindowContainerChildProto,
+    identifier: IdentifierProto | undefined,
   ): string {
     let nameOverride: string | undefined;
     if (child.displayContent) {
@@ -372,14 +396,12 @@ class ParserWindowManagerUtils {
     return nameOverride ?? identifier?.title ?? '';
   }
 
-  private makeToken(
-    identifier: com.android.server.wm.IIdentifierProto | undefined,
-  ): string {
+  private makeToken(identifier: IdentifierProto | undefined): string {
     return identifier?.hashCode?.toString(16) ?? '';
   }
 
   private getContainer(
-    containerChild: com.android.server.wm.IWindowContainerChildProto,
+    containerChild: WindowContainerChildProto,
   ): WindowContainerChildType {
     if (containerChild.displayContent) {
       return containerChild.displayContent;
@@ -405,9 +427,7 @@ class ParserWindowManagerUtils {
     return assertDefined(containerChild.windowContainer);
   }
 
-  private mapChildrenToTokens(
-    children: com.android.server.wm.IWindowContainerChildProto[],
-  ): string[] {
+  private mapChildrenToTokens(children: WindowContainerChildProto[]): string[] {
     return children
       .map((child) => {
         const identifier = this.getIdentifier(child);
@@ -416,5 +436,3 @@ class ParserWindowManagerUtils {
       .filter((token) => token.length > 0);
   }
 }
-
-export const ParserWmUtils = new ParserWindowManagerUtils();
diff --git a/tools/winscope/src/parsers/window_manager/wm_proto_type.ts b/tools/winscope/src/parsers/window_manager/proto_type.ts
similarity index 97%
rename from tools/winscope/src/parsers/window_manager/wm_proto_type.ts
rename to tools/winscope/src/parsers/window_manager/proto_type.ts
index 6bde747fe..b12ebc08c 100644
--- a/tools/winscope/src/parsers/window_manager/wm_proto_type.ts
+++ b/tools/winscope/src/parsers/window_manager/proto_type.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-export enum WmProtoType {
+export enum ProtoType {
   WindowManagerService = 'WindowManagerService',
   RootWindowContainer = 'RootWindowContainer',
   DisplayContent = 'DisplayContent',
diff --git a/tools/winscope/src/parsers/window_manager/tampered_protos.ts b/tools/winscope/src/parsers/window_manager/tampered_protos.ts
new file mode 100644
index 000000000..1c6103231
--- /dev/null
+++ b/tools/winscope/src/parsers/window_manager/tampered_protos.ts
@@ -0,0 +1,32 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TamperedProtoField} from 'parsers/tampered_message_type';
+
+export interface TamperedProtos {
+  entryField: TamperedProtoField;
+  windowManagerServiceField: TamperedProtoField;
+  rootWindowContainerField: TamperedProtoField;
+  windowContainerField: TamperedProtoField;
+  windowContainerChildField: TamperedProtoField;
+  displayContentField: TamperedProtoField;
+  displayAreaField: TamperedProtoField;
+  taskField: TamperedProtoField;
+  activityField: TamperedProtoField;
+  windowTokenField: TamperedProtoField;
+  windowStateField: TamperedProtoField;
+  taskFragmentField: TamperedProtoField;
+}
diff --git a/tools/winscope/src/parsers/window_manager/wm_tampered_protos.ts b/tools/winscope/src/parsers/window_manager/wm_tampered_protos.ts
deleted file mode 100644
index 49923ab74..000000000
--- a/tools/winscope/src/parsers/window_manager/wm_tampered_protos.ts
+++ /dev/null
@@ -1,67 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {assertDefined} from 'common/assert_utils';
-import {TamperedMessageType} from 'parsers/tampered_message_type';
-import root from 'protos/windowmanager/latest/json';
-
-export const WindowManagerTraceFileProto = TamperedMessageType.tamper(
-  root.lookupType('com.android.server.wm.WindowManagerTraceFileProto'),
-);
-
-export const WindowManagerServiceField = assertDefined(
-  WindowManagerTraceFileProto.fields['entry'].tamperedMessageType,
-).fields['windowManagerService'];
-
-export const RootWindowContainerField = assertDefined(
-  WindowManagerServiceField.tamperedMessageType,
-).fields['rootWindowContainer'];
-
-export const WindowContainerField = assertDefined(
-  RootWindowContainerField.tamperedMessageType,
-).fields['windowContainer'];
-
-export const WindowContainerChildField = assertDefined(
-  WindowContainerField.tamperedMessageType,
-).fields['children'];
-
-export const DisplayContentField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['displayContent'];
-
-export const DisplayAreaField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['displayArea'];
-
-export const TaskField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['task'];
-
-export const ActivityField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['activity'];
-
-export const WindowTokenField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['windowToken'];
-
-export const WindowStateField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['window'];
-
-export const TaskFragmentField = assertDefined(
-  WindowContainerChildField.tamperedMessageType,
-).fields['taskFragment'];
diff --git a/tools/winscope/src/styles.css b/tools/winscope/src/styles.css
index 4f6d2201e..1df7cc66f 100644
--- a/tools/winscope/src/styles.css
+++ b/tools/winscope/src/styles.css
@@ -32,6 +32,14 @@ app-root {
     margin: 0;
 }
 
+.mat-body-2 {
+    font: 500 14px / 20px 'Roboto', sans-serif;
+}
+
+.mat-button, .mat-icon-button, .mat-stroked-button, .mat-flat-button {
+    user-select: auto !important;
+}
+
 .card-grid {
     width: 100%;
     height: 100%;
@@ -95,3 +103,20 @@ body.dark-mode button.mat-flat-button.mat-primary {
 .mat-dialog-container {
     border-radius: 20px !important;
 }
+
+.mat-tooltip {
+    word-break: break-word;
+}
+
+.outline-field .mat-form-field-wrapper {
+    padding-bottom: 0px;
+}
+
+.outline-field .mat-form-field-infix {
+    padding: 6px 0 10px 0;
+    border-top: 8px solid transparent;
+}
+
+log-view .filters .mat-form-field-infix {
+    width: 100%;
+}
diff --git a/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts b/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
index ede5495d5..5d7763de4 100644
--- a/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
+++ b/tools/winscope/src/test/e2e/cross_tool_protocol_test.ts
@@ -18,23 +18,31 @@ import {browser, by, element, ElementFinder} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Cross-Tool Protocol', () => {
+  const DEFAULT_TIMEOUT_MS = 20000;
+
   beforeEach(async () => {
     await browser.restart();
-
-    jasmine.DEFAULT_TIMEOUT_INTERVAL = 20000;
-    await browser.manage().timeouts().implicitlyWait(20000);
+    jasmine.DEFAULT_TIMEOUT_INTERVAL = DEFAULT_TIMEOUT_MS;
+    await E2eTestUtils.beforeEach(DEFAULT_TIMEOUT_MS);
     await E2eTestUtils.checkServerIsUp(
       'Remote tool mock',
       E2eTestUtils.REMOTE_TOOL_MOCK_URL,
     );
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
-
     await browser.get(E2eTestUtils.REMOTE_TOOL_MOCK_URL);
+    await browser.wait(
+      async () => {
+        const handles = await browser.getAllWindowHandles();
+        return handles.length === 1;
+      },
+      20000,
+      'Remote tool mock tab is not open',
+    );
   });
 
   it('allows communication with ABT', async () => {
-    const TIMESTAMP_IN_BUGREPORT_MESSAGE = '1670509911000000000';
-    const TIMESTAMP_FROM_ABT_TO_WINSCOPE = '1670509912000000000';
+    const TIMESTAMP_FROM_ABT_TO_WINSCOPE = '1684247274018192053';
+    const INITIAL_TRACE_TIMESTAMP = '1684147274018192053';
+    const TRACE_TIMESTAMP_CLOSEST_TO_ABT = '1684149608528382581';
     const TIMESTAMP_FROM_WINSCOPE = '1670509913000000000';
 
     await openWinscopeTabFromRemoteTool();
@@ -47,10 +55,10 @@ describe('Cross-Tool Protocol', () => {
     await clickWinscopeViewTracesButton();
     await checkWinscopeRenderedSurfaceFlingerView();
     await checkWinscopeRenderedAllViewTabs();
-    await checkWinscopeTimestamp(TIMESTAMP_IN_BUGREPORT_MESSAGE);
+    await checkWinscopeTimestamp(INITIAL_TRACE_TIMESTAMP);
 
     await sendRealtimeTimestampToWinscope(TIMESTAMP_FROM_ABT_TO_WINSCOPE);
-    await checkWinscopeTimestamp(TIMESTAMP_FROM_ABT_TO_WINSCOPE);
+    await checkWinscopeTimestamp(TRACE_TIMESTAMP_CLOSEST_TO_ABT);
 
     await sendTimestampToRemoteTool(TIMESTAMP_FROM_WINSCOPE);
     await checkRemoteToolRealtimeTimestamp(TIMESTAMP_FROM_WINSCOPE);
@@ -150,7 +158,10 @@ describe('Cross-Tool Protocol', () => {
     await browser.wait(
       async () => {
         const handles = await browser.getAllWindowHandles();
-        return handles.length >= 2;
+        if (handles.length < 2) return false;
+        await browser.switchTo().window(await getWindowHandleWinscope());
+        const opened = element(by.css('upload-traces'));
+        return await opened.isPresent();
       },
       20000,
       'The Winscope tab did not open',
@@ -180,7 +191,7 @@ describe('Cross-Tool Protocol', () => {
       'Surface Flinger',
       'Transactions',
       'Transitions',
-      'Window Manager',
+      'Window Manager Dump',
     ];
 
     expect(actualTabParagraphs.sort()).toEqual(expectedTabParagraphs.sort());
diff --git a/tools/winscope/src/test/e2e/trace_navigation_test.ts b/tools/winscope/src/test/e2e/trace_navigation_test.ts
index 6772c0ba4..66e617fff 100644
--- a/tools/winscope/src/test/e2e/trace_navigation_test.ts
+++ b/tools/winscope/src/test/e2e/trace_navigation_test.ts
@@ -20,12 +20,8 @@ import {E2eTestUtils} from './utils';
 describe('Trace navigation', () => {
   const DEFAULT_TIMEOUT_MS = 1000;
 
-  beforeAll(async () => {
-    await browser.manage().timeouts().implicitlyWait(DEFAULT_TIMEOUT_MS);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
-  });
-
   beforeEach(async () => {
+    await E2eTestUtils.beforeEach(DEFAULT_TIMEOUT_MS);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
diff --git a/tools/winscope/src/test/e2e/upload_traces_test.ts b/tools/winscope/src/test/e2e/upload_traces_test.ts
index 9ec70e53e..83268fee8 100644
--- a/tools/winscope/src/test/e2e/upload_traces_test.ts
+++ b/tools/winscope/src/test/e2e/upload_traces_test.ts
@@ -22,11 +22,10 @@ describe('Upload traces', () => {
 
   beforeAll(async () => {
     jasmine.DEFAULT_TIMEOUT_INTERVAL = DEFAULT_TIMEOUT_MS;
-    await browser.manage().timeouts().implicitlyWait(DEFAULT_TIMEOUT_MS);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
   });
 
   beforeEach(async () => {
+    await E2eTestUtils.beforeEach(DEFAULT_TIMEOUT_MS);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
diff --git a/tools/winscope/src/test/e2e/utils.ts b/tools/winscope/src/test/e2e/utils.ts
index fe7a50e8c..a8f5efa68 100644
--- a/tools/winscope/src/test/e2e/utils.ts
+++ b/tools/winscope/src/test/e2e/utils.ts
@@ -20,6 +20,12 @@ class E2eTestUtils {
   static readonly WINSCOPE_URL = 'http://localhost:8080';
   static readonly REMOTE_TOOL_MOCK_URL = 'http://localhost:8081';
 
+  static async beforeEach(defaultTimeoutMs: number) {
+    await browser.manage().timeouts().implicitlyWait(defaultTimeoutMs);
+    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await browser.driver.manage().window().maximize();
+  }
+
   static async checkServerIsUp(name: string, url: string) {
     try {
       await browser.get(url);
@@ -72,7 +78,12 @@ class E2eTestUtils {
 
   static async clickCloseIcon() {
     const button = element.all(by.css('.uploaded-files button')).first();
-    await button.click();
+    await browser.executeScript(
+      `
+      arguments[0].click();
+    `,
+      button,
+    );
   }
 
   static async clickDownloadTracesButton() {
@@ -102,7 +113,7 @@ class E2eTestUtils {
         return;
       }
     }
-    throw Error(`could not find tab corresponding to ${title}`);
+    throw new Error(`could not find tab corresponding to ${title}`);
   }
 
   static async checkTimelineTraceSelector(trace: {
@@ -191,11 +202,12 @@ class E2eTestUtils {
     for (const node of nodes) {
       const id = await node.getAttribute('id');
       if (id.includes(itemName)) {
-        await node.click();
+        const desc = node.element(by.css('.description'));
+        await desc.click();
         return;
       }
     }
-    throw Error(`could not find item matching ${itemName} in hierarchy`);
+    throw new Error(`could not find item matching ${itemName} in hierarchy`);
   }
 
   static async applyStateToHierarchyOptions(
@@ -231,7 +243,7 @@ class E2eTestUtils {
         return;
       }
     }
-    throw Error(`could not find item ${itemName} in properties tree`);
+    throw new Error(`could not find item ${itemName} in properties tree`);
   }
 
   static async checkRectLabel(viewer: string, expectedLabel: string) {
@@ -253,15 +265,13 @@ class E2eTestUtils {
   }
 
   static async checkTotalScrollEntries(
-    selectors: {viewer: string; scroll: string; entry: string},
+    viewerSelector: string,
     scrollViewport: Function,
     numberOfEntries: number,
     scrollToBottomOffset?: number | undefined,
   ) {
     if (scrollToBottomOffset !== undefined) {
-      const viewport = element(
-        by.css(`${selectors.viewer} ${selectors.scroll}`),
-      );
+      const viewport = element(by.css(`${viewerSelector} .scroll`));
       await browser.executeAsyncScript(
         scrollViewport,
         viewport,
@@ -269,7 +279,7 @@ class E2eTestUtils {
       );
     }
     const entries: ElementFinder[] = await element.all(
-      by.css(`${selectors.viewer} ${selectors.scroll} ${selectors.entry}`),
+      by.css(`${viewerSelector} .scroll .entry`),
     );
     expect(await entries[entries.length - 1].getAttribute('item-id')).toEqual(
       `${numberOfEntries - 1}`,
diff --git a/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts b/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
index 0289a984a..297ff6d78 100644
--- a/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_input_method_clients_test.ts
@@ -21,8 +21,7 @@ describe('Viewer Input Method Clients', () => {
   const viewerSelector = 'viewer-input-method';
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -34,7 +33,7 @@ describe('Viewer Input Method Clients', () => {
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'keyboard_alt',
-      color: 'rgba(250, 144, 62, 1)',
+      color: 'rgba(255, 150, 75, 1)',
     });
     await E2eTestUtils.checkInitialRealTimestamp('2022-11-21, 18:05:11.145');
     await E2eTestUtils.checkFinalRealTimestamp('2022-11-21, 18:05:18.245');
@@ -52,17 +51,18 @@ describe('Viewer Input Method Clients', () => {
     await clickInputMethodSurface();
     await checkInputMethodSurfaceProperties();
 
-    await E2eTestUtils.applyStateToHierarchyOptions(viewerSelector, true);
-    await checkHierarchy();
     await E2eTestUtils.selectItemInHierarchy(viewerSelector, 'InputMethod#765');
     await checkInputMethodLayerProperties();
+
+    await E2eTestUtils.applyStateToHierarchyOptions(viewerSelector, true);
+    await checkHierarchy();
   });
 
   async function checkHierarchy() {
     const nodes = await element.all(
       by.css(`${viewerSelector} hierarchy-view .node`),
     );
-    expect(nodes.length).toEqual(5);
+    expect(nodes.length).toEqual(4);
     expect(await nodes[0].getText()).toContain(
       'InputMethodClients - 2022-11-21, 18:05:14.969 - InsetsSourceConsumer#notifyAnimationFinished',
     );
@@ -73,7 +73,6 @@ describe('Viewer Input Method Clients', () => {
     expect(await nodes[3].getText()).toContain(
       '786 - com.google.(...).ZeroStateSearchActivity#786 HWC V',
     );
-    expect(await nodes[4].getText()).toContain('765 - InputMethod#765 HWC V');
   }
 
   async function checkInputMethodLayerProperties() {
diff --git a/tools/winscope/src/test/e2e/viewer_input_method_manager_service_test.ts b/tools/winscope/src/test/e2e/viewer_input_method_manager_service_test.ts
index 48b6a9532..300765cb8 100644
--- a/tools/winscope/src/test/e2e/viewer_input_method_manager_service_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_input_method_manager_service_test.ts
@@ -21,8 +21,7 @@ describe('Viewer Input Method Manager Service', () => {
   const viewerSelector = 'viewer-input-method';
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -34,7 +33,7 @@ describe('Viewer Input Method Manager Service', () => {
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'keyboard_alt',
-      color: 'rgba(217, 48, 37, 1)',
+      color: 'rgba(255, 194, 75, 1)',
     });
     await E2eTestUtils.checkInitialRealTimestamp('2022-11-21, 18:05:11.145');
     await E2eTestUtils.checkFinalRealTimestamp('2022-11-21, 18:05:18.081');
diff --git a/tools/winscope/src/test/e2e/viewer_input_method_service_test.ts b/tools/winscope/src/test/e2e/viewer_input_method_service_test.ts
index aefb0e45f..631980ed5 100644
--- a/tools/winscope/src/test/e2e/viewer_input_method_service_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_input_method_service_test.ts
@@ -21,8 +21,7 @@ describe('Viewer Input Method Service', () => {
   const viewerSelector = 'viewer-input-method';
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -34,7 +33,7 @@ describe('Viewer Input Method Service', () => {
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'keyboard_alt',
-      color: 'rgba(242, 153, 0, 1)',
+      color: 'rgba(255, 194, 75, 1)',
     });
     await E2eTestUtils.checkInitialRealTimestamp('2022-11-21, 18:05:12.497');
     await E2eTestUtils.checkFinalRealTimestamp('2022-11-21, 18:05:18.061');
diff --git a/tools/winscope/src/test/e2e/viewer_protolog_test.ts b/tools/winscope/src/test/e2e/viewer_protolog_test.ts
index 25eead82e..b49075de4 100644
--- a/tools/winscope/src/test/e2e/viewer_protolog_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_protolog_test.ts
@@ -18,17 +18,12 @@ import {browser, ElementFinder} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer Protolog', () => {
-  const scrollSelectors = {
-    viewer: 'viewer-protolog',
-    scroll: '.scroll-messages',
-    entry: '.message',
-  };
+  const viewerSelector = 'viewer-protolog';
   const totalEntries = 7295;
   const scrollToTotalBottomOffset = 700000;
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -36,17 +31,17 @@ describe('Viewer Protolog', () => {
     await E2eTestUtils.loadTraceAndCheckViewer(
       'traces/deployment_full_trace_phone.zip',
       'ProtoLog',
-      scrollSelectors.viewer,
+      viewerSelector,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       totalEntries,
       scrollToTotalBottomOffset,
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'notes',
-      color: 'rgba(64, 165, 138, 1)',
+      color: 'rgba(52, 168, 83, 1)',
     });
     await E2eTestUtils.checkFinalRealTimestamp('2022-11-21, 18:05:18.259');
     await E2eTestUtils.checkInitialRealTimestamp('2022-11-21, 18:05:09.777');
@@ -66,14 +61,14 @@ describe('Viewer Protolog', () => {
     );
 
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       totalEntries,
       scrollToTotalBottomOffset,
     );
     await filterByText('FREEZE');
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       4,
     );
@@ -85,23 +80,23 @@ describe('Viewer Protolog', () => {
     expectedFilteredEntries: number,
   ) {
     await E2eTestUtils.toggleSelectFilterOptions(
-      scrollSelectors.viewer,
+      viewerSelector,
       filterSelector,
       options,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       expectedFilteredEntries,
     );
 
     await E2eTestUtils.toggleSelectFilterOptions(
-      scrollSelectors.viewer,
+      viewerSelector,
       filterSelector,
       options,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       totalEntries,
       scrollToTotalBottomOffset,
@@ -110,8 +105,8 @@ describe('Viewer Protolog', () => {
 
   async function filterByText(filterString: string) {
     await E2eTestUtils.updateInputField(
-      `${scrollSelectors.viewer} .filters .text`,
-      'protologTextInput',
+      `${viewerSelector} .filters .text`,
+      'Search text',
       filterString,
     );
   }
diff --git a/tools/winscope/src/test/e2e/viewer_screen_recording_test.ts b/tools/winscope/src/test/e2e/viewer_screen_recording_test.ts
index 704362fbc..f4aada604 100644
--- a/tools/winscope/src/test/e2e/viewer_screen_recording_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_screen_recording_test.ts
@@ -17,9 +17,10 @@ import {browser, by, element} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer ScreenRecording', () => {
-  beforeAll(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+  const viewerSelector = 'viewer-media-based';
+
+  beforeEach(async () => {
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -30,12 +31,47 @@ describe('Viewer ScreenRecording', () => {
     await E2eTestUtils.closeSnackBar();
     await E2eTestUtils.clickViewTracesButton();
 
-    const viewer = element(by.css('viewer-screen-recording'));
+    const viewer = element(by.css(viewerSelector));
     expect(await viewer.isPresent()).toBeTruthy();
 
-    const video = element(by.css('viewer-screen-recording video'));
+    const video = element(by.css(`${viewerSelector} video`));
     expect(await video.isPresent()).toBeTruthy();
     expect(await video.getAttribute('src')).toContain('blob:');
     expect(await video.getAttribute('currentTime')).toBeCloseTo(0, 0.001);
   });
+
+  it('processes files and renders view with multiple recordings', async () => {
+    await E2eTestUtils.uploadFixture(
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
+    );
+    await E2eTestUtils.closeSnackBar();
+    await E2eTestUtils.clickViewTracesButton();
+
+    const viewer = element(by.css(viewerSelector));
+    expect(await viewer.isPresent()).toBeTruthy();
+
+    const video = element(by.css(`${viewerSelector} video`));
+    expect(await video.isPresent()).toBeTruthy();
+    const src = await video.getAttribute('src');
+    expect(src).toContain('blob:');
+
+    const overlayTitle = element(by.css(`${viewerSelector} .overlay-title`));
+    expect(await overlayTitle.getText()).toEqual(
+      'screen_recording_metadata_v2',
+    );
+
+    const selectTrigger = element(
+      by.css(`${viewerSelector} .mat-select-trigger`),
+    );
+    expect(await selectTrigger.isPresent()).toBeTruthy();
+    await selectTrigger.click();
+    const option2 = element.all(by.css('.mat-option')).last();
+    await option2.click();
+
+    expect(await video.isPresent()).toBeTruthy();
+    const newSrc = await video.getAttribute('src');
+    expect(newSrc).toContain('blob:');
+    expect(newSrc).not.toEqual(src);
+  });
 });
diff --git a/tools/winscope/src/test/e2e/viewer_screenshot_test.ts b/tools/winscope/src/test/e2e/viewer_screenshot_test.ts
new file mode 100644
index 000000000..8084a48b9
--- /dev/null
+++ b/tools/winscope/src/test/e2e/viewer_screenshot_test.ts
@@ -0,0 +1,73 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {browser, by, element} from 'protractor';
+import {E2eTestUtils} from './utils';
+
+describe('Viewer Screenshot', () => {
+  const viewerSelector = 'viewer-media-based';
+
+  beforeEach(async () => {
+    await E2eTestUtils.beforeEach(1000);
+    await browser.get(E2eTestUtils.WINSCOPE_URL);
+  });
+
+  it('processes file and renders view', async () => {
+    await E2eTestUtils.uploadFixture('traces/screenshot.png');
+    await E2eTestUtils.closeSnackBar();
+    await E2eTestUtils.clickViewTracesButton();
+
+    const viewer = element(by.css(viewerSelector));
+    expect(await viewer.isPresent()).toBeTruthy();
+
+    const img = element(by.css(`${viewerSelector} img`));
+    expect(await img.isPresent()).toBeTruthy();
+    expect(await img.getAttribute('src')).toContain('blob:');
+  });
+
+  it('processes files and renders view with multiple screenshots', async () => {
+    await E2eTestUtils.uploadFixture(
+      'traces/screenshot.png',
+      'traces/screenshot_2.png',
+    );
+    await E2eTestUtils.closeSnackBar();
+    await E2eTestUtils.clickViewTracesButton();
+
+    const viewer = element(by.css(viewerSelector));
+    expect(await viewer.isPresent()).toBeTruthy();
+
+    const img = element(by.css(`${viewerSelector} img`));
+    expect(await img.isPresent()).toBeTruthy();
+    const src = await img.getAttribute('src');
+    expect(src).toContain('blob:');
+
+    const overlayTitle = element(by.css(`${viewerSelector} .overlay-title`));
+    expect(await overlayTitle.getText()).toEqual('screenshot');
+
+    const selectTrigger = element(
+      by.css(`${viewerSelector} .mat-select-trigger`),
+    );
+    expect(await selectTrigger.isPresent()).toBeTruthy();
+    await selectTrigger.click();
+    const option2 = element.all(by.css('.mat-option')).last();
+    await option2.click();
+
+    expect(await img.isPresent()).toBeTruthy();
+    const newSrc = await img.getAttribute('src');
+    expect(newSrc).toContain('blob:');
+    expect(newSrc).not.toEqual(src);
+    expect(await overlayTitle.getText()).toEqual('screenshot_2');
+  });
+});
diff --git a/tools/winscope/src/test/e2e/viewer_surface_flinger_test.ts b/tools/winscope/src/test/e2e/viewer_surface_flinger_test.ts
index 7a5d3a825..64fff3e07 100644
--- a/tools/winscope/src/test/e2e/viewer_surface_flinger_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_surface_flinger_test.ts
@@ -21,8 +21,7 @@ describe('Viewer Surface Flinger', () => {
   const viewerSelector = 'viewer-surface-flinger';
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
diff --git a/tools/winscope/src/test/e2e/viewer_transactions_test.ts b/tools/winscope/src/test/e2e/viewer_transactions_test.ts
index 3d8a64d7a..97eec796d 100644
--- a/tools/winscope/src/test/e2e/viewer_transactions_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_transactions_test.ts
@@ -18,17 +18,12 @@ import {browser, by, element, ElementFinder} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer Transactions', () => {
-  const scrollSelectors = {
-    viewer: 'viewer-transactions',
-    scroll: '.scroll',
-    entry: '.entry',
-  };
+  const viewerSelector = 'viewer-transactions';
   const totalEntries = 9534;
-  const scrollToTotalBottomOffset = 980000;
+  const scrollToTotalBottomOffset = 1000000;
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
@@ -36,17 +31,17 @@ describe('Viewer Transactions', () => {
     await E2eTestUtils.loadTraceAndCheckViewer(
       'traces/deployment_full_trace_phone.zip',
       'Transactions',
-      scrollSelectors.viewer,
+      viewerSelector,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       totalEntries,
       scrollToTotalBottomOffset,
     );
     await E2eTestUtils.checkTimelineTraceSelector({
       icon: 'show_chart',
-      color: 'rgba(91, 185, 116, 1)',
+      color: 'rgba(13, 101, 45, 1)',
     });
     await E2eTestUtils.checkFinalRealTimestamp('2022-11-21, 18:05:19.592');
     await E2eTestUtils.checkInitialRealTimestamp('2022-11-21, 11:36:19.513');
@@ -59,13 +54,11 @@ describe('Viewer Transactions', () => {
 
     await checkSelectFilter('.pid', ['6914'], 2);
     await checkSelectFilter('.uid', ['10161'], 16);
-    await checkSelectFilter('.what', ['eBackgroundBlurRadiusChanged'], 10);
+    await checkSelectFilter('.flags', ['eBackgroundBlurRadiusChanged'], 10);
   });
 
   async function checkSelectedEntry() {
-    const selectedEntry = element(
-      by.css(`${scrollSelectors.viewer} ${scrollSelectors.scroll} .current`),
-    );
+    const selectedEntry = element(by.css(`${viewerSelector} .scroll .current`));
     expect(await selectedEntry.isPresent()).toBeTruthy();
 
     const transactionId = selectedEntry.element(by.css('.transaction-id'));
@@ -80,7 +73,7 @@ describe('Viewer Transactions', () => {
     const uid = selectedEntry.element(by.css('.uid'));
     expect(await uid.getText()).toEqual('1000');
 
-    const type = selectedEntry.element(by.css('.type'));
+    const type = selectedEntry.element(by.css('.transaction-type'));
     expect(await type.getText()).toEqual('LAYER_CHANGED');
 
     const layerOrDisplayId = selectedEntry.element(
@@ -90,16 +83,16 @@ describe('Viewer Transactions', () => {
 
     const whatString =
       'eLayerChanged | eAlphaChanged | eFlagsChanged | eReparent | eColorChanged | eHasListenerCallbacksChanged';
-    const what = selectedEntry.element(by.css('.what'));
+    const what = selectedEntry.element(by.css('.flags'));
     expect(await what.getText()).toEqual(whatString);
 
     await E2eTestUtils.checkItemInPropertiesTree(
-      scrollSelectors.viewer,
+      viewerSelector,
       'what',
       'what:\n' + whatString,
     );
     await E2eTestUtils.checkItemInPropertiesTree(
-      scrollSelectors.viewer,
+      viewerSelector,
       'color',
       'color:\n(0.106, 0.106, 0.106)',
     );
@@ -111,23 +104,23 @@ describe('Viewer Transactions', () => {
     expectedFilteredEntries: number,
   ) {
     await E2eTestUtils.toggleSelectFilterOptions(
-      scrollSelectors.viewer,
+      viewerSelector,
       filterSelector,
       options,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       expectedFilteredEntries,
     );
 
     await E2eTestUtils.toggleSelectFilterOptions(
-      scrollSelectors.viewer,
+      viewerSelector,
       filterSelector,
       options,
     );
     await E2eTestUtils.checkTotalScrollEntries(
-      scrollSelectors,
+      viewerSelector,
       scrollViewport,
       totalEntries,
       scrollToTotalBottomOffset,
diff --git a/tools/winscope/src/test/e2e/viewer_transitions_test.ts b/tools/winscope/src/test/e2e/viewer_transitions_test.ts
index c43814f5a..892d818e7 100644
--- a/tools/winscope/src/test/e2e/viewer_transitions_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_transitions_test.ts
@@ -17,11 +17,11 @@ import {browser, by, element} from 'protractor';
 import {E2eTestUtils} from './utils';
 
 describe('Viewer Transitions', () => {
-  beforeAll(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+  beforeEach(async () => {
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
+
   it('processes trace and renders view', async () => {
     await E2eTestUtils.uploadFixture(
       'traces/elapsed_and_real_timestamp/wm_transition_trace.pb',
diff --git a/tools/winscope/src/test/e2e/viewer_window_manager_test.ts b/tools/winscope/src/test/e2e/viewer_window_manager_test.ts
index 6733750a0..267e4660d 100644
--- a/tools/winscope/src/test/e2e/viewer_window_manager_test.ts
+++ b/tools/winscope/src/test/e2e/viewer_window_manager_test.ts
@@ -21,8 +21,7 @@ describe('Viewer Window Manager', () => {
   const viewerSelector = 'viewer-window-manager';
 
   beforeEach(async () => {
-    browser.manage().timeouts().implicitlyWait(1000);
-    await E2eTestUtils.checkServerIsUp('Winscope', E2eTestUtils.WINSCOPE_URL);
+    await E2eTestUtils.beforeEach(1000);
     await browser.get(E2eTestUtils.WINSCOPE_URL);
   });
 
diff --git a/tools/winscope/src/test/fixtures/traces/WindowManager.zip.gz b/tools/winscope/src/test/fixtures/traces/WindowManager.zip.gz
new file mode 100644
index 000000000..f130d5d23
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/WindowManager.zip.gz differ
diff --git a/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/window_trace_critical.winscope b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/window_trace_critical.winscope
new file mode 100644
index 000000000..516bb037e
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/elapsed_and_real_timestamp/window_trace_critical.winscope differ
diff --git a/tools/winscope/src/test/fixtures/traces/eventlog_no_cujs.winscope b/tools/winscope/src/test/fixtures/traces/eventlog_no_cujs.winscope
new file mode 100644
index 000000000..e8cf5c251
--- /dev/null
+++ b/tools/winscope/src/test/fixtures/traces/eventlog_no_cujs.winscope
@@ -0,0 +1,6 @@
+EventLog
+
+--------- beginning of events
+         1722505528.473000000 shell 19243 19243 I auditd  : type=1400 audit(0.0:178): avc:  denied  { append } for  comm="perfetto" path="/data/local/tmp/winscope_signal_handler.log" dev="dm-53" ino=10860 scontext=u:r:perfetto:s0 tcontext=u:object_r:shell_data_file:s0 tclass=file permissive=0
+         1722505529.729000000 shell 19846 19846 I auditd  : type=1400 audit(0.0:179): avc:  denied  { append } for  comm="perfetto" path="/data/local/tmp/winscope_signal_handler.log" dev="dm-53" ino=10860 scontext=u:r:perfetto:s0 tcontext=u:object_r:shell_data_file:s0 tclass=file permissive=0
+         1722505530.733000000 shell 20350 20350 I auditd  : type=1400 audit(0.0:180): avc:  denied  { append } for  comm="perfetto" path="/data/local/tmp/winscope_signal_handler.log" dev="dm-53" ino=10860 scontext=u:r:perfetto:s0 tcontext=u:object_r:shell_data_file:s0 tclass=file permissive=0
diff --git a/tools/winscope/src/test/fixtures/traces/no_entries_view_capture.vc b/tools/winscope/src/test/fixtures/traces/no_entries_view_capture.vc
new file mode 100644
index 000000000..704bbf946
--- /dev/null
+++ b/tools/winscope/src/test/fixtures/traces/no_entries_view_capture.vc
@@ -0,0 +1 @@
+	xeeseh1/com.android.internal.policy.PhoneWindow@60e29a8%com.google.android.apps.nexuslauncher)AM
\ No newline at end of file
diff --git a/tools/winscope/src/test/fixtures/traces/perfetto/input-events.perfetto-trace b/tools/winscope/src/test/fixtures/traces/perfetto/input-events.perfetto-trace
index 44a23b841..b930d7c52 100644
Binary files a/tools/winscope/src/test/fixtures/traces/perfetto/input-events.perfetto-trace and b/tools/winscope/src/test/fixtures/traces/perfetto/input-events.perfetto-trace differ
diff --git a/tools/winscope/src/test/fixtures/traces/perfetto/input-missing-vsync-ids.perfetto-trace b/tools/winscope/src/test/fixtures/traces/perfetto/input-missing-vsync-ids.perfetto-trace
new file mode 100644
index 000000000..645f0f650
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/perfetto/input-missing-vsync-ids.perfetto-trace differ
diff --git a/tools/winscope/src/test/fixtures/traces/perfetto/windowmanager.perfetto-trace b/tools/winscope/src/test/fixtures/traces/perfetto/windowmanager.perfetto-trace
new file mode 100644
index 000000000..6e182728b
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/perfetto/windowmanager.perfetto-trace differ
diff --git a/tools/winscope/src/test/fixtures/traces/recursive_winscope.zip b/tools/winscope/src/test/fixtures/traces/recursive_winscope.zip
new file mode 100644
index 000000000..b8d401d41
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/recursive_winscope.zip differ
diff --git a/tools/winscope/src/test/fixtures/traces/screenshot_2.png b/tools/winscope/src/test/fixtures/traces/screenshot_2.png
new file mode 100644
index 000000000..747610742
Binary files /dev/null and b/tools/winscope/src/test/fixtures/traces/screenshot_2.png differ
diff --git a/tools/winscope/src/test/remote_tool_mock/app_component.ts b/tools/winscope/src/test/remote_tool_mock/app_component.ts
index 6458eb9e4..90696df79 100644
--- a/tools/winscope/src/test/remote_tool_mock/app_component.ts
+++ b/tools/winscope/src/test/remote_tool_mock/app_component.ts
@@ -253,7 +253,7 @@ export class AppComponent {
     const timestampType = assertDefined(message.timestampType);
     switch (timestampType) {
       case TimestampType.UNKNOWN:
-        throw Error("Winscope shouldn't send timestamps with UNKNOWN type");
+        throw new Error("Winscope shouldn't send timestamps with UNKNOWN type");
       case TimestampType.CLOCK_BOOTTIME: {
         paragraph = document.querySelector(
           '.paragraph-received-boottime-timestamp',
diff --git a/tools/winscope/src/test/unit/hierarchy_tree_builder.ts b/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
index 493503f71..52276e567 100644
--- a/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
+++ b/tools/winscope/src/test/unit/hierarchy_tree_builder.ts
@@ -15,6 +15,7 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {TraceRect} from 'trace/trace_rect';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {OperationChain} from 'trace/tree_node/operations/operation_chain';
 import {PropertiesProvider} from 'trace/tree_node/properties_provider';
@@ -86,6 +87,12 @@ export class HierarchyTreeBuilder extends TreeBuilder<
       .build();
     rootNode.addOrReplaceChild(childNode);
     childNode.setParent(rootNode);
+    if (child.rects !== undefined) {
+      childNode.setRects(child.rects);
+    }
+    if (child.secondaryRects !== undefined) {
+      childNode.setSecondaryRects(child.secondaryRects);
+    }
   }
 
   private makeHierarchyNodeId() {
@@ -98,4 +105,6 @@ export interface ChildHierarchy {
   name: string;
   properties?: any;
   children?: ChildHierarchy[];
+  rects?: TraceRect[];
+  secondaryRects?: TraceRect[];
 }
diff --git a/tools/winscope/src/test/unit/mock_adb_connection.ts b/tools/winscope/src/test/unit/mock_adb_connection.ts
new file mode 100644
index 000000000..205dd44c4
--- /dev/null
+++ b/tools/winscope/src/test/unit/mock_adb_connection.ts
@@ -0,0 +1,97 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FunctionUtils} from 'common/function_utils';
+import {AdbConnection} from 'trace_collection/adb_connection';
+import {AdbDevice} from 'trace_collection/adb_device';
+import {ConnectionState} from 'trace_collection/connection_state';
+import {TraceRequest} from 'trace_collection/trace_request';
+
+export class MockAdbConnection extends AdbConnection {
+  state: ConnectionState = ConnectionState.CONNECTING;
+  errorText = '';
+  files = [new File([], 'test_file')];
+  devices: AdbDevice[] = [];
+  availableTracesChangeCallback: (traces: string[]) => void =
+    FunctionUtils.DO_NOTHING;
+  devicesChangeCallback: (devices: AdbDevice[]) => void =
+    FunctionUtils.DO_NOTHING;
+  private detectStateChangeInUi: () => Promise<void> =
+    FunctionUtils.DO_NOTHING_ASYNC;
+
+  async initialize(
+    detectStateChangeInUi: () => Promise<void>,
+    availableTracesChangeCallback: (traces: string[]) => void,
+    devicesChangeCallback: (devices: AdbDevice[]) => void,
+  ) {
+    this.detectStateChangeInUi = detectStateChangeInUi;
+    this.availableTracesChangeCallback = availableTracesChangeCallback;
+    this.devicesChangeCallback = devicesChangeCallback;
+    this.setState(ConnectionState.CONNECTING);
+  }
+
+  setState(state: ConnectionState) {
+    this.state = state;
+    this.detectStateChangeInUi();
+  }
+
+  async restartConnection(): Promise<void> {
+    this.setState(ConnectionState.CONNECTING);
+  }
+
+  setSecurityToken(token: string) {
+    // do nothing
+  }
+
+  getDevices(): AdbDevice[] {
+    return this.devices;
+  }
+
+  getState(): ConnectionState {
+    return this.state;
+  }
+
+  getErrorText(): string {
+    return this.errorText;
+  }
+
+  onDestroy() {
+    // do nothing
+  }
+
+  async startTrace(
+    device: AdbDevice,
+    requestedTraces: TraceRequest[],
+  ): Promise<void> {
+    this.setState(ConnectionState.STARTING_TRACE);
+  }
+
+  async endTrace() {
+    this.setState(ConnectionState.ENDING_TRACE);
+  }
+
+  async dumpState(
+    device: AdbDevice,
+    requestedDumps: TraceRequest[],
+  ): Promise<void> {
+    this.setState(ConnectionState.DUMPING_STATE);
+  }
+
+  async fetchLastTracingSessionData(device: AdbDevice): Promise<File[]> {
+    this.setState(ConnectionState.LOADING_DATA);
+    return this.files;
+  }
+}
diff --git a/tools/winscope/src/test/unit/parser_builder.ts b/tools/winscope/src/test/unit/parser_builder.ts
index 74dd008f3..02162da26 100644
--- a/tools/winscope/src/test/unit/parser_builder.ts
+++ b/tools/winscope/src/test/unit/parser_builder.ts
@@ -31,6 +31,7 @@ export class ParserBuilder<T> {
   private customQueryResult = new Map<CustomQueryType, {}>();
   private descriptors = ['file descriptor'];
   private noOffsets = false;
+  private isCorrupted = false;
 
   setType(type: TraceType): this {
     this.type = type;
@@ -52,6 +53,11 @@ export class ParserBuilder<T> {
     return this;
   }
 
+  setIsCorrupted(value: boolean): this {
+    this.isCorrupted = value;
+    return this;
+  }
+
   setCustomQueryResult<Q extends CustomQueryType>(
     type: Q,
     result: CustomQueryParserResultTypeMap[Q],
@@ -93,6 +99,7 @@ export class ParserBuilder<T> {
       this.customQueryResult,
       this.descriptors,
       this.noOffsets,
+      this.isCorrupted,
     );
   }
 
diff --git a/tools/winscope/src/test/unit/timestamp_converter_utils.ts b/tools/winscope/src/test/unit/timestamp_converter_utils.ts
index d7e0ce14b..dde42b95e 100644
--- a/tools/winscope/src/test/unit/timestamp_converter_utils.ts
+++ b/tools/winscope/src/test/unit/timestamp_converter_utils.ts
@@ -65,6 +65,10 @@ class TimestampConverterTestUtils {
       valueNs,
     );
   }
+
+  makeZeroTimestamp(): Timestamp {
+    return this.TIMESTAMP_CONVERTER_NO_RTE_OFFSET.makeZeroTimestamp();
+  }
 }
 
 export const TimestampConverterUtils = new TimestampConverterTestUtils();
diff --git a/tools/winscope/src/test/unit/trace_builder.ts b/tools/winscope/src/test/unit/trace_builder.ts
index 9be70379a..882e266dd 100644
--- a/tools/winscope/src/test/unit/trace_builder.ts
+++ b/tools/winscope/src/test/unit/trace_builder.ts
@@ -40,6 +40,7 @@ export class TraceBuilder<T> {
   private frameMap?: FrameMap;
   private frameMapBuilder?: FrameMapBuilder;
   private descriptors: string[] = [];
+  private isCorrupted = false;
 
   setType(type: TraceType): TraceBuilder<T> {
     this.type = type;
@@ -85,6 +86,16 @@ export class TraceBuilder<T> {
     return this;
   }
 
+  setDescriptors(descriptors: string[]): TraceBuilder<T> {
+    this.descriptors = descriptors;
+    return this;
+  }
+
+  setIsCorrupted(value: boolean): TraceBuilder<T> {
+    this.isCorrupted = value;
+    return this;
+  }
+
   build(): Trace<T> {
     if (!this.parser) {
       this.parser = this.createParser();
@@ -111,7 +122,9 @@ export class TraceBuilder<T> {
   }
 
   private createParser(): Parser<T> {
-    const builder = new ParserBuilder<T>().setType(this.type);
+    const builder = new ParserBuilder<T>()
+      .setType(this.type)
+      .setIsCorrupted(this.isCorrupted);
 
     if (this.timestamps) {
       builder.setTimestamps(this.timestamps);
@@ -121,6 +134,10 @@ export class TraceBuilder<T> {
       builder.setEntries(this.entries);
     }
 
+    if (this.descriptors.length > 0) {
+      builder.setDescriptors(this.descriptors);
+    }
+
     this.parserCustomQueryResult?.forEach((result, queryType) => {
       builder.setCustomQueryResult(queryType, result as any);
     });
diff --git a/tools/winscope/src/test/unit/traces_builder.ts b/tools/winscope/src/test/unit/traces_builder.ts
index b2d9c3581..e566e2ee4 100644
--- a/tools/winscope/src/test/unit/traces_builder.ts
+++ b/tools/winscope/src/test/unit/traces_builder.ts
@@ -23,15 +23,25 @@ import {TraceBuilder} from './trace_builder';
 export class TracesBuilder {
   private readonly traceBuilders = new Map<TraceType, TraceBuilder<{}>>();
 
-  setEntries(type: TraceType, entries: Array<{}>): TracesBuilder {
+  setEntries(
+    type: TraceType,
+    entries: Array<{}>,
+    descriptors?: string[],
+  ): TracesBuilder {
     const builder = this.getOrCreateTraceBuilder(type);
     builder.setEntries(entries);
+    if (descriptors) builder.setDescriptors(descriptors);
     return this;
   }
 
-  setTimestamps(type: TraceType, timestamps: Timestamp[]): TracesBuilder {
+  setTimestamps(
+    type: TraceType,
+    timestamps: Timestamp[],
+    descriptors?: string[],
+  ): TracesBuilder {
     const builder = this.getOrCreateTraceBuilder(type);
     builder.setTimestamps(timestamps);
+    if (descriptors) builder.setDescriptors(descriptors);
     return this;
   }
 
diff --git a/tools/winscope/src/test/unit/tree_builder.ts b/tools/winscope/src/test/unit/tree_builder.ts
index a0b9b301b..68d9ed797 100644
--- a/tools/winscope/src/test/unit/tree_builder.ts
+++ b/tools/winscope/src/test/unit/tree_builder.ts
@@ -31,10 +31,10 @@ export abstract class TreeBuilder<T, U> {
 
   build(): T {
     if (this.id === undefined) {
-      throw Error('id not set');
+      throw new Error('id not set');
     }
     if (this.name === undefined) {
-      throw Error('name not set');
+      throw new Error('name not set');
     }
 
     const rootNode = this.makeRootNode();
diff --git a/tools/winscope/src/test/unit/tree_node_utils.ts b/tools/winscope/src/test/unit/tree_node_utils.ts
index cd015ffb6..2e577bd14 100644
--- a/tools/winscope/src/test/unit/tree_node_utils.ts
+++ b/tools/winscope/src/test/unit/tree_node_utils.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {TransformType} from 'parsers/surface_flinger/transform_utils';
+import {TransformTypeFlags} from 'parsers/surface_flinger/transform_utils';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
@@ -81,8 +81,8 @@ export class TreeNodeUtils {
   static makeMatrixNode(
     dsdx: number,
     dtdx: number,
-    dsdy: number,
     dtdy: number,
+    dsdy: number,
   ): PropertyTreeNode {
     return new PropertyTreeBuilder()
       .setRootId('test node')
@@ -90,13 +90,13 @@ export class TreeNodeUtils {
       .setChildren([
         {name: 'dsdx', value: dsdx},
         {name: 'dtdx', value: dtdx},
-        {name: 'dsdy', value: dsdy},
         {name: 'dtdy', value: dtdy},
+        {name: 'dsdy', value: dsdy},
       ])
       .build();
   }
 
-  static makeTransformNode(type: TransformType): PropertyTreeNode {
+  static makeTransformNode(type: TransformTypeFlags): PropertyTreeNode {
     return new PropertyTreeBuilder()
       .setRootId('test node')
       .setName('transform')
@@ -204,6 +204,26 @@ export class TreeNodeUtils {
       }
     }
 
+    if (
+      node instanceof UiHierarchyTreeNode &&
+      expectedNode instanceof UiHierarchyTreeNode
+    ) {
+      if (node.heading() !== expectedNode.heading()) {
+        return false;
+      }
+      if (node.getDisplayName() !== expectedNode.getDisplayName()) {
+        return false;
+      }
+      if (
+        !(
+          node.getChips().length === 0 && expectedNode.getChips().length === 0
+        ) &&
+        node.getChips() !== expectedNode.getChips()
+      ) {
+        return false;
+      }
+    }
+
     const nodeChildren = node.getAllChildren();
     const expectedChildren = expectedNode.getAllChildren();
     if (nodeChildren.length !== expectedChildren.length) return false;
diff --git a/tools/winscope/src/test/unit/user_notifier_checker.ts b/tools/winscope/src/test/unit/user_notifier_checker.ts
new file mode 100644
index 000000000..a06e70121
--- /dev/null
+++ b/tools/winscope/src/test/unit/user_notifier_checker.ts
@@ -0,0 +1,51 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {UserNotifier} from 'common/user_notifier';
+import {UserNotification} from 'messaging/user_notification';
+
+export class UserNotifierChecker {
+  private userNotifierAdd: jasmine.Spy<jasmine.Func>;
+  private userNotifierNotify: jasmine.Spy<jasmine.Func>;
+
+  constructor() {
+    this.userNotifierAdd = spyOn(UserNotifier, 'add').and.callThrough();
+    this.userNotifierNotify = spyOn(UserNotifier, 'notify');
+  }
+
+  expectNone() {
+    expect(this.userNotifierAdd).not.toHaveBeenCalled();
+  }
+
+  expectAdded(notifications: UserNotification[]) {
+    notifications.forEach((n) =>
+      expect(this.userNotifierAdd).toHaveBeenCalledWith(n),
+    );
+    expect(this.userNotifierNotify).not.toHaveBeenCalled();
+  }
+
+  expectNotified(notifications: UserNotification[]) {
+    notifications.forEach((n) =>
+      expect(this.userNotifierAdd).toHaveBeenCalledWith(n),
+    );
+    expect(this.userNotifierNotify).toHaveBeenCalled();
+  }
+
+  reset() {
+    this.userNotifierAdd.calls.reset();
+    this.userNotifierNotify.calls.reset();
+  }
+}
diff --git a/tools/winscope/src/test/unit/utils.ts b/tools/winscope/src/test/unit/utils.ts
index 73b39f900..38445e1bb 100644
--- a/tools/winscope/src/test/unit/utils.ts
+++ b/tools/winscope/src/test/unit/utils.ts
@@ -20,8 +20,8 @@ import {Timestamp} from 'common/time';
 import {TimestampConverter} from 'common/timestamp_converter';
 import {UrlUtils} from 'common/url_utils';
 import {ParserFactory as LegacyParserFactory} from 'parsers/legacy/parser_factory';
-import {TracesParserFactory} from 'parsers/legacy/traces_parser_factory';
 import {ParserFactory as PerfettoParserFactory} from 'parsers/perfetto/parser_factory';
+import {TracesParserFactory} from 'parsers/traces/traces_parser_factory';
 import {Parser} from 'trace/parser';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
@@ -78,6 +78,11 @@ class UnitTestUtils {
       converter,
       initializeRealToElapsedTimeOffsetNs,
     );
+
+    expect(parsers.length)
+      .withContext(`Should have been able to create a parser for ${filename}`)
+      .toBeGreaterThanOrEqual(1);
+
     return parsers[0];
   }
 
@@ -94,7 +99,6 @@ class UnitTestUtils {
       [file],
       converter,
       undefined,
-      undefined,
     );
 
     if (initializeRealToElapsedTimeOffsetNs) {
@@ -118,16 +122,10 @@ class UnitTestUtils {
       }
     }
 
-    const parsers = fileAndParsers.map((fileAndParser) => {
+    return fileAndParsers.map((fileAndParser) => {
       fileAndParser.parser.createTimestamps();
       return fileAndParser.parser;
     });
-
-    expect(parsers.length)
-      .withContext(`Should have been able to create a parser for ${filename}`)
-      .toBeGreaterThanOrEqual(1);
-
-    return parsers;
   }
 
   static async getPerfettoParser<T extends TraceType>(
@@ -171,11 +169,24 @@ class UnitTestUtils {
     withUTCOffset = false,
   ): Promise<Parser<object>> {
     const converter = UnitTestUtils.getTimestampConverter(withUTCOffset);
-    const parsersArray = await Promise.all(
-      filenames.map(async (filename) =>
-        UnitTestUtils.getParser(filename, converter, true),
-      ),
-    );
+    const legacyParsers = (
+      await Promise.all(
+        filenames.map(async (filename) =>
+          UnitTestUtils.getParsers(filename, converter, true),
+        ),
+      )
+    ).reduce((acc, cur) => acc.concat(cur), []);
+
+    const perfettoParsers = (
+      await Promise.all(
+        filenames.map(async (filename) =>
+          UnitTestUtils.getPerfettoParsers(filename),
+        ),
+      )
+    ).reduce((acc, cur) => acc.concat(cur), []);
+
+    const parsersArray = legacyParsers.concat(perfettoParsers);
+
     const offset = parsersArray
       .filter((parser) => parser.getRealToBootTimeOffsetNs() !== undefined)
       .sort((a, b) =>
@@ -289,6 +300,11 @@ class UnitTestUtils {
     return [entries, secondEntries];
   }
 
+  static async getTraceEntry<T>(filename: string, index = 0) {
+    const parser = (await UnitTestUtils.getParser(filename)) as Parser<T>;
+    return parser.getEntry(index);
+  }
+
   static timestampEqualityTester(first: any, second: any): boolean | undefined {
     if (first instanceof Timestamp && second instanceof Timestamp) {
       return UnitTestUtils.testTimestamps(first, second);
@@ -340,11 +356,6 @@ class UnitTestUtils {
     }
     return true;
   }
-
-  private static async getTraceEntry<T>(filename: string, index = 0) {
-    const parser = (await UnitTestUtils.getParser(filename)) as Parser<T>;
-    return parser.getEntry(index);
-  }
 }
 
 export {UnitTestUtils};
diff --git a/tools/winscope/src/trace/cuj_type.ts b/tools/winscope/src/trace/cuj_type.ts
new file mode 100644
index 000000000..f9b5b1ff2
--- /dev/null
+++ b/tools/winscope/src/trace/cuj_type.ts
@@ -0,0 +1,20 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import intDefMapping from 'common/intDefMapping.json';
+
+export const CujType =
+  intDefMapping['com.android.internal.jank.Cuj.CujType'].values;
diff --git a/tools/winscope/src/trace/frame_map.ts b/tools/winscope/src/trace/frame_map.ts
index a1ba340f9..1f93cae3f 100644
--- a/tools/winscope/src/trace/frame_map.ts
+++ b/tools/winscope/src/trace/frame_map.ts
@@ -127,7 +127,7 @@ export class FrameMap {
     entry: AbsoluteEntryIndex,
   ): AbsoluteFrameIndex | undefined {
     if (entry < 0 || entry >= this.lengthEntries) {
-      throw Error(`Entry index out of bounds: ${entry}`);
+      throw new Error(`Entry index out of bounds: ${entry}`);
     }
     return this.entryToStartFrame[entry];
   }
@@ -136,7 +136,7 @@ export class FrameMap {
     entry: AbsoluteEntryIndex,
   ): AbsoluteFrameIndex | undefined {
     if (entry < 0 || entry >= this.lengthEntries) {
-      throw Error(`Entry index out of bounds: ${entry}`);
+      throw new Error(`Entry index out of bounds: ${entry}`);
     }
     return this.entryToEndFrame[entry];
   }
@@ -145,7 +145,7 @@ export class FrameMap {
     frame: AbsoluteFrameIndex,
   ): AbsoluteEntryIndex | undefined {
     if (frame < 0 || frame >= this.lengthFrames) {
-      throw Error(`Frame index out of bounds: ${frame}`);
+      throw new Error(`Frame index out of bounds: ${frame}`);
     }
     return this.frameToStartEntry[frame];
   }
@@ -154,7 +154,7 @@ export class FrameMap {
     frame: AbsoluteFrameIndex,
   ): AbsoluteEntryIndex | undefined {
     if (frame < 0 || frame >= this.lengthFrames) {
-      throw Error(`Frame index out of bounds: ${frame}`);
+      throw new Error(`Frame index out of bounds: ${frame}`);
     }
     return this.frameToEndEntry[frame];
   }
diff --git a/tools/winscope/src/trace/frame_mapper.ts b/tools/winscope/src/trace/frame_mapper.ts
index d1c1a03cb..28aa32ceb 100644
--- a/tools/winscope/src/trace/frame_mapper.ts
+++ b/tools/winscope/src/trace/frame_mapper.ts
@@ -69,13 +69,18 @@ export class FrameMapper {
     await this.tryPropagateMapping(
       TraceType.SURFACE_FLINGER,
       TraceType.TRANSACTIONS,
-      this.propagateFromSurfaceFlingerToTransactions,
+      this.propagateFromSurfaceFlingerToTraceWithVsyncIds,
     );
     await this.tryPropagateMapping(
       TraceType.SURFACE_FLINGER,
       TraceType.VIEW_CAPTURE,
       this.propagateFromSurfaceFlingerToViewCapture,
     );
+    await this.tryPropagateMapping(
+      TraceType.SURFACE_FLINGER,
+      TraceType.INPUT_EVENT_MERGED,
+      this.propagateFromSurfaceFlingerToTraceWithVsyncIds,
+    );
     await this.tryPropagateMapping(
       TraceType.TRANSACTIONS,
       TraceType.WINDOW_MANAGER,
@@ -124,12 +129,12 @@ export class FrameMapper {
     });
   }
 
-  private async propagateFromSurfaceFlingerToTransactions(
+  private async propagateFromSurfaceFlingerToTraceWithVsyncIds(
     surfaceFlinger: Trace<object>,
-    transactions: Trace<object>,
+    traceWithVsyncIds: Trace<object>,
     frameMapBuilder: FrameMapBuilder,
   ) {
-    const transactionEntries = await transactions.customQuery(
+    const entries = await traceWithVsyncIds.customQuery(
       CustomQueryType.VSYNCID,
     );
 
@@ -154,7 +159,7 @@ export class FrameMapper {
       vsyncIdToFrames.set(vsyncId, frames);
     });
 
-    transactionEntries.forEach((dstEntry) => {
+    entries.forEach((dstEntry) => {
       const vsyncId = dstEntry.getValue();
       const frames = vsyncIdToFrames.get(vsyncId);
       if (frames === undefined) {
diff --git a/tools/winscope/src/trace/frame_mapper_test.ts b/tools/winscope/src/trace/frame_mapper_test.ts
index 03a797c7f..b0a02639c 100644
--- a/tools/winscope/src/trace/frame_mapper_test.ts
+++ b/tools/winscope/src/trace/frame_mapper_test.ts
@@ -20,7 +20,7 @@ import {TraceBuilder} from 'test/unit/trace_builder';
 import {CustomQueryType} from './custom_query';
 import {FrameMapper} from './frame_mapper';
 import {AbsoluteFrameIndex} from './index_types';
-import {ScreenRecordingTraceEntry} from './screen_recording';
+import {MediaBasedTraceEntry} from './media_based_trace_entry';
 import {Trace} from './trace';
 import {Traces} from './traces';
 import {TraceType} from './trace_type';
@@ -375,101 +375,108 @@ describe('FrameMapper', () => {
     });
   });
 
-  describe('Transactions <-> SurfaceFlinger', () => {
-    let transactions: Trace<PropertyTreeNode>;
-    let surfaceFlinger: Trace<HierarchyTreeNode>;
-    let traces: Traces;
-
-    beforeAll(async () => {
-      // TRANSACTIONS:   0  1--2        3  4
-      //                  \     \        \
-      //                   \     \        \
-      // SURFACE_FLINGER:   0     1        2
-      transactions = new TraceBuilder<PropertyTreeNode>()
-        .setType(TraceType.TRANSACTIONS)
-        .setEntries([
-          'entry-0' as unknown as PropertyTreeNode,
-          'entry-1' as unknown as PropertyTreeNode,
-          'entry-2' as unknown as PropertyTreeNode,
-          'entry-3' as unknown as PropertyTreeNode,
-          'entry-4' as unknown as PropertyTreeNode,
-        ])
-        .setTimestamps([time0, time1, time2, time5, time6])
-        .setParserCustomQueryResult(CustomQueryType.VSYNCID, [
-          0n,
-          10n,
-          10n,
-          20n,
-          30n,
-        ])
-        .build();
-
-      surfaceFlinger = new TraceBuilder<HierarchyTreeNode>()
-        .setType(TraceType.SURFACE_FLINGER)
-        .setEntries([
-          'entry-0' as unknown as HierarchyTreeNode,
-          'entry-1' as unknown as HierarchyTreeNode,
-          'entry-2' as unknown as HierarchyTreeNode,
-        ])
-        .setTimestamps([time0, time1, time2])
-        .setParserCustomQueryResult(CustomQueryType.VSYNCID, [0n, 10n, 20n])
-        .build();
-
-      traces = new Traces();
-      traces.addTrace(transactions);
-      traces.addTrace(surfaceFlinger);
-      await new FrameMapper(traces).computeMapping();
-    });
-
-    it('associates entries/frames', async () => {
-      const expectedFrames = new Map<
-        AbsoluteFrameIndex,
-        Map<TraceType, Array<{}>>
-      >();
-      expectedFrames.set(
-        0,
-        new Map<TraceType, Array<{}>>([
-          [TraceType.TRANSACTIONS, [await transactions.getEntry(0).getValue()]],
-          [
-            TraceType.SURFACE_FLINGER,
-            [await surfaceFlinger.getEntry(0).getValue()],
-          ],
-        ]),
-      );
-      expectedFrames.set(
-        1,
-        new Map<TraceType, Array<{}>>([
-          [
-            TraceType.TRANSACTIONS,
+  const TRACES_WITH_VSYNC_IDS = [
+    TraceType.TRANSACTIONS,
+    TraceType.INPUT_EVENT_MERGED,
+  ];
+
+  TRACES_WITH_VSYNC_IDS.forEach((traceType) => {
+    describe(`TraceType[${traceType}] <-> SurfaceFlinger`, () => {
+      let trace: Trace<PropertyTreeNode>;
+      let surfaceFlinger: Trace<HierarchyTreeNode>;
+      let traces: Traces;
+
+      beforeAll(async () => {
+        // TRACE:          0  1--2        3  4
+        //                  \     \        \
+        //                   \     \        \
+        // SURFACE_FLINGER:   0     1        2
+        trace = new TraceBuilder<PropertyTreeNode>()
+          .setType(traceType)
+          .setEntries([
+            'entry-0' as unknown as PropertyTreeNode,
+            'entry-1' as unknown as PropertyTreeNode,
+            'entry-2' as unknown as PropertyTreeNode,
+            'entry-3' as unknown as PropertyTreeNode,
+            'entry-4' as unknown as PropertyTreeNode,
+          ])
+          .setTimestamps([time0, time1, time2, time5, time6])
+          .setParserCustomQueryResult(CustomQueryType.VSYNCID, [
+            0n,
+            10n,
+            10n,
+            20n,
+            30n,
+          ])
+          .build();
+
+        surfaceFlinger = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.SURFACE_FLINGER)
+          .setEntries([
+            'entry-0' as unknown as HierarchyTreeNode,
+            'entry-1' as unknown as HierarchyTreeNode,
+            'entry-2' as unknown as HierarchyTreeNode,
+          ])
+          .setTimestamps([time0, time1, time2])
+          .setParserCustomQueryResult(CustomQueryType.VSYNCID, [0n, 10n, 20n])
+          .build();
+
+        traces = new Traces();
+        traces.addTrace(trace);
+        traces.addTrace(surfaceFlinger);
+        await new FrameMapper(traces).computeMapping();
+      });
+
+      it('associates entries/frames', async () => {
+        const expectedFrames = new Map<
+          AbsoluteFrameIndex,
+          Map<TraceType, Array<{}>>
+        >();
+        expectedFrames.set(
+          0,
+          new Map<TraceType, Array<{}>>([
+            [traceType, [await trace.getEntry(0).getValue()]],
             [
-              await transactions.getEntry(1).getValue(),
-              await transactions.getEntry(2).getValue(),
+              TraceType.SURFACE_FLINGER,
+              [await surfaceFlinger.getEntry(0).getValue()],
             ],
-          ],
-          [
-            TraceType.SURFACE_FLINGER,
-            [await surfaceFlinger.getEntry(1).getValue()],
-          ],
-        ]),
-      );
-      expectedFrames.set(
-        2,
-        new Map<TraceType, Array<{}>>([
-          [TraceType.TRANSACTIONS, [await transactions.getEntry(3).getValue()]],
-          [
-            TraceType.SURFACE_FLINGER,
-            [await surfaceFlinger.getEntry(2).getValue()],
-          ],
-        ]),
-      );
+          ]),
+        );
+        expectedFrames.set(
+          1,
+          new Map<TraceType, Array<{}>>([
+            [
+              traceType,
+              [
+                await trace.getEntry(1).getValue(),
+                await trace.getEntry(2).getValue(),
+              ],
+            ],
+            [
+              TraceType.SURFACE_FLINGER,
+              [await surfaceFlinger.getEntry(1).getValue()],
+            ],
+          ]),
+        );
+        expectedFrames.set(
+          2,
+          new Map<TraceType, Array<{}>>([
+            [traceType, [await trace.getEntry(3).getValue()]],
+            [
+              TraceType.SURFACE_FLINGER,
+              [await surfaceFlinger.getEntry(2).getValue()],
+            ],
+          ]),
+        );
 
-      expect(await TracesUtils.extractFrames(traces)).toEqual(expectedFrames);
+        expect(await TracesUtils.extractFrames(traces)).toEqual(expectedFrames);
+      });
     });
   });
 
   describe('SurfaceFlinger <-> ScreenRecording', () => {
     let surfaceFlinger: Trace<HierarchyTreeNode>;
-    let screenRecording: Trace<ScreenRecordingTraceEntry>;
+    let screenRecording: Trace<MediaBasedTraceEntry>;
     let traces: Traces;
 
     beforeAll(async () => {
@@ -492,15 +499,15 @@ describe('FrameMapper', () => {
         .setTimestamps([time0, time1, time2, time4, time6, time7, time8])
         .build();
 
-      screenRecording = new TraceBuilder<ScreenRecordingTraceEntry>()
+      screenRecording = new TraceBuilder<MediaBasedTraceEntry>()
         .setType(TraceType.SCREEN_RECORDING)
         .setEntries([
-          'entry-0' as unknown as ScreenRecordingTraceEntry,
-          'entry-1' as unknown as ScreenRecordingTraceEntry,
-          'entry-2' as unknown as ScreenRecordingTraceEntry,
-          'entry-3' as unknown as ScreenRecordingTraceEntry,
-          'entry-4' as unknown as ScreenRecordingTraceEntry,
-          'entry-5' as unknown as ScreenRecordingTraceEntry,
+          'entry-0' as unknown as MediaBasedTraceEntry,
+          'entry-1' as unknown as MediaBasedTraceEntry,
+          'entry-2' as unknown as MediaBasedTraceEntry,
+          'entry-3' as unknown as MediaBasedTraceEntry,
+          'entry-4' as unknown as MediaBasedTraceEntry,
+          'entry-5' as unknown as MediaBasedTraceEntry,
         ])
         .setTimestamps([time0, time3, time4, time5, time8, time10seconds])
         .build();
@@ -584,9 +591,9 @@ describe('FrameMapper', () => {
       .setTimestamps([time0])
       .build();
 
-    const screenRecording = new TraceBuilder<ScreenRecordingTraceEntry>()
+    const screenRecording = new TraceBuilder<MediaBasedTraceEntry>()
       .setType(TraceType.SCREEN_RECORDING)
-      .setEntries(['entry-0' as unknown as ScreenRecordingTraceEntry])
+      .setEntries(['entry-0' as unknown as MediaBasedTraceEntry])
       .setTimestamps([time1])
       .build();
 
diff --git a/tools/winscope/src/trace/geometry_factory.ts b/tools/winscope/src/trace/geometry_factory.ts
new file mode 100644
index 000000000..2378e81c0
--- /dev/null
+++ b/tools/winscope/src/trace/geometry_factory.ts
@@ -0,0 +1,38 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Rect} from 'common/geometry/rect';
+import {Region} from 'common/geometry/region';
+import {PropertyTreeNode} from './tree_node/property_tree_node';
+
+export class GeometryFactory {
+  static makeRect(node: PropertyTreeNode): Rect {
+    const left = node.getChildByName('left')?.getValue() ?? 0;
+    const top = node.getChildByName('top')?.getValue() ?? 0;
+    const right = node.getChildByName('right')?.getValue() ?? 0;
+    const bottom = node.getChildByName('bottom')?.getValue() ?? 0;
+    return new Rect(left, top, right - left, bottom - top);
+  }
+
+  static makeRegion(node: PropertyTreeNode): Region {
+    const rects =
+      node
+        .getChildByName('rect')
+        ?.getAllChildren()
+        .map((rectNode) => GeometryFactory.makeRect(rectNode)) ?? [];
+    return new Region(rects);
+  }
+}
diff --git a/tools/winscope/src/trace/screen_recording.ts b/tools/winscope/src/trace/media_based_trace_entry.ts
similarity index 91%
rename from tools/winscope/src/trace/screen_recording.ts
rename to tools/winscope/src/trace/media_based_trace_entry.ts
index a33777165..04e969155 100644
--- a/tools/winscope/src/trace/screen_recording.ts
+++ b/tools/winscope/src/trace/media_based_trace_entry.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-class ScreenRecordingTraceEntry {
+class MediaBasedTraceEntry {
   constructor(
     public videoTimeSeconds: number,
     public videoData: Blob,
@@ -22,4 +22,4 @@ class ScreenRecordingTraceEntry {
   ) {}
 }
 
-export {ScreenRecordingTraceEntry};
+export {MediaBasedTraceEntry};
diff --git a/tools/winscope/src/trace/parser_mock.ts b/tools/winscope/src/trace/parser_mock.ts
index 0ce802033..f47656b78 100644
--- a/tools/winscope/src/trace/parser_mock.ts
+++ b/tools/winscope/src/trace/parser_mock.ts
@@ -29,6 +29,7 @@ export class ParserMock<T> implements Parser<T> {
     private readonly customQueryResult: Map<CustomQueryType, object>,
     private readonly descriptors: string[],
     private readonly noOffsets: boolean,
+    private readonly isCorrupted: boolean,
   ) {
     if (timestamps.length !== entries.length) {
       throw new Error(`Timestamps and entries must have the same length`);
@@ -64,6 +65,7 @@ export class ParserMock<T> implements Parser<T> {
   }
 
   getEntry(index: AbsoluteEntryIndex): Promise<T> {
+    if (this.isCorrupted) throw new Error('Corrupted trace');
     return Promise.resolve(this.entries[index]);
   }
 
@@ -77,7 +79,10 @@ export class ParserMock<T> implements Parser<T> {
         `This mock was not configured to support custom query type '${type}'. Something missing in your test set up?`,
       );
     }
-    if (Array.isArray(result)) {
+    if (
+      type !== CustomQueryType.SF_LAYERS_ID_AND_NAME &&
+      Array.isArray(result)
+    ) {
       result = result.slice(entriesRange.start, entriesRange.end);
     }
     return Promise.resolve(result) as Promise<
diff --git a/tools/winscope/src/trace/trace.ts b/tools/winscope/src/trace/trace.ts
index 89c550952..a5eb01319 100644
--- a/tools/winscope/src/trace/trace.ts
+++ b/tools/winscope/src/trace/trace.ts
@@ -15,7 +15,9 @@
  */
 
 import {ArrayUtils} from 'common/array_utils';
+import {assertDefined} from 'common/assert_utils';
 import {INVALID_TIME_NS, Timestamp} from 'common/time';
+import {TimestampUtils} from 'common/timestamp_utils';
 import {
   CustomQueryParamTypeMap,
   CustomQueryParserResultTypeMap,
@@ -32,6 +34,7 @@ import {
   RelativeEntryIndex,
 } from './index_types';
 import {Parser} from './parser';
+import {TRACE_INFO} from './trace_info';
 import {TraceType} from './trace_type';
 
 export {
@@ -63,10 +66,16 @@ export abstract class TraceEntry<T> {
     return this.timestamp;
   }
 
+  hasValidTimestamp() {
+    return this.timestamp.getValueNs() !== INVALID_TIME_NS;
+  }
+
   getFramesRange(): FramesRange | undefined {
     if (!this.fullTrace.hasFrameInfo()) {
       throw new Error(
-        `Trace ${this.fullTrace.type} can't be accessed in frame domain (no frame info available)`,
+        `Trace ${
+          TRACE_INFO[this.fullTrace.type].name
+        } can't be accessed in frame domain (no frame info available)`,
       );
     }
     return this.framesRange;
@@ -87,7 +96,15 @@ export class TraceEntryLazy<T> extends TraceEntry<T> {
   }
 
   override async getValue(): Promise<T> {
-    return await this.parser.getEntry(this.index);
+    try {
+      return await this.parser.getEntry(this.index);
+    } catch (e) {
+      this.fullTrace.setCorruptedState(
+        true,
+        `Cannot parse entry at index ${this.index}`,
+      );
+      throw e;
+    }
   }
 }
 
@@ -121,6 +138,8 @@ export class Trace<T> {
   private readonly entriesRange: EntriesRange;
   private frameMap?: FrameMap;
   private framesRange?: FramesRange;
+  private corruptedState = false;
+  private corruptedReason: string | undefined;
 
   static fromParser<T>(parser: Parser<T>): Trace<T> {
     return new Trace(
@@ -161,7 +180,9 @@ export class Trace<T> {
   setFrameInfo(frameMap: FrameMap, framesRange: FramesRange | undefined) {
     if (frameMap.lengthEntries !== this.fullTrace.lengthEntries) {
       throw new Error(
-        'Attemped to set a frame map with incompatible number of entries',
+        `Attempted to set a frame map for ${
+          TRACE_INFO[this.type].name
+        } trace with incompatible number of entries`,
       );
     }
     this.frameMap = frameMap;
@@ -446,11 +467,52 @@ export class Trace<T> {
     return this.framesRange;
   }
 
-  isDumpWithoutTimestamp() {
-    return (
-      this.lengthEntries === 1 &&
-      this.getEntry(0).getTimestamp().getValueNs() === INVALID_TIME_NS
-    );
+  isDump(): boolean {
+    return this.lengthEntries === 1;
+  }
+
+  isDumpWithoutTimestamp(): boolean {
+    return this.isDump() && !this.getEntry(0).hasValidTimestamp();
+  }
+
+  isCorrupted(): boolean {
+    return this.corruptedState;
+  }
+
+  getCorruptedReason(): string | undefined {
+    return this.corruptedReason;
+  }
+
+  setCorruptedState(value: boolean, reason?: string) {
+    this.corruptedState = value;
+    this.corruptedReason = reason;
+  }
+
+  spansMultipleDates(): boolean {
+    if (this.lengthEntries > 0) {
+      let firstTs: string | undefined;
+      let i = 0;
+      while (firstTs === undefined && i < this.lengthEntries) {
+        const entry = this.getEntry(i);
+        if (entry.hasValidTimestamp()) {
+          firstTs = entry.getTimestamp().format();
+          break;
+        }
+        i++;
+      }
+      const firstDate = TimestampUtils.extractDateFromHumanTimestamp(
+        assertDefined(firstTs),
+      );
+      if (firstDate) {
+        const lastDate = TimestampUtils.extractDateFromHumanTimestamp(
+          this.getEntry(this.lengthEntries - 1)
+            .getTimestamp()
+            .format(),
+        );
+        return firstDate !== lastDate;
+      }
+    }
+    return false;
   }
 
   private getEntryInternal<
@@ -471,7 +533,11 @@ export class Trace<T> {
       absoluteIndex >= this.entriesRange.end
     ) {
       throw new Error(
-        `Trace entry's index out of bounds. Input relative index: ${index}. Slice length: ${this.lengthEntries}.`,
+        `${
+          TRACE_INFO[this.type].name
+        } trace entry's index out of bounds. Input relative index: ${index}. Slice length: ${
+          this.lengthEntries
+        }.`,
       );
     }
     const timestamp = this.getFullTraceTimestamps()[absoluteIndex];
@@ -487,7 +553,11 @@ export class Trace<T> {
   private getFullTraceTimestamps(): Timestamp[] {
     const timestamps = this.parser.getTimestamps();
     if (!timestamps) {
-      throw new Error('Timestamps expected to be available');
+      throw new Error(
+        `Timestamps expected to be available for this ${
+          TRACE_INFO[this.type].name
+        } trace.`,
+      );
     }
     return timestamps;
   }
@@ -591,7 +661,9 @@ export class Trace<T> {
   private checkTraceCanBeAccessedInFrameDomain() {
     if (!this.frameMap) {
       throw new Error(
-        `Trace ${this.type} can't be accessed in frame domain (no frame mapping available)`,
+        `Trace ${
+          TRACE_INFO[this.type].name
+        } can't be accessed in frame domain (no frame mapping available)`,
       );
     }
   }
diff --git a/tools/winscope/src/trace/trace_info.ts b/tools/winscope/src/trace/trace_info.ts
index 12abf8872..91179e8dc 100644
--- a/tools/winscope/src/trace/trace_info.ts
+++ b/tools/winscope/src/trace/trace_info.ts
@@ -73,14 +73,14 @@ export const TRACE_INFO: TraceInfoMap = {
   [TraceType.TRANSACTIONS]: {
     name: 'Transactions',
     icon: TRANSACTION_ICON,
-    color: '#5BB974',
+    color: '#0D652D',
     downloadArchiveDir: 'sf',
     legacyExt: '.winscope',
   },
   [TraceType.TRANSACTIONS_LEGACY]: {
     name: 'Transactions Legacy',
     icon: TRANSACTION_ICON,
-    color: '#5BB974',
+    color: '#0D652D',
     downloadArchiveDir: 'sf',
     legacyExt: '.winscope',
   },
@@ -101,7 +101,7 @@ export const TRACE_INFO: TraceInfoMap = {
   [TraceType.PROTO_LOG]: {
     name: 'ProtoLog',
     icon: PROTO_LOG_ICON,
-    color: '#40A58A',
+    color: '#34A853',
     downloadArchiveDir: 'protolog',
     legacyExt: '.winscope',
   },
@@ -115,28 +115,28 @@ export const TRACE_INFO: TraceInfoMap = {
   [TraceType.VIEW_CAPTURE]: {
     name: 'View Capture',
     icon: VIEW_CAPTURE_ICON,
-    color: '#137333',
+    color: '#59CA77',
     downloadArchiveDir: 'vc',
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_METHOD_CLIENTS]: {
     name: 'IME Clients',
     icon: IME_ICON,
-    color: '#FA903E',
+    color: '#FF964B',
     downloadArchiveDir: 'ime',
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_METHOD_SERVICE]: {
     name: 'IME Service',
     icon: IME_ICON,
-    color: '#F29900',
+    color: '#FFC24B',
     downloadArchiveDir: 'ime',
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_METHOD_MANAGER_SERVICE]: {
     name: 'IME system_server',
     icon: IME_ICON,
-    color: '#D93025',
+    color: '#FF6B00',
     downloadArchiveDir: 'ime',
     legacyExt: '.winscope',
   },
@@ -150,42 +150,49 @@ export const TRACE_INFO: TraceInfoMap = {
   [TraceType.WM_TRANSITION]: {
     name: 'WM Transitions',
     icon: TRANSITION_ICON,
-    color: '#EC407A',
+    color: '#D01884',
     downloadArchiveDir: 'transition',
     legacyExt: '.winscope',
   },
   [TraceType.SHELL_TRANSITION]: {
     name: 'Shell Transitions',
     icon: TRANSITION_ICON,
-    color: '#EC407A',
+    color: '#D01884',
     downloadArchiveDir: 'transition',
     legacyExt: '.winscope',
   },
   [TraceType.TRANSITION]: {
     name: 'Transitions',
     icon: TRANSITION_ICON,
-    color: '#EC407A',
+    color: '#D01884',
     downloadArchiveDir: 'transition',
     legacyExt: '.winscope',
   },
   [TraceType.CUJS]: {
     name: 'Cujs',
     icon: CUJ_ICON,
-    color: '#EC407A',
+    color: '#FF63B8',
     downloadArchiveDir: 'eventlog',
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_MOTION_EVENT]: {
     name: 'Motion Events',
     icon: INPUT_ICON,
-    color: '#4079ec',
+    color: '#8baef4',
     downloadArchiveDir: 'input',
     legacyExt: '.winscope',
   },
   [TraceType.INPUT_KEY_EVENT]: {
     name: 'Key Events',
     icon: INPUT_ICON,
-    color: '#4079ec',
+    color: '#8baef4',
+    downloadArchiveDir: 'input',
+    legacyExt: '.winscope',
+  },
+  [TraceType.INPUT_EVENT_MERGED]: {
+    name: 'Input Events',
+    icon: INPUT_ICON,
+    color: '#8baef4',
     downloadArchiveDir: 'input',
     legacyExt: '.winscope',
   },
diff --git a/tools/winscope/src/trace/trace_rect.ts b/tools/winscope/src/trace/trace_rect.ts
index 04da2d01c..b1082089b 100644
--- a/tools/winscope/src/trace/trace_rect.ts
+++ b/tools/winscope/src/trace/trace_rect.ts
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-import {TransformMatrix} from 'common/geometry_types';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
+import {Region} from 'common/geometry/region';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 import {Item} from 'trace/item';
 
 export class TraceRect extends Rect implements Item {
@@ -31,9 +32,11 @@ export class TraceRect extends Rect implements Item {
     readonly groupId: number,
     readonly isVisible: boolean,
     readonly isDisplay: boolean,
-    readonly isVirtual: boolean,
+    readonly isActiveDisplay: boolean,
     readonly depth: number,
     readonly opacity: number | undefined,
+    readonly isSpy: boolean,
+    readonly fillRegion: Region | undefined,
   ) {
     super(x, y, w, h);
   }
diff --git a/tools/winscope/src/trace/trace_rect_builder.ts b/tools/winscope/src/trace/trace_rect_builder.ts
index 0a7cbd504..a56f5e7fe 100644
--- a/tools/winscope/src/trace/trace_rect_builder.ts
+++ b/tools/winscope/src/trace/trace_rect_builder.ts
@@ -14,7 +14,8 @@
  * limitations under the License.
  */
 
-import {TransformMatrix} from 'common/geometry_types';
+import {Region} from 'common/geometry/region';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 import {Transform} from 'parsers/surface_flinger/transform_utils';
 import {TraceRect} from './trace_rect';
 
@@ -30,9 +31,11 @@ export class TraceRectBuilder {
   groupId: number | undefined;
   isVisible: boolean | undefined;
   isDisplay: boolean | undefined;
-  isVirtual: boolean | undefined;
+  isActiveDisplay = false;
   depth: number | undefined;
   opacity: number | undefined;
+  isSpy: boolean | undefined;
+  fillRegion: Region | undefined;
 
   setX(value: number) {
     this.x = value;
@@ -89,8 +92,8 @@ export class TraceRectBuilder {
     return this;
   }
 
-  setIsVirtual(value: boolean) {
-    this.isVirtual = value;
+  setIsActiveDisplay(value: boolean) {
+    this.isActiveDisplay = value;
     return this;
   }
 
@@ -104,53 +107,63 @@ export class TraceRectBuilder {
     return this;
   }
 
+  setIsSpy(value: boolean) {
+    this.isSpy = value;
+    return this;
+  }
+
+  setFillRegion(region: Region | undefined) {
+    this.fillRegion = region;
+    return this;
+  }
+
   build(): TraceRect {
     if (this.x === undefined) {
-      throw Error('x not set');
+      throw new Error('x not set');
     }
 
     if (this.y === undefined) {
-      throw Error('y not set');
+      throw new Error('y not set');
     }
 
     if (this.w === undefined) {
-      throw Error('width not set');
+      throw new Error('width not set');
     }
 
     if (this.h === undefined) {
-      throw Error('height not set');
+      throw new Error('height not set');
     }
 
     if (this.id === undefined) {
-      throw Error('id not set');
+      throw new Error('id not set');
     }
 
     if (this.name === undefined) {
-      throw Error('name not set');
+      throw new Error('name not set');
     }
 
     if (this.cornerRadius === undefined) {
-      throw Error('cornerRadius not set');
+      throw new Error('cornerRadius not set');
     }
 
     if (this.groupId === undefined) {
-      throw Error('groupId not set');
+      throw new Error('groupId not set');
     }
 
     if (this.isVisible === undefined) {
-      throw Error('isVisible not set');
+      throw new Error('isVisible not set');
     }
 
     if (this.isDisplay === undefined) {
-      throw Error('isDisplay not set');
+      throw new Error('isDisplay not set');
     }
 
-    if (this.isVirtual === undefined) {
-      throw Error('isVirtual not set');
+    if (this.depth === undefined) {
+      throw new Error('depth not set');
     }
 
-    if (this.depth === undefined) {
-      throw Error('depth not set');
+    if (this.isSpy === undefined) {
+      throw new Error('isSpy not set');
     }
 
     return new TraceRect(
@@ -165,9 +178,11 @@ export class TraceRectBuilder {
       this.groupId,
       this.isVisible,
       this.isDisplay,
-      this.isVirtual,
+      this.isActiveDisplay,
       this.depth,
       this.opacity,
+      this.isSpy,
+      this.fillRegion,
     );
   }
 }
diff --git a/tools/winscope/src/trace/trace_test.ts b/tools/winscope/src/trace/trace_test.ts
index 94f8a1131..4deb6f162 100644
--- a/tools/winscope/src/trace/trace_test.ts
+++ b/tools/winscope/src/trace/trace_test.ts
@@ -14,6 +14,8 @@
  * limitations under the License.
  */
 
+import {TIME_UNIT_TO_NANO} from 'common/time_units';
+import {ParserBuilder} from 'test/unit/parser_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {TraceUtils} from 'test/unit/trace_utils';
@@ -1354,4 +1356,83 @@ describe('Trace', () => {
       );
     }
   });
+
+  it('isDump()', () => {
+    const trace = new TraceBuilder<string>()
+      .setEntries(['entry-0'])
+      .setTimestamps([time10])
+      .build();
+    expect(trace.isDump()).toBeTrue();
+    expect(trace.isDumpWithoutTimestamp()).toBeFalse();
+  });
+
+  it('isDumpWithoutTimestamp()', () => {
+    const trace = new TraceBuilder<string>()
+      .setEntries(['entry-0'])
+      .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
+      .build();
+    expect(trace.isDumpWithoutTimestamp()).toBeTrue();
+  });
+
+  it('updates corruptedState on failure to parse entry', async () => {
+    const trace = new TraceBuilder<string>()
+      .setParser(
+        new ParserBuilder<string>()
+          .setIsCorrupted(true)
+          .setEntries(['entry-0'])
+          .setTimestamps([TimestampConverterUtils.makeZeroTimestamp()])
+          .build(),
+      )
+      .build();
+    expect(trace.isCorrupted()).toBeFalse();
+    expect(trace.getCorruptedReason()).toBeUndefined();
+
+    expectAsync(trace.getEntry(0).getValue()).toBeRejected();
+    try {
+      await trace.getEntry(0).getValue();
+    } catch (e) {
+      expect(trace.isCorrupted()).toBeTrue();
+      expect(trace.getCorruptedReason()).toEqual(
+        'Cannot parse entry at index 0',
+      );
+    }
+  });
+
+  it('spansMultipleDates()', () => {
+    const emptyTrace = new TraceBuilder<string>()
+      .setEntries([])
+      .setTimestamps([])
+      .build();
+    expect(emptyTrace.spansMultipleDates()).toBeFalse();
+
+    const traceWithElapsedTimestamps = new TraceBuilder<string>()
+      .setEntries(['entry-0', 'entry-1'])
+      .setTimestamps([
+        TimestampConverterUtils.makeElapsedTimestamp(0n),
+        TimestampConverterUtils.makeElapsedTimestamp(
+          BigInt(TIME_UNIT_TO_NANO.d),
+        ),
+      ])
+      .build();
+    expect(traceWithElapsedTimestamps.spansMultipleDates()).toBeFalse();
+
+    const traceWithRealTimestampsOneDate = new TraceBuilder<string>()
+      .setEntries(['entry-0', 'entry-1'])
+      .setTimestamps([time10, time15])
+      .build();
+    expect(traceWithRealTimestampsOneDate.spansMultipleDates()).toBeFalse();
+
+    const traceWitMultipleDates = new TraceBuilder<string>()
+      .setEntries(['entry-0', 'entry-1'])
+      .setTimestamps([
+        TimestampConverterUtils.makeRealTimestamp(
+          BigInt(TIME_UNIT_TO_NANO.h * 23),
+        ),
+        TimestampConverterUtils.makeRealTimestamp(
+          BigInt(TIME_UNIT_TO_NANO.h * 25),
+        ),
+      ])
+      .build();
+    expect(traceWitMultipleDates.spansMultipleDates()).toBeTrue();
+  });
 });
diff --git a/tools/winscope/src/trace/trace_type.ts b/tools/winscope/src/trace/trace_type.ts
index 706ff8c9e..f28bea9fa 100644
--- a/tools/winscope/src/trace/trace_type.ts
+++ b/tools/winscope/src/trace/trace_type.ts
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-import {ScreenRecordingTraceEntry} from './screen_recording';
+import {MediaBasedTraceEntry} from './media_based_trace_entry';
 import {HierarchyTreeNode} from './tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from './tree_node/property_tree_node';
 
@@ -42,6 +42,7 @@ export enum TraceType {
   VIEW_CAPTURE,
   INPUT_MOTION_EVENT,
   INPUT_KEY_EVENT,
+  INPUT_EVENT_MERGED,
 }
 
 export type ImeTraceType =
@@ -52,8 +53,8 @@ export type ImeTraceType =
 export interface TraceEntryTypeMap {
   [TraceType.PROTO_LOG]: PropertyTreeNode;
   [TraceType.SURFACE_FLINGER]: HierarchyTreeNode;
-  [TraceType.SCREEN_RECORDING]: ScreenRecordingTraceEntry;
-  [TraceType.SCREENSHOT]: ScreenRecordingTraceEntry;
+  [TraceType.SCREEN_RECORDING]: MediaBasedTraceEntry;
+  [TraceType.SCREENSHOT]: MediaBasedTraceEntry;
   [TraceType.SYSTEM_UI]: object;
   [TraceType.TRANSACTIONS]: PropertyTreeNode;
   [TraceType.TRANSACTIONS_LEGACY]: object;
@@ -73,10 +74,12 @@ export interface TraceEntryTypeMap {
   [TraceType.VIEW_CAPTURE]: HierarchyTreeNode;
   [TraceType.INPUT_MOTION_EVENT]: PropertyTreeNode;
   [TraceType.INPUT_KEY_EVENT]: PropertyTreeNode;
+  [TraceType.INPUT_EVENT_MERGED]: PropertyTreeNode;
 }
 
 export class TraceTypeUtils {
   private static UI_PIPELINE_ORDER = [
+    TraceType.INPUT_EVENT_MERGED,
     TraceType.INPUT_METHOD_CLIENTS,
     TraceType.INPUT_METHOD_SERVICE,
     TraceType.INPUT_METHOD_MANAGER_SERVICE,
@@ -89,8 +92,10 @@ export class TraceTypeUtils {
 
   private static TRACES_WITH_VIEWERS_DISPLAY_ORDER = [
     TraceType.SCREEN_RECORDING,
+    TraceType.SCREENSHOT,
     TraceType.SURFACE_FLINGER,
     TraceType.WINDOW_MANAGER,
+    TraceType.INPUT_EVENT_MERGED,
     TraceType.INPUT_METHOD_CLIENTS,
     TraceType.INPUT_METHOD_MANAGER_SERVICE,
     TraceType.INPUT_METHOD_SERVICE,
@@ -99,6 +104,7 @@ export class TraceTypeUtils {
     TraceType.PROTO_LOG,
     TraceType.VIEW_CAPTURE,
     TraceType.TRANSITION,
+    TraceType.CUJS,
   ];
 
   static isTraceTypeWithViewer(t: TraceType): boolean {
@@ -129,27 +135,16 @@ export class TraceTypeUtils {
     return tIndex - uIndex;
   }
 
-  static canVisualizeTrace(t: TraceType): boolean {
-    return t !== TraceType.WM_TRANSITION && t !== TraceType.SHELL_TRANSITION;
-  }
-
-  static traceUploadInfo(t: TraceType): string | undefined {
-    switch (t) {
-      case TraceType.CUJS:
-        return 'Used to show CUJ boundaries in timeline';
-      default:
-        return undefined;
-    }
-  }
-
   static getReasonForNoTraceVisualization(t: TraceType): string {
     switch (t) {
       case TraceType.WM_TRANSITION:
-        return 'Must also upload a shell transitions trace to visualize transitions';
+        return 'Must also upload a shell transitions trace to visualize transitions.';
       case TraceType.SHELL_TRANSITION:
-        return 'Must also upload a wm transitions trace to visualize transitions';
+        return 'Must also upload a wm transitions trace to visualize transitions.';
+      case TraceType.EVENT_LOG:
+        return 'Uploaded file does not contain CUJs. Only CUJ visualization is supported in Winscope.';
       default:
-        return 'Visualization for this trace is not supported in Winscope';
+        return 'Visualization for this trace is not supported in Winscope.';
     }
   }
 
diff --git a/tools/winscope/src/trace/traces.ts b/tools/winscope/src/trace/traces.ts
index af7d74348..01cfd154d 100644
--- a/tools/winscope/src/trace/traces.ts
+++ b/tools/winscope/src/trace/traces.ts
@@ -61,15 +61,6 @@ export class Traces {
     this.traces.delete(trace);
   }
 
-  deleteTracesByType(type: TraceType) {
-    this.traces.forEach((trace) => {
-      if (trace.type !== type) {
-        return;
-      }
-      this.traces.delete(trace);
-    });
-  }
-
   hasTrace(trace: Trace<{}>) {
     return this.traces.has(trace);
   }
diff --git a/tools/winscope/src/trace/traces_test.ts b/tools/winscope/src/trace/traces_test.ts
index e172f6bb1..5611748b7 100644
--- a/tools/winscope/src/trace/traces_test.ts
+++ b/tools/winscope/src/trace/traces_test.ts
@@ -189,37 +189,6 @@ describe('Traces', () => {
     expect(TracesUtils.extractTraces(traces)).toEqual([]);
   });
 
-  it('deleteTracesByType()', () => {
-    const trace0 = new TraceBuilder<string>()
-      .setType(TraceType.TEST_TRACE_STRING)
-      .setEntries([])
-      .build();
-    const trace1 = new TraceBuilder<number>()
-      .setType(TraceType.TEST_TRACE_NUMBER)
-      .setEntries([])
-      .build();
-    const trace2 = new TraceBuilder<number>()
-      .setType(TraceType.TEST_TRACE_NUMBER)
-      .setEntries([])
-      .build();
-
-    const traces = new Traces();
-    traces.addTrace(trace0);
-    traces.addTrace(trace1);
-    traces.addTrace(trace2);
-
-    expect(TracesUtils.extractTraces(traces)).toEqual([trace0, trace1, trace2]);
-
-    traces.deleteTracesByType(TraceType.TEST_TRACE_NUMBER);
-    expect(TracesUtils.extractTraces(traces)).toEqual([trace0]);
-
-    traces.deleteTracesByType(TraceType.TEST_TRACE_STRING);
-    expect(TracesUtils.extractTraces(traces)).toEqual([]);
-
-    traces.deleteTracesByType(TraceType.TEST_TRACE_STRING);
-    expect(TracesUtils.extractTraces(traces)).toEqual([]);
-  });
-
   it('hasTrace()', () => {
     const trace0 = new TraceBuilder<string>()
       .setType(TraceType.TEST_TRACE_STRING)
diff --git a/tools/winscope/src/trace/tree_node/formatters.ts b/tools/winscope/src/trace/tree_node/formatters.ts
index 2e323f1da..c2ea01106 100644
--- a/tools/winscope/src/trace/tree_node/formatters.ts
+++ b/tools/winscope/src/trace/tree_node/formatters.ts
@@ -17,7 +17,8 @@
 import {Timestamp} from 'common/time';
 import {TimeDuration} from 'common/time_duration';
 import {RawDataUtils} from 'parsers/raw_data_utils';
-import {TransformUtils} from 'parsers/surface_flinger/transform_utils';
+import {TransformType} from 'parsers/surface_flinger/transform_utils';
+import {CujType} from 'trace/cuj_type';
 import {PropertyTreeNode} from './property_tree_node';
 
 const EMPTY_OBJ_STRING = '{empty}';
@@ -62,15 +63,17 @@ class ColorFormatter implements PropertyFormatter {
     const r = formatNumber(rNode?.getValue() ?? 0);
     const g = formatNumber(gNode?.getValue() ?? 0);
     const b = formatNumber(bNode?.getValue() ?? 0);
+    const rgbString = `(${r}, ${g}, ${b})`;
     if (rNode && gNode && bNode && !alphaNode) {
-      return `(${r}, ${g}, ${b})`;
+      return rgbString;
     }
 
     const alpha = formatNumber(alphaNode?.getValue() ?? 0);
+    const alphaString = `alpha: ${alpha}`;
     if (RawDataUtils.isEmptyObj(node)) {
-      return `${EMPTY_OBJ_STRING}, alpha: ${alpha}`;
+      return `${EMPTY_OBJ_STRING}, ${alphaString}`;
     }
-    return `(${r}, ${g}, ${b}, ${alpha})`;
+    return `${rgbString}, ${alphaString}`;
   }
 }
 const COLOR_FORMATTER = new ColorFormatter();
@@ -113,8 +116,8 @@ class MatrixFormatter implements PropertyFormatter {
   format(node: PropertyTreeNode): string {
     const dsdx = formatNumber(node.getChildByName('dsdx')?.getValue() ?? 0);
     const dtdx = formatNumber(node.getChildByName('dtdx')?.getValue() ?? 0);
-    const dsdy = formatNumber(node.getChildByName('dsdy')?.getValue() ?? 0);
     const dtdy = formatNumber(node.getChildByName('dtdy')?.getValue() ?? 0);
+    const dsdy = formatNumber(node.getChildByName('dsdy')?.getValue() ?? 0);
     const tx = node.getChildByName('tx');
     const ty = node.getChildByName('ty');
     if (
@@ -127,7 +130,7 @@ class MatrixFormatter implements PropertyFormatter {
     ) {
       return 'null';
     }
-    const matrix22 = `dsdx: ${dsdx}, dtdx: ${dtdx}, dsdy: ${dsdy}, dtdy: ${dtdy}`;
+    const matrix22 = `dsdx: ${dsdx}, dtdx: ${dtdx}, dtdy: ${dtdy}, dsdy: ${dsdy}`;
     if (!tx && !ty) {
       return matrix22;
     }
@@ -145,7 +148,7 @@ class TransformFormatter implements PropertyFormatter {
   format(node: PropertyTreeNode): string {
     const type = node.getChildByName('type');
     return type !== undefined
-      ? TransformUtils.getTypeFlags(type.getValue() ?? 0)
+      ? TransformType.getTypeFlags(type.getValue() ?? 0)
       : 'null';
   }
 }
@@ -221,6 +224,20 @@ class TimestampNodeFormatter implements PropertyFormatter {
 }
 const TIMESTAMP_NODE_FORMATTER = new TimestampNodeFormatter();
 
+class CujTypeFormatter implements PropertyFormatter {
+  format(node: PropertyTreeNode): string {
+    const cujTypeId: string = `${node.getValue()}`;
+    let cujTypeString: string | undefined;
+    if (cujTypeId in CujType) {
+      cujTypeString = CujType[cujTypeId as keyof typeof CujType];
+    } else {
+      cujTypeString = 'UNKNOWN';
+    }
+    return `${cujTypeString} (${cujTypeId})`;
+  }
+}
+const CUJ_TYPE_FORMATTER = new CujTypeFormatter();
+
 export {
   EMPTY_OBJ_STRING,
   EMPTY_ARRAY_STRING,
@@ -238,4 +255,5 @@ export {
   FixedStringFormatter,
   TIMESTAMP_NODE_FORMATTER,
   MATRIX_FORMATTER,
+  CUJ_TYPE_FORMATTER,
 };
diff --git a/tools/winscope/src/trace/tree_node/formatters_test.ts b/tools/winscope/src/trace/tree_node/formatters_test.ts
index 46279653f..84efd1bbc 100644
--- a/tools/winscope/src/trace/tree_node/formatters_test.ts
+++ b/tools/winscope/src/trace/tree_node/formatters_test.ts
@@ -15,13 +15,14 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {IDENTITY_MATRIX} from 'common/geometry_types';
-import {TransformType} from 'parsers/surface_flinger/transform_utils';
+import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {TransformTypeFlags} from 'parsers/surface_flinger/transform_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {
   BUFFER_FORMATTER,
   COLOR_FORMATTER,
+  CUJ_TYPE_FORMATTER,
   DEFAULT_PROPERTY_FORMATTER,
   EMPTY_ARRAY_STRING,
   EMPTY_OBJ_STRING,
@@ -100,10 +101,10 @@ describe('Formatters', () => {
     it('translates non-empty color to string correctly', () => {
       expect(
         COLOR_FORMATTER.format(TreeNodeUtils.makeColorNode(1, 2, 3, 1)),
-      ).toEqual('(1, 2, 3, 1)');
+      ).toEqual('(1, 2, 3), alpha: 1');
       expect(
         COLOR_FORMATTER.format(TreeNodeUtils.makeColorNode(1, 2, 3, 0.608)),
-      ).toEqual('(1, 2, 3, 0.608)');
+      ).toEqual('(1, 2, 3), alpha: 0.608');
     });
 
     it('translates rgb color without alpha to string correctly (transactions)', () => {
@@ -182,16 +183,16 @@ describe('Formatters', () => {
           TreeNodeUtils.makeMatrixNode(
             IDENTITY_MATRIX.dsdx,
             IDENTITY_MATRIX.dtdx,
-            IDENTITY_MATRIX.dsdy,
             IDENTITY_MATRIX.dtdy,
+            IDENTITY_MATRIX.dsdy,
           ),
         ),
-      ).toEqual('dsdx: 1, dtdx: 0, dsdy: 0, dtdy: 1');
+      ).toEqual('dsdx: 1, dtdx: 0, dtdy: 0, dsdy: 1');
       expect(
         MATRIX_FORMATTER.format(
           TreeNodeUtils.makeMatrixNode(0.4, 100, 1, 0.1232),
         ),
-      ).toEqual('dsdx: 0.400, dtdx: 100, dsdy: 1, dtdy: 0.123');
+      ).toEqual('dsdx: 0.400, dtdx: 100, dtdy: 1, dsdy: 0.123');
       expect(
         MATRIX_FORMATTER.format(TreeNodeUtils.makeMatrixNode(0, 0, 0, 0)),
       ).toEqual('null');
@@ -200,13 +201,13 @@ describe('Formatters', () => {
           TreeNodeUtils.makePropertyNode('test node', 'transform', {
             dsdx: 1,
             dtdx: 0,
-            dsdy: 0,
-            dtdy: 1,
             tx: 5,
+            dtdy: 0,
+            dsdy: 1,
             ty: 10,
           }),
         ),
-      ).toEqual('dsdx: 1, dtdx: 0, dsdy: 0, dtdy: 1, tx: 5, ty: 10');
+      ).toEqual('dsdx: 1, dtdx: 0, dtdy: 0, dsdy: 1, tx: 5, ty: 10');
     });
   });
 
@@ -214,37 +215,37 @@ describe('Formatters', () => {
     it('translates type correctly', () => {
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.EMPTY),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.EMPTY),
         ),
       ).toEqual('IDENTITY');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.TRANSLATE_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.TRANSLATE_VAL),
         ),
       ).toEqual('TRANSLATE');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.SCALE_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.SCALE_VAL),
         ),
       ).toEqual('SCALE');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.FLIP_H_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.FLIP_H_VAL),
         ),
       ).toEqual('IDENTITY|FLIP_H');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.FLIP_V_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.FLIP_V_VAL),
         ),
       ).toEqual('IDENTITY|FLIP_V');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.ROT_90_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.ROT_90_VAL),
         ),
       ).toEqual('IDENTITY|ROT_90');
       expect(
         TRANSFORM_FORMATTER.format(
-          TreeNodeUtils.makeTransformNode(TransformType.ROT_INVALID_VAL),
+          TreeNodeUtils.makeTransformNode(TransformTypeFlags.ROT_INVALID_VAL),
         ),
       ).toEqual('IDENTITY|ROT_INVALID');
     });
@@ -285,4 +286,28 @@ describe('Formatters', () => {
       );
     });
   });
+
+  describe('CujTypeFormatter', () => {
+    it('translates known cuj type correctly', () => {
+      const cujType = new PropertyTreeBuilder()
+        .setRootId('test node')
+        .setName('cujType')
+        .setValue(66)
+        .build();
+
+      expect(CUJ_TYPE_FORMATTER.format(cujType)).toEqual(
+        'CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS (66)',
+      );
+    });
+
+    it('translates unknown cuj type correctly', () => {
+      const cujType = new PropertyTreeBuilder()
+        .setRootId('test node')
+        .setName('cujType')
+        .setValue(-1)
+        .build();
+
+      expect(CUJ_TYPE_FORMATTER.format(cujType)).toEqual('UNKNOWN (-1)');
+    });
+  });
 });
diff --git a/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts b/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
index 95ba8b539..0aa2daa39 100644
--- a/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
+++ b/tools/winscope/src/trace/tree_node/hierarchy_tree_node.ts
@@ -21,6 +21,7 @@ import {TreeNode} from './tree_node';
 
 export class HierarchyTreeNode extends TreeNode {
   private rects: TraceRect[] | undefined;
+  private secondaryRects: TraceRect[] | undefined;
   private zParent: HierarchyTreeNode | undefined;
   private parent: this | undefined;
 
@@ -52,6 +53,14 @@ export class HierarchyTreeNode extends TreeNode {
     return this.rects;
   }
 
+  setSecondaryRects(value: TraceRect[]) {
+    this.secondaryRects = value;
+  }
+
+  getSecondaryRects(): TraceRect[] | undefined {
+    return this.secondaryRects;
+  }
+
   setZParent(parent: HierarchyTreeNode): void {
     this.zParent = parent;
   }
diff --git a/tools/winscope/src/trace/tree_node/property_tree_builder_from_proto.ts b/tools/winscope/src/trace/tree_node/property_tree_builder_from_proto.ts
index 4d4dabde8..7628b763e 100644
--- a/tools/winscope/src/trace/tree_node/property_tree_builder_from_proto.ts
+++ b/tools/winscope/src/trace/tree_node/property_tree_builder_from_proto.ts
@@ -57,13 +57,13 @@ export class PropertyTreeBuilderFromProto {
 
   build(): PropertyTreeNode {
     if (this.proto === undefined) {
-      throw Error('proto not set');
+      throw new Error('proto not set');
     }
     if (this.rootId === undefined) {
-      throw Error('rootId not set');
+      throw new Error('rootId not set');
     }
     if (this.rootName === undefined) {
-      throw Error('rootName not set');
+      throw new Error('rootName not set');
     }
     const factory = new PropertyTreeNodeFactory(
       this.denylistProperties,
diff --git a/tools/winscope/src/trace_collection/adb_connection.ts b/tools/winscope/src/trace_collection/adb_connection.ts
new file mode 100644
index 000000000..37c6fa4e5
--- /dev/null
+++ b/tools/winscope/src/trace_collection/adb_connection.ts
@@ -0,0 +1,100 @@
+/*
+ * Copyright 2022, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertUnreachable} from 'common/assert_utils';
+import {HttpRequestStatus, HttpResponse} from 'common/http_request';
+import {AdbDevice} from './adb_device';
+import {ConnectionState} from './connection_state';
+import {TraceRequest} from './trace_request';
+
+export abstract class AdbConnection {
+  abstract initialize(
+    detectStateChangeInUi: () => Promise<void>,
+    availableTracesChangeCallback: (traces: string[]) => void,
+    devicesChangeCallback: (devices: AdbDevice[]) => void,
+  ): Promise<void>;
+  abstract restartConnection(): Promise<void>;
+  abstract setSecurityToken(token: string): void;
+  abstract getDevices(): AdbDevice[];
+  abstract getState(): ConnectionState;
+  abstract getErrorText(): string;
+  abstract startTrace(
+    device: AdbDevice,
+    requestedTraces: TraceRequest[],
+  ): Promise<void>;
+  abstract endTrace(device: AdbDevice): Promise<void>;
+  abstract dumpState(
+    device: AdbDevice,
+    requestedDumps: TraceRequest[],
+  ): Promise<void>;
+  abstract fetchLastTracingSessionData(device: AdbDevice): Promise<File[]>;
+  abstract onDestroy(): void;
+
+  protected async processHttpResponse(
+    resp: HttpResponse,
+    onSuccess: OnRequestSuccessCallback,
+  ): Promise<AdbResponse | undefined> {
+    let newState: ConnectionState | undefined;
+    let errorMsg: string | undefined;
+
+    switch (resp.status) {
+      case HttpRequestStatus.UNSENT:
+        newState = ConnectionState.NOT_FOUND;
+        break;
+
+      case HttpRequestStatus.UNAUTH:
+        newState = ConnectionState.UNAUTH;
+        break;
+
+      case HttpRequestStatus.SUCCESS:
+        try {
+          await onSuccess(resp);
+        } catch (err) {
+          newState = ConnectionState.ERROR;
+          errorMsg =
+            `Error handling request response:\n${err}\n\n` +
+            `Request:\n ${resp.text}`;
+        }
+        break;
+
+      case HttpRequestStatus.ERROR:
+        if (resp.type === 'text' || !resp.type) {
+          errorMsg = resp.text;
+        } else if (resp.type === 'arraybuffer') {
+          errorMsg = String.fromCharCode.apply(null, new Array(resp.body));
+          if (errorMsg === '\x00') {
+            errorMsg = 'No data received.';
+          }
+        }
+        newState = ConnectionState.ERROR;
+        break;
+
+      default:
+        assertUnreachable(resp.status);
+    }
+
+    return newState !== undefined ? {newState, errorMsg} : undefined;
+  }
+}
+
+interface AdbResponse {
+  newState: ConnectionState;
+  errorMsg: string | undefined;
+}
+
+export type OnRequestSuccessCallback = (
+  resp: HttpResponse,
+) => void | Promise<void>;
diff --git a/tools/winscope/src/trace_collection/on_request_success_callback.ts b/tools/winscope/src/trace_collection/adb_device.ts
similarity index 79%
rename from tools/winscope/src/trace_collection/on_request_success_callback.ts
rename to tools/winscope/src/trace_collection/adb_device.ts
index db36218f4..9d9151b4b 100644
--- a/tools/winscope/src/trace_collection/on_request_success_callback.ts
+++ b/tools/winscope/src/trace_collection/adb_device.ts
@@ -14,6 +14,10 @@
  * limitations under the License.
  */
 
-export type OnRequestSuccessCallback = (
-  request: XMLHttpRequest,
-) => void | Promise<void>;
+export interface AdbDevice {
+  id: string;
+  authorized: boolean;
+  model: string;
+  displays: string[];
+  multiDisplayScreenRecordingAvailable: boolean;
+}
diff --git a/tools/winscope/src/common/geometry_types.ts b/tools/winscope/src/trace_collection/adb_files.ts
similarity index 63%
rename from tools/winscope/src/common/geometry_types.ts
rename to tools/winscope/src/trace_collection/adb_files.ts
index 4860e1f0d..198ce4c71 100644
--- a/tools/winscope/src/common/geometry_types.ts
+++ b/tools/winscope/src/trace_collection/adb_files.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2023 The Android Open Source Project
+ * Copyright (C) 2024 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,25 +14,14 @@
  * limitations under the License.
  */
 
-export interface Point {
-  x: number;
-  y: number;
-}
+import {TraceType} from 'trace/trace_type';
 
-export interface TransformMatrix {
-  dsdx: number;
-  dtdx: number;
-  tx: number;
-  dsdy: number;
-  dtdy: number;
-  ty: number;
+export interface AdbFiles {
+  requested: RequestedTraceTypes[];
+  collected: File[];
 }
 
-export const IDENTITY_MATRIX = {
-  dsdx: 1,
-  dtdx: 0,
-  tx: 0,
-  dsdy: 0,
-  dtdy: 1,
-  ty: 0,
-};
+export interface RequestedTraceTypes {
+  name: string;
+  types: TraceType[];
+}
diff --git a/tools/winscope/src/trace_collection/connection.ts b/tools/winscope/src/trace_collection/connection.ts
deleted file mode 100644
index 220813fd0..000000000
--- a/tools/winscope/src/trace_collection/connection.ts
+++ /dev/null
@@ -1,52 +0,0 @@
-/*
- * Copyright 2022, The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-import {
-  Device,
-  DeviceProperties,
-  ProxyClient,
-} from 'trace_collection/proxy_client';
-import {ConfigMap} from './trace_collection_utils';
-
-export interface Connection {
-  adbSuccess: () => boolean;
-  setProxyKey?(key: string): any;
-  devices(): Device;
-  selectedDevice(): DeviceProperties;
-  selectedDeviceId(): string;
-  restart(): any;
-  selectDevice(id: string): any;
-  state(): any;
-  onConnectChange(newState: any): any;
-  resetLastDevice(): any;
-  isDevicesState(): boolean;
-  isStartTraceState(): boolean;
-  isErrorState(): boolean;
-  isStartingTraceState(): boolean;
-  isEndTraceState(): boolean;
-  isLoadDataState(): boolean;
-  isConnectingState(): boolean;
-  throwNoTargetsError(): any;
-  startTrace(
-    requestedTraces: string[],
-    reqEnableConfig?: string[],
-    reqSelectedSfConfig?: ConfigMap,
-    reqSelectedWmConfig?: ConfigMap,
-  ): any;
-  endTrace(): any;
-  adbData(): File[];
-  dumpState(requestedDumps: string[]): any;
-  proxy?: ProxyClient;
-}
diff --git a/tools/winscope/src/trace_collection/connection_state.ts b/tools/winscope/src/trace_collection/connection_state.ts
new file mode 100644
index 000000000..14e9495bc
--- /dev/null
+++ b/tools/winscope/src/trace_collection/connection_state.ts
@@ -0,0 +1,30 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export enum ConnectionState {
+  ERROR,
+  CONNECTING,
+  NOT_FOUND,
+  INVALID_VERSION,
+  UNAUTH,
+  IDLE,
+  STARTING_TRACE,
+  TRACING,
+  ENDING_TRACE,
+  DUMPING_STATE,
+  LOADING_DATA,
+  TRACE_TIMEOUT,
+}
diff --git a/tools/winscope/src/trace_collection/proxy_client.ts b/tools/winscope/src/trace_collection/proxy_client.ts
deleted file mode 100644
index 2aed8c78f..000000000
--- a/tools/winscope/src/trace_collection/proxy_client.ts
+++ /dev/null
@@ -1,401 +0,0 @@
-/*
- * Copyright 2022, The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {OnProgressUpdateType} from 'common/function_utils';
-import {PersistentStore} from 'common/persistent_store';
-import {OnRequestSuccessCallback} from './on_request_success_callback';
-import {ConfigMap} from './trace_collection_utils';
-
-export interface Device {
-  [key: string]: DeviceProperties;
-}
-
-export interface DeviceProperties {
-  authorised: boolean;
-  model: string;
-}
-
-export enum ProxyState {
-  ERROR,
-  CONNECTING,
-  NO_PROXY,
-  INVALID_VERSION,
-  UNAUTH,
-  DEVICES,
-  START_TRACE,
-  END_TRACE,
-  LOAD_DATA,
-  STARTING_TRACE,
-}
-
-export enum ProxyEndpoint {
-  DEVICES = '/devices/',
-  START_TRACE = '/start/',
-  END_TRACE = '/end/',
-  ENABLE_CONFIG_TRACE = '/configtrace/',
-  SELECTED_WM_CONFIG_TRACE = '/selectedwmconfigtrace/',
-  SELECTED_SF_CONFIG_TRACE = '/selectedsfconfigtrace/',
-  DUMP = '/dump/',
-  FETCH = '/fetch/',
-  STATUS = '/status/',
-  CHECK_WAYLAND = '/checkwayland/',
-}
-
-// from here, all requests to the proxy are made
-class ProxyRequest {
-  // List of trace we are actively tracing
-  private tracingTraces: string[] | undefined;
-
-  async call(
-    method: string,
-    path: string,
-    onSuccess: OnRequestSuccessCallback | undefined,
-    type?: XMLHttpRequest['responseType'],
-    jsonRequest?: object,
-  ): Promise<void> {
-    return new Promise((resolve) => {
-      const request = new XMLHttpRequest();
-      const client = proxyClient;
-      request.onreadystatechange = async function () {
-        if (this.readyState !== XMLHttpRequest.DONE) {
-          return;
-        }
-        if (this.status === XMLHttpRequest.UNSENT) {
-          client.setState(ProxyState.NO_PROXY);
-          resolve();
-        } else if (this.status === 200) {
-          if (
-            !client.areVersionsCompatible(
-              this.getResponseHeader('Winscope-Proxy-Version'),
-            )
-          ) {
-            client.setState(ProxyState.INVALID_VERSION);
-            resolve();
-          } else if (onSuccess) {
-            try {
-              await onSuccess(this);
-            } catch (err) {
-              console.error(err);
-              proxyClient.setState(
-                ProxyState.ERROR,
-                `Error handling request response:\n${err}\n\n` +
-                  `Request:\n ${request.responseText}`,
-              );
-              resolve();
-            }
-          }
-          resolve();
-        } else if (this.status === 403) {
-          client.setState(ProxyState.UNAUTH);
-          resolve();
-        } else {
-          if (this.responseType === 'text' || !this.responseType) {
-            client.errorText = this.responseText;
-          } else if (this.responseType === 'arraybuffer') {
-            client.errorText = String.fromCharCode.apply(
-              null,
-              new Array(this.response),
-            );
-          }
-          client.setState(ProxyState.ERROR, client.errorText);
-          resolve();
-        }
-      };
-      request.responseType = type || '';
-      request.open(method, client.WINSCOPE_PROXY_URL + path);
-      const lastKey = client.store.get('adb.proxyKey');
-      if (lastKey !== undefined) {
-        client.proxyKey = lastKey;
-      }
-      request.setRequestHeader('Winscope-Token', client.proxyKey);
-      if (jsonRequest) {
-        const json = JSON.stringify(jsonRequest);
-        request.setRequestHeader(
-          'Content-Type',
-          'application/json;charset=UTF-8',
-        );
-        request.send(json);
-      } else {
-        request.send();
-      }
-    });
-  }
-
-  async getDevices() {
-    await proxyRequest.call(
-      'GET',
-      ProxyEndpoint.DEVICES,
-      proxyRequest.onSuccessGetDevices,
-    );
-  }
-
-  async setEnabledConfig(view: ProxyClient, req: string[]) {
-    await proxyRequest.call(
-      'POST',
-      `${ProxyEndpoint.ENABLE_CONFIG_TRACE}${view.selectedDevice}/`,
-      undefined,
-      undefined,
-      req,
-    );
-  }
-
-  async setSelectedConfig(
-    endpoint: ProxyEndpoint,
-    view: ProxyClient,
-    req: ConfigMap,
-  ) {
-    await proxyRequest.call(
-      'POST',
-      `${endpoint}${view.selectedDevice}/`,
-      undefined,
-      undefined,
-      req,
-    );
-  }
-
-  async startTrace(
-    view: ProxyClient,
-    requestedTraces: string[],
-    onSuccessStartTrace: OnRequestSuccessCallback,
-  ) {
-    this.tracingTraces = requestedTraces;
-    await proxyRequest.call(
-      'POST',
-      `${ProxyEndpoint.START_TRACE}${view.selectedDevice}/`,
-      onSuccessStartTrace,
-      undefined,
-      requestedTraces,
-    );
-  }
-
-  async endTrace(
-    view: ProxyClient,
-    progressCallback: OnProgressUpdateType,
-  ): Promise<void> {
-    const requestedTraces = this.tracingTraces;
-    this.tracingTraces = undefined;
-    if (requestedTraces === undefined) {
-      throw Error('Trace not started before stopping');
-    }
-    await proxyRequest.call(
-      'POST',
-      `${ProxyEndpoint.END_TRACE}${view.selectedDevice}/`,
-      async (request: XMLHttpRequest) => {
-        await proxyClient.updateAdbData(
-          requestedTraces,
-          'trace',
-          progressCallback,
-        );
-      },
-    );
-  }
-
-  async keepTraceAlive(
-    view: ProxyClient,
-    onSuccessKeepTraceAlive: OnRequestSuccessCallback,
-  ) {
-    await proxyRequest.call(
-      'GET',
-      `${ProxyEndpoint.STATUS}${view.selectedDevice}/`,
-      onSuccessKeepTraceAlive,
-    );
-  }
-
-  async dumpState(
-    view: ProxyClient,
-    requestedDumps: string[],
-    progressCallback: OnProgressUpdateType,
-  ) {
-    await proxyRequest.call(
-      'POST',
-      `${ProxyEndpoint.DUMP}${view.selectedDevice}/`,
-      async (request: XMLHttpRequest) => {
-        await proxyClient.updateAdbData(
-          requestedDumps,
-          'dump',
-          progressCallback,
-        );
-      },
-      undefined,
-      requestedDumps,
-    );
-  }
-
-  async fetchFiles(dev: string, adbParams: AdbParams): Promise<void> {
-    const files = adbParams.files;
-    const idx = adbParams.idx;
-
-    await proxyRequest.call(
-      'GET',
-      `${ProxyEndpoint.FETCH}${dev}/${files[idx]}/`,
-      this.onSuccessFetchFiles,
-      'arraybuffer',
-    );
-  }
-
-  private onSuccessFetchFiles: OnRequestSuccessCallback = async (
-    request: XMLHttpRequest,
-  ) => {
-    try {
-      const enc = new TextDecoder('utf-8');
-      const resp = enc.decode(request.response);
-      const filesByType = JSON.parse(resp);
-
-      for (const filetype of Object.keys(filesByType)) {
-        const files = filesByType[filetype];
-        for (const encodedFileBuffer of files) {
-          const buffer = Uint8Array.from(atob(encodedFileBuffer), (c) =>
-            c.charCodeAt(0),
-          );
-          const blob = new Blob([buffer]);
-          const newFile = new File([blob], filetype);
-          proxyClient.adbData.push(newFile);
-        }
-      }
-    } catch (error) {
-      proxyClient.setState(ProxyState.ERROR, request.responseText);
-      throw error;
-    }
-  };
-
-  private onSuccessGetDevices: OnRequestSuccessCallback = async (
-    request: XMLHttpRequest,
-  ) => {
-    const client = proxyClient;
-    try {
-      client.devices = JSON.parse(request.responseText);
-      const last = client.store.get('adb.lastDevice');
-      if (last && client.devices[last] && client.devices[last].authorised) {
-        await client.selectDevice(last);
-      } else {
-        client.setState(ProxyState.DEVICES);
-      }
-      if (client.refresh_worker === undefined) {
-        client.refresh_worker = setInterval(client.getDevices, 1000);
-      }
-    } catch (err) {
-      console.error(err);
-      client.errorText = request.responseText;
-      client.setState(ProxyState.ERROR, client.errorText);
-    }
-  };
-}
-export const proxyRequest = new ProxyRequest();
-
-interface AdbParams {
-  files: string[];
-  idx: number;
-  traceType: string;
-}
-
-// stores all the changing variables from proxy and sets up calls from ProxyRequest
-export class ProxyClient {
-  readonly WINSCOPE_PROXY_URL = 'http://localhost:5544';
-  readonly VERSION = '2.1.1';
-  state: ProxyState = ProxyState.CONNECTING;
-  stateChangeListeners: Array<{
-    (param: ProxyState, errorText: string): Promise<void>;
-  }> = [];
-  refresh_worker: NodeJS.Timeout | undefined;
-  devices: Device = {};
-  selectedDevice = '';
-  errorText = '';
-  adbData: File[] = [];
-  proxyKey = '';
-  lastDevice = '';
-  store = new PersistentStore();
-
-  async setState(state: ProxyState, errorText = '') {
-    this.state = state;
-    this.errorText = errorText;
-    for (const listener of this.stateChangeListeners) {
-      await listener(state, errorText);
-    }
-  }
-
-  onProxyChange(fn: (state: ProxyState, errorText: string) => Promise<void>) {
-    this.removeOnProxyChange(fn);
-    this.stateChangeListeners.push(fn);
-  }
-
-  removeOnProxyChange(
-    removeFn: (state: ProxyState, errorText: string) => Promise<void>,
-  ) {
-    this.stateChangeListeners = this.stateChangeListeners.filter(
-      (fn) => fn !== removeFn,
-    );
-  }
-
-  async getDevices() {
-    if (
-      proxyClient.state !== ProxyState.DEVICES &&
-      proxyClient.state !== ProxyState.CONNECTING &&
-      proxyClient.state !== ProxyState.START_TRACE
-    ) {
-      if (proxyClient.refresh_worker !== undefined) {
-        clearInterval(proxyClient.refresh_worker);
-        proxyClient.refresh_worker = undefined;
-      }
-      return;
-    }
-    proxyRequest.getDevices();
-  }
-
-  async selectDevice(device_id: string) {
-    this.selectedDevice = device_id;
-    this.store.add('adb.lastDevice', device_id);
-    this.setState(ProxyState.START_TRACE);
-  }
-
-  async updateAdbData(
-    files: string[],
-    traceType: string,
-    progressCallback: OnProgressUpdateType,
-  ) {
-    for (let idx = 0; idx < files.length; idx++) {
-      const adbParams = {
-        files,
-        idx,
-        traceType,
-      };
-      await proxyRequest.fetchFiles(this.selectedDevice, adbParams);
-      progressCallback((100 * (idx + 1)) / files.length);
-    }
-  }
-
-  areVersionsCompatible(proxyVersion: string | null): boolean {
-    if (!proxyVersion) return false;
-    const [proxyMajor, proxyMinor, proxyPatch] = proxyVersion
-      .split('.')
-      .map((s) => Number(s));
-    const [clientMajor, clientMinor, clientPatch] = this.VERSION.split('.').map(
-      (s) => Number(s),
-    );
-
-    if (proxyMajor !== clientMajor) {
-      return false;
-    }
-
-    if (proxyMinor === clientMinor) {
-      // Check patch number to ensure user has deployed latest bug fixes
-      return proxyPatch >= clientPatch;
-    }
-
-    return proxyMinor > clientMinor;
-  }
-}
-
-export const proxyClient = new ProxyClient();
diff --git a/tools/winscope/src/trace_collection/proxy_connection.ts b/tools/winscope/src/trace_collection/proxy_connection.ts
index 58879c625..aab3e6d4a 100644
--- a/tools/winscope/src/trace_collection/proxy_connection.ts
+++ b/tools/winscope/src/trace_collection/proxy_connection.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright 2022, The Android Open Source Project
+ * Copyright 2024, The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -15,222 +15,478 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {FunctionUtils, OnProgressUpdateType} from 'common/function_utils';
-import {TimeUtils} from 'common/time_utils';
-import {
-  DeviceProperties,
-  proxyClient,
-  ProxyEndpoint,
-  proxyRequest,
-  ProxyState,
-} from 'trace_collection/proxy_client';
-import {Connection} from './connection';
+import {FunctionUtils} from 'common/function_utils';
 import {
-  ConfigMap,
-  TraceConfigurationMap,
-  TRACES,
-} from './trace_collection_utils';
-
-export class ProxyConnection implements Connection {
-  proxy = proxyClient;
-  keep_alive_worker: NodeJS.Timeout | undefined;
-  notConnected = [
-    ProxyState.NO_PROXY,
-    ProxyState.UNAUTH,
-    ProxyState.INVALID_VERSION,
-  ];
-
-  constructor(
-    private proxyStateChangeCallback: (state: ProxyState) => void,
-    private progressCallback: OnProgressUpdateType = FunctionUtils.DO_NOTHING,
-    private traceConfigChangeCallback: (
-      availableTracesConfig: TraceConfigurationMap,
-    ) => void,
-  ) {
-    this.proxy.setState(ProxyState.CONNECTING);
-    this.proxy.onProxyChange(
-      async (newState) => await this.onConnectChange(newState),
-    );
+  HttpRequest,
+  HttpRequestHeaderType,
+  HttpRequestStatus,
+  HttpResponse,
+} from 'common/http_request';
+import {PersistentStore} from 'common/persistent_store';
+import {TimeUtils} from 'common/time_utils';
+import {UserNotifier} from 'common/user_notifier';
+import {Analytics} from 'logging/analytics';
+import {ProxyTracingErrors} from 'messaging/user_warnings';
+import {AdbConnection, OnRequestSuccessCallback} from './adb_connection';
+import {AdbDevice} from './adb_device';
+import {ConnectionState} from './connection_state';
+import {ProxyEndpoint} from './proxy_endpoint';
+import {TraceRequest} from './trace_request';
+
+export class ProxyConnection extends AdbConnection {
+  static readonly VERSION = '4.0.0';
+  static readonly WINSCOPE_PROXY_URL = 'http://localhost:5544';
+
+  private static readonly MULTI_DISPLAY_SCREENRECORD_VERSION = '1.4';
+
+  private readonly store = new PersistentStore();
+  private readonly storeKeySecurityToken = 'adb.proxyKey';
+
+  private state: ConnectionState = ConnectionState.CONNECTING;
+  private errorText = '';
+  private securityToken = '';
+  private devices: AdbDevice[] = [];
+  selectedDevice: AdbDevice | undefined;
+  private requestedTraces: TraceRequest[] = [];
+  private adbData: File[] = [];
+  private keepTraceAliveWorker: number | undefined;
+  private refreshDevicesWorker: number | undefined;
+  private detectStateChangeInUi: () => Promise<void> =
+    FunctionUtils.DO_NOTHING_ASYNC;
+  private availableTracesChangeCallback: (traces: string[]) => void =
+    FunctionUtils.DO_NOTHING;
+  private devicesChangeCallback: (devices: AdbDevice[]) => void =
+    FunctionUtils.DO_NOTHING;
+
+  async initialize(
+    detectStateChangeInUi: () => Promise<void>,
+    availableTracesChangeCallback: (traces: string[]) => void,
+    devicesChangeCallback: (devices: AdbDevice[]) => void,
+  ): Promise<void> {
+    this.detectStateChangeInUi = detectStateChangeInUi;
+    this.availableTracesChangeCallback = availableTracesChangeCallback;
+    this.devicesChangeCallback = devicesChangeCallback;
+
     const urlParams = new URLSearchParams(window.location.search);
     if (urlParams.has('token')) {
-      this.proxy.proxyKey = assertDefined(urlParams.get('token'));
-    } else if (this.proxy.store.get('adb.proxyKey')) {
-      this.proxy.proxyKey = assertDefined(this.proxy.store.get('adb.proxyKey'));
+      this.securityToken = assertDefined(urlParams.get('token'));
+    } else {
+      this.securityToken = this.store.get(this.storeKeySecurityToken) ?? '';
     }
-    this.proxy.getDevices();
+    await this.setState(ConnectionState.CONNECTING);
   }
 
-  devices() {
-    return this.proxy.devices;
+  async restartConnection(): Promise<void> {
+    await this.setState(ConnectionState.CONNECTING);
   }
 
-  adbData() {
-    return this.proxy.adbData;
+  setSecurityToken(token: string) {
+    if (token.length > 0) {
+      this.securityToken = token;
+      this.store.add(this.storeKeySecurityToken, token);
+    }
   }
 
-  state() {
-    return this.proxy.state;
+  getDevices(): AdbDevice[] {
+    return this.devices;
   }
 
-  isDevicesState() {
-    return this.state() === ProxyState.DEVICES;
+  getState(): ConnectionState {
+    return this.state;
   }
 
-  isStartTraceState() {
-    return this.state() === ProxyState.START_TRACE;
+  getErrorText(): string {
+    return this.errorText;
   }
 
-  isErrorState() {
-    return this.state() === ProxyState.ERROR;
+  onDestroy() {
+    window.clearInterval(this.refreshDevicesWorker);
+    this.refreshDevicesWorker = undefined;
+    window.clearInterval(this.keepTraceAliveWorker);
+    this.keepTraceAliveWorker = undefined;
   }
 
-  isStartingTraceState() {
-    return this.state() === ProxyState.STARTING_TRACE;
+  async startTrace(
+    device: AdbDevice,
+    requestedTraces: TraceRequest[],
+  ): Promise<void> {
+    if (requestedTraces.length === 0) {
+      throw new Error('No traces requested');
+    }
+    this.updateMediaBasedConfig(requestedTraces);
+    this.selectedDevice = device;
+    this.requestedTraces = requestedTraces;
+    await this.setState(ConnectionState.STARTING_TRACE);
   }
 
-  isEndTraceState() {
-    return this.state() === ProxyState.END_TRACE;
+  async endTrace() {
+    if (this.requestedTraces.length === 0) {
+      throw new Error('Trace not started before stopping');
+    }
+    await this.setState(ConnectionState.ENDING_TRACE);
+    this.requestedTraces = [];
   }
 
-  isLoadDataState() {
-    return this.state() === ProxyState.LOAD_DATA;
+  async dumpState(
+    device: AdbDevice,
+    requestedDumps: TraceRequest[],
+  ): Promise<void> {
+    if (requestedDumps.length === 0) {
+      throw new Error('No dumps requested');
+    }
+    this.selectedDevice = device;
+    this.updateMediaBasedConfig(requestedDumps);
+    this.requestedTraces = requestedDumps;
+    await this.setState(ConnectionState.DUMPING_STATE);
   }
 
-  isConnectingState() {
-    return this.state() === ProxyState.CONNECTING;
+  private updateMediaBasedConfig(requestedConfig: TraceRequest[]) {
+    requestedConfig.forEach((req) => {
+      const displayConfig = req.config.find((c) => c.key === 'displays');
+      if (displayConfig?.value) {
+        if (Array.isArray(displayConfig.value)) {
+          displayConfig.value = displayConfig.value.map((display) => {
+            if (display[0] === '"') {
+              return display.split('"')[2].trim();
+            }
+            return display;
+          });
+        } else {
+          if (displayConfig.value[0] === '"') {
+            displayConfig.value = displayConfig.value.split('"')[2].trim();
+          }
+        }
+      }
+    });
   }
 
-  throwNoTargetsError() {
-    this.proxy.setState(ProxyState.ERROR, 'No targets selected');
+  async fetchLastTracingSessionData(device: AdbDevice): Promise<File[]> {
+    this.adbData = [];
+    this.selectedDevice = device;
+    await this.setState(ConnectionState.LOADING_DATA);
+    this.selectedDevice = undefined;
+    return this.adbData;
   }
 
-  setProxyKey(key: string) {
-    this.proxy.proxyKey = key;
-    this.proxy.store.add('adb.proxyKey', key);
+  private async updateAdbData(device: AdbDevice) {
+    await this.getFromProxy(
+      `${ProxyEndpoint.FETCH}${device.id}/`,
+      this.onSuccessFetchFiles,
+      'arraybuffer',
+    );
+    if (this.adbData.length === 0) {
+      Analytics.Proxy.logNoFilesFound();
+    }
   }
 
-  adbSuccess() {
-    return !this.notConnected.includes(this.proxy.state);
-  }
+  private async onConnectionStateChange(newState: ConnectionState) {
+    await this.detectStateChangeInUi();
 
-  selectedDevice(): DeviceProperties {
-    return this.proxy.devices[this.proxy.selectedDevice];
-  }
+    switch (newState) {
+      case ConnectionState.ERROR:
+        Analytics.Error.logProxyError(this.errorText);
+        return;
 
-  selectedDeviceId(): string {
-    return this.proxy.selectedDevice;
-  }
+      case ConnectionState.CONNECTING:
+        await this.requestDevices();
+        return;
+
+      case ConnectionState.IDLE:
+        {
+          const isWaylandAvailable = await this.isWaylandAvailable();
+          if (isWaylandAvailable) {
+            this.availableTracesChangeCallback(['wayland_trace']);
+          }
+        }
+        return;
 
-  restart() {
-    this.proxy.setState(ProxyState.CONNECTING);
+      case ConnectionState.STARTING_TRACE:
+        await this.postToProxy(
+          `${ProxyEndpoint.START_TRACE}${
+            assertDefined(this.selectedDevice).id
+          }/`,
+          () => this.keepTraceAlive(),
+          this.requestedTraces,
+        );
+        // TODO(b/330118129): identify source of additional start latency that affects some traces
+        await TimeUtils.sleepMs(1000); // 1s timeout ensures SR fully started
+        if (this.getState() === ConnectionState.STARTING_TRACE) {
+          this.setState(ConnectionState.TRACING);
+        }
+        return;
+
+      case ConnectionState.ENDING_TRACE:
+        await this.postToProxy(
+          `${ProxyEndpoint.END_TRACE}${assertDefined(this.selectedDevice).id}/`,
+          (response: HttpResponse) => {
+            const errors = JSON.parse(response.body);
+            if (Array.isArray(errors) && errors.length > 0) {
+              const processedErrors: string[] = errors.map((error: string) => {
+                const processed = error
+                  .replace("b'", "'")
+                  .replace('\\n', '')
+                  .replace(
+                    'please check your display state',
+                    'please check your display state (must be on at start of trace)',
+                  );
+                return processed;
+              });
+              UserNotifier.add(new ProxyTracingErrors(processedErrors));
+            }
+          },
+        );
+        return;
+
+      case ConnectionState.DUMPING_STATE:
+        await this.postToProxy(
+          `${ProxyEndpoint.DUMP}${assertDefined(this.selectedDevice).id}/`,
+          FunctionUtils.DO_NOTHING,
+          this.requestedTraces,
+        );
+        return;
+
+      case ConnectionState.LOADING_DATA:
+        if (this.selectedDevice === undefined) {
+          throw new Error('No device selected');
+        }
+        await this.updateAdbData(assertDefined(this.selectedDevice));
+        return;
+
+      default:
+      // do nothing
+    }
   }
 
-  resetLastDevice() {
-    this.proxy.store.add('adb.lastDevice', '');
-    this.restart();
+  private async keepTraceAlive() {
+    const state = this.getState();
+    if (
+      state !== ConnectionState.STARTING_TRACE &&
+      state !== ConnectionState.TRACING
+    ) {
+      window.clearInterval(this.keepTraceAliveWorker);
+      this.keepTraceAliveWorker = undefined;
+      return;
+    }
+
+    await this.getFromProxy(
+      `${ProxyEndpoint.STATUS}${assertDefined(this.selectedDevice).id}/`,
+      async (request: HttpResponse) => {
+        if (request.text !== 'True') {
+          window.clearInterval(this.keepTraceAliveWorker);
+          this.keepTraceAliveWorker = undefined;
+          await this.endTrace();
+          if (this.state === ConnectionState.ENDING_TRACE) {
+            await this.setState(ConnectionState.TRACE_TIMEOUT);
+          }
+        } else if (this.keepTraceAliveWorker === undefined) {
+          this.keepTraceAliveWorker = window.setInterval(
+            () => this.keepTraceAlive(),
+            1000,
+          );
+        }
+      },
+    );
   }
 
-  selectDevice(id: string) {
-    this.proxy.selectDevice(id);
+  private async setState(state: ConnectionState, errorText = '') {
+    const connectedStates = [
+      ConnectionState.IDLE,
+      ConnectionState.STARTING_TRACE,
+      ConnectionState.TRACING,
+      ConnectionState.ENDING_TRACE,
+      ConnectionState.DUMPING_STATE,
+      ConnectionState.LOADING_DATA,
+    ];
+    if (
+      state === ConnectionState.NOT_FOUND &&
+      connectedStates.includes(this.state)
+    ) {
+      Analytics.Proxy.logServerNotFound();
+    }
+    this.state = state;
+    this.errorText = errorText;
+    await this.onConnectionStateChange(state);
   }
 
-  keepAliveTrace(view: ProxyConnection) {
-    if (!view.isStartingTraceState() && !view.isEndTraceState()) {
-      clearInterval(view.keep_alive_worker);
-      view.keep_alive_worker = undefined;
+  private async requestDevices() {
+    if (
+      this.state !== ConnectionState.IDLE &&
+      this.state !== ConnectionState.CONNECTING
+    ) {
+      if (this.refreshDevicesWorker !== undefined) {
+        window.clearInterval(this.refreshDevicesWorker);
+        this.refreshDevicesWorker = undefined;
+      }
       return;
     }
-    proxyRequest.keepTraceAlive(view.proxy, (request: XMLHttpRequest) => {
-      if (request.responseText !== 'True') {
-        view.endTrace();
-      } else if (view.keep_alive_worker === undefined) {
-        view.keep_alive_worker = setInterval(view.keepAliveTrace, 1000, view);
-      }
-    });
+
+    await this.getFromProxy(ProxyEndpoint.DEVICES, this.onSuccessGetDevices);
   }
 
-  async startTrace(
-    requestedTraces: string[],
-    reqEnableConfig?: string[],
-    reqSelectedSfConfig?: ConfigMap,
-    reqSelectedWmConfig?: ConfigMap,
-  ) {
-    if (reqEnableConfig) {
-      proxyRequest.setEnabledConfig(this.proxy, reqEnableConfig);
-    }
-    if (reqSelectedSfConfig) {
-      proxyRequest.setSelectedConfig(
-        ProxyEndpoint.SELECTED_SF_CONFIG_TRACE,
-        this.proxy,
-        reqSelectedSfConfig,
+  private onSuccessGetDevices: OnRequestSuccessCallback = async (
+    resp: HttpResponse,
+  ) => {
+    try {
+      const devices = JSON.parse(resp.text);
+      this.devices = Object.keys(devices).map((deviceId) => {
+        return {
+          id: deviceId,
+          authorized: devices[deviceId].authorized,
+          model: devices[deviceId].model,
+          displays: devices[deviceId].displays.map((display: string) => {
+            const parts = display.split(' ').slice(1);
+            const displayNameStartIndex = parts.findIndex((part) =>
+              part.includes('displayName'),
+            );
+            if (displayNameStartIndex !== -1) {
+              const displayName = parts
+                .slice(displayNameStartIndex)
+                .join(' ')
+                .slice(12);
+              if (displayName.length > 2) {
+                return [displayName]
+                  .concat(parts.slice(0, displayNameStartIndex))
+                  .join(' ');
+              }
+            }
+            return parts.join(' ');
+          }),
+          multiDisplayScreenRecordingAvailable:
+            devices[deviceId].screenrecord_version >=
+            ProxyConnection.MULTI_DISPLAY_SCREENRECORD_VERSION,
+        };
+      });
+      this.devicesChangeCallback(this.devices);
+      if (this.refreshDevicesWorker === undefined) {
+        this.refreshDevicesWorker = window.setInterval(
+          () => this.requestDevices(),
+          1000,
+        );
+      }
+      if (this.state === ConnectionState.CONNECTING) {
+        this.setState(ConnectionState.IDLE);
+      } else if (this.state === ConnectionState.IDLE) {
+        this.detectStateChangeInUi();
+      }
+    } catch (err) {
+      this.setState(
+        ConnectionState.ERROR,
+        `Could not find devices. Received:\n${resp.text}`,
       );
     }
-    if (reqSelectedWmConfig) {
-      proxyRequest.setSelectedConfig(
-        ProxyEndpoint.SELECTED_WM_CONFIG_TRACE,
-        this.proxy,
-        reqSelectedWmConfig,
+  };
+
+  private onSuccessFetchFiles: OnRequestSuccessCallback = async (
+    httpResponse: HttpResponse,
+  ) => {
+    try {
+      const enc = new TextDecoder('utf-8');
+      const resp = enc.decode(httpResponse.body);
+      const filesByType = JSON.parse(resp);
+
+      for (const filetype of Object.keys(filesByType)) {
+        const files = filesByType[filetype];
+        for (const encodedFileBuffer of files) {
+          const buffer = Uint8Array.from(window.atob(encodedFileBuffer), (c) =>
+            c.charCodeAt(0),
+          );
+          const blob = new Blob([buffer]);
+          const newFile = new File([blob], filetype);
+          this.adbData.push(newFile);
+        }
+      }
+    } catch (error) {
+      this.setState(
+        ConnectionState.ERROR,
+        `Could not fetch files. Received:\n${httpResponse.text}`,
       );
     }
-    await proxyClient.setState(ProxyState.STARTING_TRACE);
-    await proxyRequest.startTrace(
-      this.proxy,
-      requestedTraces,
-      (request: XMLHttpRequest) => this.keepAliveTrace(this),
-    );
-    // TODO(b/330118129): identify source of additional start latency that affects some traces
-    await TimeUtils.sleepMs(1000); // 1s timeout ensures SR fully started
-    proxyClient.setState(ProxyState.END_TRACE);
+  };
+
+  private isWaylandAvailable(): Promise<boolean> {
+    return new Promise((resolve) => {
+      this.getFromProxy(
+        ProxyEndpoint.CHECK_WAYLAND,
+        (request: HttpResponse) => {
+          resolve(request.text === 'true');
+        },
+      );
+    });
   }
 
-  async endTrace() {
-    this.progressCallback(0);
-    await this.proxy.setState(ProxyState.LOAD_DATA);
-    await proxyRequest.endTrace(this.proxy, this.progressCallback);
+  private async getFromProxy(
+    path: string,
+    onSuccess: OnRequestSuccessCallback,
+    type?: XMLHttpRequest['responseType'],
+  ) {
+    const response = await HttpRequest.get(
+      this.makeRequestPath(path),
+      this.getSecurityTokenHeader(),
+      type,
+    );
+    await this.processProxyResponse(response, onSuccess);
   }
 
-  async dumpState(requestedDumps: string[]): Promise<boolean> {
-    this.progressCallback(0);
-    if (requestedDumps.length < 1) {
-      console.error('No targets selected');
-      await this.proxy.setState(ProxyState.ERROR, 'No targets selected');
-      return false;
-    }
-    await this.proxy.setState(ProxyState.LOAD_DATA);
-    await proxyRequest.dumpState(
-      this.proxy,
-      requestedDumps,
-      this.progressCallback,
+  private async postToProxy(
+    path: string,
+    onSuccess: OnRequestSuccessCallback,
+    jsonRequest?: object,
+  ) {
+    const response = await HttpRequest.post(
+      this.makeRequestPath(path),
+      this.getSecurityTokenHeader(),
+      jsonRequest,
     );
-    return true;
+    await this.processProxyResponse(response, onSuccess);
   }
 
-  isWaylandAvailable(): Promise<boolean> {
-    return new Promise((resolve, reject) => {
-      proxyRequest.call(
-        'GET',
-        ProxyEndpoint.CHECK_WAYLAND,
-        (request: XMLHttpRequest) => {
-          resolve(request.responseText === 'true');
-        },
-      );
-    });
+  private async processProxyResponse(
+    response: HttpResponse,
+    onSuccess: OnRequestSuccessCallback,
+  ) {
+    if (
+      response.status === HttpRequestStatus.SUCCESS &&
+      !this.isVersionCompatible(response)
+    ) {
+      await this.setState(ConnectionState.INVALID_VERSION);
+      return;
+    }
+    const adbResponse = await this.processHttpResponse(response, onSuccess);
+    if (adbResponse !== undefined) {
+      await this.setState(adbResponse.newState, adbResponse.errorMsg);
+    }
   }
 
-  async onConnectChange(newState: ProxyState) {
-    if (newState === ProxyState.CONNECTING) {
-      proxyClient.getDevices();
+  private isVersionCompatible(req: HttpResponse): boolean {
+    const proxyVersion = req.getHeader('Winscope-Proxy-Version');
+    if (!proxyVersion) return false;
+    const [proxyMajor, proxyMinor, proxyPatch] = proxyVersion
+      .split('.')
+      .map((s) => Number(s));
+    const [clientMajor, clientMinor, clientPatch] =
+      ProxyConnection.VERSION.split('.').map((s) => Number(s));
+
+    if (proxyMajor !== clientMajor) {
+      return false;
     }
-    if (newState === ProxyState.START_TRACE) {
-      const isWaylandAvailable = await this.isWaylandAvailable();
-      if (isWaylandAvailable) {
-        const availableTracesConfig = TRACES['default'];
-        if (isWaylandAvailable) {
-          Object.assign(availableTracesConfig, TRACES['arc']);
-        }
-        this.traceConfigChangeCallback(availableTracesConfig);
-      }
+
+    if (proxyMinor === clientMinor) {
+      // Check patch number to ensure user has deployed latest bug fixes
+      return proxyPatch >= clientPatch;
+    }
+
+    return proxyMinor > clientMinor;
+  }
+
+  private getSecurityTokenHeader(): HttpRequestHeaderType {
+    const lastKey = this.store.get(this.storeKeySecurityToken);
+    if (lastKey !== undefined) {
+      this.securityToken = lastKey;
     }
-    this.proxyStateChangeCallback(newState);
+    return [['Winscope-Token', this.securityToken]];
+  }
+
+  private makeRequestPath(path: string): string {
+    return ProxyConnection.WINSCOPE_PROXY_URL + path;
   }
 }
diff --git a/tools/winscope/src/trace_collection/proxy_connection_test.ts b/tools/winscope/src/trace_collection/proxy_connection_test.ts
new file mode 100644
index 000000000..a2930b978
--- /dev/null
+++ b/tools/winscope/src/trace_collection/proxy_connection_test.ts
@@ -0,0 +1,806 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {
+  HttpRequest,
+  HttpRequestHeaderType,
+  HttpRequestStatus,
+  HttpResponse,
+} from 'common/http_request';
+import {ProxyTracingErrors} from 'messaging/user_warnings';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {waitToBeCalled} from 'test/utils';
+import {AdbDevice} from 'trace_collection/adb_device';
+import {ConnectionState} from 'trace_collection/connection_state';
+import {ProxyConnection} from 'trace_collection/proxy_connection';
+import {ProxyEndpoint} from './proxy_endpoint';
+import {TraceRequest} from './trace_request';
+
+type HttpRequestGetType = (
+  path: string,
+  headers: HttpRequestHeaderType,
+  type?: XMLHttpRequest['responseType'],
+) => Promise<HttpResponse>;
+
+type HttpRequestPostType = (
+  path: string,
+  headers: HttpRequestHeaderType,
+  jsonRequest?: object,
+) => Promise<HttpResponse>;
+
+describe('ProxyConnection', () => {
+  const detectStateChangesInUi = jasmine.createSpy();
+  const configOptionsChangeCallback = jasmine.createSpy();
+  const availableTracesChangeCallback = jasmine.createSpy();
+  const mockDevice: AdbDevice = {
+    id: '35562',
+    model: 'Pixel 6',
+    authorized: true,
+    displays: ['"Test Display" 12345 Extra Info'],
+    multiDisplayScreenRecordingAvailable: false,
+  };
+  const mockTraceRequest: TraceRequest = {
+    name: 'layers_trace',
+    config: [],
+  };
+  const getVersionHeader = () => ProxyConnection.VERSION;
+  const successfulEndTraceResponse: HttpResponse = {
+    status: HttpRequestStatus.SUCCESS,
+    type: '',
+    text: '[]',
+    body: '[]',
+    getHeader: getVersionHeader,
+  };
+
+  let connection: ProxyConnection;
+  let getSpy: jasmine.Spy<HttpRequestGetType>;
+  let postSpy: jasmine.Spy<HttpRequestPostType>;
+
+  describe('server not found', () => {
+    const unsentResponse: HttpResponse = {
+      status: HttpRequestStatus.UNSENT,
+      type: '',
+      text: '',
+      body: undefined,
+      getHeader: getVersionHeader,
+    };
+
+    beforeEach(async () => {
+      await setUpTestEnvironment(unsentResponse);
+    });
+
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('requests devices on initialization', () => {
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.NOT_FOUND);
+    });
+
+    it('requests devices on restarting connection', async () => {
+      resetSpies();
+      await connection.restartConnection();
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.NOT_FOUND);
+    });
+
+    it('posts start trace request to proxy and updates state if proxy not found', async () => {
+      const requestObj = [mockTraceRequest];
+      await connection.startTrace(mockDevice, requestObj);
+      expect(postSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.START_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        requestObj,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.NOT_FOUND);
+    });
+  });
+
+  describe('unsuccessful request', () => {
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('unauthorized server', async () => {
+      const unauthResponse: HttpResponse = {
+        status: HttpRequestStatus.UNAUTH,
+        type: '',
+        text: '',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(unauthResponse);
+      expect(connection.getState()).toEqual(ConnectionState.UNAUTH);
+    });
+
+    it('invalid version - header undefined', async () => {
+      await checkInvalidVersion(() => undefined);
+    });
+
+    it('invalid version - old major', async () => {
+      await checkInvalidVersion(() => '0.0.0');
+    });
+
+    it('invalid version - old minor', async () => {
+      const [major, minor, patch] = ProxyConnection.VERSION.split('.');
+      await checkInvalidVersion(() =>
+        [major, Number(minor) - 1, patch].join('.'),
+      );
+    });
+
+    it('invalid version - old patch', async () => {
+      const [major, minor, patch] = ProxyConnection.VERSION.split('.');
+      await checkInvalidVersion(() =>
+        [major, minor, Number(patch) - 1].join('.'),
+      );
+    });
+
+    it('error state with response type text', async () => {
+      const errorResponse: HttpResponse = {
+        status: HttpRequestStatus.ERROR,
+        type: 'text',
+        text: 'test error message',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(errorResponse);
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+      expect(connection.getErrorText()).toEqual(errorResponse.text);
+    });
+
+    it('error state with response type empty', async () => {
+      const errorResponse: HttpResponse = {
+        status: HttpRequestStatus.ERROR,
+        type: '',
+        text: 'test error message',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(errorResponse);
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+      expect(connection.getErrorText()).toEqual(errorResponse.text);
+    });
+
+    it('error state with response type array buffer', async () => {
+      const errorResponse: HttpResponse = {
+        status: HttpRequestStatus.ERROR,
+        type: 'arraybuffer',
+        text: '',
+        body: [],
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(errorResponse);
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+    });
+
+    async function checkInvalidVersion(getHeader: () => string | undefined) {
+      const invalidResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: '',
+        body: undefined,
+        getHeader,
+      };
+      await setUpTestEnvironment(invalidResponse);
+      expect(connection.getState()).toEqual(ConnectionState.INVALID_VERSION);
+    }
+  });
+
+  describe('successful responses to tracing process', () => {
+    let userNotifierChecker: UserNotifierChecker;
+
+    beforeAll(() => {
+      userNotifierChecker = new UserNotifierChecker();
+    });
+
+    beforeEach(async () => {
+      userNotifierChecker.reset();
+      const successfulResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: 'True',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(successfulResponse);
+    });
+
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('uses stored token on initialization', async () => {
+      resetSpies();
+      connection.setSecurityToken('test_initial_token');
+      connection = await createProxyConnection();
+      checkGetDevicesRequest('test_initial_token');
+    });
+
+    it('sets security token and sends as header', async () => {
+      resetSpies();
+      connection.setSecurityToken('test_token');
+      await connection.restartConnection();
+      checkGetDevicesRequest('test_token');
+    });
+
+    it('does not set empty token', async () => {
+      connection.setSecurityToken('test_initial_token');
+      connection = await createProxyConnection();
+      resetSpies();
+      connection.setSecurityToken('');
+      await connection.restartConnection();
+      checkGetDevicesRequest('test_initial_token');
+    });
+
+    it('throws error on startTrace if no traces requested', async () => {
+      await expectAsync(
+        connection.startTrace(mockDevice, []),
+      ).toBeRejectedWithError('No traces requested');
+    });
+
+    it('throws error on endTrace if no traces requested', async () => {
+      await expectAsync(connection.endTrace()).toBeRejectedWithError(
+        'Trace not started before stopping',
+      );
+    });
+
+    it('throws error on dumpState if no dumps requested', async () => {
+      await expectAsync(
+        connection.dumpState(mockDevice, []),
+      ).toBeRejectedWithError('No dumps requested');
+    });
+
+    it('posts start trace request to proxy and updates state to tracing', async () => {
+      await checkSuccessfulTraceRequest([mockTraceRequest]);
+    });
+
+    it('posts start trace requests without updating screen recording config', async () => {
+      const requestEmptyStrDisplays: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: ''}],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestEmptyStrDisplays);
+
+      const requestEmptyArrDisplays: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: []}],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestEmptyArrDisplays);
+
+      const requestDisplayStrWithoutName: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: '12345 Other Info'}],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestDisplayStrWithoutName);
+
+      const requestDisplayArrWithoutName: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: ['12345 Other Info']}],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestDisplayArrWithoutName);
+    });
+
+    it('posts start trace requests with updated screen recording config', async () => {
+      const requestDisplayStrWithName: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: '"Test Display" 12345 Other Info'}],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestDisplayStrWithName, [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: '12345 Other Info'}],
+        },
+      ]);
+
+      const requestDisplayArrWithName: TraceRequest[] = [
+        {
+          name: 'screen_recording',
+          config: [
+            {key: 'displays', value: ['"Test Display" 12345 Other Info']},
+          ],
+        },
+      ];
+      await checkSuccessfulTraceRequest(requestDisplayArrWithName, [
+        {
+          name: 'screen_recording',
+          config: [{key: 'displays', value: ['12345 Other Info']}],
+        },
+      ]);
+    });
+
+    it('handles trace timeout', async () => {
+      const requestObj = [mockTraceRequest];
+      getSpy.and.returnValue(
+        Promise.resolve({
+          status: HttpRequestStatus.SUCCESS,
+          type: '',
+          text: 'False',
+          body: undefined,
+          getHeader: getVersionHeader,
+        }),
+      );
+      postSpy.and.returnValue(
+        Promise.resolve({
+          status: HttpRequestStatus.SUCCESS,
+          type: '',
+          text: 'True',
+          body: '[]',
+          getHeader: getVersionHeader,
+        }),
+      );
+      await connection.startTrace(mockDevice, requestObj);
+
+      expect(postSpy).toHaveBeenCalledWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.START_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        requestObj,
+      );
+      expect(postSpy).toHaveBeenCalledWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.END_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        undefined,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.TRACE_TIMEOUT);
+    });
+
+    it('posts end trace request to proxy and handles response without errors', async () => {
+      await startAndEndTrace(successfulEndTraceResponse);
+      checkTraceEndedSuccessfully();
+      userNotifierChecker.expectNone();
+    });
+
+    it('posts end trace request to proxy and handles response with errors', async () => {
+      await startAndEndTrace({
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: '["please check your display state", "b\'unknown error\'"]',
+        body: '["please check your display state", "b\'unknown error\'"]',
+        getHeader: getVersionHeader,
+      });
+      checkTraceEndedSuccessfully();
+      userNotifierChecker.expectAdded([
+        new ProxyTracingErrors([
+          'please check your display state (must be on at start of trace)',
+          "'unknown error'",
+        ]),
+      ]);
+    });
+
+    it('posts end trace request to proxy and handles non-serializable errors', async () => {
+      await startAndEndTrace({
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: '["please check your display state", "b\'unknown error\'"]',
+        body: undefined,
+        getHeader: getVersionHeader,
+      });
+      expect(postSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.END_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        undefined,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+      expect(connection.getErrorText()).toContain(
+        'Error handling request response',
+      );
+    });
+
+    it('posts dump state request to proxy', async () => {
+      await checkSuccessfulDumpRequest([mockTraceRequest]);
+    });
+
+    it('posts dump requests without updating screenshot config', async () => {
+      const requestEmptyArrDisplays: TraceRequest[] = [
+        {
+          name: 'screenshot',
+          config: [{key: 'displays', value: []}],
+        },
+      ];
+      await checkSuccessfulDumpRequest(requestEmptyArrDisplays);
+
+      const requestDisplayArrWithoutName: TraceRequest[] = [
+        {
+          name: 'screenshot',
+          config: [{key: 'displays', value: ['12345 Other Info']}],
+        },
+      ];
+      await checkSuccessfulDumpRequest(requestDisplayArrWithoutName);
+    });
+
+    it('posts dump requests with updated screenshot config', async () => {
+      const requestDisplayArrWithName: TraceRequest[] = [
+        {
+          name: 'screenshot',
+          config: [
+            {key: 'displays', value: ['"Test Display" 12345 Other Info']},
+          ],
+        },
+      ];
+      await checkSuccessfulDumpRequest(requestDisplayArrWithName, [
+        {
+          name: 'screenshot',
+          config: [{key: 'displays', value: ['12345 Other Info']}],
+        },
+      ]);
+    });
+
+    function checkTraceEndedSuccessfully() {
+      expect(postSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.END_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        undefined,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.ENDING_TRACE);
+    }
+
+    async function checkSuccessfulTraceRequest(
+      requests: TraceRequest[],
+      updatedRequests = requests,
+    ) {
+      postSpy.calls.reset();
+      await connection.startTrace(mockDevice, requests);
+
+      expect(postSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.START_TRACE +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        updatedRequests,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.TRACING);
+    }
+
+    async function checkSuccessfulDumpRequest(
+      requests: TraceRequest[],
+      updatedRequests = requests,
+    ) {
+      postSpy.calls.reset();
+      await connection.dumpState(mockDevice, requests);
+
+      expect(postSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.DUMP +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        updatedRequests,
+      );
+      expect(connection.getState()).toEqual(ConnectionState.DUMPING_STATE);
+    }
+  });
+
+  describe('wayland trace availability', () => {
+    beforeEach(() => {
+      availableTracesChangeCallback.calls.reset();
+    });
+
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('updates availability of wayland trace if available', async () => {
+      const successfulResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: 'true',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(successfulResponse);
+      expect(availableTracesChangeCallback).toHaveBeenCalledOnceWith([
+        'wayland_trace',
+      ]);
+    });
+
+    it('does not update availability of traces if call fails', async () => {
+      const unsuccessfulResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: '',
+        text: 'false',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(unsuccessfulResponse);
+      expect(availableTracesChangeCallback).not.toHaveBeenCalled();
+    });
+  });
+
+  describe('finding devices', () => {
+    const successfulResponse: HttpResponse = {
+      status: HttpRequestStatus.SUCCESS,
+      type: 'text',
+      text: JSON.stringify({
+        '35562': {
+          authorized: mockDevice.authorized,
+          model: mockDevice.model,
+          displays: ['Display 12345 Extra Info displayName="Test Display"'],
+        },
+      }),
+      body: undefined,
+      getHeader: getVersionHeader,
+    };
+
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('sets error state if onSuccess callback fails', async () => {
+      const noDevicesResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: 'arraybuffer',
+        text: '[0,]',
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(noDevicesResponse);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+      expect(connection.getErrorText()).toEqual(
+        'Could not find devices. Received:\n[0,]',
+      );
+    });
+
+    it('fetches devices', async () => {
+      await setUpTestEnvironment(successfulResponse);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([mockDevice]);
+    });
+
+    it('sets up worker to fetch devices', async () => {
+      await setUpTestEnvironment(successfulResponse);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([mockDevice]);
+      expect(getSpy).toHaveBeenCalledWith(
+        ProxyConnection.WINSCOPE_PROXY_URL + ProxyEndpoint.CHECK_WAYLAND,
+        [['Winscope-Token', '']],
+        undefined,
+      );
+
+      getSpy.calls.reset();
+      detectStateChangesInUi.calls.reset();
+
+      await waitToBeCalled(detectStateChangesInUi, 1);
+      await waitToBeCalled(getSpy, 1);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([mockDevice]);
+      expect(getSpy).not.toHaveBeenCalledWith(
+        ProxyConnection.WINSCOPE_PROXY_URL + ProxyEndpoint.CHECK_WAYLAND,
+        [['Winscope-Token', '']],
+        undefined,
+      );
+    });
+
+    it('handles missing displayName', async () => {
+      const response: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: 'text',
+        text: JSON.stringify({
+          '35562': {
+            authorized: mockDevice.authorized,
+            model: mockDevice.model,
+            displays: ['Display 12345 Extra Info'],
+          },
+        }),
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+
+      await setUpTestEnvironment(response);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([
+        {
+          id: '35562',
+          model: 'Pixel 6',
+          authorized: true,
+          displays: ['12345 Extra Info'],
+          multiDisplayScreenRecordingAvailable: false,
+        },
+      ]);
+    });
+
+    it('updates multi display screen recording availability for incompatible version', async () => {
+      const oldVersionResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: 'text',
+        text: JSON.stringify({
+          '35562': {
+            authorized: mockDevice.authorized,
+            model: mockDevice.model,
+            displays: ['Display 12345 Extra Info displayName="Test Display"'],
+            screenrecord_version: '1.3',
+          },
+        }),
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(oldVersionResponse);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([mockDevice]);
+    });
+
+    it('updates multi display screen recording availability for compatible version', async () => {
+      const compatibleVersionResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: 'text',
+        text: JSON.stringify({
+          '35562': {
+            authorized: mockDevice.authorized,
+            model: mockDevice.model,
+            displays: ['Display 12345 Extra Info displayName="Test Display"'],
+            screenrecord_version: '1.4',
+          },
+        }),
+        body: undefined,
+        getHeader: getVersionHeader,
+      };
+      const mockDeviceWithMultiDisplayScreenRecording: AdbDevice = {
+        id: '35562',
+        model: 'Pixel 6',
+        authorized: true,
+        displays: ['"Test Display" 12345 Extra Info'],
+        multiDisplayScreenRecordingAvailable: true,
+      };
+
+      await setUpTestEnvironment(compatibleVersionResponse);
+      checkGetDevicesRequest();
+      expect(connection.getState()).toEqual(ConnectionState.IDLE);
+      expect(connection.getDevices()).toEqual([
+        mockDeviceWithMultiDisplayScreenRecording,
+      ]);
+    });
+  });
+
+  describe('files', () => {
+    const testFileArray = [window.btoa('[20]')];
+    const testFile = new File(testFileArray, 'test_file');
+
+    const successfulResponse: HttpResponse = {
+      status: HttpRequestStatus.SUCCESS,
+      type: 'arraybuffer',
+      text: 'True',
+      body: new TextEncoder().encode(
+        JSON.stringify({'test_file': testFileArray}),
+      ),
+      getHeader: getVersionHeader,
+    };
+    afterEach(() => {
+      localStorage.clear();
+    });
+
+    it('sets error state if fetching files fails', async () => {
+      const successfulResponse: HttpResponse = {
+        status: HttpRequestStatus.SUCCESS,
+        type: 'arraybuffer',
+        text: 'False',
+        body: new TextEncoder().encode('[0,]'),
+        getHeader: getVersionHeader,
+      };
+      await setUpTestEnvironment(successfulResponse);
+      resetSpies();
+      await connection.fetchLastTracingSessionData(mockDevice);
+
+      expect(getSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.FETCH +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        'arraybuffer',
+      );
+      expect(connection.getState()).toEqual(ConnectionState.ERROR);
+      expect(connection.getErrorText()).toEqual(
+        'Could not fetch files. Received:\nFalse',
+      );
+    });
+
+    it('fetches last tracing session data without ongoing tracing', async () => {
+      await setUpTestEnvironment(successfulResponse);
+      resetSpies();
+      const files = await connection.fetchLastTracingSessionData(mockDevice);
+
+      expect(getSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.FETCH +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        'arraybuffer',
+      );
+      expect(connection.getState()).toEqual(ConnectionState.LOADING_DATA);
+      expect(files).toEqual([testFile]);
+    });
+
+    it('fetches last tracing session data from ongoing tracing', async () => {
+      await setUpTestEnvironment(successfulResponse);
+      await startAndEndTrace(successfulEndTraceResponse);
+      resetSpies();
+      const files = await connection.fetchLastTracingSessionData(mockDevice);
+
+      expect(getSpy).toHaveBeenCalledOnceWith(
+        ProxyConnection.WINSCOPE_PROXY_URL +
+          ProxyEndpoint.FETCH +
+          `${mockDevice.id}/`,
+        [['Winscope-Token', '']],
+        'arraybuffer',
+      );
+      expect(connection.getState()).toEqual(ConnectionState.LOADING_DATA);
+      expect(files).toEqual([testFile]);
+    });
+  });
+
+  async function setUpTestEnvironment(response: HttpResponse) {
+    getSpy = spyOn(HttpRequest, 'get').and.returnValue(
+      Promise.resolve(response),
+    );
+    postSpy = spyOn(HttpRequest, 'post').and.returnValue(
+      Promise.resolve(response),
+    );
+    connection = await createProxyConnection();
+  }
+
+  function checkGetDevicesRequest(header = '') {
+    expect(getSpy).toHaveBeenCalledWith(
+      ProxyConnection.WINSCOPE_PROXY_URL + ProxyEndpoint.DEVICES,
+      [['Winscope-Token', header]],
+      undefined,
+    );
+  }
+
+  async function startAndEndTrace(endingTraceResponse: HttpResponse) {
+    await connection.startTrace(mockDevice, [mockTraceRequest]);
+    resetSpies();
+    postSpy.and.returnValue(Promise.resolve(endingTraceResponse));
+    await connection.endTrace();
+  }
+
+  function resetSpies() {
+    getSpy.calls.reset();
+    postSpy.calls.reset();
+  }
+
+  async function createProxyConnection() {
+    const connection = new ProxyConnection();
+    await connection.initialize(
+      detectStateChangesInUi,
+      availableTracesChangeCallback,
+      configOptionsChangeCallback,
+    );
+    return connection;
+  }
+});
diff --git a/tools/winscope/src/trace_collection/proxy_endpoint.ts b/tools/winscope/src/trace_collection/proxy_endpoint.ts
new file mode 100644
index 000000000..9b99a10ef
--- /dev/null
+++ b/tools/winscope/src/trace_collection/proxy_endpoint.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export enum ProxyEndpoint {
+  DEVICES = '/devices/',
+  START_TRACE = '/start/',
+  END_TRACE = '/end/',
+  DUMP = '/dump/',
+  FETCH = '/fetch/',
+  STATUS = '/status/',
+  CHECK_WAYLAND = '/checkwayland/',
+}
diff --git a/tools/winscope/src/trace_collection/trace_collection_utils.ts b/tools/winscope/src/trace_collection/trace_collection_utils.ts
deleted file mode 100644
index 2e0dfa4ea..000000000
--- a/tools/winscope/src/trace_collection/trace_collection_utils.ts
+++ /dev/null
@@ -1,189 +0,0 @@
-/*
- * Copyright (C) 2022 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {TRACE_INFO} from 'trace/trace_info';
-import {TraceType} from 'trace/trace_type';
-
-export interface TraceConfiguration {
-  name: string | undefined;
-  run: boolean | undefined;
-  config: ConfigurationOptions | undefined;
-}
-
-export interface TraceConfigurationMap {
-  [key: string]: TraceConfiguration;
-}
-
-interface ConfigurationOptions {
-  enableConfigs: EnableConfiguration[];
-  selectionConfigs: SelectionConfiguration[];
-}
-
-export interface EnableConfiguration {
-  name: string;
-  key: string;
-  enabled: boolean;
-}
-
-export interface SelectionConfiguration {
-  key: string;
-  name: string;
-  options: string[];
-  value: string;
-}
-
-export interface ConfigMap {
-  [key: string]: string[] | string;
-}
-
-const wmTraceSelectionConfigs: SelectionConfiguration[] = [
-  {
-    key: 'wmbuffersize',
-    name: 'buffer size (KB)',
-    options: ['4000', '8000', '16000', '32000'],
-    value: '32000',
-  },
-  {
-    key: 'tracingtype',
-    name: 'tracing type',
-    options: ['frame', 'transaction'],
-    value: 'frame',
-  },
-  {
-    key: 'tracinglevel',
-    name: 'tracing level',
-    options: ['verbose', 'debug', 'critical'],
-    value: 'verbose',
-  },
-];
-
-const sfTraceEnableConfigs: EnableConfiguration[] = [
-  {
-    name: 'input',
-    key: 'input',
-    enabled: true,
-  },
-  {
-    name: 'composition',
-    key: 'composition',
-    enabled: true,
-  },
-  {
-    name: 'metadata',
-    key: 'metadata',
-    enabled: false,
-  },
-  {
-    name: 'hwc',
-    key: 'hwc',
-    enabled: true,
-  },
-  {
-    name: 'trace buffers',
-    key: 'tracebuffers',
-    enabled: true,
-  },
-  {
-    name: 'virtual displays',
-    key: 'virtualdisplays',
-    enabled: false,
-  },
-];
-
-const sfTraceSelectionConfigs: SelectionConfiguration[] = [
-  {
-    key: 'sfbuffersize',
-    name: 'buffer size (KB)',
-    options: ['4000', '8000', '16000', '32000'],
-    value: '32000',
-  },
-];
-
-const traceConfigurations: TraceConfigurationMap = {
-  layers_trace: {
-    name: TRACE_INFO[TraceType.SURFACE_FLINGER].name,
-    run: true,
-    config: {
-      enableConfigs: sfTraceEnableConfigs,
-      selectionConfigs: sfTraceSelectionConfigs,
-    },
-  },
-  window_trace: {
-    name: TRACE_INFO[TraceType.WINDOW_MANAGER].name,
-    run: true,
-    config: {
-      enableConfigs: [],
-      selectionConfigs: wmTraceSelectionConfigs,
-    },
-  },
-  screen_recording: {
-    name: TRACE_INFO[TraceType.SCREEN_RECORDING].name,
-    run: true,
-    config: undefined,
-  },
-  ime: {
-    name: 'IME',
-    run: true,
-    config: undefined,
-  },
-  transactions: {
-    name: TRACE_INFO[TraceType.TRANSACTIONS].name,
-    run: false,
-    config: undefined,
-  },
-  proto_log: {
-    name: TRACE_INFO[TraceType.PROTO_LOG].name,
-    run: false,
-    config: undefined,
-  },
-  wayland_trace: {
-    name: TRACE_INFO[TraceType.WAYLAND].name,
-    run: false,
-    config: undefined,
-  },
-  eventlog: {
-    name: TRACE_INFO[TraceType.EVENT_LOG].name,
-    run: false,
-    config: undefined,
-  },
-  transition_traces: {
-    name: TRACE_INFO[TraceType.SHELL_TRANSITION].name,
-    run: false,
-    config: undefined,
-  },
-  view_capture_traces: {
-    name: 'View Capture',
-    run: false,
-    config: undefined,
-  },
-};
-
-export const TRACES: {[key: string]: TraceConfigurationMap} = {
-  default: {
-    window_trace: traceConfigurations['window_trace'],
-    layers_trace: traceConfigurations['layers_trace'],
-    transactions: traceConfigurations['transactions'],
-    proto_log: traceConfigurations['proto_log'],
-    screen_recording: traceConfigurations['screen_recording'],
-    ime: traceConfigurations['ime'],
-    eventlog: traceConfigurations['eventlog'],
-    transition_traces: traceConfigurations['transition_traces'],
-    view_capture_trace: traceConfigurations['view_capture_traces'],
-  },
-  arc: {
-    wayland_trace: traceConfigurations['wayland_trace'],
-  },
-};
diff --git a/tools/winscope/src/trace_collection/trace_configuration.ts b/tools/winscope/src/trace_collection/trace_configuration.ts
new file mode 100644
index 000000000..469f6b9af
--- /dev/null
+++ b/tools/winscope/src/trace_collection/trace_configuration.ts
@@ -0,0 +1,291 @@
+/*
+ * Copyright (C) 2022 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TRACE_INFO} from 'trace/trace_info';
+import {TraceType} from 'trace/trace_type';
+
+export interface TraceConfiguration {
+  name: string;
+  enabled: boolean;
+  config: ConfigurationOptions | undefined;
+  available: boolean;
+  types: TraceType[];
+}
+
+export interface TraceConfigurationMap {
+  [key: string]: TraceConfiguration;
+}
+
+export interface ConfigurationOptions {
+  enableConfigs: EnableConfiguration[];
+  selectionConfigs: SelectionConfiguration[];
+}
+
+export interface EnableConfiguration {
+  name: string;
+  key: string;
+  enabled: boolean;
+}
+
+export interface SelectionConfiguration {
+  key: string;
+  name: string;
+  options: string[];
+  value: string | string[];
+  desc?: string;
+  optional?: boolean;
+  wideField?: boolean;
+}
+
+export interface ConfigMap {
+  [key: string]: string[] | string;
+}
+
+const wmTraceSelectionConfigs: SelectionConfiguration[] = [
+  {
+    key: 'wmbuffersize',
+    name: 'buffer size (KB)',
+    options: ['4000', '8000', '16000', '32000'],
+    value: '32000',
+  },
+  {
+    key: 'tracingtype',
+    name: 'tracing type',
+    options: ['frame', 'transaction'],
+    value: 'frame',
+  },
+  {
+    key: 'tracinglevel',
+    name: 'tracing level',
+    options: ['verbose', 'debug', 'critical'],
+    value: 'verbose',
+  },
+];
+
+const sfTraceEnableConfigs: EnableConfiguration[] = [
+  {
+    name: 'input',
+    key: 'input',
+    enabled: true,
+  },
+  {
+    name: 'composition',
+    key: 'composition',
+    enabled: true,
+  },
+  {
+    name: 'metadata',
+    key: 'metadata',
+    enabled: false,
+  },
+  {
+    name: 'hwc',
+    key: 'hwc',
+    enabled: false,
+  },
+  {
+    name: 'trace buffers',
+    key: 'tracebuffers',
+    enabled: false,
+  },
+  {
+    name: 'virtual displays',
+    key: 'virtualdisplays',
+    enabled: false,
+  },
+];
+
+const sfTraceSelectionConfigs: SelectionConfiguration[] = [
+  {
+    key: 'sfbuffersize',
+    name: 'buffer size (KB)',
+    options: ['4000', '8000', '16000', '32000'],
+    value: '32000',
+  },
+];
+const screenshotConfigs: SelectionConfiguration[] = [
+  {
+    key: 'displays',
+    name: 'displays',
+    options: [],
+    value: [],
+    desc: 'Leave empty to capture active display',
+    wideField: true,
+  },
+];
+
+export function makeScreenRecordingConfigs(
+  options: string[],
+  initialValue: string | string[],
+): SelectionConfiguration[] {
+  return [
+    {
+      key: 'displays',
+      name: 'displays',
+      options,
+      value: initialValue,
+      optional: true,
+      desc: 'Leave empty to capture active display',
+      wideField: true,
+    },
+  ];
+}
+
+const traceDefaultConfig: TraceConfigurationMap = {
+  layers_trace: {
+    name: TRACE_INFO[TraceType.SURFACE_FLINGER].name,
+    enabled: true,
+    config: {
+      enableConfigs: sfTraceEnableConfigs,
+      selectionConfigs: sfTraceSelectionConfigs,
+    },
+    available: true,
+    types: [TraceType.SURFACE_FLINGER],
+  },
+  window_trace: {
+    name: TRACE_INFO[TraceType.WINDOW_MANAGER].name,
+    enabled: true,
+    config: {
+      enableConfigs: [],
+      selectionConfigs: wmTraceSelectionConfigs,
+    },
+    available: true,
+    types: [TraceType.WINDOW_MANAGER],
+  },
+  screen_recording: {
+    name: TRACE_INFO[TraceType.SCREEN_RECORDING].name,
+    enabled: true,
+    config: {
+      enableConfigs: [],
+      selectionConfigs: makeScreenRecordingConfigs([], ''),
+    },
+    available: true,
+    types: [TraceType.SCREEN_RECORDING],
+  },
+  ime: {
+    name: 'IME',
+    enabled: true,
+    config: undefined,
+    available: true,
+    types: [
+      TraceType.INPUT_METHOD_CLIENTS,
+      TraceType.INPUT_METHOD_SERVICE,
+      TraceType.INPUT_METHOD_MANAGER_SERVICE,
+    ],
+  },
+  transactions: {
+    name: TRACE_INFO[TraceType.TRANSACTIONS].name,
+    enabled: true,
+    config: undefined,
+    available: true,
+    types: [TraceType.TRANSACTIONS, TraceType.TRANSACTIONS_LEGACY],
+  },
+  proto_log: {
+    name: TRACE_INFO[TraceType.PROTO_LOG].name,
+    enabled: false,
+    config: undefined,
+    available: true,
+    types: [TraceType.PROTO_LOG],
+  },
+  wayland_trace: {
+    name: TRACE_INFO[TraceType.WAYLAND].name,
+    enabled: false,
+    config: undefined,
+    available: false,
+    types: [TraceType.WAYLAND, TraceType.WAYLAND_DUMP],
+  },
+  eventlog: {
+    name: TRACE_INFO[TraceType.EVENT_LOG].name,
+    enabled: false,
+    config: undefined,
+    available: true,
+    types: [TraceType.EVENT_LOG, TraceType.CUJS],
+  },
+  transition_traces: {
+    name: TRACE_INFO[TraceType.SHELL_TRANSITION].name,
+    enabled: false,
+    config: undefined,
+    available: true,
+    types: [
+      TraceType.SHELL_TRANSITION,
+      TraceType.WM_TRANSITION,
+      TraceType.TRANSITION,
+    ],
+  },
+  view_capture_traces: {
+    name: TRACE_INFO[TraceType.VIEW_CAPTURE].name,
+    enabled: false,
+    config: undefined,
+    available: true,
+    types: [TraceType.VIEW_CAPTURE],
+  },
+  input: {
+    name: 'Input',
+    enabled: false,
+    config: undefined,
+    available: true,
+    types: [
+      TraceType.INPUT_KEY_EVENT,
+      TraceType.INPUT_MOTION_EVENT,
+      TraceType.INPUT_EVENT_MERGED,
+    ],
+  },
+};
+
+export function makeDefaultTraceConfigMap(): TraceConfigurationMap {
+  return structuredClone({
+    window_trace: traceDefaultConfig['window_trace'],
+    layers_trace: traceDefaultConfig['layers_trace'],
+    transactions: traceDefaultConfig['transactions'],
+    proto_log: traceDefaultConfig['proto_log'],
+    screen_recording: traceDefaultConfig['screen_recording'],
+    ime: traceDefaultConfig['ime'],
+    eventlog: traceDefaultConfig['eventlog'],
+    transition_traces: traceDefaultConfig['transition_traces'],
+    view_capture_trace: traceDefaultConfig['view_capture_traces'],
+    input: traceDefaultConfig['input'],
+    wayland_trace: traceDefaultConfig['wayland_trace'],
+  });
+}
+
+export function makeDefaultDumpConfigMap(): TraceConfigurationMap {
+  return structuredClone({
+    window_dump: {
+      name: 'Window Manager',
+      enabled: true,
+      config: undefined,
+      available: true,
+      types: [TraceType.WINDOW_MANAGER],
+    },
+    layers_dump: {
+      name: 'Surface Flinger',
+      enabled: true,
+      config: undefined,
+      available: true,
+      types: [TraceType.SURFACE_FLINGER],
+    },
+    screenshot: {
+      name: 'Screenshot',
+      enabled: true,
+      config: {
+        enableConfigs: [],
+        selectionConfigs: screenshotConfigs,
+      },
+      available: true,
+      types: [TraceType.SCREENSHOT],
+    },
+  });
+}
diff --git a/tools/winscope/src/trace_collection/trace_request.ts b/tools/winscope/src/trace_collection/trace_request.ts
new file mode 100644
index 000000000..951e4a2b2
--- /dev/null
+++ b/tools/winscope/src/trace_collection/trace_request.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export interface TraceRequest {
+  name: string;
+  config: TraceRequestConfig[];
+}
+
+export interface TraceRequestConfig {
+  key: string;
+  value?: string | string[];
+}
diff --git a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
index d24546c20..62b162abf 100644
--- a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
+++ b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter.ts
@@ -16,7 +16,13 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {FunctionUtils} from 'common/function_utils';
-import {TracePositionUpdate, WinscopeEvent} from 'messaging/winscope_event';
+import {parseMap, stringifyMap} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
+import {
+  TracePositionUpdate,
+  WinscopeEvent,
+  WinscopeEventType,
+} from 'messaging/winscope_event';
 import {
   EmitEvent,
   WinscopeEventEmitter,
@@ -32,14 +38,17 @@ import {RectsPresenter} from 'viewers/common/rects_presenter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 import {HierarchyPresenter} from './hierarchy_presenter';
+import {PresetHierarchy} from './preset_hierarchy';
 import {RectShowState} from './rect_show_state';
+import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {ViewerEvents} from './viewer_events';
 
-export type NotifyHierarchyViewCallbackType = (uiData: UiDataHierarchy) => void;
+export type NotifyHierarchyViewCallbackType<UiData> = (uiData: UiData) => void;
 
-export abstract class AbstractHierarchyViewerPresenter
-  implements WinscopeEventEmitter
+export abstract class AbstractHierarchyViewerPresenter<
+  UiData extends UiDataHierarchy,
+> implements WinscopeEventEmitter
 {
   protected emitWinscopeEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
   protected overridePropertiesTree: PropertyTreeNode | undefined;
@@ -53,10 +62,11 @@ export abstract class AbstractHierarchyViewerPresenter
   constructor(
     private readonly trace: Trace<HierarchyTreeNode> | undefined,
     protected readonly traces: Traces,
-    protected readonly storage: Readonly<Storage>,
-    private readonly notifyViewCallback: NotifyHierarchyViewCallbackType,
-    protected uiData: UiDataHierarchy,
+    protected readonly storage: Readonly<Store>,
+    private readonly notifyViewCallback: NotifyHierarchyViewCallbackType<UiData>,
+    protected readonly uiData: UiData,
   ) {
+    uiData.isDarkMode = storage.get('dark-mode') === 'true';
     this.copyUiDataAndNotifyView();
   }
 
@@ -87,10 +97,10 @@ export abstract class AbstractHierarchyViewerPresenter
     );
     htmlElement.addEventListener(
       ViewerEvents.HierarchyFilterChange,
-      async (event) =>
-        await this.onHierarchyFilterChange(
-          (event as CustomEvent).detail.filterString,
-        ),
+      async (event) => {
+        const detail: TextFilter = (event as CustomEvent).detail;
+        await this.onHierarchyFilterChange(detail);
+      },
     );
     htmlElement.addEventListener(
       ViewerEvents.PropertiesUserOptionsChange,
@@ -101,10 +111,10 @@ export abstract class AbstractHierarchyViewerPresenter
     );
     htmlElement.addEventListener(
       ViewerEvents.PropertiesFilterChange,
-      async (event) =>
-        await this.onPropertiesFilterChange(
-          (event as CustomEvent).detail.filterString,
-        ),
+      async (event) => {
+        const detail: TextFilter = (event as CustomEvent).detail;
+        await this.onPropertiesFilterChange(detail);
+      },
     );
     htmlElement.addEventListener(
       ViewerEvents.HighlightedNodeChange,
@@ -160,19 +170,18 @@ export abstract class AbstractHierarchyViewerPresenter
     await this.hierarchyPresenter.applyHierarchyUserOptionsChange(userOptions);
     this.uiData.hierarchyUserOptions = this.hierarchyPresenter.getUserOptions();
     this.uiData.hierarchyTrees = this.hierarchyPresenter.getAllFormattedTrees();
+    this.uiData.pinnedItems = this.hierarchyPresenter.getPinnedItems();
     this.copyUiDataAndNotifyView();
   }
 
-  async onHierarchyFilterChange(filterString: string) {
-    await this.hierarchyPresenter.applyHierarchyFilterChange(filterString);
+  async onHierarchyFilterChange(textFilter: TextFilter) {
+    await this.hierarchyPresenter.applyHierarchyFilterChange(textFilter);
     this.uiData.hierarchyTrees = this.hierarchyPresenter.getAllFormattedTrees();
+    this.uiData.pinnedItems = this.hierarchyPresenter.getPinnedItems();
     this.copyUiDataAndNotifyView();
   }
 
   async onPropertiesUserOptionsChange(userOptions: UserOptions) {
-    if (!this.propertiesPresenter) {
-      return;
-    }
     this.propertiesPresenter.applyPropertiesUserOptionsChange(userOptions);
     await this.updatePropertiesTree();
     this.uiData.propertiesUserOptions =
@@ -181,11 +190,8 @@ export abstract class AbstractHierarchyViewerPresenter
     this.copyUiDataAndNotifyView();
   }
 
-  async onPropertiesFilterChange(filterString: string) {
-    if (!this.propertiesPresenter) {
-      return;
-    }
-    this.propertiesPresenter.applyPropertiesFilterChange(filterString);
+  async onPropertiesFilterChange(textFilter: TextFilter) {
+    this.propertiesPresenter.applyPropertiesFilterChange(textFilter);
     await this.updatePropertiesTree();
     this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
     this.copyUiDataAndNotifyView();
@@ -202,6 +208,62 @@ export abstract class AbstractHierarchyViewerPresenter
     this.copyUiDataAndNotifyView();
   }
 
+  protected async handleCommonWinscopeEvents(event: WinscopeEvent) {
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_SAVE_REQUEST,
+      async (event) => {
+        this.saveConfigAsPreset(event.name);
+      },
+    );
+    await event.visit(WinscopeEventType.DARK_MODE_TOGGLED, async (event) => {
+      this.uiData.isDarkMode = event.isDarkMode;
+      this.copyUiDataAndNotifyView();
+    });
+  }
+
+  protected saveConfigAsPreset(storeKey: string) {
+    const preset: PresetHierarchy = {
+      hierarchyUserOptions: this.uiData.hierarchyUserOptions,
+      hierarchyFilter: this.uiData.hierarchyFilter,
+      propertiesUserOptions: this.uiData.propertiesUserOptions,
+      propertiesFilter: this.uiData.propertiesFilter,
+      rectsUserOptions: this.uiData.rectsUserOptions,
+      rectIdToShowState: this.uiData.rectIdToShowState,
+    };
+    this.storage.add(storeKey, JSON.stringify(preset, stringifyMap));
+  }
+
+  protected async applyPresetConfig(storeKey: string) {
+    const preset = this.storage.get(storeKey);
+    if (preset) {
+      const parsedPreset: PresetHierarchy = JSON.parse(preset, parseMap);
+      await this.hierarchyPresenter.applyHierarchyUserOptionsChange(
+        parsedPreset.hierarchyUserOptions,
+      );
+      await this.hierarchyPresenter.applyHierarchyFilterChange(
+        parsedPreset.hierarchyFilter,
+      );
+
+      this.propertiesPresenter.applyPropertiesUserOptionsChange(
+        parsedPreset.propertiesUserOptions,
+      );
+      this.propertiesPresenter.applyPropertiesFilterChange(
+        parsedPreset.propertiesFilter,
+      );
+      await this.updatePropertiesTree();
+
+      if (this.rectsPresenter) {
+        this.rectsPresenter?.applyRectsUserOptionsChange(
+          assertDefined(parsedPreset.rectsUserOptions),
+        );
+        this.rectsPresenter?.updateRectShowStates(
+          parsedPreset.rectIdToShowState,
+        );
+      }
+      this.refreshHierarchyViewerUiData();
+    }
+  }
+
   protected async applyTracePositionUpdate(event: TracePositionUpdate) {
     let entries: Array<TraceEntry<HierarchyTreeNode>> = [];
     if (this.multiTraceType !== undefined) {
@@ -224,10 +286,18 @@ export abstract class AbstractHierarchyViewerPresenter
       if (entry) entries.push(entry);
     }
 
-    await this.hierarchyPresenter.applyTracePositionUpdate(
-      entries,
-      this.highlightedItem,
-    );
+    try {
+      await this.hierarchyPresenter.applyTracePositionUpdate(
+        entries,
+        this.highlightedItem,
+      );
+    } catch (e) {
+      this.hierarchyPresenter.clear();
+      this.rectsPresenter?.clear();
+      this.propertiesPresenter.clear();
+      this.refreshHierarchyViewerUiData();
+      throw e;
+    }
 
     const propertiesOpts = this.propertiesPresenter.getUserOptions();
     const hasPreviousEntry = entries.some((e) => e.getIndex() > 0);
@@ -296,18 +366,21 @@ export abstract class AbstractHierarchyViewerPresenter
     }
   }
 
-  protected refreshHierarchyViewerUiData(uiData: UiDataHierarchy) {
-    this.uiData = uiData;
+  protected refreshHierarchyViewerUiData() {
     this.uiData.highlightedItem = this.highlightedItem;
     this.uiData.pinnedItems = this.hierarchyPresenter.getPinnedItems();
     this.uiData.hierarchyUserOptions = this.hierarchyPresenter.getUserOptions();
     this.uiData.hierarchyTrees = this.hierarchyPresenter.getAllFormattedTrees();
+    this.uiData.hierarchyFilter = this.hierarchyPresenter.getTextFilter();
 
     this.uiData.propertiesUserOptions =
       this.propertiesPresenter.getUserOptions();
     this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
     this.uiData.highlightedProperty =
       this.propertiesPresenter.getHighlightedProperty();
+    this.uiData.propertiesFilter = assertDefined(
+      this.propertiesPresenter.getTextFilter(),
+    );
 
     if (this.rectsPresenter) {
       this.uiData.rectsToDraw = this.rectsPresenter?.getRectsToDraw();
@@ -324,6 +397,15 @@ export abstract class AbstractHierarchyViewerPresenter
     return this.highlightedItem;
   }
 
+  protected getEntryFormattedTimestamp(
+    entry: TraceEntry<HierarchyTreeNode>,
+  ): string {
+    if (entry.getFullTrace().isDumpWithoutTimestamp()) {
+      return 'Dump';
+    }
+    return entry.getTimestamp().format();
+  }
+
   private copyUiDataAndNotifyView() {
     // Create a shallow copy of the data, otherwise the Angular OnPush change detection strategy
     // won't detect the new input
diff --git a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
index 1c1a62f4f..751050300 100644
--- a/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
+++ b/tools/winscope/src/viewers/common/abstract_hierarchy_viewer_presenter_test.ts
@@ -15,10 +15,18 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {Rect} from 'common/rect';
-import {TracePositionUpdate} from 'messaging/winscope_event';
+import {Rect} from 'common/geometry/rect';
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {Store} from 'common/store';
+import {
+  FilterPresetApplyRequest,
+  FilterPresetSaveRequest,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
+import {TraceType} from 'trace/trace_type';
 import {
   AbstractHierarchyViewerPresenter,
   NotifyHierarchyViewCallbackType,
@@ -29,21 +37,36 @@ import {RectShowState} from 'viewers/common/rect_show_state';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {UserOptions} from 'viewers/common/user_options';
+import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
+import {ViewerEvents} from './viewer_events';
 
-export abstract class AbstractHierarchyViewerPresenterTest {
+export abstract class AbstractHierarchyViewerPresenterTest<
+  UiData extends UiDataHierarchy,
+> {
   execute() {
     describe('AbstractHierarchyViewerPresenter', () => {
       let uiData: UiDataHierarchy;
-      let presenter: AbstractHierarchyViewerPresenter;
+      let presenter: AbstractHierarchyViewerPresenter<UiData>;
+      let userNotifierChecker: UserNotifierChecker;
+      let storage: InMemoryStorage;
+
       beforeAll(async () => {
+        jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+        userNotifierChecker = new UserNotifierChecker();
         await this.setUpTestEnvironment();
       });
 
       beforeEach(() => {
+        storage = new InMemoryStorage();
         presenter = this.createPresenter((newData) => {
           uiData = newData;
-        });
+        }, storage);
+      });
+
+      afterEach(() => {
+        userNotifierChecker.expectNone();
+        userNotifierChecker.reset();
       });
 
       it('is robust to empty trace', async () => {
@@ -65,7 +88,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         expect(
           Object.keys(uiData.propertiesUserOptions).length,
         ).toBeGreaterThan(0);
-        expect(uiData.hierarchyTrees).toBeFalsy();
+        expect(uiData.hierarchyTrees).toBeUndefined();
         if (this.shouldExecuteRectTests) {
           expect(
             Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
@@ -73,7 +96,129 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         }
       });
 
+      it('clears ui data before throwing error on corrupted trace', async () => {
+        const notifyViewCallback = (newData: UiDataHierarchy) => {
+          uiData = newData;
+        };
+        const presenter =
+          this.createPresenterWithCorruptedTrace(notifyViewCallback);
+
+        try {
+          await presenter.onAppEvent(
+            TracePositionUpdate.fromTimestamp(
+              TimestampConverterUtils.makeRealTimestamp(0n),
+            ),
+          );
+        } catch (e) {
+          expect(
+            Object.keys(uiData.hierarchyUserOptions).length,
+          ).toBeGreaterThan(0);
+          expect(
+            Object.keys(uiData.propertiesUserOptions).length,
+          ).toBeGreaterThan(0);
+          expect(uiData.hierarchyTrees).toBeUndefined();
+          expect(uiData.propertiesTree).toBeUndefined();
+          expect(uiData.highlightedItem).toEqual('');
+          expect(uiData.highlightedProperty).toEqual('');
+          expect(uiData.pinnedItems.length).toEqual(0);
+          if (this.shouldExecuteRectTests) {
+            expect(
+              Object.keys(assertDefined(uiData?.rectsUserOptions)).length,
+            ).toBeGreaterThan(0);
+            expect(uiData.rectsToDraw).toEqual([]);
+            expect(uiData.rectIdToShowState).toBeUndefined();
+          }
+        }
+      });
+
+      it('adds events listeners', () => {
+        const element = document.createElement('div');
+        presenter.addEventListeners(element);
+
+        let spy: jasmine.Spy = spyOn(presenter, 'onPinnedItemChange');
+        const node = TreeNodeUtils.makeUiHierarchyNode({name: 'test'});
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HierarchyPinnedChange, {
+            detail: {pinnedItem: node},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(node);
+
+        spy = spyOn(presenter, 'onHighlightedIdChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HighlightedIdChange, {
+            detail: {id: 'test'},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith('test');
+
+        spy = spyOn(presenter, 'onHighlightedPropertyChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HighlightedPropertyChange, {
+            detail: {id: 'test'},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith('test');
+
+        spy = spyOn(presenter, 'onHierarchyUserOptionsChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HierarchyUserOptionsChange, {
+            detail: {userOptions: {}},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith({});
+
+        spy = spyOn(presenter, 'onHierarchyFilterChange');
+        const filter = new TextFilter('', []);
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HierarchyFilterChange, {detail: filter}),
+        );
+        expect(spy).toHaveBeenCalledWith(filter);
+
+        spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
+            detail: {userOptions: {}},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith({});
+
+        spy = spyOn(presenter, 'onPropertiesFilterChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.PropertiesFilterChange, {
+            detail: filter,
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(filter);
+
+        spy = spyOn(presenter, 'onHighlightedNodeChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.HighlightedNodeChange, {detail: {node}}),
+        );
+        expect(spy).toHaveBeenCalledWith(node);
+
+        if (this.shouldExecuteRectTests) {
+          spy = spyOn(presenter, 'onRectShowStateChange');
+          element.dispatchEvent(
+            new CustomEvent(ViewerEvents.RectShowStateChange, {
+              detail: {rectId: 'test', state: RectShowState.HIDE},
+            }),
+          );
+          expect(spy).toHaveBeenCalledWith('test', RectShowState.HIDE);
+
+          spy = spyOn(presenter, 'onRectsUserOptionsChange');
+          element.dispatchEvent(
+            new CustomEvent(ViewerEvents.RectsUserOptionsChange, {
+              detail: {userOptions: {}},
+            }),
+          );
+          expect(spy).toHaveBeenCalledWith({});
+        }
+      });
+
       it('processes trace position updates', async () => {
+        pinNode(this.getSelectedTree());
+
         await assertDefined(presenter).onAppEvent(
           assertDefined(this.getPositionUpdate()),
         );
@@ -88,6 +233,8 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         assertDefined(uiData.hierarchyTrees).forEach((tree) => {
           expect(tree.getAllChildren().length > 0).toBeTrue();
         });
+        expect(uiData.pinnedItems.length).toBeGreaterThan(0);
+
         if (this.shouldExecuteRectTests) {
           expect(
             Object.keys(assertDefined(uiData.rectsUserOptions)).length,
@@ -113,7 +260,32 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         });
       }
 
-      it('updates pinned items', () => {
+      if (this.shouldExecuteDumpTests) {
+        it('shows correct hierarchy tree name for entry', async () => {
+          const update = this.getPositionUpdate();
+          const spy = spyOn(
+            assertDefined(update.position.entry?.getFullTrace()),
+            'isDumpWithoutTimestamp',
+          );
+
+          spy.and.returnValue(false);
+          await presenter.onAppEvent(update);
+          const entryNode = assertDefined(uiData.hierarchyTrees?.at(0));
+          expect(entryNode.getDisplayName()).toContain(
+            update.position.timestamp.format(),
+          );
+
+          pinNode(entryNode);
+
+          spy.and.returnValue(true);
+          await presenter.onAppEvent(update);
+          const newEntryNode = assertDefined(uiData.hierarchyTrees?.at(0));
+          expect(newEntryNode.getDisplayName()).toContain('Dump');
+          expect(uiData.pinnedItems).toEqual([newEntryNode]);
+        });
+      }
+
+      it('handles pinned item change', () => {
         expect(uiData.pinnedItems).toEqual([]);
 
         const pinnedItem = TreeNodeUtils.makeUiHierarchyNode({
@@ -122,7 +294,10 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         });
 
         presenter.onPinnedItemChange(pinnedItem);
-        expect(uiData.pinnedItems).toContain(pinnedItem);
+        expect(uiData.pinnedItems).toEqual([pinnedItem]);
+
+        presenter.onPinnedItemChange(pinnedItem);
+        expect(uiData.pinnedItems).toEqual([]);
       });
 
       it('updates highlighted property', () => {
@@ -130,6 +305,8 @@ export abstract class AbstractHierarchyViewerPresenterTest {
         const id = '4';
         presenter.onHighlightedPropertyChange(id);
         expect(uiData.highlightedProperty).toEqual(id);
+        presenter.onHighlightedPropertyChange(id);
+        expect(uiData.highlightedProperty).toEqual('');
       });
 
       it('filters hierarchy tree by visibility', async () => {
@@ -152,11 +329,24 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           this.getExpectedChildrenBeforeVisibilityFilter(),
         );
 
+        const nonVisibleNode = assertDefined(
+          uiData.hierarchyTrees
+            ?.at(0)
+            ?.findDfs(
+              (node) =>
+                !node.isRoot() &&
+                !node.getEagerPropertyByName('isComputedVisible')?.getValue(),
+            ),
+        );
+        pinNode(nonVisibleNode);
+        expect(uiData.pinnedItems).toEqual([nonVisibleNode]);
+
         userOptions['showOnlyVisible'].enabled = true;
         await presenter.onHierarchyUserOptionsChange(userOptions);
         expect(this.getTotalHierarchyChildren(uiData)).toEqual(
           this.getExpectedChildrenAfterVisibilityFilter(),
         );
+        expect(uiData.pinnedItems).toEqual([nonVisibleNode]);
       });
 
       if (this.shouldExecuteFlatTreeTest) {
@@ -228,19 +418,22 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           await presenter.onAppEvent(this.getPositionUpdate());
           let nodeWithLongName = assertDefined(
             assertDefined(uiData.hierarchyTrees)[0].findDfs(
-              UiTreeUtils.makeIdFilter(longName),
+              UiTreeUtils.makeNodeFilter(longName),
             ),
           );
           expect(nodeWithLongName.getDisplayName()).toEqual(shortName);
+          pinNode(nodeWithLongName);
+          expect(uiData.pinnedItems).toEqual([nodeWithLongName]);
 
           await presenter.onHierarchyUserOptionsChange(userOptions);
           expect(uiData.hierarchyUserOptions).toEqual(userOptions);
           nodeWithLongName = assertDefined(
             assertDefined(uiData.hierarchyTrees)[0].findDfs(
-              UiTreeUtils.makeIdFilter(longName),
+              UiTreeUtils.makeNodeFilter(longName),
             ),
           );
           expect(longName).toContain(nodeWithLongName.getDisplayName());
+          expect(uiData.pinnedItems).toEqual([nodeWithLongName]);
         });
       }
 
@@ -270,10 +463,23 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           this.getExpectedHierarchyChildrenBeforeStringFilter(),
         );
 
-        await presenter.onHierarchyFilterChange(this.hierarchyFilterString);
+        const nonMatchNode = assertDefined(
+          uiData.hierarchyTrees
+            ?.at(0)
+            ?.findDfs(
+              (node) =>
+                !node.isRoot() &&
+                !node.id.includes(this.hierarchyFilter.filterString),
+            ),
+        );
+        pinNode(nonMatchNode);
+        expect(uiData.pinnedItems).toEqual([nonMatchNode]);
+
+        await presenter.onHierarchyFilterChange(this.hierarchyFilter);
         expect(this.getTotalHierarchyChildren(uiData)).toEqual(
           this.expectedHierarchyChildrenAfterStringFilter,
         );
+        expect(uiData.pinnedItems).toEqual([nonMatchNode]);
       });
 
       it('sets properties tree and associated ui data from tree node', async () => {
@@ -293,9 +499,8 @@ export abstract class AbstractHierarchyViewerPresenterTest {
 
       it('after highlighting a node, updates properties tree on position update', async () => {
         await presenter.onAppEvent(this.getPositionUpdate());
-        await presenter.onHighlightedNodeChange(
-          this.getSelectedTreeAfterPositionUpdate(),
-        );
+        const selectedTree = this.getSelectedTreeAfterPositionUpdate();
+        await presenter.onHighlightedNodeChange(selectedTree);
         this.executeChecksForPropertiesTreeAfterPositionUpdate(uiData);
 
         const secondUpdate = this.getSecondPositionUpdate();
@@ -370,7 +575,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           assertDefined(uiData.propertiesTree).getAllChildren().length,
         ).toEqual(this.numberOfNonDefaultProperties);
 
-        await presenter.onPropertiesFilterChange(this.propertiesFilterString);
+        await presenter.onPropertiesFilterChange(this.propertiesFilter);
         expect(
           assertDefined(uiData.propertiesTree).getAllChildren().length,
         ).toEqual(this.numberOfFilteredProperties);
@@ -412,7 +617,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
 
         it('filters rects by show/hide state', async () => {
           const userOptions: UserOptions = {
-            ignoreNonHidden: {
+            ignoreRectShowState: {
               name: 'Ignore',
               icon: 'visibility',
               enabled: true,
@@ -428,7 +633,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           );
           this.checkRectUiData(uiData, totalRects, totalRects, totalRects - 1);
 
-          userOptions['ignoreNonHidden'].enabled = false;
+          userOptions['ignoreRectShowState'].enabled = false;
           presenter.onRectsUserOptionsChange(userOptions);
           this.checkRectUiData(
             uiData,
@@ -440,7 +645,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
 
         it('handles both visibility and show/hide state in rects', async () => {
           const userOptions: UserOptions = {
-            ignoreNonHidden: {
+            ignoreRectShowState: {
               name: 'Ignore',
               icon: 'visibility',
               enabled: true,
@@ -461,7 +666,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           );
           this.checkRectUiData(uiData, totalRects, totalRects, totalRects - 1);
 
-          userOptions['ignoreNonHidden'].enabled = false;
+          userOptions['ignoreRectShowState'].enabled = false;
           presenter.onRectsUserOptionsChange(userOptions);
           this.checkRectUiData(
             uiData,
@@ -479,7 +684,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
             visibleRects - 1,
           );
 
-          userOptions['ignoreNonHidden'].enabled = true;
+          userOptions['ignoreRectShowState'].enabled = true;
           presenter.onRectsUserOptionsChange(userOptions);
           this.checkRectUiData(
             uiData,
@@ -494,6 +699,7 @@ export abstract class AbstractHierarchyViewerPresenterTest {
 
           const rect = assertDefined(uiData.rectsToDraw?.at(2));
           await presenter.onHighlightedIdChange(rect.id);
+          expect(uiData.highlightedItem).toEqual(rect.id);
           const propertiesTree = assertDefined(uiData.propertiesTree);
           expect(propertiesTree.id).toEqual(rect.id);
           expect(propertiesTree.getAllChildren().length).toBeGreaterThan(0);
@@ -501,6 +707,9 @@ export abstract class AbstractHierarchyViewerPresenterTest {
           if (this.executeSpecializedChecksForPropertiesFromRect) {
             this.executeSpecializedChecksForPropertiesFromRect(uiData);
           }
+
+          await presenter.onHighlightedIdChange(rect.id);
+          expect(uiData.highlightedItem).toEqual('');
         });
 
         it('after highlighting a rect, updates properties tree on position update', async () => {
@@ -518,6 +727,56 @@ export abstract class AbstractHierarchyViewerPresenterTest {
             )(uiData);
           }
         });
+      } else {
+        it('is robust to attempts to change rect user data', async () => {
+          expect(() =>
+            presenter.onRectsUserOptionsChange({}),
+          ).not.toThrowError();
+          await expectAsync(
+            presenter.onRectShowStateChange('', RectShowState.SHOW),
+          ).not.toBeRejected();
+        });
+      }
+
+      it('handles filter preset requests', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        const saveEvent = new FilterPresetSaveRequest(
+          'TestPreset',
+          TraceType.TEST_TRACE_STRING,
+        );
+        expect(storage.get(saveEvent.name)).toBeUndefined();
+        await presenter.onAppEvent(saveEvent);
+        expect(storage.get(saveEvent.name)).toBeDefined();
+
+        await presenter.onHierarchyFilterChange(
+          new TextFilter('Test Filter', []),
+        );
+        await presenter.onHierarchyUserOptionsChange({});
+        await presenter.onPropertiesUserOptionsChange({});
+        await presenter.onPropertiesFilterChange(
+          new TextFilter('Test Filter', []),
+        );
+
+        if (this.shouldExecuteRectTests) {
+          presenter.onRectsUserOptionsChange({});
+          await presenter.onRectShowStateChange(
+            assertDefined(uiData.rectsToDraw)[0].id,
+            RectShowState.HIDE,
+          );
+        }
+        const currentUiData = uiData;
+
+        const applyEvent = new FilterPresetApplyRequest(
+          saveEvent.name,
+          TraceType.TEST_TRACE_STRING,
+        );
+        await presenter.onAppEvent(applyEvent);
+        expect(uiData).not.toEqual(currentUiData);
+      });
+
+      function pinNode(node: UiHierarchyTreeNode) {
+        presenter.onPinnedItemChange(node);
+        expect(uiData.pinnedItems).toEqual([node]);
       }
     });
 
@@ -553,12 +812,13 @@ export abstract class AbstractHierarchyViewerPresenterTest {
   abstract readonly shouldExecuteFlatTreeTest: boolean;
   abstract readonly shouldExecuteRectTests: boolean;
   abstract readonly shouldExecuteShowDiffTests: boolean;
+  abstract readonly shouldExecuteDumpTests: boolean;
   abstract readonly shouldExecuteSimplifyNamesTest: boolean;
   abstract readonly numberOfDefaultProperties: number;
   abstract readonly numberOfNonDefaultProperties: number;
-  abstract readonly propertiesFilterString: string;
+  abstract readonly propertiesFilter: TextFilter;
   abstract readonly numberOfFilteredProperties: number;
-  abstract readonly hierarchyFilterString: string;
+  abstract readonly hierarchyFilter: TextFilter;
   abstract readonly expectedHierarchyChildrenAfterStringFilter: number;
 
   readonly expectedFirstRect?: Rect;
@@ -571,11 +831,15 @@ export abstract class AbstractHierarchyViewerPresenterTest {
 
   abstract setUpTestEnvironment(): Promise<void>;
   abstract createPresenter(
-    callback: NotifyHierarchyViewCallbackType,
-  ): AbstractHierarchyViewerPresenter;
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+    storage: Store,
+  ): AbstractHierarchyViewerPresenter<UiData>;
   abstract createPresenterWithEmptyTrace(
-    callback: NotifyHierarchyViewCallbackType,
-  ): AbstractHierarchyViewerPresenter;
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+  ): AbstractHierarchyViewerPresenter<UiData>;
+  abstract createPresenterWithCorruptedTrace(
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+  ): AbstractHierarchyViewerPresenter<UiData>;
   abstract getPositionUpdate(): TracePositionUpdate;
   abstract getSecondPositionUpdate(): TracePositionUpdate | undefined;
   abstract getShowDiffPositionUpdate(): TracePositionUpdate;
diff --git a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts
new file mode 100644
index 000000000..0bfde591e
--- /dev/null
+++ b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter.ts
@@ -0,0 +1,258 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FunctionUtils} from 'common/function_utils';
+import {Timestamp} from 'common/time';
+import {
+  TracePositionUpdate,
+  WinscopeEvent,
+  WinscopeEventType,
+} from 'messaging/winscope_event';
+import {
+  EmitEvent,
+  WinscopeEventEmitter,
+} from 'messaging/winscope_event_emitter';
+import {Trace, TraceEntry} from 'trace/trace';
+import {TraceEntryFinder} from 'trace/trace_entry_finder';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {UserOptions} from 'viewers/common/user_options';
+import {LogPresenter} from './log_presenter';
+import {TextFilter} from './text_filter';
+import {LogEntry, LogFieldType, UiDataLog} from './ui_data_log';
+import {
+  LogFilterChangeDetail,
+  LogTextFilterChangeDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from './viewer_events';
+
+export type NotifyLogViewCallbackType<UiData> = (uiData: UiData) => void;
+
+export abstract class AbstractLogViewerPresenter<UiData extends UiDataLog>
+  implements WinscopeEventEmitter
+{
+  protected emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
+  protected abstract logPresenter: LogPresenter<LogEntry>;
+  protected propertiesPresenter?: PropertiesPresenter;
+  protected keepCalculated?: boolean;
+
+  protected constructor(
+    protected readonly trace: Trace<PropertyTreeNode>,
+    private readonly notifyViewCallback: NotifyLogViewCallbackType<UiData>,
+    protected readonly uiData: UiData,
+  ) {
+    this.notifyViewChanged();
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.emitAppEvent = callback;
+  }
+
+  addEventListeners(htmlElement: HTMLElement) {
+    htmlElement.addEventListener(
+      ViewerEvents.LogFilterChange,
+      async (event) => {
+        const detail: LogFilterChangeDetail = (event as CustomEvent).detail;
+        await this.onFilterChange(detail.type, detail.value);
+      },
+    );
+    htmlElement.addEventListener(
+      ViewerEvents.LogTextFilterChange,
+      async (event) => {
+        const detail: LogTextFilterChangeDetail = (event as CustomEvent).detail;
+        await this.onTextFilterChange(detail.type, detail.filter);
+      },
+    );
+    htmlElement.addEventListener(ViewerEvents.LogEntryClick, async (event) => {
+      await this.onLogEntryClick((event as CustomEvent).detail);
+    });
+    htmlElement.addEventListener(
+      ViewerEvents.ArrowDownPress,
+      async (event) => await this.onArrowDownPress(),
+    );
+    htmlElement.addEventListener(
+      ViewerEvents.ArrowUpPress,
+      async (event) => await this.onArrowUpPress(),
+    );
+    htmlElement.addEventListener(ViewerEvents.TimestampClick, async (event) => {
+      const detail: TimestampClickDetail = (event as CustomEvent).detail;
+      if (detail.entry !== undefined) {
+        await this.onLogTimestampClick(detail.entry);
+      } else if (detail.timestamp !== undefined) {
+        await this.onRawTimestampClick(detail.timestamp);
+      }
+    });
+    htmlElement.addEventListener(
+      ViewerEvents.PropertiesUserOptionsChange,
+      (event) =>
+        this.onPropertiesUserOptionsChange(
+          (event as CustomEvent).detail.userOptions,
+        ),
+    );
+  }
+
+  async onAppEvent(event: WinscopeEvent) {
+    await event.visit(
+      WinscopeEventType.TRACE_POSITION_UPDATE,
+      async (event) => {
+        await this.applyTracePositionUpdate(event);
+      },
+    );
+    await event.visit(WinscopeEventType.DARK_MODE_TOGGLED, async (event) => {
+      this.uiData.isDarkMode = event.isDarkMode;
+      this.notifyViewChanged();
+    });
+  }
+
+  async onFilterChange(type: LogFieldType, value: string[] | string) {
+    this.logPresenter.applyFilterChange(type, value);
+    await this.updatePropertiesTree();
+    this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
+    this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex =
+      this.logPresenter.getCurrentIndex() ??
+      this.logPresenter.getSelectedIndex();
+    this.uiData.entries = this.logPresenter.getFilteredEntries();
+    this.notifyViewChanged();
+  }
+
+  async onTextFilterChange(type: LogFieldType, filter: TextFilter) {
+    this.logPresenter.applyTextFilterChange(type, filter);
+    await this.updatePropertiesTree();
+    this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
+    this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex =
+      this.logPresenter.getCurrentIndex() ??
+      this.logPresenter.getSelectedIndex();
+    this.uiData.entries = this.logPresenter.getFilteredEntries();
+    this.notifyViewChanged();
+  }
+
+  async onPropertiesUserOptionsChange(userOptions: UserOptions) {
+    if (!this.propertiesPresenter) {
+      return;
+    }
+    this.propertiesPresenter.applyPropertiesUserOptionsChange(userOptions);
+    this.uiData.propertiesUserOptions =
+      this.propertiesPresenter.getUserOptions();
+    await this.updatePropertiesTree();
+    this.notifyViewChanged();
+  }
+
+  async onLogTimestampClick(traceEntry: TraceEntry<PropertyTreeNode>) {
+    await this.emitAppEvent(
+      TracePositionUpdate.fromTraceEntry(traceEntry, true),
+    );
+  }
+
+  async onRawTimestampClick(timestamp: Timestamp) {
+    await this.emitAppEvent(TracePositionUpdate.fromTimestamp(timestamp, true));
+  }
+
+  async onLogEntryClick(index: number) {
+    this.logPresenter.applyLogEntryClick(index);
+    this.updateIndicesUiData();
+    await this.updatePropertiesTree();
+    this.notifyViewChanged();
+  }
+
+  async onArrowDownPress() {
+    this.logPresenter.applyArrowDownPress();
+    this.updateIndicesUiData();
+    await this.updatePropertiesTree();
+    this.notifyViewChanged();
+  }
+
+  async onArrowUpPress() {
+    this.logPresenter.applyArrowUpPress();
+    this.updateIndicesUiData();
+    await this.updatePropertiesTree();
+    this.notifyViewChanged();
+  }
+
+  protected refreshUiData() {
+    this.uiData.headers = this.logPresenter.getHeaders();
+    this.uiData.filters = this.logPresenter.getFilters();
+    this.uiData.entries = this.logPresenter.getFilteredEntries();
+    this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
+    this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
+    if (this.propertiesPresenter) {
+      this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
+      this.uiData.propertiesUserOptions =
+        this.propertiesPresenter.getUserOptions();
+    }
+  }
+
+  protected async applyTracePositionUpdate(event: TracePositionUpdate) {
+    await this.initializeIfNeeded();
+    const entry = TraceEntryFinder.findCorrespondingEntry(
+      this.trace,
+      event.position,
+    );
+    this.logPresenter.applyTracePositionUpdate(entry);
+
+    this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
+    this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
+    this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
+
+    if (this.propertiesPresenter) {
+      await this.updatePropertiesTree();
+      this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
+    }
+
+    this.notifyViewChanged();
+  }
+
+  protected async updatePropertiesTree() {
+    if (this.propertiesPresenter) {
+      const tree = this.getPropertiesTree();
+      this.propertiesPresenter.setPropertiesTree(tree);
+      await this.propertiesPresenter.formatPropertiesTree(
+        undefined,
+        undefined,
+        this.keepCalculated ?? false,
+      );
+      this.uiData.propertiesTree = this.propertiesPresenter.getFormattedTree();
+    }
+  }
+
+  private updateIndicesUiData() {
+    this.uiData.selectedIndex = this.logPresenter.getSelectedIndex();
+    this.uiData.currentIndex = this.logPresenter.getCurrentIndex();
+    this.uiData.scrollToIndex = this.logPresenter.getScrollToIndex();
+  }
+
+  private getPropertiesTree(): PropertyTreeNode | undefined {
+    const entries = this.logPresenter.getFilteredEntries();
+    const selectedIndex = this.logPresenter.getSelectedIndex();
+    const currentIndex = this.logPresenter.getCurrentIndex();
+    if (selectedIndex !== undefined) {
+      return entries.at(selectedIndex)?.propertiesTree;
+    }
+    if (currentIndex !== undefined) {
+      return entries.at(currentIndex)?.propertiesTree;
+    }
+    return undefined;
+  }
+
+  protected notifyViewChanged() {
+    this.notifyViewCallback(this.uiData);
+  }
+
+  protected abstract initializeIfNeeded(): Promise<void>;
+}
diff --git a/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts
new file mode 100644
index 000000000..11c10b360
--- /dev/null
+++ b/tools/winscope/src/viewers/common/abstract_log_viewer_presenter_test.ts
@@ -0,0 +1,469 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TracePositionUpdate} from 'messaging/winscope_event';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from './abstract_log_viewer_presenter';
+import {TextFilter} from './text_filter';
+import {LogEntry, LogFieldType, LogFieldValue, UiDataLog} from './ui_data_log';
+import {
+  LogFilterChangeDetail,
+  LogTextFilterChangeDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from './viewer_events';
+
+export abstract class AbstractLogViewerPresenterTest<UiData extends UiDataLog> {
+  execute() {
+    describe('AbstractLogViewerPresenterTest', () => {
+      let uiData: UiData;
+      let presenter: AbstractLogViewerPresenter<UiData>;
+      beforeAll(async () => {
+        await this.setUpTestEnvironment();
+      });
+
+      beforeEach(async () => {
+        presenter = await this.createPresenter((newData) => {
+          uiData = newData;
+        });
+      });
+
+      it('is robust to empty trace', async () => {
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        const presenter = await this.createPresenterWithEmptyTrace(
+          notifyViewCallback,
+        );
+
+        const positionUpdateWithoutTraceEntry =
+          TracePositionUpdate.fromTimestamp(
+            TimestampConverterUtils.makeRealTimestamp(0n),
+          );
+        await presenter.onAppEvent(positionUpdateWithoutTraceEntry);
+
+        expect(uiData.entries).toEqual([]);
+        expect(uiData.selectedIndex).toBeUndefined();
+        expect(uiData.scrollToIndex).toBeUndefined();
+        expect(uiData.currentIndex).toBeUndefined();
+
+        if (this.shouldExecuteFilterTests) {
+          expect(uiData.filters?.length).toBeGreaterThan(0);
+        }
+
+        if (this.shouldExecuteHeaderTests) {
+          expect(uiData.headers?.length).toBeGreaterThan(0);
+        }
+
+        if (this.shouldExecutePropertiesTests) {
+          expect(uiData.propertiesTree).toBeUndefined();
+          expect(uiData.propertiesUserOptions).toBeDefined();
+          if (this.executePropertiesChecksForEmptyTrace) {
+            this.executePropertiesChecksForEmptyTrace(uiData);
+          }
+        }
+      });
+
+      it('adds events listeners', async () => {
+        const element = document.createElement('div');
+        presenter.addEventListeners(element);
+
+        let spy: jasmine.Spy = spyOn(presenter, 'onFilterChange');
+        const filterDetail = new LogFilterChangeDetail(
+          LogFieldType.CUJ_TYPE,
+          '',
+        );
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.LogFilterChange, {
+            detail: filterDetail,
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(filterDetail.type, filterDetail.value);
+
+        spy = spyOn(presenter, 'onTextFilterChange');
+        const textFilterDetail = new LogTextFilterChangeDetail(
+          LogFieldType.CUJ_TYPE,
+          new TextFilter('', []),
+        );
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.LogTextFilterChange, {
+            detail: textFilterDetail,
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(
+          textFilterDetail.type,
+          textFilterDetail.filter,
+        );
+
+        spy = spyOn(presenter, 'onLogEntryClick');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.LogEntryClick, {
+            detail: 0,
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(0);
+
+        spy = spyOn(presenter, 'onArrowDownPress');
+        element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowDownPress));
+        expect(spy).toHaveBeenCalled();
+
+        spy = spyOn(presenter, 'onArrowUpPress');
+        element.dispatchEvent(new CustomEvent(ViewerEvents.ArrowUpPress));
+        expect(spy).toHaveBeenCalled();
+
+        await presenter.onAppEvent(this.getPositionUpdate());
+        spy = spyOn(presenter, 'onLogTimestampClick');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.TimestampClick, {
+            detail: new TimestampClickDetail(uiData.entries[0].traceEntry),
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(uiData.entries[0].traceEntry);
+
+        spy = spyOn(presenter, 'onRawTimestampClick');
+        const ts = TimestampConverterUtils.makeZeroTimestamp();
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.TimestampClick, {
+            detail: new TimestampClickDetail(undefined, ts),
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith(ts);
+
+        spy = spyOn(presenter, 'onPropertiesUserOptionsChange');
+        element.dispatchEvent(
+          new CustomEvent(ViewerEvents.PropertiesUserOptionsChange, {
+            detail: {userOptions: {}},
+          }),
+        );
+        expect(spy).toHaveBeenCalledWith({});
+      });
+
+      it('processes trace position updates', async () => {
+        await assertDefined(presenter).onAppEvent(
+          assertDefined(this.getPositionUpdate()),
+        );
+        expect(uiData.scrollToIndex).toEqual(
+          this.expectedIndexOfFirstPositionUpdate,
+        );
+        expect(uiData.currentIndex).toEqual(
+          this.expectedIndexOfFirstPositionUpdate,
+        );
+        expect(uiData.selectedIndex).toBeUndefined();
+        expect(uiData.entries.length).toEqual(this.totalOutputEntries);
+
+        if (this.shouldExecutePropertiesTests) {
+          expect(assertDefined(uiData.propertiesTree).id).toEqual(
+            assertDefined(uiData.entries[0].propertiesTree).id,
+          );
+          if (this.executePropertiesChecksAfterPositionUpdate) {
+            this.executePropertiesChecksAfterPositionUpdate(uiData);
+          }
+        }
+
+        if (this.shouldExecuteFilterTests) {
+          for (const [logFieldType, expectedOptions] of assertDefined(
+            this.expectedInitialFilterOptions,
+          )) {
+            const options = assertDefined(
+              uiData.filters?.find((f) => f.type === logFieldType)?.options,
+            );
+            if (Array.isArray(expectedOptions)) {
+              expect(options).toEqual(expectedOptions);
+            } else {
+              expect(options.length).toEqual(expectedOptions);
+            }
+          }
+        }
+      });
+
+      it('processes trace position update and updates current entry and scroll position', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        this.checkInitialTracePositionUpdate(uiData);
+
+        await presenter.onAppEvent(this.getSecondPositionUpdate());
+        expect(uiData.currentIndex).toEqual(
+          this.expectedIndexOfSecondPositionUpdate,
+        );
+        expect(uiData.selectedIndex).toBeUndefined();
+
+        if (this.shouldExecutePropertiesTests) {
+          expect(assertDefined(uiData.propertiesTree).id).toEqual(
+            assertDefined(
+              uiData.entries[this.expectedIndexOfSecondPositionUpdate]
+                .propertiesTree,
+            ).id,
+          );
+        }
+      });
+
+      if (this.shouldExecuteFilterTests) {
+        it('filters entries', async () => {
+          for (const [type, valuesToSet] of assertDefined(
+            this.filterValuesToSet,
+          )) {
+            const expected = assertDefined(
+              this.expectedFieldValuesAfterFilter?.get(type),
+            );
+            for (let i = 0; i < valuesToSet.length; i++) {
+              const filterValues = valuesToSet[i];
+              const expectedFieldValues = expected[i];
+
+              await presenter.onFilterChange(type, filterValues);
+              const fieldValues = uiData.entries.map((entry) =>
+                assertDefined(this.getFieldValue(entry, type)),
+              );
+              if (Array.isArray(expectedFieldValues)) {
+                expect(new Set(fieldValues)).toEqual(
+                  new Set(expectedFieldValues),
+                );
+              } else {
+                expect(fieldValues.length).toEqual(expectedFieldValues);
+              }
+              await presenter.onFilterChange(type, []);
+            }
+          }
+        });
+
+        it('updates indices when filters change', async () => {
+          await presenter.onAppEvent(this.getSecondPositionUpdate());
+          const filterName = assertDefined(this.filterNameForCurrentIndexTest);
+          await presenter.onFilterChange(filterName, []);
+          expect(uiData.currentIndex).toEqual(
+            this.expectedIndexOfSecondPositionUpdate,
+          );
+          expect(uiData.scrollToIndex).toEqual(
+            this.expectedIndexOfSecondPositionUpdate,
+          );
+          expect(uiData.selectedIndex).toEqual(undefined);
+
+          const finalEntryIndex = uiData.entries.length - 1;
+          await presenter.onLogEntryClick(finalEntryIndex);
+          expect(uiData.selectedIndex).toEqual(finalEntryIndex);
+
+          await presenter.onFilterChange(
+            filterName,
+            assertDefined(this.filterChangeForCurrentIndexTest),
+          );
+          expect(uiData.currentIndex).toEqual(
+            this.expectedCurrentIndexAfterFilterChange,
+          );
+          expect(uiData.scrollToIndex).toEqual(
+            this.expectedCurrentIndexAfterFilterChange,
+          );
+
+          let expectedSelectedIndex =
+            finalEntryIndex <= uiData.entries.length - 1
+              ? finalEntryIndex
+              : this.expectedCurrentIndexAfterFilterChange;
+          expect(uiData.selectedIndex).toEqual(expectedSelectedIndex);
+
+          await presenter.onFilterChange(
+            filterName,
+            assertDefined(this.secondFilterChangeForCurrentIndexTest),
+          );
+          expect(uiData.currentIndex).toEqual(
+            this.expectedCurrentIndexAfterSecondFilterChange,
+          );
+          expect(uiData.scrollToIndex).toEqual(
+            this.expectedCurrentIndexAfterSecondFilterChange,
+          );
+
+          const prevStillValid =
+            expectedSelectedIndex !== undefined &&
+            expectedSelectedIndex <= uiData.entries.length - 1;
+          expectedSelectedIndex = prevStillValid
+            ? expectedSelectedIndex
+            : this.expectedCurrentIndexAfterSecondFilterChange;
+          expect(uiData.selectedIndex).toEqual(expectedSelectedIndex);
+        });
+      }
+
+      it('updates selected entry ui data when entry clicked', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        this.checkInitialTracePositionUpdate(uiData);
+
+        await presenter.onLogEntryClick(this.logEntryClickIndex);
+        this.checkSelectedEntryUiData(uiData, this.logEntryClickIndex);
+        expect(uiData.scrollToIndex).toEqual(undefined); // no scrolling
+
+        // does not remove selection when entry clicked again
+        await presenter.onLogEntryClick(this.logEntryClickIndex);
+        this.checkSelectedEntryUiData(uiData, this.logEntryClickIndex);
+        expect(uiData.scrollToIndex).toEqual(undefined); // no scrolling
+      });
+
+      it('updates selected entry ui data when entry changed by key press', async () => {
+        await presenter.onLogEntryClick(0);
+
+        await presenter.onArrowDownPress();
+        this.checkSelectedAndScrollIndices(uiData, 1);
+
+        await presenter.onArrowUpPress();
+        this.checkSelectedAndScrollIndices(uiData, 0);
+
+        // robust to attempt to go before first entry
+        await presenter.onArrowUpPress();
+        this.checkSelectedAndScrollIndices(uiData, 0);
+
+        // robust to attempt to go beyond last entry
+        const finalIndex = uiData.entries.length - 1;
+        await presenter.onLogEntryClick(finalIndex);
+        await presenter.onArrowDownPress();
+        expect(uiData.selectedIndex).toEqual(finalIndex);
+      });
+
+      it('computes index based on trace position update', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.currentIndex).toEqual(
+          this.expectedIndexOfFirstPositionUpdate,
+        );
+
+        await presenter.onAppEvent(this.getSecondPositionUpdate());
+        expect(uiData.currentIndex).toEqual(
+          this.expectedIndexOfSecondPositionUpdate,
+        );
+      });
+
+      it('emits event on log timestamp click', async () => {
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+
+        await presenter.onLogTimestampClick(uiData.entries[0].traceEntry);
+        expect(spy).toHaveBeenCalledWith(
+          TracePositionUpdate.fromTraceEntry(
+            uiData.entries[0].traceEntry,
+            true,
+          ),
+        );
+      });
+
+      it('emits event on raw timestamp click', async () => {
+        const spy = jasmine.createSpy();
+        presenter.setEmitEvent(spy);
+
+        const ts = TimestampConverterUtils.makeZeroTimestamp();
+        await presenter.onRawTimestampClick(ts);
+        expect(spy).toHaveBeenCalledWith(
+          TracePositionUpdate.fromTimestamp(ts, true),
+        );
+      });
+
+      if (!this.shouldExecutePropertiesTests) {
+        it('is robust to attempts to change properties', async () => {
+          await presenter.onAppEvent(this.getPositionUpdate());
+          await presenter.onLogEntryClick(this.logEntryClickIndex);
+
+          await presenter.onPropertiesUserOptionsChange({});
+          expect(uiData.propertiesUserOptions).toBeUndefined();
+          expect(uiData.propertiesTree).toBeUndefined();
+        });
+      }
+    });
+
+    if (this.executeSpecializedTests) {
+      this.executeSpecializedTests();
+    }
+  }
+
+  checkInitialTracePositionUpdate(uiData: UiDataLog) {
+    expect(uiData.entries.length).toEqual(this.totalOutputEntries);
+    expect(uiData.scrollToIndex).toEqual(
+      this.expectedIndexOfFirstPositionUpdate,
+    );
+    expect(uiData.currentIndex).toEqual(
+      this.expectedIndexOfFirstPositionUpdate,
+    );
+    expect(uiData.selectedIndex).toBeUndefined();
+
+    if (this.shouldExecuteFilterTests) {
+      expect(uiData.filters?.length).toBeGreaterThan(0);
+    }
+
+    if (this.shouldExecuteHeaderTests) {
+      expect(uiData.headers?.length).toBeGreaterThan(0);
+    }
+
+    if (this.shouldExecutePropertiesTests) {
+      expect(uiData.propertiesTree).toBeDefined();
+      expect(uiData.propertiesUserOptions).toBeDefined();
+    }
+  }
+
+  getFieldValue(entry: LogEntry, logFieldType: LogFieldType) {
+    return entry.fields.find((f) => f.type === logFieldType)?.value;
+  }
+
+  checkSelectedEntryUiData(uiData: UiDataLog, newIndex: number | undefined) {
+    expect(uiData.selectedIndex).toEqual(newIndex);
+    expect(uiData.currentIndex).toEqual(
+      this.expectedIndexOfFirstPositionUpdate,
+    );
+
+    if (this.shouldExecutePropertiesTests) {
+      if (newIndex !== undefined) {
+        expect(assertDefined(uiData.propertiesTree).id).toEqual(
+          assertDefined(uiData.entries[newIndex].propertiesTree).id,
+        );
+      } else {
+        expect(uiData.propertiesTree).toBeUndefined();
+      }
+    }
+  }
+
+  checkSelectedAndScrollIndices(uiData: UiDataLog, index: number | undefined) {
+    this.checkSelectedEntryUiData(uiData, index);
+    expect(uiData.scrollToIndex).toEqual(index);
+  }
+
+  abstract readonly shouldExecuteHeaderTests: boolean;
+  abstract readonly shouldExecuteFilterTests: boolean;
+  abstract readonly shouldExecutePropertiesTests: boolean;
+
+  abstract readonly totalOutputEntries: number;
+  abstract readonly expectedIndexOfFirstPositionUpdate: number;
+  abstract readonly expectedIndexOfSecondPositionUpdate: number;
+  abstract readonly logEntryClickIndex: number;
+
+  readonly expectedInitialFilterOptions?: Map<LogFieldType, string[] | number>;
+  readonly filterValuesToSet?: Map<LogFieldType, Array<string[] | string>>;
+  readonly expectedFieldValuesAfterFilter?: Map<
+    LogFieldType,
+    Array<LogFieldValue[] | number>
+  >;
+  readonly filterNameForCurrentIndexTest?: LogFieldType;
+  readonly filterChangeForCurrentIndexTest?: string[];
+  readonly expectedCurrentIndexAfterFilterChange?: number;
+  readonly secondFilterChangeForCurrentIndexTest?: string[];
+  readonly expectedCurrentIndexAfterSecondFilterChange?: number;
+
+  abstract setUpTestEnvironment(): Promise<void>;
+  abstract createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<AbstractLogViewerPresenter<UiData>>;
+  abstract createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<AbstractLogViewerPresenter<UiData>>;
+  abstract getPositionUpdate(): TracePositionUpdate;
+  abstract getSecondPositionUpdate(): TracePositionUpdate;
+
+  executePropertiesChecksForEmptyTrace?(uiData: UiDataLog): void;
+  executePropertiesChecksAfterPositionUpdate?(uiData: UiDataLog): void;
+  executeSpecializedTests?(): void;
+}
diff --git a/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts b/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
index 652cb7d77..caa65034a 100644
--- a/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
+++ b/tools/winscope/src/viewers/common/abstract_presenter_input_method.ts
@@ -16,6 +16,7 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {Timestamp} from 'common/time';
 import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
 import {Trace, TraceEntry} from 'trace/trace';
@@ -39,17 +40,19 @@ import {
 } from './abstract_hierarchy_viewer_presenter';
 import {VISIBLE_CHIP} from './chip';
 import {HierarchyPresenter} from './hierarchy_presenter';
+import {UpdateSfSubtreeDisplayNames} from './operations/update_sf_subtree_display_names';
 import {PropertiesPresenter} from './properties_presenter';
+import {TextFilter} from './text_filter';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiTreeUtils} from './ui_tree_utils';
 
-export abstract class AbstractPresenterInputMethod extends AbstractHierarchyViewerPresenter {
+export abstract class AbstractPresenterInputMethod extends AbstractHierarchyViewerPresenter<ImeUiData> {
   protected getHierarchyTreeNameStrategy = (
     entry: TraceEntry<HierarchyTreeNode>,
     tree: HierarchyTreeNode,
   ) => {
     const where = tree.getEagerPropertyByName('where')?.formattedValue();
-    return entry.getTimestamp().format() + ' - ' + where;
+    return this.getEntryFormattedTimestamp(entry) + ' - ' + where;
   };
   protected override hierarchyPresenter = new HierarchyPresenter(
     PersistentStoreProxy.new<UserOptions>(
@@ -71,10 +74,16 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'ImeHierarchyFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     [],
     true,
     false,
     this.getHierarchyTreeNameStrategy,
+    [[TraceType.SURFACE_FLINGER, [new UpdateSfSubtreeDisplayNames()]]],
   );
   protected override propertiesPresenter = new PropertiesPresenter(
     PersistentStoreProxy.new<UserOptions>(
@@ -92,6 +101,11 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'ImePropertiesFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     [],
   );
   protected override multiTraceType = undefined;
@@ -106,8 +120,8 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
   constructor(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
-    notifyViewCallback: NotifyHierarchyViewCallbackType,
+    storage: Store,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<ImeUiData>,
   ) {
     super(
       trace,
@@ -122,6 +136,7 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
   }
 
   async onAppEvent(event: WinscopeEvent) {
+    await this.handleCommonWinscopeEvents(event);
     await event.visit(
       WinscopeEventType.TRACE_POSITION_UPDATE,
       async (event) => {
@@ -173,6 +188,14 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
         this.refreshUIData();
       },
     );
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        const filterPresetName = event.name;
+        await this.applyPresetConfig(filterPresetName);
+        this.refreshUIData();
+      },
+    );
   }
 
   async onHighlightedNodeChange(node: UiHierarchyTreeNode) {
@@ -366,13 +389,9 @@ export abstract class AbstractPresenterInputMethod extends AbstractHierarchyView
   }
 
   private refreshUIData() {
-    this.refreshHierarchyViewerUiData(
-      new ImeUiData(
-        this.imeTrace.type as ImeTraceType,
-        this.hierarchyTableProperties,
-        this.additionalProperties,
-      ),
-    );
+    this.uiData.hierarchyTableProperties = this.hierarchyTableProperties;
+    this.uiData.additionalProperties = this.additionalProperties;
+    this.refreshHierarchyViewerUiData();
   }
 
   protected abstract getHierarchyTableProperties(): TableProperties;
diff --git a/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts b/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
index 0e6d280c9..afb4bf46a 100644
--- a/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
+++ b/tools/winscope/src/viewers/common/abstract_presenter_input_method_test.ts
@@ -16,9 +16,11 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {InMemoryStorage} from 'common/in_memory_storage';
+import {Store} from 'common/store';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {TreeNodeUtils} from 'test/unit/tree_node_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Traces} from 'trace/traces';
 import {ImeTraceType, TraceType} from 'trace/trace_type';
@@ -31,11 +33,12 @@ import {PresenterInputMethodService} from 'viewers/viewer_input_method_service/p
 import {NotifyHierarchyViewCallbackType} from './abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from './abstract_hierarchy_viewer_presenter_test';
 import {AbstractPresenterInputMethod} from './abstract_presenter_input_method';
+import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 
-export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchyViewerPresenterTest {
+export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchyViewerPresenterTest<ImeUiData> {
   private traces: Traces | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
   private secondPositionUpdate: TracePositionUpdate | undefined;
@@ -45,9 +48,10 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
   override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = false;
   override readonly shouldExecuteShowDiffTests = false;
+  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = false;
 
-  override readonly hierarchyFilterString = 'Reject all';
+  override readonly hierarchyFilter = new TextFilter('Reject all', []);
   override readonly expectedHierarchyChildrenAfterStringFilter = 0;
 
   override async setUpTestEnvironment(): Promise<void> {
@@ -99,7 +103,7 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
   }
 
   override createPresenterWithEmptyTrace(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<ImeUiData>,
   ): AbstractPresenterInputMethod {
     const trace = new TraceBuilder<HierarchyTreeNode>()
       .setType(this.imeTraceType)
@@ -114,12 +118,16 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
       callback,
     );
   }
-
-  override createPresenter(
-    callback: NotifyHierarchyViewCallbackType,
+  override createPresenterWithCorruptedTrace(
+    callback: NotifyHierarchyViewCallbackType<ImeUiData>,
   ): AbstractPresenterInputMethod {
-    const traces = assertDefined(this.traces);
-    const trace = assertDefined(traces.getTrace(this.imeTraceType));
+    const trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(this.imeTraceType)
+      .setEntries([assertDefined(this.selectedTree)])
+      .setIsCorrupted(true)
+      .build();
+    const traces = new Traces();
+    traces.addTrace(trace);
     return new this.PresenterInputMethod(
       trace,
       traces,
@@ -128,6 +136,15 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
     );
   }
 
+  override createPresenter(
+    callback: NotifyHierarchyViewCallbackType<ImeUiData>,
+    storage: Store,
+  ): AbstractPresenterInputMethod {
+    const traces = assertDefined(this.traces);
+    const trace = assertDefined(traces.getTrace(this.imeTraceType));
+    return new this.PresenterInputMethod(trace, traces, storage, callback);
+  }
+
   override getPositionUpdate(): TracePositionUpdate {
     return assertDefined(this.positionUpdate);
   }
@@ -193,9 +210,11 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
         | typeof PresenterInputMethodService
         | typeof PresenterInputMethodManagerService;
       let imeTraceType: ImeTraceType;
+      let userNotifierChecker: UserNotifierChecker;
 
       beforeAll(async () => {
         jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
+        userNotifierChecker = new UserNotifierChecker();
         Presenter = this.PresenterInputMethod;
         imeTraceType = this.imeTraceType;
         await this.setUpTestEnvironment();
@@ -203,6 +222,11 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
         await loadTraces();
       });
 
+      afterEach(() => {
+        userNotifierChecker.expectNone();
+        userNotifierChecker.reset();
+      });
+
       it('is robust to traces without SF', async () => {
         setUpPresenter([imeTraceType, TraceType.WINDOW_MANAGER]);
         await presenter.onAppEvent(this.getPositionUpdate());
@@ -235,9 +259,26 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
           name: 'Test Tree',
           treeNode: this.getSelectedTree(),
         });
+        expect(assertDefined(uiData.propertiesTree).getDisplayName()).toEqual(
+          'Test Tree',
+        );
+        expect(uiData.highlightedItem).toEqual(this.getSelectedTree().id);
+      });
+
+      it('can set new properties tree and associated ui data from id', async () => {
+        setUpPresenter([imeTraceType, TraceType.WINDOW_MANAGER]);
+        expect(uiData.propertiesTree).toBeUndefined();
+        await presenter.onAppEvent(this.getPositionUpdate());
+
+        const selectedTree = this.getSelectedTree();
+        await presenter.onHighlightedIdChange(selectedTree.id);
         const propertiesTree = assertDefined(uiData.propertiesTree);
-        expect(propertiesTree.getDisplayName()).toEqual('Test Tree');
+        expect(propertiesTree.getDisplayName()).toEqual(selectedTree.name);
         expect(uiData.highlightedItem).toEqual(this.getSelectedTree().id);
+
+        await presenter.onHighlightedIdChange(selectedTree.id);
+        expect(uiData.propertiesTree).toEqual(propertiesTree);
+        expect(uiData.highlightedItem).toEqual('');
       });
 
       if (this.getPropertiesTree) {
@@ -261,6 +302,13 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
             UiPropertyTreeNode.from(selectedPropertyTree),
           );
           expect(uiData.highlightedItem).toEqual(selectedPropertyTree.id);
+
+          // clears additional property tree selection
+          const selectedTree = this.getSelectedTree();
+          await presenter.onHighlightedIdChange(selectedTree.id);
+          expect(uiData.propertiesTree?.getDisplayName()).toEqual(
+            selectedTree.name,
+          );
         });
       }
 
@@ -286,7 +334,7 @@ export abstract class AbstractPresenterInputMethodTest extends AbstractHierarchy
           trace,
           traces,
           new InMemoryStorage(),
-          callback as NotifyHierarchyViewCallbackType,
+          callback as NotifyHierarchyViewCallbackType<ImeUiData>,
         );
       }
 
diff --git a/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts b/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
index d0bb30f98..6b8de264a 100644
--- a/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
+++ b/tools/winscope/src/viewers/common/abstract_viewer_input_method.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
@@ -22,7 +23,6 @@ import {AbstractPresenterInputMethod} from 'viewers/common/abstract_presenter_in
 import {ImeUiData} from 'viewers/common/ime_ui_data';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer} from 'viewers/viewer';
-import {NotifyHierarchyViewCallbackType} from './abstract_hierarchy_viewer_presenter';
 
 export abstract class AbstractViewerInputMethod implements Viewer {
   private readonly trace: Trace<HierarchyTreeNode>;
@@ -30,15 +30,11 @@ export abstract class AbstractViewerInputMethod implements Viewer {
   protected readonly presenter: AbstractPresenterInputMethod;
   protected abstract readonly view: View;
 
-  protected imeUiCallback = ((uiData: ImeUiData) => {
+  protected imeUiCallback = (uiData: ImeUiData) => {
     (this.htmlElement as any).inputData = uiData;
-  }) as NotifyHierarchyViewCallbackType;
+  };
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-input-method');
     this.presenter = this.initializePresenter(trace, traces, storage);
@@ -75,6 +71,6 @@ export abstract class AbstractViewerInputMethod implements Viewer {
   protected abstract initializePresenter(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
+    storage: Store,
   ): AbstractPresenterInputMethod;
 }
diff --git a/tools/winscope/src/viewers/common/chip.ts b/tools/winscope/src/viewers/common/chip.ts
index c35abcc83..446f7973a 100644
--- a/tools/winscope/src/viewers/common/chip.ts
+++ b/tools/winscope/src/viewers/common/chip.ts
@@ -61,7 +61,7 @@ export const HWC_CHIP = new Chip(
 export const DUPLICATE_CHIP = new Chip(
   'Duplicate',
   "Multiple layers present with this layer's id",
-  'duplicate',
+  'warn',
 );
 
 export const MISSING_Z_PARENT_CHIP = new Chip(
@@ -69,3 +69,9 @@ export const MISSING_Z_PARENT_CHIP = new Chip(
   'Is relative Z-ordered to another surface, but RelZParent is missing from hierarchy',
   'zParent',
 );
+
+export const HIDDEN_BY_POLICY_CHIP = new Chip(
+  'H',
+  'Is hidden by policy',
+  'hidden',
+);
diff --git a/tools/winscope/src/viewers/common/collapsible_section_type.ts b/tools/winscope/src/viewers/common/collapsible_section_type.ts
index 2cdfba7af..74ec15857 100644
--- a/tools/winscope/src/viewers/common/collapsible_section_type.ts
+++ b/tools/winscope/src/viewers/common/collapsible_section_type.ts
@@ -20,4 +20,6 @@ export enum CollapsibleSectionType {
   PROPERTIES = 'PROPERTIES',
   CURATED_PROPERTIES = 'CURATED PROPERTIES',
   IME_ADDITIONAL_PROPERTIES = 'WM & SF PROPERTIES',
+  INPUT_DISPATCH_PROPERTIES = 'INPUT DISPATCH PROPERTIES',
+  LOG = 'LOG',
 }
diff --git a/tools/winscope/src/viewers/common/curated_properties.ts b/tools/winscope/src/viewers/common/curated_properties.ts
index 67b22a26b..884f40e80 100644
--- a/tools/winscope/src/viewers/common/curated_properties.ts
+++ b/tools/winscope/src/viewers/common/curated_properties.ts
@@ -24,6 +24,7 @@ export interface SfLayerSummary {
 
 export interface SfSummaryProperty {
   key: string;
+  desc?: string;
   simpleValue?: string;
   layerValues?: SfLayerSummary[];
 }
@@ -41,7 +42,8 @@ export interface SfCuratedProperties {
   bufferTransformType: string;
   destinationFrame: string;
   z: string;
-  relativeParent: string;
+  relativeParent: string | SfLayerSummary;
+  relativeChildren: SfLayerSummary[];
   calcColor: string;
   calcShadowRadius: string;
   calcCornerRadius: string;
diff --git a/tools/winscope/src/viewers/common/display_identifier.ts b/tools/winscope/src/viewers/common/display_identifier.ts
index b09c1139f..e7e6c88b8 100644
--- a/tools/winscope/src/viewers/common/display_identifier.ts
+++ b/tools/winscope/src/viewers/common/display_identifier.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright 2020, The Android Open Source Project
+ * Copyright 2024, The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -18,4 +18,5 @@ export interface DisplayIdentifier {
   displayId: number | string;
   groupId: number;
   name: string;
+  isActive: boolean;
 }
diff --git a/tools/winscope/src/viewers/common/hierarchy_presenter.ts b/tools/winscope/src/viewers/common/hierarchy_presenter.ts
index d49277dd1..4ff00dce6 100644
--- a/tools/winscope/src/viewers/common/hierarchy_presenter.ts
+++ b/tools/winscope/src/viewers/common/hierarchy_presenter.ts
@@ -35,6 +35,7 @@ import {Filter} from './operations/filter';
 import {FlattenChildren} from './operations/flatten_children';
 import {SimplifyNames} from './operations/simplify_names';
 import {PropertiesPresenter} from './properties_presenter';
+import {TextFilter} from './text_filter';
 import {UiTreeFormatter} from './ui_tree_formatter';
 
 export type GetHierarchyTreeNameType = (
@@ -43,7 +44,7 @@ export type GetHierarchyTreeNameType = (
 ) => string;
 
 export class HierarchyPresenter {
-  private hierarchyFilter: TreeNodeFilter = UiTreeUtils.makeIdFilter('');
+  private hierarchyFilter: TreeNodeFilter;
   private pinnedItems: UiHierarchyTreeNode[] = [];
   private pinnedIds: string[] = [];
 
@@ -74,12 +75,20 @@ export class HierarchyPresenter {
 
   constructor(
     private userOptions: UserOptions,
+    private textFilter: TextFilter,
     private denylistProperties: string[],
     private showHeadings: boolean,
     private forceSelectFirstNode: boolean,
     private getHierarchyTreeNameStrategy?: GetHierarchyTreeNameType,
-    private customOperations?: Array<Operation<UiHierarchyTreeNode>>,
-  ) {}
+    private customOperations?: Array<
+      [TraceType, Array<Operation<UiHierarchyTreeNode>>]
+    >,
+  ) {
+    this.hierarchyFilter = UiTreeUtils.makeNodeFilter(
+      textFilter.filterString,
+      textFilter.flags,
+    );
+  }
 
   getUserOptions(): UserOptions {
     return this.userOptions;
@@ -258,7 +267,6 @@ export class HierarchyPresenter {
     }
 
     if (this.currentHierarchyTrees) {
-      this.pinnedItems = [];
       this.currentFormattedTrees = assertDefined(
         await this.formatHierarchyTreesAndUpdatePinnedItems(
           this.currentHierarchyTrees,
@@ -320,14 +328,22 @@ export class HierarchyPresenter {
       );
   }
 
-  async applyHierarchyFilterChange(filterString: string) {
-    this.hierarchyFilter = UiTreeUtils.makeIdFilter(filterString);
+  async applyHierarchyFilterChange(textFilter: TextFilter) {
+    this.textFilter = textFilter;
+    this.hierarchyFilter = UiTreeUtils.makeNodeFilter(
+      textFilter.filterString,
+      textFilter.flags,
+    );
     this.currentFormattedTrees =
       await this.formatHierarchyTreesAndUpdatePinnedItems(
         this.currentHierarchyTrees,
       );
   }
 
+  getTextFilter(): TextFilter {
+    return this.textFilter;
+  }
+
   applyPinnedItemChange(pinnedItem: UiHierarchyTreeNode) {
     const pinnedId = pinnedItem.id;
     if (this.pinnedItems.map((item) => item.id).includes(pinnedId)) {
@@ -335,11 +351,22 @@ export class HierarchyPresenter {
         (pinned) => pinned.id !== pinnedId,
       );
     } else {
-      this.pinnedItems.push(pinnedItem);
+      // Angular change detection requires new array as input
+      this.pinnedItems = this.pinnedItems.concat([pinnedItem]);
     }
     this.updatePinnedIds(pinnedId);
   }
 
+  clear() {
+    this.previousEntries = undefined;
+    this.previousHierarchyTrees = undefined;
+    this.currentEntries = undefined;
+    this.currentHierarchyTrees = undefined;
+    this.currentHierarchyTreeNames = undefined;
+    this.currentFormattedTrees = undefined;
+    this.selectedHierarchyTree = undefined;
+  }
+
   private updatePinnedIds(newId: string) {
     if (this.pinnedIds.includes(newId)) {
       this.pinnedIds = this.pinnedIds.filter((pinned) => pinned !== newId);
@@ -353,12 +380,15 @@ export class HierarchyPresenter {
       | Map<Trace<HierarchyTreeNode>, HierarchyTreeNode[]>
       | undefined,
   ): Promise<Map<Trace<HierarchyTreeNode>, UiHierarchyTreeNode[]> | undefined> {
+    this.pinnedItems = [];
+
     if (!hierarchyTrees) return undefined;
 
     const formattedTrees = new Map<
       Trace<HierarchyTreeNode>,
       UiHierarchyTreeNode[]
     >();
+
     for (const [trace, trees] of hierarchyTrees.entries()) {
       const formatted = [];
       for (let i = 0; i < trees.length; i++) {
@@ -379,6 +409,21 @@ export class HierarchyPresenter {
     trace: Trace<HierarchyTreeNode>,
     hierarchyTree: HierarchyTreeNode,
     hierarchyTreeIndex: number | undefined,
+  ): Promise<UiHierarchyTreeNode> {
+    const formattedTree = await this.formatTree(
+      trace,
+      hierarchyTree,
+      hierarchyTreeIndex,
+    );
+    this.pinnedItems.push(...this.extractPinnedItems(formattedTree));
+    const filteredTree = this.filterTree(formattedTree);
+    return filteredTree;
+  }
+
+  private async formatTree(
+    trace: Trace<HierarchyTreeNode>,
+    hierarchyTree: HierarchyTreeNode,
+    hierarchyTreeIndex: number | undefined,
   ): Promise<UiHierarchyTreeNode> {
     const uiTree = UiHierarchyTreeNode.from(hierarchyTree);
 
@@ -418,14 +463,7 @@ export class HierarchyPresenter {
       formatter.addOperation(new FlattenChildren());
     }
 
-    const predicates = [this.hierarchyFilter];
-    if (this.userOptions['showOnlyVisible']?.enabled) {
-      predicates.push(UiTreeUtils.isVisible);
-    }
-
-    formatter
-      .addOperation(new Filter(predicates, true))
-      .addOperation(new AddChips());
+    formatter.addOperation(new AddChips());
 
     if (this.userOptions['simplifyNames']?.enabled) {
       formatter.addOperation(
@@ -434,10 +472,14 @@ export class HierarchyPresenter {
           : new SimplifyNames(),
       );
     }
-    this.customOperations?.forEach((op) => formatter.addOperation(op));
-    const formattedTree = formatter.format();
-    this.pinnedItems.push(...this.extractPinnedItems(formattedTree));
-    return formattedTree;
+    this.customOperations?.forEach((traceAndOperations) => {
+      const [traceType, operations] = traceAndOperations;
+      if (trace.type === traceType) {
+        operations.forEach((op) => formatter.addOperation(op));
+      }
+    });
+
+    return formatter.format();
   }
 
   private extractPinnedItems(tree: UiHierarchyTreeNode): UiHierarchyTreeNode[] {
@@ -454,6 +496,17 @@ export class HierarchyPresenter {
     return pinnedNodes;
   }
 
+  private filterTree(formattedTree: UiHierarchyTreeNode): UiHierarchyTreeNode {
+    const formatter = new UiTreeFormatter<UiHierarchyTreeNode>().setUiTree(
+      formattedTree,
+    );
+    const predicates = [this.hierarchyFilter];
+    if (this.userOptions['showOnlyVisible']?.enabled) {
+      predicates.push(UiTreeUtils.isVisible);
+    }
+    return formatter.addOperation(new Filter(predicates, true)).format();
+  }
+
   static isHierarchyTreeModified: IsModifiedCallbackType = async (
     newTree: TreeNode | undefined,
     oldTree: TreeNode | undefined,
diff --git a/tools/winscope/src/viewers/common/ime_ui_data.ts b/tools/winscope/src/viewers/common/ime_ui_data.ts
index 37772fe5c..c79428698 100644
--- a/tools/winscope/src/viewers/common/ime_ui_data.ts
+++ b/tools/winscope/src/viewers/common/ime_ui_data.ts
@@ -18,6 +18,7 @@ import {ImeTraceType} from 'trace/trace_type';
 import {ImeAdditionalProperties} from 'viewers/common/ime_additional_properties';
 import {TableProperties} from 'viewers/common/table_properties';
 import {UserOptions} from 'viewers/common/user_options';
+import {TextFilter} from './text_filter';
 import {UiDataHierarchy} from './ui_data_hierarchy';
 import {UiHierarchyTreeNode} from './ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
@@ -30,6 +31,8 @@ export class ImeUiData implements UiDataHierarchy {
   propertiesUserOptions: UserOptions = {};
   propertiesTree: UiPropertyTreeNode | undefined;
   highlightedProperty = '';
+  hierarchyFilter = new TextFilter('', []);
+  propertiesFilter = new TextFilter('', []);
 
   constructor(
     readonly traceType: ImeTraceType,
diff --git a/tools/winscope/src/viewers/common/ime_utils.ts b/tools/winscope/src/viewers/common/ime_utils.ts
index 242b43e56..84974e6e7 100644
--- a/tools/winscope/src/viewers/common/ime_utils.ts
+++ b/tools/winscope/src/viewers/common/ime_utils.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
+import {FilterFlag} from 'common/filter_flag';
 import {Timestamp} from 'common/time';
 import {Item} from 'trace/item';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
@@ -106,7 +107,7 @@ class ImeAdditionalPropertiesUtils {
     processedWindowManagerState: ProcessedWindowManagerState,
     sfEntryTimestamp: Timestamp | undefined,
   ): ImeLayers | undefined {
-    const isImeContainer = UiTreeUtils.makeIdFilter('ImeContainer');
+    const isImeContainer = UiTreeUtils.makeNodeFilter('ImeContainer');
     const imeContainerLayer = entryTree.findDfs(isImeContainer);
 
     if (!imeContainerLayer) {
@@ -123,7 +124,7 @@ class ImeAdditionalPropertiesUtils {
       ).getValue(),
     };
 
-    const isInputMethodSurface = UiTreeUtils.makeIdFilter('InputMethod');
+    const isInputMethodSurface = UiTreeUtils.makeNodeFilter('InputMethod');
     const inputMethodSurfaceLayer =
       imeContainerLayer.findDfs(isInputMethodSurface);
 
@@ -147,7 +148,7 @@ class ImeAdditionalPropertiesUtils {
         ?.split(' ')[0]
         .slice(1);
     if (focusedWindowToken) {
-      const isFocusedWindow = UiTreeUtils.makeIdFilter(focusedWindowToken);
+      const isFocusedWindow = UiTreeUtils.makeNodeFilter(focusedWindowToken);
       focusedWindowLayer = entryTree.findDfs(isFocusedWindow);
     }
 
@@ -159,12 +160,12 @@ class ImeAdditionalPropertiesUtils {
     // cases where both exist
     const taskLayerOfImeContainer = this.findAncestorTaskLayerOfImeLayer(
       entryTree,
-      UiTreeUtils.makeIdFilter('ImeContainer'),
+      UiTreeUtils.makeNodeFilter('ImeContainer'),
     );
 
     const taskLayerOfImeSnapshot = this.findAncestorTaskLayerOfImeLayer(
       entryTree,
-      UiTreeUtils.makeIdFilter('IME-snapshot'),
+      UiTreeUtils.makeNodeFilter('IME-snapshot'),
     );
 
     const rootProperties = sfEntryTimestamp
@@ -260,7 +261,9 @@ class ImeAdditionalPropertiesUtils {
       return undefined;
     }
 
-    const isTaskLayer = UiTreeUtils.makeIdFilter('Task|ImePlaceholder');
+    const isTaskLayer = UiTreeUtils.makeNodeFilter('Task|ImePlaceholder', [
+      FilterFlag.USE_REGEX,
+    ]);
     const taskLayer = imeLayer.findAncestor(isTaskLayer);
     if (!taskLayer) {
       return undefined;
@@ -288,7 +291,7 @@ class ImeAdditionalPropertiesUtils {
   }
 
   private isInputMethodVisible(displayContent: HierarchyTreeNode): boolean {
-    const isInputMethod = UiTreeUtils.makeIdFilter('InputMethod');
+    const isInputMethod = UiTreeUtils.makeNodeFilter('InputMethod');
     const inputMethodWindowOrLayer = displayContent.findDfs(isInputMethod);
     return inputMethodWindowOrLayer
       ?.getEagerPropertyByName('isComputedVisible')
diff --git a/tools/winscope/src/viewers/common/ime_utils_test.ts b/tools/winscope/src/viewers/common/ime_utils_test.ts
index b3c08d737..03bb62fc4 100644
--- a/tools/winscope/src/viewers/common/ime_utils_test.ts
+++ b/tools/winscope/src/viewers/common/ime_utils_test.ts
@@ -14,11 +14,23 @@
  * limitations under the License.
  */
 import {assertDefined} from 'common/assert_utils';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {TraceType} from 'trace/trace_type';
 import {ImeUtils} from './ime_utils';
 
 describe('ImeUtils', () => {
+  let userNotifierChecker: UserNotifierChecker;
+
+  beforeAll(() => {
+    userNotifierChecker = new UserNotifierChecker();
+  });
+
+  afterEach(() => {
+    userNotifierChecker.expectNone();
+    userNotifierChecker.reset();
+  });
+
   it('processes WindowManager trace entry', async () => {
     const entries = (await UnitTestUtils.getImeTraceEntries())[0];
     const processed = ImeUtils.processWindowManagerTraceEntry(
@@ -128,7 +140,7 @@ describe('ImeUtils', () => {
 
     expect(
       assertDefined(layers.properties.focusedWindowColor).formattedValue(),
-    ).toEqual('(0, 0, 0, 1)');
+    ).toEqual('(0, 0, 0), alpha: 1');
 
     const taskLayerOfImeContainer = assertDefined(
       layers.taskLayerOfImeContainer,
diff --git a/tools/winscope/src/viewers/common/log_component.ts b/tools/winscope/src/viewers/common/log_component.ts
new file mode 100644
index 000000000..28a63a473
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_component.ts
@@ -0,0 +1,437 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {CdkVirtualScrollViewport} from '@angular/cdk/scrolling';
+import {
+  Component,
+  ElementRef,
+  EventEmitter,
+  HostListener,
+  Inject,
+  Input,
+  Output,
+  ViewChild,
+} from '@angular/core';
+import {MatSelectChange} from '@angular/material/select';
+
+import {Timestamp, TimestampFormatType} from 'common/time';
+import {TimeUtils} from 'common/time_utils';
+import {TraceType} from 'trace/trace_type';
+import {
+  LogFilterChangeDetail,
+  LogTextFilterChangeDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {
+  inlineButtonStyle,
+  timeButtonStyle,
+} from 'viewers/components/styles/clickable_property.styles';
+import {currentElementStyle} from 'viewers/components/styles/current_element.styles';
+import {logComponentStyles} from 'viewers/components/styles/log_component.styles';
+import {selectedElementStyle} from 'viewers/components/styles/selected_element.styles';
+import {
+  viewerCardInnerStyle,
+  viewerCardStyle,
+} from 'viewers/components/styles/viewer_card.styles';
+import {TextFilter} from './text_filter';
+import {
+  LogEntry,
+  LogField,
+  LogFieldClassNames,
+  LogFieldNames,
+  LogFieldType,
+  LogFilter,
+} from './ui_data_log';
+
+@Component({
+  selector: 'log-view',
+  template: `
+    <div class="view-header" *ngIf="title">
+      <div class="title-section">
+        <collapsible-section-title
+            class="log-title"
+            [title]="title"
+            (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
+
+        <div class="filters" *ngIf="showFiltersInTitle && filters.length > 0">
+          <div class="filter" *ngFor="let filter of filters"
+               [class]="getLogFieldClass(filter.type)">
+            <select-with-filter
+                *ngIf="filter.options?.length > 0"
+                [label]="getLogFieldName(filter.type)"
+                [options]="filter.options"
+                [outerFilterWidth]="getOuterFilterWidth(filter.type)"
+                [innerFilterWidth]="getInnerFilterWidth(filter.type)"
+                (selectChange)="onFilterChange($event, filter.type)">
+            </select-with-filter>
+          </div>
+        </div>
+      </div>
+    </div>
+
+    <div class="entries">
+      <div class="headers table-header" *ngIf="headers.length > 0">
+        <div *ngFor="let header of headers" class="mat-body-2" [class]="getLogFieldClass(header)" [class.with-date]="areMultipleDatesPresent()">{{getLogFieldName(header)}}</div>
+      </div>
+
+      <div class="filters table-header" *ngIf="!showFiltersInTitle && filters.length > 0">
+        <div *ngIf="showTraceEntryTimes" class="time" [class.with-date]="areMultipleDatesPresent()">
+          <button
+              color="primary"
+              mat-stroked-button
+              class="go-to-current-time"
+              *ngIf="showCurrentTimeButton"
+              (click)="onGoToCurrentTimeClick()">
+            Go to Current Time
+          </button>
+        </div>
+
+        <div class="filter" *ngFor="let filter of filters" [class]="getLogFieldClass(filter.type)" [class.with-date]="areMultipleDatesPresent()">
+          <select-with-filter
+              *ngIf="filter.options?.length > 0"
+              [label]="getLogFieldName(filter.type)"
+              [options]="filter.options"
+              [outerFilterWidth]="getOuterFilterWidth(filter.type)"
+              [innerFilterWidth]="getInnerFilterWidth(filter.type)"
+              (selectChange)="onFilterChange($event, filter.type)">
+          </select-with-filter>
+
+          <search-box
+            *ngIf="filter.textFilter"
+            appearance="fill"
+            [textFilter]="filter.textFilter"
+            [fontSize]="12"
+            [wideField]="true"
+            [label]="getLogFieldName(filter.type)"
+            [filterName]="getLogFieldName(filter.type)"
+            (filterChange)="onSearchBoxChange($event, filter.type)"></search-box>
+        </div>
+      </div>
+
+      <div class="placeholder-text mat-body-1" *ngIf="entries.length === 0"> No entries found. </div>
+
+      <cdk-virtual-scroll-viewport
+          *ngIf="isTransactions()"
+          transactionsVirtualScroll
+          class="scroll"
+          [scrollItems]="entries">
+        <ng-container
+            *cdkVirtualFor="let entry of entries; let i = index"
+            [ngTemplateOutlet]="content"
+            [ngTemplateOutletContext]="{entry: entry, i: i}"> </ng-container>
+      </cdk-virtual-scroll-viewport>
+
+      <cdk-virtual-scroll-viewport
+          *ngIf="isProtolog()"
+          protologVirtualScroll
+          class="scroll"
+          [scrollItems]="entries">
+        <ng-container
+            *cdkVirtualFor="let entry of entries; let i = index"
+            [ngTemplateOutlet]="content"
+            [ngTemplateOutletContext]="{entry: entry, i: i}"> </ng-container>
+      </cdk-virtual-scroll-viewport>
+
+      <cdk-virtual-scroll-viewport
+          *ngIf="isFixedSizeScrollViewport()"
+          itemSize="36"
+          class="scroll">
+        <ng-container
+            *cdkVirtualFor="let entry of entries; let i = index"
+            [ngTemplateOutlet]="content"
+            [ngTemplateOutletContext]="{entry: entry, i: i}"> </ng-container>
+      </cdk-virtual-scroll-viewport>
+
+      <ng-template #content let-entry="entry" let-i="i">
+        <div
+            class="entry"
+            [attr.item-id]="i"
+            [class.current]="isCurrentEntry(i)"
+            [class.selected]="isSelectedEntry(i)"
+            (click)="onEntryClicked(i)">
+          <div *ngIf="showTraceEntryTimes" class="time" [class.with-date]="areMultipleDatesPresent()">
+            <button
+                mat-button
+                class="time-button"
+                color="primary"
+                (click)="onTraceEntryTimestampClick($event, entry)"
+                [disabled]="!entry.traceEntry.hasValidTimestamp()">
+              {{ formatTimestamp(entry.traceEntry.getTimestamp()) }}
+            </button>
+          </div>
+
+          <div [class]="getLogFieldClass(field.type)" [class.with-date]="areMultipleDatesPresent()" *ngFor="let field of entry.fields; index as i">
+            <span class="mat-body-1" *ngIf="!showFieldButton(field)">{{ field.value }}</span>
+            <button
+                *ngIf="showFieldButton(field)"
+                mat-button
+                class="time-button"
+                color="primary"
+                (click)="onFieldButtonClick($event, entry, field)">
+              {{ formatFieldButton(field) }}
+            </button>
+            <mat-icon
+                *ngIf="field.icon"
+                aria-hidden="false"
+                [style]="{color: field.iconColor}"> {{field.icon}} </mat-icon>
+          </div>
+        </div>
+      </ng-template>
+    </div>
+  `,
+  styles: [
+    `
+      .view-header {
+        display: flex;
+        flex-direction: column;
+        flex: 0 0 auto
+      }
+    `,
+    selectedElementStyle,
+    currentElementStyle,
+    timeButtonStyle,
+    inlineButtonStyle,
+    viewerCardStyle,
+    viewerCardInnerStyle,
+    logComponentStyles,
+  ],
+})
+export class LogComponent {
+  emptyFilterValue = '';
+  private lastClickedTimestamp: Timestamp | undefined;
+
+  @Input() title: string | undefined;
+  @Input() selectedIndex: number | undefined;
+  @Input() scrollToIndex: number | undefined;
+  @Input() currentIndex: number | undefined;
+  @Input() headers: LogFieldType[] = [];
+  @Input() filters: LogFilter[] = [];
+  @Input() entries: LogEntry[] = [];
+  @Input() showCurrentTimeButton = true;
+  @Input() traceType: TraceType | undefined;
+  @Input() showTraceEntryTimes = true;
+  @Input() showFiltersInTitle = false;
+
+  @Output() collapseButtonClicked = new EventEmitter();
+
+  @ViewChild(CdkVirtualScrollViewport)
+  scrollComponent?: CdkVirtualScrollViewport;
+
+  constructor(
+    @Inject(ElementRef) private elementRef: ElementRef<HTMLElement>,
+  ) {}
+
+  showFieldButton(field: LogField) {
+    return (
+      field.value instanceof Timestamp || field.type === LogFieldType.INPUT_TYPE
+    );
+  }
+
+  formatFieldButton(field: LogField): string | number {
+    return field.value instanceof Timestamp
+      ? this.formatTimestamp(field.value)
+      : field.value;
+  }
+
+  areMultipleDatesPresent(): boolean {
+    return (
+      this.entries.at(0)?.traceEntry.getFullTrace().spansMultipleDates() ??
+      false
+    );
+  }
+
+  formatTimestamp(timestamp: Timestamp) {
+    if (!this.areMultipleDatesPresent()) {
+      return timestamp.format(TimestampFormatType.DROP_DATE);
+    }
+    return timestamp.format();
+  }
+
+  getLogFieldClass(fieldType: LogFieldType) {
+    return LogFieldClassNames.get(fieldType);
+  }
+
+  getLogFieldName(fieldType: LogFieldType) {
+    return LogFieldNames.get(fieldType);
+  }
+
+  ngOnChanges() {
+    if (
+      this.scrollToIndex !== undefined &&
+      this.lastClickedTimestamp !==
+        this.entries.at(this.scrollToIndex)?.traceEntry.getTimestamp()
+    ) {
+      this.scrollComponent?.scrollToIndex(Math.max(0, this.scrollToIndex - 1));
+    }
+  }
+
+  async ngAfterContentInit() {
+    await TimeUtils.sleepMs(10);
+    this.updateTableMarginEnd();
+  }
+
+  @HostListener('window:resize', ['$event'])
+  onResize(event: Event) {
+    this.updateTableMarginEnd();
+  }
+
+  onFilterChange(event: MatSelectChange, filterType: LogFieldType) {
+    this.emitEvent(
+      ViewerEvents.LogFilterChange,
+      new LogFilterChangeDetail(filterType, event.value),
+    );
+  }
+
+  onSearchBoxChange(detail: TextFilter, filterType: LogFieldType) {
+    this.emitEvent(
+      ViewerEvents.LogTextFilterChange,
+      new LogTextFilterChangeDetail(filterType, detail),
+    );
+  }
+
+  onEntryClicked(index: number) {
+    this.emitEvent(ViewerEvents.LogEntryClick, index);
+  }
+
+  onGoToCurrentTimeClick() {
+    if (this.currentIndex !== undefined && this.scrollComponent) {
+      this.scrollComponent.scrollToIndex(this.currentIndex);
+    }
+  }
+
+  onTraceEntryTimestampClick(event: MouseEvent, entry: LogEntry) {
+    event.stopPropagation();
+    this.lastClickedTimestamp = entry.traceEntry.getTimestamp();
+    this.emitEvent(
+      ViewerEvents.TimestampClick,
+      new TimestampClickDetail(entry.traceEntry),
+    );
+  }
+
+  onFieldButtonClick(event: MouseEvent, entry: LogEntry, field: LogField) {
+    event.stopPropagation();
+    if (
+      field.type === LogFieldType.DISPATCH_TIME ||
+      field.type === LogFieldType.INPUT_TYPE
+    ) {
+      this.onTraceEntryTimestampClick(event, entry);
+    } else if (field.value instanceof Timestamp) {
+      this.onRawTimestampClick(field.value as Timestamp);
+    }
+  }
+
+  @HostListener('document:keydown', ['$event'])
+  async handleKeyboardEvent(event: KeyboardEvent) {
+    const logComponentRect = (
+      this.elementRef.nativeElement as HTMLElement
+    ).getBoundingClientRect();
+    const logComponentVisible =
+      logComponentRect.height > 0 && logComponentRect.width > 0;
+    if (event.key === 'ArrowDown' && logComponentVisible) {
+      event.stopPropagation();
+      event.preventDefault();
+      this.emitEvent(ViewerEvents.ArrowDownPress);
+    }
+    if (event.key === 'ArrowUp' && logComponentVisible) {
+      event.stopPropagation();
+      event.preventDefault();
+      this.emitEvent(ViewerEvents.ArrowUpPress);
+    }
+  }
+
+  isCurrentEntry(index: number): boolean {
+    return index === this.currentIndex;
+  }
+
+  isSelectedEntry(index: number): boolean {
+    return index === this.selectedIndex;
+  }
+
+  getOuterFilterWidth(type: LogFieldType): string | undefined {
+    switch (type) {
+      case LogFieldType.INPUT_DISPATCH_WINDOWS:
+        return '300px';
+      default:
+        return '100%';
+    }
+  }
+
+  getInnerFilterWidth(type: LogFieldType): string | undefined {
+    switch (type) {
+      case LogFieldType.TRANSACTION_ID:
+        return '125';
+      case LogFieldType.VSYNC_ID:
+        return '90';
+      case LogFieldType.TRANSACTION_TYPE:
+        return '175';
+      case LogFieldType.LAYER_OR_DISPLAY_ID:
+        return '100';
+      case LogFieldType.FLAGS:
+        return '250';
+      case LogFieldType.TAG:
+        return '150';
+      case LogFieldType.SOURCE_FILE:
+        return '300';
+      case LogFieldType.INPUT_DISPATCH_WINDOWS:
+        return '300';
+      default:
+        return '100';
+    }
+  }
+
+  isTransactions() {
+    return this.traceType === TraceType.TRANSACTIONS;
+  }
+
+  isProtolog() {
+    return this.traceType === TraceType.PROTO_LOG;
+  }
+
+  isFixedSizeScrollViewport() {
+    return !(this.isTransactions() || this.isProtolog());
+  }
+
+  updateTableMarginEnd() {
+    const tableHeader =
+      this.elementRef.nativeElement.querySelector<HTMLElement>('.table-header');
+    if (!tableHeader) {
+      return;
+    }
+    const el = this.scrollComponent?.elementRef.nativeElement;
+    if (el && el.scrollHeight > el.offsetHeight) {
+      tableHeader.style.marginInlineEnd =
+        el.offsetWidth - el.scrollWidth + 'px';
+    } else {
+      tableHeader.style.marginInlineEnd = '';
+    }
+  }
+
+  private onRawTimestampClick(value: Timestamp) {
+    this.emitEvent(
+      ViewerEvents.TimestampClick,
+      new TimestampClickDetail(undefined, value),
+    );
+  }
+
+  private emitEvent(event: ViewerEvents, data?: any) {
+    const customEvent = new CustomEvent(event, {
+      bubbles: true,
+      detail: data,
+    });
+    this.elementRef.nativeElement.dispatchEvent(customEvent);
+  }
+}
diff --git a/tools/winscope/src/viewers/common/log_component_test.ts b/tools/winscope/src/viewers/common/log_component_test.ts
new file mode 100644
index 000000000..cf547410d
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_component_test.ts
@@ -0,0 +1,352 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {ScrollingModule} from '@angular/cdk/scrolling';
+import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
+import {
+  ComponentFixture,
+  ComponentFixtureAutoDetect,
+  TestBed,
+} from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
+import {MatDividerModule} from '@angular/material/divider';
+import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
+import {MatSelectModule} from '@angular/material/select';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {Timestamp} from 'common/time';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {TraceEntry} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  LogFilterChangeDetail,
+  LogTextFilterChangeDetail,
+  TimestampClickDetail,
+  ViewerEvents,
+} from 'viewers/common/viewer_events';
+import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
+import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {PropertiesComponent} from 'viewers/components/properties_component';
+import {SearchBoxComponent} from 'viewers/components/search_box_component';
+import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
+import {LogComponent} from './log_component';
+import {TextFilter} from './text_filter';
+import {LogEntry, LogFieldType} from './ui_data_log';
+
+describe('LogComponent', () => {
+  let fixture: ComponentFixture<LogComponent>;
+  let component: LogComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      imports: [
+        ScrollingModule,
+        MatFormFieldModule,
+        FormsModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        MatSelectModule,
+        MatDividerModule,
+        MatButtonModule,
+        MatIconModule,
+      ],
+      declarations: [
+        LogComponent,
+        SelectWithFilterComponent,
+        CollapsedSectionsComponent,
+        CollapsibleSectionTitleComponent,
+        PropertiesComponent,
+        SearchBoxComponent,
+      ],
+      schemas: [CUSTOM_ELEMENTS_SCHEMA],
+    }).compileComponents();
+
+    fixture = TestBed.createComponent(LogComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    setComponentInputData();
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('renders filters', () => {
+    const filters = htmlElement.querySelectorAll('.entries .filter');
+    expect(filters.length).toEqual(2);
+  });
+
+  it('renders entries', () => {
+    expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+
+    const entryText = assertDefined(
+      htmlElement.querySelector('.scroll .entry'),
+    ).textContent;
+    expect(entryText).toContain('Test tag');
+    expect(entryText).toContain('123');
+    expect(entryText).toContain('2ns');
+  });
+
+  it('scrolls to current entry on button click', () => {
+    component.currentIndex = 1;
+    fixture.detectChanges();
+    const goToCurrentTimeButton = assertDefined(
+      htmlElement.querySelector('.go-to-current-time'),
+    ) as HTMLButtonElement;
+    const spy = spyOn(
+      assertDefined(component.scrollComponent),
+      'scrollToIndex',
+    );
+    goToCurrentTimeButton.click();
+    expect(spy).toHaveBeenCalledWith(1);
+  });
+
+  it('applies select filter correctly', async () => {
+    const allEntries = component.entries.slice();
+    htmlElement.addEventListener(ViewerEvents.LogFilterChange, (event) => {
+      const detail: LogFilterChangeDetail = (event as CustomEvent).detail;
+      if (detail.value.length === 0) {
+        component.entries = allEntries;
+        return;
+      }
+      component.entries = allEntries.filter((entry) => {
+        const entryValue = assertDefined(
+          entry.fields.find((f) => f.type === detail.type),
+        ).value.toString();
+        if (Array.isArray(detail.value)) {
+          return detail.value.includes(entryValue);
+        }
+        return entryValue.includes(detail.value);
+      });
+    });
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
+    const filterTrigger = assertDefined(
+      htmlElement.querySelector(`.filters .tag .mat-select-trigger`),
+    ) as HTMLInputElement;
+    filterTrigger.click();
+    await fixture.whenStable();
+
+    const firstOption = assertDefined(
+      document.querySelector('.mat-select-panel .mat-option'),
+    ) as HTMLElement;
+    firstOption.click();
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(1);
+
+    firstOption.click();
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
+  });
+
+  it('applies text filter correctly', async () => {
+    const allEntries = component.entries.slice();
+    htmlElement.addEventListener(ViewerEvents.LogTextFilterChange, (event) => {
+      const detail: LogTextFilterChangeDetail = (event as CustomEvent).detail;
+      if (detail.filter.filterString.length === 0) {
+        component.entries = allEntries;
+        return;
+      }
+      component.entries = allEntries.filter((entry) => {
+        const entryValue = assertDefined(
+          entry.fields.find((f) => f.type === detail.type),
+        ).value.toString();
+        return entryValue.includes(detail.filter.filterString);
+      });
+    });
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
+
+    const inputEl = assertDefined(
+      htmlElement.querySelector<HTMLInputElement>(`.filters .vsyncid input`),
+    );
+
+    inputEl.value = '123';
+    inputEl.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
+
+    inputEl.value = '1234';
+    inputEl.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(1);
+
+    inputEl.value = '12345';
+    inputEl.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(0);
+
+    inputEl.value = '';
+    inputEl.dispatchEvent(new Event('input'));
+    fixture.detectChanges();
+    expect(htmlElement.querySelectorAll('.entry').length).toEqual(2);
+  });
+
+  it('emits event on arrow key press', () => {
+    let downArrowPressedTimes = 0;
+    htmlElement.addEventListener(ViewerEvents.ArrowDownPress, (event) => {
+      downArrowPressedTimes++;
+    });
+    let upArrowPressedTimes = 0;
+    htmlElement.addEventListener(ViewerEvents.ArrowUpPress, (event) => {
+      upArrowPressedTimes++;
+    });
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));
+    expect(upArrowPressedTimes).toEqual(1);
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowDown'}));
+    expect(downArrowPressedTimes).toEqual(1);
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));
+    expect(upArrowPressedTimes).toEqual(2);
+
+    document.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowDown'}));
+    expect(downArrowPressedTimes).toEqual(2);
+  });
+
+  it('propagates entry on trace entry timestamp click', () => {
+    let entry: TraceEntry<PropertyTreeNode> | undefined;
+    htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
+      const detail: TimestampClickDetail = (event as CustomEvent).detail;
+      entry = detail.entry;
+    });
+    const logTimestampButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.time-button'),
+    );
+    logTimestampButton.click();
+
+    expect(entry).toBeDefined();
+  });
+
+  it('propagates timestamp on raw timestamp click', () => {
+    let timestamp: Timestamp | undefined;
+    htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
+      const detail: TimestampClickDetail = (event as CustomEvent).detail;
+      timestamp = detail.timestamp;
+    });
+    const logTimestampButton = assertDefined(
+      htmlElement.querySelector('.send-time button'),
+    ) as HTMLButtonElement;
+    logTimestampButton.click();
+
+    expect(timestamp).toBeDefined();
+  });
+
+  it('changes css class on entry click and does not scroll', () => {
+    htmlElement.addEventListener(ViewerEvents.LogEntryClick, (event) => {
+      const index = (event as CustomEvent).detail;
+      component.selectedIndex = index;
+      fixture.detectChanges();
+    });
+
+    const entry = assertDefined(
+      htmlElement.querySelector('.entry[item-id="1"]'),
+    ) as HTMLButtonElement;
+    expect(entry.className).not.toContain('selected');
+    const spy = spyOn(
+      assertDefined(component.scrollComponent),
+      'scrollToIndex',
+    );
+    entry.click();
+    expect(spy).not.toHaveBeenCalled();
+    expect(entry.className).toContain('selected');
+  });
+
+  it('shows placeholder text', () => {
+    expect(htmlElement.querySelector('.placeholder-text')).toBeNull();
+    component.entries = [];
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.placeholder-text')).toBeTruthy();
+  });
+
+  it('formats timestamp without date unless multiple dates present', () => {
+    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
+    expect(entry.textContent?.trim()).toEqual('1ns Test tag 1123 2ns');
+
+    const spy = spyOn(component, 'areMultipleDatesPresent').and.returnValue(
+      true,
+    );
+    fixture.detectChanges();
+    expect(entry.textContent?.trim()).toEqual('1ns Test tag 1123 2ns');
+
+    setComponentInputData(false);
+    fixture.detectChanges();
+    expect(entry.textContent?.trim()).toEqual(
+      '1970-01-01, 00:00:00.000 Test tag 21234 1970-01-01, 00:00:00.000',
+    );
+
+    spy.and.returnValue(false);
+    fixture.detectChanges();
+    expect(entry.textContent?.trim()).toEqual(
+      '00:00:00.000 Test tag 21234 00:00:00.000',
+    );
+  });
+
+  function setComponentInputData(elapsed = true) {
+    let entryTime: Timestamp;
+    let fieldTime: Timestamp;
+    if (elapsed) {
+      entryTime = TimestampConverterUtils.makeElapsedTimestamp(1n);
+      fieldTime = TimestampConverterUtils.makeElapsedTimestamp(2n);
+    } else {
+      entryTime = TimestampConverterUtils.makeRealTimestamp(1n);
+      fieldTime = TimestampConverterUtils.makeRealTimestamp(2n);
+    }
+
+    const fields1 = [
+      {type: LogFieldType.TAG, value: 'Test tag 1'},
+      {type: LogFieldType.VSYNC_ID, value: 123},
+      {type: LogFieldType.SEND_TIME, value: fieldTime},
+    ];
+    const fields2 = [
+      {type: LogFieldType.TAG, value: 'Test tag 2'},
+      {type: LogFieldType.VSYNC_ID, value: 1234},
+      {type: LogFieldType.SEND_TIME, value: fieldTime},
+    ];
+
+    const trace = new TraceBuilder<PropertyTreeNode>()
+      .setTimestamps([entryTime, entryTime])
+      .build();
+
+    const entry1: LogEntry = {
+      traceEntry: trace.getEntry(0),
+      fields: fields1,
+    };
+    const entry2: LogEntry = {
+      traceEntry: trace.getEntry(1),
+      fields: fields2,
+    };
+
+    const entries = [entry1, entry2];
+
+    const filters = [
+      {type: LogFieldType.TAG, options: ['Test tag 1', 'Test tag 2']},
+      {type: LogFieldType.VSYNC_ID, textFilter: new TextFilter('', [])},
+    ];
+
+    component.entries = entries;
+    component.filters = filters;
+    component.selectedIndex = 0;
+    component.traceType = TraceType.CUJS;
+  }
+});
diff --git a/tools/winscope/src/viewers/common/log_presenter.ts b/tools/winscope/src/viewers/common/log_presenter.ts
new file mode 100644
index 000000000..efcd8a4ce
--- /dev/null
+++ b/tools/winscope/src/viewers/common/log_presenter.ts
@@ -0,0 +1,269 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {ArrayUtils} from 'common/array_utils';
+import {assertDefined} from 'common/assert_utils';
+import {
+  FilterFlag,
+  makeFilterPredicate,
+  StringFilterPredicate,
+} from 'common/filter_flag';
+import {Timestamp} from 'common/time';
+import {TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from './text_filter';
+import {LogEntry, LogFieldType, LogFilter} from './ui_data_log';
+
+export class LogPresenter<Entry extends LogEntry> {
+  private allEntries: Entry[] = [];
+  private filteredEntries: Entry[] = [];
+  private filters: LogFilter[] = [];
+  private headers: LogFieldType[] = [];
+  private filterPredicates = new Map<LogFieldType, StringFilterPredicate>();
+  private currentEntry: TraceEntry<PropertyTreeNode> | undefined;
+  private selectedIndex: number | undefined;
+  private scrollToIndex: number | undefined;
+  private currentIndex: number | undefined;
+  private originalIndicesOfAllEntries: number[] = [];
+
+  constructor(private timeOrderedEntries = true) {}
+
+  setAllEntries(value: Entry[]) {
+    this.allEntries = value;
+    this.updateFilteredEntries();
+  }
+
+  setHeaders(headers: LogFieldType[]) {
+    this.headers = headers;
+  }
+
+  getHeaders(): LogFieldType[] {
+    return this.headers;
+  }
+
+  setFilters(filters: LogFilter[]) {
+    this.filters = filters;
+    this.filterPredicates = new Map<LogFieldType, StringFilterPredicate>();
+    this.filters.forEach((filter) => {
+      if (
+        filter.textFilter &&
+        (filter.textFilter.filterString || filter.textFilter.flags.length > 0)
+      ) {
+        this.filterPredicates.set(
+          filter.type,
+          this.makeLogFilterPredicate(
+            filter.type,
+            filter.textFilter.filterString,
+            filter.textFilter.flags,
+          ),
+        );
+      }
+    });
+    this.updateFilteredEntries();
+    this.resetIndices();
+  }
+
+  getFilters(): LogFilter[] {
+    return this.filters;
+  }
+
+  getFilteredEntries(): Entry[] {
+    return this.filteredEntries;
+  }
+
+  getSelectedIndex(): number | undefined {
+    return this.selectedIndex;
+  }
+
+  getScrollToIndex(): number | undefined {
+    return this.scrollToIndex;
+  }
+
+  getCurrentIndex(): number | undefined {
+    return this.currentIndex;
+  }
+
+  applyLogEntryClick(index: number) {
+    if (this.selectedIndex === index) {
+      this.scrollToIndex = undefined;
+      return;
+    }
+    this.selectedIndex = index;
+    this.scrollToIndex = undefined; // no scrolling
+  }
+
+  applyArrowDownPress() {
+    const index = this.selectedIndex ?? this.currentIndex;
+    if (index === undefined) {
+      this.changeLogByKeyPress(0);
+      return;
+    }
+    if (index < this.filteredEntries.length - 1) {
+      this.changeLogByKeyPress(index + 1);
+    }
+  }
+
+  applyArrowUpPress() {
+    const index = this.selectedIndex ?? this.currentIndex;
+    if (index === undefined) {
+      this.changeLogByKeyPress(0);
+      return;
+    }
+    if (index > 0) {
+      this.changeLogByKeyPress(index - 1);
+    }
+  }
+
+  applyTracePositionUpdate(entry: TraceEntry<PropertyTreeNode> | undefined) {
+    this.currentEntry = entry;
+    this.resetIndices();
+  }
+
+  applyTextFilterChange(type: LogFieldType, value: TextFilter) {
+    assertDefined(
+      this.filters.find((filter) => filter.type === type),
+    ).textFilter = value;
+    if (value.filterString.length > 0) {
+      this.filterPredicates.set(
+        type,
+        this.makeLogFilterPredicate(type, value.filterString, value.flags),
+      );
+    } else {
+      this.filterPredicates.delete(type);
+    }
+    this.updateEntriesAfterFilterChange();
+  }
+
+  applyFilterChange(type: LogFieldType, value: string[] | string) {
+    if (value.length > 0) {
+      this.filterPredicates.set(
+        type,
+        this.makeLogFilterPredicate(type, value, []),
+      );
+    } else {
+      this.filterPredicates.delete(type);
+    }
+    this.updateEntriesAfterFilterChange();
+  }
+
+  private updateEntriesAfterFilterChange() {
+    this.updateFilteredEntries();
+    this.currentIndex = this.getCurrentTracePositionIndex();
+    if (
+      this.selectedIndex !== undefined &&
+      this.selectedIndex > this.filteredEntries.length - 1
+    ) {
+      this.selectedIndex = this.currentIndex;
+    }
+    this.scrollToIndex = this.selectedIndex ?? this.currentIndex;
+  }
+
+  private changeLogByKeyPress(index: number) {
+    if (this.selectedIndex === index || this.filteredEntries.length === 0) {
+      return;
+    }
+    this.selectedIndex = index;
+    this.scrollToIndex = index;
+  }
+
+  private resetIndices() {
+    this.currentIndex = this.getCurrentTracePositionIndex();
+    this.selectedIndex = undefined;
+    this.scrollToIndex = this.currentIndex;
+  }
+
+  private static shouldFilterBySubstring(type: LogFieldType): boolean {
+    switch (type) {
+      case LogFieldType.FLAGS:
+      case LogFieldType.INPUT_DISPATCH_WINDOWS:
+        return true;
+      default:
+        return false;
+    }
+  }
+
+  private makeLogFilterPredicate(
+    type: LogFieldType,
+    filterValue: string | string[],
+    flags: FilterFlag[],
+  ): StringFilterPredicate {
+    if (
+      Array.isArray(filterValue) &&
+      LogPresenter.shouldFilterBySubstring(type)
+    ) {
+      return (entryString) =>
+        filterValue.some((val) => entryString.includes(val));
+    } else if (Array.isArray(filterValue)) {
+      return (entryString) => filterValue.includes(entryString);
+    } else {
+      return makeFilterPredicate(filterValue, flags);
+    }
+  }
+
+  private updateFilteredEntries() {
+    this.filteredEntries = this.allEntries.filter((entry) => {
+      for (const [filterType, predicate] of this.filterPredicates) {
+        const entryValue = entry.fields.find(
+          (f) => f.type === filterType,
+        )?.value;
+
+        if (entryValue === undefined || entryValue instanceof Timestamp) {
+          continue;
+        }
+
+        const entryValueStr = entryValue.toString();
+
+        if (!predicate(entryValueStr)) return false;
+      }
+      return true;
+    });
+    if (this.filteredEntries.length === 0) {
+      this.currentIndex = undefined;
+      this.selectedIndex = undefined;
+    }
+    this.originalIndicesOfAllEntries = this.filteredEntries.map((entry) =>
+      entry.traceEntry.getIndex(),
+    );
+  }
+
+  private getCurrentTracePositionIndex(): number | undefined {
+    if (!this.currentEntry) {
+      this.currentIndex = undefined;
+      return;
+    }
+    if (this.originalIndicesOfAllEntries.length === 0) {
+      this.currentIndex = undefined;
+      return;
+    }
+    const target = this.currentEntry.getIndex();
+
+    if (this.timeOrderedEntries) {
+      return (
+        ArrayUtils.binarySearchFirstGreaterOrEqual(
+          this.originalIndicesOfAllEntries,
+          this.currentEntry.getIndex(),
+        ) ?? this.originalIndicesOfAllEntries.length - 1
+      );
+    }
+
+    const currentIndex = this.originalIndicesOfAllEntries.findIndex(
+      (i) => i === target,
+    );
+    return currentIndex !== -1
+      ? currentIndex
+      : this.originalIndicesOfAllEntries.length - 1;
+  }
+}
diff --git a/tools/winscope/src/viewers/common/operations/add_chips.ts b/tools/winscope/src/viewers/common/operations/add_chips.ts
index e3f35d3e0..0e5a737b9 100644
--- a/tools/winscope/src/viewers/common/operations/add_chips.ts
+++ b/tools/winscope/src/viewers/common/operations/add_chips.ts
@@ -19,6 +19,7 @@ import {Operation} from 'trace/tree_node/operations/operation';
 import {
   DUPLICATE_CHIP,
   GPU_CHIP,
+  HIDDEN_BY_POLICY_CHIP,
   HWC_CHIP,
   MISSING_Z_PARENT_CHIP,
   RELATIVE_Z_CHIP,
@@ -54,6 +55,10 @@ export class AddChips implements Operation<UiHierarchyTreeNode> {
         node.addChip(DUPLICATE_CHIP);
       }
 
+      if (node.getEagerPropertyByName('isHiddenByPolicy')?.getValue()) {
+        node.addChip(HIDDEN_BY_POLICY_CHIP);
+      }
+
       const zOrderRelativeOfId = node
         .getEagerPropertyByName('zOrderRelativeOf')
         ?.getValue();
diff --git a/tools/winscope/src/viewers/common/operations/add_chips_test.ts b/tools/winscope/src/viewers/common/operations/add_chips_test.ts
index e66b8ee91..69f0f8784 100644
--- a/tools/winscope/src/viewers/common/operations/add_chips_test.ts
+++ b/tools/winscope/src/viewers/common/operations/add_chips_test.ts
@@ -20,6 +20,7 @@ import {LayerCompositionType} from 'trace/layer_composition_type';
 import {
   DUPLICATE_CHIP,
   GPU_CHIP,
+  HIDDEN_BY_POLICY_CHIP,
   HWC_CHIP,
   MISSING_Z_PARENT_CHIP,
   RELATIVE_Z_CHIP,
@@ -194,4 +195,25 @@ describe('AddChips', () => {
       assertDefined(parentWithChips.getChildByName('node')).getChips(),
     ).toEqual([RELATIVE_Z_CHIP]);
   });
+
+  it('adds HIDDEN_BY_POLICY_CHIP', () => {
+    hierarchyRoot = UiHierarchyTreeNode.from(
+      new HierarchyTreeBuilder()
+        .setId('test')
+        .setName('node')
+        .setChildren([
+          {
+            id: 1,
+            name: 'node',
+            properties: {isHiddenByPolicy: true},
+          },
+        ])
+        .build(),
+    );
+
+    operation.apply(hierarchyRoot);
+    expect(
+      assertDefined(hierarchyRoot.getChildByName('node')).getChips(),
+    ).toEqual([HIDDEN_BY_POLICY_CHIP]);
+  });
 });
diff --git a/tools/winscope/src/viewers/components/styles/search_box.styles.ts b/tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names.ts
similarity index 60%
rename from tools/winscope/src/viewers/components/styles/search_box.styles.ts
rename to tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names.ts
index b91a96ab0..e4a1a974c 100644
--- a/tools/winscope/src/viewers/components/styles/search_box.styles.ts
+++ b/tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names.ts
@@ -14,24 +14,17 @@
  * limitations under the License.
  */
 
-export const searchBoxStyle = `
-  .search-box {
-    font-size: 14px;
-    height: 48px;
-  }
+import {Operation} from 'trace/tree_node/operations/operation';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 
-  .search-box .mat-form-field-flex {
-    padding-left: 5px;
-  }
-  .search-box .mat-form-field-wrapper {
-      padding: 0 !important;
+export class UpdateSfSubtreeDisplayNames
+  implements Operation<UiHierarchyTreeNode>
+{
+  apply(node: UiHierarchyTreeNode): void {
+    this.updateRootName(node);
   }
-  .search-box .mat-form-field-label-wrapper {
-      padding: 0 !important;
-  }
-  .search-box .mat-form-field-infix {
-      border-top: 0;
-      padding-top: 5px;
-      padding-bottom: 5px;
+
+  private updateRootName(node: UiHierarchyTreeNode) {
+    node.setDisplayName('SfSubtree - ' + node.name);
   }
-`;
+}
diff --git a/tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names_test.ts b/tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names_test.ts
new file mode 100644
index 000000000..240c887d1
--- /dev/null
+++ b/tools/winscope/src/viewers/common/operations/update_sf_subtree_display_names_test.ts
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {UpdateSfSubtreeDisplayNames} from './update_sf_subtree_display_names';
+
+describe('UpdateDisplayNames', () => {
+  let operation: UpdateSfSubtreeDisplayNames;
+
+  beforeEach(() => {
+    operation = new UpdateSfSubtreeDisplayNames();
+  });
+
+  it('changes display name of node', () => {
+    const hierarchyRoot = UiHierarchyTreeNode.from(
+      new HierarchyTreeBuilder().setId('test').setName('Task').build(),
+    );
+
+    operation.apply(hierarchyRoot);
+    expect(hierarchyRoot.getDisplayName()).toEqual('SfSubtree - Task');
+  });
+});
diff --git a/tools/winscope/src/viewers/common/preset_hierarchy.ts b/tools/winscope/src/viewers/common/preset_hierarchy.ts
new file mode 100644
index 000000000..6a9bffbeb
--- /dev/null
+++ b/tools/winscope/src/viewers/common/preset_hierarchy.ts
@@ -0,0 +1,28 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {UserOptions} from 'viewers/common/user_options';
+import {RectShowState} from './rect_show_state';
+import {TextFilter} from './text_filter';
+
+export interface PresetHierarchy {
+  hierarchyUserOptions: UserOptions;
+  hierarchyFilter: TextFilter;
+  propertiesUserOptions: UserOptions;
+  propertiesFilter: TextFilter;
+  rectsUserOptions?: UserOptions;
+  rectIdToShowState?: Map<string, RectShowState> | undefined;
+}
diff --git a/tools/winscope/src/viewers/common/properties_presenter.ts b/tools/winscope/src/viewers/common/properties_presenter.ts
index a4cc6fa1c..bb2240fcf 100644
--- a/tools/winscope/src/viewers/common/properties_presenter.ts
+++ b/tools/winscope/src/viewers/common/properties_presenter.ts
@@ -15,44 +15,58 @@
  */
 
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {Operation} from 'trace/tree_node/operations/operation';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {TreeNode} from 'trace/tree_node/tree_node';
 import {IsModifiedCallbackType} from './add_diffs';
 import {AddDiffsPropertiesTree} from './add_diffs_properties_tree';
 import {Filter} from './operations/filter';
+import {TextFilter} from './text_filter';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 import {UiTreeFormatter} from './ui_tree_formatter';
 import {TreeNodeFilter, UiTreeUtils} from './ui_tree_utils';
 import {UserOptions} from './user_options';
 
 export class PropertiesPresenter {
-  private propertiesFilter: TreeNodeFilter = UiTreeUtils.makePropertyFilter('');
+  private propertiesFilter: TreeNodeFilter;
   private highlightedProperty = '';
   private propertiesTree: PropertyTreeNode | undefined;
   private formattedTree: UiPropertyTreeNode | undefined;
 
   constructor(
     private userOptions: UserOptions,
-    private denylistProperties: string[],
-  ) {}
+    private textFilter: TextFilter | undefined,
+    private propertiesDenylist: string[],
+    private customOperations?: Array<Operation<UiPropertyTreeNode>>,
+    private defaultAllowlist: string[] = [],
+  ) {
+    if (this.textFilter) {
+      this.propertiesFilter = UiTreeUtils.makeNodeFilter(
+        this.textFilter.filterString,
+        this.textFilter.flags,
+      );
+    } else {
+      this.propertiesFilter = UiTreeUtils.makeNodeFilter('');
+    }
+  }
 
-  getUserOptions() {
+  getUserOptions(): UserOptions {
     return this.userOptions;
   }
 
-  setPropertiesTree(tree: PropertyTreeNode) {
+  setPropertiesTree(tree: PropertyTreeNode | undefined) {
     this.propertiesTree = tree;
   }
 
-  getPropertiesTree() {
+  getPropertiesTree(): PropertyTreeNode | undefined {
     return this.propertiesTree;
   }
 
-  getFormattedTree() {
+  getFormattedTree(): UiPropertyTreeNode | undefined {
     return this.formattedTree;
   }
 
-  getHighlightedProperty() {
+  getHighlightedProperty(): string {
     return this.highlightedProperty;
   }
 
@@ -64,8 +78,16 @@ export class PropertiesPresenter {
     }
   }
 
-  applyPropertiesFilterChange(filterString: string) {
-    this.propertiesFilter = UiTreeUtils.makePropertyFilter(filterString);
+  getTextFilter(): TextFilter | undefined {
+    return this.textFilter;
+  }
+
+  applyPropertiesFilterChange(textFilter: TextFilter) {
+    this.textFilter = textFilter;
+    this.propertiesFilter = UiTreeUtils.makeNodeFilter(
+      textFilter.filterString,
+      textFilter.flags,
+    );
   }
 
   applyPropertiesUserOptionsChange(userOptions: UserOptions) {
@@ -95,7 +117,7 @@ export class PropertiesPresenter {
         : undefined;
       await new AddDiffsPropertiesTree(
         PropertiesPresenter.isPropertyNodeModified,
-        this.denylistProperties,
+        this.propertiesDenylist,
       ).executeInPlace(uiTree, prevEntryUiTree);
     }
 
@@ -106,27 +128,32 @@ export class PropertiesPresenter {
     const predicatesKeepingChildren = [this.propertiesFilter];
     const predicatesDiscardingChildren = [];
 
-    if (this.denylistProperties) {
+    if (this.propertiesDenylist) {
       predicatesDiscardingChildren.push(
-        UiTreeUtils.makeDenyListFilterByName(this.denylistProperties),
+        UiTreeUtils.makeDenyListFilterByName(this.propertiesDenylist),
       );
     }
 
     if (!this.userOptions['showDefaults']?.enabled) {
-      predicatesDiscardingChildren.push(UiTreeUtils.isNotDefault);
       predicatesDiscardingChildren.push(
-        UiTreeUtils.makePropertyMatchFilter('IDENTITY'),
+        UiTreeUtils.makeIsNotDefaultFilter(this.defaultAllowlist),
       );
     }
 
     if (!keepCalculated) {
       predicatesDiscardingChildren.push(UiTreeUtils.isNotCalculated);
     }
-    this.formattedTree = new UiTreeFormatter<UiPropertyTreeNode>()
-      .setUiTree(uiTree)
-      .addOperation(new Filter(predicatesDiscardingChildren, false))
-      .addOperation(new Filter(predicatesKeepingChildren, true))
-      .format();
+    const formatter = new UiTreeFormatter<UiPropertyTreeNode>().setUiTree(
+      uiTree,
+    );
+    if (predicatesDiscardingChildren.length > 0) {
+      formatter.addOperation(new Filter(predicatesDiscardingChildren, false));
+    }
+    formatter.addOperation(new Filter(predicatesKeepingChildren, true));
+
+    this.customOperations?.forEach((op) => formatter.addOperation(op));
+
+    this.formattedTree = formatter.format();
   }
 
   clear() {
diff --git a/tools/winscope/src/viewers/common/rect_filter.ts b/tools/winscope/src/viewers/common/rect_filter.ts
index a11af9d06..524d15895 100644
--- a/tools/winscope/src/viewers/common/rect_filter.ts
+++ b/tools/winscope/src/viewers/common/rect_filter.ts
@@ -14,26 +14,39 @@
  * limitations under the License.
  */
 
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {RectShowState} from './rect_show_state';
 
 export class RectFilter {
   private forcedStates = new Map<string, RectShowState>();
 
+  constructor(private convertToForcedStateKey: (id: string) => string) {}
+
   filterRects(
     rects: UiRect[],
     isOnlyVisibleMode: boolean,
-    isIgnoreNonHiddenMode: boolean,
+    isIgnoreRectShowStateMode: boolean,
+    isOnlyWithContentMode: boolean,
   ): UiRect[] {
-    if (!(isOnlyVisibleMode || !isIgnoreNonHiddenMode)) {
+    if (
+      !isOnlyVisibleMode &&
+      isIgnoreRectShowStateMode &&
+      !isOnlyWithContentMode
+    ) {
       return rects;
     }
     return rects.filter((rect) => {
+      const satisfiesHasContent = rect.hasContent || rect.isDisplay;
+      if (isOnlyWithContentMode && !satisfiesHasContent) {
+        return false;
+      }
+
       const satisfiesOnlyVisible = rect.isDisplay || rect.isVisible;
-      const forceHidden = this.forcedStates.get(rect.id) === RectShowState.HIDE;
-      const forceShow = this.forcedStates.get(rect.id) === RectShowState.SHOW;
+      const key = this.convertToForcedStateKey(rect.id);
+      const forceHidden = this.forcedStates.get(key) === RectShowState.HIDE;
+      const forceShow = this.forcedStates.get(key) === RectShowState.SHOW;
 
-      if (isOnlyVisibleMode && !isIgnoreNonHiddenMode) {
+      if (isOnlyVisibleMode && !isIgnoreRectShowStateMode) {
         return forceShow || (satisfiesOnlyVisible && !forceHidden);
       }
       if (isOnlyVisibleMode) {
@@ -49,7 +62,8 @@ export class RectFilter {
   ): Map<string, RectShowState> {
     const rectIdToShowState = new Map<string, RectShowState>();
     allRects.forEach((rect) => {
-      const forcedState = this.forcedStates.get(rect.id);
+      const key = this.convertToForcedStateKey(rect.id);
+      const forcedState = this.forcedStates.get(key);
       if (forcedState !== undefined) {
         rectIdToShowState.set(rect.id, forcedState);
         return;
@@ -62,6 +76,10 @@ export class RectFilter {
   }
 
   updateRectShowState(id: string, newShowState: RectShowState) {
-    this.forcedStates.set(id, newShowState);
+    this.forcedStates.set(this.convertToForcedStateKey(id), newShowState);
+  }
+
+  clear() {
+    this.forcedStates.clear();
   }
 }
diff --git a/tools/winscope/src/viewers/common/rect_filter_test.ts b/tools/winscope/src/viewers/common/rect_filter_test.ts
index 42e478ac4..a4a9b9c9c 100644
--- a/tools/winscope/src/viewers/common/rect_filter_test.ts
+++ b/tools/winscope/src/viewers/common/rect_filter_test.ts
@@ -14,24 +14,44 @@
  * limitations under the License.
  */
 
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 import {UiRectBuilder} from 'viewers/components/rects/ui_rect_builder';
 import {RectFilter} from './rect_filter';
 import {RectShowState} from './rect_show_state';
 
 describe('RectFilter', () => {
   let rectFilter: RectFilter;
-  const nonVisibleRect = makeRect('nonVisibleRect', false);
-  const visibleRect = makeRect('visibleRect', true);
-  const displayRect = makeRect('displayRect', false, true);
-  const allRects = [visibleRect, nonVisibleRect, displayRect];
-  const preFilteredRects = [visibleRect, nonVisibleRect];
+  const nonVisibleNoContentRect = makeRect(
+    'nonVisibleNoContentRect',
+    false,
+    false,
+  );
+  const nonVisibleContentRect = makeRect('nonVisibleContentRect', false, true);
+  const visibleContentRect = makeRect('visibleContentRect', true, true);
+  const visibleNoContentRect = makeRect('visibleNoContentRect', true, false);
+  const displayRect = makeRect('displayRect', false, false, true);
+  const allRects = [
+    visibleContentRect,
+    visibleNoContentRect,
+    nonVisibleContentRect,
+    nonVisibleNoContentRect,
+    displayRect,
+  ];
+  const preFilteredRects = [
+    visibleContentRect,
+    visibleNoContentRect,
+    nonVisibleContentRect,
+    nonVisibleNoContentRect,
+  ];
   let expectedRectIdToShowState: Map<string, RectShowState>;
 
   beforeEach(() => {
-    rectFilter = new RectFilter();
+    rectFilter = new RectFilter((id: string) => id);
     expectedRectIdToShowState = new Map([
-      [visibleRect.id, RectShowState.SHOW],
-      [nonVisibleRect.id, RectShowState.SHOW],
+      [visibleContentRect.id, RectShowState.SHOW],
+      [visibleNoContentRect.id, RectShowState.SHOW],
+      [nonVisibleContentRect.id, RectShowState.SHOW],
+      [nonVisibleNoContentRect.id, RectShowState.SHOW],
       [displayRect.id, RectShowState.SHOW],
     ]);
   });
@@ -56,21 +76,21 @@ describe('RectFilter', () => {
   });
 
   it('updates rect forced show state', () => {
-    expect(isShown(visibleRect.id)).toBeTrue();
+    expect(isShown(visibleContentRect.id)).toBeTrue();
 
     // robust to same state (RectShowState.SHOW)
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.SHOW);
-    expect(isShown(visibleRect.id)).toBeTrue();
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.SHOW);
+    expect(isShown(visibleContentRect.id)).toBeTrue();
 
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.HIDE);
-    expect(isShown(visibleRect.id)).toBeFalse();
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    expect(isShown(visibleContentRect.id)).toBeFalse();
 
     // robust to same state (RectShowState.HIDE)
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.HIDE);
-    expect(isShown(visibleRect.id)).toBeFalse();
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    expect(isShown(visibleContentRect.id)).toBeFalse();
 
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.SHOW);
-    expect(isShown(visibleRect.id)).toBeTrue();
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.SHOW);
+    expect(isShown(visibleContentRect.id)).toBeTrue();
 
     expect(isShown(displayRect.id)).toBeFalse();
     rectFilter.updateRectShowState(displayRect.id, RectShowState.SHOW);
@@ -78,58 +98,141 @@ describe('RectFilter', () => {
   });
 
   it('does not filter rects if applicable', () => {
-    expect(rectFilter.filterRects(allRects, false, true)).toEqual(allRects);
+    expect(rectFilter.filterRects(allRects, false, true, false)).toEqual(
+      allRects,
+    );
   });
 
   it('filters non visible rects', () => {
-    const filteredRects = rectFilter.filterRects(allRects, true, true);
-    expect(filteredRects).toEqual([visibleRect, displayRect]);
+    const filteredRects = rectFilter.filterRects(allRects, true, true, false);
+    expect(filteredRects).toEqual([
+      visibleContentRect,
+      visibleNoContentRect,
+      displayRect,
+    ]);
 
     // robust to all visible rects
-    expect(rectFilter.filterRects(filteredRects, true, true)).toEqual(
+    expect(rectFilter.filterRects(filteredRects, true, true, false)).toEqual(
       filteredRects,
     );
 
     // does not apply force-hide state
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.HIDE);
-    expect(rectFilter.filterRects(allRects, true, true)).toEqual(filteredRects);
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    expect(rectFilter.filterRects(allRects, true, true, false)).toEqual(
+      filteredRects,
+    );
 
     // does not apply force-show state
-    rectFilter.updateRectShowState(nonVisibleRect.id, RectShowState.SHOW);
-    expect(rectFilter.filterRects(allRects, true, true)).toEqual(filteredRects);
+    rectFilter.updateRectShowState(
+      nonVisibleContentRect.id,
+      RectShowState.SHOW,
+    );
+    expect(rectFilter.filterRects(allRects, true, true, false)).toEqual(
+      filteredRects,
+    );
   });
 
   it('applies show/hide states', () => {
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.HIDE);
-    const filteredRects = rectFilter.filterRects(allRects, false, false);
-    expect(filteredRects).toEqual([nonVisibleRect, displayRect]);
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    const filteredRects = rectFilter.filterRects(allRects, false, false, false);
+    expect(filteredRects).toEqual([
+      visibleNoContentRect,
+      nonVisibleContentRect,
+      nonVisibleNoContentRect,
+      displayRect,
+    ]);
 
     // robust to no change in show/hide states
-    expect(rectFilter.filterRects(filteredRects, false, false)).toEqual(
+    expect(rectFilter.filterRects(filteredRects, false, false, false)).toEqual(
       filteredRects,
     );
 
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.SHOW);
-    expect(rectFilter.filterRects(allRects, false, false)).toEqual(allRects);
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.SHOW);
+    expect(rectFilter.filterRects(allRects, false, false, false)).toEqual(
+      allRects,
+    );
   });
 
   it('filters non visible rects and applies show/hide states', () => {
     // does not remove force-shown non-visible rect
-    rectFilter.updateRectShowState(nonVisibleRect.id, RectShowState.SHOW);
-    expect(rectFilter.filterRects(allRects, true, false)).toEqual(allRects);
+    rectFilter.updateRectShowState(
+      nonVisibleContentRect.id,
+      RectShowState.SHOW,
+    );
+    rectFilter.updateRectShowState(
+      nonVisibleNoContentRect.id,
+      RectShowState.SHOW,
+    );
+    expect(rectFilter.filterRects(allRects, true, false, false)).toEqual(
+      allRects,
+    );
 
     // removes force-hidden visible rect
-    rectFilter.updateRectShowState(visibleRect.id, RectShowState.HIDE);
-    const filteredRects = rectFilter.filterRects(allRects, true, false);
-    expect(filteredRects).toEqual([nonVisibleRect, displayRect]);
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    const filteredRects = rectFilter.filterRects(allRects, true, false, false);
+    expect(filteredRects).toEqual([
+      visibleNoContentRect,
+      nonVisibleContentRect,
+      nonVisibleNoContentRect,
+      displayRect,
+    ]);
 
     // removes non-visible rect but keeps visible rect that has not had hide/show state applied
-    rectFilter.updateRectShowState(nonVisibleRect.id, RectShowState.HIDE);
-    expect(rectFilter.filterRects(allRects, true, false)).toEqual([
+    rectFilter.updateRectShowState(
+      nonVisibleNoContentRect.id,
+      RectShowState.HIDE,
+    );
+    expect(rectFilter.filterRects(allRects, true, false, false)).toEqual([
+      visibleNoContentRect,
+      nonVisibleContentRect,
       displayRect,
     ]);
   });
 
+  it('filters rects without content', () => {
+    const filteredRects = rectFilter.filterRects(allRects, false, true, true);
+    expect(filteredRects).toEqual([
+      visibleContentRect,
+      nonVisibleContentRect,
+      displayRect,
+    ]);
+
+    // robust to all rects with content
+    expect(rectFilter.filterRects(filteredRects, false, true, true)).toEqual(
+      filteredRects,
+    );
+  });
+
+  it('filters rects without content by show state and visibility', () => {
+    const filteredRects = rectFilter.filterRects(allRects, true, false, true);
+    expect(filteredRects).toEqual([visibleContentRect, displayRect]);
+
+    // does not apply force-hide state
+    rectFilter.updateRectShowState(visibleContentRect.id, RectShowState.HIDE);
+    expect(rectFilter.filterRects(allRects, true, true, true)).toEqual(
+      filteredRects,
+    );
+
+    // does not apply force-show state
+    rectFilter.updateRectShowState(
+      nonVisibleNoContentRect.id,
+      RectShowState.SHOW,
+    );
+    expect(rectFilter.filterRects(allRects, true, true, true)).toEqual(
+      filteredRects,
+    );
+  });
+
+  it('applies forced state key callback', () => {
+    const relaxedRectFilter = new RectFilter((id) =>
+      id.slice(id.length - 5, id.length - 1),
+    );
+    relaxedRectFilter.updateRectShowState('TestRect', RectShowState.HIDE);
+    expect(
+      relaxedRectFilter.filterRects(allRects, false, false, false),
+    ).toEqual([displayRect]);
+  });
+
   function isShown(rectId: string) {
     const nonHiddenRectIds = rectFilter.getRectIdToShowState(
       allRects,
@@ -138,30 +241,38 @@ describe('RectFilter', () => {
     return nonHiddenRectIds.get(rectId) === RectShowState.SHOW;
   }
 
-  function makeRect(id: string, isVisible: boolean, isDisplay = false) {
+  function makeRect(
+    id: string,
+    isVisible: boolean,
+    hasContent: boolean,
+    isDisplay = false,
+  ) {
     return new UiRectBuilder()
       .setX(0)
       .setY(0)
       .setWidth(1)
       .setHeight(1)
       .setLabel(id)
-      .setTransform({
-        dsdx: 1,
-        dsdy: 0,
-        dtdx: 0,
-        dtdy: 1,
-        tx: 0,
-        ty: 0,
-      })
+      .setTransform(
+        TransformMatrix.from({
+          dsdx: 1,
+          dsdy: 0,
+          dtdx: 0,
+          dtdy: 1,
+          tx: 0,
+          ty: 0,
+        }),
+      )
       .setIsVisible(isVisible)
       .setIsDisplay(isDisplay)
+      .setIsActiveDisplay(false)
       .setId(id)
       .setGroupId(0)
-      .setIsVirtual(false)
       .setIsClickable(false)
       .setCornerRadius(0)
       .setDepth(0)
       .setOpacity(0.5)
+      .setHasContent(hasContent)
       .build();
   }
 });
diff --git a/tools/winscope/src/viewers/common/rects_presenter.ts b/tools/winscope/src/viewers/common/rects_presenter.ts
index 581a10f15..51c45ac41 100644
--- a/tools/winscope/src/viewers/common/rects_presenter.ts
+++ b/tools/winscope/src/viewers/common/rects_presenter.ts
@@ -16,15 +16,15 @@
 
 import {Trace} from 'trace/trace';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {DisplayIdentifier} from './display_identifier';
 import {RectFilter} from './rect_filter';
 import {RectShowState} from './rect_show_state';
 import {UserOptions} from './user_options';
 
 export class RectsPresenter {
+  private readonly rectFilter = new RectFilter(this.convertToKey);
   private allCurrentRects: UiRect[] = [];
-  private rectFilter = new RectFilter();
   private rectsToDraw: UiRect[] = [];
   private displays: DisplayIdentifier[] = [];
   private rectIdToShowState: Map<string, RectShowState> | undefined;
@@ -36,21 +36,22 @@ export class RectsPresenter {
       trace: Trace<HierarchyTreeNode>,
     ) => UiRect[],
     private makeDisplaysStrategy?: (rects: UiRect[]) => DisplayIdentifier[],
+    private convertToKey: (rectId: string) => string = (id: string) => id,
   ) {}
 
-  getUserOptions() {
+  getUserOptions(): UserOptions {
     return this.userOptions;
   }
 
-  getRectsToDraw() {
+  getRectsToDraw(): UiRect[] {
     return this.rectsToDraw;
   }
 
-  getRectIdToShowState() {
+  getRectIdToShowState(): Map<string, RectShowState> | undefined {
     return this.rectIdToShowState;
   }
 
-  getDisplays() {
+  getDisplays(): DisplayIdentifier[] {
     return this.displays;
   }
 
@@ -83,6 +84,26 @@ export class RectsPresenter {
     this.updateRectsToDrawAndRectIdToShowState();
   }
 
+  updateRectShowStates(
+    rectIdToShowState: Map<string, RectShowState> | undefined,
+  ) {
+    this.rectFilter.clear();
+    if (rectIdToShowState) {
+      for (const [id, state] of rectIdToShowState.entries()) {
+        this.rectFilter.updateRectShowState(id, state);
+      }
+    }
+    this.updateRectsToDrawAndRectIdToShowState();
+  }
+
+  clear() {
+    this.allCurrentRects = [];
+    this.rectsToDraw = [];
+    this.displays = [];
+    this.rectIdToShowState = undefined;
+    this.rectFilter.clear();
+  }
+
   private updateRectsToDrawAndRectIdToShowState() {
     this.rectsToDraw = this.filterRects(this.allCurrentRects);
     this.rectIdToShowState = this.rectFilter.getRectIdToShowState(
@@ -94,12 +115,15 @@ export class RectsPresenter {
   private filterRects(rects: UiRect[]): UiRect[] {
     const isOnlyVisibleMode =
       this.userOptions['showOnlyVisible']?.enabled ?? false;
-    const isIgnoreHiddenMode =
-      this.userOptions['ignoreNonHidden']?.enabled ?? false;
+    const isIgnoreRectShowStateMode =
+      this.userOptions['ignoreRectShowState']?.enabled ?? false;
+    const isOnlyWithContentMode =
+      this.userOptions['showOnlyWithContent']?.enabled ?? false;
     return this.rectFilter.filterRects(
       rects,
       isOnlyVisibleMode,
-      isIgnoreHiddenMode,
+      isIgnoreRectShowStateMode,
+      isOnlyWithContentMode,
     );
   }
 }
diff --git a/tools/winscope/src/viewers/common/scroll_component_test_utils.ts b/tools/winscope/src/viewers/common/scroll_component_tests.ts
similarity index 83%
rename from tools/winscope/src/viewers/common/scroll_component_test_utils.ts
rename to tools/winscope/src/viewers/common/scroll_component_tests.ts
index de9aa9e82..15d65e0b8 100644
--- a/tools/winscope/src/viewers/common/scroll_component_test_utils.ts
+++ b/tools/winscope/src/viewers/common/scroll_component_tests.ts
@@ -24,13 +24,12 @@ import {ViewerTransactionsComponent} from 'viewers/viewer_transactions/viewer_tr
 type ScrollComponent = ViewerProtologComponent | ViewerTransactionsComponent;
 
 export function executeScrollComponentTests(
-  itemClassName: string,
   setUpTestEnvironment: () => Promise<
     [ComponentFixture<ScrollComponent>, HTMLElement, CdkVirtualScrollViewport]
   >,
 ) {
-  describe('', () => {
-    let fixture: ComponentFixture<any>;
+  describe('common tests', () => {
+    let fixture: ComponentFixture<ScrollComponent>;
     let htmlElement: HTMLElement;
     let viewport: CdkVirtualScrollViewport;
 
@@ -39,7 +38,7 @@ export function executeScrollComponentTests(
     });
 
     it('renders initial state', () => {
-      const items = htmlElement.querySelectorAll(`.${itemClassName}`)!;
+      const items = htmlElement.querySelectorAll('.entry');
       expect(items.length).toBe(20);
     });
 
@@ -52,13 +51,9 @@ export function executeScrollComponentTests(
     });
 
     it('should scroll to index in large jumps', () => {
-      expect(
-        htmlElement.querySelector(`.${itemClassName}[item-id="30"]`),
-      ).toBeFalsy();
+      expect(htmlElement.querySelector(`.entry[item-id="30"]`)).toBeFalsy();
       checkScrollToIndex(30);
-      expect(
-        htmlElement.querySelector(`.${itemClassName}[item-id="70"]`),
-      ).toBeFalsy();
+      expect(htmlElement.querySelector(`.entry[item-id="70"]`)).toBeFalsy();
       checkScrollToIndex(70);
     });
 
@@ -76,9 +71,7 @@ export function executeScrollComponentTests(
       viewport.elementRef.nativeElement.dispatchEvent(new Event('scroll'));
       animationFrameScheduler.flush();
       fixture.detectChanges();
-      assertDefined(
-        htmlElement.querySelector(`.${itemClassName}[item-id="${i}"]`),
-      );
+      assertDefined(htmlElement.querySelector(`.entry[item-id="${i}"]`));
     }
   });
 }
diff --git a/tools/winscope/src/viewers/common/text_filter.ts b/tools/winscope/src/viewers/common/text_filter.ts
new file mode 100644
index 000000000..3be558e64
--- /dev/null
+++ b/tools/winscope/src/viewers/common/text_filter.ts
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FilterFlag} from 'common/filter_flag';
+
+export class TextFilter {
+  constructor(public filterString: string, public flags: FilterFlag[]) {}
+}
diff --git a/tools/winscope/src/viewers/common/ui_data_hierarchy.ts b/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
index a69f7db0b..b99419f2a 100644
--- a/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
+++ b/tools/winscope/src/viewers/common/ui_data_hierarchy.ts
@@ -16,9 +16,10 @@
 
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {DisplayIdentifier} from './display_identifier';
 import {RectShowState} from './rect_show_state';
+import {TextFilter} from './text_filter';
 import {UiPropertyTreeNode} from './ui_property_tree_node';
 
 export interface UiDataHierarchy {
@@ -29,6 +30,9 @@ export interface UiDataHierarchy {
   propertiesUserOptions: UserOptions;
   propertiesTree: UiPropertyTreeNode | undefined;
   highlightedProperty: string;
+  hierarchyFilter: TextFilter;
+  propertiesFilter: TextFilter;
+  isDarkMode?: boolean;
   rectsToDraw?: UiRect[];
   rectIdToShowState?: Map<string, RectShowState> | undefined;
   displays?: DisplayIdentifier[];
diff --git a/tools/winscope/src/viewers/common/ui_data_log.ts b/tools/winscope/src/viewers/common/ui_data_log.ts
new file mode 100644
index 000000000..5bb05c5ad
--- /dev/null
+++ b/tools/winscope/src/viewers/common/ui_data_log.ts
@@ -0,0 +1,147 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Timestamp} from 'common/time';
+import {TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {UserOptions} from 'viewers/common/user_options';
+import {TextFilter} from './text_filter';
+import {UiPropertyTreeNode} from './ui_property_tree_node';
+
+export interface UiDataLog {
+  entries: LogEntry[];
+  selectedIndex: undefined | number;
+  scrollToIndex: undefined | number;
+
+  filters?: LogFilter[];
+  headers?: LogFieldType[];
+  currentIndex?: undefined | number;
+  propertiesTree?: undefined | UiPropertyTreeNode;
+  propertiesUserOptions?: UserOptions;
+  propertiesFilter?: TextFilter;
+  isDarkMode?: boolean;
+}
+
+export interface LogFilter {
+  type: LogFieldType;
+  options?: string[];
+  textFilter?: TextFilter;
+}
+
+export interface LogEntry {
+  traceEntry: TraceEntry<PropertyTreeNode>;
+  fields: LogField[];
+  propertiesTree?: undefined | PropertyTreeNode;
+}
+
+export interface LogField {
+  type: LogFieldType;
+  value: LogFieldValue;
+  icon?: string;
+  iconColor?: string;
+}
+
+export type LogFieldValue = string | number | Timestamp;
+
+export enum LogFieldType {
+  TRANSACTION_ID,
+  VSYNC_ID,
+  PID,
+  UID,
+  TRANSACTION_TYPE,
+  LAYER_OR_DISPLAY_ID,
+  FLAGS,
+  LOG_LEVEL,
+  TAG,
+  SOURCE_FILE,
+  TEXT,
+  TRANSITION_ID,
+  TRANSITION_TYPE,
+  SEND_TIME,
+  DISPATCH_TIME,
+  DURATION,
+  STATUS,
+  CUJ_TYPE,
+  START_TIME,
+  END_TIME,
+  INPUT_TYPE,
+  INPUT_SOURCE,
+  INPUT_ACTION,
+  INPUT_DEVICE_ID,
+  INPUT_DISPLAY_ID,
+  INPUT_EVENT_DETAILS,
+  INPUT_DISPATCH_WINDOWS,
+}
+
+export const LogFieldNames: ReadonlyMap<LogFieldType, string> = new Map([
+  [LogFieldType.TRANSACTION_ID, 'TX ID'],
+  [LogFieldType.VSYNC_ID, 'VSYNC ID'],
+  [LogFieldType.PID, 'PID'],
+  [LogFieldType.UID, 'UID'],
+  [LogFieldType.TRANSACTION_TYPE, 'TYPE'],
+  [LogFieldType.LAYER_OR_DISPLAY_ID, 'LAYER/DISP ID'],
+  [LogFieldType.FLAGS, 'Flags'],
+  [LogFieldType.LOG_LEVEL, 'Log level'],
+  [LogFieldType.TAG, 'Tag'],
+  [LogFieldType.SOURCE_FILE, 'Source files'],
+  [LogFieldType.TEXT, 'Search text'],
+  [LogFieldType.TRANSITION_ID, 'Id'],
+  [LogFieldType.TRANSITION_TYPE, 'Type'],
+  [LogFieldType.SEND_TIME, 'Send Time'],
+  [LogFieldType.DISPATCH_TIME, 'Dispatch Time'],
+  [LogFieldType.DURATION, 'Duration'],
+  [LogFieldType.STATUS, 'Status'],
+  [LogFieldType.CUJ_TYPE, 'Type'],
+  [LogFieldType.START_TIME, 'Start Time'],
+  [LogFieldType.END_TIME, 'End Time'],
+  [LogFieldType.INPUT_TYPE, 'Type'],
+  [LogFieldType.INPUT_SOURCE, 'Source'],
+  [LogFieldType.INPUT_ACTION, 'Action'],
+  [LogFieldType.INPUT_DEVICE_ID, 'Device'],
+  [LogFieldType.INPUT_DISPLAY_ID, 'Display'],
+  [LogFieldType.INPUT_EVENT_DETAILS, 'Details'],
+  [LogFieldType.INPUT_DISPATCH_WINDOWS, 'Target Windows'],
+]);
+
+export const LogFieldClassNames: ReadonlyMap<LogFieldType, string> = new Map([
+  [LogFieldType.TRANSACTION_ID, 'transaction-id right-align'],
+  [LogFieldType.VSYNC_ID, 'vsyncid right-align'],
+  [LogFieldType.PID, 'pid right-align'],
+  [LogFieldType.UID, 'uid right-align'],
+  [LogFieldType.TRANSACTION_TYPE, 'transaction-type'],
+  [LogFieldType.LAYER_OR_DISPLAY_ID, 'layer-or-display-id right-align'],
+  [LogFieldType.FLAGS, 'flags'],
+  [LogFieldType.LOG_LEVEL, 'log-level'],
+  [LogFieldType.TAG, 'tag'],
+  [LogFieldType.SOURCE_FILE, 'source-file'],
+  [LogFieldType.TEXT, 'text'],
+  [LogFieldType.TRANSITION_ID, 'transition-id right-align'],
+  [LogFieldType.TRANSITION_TYPE, 'transition-type'],
+  [LogFieldType.CUJ_TYPE, 'jank_cuj-type'],
+  [LogFieldType.SEND_TIME, 'send-time time'],
+  [LogFieldType.DISPATCH_TIME, 'dispatch-time time'],
+  [LogFieldType.START_TIME, 'start-time time'],
+  [LogFieldType.END_TIME, 'end-time time'],
+  [LogFieldType.DURATION, 'duration right-align'],
+  [LogFieldType.STATUS, 'status right-align'],
+  [LogFieldType.INPUT_TYPE, 'input-type inline'],
+  [LogFieldType.INPUT_SOURCE, 'input-source'],
+  [LogFieldType.INPUT_ACTION, 'input-action'],
+  [LogFieldType.INPUT_DEVICE_ID, 'input-device-id right-align'],
+  [LogFieldType.INPUT_DISPLAY_ID, 'input-display-id right-align'],
+  [LogFieldType.INPUT_EVENT_DETAILS, 'input-details'],
+  [LogFieldType.INPUT_DISPATCH_WINDOWS, 'input-windows'],
+]);
diff --git a/tools/winscope/src/viewers/common/ui_rect_factory.ts b/tools/winscope/src/viewers/common/ui_rect_factory.ts
index 015b8b2ef..8c24820c3 100644
--- a/tools/winscope/src/viewers/common/ui_rect_factory.ts
+++ b/tools/winscope/src/viewers/common/ui_rect_factory.ts
@@ -17,7 +17,7 @@
 import {assertDefined} from 'common/assert_utils';
 import {TraceRect} from 'trace/trace_rect';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UiRectBuilder} from 'viewers/components/rects/ui_rect_builder';
 
 class UiRectFactory {
@@ -36,9 +36,9 @@ class UiRectFactory {
         .setTransform(traceRect.transform)
         .setIsVisible(traceRect.isVisible)
         .setIsDisplay(traceRect.isDisplay)
+        .setIsActiveDisplay(traceRect.isActiveDisplay)
         .setId(traceRect.id)
         .setGroupId(traceRect.groupId)
-        .setIsVirtual(traceRect.isVirtual)
         .setIsClickable(!traceRect.isDisplay)
         .setCornerRadius(traceRect.cornerRadius)
         .setHasContent(
@@ -66,9 +66,9 @@ class UiRectFactory {
         .setTransform(traceRect.transform)
         .setIsVisible(traceRect.isVisible)
         .setIsDisplay(traceRect.isDisplay)
+        .setIsActiveDisplay(traceRect.isActiveDisplay)
         .setId(traceRect.id)
         .setGroupId(groupId)
-        .setIsVirtual(traceRect.isVirtual)
         .setIsClickable(true)
         .setCornerRadius(traceRect.cornerRadius)
         .setHasContent(traceRect.isVisible)
@@ -78,11 +78,47 @@ class UiRectFactory {
     });
   }
 
-  private extractRects(hierarchyRoot: HierarchyTreeNode): TraceRect[] {
+  makeInputRects(
+    hierarchyRoot: HierarchyTreeNode,
+    hasContent: (id: string) => boolean,
+  ): UiRect[] {
+    const traceRects = this.extractRects(hierarchyRoot, (node) =>
+      // The root node contains the display rects, so use the primary rects for the displays.
+      // For nodes, the input windows are the secondary rects.
+      node.isRoot() ? node.getRects() : node.getSecondaryRects(),
+    );
+    return traceRects.map((traceRect) => {
+      const opacity = traceRect.isDisplay ? 1 : traceRect.isSpy ? 0.25 : 0.9;
+      return new UiRectBuilder()
+        .setX(traceRect.x)
+        .setY(traceRect.y)
+        .setWidth(traceRect.w)
+        .setHeight(traceRect.h)
+        .setLabel(traceRect.name)
+        .setTransform(traceRect.transform)
+        .setIsVisible(traceRect.isVisible)
+        .setIsDisplay(traceRect.isDisplay)
+        .setIsActiveDisplay(traceRect.isActiveDisplay)
+        .setId(traceRect.id)
+        .setGroupId(traceRect.groupId)
+        .setIsClickable(true)
+        .setCornerRadius(traceRect.cornerRadius)
+        .setHasContent(hasContent(traceRect.id))
+        .setDepth(traceRect.depth)
+        .setOpacity(opacity)
+        .setFillRegion(traceRect.fillRegion)
+        .build();
+    });
+  }
+
+  private extractRects(
+    hierarchyRoot: HierarchyTreeNode,
+    extractNodeRects = (node: HierarchyTreeNode) => node.getRects(),
+  ): TraceRect[] {
     const rects: TraceRect[] = [];
 
     hierarchyRoot.forEachNodeDfs((node) => {
-      const nodeRects = node.getRects();
+      const nodeRects = extractNodeRects(node);
       if (nodeRects && nodeRects.length > 0) {
         rects.push(...nodeRects);
       }
diff --git a/tools/winscope/src/viewers/common/ui_rect_factory_test.ts b/tools/winscope/src/viewers/common/ui_rect_factory_test.ts
index 506632759..a3d904964 100644
--- a/tools/winscope/src/viewers/common/ui_rect_factory_test.ts
+++ b/tools/winscope/src/viewers/common/ui_rect_factory_test.ts
@@ -19,7 +19,7 @@ import {Transform} from 'parsers/surface_flinger/transform_utils';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceRectBuilder} from 'trace/trace_rect_builder';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UiRectBuilder} from 'viewers/components/rects/ui_rect_builder';
 import {UI_RECT_FACTORY} from './ui_rect_factory';
 
@@ -57,8 +57,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(false)
       .setDepth(0)
       .setOpacity(0.5)
@@ -76,8 +76,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(false)
       .setDepth(1)
       .setOpacity(0.5)
@@ -88,6 +88,33 @@ describe('UI_RECT_FACTORY', () => {
     expect(UI_RECT_FACTORY.makeUiRects(hierarchyRoot)).toEqual(expectedRects);
   });
 
+  it('makes rects with data from trace rect', () => {
+    buildRectAndSetToNode(node2, 1, 5, 10, true, true, false, true);
+
+    const expectedUiRect2 = new UiRectBuilder()
+      .setX(0)
+      .setY(0)
+      .setWidth(5)
+      .setHeight(10)
+      .setId('2 node2')
+      .setLabel('node2')
+      .setCornerRadius(0)
+      .setGroupId(0)
+      .setTransform(Transform.EMPTY.matrix)
+      .setIsVisible(true)
+      .setIsDisplay(true)
+      .setIsActiveDisplay(true)
+      .setIsClickable(false)
+      .setHasContent(false)
+      .setDepth(1)
+      .setOpacity(0.5)
+      .build();
+
+    const expectedRects: UiRect[] = [expectedUiRect2];
+
+    expect(UI_RECT_FACTORY.makeUiRects(hierarchyRoot)).toEqual(expectedRects);
+  });
+
   it('handles depth order different to dfs order', () => {
     buildRectAndSetToNode(node1, 1);
     buildRectAndSetToNode(node2, 0);
@@ -104,8 +131,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(false)
       .setDepth(1)
       .setOpacity(0.5)
@@ -123,8 +150,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(false)
       .setDepth(0)
       .setOpacity(0.5)
@@ -152,8 +179,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(true)
       .setDepth(1)
       .setOpacity(0.5)
@@ -171,8 +198,8 @@ describe('UI_RECT_FACTORY', () => {
       .setTransform(Transform.EMPTY.matrix)
       .setIsVisible(true)
       .setIsDisplay(false)
+      .setIsActiveDisplay(false)
       .setIsClickable(true)
-      .setIsVirtual(false)
       .setHasContent(true)
       .setDepth(0)
       .setOpacity(0.5)
@@ -193,11 +220,94 @@ describe('UI_RECT_FACTORY', () => {
     expect(UI_RECT_FACTORY.makeVcUiRects(hierarchyRoot, GROUP_ID)).toEqual([]);
   });
 
+  it('makes input rects', () => {
+    // The root of the hierarchy should contain the display info in the primary rects.
+    buildRectAndSetToNode(hierarchyRoot, 0, 1, 1, true, true);
+    // The rest of the nodes should contain input windows in the secondary rects.
+    // The opacity is determined by whether the window is a spy and display.
+    buildRectAndSetToNode(node1, 1, 1, 1, false, false, true);
+    buildRectAndSetToNode(node2, 2, 1, 1, false, false, false);
+
+    function hasContent(id: string) {
+      return id === node1.id;
+    }
+
+    const expectedRootRect = new UiRectBuilder()
+      .setX(0)
+      .setY(0)
+      .setWidth(1)
+      .setHeight(1)
+      .setId('TreeEntry root')
+      .setLabel('root')
+      .setCornerRadius(0)
+      .setGroupId(0)
+      .setTransform(Transform.EMPTY.matrix)
+      .setIsVisible(true)
+      .setIsDisplay(true)
+      .setIsActiveDisplay(false)
+      .setIsClickable(true)
+      .setHasContent(false)
+      .setDepth(0)
+      .setOpacity(1)
+      .build();
+
+    const expectedInputRect1 = new UiRectBuilder()
+      .setX(0)
+      .setY(0)
+      .setWidth(1)
+      .setHeight(1)
+      .setId('1 node1')
+      .setLabel('node1')
+      .setCornerRadius(0)
+      .setGroupId(0)
+      .setTransform(Transform.EMPTY.matrix)
+      .setIsVisible(true)
+      .setIsDisplay(false)
+      .setIsActiveDisplay(false)
+      .setIsClickable(true)
+      .setHasContent(true)
+      .setDepth(1)
+      .setOpacity(0.25)
+      .build();
+
+    const expectedInputRect2 = new UiRectBuilder()
+      .setX(0)
+      .setY(0)
+      .setWidth(1)
+      .setHeight(1)
+      .setId('2 node2')
+      .setLabel('node2')
+      .setCornerRadius(0)
+      .setGroupId(0)
+      .setTransform(Transform.EMPTY.matrix)
+      .setIsVisible(true)
+      .setIsDisplay(false)
+      .setIsActiveDisplay(false)
+      .setIsClickable(true)
+      .setHasContent(false)
+      .setDepth(2)
+      .setOpacity(0.9)
+      .build();
+
+    const expectedRects: UiRect[] = [
+      expectedRootRect,
+      expectedInputRect1,
+      expectedInputRect2,
+    ];
+    expect(UI_RECT_FACTORY.makeInputRects(hierarchyRoot, hasContent)).toEqual(
+      expectedRects,
+    );
+  });
+
   function buildRectAndSetToNode(
     node: HierarchyTreeNode,
     depth: number,
     width = 1,
     height = 1,
+    isPrimary = true,
+    isDisplay = false,
+    isSpy = false,
+    isActiveDisplay = false,
   ) {
     const rect = new TraceRectBuilder()
       .setX(0)
@@ -211,11 +321,12 @@ describe('UI_RECT_FACTORY', () => {
       .setDepth(depth)
       .setGroupId(0)
       .setIsVisible(true)
-      .setIsDisplay(false)
-      .setIsVirtual(false)
+      .setIsDisplay(isDisplay)
+      .setIsActiveDisplay(isActiveDisplay)
       .setOpacity(0.5)
+      .setIsSpy(isSpy)
       .build();
 
-    node.setRects([rect]);
+    isPrimary ? node.setRects([rect]) : node.setSecondaryRects([rect]);
   }
 });
diff --git a/tools/winscope/src/viewers/common/ui_tree_formatter.ts b/tools/winscope/src/viewers/common/ui_tree_formatter.ts
index 9a7a1b3c3..fbaa94133 100644
--- a/tools/winscope/src/viewers/common/ui_tree_formatter.ts
+++ b/tools/winscope/src/viewers/common/ui_tree_formatter.ts
@@ -34,7 +34,7 @@ export class UiTreeFormatter<T extends TreeNode> {
 
   format(): T {
     if (this.uiTree === undefined) {
-      throw Error('tree not set');
+      throw new Error('tree not set');
     }
 
     return this.operations.apply(this.uiTree);
diff --git a/tools/winscope/src/viewers/common/ui_tree_utils.ts b/tools/winscope/src/viewers/common/ui_tree_utils.ts
index c385d28d4..6baedd871 100644
--- a/tools/winscope/src/viewers/common/ui_tree_utils.ts
+++ b/tools/winscope/src/viewers/common/ui_tree_utils.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {FilterFlag, makeFilterPredicate} from 'common/filter_flag';
 import {
   PropertySource,
   PropertyTreeNode,
@@ -37,12 +38,15 @@ export class UiTreeUtils {
     );
   };
 
-  static isNotDefault: TreeNodeFilter = (node: TreeNode) => {
-    return (
-      node instanceof UiPropertyTreeNode &&
-      node.source !== PropertySource.DEFAULT
-    );
-  };
+  static makeIsNotDefaultFilter(allowList: string[]): TreeNodeFilter {
+    return (node: TreeNode) => {
+      return (
+        node instanceof UiPropertyTreeNode &&
+        (node.source !== PropertySource.DEFAULT ||
+          allowList.includes(node.name))
+      );
+    };
+  }
 
   static isNotCalculated: TreeNodeFilter = (node: TreeNode) => {
     return (
@@ -51,47 +55,27 @@ export class UiTreeUtils {
     );
   };
 
-  static makeIdFilter(filterString: string): TreeNodeFilter {
-    const filter = (node: TreeNode) => {
-      const regex = new RegExp(filterString, 'i');
-      return filterString.length === 0 || regex.test(node.id);
-    };
-    return filter;
-  }
-
-  static makePropertyFilter(filterString: string): TreeNodeFilter {
-    const filter = (node: TreeNode) => {
-      const regex = new RegExp(filterString, 'i');
+  static makeNodeFilter(
+    filterString: string,
+    flags: FilterFlag[] = [],
+  ): TreeNodeFilter {
+    const predicate = makeFilterPredicate(filterString, flags);
+    return (node: TreeNode) => {
       return (
-        filterString.length === 0 ||
-        regex.test(node.name) ||
-        (node instanceof PropertyTreeNode && regex.test(node.formattedValue()))
+        predicate(node.id) ||
+        (node instanceof PropertyTreeNode && predicate(node.formattedValue()))
       );
     };
-    return filter;
   }
 
   static makeIdMatchFilter(targetId: string): TreeNodeFilter {
     return (node: TreeNode) => node.id === targetId;
   }
 
-  static makePropertyMatchFilter(targetValue: string): TreeNodeFilter {
-    return (node: TreeNode) => {
-      return (
-        node instanceof UiPropertyTreeNode &&
-        node.formattedValue() !== targetValue
-      );
-    };
-  }
-
   static makeDenyListFilterByName(denylist: string[]): TreeNodeFilter {
     return (node: TreeNode) => !denylist.includes(node.name);
   }
 
-  static makeAllowListFilterById(allowlist: string[]): TreeNodeFilter {
-    return (node: TreeNode) => allowlist.includes(node.id);
-  }
-
   static shouldGetProperties(node: UiHierarchyTreeNode): boolean {
     return !node.isOldNode() || node.getDiff() === DiffType.DELETED;
   }
diff --git a/tools/winscope/src/viewers/common/variable_height_scroll_strategy.ts b/tools/winscope/src/viewers/common/variable_height_scroll_strategy.ts
index 1ac231e80..aaa74858a 100644
--- a/tools/winscope/src/viewers/common/variable_height_scroll_strategy.ts
+++ b/tools/winscope/src/viewers/common/variable_height_scroll_strategy.ts
@@ -80,8 +80,9 @@ export abstract class VariableHeightScrollStrategy
     if (!this.viewport) {
       return;
     }
-
-    const offset = this.getOffsetByItemIndex(index);
+    // scroll previous index to top, so when previous index is partially rendered the target index is still fully rendered
+    const previousIndex = Math.max(0, index - 1);
+    const offset = this.getOffsetByItemIndex(previousIndex);
     this.viewport.scrollToOffset(offset);
   }
 
diff --git a/tools/winscope/src/viewers/common/viewer_events.ts b/tools/winscope/src/viewers/common/viewer_events.ts
index a1e6c62f0..778a31b8a 100644
--- a/tools/winscope/src/viewers/common/viewer_events.ts
+++ b/tools/winscope/src/viewers/common/viewer_events.ts
@@ -15,46 +15,36 @@
  */
 
 import {Timestamp} from 'common/time';
+import {TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {TextFilter} from './text_filter';
+import {LogFieldType} from './ui_data_log';
 
-export class ViewerEvents {
-  static HighlightedNodeChange = 'HighlightedNodeChange';
-  static HighlightedIdChange = 'HighlightedIdChange';
+export enum ViewerEvents {
+  HighlightedNodeChange = 'HighlightedNodeChange',
+  HighlightedIdChange = 'HighlightedIdChange',
 
-  static HierarchyPinnedChange = 'HierarchyPinnedChange';
-  static HierarchyUserOptionsChange = 'HierarchyUserOptionsChange';
-  static HierarchyFilterChange = 'HierarchyFilterChange';
-  static RectShowStateChange = 'RectShowStateChange';
+  HierarchyPinnedChange = 'HierarchyPinnedChange',
+  HierarchyUserOptionsChange = 'HierarchyUserOptionsChange',
+  HierarchyFilterChange = 'HierarchyFilterChange',
+  RectShowStateChange = 'RectShowStateChange',
 
-  static PropertiesUserOptionsChange = 'PropertiesUserOptionsChange';
-  static PropertiesFilterChange = 'PropertiesFilterChange';
-  static HighlightedPropertyChange = 'HighlightedPropertyChange';
+  PropertiesUserOptionsChange = 'PropertiesUserOptionsChange',
+  PropertiesFilterChange = 'PropertiesFilterChange',
+  HighlightedPropertyChange = 'HighlightedPropertyChange',
 
-  static RectGroupIdChange = 'RectGroupIdChange';
-  static RectsUserOptionsChange = 'RectsUserOptionsChange';
+  RectsUserOptionsChange = 'RectsUserOptionsChange',
 
-  static AdditionalPropertySelected = 'AdditionalPropertySelected';
-  static RectsDblClick = 'RectsDblClick';
-  static MiniRectsDblClick = 'MiniRectsDblClick';
+  AdditionalPropertySelected = 'AdditionalPropertySelected',
+  RectsDblClick = 'RectsDblClick',
+  MiniRectsDblClick = 'MiniRectsDblClick',
 
-  static TimestampClick = 'TimestampClick';
-
-  static LogLevelsFilterChanged = 'LogLevelsFilterChanged';
-  static TagsFilterChanged = 'TagsFilterChanged';
-  static SourceFilesFilterChanged = 'SourceFilesFilterChanged';
-  static SearchStringFilterChanged = 'SearchStringFilterChanged';
-
-  static VSyncIdFilterChanged = 'VSyncIdFilterChanged';
-  static PidFilterChanged = 'PidFilterChanged';
-  static UidFilterChanged = 'UidFilterChanged';
-  static TypeFilterChanged = 'TypeFilterChanged';
-  static LayerIdFilterChanged = 'LayerIdFilterChanged';
-  static WhatFilterChanged = 'WhatFilterChanged';
-
-  static LogClicked = 'LogClicked';
-
-  static LogChangedByKeyPress = 'LogChangedByKeyPress';
-  static TransactionIdFilterChanged = 'TransactionIdFilterChanged';
-  static TransitionSelected = 'TransitionSelected';
+  TimestampClick = 'TimestampClick',
+  LogEntryClick = 'LogEntryClick',
+  LogFilterChange = 'LogFilterChange',
+  LogTextFilterChange = 'LogTextFilterChange',
+  ArrowDownPress = 'ArrowDownPress',
+  ArrowUpPress = 'ArrowUpPress',
 }
 
 export class RectDblClickDetail {
@@ -62,5 +52,16 @@ export class RectDblClickDetail {
 }
 
 export class TimestampClickDetail {
-  constructor(public timestamp?: Timestamp, public index?: number) {}
+  constructor(
+    public entry?: TraceEntry<PropertyTreeNode>,
+    public timestamp?: Timestamp,
+  ) {}
+}
+
+export class LogFilterChangeDetail {
+  constructor(public type: LogFieldType, public value: string[] | string) {}
+}
+
+export class LogTextFilterChangeDetail {
+  constructor(public type: LogFieldType, public filter: TextFilter) {}
 }
diff --git a/tools/winscope/src/viewers/components/hierarchy_component.ts b/tools/winscope/src/viewers/components/hierarchy_component.ts
index 5f068428b..be78859e5 100644
--- a/tools/winscope/src/viewers/components/hierarchy_component.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_component.ts
@@ -21,17 +21,18 @@ import {
   Input,
   Output,
 } from '@angular/core';
+import {Color} from 'app/colors';
 import {PersistentStore} from 'common/persistent_store';
 import {Analytics} from 'logging/analytics';
 import {TraceType} from 'trace/trace_type';
 import {RectShowState} from 'viewers/common/rect_show_state';
 import {TableProperties} from 'viewers/common/table_properties';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {UserOptions} from 'viewers/common/user_options';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {nodeStyles} from 'viewers/components/styles/node.styles';
-import {searchBoxStyle} from './styles/search_box.styles';
 import {viewerCardInnerStyle} from './styles/viewer_card.styles';
 
 @Component({
@@ -43,14 +44,9 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
           class="hierarchy-title"
           title="HIERARCHY"
           (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
-        <mat-form-field class="search-box" (keydown.enter)="$event.target.blur()">
-          <mat-label>Search</mat-label>
-          <input
-            matInput
-            [(ngModel)]="filterString"
-            (ngModelChange)="onFilterChange()"
-            name="filter" />
-        </mat-form-field>
+        <search-box
+          [textFilter]="textFilter"
+          (filterChange)="onFilterChange($event)"></search-box>
       </div>
       <user-options
         class="view-controls"
@@ -79,6 +75,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       </div>
     </div>
     <mat-divider></mat-divider>
+    <span class="mat-body-1 placeholder-text" *ngIf="showPlaceholderText()"> {{ placeholderText }} </span>
     <div class="hierarchy-content tree-wrapper">
       <tree-view
         *ngIf="tree"
@@ -130,7 +127,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       .pinned-items {
         width: 100%;
         box-sizing: border-box;
-        border: 2px solid #ffd58b;
+        border: 2px solid ${Color.PINNED_ITEM_BORDER};
       }
 
       tree-view {
@@ -138,12 +135,10 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       }
     `,
     nodeStyles,
-    searchBoxStyle,
     viewerCardInnerStyle,
   ],
 })
 export class HierarchyComponent {
-  filterString = '';
   isHighlighted = UiTreeUtils.isHighlighted;
   ViewerEvents = ViewerEvents;
   Analytics = Analytics;
@@ -157,6 +152,8 @@ export class HierarchyComponent {
   @Input() store: PersistentStore | undefined;
   @Input() userOptions: UserOptions = {};
   @Input() rectIdToShowState?: Map<string, RectShowState>;
+  @Input() placeholderText = 'No entry found.';
+  @Input() textFilter: TextFilter | undefined;
 
   @Output() collapseButtonClicked = new EventEmitter();
 
@@ -166,10 +163,14 @@ export class HierarchyComponent {
     return child.id;
   }
 
-  isFlattened() {
+  isFlattened(): boolean {
     return this.userOptions['flat']?.enabled;
   }
 
+  showPlaceholderText(): boolean {
+    return !this.tree && (this.subtrees?.length ?? 0) === 0;
+  }
+
   onPinnedNodeClick(event: MouseEvent, pinnedItem: UiHierarchyTreeNode) {
     event.preventDefault();
     if (window.getSelection()?.type === 'range') {
@@ -178,10 +179,10 @@ export class HierarchyComponent {
     this.onHighlightedItemChange(pinnedItem);
   }
 
-  onFilterChange() {
+  onFilterChange(detail: TextFilter) {
     const event = new CustomEvent(ViewerEvents.HierarchyFilterChange, {
       bubbles: true,
-      detail: {filterString: this.filterString},
+      detail,
     });
     this.elementRef.nativeElement.dispatchEvent(event);
   }
diff --git a/tools/winscope/src/viewers/components/hierarchy_component_test.ts b/tools/winscope/src/viewers/components/hierarchy_component_test.ts
index e00ceb1ac..bbb28f0b4 100644
--- a/tools/winscope/src/viewers/components/hierarchy_component_test.ts
+++ b/tools/winscope/src/viewers/components/hierarchy_component_test.ts
@@ -13,6 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+import {ClipboardModule} from '@angular/cdk/clipboard';
 import {CommonModule} from '@angular/common';
 import {
   ComponentFixture,
@@ -28,9 +29,11 @@ import {MatInputModule} from '@angular/material/input';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
+import {FilterFlag} from 'common/filter_flag';
 import {PersistentStore} from 'common/persistent_store';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceType} from 'trace/trace_type';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {HierarchyTreeNodeDataViewComponent} from 'viewers/components/hierarchy_tree_node_data_view_component';
@@ -38,6 +41,7 @@ import {TreeComponent} from 'viewers/components/tree_component';
 import {TreeNodeComponent} from 'viewers/components/tree_node_component';
 import {CollapsibleSectionTitleComponent} from './collapsible_section_title_component';
 import {HierarchyComponent} from './hierarchy_component';
+import {SearchBoxComponent} from './search_box_component';
 import {UserOptionsComponent} from './user_options_component';
 
 describe('HierarchyComponent', () => {
@@ -55,6 +59,7 @@ describe('HierarchyComponent', () => {
         HierarchyTreeNodeDataViewComponent,
         CollapsibleSectionTitleComponent,
         UserOptionsComponent,
+        SearchBoxComponent,
       ],
       imports: [
         CommonModule,
@@ -66,6 +71,7 @@ describe('HierarchyComponent', () => {
         FormsModule,
         MatIconModule,
         MatTooltipModule,
+        ClipboardModule,
       ],
     }).compileComponents();
 
@@ -89,6 +95,7 @@ describe('HierarchyComponent', () => {
         isUnavailable: false,
       },
     };
+    component.textFilter = new TextFilter('', []);
     component.dependencies = [TraceType.SURFACE_FLINGER];
 
     fixture.detectChanges();
@@ -140,6 +147,15 @@ describe('HierarchyComponent', () => {
     expect(pinnedNodeEl).toBeTruthy();
   });
 
+  it('renders placeholder text', () => {
+    component.tree = undefined;
+    component.placeholderText = 'Placeholder text';
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.placeholder-text')?.textContent,
+    ).toContain('Placeholder text');
+  });
+
   it('handles pinned node click', () => {
     const node = assertDefined(component.tree);
     component.pinnedItems = [node];
@@ -184,21 +200,26 @@ describe('HierarchyComponent', () => {
   });
 
   it('handles change in filter', () => {
-    let filterString: string | undefined;
+    let textFilter: TextFilter | undefined;
     htmlElement.addEventListener(
       ViewerEvents.HierarchyFilterChange,
       (event) => {
-        filterString = (event as CustomEvent).detail.filterString;
+        textFilter = (event as CustomEvent).detail;
       },
     );
     const inputEl = assertDefined(
-      htmlElement.querySelector('.title-section input'),
-    ) as HTMLInputElement;
+      htmlElement.querySelector<HTMLInputElement>('.title-section input'),
+    );
+    const flagButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.search-box button'),
+    );
+    flagButton.click();
+    fixture.detectChanges();
 
     inputEl.value = 'Root';
     inputEl.dispatchEvent(new Event('input'));
     fixture.detectChanges();
-    expect(filterString).toBe('Root');
+    expect(textFilter).toEqual(new TextFilter('Root', [FilterFlag.MATCH_CASE]));
   });
 
   it('handles collapse button click', () => {
diff --git a/tools/winscope/src/viewers/components/ime_additional_properties_component.ts b/tools/winscope/src/viewers/components/ime_additional_properties_component.ts
index 32c31a2db..a67206b40 100644
--- a/tools/winscope/src/viewers/components/ime_additional_properties_component.ts
+++ b/tools/winscope/src/viewers/components/ime_additional_properties_component.ts
@@ -43,6 +43,9 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         title="WM & SF PROPERTIES"
         (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
     </div>
+
+    <span class="mat-body-1 placeholder-text" *ngIf="!additionalProperties"> No IME entry found. </span>
+
     <div class="additional-properties-content" *ngIf="additionalProperties">
       <div *ngIf="isAllPropertiesUndefined()" class="group">
         <p class="mat-body-1">
diff --git a/tools/winscope/src/viewers/components/ime_additional_properties_component_test.ts b/tools/winscope/src/viewers/components/ime_additional_properties_component_test.ts
index cc5becbfc..f8a4fab67 100644
--- a/tools/winscope/src/viewers/components/ime_additional_properties_component_test.ts
+++ b/tools/winscope/src/viewers/components/ime_additional_properties_component_test.ts
@@ -74,6 +74,14 @@ describe('ImeAdditionalPropertiesComponent', () => {
     expect(htmlElement.querySelector('.input-method-surface')).toBeDefined();
   });
 
+  it('renders placeholder text', () => {
+    component.additionalProperties = undefined;
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.placeholder-text')?.textContent,
+    ).toContain('No IME entry found.');
+  });
+
   it('emits update additional property tree event on wm state button click', () => {
     const button = assertDefined(
       htmlElement.querySelector('.wm-state-button'),
@@ -159,47 +167,50 @@ describe('ImeAdditionalPropertiesComponent', () => {
   class TestHostComponent {
     isImeManagerService = false;
 
-    additionalProperties = new ImeAdditionalProperties(
-      {
-        id: 'wmStateId',
-        name: 'wmState',
-        wmStateProperties: {
-          timestamp: '1970-01-01, 00:00:00.000000000',
-          focusedApp: 'exampleFocusedApp',
-          focusedWindow: undefined,
-          focusedActivity: undefined,
-          isInputMethodWindowVisible: false,
-          imeControlTarget: TreeNodeUtils.makePropertyNode(
-            'DisplayContent.inputMethodControlTarget',
-            'inputMethodControlTarget',
-            null,
-          ),
-          imeInputTarget: undefined,
-          imeLayeringTarget: undefined,
-          imeInsetsSourceProvider: undefined,
-        },
-        hierarchyTree: TreeNodeUtils.makeHierarchyNode({name: 'wmStateProto'}),
-      },
-      {
-        id: 'ime',
-        name: 'imeLayers',
-        properties: {
-          imeContainer: {
-            id: '123',
-            zOrderRelativeOfId: -1,
-            z: 0,
+    additionalProperties: ImeAdditionalProperties | undefined =
+      new ImeAdditionalProperties(
+        {
+          id: 'wmStateId',
+          name: 'wmState',
+          wmStateProperties: {
+            timestamp: '1970-01-01, 00:00:00.000000000',
+            focusedApp: 'exampleFocusedApp',
+            focusedWindow: undefined,
+            focusedActivity: undefined,
+            isInputMethodWindowVisible: false,
+            imeControlTarget: TreeNodeUtils.makePropertyNode(
+              'DisplayContent.inputMethodControlTarget',
+              'inputMethodControlTarget',
+              null,
+            ),
+            imeInputTarget: undefined,
+            imeLayeringTarget: undefined,
+            imeInsetsSourceProvider: undefined,
           },
-          inputMethodSurface: {
-            id: '456',
-            isVisible: false,
+          hierarchyTree: TreeNodeUtils.makeHierarchyNode({
+            name: 'wmStateProto',
+          }),
+        },
+        {
+          id: 'ime',
+          name: 'imeLayers',
+          properties: {
+            imeContainer: {
+              id: '123',
+              zOrderRelativeOfId: -1,
+              z: 0,
+            },
+            inputMethodSurface: {
+              id: '456',
+              isVisible: false,
+            },
+            focusedWindowColor: undefined,
+            root: undefined,
           },
-          focusedWindowColor: undefined,
-          root: undefined,
+          taskLayerOfImeContainer: undefined,
+          taskLayerOfImeSnapshot: undefined,
         },
-        taskLayerOfImeContainer: undefined,
-        taskLayerOfImeSnapshot: undefined,
-      },
-    );
+      );
     highlightedItem = '';
     additionalPropertieTreeName: string | undefined;
     collapseButtonClicked = false;
diff --git a/tools/winscope/src/viewers/components/properties_component.ts b/tools/winscope/src/viewers/components/properties_component.ts
index 8d3c2acf1..c26993c84 100644
--- a/tools/winscope/src/viewers/components/properties_component.ts
+++ b/tools/winscope/src/viewers/components/properties_component.ts
@@ -20,17 +20,19 @@ import {
   Inject,
   Input,
   Output,
+  ViewChild,
 } from '@angular/core';
 import {PersistentStore} from 'common/persistent_store';
 import {Analytics} from 'logging/analytics';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
 import {CuratedProperties} from 'viewers/common/curated_properties';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {nodeStyles} from 'viewers/components/styles/node.styles';
-import {searchBoxStyle} from './styles/search_box.styles';
+import {SearchBoxComponent} from './search_box_component';
 import {viewerCardInnerStyle} from './styles/viewer_card.styles';
 
 @Component({
@@ -43,12 +45,10 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
           [class.padded-title]="!hasUserOptions()"
           [title]="title"
           (collapseButtonClicked)="collapseButtonClicked.emit()"></collapsible-section-title>
-
-        <mat-form-field *ngIf="showFilter" class="search-box" (keydown.enter)="$event.target.blur()">
-          <mat-label>Search</mat-label>
-
-          <input matInput [(ngModel)]="filterString" (ngModelChange)="filterTree()" name="filter" />
-        </mat-form-field>
+        <search-box
+          *ngIf="showFilter"
+          [textFilter]="textFilter"
+          (filterChange)="onFilterChange($event)"></search-box>
       </div>
 
       <user-options
@@ -82,7 +82,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       </div>
     </div>
 
-    <span class="mat-body-1 placeholder-text" *ngIf="!showPropertiesTree() && placeholderText"> {{ placeholderText }} </span>
+    <span class="mat-body-1 placeholder-text" *ngIf="showPlaceholderText()"> {{ placeholderText }} </span>
   `,
   styles: [
     `
@@ -106,20 +106,14 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         overflow-y: auto;
         padding: 0px 12px;
       }
-
-      .placeholder-text {
-        padding: 8px 12px;
-      }
     `,
     nodeStyles,
-    searchBoxStyle,
     viewerCardInnerStyle,
   ],
 })
 export class PropertiesComponent {
   Analytics = Analytics;
   CollapsibleSectionType = CollapsibleSectionType;
-  filterString = '';
   ViewerEvents = ViewerEvents;
 
   @Input() title = 'PROPERTIES';
@@ -133,15 +127,18 @@ export class PropertiesComponent {
   @Input() isProtoDump = false;
   @Input() traceType: TraceType | undefined;
   @Input() store: PersistentStore | undefined;
+  @Input() textFilter: TextFilter | undefined;
 
   @Output() collapseButtonClicked = new EventEmitter();
 
+  @ViewChild(SearchBoxComponent) searchBox: SearchBoxComponent | undefined;
+
   constructor(@Inject(ElementRef) private elementRef: ElementRef) {}
 
-  filterTree() {
+  onFilterChange(detail: TextFilter) {
     const event = new CustomEvent(ViewerEvents.PropertiesFilterChange, {
       bubbles: true,
-      detail: {filterString: this.filterString},
+      detail,
     });
     this.elementRef.nativeElement.dispatchEvent(event);
   }
@@ -161,7 +158,7 @@ export class PropertiesComponent {
   showViewCaptureFormat(): boolean {
     return (
       this.traceType === TraceType.VIEW_CAPTURE &&
-      this.filterString === '' &&
+      this.textFilter?.filterString === '' &&
       // Todo: Highlight Inline in formatted ViewCapture Properties Component.
       !this.userOptions['showDiff']?.enabled &&
       this.curatedProperties !== undefined
@@ -171,4 +168,10 @@ export class PropertiesComponent {
   showPropertiesTree(): boolean {
     return !!this.propertiesTree && !this.showViewCaptureFormat();
   }
+
+  showPlaceholderText(): boolean {
+    return (
+      !this.propertiesTree && !this.curatedProperties && !!this.placeholderText
+    );
+  }
 }
diff --git a/tools/winscope/src/viewers/components/properties_component_test.ts b/tools/winscope/src/viewers/components/properties_component_test.ts
index 6b4ea29ad..a2d0b3688 100644
--- a/tools/winscope/src/viewers/components/properties_component_test.ts
+++ b/tools/winscope/src/viewers/components/properties_component_test.ts
@@ -13,6 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+import {ClipboardModule} from '@angular/cdk/clipboard';
 import {CommonModule} from '@angular/common';
 import {
   ComponentFixture,
@@ -28,14 +29,17 @@ import {MatInputModule} from '@angular/material/input';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
+import {FilterFlag} from 'common/filter_flag';
 import {PersistentStore} from 'common/persistent_store';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TraceType} from 'trace/trace_type';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {CollapsibleSectionTitleComponent} from './collapsible_section_title_component';
 import {PropertiesComponent} from './properties_component';
 import {PropertyTreeNodeDataViewComponent} from './property_tree_node_data_view_component';
+import {SearchBoxComponent} from './search_box_component';
 import {SurfaceFlingerPropertyGroupsComponent} from './surface_flinger_property_groups_component';
 import {TreeComponent} from './tree_component';
 import {TreeNodeComponent} from './tree_node_component';
@@ -57,6 +61,7 @@ describe('PropertiesComponent', () => {
         PropertyTreeNodeDataViewComponent,
         CollapsibleSectionTitleComponent,
         UserOptionsComponent,
+        SearchBoxComponent,
       ],
       imports: [
         CommonModule,
@@ -69,6 +74,7 @@ describe('PropertiesComponent', () => {
         ReactiveFormsModule,
         MatIconModule,
         MatTooltipModule,
+        ClipboardModule,
       ],
     }).compileComponents();
 
@@ -84,6 +90,7 @@ describe('PropertiesComponent', () => {
         isUnavailable: false,
       },
     };
+    component.textFilter = new TextFilter('', []);
     component.traceType = TraceType.SURFACE_FLINGER;
 
     fixture.detectChanges();
@@ -118,6 +125,15 @@ describe('PropertiesComponent', () => {
     expect(treeEl).toBeTruthy();
   });
 
+  it('renders placeholder text', () => {
+    component.propertiesTree = undefined;
+    component.placeholderText = 'Placeholder text';
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.placeholder-text')?.textContent,
+    ).toContain('Placeholder text');
+  });
+
   it('handles node click', () => {
     const tree = new PropertyTreeBuilder()
       .setRootId('selectedItem')
@@ -145,21 +161,26 @@ describe('PropertiesComponent', () => {
   });
 
   it('handles change in filter', () => {
-    let filterString: string | undefined;
+    let textFilter: TextFilter | undefined;
     htmlElement.addEventListener(
       ViewerEvents.PropertiesFilterChange,
       (event) => {
-        filterString = (event as CustomEvent).detail.filterString;
+        textFilter = (event as CustomEvent).detail;
       },
     );
     const inputEl = assertDefined(
-      htmlElement.querySelector('.title-section input'),
-    ) as HTMLInputElement;
+      htmlElement.querySelector<HTMLInputElement>('.title-section input'),
+    );
+    const flagButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.search-box button'),
+    );
+    flagButton.click();
+    fixture.detectChanges();
 
     inputEl.value = 'Root';
     inputEl.dispatchEvent(new Event('input'));
     fixture.detectChanges();
-    expect(filterString).toBe('Root');
+    expect(textFilter).toEqual(new TextFilter('Root', [FilterFlag.MATCH_CASE]));
   });
 
   it('handles collapse button click', () => {
diff --git a/tools/winscope/src/viewers/components/property_tree_node_data_view_component.ts b/tools/winscope/src/viewers/components/property_tree_node_data_view_component.ts
index 92c637200..932584cd3 100644
--- a/tools/winscope/src/viewers/components/property_tree_node_data_view_component.ts
+++ b/tools/winscope/src/viewers/components/property_tree_node_data_view_component.ts
@@ -25,17 +25,18 @@ import {timeButtonStyle} from './styles/clickable_property.styles';
 @Component({
   selector: 'property-tree-node-data-view',
   template: `
-    <div class="mat-body-1 node-property" *ngIf="node">
-      <span class="property-key"> {{ getKey(node) }} </span>
+    <div class="node-property" *ngIf="node">
+      <span class=" mat-body-1 property-key"> {{ getKey(node) }} </span>
       <div *ngIf="node?.formattedValue()" class="property-value" [class]="[timeClass()]">
         <button
           *ngIf="isTimestamp()"
+          class="time-button"
           mat-button
           color="primary"
           (click)="onTimestampClicked(node)">
           {{ node.formattedValue() }}
         </button>
-        <a *ngIf="!isTimestamp()" [class]="[valueClass()]" class="value new">{{ node.formattedValue() }}</a>
+        <a *ngIf="!isTimestamp()" [class]="[valueClass()]" class="mat-body-2 value new">{{ node.formattedValue() }}</a>
         <s *ngIf="isModified()" class="old-value">{{ node.getOldValue() }}</s>
       </div>
     </div>
@@ -66,10 +67,11 @@ export class PropertyTreeNodeDataViewComponent {
     return this.node?.getValue() instanceof Timestamp;
   }
 
-  onTimestampClicked(timestamp: UiPropertyTreeNode) {
+  onTimestampClicked(timestampNode: UiPropertyTreeNode) {
+    const timestamp: Timestamp = timestampNode.getValue();
     const customEvent = new CustomEvent(ViewerEvents.TimestampClick, {
       bubbles: true,
-      detail: new TimestampClickDetail(timestamp.getValue(), undefined),
+      detail: new TimestampClickDetail(undefined, timestamp),
     });
     this.elementRef.nativeElement.dispatchEvent(customEvent);
   }
diff --git a/tools/winscope/src/viewers/components/property_tree_node_data_view_component_test.ts b/tools/winscope/src/viewers/components/property_tree_node_data_view_component_test.ts
index 35550f0bc..93dbf029e 100644
--- a/tools/winscope/src/viewers/components/property_tree_node_data_view_component_test.ts
+++ b/tools/winscope/src/viewers/components/property_tree_node_data_view_component_test.ts
@@ -68,7 +68,7 @@ describe('PropertyTreeNodeDataViewComponent', () => {
     fixture.detectChanges();
 
     const timestampButton = assertDefined(
-      htmlElement.querySelector('.time button'),
+      htmlElement.querySelector('.time-button'),
     ) as HTMLButtonElement;
     timestampButton.click();
     fixture.detectChanges();
diff --git a/tools/winscope/src/viewers/components/rects/camera.ts b/tools/winscope/src/viewers/components/rects/camera.ts
new file mode 100644
index 000000000..f34b9c3b3
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/camera.ts
@@ -0,0 +1,24 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Distance} from 'common/geometry/distance';
+
+export interface Camera {
+  rotationAngleX: number;
+  rotationAngleY: number;
+  zoomFactor: number;
+  panScreenDistance: Distance;
+}
diff --git a/tools/winscope/src/viewers/components/rects/canvas.ts b/tools/winscope/src/viewers/components/rects/canvas.ts
index 75993150c..3a1b94978 100644
--- a/tools/winscope/src/viewers/components/rects/canvas.ts
+++ b/tools/winscope/src/viewers/components/rects/canvas.ts
@@ -13,244 +13,202 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {assertDefined} from 'common/assert_utils';
-import {TransformMatrix} from 'common/geometry_types';
+import {ArrayUtils} from 'common/array_utils';
+import {assertDefined, assertUnreachable} from 'common/assert_utils';
+import {Box3D} from 'common/geometry/box3d';
+import {Point3D} from 'common/geometry/point3d';
+import {Rect3D} from 'common/geometry/rect3d';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 import * as THREE from 'three';
 import {
   CSS2DObject,
   CSS2DRenderer,
 } from 'three/examples/jsm/renderers/CSS2DRenderer';
 import {ViewerEvents} from 'viewers/common/viewer_events';
-import {
-  Circle3D,
-  ColorType,
-  Label3D,
-  Point3D,
-  Rect3D,
-  Scene3D,
-} from './types3d';
+import {Camera} from './camera';
+import {ColorType} from './color_type';
+import {RectLabel} from './rect_label';
+import {UiRect3D} from './ui_rect3d';
 
 export class Canvas {
   static readonly TARGET_SCENE_DIAGONAL = 4;
-  private static readonly RECT_COLOR_HIGHLIGHTED_LIGHT_MODE = new THREE.Color(
+  static readonly RECT_COLOR_HIGHLIGHTED_LIGHT_MODE = new THREE.Color(
     0xd2e3fc, // Keep in sync with :not(.dark-mode) --selected-element-color in material-theme.scss
   );
-  private static readonly RECT_COLOR_HIGHLIGHTED_DARK_MODE = new THREE.Color(
+  static readonly RECT_COLOR_HIGHLIGHTED_DARK_MODE = new THREE.Color(
     0x5f718a, // Keep in sync with .dark-mode --selected-element-color in material-theme.scss
   );
-  private static readonly RECT_COLOR_HAS_CONTENT = new THREE.Color(0xad42f5);
-
-  private static readonly RECT_EDGE_COLOR_LIGHT_MODE = 0x000000;
-  private static readonly RECT_EDGE_COLOR_DARK_MODE = 0xffffff;
-  private static readonly RECT_EDGE_COLOR_ROUNDED = 0x848884;
-
-  private static readonly LABEL_LINE_COLOR = 0x808080;
-
-  private static readonly OPACITY_REGULAR = 0.75;
-  private static readonly OPACITY_OVERSIZED = 0.25;
-
-  private camera?: THREE.OrthographicCamera;
-  private scene?: THREE.Scene;
-  private renderer?: THREE.WebGLRenderer;
-  private labelRenderer?: CSS2DRenderer;
-  private clickableObjects: THREE.Object3D[] = [];
+  static readonly RECT_COLOR_HAS_CONTENT = new THREE.Color(0xad42f5);
+  static readonly RECT_EDGE_COLOR_LIGHT_MODE = 0x000000;
+  static readonly RECT_EDGE_COLOR_DARK_MODE = 0xffffff;
+  static readonly RECT_EDGE_COLOR_ROUNDED = 0x848884;
+  static readonly RECT_EDGE_COLOR_PINNED = 0xffc24b; // Keep in sync with Color#PINNED_ITEM_BORDER
+  static readonly RECT_EDGE_COLOR_PINNED_ALT = 0xb34a24;
+  static readonly LABEL_LINE_COLOR = 0x808080;
+  static readonly OPACITY_REGULAR = 0.75;
+  static readonly OPACITY_OVERSIZED = 0.25;
+  static readonly TRANSPARENT_MATERIAL = new THREE.MeshBasicMaterial({
+    opacity: 0,
+    transparent: true,
+  });
+  private static readonly RECT_EDGE_BOLD_WIDTH = 10;
+  private static readonly FILL_REGION_NAME = 'fillRegion';
+
+  renderer = new THREE.WebGLRenderer({
+    antialias: true,
+    canvas: this.canvasRects,
+    alpha: true,
+  });
+  labelRenderer?: CSS2DRenderer;
+
+  private camera = new THREE.OrthographicCamera(
+    -Canvas.TARGET_SCENE_DIAGONAL / 2,
+    Canvas.TARGET_SCENE_DIAGONAL / 2,
+    Canvas.TARGET_SCENE_DIAGONAL / 2,
+    -Canvas.TARGET_SCENE_DIAGONAL / 2,
+    0,
+    100,
+  );
+  private scene = new THREE.Scene();
+  private pinnedIdToColorMap = new Map<string, number>();
+  private lastAssignedDefaultPinnedColor = false;
+  private firstDraw = true;
+  private lastScene: SceneState = {
+    isDarkMode: this.isDarkMode(),
+    translatedPos: undefined,
+    rectIdToRectGraphics: new Map<string, RectGraphics>(),
+    rectIdToLabelGraphics: new Map<string, LabelGraphics>(),
+  };
 
   constructor(
-    private canvasRects: HTMLCanvasElement,
+    private canvasRects: HTMLElement,
     private canvasLabels?: HTMLElement,
     private isDarkMode = () => false,
-  ) {}
+  ) {
+    if (this.canvasLabels) {
+      this.labelRenderer = new CSS2DRenderer({element: this.canvasLabels});
+    }
+  }
 
-  draw(scene: Scene3D) {
+  updateViewPosition(camera: Camera, bounds: Box3D) {
     // Must set 100% width and height so the HTML element expands to the parent's
     // boundaries and the correct clientWidth and clientHeight values can be read
     this.canvasRects.style.width = '100%';
     this.canvasRects.style.height = '100%';
-    let widthAspectRatioAdjustFactor: number;
-    let heightAspectRatioAdjustFactor: number;
+    const [maxWidth, maxHeight] = [
+      this.canvasRects.clientWidth,
+      this.canvasRects.clientHeight,
+    ];
+    if (maxWidth === 0 || maxHeight === 0) {
+      return;
+    }
 
-    if (this.canvasRects.clientWidth > this.canvasRects.clientHeight) {
-      heightAspectRatioAdjustFactor = 1;
-      widthAspectRatioAdjustFactor =
-        this.canvasRects.clientWidth / this.canvasRects.clientHeight;
+    let widthAspectRatioAdjustFactor = 1;
+    let heightAspectRatioAdjustFactor = 1;
+    if (maxWidth > maxHeight) {
+      widthAspectRatioAdjustFactor = maxWidth / maxHeight;
     } else {
-      heightAspectRatioAdjustFactor =
-        this.canvasRects.clientHeight / this.canvasRects.clientWidth;
-      widthAspectRatioAdjustFactor = 1;
+      heightAspectRatioAdjustFactor = maxHeight / maxWidth;
     }
-
     const cameraWidth =
       Canvas.TARGET_SCENE_DIAGONAL * widthAspectRatioAdjustFactor;
     const cameraHeight =
       Canvas.TARGET_SCENE_DIAGONAL * heightAspectRatioAdjustFactor;
 
-    const panFactorX =
-      scene.camera.panScreenDistance.dx / this.canvasRects.clientWidth;
-    const panFactorY =
-      scene.camera.panScreenDistance.dy / this.canvasRects.clientHeight;
+    const panFactorX = camera.panScreenDistance.dx / maxWidth;
+    const panFactorY = camera.panScreenDistance.dy / maxHeight;
 
-    this.scene = new THREE.Scene();
     const scaleFactor =
-      (Canvas.TARGET_SCENE_DIAGONAL / scene.boundingBox.diagonal) *
-      scene.camera.zoomFactor;
+      (Canvas.TARGET_SCENE_DIAGONAL / bounds.diagonal) * camera.zoomFactor;
     this.scene.scale.set(scaleFactor, -scaleFactor, scaleFactor);
-    this.scene.translateX(
-      scaleFactor * -scene.boundingBox.center.x + cameraWidth * panFactorX,
-    );
-    this.scene.translateY(
-      scaleFactor * scene.boundingBox.center.y - cameraHeight * panFactorY,
-    );
-    this.scene.translateZ(scaleFactor * -scene.boundingBox.center.z);
 
-    this.camera = new THREE.OrthographicCamera(
-      -cameraWidth / 2,
-      cameraWidth / 2,
-      cameraHeight / 2,
-      -cameraHeight / 2,
-      0,
-      100,
-    );
-
-    const rotationAngleX = (scene.camera.rotationFactor * Math.PI * 45) / 360;
-    const rotationAngleY = rotationAngleX * 1.5;
-    const cameraPosition = new THREE.Vector3(
-      0,
-      0,
-      Canvas.TARGET_SCENE_DIAGONAL,
-    );
-    cameraPosition.applyAxisAngle(new THREE.Vector3(1, 0, 0), -rotationAngleX);
-    cameraPosition.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotationAngleY);
-
-    this.camera.position.set(
-      cameraPosition.x,
-      cameraPosition.y,
-      cameraPosition.z,
+    const translatedPos = new Point3D(
+      scaleFactor * -(bounds.depth * camera.rotationAngleX + bounds.center.x) +
+        cameraWidth * panFactorX,
+      scaleFactor *
+        ((-bounds.depth * camera.rotationAngleY ** 2) / 2 + bounds.center.y) -
+        cameraHeight * panFactorY,
+      scaleFactor * -bounds.depth,
     );
+    this.scene
+      .translateX(translatedPos.x - (this.lastScene.translatedPos?.x ?? 0))
+      .translateY(translatedPos.y - (this.lastScene.translatedPos?.y ?? 0))
+      .translateZ(translatedPos.z - (this.lastScene.translatedPos?.z ?? 0));
+    this.lastScene.translatedPos = translatedPos;
+
+    this.camera.left = -cameraWidth / 2;
+    this.camera.right = cameraWidth / 2;
+    this.camera.top = cameraHeight / 2;
+    this.camera.bottom = -cameraHeight / 2;
+    const cPos = new THREE.Vector3(0, 0, Canvas.TARGET_SCENE_DIAGONAL)
+      .applyAxisAngle(new THREE.Vector3(1, 0, 0), -camera.rotationAngleX)
+      .applyAxisAngle(new THREE.Vector3(0, 1, 0), camera.rotationAngleY);
+    this.camera.position.set(cPos.x, cPos.y, cPos.z);
     this.camera.lookAt(0, 0, 0);
+    this.camera.updateProjectionMatrix();
 
-    this.renderer = new THREE.WebGLRenderer({
-      antialias: true,
-      canvas: this.canvasRects,
-      alpha: true,
-    });
+    this.renderer.setSize(maxWidth, maxHeight);
+    this.labelRenderer?.setSize(maxWidth, maxHeight);
+  }
 
-    // set various factors for shading and shifting
-    this.drawRects(scene.rects);
-    const canvasRects = assertDefined(this.canvasRects);
-    if (this.canvasLabels) {
-      this.drawLabels(scene.labels, this.isDarkMode());
+  updateRects(rects: UiRect3D[]) {
+    for (const key of this.lastScene.rectIdToRectGraphics.keys()) {
+      if (!rects.some((rect) => rect.id === key)) {
+        this.lastScene.rectIdToRectGraphics.delete(key);
+        this.scene.remove(assertDefined(this.scene.getObjectByName(key)));
+      }
+    }
+    rects.forEach((rect) => {
+      const existingGraphics = this.lastScene.rectIdToRectGraphics.get(rect.id);
+      const mesh = !existingGraphics
+        ? this.makeAndAddRectMesh(rect)
+        : this.updateExistingRectMesh(
+            rect,
+            existingGraphics.rect,
+            existingGraphics.mesh,
+          );
+      this.lastScene.rectIdToRectGraphics.set(rect.id, {rect, mesh});
+    });
+  }
 
-      this.labelRenderer = new CSS2DRenderer({element: this.canvasLabels});
-      this.labelRenderer.setSize(
-        canvasRects.clientWidth,
-        canvasRects.clientHeight,
-      );
-      this.labelRenderer.render(this.scene, this.camera);
+  updateLabels(labels: RectLabel[]) {
+    if (this.labelRenderer) {
+      this.updateLabelGraphics(labels);
     }
+  }
 
-    this.renderer.setSize(canvasRects.clientWidth, canvasRects.clientHeight);
+  renderView(): [THREE.Scene, THREE.OrthographicCamera] {
+    this.labelRenderer?.render(this.scene, this.camera);
     this.renderer.setPixelRatio(window.devicePixelRatio);
-    this.renderer.compile(this.scene, this.camera);
+    if (this.firstDraw) {
+      this.renderer.compile(this.scene, this.camera);
+      this.firstDraw = false;
+    }
     this.renderer.render(this.scene, this.camera);
+    this.lastScene.isDarkMode = this.isDarkMode();
+    return [this.scene, this.camera];
   }
 
   getClickedRectId(x: number, y: number, z: number): undefined | string {
     const clickPosition = new THREE.Vector3(x, y, z);
     const raycaster = new THREE.Raycaster();
     raycaster.setFromCamera(clickPosition, assertDefined(this.camera));
-    const intersected = raycaster.intersectObjects(this.clickableObjects);
-    if (intersected.length > 0) {
-      return intersected[0].object.name;
-    }
-    return undefined;
-  }
-
-  private drawRects(rects: Rect3D[]) {
-    this.clickableObjects = [];
-    rects.forEach((rect) => {
-      const rectMesh = Canvas.makeRectMesh(rect, this.isDarkMode());
-      const transform = Canvas.toMatrix4(rect.transform);
-      rectMesh.applyMatrix4(transform);
-
-      this.scene?.add(rectMesh);
-
-      if (rect.isClickable) {
-        this.clickableObjects.push(rectMesh);
-      }
-    });
-  }
-
-  private drawLabels(labels: Label3D[], isDarkMode: boolean) {
-    this.clearLabels();
-    labels.forEach((label) => {
-      const circleMesh = this.makeLabelCircleMesh(label.circle, isDarkMode);
-      this.scene?.add(circleMesh);
-
-      const linePoints = label.linePoints.map((point: Point3D) => {
-        return new THREE.Vector3(point.x, point.y, point.z);
-      });
-      const lineGeometry = new THREE.BufferGeometry().setFromPoints(linePoints);
-      const lineMaterial = new THREE.LineBasicMaterial({
-        color: label.isHighlighted
-          ? isDarkMode
-            ? Canvas.RECT_EDGE_COLOR_DARK_MODE
-            : Canvas.RECT_EDGE_COLOR_LIGHT_MODE
-          : Canvas.LABEL_LINE_COLOR,
-      });
-      const line = new THREE.Line(lineGeometry, lineMaterial);
-      this.scene?.add(line);
-
-      this.drawLabelTextHtml(label);
-    });
-  }
-
-  private drawLabelTextHtml(label: Label3D) {
-    // Add rectangle label
-    const spanText: HTMLElement = document.createElement('span');
-    spanText.innerText = label.text;
-    spanText.className = 'mat-body-1';
-
-    // Hack: transparent/placeholder text used to push the visible text towards left
-    // (towards negative x) and properly align it with the label's vertical segment
-    const spanPlaceholder: HTMLElement = document.createElement('span');
-    spanPlaceholder.innerText = label.text;
-    spanPlaceholder.className = 'mat-body-1';
-    spanPlaceholder.style.opacity = '0';
-
-    const div: HTMLElement = document.createElement('div');
-    div.className = 'rect-label';
-    div.style.display = 'inline';
-    div.appendChild(spanText);
-    div.appendChild(spanPlaceholder);
-
-    div.style.marginTop = '5px';
-    if (!label.isHighlighted) {
-      div.style.color = 'gray';
-    }
-    div.style.pointerEvents = 'auto';
-    div.style.cursor = 'pointer';
-    div.addEventListener('click', (event) =>
-      this.propagateUpdateHighlightedItem(event, label.rectId),
+    const intersected = raycaster.intersectObjects(
+      Array.from(this.lastScene.rectIdToRectGraphics.values())
+        .filter((graphics) => graphics.rect.isClickable)
+        .map((graphics) => graphics.mesh),
     );
-
-    const labelCss = new CSS2DObject(div);
-    labelCss.position.set(
-      label.textCenter.x,
-      label.textCenter.y,
-      label.textCenter.z,
-    );
-
-    this.scene?.add(labelCss);
+    return intersected.at(0)?.object.name;
   }
 
-  private static toMatrix4(transform: TransformMatrix): THREE.Matrix4 {
+  private toMatrix4(transform: TransformMatrix): THREE.Matrix4 {
     return new THREE.Matrix4().set(
       transform.dsdx,
-      transform.dsdy,
+      transform.dtdx,
       0,
       transform.tx,
-      transform.dtdx,
       transform.dtdy,
+      transform.dsdy,
       0,
       transform.ty,
       0,
@@ -264,81 +222,43 @@ export class Canvas {
     );
   }
 
-  private static makeRectMesh(rect: Rect3D, isDarkMode: boolean): THREE.Mesh {
-    const rectShape = Canvas.createRectShape(rect);
-    const rectGeometry = new THREE.ShapeGeometry(rectShape);
-    const rectBorders = Canvas.createRectBorders(
-      rect,
-      rectGeometry,
-      isDarkMode,
+  private makeAndAddRectMesh(rect: UiRect3D): THREE.Mesh {
+    const color = this.getColor(rect);
+    const fillMaterial = this.getFillMaterial(rect, color);
+    const mesh = new THREE.Mesh(
+      this.makeRoundedRectGeometry(rect),
+      rect.fillRegion ? Canvas.TRANSPARENT_MATERIAL : fillMaterial,
     );
 
-    const color = Canvas.getColor(rect, isDarkMode);
-    let mesh: THREE.Mesh | undefined;
-    if (color === undefined) {
-      mesh = new THREE.Mesh(
-        rectGeometry,
-        new THREE.MeshBasicMaterial({
-          opacity: 0,
-          transparent: true,
-        }),
-      );
-    } else {
-      let opacity: number | undefined;
-      if (
-        rect.colorType === ColorType.VISIBLE_WITH_OPACITY ||
-        rect.colorType === ColorType.HAS_CONTENT_AND_OPACITY
-      ) {
-        opacity = rect.darkFactor;
-      } else {
-        opacity = rect.isOversized
-          ? Canvas.OPACITY_OVERSIZED
-          : Canvas.OPACITY_REGULAR;
-      }
-      mesh = new THREE.Mesh(
-        rectGeometry,
-        new THREE.MeshBasicMaterial({
-          color,
-          opacity,
-          transparent: true,
-        }),
-      );
+    if (rect.fillRegion) {
+      this.addFillRegionMesh(rect, fillMaterial, mesh);
     }
+    this.addRectBorders(rect, mesh);
 
-    mesh.add(rectBorders);
     mesh.position.x = 0;
     mesh.position.y = 0;
     mesh.position.z = rect.topLeft.z;
     mesh.name = rect.id;
-
+    mesh.applyMatrix4(this.toMatrix4(rect.transform));
+    this.scene.add(mesh);
     return mesh;
   }
 
-  private static createRectShape(rect: Rect3D): THREE.Shape {
-    const bottomLeft: Point3D = {
-      x: rect.topLeft.x,
-      y: rect.bottomRight.y,
-      z: rect.topLeft.z,
-    };
-    const topRight: Point3D = {
-      x: rect.bottomRight.x,
-      y: rect.topLeft.y,
-      z: rect.bottomRight.z,
-    };
-
-    // Limit corner radius if larger than height/2 (or width/2)
-    const height = rect.bottomRight.y - rect.topLeft.y;
-    const width = rect.bottomRight.x - rect.topLeft.x;
-    const minEdge = Math.min(height, width);
-    let cornerRadius = Math.min(rect.cornerRadius, minEdge / 2);
-
-    // Force radius > 0, because radius === 0 could result in weird triangular shapes
-    // being drawn instead of rectangles. Seems like quadraticCurveTo() doesn't
-    // always handle properly the case with radius === 0.
-    cornerRadius = Math.max(cornerRadius, 0.01);
+  private makeRoundedRectGeometry(rect: UiRect3D): THREE.ShapeGeometry {
+    const bottomLeft = new Point3D(
+      rect.topLeft.x,
+      rect.bottomRight.y,
+      rect.topLeft.z,
+    );
+    const topRight = new Point3D(
+      rect.bottomRight.x,
+      rect.topLeft.y,
+      rect.bottomRight.z,
+    );
+    const cornerRadius = this.getAdjustedCornerRadius(rect);
 
     // Create (rounded) rect shape
-    return new THREE.Shape()
+    const shape = new THREE.Shape()
       .moveTo(rect.topLeft.x, rect.topLeft.y + cornerRadius)
       .lineTo(bottomLeft.x, bottomLeft.y - cornerRadius)
       .quadraticCurveTo(
@@ -368,27 +288,38 @@ export class Canvas {
         rect.topLeft.x,
         rect.topLeft.y + cornerRadius,
       );
+    return new THREE.ShapeGeometry(shape);
+  }
+
+  private makeRectShape(topLeft: Point3D, bottomRight: Point3D): THREE.Shape {
+    const bottomLeft = new Point3D(topLeft.x, bottomRight.y, topLeft.z);
+    const topRight = new Point3D(bottomRight.x, topLeft.y, bottomRight.z);
+
+    // Create rect shape
+    return new THREE.Shape()
+      .moveTo(topLeft.x, topLeft.y)
+      .lineTo(bottomLeft.x, bottomLeft.y)
+      .lineTo(bottomRight.x, bottomRight.y)
+      .lineTo(topRight.x, topRight.y)
+      .lineTo(topLeft.x, topLeft.y);
   }
 
-  private static getVisibleRectColor(darkFactor: number) {
+  private getVisibleRectColor(darkFactor: number) {
     const red = ((200 - 45) * darkFactor + 45) / 255;
     const green = ((232 - 182) * darkFactor + 182) / 255;
     const blue = ((183 - 44) * darkFactor + 44) / 255;
     return new THREE.Color(red, green, blue);
   }
 
-  private static getColor(
-    rect: Rect3D,
-    isDarkMode: boolean,
-  ): THREE.Color | undefined {
+  private getColor(rect: UiRect3D): THREE.Color | undefined {
     switch (rect.colorType) {
       case ColorType.VISIBLE: {
         // green (darkness depends on z order)
-        return Canvas.getVisibleRectColor(rect.darkFactor);
+        return this.getVisibleRectColor(rect.darkFactor);
       }
       case ColorType.VISIBLE_WITH_OPACITY: {
         // same green for all rects - rect.darkFactor determines opacity
-        return Canvas.getVisibleRectColor(0.7);
+        return this.getVisibleRectColor(0.7);
       }
       case ColorType.NOT_VISIBLE: {
         // gray (darkness depends on z order)
@@ -398,7 +329,7 @@ export class Canvas {
         return new THREE.Color(darkness, darkness, darkness);
       }
       case ColorType.HIGHLIGHTED: {
-        return isDarkMode
+        return this.isDarkMode()
           ? Canvas.RECT_COLOR_HIGHLIGHTED_DARK_MODE
           : Canvas.RECT_COLOR_HIGHLIGHTED_LIGHT_MODE;
       }
@@ -412,52 +343,458 @@ export class Canvas {
         return undefined;
       }
       default: {
-        throw new Error(`Unexpected color type: ${rect.colorType}`);
+        assertUnreachable(rect.colorType);
       }
     }
   }
 
-  private static createRectBorders(
-    rect: Rect3D,
+  private makeRectBorders(
+    rect: UiRect3D,
     rectGeometry: THREE.ShapeGeometry,
-    isDarkMode: boolean,
   ): THREE.LineSegments {
     // create line edges for rect
     const edgeGeo = new THREE.EdgesGeometry(rectGeometry);
-    let edgeMaterial: THREE.Material;
+    let color: number;
     if (rect.cornerRadius) {
-      edgeMaterial = new THREE.LineBasicMaterial({
-        color: Canvas.RECT_EDGE_COLOR_ROUNDED,
-        linewidth: 1,
-      });
+      color = Canvas.RECT_EDGE_COLOR_ROUNDED;
     } else {
-      edgeMaterial = new THREE.LineBasicMaterial({
-        color: isDarkMode
-          ? Canvas.RECT_EDGE_COLOR_DARK_MODE
-          : Canvas.RECT_EDGE_COLOR_LIGHT_MODE,
-        linewidth: 1,
-      });
+      color = this.isDarkMode()
+        ? Canvas.RECT_EDGE_COLOR_DARK_MODE
+        : Canvas.RECT_EDGE_COLOR_LIGHT_MODE;
     }
+    const edgeMaterial = new THREE.LineBasicMaterial({color});
     const lineSegments = new THREE.LineSegments(edgeGeo, edgeMaterial);
     lineSegments.computeLineDistances();
     return lineSegments;
   }
 
-  private makeLabelCircleMesh(
-    circle: Circle3D,
-    isDarkMode: boolean,
+  private getAdjustedCornerRadius(rect: UiRect3D): number {
+    // Limit corner radius if larger than height/2 (or width/2)
+    const height = rect.bottomRight.y - rect.topLeft.y;
+    const width = rect.bottomRight.x - rect.topLeft.x;
+    const minEdge = Math.min(height, width);
+    const cornerRadius = Math.min(rect.cornerRadius, minEdge / 2);
+
+    // Force radius > 0, because radius === 0 could result in weird triangular shapes
+    // being drawn instead of rectangles. Seems like quadraticCurveTo() doesn't
+    // always handle properly the case with radius === 0.
+    return Math.max(cornerRadius, 0.01);
+  }
+
+  private makePinnedRectBorders(rect: UiRect3D): THREE.Mesh {
+    const pinnedBorders = this.createPinnedBorderRects(rect);
+    let color = this.pinnedIdToColorMap.get(rect.id);
+    if (color === undefined) {
+      color = this.lastAssignedDefaultPinnedColor
+        ? Canvas.RECT_EDGE_COLOR_PINNED_ALT
+        : Canvas.RECT_EDGE_COLOR_PINNED;
+      this.pinnedIdToColorMap.set(rect.id, color);
+      this.lastAssignedDefaultPinnedColor =
+        !this.lastAssignedDefaultPinnedColor;
+    }
+    const pinnedBorderMesh = new THREE.Mesh(
+      new THREE.ShapeGeometry(pinnedBorders),
+      new THREE.MeshBasicMaterial({color}),
+    );
+    // Prevent z-fighting with the parent mesh
+    pinnedBorderMesh.position.z = 2;
+    return pinnedBorderMesh;
+  }
+
+  private createPinnedBorderRects(rect: UiRect3D): THREE.Shape[] {
+    const cornerRadius = this.getAdjustedCornerRadius(rect);
+    const xBoldWidth = Canvas.RECT_EDGE_BOLD_WIDTH / rect.transform.dsdx;
+    const yBorderWidth = Canvas.RECT_EDGE_BOLD_WIDTH / rect.transform.dsdy;
+    const borderRects = [
+      // left and bottom borders
+      new THREE.Shape()
+        .moveTo(rect.topLeft.x, rect.topLeft.y + cornerRadius)
+        .lineTo(rect.topLeft.x, rect.bottomRight.y - cornerRadius)
+        .quadraticCurveTo(
+          rect.topLeft.x,
+          rect.bottomRight.y,
+          rect.topLeft.x + cornerRadius,
+          rect.bottomRight.y,
+        )
+        .lineTo(rect.bottomRight.x - cornerRadius, rect.bottomRight.y)
+        .quadraticCurveTo(
+          rect.bottomRight.x,
+          rect.bottomRight.y,
+          rect.bottomRight.x,
+          rect.bottomRight.y - cornerRadius,
+        )
+        .lineTo(
+          rect.bottomRight.x - xBoldWidth,
+          rect.bottomRight.y - cornerRadius,
+        )
+        .quadraticCurveTo(
+          rect.bottomRight.x - xBoldWidth,
+          rect.bottomRight.y - yBorderWidth,
+          rect.bottomRight.x - cornerRadius,
+          rect.bottomRight.y - yBorderWidth,
+        )
+        .lineTo(
+          rect.topLeft.x + cornerRadius,
+          rect.bottomRight.y - yBorderWidth,
+        )
+        .quadraticCurveTo(
+          rect.topLeft.x + xBoldWidth,
+          rect.bottomRight.y - yBorderWidth,
+          rect.topLeft.x + xBoldWidth,
+          rect.bottomRight.y - cornerRadius,
+        )
+        .lineTo(rect.topLeft.x + xBoldWidth, rect.topLeft.y + cornerRadius)
+        .lineTo(rect.topLeft.x, rect.topLeft.y + cornerRadius),
+
+      // right and top borders
+      new THREE.Shape()
+        .moveTo(rect.bottomRight.x, rect.bottomRight.y - cornerRadius)
+        .lineTo(rect.bottomRight.x, rect.topLeft.y + cornerRadius)
+        .quadraticCurveTo(
+          rect.bottomRight.x,
+          rect.topLeft.y,
+          rect.bottomRight.x - cornerRadius,
+          rect.topLeft.y,
+        )
+        .lineTo(rect.topLeft.x + cornerRadius, rect.topLeft.y)
+        .quadraticCurveTo(
+          rect.topLeft.x,
+          rect.topLeft.y,
+          rect.topLeft.x,
+          rect.topLeft.y + cornerRadius,
+        )
+        .lineTo(rect.topLeft.x + xBoldWidth, rect.topLeft.y + cornerRadius)
+        .quadraticCurveTo(
+          rect.topLeft.x + xBoldWidth,
+          rect.topLeft.y + yBorderWidth,
+          rect.topLeft.x + cornerRadius,
+          rect.topLeft.y + yBorderWidth,
+        )
+        .lineTo(
+          rect.bottomRight.x - cornerRadius,
+          rect.topLeft.y + yBorderWidth,
+        )
+        .quadraticCurveTo(
+          rect.bottomRight.x - xBoldWidth,
+          rect.topLeft.y + yBorderWidth,
+          rect.bottomRight.x - xBoldWidth,
+          rect.topLeft.y + cornerRadius,
+        )
+        .lineTo(
+          rect.bottomRight.x - xBoldWidth,
+          rect.bottomRight.y - cornerRadius,
+        )
+        .lineTo(rect.bottomRight.x, rect.bottomRight.y - cornerRadius),
+    ];
+    return borderRects;
+  }
+
+  private getFillMaterial(
+    rect: UiRect3D,
+    color: THREE.Color | undefined,
+  ): THREE.MeshBasicMaterial {
+    if (color !== undefined) {
+      let opacity: number | undefined;
+      if (
+        rect.colorType === ColorType.VISIBLE_WITH_OPACITY ||
+        rect.colorType === ColorType.HAS_CONTENT_AND_OPACITY
+      ) {
+        opacity = rect.darkFactor;
+      } else {
+        opacity = rect.isOversized
+          ? Canvas.OPACITY_OVERSIZED
+          : Canvas.OPACITY_REGULAR;
+      }
+      return new THREE.MeshBasicMaterial({
+        color,
+        opacity,
+        transparent: true,
+      });
+    }
+    return Canvas.TRANSPARENT_MATERIAL;
+  }
+
+  private addFillRegionMesh(
+    rect: UiRect3D,
+    fillMaterial: THREE.MeshBasicMaterial,
+    mesh: THREE.Mesh,
+  ) {
+    const fillShapes = assertDefined(rect.fillRegion).map((fillRect) =>
+      this.makeRectShape(fillRect.topLeft, fillRect.bottomRight),
+    );
+    const fillMesh = new THREE.Mesh(
+      new THREE.ShapeGeometry(fillShapes),
+      fillMaterial,
+    );
+    // Prevent z-fighting with the parent mesh
+    fillMesh.position.z = 1;
+    fillMesh.name = rect.id + Canvas.FILL_REGION_NAME;
+    mesh.add(fillMesh);
+  }
+
+  private updateExistingRectMesh(
+    newRect: UiRect3D,
+    existingRect: UiRect3D,
+    existingMesh: THREE.Mesh,
   ): THREE.Mesh {
-    const geometry = new THREE.CircleGeometry(circle.radius, 20);
-    const material = new THREE.MeshBasicMaterial({
-      color: isDarkMode
-        ? Canvas.RECT_EDGE_COLOR_DARK_MODE
-        : Canvas.RECT_EDGE_COLOR_LIGHT_MODE,
+    this.updateRectMeshFillMaterial(newRect, existingRect, existingMesh);
+    this.updateRectMeshGeometry(newRect, existingRect, existingMesh);
+    return existingMesh;
+  }
+
+  private updateRectMeshFillMaterial(
+    newRect: UiRect3D,
+    existingRect: UiRect3D,
+    existingMesh: THREE.Mesh,
+  ) {
+    const fillMaterial = this.getFillMaterial(newRect, this.getColor(newRect));
+    const fillChanged =
+      newRect.colorType !== existingRect.colorType ||
+      this.lastScene.isDarkMode !== this.isDarkMode() ||
+      newRect.darkFactor !== existingRect.darkFactor ||
+      newRect.isOversized !== existingRect.isOversized;
+
+    if (!newRect.fillRegion && existingRect.fillRegion) {
+      existingMesh.material = fillMaterial;
+      existingMesh.remove(
+        assertDefined(
+          existingMesh.getObjectByName(
+            existingRect.id + Canvas.FILL_REGION_NAME,
+          ),
+        ),
+      );
+    } else if (newRect.fillRegion && !existingRect.fillRegion) {
+      existingMesh.material = Canvas.TRANSPARENT_MATERIAL;
+      this.addFillRegionMesh(newRect, fillMaterial, existingMesh);
+    } else if (newRect.fillRegion && existingRect.fillRegion) {
+      const fillRegionChanged = !ArrayUtils.equal(
+        newRect.fillRegion,
+        existingRect.fillRegion,
+        (a, b) => {
+          const [r, o] = [a as Rect3D, b as Rect3D];
+          return (
+            r.topLeft.isEqual(o.topLeft) && r.bottomRight.isEqual(o.bottomRight)
+          );
+        },
+      );
+      if (fillRegionChanged) {
+        existingMesh.remove(
+          assertDefined(
+            existingMesh.getObjectByName(
+              existingRect.id + Canvas.FILL_REGION_NAME,
+            ),
+          ),
+        );
+        this.addFillRegionMesh(newRect, fillMaterial, existingMesh);
+      }
+    }
+
+    if (fillChanged) {
+      if (newRect.fillRegion === undefined) {
+        existingMesh.material = fillMaterial;
+      } else {
+        const fillMesh = assertDefined(
+          existingMesh.getObjectByName(
+            existingRect.id + Canvas.FILL_REGION_NAME,
+          ),
+        ) as THREE.Mesh;
+        fillMesh.material = fillMaterial;
+      }
+    }
+  }
+
+  private updateRectMeshGeometry(
+    newRect: UiRect3D,
+    existingRect: UiRect3D,
+    existingMesh: THREE.Mesh,
+  ) {
+    const isGeometryChanged =
+      !newRect.bottomRight.isEqual(existingRect.bottomRight) ||
+      !newRect.topLeft.isEqual(existingRect.topLeft) ||
+      newRect.cornerRadius !== existingRect.cornerRadius;
+
+    if (isGeometryChanged) {
+      existingMesh.geometry = this.makeRoundedRectGeometry(newRect);
+      existingMesh.position.z = newRect.topLeft.z;
+    }
+
+    const isColorChanged =
+      this.isDarkMode() !== this.lastScene.isDarkMode ||
+      newRect.isPinned !== existingRect.isPinned;
+    if (isGeometryChanged || isColorChanged) {
+      existingMesh.remove(
+        assertDefined(existingMesh.getObjectByName(existingRect.id + 'border')),
+      );
+      this.addRectBorders(newRect, existingMesh);
+    }
+
+    if (!newRect.transform.isEqual(existingRect.transform)) {
+      existingMesh.applyMatrix4(
+        this.toMatrix4(existingRect.transform.inverse()),
+      );
+      existingMesh.applyMatrix4(this.toMatrix4(newRect.transform));
+    }
+  }
+
+  private addRectBorders(newRect: UiRect3D, mesh: THREE.Mesh) {
+    let borderMesh: THREE.Object3D;
+    if (newRect.isPinned) {
+      borderMesh = this.makePinnedRectBorders(newRect);
+    } else {
+      borderMesh = this.makeRectBorders(newRect, mesh.geometry);
+    }
+    borderMesh.name = newRect.id + 'border';
+    mesh.add(borderMesh);
+  }
+
+  private updateLabelGraphics(labels: RectLabel[]) {
+    this.clearLabels(labels);
+    labels.forEach((label) => {
+      let graphics: LabelGraphics;
+      if (this.lastScene.rectIdToLabelGraphics.get(label.rectId)) {
+        graphics = this.updateExistingLabelGraphics(label);
+      } else {
+        const circle = this.makeLabelCircleMesh(label);
+        this.scene.add(circle);
+        const line = this.makeLabelLine(label);
+        this.scene.add(line);
+        const text = this.makeLabelCssObject(label);
+        this.scene.add(text);
+        graphics = {label, circle, line, text};
+      }
+      this.lastScene.rectIdToLabelGraphics.set(label.rectId, graphics);
     });
+  }
+
+  private makeLabelCircleMesh(label: RectLabel): THREE.Mesh {
+    const geometry = new THREE.CircleGeometry(label.circle.radius, 20);
+    const material = this.makeLabelMaterial(label);
     const mesh = new THREE.Mesh(geometry, material);
-    mesh.position.set(circle.center.x, circle.center.y, circle.center.z);
+    mesh.position.set(
+      label.circle.center.x,
+      label.circle.center.y,
+      label.circle.center.z,
+    );
+    mesh.name = label.rectId + 'circle';
     return mesh;
   }
 
+  private makeLabelLine(label: RectLabel): THREE.Line {
+    const lineGeometry = this.makeLabelLineGeometry(label);
+    const lineMaterial = this.makeLabelMaterial(label);
+    const line = new THREE.Line(lineGeometry, lineMaterial);
+    line.name = label.rectId + 'line';
+    return line;
+  }
+
+  private makeLabelLineGeometry(label: RectLabel): THREE.BufferGeometry {
+    const linePoints = label.linePoints.map((point: Point3D) => {
+      return new THREE.Vector3(point.x, point.y, point.z);
+    });
+    return new THREE.BufferGeometry().setFromPoints(linePoints);
+  }
+
+  private makeLabelMaterial(label: RectLabel): THREE.LineBasicMaterial {
+    return new THREE.LineBasicMaterial({
+      color: label.isHighlighted
+        ? this.isDarkMode()
+          ? Canvas.RECT_EDGE_COLOR_DARK_MODE
+          : Canvas.RECT_EDGE_COLOR_LIGHT_MODE
+        : Canvas.LABEL_LINE_COLOR,
+    });
+  }
+
+  private makeLabelCssObject(label: RectLabel): CSS2DObject {
+    // Add rectangle label
+    const spanText: HTMLElement = document.createElement('span');
+    spanText.innerText = label.text;
+    spanText.className = 'mat-body-1';
+    spanText.style.backgroundColor = 'var(--background-color)';
+
+    // Hack: transparent/placeholder text used to push the visible text towards left
+    // (towards negative x) and properly align it with the label's vertical segment
+    const spanPlaceholder: HTMLElement = document.createElement('span');
+    spanPlaceholder.innerText = label.text;
+    spanPlaceholder.className = 'mat-body-1';
+    spanPlaceholder.style.opacity = '0';
+
+    const div: HTMLElement = document.createElement('div');
+    div.className = 'rect-label';
+    div.style.display = 'inline';
+    div.style.whiteSpace = 'nowrap';
+    div.appendChild(spanText);
+    div.appendChild(spanPlaceholder);
+
+    div.style.marginTop = '5px';
+    if (!label.isHighlighted) {
+      div.style.color = 'gray';
+    }
+    div.style.pointerEvents = 'auto';
+    div.style.cursor = 'pointer';
+    div.addEventListener('click', (event) =>
+      this.propagateUpdateHighlightedItem(event, label.rectId),
+    );
+
+    const labelCss = new CSS2DObject(div);
+    labelCss.position.set(
+      label.textCenter.x,
+      label.textCenter.y,
+      label.textCenter.z,
+    );
+    labelCss.name = label.rectId + 'text';
+    return labelCss;
+  }
+
+  private updateExistingLabelGraphics(newLabel: RectLabel): LabelGraphics {
+    const {
+      label: existingLabel,
+      circle,
+      line,
+      text,
+    } = assertDefined(
+      this.lastScene.rectIdToLabelGraphics.get(newLabel.rectId),
+    );
+
+    if (newLabel.circle.radius !== existingLabel.circle.radius) {
+      circle.geometry = new THREE.CircleGeometry(newLabel.circle.radius, 20);
+    }
+    if (!newLabel.circle.center.isEqual(existingLabel.circle.center)) {
+      circle.position.set(
+        newLabel.circle.center.x,
+        newLabel.circle.center.y,
+        newLabel.circle.center.z,
+      );
+    }
+
+    if (
+      newLabel.isHighlighted !== existingLabel.isHighlighted ||
+      this.isDarkMode() !== this.lastScene.isDarkMode
+    ) {
+      const lineMaterial = this.makeLabelMaterial(newLabel);
+      circle.material = lineMaterial;
+      line.material = lineMaterial;
+      text.element.style.color = newLabel.isHighlighted ? '' : 'gray';
+    }
+
+    if (
+      !ArrayUtils.equal(newLabel.linePoints, existingLabel.linePoints, (a, b) =>
+        (a as Point3D).isEqual(b as Point3D),
+      )
+    ) {
+      line.geometry = this.makeLabelLineGeometry(newLabel);
+    }
+
+    if (!newLabel.textCenter.isEqual(existingLabel.textCenter)) {
+      text.position.set(
+        newLabel.textCenter.x,
+        newLabel.textCenter.y,
+        newLabel.textCenter.z,
+      );
+    }
+
+    return {label: newLabel, circle, line, text};
+  }
+
   private propagateUpdateHighlightedItem(event: MouseEvent, newId: string) {
     event.preventDefault();
     const highlightedChangeEvent = new CustomEvent(
@@ -470,9 +807,36 @@ export class Canvas {
     event.target?.dispatchEvent(highlightedChangeEvent);
   }
 
-  private clearLabels() {
+  private clearLabels(labels: RectLabel[]) {
     if (this.canvasLabels) {
       this.canvasLabels.innerHTML = '';
     }
+    for (const [rectId, graphics] of this.lastScene.rectIdToLabelGraphics) {
+      if (!labels.some((label) => label.rectId === rectId)) {
+        this.scene.remove(graphics.circle);
+        this.scene.remove(graphics.line);
+        this.scene.remove(graphics.text);
+        this.lastScene.rectIdToLabelGraphics.delete(rectId);
+      }
+    }
   }
 }
+
+interface SceneState {
+  isDarkMode: boolean;
+  translatedPos?: Point3D | undefined;
+  rectIdToRectGraphics: Map<string, RectGraphics>;
+  rectIdToLabelGraphics: Map<string, LabelGraphics>;
+}
+
+interface RectGraphics {
+  rect: UiRect3D;
+  mesh: THREE.Mesh;
+}
+
+interface LabelGraphics {
+  label: RectLabel;
+  circle: THREE.Mesh;
+  line: THREE.Line;
+  text: CSS2DObject;
+}
diff --git a/tools/winscope/src/viewers/components/rects/canvas_test.ts b/tools/winscope/src/viewers/components/rects/canvas_test.ts
new file mode 100644
index 000000000..d18d22a8b
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/canvas_test.ts
@@ -0,0 +1,865 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {Box3D} from 'common/geometry/box3d';
+import {Distance} from 'common/geometry/distance';
+import {Point3D} from 'common/geometry/point3d';
+import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {
+  TransformType,
+  TransformTypeFlags,
+} from 'parsers/surface_flinger/transform_utils';
+import * as THREE from 'three';
+import {CSS2DObject} from 'three/examples/jsm/renderers/CSS2DRenderer';
+import {ViewerEvents} from 'viewers/common/viewer_events';
+import {Camera} from './camera';
+import {Canvas} from './canvas';
+import {ColorType} from './color_type';
+import {RectLabel} from './rect_label';
+import {UiRect3D} from './ui_rect3d';
+
+describe('Canvas', () => {
+  const rectId = 'rect1';
+
+  describe('updateViewPosition', () => {
+    let canvasRects: HTMLCanvasElement;
+    let canvasLabels: HTMLElement;
+    let canvas: Canvas;
+    let canvasWidthSpy: jasmine.Spy;
+    let canvasHeightSpy: jasmine.Spy;
+    let camera: Camera;
+    let boundingBox: Box3D;
+    let graphicsScene: THREE.Scene;
+    let graphicsCamera: THREE.OrthographicCamera;
+
+    beforeEach(() => {
+      canvasRects = document.createElement('canvas');
+      canvasWidthSpy = spyOnProperty(
+        canvasRects,
+        'clientWidth',
+      ).and.returnValue(100);
+      canvasHeightSpy = spyOnProperty(
+        canvasRects,
+        'clientHeight',
+      ).and.returnValue(100);
+      canvasLabels = document.createElement('canvas');
+      canvas = new Canvas(canvasRects, canvasLabels);
+      camera = makeCamera();
+      boundingBox = makeBoundingBox();
+      [graphicsScene, graphicsCamera] = canvas.renderView();
+    });
+
+    it('handles zero size canvas element', () => {
+      const canvasRendererSetSizeSpy = spyOn(canvas.renderer, 'setSize');
+      canvasWidthSpy.and.returnValue(0);
+      canvas.updateViewPosition(camera, boundingBox);
+      expect(canvasRendererSetSizeSpy).not.toHaveBeenCalled();
+
+      canvasWidthSpy.and.returnValue(100);
+      canvasHeightSpy.and.returnValue(0);
+      canvas.updateViewPosition(camera, boundingBox);
+      expect(canvasRendererSetSizeSpy).not.toHaveBeenCalled();
+    });
+
+    it('changes camera lrtb and maintains scene translated position based on canvas aspect ratio', () => {
+      camera.panScreenDistance = new Distance(2, 2);
+
+      canvas.updateViewPosition(camera, boundingBox);
+      const [l, r, t, b] = [
+        graphicsCamera.left,
+        graphicsCamera.right,
+        graphicsCamera.top,
+        graphicsCamera.bottom,
+      ];
+      const prevPosition = graphicsScene.position.clone();
+
+      canvasWidthSpy.and.returnValue(200);
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsCamera.left).toBeLessThan(l);
+      expect(graphicsCamera.right).toBeGreaterThan(r);
+      expect(graphicsCamera.top).toEqual(t);
+      expect(graphicsCamera.bottom).toEqual(b);
+      expect(graphicsScene.position).toEqual(prevPosition);
+
+      canvasWidthSpy.and.returnValue(100);
+      canvasHeightSpy.and.returnValue(200);
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsCamera.left).toEqual(l);
+      expect(graphicsCamera.right).toEqual(r);
+      expect(graphicsCamera.top).toBeGreaterThan(t);
+      expect(graphicsCamera.bottom).toBeLessThan(b);
+      expect(graphicsScene.position).toEqual(prevPosition);
+    });
+
+    it('changes scene translated position on change in pan screen distance', () => {
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevPosition = graphicsScene.position.clone();
+      const prevScale = graphicsScene.scale.clone();
+
+      camera.panScreenDistance = new Distance(2, 2);
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsScene.position.x).toBeGreaterThan(prevPosition.x);
+      expect(graphicsScene.position.y).toBeLessThan(prevPosition.y);
+      expect(graphicsScene.position.z).toEqual(prevPosition.z);
+      expect(graphicsScene.scale).toEqual(prevScale);
+    });
+
+    it('changes scene scale and scene translated position on change in zoom factor', () => {
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevPosition = graphicsScene.position.clone();
+      const sceneScale = graphicsScene.scale.clone();
+
+      camera.zoomFactor = 2;
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsScene.scale).toEqual(sceneScale.multiplyScalar(2));
+      expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(2));
+    });
+
+    it('changes camera position and scene translated x-position on change in rotation angle x', () => {
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevScenePos = graphicsScene.position.clone();
+      const prevCameraPos = graphicsCamera.position.clone();
+
+      camera.rotationAngleX = 1.5;
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsScene.position.x).toBeLessThan(prevScenePos.x);
+      expect(graphicsScene.position.y).toEqual(prevScenePos.y);
+      expect(graphicsScene.position.z).toEqual(prevScenePos.z);
+
+      expect(graphicsCamera.position.x).toEqual(prevCameraPos.x);
+      expect(graphicsCamera.position.y).toBeGreaterThan(prevCameraPos.y);
+      expect(graphicsCamera.position.z).toBeLessThan(prevCameraPos.z);
+    });
+
+    it('changes camera position and scene translated y-position on change in rotation angle y', () => {
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevScenePos = graphicsScene.position.clone();
+      const prevCameraPos = graphicsCamera.position.clone();
+
+      camera.rotationAngleY = 1.5;
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsScene.position.x).toEqual(prevScenePos.x);
+      expect(graphicsScene.position.y).toBeLessThan(prevScenePos.y);
+      expect(graphicsScene.position.z).toEqual(prevScenePos.z);
+
+      expect(graphicsCamera.position.x).toBeGreaterThan(prevCameraPos.x);
+      expect(graphicsCamera.position.y).toEqual(prevCameraPos.y);
+      expect(graphicsCamera.position.z).toBeLessThan(prevCameraPos.z);
+    });
+
+    it('changes scene scale and translated position on change in box diagonal', () => {
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevPosition = graphicsScene.position.clone();
+      const sceneScale = graphicsScene.scale.clone();
+
+      boundingBox.diagonal = 2;
+      canvas.updateViewPosition(camera, boundingBox);
+
+      expect(graphicsScene.scale).toEqual(sceneScale.multiplyScalar(0.5));
+      expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(0.5));
+    });
+
+    it('changes translated position on change in box depth', () => {
+      camera.rotationAngleX = 1;
+      camera.rotationAngleY = 1;
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevPosition = graphicsScene.position.clone();
+      const prevScale = graphicsScene.scale.clone();
+
+      boundingBox.depth = 2;
+      canvas.updateViewPosition(camera, boundingBox);
+      expect(graphicsScene.position).toEqual(prevPosition.multiplyScalar(2));
+      expect(graphicsScene.scale).toEqual(prevScale);
+    });
+
+    it('changes translated position on change in box center', () => {
+      camera.rotationAngleX = 1;
+      camera.rotationAngleY = 1;
+      canvas.updateViewPosition(camera, boundingBox);
+      const prevPosition = graphicsScene.position.clone();
+      const prevScale = graphicsScene.scale.clone();
+
+      boundingBox.center = new Point3D(3, 3, 3);
+      canvas.updateViewPosition(camera, boundingBox);
+      expect(graphicsScene.position).not.toEqual(prevPosition);
+      expect(graphicsScene.scale).toEqual(prevScale);
+    });
+
+    it('robust to no labels canvas', () => {
+      const canvas = new Canvas(canvasRects);
+      canvas.updateViewPosition(makeCamera(), makeBoundingBox());
+    });
+  });
+
+  describe('updateRects', () => {
+    let canvas: Canvas;
+    let isDarkMode: boolean;
+    let graphicsScene: THREE.Scene;
+
+    beforeEach(() => {
+      isDarkMode = false;
+      const canvasRects = document.createElement('canvas');
+      const canvasLabels = document.createElement('canvas');
+      canvas = new Canvas(canvasRects, canvasLabels, () => isDarkMode);
+      graphicsScene = canvas.renderView()[0];
+    });
+
+    it('adds and removes rects', () => {
+      const mapDeleteSpy = spyOn(Map.prototype, 'delete').and.callThrough();
+      canvas.updateRects([]);
+      expect(graphicsScene.getObjectByName(rectId)).toBeUndefined();
+      canvas.updateRects([makeUiRect3D(rectId)]);
+      expect(graphicsScene.getObjectByName(rectId)).toBeDefined();
+      canvas.updateRects([]);
+      expect(graphicsScene.getObjectByName(rectId)).toBeUndefined();
+      expect(mapDeleteSpy).toHaveBeenCalledOnceWith(rectId);
+    });
+
+    it('updates existing rects instead of adding new rect', () => {
+      const rect = makeUiRect3D(rectId);
+      canvas.updateRects([rect]);
+      const rectMesh = getRectMesh(rectId);
+      expect(rectMesh.position.z).toEqual(0);
+
+      const newRect = makeUiRect3D(rectId);
+      newRect.topLeft = new Point3D(0, 0, 1);
+      canvas.updateRects([newRect]);
+      expect(rectMesh.position.z).toEqual(1);
+      expect(getRectMesh('rect1')).toEqual(rectMesh);
+    });
+
+    it('makes rect with correct position and borders', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.topLeft = new Point3D(1, 1, 5);
+      rect.bottomRight = new Point3D(2, 2, 5);
+      canvas.updateRects([rect]);
+      const rectMesh = getRectMesh(rectId);
+      expect(rectMesh.position.z).toEqual(5);
+      checkBorderColor(rectId, Canvas.RECT_EDGE_COLOR_LIGHT_MODE);
+
+      isDarkMode = true;
+      canvas.updateRects([rect]);
+      checkBorderColor(rectId, Canvas.RECT_EDGE_COLOR_DARK_MODE);
+    });
+
+    it('makes rect with correct fill material', () => {
+      const rect = makeUiRect3D(rectId);
+      canvas.updateRects([rect]);
+      const rectMesh = getRectMesh(rectId);
+      const defaultVisibleRectColor = new THREE.Color(
+        200 / 255,
+        232 / 255,
+        183 / 255,
+      );
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        defaultVisibleRectColor,
+        Canvas.OPACITY_REGULAR,
+      );
+
+      const visibleWithOpacity = makeUiRect3D(rectId);
+      visibleWithOpacity.colorType = ColorType.VISIBLE_WITH_OPACITY;
+      canvas.updateRects([visibleWithOpacity]);
+      const material = rectMesh.material as THREE.MeshBasicMaterial;
+      expect(material.color).not.toEqual(defaultVisibleRectColor);
+      expect(material.opacity).toEqual(1);
+
+      const nonVisible = makeUiRect3D(rectId);
+      nonVisible.colorType = ColorType.NOT_VISIBLE;
+      canvas.updateRects([nonVisible]);
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        new THREE.Color(220 / 255, 220 / 255, 220 / 255),
+        Canvas.OPACITY_REGULAR,
+      );
+
+      const highlighted = makeUiRect3D(rectId);
+      highlighted.colorType = ColorType.HIGHLIGHTED;
+      canvas.updateRects([highlighted]);
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        Canvas.RECT_COLOR_HIGHLIGHTED_LIGHT_MODE,
+        Canvas.OPACITY_REGULAR,
+      );
+      isDarkMode = true;
+      canvas.updateRects([highlighted]);
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        Canvas.RECT_COLOR_HIGHLIGHTED_DARK_MODE,
+        Canvas.OPACITY_REGULAR,
+      );
+
+      const contentAndOpacity = makeUiRect3D(rectId);
+      contentAndOpacity.colorType = ColorType.HAS_CONTENT_AND_OPACITY;
+      canvas.updateRects([contentAndOpacity]);
+      checkMaterialColorAndOpacity(rectMesh, Canvas.RECT_COLOR_HAS_CONTENT, 1);
+
+      const content = makeUiRect3D(rectId);
+      content.colorType = ColorType.HAS_CONTENT;
+      canvas.updateRects([content]);
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        Canvas.RECT_COLOR_HAS_CONTENT,
+        Canvas.OPACITY_REGULAR,
+      );
+
+      const oversized = makeUiRect3D(rectId);
+      oversized.colorType = ColorType.HAS_CONTENT;
+      oversized.isOversized = true;
+      canvas.updateRects([oversized]);
+      checkMaterialColorAndOpacity(
+        rectMesh,
+        Canvas.RECT_COLOR_HAS_CONTENT,
+        Canvas.OPACITY_OVERSIZED,
+      );
+
+      const empty = makeUiRect3D(rectId);
+      empty.colorType = ColorType.EMPTY;
+      canvas.updateRects([empty]);
+      expect(rectMesh.material).toEqual(Canvas.TRANSPARENT_MATERIAL);
+    });
+
+    it('makes rect with fill region', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.fillRegion = [];
+      rect.colorType = ColorType.HAS_CONTENT;
+      canvas.updateRects([rect]);
+      const rectMesh = getRectMesh(rectId);
+      expect(rectMesh.material).toEqual(Canvas.TRANSPARENT_MATERIAL);
+
+      const fillRegionMesh = getFillRegionMesh(rectId);
+      expect(fillRegionMesh.position.z).toEqual(1);
+      checkMaterialColorAndOpacity(
+        fillRegionMesh,
+        Canvas.RECT_COLOR_HAS_CONTENT,
+        Canvas.OPACITY_REGULAR,
+      );
+    });
+
+    it('makes rect with pinned borders', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.topLeft = new Point3D(1, 1, 5);
+      rect.bottomRight = new Point3D(2, 2, 5);
+      rect.isPinned = true;
+
+      const rect2 = makeUiRect3D('rect2');
+      rect2.topLeft = new Point3D(1, 1, 5);
+      rect2.bottomRight = new Point3D(2, 2, 5);
+      rect2.isPinned = true;
+      canvas.updateRects([rect, rect2]);
+
+      checkBorderColor(rect.id, Canvas.RECT_EDGE_COLOR_PINNED);
+      checkBorderColor(rect2.id, Canvas.RECT_EDGE_COLOR_PINNED_ALT);
+    });
+
+    it('handles changes in geometry', () => {
+      const rect = makeUiRect3D(rectId);
+      canvas.updateRects([rect]);
+      const rectMesh = getRectMesh(rectId);
+      let rectGeometryId = rectMesh.geometry.id;
+
+      // no change
+      canvas.updateRects([rect]);
+      expect(rectMesh.geometry.id).toEqual(rectGeometryId);
+
+      // geometry object replaced
+      const roundRect = makeUiRect3D(rectId);
+      roundRect.cornerRadius = 5;
+      updateRectsAndCheckGeometryId(roundRect, rectMesh, rectGeometryId);
+      rectGeometryId = rectMesh.geometry.id;
+
+      const bottomRightChanged = makeUiRect3D(rectId);
+      bottomRightChanged.cornerRadius = 5;
+      bottomRightChanged.bottomRight = new Point3D(5, 5, 5);
+      updateRectsAndCheckGeometryId(
+        bottomRightChanged,
+        rectMesh,
+        rectGeometryId,
+      );
+      rectGeometryId = rectMesh.geometry.id;
+
+      const topLeftChanged = makeUiRect3D(rectId);
+      topLeftChanged.cornerRadius = 5;
+      topLeftChanged.bottomRight = new Point3D(5, 5, 5);
+      topLeftChanged.topLeft = new Point3D(0, 0, 5);
+      updateRectsAndCheckGeometryId(topLeftChanged, rectMesh, rectGeometryId);
+      rectGeometryId = rectMesh.geometry.id;
+
+      const rotated = makeUiRect3D(rectId);
+      rotated.cornerRadius = 5;
+      rotated.bottomRight = new Point3D(5, 5, 5);
+      rotated.topLeft = new Point3D(0, 0, 5);
+      rotated.transform = TransformType.getDefaultTransform(
+        TransformTypeFlags.ROT_90_VAL,
+        2,
+        2,
+      ).matrix;
+      const prevRotation = rectMesh.rotation.clone();
+      canvas.updateRects([rotated]);
+      expect(rectMesh.geometry.id).toEqual(rectGeometryId);
+      expect(rectMesh.rotation.equals(prevRotation)).toBeFalse();
+    });
+
+    it('handles changes in fill region', () => {
+      const noFillRegion = makeUiRect3D(rectId);
+      canvas.updateRects([noFillRegion]);
+      const rectMesh = getRectMesh(rectId);
+      expect(rectMesh.getObjectByName(rectId + 'fillRegion')).toBeUndefined();
+      expect(
+        (rectMesh.material as THREE.MeshBasicMaterial).color.getHex(),
+      ).toEqual(13166775);
+
+      const emptyFillRegion = makeUiRect3D(rectId);
+      emptyFillRegion.fillRegion = [];
+      canvas.updateRects([emptyFillRegion]);
+      const fillRegionMesh = getFillRegionMesh(rectId);
+      expect(rectMesh.material).toEqual(Canvas.TRANSPARENT_MATERIAL);
+      expect(
+        (fillRegionMesh.material as THREE.MeshBasicMaterial).color.getHex(),
+      ).toEqual(13166775);
+      let fillRegionGeometryId = fillRegionMesh.geometry.id;
+
+      const emptyFillRegionWithContent = makeUiRect3D(rectId);
+      emptyFillRegionWithContent.fillRegion = [];
+      emptyFillRegionWithContent.colorType = ColorType.HAS_CONTENT;
+      canvas.updateRects([emptyFillRegionWithContent]);
+      expect(rectMesh.material).toEqual(Canvas.TRANSPARENT_MATERIAL);
+      checkMaterialColorAndOpacity(
+        fillRegionMesh,
+        Canvas.RECT_COLOR_HAS_CONTENT,
+        Canvas.OPACITY_REGULAR,
+      );
+      let newGeometry = getFillRegionMesh(rectId).geometry;
+      expect(newGeometry.id).toEqual(fillRegionGeometryId);
+
+      const validFillRegion = makeUiRect3D(rectId);
+      validFillRegion.fillRegion = [
+        {
+          topLeft: emptyFillRegion.topLeft,
+          bottomRight: emptyFillRegion.bottomRight,
+        },
+      ];
+      canvas.updateRects([validFillRegion]);
+      newGeometry = getFillRegionMesh(rectId).geometry;
+      expect(newGeometry.id).not.toEqual(fillRegionGeometryId);
+      fillRegionGeometryId = newGeometry.id;
+
+      const differentFillRegion = makeUiRect3D(rectId);
+      differentFillRegion.fillRegion = [
+        {
+          topLeft: validFillRegion.fillRegion[0].topLeft,
+          bottomRight: new Point3D(4, 4, 2),
+        },
+      ];
+      canvas.updateRects([differentFillRegion]);
+      newGeometry = getFillRegionMesh(rectId).geometry;
+      expect(newGeometry.id).not.toEqual(fillRegionGeometryId);
+      fillRegionGeometryId = newGeometry.id;
+
+      canvas.updateRects([noFillRegion]);
+      expect(
+        getRectMesh(rectId).getObjectByName(rectId + 'fillRegion'),
+      ).toBeUndefined();
+    });
+
+    it('handles change from normal to pinned borders', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.topLeft = new Point3D(1, 1, 5);
+      rect.bottomRight = new Point3D(2, 2, 5);
+      canvas.updateRects([rect]);
+      checkBorderColor(rect.id, Canvas.RECT_EDGE_COLOR_LIGHT_MODE);
+
+      const pinnedRect = makeUiRect3D(rectId);
+      pinnedRect.topLeft = new Point3D(1, 1, 5);
+      pinnedRect.bottomRight = new Point3D(2, 2, 5);
+      pinnedRect.isPinned = true;
+      canvas.updateRects([pinnedRect]);
+      checkBorderColor(rect.id, Canvas.RECT_EDGE_COLOR_PINNED);
+    });
+
+    function checkMaterialColorAndOpacity(
+      mesh: THREE.Mesh,
+      color: THREE.Color | number,
+      opacity: number,
+    ) {
+      const material = mesh.material as THREE.MeshBasicMaterial;
+      if (color instanceof THREE.Color) {
+        expect(material.color).toEqual(color);
+      } else {
+        expect(material.color.getHex()).toEqual(color);
+      }
+      expect(material.opacity).toEqual(opacity);
+    }
+
+    function checkBorderColor(id: string, color: number) {
+      const rectMesh = getRectMesh(id);
+
+      const borderMesh = assertDefined(
+        rectMesh.getObjectByName(id + 'border'),
+      ) as THREE.Mesh;
+      expect(
+        (borderMesh.material as THREE.LineBasicMaterial).color.getHex(),
+      ).toEqual(color);
+    }
+
+    function getRectMesh(id: string) {
+      return assertDefined(graphicsScene.getObjectByName(id)) as THREE.Mesh;
+    }
+
+    function getFillRegionMesh(id: string) {
+      const rectMesh = getRectMesh(id);
+      return assertDefined(
+        rectMesh.getObjectByName(id + 'fillRegion'),
+      ) as THREE.Mesh;
+    }
+
+    function updateRectsAndCheckGeometryId(
+      rect: UiRect3D,
+      rectMesh: THREE.Mesh,
+      prevId: number,
+    ) {
+      canvas.updateRects([rect]);
+      expect(rectMesh.geometry.id).not.toEqual(prevId);
+    }
+  });
+
+  describe('updateLabels', () => {
+    let canvas: Canvas;
+    let isDarkMode: boolean;
+    let graphicsScene: THREE.Scene;
+
+    beforeEach(() => {
+      isDarkMode = false;
+      const canvasRects = document.createElement('canvas');
+      const canvasLabels = document.createElement('canvas');
+      canvas = new Canvas(canvasRects, canvasLabels, () => isDarkMode);
+      graphicsScene = canvas.renderView()[0];
+    });
+
+    it('adds and removes labels', () => {
+      const mapDeleteSpy = spyOn(Map.prototype, 'delete').and.callThrough();
+      canvas.updateLabels([]);
+      expect(graphicsScene.getObjectByName(rectId + 'circle')).toBeUndefined();
+      expect(graphicsScene.getObjectByName(rectId + 'line')).toBeUndefined();
+      expect(graphicsScene.getObjectByName(rectId + 'text')).toBeUndefined();
+
+      canvas.updateLabels([makeRectLabel(rectId)]);
+      expect(graphicsScene.getObjectByName(rectId + 'circle')).toBeDefined();
+      expect(graphicsScene.getObjectByName(rectId + 'line')).toBeDefined();
+      expect(graphicsScene.getObjectByName(rectId + 'text')).toBeDefined();
+
+      canvas.updateLabels([]);
+      expect(graphicsScene.getObjectByName(rectId + 'circle')).toBeUndefined();
+      expect(graphicsScene.getObjectByName(rectId + 'line')).toBeUndefined();
+      expect(graphicsScene.getObjectByName(rectId + 'text')).toBeUndefined();
+      expect(mapDeleteSpy).toHaveBeenCalledOnceWith(rectId);
+    });
+
+    it('updates existing labels instead of adding new labels', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const circleMesh = getCircleMesh(rectId);
+      const geometryId = circleMesh.geometry.id;
+
+      const newLabel = makeRectLabel(rectId);
+      newLabel.circle.radius = 2;
+      canvas.updateLabels([newLabel]);
+      expect(getCircleMesh(rectId)).toEqual(circleMesh);
+      expect(circleMesh.geometry.id).not.toEqual(geometryId);
+    });
+
+    it('makes label with correct circle and text geometry', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const circleMesh = getCircleMesh(rectId);
+      expect(
+        (circleMesh.geometry as THREE.CircleGeometry).parameters.radius,
+      ).toEqual(label.circle.radius);
+      checkVectorEqualToPoint(circleMesh.position, label.circle.center);
+      const text = getText(rectId);
+      checkVectorEqualToPoint(text.position, label.textCenter);
+    });
+
+    it('handles change in circle radius', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const circleMesh = getCircleMesh(rectId);
+
+      const newLabel = makeRectLabel(rectId);
+      newLabel.circle.radius = 2;
+      canvas.updateLabels([newLabel]);
+      expect(
+        (circleMesh.geometry as THREE.CircleGeometry).parameters.radius,
+      ).toEqual(2);
+    });
+
+    it('handles change in circle center', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const circleMesh = getCircleMesh(rectId);
+
+      const newLabel = makeRectLabel(rectId);
+      newLabel.circle.center = new Point3D(1, 1, 1);
+      canvas.updateLabels([newLabel]);
+      checkVectorEqualToPoint(circleMesh.position, newLabel.circle.center);
+    });
+
+    it('applies colors based on highlighted or dark mode state', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const circleMesh = getCircleMesh(rectId);
+      const line = getLine(rectId);
+      const text = getText(rectId);
+      expect(
+        (circleMesh.material as THREE.LineBasicMaterial).color.getHex(),
+      ).toEqual(Canvas.LABEL_LINE_COLOR);
+      expect((line.material as THREE.LineBasicMaterial).color.getHex()).toEqual(
+        Canvas.LABEL_LINE_COLOR,
+      );
+      expect(text.element.style.color).toEqual('gray');
+
+      const highlighted = makeRectLabel(rectId);
+      highlighted.isHighlighted = true;
+      canvas.updateLabels([highlighted]);
+      expect(
+        (circleMesh.material as THREE.LineBasicMaterial).color.getHex(),
+      ).toEqual(Canvas.RECT_EDGE_COLOR_LIGHT_MODE);
+      expect((line.material as THREE.LineBasicMaterial).color.getHex()).toEqual(
+        Canvas.RECT_EDGE_COLOR_LIGHT_MODE,
+      );
+      expect(text.element.style.color).toEqual('');
+
+      isDarkMode = true;
+      canvas.updateLabels([highlighted]);
+      expect(
+        (circleMesh.material as THREE.LineBasicMaterial).color.getHex(),
+      ).toEqual(Canvas.RECT_EDGE_COLOR_DARK_MODE);
+      expect((line.material as THREE.LineBasicMaterial).color.getHex()).toEqual(
+        Canvas.RECT_EDGE_COLOR_DARK_MODE,
+      );
+      expect(text.element.style.color).toEqual('');
+
+      canvas.updateLabels([label]);
+      expect(
+        (circleMesh.material as THREE.LineBasicMaterial).color.getHex(),
+      ).toEqual(Canvas.LABEL_LINE_COLOR);
+      expect((line.material as THREE.LineBasicMaterial).color.getHex()).toEqual(
+        Canvas.LABEL_LINE_COLOR,
+      );
+      expect(text.element.style.color).toEqual('gray');
+    });
+
+    it('handles change in line points', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const line = getLine(rectId);
+      const geometryId = line.geometry.id;
+
+      const newLabel = makeRectLabel(rectId);
+      newLabel.linePoints = [new Point3D(1, 1, 1), new Point3D(1, 2, 1)];
+      canvas.updateLabels([newLabel]);
+      expect(line.geometry.id).not.toEqual(geometryId);
+    });
+
+    it('handles change in text center', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const text = getText(rectId);
+
+      const newLabel = makeRectLabel(rectId);
+      newLabel.textCenter = new Point3D(1, 15, 1);
+      canvas.updateLabels([newLabel]);
+      checkVectorEqualToPoint(text.position, newLabel.textCenter);
+    });
+
+    it('robust to no labels canvas', () => {
+      const canvasRects = document.createElement('canvas');
+      const canvas = new Canvas(canvasRects);
+      canvas.updateLabels([]);
+    });
+
+    it('propagates highlighted item on text click', () => {
+      const label = makeRectLabel(rectId);
+      canvas.updateLabels([label]);
+      const text = getText(rectId);
+
+      let id: string | undefined;
+      text.element.addEventListener(
+        ViewerEvents.HighlightedIdChange,
+        (event) => {
+          id = (event as CustomEvent).detail.id;
+        },
+      );
+      text.element.click();
+      expect(id).toEqual(rectId);
+    });
+
+    function getCircleMesh(id: string): THREE.Mesh {
+      return assertDefined(
+        graphicsScene.getObjectByName(id + 'circle'),
+      ) as THREE.Mesh;
+    }
+
+    function getLine(id: string): THREE.Line {
+      return assertDefined(
+        graphicsScene.getObjectByName(id + 'line'),
+      ) as THREE.Line;
+    }
+
+    function getText(id: string): CSS2DObject {
+      return assertDefined(
+        graphicsScene.getObjectByName(id + 'text'),
+      ) as CSS2DObject;
+    }
+
+    function checkVectorEqualToPoint(vector: THREE.Vector3, point: Point3D) {
+      expect(
+        vector.equals(new THREE.Vector3(point.x, point.y, point.z)),
+      ).toBeTrue();
+    }
+  });
+
+  describe('renderView', () => {
+    let canvas: Canvas;
+    let rectsCompileSpy: jasmine.Spy;
+    let renderingSpies: jasmine.Spy[];
+
+    beforeEach(() => {
+      const canvasRects = document.createElement('canvas');
+      const canvasLabels = document.createElement('canvas');
+      canvas = new Canvas(canvasRects, canvasLabels);
+      rectsCompileSpy = spyOn(assertDefined(canvas.renderer), 'compile');
+      renderingSpies = [
+        spyOn(assertDefined(canvas.renderer), 'setPixelRatio'),
+        spyOn(assertDefined(canvas.renderer), 'render'),
+        spyOn(assertDefined(canvas.labelRenderer), 'render'),
+      ];
+    });
+
+    it('sets pixel ratio and renders rects and labels', () => {
+      canvas.renderView();
+      checkRenderSpiesCalled(1);
+    });
+
+    it('only compiles on first call', () => {
+      canvas.renderView();
+      expect(rectsCompileSpy).toHaveBeenCalledTimes(1);
+      checkRenderSpiesCalled(1);
+
+      canvas.renderView();
+      expect(rectsCompileSpy).toHaveBeenCalledTimes(1);
+      checkRenderSpiesCalled(2);
+    });
+
+    it('robust to no labels canvas', () => {
+      const canvasRects = document.createElement('canvas');
+      const canvas = new Canvas(canvasRects);
+      canvas.renderView();
+    });
+
+    function checkRenderSpiesCalled(times: number) {
+      renderingSpies.forEach((spy) => expect(spy).toHaveBeenCalledTimes(times));
+    }
+  });
+
+  describe('getClickedRectId', () => {
+    let canvas: Canvas;
+
+    beforeEach(() => {
+      const canvasRects = document.createElement('canvas');
+      const canvasLabels = document.createElement('canvas');
+      canvas = new Canvas(canvasRects, canvasLabels);
+      canvas.updateViewPosition(makeCamera(), makeBoundingBox());
+      canvas.renderView();
+    });
+
+    it('identifies clicked rect', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.isClickable = true;
+      canvas.updateRects([rect]);
+      canvas.renderView();
+
+      const id = canvas.getClickedRectId(0.1, 0.1, 0);
+      expect(id).toEqual('rect1');
+    });
+
+    it('does not identify rect if not clickable', () => {
+      const rect = makeUiRect3D(rectId);
+      canvas.updateRects([rect]);
+      expect(canvas.getClickedRectId(0.1, 0.1, 0)).toBeUndefined();
+    });
+
+    it('does not identify rect out of click area', () => {
+      const rect = makeUiRect3D(rectId);
+      rect.isClickable = true;
+      canvas.updateRects([rect]);
+      expect(canvas.getClickedRectId(2, 2, 0)).toBeUndefined();
+    });
+  });
+
+  function makeCamera(): Camera {
+    return {
+      rotationAngleX: 0,
+      rotationAngleY: 0,
+      zoomFactor: 1,
+      panScreenDistance: new Distance(0, 0),
+    };
+  }
+
+  function makeBoundingBox(): Box3D {
+    return {
+      width: 1,
+      height: 1,
+      depth: 1,
+      center: new Point3D(0, 0, 0),
+      diagonal: 1,
+    };
+  }
+
+  function makeUiRect3D(id: string): UiRect3D {
+    return {
+      id,
+      topLeft: new Point3D(0, 0, 0),
+      bottomRight: new Point3D(1, 1, 0),
+      cornerRadius: 0,
+      darkFactor: 1,
+      colorType: ColorType.VISIBLE,
+      isClickable: false,
+      transform: IDENTITY_MATRIX,
+      isOversized: false,
+      fillRegion: undefined,
+      isPinned: false,
+    };
+  }
+
+  function makeRectLabel(id: string): RectLabel {
+    return {
+      circle: {radius: 1, center: new Point3D(0, 0, 0)},
+      linePoints: [new Point3D(0, 0, 0), new Point3D(0, 1, 0)],
+      textCenter: new Point3D(0, 12, 0),
+      text: id,
+      isHighlighted: false,
+      rectId: id,
+    };
+  }
+});
diff --git a/tools/winscope/src/viewers/components/rects/color_type.ts b/tools/winscope/src/viewers/components/rects/color_type.ts
new file mode 100644
index 000000000..9c484df86
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/color_type.ts
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export enum ColorType {
+  VISIBLE,
+  VISIBLE_WITH_OPACITY,
+  NOT_VISIBLE,
+  HIGHLIGHTED,
+  HAS_CONTENT,
+  EMPTY,
+  HAS_CONTENT_AND_OPACITY,
+}
diff --git a/tools/winscope/src/viewers/components/rects/mapper3d.ts b/tools/winscope/src/viewers/components/rects/mapper3d.ts
index 40719781e..b2a399d39 100644
--- a/tools/winscope/src/viewers/components/rects/mapper3d.ts
+++ b/tools/winscope/src/viewers/components/rects/mapper3d.ts
@@ -15,46 +15,58 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {IDENTITY_MATRIX, TransformMatrix} from 'common/geometry_types';
-import {Size, UiRect} from 'viewers/components/rects/types2d';
-import {
-  Box3D,
-  ColorType,
-  Distance2D,
-  Label3D,
-  Point3D,
-  Rect3D,
-  Scene3D,
-  ShadingMode,
-} from './types3d';
+import {Box3D} from 'common/geometry/box3d';
+import {Distance} from 'common/geometry/distance';
+import {Point3D} from 'common/geometry/point3d';
+import {Rect3D} from 'common/geometry/rect3d';
+import {Size} from 'common/geometry/size';
+import {IDENTITY_MATRIX} from 'common/geometry/transform_matrix';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {UiRect} from 'viewers/components/rects/ui_rect';
+import {ColorType} from './color_type';
+import {RectLabel} from './rect_label';
+import {Scene} from './scene';
+import {ShadingMode} from './shading_mode';
+import {UiRect3D} from './ui_rect3d';
 
 class Mapper3D {
   private static readonly CAMERA_ROTATION_FACTOR_INIT = 1;
-  private static readonly Z_FIGHTING_EPSILON = 5;
-  private static readonly Z_SPACING_FACTOR_INIT = 1;
-  private static readonly Z_SPACING_MAX = 200;
+  private static readonly DISPLAY_CLUSTER_SPACING = 750;
   private static readonly LABEL_FIRST_Y_OFFSET = 100;
-  private static readonly LABEL_TEXT_Y_SPACING = 200;
   private static readonly LABEL_CIRCLE_RADIUS = 15;
+  private static readonly LABEL_SPACING_INIT_FACTOR = 12.5;
+  private static readonly LABEL_SPACING_PER_RECT_FACTOR = 5;
+  private static readonly LABEL_SPACING_MIN = 200;
+  private static readonly MAX_RENDERED_LABELS = 30;
+  private static readonly SINGLE_LABEL_SPACING_FACTOR = 1.75;
+  private static readonly Y_AXIS_ROTATION_FACTOR = 1.5;
+  private static readonly Z_FIGHTING_EPSILON = 5;
   private static readonly ZOOM_FACTOR_INIT = 1;
   private static readonly ZOOM_FACTOR_MIN = 0.1;
   private static readonly ZOOM_FACTOR_MAX = 30;
   private static readonly ZOOM_FACTOR_STEP = 0.2;
+  private static readonly Z_SPACING_FACTOR_INIT = 1;
+  private static readonly Z_SPACING_MAX = 200;
 
   private rects: UiRect[] = [];
   private highlightedRectId = '';
   private cameraRotationFactor = Mapper3D.CAMERA_ROTATION_FACTOR_INIT;
   private zSpacingFactor = Mapper3D.Z_SPACING_FACTOR_INIT;
   private zoomFactor = Mapper3D.ZOOM_FACTOR_INIT;
-  private panScreenDistance = new Distance2D(0, 0);
-  private currentGroupId = 0; // default stack id is usually 0
+  private panScreenDistance = new Distance(0, 0);
+  private currentGroupIds = [0]; // default stack id is usually 0
   private shadingModeIndex = 0;
   private allowedShadingModes: ShadingMode[] = [ShadingMode.GRADIENT];
+  private pinnedItems: UiHierarchyTreeNode[] = [];
 
   setRects(rects: UiRect[]) {
     this.rects = rects;
   }
 
+  setPinnedItems(value: UiHierarchyTreeNode[]) {
+    this.pinnedItems = value;
+  }
+
   setHighlightedRectId(id: string) {
     this.highlightedRectId = id;
   }
@@ -85,7 +97,7 @@ class Mapper3D {
     this.zoomFactor = Math.max(this.zoomFactor, Mapper3D.ZOOM_FACTOR_MIN);
   }
 
-  addPanScreenDistance(distance: Distance2D) {
+  addPanScreenDistance(distance: Distance) {
     this.panScreenDistance.dx += distance.dx;
     this.panScreenDistance.dy += distance.dy;
   }
@@ -102,12 +114,12 @@ class Mapper3D {
     this.panScreenDistance.dy = 0;
   }
 
-  getCurrentGroupId(): number {
-    return this.currentGroupId;
+  getCurrentGroupIds(): number[] {
+    return this.currentGroupIds;
   }
 
-  setCurrentGroupId(id: number) {
-    this.currentGroupId = id;
+  setCurrentGroupIds(ids: number[]) {
+    this.currentGroupIds = ids;
   }
 
   setAllowedShadingModes(modes: ShadingMode[]) {
@@ -154,36 +166,60 @@ class Mapper3D {
     );
   }
 
-  computeScene(): Scene3D {
-    const rects2d = this.selectRectsToDraw(this.rects);
-    rects2d.sort(this.compareDepth);
-    const rects3d = this.computeRects(rects2d);
-    const labels3d = this.computeLabels(rects2d, rects3d);
-    const boundingBox = this.computeBoundingBox(rects3d, labels3d);
+  computeScene(): Scene {
+    const rects3d: UiRect3D[] = [];
+    const labels3d: RectLabel[] = [];
+    let clusterYOffset = 0;
+    let boundingBox: Box3D | undefined;
+
+    for (const groupId of this.currentGroupIds) {
+      const rects2dForGroupId = this.selectRectsToDraw(this.rects, groupId);
+      rects2dForGroupId.sort(this.compareDepth); // decreasing order of depth
+      const rects3dForGroupId = this.computeRects(
+        rects2dForGroupId,
+        clusterYOffset,
+      );
+      const labels3dForGroupId = this.computeLabels(
+        rects2dForGroupId,
+        rects3dForGroupId,
+      );
+      rects3d.push(...rects3dForGroupId);
+      labels3d.push(...labels3dForGroupId);
+
+      boundingBox = this.computeBoundingBox(rects3d, labels3d);
+      clusterYOffset += boundingBox.height + Mapper3D.DISPLAY_CLUSTER_SPACING;
+    }
 
-    const scene: Scene3D = {
-      boundingBox,
+    const angleX = this.getCameraXAxisAngle();
+    const scene: Scene = {
+      boundingBox: boundingBox ?? this.computeBoundingBox(rects3d, labels3d),
       camera: {
-        rotationFactor: this.cameraRotationFactor,
+        rotationAngleX: angleX,
+        rotationAngleY: angleX * Mapper3D.Y_AXIS_ROTATION_FACTOR,
         zoomFactor: this.zoomFactor,
         panScreenDistance: this.panScreenDistance,
       },
       rects: rects3d,
       labels: labels3d,
     };
-
     return scene;
   }
 
+  private getCameraXAxisAngle(): number {
+    return (this.cameraRotationFactor * Math.PI * 45) / 360;
+  }
+
   private compareDepth(a: UiRect, b: UiRect): number {
+    if (a.isDisplay && !b.isDisplay) return 1;
+    if (!a.isDisplay && b.isDisplay) return -1;
     return b.depth - a.depth;
   }
 
-  private selectRectsToDraw(rects: UiRect[]): UiRect[] {
-    return rects.filter((rect) => rect.groupId === this.currentGroupId);
+  private selectRectsToDraw(rects: UiRect[], groupId: number): UiRect[] {
+    return rects.filter((rect) => rect.groupId === groupId);
   }
 
-  private computeRects(rects2d: UiRect[]): Rect3D[] {
+  private computeRects(rects2d: UiRect[], clusterYOffset: number): UiRect3D[] {
     let visibleRectsSoFar = 0;
     let visibleRectsTotal = 0;
     let nonVisibleRectsSoFar = 0;
@@ -212,11 +248,11 @@ class Mapper3D {
     };
 
     let z = 0;
-    const rects3d = rects2d.map((rect2d): Rect3D => {
+    const rects3d = rects2d.map((rect2d, i): UiRect3D => {
+      const j = rects2d.length - 1 - i; // rects sorted in decreasing order of depth; increment z by L - 1 - i
       z =
         this.zSpacingFactor *
-        (Mapper3D.Z_SPACING_MAX * rect2d.depth +
-          computeAntiZFightingOffset(rect2d.depth));
+        (Mapper3D.Z_SPACING_MAX * j + computeAntiZFightingOffset(j));
 
       let darkFactor = 0;
       if (rect2d.isVisible) {
@@ -228,25 +264,29 @@ class Mapper3D {
           (nonVisibleRectsTotal - nonVisibleRectsSoFar++) /
           nonVisibleRectsTotal;
       }
+      let fillRegion: Rect3D[] | undefined;
+      if (rect2d.fillRegion) {
+        fillRegion = rect2d.fillRegion.rects.map((r) => {
+          return {
+            topLeft: new Point3D(r.x, r.y, z),
+            bottomRight: new Point3D(r.x + r.w, r.y + r.h, z),
+          };
+        });
+      }
+      const transform = rect2d.transform ?? IDENTITY_MATRIX;
 
-      const rect = {
+      const rect: UiRect3D = {
         id: rect2d.id,
-        topLeft: {
-          x: rect2d.x,
-          y: rect2d.y,
-          z,
-        },
-        bottomRight: {
-          x: rect2d.x + rect2d.w,
-          y: rect2d.y + rect2d.h,
-          z,
-        },
+        topLeft: new Point3D(rect2d.x, rect2d.y, z),
+        bottomRight: new Point3D(rect2d.x + rect2d.w, rect2d.y + rect2d.h, z),
         isOversized: false,
         cornerRadius: rect2d.cornerRadius,
         darkFactor,
         colorType: this.getColorType(rect2d),
         isClickable: rect2d.isClickable,
-        transform: rect2d.transform ?? IDENTITY_MATRIX,
+        transform: clusterYOffset ? transform.addTy(clusterYOffset) : transform,
+        fillRegion,
+        isPinned: this.pinnedItems.some((node) => node.id === rect2d.id),
       };
       return this.cropOversizedRect(rect, maxDisplaySize);
     });
@@ -255,7 +295,7 @@ class Mapper3D {
   }
 
   private getColorType(rect2d: UiRect): ColorType {
-    if (this.highlightedRectId === rect2d.id && rect2d.isClickable) {
+    if (this.isHighlighted(rect2d)) {
       return ColorType.HIGHLIGHTED;
     }
     if (this.isWireFrame()) {
@@ -296,7 +336,7 @@ class Mapper3D {
     };
   }
 
-  private cropOversizedRect(rect3d: Rect3D, maxDisplaySize: Size): Rect3D {
+  private cropOversizedRect(rect3d: UiRect3D, maxDisplaySize: Size): UiRect3D {
     // Arbitrary max size for a rect (2x the maximum display)
     let maxDimension = Number.MAX_VALUE;
     if (maxDisplaySize.height > 0) {
@@ -320,38 +360,69 @@ class Mapper3D {
     return rect3d;
   }
 
-  private computeLabels(rects2d: UiRect[], rects3d: Rect3D[]): Label3D[] {
-    const labels3d: Label3D[] = [];
+  private computeLabels(rects2d: UiRect[], rects3d: UiRect3D[]): RectLabel[] {
+    const labels3d: RectLabel[] = [];
 
-    let labelY =
-      Math.max(
-        ...rects3d.map((rect) => {
-          return this.matMultiply(rect.transform, rect.bottomRight).y;
-        }),
-      ) + Mapper3D.LABEL_FIRST_Y_OFFSET;
+    const bottomRightCorners = rects3d.map((rect) =>
+      rect.transform.transformPoint3D(rect.bottomRight),
+    );
+    const lowestYPoint = Math.max(...bottomRightCorners.map((p) => p.y));
+    const rightmostXPoint = Math.max(...bottomRightCorners.map((p) => p.x));
+
+    const cameraTiltFactor =
+      Math.sin(this.getCameraXAxisAngle()) / Mapper3D.Y_AXIS_ROTATION_FACTOR;
+    const labelTextYSpacing = Math.max(
+      (rects2d.length * Mapper3D.LABEL_SPACING_MIN) /
+        Mapper3D.LABEL_SPACING_PER_RECT_FACTOR,
+      lowestYPoint / Mapper3D.LABEL_SPACING_INIT_FACTOR,
+    );
+    const scaleFactor =
+      Math.min(this.zoomFactor, Math.max(1, Math.sqrt(rects2d.length)) / 2) **
+      2;
+
+    let labelY = lowestYPoint + Mapper3D.LABEL_FIRST_Y_OFFSET / scaleFactor;
+    let lastDepth: number | undefined;
 
     rects2d.forEach((rect2d, index) => {
       if (!rect2d.label) {
         return;
       }
+      const j = rects2d.length - 1 - index; // rects sorted in decreasing order of depth; increment labelY by depth at L - 1 - i
+      if (this.onlyRenderSelectedLabel(rects2d)) {
+        // only render the selected rect label
+        if (!this.isHighlighted(rect2d)) {
+          return;
+        }
+        labelY +=
+          ((rects2d[j].depth / rects2d[0].depth) *
+            labelTextYSpacing *
+            Mapper3D.SINGLE_LABEL_SPACING_FACTOR *
+            this.zSpacingFactor) /
+          Math.sqrt(scaleFactor);
+      } else {
+        if (lastDepth !== undefined) {
+          labelY += ((lastDepth - j) * labelTextYSpacing) / scaleFactor;
+        }
+        lastDepth = j;
+      }
 
       const rect3d = rects3d[index];
 
-      const bottomLeft: Point3D = {
-        x: rect3d.topLeft.x,
-        y: rect3d.topLeft.y,
-        z: rect3d.topLeft.z,
-      };
-      const topRight: Point3D = {
-        x: rect3d.bottomRight.x,
-        y: rect3d.bottomRight.y,
-        z: rect3d.bottomRight.z,
-      };
+      const bottomLeft = new Point3D(
+        rect3d.topLeft.x,
+        rect3d.topLeft.y,
+        rect3d.topLeft.z,
+      );
+      const topRight = new Point3D(
+        rect3d.bottomRight.x,
+        rect3d.bottomRight.y,
+        rect3d.bottomRight.z,
+      );
       const lineStarts = [
-        this.matMultiply(rect3d.transform, rect3d.topLeft),
-        this.matMultiply(rect3d.transform, rect3d.bottomRight),
-        this.matMultiply(rect3d.transform, bottomLeft),
-        this.matMultiply(rect3d.transform, topRight),
+        rect3d.transform.transformPoint3D(rect3d.topLeft),
+        rect3d.transform.transformPoint3D(rect3d.bottomRight),
+        rect3d.transform.transformPoint3D(bottomLeft),
+        rect3d.transform.transformPoint3D(topRight),
       ];
       let maxIndex = 0;
       for (let i = 1; i < lineStarts.length; i++) {
@@ -360,25 +431,23 @@ class Mapper3D {
         }
       }
       const lineStart = lineStarts[maxIndex];
+
+      const xDiff = rightmostXPoint - lineStart.x;
+
       lineStart.x += Mapper3D.LABEL_CIRCLE_RADIUS / 2;
 
-      const lineEnd: Point3D = {
-        x: lineStart.x,
-        y: labelY,
-        z: lineStart.z,
-      };
+      const lineEnd = new Point3D(
+        lineStart.x,
+        labelY + xDiff * cameraTiltFactor,
+        lineStart.z,
+      );
 
-      const isHighlighted =
-        rect2d.isClickable && this.highlightedRectId === rect2d.id;
+      const isHighlighted = this.isHighlighted(rect2d);
 
-      const label3d: Label3D = {
+      const RectLabel: RectLabel = {
         circle: {
           radius: Mapper3D.LABEL_CIRCLE_RADIUS,
-          center: {
-            x: lineStart.x,
-            y: lineStart.y,
-            z: lineStart.z + 0.5,
-          },
+          center: new Point3D(lineStart.x, lineStart.y, lineStart.z + 0.5),
         },
         linePoints: [lineStart, lineEnd],
         textCenter: lineEnd,
@@ -386,29 +455,19 @@ class Mapper3D {
         isHighlighted,
         rectId: rect2d.id,
       };
-      labels3d.push(label3d);
-
-      labelY += Mapper3D.LABEL_TEXT_Y_SPACING;
+      labels3d.push(RectLabel);
     });
 
     return labels3d;
   }
 
-  private matMultiply(mat: TransformMatrix, point: Point3D): Point3D {
-    return {
-      x: mat.dsdx * point.x + mat.dsdy * point.y + mat.tx,
-      y: mat.dtdx * point.x + mat.dtdy * point.y + mat.ty,
-      z: point.z,
-    };
-  }
-
-  private computeBoundingBox(rects: Rect3D[], labels: Label3D[]): Box3D {
+  private computeBoundingBox(rects: UiRect3D[], labels: RectLabel[]): Box3D {
     if (rects.length === 0) {
       return {
         width: 1,
         height: 1,
         depth: 1,
-        center: {x: 0, y: 0, z: 0},
+        center: new Point3D(0, 0, 0),
         diagonal: Math.sqrt(3),
       };
     }
@@ -444,17 +503,20 @@ class Mapper3D {
       updateMinMaxCoordinates(rect.bottomRight);
     });
 
-    labels.forEach((label) => {
-      label.linePoints.forEach((point) => {
-        updateMinMaxCoordinates(point);
+    // if only selected rect label rendered, do not include in bounding box
+    if (!this.onlyRenderSelectedLabel(rects)) {
+      labels.forEach((label) => {
+        label.linePoints.forEach((point) => {
+          updateMinMaxCoordinates(point);
+        });
       });
-    });
+    }
 
-    const center: Point3D = {
-      x: (minX + maxX) / 2,
-      y: (minY + maxY) / 2,
-      z: (minZ + maxZ) / 2,
-    };
+    const center = new Point3D(
+      (minX + maxX) / 2,
+      (minY + maxY) / 2,
+      (minZ + maxZ) / 2,
+    );
 
     const width = maxX - minX;
     const height = maxY - minY;
@@ -468,6 +530,17 @@ class Mapper3D {
       diagonal: Math.sqrt(width * width + height * height + depth * depth),
     };
   }
+
+  isHighlighted(rect: UiRect): boolean {
+    return rect.isClickable && this.highlightedRectId === rect.id;
+  }
+
+  private onlyRenderSelectedLabel(rects: Array<UiRect | UiRect3D>): boolean {
+    return (
+      rects.length > Mapper3D.MAX_RENDERED_LABELS ||
+      this.currentGroupIds.length > 1
+    );
+  }
 }
 
 export {Mapper3D};
diff --git a/tools/winscope/src/viewers/components/rects/rect_label.ts b/tools/winscope/src/viewers/components/rects/rect_label.ts
new file mode 100644
index 000000000..8a62794ca
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/rect_label.ts
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Circle3D} from 'common/geometry/circle3d';
+import {Point3D} from 'common/geometry/point3d';
+
+export interface RectLabel {
+  circle: Circle3D;
+  linePoints: Point3D[];
+  textCenter: Point3D;
+  text: string;
+  isHighlighted: boolean;
+  rectId: string;
+}
diff --git a/tools/winscope/src/viewers/components/rects/rects_component.ts b/tools/winscope/src/viewers/components/rects/rects_component.ts
index af5e96efe..0a32587ae 100644
--- a/tools/winscope/src/viewers/components/rects/rects_component.ts
+++ b/tools/winscope/src/viewers/components/rects/rects_component.ts
@@ -32,21 +32,23 @@ import {MatIconRegistry} from '@angular/material/icon';
 import {MatSelectChange} from '@angular/material/select';
 import {DomSanitizer} from '@angular/platform-browser';
 import {assertDefined} from 'common/assert_utils';
+import {Distance} from 'common/geometry/distance';
 import {PersistentStore} from 'common/persistent_store';
 import {UrlUtils} from 'common/url_utils';
 import {Analytics} from 'logging/analytics';
 import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 import {RectDblClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {iconDividerStyle} from 'viewers/components/styles/icon_divider.styles';
 import {multlineTooltip} from 'viewers/components/styles/tooltip.styles';
 import {viewerCardInnerStyle} from 'viewers/components/styles/viewer_card.styles';
 import {Canvas} from './canvas';
 import {Mapper3D} from './mapper3d';
-import {Distance2D, ShadingMode} from './types3d';
+import {ShadingMode} from './shading_mode';
 
 @Component({
   selector: 'rects-view',
@@ -66,9 +68,9 @@ import {Distance2D, ShadingMode} from './types3d';
             [matTooltip]="getShadingMode()"
             [disabled]="shadingModes.length < 2"
             (click)="onShadingModeButtonClicked()" #shadingModeButton>
-            <mat-icon *ngIf="mapper3d.isWireFrame()" class="material-symbols-outlined" aria-hidden="true"> deployed_code </mat-icon>
-            <mat-icon *ngIf="mapper3d.isShadedByGradient()" svgIcon="cube_partial_shade"></mat-icon>
-            <mat-icon *ngIf="mapper3d.isShadedByOpacity()" svgIcon="cube_full_shade"></mat-icon>
+            <mat-icon *ngIf="largeRectsMapper3d.isWireFrame()" class="material-symbols-outlined" aria-hidden="true"> deployed_code </mat-icon>
+            <mat-icon *ngIf="largeRectsMapper3d.isShadedByGradient()" svgIcon="cube_partial_shade"></mat-icon>
+            <mat-icon *ngIf="largeRectsMapper3d.isShadedByOpacity()" svgIcon="cube_full_shade"></mat-icon>
           </button>
 
           <div class="icon-divider"></div>
@@ -86,7 +88,7 @@ import {Distance2D, ShadingMode} from './types3d';
               min="0"
               max="1"
               aria-label="units"
-              [value]="mapper3d.getCameraRotationFactor()"
+              [value]="largeRectsMapper3d.getCameraRotationFactor()"
               (input)="onRotationSliderChange($event.value)"
               (focus)="$event.target.blur()"
               color="accent"
@@ -119,6 +121,7 @@ import {Distance2D, ShadingMode} from './types3d';
             (mouseenter)="onInteractionStart([zoomInButton])"
             (mouseleave)="onInteractionEnd([zoomInButton])"
             mat-icon-button
+            class="zoom-in-button"
             (click)="onZoomInClick()" #zoomInButton>
             <mat-icon aria-hidden="true"> zoom_in </mat-icon>
           </button>
@@ -127,6 +130,7 @@ import {Distance2D, ShadingMode} from './types3d';
             (mouseenter)="onInteractionStart([zoomOutButton])"
             (mouseleave)="onInteractionEnd([zoomOutButton])"
             mat-icon-button
+            class="zoom-out-button"
             (click)="onZoomOutClick()" #zoomOutButton>
             <mat-icon aria-hidden="true"> zoom_out </mat-icon>
           </button>
@@ -139,6 +143,7 @@ import {Distance2D, ShadingMode} from './types3d';
             (mouseleave)="onInteractionEnd([resetZoomButton])"
             mat-icon-button
             matTooltip="Restore camera settings"
+            class="reset-button"
             (click)="resetCamera()" #resetZoomButton>
             <mat-icon aria-hidden="true"> restore </mat-icon>
           </button>
@@ -157,12 +162,29 @@ import {Distance2D, ShadingMode} from './types3d';
           <span class="mat-body-1"> {{groupLabel}}: </span>
           <mat-form-field appearance="none" class="displays-select">
             <mat-select
-              (selectionChange)="onDisplayChange($event)"
-              [value]="currentDisplay?.name">
+              #displaySelect
+              disableOptionCentering
+              (selectionChange)="onDisplaySelectChange($event)"
+              [value]="currentDisplays"
+              [disabled]="internalDisplays.length === 1"
+              multiple>
+              <mat-select-trigger>
+                <span>
+                  {{ getSelectTriggerValue() }}
+                </span>
+              </mat-select-trigger>
               <mat-option
-                *ngFor="let name of displayNames"
-                [value]="name">
-                {{ name }}
+                *ngFor="let display of internalDisplays"
+                [value]="display"
+                [matTooltip]="'Display Id: ' + display.displayId"
+                matTooltipPosition="right">
+                <div class="option-label">
+                  <button
+                    mat-flat-button
+                    class="option-only-button"
+                    (click)="onOnlyButtonClick($event, display)"> Only </button>
+                  <span class="option-label-text"> {{ display.name }} </span>
+                </div>
               </mat-option>
             </mat-select>
           </mat-form-field>
@@ -170,6 +192,8 @@ import {Distance2D, ShadingMode} from './types3d';
       </div>
     </div>
     <mat-divider></mat-divider>
+    <span class="mat-body-1 placeholder-text" *ngIf="rects.length===0"> No rects found. </span>
+    <span class="mat-body-1 placeholder-text" *ngIf="currentDisplays.length===0"> No displays selected. </span>
     <div class="rects-content">
       <div class="canvas-container">
         <canvas
@@ -274,6 +298,28 @@ import {Distance2D, ShadingMode} from './types3d';
         position: absolute;
         z-index: 1000;
       }
+
+      .option-label {
+        display: flex;
+        align-items: center;
+        justify-content: space-between;
+      }
+
+      .option-only-button {
+        padding: 0 10px;
+        border-radius: 10px;
+        background-color: var(--disabled-color) !important;
+        color: var(--default-text-color);
+        min-width: fit-content;
+        height: 18px;
+        align-items: center;
+        display: flex;
+      }
+
+      .option-label-text {
+        overflow: hidden;
+        text-overflow: ellipsis;
+      }
     `,
     multlineTooltip,
     iconDividerStyle,
@@ -296,6 +342,8 @@ export class RectsComponent implements OnInit, OnDestroy {
   @Input() shadingModes: ShadingMode[] = [ShadingMode.GRADIENT];
   @Input() userOptions: UserOptions = {};
   @Input() dependencies: TraceType[] = [];
+  @Input() pinnedItems: UiHierarchyTreeNode[] = [];
+  @Input() isDarkMode = false;
 
   @Output() collapseButtonClicked = new EventEmitter();
 
@@ -303,31 +351,32 @@ export class RectsComponent implements OnInit, OnDestroy {
   private internalMiniRects?: UiRect[];
   private storeKeyZSpacingFactor = '';
   private storeKeyShadingMode = '';
-  private displayNames: string[] = [];
   private internalDisplays: DisplayIdentifier[] = [];
   private internalHighlightedItem = '';
-  private currentDisplay: DisplayIdentifier | undefined;
-  private mapper3d: Mapper3D;
+  private currentDisplays: DisplayIdentifier[] = [];
+  private largeRectsMapper3d = new Mapper3D();
+  private miniRectsMapper3d = new Mapper3D();
   private largeRectsCanvas?: Canvas;
   private miniRectsCanvas?: Canvas;
-  private resizeObserver: ResizeObserver;
+  private resizeObserver = new ResizeObserver((entries) => {
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    this.largeRectsCanvas?.renderView();
+  });
   private largeRectsCanvasElement?: HTMLCanvasElement;
   private miniRectsCanvasElement?: HTMLCanvasElement;
   private largeRectsLabelsElement?: HTMLElement;
   private mouseMoveListener = (event: MouseEvent) => this.onMouseMove(event);
   private mouseUpListener = (event: MouseEvent) => this.onMouseUp(event);
+  private panning = false;
 
   private static readonly ZOOM_SCROLL_RATIO = 0.3;
 
   constructor(
-    @Inject(ElementRef) private elementRef: ElementRef,
+    @Inject(ElementRef) private elementRef: ElementRef<HTMLElement>,
     @Inject(MatIconRegistry) private matIconRegistry: MatIconRegistry,
     @Inject(DomSanitizer) private domSanitizer: DomSanitizer,
   ) {
-    this.mapper3d = new Mapper3D();
-    this.resizeObserver = new ResizeObserver((entries) => {
-      this.drawLargeRectsAndLabels();
-    });
     this.matIconRegistry.addSvgIcon(
       'cube_full_shade',
       this.domSanitizer.bypassSecurityTrustResourceUrl(
@@ -343,14 +392,15 @@ export class RectsComponent implements OnInit, OnDestroy {
   }
 
   ngOnInit() {
-    this.mapper3d.setAllowedShadingModes(this.shadingModes);
+    this.largeRectsMapper3d.setAllowedShadingModes(this.shadingModes);
 
-    const canvasContainer: HTMLElement =
-      this.elementRef.nativeElement.querySelector('.canvas-container');
+    const canvasContainer = assertDefined(
+      this.elementRef.nativeElement.querySelector<HTMLElement>(
+        '.canvas-container',
+      ),
+    );
     this.resizeObserver.observe(canvasContainer);
 
-    const isDarkMode = () => this.store?.get('dark-mode') === 'true';
-
     this.largeRectsCanvasElement = canvasContainer.querySelector(
       '.large-rects-canvas',
     )! as HTMLCanvasElement;
@@ -360,7 +410,7 @@ export class RectsComponent implements OnInit, OnDestroy {
     this.largeRectsCanvas = new Canvas(
       this.largeRectsCanvasElement,
       this.largeRectsLabelsElement,
-      isDarkMode,
+      () => this.isDarkMode,
     );
     this.largeRectsCanvasElement.addEventListener('mousedown', (event) =>
       this.onCanvasMouseDown(event),
@@ -370,12 +420,12 @@ export class RectsComponent implements OnInit, OnDestroy {
       this.updateControlsFromStore();
     }
 
-    this.currentDisplay =
+    this.currentDisplays =
       this.internalDisplays.length > 0
-        ? this.getFirstDisplayWithRectsOrFirstDisplay(this.internalDisplays)
-        : undefined;
-    this.mapper3d.increaseZoomFactor(this.zoomFactor - 1);
-    this.drawLargeRectsAndLabels();
+        ? [this.getActiveDisplay(this.internalDisplays)]
+        : [];
+    this.largeRectsMapper3d.increaseZoomFactor(this.zoomFactor - 1);
+    this.redrawLargeRectsAndLabels();
 
     this.miniRectsCanvasElement = canvasContainer.querySelector(
       '.mini-rects-canvas',
@@ -383,47 +433,71 @@ export class RectsComponent implements OnInit, OnDestroy {
     this.miniRectsCanvas = new Canvas(
       this.miniRectsCanvasElement,
       undefined,
-      isDarkMode,
+      () => this.isDarkMode,
     );
+    this.miniRectsMapper3d.setShadingMode(ShadingMode.GRADIENT);
+    this.miniRectsMapper3d.resetToOrthogonalState();
     if (this.miniRects && this.miniRects.length > 0) {
+      this.internalMiniRects = this.miniRects;
       this.drawMiniRects();
     }
   }
 
-  blurTab() {
-    (document.activeElement as HTMLElement).blur();
-  }
-
   ngOnChanges(simpleChanges: SimpleChanges) {
-    if (simpleChanges['highlightedItem']) {
-      this.internalHighlightedItem =
-        simpleChanges['highlightedItem'].currentValue;
-      this.mapper3d.setHighlightedRectId(this.internalHighlightedItem);
-      if (!(simpleChanges['rects'] || simpleChanges['displays'])) {
-        this.drawLargeRectsAndLabels();
-      }
+    this.handleLargeRectChanges(simpleChanges);
+    if (
+      simpleChanges['miniRects'] ||
+      (this.miniRects && simpleChanges['isDarkMode'])
+    ) {
+      this.internalMiniRects = this.miniRects;
+      this.drawMiniRects();
     }
+  }
+
+  private handleLargeRectChanges(simpleChanges: SimpleChanges) {
     let displayChange = false;
     if (simpleChanges['displays']) {
       const curr: DisplayIdentifier[] = simpleChanges['displays'].currentValue;
-      const prev: DisplayIdentifier[] | null =
-        simpleChanges['displays'].previousValue;
+      const prev: DisplayIdentifier[] | undefined =
+        simpleChanges['displays'].previousValue ?? undefined;
       displayChange =
         curr.length > 0 &&
         !curr.every((d, index) => d.displayId === prev?.at(index)?.displayId);
     }
+
+    let redrawRects = false;
+    let recolorRects = false;
+    let recolorLabels = false;
+    if (simpleChanges['pinnedItems']) {
+      this.largeRectsMapper3d.setPinnedItems(this.pinnedItems);
+      recolorRects = true;
+    }
+    if (simpleChanges['highlightedItem']) {
+      this.internalHighlightedItem =
+        simpleChanges['highlightedItem'].currentValue;
+      this.largeRectsMapper3d.setHighlightedRectId(
+        this.internalHighlightedItem,
+      );
+      recolorRects = true;
+      recolorLabels = true;
+    }
+    if (simpleChanges['isDarkMode']) {
+      recolorRects = true;
+      recolorLabels = true;
+    }
     if (simpleChanges['rects']) {
       this.internalRects = simpleChanges['rects'].currentValue;
-      if (!displayChange) {
-        this.drawLargeRectsAndLabels();
-      }
+      redrawRects = true;
     }
+
     if (displayChange) {
       this.onDisplaysChange(simpleChanges['displays']);
-    }
-    if (simpleChanges['miniRects']) {
-      this.internalMiniRects = simpleChanges['miniRects'].currentValue;
-      this.drawMiniRects();
+    } else if (redrawRects) {
+      this.redrawLargeRectsAndLabels();
+    } else if (recolorRects && recolorLabels) {
+      this.updateLargeRectsAndLabelsColors();
+    } else if (recolorRects) {
+      this.updateLargeRectsColors();
     }
   }
 
@@ -434,40 +508,37 @@ export class RectsComponent implements OnInit, OnDestroy {
   onDisplaysChange(change: SimpleChange) {
     const displays = change.currentValue;
     this.internalDisplays = displays;
-    this.displayNames = this.internalDisplays.map((d) => d.name);
+    const activeDisplay = this.getActiveDisplay(this.internalDisplays);
 
     if (displays.length === 0) {
       return;
     }
 
     if (change.firstChange) {
-      this.updateCurrentDisplay(
-        this.getFirstDisplayWithRectsOrFirstDisplay(this.internalDisplays),
-      );
+      this.updateCurrentDisplays([activeDisplay]);
       return;
     }
 
-    const curr = this.internalDisplays.find(
-      (display) => display.displayId === this.currentDisplay?.displayId,
+    const curr = this.internalDisplays.filter((display) =>
+      this.currentDisplays.some((curr) => curr.displayId === display.displayId),
     );
-    if (curr) {
-      this.updateCurrentDisplay(curr);
+    if (curr.length > 0) {
+      this.updateCurrentDisplays(curr);
       return;
     }
 
-    const displaysWithCurrentGroupId = this.internalDisplays.filter(
-      (display) => display.groupId === this.mapper3d.getCurrentGroupId(),
+    const currGroupIds = this.largeRectsMapper3d.getCurrentGroupIds();
+    const displaysWithCurrentGroupId = this.internalDisplays.filter((display) =>
+      currGroupIds.some((curr) => curr === display.groupId),
     );
     if (displaysWithCurrentGroupId.length === 0) {
-      this.updateCurrentDisplay(
-        this.getFirstDisplayWithRectsOrFirstDisplay(this.internalDisplays),
-      );
+      this.updateCurrentDisplays([activeDisplay]);
       return;
     }
 
-    this.updateCurrentDisplay(
-      this.getFirstDisplayWithRectsOrFirstDisplay(displaysWithCurrentGroupId),
-    );
+    this.updateCurrentDisplays([
+      this.getActiveDisplay(displaysWithCurrentGroupId),
+    ]);
     return;
   }
 
@@ -479,7 +550,7 @@ export class RectsComponent implements OnInit, OnDestroy {
       this.storeKeyZSpacingFactor,
     );
     if (storedZSpacingFactor !== undefined) {
-      this.mapper3d.setZSpacingFactor(Number(storedZSpacingFactor));
+      this.largeRectsMapper3d.setZSpacingFactor(Number(storedZSpacingFactor));
     }
 
     const storedShadingMode = assertDefined(this.store).get(
@@ -489,7 +560,7 @@ export class RectsComponent implements OnInit, OnDestroy {
       storedShadingMode !== undefined &&
       this.shadingModes.includes(storedShadingMode as ShadingMode)
     ) {
-      this.mapper3d.setShadingMode(storedShadingMode as ShadingMode);
+      this.largeRectsMapper3d.setShadingMode(storedShadingMode as ShadingMode);
     }
   }
 
@@ -500,19 +571,19 @@ export class RectsComponent implements OnInit, OnDestroy {
       TRACE_INFO[this.dependencies[0]].name,
     );
     this.store?.add(this.storeKeyZSpacingFactor, `${factor}`);
-    this.mapper3d.setZSpacingFactor(factor);
-    this.drawLargeRectsAndLabels();
+    this.largeRectsMapper3d.setZSpacingFactor(factor);
+    this.redrawLargeRectsAndLabels();
   }
 
   onRotationSliderChange(factor: number) {
-    this.mapper3d.setCameraRotationFactor(factor);
-    this.drawLargeRectsAndLabels();
+    this.largeRectsMapper3d.setCameraRotationFactor(factor);
+    this.updateLargeRectsPositionAndLabels();
   }
 
   resetCamera() {
     Analytics.Navigation.logZoom('reset', 'rects');
-    this.mapper3d.resetCamera();
-    this.drawLargeRectsAndLabels();
+    this.largeRectsMapper3d.resetCamera();
+    this.redrawLargeRectsAndLabels();
   }
 
   @HostListener('wheel', ['$event'])
@@ -534,9 +605,12 @@ export class RectsComponent implements OnInit, OnDestroy {
   }
 
   onMouseMove(event: MouseEvent) {
-    const distance = new Distance2D(event.movementX, event.movementY);
-    this.mapper3d.addPanScreenDistance(distance);
-    this.drawLargeRectsAndLabels();
+    this.panning = true;
+    const distance = new Distance(event.movementX, event.movementY);
+    this.largeRectsMapper3d.addPanScreenDistance(distance);
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    this.largeRectsCanvas?.renderView();
   }
 
   onMouseUp(event: MouseEvent) {
@@ -554,20 +628,26 @@ export class RectsComponent implements OnInit, OnDestroy {
     this.doZoomOut();
   }
 
-  onDisplayChange(event: MatSelectChange) {
-    const displayName = event.value;
-    const display = assertDefined(
-      this.internalDisplays.find((d) => d.name === displayName),
-    );
-    this.updateCurrentDisplay(display);
-    const viewerEvent = new CustomEvent(ViewerEvents.RectGroupIdChange, {
-      bubbles: true,
-      detail: {groupId: display.groupId},
-    });
-    this.elementRef.nativeElement.dispatchEvent(viewerEvent);
+  onDisplaySelectChange(event: MatSelectChange) {
+    const selectedDisplays = event.value;
+    this.updateCurrentDisplays(selectedDisplays);
+  }
+
+  getSelectTriggerValue(): string {
+    return this.currentDisplays.map((d) => d.name).join(', ');
+  }
+
+  onOnlyButtonClick(event: MouseEvent, selected: DisplayIdentifier) {
+    event.preventDefault();
+    event.stopPropagation();
+    this.updateCurrentDisplays([selected]);
   }
 
   onRectClick(event: MouseEvent) {
+    if (this.panning) {
+      this.panning = false;
+      return;
+    }
     event.preventDefault();
 
     const id = this.findClickedRectId(event);
@@ -601,23 +681,23 @@ export class RectsComponent implements OnInit, OnDestroy {
   }
 
   getZSpacingFactor(): number {
-    return this.mapper3d.getZSpacingFactor();
+    return this.largeRectsMapper3d.getZSpacingFactor();
   }
 
   getShadingMode(): ShadingMode {
-    return this.mapper3d.getShadingMode();
+    return this.largeRectsMapper3d.getShadingMode();
   }
 
   onShadingModeButtonClicked() {
-    this.mapper3d.updateShadingMode();
-    const newMode = this.mapper3d.getShadingMode();
+    this.largeRectsMapper3d.updateShadingMode();
+    const newMode = this.largeRectsMapper3d.getShadingMode();
     Analytics.Navigation.logRectSettingsChanged(
       'shading mode',
       newMode,
       TRACE_INFO[this.dependencies[0]].name,
     );
     this.store?.add(this.storeKeyShadingMode, newMode);
-    this.drawLargeRectsAndLabels();
+    this.updateLargeRectsColors();
   }
 
   onInteractionStart(components: CanColor[]) {
@@ -628,22 +708,23 @@ export class RectsComponent implements OnInit, OnDestroy {
     components.forEach((c) => (c.color = 'accent'));
   }
 
-  private getFirstDisplayWithRectsOrFirstDisplay(
-    displays: DisplayIdentifier[],
-  ): DisplayIdentifier {
+  private getActiveDisplay(displays: DisplayIdentifier[]): DisplayIdentifier {
+    const displaysWithRects = displays.filter((display) =>
+      this.internalRects.some(
+        (rect) => !rect.isDisplay && rect.groupId === display.groupId,
+      ),
+    );
     return (
-      displays.find((display) =>
-        this.internalRects.some(
-          (rect) => !rect.isDisplay && rect.groupId === display.groupId,
-        ),
-      ) ?? assertDefined(displays.at(0))
+      displaysWithRects.find((display) => display.isActive) ??
+      displaysWithRects.at(0) ?? // fallback if no active displays
+      displays[0]
     );
   }
 
-  private updateCurrentDisplay(display: DisplayIdentifier) {
-    this.currentDisplay = display;
-    this.mapper3d.setCurrentGroupId(display.groupId);
-    this.drawLargeRectsAndLabels();
+  private updateCurrentDisplays(displays: DisplayIdentifier[]) {
+    this.currentDisplays = displays;
+    this.largeRectsMapper3d.setCurrentGroupIds(displays.map((d) => d.groupId));
+    this.redrawLargeRectsAndLabels();
   }
 
   private findClickedRectId(event: MouseEvent): string | undefined {
@@ -660,54 +741,64 @@ export class RectsComponent implements OnInit, OnDestroy {
   }
 
   private doZoomIn(ratio = 1) {
-    this.mapper3d.increaseZoomFactor(ratio);
-    this.drawLargeRectsAndLabels();
+    this.largeRectsMapper3d.increaseZoomFactor(ratio);
+    this.updateLargeRectsPositionAndLabels();
   }
 
   private doZoomOut(ratio = 1) {
-    this.mapper3d.decreaseZoomFactor(ratio);
-    this.drawLargeRectsAndLabels();
+    this.largeRectsMapper3d.decreaseZoomFactor(ratio);
+    this.updateLargeRectsPositionAndLabels();
   }
 
-  private drawLargeRectsAndLabels() {
-    // TODO(b/258593034): Re-create scene only when input rects change. With the other input events
-    // (rotation, spacing, ...) we can just update the camera and/or update the mesh positions.
-    // We'd probably need to get rid of the intermediate layer (Scene3D, Rect3D, ... types) and
-    // work directly with three.js's meshes.
-    this.mapper3d.setRects(this.internalRects);
-    this.largeRectsCanvas?.draw(this.mapper3d.computeScene());
+  private redrawLargeRectsAndLabels() {
+    this.largeRectsMapper3d.setRects(this.internalRects);
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    this.largeRectsCanvas?.updateRects(scene.rects);
+    this.largeRectsCanvas?.updateLabels(scene.labels);
+    this.largeRectsCanvas?.renderView();
+  }
+
+  private updateLargeRectsPositionAndLabels() {
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateViewPosition(scene.camera, scene.boundingBox);
+    this.largeRectsCanvas?.updateLabels(scene.labels);
+    this.largeRectsCanvas?.renderView();
+  }
+
+  private updateLargeRectsColors() {
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateRects(scene.rects);
+    this.largeRectsCanvas?.renderView();
+  }
+
+  private updateLargeRectsAndLabelsColors() {
+    const scene = this.largeRectsMapper3d.computeScene();
+    this.largeRectsCanvas?.updateRects(scene.rects);
+    this.largeRectsCanvas?.updateLabels(scene.labels);
+    this.largeRectsCanvas?.renderView();
   }
 
   private drawMiniRects() {
-    // TODO(b/258593034): Re-create scene only when input rects change. With the other input events
-    // (rotation, spacing, ...) we can just update the camera and/or update the mesh positions.
-    // We'd probably need to get rid of the intermediate layer (Scene3D, Rect3D, ... types) and
-    // work directly with three.js's meshes.
-    if (this.internalMiniRects) {
-      const largeRectShadingMode = this.mapper3d.getShadingMode();
-      const largeRectGroupId = this.mapper3d.getCurrentGroupId();
-      const largeRectZSpacing = this.mapper3d.getZSpacingFactor();
-      const largeRectCameraRotation = this.mapper3d.getCameraRotationFactor();
-
-      this.mapper3d.setShadingMode(ShadingMode.GRADIENT);
-      this.mapper3d.setCurrentGroupId(this.internalMiniRects[0]?.groupId);
-      this.mapper3d.resetToOrthogonalState();
-
-      this.mapper3d.setRects(this.internalMiniRects);
-      this.mapper3d.decreaseZoomFactor(this.zoomFactor - 1);
-      this.miniRectsCanvas?.draw(this.mapper3d.computeScene());
-      this.mapper3d.increaseZoomFactor(this.zoomFactor - 1);
-
-      // Mapper internally sets these values to 100%. They need to be reset afterwards
+    if (this.internalMiniRects && this.miniRectsCanvas) {
+      this.miniRectsMapper3d.setShadingMode(ShadingMode.GRADIENT);
+      this.miniRectsMapper3d.setCurrentGroupIds([
+        this.internalMiniRects[0]?.groupId,
+      ]);
+      this.miniRectsMapper3d.resetToOrthogonalState();
+      this.miniRectsMapper3d.setRects(this.internalMiniRects);
+
+      const scene = this.miniRectsMapper3d.computeScene();
+      this.miniRectsCanvas.updateViewPosition(scene.camera, scene.boundingBox);
+      this.miniRectsCanvas.updateRects(scene.rects);
+      this.miniRectsCanvas.updateLabels(scene.labels);
+      this.miniRectsCanvas.renderView();
+
+      // Canvas internally sets these values to 100%. They need to be reset afterwards
       if (this.miniRectsCanvasElement) {
-        this.miniRectsCanvasElement.style.width = '25%';
-        this.miniRectsCanvasElement.style.height = '25%';
+        this.miniRectsCanvasElement.style.width = '30%';
+        this.miniRectsCanvasElement.style.height = '30%';
       }
-
-      this.mapper3d.setShadingMode(largeRectShadingMode);
-      this.mapper3d.setCurrentGroupId(largeRectGroupId);
-      this.mapper3d.setZSpacingFactor(largeRectZSpacing);
-      this.mapper3d.setCameraRotationFactor(largeRectCameraRotation);
     }
   }
 
diff --git a/tools/winscope/src/viewers/components/rects/rects_component_test.ts b/tools/winscope/src/viewers/components/rects/rects_component_test.ts
index 2b54b44ac..0b839452c 100644
--- a/tools/winscope/src/viewers/components/rects/rects_component_test.ts
+++ b/tools/winscope/src/viewers/components/rects/rects_component_test.ts
@@ -15,37 +15,58 @@
  */
 
 import {CommonModule} from '@angular/common';
-import {HttpClientModule} from '@angular/common/http';
-import {Component, CUSTOM_ELEMENTS_SCHEMA, ViewChild} from '@angular/core';
+import {Component, ViewChild} from '@angular/core';
 import {ComponentFixture, TestBed} from '@angular/core/testing';
 import {MatButtonModule} from '@angular/material/button';
 import {MatDividerModule} from '@angular/material/divider';
 import {MatFormFieldModule} from '@angular/material/form-field';
 import {MatIconModule} from '@angular/material/icon';
+import {MatIconTestingModule} from '@angular/material/icon/testing';
 import {MatSelectModule} from '@angular/material/select';
 import {MatSliderModule} from '@angular/material/slider';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
+import {Box3D} from 'common/geometry/box3d';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 import {PersistentStore} from 'common/persistent_store';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {waitToBeCalled} from 'test/utils';
 import {TraceType} from 'trace/trace_type';
 import {VISIBLE_CHIP} from 'viewers/common/chip';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
-import {ViewerEvents} from 'viewers/common/viewer_events';
+import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {RectDblClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
 import {RectsComponent} from 'viewers/components/rects/rects_component';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UserOptionsComponent} from 'viewers/components/user_options_component';
+import {Camera} from './camera';
 import {Canvas} from './canvas';
-import {ColorType, ShadingMode} from './types3d';
+import {ColorType} from './color_type';
+import {RectLabel} from './rect_label';
+import {ShadingMode} from './shading_mode';
+import {UiRect3D} from './ui_rect3d';
 import {UiRectBuilder} from './ui_rect_builder';
 
 describe('RectsComponent', () => {
+  const rectGroup0 = makeRectWithGroupId(0);
+  const rectGroup1 = makeRectWithGroupId(1);
+  const rectGroup2 = makeRectWithGroupId(2);
+
   let component: TestHostComponent;
   let fixture: ComponentFixture<TestHostComponent>;
   let htmlElement: HTMLElement;
+  let updateViewPositionSpy: jasmine.Spy<(camera: Camera, box: Box3D) => void>;
+  let updateRectsSpy: jasmine.Spy<(rects: UiRect3D[]) => void>;
+  let updateLabelsSpy: jasmine.Spy<(labels: RectLabel[]) => void>;
+  let renderViewSpy: jasmine.Spy<() => void>;
 
   beforeEach(async () => {
+    updateViewPositionSpy = spyOn(Canvas.prototype, 'updateViewPosition');
+    updateRectsSpy = spyOn(Canvas.prototype, 'updateRects');
+    updateLabelsSpy = spyOn(Canvas.prototype, 'updateLabels');
+    renderViewSpy = spyOn(Canvas.prototype, 'renderView');
     localStorage.clear();
 
     await TestBed.configureTestingModule({
@@ -56,7 +77,7 @@ describe('RectsComponent', () => {
         MatButtonModule,
         MatTooltipModule,
         MatIconModule,
-        HttpClientModule,
+        MatIconTestingModule,
         MatSelectModule,
         BrowserAnimationsModule,
         MatFormFieldModule,
@@ -67,7 +88,7 @@ describe('RectsComponent', () => {
         CollapsibleSectionTitleComponent,
         UserOptionsComponent,
       ],
-      schemas: [CUSTOM_ELEMENTS_SCHEMA],
+      schemas: [],
     }).compileComponents();
 
     fixture = TestBed.createComponent(TestHostComponent);
@@ -96,39 +117,38 @@ describe('RectsComponent', () => {
 
   it('draws scene when input data changes', async () => {
     fixture.detectChanges();
-    spyOn(Canvas.prototype, 'draw').and.callThrough();
-
-    const inputRect = makeRectWithGroupId(0);
+    resetSpies();
 
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(0);
-    component.rects = [inputRect];
+    checkAllSpiesCalled(0);
+    component.rects = [rectGroup0];
     fixture.detectChanges();
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(1);
-    component.rects = [inputRect];
+    checkAllSpiesCalled(1);
+    component.rects = [rectGroup0];
     fixture.detectChanges();
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(2);
+    checkAllSpiesCalled(2);
   });
 
   it('draws scene when rotation slider changes', () => {
     fixture.detectChanges();
-    spyOn(Canvas.prototype, 'draw').and.callThrough();
+    resetSpies();
     const slider = assertDefined(htmlElement.querySelector('.slider-rotation'));
 
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(0);
-
+    checkAllSpiesCalled(0);
     slider.dispatchEvent(new MouseEvent('mousedown'));
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(1);
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy).toHaveBeenCalledTimes(0);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
+    expect(renderViewSpy).toHaveBeenCalledTimes(1);
   });
 
   it('draws scene when spacing slider changes', () => {
     fixture.detectChanges();
-    spyOn(Canvas.prototype, 'draw').and.callThrough();
+    resetSpies();
     const slider = assertDefined(htmlElement.querySelector('.slider-spacing'));
 
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(0);
-
+    checkAllSpiesCalled(0);
     slider.dispatchEvent(new MouseEvent('mousedown'));
-    expect(Canvas.prototype.draw).toHaveBeenCalledTimes(1);
+    checkAllSpiesCalled(1);
   });
 
   it('unfocuses spacing slider on click', () => {
@@ -147,24 +167,24 @@ describe('RectsComponent', () => {
     checkSliderUnfocusesOnClick(rotationSlider, 1);
   });
 
-  it('renders display selector', () => {
+  it('renders display selector', async () => {
+    component.rects = [rectGroup0];
     component.displays = [
-      {displayId: 0, groupId: 0, name: 'Display 0'},
-      {displayId: 1, groupId: 1, name: 'Display 1'},
-      {displayId: 2, groupId: 2, name: 'Display 2'},
+      {displayId: 0, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
+      {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 0');
+    await checkSelectedDisplay([0]);
   });
 
-  it('handles display change', () => {
+  it('handles display change by checkbox', async () => {
+    component.rects = [rectGroup0, rectGroup1];
     component.displays = [
-      {displayId: 0, groupId: 0, name: 'Display 0'},
-      {displayId: 1, groupId: 1, name: 'Display 1'},
-      {displayId: 2, groupId: 2, name: 'Display 2'},
+      {displayId: 0, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
+      {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 0');
+    await checkSelectedDisplay([0]);
 
     const trigger = assertDefined(
       htmlElement.querySelector('.displays-section .mat-select-trigger'),
@@ -172,90 +192,138 @@ describe('RectsComponent', () => {
     (trigger as HTMLElement).click();
     fixture.detectChanges();
 
-    let groupId = 0;
-    htmlElement.addEventListener(ViewerEvents.RectGroupIdChange, (event) => {
-      groupId = (event as CustomEvent).detail.groupId;
-    });
+    const options = document.querySelectorAll<HTMLElement>(
+      '.mat-select-panel .mat-option',
+    );
 
-    const option = document
-      .querySelectorAll('.mat-select-panel .mat-option')
-      .item(1);
-    (option as HTMLElement).click();
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 1');
-    expect(groupId).toEqual(1);
+    options.item(1).click();
+    await checkSelectedDisplay([0, 1]);
+
+    options.item(0).click();
+    await checkSelectedDisplay([1]);
+
+    options.item(1).click();
+    await checkSelectedDisplay([]);
+    const placeholder = assertDefined(
+      htmlElement.querySelector('.placeholder-text'),
+    );
+    expect(placeholder.textContent?.trim()).toEqual('No displays selected.');
   });
 
-  it('tracks selected display', () => {
+  it('handles display change by "only" button', async () => {
+    component.rects = [rectGroup0, rectGroup1];
     component.displays = [
-      {displayId: 10, groupId: 0, name: 'Display 0'},
-      {displayId: 20, groupId: 1, name: 'Display 1'},
+      {displayId: 0, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 1, groupId: 1, name: 'Display 1', isActive: false},
+      {displayId: 2, groupId: 2, name: 'Display 2', isActive: false},
     ];
+    await checkSelectedDisplay([0]);
+
+    const trigger = assertDefined(
+      htmlElement.querySelector('.displays-section .mat-select-trigger'),
+    );
+    (trigger as HTMLElement).click();
     fixture.detectChanges();
-    checkSelectedDisplay('Display 0');
 
+    const onlyButtons = document.querySelectorAll<HTMLElement>(
+      '.mat-select-panel .mat-option .option-only-button',
+    );
+
+    const display0Button = onlyButtons.item(0);
+    const display1Button = onlyButtons.item(1);
+
+    // no change
+    display0Button.click();
+    await checkSelectedDisplay([0]);
+
+    display1Button.click();
+    await checkSelectedDisplay([1]);
+
+    assertDefined(display0Button.parentElement).click();
+    await checkSelectedDisplay([0, 1]);
+    display0Button.click();
+    await checkSelectedDisplay([0]);
+  });
+
+  it('tracks selected display', async () => {
     component.displays = [
-      {displayId: 20, groupId: 2, name: 'Display 1'},
-      {displayId: 10, groupId: 1, name: 'Display 0'},
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 20, groupId: 1, name: 'Display 1', isActive: false},
     ];
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 0');
+    component.rects = [rectGroup0, rectGroup1];
+    await checkSelectedDisplay([0]);
+
+    component.displays = [
+      {displayId: 20, groupId: 2, name: 'Display 1', isActive: false},
+      {displayId: 10, groupId: 1, name: 'Display 0', isActive: false},
+    ];
+    await checkSelectedDisplay([0], [1]);
   });
 
   it('updates scene on separation slider change', () => {
-    const inputRect = makeRectWithGroupId(0);
-    component.rects = [inputRect, inputRect];
-    const spy = spyOn(Canvas.prototype, 'draw').and.callThrough();
+    component.rects = [rectGroup0, rectGroup0];
     fixture.detectChanges();
     updateSeparationSlider();
 
-    expect(spy).toHaveBeenCalledTimes(2);
-    const sceneBefore = assertDefined(spy.calls.first().args.at(0));
-    const sceneAfter = assertDefined(spy.calls.mostRecent().args.at(0));
+    checkAllSpiesCalled(2);
+    const rectsBefore = assertDefined(updateRectsSpy.calls.first().args[0]);
+    const rectsAfter = assertDefined(updateRectsSpy.calls.mostRecent().args[0]);
 
-    expect(sceneBefore.rects[1].topLeft.z).toEqual(5);
-    expect(sceneAfter.rects[1].topLeft.z).toEqual(0.3);
+    expect(rectsBefore[0].topLeft.z).toEqual(200);
+    expect(rectsAfter[0].topLeft.z).toEqual(12);
   });
 
   it('updates scene on rotation slider change', () => {
-    const inputRect = makeRectWithGroupId(0);
-    component.rects = [inputRect];
-    const spy = spyOn(Canvas.prototype, 'draw').and.callThrough();
+    component.rects = [rectGroup0];
     fixture.detectChanges();
     updateRotationSlider();
 
-    expect(spy).toHaveBeenCalledTimes(2);
-    const sceneBefore = assertDefined(spy.calls.first().args.at(0));
-    const sceneAfter = assertDefined(spy.calls.mostRecent().args.at(0));
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(2);
+    expect(updateRectsSpy).toHaveBeenCalledTimes(1);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(2);
+    expect(renderViewSpy).toHaveBeenCalledTimes(2);
 
-    expect(sceneBefore.camera.rotationFactor).toEqual(1);
-    expect(sceneAfter.camera.rotationFactor).toEqual(0.5);
+    const cameraBefore = assertDefined(
+      updateViewPositionSpy.calls.first().args[0],
+    );
+    const cameraAfter = assertDefined(
+      updateViewPositionSpy.calls.mostRecent().args[0],
+    );
+
+    expect(cameraAfter.rotationAngleX).toEqual(
+      cameraBefore.rotationAngleX * 0.5,
+    );
+    expect(cameraAfter.rotationAngleY).toEqual(
+      cameraBefore.rotationAngleY * 0.5,
+    );
   });
 
   it('updates scene on shading mode change', () => {
-    const inputRect = makeRectWithGroupId(0);
-    component.rects = [inputRect];
-    const spy = spyOn(Canvas.prototype, 'draw').and.callThrough();
+    component.rects = [rectGroup0];
     fixture.detectChanges();
 
     updateShadingMode(ShadingMode.GRADIENT, ShadingMode.WIRE_FRAME);
     updateShadingMode(ShadingMode.WIRE_FRAME, ShadingMode.OPACITY);
 
-    expect(spy).toHaveBeenCalledTimes(3);
-    const sceneGradient = assertDefined(spy.calls.first().args.at(0));
-    const sceneWireFrame = assertDefined(spy.calls.argsFor(1).at(0));
-    const sceneOpacity = assertDefined(spy.calls.mostRecent().args.at(0));
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy).toHaveBeenCalledTimes(3);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
+    expect(renderViewSpy).toHaveBeenCalledTimes(3);
 
-    expect(sceneGradient.rects[0].colorType).toEqual(ColorType.VISIBLE);
-    expect(sceneGradient.rects[0].darkFactor).toEqual(1);
+    const rectsGradient = assertDefined(updateRectsSpy.calls.first().args[0]);
+    const rectsWireFrame = assertDefined(updateRectsSpy.calls.argsFor(1).at(0));
+    const rectsOpacity = assertDefined(
+      updateRectsSpy.calls.mostRecent().args[0],
+    );
 
-    expect(sceneWireFrame.rects[0].colorType).toEqual(ColorType.EMPTY);
-    expect(sceneWireFrame.rects[0].darkFactor).toEqual(1);
+    expect(rectsGradient[0].colorType).toEqual(ColorType.VISIBLE);
+    expect(rectsGradient[0].darkFactor).toEqual(1);
 
-    expect(sceneOpacity.rects[0].colorType).toEqual(
-      ColorType.VISIBLE_WITH_OPACITY,
-    );
-    expect(sceneOpacity.rects[0].darkFactor).toEqual(0.5);
+    expect(rectsWireFrame[0].colorType).toEqual(ColorType.EMPTY);
+    expect(rectsWireFrame[0].darkFactor).toEqual(1);
+
+    expect(rectsOpacity[0].colorType).toEqual(ColorType.VISIBLE_WITH_OPACITY);
+    expect(rectsOpacity[0].darkFactor).toEqual(0.5);
   });
 
   it('uses stored rects view settings', () => {
@@ -273,71 +341,113 @@ describe('RectsComponent', () => {
     expect(newRectsComponent.getShadingMode()).toEqual(ShadingMode.WIRE_FRAME);
   });
 
-  it('defaults initial selection to first display with non-display rects and groupId 0', () => {
-    const inputRect = makeRectWithGroupId(0);
-    component.rects = [inputRect];
+  it('defaults initial selection to first active display with rects', async () => {
+    component.rects = [rectGroup0, rectGroup1];
     component.displays = [
-      {displayId: 10, groupId: 1, name: 'Display 0'},
-      {displayId: 20, groupId: 0, name: 'Display 1'},
+      {displayId: 10, groupId: 1, name: 'Display 0', isActive: false},
+      {displayId: 20, groupId: 0, name: 'Display 1', isActive: true},
     ];
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 1');
+    await checkSelectedDisplay([1], [0]);
   });
 
-  it('defaults initial selection to first display with non-display rects and groupId non-zero', () => {
-    const inputRect = makeRectWithGroupId(1);
-    component.rects = [inputRect];
+  it('defaults initial selection to first display with non-display rects and groupId 0', async () => {
     component.displays = [
-      {displayId: 10, groupId: 0, name: 'Display 0'},
-      {displayId: 20, groupId: 1, name: 'Display 1'},
+      {displayId: 10, groupId: 1, name: 'Display 0', isActive: true},
+      {displayId: 20, groupId: 0, name: 'Display 1', isActive: false},
     ];
-    fixture.detectChanges();
-    checkSelectedDisplay('Display 1');
+    component.rects = [rectGroup0];
+    await checkSelectedDisplay([1], [0]);
+  });
+
+  it('defaults initial selection to first display with non-display rects and groupId non-zero', async () => {
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+      {displayId: 20, groupId: 1, name: 'Display 1', isActive: false},
+    ];
+    component.rects = [rectGroup1];
+    await checkSelectedDisplay([1]);
+  });
+
+  it('handles change from zero to one display', async () => {
+    component.displays = [];
+    component.rects = [];
+    await checkSelectedDisplay([]);
+    const placeholder = assertDefined(
+      htmlElement.querySelector('.placeholder-text'),
+    );
+    expect(placeholder.textContent?.trim()).toEqual('No rects found.');
+
+    component.rects = [rectGroup0];
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+    ];
+    await checkSelectedDisplay([0]);
   });
 
   it('draws mini rects with non-present group id', () => {
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+    ];
     fixture.detectChanges();
-    const inputRect = makeRectWithGroupId(0);
-    const miniRect = makeRectWithGroupId(2);
-    component.rects = [inputRect];
-    component.displays = [{displayId: 10, groupId: 0, name: 'Display 0'}];
-    component.miniRects = [miniRect];
-    const spy = spyOn(Canvas.prototype, 'draw').and.callThrough();
+    component.rects = [rectGroup0];
+    component.miniRects = [rectGroup2];
+    resetSpies();
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalledTimes(2);
+    checkAllSpiesCalled(2);
     expect(
-      spy.calls
+      updateRectsSpy.calls
         .all()
-        .forEach((call) => expect(call.args[0].rects.length).toEqual(1)),
+        .forEach((call) => expect(call.args[0].length).toEqual(1)),
     );
   });
 
   it('draws mini rects with default spacing, rotation and shading mode', () => {
+    component.displays = [
+      {displayId: 10, groupId: 0, name: 'Display 0', isActive: false},
+    ];
     fixture.detectChanges();
 
     updateSeparationSlider();
     updateRotationSlider();
     updateShadingMode(ShadingMode.GRADIENT, ShadingMode.WIRE_FRAME);
 
-    const inputRect = makeRectWithGroupId(0);
-    component.rects = [inputRect, inputRect];
-    component.displays = [{displayId: 10, groupId: 0, name: 'Display 0'}];
-    component.miniRects = [inputRect, inputRect];
-    const spy = spyOn(Canvas.prototype, 'draw').and.callThrough();
+    component.rects = [rectGroup0, rectGroup0];
+    component.miniRects = [rectGroup0, rectGroup0];
+    resetSpies();
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalledTimes(2);
+    checkAllSpiesCalled(2);
+
+    const largeRectsCamera = assertDefined(
+      updateViewPositionSpy.calls.first().args[0],
+    );
+    const miniRectsCamera = assertDefined(
+      updateViewPositionSpy.calls.mostRecent().args[0],
+    );
+
+    expect(largeRectsCamera.rotationAngleX).toEqual(
+      miniRectsCamera.rotationAngleX * 0.5,
+    );
+    expect(largeRectsCamera.rotationAngleY).toEqual(
+      miniRectsCamera.rotationAngleY * 0.5,
+    );
+    const largeRects = assertDefined(updateRectsSpy.calls.first().args[0]);
+    const miniRects = assertDefined(updateRectsSpy.calls.mostRecent().args[0]);
 
-    const largeRectsScene = assertDefined(spy.calls.first().args.at(0));
-    const miniRectsScene = assertDefined(spy.calls.mostRecent().args.at(0));
+    expect(largeRects[0].colorType).toEqual(ColorType.EMPTY);
+    expect(miniRects[0].colorType).toEqual(ColorType.VISIBLE);
 
-    expect(largeRectsScene.camera.rotationFactor).toEqual(0.5);
-    expect(miniRectsScene.camera.rotationFactor).toEqual(1);
+    expect(largeRects[0].topLeft.z).toEqual(12);
+    expect(miniRects[0].topLeft.z).toEqual(200);
+  });
 
-    expect(largeRectsScene.rects[0].colorType).toEqual(ColorType.EMPTY);
-    expect(miniRectsScene.rects[0].colorType).toEqual(ColorType.VISIBLE);
+  it('redraws mini rects on change', () => {
+    component.miniRects = [rectGroup0, rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
 
-    expect(largeRectsScene.rects[1].topLeft.z).toEqual(0.3);
-    expect(miniRectsScene.rects[1].topLeft.z).toEqual(5);
+    component.miniRects = [rectGroup0, rectGroup0];
+    fixture.detectChanges();
+    checkAllSpiesCalled(1);
   });
 
   it('handles collapse button click', () => {
@@ -354,11 +464,275 @@ describe('RectsComponent', () => {
     expect(spy).toHaveBeenCalled();
   });
 
-  function checkSelectedDisplay(selectedDisplay: string) {
+  it('updates scene on pinned items change', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
+
+    component.pinnedItems = [
+      UiHierarchyTreeNode.from(
+        new HierarchyTreeBuilder().setId('test-id').setName('0').build(),
+      ),
+    ];
+    fixture.detectChanges();
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(0);
+    expect(updateRectsSpy).toHaveBeenCalledTimes(1);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(0);
+    expect(renderViewSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy.calls.mostRecent().args[0][0].isPinned).toBeTrue();
+  });
+
+  it('emits rect id on rect click', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+
+    const testString = 'test_id';
+    spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(testString);
+    let id: string | undefined;
+    htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) => {
+      id = (event as CustomEvent).detail.id;
+    });
+
+    const canvas = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
+    );
+    canvas.click();
+    fixture.detectChanges();
+    expect(id).toEqual(testString);
+  });
+
+  it('pans view without emitting rect id', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    const cameraBefore = updateViewPositionSpy.calls.mostRecent().args[0];
+    expect(cameraBefore.panScreenDistance.dx).toEqual(0);
+    expect(cameraBefore.panScreenDistance.dy).toEqual(0);
+    resetSpies();
+
+    const testString = 'test_id';
+    spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(testString);
+    let id: string | undefined;
+    htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) => {
+      id = (event as CustomEvent).detail.id;
+    });
+
+    panView();
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy).not.toHaveBeenCalled();
+    expect(updateLabelsSpy).not.toHaveBeenCalled();
+    expect(renderViewSpy).toHaveBeenCalled();
+
+    const cameraAfter = updateViewPositionSpy.calls.mostRecent().args[0];
+    expect(cameraAfter.panScreenDistance.dx).toEqual(5);
+    expect(cameraAfter.panScreenDistance.dy).toEqual(10);
+
+    const canvas = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
+    );
+    canvas.click();
+    fixture.detectChanges();
+    expect(id).toBeUndefined();
+
+    canvas.click();
+    fixture.detectChanges();
+    expect(id).toEqual(testString);
+  });
+
+  it('handles window resize', async () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
+
+    spyOnProperty(window, 'innerWidth').and.returnValue(window.innerWidth / 2);
+    window.dispatchEvent(new Event('resize'));
+    fixture.detectChanges();
+    await fixture.whenStable();
+    await waitToBeCalled(renderViewSpy, 1);
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy).not.toHaveBeenCalled();
+    expect(updateLabelsSpy).not.toHaveBeenCalled();
+  });
+
+  it('handles change in dark mode', async () => {
+    component.rects = [rectGroup0];
+    component.miniRects = [rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
+
+    component.isDarkMode = true;
+    fixture.detectChanges();
+    expect(updateRectsSpy).toHaveBeenCalledTimes(2);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(2);
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1); // only for mini rects
+    expect(renderViewSpy).toHaveBeenCalledTimes(2);
+  });
+
+  it('handles zoom button clicks', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    const zoomFactor =
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
+    resetSpies();
+
+    clickZoomInButton();
+    checkZoomedIn(zoomFactor);
+    const zoomedInFactor =
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
+    resetSpies();
+
+    const zoomOutButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.zoom-out-button'),
+    );
+    zoomOutButton.click();
+    fixture.detectChanges();
+    checkZoomedOut(zoomedInFactor);
+  });
+
+  it('handles zoom change via scroll event', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    const zoomFactor =
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
+    resetSpies();
+
+    const rectsElement = assertDefined(htmlElement.querySelector('rects-view'));
+
+    const zoomInEvent = new WheelEvent('wheel');
+    Object.defineProperty(zoomInEvent, 'target', {
+      value: htmlElement.querySelector('.large-rects-canvas'),
+    });
+    Object.defineProperty(zoomInEvent, 'deltaY', {value: 0});
+    rectsElement.dispatchEvent(zoomInEvent);
+    fixture.detectChanges();
+
+    checkZoomedIn(zoomFactor);
+    const zoomedInFactor =
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor;
+    resetSpies();
+
+    const zoomOutEvent = new WheelEvent('wheel');
+    Object.defineProperty(zoomOutEvent, 'target', {
+      value: htmlElement.querySelector('.large-rects-canvas'),
+    });
+    Object.defineProperty(zoomOutEvent, 'deltaY', {value: 1});
+    rectsElement.dispatchEvent(zoomOutEvent);
+    fixture.detectChanges();
+    checkZoomedOut(zoomedInFactor);
+  });
+
+  it('handles reset button click', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    const [camera, boundingBox] = updateViewPositionSpy.calls.mostRecent().args;
+
+    updateRotationSlider();
+    updateSeparationSlider();
+    clickZoomInButton();
+    panView();
+    resetSpies();
+
+    const resetButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.reset-button'),
+    );
+    resetButton.click();
+    fixture.detectChanges();
+    checkAllSpiesCalled(1);
+    const [newCamera, newBoundingBox] =
+      updateViewPositionSpy.calls.mostRecent().args;
+    expect(newCamera).toEqual(camera);
+    expect(newBoundingBox).toEqual(boundingBox);
+  });
+
+  it('handles change in highlighted item', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    expect(updateRectsSpy.calls.mostRecent().args[0][0].colorType).toEqual(
+      ColorType.VISIBLE,
+    );
+    resetSpies();
+
+    component.highlightedItem = rectGroup0.id;
+    fixture.detectChanges();
+
+    expect(updateViewPositionSpy).not.toHaveBeenCalled();
+    expect(updateRectsSpy).toHaveBeenCalledTimes(1);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
+    expect(renderViewSpy).toHaveBeenCalledTimes(1);
+    expect(updateRectsSpy.calls.mostRecent().args[0][0].colorType).toEqual(
+      ColorType.HIGHLIGHTED,
+    );
+  });
+
+  it('handles rect double click', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
+
+    const testString = 'test_id';
+    spyOn(Canvas.prototype, 'getClickedRectId').and.returnValue(testString);
+    let detail: RectDblClickDetail | undefined;
+    htmlElement.addEventListener(ViewerEvents.RectsDblClick, (event) => {
+      detail = (event as CustomEvent).detail;
+    });
+
+    const canvas = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
+    );
+    canvas.dispatchEvent(new MouseEvent('dblclick'));
+    fixture.detectChanges();
+    expect(detail).toEqual(new RectDblClickDetail(testString));
+  });
+
+  it('handles mini rect double click', () => {
+    component.rects = [rectGroup0];
+    fixture.detectChanges();
+    resetSpies();
+
+    let miniRectDoubleClick = false;
+    htmlElement.addEventListener(ViewerEvents.MiniRectsDblClick, (event) => {
+      miniRectDoubleClick = true;
+    });
+
+    const canvas = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.mini-rects-canvas'),
+    );
+    canvas.dispatchEvent(new MouseEvent('dblclick'));
+    fixture.detectChanges();
+    expect(miniRectDoubleClick).toBeTrue();
+  });
+
+  function resetSpies() {
+    [
+      updateViewPositionSpy,
+      updateRectsSpy,
+      updateLabelsSpy,
+      renderViewSpy,
+    ].forEach((spy) => spy.calls.reset());
+  }
+
+  async function checkSelectedDisplay(
+    displayNumbers: number[],
+    testIds?: number[],
+  ) {
+    fixture.detectChanges();
+    await fixture.whenStable();
+    fixture.detectChanges();
     const displaySelect = assertDefined(
       htmlElement.querySelector('.displays-select'),
     );
-    expect(displaySelect.innerHTML).toContain(selectedDisplay);
+    expect(displaySelect.textContent?.trim()).toEqual(
+      displayNumbers
+        .map((displayNumber) => `Display ${displayNumber}`)
+        .join(', '),
+    );
+    const drawnRects = updateRectsSpy.calls.mostRecent().args[0];
+    expect(drawnRects.length).toEqual(displayNumbers.length);
+    drawnRects.forEach((rect, index) => {
+      expect(rect.id).toEqual(
+        `test-id ${testIds ? testIds[index] : displayNumbers[index]}`,
+      );
+      if (index > 0) expect(rect.transform.ty).toBeGreaterThan(0);
+    });
   }
 
   function findAndClickElement(selector: string) {
@@ -372,6 +746,7 @@ describe('RectsComponent', () => {
   function checkSliderUnfocusesOnClick(slider: Element, expectedValue: number) {
     const rectsComponent = assertDefined(component.rectsComponent);
     slider.dispatchEvent(new MouseEvent('mousedown'));
+    slider.dispatchEvent(new MouseEvent('mouseup'));
     expect(rectsComponent.getZSpacingFactor()).toEqual(expectedValue);
     htmlElement.dispatchEvent(
       new KeyboardEvent('keydown', {key: 'ArrowRight'}),
@@ -409,26 +784,78 @@ describe('RectsComponent', () => {
       .setWidth(1)
       .setHeight(1)
       .setLabel('rectangle1')
-      .setTransform({
-        dsdx: 1,
-        dsdy: 0,
-        dtdx: 0,
-        dtdy: 1,
-        tx: 0,
-        ty: 0,
-      })
+      .setTransform(
+        TransformMatrix.from({
+          dsdx: 1,
+          dsdy: 0,
+          dtdx: 0,
+          dtdy: 1,
+          tx: 0,
+          ty: 0,
+        }),
+      )
       .setIsVisible(isVisible)
       .setIsDisplay(false)
-      .setId('test-id-1234')
+      .setIsActiveDisplay(false)
+      .setId('test-id ' + groupId)
       .setGroupId(groupId)
-      .setIsVirtual(false)
-      .setIsClickable(false)
+      .setIsClickable(true)
       .setCornerRadius(0)
       .setDepth(0)
       .setOpacity(0.5)
       .build();
   }
 
+  function panView() {
+    const canvas = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.large-rects-canvas'),
+    );
+    canvas.dispatchEvent(new MouseEvent('mousedown'));
+    const mouseMoveEvent = new MouseEvent('mousemove');
+    Object.defineProperty(mouseMoveEvent, 'movementX', {value: 5});
+    Object.defineProperty(mouseMoveEvent, 'movementY', {value: 10});
+    document.dispatchEvent(mouseMoveEvent);
+    document.dispatchEvent(new MouseEvent('mouseup'));
+    fixture.detectChanges();
+  }
+
+  function clickZoomInButton() {
+    const zoomInButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.zoom-in-button'),
+    );
+    zoomInButton.click();
+    fixture.detectChanges();
+  }
+
+  function checkZoomedIn(oldZoomFactor: number) {
+    expect(updateRectsSpy).toHaveBeenCalledTimes(0);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(renderViewSpy).toHaveBeenCalledTimes(1);
+    expect(
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor,
+    ).toBeGreaterThan(oldZoomFactor);
+  }
+
+  function checkZoomedOut(oldZoomFactor: number) {
+    expect(updateRectsSpy).toHaveBeenCalledTimes(0);
+    expect(updateLabelsSpy).toHaveBeenCalledTimes(1);
+    expect(updateViewPositionSpy).toHaveBeenCalledTimes(1);
+    expect(renderViewSpy).toHaveBeenCalledTimes(1);
+    expect(
+      updateViewPositionSpy.calls.mostRecent().args[0].zoomFactor,
+    ).toBeLessThan(oldZoomFactor);
+  }
+
+  function checkAllSpiesCalled(times: number) {
+    [
+      updateViewPositionSpy,
+      updateRectsSpy,
+      updateLabelsSpy,
+      renderViewSpy,
+    ].forEach((spy) => expect(spy).toHaveBeenCalledTimes(times));
+  }
+
   @Component({
     selector: 'host-component',
     template: `
@@ -436,12 +863,15 @@ describe('RectsComponent', () => {
         title="TestRectsView"
         [store]="store"
         [rects]="rects"
-        [isStackBased]="isStackBased"
-        [displays]="displays"
         [miniRects]="miniRects"
+        [displays]="displays"
+        [isStackBased]="isStackBased"
         [shadingModes]="shadingModes"
         [userOptions]="userOptions"
-        [dependencies]="dependencies"></rects-view>
+        [dependencies]="dependencies"
+        [pinnedItems]="pinnedItems"
+        [isDarkMode]="isDarkMode"
+        [highlightedItem]="highlightedItem"></rects-view>
     `,
   })
   class TestHostComponent {
@@ -463,6 +893,9 @@ describe('RectsComponent', () => {
       },
     };
     dependencies = [TraceType.SURFACE_FLINGER];
+    pinnedItems: UiHierarchyTreeNode[] = [];
+    isDarkMode = false;
+    highlightedItem = '';
 
     @ViewChild(RectsComponent)
     rectsComponent: RectsComponent | undefined;
diff --git a/tools/winscope/src/viewers/components/rects/scene.ts b/tools/winscope/src/viewers/components/rects/scene.ts
new file mode 100644
index 000000000..f7a3a5f0f
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/scene.ts
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Box3D} from 'common/geometry/box3d';
+import {Camera} from './camera';
+import {RectLabel} from './rect_label';
+import {UiRect3D} from './ui_rect3d';
+
+export interface Scene {
+  boundingBox: Box3D;
+  camera: Camera;
+  rects: UiRect3D[];
+  labels: RectLabel[];
+}
diff --git a/tools/winscope/src/viewers/components/rects/shading_mode.ts b/tools/winscope/src/viewers/components/rects/shading_mode.ts
new file mode 100644
index 000000000..99b837909
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/shading_mode.ts
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export enum ShadingMode {
+  WIRE_FRAME = 'Wire frame',
+  GRADIENT = 'Shaded by gradient',
+  OPACITY = 'Shaded by opacity',
+}
diff --git a/tools/winscope/src/viewers/components/rects/types3d.ts b/tools/winscope/src/viewers/components/rects/types3d.ts
deleted file mode 100644
index 1b6d157b4..000000000
--- a/tools/winscope/src/viewers/components/rects/types3d.ts
+++ /dev/null
@@ -1,90 +0,0 @@
-/*
- * Copyright (C) 2022 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {TransformMatrix} from 'common/geometry_types';
-
-export enum ColorType {
-  VISIBLE,
-  VISIBLE_WITH_OPACITY,
-  NOT_VISIBLE,
-  HIGHLIGHTED,
-  HAS_CONTENT,
-  EMPTY,
-  HAS_CONTENT_AND_OPACITY,
-}
-
-export enum ShadingMode {
-  WIRE_FRAME = 'Wire frame',
-  GRADIENT = 'Shaded by gradient',
-  OPACITY = 'Shaded by opacity',
-}
-
-export class Distance2D {
-  constructor(public dx: number, public dy: number) {}
-}
-
-export interface Box3D {
-  width: number;
-  height: number;
-  depth: number;
-  center: Point3D;
-  diagonal: number;
-}
-
-export interface Rect3D {
-  id: string;
-  topLeft: Point3D;
-  bottomRight: Point3D;
-  cornerRadius: number;
-  darkFactor: number;
-  colorType: ColorType;
-  isClickable: boolean;
-  transform: TransformMatrix;
-  isOversized: boolean;
-}
-
-export interface Point3D {
-  x: number;
-  y: number;
-  z: number;
-}
-
-export interface Label3D {
-  circle: Circle3D;
-  linePoints: Point3D[];
-  textCenter: Point3D;
-  text: string;
-  isHighlighted: boolean;
-  rectId: string;
-}
-
-export interface Circle3D {
-  radius: number;
-  center: Point3D;
-}
-
-export interface Scene3D {
-  boundingBox: Box3D;
-  camera: Camera;
-  rects: Rect3D[];
-  labels: Label3D[];
-}
-
-export interface Camera {
-  rotationFactor: number;
-  zoomFactor: number;
-  panScreenDistance: Distance2D;
-}
diff --git a/tools/winscope/src/viewers/components/rects/types2d.ts b/tools/winscope/src/viewers/components/rects/ui_rect.ts
similarity index 78%
rename from tools/winscope/src/viewers/components/rects/types2d.ts
rename to tools/winscope/src/viewers/components/rects/ui_rect.ts
index c5404598b..14cb51bd5 100644
--- a/tools/winscope/src/viewers/components/rects/types2d.ts
+++ b/tools/winscope/src/viewers/components/rects/ui_rect.ts
@@ -1,5 +1,5 @@
 /*
- * Copyright 2020, The Android Open Source Project
+ * Copyright (C) 2024, The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-import {TransformMatrix} from 'common/geometry_types';
-import {Rect} from 'common/rect';
+import {Rect} from 'common/geometry/rect';
+import {Region} from 'common/geometry/region';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
 
 export class UiRect extends Rect {
   constructor(
@@ -26,21 +27,17 @@ export class UiRect extends Rect {
     readonly label: string,
     readonly isVisible: boolean,
     readonly isDisplay: boolean,
+    readonly isActiveDisplay: boolean,
     readonly id: string,
     readonly groupId: number,
-    readonly isVirtual: boolean,
     readonly isClickable: boolean,
     readonly cornerRadius: number,
     readonly transform: TransformMatrix | undefined,
     readonly depth: number,
     readonly hasContent: boolean | undefined,
     readonly opacity: number | undefined,
+    readonly fillRegion: Region | undefined,
   ) {
     super(x, y, w, h);
   }
 }
-
-export interface Size {
-  width: number;
-  height: number;
-}
diff --git a/tools/winscope/src/viewers/components/rects/ui_rect3d.ts b/tools/winscope/src/viewers/components/rects/ui_rect3d.ts
new file mode 100644
index 000000000..d55f8d1a9
--- /dev/null
+++ b/tools/winscope/src/viewers/components/rects/ui_rect3d.ts
@@ -0,0 +1,34 @@
+/*
+ * Copyright 2024, The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Point3D} from 'common/geometry/point3d';
+import {Rect3D} from 'common/geometry/rect3d';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
+import {ColorType} from './color_type';
+
+export interface UiRect3D extends Rect3D {
+  id: string;
+  topLeft: Point3D;
+  bottomRight: Point3D;
+  cornerRadius: number;
+  darkFactor: number;
+  colorType: ColorType;
+  isClickable: boolean;
+  transform: TransformMatrix;
+  isOversized: boolean;
+  fillRegion: Rect3D[] | undefined;
+  isPinned: boolean;
+}
diff --git a/tools/winscope/src/viewers/components/rects/ui_rect_builder.ts b/tools/winscope/src/viewers/components/rects/ui_rect_builder.ts
index 16701f5bf..9d15ef113 100644
--- a/tools/winscope/src/viewers/components/rects/ui_rect_builder.ts
+++ b/tools/winscope/src/viewers/components/rects/ui_rect_builder.ts
@@ -14,8 +14,9 @@
  * limitations under the License.
  */
 
-import {TransformMatrix} from 'common/geometry_types';
-import {UiRect} from './types2d';
+import {Region} from 'common/geometry/region';
+import {TransformMatrix} from 'common/geometry/transform_matrix';
+import {UiRect} from './ui_rect';
 
 export class UiRectBuilder {
   x: number | undefined;
@@ -26,14 +27,15 @@ export class UiRectBuilder {
   transform: TransformMatrix | undefined;
   isVisible: boolean | undefined;
   isDisplay: boolean | undefined;
+  isActiveDisplay: boolean | undefined;
   id: string | undefined;
   groupId: number | undefined;
-  isVirtual: boolean | undefined;
   isClickable: boolean | undefined;
   cornerRadius: number | undefined;
   depth: number | undefined;
   hasContent: boolean | undefined;
   opacity: number | undefined;
+  fillRegion: Region | undefined;
 
   setX(value: number) {
     this.x = value;
@@ -75,6 +77,11 @@ export class UiRectBuilder {
     return this;
   }
 
+  setIsActiveDisplay(value: boolean) {
+    this.isActiveDisplay = value;
+    return this;
+  }
+
   setId(value: string) {
     this.id = value;
     return this;
@@ -85,11 +92,6 @@ export class UiRectBuilder {
     return this;
   }
 
-  setIsVirtual(value: boolean) {
-    this.isVirtual = value;
-    return this;
-  }
-
   setIsClickable(value: boolean) {
     this.isClickable = value;
     return this;
@@ -115,57 +117,62 @@ export class UiRectBuilder {
     return this;
   }
 
+  setFillRegion(region: Region | undefined) {
+    this.fillRegion = region;
+    return this;
+  }
+
   build(): UiRect {
     if (this.x === undefined) {
-      throw Error('x not set');
+      throw new Error('x not set');
     }
 
     if (this.y === undefined) {
-      throw Error('y not set');
+      throw new Error('y not set');
     }
 
     if (this.w === undefined) {
-      throw Error('width not set');
+      throw new Error('width not set');
     }
 
     if (this.h === undefined) {
-      throw Error('height not set');
+      throw new Error('height not set');
     }
 
     if (this.label === undefined) {
-      throw Error('label not set');
+      throw new Error('label not set');
     }
 
     if (this.isVisible === undefined) {
-      throw Error('isVisible not set');
+      throw new Error('isVisible not set');
     }
 
     if (this.isDisplay === undefined) {
-      throw Error('isDisplay not set');
+      throw new Error('isDisplay not set');
     }
 
-    if (this.id === undefined) {
-      throw Error('id not set');
+    if (this.isActiveDisplay === undefined) {
+      throw new Error('isActiveDisplay not set');
     }
 
-    if (this.groupId === undefined) {
-      throw Error('groupId not set');
+    if (this.id === undefined) {
+      throw new Error('id not set');
     }
 
-    if (this.isVirtual === undefined) {
-      throw Error('isVirtual not set');
+    if (this.groupId === undefined) {
+      throw new Error('groupId not set');
     }
 
     if (this.isClickable === undefined) {
-      throw Error('isClickable not set');
+      throw new Error('isClickable not set');
     }
 
     if (this.cornerRadius === undefined) {
-      throw Error('cornerRadius not set');
+      throw new Error('cornerRadius not set');
     }
 
     if (this.depth === undefined) {
-      throw Error('depth not set');
+      throw new Error('depth not set');
     }
 
     return new UiRect(
@@ -176,15 +183,16 @@ export class UiRectBuilder {
       this.label,
       this.isVisible,
       this.isDisplay,
+      this.isActiveDisplay,
       this.id,
       this.groupId,
-      this.isVirtual,
       this.isClickable,
       this.cornerRadius,
       this.transform,
       this.depth,
       this.hasContent,
       this.opacity,
+      this.fillRegion,
     );
   }
 }
diff --git a/tools/winscope/src/viewers/components/search_box_component.ts b/tools/winscope/src/viewers/components/search_box_component.ts
new file mode 100644
index 000000000..ea7e1382a
--- /dev/null
+++ b/tools/winscope/src/viewers/components/search_box_component.ts
@@ -0,0 +1,101 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Component, EventEmitter, Input, Output} from '@angular/core';
+import {assertDefined} from 'common/assert_utils';
+import {FilterFlag} from 'common/filter_flag';
+import {TextFilter} from 'viewers/common/text_filter';
+
+@Component({
+  selector: 'search-box',
+  template: `
+    <mat-form-field class="search-box" [class.wide-field]="wideField" [appearance]="appearance" [style.font-size]="fontSize + 'px'" (keydown.enter)="$event.target.blur()">
+      <mat-label>{{ label }}</mat-label>
+      <input
+        matInput
+        [(ngModel)]="textFilter.filterString"
+        (ngModelChange)="onFilterChange()"
+        [name]="filterName" />
+      <div class="field-suffix" matSuffix>
+        <button
+          mat-icon-button
+          matTooltip="Match case"
+          [color]="hasFlag(FilterFlag.MATCH_CASE) ? 'primary' : undefined"
+          (click)="onFilterFlagClick($event, FilterFlag.MATCH_CASE)">
+          <mat-icon class="material-symbols-outlined">match_case</mat-icon>
+        </button>
+        <button
+          mat-icon-button
+          matTooltip="Match whole word"
+          [color]="hasFlag(FilterFlag.MATCH_WORD) ? 'primary' : undefined"
+          (click)="onFilterFlagClick($event, FilterFlag.MATCH_WORD)">
+          <mat-icon class="material-symbols-outlined">match_word</mat-icon>
+        </button>
+        <button
+          mat-icon-button
+          matTooltip="Use regex"
+          [color]="hasFlag(FilterFlag.USE_REGEX) ? 'primary' : undefined"
+          (click)="onFilterFlagClick($event, FilterFlag.USE_REGEX)">
+          <mat-icon class="material-symbols-outlined">regular_expression</mat-icon>
+        </button>
+      </div>
+    </mat-form-field>
+  `,
+  styles: [
+    `
+    .search-box {
+      height: 48px;
+    }
+    .wide-field {
+      width: 100%;
+    }
+    .search-box .mat-icon {
+      font-size: 18px;
+    }
+  `,
+  ],
+})
+export class SearchBoxComponent {
+  FilterFlag = FilterFlag;
+
+  @Input() textFilter: TextFilter | undefined = new TextFilter('', []);
+  @Input() label = 'Search';
+  @Input() filterName = 'filter';
+  @Input() appearance: string | undefined;
+  @Input() fontSize = 14;
+  @Input() wideField = false;
+
+  @Output() readonly filterChange = new EventEmitter<TextFilter>();
+
+  hasFlag(flag: FilterFlag): boolean {
+    return assertDefined(this.textFilter).flags.includes(flag) ?? false;
+  }
+
+  onFilterFlagClick(event: MouseEvent, flag: FilterFlag) {
+    event.stopPropagation();
+    const filter = assertDefined(this.textFilter);
+    if (this.hasFlag(flag)) {
+      filter.flags = filter.flags.filter((f) => f !== flag);
+    } else {
+      filter.flags = filter.flags.concat(flag);
+    }
+    this.onFilterChange();
+  }
+
+  onFilterChange() {
+    this.filterChange.emit(this.textFilter);
+  }
+}
diff --git a/tools/winscope/src/viewers/components/search_box_component_test.ts b/tools/winscope/src/viewers/components/search_box_component_test.ts
new file mode 100644
index 000000000..11ade8b16
--- /dev/null
+++ b/tools/winscope/src/viewers/components/search_box_component_test.ts
@@ -0,0 +1,117 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
+import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {FilterFlag} from 'common/filter_flag';
+import {TextFilter} from 'viewers/common/text_filter';
+import {SearchBoxComponent} from './search_box_component';
+
+describe('SearchBoxComponent', () => {
+  let fixture: ComponentFixture<SearchBoxComponent>;
+  let component: SearchBoxComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      imports: [
+        MatFormFieldModule,
+        MatInputModule,
+        FormsModule,
+        MatButtonModule,
+        BrowserAnimationsModule,
+        MatIconModule,
+        MatTooltipModule,
+      ],
+      declarations: [SearchBoxComponent],
+    }).compileComponents();
+    fixture = TestBed.createComponent(SearchBoxComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    component.textFilter = new TextFilter('', []);
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('shows custom label', () => {
+    const label = htmlElement.querySelector('.search-box mat-label');
+    expect(label?.textContent).toEqual('Search');
+
+    component.label = 'custom label';
+    fixture.detectChanges();
+    expect(label?.textContent).toEqual('custom label');
+  });
+
+  it('handles change in filter', () => {
+    const spy = spyOn(component.filterChange, 'emit');
+    expect(component.textFilter?.filterString).toEqual('');
+    changeFilterString('Test');
+    expect(component.textFilter?.filterString).toEqual('Test');
+    expect(spy).toHaveBeenCalledWith(new TextFilter('Test', []));
+  });
+
+  it('handles change in flags', () => {
+    const spy = spyOn(component.filterChange, 'emit');
+    const buttons =
+      htmlElement.querySelectorAll<HTMLElement>('.search-box button');
+    expect(buttons.length).toEqual(3);
+
+    buttons.item(0).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledWith(
+      new TextFilter('', [FilterFlag.MATCH_CASE]),
+    );
+
+    buttons.item(0).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledWith(new TextFilter('', []));
+
+    buttons.item(2).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledWith(
+      new TextFilter('', [FilterFlag.USE_REGEX]),
+    );
+
+    buttons.item(1).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledWith(
+      new TextFilter('', [FilterFlag.USE_REGEX, FilterFlag.MATCH_WORD]),
+    );
+  });
+
+  function changeFilterString(
+    newString: string,
+    el = htmlElement,
+    f = fixture,
+  ) {
+    const inputEl = assertDefined(
+      el.querySelector<HTMLInputElement>('.search-box input'),
+    );
+    inputEl.value = newString;
+    inputEl.dispatchEvent(new Event('input'));
+    f.detectChanges();
+  }
+});
diff --git a/tools/winscope/src/viewers/components/select_with_filter_component.ts b/tools/winscope/src/viewers/components/select_with_filter_component.ts
index 758235de8..f6df8c655 100644
--- a/tools/winscope/src/viewers/components/select_with_filter_component.ts
+++ b/tools/winscope/src/viewers/components/select_with_filter_component.ts
@@ -34,7 +34,7 @@ import {MatSelectChange} from '@angular/material/select';
         <mat-option
           *ngFor="let option of options"
           [value]="option"
-          [class.hidden-option]="!option.includes(filterString)">
+          [class.hidden-option]="hideOption(option)">
           {{ option }}
         </mat-option>
       </mat-select>
@@ -56,7 +56,7 @@ import {MatSelectChange} from '@angular/material/select';
 export class SelectWithFilterComponent {
   @Input() label: string = '';
   @Input() options: string[] = [];
-  @Input() outerFilterWidth = '75';
+  @Input() outerFilterWidth = '100px';
   @Input() innerFilterWidth = '100';
   @Input() flex = 'none';
   @Input() multiple = true;
@@ -73,7 +73,7 @@ export class SelectWithFilterComponent {
   getOuterFormFieldStyle() {
     return {
       flex: this.flex,
-      width: this.outerFilterWidth + 'px',
+      width: this.outerFilterWidth,
     };
   }
 
@@ -90,4 +90,8 @@ export class SelectWithFilterComponent {
   onSelectClosed() {
     this.filterString = '';
   }
+
+  hideOption(option: string) {
+    return !option.toLowerCase().includes(this.filterString.toLowerCase());
+  }
 }
diff --git a/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts b/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
index 4f3a0477f..672d8a99e 100644
--- a/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/clickable_property.styles.ts
@@ -15,7 +15,7 @@
  */
 
 export const timeButtonStyle = `
-    .time button {
+    .time-button {
       padding: 0px;
       line-height: normal;
       text-align: left;
@@ -26,6 +26,7 @@ export const inlineButtonStyle = `
     .inline button {
       padding: 0px;
       min-width: fit-content;
+      width: fit-content;
       line-height: normal;
       text-align: left;
     }
diff --git a/tools/winscope/src/viewers/components/styles/log_component.styles.ts b/tools/winscope/src/viewers/components/styles/log_component.styles.ts
new file mode 100644
index 000000000..2d99e422e
--- /dev/null
+++ b/tools/winscope/src/viewers/components/styles/log_component.styles.ts
@@ -0,0 +1,205 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+export const logComponentStyles = `
+  .entries {
+    display: flex;
+    flex-direction: column;
+    flex: 1;
+    overflow: auto;
+    margin: 4px;
+    padding: 12px;
+  }
+
+  .entries .filters {
+    display: flex;
+    flex-direction: row;
+  }
+
+  .entries .scroll {
+    flex: 1;
+  }
+
+  .scroll .entry {
+    display: flex;
+    flex-direction: row;
+    overflow-wrap: anywhere;
+  }
+
+  .filters div,
+  .entries div {
+    padding: 4px;
+  }
+
+  .time:not(.with-date) {
+    flex: 0 0 135px;
+  }
+
+  .time.with-date {
+    flex: 0 0 175px;
+  }
+
+  .go-to-current-time {
+    font-size: 12px;
+    height: 75%;
+    width: fit-content;
+  }
+
+  .placeholder-text {
+    text-align: center;
+  }
+
+  .right-align {
+    text-align: end;
+  }
+
+  .layer-or-display-id {
+    flex: 0.75;
+    min-width: 85px;
+  }
+
+  .transaction-id {
+    flex: 1;
+    min-width: 85px;
+  }
+
+  .vsyncid {
+    flex: none;
+    width: 90px;
+  }
+
+  .pid {
+    flex: none;
+    width: 75px;
+  }
+
+  .uid {
+    flex: none;
+    width: 75px;
+  }
+
+  .transaction-type {
+    flex: 1;
+    min-width: 85px;
+  }
+
+  .flags, .flags select-with-filter {
+    flex: 2;
+  }
+
+  .log-level {
+    flex: 1;
+    min-width: 85px;
+  }
+
+  .filters .log-level select-with-filter {
+    flex: 1;
+  }
+
+  .tag, .tag select-with-filter {
+    flex: 2;
+  }
+
+  .source-file, .source-file select-with-filter {
+    flex: 4;
+  }
+
+  .text {
+    flex: 10;
+  }
+
+  .filters mat-form-field {
+    width: 80%;
+    font-size: 12px;
+  }
+
+  .title-section .filters {
+    margin-top: 8px;
+  }
+
+  .transition-id {
+    flex: 1;
+  }
+
+  .entries .headers {
+    flex: 0 0 auto;
+    display: flex;
+    flex-direction: row;
+    font-weight: bold;
+    border-bottom: solid 1px rgba(0, 0, 0, 0.5);
+  }
+
+  .transition-type {
+    flex: 3;
+  }
+
+  .jank_cuj-type {
+    flex: 8;
+  }
+
+  .start-time, .end-time, .dispatch-time, .send-time {
+    flex: 3;
+  }
+
+  .duration {
+    flex: 2;
+  }
+
+  .status {
+    flex: 3;
+  }
+
+  .entry .status {
+    display: flex;
+    align-items: center;
+    gap: 5px;
+    justify-content: end;
+  }
+
+  .status .mat-icon {
+    font-size: 18px;
+    width: 18px;
+    height: 18px;
+  }
+
+  .input-type {
+    flex: 2;
+  }
+  .input-source {
+    flex: 3;
+  }
+  .input-action {
+    flex: 2;
+  }
+  .input-device-id {
+    flex: 1;
+  }
+  .input-display-id {
+    flex: 1;
+    min-width: 50px;
+  }
+  .input-details {
+    flex: 4;
+  }
+  .entry .input-windows {
+    display: none;
+    flex: 0;
+  }
+  .filters .input-windows {
+    display: flex;
+    flex: 10;
+  }
+`;
diff --git a/tools/winscope/src/viewers/components/styles/node.styles.ts b/tools/winscope/src/viewers/components/styles/node.styles.ts
index 035ecdf8e..d5f6f42f6 100644
--- a/tools/winscope/src/viewers/components/styles/node.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/node.styles.ts
@@ -26,38 +26,42 @@ export const nodeStyles =
         width: 100%;
     }
 
+    .node:not(.selected):not(.full-opacity):not(:hover) {
+        opacity: 0.5;
+    }
+
     .node.clickable {
         cursor: pointer;
     }
 
     .node:not(.selected).added,
     .node:not(.selected).addedMove {
-        background: ${Color.ADDED_ELEMENT_BACKGROUND};
+        background-color: var(--added-element-color);
     }
 
     .node:not(.selected).deleted,
     .node:not(.selected).deletedMove {
-        background: ${Color.DELETED_ELEMENT_BACKGROUND};
+        background-color: var(--deleted-element-color);
     }
 
     .node:not(.selected).modified {
-        background: ${Color.MODIFIED_ELEMENT_BACKGROUND};
+        background-color: var(--modified-element-color);
     }
 
     .node:hover:not(.selected) {
-        background-color: ${Color.HOVER_ELEMENT_BACKGROUND};
+        background-color: var(--hover-element-color);
     }
 
     .node.addedMove:after,
     .node.deletedMove:after {
-        content: 'moved';
+        content: 'Moved';
         font: 14px 'Roboto', sans-serif;
         margin: 0 5px;
-        background: ${Color.CHIP_BLUE};
-        border-radius: 5px;
+        background-color: ${Color.CHIP_BLUE};
+        color: ${Color.TEXT_BLACK};
+        border-radius: 10px;
         height: fit-content;
         padding: 3px;
-        color: white;
     }
 ` + selectedElementStyle;
 
@@ -114,11 +118,15 @@ export const nodeInnerItemStyles = `
       position: absolute;
     }
 
-    .toggle-tree-btn, .expand-tree-btn, .pin-node-btn, .toggle-rect-show-state-btn {
+    .icon-wrapper-copy {
+        right: 0;
+    }
+
+    .toggle-tree-btn, .expand-tree-btn, .pin-node-btn, .toggle-rect-show-state-btn, .copy-btn {
         padding: 0;
     }
 
-    .toggle-rect-show-state-btn {
+    .toggle-rect-show-state-btn, .copy-btn {
         transform: scale(0.75);
     }
 
@@ -147,6 +155,9 @@ export const nodeInnerItemStyles = `
         vertical-align: middle;
         color: inherit;
         cursor: pointer;
+        height: 24px;
+        width: 24px;
+        line-height: 24px;
     }
 
     .expand-tree-btn {
@@ -154,16 +165,25 @@ export const nodeInnerItemStyles = `
     }
 
     .expand-tree-btn.modified {
-        background: ${Color.MODIFIED_ELEMENT_BACKGROUND};
+        background-color: var(--modified-element-color);
     }
 
     .expand-tree-btn.deleted,
     .expand-tree-btn.deletedMove {
-        background: ${Color.DELETED_ELEMENT_BACKGROUND};
+        background-color: var(--deleted-element-color);
     }
 
     .expand-tree-btn.added,
     .expand-tree-btn.addedMove {
-        background: ${Color.ADDED_ELEMENT_BACKGROUND};
+        background-color: var(--added-element-color);
+    }
+
+    .icon-wrapper-show-state {
+        opacity: 1;
+    }
+
+    :host:not(:hover):not(.selected) .icon-wrapper-show-state,
+    :host:not(:hover) .icon-wrapper-copy {
+        visibility: hidden;
     }
 `;
diff --git a/tools/winscope/src/viewers/components/styles/tree_node_data_view.styles.ts b/tools/winscope/src/viewers/components/styles/tree_node_data_view.styles.ts
index 9e1b48d18..8b76877bb 100644
--- a/tools/winscope/src/viewers/components/styles/tree_node_data_view.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/tree_node_data_view.styles.ts
@@ -25,24 +25,8 @@ export const hierarchyTreeNodeDataViewStyles = `
         margin: 0 5px;
         padding: 0 10px;
         border-radius: 10px;
-        background-color: #aaa;
-        color: ${Color.TEXT_BLACK};
-    }
-
-    .tree-view-chip.tree-view-chip-warn {
-        background-color: ${Color.CHIP_ORANGE};
-    }
-
-    .tree-view-chip.tree-view-chip-error {
-        background-color: ${Color.CHIP_RED};
-    }
-
-    .tree-view-chip.tree-view-chip-gpu {
-        background-color: ${Color.CHIP_GREEN};
-    }
-
-    .tree-view-chip.tree-view-chip-hwc {
         background-color: ${Color.CHIP_BLUE};
+        color: ${Color.TEXT_BLACK};
     }
 `;
 
@@ -63,20 +47,14 @@ export const propertyTreeNodeDataViewStyles = `
         vertical-align: top;
     }
     .old-value {
-        color: ${Color.TEXT_GRAY};
+        color: var(--gray-text-color);
         display: flex;
     }
-    .value {
-        color: var(--purple-text-color);
-    }
     .new {
         display: flex;
     }
     .value.null {
-        color: ${Color.TEXT_GRAY};
-    }
-    .value.number {
-        color: var(--blue-text-color);
+        color: var(--gray-text-color);
     }
     .value.true {
         color: var(--green-text-color);
diff --git a/tools/winscope/src/viewers/components/styles/user_option.styles.ts b/tools/winscope/src/viewers/components/styles/user_option.styles.ts
index 252514b3e..c3a9897d0 100644
--- a/tools/winscope/src/viewers/components/styles/user_option.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/user_option.styles.ts
@@ -17,40 +17,40 @@
 import {Color} from 'app/colors';
 
 export const userOptionStyle = `
-    .user-option {
-        line-height: 24px;
-        padding: 0 10px;
-        margin-right: 10px;
-        min-width: fit-content;
-    }
-    .user-option.not-enabled {
-        background-color: var(--disabled-color);
-    }
+  .user-option {
+    line-height: 24px;
+    padding: 0 10px;
+    margin-inline-end: 10px;
+    min-width: fit-content;
+  }
+  .user-option.not-enabled {
+    background-color: var(--disabled-color);
+  }
 
-    .user-option-label {
-      display: flex;
-      flex-direction: row;
-    }
-    .user-option-label.with-chip {
-      align-items: baseline;
-    }
-    .user-option-label:not(.with-chip) {
-      align-items: center;
-    }
-    .user-option .mat-icon {
-      margin-left: 5px;
-    }
+  .user-option-label {
+    display: flex;
+    flex-direction: row;
+  }
+  .user-option-label.with-chip {
+    align-items: baseline;
+  }
+  .user-option-label:not(.with-chip) {
+    align-items: center;
+  }
+  .user-option .mat-icon {
+    margin-inline-start: 5px;
+  }
 
-    .user-option-chip {
-        margin-left: 5px;
-        margin-top: 2px;
-        padding: 0 10px;
-        border-radius: 10px;
-        background-color: #aaa;
-        font-weight: normal;
-        color: ${Color.TEXT_BLACK};
-        height: 18px;
-        align-items: center;
-        display: flex;
-      }
+  .user-option-chip {
+    margin-inline-start: 5px;
+    margin-top: 2px;
+    padding: 0 10px;
+    border-radius: 10px;
+    background-color: ${Color.CHIP_BLUE};
+    font-weight: normal;
+    color: ${Color.TEXT_BLACK};
+    height: 18px;
+    align-items: center;
+    display: flex;
+  }
 `;
diff --git a/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts b/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
index 589928960..9c44c410f 100644
--- a/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
+++ b/tools/winscope/src/viewers/components/styles/viewer_card.styles.ts
@@ -32,10 +32,6 @@ export const viewerCardStyle = `
         box-shadow: 0px 1px 3px var(--border-color), 0px 1px 2px var(--border-color);
     }
 
-    .log-view:not(.collapsed) {
-        padding: 12px;
-    }
-
     .rects-view:not(.collapsed),
     .hierarchy-view:not(.collapsed),
     .ime-additional-properties:not(.collapsed),
@@ -83,4 +79,8 @@ export const viewerCardInnerStyle = `
         overflow-x: auto;
         overflow-y: hidden;
     }
+
+    .placeholder-text {
+      padding: 8px 12px;
+    }
 `;
diff --git a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component.ts b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component.ts
index f34634384..eb7195f94 100644
--- a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component.ts
+++ b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component.ts
@@ -43,13 +43,13 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       <div class="group">
         <h3 class="group-header mat-subheading-2">Visibility</h3>
         <div class="left-column">
-          <p class="mat-body-1 flags">
-            <span class="mat-body-2">Flags:</span>
+          <p class="mat-body-2 flags">
+            <span class="mat-body-1">Flags:</span>
             &ngsp;
             {{ properties.flags }}
           </p>
-          <span *ngFor="let summaryProperty of properties.summary" class="mat-body-1 summary inline">
-            <span class="mat-body-2">{{ summaryProperty.key }}:</span>
+          <span *ngFor="let summaryProperty of properties.summary" class="mat-body-2 summary inline">
+            <span class="mat-body-1" [matTooltip]="summaryProperty.desc" [matTooltipShowDelay]="400">{{ summaryProperty.key }}:</span>
             <ng-container *ngIf="summaryProperty.simpleValue">
               {{ summaryProperty.simpleValue }}
             </ng-container>
@@ -76,14 +76,14 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         <h3 class="group-header mat-subheading-2">Geometry</h3>
         <div class="left-column">
           <p class="column-header mat-small">Calculated</p>
-          <p class="property mat-body-2">Transform:</p>
+          <p class="property mat-body-1">Transform:</p>
           <transform-matrix
             *ngIf="properties.calcTransform?.getAllChildren().length > 0"
             [matTooltip]="getTransformType(properties.calcTransform)"
             [matrix]="getTransformMatrix(properties.calcTransform)"></transform-matrix>
-          <p class="mat-body-1 crop">
+          <p class="mat-body-2 crop">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="Raw value read from proto.bounds. This is the buffer size or
                   requested crop cropped by parent bounds."
               >Crop:</span
@@ -92,9 +92,9 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
             {{ properties.calcCrop }}
           </p>
 
-          <p class="mat-body-1 final-bounds">
+          <p class="mat-body-2 final-bounds">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="Raw value read from proto.screenBounds. This is the calculated crop
                   transformed."
               >Final Bounds:</span
@@ -105,13 +105,13 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         </div>
         <div class="right-column">
           <p class="column-header mat-small">Requested</p>
-          <p class="property mat-body-2">Transform:</p>
+          <p class="property mat-body-1">Transform:</p>
           <transform-matrix
             *ngIf="properties.reqTransform?.getAllChildren().length > 0"
             [matTooltip]="getTransformType(properties.reqTransform)"
             [matrix]="getTransformMatrix(properties.reqTransform)"></transform-matrix>
-          <p class="mat-body-1 crop">
-            <span class="mat-body-2">Crop:</span>
+          <p class="mat-body-2 crop">
+            <span class="mat-body-1">Crop:</span>
             &ngsp;
             {{ properties.reqCrop }}
           </p>
@@ -123,19 +123,19 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       <div class="group buffer">
         <h3 class="group-header mat-subheading-2">Buffer</h3>
         <div class="left-column">
-          <p class="mat-body-1 size">
-            <span class="mat-body-2">Size:</span>
+          <p class="mat-body-2 size">
+            <span class="mat-body-1">Size:</span>
             &ngsp;
             {{ properties.bufferSize }}
           </p>
-          <p class="mat-body-1 frame-number">
-            <span class="mat-body-2">Frame Number:</span>
+          <p class="mat-body-2 frame-number">
+            <span class="mat-body-1">Frame Number:</span>
             &ngsp;
             {{ properties.frameNumber }}
           </p>
-          <p class="mat-body-1 transform">
+          <p class="mat-body-2 transform">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="Rotates or flips the buffer in place. Used with display transform
                   hint to cancel out any buffer transformation when sending to
                   HWC."
@@ -146,9 +146,9 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
           </p>
         </div>
         <div class="right-column">
-          <p class="mat-body-1 dest-frame">
+          <p class="mat-body-2 dest-frame">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="Scales buffer to the frame by overriding the requested transform
                   for this item."
               >Destination Frame:</span
@@ -156,7 +156,7 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
             &ngsp;
             {{ properties.destinationFrame }}
           </p>
-          <p *ngIf="properties.ignoreDestinationFrame" class="mat-body-1 ignore-frame">
+          <p *ngIf="properties.ignoreDestinationFrame" class="mat-body-2 ignore-frame">
             Destination Frame ignored because item has eIgnoreDestinationFrame flag set.
           </p>
         </div>
@@ -167,21 +167,48 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
       <div class="group hierarchy-info">
         <h3 class="group-header mat-subheading-2">Hierarchy</h3>
         <div class="left-column">
-          <p class="mat-body-1 z-order">
-            <span class="mat-body-2">z-order:</span>
+          <p class="mat-body-2 z-order">
+            <span class="mat-body-1">z-order:</span>
             &ngsp;
             {{ properties.z }}
           </p>
-          <p class="mat-body-1 rel-parent">
+          <p class="mat-body-2 rel-parent inline">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="item is z-ordered relative to its relative parents but its bounds
                   and other properties are inherited from its parents."
-              >relative parent:</span
-            >
+              >relative parent:</span>
             &ngsp;
-            {{ properties.relativeParent }}
+            <ng-container *ngIf="!properties.relativeParent.nodeId">
+              {{ properties.relativeParent }}
+            </ng-container>
+            <ng-container *ngIf="properties.relativeParent.nodeId">
+              <button
+                mat-button
+                color="primary"
+                [matTooltip]="properties.relativeParent.name"
+                (click)="onIdClicked(properties.relativeParent.nodeId)">
+                {{ properties.relativeParent.layerId }}
+              </button>
+            </ng-container>
           </p>
+          <span class="mat-body-2 rel-children inline">
+            <span class="mat-body-1">relative children:</span>
+            &ngsp;
+            <ng-container *ngIf="properties.relativeChildren.length === 0">
+              none
+            </ng-container>
+            <ng-container *ngFor="let layer of properties.relativeChildren; index as i">
+              <button
+                mat-button
+                color="primary"
+                [matTooltip]="layer.name"
+                (click)="onIdClicked(layer.nodeId)">
+                {{ layer.layerId }}
+              </button>
+              {{(i === properties.relativeChildren.length - 1) ? '' : ', '}}
+            </ng-container>
+          </span>
         </div>
       </div>
 
@@ -191,24 +218,24 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         <h3 class="group-header mat-subheading-2">Effects</h3>
         <div class="left-column">
           <p class="column-header mat-small">Calculated</p>
-          <p class="mat-body-1 color">
-            <span class="mat-body-2">Color:</span>
+          <p class="mat-body-2 color">
+            <span class="mat-body-1">Color:</span>
             &ngsp;
             {{ properties.calcColor }}
           </p>
-          <p class="mat-body-1 corner-radius">
-            <span class="mat-body-2">Corner Radius:</span>
+          <p class="mat-body-2 corner-radius">
+            <span class="mat-body-1">Corner Radius:</span>
             &ngsp;
             {{ properties.calcCornerRadius }}
           </p>
-          <p class="mat-body-1 shadow">
-            <span class="mat-body-2">Shadow:</span>
+          <p class="mat-body-2 shadow">
+            <span class="mat-body-1">Shadow:</span>
             &ngsp;
             {{ properties.calcShadowRadius }}
           </p>
-          <p class="mat-body-1">
+          <p class="mat-body-2">
             <span
-              class="mat-body-2"
+              class="mat-body-1"
               matTooltip="Crop used to define the bounds of the corner radii. If the bounds
                   are greater than the item bounds then the rounded corner will not
                   be visible."
@@ -217,21 +244,21 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
             &ngsp;
             {{ properties.calcCornerRadiusCrop }}
           </p>
-          <p class="mat-body-1 blur">
-            <span class="mat-body-2">Blur:</span>
+          <p class="mat-body-2 blur">
+            <span class="mat-body-1">Blur:</span>
             &ngsp;
             {{ properties.backgroundBlurRadius }}
           </p>
         </div>
         <div class="right-column">
           <p class="column-header mat-small">Requested</p>
-          <p class="mat-body-1">
-            <span class="mat-body-2">Color:</span>
+          <p class="mat-body-2">
+            <span class="mat-body-1">Color:</span>
             &ngsp;
             {{ properties.reqColor }}
           </p>
-          <p class="mat-body-1 corner-radius">
-            <span class="mat-body-2">Corner Radius:</span>
+          <p class="mat-body-2 corner-radius">
+            <span class="mat-body-1">Corner Radius:</span>
             &ngsp;
             {{ properties.reqCornerRadius }}
           </p>
@@ -244,44 +271,44 @@ import {viewerCardInnerStyle} from './styles/viewer_card.styles';
         <h3 class="group-header mat-subheading-2">Input</h3>
         <ng-container *ngIf="properties.hasInputChannel">
           <div class="left-column">
-            <p class="property mat-body-2">To Display Transform:</p>
+            <p class="property mat-body-1">To Display Transform:</p>
             <transform-matrix
               *ngIf="properties.inputTransform?.getAllChildren().length > 0"
               [matTooltip]="getTransformType(properties.inputTransform)"
               [matrix]="getTransformMatrix(properties.inputTransform)"></transform-matrix>
-            <p class="mat-body-1">
-              <span class="mat-body-2">Touchable Region:</span>
+            <p class="mat-body-2">
+              <span class="mat-body-1">Touchable Region:</span>
               &ngsp;
               {{ properties.inputRegion }}
             </p>
           </div>
           <div class="right-column">
             <p class="column-header mat-small">Config</p>
-            <p class="mat-body-1 focusable">
-              <span class="mat-body-2">Focusable:</span>
+            <p class="mat-body-2 focusable">
+              <span class="mat-body-1">Focusable:</span>
               &ngsp;
               {{ properties.focusable }}
             </p>
-            <p class="mat-body-1 crop-touch-region">
-              <span class="mat-body-2">Crop touch region with item:</span>
+            <p class="mat-body-2 crop-touch-region">
+              <span class="mat-body-1">Crop touch region with item:</span>
               &ngsp;
               {{ properties.cropTouchRegionWithItem }}
             </p>
-            <p class="mat-body-1 replace-touch-region">
-              <span class="mat-body-2">Replace touch region with crop:</span>
+            <p class="mat-body-2 replace-touch-region">
+              <span class="mat-body-1">Replace touch region with crop:</span>
               &ngsp;
               {{ properties.replaceTouchRegionWithCrop }}
             </p>
-            <p class="mat-body-1 input-config">
-              <span class="mat-body-2">Input Config:</span>
+            <p class="mat-body-2 input-config">
+              <span class="mat-body-1">Input Config:</span>
               &ngsp;
               {{ properties.inputConfig }}
             </p>
           </div>
         </ng-container>
         <div *ngIf="!properties.hasInputChannel" class="left-column">
-          <p class="mat-body-1">
-            <span class="mat-body-2">Input channel:</span>
+          <p class="mat-body-2">
+            <span class="mat-body-1">Input channel:</span>
             &ngsp; not set
           </p>
         </div>
diff --git a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
index 6aadc3904..0cb8d9aad 100644
--- a/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
+++ b/tools/winscope/src/viewers/components/surface_flinger_property_groups_component_test.ts
@@ -73,22 +73,15 @@ describe('SurfaceFlingerPropertyGroupsComponent', () => {
   it('renders interactive summary property', () => {
     const summary = htmlElement.querySelectorAll('.summary').item(1);
     expect(summary.textContent).toContain('Covered by:');
-    const button = assertDefined(
-      summary.querySelector('button'),
-    ) as HTMLButtonElement;
+    const button = assertDefined(summary.querySelector<HTMLElement>('button'));
     expect(button.textContent).toMatch('1');
   });
 
-  it('emits highlighted id event', () => {
-    let id = '';
-    htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) => {
-      id = (event as CustomEvent).detail.id;
-    });
-    const button = assertDefined(
-      htmlElement.querySelector('.summary button'),
-    ) as HTMLButtonElement;
-    button.click();
-    expect(id).toEqual('1 coveringLayer');
+  it('emits highlighted id event from layer id in summary', () => {
+    checkHighlightedIdEventEmittedFromButtonClick(
+      '.summary button',
+      '1 coveringLayer',
+    );
   });
 
   it('displays calculated geometry', () => {
@@ -136,6 +129,38 @@ describe('SurfaceFlingerPropertyGroupsComponent', () => {
       '.hierarchy-info .rel-parent',
     );
     expect(assertDefined(relParentDiv).innerHTML).toContain('none');
+    const relChildrenDiv = assertDefined(
+      htmlElement.querySelector('.hierarchy-info .rel-children'),
+    );
+    expect(relChildrenDiv.innerHTML).toContain('none');
+  });
+
+  it('emits highlighted id event from layer id in rel z parent', () => {
+    component.properties.relativeParent = {
+      layerId: '1',
+      nodeId: '1 relZParent',
+      name: 'relZParent',
+    };
+    fixture.detectChanges();
+    checkHighlightedIdEventEmittedFromButtonClick(
+      '.hierarchy-info .rel-parent button',
+      '1 relZParent',
+    );
+  });
+
+  it('emits highlighted id event from layer id in rel z children', () => {
+    component.properties.relativeChildren = [
+      {
+        layerId: '2',
+        nodeId: '2 relZChild',
+        name: 'relZChild',
+      },
+    ];
+    fixture.detectChanges();
+    checkHighlightedIdEventEmittedFromButtonClick(
+      '.hierarchy-info .rel-children button',
+      '2 relZChild',
+    );
   });
 
   it('displays simple calculated effects', () => {
@@ -202,13 +227,30 @@ describe('SurfaceFlingerPropertyGroupsComponent', () => {
   it('handles collapse button click', () => {
     expect(component.collapseButtonClicked).toBeFalse();
     const collapseButton = assertDefined(
-      htmlElement.querySelector('collapsible-section-title button'),
-    ) as HTMLButtonElement;
+      htmlElement.querySelector<HTMLElement>(
+        'collapsible-section-title button',
+      ),
+    );
     collapseButton.click();
     fixture.detectChanges();
     expect(component.collapseButtonClicked).toBeTrue();
   });
 
+  function checkHighlightedIdEventEmittedFromButtonClick(
+    selector: string,
+    expectedId: string,
+  ) {
+    let id = '';
+    htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) => {
+      id = (event as CustomEvent).detail.id;
+    });
+    const button = assertDefined(
+      htmlElement.querySelector<HTMLElement>(selector),
+    );
+    button.click();
+    expect(id).toEqual(expectedId);
+  }
+
   @Component({
     selector: 'host-component',
     template: `
@@ -256,6 +298,7 @@ describe('SurfaceFlingerPropertyGroupsComponent', () => {
       destinationFrame: EMPTY_OBJ_STRING,
       z: '0',
       relativeParent: 'none',
+      relativeChildren: [],
       calcColor: `${EMPTY_OBJ_STRING}, alpha: 1`,
       calcShadowRadius: '1 px',
       calcCornerRadius: '1 px',
diff --git a/tools/winscope/src/viewers/components/transform_matrix_component.ts b/tools/winscope/src/viewers/components/transform_matrix_component.ts
index ac2a848f2..e2ef21a52 100644
--- a/tools/winscope/src/viewers/components/transform_matrix_component.ts
+++ b/tools/winscope/src/viewers/components/transform_matrix_component.ts
@@ -25,17 +25,17 @@ import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
         {{ getVal('dsdx') }}
       </p>
       <p class="mat-body-1">
-        {{ getVal('dsdy') }}
+        {{ getVal('dtdx') }}
       </p>
       <p class="mat-body-1" matTooltip="Translate x">
         {{ getVal('tx') }}
       </p>
 
       <p class="mat-body-1">
-        {{ getVal('dtdx') }}
+        {{ getVal('dtdy') }}
       </p>
       <p class="mat-body-1">
-        {{ getVal('dtdy') }}
+        {{ getVal('dsdy') }}
       </p>
       <p class="mat-body-1" matTooltip="Translate y">
         {{ getVal('ty') }}
diff --git a/tools/winscope/src/viewers/components/tree_component.ts b/tools/winscope/src/viewers/components/tree_component.ts
index a4707a6d9..7ee35694e 100644
--- a/tools/winscope/src/viewers/components/tree_component.ts
+++ b/tools/winscope/src/viewers/components/tree_component.ts
@@ -49,8 +49,8 @@ import {
       [class.selected]="isHighlighted(node, highlightedItem)"
       [class.clickable]="isClickable()"
       [class.child-selected]="hasSelectedChild()"
-      [class.hover]="nodeHover"
-      [class.childHover]="childHover"
+      [class.child-hover]="childHover"
+      [class.full-opacity]="showFullOpacity(node)"
       [class]="node.getDiff()"
       [style]="nodeOffsetStyle()"
       [node]="node"
@@ -118,7 +118,6 @@ export class TreeComponent {
   @Output() readonly hoverEnd = new EventEmitter<void>();
 
   localExpandedState = true;
-  nodeHover = false;
   childHover = false;
   readonly levelOffset = 24;
   nodeElement: HTMLElement;
@@ -274,6 +273,13 @@ export class TreeComponent {
     return showState === RectShowState.SHOW ? 'visibility' : 'visibility_off';
   }
 
+  showFullOpacity(node: UiPropertyTreeNode | UiHierarchyTreeNode) {
+    if (node instanceof UiPropertyTreeNode) return true;
+    if (this.rectIdToShowState === undefined) return true;
+    const showState = this.rectIdToShowState.get(node.id);
+    return showState === RectShowState.SHOW;
+  }
+
   toggleRectShowState() {
     const nodeId = assertDefined(this.node).id;
     const currentShowState = assertDefined(this.rectIdToShowState?.get(nodeId));
@@ -302,9 +308,9 @@ export class TreeComponent {
   ) {
     if (this.store && this.useStoredExpandedState && shouldUpdateStoredState) {
       if (isExpanded) {
-        this.store.removeItem(this.storeKeyCollapsedState);
+        this.store.clear(this.storeKeyCollapsedState);
       } else {
-        this.store.setItem(this.storeKeyCollapsedState, 'true');
+        this.store.add(this.storeKeyCollapsedState, 'true');
       }
     } else {
       this.localExpandedState = isExpanded;
@@ -320,18 +326,16 @@ export class TreeComponent {
   };
 
   private nodeMouseEnterEventListener = () => {
-    this.nodeHover = true;
     this.hoverStart.emit();
   };
 
   private nodeMouseLeaveEventListener = () => {
-    this.nodeHover = false;
     this.hoverEnd.emit();
   };
 
   private isCollapsedInStore(): boolean {
     return (
-      assertDefined(this.store).getItem(this.storeKeyCollapsedState) === 'true'
+      assertDefined(this.store).get(this.storeKeyCollapsedState) === 'true'
     );
   }
 }
diff --git a/tools/winscope/src/viewers/components/tree_component_test.ts b/tools/winscope/src/viewers/components/tree_component_test.ts
index 3d0a156b4..80728c755 100644
--- a/tools/winscope/src/viewers/components/tree_component_test.ts
+++ b/tools/winscope/src/viewers/components/tree_component_test.ts
@@ -13,18 +13,18 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+
+import {Clipboard, ClipboardModule} from '@angular/cdk/clipboard';
 import {Component, CUSTOM_ELEMENTS_SCHEMA, ViewChild} from '@angular/core';
-import {
-  ComponentFixture,
-  ComponentFixtureAutoDetect,
-  TestBed,
-} from '@angular/core/testing';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
 import {MatIconModule} from '@angular/material/icon';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {assertDefined} from 'common/assert_utils';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {RectShowState} from 'viewers/common/rect_show_state';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {HierarchyTreeNodeDataViewComponent} from './hierarchy_tree_node_data_view_component';
 import {PropertyTreeNodeDataViewComponent} from './property_tree_node_data_view_component';
@@ -35,10 +35,12 @@ describe('TreeComponent', () => {
   let fixture: ComponentFixture<TestHostComponent>;
   let component: TestHostComponent;
   let htmlElement: HTMLElement;
+  let mockCopyText: jasmine.Spy;
 
   beforeEach(async () => {
+    mockCopyText = jasmine.createSpy();
     await TestBed.configureTestingModule({
-      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      providers: [{provide: Clipboard, useValue: {copy: mockCopyText}}],
       declarations: [
         TreeComponent,
         TestHostComponent,
@@ -46,25 +48,27 @@ describe('TreeComponent', () => {
         HierarchyTreeNodeDataViewComponent,
         PropertyTreeNodeDataViewComponent,
       ],
-      imports: [MatTooltipModule, MatIconModule],
+      imports: [MatTooltipModule, MatIconModule, ClipboardModule],
       schemas: [CUSTOM_ELEMENTS_SCHEMA],
     }).compileComponents();
     fixture = TestBed.createComponent(TestHostComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
-    fixture.detectChanges();
   });
 
   it('can be created', () => {
+    fixture.detectChanges();
     expect(component).toBeTruthy();
   });
 
   it('shows node', () => {
+    fixture.detectChanges();
     const treeNode = htmlElement.querySelector('tree-node');
     expect(treeNode).toBeTruthy();
   });
 
   it('can identify if a parent node has a selected child', () => {
+    fixture.detectChanges();
     const treeComponent = assertDefined(component.treeComponent);
     expect(treeComponent.hasSelectedChild()).toBeFalse();
     component.highlightedItem = '3 Child3';
@@ -72,47 +76,83 @@ describe('TreeComponent', () => {
     expect(treeComponent.hasSelectedChild()).toBeTrue();
   });
 
-  it('highlights node upon click', () => {
-    const treeNode = assertDefined(htmlElement.querySelector('tree-node'));
+  it('highlights node and inner node upon click', () => {
+    fixture.detectChanges();
+    const treeNodes = assertDefined(
+      htmlElement.querySelectorAll<HTMLElement>('tree-node'),
+    );
 
     const spy = spyOn(
       assertDefined(component.treeComponent).highlightedChange,
       'emit',
     );
-    (treeNode as HTMLButtonElement).dispatchEvent(
-      new MouseEvent('click', {detail: 1}),
-    );
+    treeNodes.item(0).dispatchEvent(new MouseEvent('click', {detail: 1}));
     fixture.detectChanges();
-    expect(spy).toHaveBeenCalled();
+    expect(spy).toHaveBeenCalledTimes(1);
+
+    treeNodes.item(1).click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalledTimes(2);
   });
 
   it('toggles tree upon node double click', () => {
+    fixture.detectChanges();
     const treeComponent = assertDefined(component.treeComponent);
-    const treeNode = assertDefined(htmlElement.querySelector('tree-node'));
-
-    const currLocalExpandedState = treeComponent.localExpandedState;
-    (treeNode as HTMLButtonElement).dispatchEvent(
-      new MouseEvent('click', {detail: 2}),
+    const treeNode = assertDefined(
+      htmlElement.querySelector<HTMLElement>('tree-node'),
     );
+    const currLocalExpandedState = treeComponent.localExpandedState;
+    treeNode.dispatchEvent(new MouseEvent('click', {detail: 2}));
     fixture.detectChanges();
     expect(!currLocalExpandedState).toEqual(treeComponent.localExpandedState);
   });
 
   it('does not toggle tree in flat mode on double click', () => {
+    fixture.detectChanges();
     const treeComponent = assertDefined(component.treeComponent);
     component.isFlattened = true;
     fixture.detectChanges();
-    const treeNode = assertDefined(htmlElement.querySelector('tree-node'));
+    const treeNode = assertDefined(
+      htmlElement.querySelector<HTMLElement>('tree-node'),
+    );
 
     const currLocalExpandedState = treeComponent.localExpandedState;
-    (treeNode as HTMLButtonElement).dispatchEvent(
-      new MouseEvent('click', {detail: 2}),
-    );
+    treeNode.dispatchEvent(new MouseEvent('click', {detail: 2}));
     fixture.detectChanges();
     expect(currLocalExpandedState).toEqual(treeComponent.localExpandedState);
   });
 
+  it('pins node on click', () => {
+    fixture.detectChanges();
+    const pinNodeButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.pin-node-btn'),
+    );
+    const spy = spyOn(
+      assertDefined(component.treeComponent).pinnedItemChange,
+      'emit',
+    );
+    pinNodeButton.click();
+    fixture.detectChanges();
+    expect(spy).toHaveBeenCalled();
+  });
+
+  it('expands tree on expand tree button click', () => {
+    fixture.detectChanges();
+    const treeNode = assertDefined(
+      htmlElement.querySelector<HTMLElement>('tree-node'),
+    );
+    treeNode.dispatchEvent(new MouseEvent('click', {detail: 2}));
+    fixture.detectChanges();
+    expect(component.treeComponent?.localExpandedState).toEqual(false);
+    assertDefined(
+      htmlElement.querySelector<HTMLElement>('.expand-tree-btn'),
+    ).click();
+    fixture.detectChanges();
+    expect(component.treeComponent?.localExpandedState).toEqual(true);
+  });
+
   it('scrolls selected node only if not in view', () => {
+    fixture.detectChanges();
     const treeComponent = assertDefined(component.treeComponent);
     const treeNode = assertDefined(
       treeComponent.elementRef.nativeElement.querySelector(`#nodeChild79`),
@@ -131,16 +171,22 @@ describe('TreeComponent', () => {
     expect(spy).toHaveBeenCalledTimes(1);
   });
 
-  it('sets initial expanded state to true by default', () => {
+  it('sets initial expanded state to true by default for leaf', () => {
+    fixture.detectChanges();
+    expect(assertDefined(component.treeComponent).isExpanded()).toBeTrue();
+  });
+
+  it('sets initial expanded state to true by default for non root', () => {
+    component.tree = component.tree.getAllChildren()[0];
     fixture.detectChanges();
     expect(assertDefined(component.treeComponent).isExpanded()).toBeTrue();
   });
 
   it('sets initial expanded state to false if collapse state exists in store', () => {
     component.useStoredExpandedState = true;
+    fixture.detectChanges();
     const treeComponent = assertDefined(component.treeComponent);
     // tree expanded by default
-    fixture.detectChanges();
     expect(treeComponent.isExpanded()).toBeTrue();
 
     // tree collapsed
@@ -155,12 +201,15 @@ describe('TreeComponent', () => {
   });
 
   it('renders show state button if applicable', () => {
+    fixture.detectChanges();
     expect(htmlElement.querySelector('.toggle-rect-show-state-btn')).toBeNull();
+    expect(htmlElement.querySelector('.children.with-gutter')).toBeNull();
 
     component.rectIdToShowState = new Map([
       [component.tree.id, RectShowState.HIDE],
     ]);
     fixture.detectChanges();
+    expect(htmlElement.querySelector('.children.with-gutter')).toBeTruthy();
     expect(
       assertDefined(htmlElement.querySelector('.toggle-rect-show-state-btn'))
         .textContent,
@@ -180,20 +229,74 @@ describe('TreeComponent', () => {
     ]);
     fixture.detectChanges();
     const button = assertDefined(
-      htmlElement.querySelector('.toggle-rect-show-state-btn'),
-    ) as HTMLElement;
+      htmlElement.querySelector<HTMLElement>('.toggle-rect-show-state-btn'),
+    );
     expect(button.textContent).toContain('visibility_off');
 
-    let id: string | undefined;
-    let state: RectShowState | undefined;
+    let id = '';
     htmlElement.addEventListener(ViewerEvents.RectShowStateChange, (event) => {
-      id = (event as CustomEvent).detail.rectId;
-      state = (event as CustomEvent).detail.state;
+      const detail = (event as CustomEvent).detail;
+      id = detail.rectId;
+      component.rectIdToShowState?.set(detail.rectId, detail.state);
     });
     button.click();
     fixture.detectChanges();
-    expect(id).toEqual(component.tree.id);
-    expect(state).toEqual(RectShowState.SHOW);
+    expect(component.rectIdToShowState.get(id)).toEqual(RectShowState.SHOW);
+
+    button.click();
+    fixture.detectChanges();
+    expect(component.rectIdToShowState.get(id)).toEqual(RectShowState.HIDE);
+  });
+
+  it('shows node at full opacity when applicable', () => {
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.node.full-opacity')).toBeTruthy();
+
+    component.rectIdToShowState = new Map([
+      [component.tree.id, RectShowState.SHOW],
+    ]);
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.node.full-opacity')).toBeTruthy();
+
+    component.tree = TreeNodeUtils.makeUiPropertyNode(
+      component.tree.id,
+      component.tree.name,
+      0,
+    );
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.node.full-opacity')).toBeTruthy();
+  });
+
+  it('shows node at non-full opacity when applicable', () => {
+    component.rectIdToShowState = new Map([]);
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.node.full-opacity')).toBeNull();
+
+    component.rectIdToShowState = new Map([
+      [component.tree.id, RectShowState.HIDE],
+    ]);
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.node.full-opacity')).toBeNull();
+  });
+
+  it('copies text via copy button without selecting node', () => {
+    fixture.detectChanges();
+
+    component.tree = TreeNodeUtils.makeUiPropertyNode(
+      component.tree.id,
+      component.tree.name,
+      0,
+    );
+    fixture.detectChanges();
+
+    const spy = spyOn(assertDefined(component.treeComponent), 'onNodeClick');
+    const copyButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.icon-wrapper-copy button'),
+    );
+    copyButton.click();
+    fixture.detectChanges();
+    expect(mockCopyText).toHaveBeenCalled();
+    expect(spy).not.toHaveBeenCalled();
   });
 
   function makeTree() {
@@ -234,7 +337,7 @@ describe('TreeComponent', () => {
     ],
   })
   class TestHostComponent {
-    tree: UiHierarchyTreeNode;
+    tree: UiHierarchyTreeNode | UiPropertyTreeNode;
     highlightedItem = '';
     isFlattened = false;
     useStoredExpandedState = false;
diff --git a/tools/winscope/src/viewers/components/tree_node_component.ts b/tools/winscope/src/viewers/components/tree_node_component.ts
index d56c2a5b1..20c745f68 100644
--- a/tools/winscope/src/viewers/components/tree_node_component.ts
+++ b/tools/winscope/src/viewers/components/tree_node_component.ts
@@ -31,26 +31,35 @@ import {nodeInnerItemStyles} from 'viewers/components/styles/node.styles';
   selector: 'tree-node',
   template: `
     <div *ngIf="showStateIcon" class="icon-wrapper-show-state" [style]="getShowStateIconStyle()">
-      <button class="icon-button toggle-rect-show-state-btn" (click)="toggleRectShowState($event)">
+      <button
+        mat-icon-button
+        class="icon-button toggle-rect-show-state-btn"
+        (click)="toggleRectShowState($event)">
         <mat-icon class="material-symbols-outlined">
           {{ showStateIcon }}
         </mat-icon>
       </button>
     </div>
     <div *ngIf="showChevron()" class="icon-wrapper">
-      <button class="icon-button toggle-tree-btn" (click)="toggleTree($event)">
+      <button
+        mat-icon-button
+        class="icon-button toggle-tree-btn"
+        (click)="toggleTree($event)">
         <mat-icon>
           {{ isExpanded ? 'arrow_drop_down' : 'chevron_right' }}
         </mat-icon>
       </button>
     </div>
 
-    <div *ngIf="showLeafNodeIcon()" class="icon-wrapper leaf-node-icon-wrapper">
+    <div *ngIf="!showChevron()" class="icon-wrapper leaf-node-icon-wrapper">
       <mat-icon class="leaf-node-icon"></mat-icon>
     </div>
 
     <div *ngIf="showPinNodeIcon()" class="icon-wrapper">
-      <button class="icon-button pin-node-btn" (click)="pinNode($event)">
+      <button
+        mat-icon-button
+        class="icon-button pin-node-btn"
+        (click)="pinNode($event)">
         <mat-icon [class.material-symbols-outlined]="!isPinned"> push_pin </mat-icon>
       </button>
     </div>
@@ -66,12 +75,22 @@ import {nodeInnerItemStyles} from 'viewers/components/styles/node.styles';
 
     <div *ngIf="!isLeaf && !isExpanded && !isPinned" class="icon-wrapper">
       <button
+        mat-icon-button
         class="icon-button expand-tree-btn"
         [class]="collapseDiffClass"
         (click)="expandTree($event)">
         <mat-icon aria-hidden="true"> more_horiz </mat-icon>
       </button>
     </div>
+    <div *ngIf="showCopyButton()" class="icon-wrapper-copy">
+      <button
+        mat-icon-button
+        class="icon-button copy-btn"
+        [cdkCopyToClipboard]="getCopyText()"
+        (click)="$event.stopPropagation()">
+        <mat-icon class="material-symbols-outlined">content_copy</mat-icon>
+      </button>
+    </div>
   `,
   styles: [nodeInnerItemStyles],
 })
@@ -110,7 +129,7 @@ export class TreeNodeComponent {
     }
   }
 
-  isNodeInView() {
+  isNodeInView(): boolean {
     if (!this.treeWrapper) {
       return false;
     }
@@ -133,14 +152,12 @@ export class TreeNodeComponent {
     return parent;
   }
 
-  isPropertyTreeNode() {
+  isPropertyTreeNode(): boolean {
     return this.node instanceof UiPropertyTreeNode;
   }
 
-  showPinNodeIcon() {
-    return (
-      (this.node instanceof UiHierarchyTreeNode && !this.node.isRoot()) ?? false
-    );
+  showPinNodeIcon(): boolean {
+    return this.node instanceof UiHierarchyTreeNode && !this.node.isRoot();
   }
 
   toggleTree(event: MouseEvent) {
@@ -153,14 +170,10 @@ export class TreeNodeComponent {
     this.rectShowStateChange.emit();
   }
 
-  showChevron() {
+  showChevron(): boolean {
     return !this.isLeaf && !this.flattened && !this.isInPinnedSection;
   }
 
-  showLeafNodeIcon() {
-    return !this.showChevron() && !this.isInPinnedSection;
-  }
-
   expandTree(event: MouseEvent) {
     event.stopPropagation();
     this.expandTreeChange.emit();
@@ -181,7 +194,6 @@ export class TreeNodeComponent {
     );
 
     childrenDiffClasses.delete(DiffType.NONE);
-    childrenDiffClasses.delete(undefined);
 
     if (childrenDiffClasses.size === 0) {
       return '';
@@ -202,11 +214,26 @@ export class TreeNodeComponent {
     };
   }
 
+  showCopyButton(): boolean {
+    return (
+      this.node instanceof UiPropertyTreeNode &&
+      (this.node.isRoot() || !this.showChevron())
+    );
+  }
+
+  getCopyText(): string {
+    const node = assertDefined(this.node) as UiPropertyTreeNode;
+    if (this.showChevron()) {
+      return node.name;
+    }
+    return `${node.name}: ${node.formattedValue()}`;
+  }
+
   private getAllDiffTypesOfChildren(
     node: UiHierarchyTreeNode | UiPropertyTreeNode,
-  ) {
-    const classes = new Set();
-    for (const child of node.getAllChildren().values()) {
+  ): Set<DiffType> {
+    const classes = new Set<DiffType>();
+    for (const child of node.getAllChildren()) {
       classes.add(child.getDiff());
       for (const diffClass of this.getAllDiffTypesOfChildren(child)) {
         classes.add(diffClass);
diff --git a/tools/winscope/src/viewers/components/tree_node_component_test.ts b/tools/winscope/src/viewers/components/tree_node_component_test.ts
index 05349f7fb..b5cf8ae0e 100644
--- a/tools/winscope/src/viewers/components/tree_node_component_test.ts
+++ b/tools/winscope/src/viewers/components/tree_node_component_test.ts
@@ -13,17 +13,19 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+
+import {Clipboard, ClipboardModule} from '@angular/cdk/clipboard';
 import {Component, ViewChild} from '@angular/core';
-import {
-  ComponentFixture,
-  ComponentFixtureAutoDetect,
-  TestBed,
-} from '@angular/core/testing';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
 import {MatIconModule} from '@angular/material/icon';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {assertDefined} from 'common/assert_utils';
 import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {DEFAULT_PROPERTY_FORMATTER} from 'trace/tree_node/formatters';
+import {DiffType} from 'viewers/common/diff_type';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {HierarchyTreeNodeDataViewComponent} from './hierarchy_tree_node_data_view_component';
 import {PropertyTreeNodeDataViewComponent} from './property_tree_node_data_view_component';
 import {TreeNodeComponent} from './tree_node_component';
@@ -32,17 +34,31 @@ describe('TreeNodeComponent', () => {
   let fixture: ComponentFixture<TestHostComponent>;
   let component: TestHostComponent;
   let htmlElement: HTMLElement;
+  let mockCopyText: jasmine.Spy;
+
+  const propertiesTree = UiPropertyTreeNode.from(
+    new PropertyTreeBuilder()
+      .setRootId('test')
+      .setName('property tree')
+      .setChildren([
+        {name: 'key1', value: 'value1', formatter: DEFAULT_PROPERTY_FORMATTER},
+        {name: 'key2', children: [{name: 'key3'}]},
+      ])
+      .build(),
+  );
+  propertiesTree.setIsRoot(true);
 
   beforeEach(async () => {
+    mockCopyText = jasmine.createSpy();
     await TestBed.configureTestingModule({
-      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      providers: [{provide: Clipboard, useValue: {copy: mockCopyText}}],
       declarations: [
         TreeNodeComponent,
         HierarchyTreeNodeDataViewComponent,
         PropertyTreeNodeDataViewComponent,
         TestHostComponent,
       ],
-      imports: [MatIconModule, MatTooltipModule],
+      imports: [MatIconModule, MatTooltipModule, ClipboardModule],
     }).compileComponents();
     fixture = TestBed.createComponent(TestHostComponent);
     component = fixture.componentInstance;
@@ -54,79 +70,164 @@ describe('TreeNodeComponent', () => {
     expect(component).toBeTruthy();
   });
 
-  it('can generate data view component', () => {
-    component.treeNodeComponent.isPropertyTreeNode = jasmine
-      .createSpy()
-      .and.returnValue(false);
-    fixture.detectChanges();
+  it('can generate hierarchy data view component', () => {
     const treeNodeDataView = htmlElement.querySelector(
       'hierarchy-tree-node-data-view',
     );
     expect(treeNodeDataView).toBeTruthy();
+    expect(
+      htmlElement.querySelector('property-tree-node-data-view'),
+    ).toBeNull();
+  });
+
+  it('can generate property data view component', () => {
+    component.node = propertiesTree;
+    fixture.detectChanges();
+    const treeNodeDataView = htmlElement.querySelector(
+      'property-tree-node-data-view',
+    );
+    expect(treeNodeDataView).toBeTruthy();
+    expect(
+      htmlElement.querySelector('hierarchy-tree-node-data-view'),
+    ).toBeNull();
   });
 
   it('can trigger tree toggle on click of chevron', () => {
-    component.treeNodeComponent.showChevron = jasmine
-      .createSpy()
-      .and.returnValue(true);
+    const treeNodeComponent = assertDefined(component.treeNodeComponent);
+    treeNodeComponent.showChevron = jasmine.createSpy().and.returnValue(true);
     fixture.detectChanges();
 
-    const spy = spyOn(component.treeNodeComponent.toggleTreeChange, 'emit');
+    const spy = spyOn(treeNodeComponent.toggleTreeChange, 'emit');
     const toggleButton = assertDefined(
-      htmlElement.querySelector('.toggle-tree-btn'),
+      htmlElement.querySelector<HTMLElement>('.toggle-tree-btn'),
     );
-    (toggleButton as HTMLButtonElement).click();
+    toggleButton.click();
     expect(spy).toHaveBeenCalled();
   });
 
   it('can trigger tree expansion on click of expand tree button', () => {
-    const spy = spyOn(component.treeNodeComponent.expandTreeChange, 'emit');
+    const spy = spyOn(
+      assertDefined(component.treeNodeComponent).expandTreeChange,
+      'emit',
+    );
     const expandButton = assertDefined(
-      htmlElement.querySelector('.expand-tree-btn'),
+      htmlElement.querySelector<HTMLElement>('.expand-tree-btn'),
     );
-    (expandButton as HTMLButtonElement).click();
+    expandButton.click();
     expect(spy).toHaveBeenCalled();
   });
 
-  it('can trigger node pin on click of star', () => {
-    component.treeNodeComponent.showPinNodeIcon = jasmine
+  it('assigns diff css classes to expand tree button', () => {
+    const expandButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.expand-tree-btn'),
+    );
+    expect(expandButton.className).toEqual('icon-button expand-tree-btn');
+    component.node = UiHierarchyTreeNode.from(
+      new HierarchyTreeBuilder()
+        .setId('LayerTraceEntry')
+        .setName('Added Diff')
+        .setChildren([
+          {id: 1, name: 'Child 1', children: [{id: 2, name: 'Child 2'}]},
+        ])
+        .build(),
+    );
+    component.node.getChildByName('Child 1')?.setDiff(DiffType.ADDED);
+    fixture.detectChanges();
+    expect(expandButton.className).toEqual('icon-button expand-tree-btn added');
+
+    component.node = UiHierarchyTreeNode.from(
+      new HierarchyTreeBuilder()
+        .setId('LayerTraceEntry')
+        .setName('Added Diff')
+        .setChildren([
+          {id: 1, name: 'Child 1', children: [{id: 2, name: 'Child 2'}]},
+        ])
+        .build(),
+    );
+    const child1 = assertDefined(component.node.getChildByName('Child 1'));
+    child1.setDiff(DiffType.ADDED);
+    child1.getChildByName('Child 2')?.setDiff(DiffType.DELETED);
+    fixture.detectChanges();
+    expect(expandButton.className).toEqual(
+      'icon-button expand-tree-btn modified',
+    );
+  });
+
+  it('pins node on click', () => {
+    const treeNodeComponent = assertDefined(component.treeNodeComponent);
+    treeNodeComponent.showPinNodeIcon = jasmine
       .createSpy()
       .and.returnValue(true);
     fixture.detectChanges();
 
-    const spy = spyOn(component.treeNodeComponent.pinNodeChange, 'emit');
+    const spy = spyOn(treeNodeComponent.pinNodeChange, 'emit');
     const pinNodeButton = assertDefined(
-      htmlElement.querySelector('.pin-node-btn'),
+      htmlElement.querySelector<HTMLElement>('.pin-node-btn'),
     );
-    (pinNodeButton as HTMLButtonElement).click();
-    expect(spy).toHaveBeenCalledWith(component.node);
+    pinNodeButton.click();
+    expect(spy).toHaveBeenCalledWith(component.node as UiHierarchyTreeNode);
   });
 
   it('can trigger rect show state toggle on click of icon', () => {
-    component.treeNodeComponent.showStateIcon = 'visibility';
+    const treeNodeComponent = assertDefined(component.treeNodeComponent);
+    treeNodeComponent.showStateIcon = 'visibility';
     fixture.detectChanges();
 
-    const spy = spyOn(component.treeNodeComponent.rectShowStateChange, 'emit');
-    const pinNodeButton = assertDefined(
-      htmlElement.querySelector('.toggle-rect-show-state-btn'),
+    const spy = spyOn(treeNodeComponent.rectShowStateChange, 'emit');
+    const showStateButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.toggle-rect-show-state-btn'),
     );
-    (pinNodeButton as HTMLButtonElement).click();
+    showStateButton.click();
     expect(spy).toHaveBeenCalled();
   });
 
+  it('does not show copy button for hierarchy tree', () => {
+    expect(htmlElement.querySelector('.icon-wrapper-copy')).toBeNull();
+  });
+
+  it('does not show copy button for property tree node that is not leaf or root', () => {
+    component.node = assertDefined(propertiesTree.getChildByName('key2'));
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.icon-wrapper-copy')).toBeNull();
+  });
+
+  it('copies node name for root of property tree node', () => {
+    component.node = propertiesTree;
+    fixture.detectChanges();
+    const copyButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.icon-wrapper-copy button'),
+    );
+    copyButton.click();
+    fixture.detectChanges();
+    expect(mockCopyText).toHaveBeenCalledWith(propertiesTree.name);
+  });
+
+  it('copies property name and value for leaf node', () => {
+    component.node = assertDefined(propertiesTree.getChildByName('key1'));
+    component.isLeaf = true;
+    fixture.detectChanges();
+    const copyButton = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.icon-wrapper-copy button'),
+    );
+    copyButton.click();
+    fixture.detectChanges();
+    expect(mockCopyText).toHaveBeenCalledWith('key1: value1');
+  });
+
   @Component({
     selector: 'host-component',
     template: `
       <tree-node
         [node]="node"
-        [isExpanded]="false"
+        [isExpanded]="isExpanded"
         [isPinned]="false"
         [isInPinnedSection]="false"
-        [isSelected]="isSelected"></tree-node>
+        [isSelected]="isSelected"
+        [isLeaf]="isLeaf"></tree-node>
     `,
   })
   class TestHostComponent {
-    node = UiHierarchyTreeNode.from(
+    node: UiHierarchyTreeNode | UiPropertyTreeNode = UiHierarchyTreeNode.from(
       new HierarchyTreeBuilder()
         .setId('LayerTraceEntry')
         .setName('4')
@@ -135,8 +236,10 @@ describe('TreeNodeComponent', () => {
     );
 
     isSelected = false;
+    isLeaf = false;
+    isExpanded = false;
 
     @ViewChild(TreeNodeComponent)
-    treeNodeComponent!: TreeNodeComponent;
+    treeNodeComponent: TreeNodeComponent | undefined;
   }
 });
diff --git a/tools/winscope/src/viewers/components/view_capture_property_groups_component.ts b/tools/winscope/src/viewers/components/view_capture_property_groups_component.ts
index ca80f4ac4..2eab13919 100644
--- a/tools/winscope/src/viewers/components/view_capture_property_groups_component.ts
+++ b/tools/winscope/src/viewers/components/view_capture_property_groups_component.ts
@@ -22,13 +22,13 @@ import {VcCuratedProperties} from 'viewers/common/curated_properties';
     <div *ngIf="properties" class="group view">
       <h3 class="group-header mat-subheading-2">View</h3>
       <div class="left-column class-name">
-        <p class="mat-body-1">
-          <span class="mat-body-2">Class: </span>
+        <p class="mat-body-2">
+          <span class="mat-body-1">Class: </span>
           &ngsp;
           {{ properties.className }}
         </p>
-        <p class="mat-body-1 hashcode">
-          <span class="mat-body-2">Hashcode: </span>
+        <p class="mat-body-2 hashcode">
+          <span class="mat-body-1">Hashcode: </span>
           &ngsp;
           {{ properties.hashcode }}
         </p>
@@ -39,31 +39,31 @@ import {VcCuratedProperties} from 'viewers/common/curated_properties';
       <h3 class="group-header mat-subheading-2">Geometry</h3>
       <div class="left-column coordinates">
         <p class="column-header mat-small">Coordinates</p>
-        <p class="mat-body-1 left">
-          <span class="mat-body-2">Left: </span>
+        <p class="mat-body-2 left">
+          <span class="mat-body-1">Left: </span>
           &ngsp;
           {{ properties.left }}
         </p>
-        <p class="mat-body-1 top">
-          <span class="mat-body-2">Top: </span>
+        <p class="mat-body-2 top">
+          <span class="mat-body-1">Top: </span>
           &ngsp;
           {{ properties.top }}
         </p>
-        <p class="mat-body-1 elevation">
-          <span class="mat-body-2">Elevation: </span>
+        <p class="mat-body-2 elevation">
+          <span class="mat-body-1">Elevation: </span>
           &ngsp;
           {{ properties.elevation }}
         </p>
       </div>
       <div class="right-column size">
         <p class="column-header mat-small">Size</p>
-        <p class="mat-body-1 height">
-          <span class="mat-body-2">Height: </span>
+        <p class="mat-body-2 height">
+          <span class="mat-body-1">Height: </span>
           &ngsp;
           {{ properties.height }}
         </p>
-        <p class="mat-body-1 width">
-          <span class="mat-body-2">Width: </span>
+        <p class="mat-body-2 width">
+          <span class="mat-body-1">Width: </span>
           &ngsp;
           {{ properties.width }}
         </p>
@@ -73,26 +73,26 @@ import {VcCuratedProperties} from 'viewers/common/curated_properties';
       <h3 class="group-header mat-subheading-2"></h3>
       <div class="left-column translation">
         <p class="column-header mat-small">Translation</p>
-        <p class="mat-body-1 translationx">
-          <span class="mat-body-2">Translation X: </span>
+        <p class="mat-body-2 translationx">
+          <span class="mat-body-1">Translation X: </span>
           &ngsp;
           {{ properties.translationX }}
         </p>
-        <p class="mat-body-1 translationy">
-          <span class="mat-body-2">Translation Y: </span>
+        <p class="mat-body-2 translationy">
+          <span class="mat-body-1">Translation Y: </span>
           &ngsp;
           {{ properties.translationY }}
         </p>
       </div>
       <div class="right-column scroll">
         <p class="column-header mat-small">Scroll</p>
-        <p class="mat-body-1 scrollx">
-          <span class="mat-body-2">Scroll X: </span>
+        <p class="mat-body-2 scrollx">
+          <span class="mat-body-1">Scroll X: </span>
           &ngsp;
           {{ properties.scrollX }}
         </p>
-        <p class="mat-body-1 scrolly">
-          <span class="mat-body-2">Scroll Y: </span>
+        <p class="mat-body-2 scrolly">
+          <span class="mat-body-1">Scroll Y: </span>
           &ngsp;
           {{ properties.scrollY }}
         </p>
@@ -102,13 +102,13 @@ import {VcCuratedProperties} from 'viewers/common/curated_properties';
       <h3 class="group-header mat-subheading-2"></h3>
       <div class="left-column scale">
         <p class="column-header mat-small">Scale</p>
-        <p class="mat-body-1 scalex">
-          <span class="mat-body-2">Scale X: </span>
+        <p class="mat-body-2 scalex">
+          <span class="mat-body-1">Scale X: </span>
           &ngsp;
           {{ properties.scaleX }}
         </p>
-        <p class="mat-body-1 scaley">
-          <span class="mat-body-2">Scale Y: </span>
+        <p class="mat-body-2 scaley">
+          <span class="mat-body-1">Scale Y: </span>
           &ngsp;
           {{ properties.scaleY }}
         </p>
@@ -119,26 +119,26 @@ import {VcCuratedProperties} from 'viewers/common/curated_properties';
       <h3 class="group-header mat-subheading-2">Effects</h3>
       <div class="left-column translation">
         <p class="column-header mat-small">Translation</p>
-        <p class="mat-body-1 visibility">
-          <span class="mat-body-2">Visibility: </span>
+        <p class="mat-body-2 visibility">
+          <span class="mat-body-1">Visibility: </span>
           &ngsp;
           {{ properties.visibility }}
         </p>
-        <p class="mat-body-1 alpha">
-          <span class="mat-body-2">Alpha: </span>
+        <p class="mat-body-2 alpha">
+          <span class="mat-body-1">Alpha: </span>
           &ngsp;
           {{ properties.alpha }}
         </p>
-        <p class="mat-body-1 will-not-draw">
-          <span class="mat-body-2">Will Not Draw: </span>
+        <p class="mat-body-2 will-not-draw">
+          <span class="mat-body-1">Will Not Draw: </span>
           &ngsp;
           {{ properties.willNotDraw }}
         </p>
       </div>
       <div class="right-column misc">
         <p class="column-header mat-small">Miscellaneous</p>
-        <p class="mat-body-1 clip-children">
-          <span class="mat-body-2">Clip Children: </span>
+        <p class="mat-body-2 clip-children">
+          <span class="mat-body-1">Clip Children: </span>
           &ngsp;
           {{ properties.clipChildren }}
         </p>
diff --git a/tools/winscope/src/viewers/components/viewer_input_method_component.ts b/tools/winscope/src/viewers/components/viewer_input_method_component.ts
index 882cd6aec..d9ade3592 100644
--- a/tools/winscope/src/viewers/components/viewer_input_method_component.ts
+++ b/tools/winscope/src/viewers/components/viewer_input_method_component.ts
@@ -40,10 +40,12 @@ import {viewerCardStyle} from './styles/viewer_card.styles';
           [highlightedItem]="inputData?.highlightedItem"
           [pinnedItems]="inputData?.pinnedItems ?? []"
           [tableProperties]="inputData?.hierarchyTableProperties"
+          [textFilter]="inputData?.hierarchyFilter"
           [store]="store"
           [userOptions]="inputData?.hierarchyUserOptions ?? {}"
           (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.HIERARCHY, true)"
-          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.HIERARCHY)"></hierarchy-view>
+          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.HIERARCHY)"
+          placeholderText="No IME entry found."></hierarchy-view>
         <ime-additional-properties
           class="ime-additional-properties"
           [isImeManagerService]="isImeManagerService()"
@@ -59,8 +61,10 @@ import {viewerCardStyle} from './styles/viewer_card.styles';
         [userOptions]="inputData?.propertiesUserOptions ?? {}"
         [propertiesTree]="inputData?.propertiesTree"
         [traceType]="inputData?.traceType"
+        [textFilter]="inputData?.propertiesFilter"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"
-        [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES)"></properties-view>
+        [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES)"
+        placeholderText="No selected item."></properties-view>
     </div>
   `,
   styles: [
diff --git a/tools/winscope/src/viewers/components/viewer_input_method_component_test.ts b/tools/winscope/src/viewers/components/viewer_input_method_component_test.ts
index 4fd9bd1fb..6759f71b2 100644
--- a/tools/winscope/src/viewers/components/viewer_input_method_component_test.ts
+++ b/tools/winscope/src/viewers/components/viewer_input_method_component_test.ts
@@ -26,6 +26,8 @@ import {MatDividerModule} from '@angular/material/divider';
 import {MatIconModule} from '@angular/material/icon';
 import {MatTooltipModule} from '@angular/material/tooltip';
 import {UnitTestUtils} from 'test/unit/utils';
+import {TraceType} from 'trace/trace_type';
+import {ImeUiData} from 'viewers/common/ime_ui_data';
 import {CollapsedSectionsComponent} from './collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from './collapsible_section_title_component';
 import {HierarchyComponent} from './hierarchy_component';
@@ -61,6 +63,7 @@ describe('ViewerInputMethodComponent', () => {
     fixture = TestBed.createComponent(ViewerInputMethodComponent);
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
+    component.inputData = new ImeUiData(TraceType.INPUT_METHOD_CLIENTS);
     fixture.detectChanges();
   });
 
diff --git a/tools/winscope/src/viewers/viewer_factory.ts b/tools/winscope/src/viewers/viewer_factory.ts
index 61b9a65d4..cc9105780 100644
--- a/tools/winscope/src/viewers/viewer_factory.ts
+++ b/tools/winscope/src/viewers/viewer_factory.ts
@@ -15,16 +15,19 @@
  */
 
 import {assertTrue} from 'common/assert_utils';
+import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType, TraceTypeUtils} from 'trace/trace_type';
 import {Viewer} from './viewer';
+import {ViewerInput} from './viewer_input/viewer_input';
 import {ViewerInputMethodClients} from './viewer_input_method_clients/viewer_input_method_clients';
 import {ViewerInputMethodManagerService} from './viewer_input_method_manager_service/viewer_input_method_manager_service';
 import {ViewerInputMethodService} from './viewer_input_method_service/viewer_input_method_service';
+import {ViewerJankCujs} from './viewer_jank_cujs/viewer_jank_cujs';
+import {ViewerScreenshot} from './viewer_media_based/viewer_screenshot';
+import {ViewerScreenRecording} from './viewer_media_based/viewer_screen_recording';
 import {ViewerProtoLog} from './viewer_protolog/viewer_protolog';
-import {ViewerScreenshot} from './viewer_screen_recording/viewer_screenshot';
-import {ViewerScreenRecording} from './viewer_screen_recording/viewer_screen_recording';
 import {ViewerSurfaceFlinger} from './viewer_surface_flinger/viewer_surface_flinger';
 import {ViewerTransactions} from './viewer_transactions/viewer_transactions';
 import {ViewerTransitions} from './viewer_transitions/viewer_transitions';
@@ -32,7 +35,7 @@ import {ViewerViewCapture} from './viewer_view_capture/viewer_view_capture';
 import {ViewerWindowManager} from './viewer_window_manager/viewer_window_manager';
 
 class ViewerFactory {
-  static readonly VIEWERS = [
+  static readonly SINGLE_TRACE_VIEWERS = [
     ViewerSurfaceFlinger,
     ViewerWindowManager,
     ViewerInputMethodClients,
@@ -40,17 +43,23 @@ class ViewerFactory {
     ViewerInputMethodService,
     ViewerTransactions,
     ViewerProtoLog,
+    ViewerTransitions,
+    ViewerJankCujs,
+  ];
+
+  static readonly MULTI_TRACE_VIEWERS = [
+    ViewerViewCapture,
+    ViewerInput,
     ViewerScreenRecording,
     ViewerScreenshot,
-    ViewerTransitions,
   ];
 
-  createViewers(traces: Traces, storage: Storage): Viewer[] {
+  createViewers(traces: Traces, storage: Store): Viewer[] {
     const viewers: Viewer[] = [];
 
-    // regular viewers
+    // instantiate one viewer for one trace
     traces.forEachTrace((trace) => {
-      ViewerFactory.VIEWERS.forEach((Viewer) => {
+      ViewerFactory.SINGLE_TRACE_VIEWERS.forEach((Viewer) => {
         assertTrue(Viewer.DEPENDENCIES.length === 1);
         const isViewerDepSatisfied = trace.type === Viewer.DEPENDENCIES[0];
         if (isViewerDepSatisfied) {
@@ -59,14 +68,17 @@ class ViewerFactory {
       });
     });
 
-    // ViewCapture viewer (instantiate one viewer for N ViewCapture traces)
+    // instantiate one viewer for N traces
     const availableTraceTypes = new Set(traces.mapTrace((trace) => trace.type));
-    const isViewerDepSatisfied = ViewerViewCapture.DEPENDENCIES.some(
-      (traceType: TraceType) => availableTraceTypes.has(traceType),
-    );
-    if (isViewerDepSatisfied) {
-      viewers.push(new ViewerViewCapture(traces, storage));
-    }
+
+    ViewerFactory.MULTI_TRACE_VIEWERS.forEach((Viewer) => {
+      const isViewerDepSatisfied = Viewer.DEPENDENCIES.some(
+        (traceType: TraceType) => availableTraceTypes.has(traceType),
+      );
+      if (isViewerDepSatisfied) {
+        viewers.push(new Viewer(traces, storage));
+      }
+    });
 
     // Note:
     // the final order of tabs/views in the UI corresponds the order of the
diff --git a/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts
new file mode 100644
index 000000000..3bd80ec6e
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter.ts
@@ -0,0 +1,84 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {FixedStringFormatter} from 'trace/tree_node/formatters';
+import {Operation} from 'trace/tree_node/operations/operation';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+
+export class DispatchEntryFormatter implements Operation<UiPropertyTreeNode> {
+  static readonly AXIS_X = 0;
+  static readonly AXIS_Y = 1;
+
+  constructor(private readonly layerIdToName: Map<number, string>) {}
+
+  apply(node: UiPropertyTreeNode): void {
+    node.getAllChildren().forEach((dispatchEntry) => {
+      this.formatTargetWindow(dispatchEntry);
+      this.formatDispatchedPointers(dispatchEntry);
+    });
+  }
+
+  private formatTargetWindow(dispatchEntry: UiPropertyTreeNode) {
+    const windowIdNode = dispatchEntry.getChildByName('windowId');
+    if (windowIdNode === undefined) {
+      return;
+    }
+    windowIdNode.setDisplayName('TargetWindow');
+    const windowId = Number(windowIdNode.getValue() ?? -1);
+    const layerName = this.layerIdToName.get(windowId);
+    windowIdNode.setFormatter(
+      new FixedStringFormatter(
+        `${windowId} - ${layerName ?? '<Unknown Name>'}`,
+      ),
+    );
+  }
+
+  private formatDispatchedPointers(dispatchEntry: UiPropertyTreeNode) {
+    const dispatchedPointerNode =
+      dispatchEntry.getChildByName('dispatchedPointer');
+    if (dispatchedPointerNode === undefined) {
+      return;
+    }
+    dispatchedPointerNode.setDisplayName('DispatchedPointersInWindowSpace');
+    let formattedPointers = '';
+    dispatchedPointerNode.getAllChildren()?.forEach((pointer) => {
+      const axisValues = pointer.getChildByName('axisValueInWindow');
+      let x = '';
+      let y = '';
+      axisValues?.getAllChildren()?.forEach((axisValue) => {
+        const axis = Number(axisValue.getChildByName('axis')?.getValue());
+        if (axis === DispatchEntryFormatter.AXIS_X) {
+          x = axisValue.getChildByName('value')?.getValue() ?? '?';
+          return;
+        }
+        if (axis === DispatchEntryFormatter.AXIS_Y) {
+          y = axisValue.getChildByName('value')?.getValue() ?? '?';
+          return;
+        }
+      });
+      if (formattedPointers.length > 0) {
+        formattedPointers += ', ';
+      }
+      formattedPointers += `(${x}, ${y})`;
+    });
+    if (formattedPointers.length === 0) {
+      formattedPointers = '<none>';
+    }
+    dispatchedPointerNode.setFormatter(
+      new FixedStringFormatter(formattedPointers),
+    );
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter_test.ts b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter_test.ts
new file mode 100644
index 000000000..399dfaff7
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/operations/dispatch_entry_formatter_test.ts
@@ -0,0 +1,223 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+import {DispatchEntryFormatter} from './dispatch_entry_formatter';
+
+describe('DispatchEntryFormatter', () => {
+  let operation: DispatchEntryFormatter;
+  const layerIdToName = new Map<number, string>([
+    [1, 'one'],
+    [2, 'two'],
+  ]);
+
+  beforeEach(() => {
+    operation = new DispatchEntryFormatter(layerIdToName);
+  });
+
+  it('formats windowId node', () => {
+    const dispatchEntries = new PropertyTreeBuilder()
+      .setRootId('entries')
+      .setName('dispatchEntries');
+    dispatchEntries.setChildren([
+      {name: '0', children: [{name: 'windowId', value: 0}]},
+      {name: '1', children: [{name: 'windowId', value: 1}]},
+      {name: '2', children: [{name: 'windowId', value: 2}]},
+    ]);
+
+    const root = UiPropertyTreeNode.from(dispatchEntries.build());
+
+    operation.apply(root);
+    expect(
+      root.getChildByName('0')?.getChildByName('windowId')?.getDisplayName(),
+    ).toEqual('TargetWindow');
+    expect(
+      root.getChildByName('0')?.getChildByName('windowId')?.formattedValue(),
+    ).toEqual('0 - <Unknown Name>');
+    expect(
+      root.getChildByName('1')?.getChildByName('windowId')?.getDisplayName(),
+    ).toEqual('TargetWindow');
+    expect(
+      root.getChildByName('1')?.getChildByName('windowId')?.formattedValue(),
+    ).toEqual('1 - one');
+    expect(
+      root.getChildByName('2')?.getChildByName('windowId')?.getDisplayName(),
+    ).toEqual('TargetWindow');
+    expect(
+      root.getChildByName('2')?.getChildByName('windowId')?.formattedValue(),
+    ).toEqual('2 - two');
+  });
+
+  it('formats dispatched pointers', () => {
+    const dispatchEntries = new PropertyTreeBuilder()
+      .setRootId('entries')
+      .setName('dispatchEntries');
+    dispatchEntries.setChildren([
+      {name: '0', children: [{name: 'dispatchedPointer', children: []}]},
+      {
+        name: '1',
+        children: [
+          {
+            name: 'dispatchedPointer',
+            children: [
+              {
+                name: '0',
+                children: [
+                  {
+                    name: 'axisValueInWindow',
+                    children: [
+                      {
+                        name: '0',
+                        children: [
+                          {name: 'axis', value: 0},
+                          {
+                            name: 'value',
+                            value: 2,
+                          },
+                        ],
+                      },
+                      {
+                        name: '1',
+                        children: [
+                          {name: 'axis', value: 1},
+                          {
+                            name: 'value',
+                            value: 3,
+                          },
+                        ],
+                      },
+                    ],
+                  },
+                ],
+              },
+            ],
+          },
+        ],
+      },
+      {
+        name: '2',
+        children: [
+          {
+            name: 'dispatchedPointer',
+            children: [
+              {
+                name: '0',
+                children: [
+                  {
+                    name: 'axisValueInWindow',
+                    children: [
+                      {
+                        name: '0',
+                        children: [
+                          {name: 'axis', value: 0},
+                          {
+                            name: 'value',
+                            value: 4,
+                          },
+                        ],
+                      },
+                      {
+                        name: '1',
+                        children: [
+                          {name: 'axis', value: 1},
+                          {
+                            name: 'value',
+                          },
+                        ],
+                      },
+                    ],
+                  },
+                ],
+              },
+              {
+                name: '2',
+                children: [
+                  {
+                    name: 'axisValueInWindow',
+                    children: [
+                      {
+                        name: '0',
+                        children: [
+                          {name: 'axis', value: 0},
+                          {
+                            name: 'value',
+                            value: 5,
+                          },
+                        ],
+                      },
+                      {
+                        name: '1',
+                        children: [
+                          {name: 'axis', value: 1},
+                          {
+                            name: 'value',
+                            value: 6,
+                          },
+                        ],
+                      },
+                    ],
+                  },
+                ],
+              },
+            ],
+          },
+        ],
+      },
+    ]);
+
+    const root = UiPropertyTreeNode.from(dispatchEntries.build());
+
+    operation.apply(root);
+    expect(
+      root
+        .getChildByName('0')
+        ?.getChildByName('dispatchedPointer')
+        ?.getDisplayName(),
+    ).toEqual('DispatchedPointersInWindowSpace');
+    expect(
+      root
+        .getChildByName('0')
+        ?.getChildByName('dispatchedPointer')
+        ?.formattedValue(),
+    ).toEqual('<none>');
+    expect(
+      root
+        .getChildByName('1')
+        ?.getChildByName('dispatchedPointer')
+        ?.getDisplayName(),
+    ).toEqual('DispatchedPointersInWindowSpace');
+    expect(
+      root
+        .getChildByName('1')
+        ?.getChildByName('dispatchedPointer')
+        ?.formattedValue(),
+    ).toEqual('(2, 3)');
+
+    expect(
+      root
+        .getChildByName('2')
+        ?.getChildByName('dispatchedPointer')
+        ?.getDisplayName(),
+    ).toEqual('DispatchedPointersInWindowSpace');
+    expect(
+      root
+        .getChildByName('2')
+        ?.getChildByName('dispatchedPointer')
+        ?.formattedValue(),
+    ).toEqual('(4, ?), (5, 6)');
+  });
+});
diff --git a/tools/winscope/src/viewers/viewer_input/presenter.ts b/tools/winscope/src/viewers/viewer_input/presenter.ts
new file mode 100644
index 000000000..cf3152d56
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/presenter.ts
@@ -0,0 +1,410 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
+import {TabbedViewSwitchRequest} from 'messaging/winscope_event';
+import {CustomQueryType} from 'trace/custom_query';
+import {Trace, TraceEntry} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {VISIBLE_CHIP} from 'viewers/common/chip';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {UI_RECT_FACTORY} from 'viewers/common/ui_rect_factory';
+import {UserOptions} from 'viewers/common/user_options';
+import {ViewerEvents} from 'viewers/common/viewer_events';
+import {
+  convertRectIdToLayerorDisplayName,
+  makeDisplayIdentifiers,
+} from 'viewers/viewer_surface_flinger/presenter';
+import {DispatchEntryFormatter} from './operations/dispatch_entry_formatter';
+import {InputEntry, UiData} from './ui_data';
+
+enum InputEventType {
+  KEY,
+  MOTION,
+}
+
+export class Presenter extends AbstractLogViewerPresenter<UiData> {
+  static readonly FIELD_TYPES = [
+    LogFieldType.INPUT_TYPE,
+    LogFieldType.INPUT_SOURCE,
+    LogFieldType.INPUT_ACTION,
+    LogFieldType.INPUT_DEVICE_ID,
+    LogFieldType.INPUT_DISPLAY_ID,
+    LogFieldType.INPUT_EVENT_DETAILS,
+  ];
+
+  static readonly DENYLIST_DISPATCH_PROPERTIES = ['eventId'];
+
+  private readonly traces: Traces;
+  private readonly surfaceFlingerTrace: Trace<HierarchyTreeNode> | undefined;
+  protected override uiData: UiData = UiData.createEmpty();
+  private allEntries: InputEntry[] | undefined;
+
+  private readonly layerIdToName = new Map<number, string>();
+  private readonly allInputLayerIds = new Set<number>();
+
+  protected override logPresenter = new LogPresenter<InputEntry>();
+  protected override propertiesPresenter = new PropertiesPresenter(
+    {},
+    undefined,
+    [],
+  );
+  protected dispatchPropertiesPresenter = new PropertiesPresenter(
+    {},
+    undefined,
+    Presenter.DENYLIST_DISPATCH_PROPERTIES,
+    [new DispatchEntryFormatter(this.layerIdToName)],
+  );
+  private readonly currentTargetWindowIds = new Set<string>();
+
+  private readonly rectsPresenter = new RectsPresenter(
+    PersistentStoreProxy.new<UserOptions>(
+      'InputWindowRectsOptions',
+      {
+        showOnlyWithContent: {
+          name: 'Has input',
+          icon: 'pan_tool_alt',
+          enabled: false,
+        },
+        showOnlyVisible: {
+          name: 'Show only',
+          chip: VISIBLE_CHIP,
+          enabled: true,
+        },
+      },
+      this.storage,
+    ),
+    (tree: HierarchyTreeNode) =>
+      UI_RECT_FACTORY.makeInputRects(tree, (id) =>
+        this.currentTargetWindowIds.has(id),
+      ),
+    makeDisplayIdentifiers,
+    convertRectIdToLayerorDisplayName,
+  );
+
+  constructor(
+    traces: Traces,
+    mergedInputEventTrace: Trace<PropertyTreeNode>,
+    private readonly storage: Store,
+    readonly notifyInputViewCallback: NotifyLogViewCallbackType<UiData>,
+  ) {
+    const uiData = UiData.createEmpty();
+    uiData.isDarkMode = storage.get('dark-mode') === 'true';
+    super(
+      mergedInputEventTrace,
+      (uiData) => notifyInputViewCallback(uiData as UiData),
+      uiData,
+    );
+    this.traces = traces;
+    this.surfaceFlingerTrace = this.traces.getTrace(TraceType.SURFACE_FLINGER);
+  }
+
+  protected override async initializeIfNeeded() {
+    if (this.allEntries !== undefined) {
+      return;
+    }
+
+    if (this.surfaceFlingerTrace !== undefined) {
+      const layerMappings = await this.surfaceFlingerTrace.customQuery(
+        CustomQueryType.SF_LAYERS_ID_AND_NAME,
+      );
+      layerMappings.forEach(({id, name}) => this.layerIdToName.set(id, name));
+    }
+
+    this.allEntries = await this.makeInputEntries();
+
+    this.logPresenter.setAllEntries(this.allEntries);
+    this.logPresenter.setHeaders(Presenter.FIELD_TYPES);
+    this.logPresenter.setFilters([
+      {
+        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
+        options: [...this.allInputLayerIds.values()].map((layerId) => {
+          return this.getLayerDisplayName(layerId);
+        }),
+      },
+    ]);
+
+    this.refreshUiData();
+  }
+
+  private async makeInputEntries(): Promise<InputEntry[]> {
+    const entries: InputEntry[] = [];
+    for (let i = 0; i < this.trace.lengthEntries; i++) {
+      const entry = assertDefined(this.trace.getEntry(i));
+      const wrapperTree = await entry.getValue();
+
+      let type = InputEventType.KEY;
+      let eventTree = wrapperTree.getChildByName('keyEvent');
+      if (eventTree === undefined || eventTree.getAllChildren().length === 0) {
+        eventTree = assertDefined(wrapperTree.getChildByName('motionEvent'));
+        type = InputEventType.MOTION;
+      }
+      eventTree.setIsRoot(true);
+
+      const dispatchTree = assertDefined(
+        wrapperTree.getChildByName('windowDispatchEvents'),
+      );
+      dispatchTree.setIsRoot(true);
+      dispatchTree.getAllChildren().forEach((dispatchEntry) => {
+        const windowIdNode = dispatchEntry.getChildByName('windowId');
+        const windowId = Number(windowIdNode?.getValue() ?? -1);
+        this.allInputLayerIds.add(windowId);
+      });
+
+      let sfEntry: TraceEntry<HierarchyTreeNode> | undefined;
+      if (this.surfaceFlingerTrace !== undefined && this.trace.hasFrameInfo()) {
+        const frame = entry.getFramesRange()?.start;
+        if (frame !== undefined) {
+          const sfFrame = this.surfaceFlingerTrace.getFrame(frame);
+          if (sfFrame.lengthEntries > 0) {
+            sfEntry = sfFrame.getEntry(0);
+          }
+        }
+      }
+
+      entries.push(
+        new InputEntry(
+          entry,
+          this.extractLogFields(eventTree, dispatchTree, type),
+          eventTree,
+          dispatchTree,
+          sfEntry,
+        ),
+      );
+    }
+    return Promise.resolve(entries);
+  }
+
+  private getLayerDisplayName(layerId: number): string {
+    // Surround the name using the invisible zero-width non-joiner character to ensure
+    // the full string is matched while filtering.
+    return `\u{200C}${
+      this.layerIdToName.get(layerId) ?? layerId.toString()
+    }\u{200C}`;
+  }
+
+  private extractLogFields(
+    eventTree: PropertyTreeNode,
+    dispatchTree: PropertyTreeNode,
+    type: InputEventType,
+  ): LogField[] {
+    const targetWindows: string[] = [];
+    dispatchTree.getAllChildren().forEach((dispatchEntry) => {
+      const windowId = Number(
+        dispatchEntry.getChildByName('windowId')?.getValue() ?? -1,
+      );
+      targetWindows.push(this.getLayerDisplayName(windowId));
+    });
+
+    return [
+      {
+        type: LogFieldType.INPUT_TYPE,
+        value: type === InputEventType.KEY ? 'KEY' : 'MOTION',
+      },
+      {
+        type: LogFieldType.INPUT_SOURCE,
+        value: assertDefined(eventTree.getChildByName('source'))
+          .formattedValue()
+          .replace('SOURCE_', ''),
+      },
+      {
+        type: LogFieldType.INPUT_ACTION,
+        value: assertDefined(eventTree.getChildByName('action'))
+          .formattedValue()
+          .replace('ACTION_', ''),
+      },
+      {
+        type: LogFieldType.INPUT_DEVICE_ID,
+        value: assertDefined(eventTree.getChildByName('deviceId')).getValue(),
+      },
+      {
+        type: LogFieldType.INPUT_DISPLAY_ID,
+        value: assertDefined(eventTree.getChildByName('displayId')).getValue(),
+      },
+      {
+        type: LogFieldType.INPUT_EVENT_DETAILS,
+        value:
+          type === InputEventType.KEY
+            ? Presenter.extractKeyDetails(eventTree)
+            : Presenter.extractMotionDetails(eventTree),
+      },
+      {
+        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
+        value: targetWindows.join(', '),
+      },
+    ];
+  }
+
+  private static extractKeyDetails(eventTree: PropertyTreeNode): string {
+    return (
+      'Keycode: ' + eventTree.getChildByName('keyCode')?.formattedValue() ??
+      'not present'
+    );
+  }
+
+  private static extractMotionDetails(eventTree: PropertyTreeNode): string {
+    let details = '';
+    const pointers =
+      eventTree.getChildByName('pointer')?.getAllChildren() ?? [];
+    pointers.forEach((pointer) => {
+      const id = pointer.getChildByName('pointerId')?.formattedValue() ?? '?';
+      let x = '?';
+      let y = '?';
+      const axisValues =
+        pointer.getChildByName('axisValue')?.getAllChildren() ?? [];
+      axisValues.forEach((axisValue) => {
+        if (axisValue.getChildByName('axis')?.formattedValue() === 'AXIS_X') {
+          x = axisValue.getChildByName('value')?.getValue();
+          return;
+        }
+        if (axisValue.getChildByName('axis')?.formattedValue() === 'AXIS_Y') {
+          y = axisValue.getChildByName('value')?.getValue();
+          return;
+        }
+      });
+
+      if (details.length !== 0) {
+        details += ', ';
+      }
+      details += '[' + id + ': (' + x + ', ' + y + ')]';
+    });
+    return details;
+  }
+
+  protected override async updatePropertiesTree() {
+    await super.updatePropertiesTree();
+
+    const inputEntry = this.getCurrentEntry();
+    const tree = inputEntry?.dispatchPropertiesTree;
+    this.dispatchPropertiesPresenter.setPropertiesTree(tree);
+    await this.dispatchPropertiesPresenter.formatPropertiesTree(
+      undefined,
+      undefined,
+      this.keepCalculated ?? false,
+    );
+    this.uiData.dispatchPropertiesTree =
+      this.dispatchPropertiesPresenter.getFormattedTree();
+
+    await this.updateRects();
+  }
+
+  private async updateRects() {
+    if (this.surfaceFlingerTrace === undefined) {
+      return;
+    }
+    const inputEntry = this.getCurrentEntry();
+
+    this.currentTargetWindowIds.clear();
+    inputEntry?.dispatchPropertiesTree
+      ?.getAllChildren()
+      ?.forEach((dispatchEntry) => {
+        const windowId = dispatchEntry.getChildByName('windowId');
+        if (windowId !== undefined) {
+          this.currentTargetWindowIds.add(`${Number(windowId.getValue())}`);
+        }
+      });
+
+    if (inputEntry?.surfaceFlingerEntry !== undefined) {
+      const node = await inputEntry.surfaceFlingerEntry.getValue();
+      this.rectsPresenter.applyHierarchyTreesChange([
+        [this.surfaceFlingerTrace, [node]],
+      ]);
+      this.uiData.rectsToDraw = this.rectsPresenter.getRectsToDraw();
+      this.uiData.rectIdToShowState =
+        this.rectsPresenter.getRectIdToShowState();
+    } else {
+      this.uiData.rectsToDraw = [];
+      this.uiData.rectIdToShowState = undefined;
+    }
+    this.uiData.rectsUserOptions = this.rectsPresenter.getUserOptions();
+    this.uiData.displays = this.rectsPresenter.getDisplays();
+  }
+
+  private getCurrentEntry(): InputEntry | undefined {
+    const entries = this.logPresenter.getFilteredEntries();
+    const selectedIndex = this.logPresenter.getSelectedIndex();
+    const currentIndex = this.logPresenter.getCurrentIndex();
+    const index = selectedIndex ?? currentIndex;
+    if (index === undefined) {
+      return undefined;
+    }
+    return entries[index];
+  }
+
+  override addEventListeners(htmlElement: HTMLElement) {
+    super.addEventListeners(htmlElement);
+
+    htmlElement.addEventListener(
+      ViewerEvents.HighlightedPropertyChange,
+      (event) =>
+        this.onHighlightedPropertyChange((event as CustomEvent).detail.id),
+    );
+
+    htmlElement.addEventListener(ViewerEvents.HighlightedIdChange, (event) =>
+      this.onHighlightedIdChange((event as CustomEvent).detail.id),
+    );
+
+    htmlElement.addEventListener(
+      ViewerEvents.RectsUserOptionsChange,
+      async (event) => {
+        await this.onRectsUserOptionsChange(
+          (event as CustomEvent).detail.userOptions,
+        );
+      },
+    );
+
+    htmlElement.addEventListener(ViewerEvents.RectsDblClick, async (event) => {
+      await this.onRectDoubleClick();
+    });
+  }
+
+  onHighlightedPropertyChange(id: string) {
+    this.propertiesPresenter.applyHighlightedPropertyChange(id);
+    this.dispatchPropertiesPresenter.applyHighlightedPropertyChange(id);
+    this.uiData.highlightedProperty = id;
+    this.notifyViewChanged();
+  }
+
+  async onHighlightedIdChange(id: string) {
+    this.uiData.highlightedRect = id;
+    await this.updateRects();
+    this.notifyViewChanged();
+  }
+
+  async onRectsUserOptionsChange(userOptions: UserOptions) {
+    this.rectsPresenter.applyRectsUserOptionsChange(userOptions);
+    await this.updateRects();
+    this.notifyViewChanged();
+  }
+
+  async onRectDoubleClick() {
+    await this.emitAppEvent(
+      new TabbedViewSwitchRequest(assertDefined(this.surfaceFlingerTrace)),
+    );
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_input/presenter_test.ts b/tools/winscope/src/viewers/viewer_input/presenter_test.ts
new file mode 100644
index 000000000..be906e693
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/presenter_test.ts
@@ -0,0 +1,648 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANYf KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
+import {TracePositionUpdate} from 'messaging/winscope_event';
+import {Transform} from 'parsers/surface_flinger/transform_utils';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TracesBuilder} from 'test/unit/traces_builder';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {CustomQueryType} from 'trace/custom_query';
+import {Parser} from 'trace/parser';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceRectBuilder} from 'trace/trace_rect_builder';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {
+  LogFieldType,
+  LogFieldValue,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+
+class PresenterInputTest extends AbstractLogViewerPresenterTest<UiData> {
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private surfaceFlingerTrace: Trace<HierarchyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private secondPositionUpdate: TracePositionUpdate | undefined;
+  private layerIdToName: Array<{id: number; name: string}> = [
+    {id: 0, name: 'win-zero-not-98'},
+    {id: 212, name: 'win-212'},
+    {id: 64, name: 'win-64'},
+    {id: 82, name: 'win-82'},
+    {id: 75, name: 'win-75'},
+    // The layer name for window with id 98 is omitted to test incomplete mapping.
+  ];
+
+  override readonly shouldExecuteHeaderTests = true;
+  override readonly shouldExecuteFilterTests = true;
+  override readonly shouldExecutePropertiesTests = true;
+
+  override readonly totalOutputEntries = 8;
+  override readonly expectedIndexOfFirstPositionUpdate = 0;
+  override readonly expectedIndexOfSecondPositionUpdate = 2;
+  override readonly logEntryClickIndex = 3;
+  override readonly expectedInitialFilterOptions = new Map<
+    LogFieldType,
+    string[] | number
+  >([
+    [
+      LogFieldType.INPUT_DISPATCH_WINDOWS,
+      [
+        wrappedName('win-212'),
+        wrappedName('win-64'),
+        wrappedName('win-82'),
+        wrappedName('win-75'),
+        wrappedName('win-zero-not-98'),
+        wrappedName('98'),
+      ],
+    ],
+  ]);
+  override readonly filterValuesToSet = new Map<
+    LogFieldType,
+    Array<string | string[]>
+  >([
+    [
+      LogFieldType.INPUT_DISPATCH_WINDOWS,
+      [
+        // Case 1: No filter.
+        [],
+        // Case 2: The second entry is dispatched only to window '98'. Also ensure
+        // that this does not match events dispatched to window 'win-zero-not-98'.
+        [wrappedName('98')],
+        // Case 3: Events dispatched to 64 are also dispatched to other windows.
+        [wrappedName('win-64')],
+        // Case 4: Multiple filters that match all events.
+        [wrappedName('win-zero-not-98'), wrappedName('98')],
+      ],
+    ],
+  ]);
+  override readonly expectedFieldValuesAfterFilter = new Map<
+    LogFieldType,
+    Array<LogFieldValue[] | number>
+  >([
+    [
+      LogFieldType.INPUT_DISPATCH_WINDOWS,
+      [
+        // Case 1
+        this.totalOutputEntries,
+        // Case 2
+        [wrappedName('98')],
+        // Case 3
+        [
+          [
+            wrappedName('win-212'),
+            wrappedName('win-64'),
+            wrappedName('win-82'),
+            wrappedName('win-75'),
+            wrappedName('win-zero-not-98'),
+          ].join(', '),
+        ],
+        // Case 4
+        this.totalOutputEntries,
+      ],
+    ],
+  ]);
+
+  override readonly filterNameForCurrentIndexTest =
+    LogFieldType.INPUT_DISPATCH_WINDOWS;
+  override readonly filterChangeForCurrentIndexTest = [wrappedName('98')];
+  override readonly secondFilterChangeForCurrentIndexTest = [
+    wrappedName('98'),
+    wrappedName('515'),
+  ];
+  override readonly expectedCurrentIndexAfterFilterChange = 0;
+  override readonly expectedCurrentIndexAfterSecondFilterChange = 0;
+
+  override async setUpTestEnvironment(): Promise<void> {
+    const parser = (await UnitTestUtils.getTracesParser([
+      'traces/perfetto/input-events.perfetto-trace',
+    ])) as Parser<PropertyTreeNode>;
+
+    this.trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.INPUT_EVENT_MERGED)
+      .setParser(parser)
+      .build();
+
+    this.surfaceFlingerTrace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.SURFACE_FLINGER)
+      .setEntries([])
+      .setParserCustomQueryResult(
+        CustomQueryType.SF_LAYERS_ID_AND_NAME,
+        this.layerIdToName,
+      )
+      .build();
+
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
+    );
+    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(2),
+    );
+  }
+
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const traces = new TracesBuilder()
+      .setEntries(TraceType.INPUT_EVENT_MERGED, [])
+      .build();
+    if (this.surfaceFlingerTrace !== undefined) {
+      traces.addTrace(this.surfaceFlingerTrace);
+    }
+    return PresenterInputTest.createPresenterWithTraces(traces, callback);
+  }
+
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const traces = new Traces();
+    traces.addTrace(assertDefined(this.trace));
+    if (this.surfaceFlingerTrace !== undefined) {
+      traces.addTrace(this.surfaceFlingerTrace);
+    }
+    const presenter = PresenterInputTest.createPresenterWithTraces(
+      traces,
+      callback,
+    );
+    await presenter.onAppEvent(this.getPositionUpdate()); // trigger initialization
+    return presenter;
+  }
+
+  private static createPresenterWithTraces(
+    traces: Traces,
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Presenter {
+    return new Presenter(
+      traces,
+      assertDefined(traces.getTrace(TraceType.INPUT_EVENT_MERGED)),
+      new InMemoryStorage(),
+      callback,
+    );
+  }
+
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
+  }
+
+  override getSecondPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.secondPositionUpdate);
+  }
+
+  override executePropertiesChecksForEmptyTrace(uiDataLog: UiDataLog) {
+    const uiData = uiDataLog as UiData;
+    expect(uiData.highlightedProperty).toBeFalsy();
+    expect(uiData.dispatchPropertiesTree).toBeUndefined();
+  }
+
+  override executePropertiesChecksAfterPositionUpdate(
+    uiDataLog: UiDataLog,
+  ): void {
+    expect(uiDataLog.entries.length).toEqual(8);
+    expect(uiDataLog.currentIndex).toEqual(0);
+    expect(uiDataLog.selectedIndex).toBeUndefined();
+    const curEntry = uiDataLog.entries[0];
+    const expectedFields = [
+      {
+        type: LogFieldType.INPUT_TYPE,
+        value: 'MOTION',
+      },
+      {
+        type: LogFieldType.INPUT_SOURCE,
+        value: 'TOUCHSCREEN',
+      },
+      {
+        type: LogFieldType.INPUT_ACTION,
+        value: 'DOWN',
+      },
+      {
+        type: LogFieldType.INPUT_EVENT_DETAILS,
+        value: '[0: (431, 624)]',
+      },
+      {
+        type: LogFieldType.INPUT_DISPATCH_WINDOWS,
+        value: [
+          wrappedName('win-212'),
+          wrappedName('win-64'),
+          wrappedName('win-82'),
+          wrappedName('win-75'),
+          wrappedName('win-zero-not-98'),
+        ].join(', '),
+      },
+    ];
+    expectedFields.forEach((field) => {
+      expect(curEntry.fields).toContain(field);
+    });
+
+    const motionEvent = assertDefined(uiDataLog.propertiesTree);
+    expect(motionEvent.getChildByName('eventId')?.getValue()).toEqual(
+      330184796,
+    );
+    expect(motionEvent.getChildByName('action')?.formattedValue()).toEqual(
+      'ACTION_DOWN',
+    );
+
+    const uiData = uiDataLog as UiData;
+    const dispatchProperties = assertDefined(uiData.dispatchPropertiesTree);
+    expect(dispatchProperties.getAllChildren().length).toEqual(5);
+
+    expect(
+      dispatchProperties
+        .getChildByName('0')
+        ?.getChildByName('windowId')
+        ?.getDisplayName(),
+    ).toEqual('TargetWindow');
+    expect(
+      dispatchProperties
+        .getChildByName('0')
+        ?.getChildByName('windowId')
+        ?.formattedValue(),
+    ).toEqual('212 - win-212');
+  }
+
+  private expectEventPresented(
+    uiData: UiData,
+    eventId: number,
+    action: string,
+  ) {
+    const properties = assertDefined(uiData.propertiesTree);
+    expect(properties.getChildByName('action')?.formattedValue()).toEqual(
+      action,
+    );
+    expect(properties.getChildByName('eventId')?.getValue()).toEqual(eventId);
+  }
+
+  override executeSpecializedTests() {
+    describe('Specialized tests', () => {
+      const time0 = TimestampConverterUtils.makeRealTimestamp(0n);
+      const time10 = TimestampConverterUtils.makeRealTimestamp(10n);
+      const time19 = TimestampConverterUtils.makeRealTimestamp(19n);
+      const time20 = TimestampConverterUtils.makeRealTimestamp(20n);
+      const time25 = TimestampConverterUtils.makeRealTimestamp(25n);
+      const time30 = TimestampConverterUtils.makeRealTimestamp(30n);
+      const time35 = TimestampConverterUtils.makeRealTimestamp(35n);
+      const time36 = TimestampConverterUtils.makeRealTimestamp(36n);
+      const layerRect = new TraceRectBuilder()
+        .setX(0)
+        .setY(0)
+        .setWidth(1)
+        .setHeight(1)
+        .setId('layerRect')
+        .setName('layerRect')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setOpacity(1)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build();
+      const inputRect = new TraceRectBuilder()
+        .setX(2)
+        .setY(2)
+        .setWidth(3)
+        .setHeight(3)
+        .setId('inputRect')
+        .setName('inputRect')
+        .setCornerRadius(0)
+        .setTransform(Transform.EMPTY.matrix)
+        .setDepth(1)
+        .setGroupId(0)
+        .setIsVisible(true)
+        .setOpacity(1)
+        .setIsDisplay(false)
+        .setIsSpy(false)
+        .build();
+      const sfEntry0 = new HierarchyTreeBuilder()
+        .setId('LayerTraceEntry')
+        .setName('root')
+        .setChildren([
+          {
+            id: 1,
+            name: 'layer1',
+            rects: [layerRect],
+            secondaryRects: [inputRect],
+          },
+        ])
+        .build();
+      const sfEntry1 = new HierarchyTreeBuilder()
+        .setId('LayerTraceEntry')
+        .setName('root')
+        .setChildren([
+          {
+            id: 1,
+            name: 'layer1',
+            rects: [layerRect],
+            secondaryRects: [inputRect],
+            children: [
+              {
+                id: 2,
+                name: 'layer2',
+                rects: [layerRect],
+                secondaryRects: [inputRect],
+              },
+            ],
+          },
+        ])
+        .build();
+      const sfEntry2 = new HierarchyTreeBuilder()
+        .setId('LayerTraceEntry')
+        .setName('root')
+        .setChildren([
+          {
+            id: 1,
+            name: 'layer1',
+            rects: [layerRect],
+            secondaryRects: [inputRect],
+            children: [
+              {
+                id: 2,
+                name: 'layer2',
+                rects: [layerRect],
+                secondaryRects: [inputRect],
+              },
+            ],
+          },
+          {
+            id: 3,
+            name: 'layer3',
+            rects: [layerRect],
+            secondaryRects: [inputRect],
+          },
+        ])
+        .build();
+
+      let uiData: UiData = UiData.createEmpty();
+
+      beforeEach(async () => {
+        uiData = UiData.createEmpty();
+        await this.setUpTestEnvironment();
+      });
+
+      it('updates selected entry', async () => {
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+
+        const keyEntry = assertDefined(this.trace).getEntry(7);
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(keyEntry),
+        );
+
+        this.expectEventPresented(uiData, 894093732, 'ACTION_UP');
+
+        const motionEntry = assertDefined(this.trace).getEntry(1);
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(motionEntry),
+        );
+
+        this.expectEventPresented(uiData, 1327679296, 'ACTION_OUTSIDE');
+
+        const motionDispatchProperties = assertDefined(
+          uiData.dispatchPropertiesTree,
+        );
+        expect(motionDispatchProperties.getAllChildren().length).toEqual(1);
+        expect(
+          motionDispatchProperties
+            .getChildByName('0')
+            ?.getChildByName('windowId')
+            ?.getValue(),
+        ).toEqual(98n);
+      });
+
+      it('finds entry by time', async () => {
+        const traces = new Traces();
+        traces.addTrace(assertDefined(this.trace));
+
+        const lastMotion = await assertDefined(this.trace).getEntry(5);
+        const firstKey = await assertDefined(this.trace).getEntry(6);
+        const diffNs =
+          firstKey.getTimestamp().getValueNs() -
+          lastMotion.getTimestamp().getValueNs();
+        const belowLastMotionTime = lastMotion.getTimestamp().minus(1n);
+        const midpointTime = lastMotion.getTimestamp().add(diffNs / 2n);
+        const aboveFirstKeyTime = firstKey.getTimestamp().add(1n);
+
+        const otherTrace = new TraceBuilder<string>()
+          .setType(TraceType.TEST_TRACE_STRING)
+          .setEntries(['event-log-00', 'event-log-01', 'event-log-02'])
+          .setTimestamps([belowLastMotionTime, midpointTime, aboveFirstKeyTime])
+          .build();
+        traces.addTrace(otherTrace);
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(0)),
+        );
+        this.expectEventPresented(uiData, 313395000, 'ACTION_MOVE');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(1)),
+        );
+        this.expectEventPresented(uiData, 436499943, 'ACTION_UP');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(2)),
+        );
+        this.expectEventPresented(uiData, 759309047, 'ACTION_DOWN');
+      });
+
+      it('finds closest input event by frame', async () => {
+        const parser = assertDefined(this.trace).getParser();
+        const traces = new Traces();
+
+        // FRAME:            0        1       2
+        // TEST(time):       0       19      35
+        // INPUT(time):     10    20,25   30,36
+        const trace = new TraceBuilder<PropertyTreeNode>()
+          .setType(TraceType.INPUT_EVENT_MERGED)
+          .setEntries([
+            await parser.getEntry(0),
+            await parser.getEntry(1),
+            await parser.getEntry(2),
+            await parser.getEntry(3),
+            await parser.getEntry(4),
+          ])
+          .setTimestamps([time10, time20, time25, time30, time36])
+          .setFrame(0, 0)
+          .setFrame(1, 1)
+          .setFrame(2, 1)
+          .setFrame(3, 2)
+          .setFrame(4, 2)
+          .build();
+        traces.addTrace(trace);
+
+        const otherTrace = new TraceBuilder<string>()
+          .setType(TraceType.TEST_TRACE_STRING)
+          .setEntries(['sf-event-00', 'sf-event-01', 'sf-event-02'])
+          .setTimestamps([time0, time19, time35])
+          .setFrame(0, 0)
+          .setFrame(1, 1)
+          .setFrame(2, 2)
+          .build();
+        traces.addTrace(otherTrace);
+
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(0)),
+        );
+        this.expectEventPresented(uiData, 330184796, 'ACTION_DOWN');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(1)),
+        );
+        this.expectEventPresented(uiData, 1327679296, 'ACTION_OUTSIDE');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(otherTrace.getEntry(2)),
+        );
+        this.expectEventPresented(uiData, 106022695, 'ACTION_MOVE');
+      });
+
+      it('no rects defined without SF trace', async () => {
+        this.surfaceFlingerTrace = undefined;
+
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.rectsToDraw).toBeUndefined();
+      });
+
+      it('empty trace no rects defined without SF trace', async () => {
+        this.surfaceFlingerTrace = undefined;
+
+        const presenter = await this.createPresenterWithEmptyTrace(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.rectsToDraw).toBeUndefined();
+      });
+
+      it('rects defined with SF trace', async () => {
+        assertDefined(this.surfaceFlingerTrace);
+        const presenter = await this.createPresenter(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.rectsToDraw).toBeDefined();
+        expect(uiData.rectsToDraw).toEqual([]);
+      });
+
+      it('empty trace rects defined with SF trace', async () => {
+        assertDefined(this.surfaceFlingerTrace);
+        const presenter = await this.createPresenterWithEmptyTrace(
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+        await presenter.onAppEvent(this.getPositionUpdate());
+        expect(uiData.rectsToDraw).toBeDefined();
+        expect(uiData.rectsToDraw).toEqual([]);
+      });
+
+      it('extracts corresponding input rects from SF trace', async () => {
+        const parser = assertDefined(this.trace).getParser();
+        const traces = new Traces();
+
+        // FRAME:         0     1   2   3
+        // INPUT(index):  0   1,2   -   3
+        // SF(index):     -     0   1   2
+        const trace = new TraceBuilder<PropertyTreeNode>()
+          .setType(TraceType.INPUT_EVENT_MERGED)
+          .setEntries([
+            await parser.getEntry(0),
+            await parser.getEntry(1),
+            await parser.getEntry(2),
+            await parser.getEntry(3),
+          ])
+          .setTimestamps([time10, time20, time25, time30])
+          .setFrame(0, 0)
+          .setFrame(1, 1)
+          .setFrame(2, 1)
+          .setFrame(3, 3)
+          .build();
+        traces.addTrace(trace);
+
+        const sfTrace = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.SURFACE_FLINGER)
+          .setEntries([sfEntry0, sfEntry1, sfEntry2])
+          .setTimestamps([time0, time19, time35])
+          .setFrame(0, 1)
+          .setFrame(1, 2)
+          .setFrame(2, 3)
+          .setParserCustomQueryResult(
+            CustomQueryType.SF_LAYERS_ID_AND_NAME,
+            this.layerIdToName,
+          )
+          .build();
+        traces.addTrace(sfTrace);
+
+        const presenter = PresenterInputTest.createPresenterWithTraces(
+          traces,
+          (uiDataLog) => (uiData = uiDataLog as UiData),
+        );
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(0)),
+        );
+        expect(uiData.rectsToDraw).toEqual([]);
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(1)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(2)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(1);
+        expect(uiData.rectsToDraw?.at(0)?.id).toEqual('inputRect');
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(3)),
+        );
+        expect(uiData.rectsToDraw).toHaveSize(3);
+        uiData.rectsToDraw?.forEach((rect) =>
+          expect(rect.id).toEqual('inputRect'),
+        );
+      });
+    });
+  }
+}
+
+function wrappedName(name: string): string {
+  return `\u{200C}${name}\u{200C}`;
+}
+
+describe('PresenterInput', async () => {
+  new PresenterInputTest().execute();
+});
diff --git a/tools/winscope/src/viewers/viewer_input/ui_data.ts b/tools/winscope/src/viewers/viewer_input/ui_data.ts
new file mode 100644
index 000000000..02e00df2e
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/ui_data.ts
@@ -0,0 +1,70 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TraceEntry} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
+import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {DisplayIdentifier} from 'viewers/common/display_identifier';
+import {RectShowState} from 'viewers/common/rect_show_state';
+import {
+  LogEntry,
+  LogField,
+  LogFieldType,
+  LogFilter,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+import {UserOptions} from 'viewers/common/user_options';
+import {UiRect} from 'viewers/components/rects/ui_rect';
+
+export class UiData implements UiDataLog {
+  constructor(
+    public headers: LogFieldType[],
+    public entries: LogEntry[],
+    public filters: LogFilter[],
+    public selectedIndex: undefined | number,
+    public scrollToIndex: undefined | number,
+    public currentIndex: undefined | number,
+    public propertiesTree: undefined | UiPropertyTreeNode,
+  ) {}
+
+  highlightedProperty: string = '';
+  dispatchPropertiesTree: UiPropertyTreeNode | undefined;
+
+  rectsToDraw: UiRect[] | undefined;
+  rectIdToShowState: Map<string, RectShowState> | undefined;
+  highlightedRect = '';
+  rectsUserOptions: UserOptions | undefined;
+  displays: DisplayIdentifier[] = [];
+  isDarkMode = false;
+
+  readonly dependencies: TraceType[] = [TraceType.INPUT_EVENT_MERGED];
+
+  static createEmpty(): UiData {
+    return new UiData([], [], [], undefined, undefined, undefined, undefined);
+  }
+}
+
+export class InputEntry implements LogEntry {
+  constructor(
+    public traceEntry: TraceEntry<PropertyTreeNode>,
+    public fields: LogField[],
+    public propertiesTree: PropertyTreeNode | undefined,
+    public dispatchPropertiesTree: PropertyTreeNode | undefined,
+    public surfaceFlingerEntry: TraceEntry<HierarchyTreeNode> | undefined,
+  ) {}
+}
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input.ts b/tools/winscope/src/viewers/viewer_input/viewer_input.ts
new file mode 100644
index 000000000..d3ae0d8f3
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input.ts
@@ -0,0 +1,81 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
+import {WinscopeEvent} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {View, Viewer, ViewType} from 'viewers/viewer';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+import {ViewerInputComponent} from './viewer_input_component';
+
+export class ViewerInput implements Viewer {
+  static readonly DEPENDENCIES: TraceType[] = [TraceType.INPUT_EVENT_MERGED];
+
+  private readonly traces: Traces;
+  private readonly mergedInputEventTrace: Trace<PropertyTreeNode>;
+  private readonly htmlElement: HTMLElement;
+  private readonly presenter: Presenter;
+  private readonly view: View;
+
+  constructor(traces: Traces, storage: Store) {
+    this.traces = traces;
+    this.mergedInputEventTrace = assertDefined(
+      traces.getTrace(TraceType.INPUT_EVENT_MERGED),
+    );
+    this.htmlElement = document.createElement('viewer-input');
+
+    this.presenter = new Presenter(
+      traces,
+      this.mergedInputEventTrace,
+      storage,
+      (uiData: UiData) => {
+        (this.htmlElement as unknown as ViewerInputComponent).inputData =
+          uiData;
+      },
+    );
+
+    this.presenter.addEventListeners(this.htmlElement);
+
+    this.view = new View(
+      ViewType.TAB,
+      this.getTraces(),
+      this.htmlElement,
+      'Input',
+    );
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.presenter.setEmitEvent(callback);
+  }
+
+  async onWinscopeEvent(event: WinscopeEvent) {
+    await this.presenter.onAppEvent(event);
+  }
+
+  getViews(): View[] {
+    return [this.view];
+  }
+
+  getTraces(): Array<Trace<PropertyTreeNode>> {
+    return [this.mergedInputEventTrace];
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts b/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts
new file mode 100644
index 000000000..55661e39d
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input_component.ts
@@ -0,0 +1,160 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Component, Input} from '@angular/core';
+import {PersistentStore} from 'common/persistent_store';
+import {TraceType} from 'trace/trace_type';
+import {CollapsibleSections} from 'viewers/common/collapsible_sections';
+import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
+import {ShadingMode} from 'viewers/components/rects/shading_mode';
+import {
+  viewerCardInnerStyle,
+  viewerCardStyle,
+} from 'viewers/components/styles/viewer_card.styles';
+import {UiData} from './ui_data';
+
+@Component({
+  selector: 'viewer-input',
+  template: `
+    <div class="card-grid">
+      <collapsed-sections
+          [class.empty]="sections.areAllSectionsExpanded()"
+          [sections]="sections"
+          (sectionChange)="sections.onCollapseStateChange($event, false)">
+      </collapsed-sections>
+
+      <rects-view *ngIf="inputData?.rectsToDraw"
+          class="rects-view"
+          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.RECTS)"
+          [title]="rectsTitle"
+          [store]="store"
+          [isStackBased]="true"
+          [dependencies]="inputData?.dependencies"
+          [displays]="inputData?.displays"
+          [rects]="inputData?.rectsToDraw ?? []"
+          [shadingModes]="shadingModes"
+          [highlightedItem]="inputData?.highlightedRect ?? ''"
+          [userOptions]="inputData?.rectsUserOptions ?? {}"
+          [isDarkMode]="inputData?.isDarkMode ?? false"
+          (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.RECTS, true)"></rects-view>
+
+      <log-view
+          class="log-view"
+          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.LOG)"
+          [title]="eventLogTitle"
+          [selectedIndex]="inputData?.selectedIndex"
+          [scrollToIndex]="inputData?.scrollToIndex"
+          [currentIndex]="inputData?.currentIndex"
+          [entries]="inputData?.entries"
+          [headers]="inputData?.headers"
+          [filters]="inputData?.filters"
+          [showFiltersInTitle]="true"
+          [traceType]="${TraceType.INPUT_EVENT_MERGED}"
+          [showTraceEntryTimes]="false"
+          [showCurrentTimeButton]="false"
+          (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.LOG, true)"></log-view>
+
+      <div class="properties" *ngIf="!arePropertiesCollapsed()">
+        <properties-view
+          class="properties-view event-properties"
+          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES)"
+          [title]="eventPropertiesTitle"
+          [propertiesTree]="inputData?.propertiesTree"
+          [highlightedProperty]="inputData?.highlightedProperty"
+          [traceType]="${TraceType.INPUT_EVENT_MERGED}"
+          [store]="store"
+          [isProtoDump]="true"
+          [showFilter]="false"
+          placeholderText="No selected entry."
+          (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"></properties-view>
+        <properties-view
+          class="properties-view dispatch-properties"
+          [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.INPUT_DISPATCH_PROPERTIES)"
+          [title]="dispatchPropertiesTitle"
+          [propertiesTree]="inputData?.dispatchPropertiesTree"
+          [highlightedProperty]="inputData?.highlightedProperty"
+          [traceType]="${TraceType.INPUT_EVENT_MERGED}"
+          [store]="store"
+          [isProtoDump]="true"
+          [showFilter]="false"
+          placeholderText="No selected entry."
+          (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.INPUT_DISPATCH_PROPERTIES, true)"></properties-view>
+      </div>
+    </div>
+  `,
+  styles: [
+    viewerCardStyle,
+    viewerCardInnerStyle,
+    `
+      .properties {
+        flex: 1;
+        display: flex;
+        flex-direction: column;
+        overflow: auto;
+      }
+
+      .log-view:not(.collapsed) {
+        flex: 1;
+      }
+    `,
+  ],
+})
+export class ViewerInputComponent {
+  @Input() inputData: UiData | undefined;
+  @Input() store: PersistentStore | undefined;
+  @Input() active = false;
+  TraceType = TraceType;
+  CollapsibleSectionType = CollapsibleSectionType;
+
+  rectsTitle = 'INPUT WINDOWS';
+  eventLogTitle = 'EVENT LOG';
+  eventPropertiesTitle = 'EVENT DETAILS';
+  dispatchPropertiesTitle = 'DISPATCH DETAILS';
+
+  shadingModes = [ShadingMode.OPACITY];
+
+  sections = new CollapsibleSections([
+    {
+      type: CollapsibleSectionType.RECTS,
+      label: this.rectsTitle,
+      isCollapsed: false,
+    },
+    {
+      type: CollapsibleSectionType.LOG,
+      label: this.eventLogTitle,
+      isCollapsed: false,
+    },
+    {
+      type: CollapsibleSectionType.PROPERTIES,
+      label: this.eventPropertiesTitle,
+      isCollapsed: false,
+    },
+    {
+      type: CollapsibleSectionType.INPUT_DISPATCH_PROPERTIES,
+      label: this.dispatchPropertiesTitle,
+      isCollapsed: false,
+    },
+  ]);
+
+  arePropertiesCollapsed(): boolean {
+    return (
+      this.sections.isSectionCollapsed(CollapsibleSectionType.PROPERTIES) &&
+      this.sections.isSectionCollapsed(
+        CollapsibleSectionType.INPUT_DISPATCH_PROPERTIES,
+      )
+    );
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts b/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts
new file mode 100644
index 000000000..49f67619f
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_input/viewer_input_component_test.ts
@@ -0,0 +1,242 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {ClipboardModule} from '@angular/cdk/clipboard';
+import {ScrollingModule} from '@angular/cdk/scrolling';
+import {CommonModule} from '@angular/common';
+import {HttpClientModule} from '@angular/common/http';
+import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
+import {
+  ComponentFixture,
+  ComponentFixtureAutoDetect,
+  TestBed,
+} from '@angular/core/testing';
+import {FormsModule} from '@angular/forms';
+import {MatButtonModule} from '@angular/material/button';
+import {MatCheckboxModule} from '@angular/material/checkbox';
+import {MatDividerModule} from '@angular/material/divider';
+import {MatFormFieldModule} from '@angular/material/form-field';
+import {MatIconModule} from '@angular/material/icon';
+import {MatInputModule} from '@angular/material/input';
+import {MatSelectModule} from '@angular/material/select';
+import {MatSliderModule} from '@angular/material/slider';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Trace, TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LogComponent} from 'viewers/common/log_component';
+import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
+import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {PropertiesComponent} from 'viewers/components/properties_component';
+import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
+import {RectsComponent} from 'viewers/components/rects/rects_component';
+import {TreeComponent} from 'viewers/components/tree_component';
+import {TreeNodeComponent} from 'viewers/components/tree_node_component';
+import {Presenter} from './presenter';
+import {InputEntry, UiData} from './ui_data';
+import {ViewerInputComponent} from './viewer_input_component';
+
+describe('ViewerInputComponent', () => {
+  let fixture: ComponentFixture<ViewerInputComponent>;
+  let component: ViewerInputComponent;
+  let htmlElement: HTMLElement;
+
+  let tree: PropertyTreeNode;
+  let trace: Trace<PropertyTreeNode>;
+  let entry: TraceEntry<PropertyTreeNode>;
+
+  beforeAll(async () => {
+    tree = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('AndroidMotionEvent')
+      .setName('entry')
+      .build();
+    trace = new TraceBuilder<PropertyTreeNode>()
+      .setEntries([tree])
+      .setTimestamps([TimestampConverterUtils.makeElapsedTimestamp(20n)])
+      .build();
+    entry = trace.getEntry(0);
+  });
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      imports: [
+        CommonModule,
+        MatIconModule,
+        MatDividerModule,
+        HttpClientModule,
+        MatCheckboxModule,
+        MatSliderModule,
+        MatFormFieldModule,
+        MatInputModule,
+        BrowserAnimationsModule,
+        FormsModule,
+        MatTooltipModule,
+        MatButtonModule,
+        MatSelectModule,
+        ScrollingModule,
+        ClipboardModule,
+      ],
+      declarations: [
+        ViewerInputComponent,
+        TreeComponent,
+        TreeNodeComponent,
+        PropertyTreeNodeDataViewComponent,
+        PropertiesComponent,
+        CollapsedSectionsComponent,
+        CollapsibleSectionTitleComponent,
+        LogComponent,
+        RectsComponent,
+      ],
+      schemas: [CUSTOM_ELEMENTS_SCHEMA],
+    }).compileComponents();
+
+    fixture = TestBed.createComponent(ViewerInputComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+
+    component.inputData = makeUiData();
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('renders entries', () => {
+    expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+
+    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
+    expect(entry.innerHTML).toContain(`MOTION #1`);
+    expect(entry.innerHTML).toContain(`EXAMPLE SOURCE #1`);
+    expect(entry.innerHTML).toContain(`EXAMPLE ACTION #1`);
+    expect(entry.innerHTML).toContain(`EXAMPLE DETAILS #1`);
+  });
+
+  it('shows message when no event is selected', () => {
+    assertDefined(component.inputData).propertiesTree = undefined;
+    assertDefined(component.inputData).dispatchPropertiesTree = undefined;
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector('.event-properties .placeholder-text')
+        ?.innerHTML,
+    ).toContain('No selected entry');
+    expect(
+      htmlElement.querySelector('.dispatch-properties .placeholder-text')
+        ?.innerHTML,
+    ).toContain('No selected entry');
+  });
+
+  it('creates collapsed sections with no buttons', () => {
+    UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
+  });
+
+  it('handles collapse/expand', () => {
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.rects-view',
+      'INPUT WINDOWS',
+    );
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.event-properties',
+      'EVENT DETAILS',
+    );
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.dispatch-properties',
+      'DISPATCH DETAILS',
+    );
+    UnitTestUtils.checkSectionCollapseAndExpand(
+      htmlElement,
+      fixture,
+      '.log-view',
+      'EVENT LOG',
+    );
+  });
+
+  it('shows rects view when rects are defined', () => {
+    assertDefined(component.inputData).rectsToDraw = [];
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.rects-view')).toBeTruthy();
+  });
+
+  it('hides rects view when rects are not defined', () => {
+    assertDefined(component.inputData).rectsToDraw = undefined;
+    fixture.detectChanges();
+    expect(htmlElement.querySelector('.rects-view')).toBeNull();
+  });
+
+  function makeUiData(): UiData {
+    const entries = [
+      createInputEntry(entry, 1),
+      createInputEntry(entry, 2),
+      createInputEntry(entry, 3),
+    ];
+
+    const uiData = UiData.createEmpty();
+    uiData.entries = entries;
+    uiData.selectedIndex = 0;
+    uiData.headers = Presenter.FIELD_TYPES;
+
+    uiData.rectsToDraw = [];
+    return uiData;
+  }
+
+  function createInputEntry(
+    entry: TraceEntry<PropertyTreeNode>,
+    num: number,
+  ): InputEntry {
+    const fields: LogField[] = [
+      {
+        type: LogFieldType.INPUT_TYPE,
+        value: `MOTION #${num}`,
+      },
+      {
+        type: LogFieldType.INPUT_SOURCE,
+        value: `EXAMPLE SOURCE #${num}`,
+      },
+      {
+        type: LogFieldType.INPUT_ACTION,
+        value: `EXAMPLE ACTION #${num}`,
+      },
+      {
+        type: LogFieldType.INPUT_DEVICE_ID,
+        value: 42,
+      },
+      {
+        type: LogFieldType.INPUT_DISPLAY_ID,
+        value: 2,
+      },
+      {
+        type: LogFieldType.INPUT_EVENT_DETAILS,
+        value: `EXAMPLE DETAILS #${num}`,
+      },
+    ];
+
+    return new InputEntry(entry, fields, tree, tree, undefined);
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
index fd3944fa6..80de81358 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients.ts
@@ -14,14 +14,19 @@
  * limitations under the License.
  */
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractPresenterInputMethod} from 'viewers/common/abstract_presenter_input_method';
 import {VISIBLE_CHIP} from 'viewers/common/chip';
 import {HierarchyPresenter} from 'viewers/common/hierarchy_presenter';
+import {ImeUiData} from 'viewers/common/ime_ui_data';
+import {UpdateSfSubtreeDisplayNames} from 'viewers/common/operations/update_sf_subtree_display_names';
 import {TableProperties} from 'viewers/common/table_properties';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UserOptions} from 'viewers/common/user_options';
 import {UpdateDisplayNames} from './operations/update_display_names';
 
@@ -46,17 +51,25 @@ export class PresenterInputMethodClients extends AbstractPresenterInputMethod {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'ImeHierarchyFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     [],
     true,
     false,
     this.getHierarchyTreeNameStrategy,
-    [new UpdateDisplayNames()],
+    [
+      [TraceType.SURFACE_FLINGER, [new UpdateSfSubtreeDisplayNames()]],
+      [TraceType.INPUT_METHOD_CLIENTS, [new UpdateDisplayNames()]],
+    ],
   );
   constructor(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
-    notifyViewCallback: NotifyHierarchyViewCallbackType,
+    storage: Store,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<ImeUiData>,
   ) {
     super(trace, traces, storage, notifyViewCallback);
   }
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
index 6c7e98d25..dd1168cc0 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/presenter_input_method_clients_test.ts
@@ -19,12 +19,13 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertySource} from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
+import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodClients} from './presenter_input_method_clients';
 
 class PresenterInputMethodClientsTest extends AbstractPresenterInputMethodTest {
   override readonly numberOfDefaultProperties = 1;
   override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilterString = 'where';
+  override readonly propertiesFilter = new TextFilter('where', []);
   override readonly numberOfFilteredProperties = 1;
 
   protected override readonly PresenterInputMethod =
diff --git a/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts b/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
index de16f08c7..b8de9b2fa 100644
--- a/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_clients/viewer_input_method_clients.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
@@ -30,11 +31,7 @@ class ViewerInputMethodClients extends AbstractViewerInputMethod {
 
   override readonly view: View;
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
     this.view = new View(
       ViewType.TAB,
@@ -47,7 +44,7 @@ class ViewerInputMethodClients extends AbstractViewerInputMethod {
   override initializePresenter(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
+    storage: Store,
   ): PresenterInputMethodClients {
     return new PresenterInputMethodClients(
       trace,
diff --git a/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts b/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
index 0eb8e1a7f..e15e83ff7 100644
--- a/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_manager_service/presenter_input_method_manager_service_test.ts
@@ -23,12 +23,13 @@ import {
   PropertyTreeNode,
 } from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
+import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodManagerService} from './presenter_input_method_manager_service';
 
 class PresenterInputMethodManagerServiceTest extends AbstractPresenterInputMethodTest {
   override readonly numberOfDefaultProperties = 1;
   override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilterString = 'elapsedNanos';
+  override readonly propertiesFilter = new TextFilter('elapsedNanos', []);
   override readonly numberOfFilteredProperties = 1;
 
   protected override readonly PresenterInputMethod =
diff --git a/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts b/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
index 965e1172e..db094beec 100644
--- a/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_manager_service/viewer_input_method_manager_service.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
@@ -30,11 +31,7 @@ class ViewerInputMethodManagerService extends AbstractViewerInputMethod {
 
   override readonly view: View;
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
     this.view = new View(
       ViewType.TAB,
@@ -47,7 +44,7 @@ class ViewerInputMethodManagerService extends AbstractViewerInputMethod {
   override initializePresenter(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
+    storage: Store,
   ) {
     return new PresenterInputMethodManagerService(
       trace,
diff --git a/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts b/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
index b10220fa8..059140bdf 100644
--- a/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_service/presenter_input_method_service_test.ts
@@ -18,12 +18,13 @@ import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertySource} from 'trace/tree_node/property_tree_node';
 import {AbstractPresenterInputMethodTest} from 'viewers/common/abstract_presenter_input_method_test';
+import {TextFilter} from 'viewers/common/text_filter';
 import {PresenterInputMethodService} from './presenter_input_method_service';
 
 class PresenterInputMethodServiceTest extends AbstractPresenterInputMethodTest {
   override readonly numberOfDefaultProperties = 1;
   override readonly numberOfNonDefaultProperties = 2;
-  override readonly propertiesFilterString = 'elapsedNanos';
+  override readonly propertiesFilter = new TextFilter('elapsedNanos', []);
   override readonly numberOfFilteredProperties = 1;
 
   protected override readonly PresenterInputMethod =
diff --git a/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts b/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
index fd84b3c5d..9436b428d 100644
--- a/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
+++ b/tools/winscope/src/viewers/viewer_input_method_service/viewer_input_method_service.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
@@ -30,11 +31,7 @@ class ViewerInputMethodService extends AbstractViewerInputMethod {
 
   override readonly view: View;
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     super(trace, traces, storage);
     this.view = new View(
       ViewType.TAB,
@@ -47,7 +44,7 @@ class ViewerInputMethodService extends AbstractViewerInputMethod {
   override initializePresenter(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Storage,
+    storage: Store,
   ) {
     return new PresenterInputMethodService(
       trace,
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts b/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts
new file mode 100644
index 000000000..bcd7f4bba
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/presenter.ts
@@ -0,0 +1,137 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TimeDuration} from 'common/time_duration';
+import {Trace} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {CujEntry, CujStatus, UiData} from './ui_data';
+
+export class Presenter extends AbstractLogViewerPresenter<UiData> {
+  static readonly FIELD_NAMES = [
+    LogFieldType.CUJ_TYPE,
+    LogFieldType.START_TIME,
+    LogFieldType.END_TIME,
+    LogFieldType.DURATION,
+    LogFieldType.STATUS,
+  ];
+  private static readonly VALUE_NA = 'N/A';
+
+  private isInitialized = false;
+  private transitionTrace: Trace<PropertyTreeNode>;
+
+  protected override logPresenter = new LogPresenter<CujEntry>();
+  protected override propertiesPresenter = new PropertiesPresenter(
+    {},
+    undefined,
+    [],
+    [],
+  );
+
+  constructor(
+    trace: Trace<PropertyTreeNode>,
+    notifyViewCallback: NotifyLogViewCallbackType<UiData>,
+  ) {
+    super(trace, notifyViewCallback, UiData.createEmpty());
+    this.transitionTrace = trace;
+  }
+
+  protected async initializeIfNeeded() {
+    if (this.isInitialized) {
+      return;
+    }
+
+    const allEntries = await this.makeUiDataEntries();
+
+    this.logPresenter.setAllEntries(allEntries);
+    this.logPresenter.setHeaders(Presenter.FIELD_NAMES);
+    this.refreshUiData();
+    this.isInitialized = true;
+  }
+
+  private async makeUiDataEntries(): Promise<CujEntry[]> {
+    const cujs: CujEntry[] = [];
+    for (
+      let traceIndex = 0;
+      traceIndex < this.transitionTrace.lengthEntries;
+      ++traceIndex
+    ) {
+      const entry = assertDefined(this.trace.getEntry(traceIndex));
+      const cujNode = await entry.getValue();
+
+      let status: CujStatus | undefined;
+      let statusIcon: string | undefined;
+      let statusIconColor: string | undefined;
+      if (assertDefined(cujNode.getChildByName('canceled')).getValue()) {
+        status = CujStatus.CANCELLED;
+        statusIcon = 'close';
+        statusIconColor = 'red';
+      } else {
+        status = CujStatus.EXECUTED;
+        statusIcon = 'check';
+        statusIconColor = 'green';
+      }
+
+      const startTs = cujNode.getChildByName('startTimestamp')?.getValue();
+      const endTs = cujNode.getChildByName('endTimestamp')?.getValue();
+
+      let timeDiff: TimeDuration | undefined = undefined;
+      if (startTs && endTs) {
+        const timeDiffNs = endTs.minus(startTs.getValueNs()).getValueNs();
+        timeDiff = new TimeDuration(timeDiffNs);
+      }
+
+      const cujType = assertDefined(
+        cujNode.getChildByName('cujType'),
+      ).formattedValue();
+
+      const fields: LogField[] = [
+        {
+          type: LogFieldType.CUJ_TYPE,
+          value: cujType,
+        },
+        {
+          type: LogFieldType.START_TIME,
+          value: startTs ?? Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.END_TIME,
+          value: endTs ?? Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.DURATION,
+          value: timeDiff?.format() ?? Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.STATUS,
+          value: status ?? Presenter.VALUE_NA,
+          icon: statusIcon,
+          iconColor: statusIconColor,
+        },
+      ];
+      cujs.push(new CujEntry(entry, fields, cujNode));
+    }
+
+    return cujs;
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts b/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts
new file mode 100644
index 000000000..cd8e24b5a
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/presenter_test.ts
@@ -0,0 +1,120 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANYf KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {assertDefined} from 'common/assert_utils';
+import {TracePositionUpdate} from 'messaging/winscope_event';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {Parser} from 'trace/parser';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+
+class PresenterJankCujsTest extends AbstractLogViewerPresenterTest<UiData> {
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private secondPositionUpdate: TracePositionUpdate | undefined;
+
+  override readonly shouldExecuteHeaderTests = true;
+  override readonly shouldExecuteFilterTests = false;
+  override readonly shouldExecutePropertiesTests = true;
+
+  override readonly totalOutputEntries = 16;
+  override readonly expectedIndexOfFirstPositionUpdate = 0;
+  override readonly expectedIndexOfSecondPositionUpdate = 2;
+  override readonly logEntryClickIndex = 3;
+
+  override async setUpTestEnvironment(): Promise<void> {
+    const parser = (await UnitTestUtils.getTracesParser([
+      'traces/eventlog.winscope',
+    ])) as Parser<PropertyTreeNode>;
+
+    this.trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.CUJS)
+      .setParser(parser)
+      .build();
+
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
+    );
+    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(2),
+    );
+  }
+
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const trace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.CUJS)
+      .setEntries([])
+      .build();
+    return new Presenter(trace, callback);
+  }
+
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const trace = assertDefined(this.trace);
+    const traces = new Traces();
+    traces.addTrace(trace);
+
+    const presenter = new Presenter(trace, callback);
+    await presenter.onAppEvent(this.getPositionUpdate()); // trigger initialization
+    return presenter;
+  }
+
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
+  }
+
+  override getSecondPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.secondPositionUpdate);
+  }
+
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiData) {
+    const cujTypeValues = uiData.entries.map((entry) => {
+      return entry.fields[0].value;
+    });
+    expect(cujTypeValues).toEqual([
+      'CUJ_LAUNCHER_QUICK_SWITCH (11)',
+      'CUJ_LAUNCHER_APP_CLOSE_TO_HOME (9)',
+      'CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS (66)',
+      'CUJ_LAUNCHER_OPEN_ALL_APPS (25)',
+      'CUJ_LAUNCHER_CLOSE_ALL_APPS_SWIPE (67)',
+      'CUJ_LAUNCHER_APP_LAUNCH_FROM_ICON (8)',
+      'CUJ_SPLASHSCREEN_EXIT_ANIM (39)',
+      'CUJ_LAUNCHER_QUICK_SWITCH (11)',
+      'CUJ_LAUNCHER_APP_CLOSE_TO_HOME (9)',
+      'CUJ_LAUNCHER_APP_SWIPE_TO_RECENTS (66)',
+      'CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE (0)',
+      'CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE (0)',
+      'CUJ_NOTIFICATION_SHADE_QS_EXPAND_COLLAPSE (5)',
+      'CUJ_NOTIFICATION_SHADE_QS_EXPAND_COLLAPSE (5)',
+      'CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE (0)',
+      'CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE (0)',
+    ]);
+  }
+}
+
+describe('PresenterJankCujsTest', () => {
+  new PresenterJankCujsTest().execute();
+});
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts b/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts
new file mode 100644
index 000000000..ef2e9ec6c
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/ui_data.ts
@@ -0,0 +1,51 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  LogEntry,
+  LogField,
+  LogFieldType,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
+import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
+
+export class UiData implements UiDataLog {
+  constructor(
+    public headers: LogFieldType[],
+    public entries: LogEntry[],
+    public selectedIndex: undefined | number,
+    public scrollToIndex: undefined | number,
+    public propertiesTree: undefined | UiPropertyTreeNode,
+  ) {}
+
+  static createEmpty() {
+    return new UiData([], [], undefined, undefined, undefined);
+  }
+}
+export class CujEntry implements LogEntry {
+  constructor(
+    public traceEntry: TraceEntry<PropertyTreeNode>,
+    public fields: LogField[],
+    public propertiesTree: PropertyTreeNode | undefined,
+  ) {}
+}
+
+export enum CujStatus {
+  EXECUTED = 'EXECUTED',
+  CANCELLED = 'CANCELLED',
+}
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts
new file mode 100644
index 000000000..b1670e7ac
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs.ts
@@ -0,0 +1,67 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {WinscopeEvent} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {View, Viewer, ViewType} from 'viewers/viewer';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+
+export class ViewerJankCujs implements Viewer {
+  static readonly DEPENDENCIES: TraceType[] = [TraceType.CUJS];
+
+  private readonly trace: Trace<PropertyTreeNode>;
+  private readonly htmlElement: HTMLElement;
+  private readonly presenter: Presenter;
+  private readonly view: View;
+
+  constructor(trace: Trace<PropertyTreeNode>, traces: Traces) {
+    this.trace = trace;
+    this.htmlElement = document.createElement('viewer-jank-cujs');
+    const notifyViewCallback = (data: UiData) => {
+      (this.htmlElement as any).inputData = data;
+    };
+    this.presenter = new Presenter(trace, notifyViewCallback);
+    this.presenter.addEventListeners(this.htmlElement);
+
+    this.view = new View(
+      ViewType.TAB,
+      this.getTraces(),
+      this.htmlElement,
+      'Jank CUJs',
+    );
+  }
+
+  async onWinscopeEvent(event: WinscopeEvent) {
+    await this.presenter.onAppEvent(event);
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.presenter.setEmitEvent(callback);
+  }
+
+  getViews(): View[] {
+    return [this.view];
+  }
+
+  getTraces(): Array<Trace<PropertyTreeNode>> {
+    return [this.trace];
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts
new file mode 100644
index 000000000..bc4384c80
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component.ts
@@ -0,0 +1,46 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {Component, Input, ViewChild} from '@angular/core';
+import {TraceType} from 'trace/trace_type';
+import {LogComponent} from 'viewers/common/log_component';
+import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
+import {UiData} from './ui_data';
+
+@Component({
+  selector: 'viewer-jank-cujs',
+  template: `
+    <div class="card-grid">
+       <log-view
+        class="log-view"
+        [selectedIndex]="inputData?.selectedIndex"
+        [scrollToIndex]="inputData?.scrollToIndex"
+        [currentIndex]="inputData?.currentIndex"
+        [entries]="inputData?.entries"
+        [headers]="inputData?.headers"
+        [traceType]="${TraceType.CUJS}"
+        [showTraceEntryTimes]="false"
+        [showCurrentTimeButton]="false">
+      </log-view>
+    </div>
+  `,
+  styles: [viewerCardStyle],
+})
+export class ViewerJankCujsComponent {
+  @Input() inputData: UiData | undefined;
+
+  @ViewChild(LogComponent)
+  logComponent?: LogComponent;
+}
diff --git a/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts
new file mode 100644
index 000000000..6ccddbedb
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_jank_cujs/viewer_jank_cujs_component_test.ts
@@ -0,0 +1,169 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {ClipboardModule} from '@angular/cdk/clipboard';
+import {ScrollingModule} from '@angular/cdk/scrolling';
+import {
+  ComponentFixture,
+  ComponentFixtureAutoDetect,
+  TestBed,
+} from '@angular/core/testing';
+import {MatDividerModule} from '@angular/material/divider';
+import {MatIconModule} from '@angular/material/icon';
+import {assertDefined} from 'common/assert_utils';
+import {TimeDuration} from 'common/time_duration';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {UnitTestUtils} from 'test/unit/utils';
+import {CujType} from 'trace/cuj_type';
+import {Parser} from 'trace/parser';
+import {Trace, TraceEntry} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LogComponent} from 'viewers/common/log_component';
+import {LogEntry, LogField, LogFieldType} from 'viewers/common/ui_data_log';
+import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
+import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
+import {PropertiesComponent} from 'viewers/components/properties_component';
+import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tree_node_data_view_component';
+import {TreeComponent} from 'viewers/components/tree_component';
+import {TreeNodeComponent} from 'viewers/components/tree_node_component';
+import {Presenter} from './presenter';
+import {CujStatus, UiData} from './ui_data';
+import {ViewerJankCujsComponent} from './viewer_jank_cujs_component';
+
+describe('ViewerJankCujsComponent', () => {
+  let fixture: ComponentFixture<ViewerJankCujsComponent>;
+  let component: ViewerJankCujsComponent;
+  let htmlElement: HTMLElement;
+
+  let trace: Trace<PropertyTreeNode>;
+  let entry: TraceEntry<PropertyTreeNode>;
+
+  beforeAll(async () => {
+    const parser = (await UnitTestUtils.getTracesParser([
+      'traces/eventlog.winscope',
+    ])) as Parser<PropertyTreeNode>;
+
+    trace = new TraceBuilder<PropertyTreeNode>()
+      .setParser(parser)
+      .setType(TraceType.CUJS)
+      .build();
+
+    entry = trace.getEntry(0);
+  });
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
+      imports: [
+        MatDividerModule,
+        ScrollingModule,
+        MatIconModule,
+        ClipboardModule,
+      ],
+      declarations: [
+        ViewerJankCujsComponent,
+        TreeComponent,
+        TreeNodeComponent,
+        PropertyTreeNodeDataViewComponent,
+        PropertiesComponent,
+        CollapsedSectionsComponent,
+        CollapsibleSectionTitleComponent,
+        LogComponent,
+      ],
+      schemas: [],
+    }).compileComponents();
+
+    fixture = TestBed.createComponent(ViewerJankCujsComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+
+    component.inputData = makeUiData();
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('renders entries', () => {
+    expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+
+    const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
+    expect(entry.innerHTML).toContain('LOCKSCREEN_PASSWORD_DISAPPEAR');
+    expect(entry.innerHTML).toContain('30ns');
+  });
+
+  function makeUiData(): UiData {
+    let mockTransitionIdCounter = 0;
+
+    const cujEntries = [
+      createMockCujEntry(entry, 20, CujType[20], 30, mockTransitionIdCounter++),
+      createMockCujEntry(entry, 66, CujType[66], 42, 50, CujStatus.CANCELLED),
+      createMockCujEntry(entry, 46, CujType[46], 49, mockTransitionIdCounter++),
+      createMockCujEntry(entry, 59, CujType[59], 58, 70, CujStatus.EXECUTED),
+    ];
+
+    const uiData = UiData.createEmpty();
+    uiData.entries = cujEntries;
+    uiData.selectedIndex = 0;
+    uiData.headers = Presenter.FIELD_NAMES;
+    return uiData;
+  }
+
+  function createMockCujEntry(
+    entry: TraceEntry<PropertyTreeNode>,
+    cujTypeId: number,
+    cujTypeStr: string,
+    startTsNanos: number,
+    endTsNanos: number,
+    status = CujStatus.EXECUTED,
+  ): LogEntry {
+    const fields: LogField[] = [
+      {
+        type: LogFieldType.CUJ_TYPE,
+        value: `${cujTypeStr} (${cujTypeId})`,
+      },
+      {
+        type: LogFieldType.START_TIME,
+        value: TimestampConverterUtils.makeElapsedTimestamp(
+          BigInt(startTsNanos),
+        ),
+      },
+      {
+        type: LogFieldType.END_TIME,
+        value: TimestampConverterUtils.makeElapsedTimestamp(BigInt(endTsNanos)),
+      },
+      {
+        type: LogFieldType.DURATION,
+        value: new TimeDuration(BigInt(endTsNanos - startTsNanos)).format(),
+      },
+      {
+        type: LogFieldType.STATUS,
+        value: status,
+        icon: 'check',
+        iconColor: 'green',
+      },
+    ];
+
+    return {
+      traceEntry: entry,
+      fields,
+      propertiesTree: undefined,
+    };
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_media_based/presenter.ts b/tools/winscope/src/viewers/viewer_media_based/presenter.ts
new file mode 100644
index 000000000..0f0ea0fb4
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/presenter.ts
@@ -0,0 +1,71 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+import {Trace, TraceEntry} from 'trace/trace';
+import {TraceEntryFinder} from 'trace/trace_entry_finder';
+import {UiData} from './ui_data';
+
+export type NotifyHierarchyViewCallbackType<UiData> = (uiData: UiData) => void;
+
+export class Presenter {
+  private readonly uiData: UiData;
+
+  constructor(
+    private readonly traces: Array<Trace<MediaBasedTraceEntry>>,
+    private readonly notifyViewCallback: NotifyHierarchyViewCallbackType<UiData>,
+  ) {
+    this.uiData = new UiData(
+      this.traces.map((trace) => trace.getDescriptors().join(', ')),
+    );
+    this.notifyViewCallback(this.uiData);
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    // do nothing
+  }
+
+  async onAppEvent(event: WinscopeEvent) {
+    await event.visit(
+      WinscopeEventType.TRACE_POSITION_UPDATE,
+      async (event) => {
+        const traceEntries = this.traces
+          .map((trace) =>
+            TraceEntryFinder.findCorrespondingEntry(trace, event.position),
+          )
+          .filter((entry) => entry !== undefined) as Array<
+          TraceEntry<MediaBasedTraceEntry>
+        >;
+        const entries: MediaBasedTraceEntry[] = await Promise.all(
+          traceEntries.map((entry) => {
+            return entry.getValue();
+          }),
+        );
+        this.uiData.currentTraceEntries = entries;
+        this.notifyViewCallback(this.uiData);
+      },
+    );
+    await event.visit(
+      WinscopeEventType.EXPANDED_TIMELINE_TOGGLED,
+      async (event) => {
+        this.uiData.forceMinimize = event.isTimelineExpanded;
+        this.notifyViewCallback(this.uiData);
+      },
+    );
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_media_based/presenter_test.ts b/tools/winscope/src/viewers/viewer_media_based/presenter_test.ts
new file mode 100644
index 000000000..cb4361fc1
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/presenter_test.ts
@@ -0,0 +1,82 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {
+  ExpandedTimelineToggled,
+  TracePositionUpdate,
+} from 'messaging/winscope_event';
+import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+import {TraceType} from 'trace/trace_type';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+
+describe('PresenterMediaBased', () => {
+  const entries = [
+    new MediaBasedTraceEntry(10, new Blob(), false),
+    new MediaBasedTraceEntry(15, new Blob(), false),
+  ];
+  const timestamps = [
+    TimestampConverterUtils.makeRealTimestamp(10n),
+    TimestampConverterUtils.makeRealTimestamp(15n),
+  ];
+  const trace1 = new TraceBuilder<MediaBasedTraceEntry>()
+    .setType(TraceType.SCREEN_RECORDING)
+    .setDescriptors(['recording 1'])
+    .setEntries(entries)
+    .setTimestamps(timestamps)
+    .build();
+  const trace2 = new TraceBuilder<MediaBasedTraceEntry>()
+    .setType(TraceType.SCREEN_RECORDING)
+    .setDescriptors(['recording 2'])
+    .setEntries(entries)
+    .setTimestamps(timestamps)
+    .build();
+
+  const traces = [trace1, trace2];
+
+  let presenter: Presenter;
+  let uiData: UiData;
+
+  beforeEach(() => {
+    presenter = new Presenter(traces, (newData) => {
+      uiData = newData;
+    });
+  });
+
+  it('initializes titles from trace descriptors', () => {
+    expect(uiData.titles).toEqual(['recording 1', 'recording 2']);
+  });
+
+  it('processes trace position updates', async () => {
+    const positionUpdate1 = TracePositionUpdate.fromTimestamp(timestamps[1]);
+    await presenter.onAppEvent(positionUpdate1);
+    expect(uiData.currentTraceEntries).toEqual([entries[1], entries[1]]);
+
+    const positionUpdate0 = TracePositionUpdate.fromTimestamp(timestamps[0]);
+    await presenter.onAppEvent(positionUpdate0);
+    expect(uiData.currentTraceEntries).toEqual([entries[0], entries[0]]);
+  });
+
+  it('updates force minimize state on expanded timeline toggle', async () => {
+    expect(uiData.forceMinimize).toBeFalse();
+    await presenter.onAppEvent(new ExpandedTimelineToggled(true));
+    expect(uiData.forceMinimize).toBeTrue();
+    await presenter.onAppEvent(new ExpandedTimelineToggled(false));
+    expect(uiData.forceMinimize).toBeFalse();
+  });
+});
diff --git a/tools/winscope/src/viewers/viewer_media_based/ui_data.ts b/tools/winscope/src/viewers/viewer_media_based/ui_data.ts
new file mode 100644
index 000000000..311213161
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/ui_data.ts
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+
+export class UiData {
+  readonly titles: string[];
+  currentTraceEntries: MediaBasedTraceEntry[] = [];
+  forceMinimize = false;
+
+  constructor(titles: string[]) {
+    this.titles = titles;
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_media_based/viewer_media_based.ts b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based.ts
new file mode 100644
index 000000000..1df1984e8
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based.ts
@@ -0,0 +1,74 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {WinscopeEvent} from 'messaging/winscope_event';
+import {EmitEvent} from 'messaging/winscope_event_emitter';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+import {Trace} from 'trace/trace';
+import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
+import {TraceType} from 'trace/trace_type';
+import {View, Viewer, ViewType} from 'viewers/viewer';
+import {Presenter} from './presenter';
+import {UiData} from './ui_data';
+import {ViewerMediaBasedComponent} from './viewer_media_based_component';
+
+export abstract class ViewerMediaBased implements Viewer {
+  private readonly traces: Array<Trace<MediaBasedTraceEntry>>;
+  private readonly htmlElement: HTMLElement;
+  private readonly presenter: Presenter;
+  private readonly view: View;
+
+  constructor(
+    traces: Traces,
+    type: TraceType.SCREENSHOT | TraceType.SCREEN_RECORDING,
+  ) {
+    this.traces = traces.getTraces(type);
+    this.htmlElement = document.createElement('viewer-media-based');
+
+    const notifyViewCallback = (uiData: UiData) => {
+      const component = this
+        .htmlElement as unknown as ViewerMediaBasedComponent;
+      component.titles = uiData.titles;
+      component.currentTraceEntries = uiData.currentTraceEntries;
+      component.forceMinimize = uiData.forceMinimize;
+    };
+    this.presenter = new Presenter(this.traces, notifyViewCallback);
+
+    this.view = new View(
+      ViewType.OVERLAY,
+      this.getTraces(),
+      this.htmlElement,
+      TRACE_INFO[type].name,
+    );
+  }
+
+  setEmitEvent(callback: EmitEvent) {
+    this.presenter.setEmitEvent(callback);
+  }
+
+  async onWinscopeEvent(event: WinscopeEvent) {
+    await this.presenter.onAppEvent(event);
+  }
+
+  getViews(): View[] {
+    return [this.view];
+  }
+
+  getTraces(): Array<Trace<MediaBasedTraceEntry>> {
+    return this.traces;
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component.ts b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component.ts
new file mode 100644
index 000000000..fab92083f
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component.ts
@@ -0,0 +1,318 @@
+/*
+ * Copyright (C) 2022 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+import {
+  ChangeDetectorRef,
+  Component,
+  ElementRef,
+  HostListener,
+  Inject,
+  Input,
+  NgZone,
+  SimpleChanges,
+} from '@angular/core';
+import {MatSelectChange} from '@angular/material/select';
+import {DomSanitizer, SafeUrl} from '@angular/platform-browser';
+import {assertDefined} from 'common/assert_utils';
+import {Size} from 'common/geometry/size';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+
+@Component({
+  selector: 'viewer-media-based',
+  template: `
+  <div class="overlay">
+    <mat-card class="container" cdkDrag cdkDragBoundary=".overlay">
+      <mat-card-title class="header">
+        <button mat-button class="button-drag draggable" cdkDragHandle>
+          <mat-icon class="drag-icon">drag_indicator</mat-icon>
+        </button>
+        <span
+          #titleText
+          *ngIf="titles.length <= 1"
+          cdkDragHandle
+          class="mat-body-2 overlay-title draggable"
+          [matTooltip]="titles.at(index)"
+          matTooltipPosition="above"
+          [matTooltipShowDelay]="300"
+          >{{ titles.at(0)?.split(".")[0].split(" ")[0] ?? 'Screen recording'}}</span>
+
+        <mat-select
+          *ngIf="titles.length > 1"
+          class="overlay-title select-title"
+          [matTooltip]="titles.at(index)"
+          matTooltipPosition="above"
+          [matTooltipShowDelay]="300"
+          (selectionChange)="onSelectChange($event)"
+          [value]="index">
+          <mat-option
+            *ngFor="let title of titles; index as i"
+            [value]="i">
+            {{ titles[i].split(".")[0] }}
+          </mat-option>
+        </mat-select>
+
+        <button mat-button class="button-minimize" [disabled]="forceMinimize" (click)="onMinimizeButtonClick()">
+          <mat-icon>
+            {{ isMinimized() ? 'maximize' : 'minimize' }}
+          </mat-icon>
+        </button>
+      </mat-card-title>
+      <div class="video-container" cdkDragHandle [style.height]="isMinimized() ? '0px' : ''">
+        <ng-container *ngIf="hasFrameToShow(); then video; else noVideo"> </ng-container>
+      </div>
+    </mat-card>
+
+    <ng-template #video>
+      <video
+        *ngIf="hasFrameToShow()"
+        [currentTime]="getCurrentTime()"
+        [src]="safeUrl"
+        #videoElement></video>
+    </ng-template>
+
+    <ng-template #noVideo>
+      <img *ngIf="hasImage()" [src]="safeUrl" />
+
+      <div class="no-video" *ngIf="!hasImage()">
+        <p class="mat-body-2">No frame to show.</p>
+      </div>
+    </ng-template>
+    </div>
+  `,
+  styles: [
+    `
+      .overlay {
+        z-index: 30;
+        position: fixed;
+        top: 0px;
+        left: 0px;
+        width: 100%;
+        height: 100%;
+        pointer-events: none;
+      }
+
+      .container {
+        pointer-events: all;
+        width: max(250px, 15vw);
+        min-width: 200px;
+        resize: horizontal;
+        overflow: hidden;
+        display: flex;
+        flex-direction: column;
+        padding: 0;
+        left: 80vw;
+        top: 20vh;
+      }
+
+      .header {
+        display: flex;
+        flex-direction: row;
+        margin: 0px;
+        border: 1px solid var(--border-color);
+        border-radius: 4px;
+        justify-content: space-between;
+        align-items: center;
+      }
+
+      .draggable {
+        cursor: grab;
+      }
+
+      .button-drag {
+        padding: 2px;
+        min-width: fit-content;
+      }
+
+      .overlay-title {
+        overflow: hidden;
+        text-overflow: ellipsis;
+        font-size: 14px;
+        width: unset;
+      }
+
+      .select-title {
+        display: flex;
+        align-items: center;
+      }
+
+      .button-minimize {
+        flex-grow: 0;
+        padding: 2px;
+        min-width: 24px;
+      }
+
+      .video-container, video, img {
+        border: 1px solid var(--default-border);
+        width: 100%;
+        height: auto;
+        cursor: grab;
+        overflow: hidden;
+      }
+
+      .no-video {
+        padding: 1rem;
+        text-align: center;
+      }
+    `,
+  ],
+})
+class ViewerMediaBasedComponent {
+  safeUrl: undefined | SafeUrl = undefined;
+  shouldMinimize = false;
+  index = 0;
+
+  constructor(
+    @Inject(DomSanitizer) private sanitizer: DomSanitizer,
+    @Inject(ElementRef) private elementRef: ElementRef<HTMLElement>,
+    @Inject(ChangeDetectorRef) private changeDetectorRef: ChangeDetectorRef,
+    @Inject(NgZone) private ngZone: NgZone,
+  ) {}
+
+  @Input() currentTraceEntries: MediaBasedTraceEntry[] = [];
+  @Input() titles: string[] = [];
+  @Input() forceMinimize = false;
+
+  private frameSize: Size = {width: 720, height: 1280}; // default for Flicker
+  private frameSizeWorker: number | undefined;
+
+  ngOnChanges(changes: SimpleChanges) {
+    this.changeDetectorRef.detectChanges();
+    if (this.currentTraceEntries.length === 0) {
+      return;
+    }
+
+    if (!changes['currentTraceEntries']) {
+      return;
+    }
+
+    if (this.safeUrl === undefined) {
+      this.updateSafeUrl();
+    }
+  }
+
+  ngAfterViewInit() {
+    this.resetFrameSizeWorker();
+    this.updateMaxContainerSize();
+  }
+
+  ngOnDestroy() {
+    this.clearFrameSizeWorker();
+  }
+
+  @HostListener('window:resize', ['$event'])
+  onResize(event: Event) {
+    this.updateMaxContainerSize();
+  }
+
+  onMinimizeButtonClick() {
+    this.shouldMinimize = !this.shouldMinimize;
+  }
+
+  isMinimized() {
+    return this.forceMinimize || this.shouldMinimize;
+  }
+
+  hasFrameToShow() {
+    const curr = this.currentTraceEntries.at(this.index);
+    return curr && !curr.isImage && curr.videoTimeSeconds !== undefined;
+  }
+
+  hasImage() {
+    return this.currentTraceEntries.at(this.index)?.isImage ?? false;
+  }
+
+  getCurrentTime(): number {
+    return this.currentTraceEntries.at(this.index)?.videoTimeSeconds ?? 0;
+  }
+
+  onSelectChange(event: MatSelectChange) {
+    this.index = event.value;
+    this.updateSafeUrl();
+    event.source.close();
+  }
+
+  private resetFrameSizeWorker() {
+    if (this.frameSizeWorker === undefined) {
+      this.frameSizeWorker = window.setInterval(
+        () => this.updateFrameSize(),
+        50,
+      );
+    }
+  }
+
+  private updateFrameSize() {
+    const video =
+      this.elementRef.nativeElement.querySelector<HTMLVideoElement>('video');
+    if (video && video.readyState) {
+      this.frameSize = {
+        width: video.videoWidth,
+        height: video.videoHeight,
+      };
+      this.clearFrameSizeWorker();
+      this.updateMaxContainerSize();
+      return;
+    }
+    const image =
+      this.elementRef.nativeElement.querySelector<HTMLImageElement>('img');
+    if (image) {
+      this.frameSize = {
+        width: image.naturalWidth,
+        height: image.naturalHeight,
+      };
+      this.clearFrameSizeWorker();
+      this.updateMaxContainerSize();
+    }
+  }
+
+  private updateSafeUrl() {
+    const curr = this.currentTraceEntries.at(this.index);
+    if (curr) {
+      this.safeUrl = this.sanitizer.bypassSecurityTrustUrl(
+        URL.createObjectURL(curr.videoData),
+      );
+      this.changeDetectorRef.detectChanges();
+      const video =
+        this.elementRef.nativeElement.querySelector<HTMLVideoElement>('video');
+      if (video) video.currentTime = this.getCurrentTime();
+      this.resetFrameSizeWorker();
+    }
+  }
+
+  private updateMaxContainerSize() {
+    this.ngZone.run(() => {
+      const container = assertDefined(
+        this.elementRef.nativeElement.querySelector<HTMLElement>('.container'),
+      );
+      const maxHeight = window.innerHeight - 140;
+      const headerHeight =
+        this.elementRef.nativeElement.querySelector('.header')?.clientHeight ??
+        0;
+      const maxWidth = Math.min(
+        ((maxHeight - headerHeight) * this.frameSize.width) /
+          this.frameSize.height,
+        window.innerWidth,
+      );
+      container.style.maxWidth = `${maxWidth}px`;
+      this.changeDetectorRef.detectChanges();
+    });
+  }
+
+  private clearFrameSizeWorker() {
+    window.clearInterval(this.frameSizeWorker);
+    this.frameSizeWorker = undefined;
+  }
+}
+
+export {ViewerMediaBasedComponent};
diff --git a/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component_test.ts b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component_test.ts
new file mode 100644
index 000000000..f50d9f9a9
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/viewer_media_based_component_test.ts
@@ -0,0 +1,289 @@
+/*
+ * Copyright (C) 2022 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Component, ViewChild} from '@angular/core';
+import {ComponentFixture, TestBed} from '@angular/core/testing';
+import {MatButtonModule} from '@angular/material/button';
+import {MatCardModule} from '@angular/material/card';
+import {MatIconModule} from '@angular/material/icon';
+import {MatSelectModule} from '@angular/material/select';
+import {MatTooltipModule} from '@angular/material/tooltip';
+import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
+import {assertDefined} from 'common/assert_utils';
+import {UnitTestUtils} from 'test/unit/utils';
+import {MediaBasedTraceEntry} from 'trace/media_based_trace_entry';
+import {ViewerMediaBasedComponent} from './viewer_media_based_component';
+
+describe('ViewerMediaBasedComponent', () => {
+  let fixture: ComponentFixture<TestHostComponent>;
+  let component: TestHostComponent;
+  let htmlElement: HTMLElement;
+
+  beforeEach(async () => {
+    await TestBed.configureTestingModule({
+      imports: [
+        MatCardModule,
+        MatTooltipModule,
+        MatButtonModule,
+        MatIconModule,
+        MatSelectModule,
+        BrowserAnimationsModule,
+      ],
+      declarations: [TestHostComponent, ViewerMediaBasedComponent],
+    }).compileComponents();
+
+    fixture = TestBed.createComponent(TestHostComponent);
+    component = fixture.componentInstance;
+    htmlElement = fixture.nativeElement;
+    fixture.detectChanges();
+  });
+
+  it('can be created', () => {
+    expect(component).toBeTruthy();
+  });
+
+  it('renders title correctly', () => {
+    const title = assertDefined(htmlElement.querySelector('.overlay-title'));
+    expect(title.textContent).toEqual('Screen recording');
+
+    component.titles = ['Screenshot'];
+    fixture.detectChanges();
+    expect(title.textContent).toEqual('Screenshot');
+
+    component.titles = ['Screenshot.png'];
+    fixture.detectChanges();
+    expect(title.textContent).toEqual('Screenshot');
+
+    component.titles = ['Screenshot.png (parent.zip)'];
+    fixture.detectChanges();
+    expect(title.textContent).toEqual('Screenshot');
+
+    component.titles = ['Screenshot (parent.zip)'];
+    fixture.detectChanges();
+    expect(title.textContent).toEqual('Screenshot');
+  });
+
+  it('can be minimized and maximized', () => {
+    const buttonMinimize = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.button-minimize'),
+    );
+    const videoContainer = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.video-container'),
+    );
+    expect(videoContainer.style.height).toEqual('');
+
+    buttonMinimize.click();
+    fixture.detectChanges();
+    expect(videoContainer.style.height).toEqual('0px');
+
+    buttonMinimize.click();
+    fixture.detectChanges();
+    expect(videoContainer.style.height).toEqual('');
+  });
+
+  it('forces minimized state', () => {
+    component.forceMinimize = true;
+    fixture.detectChanges();
+
+    const buttonMinimize = assertDefined(
+      htmlElement.querySelector<HTMLButtonElement>('.button-minimize'),
+    );
+    const videoContainer = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.video-container'),
+    );
+    expect(videoContainer.style.height).toEqual('0px');
+    expect(buttonMinimize.disabled).toBeTrue();
+
+    component.forceMinimize = false;
+    fixture.detectChanges();
+    expect(videoContainer.style.height).toEqual('');
+    expect(buttonMinimize.disabled).toBeFalse();
+  });
+
+  it('shows video', async () => {
+    const initialMaxWidth = getContainerMaxWidth();
+    const videoFile = await UnitTestUtils.getFixtureFile(
+      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
+    );
+    component.currentTraceEntries = [new MediaBasedTraceEntry(1, videoFile)];
+    fixture.detectChanges();
+    await fixture.whenStable();
+    const videoContainer = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.video-container'),
+    );
+    expect(videoContainer.querySelector('video')).toBeTruthy();
+    expect(videoContainer.querySelector('img')).toBeNull();
+    expect(getContainerMaxWidth()).not.toEqual(initialMaxWidth);
+  });
+
+  it('shows screenshot image', async () => {
+    const initialMaxWidth = getContainerMaxWidth();
+    const screenshotFile = await UnitTestUtils.getFixtureFile(
+      'traces/screenshot_2.png',
+    );
+    component.currentTraceEntries = [
+      new MediaBasedTraceEntry(0, screenshotFile, true),
+    ];
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    const videoContainer = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.video-container'),
+    );
+    expect(videoContainer.querySelector('img')).toBeTruthy();
+    expect(videoContainer.querySelector('video')).toBeNull();
+    expect(getContainerMaxWidth()).not.toEqual(initialMaxWidth);
+  });
+
+  it('shows no frame message', () => {
+    const videoContainer = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.video-container'),
+    );
+    expect(videoContainer.textContent).toContain('No frame to show');
+  });
+
+  it('selector changes entry shown', async () => {
+    component.currentTraceEntries = [
+      new MediaBasedTraceEntry(0, new Blob(), true),
+      new MediaBasedTraceEntry(0, new Blob(), true),
+    ];
+    component.titles = ['Screenshot 1', 'Screenshot 2'];
+    fixture.detectChanges();
+
+    const screenComponent = assertDefined(component.screenComponent);
+    let url = screenComponent.safeUrl;
+
+    await openSelect();
+    const options = document.querySelectorAll<HTMLElement>('mat-option');
+
+    options.item(1).click();
+    fixture.detectChanges();
+    expect(screenComponent.safeUrl).not.toEqual(url);
+    url = screenComponent.safeUrl;
+
+    options.item(1).click();
+    fixture.detectChanges();
+    expect(screenComponent.safeUrl).toEqual(url);
+
+    options.item(0).click();
+    fixture.detectChanges();
+    expect(screenComponent.safeUrl).not.toEqual(url);
+    url = screenComponent.safeUrl;
+
+    options.item(0).click();
+    fixture.detectChanges();
+    expect(screenComponent.safeUrl).toEqual(url);
+  });
+
+  it('video current time updated correctly on entry change', async () => {
+    component.currentTraceEntries = [
+      new MediaBasedTraceEntry(10, new Blob(), false),
+      new MediaBasedTraceEntry(15, new Blob(), false),
+    ];
+    component.titles = ['Recording 1', 'Recording 2'];
+    fixture.detectChanges();
+
+    expect(
+      htmlElement.querySelector<HTMLVideoElement>('video')?.currentTime,
+    ).toEqual(10);
+
+    await openSelect();
+    const options = document.querySelectorAll<HTMLElement>('mat-option');
+
+    options.item(1).click();
+    fixture.detectChanges();
+    expect(
+      htmlElement.querySelector<HTMLVideoElement>('video')?.currentTime,
+    ).toEqual(15);
+  });
+
+  it('does not update frame if trace entries do not change', () => {
+    component.currentTraceEntries = [
+      new MediaBasedTraceEntry(0, new Blob(), true),
+    ];
+    component.titles = ['Screenshot 1'];
+    fixture.detectChanges();
+
+    const screenComponent = assertDefined(component.screenComponent);
+    const url = screenComponent.safeUrl;
+
+    component.titles = ['Screenshot 1', 'Screenshot 2'];
+    fixture.detectChanges();
+    expect(screenComponent.safeUrl).toEqual(url);
+  });
+
+  it('updates max container size on window resize', async () => {
+    const screenshotFile = await UnitTestUtils.getFixtureFile(
+      'traces/screenshot.png',
+    );
+    component.currentTraceEntries = [
+      new MediaBasedTraceEntry(0, screenshotFile, true),
+    ];
+    fixture.detectChanges();
+    await fixture.whenStable();
+
+    const initialMaxWidth = getContainerMaxWidth();
+    const newWindowHeight = window.innerHeight / 2;
+    spyOnProperty(window, 'innerHeight').and.returnValue(newWindowHeight);
+    resizeWindow();
+    const maxWidthAfterNewWindowHeight = getContainerMaxWidth();
+    expect(maxWidthAfterNewWindowHeight < initialMaxWidth).toBeTrue();
+
+    const newWindowWidth = maxWidthAfterNewWindowHeight / 2;
+    spyOnProperty(window, 'innerWidth').and.returnValue(newWindowWidth);
+    resizeWindow();
+    expect(getContainerMaxWidth() < maxWidthAfterNewWindowHeight).toBeTrue();
+  });
+
+  function getContainerMaxWidth(): number {
+    const container = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.container'),
+    );
+    return Number(container.style.maxWidth.slice(0, -2));
+  }
+
+  async function openSelect() {
+    const selectTrigger = assertDefined(
+      htmlElement.querySelector<HTMLElement>('.mat-select-trigger'),
+    );
+    selectTrigger.click();
+    fixture.detectChanges();
+  }
+
+  async function resizeWindow() {
+    window.dispatchEvent(new Event('resize'));
+    fixture.detectChanges();
+    await fixture.whenStable();
+  }
+
+  @Component({
+    selector: 'host-component',
+    template: `
+      <viewer-media-based
+        [currentTraceEntries]="currentTraceEntries"
+        [titles]="titles"
+        [forceMinimize]="forceMinimize"></viewer-media-based>
+    `,
+  })
+  class TestHostComponent {
+    currentTraceEntries: MediaBasedTraceEntry[] = [];
+    titles: string[] = [];
+    forceMinimize = false;
+
+    @ViewChild(ViewerMediaBasedComponent)
+    screenComponent: ViewerMediaBasedComponent | undefined;
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_media_based/viewer_screen_recording.ts b/tools/winscope/src/viewers/viewer_media_based/viewer_screen_recording.ts
new file mode 100644
index 000000000..b912ac177
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/viewer_screen_recording.ts
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2022 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {ViewerMediaBased} from './viewer_media_based';
+
+export class ViewerScreenRecording extends ViewerMediaBased {
+  static readonly DEPENDENCIES: TraceType[] = [TraceType.SCREEN_RECORDING];
+
+  constructor(traces: Traces) {
+    super(traces, TraceType.SCREEN_RECORDING);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_media_based/viewer_screenshot.ts b/tools/winscope/src/viewers/viewer_media_based/viewer_screenshot.ts
new file mode 100644
index 000000000..f0484d0c0
--- /dev/null
+++ b/tools/winscope/src/viewers/viewer_media_based/viewer_screenshot.ts
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
+import {ViewerMediaBased} from './viewer_media_based';
+
+export class ViewerScreenshot extends ViewerMediaBased {
+  static readonly DEPENDENCIES: TraceType[] = [TraceType.SCREENSHOT];
+
+  constructor(traces: Traces) {
+    super(traces, TraceType.SCREENSHOT);
+  }
+}
diff --git a/tools/winscope/src/viewers/viewer_protolog/presenter.ts b/tools/winscope/src/viewers/viewer_protolog/presenter.ts
index 5f2d42e1d..b73bdbd9e 100644
--- a/tools/winscope/src/viewers/viewer_protolog/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/presenter.ts
@@ -14,139 +14,84 @@
  * limitations under the License.
  */
 
-import {ArrayUtils} from 'common/array_utils';
 import {assertDefined} from 'common/assert_utils';
-import {FunctionUtils} from 'common/function_utils';
+import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
+import {Trace} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {
-  TracePositionUpdate,
-  WinscopeEvent,
-  WinscopeEventType,
-} from 'messaging/winscope_event';
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {
-  EmitEvent,
-  WinscopeEventEmitter,
-} from 'messaging/winscope_event_emitter';
-import {AbsoluteEntryIndex, Trace, TraceEntry} from 'trace/trace';
-import {TraceEntryFinder} from 'trace/trace_entry_finder';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {UiData, UiDataMessage} from './ui_data';
-
-export class Presenter implements WinscopeEventEmitter {
-  private readonly trace: Trace<PropertyTreeNode>;
-  private readonly notifyUiDataCallback: (data: UiData) => void;
-  private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
-  private entry?: TraceEntry<PropertyTreeNode>;
-  private uiData = UiData.EMPTY;
-  private originalIndicesOfFilteredOutputMessages: number[] = [];
-
+  LogEntry,
+  LogField,
+  LogFieldType,
+  LogFilter,
+} from 'viewers/common/ui_data_log';
+import {ProtologEntry, UiData} from './ui_data';
+
+export class Presenter extends AbstractLogViewerPresenter<UiData> {
+  static readonly FIELD_TYPES = [
+    LogFieldType.LOG_LEVEL,
+    LogFieldType.TAG,
+    LogFieldType.SOURCE_FILE,
+    LogFieldType.TEXT,
+  ];
   private isInitialized = false;
-  private allUiDataMessages: UiDataMessage[] = [];
-  private allTags: string[] = [];
-  private allSourceFiles: string[] = [];
-  private allLogLevels: string[] = [];
 
-  private tagsFilter: string[] = [];
-  private filesFilter: string[] = [];
-  private levelsFilter: string[] = [];
-  private searchString = '';
+  protected override logPresenter = new LogPresenter<LogEntry>();
 
   constructor(
     trace: Trace<PropertyTreeNode>,
-    notifyUiDataCallback: (data: UiData) => void,
+    notifyViewCallback: NotifyLogViewCallbackType<UiData>,
+    private storage: Store,
   ) {
-    this.trace = trace;
-    this.notifyUiDataCallback = notifyUiDataCallback;
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  setEmitEvent(callback: EmitEvent) {
-    this.emitAppEvent = callback;
-  }
-
-  async onAppEvent(event: WinscopeEvent) {
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.initializeIfNeeded();
-        this.entry = TraceEntryFinder.findCorrespondingEntry(
-          this.trace,
-          event.position,
-        );
-        this.computeUiDataCurrentMessageIndex();
-        this.notifyUiDataCallback(this.uiData);
-      },
-    );
-  }
-
-  onLogLevelsFilterChanged(levels: string[]) {
-    this.levelsFilter = levels;
-    this.computeUiData();
-    this.computeUiDataCurrentMessageIndex();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onTagsFilterChanged(tags: string[]) {
-    this.tagsFilter = tags;
-    this.computeUiData();
-    this.computeUiDataCurrentMessageIndex();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onSourceFilesFilterChanged(files: string[]) {
-    this.filesFilter = files;
-    this.computeUiData();
-    this.computeUiDataCurrentMessageIndex();
-    this.notifyUiDataCallback(this.uiData);
+    super(trace, notifyViewCallback, UiData.createEmpty());
   }
 
-  onSearchStringFilterChanged(searchString: string) {
-    this.searchString = searchString;
-    this.computeUiData();
-    this.computeUiDataCurrentMessageIndex();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onMessageClicked(index: number) {
-    if (this.uiData.selectedMessageIndex === index) {
-      this.uiData.selectedMessageIndex = undefined;
-    } else {
-      this.uiData.selectedMessageIndex = index;
-    }
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  async onLogTimestampClicked(traceIndex: AbsoluteEntryIndex) {
-    await this.emitAppEvent(
-      TracePositionUpdate.fromTraceEntry(this.trace.getEntry(traceIndex), true),
-    );
-  }
-
-  private async initializeIfNeeded() {
+  protected override async initializeIfNeeded() {
     if (this.isInitialized) {
       return;
     }
-    this.allUiDataMessages = await this.makeAllUiDataMessages();
-
-    this.allLogLevels = this.getUniqueMessageValues(
-      this.allUiDataMessages,
-      (message: UiDataMessage) => message.level,
-    );
-    this.allTags = this.getUniqueMessageValues(
-      this.allUiDataMessages,
-      (message: UiDataMessage) => message.tag,
-    );
-    this.allSourceFiles = this.getUniqueMessageValues(
-      this.allUiDataMessages,
-      (message: UiDataMessage) => message.at,
-    );
+    const allEntries = await this.makeAllUiDataMessages();
+    const filters: LogFilter[] = [];
+
+    for (const type of Presenter.FIELD_TYPES) {
+      if (type === LogFieldType.TEXT) {
+        filters.push({
+          type,
+          textFilter: PersistentStoreProxy.new(
+            'ProtoLog' + type,
+            new TextFilter('', []),
+            this.storage,
+          ),
+        });
+      } else {
+        filters.push({
+          type,
+          options: this.getUniqueMessageValues(
+            allEntries,
+            (entry: ProtologEntry) =>
+              assertDefined(
+                entry.fields.find((f) => f.type === type),
+              ).value.toString(),
+          ),
+        });
+      }
+    }
 
-    this.computeUiData();
+    this.logPresenter.setAllEntries(allEntries);
+    this.logPresenter.setFilters(filters);
 
+    this.refreshUiData();
     this.isInitialized = true;
   }
 
-  private async makeAllUiDataMessages(): Promise<UiDataMessage[]> {
-    const messages: PropertyTreeNode[] = [];
+  private async makeAllUiDataMessages(): Promise<ProtologEntry[]> {
+    const messages: ProtologEntry[] = [];
 
     for (
       let traceIndex = 0;
@@ -154,86 +99,42 @@ export class Presenter implements WinscopeEventEmitter {
       ++traceIndex
     ) {
       const entry = assertDefined(this.trace.getEntry(traceIndex));
-      const message = await entry.getValue();
-      messages.push(message);
-    }
-
-    return messages.map((messageNode, index) => {
-      return {
-        traceIndex: index,
-        text: assertDefined(
-          messageNode.getChildByName('text'),
-        ).formattedValue(),
-        time: assertDefined(messageNode.getChildByName('timestamp')),
-        tag: assertDefined(messageNode.getChildByName('tag')).formattedValue(),
-        level: assertDefined(
-          messageNode.getChildByName('level'),
-        ).formattedValue(),
-        at: assertDefined(messageNode.getChildByName('at')).formattedValue(),
-      };
-    });
-  }
-
-  private computeUiData() {
-    let filteredMessages = this.allUiDataMessages;
-
-    if (this.levelsFilter.length > 0) {
-      filteredMessages = filteredMessages.filter((value) =>
-        this.levelsFilter.includes(value.level),
-      );
-    }
-
-    if (this.tagsFilter.length > 0) {
-      filteredMessages = filteredMessages.filter((value) =>
-        this.tagsFilter.includes(value.tag),
-      );
-    }
-
-    if (this.filesFilter.length > 0) {
-      filteredMessages = filteredMessages.filter((value) =>
-        this.filesFilter.includes(value.at),
-      );
-    }
-
-    filteredMessages = filteredMessages.filter((value) =>
-      value.text.includes(this.searchString),
-    );
-
-    this.originalIndicesOfFilteredOutputMessages = filteredMessages.map(
-      (message) => message.traceIndex,
-    );
-
-    this.uiData = new UiData(
-      this.allLogLevels,
-      this.allTags,
-      this.allSourceFiles,
-      filteredMessages,
-      undefined,
-      undefined,
-    );
-  }
-
-  private computeUiDataCurrentMessageIndex() {
-    if (!this.entry) {
-      this.uiData.currentMessageIndex = undefined;
-      return;
-    }
-
-    if (this.originalIndicesOfFilteredOutputMessages.length === 0) {
-      this.uiData.currentMessageIndex = undefined;
-      return;
+      const messageNode = await entry.getValue();
+      const fields: LogField[] = [
+        {
+          type: LogFieldType.LOG_LEVEL,
+          value: assertDefined(
+            messageNode.getChildByName('level'),
+          ).formattedValue(),
+        },
+        {
+          type: LogFieldType.TAG,
+          value: assertDefined(
+            messageNode.getChildByName('tag'),
+          ).formattedValue(),
+        },
+        {
+          type: LogFieldType.SOURCE_FILE,
+          value: assertDefined(
+            messageNode.getChildByName('at'),
+          ).formattedValue(),
+        },
+        {
+          type: LogFieldType.TEXT,
+          value: assertDefined(
+            messageNode.getChildByName('text'),
+          ).formattedValue(),
+        },
+      ];
+      messages.push(new ProtologEntry(entry, fields));
     }
 
-    this.uiData.currentMessageIndex =
-      ArrayUtils.binarySearchFirstGreaterOrEqual(
-        this.originalIndicesOfFilteredOutputMessages,
-        this.entry.getIndex(),
-      ) ?? this.originalIndicesOfFilteredOutputMessages.length - 1;
+    return messages;
   }
 
   private getUniqueMessageValues(
-    allMessages: UiDataMessage[],
-    getValue: (message: UiDataMessage) => string,
+    allMessages: ProtologEntry[],
+    getValue: (message: ProtologEntry) => string,
   ): string[] {
     const uniqueValues = new Set<string>();
     allMessages.forEach((message) => {
diff --git a/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts b/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
index 46060d3e0..bca69f156 100644
--- a/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/presenter_test.ts
@@ -15,10 +15,10 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {InMemoryStorage} from 'common/in_memory_storage';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
-import {TracesBuilder} from 'test/unit/traces_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {Trace} from 'trace/trace';
 import {TraceType} from 'trace/trace_type';
@@ -27,19 +27,121 @@ import {
   TIMESTAMP_NODE_FORMATTER,
 } from 'trace/tree_node/formatters';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {TextFilter} from 'viewers/common/text_filter';
+import {LogFieldType, LogFieldValue} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
-import {UiData, UiDataMessage} from './ui_data';
-
-describe('ViewerProtoLogPresenter', () => {
-  let presenter: Presenter;
-  let inputMessages: UiDataMessage[];
-  let trace: Trace<PropertyTreeNode>;
-  let positionUpdate10: TracePositionUpdate;
-  let positionUpdate11: TracePositionUpdate;
-  let positionUpdate12: TracePositionUpdate;
-  let outputUiData: undefined | UiData;
+import {UiData} from './ui_data';
+
+class PresenterProtologTest extends AbstractLogViewerPresenterTest<UiData> {
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private secondPositionUpdate: TracePositionUpdate | undefined;
+
+  override readonly shouldExecuteHeaderTests = false;
+  override readonly shouldExecuteFilterTests = true;
+  override readonly shouldExecutePropertiesTests = false;
+
+  override readonly totalOutputEntries = 3;
+  override readonly expectedIndexOfFirstPositionUpdate = 0;
+  override readonly expectedIndexOfSecondPositionUpdate = 1;
+  override readonly expectedInitialFilterOptions = new Map<
+    LogFieldType,
+    string[] | number
+  >([
+    [LogFieldType.LOG_LEVEL, ['level0', 'level1', 'level2']],
+    [LogFieldType.TAG, ['tag0', 'tag1', 'tag2']],
+    [LogFieldType.SOURCE_FILE, ['sourcefile0', 'sourcefile1', 'sourcefile2']],
+  ]);
+  override readonly filterValuesToSet = new Map<
+    LogFieldType,
+    Array<string | string[]>
+  >([
+    [LogFieldType.LOG_LEVEL, [[], ['level1'], ['level0', 'level1', 'level2']]],
+    [LogFieldType.TAG, [[], ['tag1'], ['tag0', 'tag1', 'tag2']]],
+    [
+      LogFieldType.SOURCE_FILE,
+      [[], ['sourcefile1'], ['sourcefile0', 'sourcefile1', 'sourcefile2']],
+    ],
+    [LogFieldType.TEXT, [[], 'text', 'text0', 'text1']],
+  ]);
+  override readonly expectedFieldValuesAfterFilter = new Map<
+    LogFieldType,
+    Array<LogFieldValue[] | number>
+  >([
+    [
+      LogFieldType.LOG_LEVEL,
+      [this.totalOutputEntries, ['level1'], ['level0', 'level1', 'level2']],
+    ],
+    [
+      LogFieldType.TAG,
+      [this.totalOutputEntries, ['tag1'], ['tag0', 'tag1', 'tag2']],
+    ],
+    [
+      LogFieldType.SOURCE_FILE,
+      [
+        this.totalOutputEntries,
+        ['sourcefile1'],
+        ['sourcefile0', 'sourcefile1', 'sourcefile2'],
+      ],
+    ],
+    [
+      LogFieldType.TEXT,
+      [
+        this.totalOutputEntries,
+        ['text0', 'text1', 'text2'],
+        ['text0'],
+        ['text1'],
+      ],
+    ],
+  ]);
+  override readonly logEntryClickIndex = 10;
+  override readonly filterNameForCurrentIndexTest = LogFieldType.LOG_LEVEL;
+  override readonly filterChangeForCurrentIndexTest = ['level1'];
+  override readonly expectedCurrentIndexAfterFilterChange = 0;
+  override readonly secondFilterChangeForCurrentIndexTest = [
+    'level0',
+    'level1',
+  ];
+  override readonly expectedCurrentIndexAfterSecondFilterChange = 1;
+
+  override executeSpecializedTests() {
+    describe('Specialized tests', () => {
+      let presenter: Presenter;
+      let uiData: UiData;
+
+      beforeAll(async () => {
+        await this.setUpTestEnvironment();
+      });
+
+      beforeEach(async () => {
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        presenter = await this.createPresenter(notifyViewCallback);
+      });
+
+      it('handles text filter change', async () => {
+        await presenter.onAppEvent(this.getSecondPositionUpdate());
+        expect(uiData.entries.length).toEqual(3);
+        expect(uiData.currentIndex).toEqual(1);
+        expect(uiData.scrollToIndex).toEqual(1);
+        expect(uiData.selectedIndex).toEqual(undefined);
+
+        await presenter.onTextFilterChange(
+          LogFieldType.TEXT,
+          new TextFilter('text0', []),
+        );
+        expect(uiData.entries.length).toEqual(1);
+        expect(uiData.currentIndex).toEqual(0);
+        expect(uiData.scrollToIndex).toEqual(0);
+        expect(uiData.selectedIndex).toEqual(undefined);
+      });
+    });
+  }
 
-  beforeEach(async () => {
+  override async setUpTestEnvironment(): Promise<void> {
     const time10 = TimestampConverterUtils.makeRealTimestamp(10n);
     const time11 = TimestampConverterUtils.makeRealTimestamp(11n);
     const time12 = TimestampConverterUtils.makeRealTimestamp(12n);
@@ -121,179 +223,46 @@ describe('ViewerProtoLogPresenter', () => {
         .build(),
     ];
 
-    inputMessages = [
-      {
-        traceIndex: 0,
-        text: 'text0',
-        time: assertDefined(entries[0].getChildByName('timestamp')),
-        tag: 'tag0',
-        level: 'level0',
-        at: 'sourcefile0',
-      },
-      {
-        traceIndex: 1,
-        text: 'text1',
-        time: assertDefined(entries[1].getChildByName('timestamp')),
-        tag: 'tag1',
-        level: 'level1',
-        at: 'sourcefile1',
-      },
-      {
-        traceIndex: 2,
-        text: 'text2',
-        time: assertDefined(entries[2].getChildByName('timestamp')),
-        tag: 'tag2',
-        level: 'level2',
-        at: 'sourcefile2',
-      },
-    ];
-
-    trace = new TraceBuilder<PropertyTreeNode>()
+    this.trace = new TraceBuilder<PropertyTreeNode>()
       .setEntries(entries)
       .setTimestamps([time10, time11, time12])
       .build();
 
-    positionUpdate10 = TracePositionUpdate.fromTimestamp(time10);
-    positionUpdate11 = TracePositionUpdate.fromTimestamp(time11);
-    positionUpdate12 = TracePositionUpdate.fromTimestamp(time12);
-
-    outputUiData = undefined;
+    this.positionUpdate = TracePositionUpdate.fromTimestamp(time10);
+    this.secondPositionUpdate = TracePositionUpdate.fromTimestamp(time11);
+  }
 
-    presenter = new Presenter(trace, (data: UiData) => {
-      outputUiData = data;
-    });
-    await presenter.onAppEvent(positionUpdate10); // trigger initialization
-  });
-
-  it('is robust to empty trace', async () => {
-    const traces = new TracesBuilder()
-      .setEntries(TraceType.PROTO_LOG, [])
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const emptyTrace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.PROTO_LOG)
+      .setEntries([])
       .build();
-    const trace = new TraceBuilder<PropertyTreeNode>().setEntries([]).build();
-    presenter = new Presenter(trace, (data: UiData) => {
-      outputUiData = data;
-    });
-
-    const uiData = assertDefined(outputUiData);
-    expect(uiData.messages).toEqual([]);
-    expect(uiData.currentMessageIndex).toBeUndefined();
-
-    await presenter.onAppEvent(positionUpdate10);
-
-    const newUiData = assertDefined(outputUiData);
-    expect(newUiData.messages).toEqual([]);
-    expect(newUiData.currentMessageIndex).toBeUndefined();
-  });
-
-  it('processes trace position updates', async () => {
-    await presenter.onAppEvent(positionUpdate10);
-
-    const uiData = assertDefined(outputUiData);
-    expect(uiData.allLogLevels).toEqual(['level0', 'level1', 'level2']);
-    expect(uiData.allTags).toEqual(['tag0', 'tag1', 'tag2']);
-    expect(uiData.allSourceFiles).toEqual([
-      'sourcefile0',
-      'sourcefile1',
-      'sourcefile2',
-    ]);
-    expect(uiData.messages).toEqual(inputMessages);
-    expect(uiData.currentMessageIndex).toEqual(0);
-  });
-
-  it('updates displayed messages according to log levels filter', () => {
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onLogLevelsFilterChanged([]);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onLogLevelsFilterChanged(['level1']);
-    expect(assertDefined(outputUiData).messages).toEqual([inputMessages[1]]);
-
-    presenter.onLogLevelsFilterChanged(['level0', 'level1', 'level2']);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-  });
-
-  it('updates displayed messages according to tags filter', () => {
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onTagsFilterChanged([]);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onTagsFilterChanged(['tag1']);
-    expect(assertDefined(outputUiData).messages).toEqual([inputMessages[1]]);
-
-    presenter.onTagsFilterChanged(['tag0', 'tag1', 'tag2']);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-  });
-
-  it('updates displayed messages according to source files filter', () => {
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onSourceFilesFilterChanged([]);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onSourceFilesFilterChanged(['sourcefile1']);
-    expect(assertDefined(outputUiData).messages).toEqual([inputMessages[1]]);
-
-    presenter.onSourceFilesFilterChanged([
-      'sourcefile0',
-      'sourcefile1',
-      'sourcefile2',
-    ]);
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-  });
-
-  it('updates displayed messages according to search string filter', () => {
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onSearchStringFilterChanged('');
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onSearchStringFilterChanged('text');
-    expect(assertDefined(outputUiData).messages).toEqual(inputMessages);
-
-    presenter.onSearchStringFilterChanged('text0');
-    expect(assertDefined(outputUiData).messages).toEqual([inputMessages[0]]);
-
-    presenter.onSearchStringFilterChanged('text1');
-    expect(assertDefined(outputUiData).messages).toEqual([inputMessages[1]]);
-  });
-
-  it('computes current message index', async () => {
-    // Position -> entry #0
-    await presenter.onAppEvent(positionUpdate10);
-    presenter.onLogLevelsFilterChanged([]);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(0);
-
-    presenter.onLogLevelsFilterChanged(['level0']);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(0);
-
-    presenter.onLogLevelsFilterChanged([]);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(0);
-
-    // Position -> entry #1
-    await presenter.onAppEvent(positionUpdate11);
-    presenter.onLogLevelsFilterChanged([]);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(1);
-
-    presenter.onLogLevelsFilterChanged(['level0']);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(0);
-
-    presenter.onLogLevelsFilterChanged(['level1']);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(0);
-
-    presenter.onLogLevelsFilterChanged(['level0', 'level1']);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(1);
-
-    // Position -> entry #2
-    await presenter.onAppEvent(positionUpdate12);
-    presenter.onLogLevelsFilterChanged([]);
-    expect(assertDefined(outputUiData).currentMessageIndex).toEqual(2);
-  });
-
-  it('updates selected message index', () => {
-    expect(assertDefined(outputUiData).selectedMessageIndex).toBeUndefined();
-    presenter.onMessageClicked(3);
-    expect(assertDefined(outputUiData).selectedMessageIndex).toEqual(3);
-  });
+    return new Presenter(emptyTrace, callback, new InMemoryStorage());
+  }
+
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const presenter = new Presenter(
+      assertDefined(this.trace),
+      callback,
+      new InMemoryStorage(),
+    );
+    await presenter.onAppEvent(this.getPositionUpdate()); // trigger initialization
+    return presenter;
+  }
+
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
+  }
+
+  override getSecondPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.secondPositionUpdate);
+  }
+}
+
+describe('PresenterProtolog', () => {
+  new PresenterProtologTest().execute();
 });
diff --git a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive.ts b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive.ts
index e00b4b13c..3102f05b9 100644
--- a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_directive.ts
@@ -17,7 +17,7 @@
 import {VIRTUAL_SCROLL_STRATEGY} from '@angular/cdk/scrolling';
 import {Directive, forwardRef} from '@angular/core';
 import {VariableHeightScrollDirective} from 'viewers/common/variable_height_scroll_directive';
-import {UiDataMessage} from 'viewers/viewer_protolog/ui_data';
+import {ProtologEntry} from 'viewers/viewer_protolog/ui_data';
 import {ProtologScrollStrategy} from './protolog_scroll_strategy';
 
 @Directive({
@@ -30,6 +30,6 @@ import {ProtologScrollStrategy} from './protolog_scroll_strategy';
     },
   ],
 })
-export class ProtologScrollDirective extends VariableHeightScrollDirective<UiDataMessage> {
+export class ProtologScrollDirective extends VariableHeightScrollDirective<ProtologEntry> {
   scrollStrategy = new ProtologScrollStrategy();
 }
diff --git a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
index bffffdfa2..22d085be7 100644
--- a/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/scroll_strategy/protolog_scroll_strategy.ts
@@ -14,8 +14,10 @@
  * limitations under the License.
  */
 
+import {assertDefined} from 'common/assert_utils';
+import {LogFieldType} from 'viewers/common/ui_data_log';
 import {VariableHeightScrollStrategy} from 'viewers/common/variable_height_scroll_strategy';
-import {UiDataMessage} from 'viewers/viewer_protolog/ui_data';
+import {ProtologEntry} from 'viewers/viewer_protolog/ui_data';
 
 export class ProtologScrollStrategy extends VariableHeightScrollStrategy {
   protected readonly defaultRowSize = 16;
@@ -23,14 +25,20 @@ export class ProtologScrollStrategy extends VariableHeightScrollStrategy {
   private readonly timestampCharsPerRow = 20;
   private readonly sourceFileCharsPerRow = 50;
 
-  protected override predictScrollItemHeight(message: UiDataMessage): number {
-    const textHeight = this.subItemHeight(message.text, this.textCharsPerRow);
+  protected override predictScrollItemHeight(entry: ProtologEntry): number {
+    const textHeight = this.subItemHeight(
+      assertDefined(entry.fields.find((f) => f.type === LogFieldType.TEXT))
+        .value as string,
+      this.textCharsPerRow,
+    );
     const timestampHeight = this.subItemHeight(
-      message.time.formattedValue(),
+      entry.traceEntry.getTimestamp().format(),
       this.timestampCharsPerRow,
     );
     const sourceFileHeight = this.subItemHeight(
-      message.at,
+      assertDefined(
+        entry.fields.find((f) => f.type === LogFieldType.SOURCE_FILE),
+      ).value as string,
       this.sourceFileCharsPerRow,
     );
     return Math.max(textHeight, timestampHeight, sourceFileHeight);
diff --git a/tools/winscope/src/viewers/viewer_protolog/ui_data.ts b/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
index f9b6264a2..7a8d14a45 100644
--- a/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/ui_data.ts
@@ -14,27 +14,32 @@
  * limitations under the License.
  */
 
-import {AbsoluteEntryIndex} from 'trace/index_types';
+import {TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  LogEntry,
+  LogField,
+  LogFilter,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
 
-export interface UiDataMessage {
-  readonly traceIndex: AbsoluteEntryIndex;
-  readonly text: string;
-  readonly time: PropertyTreeNode;
-  readonly tag: string;
-  readonly level: string;
-  readonly at: string;
+export class UiData implements UiDataLog {
+  constructor(
+    public filters: LogFilter[],
+    public entries: LogEntry[],
+    public currentIndex: undefined | number,
+    public selectedIndex: undefined | number,
+    public scrollToIndex: undefined | number,
+  ) {}
+
+  static createEmpty(): UiData {
+    return new UiData([], [], undefined, undefined, undefined);
+  }
 }
 
-export class UiData {
+export class ProtologEntry implements LogEntry {
   constructor(
-    public allLogLevels: string[],
-    public allTags: string[],
-    public allSourceFiles: string[],
-    public messages: UiDataMessage[],
-    public currentMessageIndex: undefined | number,
-    public selectedMessageIndex: undefined | number,
+    public traceEntry: TraceEntry<PropertyTreeNode>,
+    public fields: LogField[],
   ) {}
-
-  static EMPTY = new UiData([], [], [], [], undefined, undefined);
 }
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
index 0f9c82a52..e70f27c66 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog.ts
@@ -14,17 +14,18 @@
  * limitations under the License.
  */
 
-import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
+import {ViewerProtologComponent} from './viewer_protolog_component';
 
 class ViewerProtoLog implements Viewer {
   static readonly DEPENDENCIES: TraceType[] = [TraceType.PROTO_LOG];
@@ -34,58 +35,21 @@ class ViewerProtoLog implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(trace: Trace<PropertyTreeNode>, traces: Traces) {
+  constructor(trace: Trace<PropertyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-protolog');
-
-    this.presenter = new Presenter(trace, (data: UiData) => {
-      (this.htmlElement as any).inputData = data;
-    });
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.LogLevelsFilterChanged,
-      (event) => {
-        this.presenter.onLogLevelsFilterChanged((event as CustomEvent).detail);
-      },
-    );
-    this.htmlElement.addEventListener(
-      ViewerEvents.TagsFilterChanged,
-      (event) => {
-        this.presenter.onTagsFilterChanged((event as CustomEvent).detail);
-      },
-    );
-    this.htmlElement.addEventListener(
-      ViewerEvents.SourceFilesFilterChanged,
-      (event) => {
-        this.presenter.onSourceFilesFilterChanged(
-          (event as CustomEvent).detail,
-        );
-      },
-    );
-    this.htmlElement.addEventListener(
-      ViewerEvents.SearchStringFilterChanged,
-      (event) => {
-        this.presenter.onSearchStringFilterChanged(
-          (event as CustomEvent).detail,
-        );
-      },
-    );
-    this.htmlElement.addEventListener(ViewerEvents.LogClicked, (event) => {
-      this.presenter.onMessageClicked((event as CustomEvent).detail);
-    });
-    this.htmlElement.addEventListener(
-      ViewerEvents.TimestampClick,
-      async (event) => {
-        const detail: TimestampClickDetail = (event as CustomEvent).detail;
-        await this.presenter.onLogTimestampClicked(assertDefined(detail.index));
-      },
-    );
+    (this.htmlElement as unknown as ViewerProtologComponent).store = storage;
+    const notifyViewCallback = (data: UiData) => {
+      (this.htmlElement as unknown as ViewerProtologComponent).inputData = data;
+    };
+    this.presenter = new Presenter(trace, notifyViewCallback, storage);
+    this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
       ViewType.TAB,
       this.getTraces(),
       this.htmlElement,
-      'ProtoLog',
+      TRACE_INFO[TraceType.PROTO_LOG].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
index e8de225e2..672cb0134 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component.ts
@@ -13,257 +13,34 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {CdkVirtualScrollViewport} from '@angular/cdk/scrolling';
-import {Component, ElementRef, Inject, Input, ViewChild} from '@angular/core';
-import {MatSelectChange} from '@angular/material/select';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
-import {timeButtonStyle} from 'viewers/components/styles/clickable_property.styles';
-import {currentElementStyle} from 'viewers/components/styles/current_element.styles';
-import {selectedElementStyle} from 'viewers/components/styles/selected_element.styles';
+import {Component, Input, ViewChild} from '@angular/core';
+import {PersistentStore} from 'common/persistent_store';
+import {TraceType} from 'trace/trace_type';
+import {LogComponent} from 'viewers/common/log_component';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
-import {UiData, UiDataMessage} from './ui_data';
+import {UiData} from './ui_data';
 
 @Component({
   selector: 'viewer-protolog',
   template: `
-    <div class="card-grid container">
-      <div class="log-view">
-        <div class="filters">
-          <div class="log-level">
-            <select-with-filter
-              label="Log level"
-              flex="3"
-              [options]="uiData.allLogLevels"
-              outerFilterWidth="225"
-              (selectChange)="onLogLevelsChange($event)">
-            </select-with-filter>
-          </div>
-          <div class="tag">
-            <select-with-filter
-              label="Tags"
-              flex="2"
-              [options]="uiData.allTags"
-              outerFilterWidth="150"
-              innerFilterWidth="150"
-              (selectChange)="onTagsChange($event)">
-            </select-with-filter>
-          </div>
-          <div class="source-file">
-            <select-with-filter
-              label="Source files"
-              flex="4"
-              [options]="uiData.allSourceFiles"
-              outerFilterWidth="300"
-              innerFilterWidth="300"
-              (selectChange)="onSourceFilesChange($event)">
-            </select-with-filter>
-          </div>
-          <div class="text">
-            <mat-form-field appearance="fill" (keydown.enter)="$event.target.blur()">
-              <mat-label>Search text</mat-label>
-              <input matInput name="protologTextInput" [(ngModel)]="searchString" (input)="onSearchStringChange()" />
-            </mat-form-field>
-          </div>
-
-          <button
-            color="primary"
-            mat-stroked-button
-            class="go-to-current-time"
-            (click)="onGoToCurrentTimeClick()">
-            Go to Current Time
-          </button>
-        </div>
-        <cdk-virtual-scroll-viewport
-          protologVirtualScroll
-          class="scroll-messages"
-          [scrollItems]="uiData.messages">
-          <div
-            *cdkVirtualFor="let message of uiData.messages; let i = index"
-            class="message"
-            [attr.item-id]="i"
-            [class.current]="isCurrentMessage(i)"
-            [class.selected]="isSelectedMessage(i)"
-            (click)="onMessageClicked(i)">
-            <div class="time">
-              <button
-                mat-button
-                color="primary"
-                (click)="onTimestampClicked(message)">
-                {{ message.time.formattedValue() }}
-              </button>
-            </div>
-            <div class="log-level">
-              <span class="mat-body-1">{{ message.level }}</span>
-            </div>
-            <div class="tag">
-              <span class="mat-body-1">{{ message.tag }}</span>
-            </div>
-            <div class="source-file">
-              <span class="mat-body-1">{{ message.at }}</span>
-            </div>
-            <div class="text">
-              <span class="mat-body-1">{{ message.text }}</span>
-            </div>
-          </div>
-        </cdk-virtual-scroll-viewport>
-      </div>
+    <div class="card-grid">
+       <log-view
+        class="log-view"
+        [selectedIndex]="inputData?.selectedIndex"
+        [scrollToIndex]="inputData?.scrollToIndex"
+        [currentIndex]="inputData?.currentIndex"
+        [entries]="inputData?.entries"
+        [filters]="inputData?.filters"
+        [traceType]="${TraceType.PROTO_LOG}">
+      </log-view>
     </div>
   `,
-  styles: [
-    `
-      .container {
-        display: flex;
-        flex-direction: column;
-      }
-
-      .filters {
-        display: flex;
-        flex-direction: row;
-        margin-top: 16px;
-      }
-
-      .scroll-messages {
-        height: 100%;
-        flex: 1;
-      }
-
-      .message {
-        display: flex;
-        flex-direction: row;
-        overflow-wrap: anywhere;
-      }
-
-      .time {
-        flex: 2;
-      }
-
-      .log-level {
-        flex: 1;
-      }
-
-      .filters .log-level {
-        flex: 3;
-      }
-
-      .tag {
-        flex: 2;
-      }
-
-      .source-file {
-        flex: 4;
-      }
-
-      .text {
-        flex: 10;
-      }
-
-      .filters .text mat-form-field {
-        width: 80%;
-      }
-
-      .go-to-current-time {
-        margin-top: 4px;
-        font-size: 12px;
-        height: 65%;
-        width: fit-content;
-      }
-
-      .filters div {
-        margin: 4px;
-      }
-
-      .message div {
-        margin: 4px;
-      }
-
-      mat-form-field {
-        width: 100%;
-        font-size: 12px;
-      }
-    `,
-    selectedElementStyle,
-    currentElementStyle,
-    timeButtonStyle,
-    viewerCardStyle,
-  ],
+  styles: [viewerCardStyle],
 })
 export class ViewerProtologComponent {
-  uiData: UiData = UiData.EMPTY;
-
-  private searchString = '';
-  private lastClicked = '';
-  private lastSelectedMessage: undefined | number;
-
-  @ViewChild(CdkVirtualScrollViewport)
-  scrollComponent?: CdkVirtualScrollViewport;
-
-  constructor(@Inject(ElementRef) private elementRef: ElementRef) {}
-
-  @Input()
-  set inputData(data: UiData) {
-    this.uiData = data;
-    if (
-      this.lastSelectedMessage === undefined &&
-      this.uiData.currentMessageIndex !== undefined &&
-      this.scrollComponent &&
-      this.lastClicked !==
-        this.uiData.messages[
-          this.uiData.currentMessageIndex
-        ].time.formattedValue()
-    ) {
-      this.scrollComponent.scrollToIndex(this.uiData.currentMessageIndex);
-    }
-
-    this.lastSelectedMessage = undefined;
-  }
-
-  onLogLevelsChange(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.LogLevelsFilterChanged, event.value);
-  }
-
-  onTagsChange(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.TagsFilterChanged, event.value);
-  }
-
-  onSourceFilesChange(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.SourceFilesFilterChanged, event.value);
-  }
-
-  onSearchStringChange() {
-    this.emitEvent(ViewerEvents.SearchStringFilterChanged, this.searchString);
-  }
-
-  onGoToCurrentTimeClick() {
-    if (this.uiData.currentMessageIndex !== undefined && this.scrollComponent) {
-      this.scrollComponent.scrollToIndex(this.uiData.currentMessageIndex);
-    }
-  }
-
-  onTimestampClicked(message: UiDataMessage) {
-    this.emitEvent(
-      ViewerEvents.TimestampClick,
-      new TimestampClickDetail(message.time.getValue(), message.traceIndex),
-    );
-  }
-
-  onMessageClicked(index: number) {
-    this.lastSelectedMessage = index;
-    this.emitEvent(ViewerEvents.LogClicked, index);
-  }
-
-  isCurrentMessage(index: number): boolean {
-    return index === this.uiData.currentMessageIndex;
-  }
-
-  isSelectedMessage(index: number): boolean {
-    return index === this.uiData.selectedMessageIndex;
-  }
+  @Input() inputData: UiData | undefined;
+  @Input() store: PersistentStore | undefined;
 
-  private emitEvent(event: string, data: any) {
-    const customEvent = new CustomEvent(event, {
-      bubbles: true,
-      detail: data,
-    });
-    this.elementRef.nativeElement.dispatchEvent(customEvent);
-  }
+  @ViewChild(LogComponent)
+  logComponent?: LogComponent;
 }
diff --git a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
index 44c3c484e..a01a868ba 100644
--- a/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_protolog/viewer_protolog_component_test.ts
@@ -32,12 +32,14 @@ import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
-import {TIMESTAMP_NODE_FORMATTER} from 'trace/tree_node/formatters';
-import {executeScrollComponentTests} from 'viewers/common/scroll_component_test_utils';
-import {ViewerEvents} from 'viewers/common/viewer_events';
+import {TraceBuilder} from 'test/unit/trace_builder';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LogComponent} from 'viewers/common/log_component';
+import {executeScrollComponentTests} from 'viewers/common/scroll_component_tests';
+import {LogFieldType} from 'viewers/common/ui_data_log';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {ProtologScrollDirective} from './scroll_strategy/protolog_scroll_directive';
-import {UiData, UiDataMessage} from './ui_data';
+import {ProtologEntry, UiData} from './ui_data';
 import {ViewerProtologComponent} from './viewer_protolog_component';
 
 describe('ViewerProtologComponent', () => {
@@ -60,6 +62,7 @@ describe('ViewerProtologComponent', () => {
         declarations: [
           ViewerProtologComponent,
           SelectWithFilterComponent,
+          LogComponent,
           ProtologScrollDirective,
         ],
         schemas: [CUSTOM_ELEMENTS_SCHEMA],
@@ -67,6 +70,9 @@ describe('ViewerProtologComponent', () => {
       fixture = TestBed.createComponent(ViewerProtologComponent);
       component = fixture.componentInstance;
       htmlElement = fixture.nativeElement;
+
+      component.inputData = makeUiData();
+      fixture.detectChanges();
     });
 
     it('can be created', () => {
@@ -81,169 +87,17 @@ describe('ViewerProtologComponent', () => {
     });
 
     it('renders log messages', () => {
-      expect(htmlElement.querySelector('.scroll-messages')).toBeTruthy();
-    });
-
-    it('applies log level filter correctly', async () => {
-      const allMessages = makeUiData().messages;
-      htmlElement.addEventListener(
-        ViewerEvents.LogLevelsFilterChanged,
-        (event) => {
-          if ((event as CustomEvent).detail.length === 0) {
-            component.uiData.messages = allMessages;
-            return;
-          }
-          component.uiData.messages = allMessages.filter((message) =>
-            (event as CustomEvent).detail.includes(message.level),
-          );
-        },
-      );
-      await checkSelectFilter('.log-level');
-    });
-
-    it('applies tag filter correctly', async () => {
-      const allMessages = makeUiData().messages;
-      htmlElement.addEventListener(ViewerEvents.TagsFilterChanged, (event) => {
-        if ((event as CustomEvent).detail.length === 0) {
-          component.uiData.messages = allMessages;
-          return;
-        }
-        component.uiData.messages = allMessages.filter((message) =>
-          (event as CustomEvent).detail.includes(message.tag),
-        );
-      });
-      await checkSelectFilter('.tag');
-    });
-
-    it('applies source file filter correctly', async () => {
-      const allMessages = makeUiData().messages;
-      htmlElement.addEventListener(
-        ViewerEvents.SourceFilesFilterChanged,
-        (event) => {
-          if ((event as CustomEvent).detail.length === 0) {
-            component.uiData.messages = allMessages;
-            return;
-          }
-          component.uiData.messages = allMessages.filter((message) =>
-            (event as CustomEvent).detail.includes(message.at),
-          );
-        },
-      );
-      await checkSelectFilter('.source-file');
+      expect(htmlElement.querySelector('.scroll')).toBeTruthy();
+      const entry = assertDefined(htmlElement.querySelector('.scroll .entry'));
+      expect(entry.innerHTML).toContain('INFO');
+      expect(entry.innerHTML).toContain('WindowManager');
+      expect(entry.innerHTML).toContain('test_source_file.java');
+      expect(entry.innerHTML).toContain('test information about message');
     });
-
-    it('applies text filter correctly', () => {
-      const allMessages = makeUiData().messages;
-      htmlElement.addEventListener(
-        ViewerEvents.SearchStringFilterChanged,
-        (event) => {
-          component.uiData.messages = allMessages.filter((message) =>
-            message.text.includes((event as CustomEvent).detail),
-          );
-        },
-      );
-      component.inputData = makeUiData();
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(200);
-
-      const textFilterDiv = assertDefined(
-        htmlElement.querySelector('.filters .text'),
-      );
-      const inputEl = assertDefined(
-        textFilterDiv.querySelector('input'),
-      ) as HTMLInputElement;
-      inputEl.value = 'keep';
-      inputEl.dispatchEvent(new Event('input'));
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(100);
-      inputEl.value = '';
-      inputEl.dispatchEvent(new Event('input'));
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(200);
-    });
-
-    it('scrolls to current entry on button click', () => {
-      component.inputData = makeUiData();
-      fixture.detectChanges();
-      const goToCurrentTimeButton = assertDefined(
-        htmlElement.querySelector('.go-to-current-time'),
-      ) as HTMLButtonElement;
-      const spy = spyOn(
-        assertDefined(component.scrollComponent),
-        'scrollToIndex',
-      );
-      goToCurrentTimeButton.click();
-      expect(spy).toHaveBeenCalledWith(150);
-    });
-
-    it('changes css class on message click and does not scroll', () => {
-      const uiData = makeUiData();
-      component.inputData = uiData;
-      fixture.detectChanges();
-
-      htmlElement.addEventListener(ViewerEvents.LogClicked, (event) => {
-        const index = (event as CustomEvent).detail;
-        uiData.selectedMessageIndex = index;
-        component.inputData = uiData;
-        fixture.detectChanges();
-      });
-
-      const message = assertDefined(
-        htmlElement.querySelector('.message[item-id="3"]'),
-      ) as HTMLButtonElement;
-      expect(message.className).not.toContain('selected');
-      const spy = spyOn(
-        assertDefined(component.scrollComponent),
-        'scrollToIndex',
-      );
-      message.click();
-      expect(spy).not.toHaveBeenCalled();
-      expect(message.className).toContain('selected');
-    });
-
-    it('propagates timestamp on click', () => {
-      component.inputData = makeUiData();
-      fixture.detectChanges();
-      let index: number | undefined;
-      htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
-        index = (event as CustomEvent).detail.index;
-      });
-      const logTimestampButton = assertDefined(
-        htmlElement.querySelector('.time button'),
-      ) as HTMLButtonElement;
-      logTimestampButton.click();
-
-      expect(index).toEqual(0);
-    });
-
-    async function checkSelectFilter(filterSelector: string) {
-      component.inputData = makeUiData();
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(200);
-
-      const filterTrigger = assertDefined(
-        htmlElement.querySelector(
-          `.filters ${filterSelector} .mat-select-trigger`,
-        ),
-      ) as HTMLInputElement;
-      filterTrigger.click();
-      await fixture.whenStable();
-
-      const firstOption = assertDefined(
-        document.querySelector('.mat-select-panel .mat-option'),
-      ) as HTMLElement;
-      firstOption.click();
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(100);
-
-      firstOption.click();
-      fixture.detectChanges();
-      expect(component.uiData.messages.length).toEqual(200);
-    }
   });
 
   describe('Scroll component', () => {
-    executeScrollComponentTests('message', setUpTestEnvironment);
+    executeScrollComponentTests(setUpTestEnvironment);
     async function setUpTestEnvironment(): Promise<
       [
         ComponentFixture<ViewerProtologComponent>,
@@ -261,14 +115,21 @@ describe('ViewerProtologComponent', () => {
           BrowserAnimationsModule,
           MatSelectModule,
         ],
-        declarations: [ViewerProtologComponent, ProtologScrollDirective],
+        declarations: [
+          ViewerProtologComponent,
+          LogComponent,
+          ProtologScrollDirective,
+        ],
         schemas: [CUSTOM_ELEMENTS_SCHEMA],
       }).compileComponents();
       const fixture = TestBed.createComponent(ViewerProtologComponent);
       const protologComponent = fixture.componentInstance;
       const htmlElement = fixture.nativeElement;
-      const viewport = assertDefined(protologComponent.scrollComponent);
       protologComponent.inputData = makeUiData();
+      fixture.detectChanges();
+      const viewport = assertDefined(
+        protologComponent.logComponent?.scrollComponent,
+      );
       return [fixture, htmlElement, viewport];
     }
   });
@@ -280,35 +141,49 @@ describe('ViewerProtologComponent', () => {
       'test_source_file.java',
       'other_test_source_file.java',
     ];
-
-    const time = new PropertyTreeBuilder()
-      .setRootId('ProtologMessage')
-      .setName('timestamp')
-      .setValue(TimestampConverterUtils.makeElapsedTimestamp(10n))
-      .setFormatter(TIMESTAMP_NODE_FORMATTER)
+    const propertiesTree = new PropertyTreeBuilder()
+      .setRootId('Protolog')
+      .setName('tree')
+      .setValue(null)
+      .build();
+    const ts = TimestampConverterUtils.makeElapsedTimestamp(10n);
+    const trace = new TraceBuilder<PropertyTreeNode>()
+      .setEntries([propertiesTree, propertiesTree])
+      .setTimestamps([ts, ts])
       .build();
 
-    const messages = [];
+    const messages: ProtologEntry[] = [];
     const shortMessage = 'test information about message';
     const longMessage = shortMessage.repeat(10) + 'keep';
     for (let i = 0; i < 200; i++) {
-      const uiDataMessage: UiDataMessage = {
-        traceIndex: i,
-        text: i % 2 === 0 ? shortMessage : longMessage,
-        time,
-        tag: i % 2 === 0 ? allTags[0] : allTags[1],
-        level: i % 2 === 0 ? allLogLevels[0] : allLogLevels[1],
-        at: i % 2 === 0 ? allSourceFiles[0] : allSourceFiles[1],
-      };
-      messages.push(uiDataMessage);
+      const message = new ProtologEntry(trace.getEntry(0), [
+        {
+          type: LogFieldType.LOG_LEVEL,
+          value: i % 2 === 0 ? allLogLevels[0] : allLogLevels[1],
+        },
+        {type: LogFieldType.TAG, value: i % 2 === 0 ? allTags[0] : allTags[1]},
+        {
+          type: LogFieldType.SOURCE_FILE,
+          value: i % 2 === 0 ? allSourceFiles[0] : allSourceFiles[1],
+        },
+        {
+          type: LogFieldType.TEXT,
+          value: i % 2 === 0 ? shortMessage : longMessage,
+        },
+      ]);
+      messages.push(message);
     }
     return new UiData(
-      allLogLevels,
-      allTags,
-      allSourceFiles,
+      [
+        {type: LogFieldType.LOG_LEVEL, options: allLogLevels},
+        {type: LogFieldType.TAG, options: allTags},
+        {type: LogFieldType.SOURCE_FILE, options: allSourceFiles},
+        {type: LogFieldType.TEXT},
+      ],
       messages,
       150,
       undefined,
+      undefined,
     );
   }
 });
diff --git a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording.ts b/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording.ts
deleted file mode 100644
index 4ed8c223d..000000000
--- a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording.ts
+++ /dev/null
@@ -1,78 +0,0 @@
-/*
- * Copyright (C) 2022 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
-import {Trace} from 'trace/trace';
-import {Traces} from 'trace/traces';
-import {TraceEntryFinder} from 'trace/trace_entry_finder';
-import {TraceType} from 'trace/trace_type';
-import {View, Viewer, ViewType} from 'viewers/viewer';
-import {ViewerScreenRecordingComponent} from './viewer_screen_recording_component';
-
-export class ViewerScreenRecording implements Viewer {
-  static readonly DEPENDENCIES: TraceType[] = [TraceType.SCREEN_RECORDING];
-
-  private readonly trace: Trace<ScreenRecordingTraceEntry>;
-  private readonly htmlElement: HTMLElement;
-  private readonly view: View;
-
-  constructor(trace: Trace<ScreenRecordingTraceEntry>, traces: Traces) {
-    this.trace = trace;
-    this.htmlElement = document.createElement('viewer-screen-recording');
-    this.view = new View(
-      ViewType.OVERLAY,
-      this.getTraces(),
-      this.htmlElement,
-      'ScreenRecording',
-    );
-  }
-
-  async onWinscopeEvent(event: WinscopeEvent) {
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        const entry = TraceEntryFinder.findCorrespondingEntry(
-          this.trace,
-          event.position,
-        );
-        (
-          this.htmlElement as unknown as ViewerScreenRecordingComponent
-        ).currentTraceEntry = await entry?.getValue();
-      },
-    );
-    await event.visit(
-      WinscopeEventType.EXPANDED_TIMELINE_TOGGLED,
-      async (event) => {
-        (
-          this.htmlElement as unknown as ViewerScreenRecordingComponent
-        ).forceMinimize = event.isTimelineExpanded;
-      },
-    );
-  }
-
-  setEmitEvent() {
-    // do nothing
-  }
-
-  getViews(): View[] {
-    return [this.view];
-  }
-
-  getTraces(): Array<Trace<ScreenRecordingTraceEntry>> {
-    return [this.trace];
-  }
-}
diff --git a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component.ts b/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component.ts
deleted file mode 100644
index 6b7258926..000000000
--- a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component.ts
+++ /dev/null
@@ -1,248 +0,0 @@
-/*
- * Copyright (C) 2022 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-import {
-  Component,
-  ElementRef,
-  HostListener,
-  Inject,
-  Input,
-  SimpleChanges,
-} from '@angular/core';
-import {DomSanitizer, SafeUrl} from '@angular/platform-browser';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
-
-@Component({
-  selector: 'viewer-screen-recording',
-  template: `
-  <div class="overlay">
-    <mat-card class="container" cdkDrag cdkDragBoundary=".overlay">
-      <mat-card-title class="header">
-        <button mat-button class="button-drag" cdkDragHandle>
-          <mat-icon class="drag-icon">drag_indicator</mat-icon>
-          <span class="mat-body-2">{{ title }}</span>
-        </button>
-
-        <button mat-button class="button-minimize" [disabled]="forceMinimize" (click)="onMinimizeButtonClick()">
-          <mat-icon>
-            {{ isMinimized() ? 'maximize' : 'minimize' }}
-          </mat-icon>
-        </button>
-      </mat-card-title>
-      <div class="video-container" cdkDragHandle [style.height]="isMinimized() ? '0px' : ''">
-        <ng-container *ngIf="hasFrameToShow(); then video; else noVideo"> </ng-container>
-      </div>
-    </mat-card>
-
-    <ng-template #video>
-      <video
-        *ngIf="hasFrameToShow()"
-        [class.ready]="videoElement.readyState"
-        [currentTime]="currentTraceEntry.videoTimeSeconds"
-        [src]="safeUrl"
-        #videoElement></video>
-    </ng-template>
-
-    <ng-template #noVideo>
-      <img *ngIf="hasImage()" [src]="safeUrl" />
-
-      <div class="no-video" *ngIf="!hasImage()">
-        <p class="mat-body-2">No screen recording frame to show.</p>
-        <p class="mat-body-1">Current timestamp is still before first frame.</p>
-      </div>
-    </ng-template>
-    </div>
-  `,
-  styles: [
-    `
-      .overlay {
-        z-index: 30;
-        position: fixed;
-        top: 0px;
-        left: 0px;
-        width: 100%;
-        height: 100%;
-        pointer-events: none;
-      }
-
-      .container {
-        pointer-events: all;
-        width: max(250px, 15vw);
-        min-width: 165px;
-        resize: horizontal;
-        overflow: hidden;
-        display: flex;
-        flex-direction: column;
-        padding: 0;
-        left: 80vw;
-        top: 20vh;
-      }
-
-      .header {
-        display: flex;
-        flex-direction: row;
-        margin: 0px;
-        border: 1px solid var(--border-color);
-        border-radius: 4px;
-      }
-
-      .button-drag {
-        flex-grow: 1;
-        cursor: grab;
-        padding: 2px;
-      }
-
-      .drag-icon {
-        float: left;
-        margin: 5px 0;
-      }
-
-      .button-minimize {
-        flex-grow: 0;
-        padding: 2px;
-        min-width: 24px;
-      }
-
-      .video-container, video, img {
-        border: 1px solid var(--default-border);
-        width: 100%;
-        height: auto;
-        cursor: grab;
-        overflow: hidden;
-      }
-
-      .no-video {
-        padding: 1rem;
-        text-align: center;
-      }
-    `,
-  ],
-})
-class ViewerScreenRecordingComponent {
-  safeUrl: undefined | SafeUrl = undefined;
-  shouldMinimize = false;
-
-  constructor(
-    @Inject(DomSanitizer) private sanitizer: DomSanitizer,
-    @Inject(ElementRef) private elementRef: ElementRef,
-  ) {}
-
-  @Input() currentTraceEntry: ScreenRecordingTraceEntry | undefined;
-  @Input() title = 'Screen recording';
-  @Input() forceMinimize = false;
-
-  private frameHeight = 1280; // default for Flicker/Winscope
-  private frameWidth = 720; // default for Flicker/Winscope
-
-  private videoObserver: MutationObserver | undefined;
-
-  ngOnChanges(changes: SimpleChanges) {
-    if (this.currentTraceEntry === undefined) {
-      return;
-    }
-
-    if (!changes['currentTraceEntry']) {
-      return;
-    }
-
-    if (this.safeUrl === undefined) {
-      this.safeUrl = this.sanitizer.bypassSecurityTrustUrl(
-        URL.createObjectURL(this.currentTraceEntry.videoData),
-      );
-    }
-  }
-
-  async ngAfterViewInit() {
-    const video: HTMLVideoElement | null =
-      this.elementRef.nativeElement.querySelector('video');
-
-    if (video) {
-      const config = {
-        attributes: true,
-        CharacterData: true,
-      };
-
-      const videoCallback = (
-        mutations: MutationRecord[],
-        observer: MutationObserver,
-      ) => {
-        for (const mutation of mutations) {
-          if (
-            mutation.type === 'attributes' &&
-            mutation.attributeName === 'class'
-          ) {
-            if (video?.className.includes('ready')) {
-              this.frameHeight = video?.videoHeight;
-              this.frameWidth = video?.videoWidth;
-              observer.disconnect();
-            }
-          }
-        }
-      };
-
-      this.videoObserver = new MutationObserver(videoCallback);
-      this.videoObserver.observe(video, config);
-    } else {
-      const image: HTMLImageElement | null =
-        this.elementRef.nativeElement.querySelector('img');
-      if (image) {
-        this.frameHeight = image.naturalHeight;
-        this.frameWidth = image.naturalWidth;
-      }
-    }
-
-    this.updateMaxContainerSize();
-  }
-
-  ngOnDestroy() {
-    this.videoObserver?.disconnect();
-  }
-
-  @HostListener('window:resize', ['$event'])
-  onResize(event: Event) {
-    this.updateMaxContainerSize();
-  }
-
-  updateMaxContainerSize() {
-    const container = this.elementRef.nativeElement.querySelector('.container');
-    const maxHeight = window.innerHeight - 140;
-    const headerHeight =
-      this.elementRef.nativeElement.querySelector('.header').clientHeight;
-    const maxWidth =
-      ((maxHeight - headerHeight) * this.frameWidth) / this.frameHeight;
-    container.style.maxWidth = `${maxWidth}px`;
-  }
-
-  onMinimizeButtonClick() {
-    this.shouldMinimize = !this.shouldMinimize;
-  }
-
-  isMinimized() {
-    return this.forceMinimize || this.shouldMinimize;
-  }
-
-  hasFrameToShow() {
-    return (
-      !this.currentTraceEntry?.isImage &&
-      this.currentTraceEntry?.videoTimeSeconds !== undefined
-    );
-  }
-
-  hasImage() {
-    return this.currentTraceEntry?.isImage ?? false;
-  }
-}
-
-export {ViewerScreenRecordingComponent};
diff --git a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component_test.ts b/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component_test.ts
deleted file mode 100644
index 0ea111f4d..000000000
--- a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screen_recording_component_test.ts
+++ /dev/null
@@ -1,135 +0,0 @@
-/*
- * Copyright (C) 2022 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
-import {
-  ComponentFixture,
-  ComponentFixtureAutoDetect,
-  TestBed,
-} from '@angular/core/testing';
-import {MatCardModule} from '@angular/material/card';
-import {assertDefined} from 'common/assert_utils';
-import {UnitTestUtils} from 'test/unit/utils';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
-import {ViewerScreenRecordingComponent} from './viewer_screen_recording_component';
-
-describe('ViewerScreenRecordingComponent', () => {
-  let fixture: ComponentFixture<ViewerScreenRecordingComponent>;
-  let component: ViewerScreenRecordingComponent;
-  let htmlElement: HTMLElement;
-
-  beforeEach(async () => {
-    await TestBed.configureTestingModule({
-      providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-      imports: [MatCardModule],
-      declarations: [ViewerScreenRecordingComponent],
-      schemas: [CUSTOM_ELEMENTS_SCHEMA],
-    }).compileComponents();
-
-    fixture = TestBed.createComponent(ViewerScreenRecordingComponent);
-    component = fixture.componentInstance;
-    htmlElement = fixture.nativeElement;
-    fixture.detectChanges();
-  });
-
-  it('can be created', () => {
-    expect(component).toBeTruthy();
-  });
-
-  it('renders title correctly', () => {
-    const title = assertDefined(
-      htmlElement.querySelector('.header'),
-    ) as HTMLElement;
-    expect(title.innerHTML).toContain('Screen recording');
-
-    component.title = 'Screenshot';
-    fixture.detectChanges();
-    expect(title.innerHTML).toContain('Screenshot');
-  });
-
-  it('can be minimized and maximized', () => {
-    const buttonMinimize = assertDefined(
-      htmlElement.querySelector('.button-minimize'),
-    ) as HTMLButtonElement;
-    const videoContainer = assertDefined(
-      htmlElement.querySelector('.video-container'),
-    ) as HTMLElement;
-    expect(videoContainer.style.height).toEqual('');
-
-    buttonMinimize.click();
-    fixture.detectChanges();
-    expect(videoContainer.style.height).toEqual('0px');
-
-    buttonMinimize.click();
-    fixture.detectChanges();
-    expect(videoContainer.style.height).toEqual('');
-  });
-
-  it('forces minimized state', () => {
-    component.forceMinimize = true;
-    fixture.detectChanges();
-
-    const buttonMinimize = assertDefined(
-      htmlElement.querySelector('.button-minimize'),
-    ) as HTMLButtonElement;
-    const videoContainer = assertDefined(
-      htmlElement.querySelector('.video-container'),
-    ) as HTMLElement;
-    expect(videoContainer.style.height).toEqual('0px');
-    expect(buttonMinimize.disabled).toBeTrue();
-
-    component.forceMinimize = false;
-    fixture.detectChanges();
-    expect(videoContainer.style.height).toEqual('');
-    expect(buttonMinimize.disabled).toBeFalse();
-  });
-
-  it('shows video', async () => {
-    const videoFile = await UnitTestUtils.getFixtureFile(
-      'traces/elapsed_and_real_timestamp/screen_recording_metadata_v2.mp4',
-    );
-    component.currentTraceEntry = new ScreenRecordingTraceEntry(1, videoFile);
-    fixture.detectChanges();
-    const videoContainer = assertDefined(
-      htmlElement.querySelector('.video-container'),
-    ) as HTMLElement;
-    expect(videoContainer.querySelector('video')).toBeTruthy();
-    expect(videoContainer.querySelector('img')).toBeNull();
-  });
-
-  it('shows screenshot image', () => {
-    component.currentTraceEntry = new ScreenRecordingTraceEntry(
-      0,
-      new Blob(),
-      true,
-    );
-    fixture.detectChanges();
-    const videoContainer = assertDefined(
-      htmlElement.querySelector('.video-container'),
-    ) as HTMLElement;
-    expect(videoContainer.querySelector('img')).toBeTruthy();
-    expect(videoContainer.querySelector('video')).toBeNull();
-  });
-
-  it('shows no frame message', () => {
-    const videoContainer = assertDefined(
-      htmlElement.querySelector('.video-container'),
-    ) as HTMLElement;
-    expect(videoContainer.innerHTML).toContain(
-      'No screen recording frame to show',
-    );
-  });
-});
diff --git a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screenshot.ts b/tools/winscope/src/viewers/viewer_screen_recording/viewer_screenshot.ts
deleted file mode 100644
index ac9bb6030..000000000
--- a/tools/winscope/src/viewers/viewer_screen_recording/viewer_screenshot.ts
+++ /dev/null
@@ -1,82 +0,0 @@
-/*
- * Copyright (C) 2024 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
-import {ScreenRecordingTraceEntry} from 'trace/screen_recording';
-import {Trace} from 'trace/trace';
-import {Traces} from 'trace/traces';
-import {TraceEntryFinder} from 'trace/trace_entry_finder';
-import {TraceType} from 'trace/trace_type';
-import {View, Viewer, ViewType} from 'viewers/viewer';
-import {ViewerScreenRecordingComponent} from './viewer_screen_recording_component';
-
-class ViewerScreenshot implements Viewer {
-  static readonly DEPENDENCIES: TraceType[] = [TraceType.SCREENSHOT];
-
-  private readonly trace: Trace<ScreenRecordingTraceEntry>;
-  private readonly htmlElement: HTMLElement;
-  private readonly view: View;
-
-  constructor(trace: Trace<ScreenRecordingTraceEntry>, traces: Traces) {
-    this.trace = trace;
-    this.htmlElement = document.createElement('viewer-screen-recording');
-    this.view = new View(
-      ViewType.OVERLAY,
-      this.getTraces(),
-      this.htmlElement,
-      'Screenshot',
-    );
-  }
-
-  async onWinscopeEvent(event: WinscopeEvent) {
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        const entry = TraceEntryFinder.findCorrespondingEntry(
-          this.trace,
-          event.position,
-        );
-        (
-          this.htmlElement as unknown as ViewerScreenRecordingComponent
-        ).currentTraceEntry = await entry?.getValue();
-        (this.htmlElement as unknown as ViewerScreenRecordingComponent).title =
-          'Screenshot';
-      },
-    );
-    await event.visit(
-      WinscopeEventType.EXPANDED_TIMELINE_TOGGLED,
-      async (event) => {
-        (
-          this.htmlElement as unknown as ViewerScreenRecordingComponent
-        ).forceMinimize = event.isTimelineExpanded;
-      },
-    );
-  }
-
-  setEmitEvent() {
-    // do nothing
-  }
-
-  getViews(): View[] {
-    return [this.view];
-  }
-
-  getTraces(): Array<Trace<ScreenRecordingTraceEntry>> {
-    return [this.trace];
-  }
-}
-
-export {ViewerScreenshot};
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts b/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
index ff1086ac4..f488825b4 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/presenter.ts
@@ -16,8 +16,10 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {
   TabbedViewSwitchRequest,
+  TracePositionUpdate,
   WinscopeEvent,
   WinscopeEventType,
 } from 'messaging/winscope_event';
@@ -25,8 +27,12 @@ import {LayerFlag} from 'parsers/surface_flinger/layer_flag';
 import {CustomQueryType} from 'trace/custom_query';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TraceEntryFinder} from 'trace/trace_entry_finder';
 import {TraceType} from 'trace/trace_type';
-import {EMPTY_OBJ_STRING} from 'trace/tree_node/formatters';
+import {
+  EMPTY_OBJ_STRING,
+  FixedStringFormatter,
+} from 'trace/tree_node/formatters';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {
@@ -43,13 +49,14 @@ import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {HierarchyPresenter} from 'viewers/common/hierarchy_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
 import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UI_RECT_FACTORY} from 'viewers/common/ui_rect_factory';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UiData} from './ui_data';
 
-export class Presenter extends AbstractHierarchyViewerPresenter {
+export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
   static readonly DENYLIST_PROPERTY_NAMES = [
     'name',
     'children',
@@ -82,16 +89,21 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'SfHierarchyFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
     true,
     false,
-    (entry) => entry.getTimestamp().format(),
+    this.getEntryFormattedTimestamp,
   );
   protected override rectsPresenter = new RectsPresenter(
     PersistentStoreProxy.new<UserOptions>(
       'SfRectsOptions',
       {
-        ignoreNonHidden: {
+        ignoreRectShowState: {
           name: 'Ignore',
           icon: 'visibility',
           enabled: false,
@@ -106,7 +118,9 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     ),
     (tree: HierarchyTreeNode) =>
       UI_RECT_FACTORY.makeUiRects(tree, this.viewCapturePackageNames),
-    this.getDisplays,
+    (displays: UiRect[]) =>
+      makeDisplayIdentifiers(displays, this.wmFocusedDisplayId),
+    convertRectIdToLayerorDisplayName,
   );
   protected override propertiesPresenter = new PropertiesPresenter(
     PersistentStoreProxy.new<UserOptions>(
@@ -129,21 +143,31 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'SfPropertiesFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
+    undefined,
+    ['a', 'type'],
   );
   protected override multiTraceType = undefined;
 
   private viewCapturePackageNames: string[] = [];
   private curatedProperties: SfCuratedProperties | undefined;
   private displayPropertyGroups = false;
+  private wmTrace: Trace<HierarchyTreeNode> | undefined;
+  private wmFocusedDisplayId: number | undefined;
 
   constructor(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Readonly<Storage>,
-    notifyViewCallback: NotifyHierarchyViewCallbackType,
+    storage: Readonly<Store>,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<UiData>,
   ) {
     super(trace, traces, storage, notifyViewCallback, new UiData());
+    this.wmTrace = traces.getTrace(TraceType.WINDOW_MANAGER);
   }
 
   async onRectDoubleClick(rectId: string) {
@@ -161,15 +185,26 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
   }
 
   override async onAppEvent(event: WinscopeEvent) {
+    await this.handleCommonWinscopeEvents(event);
     await event.visit(
       WinscopeEventType.TRACE_POSITION_UPDATE,
       async (event) => {
         await this.initializeIfNeeded();
+        await this.setInitialWmActiveDisplay(event);
         await this.applyTracePositionUpdate(event);
         this.updateCuratedProperties();
         this.refreshUIData();
       },
     );
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        const filterPresetName = event.name;
+        await this.applyPresetConfig(filterPresetName);
+        this.updateCuratedProperties();
+        this.refreshUIData();
+      },
+    );
   }
 
   override async onHighlightedNodeChange(item: UiHierarchyTreeNode) {
@@ -207,39 +242,6 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     this.viewCapturePackageNames = await Promise.all(promisesPackageName);
   }
 
-  private getDisplays(rects: UiRect[]): DisplayIdentifier[] {
-    const ids: DisplayIdentifier[] = [];
-
-    rects.forEach((rect: UiRect) => {
-      if (!rect.isDisplay) return;
-      const displayId = rect.id.slice(10, rect.id.length);
-      ids.push({displayId, groupId: rect.groupId, name: rect.label});
-    });
-
-    let offscreenDisplayCount = 0;
-    rects.forEach((rect: UiRect) => {
-      if (rect.isDisplay) return;
-
-      if (!ids.find((identifier) => identifier.groupId === rect.groupId)) {
-        offscreenDisplayCount++;
-        const name =
-          'Offscreen Display' +
-          (offscreenDisplayCount > 1 ? ` ${offscreenDisplayCount}` : '');
-        ids.push({displayId: -1, groupId: rect.groupId, name});
-      }
-    });
-
-    return ids.sort((a, b) => {
-      if (a.name < b.name) {
-        return -1;
-      }
-      if (a.name > b.name) {
-        return 1;
-      }
-      return 0;
-    });
-  }
-
   private updateCuratedProperties() {
     const selectedHierarchyTree = this.hierarchyPresenter.getSelectedTree();
     const propertiesTree = this.propertiesPresenter.getPropertiesTree();
@@ -249,14 +251,23 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         this.curatedProperties = undefined;
         this.displayPropertyGroups = false;
       } else {
-        this.curatedProperties = this.getCuratedProperties(propertiesTree);
+        this.curatedProperties = this.getCuratedProperties(
+          selectedHierarchyTree[1],
+          propertiesTree,
+        );
         this.displayPropertyGroups = true;
       }
+    } else {
+      this.curatedProperties = undefined;
+      this.displayPropertyGroups = false;
     }
   }
 
-  private getCuratedProperties(tree: PropertyTreeNode): SfCuratedProperties {
-    const inputWindowInfo = tree.getChildByName('inputWindowInfo');
+  private getCuratedProperties(
+    hTree: HierarchyTreeNode,
+    pTree: PropertyTreeNode,
+  ): SfCuratedProperties {
+    const inputWindowInfo = pTree.getChildByName('inputWindowInfo');
     const hasInputChannel =
       inputWindowInfo !== undefined &&
       inputWindowInfo.getAllChildren().length > 0;
@@ -267,58 +278,77 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         ).formattedValue()
       : '-1';
 
-    const verboseFlags = tree.getChildByName('verboseFlags')?.formattedValue();
-    const flags = assertDefined(tree.getChildByName('flags'));
+    const verboseFlags = pTree.getChildByName('verboseFlags')?.formattedValue();
+    const flags = assertDefined(pTree.getChildByName('flags'));
     const curatedFlags =
       verboseFlags !== '' && verboseFlags !== undefined
         ? verboseFlags
         : flags.formattedValue();
 
-    const bufferTransform = tree.getChildByName('bufferTransform');
+    const bufferTransform = pTree.getChildByName('bufferTransform');
     const bufferTransformTypeFlags =
       bufferTransform?.getChildByName('type')?.formattedValue() ?? 'null';
 
+    const zOrderRelativeOfNode = assertDefined(
+      pTree.getChildByName('zOrderRelativeOf'),
+    );
+    let relativeParent: string | SfLayerSummary =
+      zOrderRelativeOfNode.formattedValue();
+    if (relativeParent !== 'none') {
+      // update zOrderRelativeOf property formatter to zParent node id
+      zOrderRelativeOfNode.setFormatter(
+        new FixedStringFormatter(assertDefined(hTree.getZParent()).id),
+      );
+      relativeParent = this.getLayerSummary(zOrderRelativeOfNode);
+    }
+
     const curated: SfCuratedProperties = {
-      summary: this.getSummaryOfVisibility(tree),
+      summary: this.getSummaryOfVisibility(pTree),
       flags: curatedFlags,
-      calcTransform: tree.getChildByName('transform'),
-      calcCrop: assertDefined(tree.getChildByName('bounds')).formattedValue(),
+      calcTransform: pTree.getChildByName('transform'),
+      calcCrop: assertDefined(pTree.getChildByName('bounds')).formattedValue(),
       finalBounds: assertDefined(
-        tree.getChildByName('screenBounds'),
+        pTree.getChildByName('screenBounds'),
       ).formattedValue(),
-      reqTransform: tree.getChildByName('requestedTransform'),
-      reqCrop: this.getCropPropertyValue(tree, 'bounds'),
+      reqTransform: pTree.getChildByName('requestedTransform'),
+      reqCrop: this.getCropPropertyValue(pTree, 'bounds'),
       bufferSize: assertDefined(
-        tree.getChildByName('activeBuffer'),
+        pTree.getChildByName('activeBuffer'),
       ).formattedValue(),
       frameNumber: assertDefined(
-        tree.getChildByName('currFrame'),
+        pTree.getChildByName('currFrame'),
       ).formattedValue(),
       bufferTransformType: bufferTransformTypeFlags,
       destinationFrame: assertDefined(
-        tree.getChildByName('destinationFrame'),
-      ).formattedValue(),
-      z: assertDefined(tree.getChildByName('z')).formattedValue(),
-      relativeParent: assertDefined(
-        tree.getChildByName('zOrderRelativeOf'),
+        pTree.getChildByName('destinationFrame'),
       ).formattedValue(),
-      calcColor: this.getColorPropertyValue(tree, 'color'),
-      calcShadowRadius: this.getPixelPropertyValue(tree, 'shadowRadius'),
-      calcCornerRadius: this.getPixelPropertyValue(tree, 'cornerRadius'),
-      calcCornerRadiusCrop: this.getCropPropertyValue(tree, 'cornerRadiusCrop'),
+      z: assertDefined(pTree.getChildByName('z')).formattedValue(),
+      relativeParent,
+      relativeChildren:
+        pTree
+          .getChildByName('relZChildren')
+          ?.getAllChildren()
+          .map((c) => this.getLayerSummary(c)) ?? [],
+      calcColor: this.getColorPropertyValue(pTree, 'color'),
+      calcShadowRadius: this.getPixelPropertyValue(pTree, 'shadowRadius'),
+      calcCornerRadius: this.getPixelPropertyValue(pTree, 'cornerRadius'),
+      calcCornerRadiusCrop: this.getCropPropertyValue(
+        pTree,
+        'cornerRadiusCrop',
+      ),
       backgroundBlurRadius: this.getPixelPropertyValue(
-        tree,
+        pTree,
         'backgroundBlurRadius',
       ),
-      reqColor: this.getColorPropertyValue(tree, 'requestedColor'),
+      reqColor: this.getColorPropertyValue(pTree, 'requestedColor'),
       reqCornerRadius: this.getPixelPropertyValue(
-        tree,
+        pTree,
         'requestedCornerRadius',
       ),
-      inputTransform: hasInputChannel
-        ? inputWindowInfo.getChildByName('transform')
-        : undefined,
-      inputRegion: tree.getChildByName('inputRegion')?.formattedValue(),
+      inputTransform: inputWindowInfo?.getChildByName('transform'),
+      inputRegion: inputWindowInfo
+        ?.getChildByName('touchableRegion')
+        ?.formattedValue(),
       focusable: hasInputChannel
         ? assertDefined(
             inputWindowInfo.getChildByName('focusable'),
@@ -356,6 +386,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       summary.push({
         key: 'Occluded by',
         layerValues: occludedBy.map((layer) => this.getLayerSummary(layer)),
+        desc: 'Fully occluded by these opaque layers',
       });
     }
 
@@ -368,6 +399,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         layerValues: partiallyOccludedBy.map((layer) =>
           this.getLayerSummary(layer),
         ),
+        desc: 'Partially occluded by these opaque layers',
       });
     }
 
@@ -376,6 +408,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       summary.push({
         key: 'Covered by',
         layerValues: coveredBy.map((layer) => this.getLayerSummary(layer)),
+        desc: 'Partially or fully covered by these likely translucent layers',
       });
     }
     return summary;
@@ -387,11 +420,11 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
 
   private getLayerSummary(layer: PropertyTreeNode): SfLayerSummary {
     const nodeId = layer.formattedValue();
-    const [layerId, name] = nodeId.split(' ');
+    const parts = nodeId.split(' ');
     return {
-      layerId,
+      layerId: parts[0],
       nodeId,
-      name,
+      name: parts.slice(1).join(' '),
     };
   }
 
@@ -410,9 +443,75 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     return propVal !== 'null' ? propVal : 'no color found';
   }
 
+  private async setInitialWmActiveDisplay(event: TracePositionUpdate) {
+    if (!this.wmTrace || this.wmFocusedDisplayId !== undefined) {
+      return;
+    }
+    const wmEntry: HierarchyTreeNode | undefined =
+      await TraceEntryFinder.findCorrespondingEntry<HierarchyTreeNode>(
+        this.wmTrace,
+        event.position,
+      )?.getValue();
+    if (wmEntry) {
+      this.wmFocusedDisplayId = wmEntry
+        .getEagerPropertyByName('focusedDisplayId')
+        ?.getValue();
+    }
+  }
+
   private refreshUIData() {
-    this.refreshHierarchyViewerUiData(
-      new UiData(this.curatedProperties, this.displayPropertyGroups),
-    );
+    this.uiData.curatedProperties = this.curatedProperties;
+    this.uiData.displayPropertyGroups = this.displayPropertyGroups;
+    this.refreshHierarchyViewerUiData();
   }
 }
+
+export function makeDisplayIdentifiers(
+  rects: UiRect[],
+  focusedDisplayId?: number,
+): DisplayIdentifier[] {
+  const ids: DisplayIdentifier[] = [];
+
+  const isActive = (display: UiRect) => {
+    if (focusedDisplayId !== undefined) {
+      return display.groupId === focusedDisplayId;
+    }
+    return display.isActiveDisplay;
+  };
+
+  rects.forEach((rect: UiRect) => {
+    if (!rect.isDisplay) return;
+
+    const displayId = rect.id.slice(10, rect.id.length);
+    ids.push({
+      displayId,
+      groupId: rect.groupId,
+      name: rect.label,
+      isActive: isActive(rect),
+    });
+  });
+
+  let offscreenDisplayCount = 0;
+  rects.forEach((rect: UiRect) => {
+    if (rect.isDisplay) return;
+
+    if (!ids.find((identifier) => identifier.groupId === rect.groupId)) {
+      offscreenDisplayCount++;
+      const name =
+        'Offscreen Display' +
+        (offscreenDisplayCount > 1 ? ` ${offscreenDisplayCount}` : '');
+      ids.push({displayId: -1, groupId: rect.groupId, name, isActive: false});
+    }
+  });
+
+  return ids;
+}
+
+export function convertRectIdToLayerorDisplayName(id: string) {
+  if (id.startsWith('Display')) return id.split('-').slice(1).join('-').trim();
+  const idMinusStartLayerId = id.split(' ').slice(1).join(' ');
+  const idSplittingEndLayerId = idMinusStartLayerId.split('#');
+  return idSplittingEndLayerId
+    .slice(0, idSplittingEndLayerId.length - 1)
+    .join('#');
+}
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts b/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
index eb65ff822..43c723fe4 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/presenter_test.ts
@@ -15,26 +15,32 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {Rect} from 'common/rect';
+import {Store} from 'common/store';
 import {TracePositionUpdate} from 'messaging/winscope_event';
+import {HierarchyTreeBuilder} from 'test/unit/hierarchy_tree_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
+import {UserNotifierChecker} from 'test/unit/user_notifier_checker';
 import {UnitTestUtils} from 'test/unit/utils';
 import {CustomQueryType} from 'trace/custom_query';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
+import {EMPTY_OBJ_STRING} from 'trace/tree_node/formatters';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
 import {DiffType} from 'viewers/common/diff_type';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
+import {UserOptions} from 'viewers/common/user_options';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
-class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
+class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest<UiData> {
   private traceSf: Trace<HierarchyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
   private secondPositionUpdate: TracePositionUpdate | undefined;
@@ -45,20 +51,21 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
   override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = true;
   override readonly shouldExecuteShowDiffTests = true;
+  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = true;
 
-  override readonly numberOfDefaultProperties = 34;
-  override readonly numberOfNonDefaultProperties = 22;
+  override readonly numberOfDefaultProperties = 32;
+  override readonly numberOfNonDefaultProperties = 24;
   override readonly expectedFirstRect = new Rect(0, 0, 1080, 2400);
-  override readonly propertiesFilterString = 'bound';
-  override readonly expectedTotalRects = 7;
+  override readonly propertiesFilter = new TextFilter('bound', []);
+  override readonly expectedTotalRects = 11;
   override readonly expectedVisibleRects = 6;
   override readonly treeNodeLongName =
     'ActivityRecord{64953af u0 com.google.android.apps.nexuslauncher/.NexusLauncherActivity#96';
   override readonly treeNodeShortName =
     'ActivityRecord{64953af u0 com.google.(...).NexusLauncherActivity#96';
   override readonly numberOfFilteredProperties = 3;
-  override readonly hierarchyFilterString = 'Wallpaper';
+  override readonly hierarchyFilter = new TextFilter('Wallpaper', []);
   override readonly expectedHierarchyChildrenAfterStringFilter = 4;
   override readonly propertyWithDiff = 'bounds';
   override readonly expectedPropertyDiffType = DiffType.ADDED;
@@ -74,6 +81,14 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
         await UnitTestUtils.getLayerTraceEntry(0),
         await UnitTestUtils.getMultiDisplayLayerTraceEntry(),
         await UnitTestUtils.getLayerTraceEntry(1),
+        await UnitTestUtils.getTraceEntry<HierarchyTreeNode>(
+          'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
+          5,
+        ),
+        await UnitTestUtils.getTraceEntry<HierarchyTreeNode>(
+          'traces/elapsed_and_real_timestamp/SurfaceFlinger.pb',
+          6,
+        ),
       ])
       .build();
 
@@ -89,14 +104,18 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
     const firstEntryDataTree = await firstEntry.getValue();
     const layer = assertDefined(
       firstEntryDataTree.findDfs(
-        UiTreeUtils.makeIdMatchFilter('53 Dim layer#53'),
+        UiTreeUtils.makeIdMatchFilter(
+          '163 Surface(name=b48baf1 InputMethod)/@0x3a7bd57 - animation-leash of insets_animation#163',
+        ),
       ),
     );
     const selectedTreeParent = UiHierarchyTreeNode.from(
       assertDefined(layer.getZParent()),
     );
     this.selectedTree = assertDefined(
-      selectedTreeParent.getChildByName('Dim layer#53'),
+      selectedTreeParent.getChildByName(
+        'Surface(name=b48baf1 InputMethod)/@0x3a7bd57 - animation-leash of insets_animation#163',
+      ),
     );
     this.selectedTreeAfterPositionUpdate = UiHierarchyTreeNode.from(
       assertDefined(
@@ -112,7 +131,7 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
   }
 
   override createPresenterWithEmptyTrace(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
     const trace = new TraceBuilder<HierarchyTreeNode>()
       .setType(TraceType.SURFACE_FLINGER)
@@ -123,15 +142,29 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
     return new Presenter(trace, traces, new InMemoryStorage(), callback);
   }
 
-  override createPresenter(
-    callback: NotifyHierarchyViewCallbackType,
+  override createPresenterWithCorruptedTrace(
+    callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
+    const trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.SURFACE_FLINGER)
+      .setEntries([assertDefined(this.selectedTree)])
+      .setIsCorrupted(true)
+      .build();
     const traces = new Traces();
-    const trace = assertDefined(this.traceSf);
     traces.addTrace(trace);
     return new Presenter(trace, traces, new InMemoryStorage(), callback);
   }
 
+  override createPresenter(
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+    storage: Store,
+  ): Presenter {
+    const traces = new Traces();
+    const traceSf = assertDefined(this.traceSf);
+    traces.addTrace(traceSf);
+    return new Presenter(traceSf, traces, storage, callback);
+  }
+
   override getPositionUpdate(): TracePositionUpdate {
     return assertDefined(this.positionUpdate);
   }
@@ -191,6 +224,14 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
           ?.getChildByName('byteOffset'),
       ).formattedValue(),
     ).toEqual('2919');
+    expect(uiData.displays).toEqual([
+      {
+        displayId: '4619827677550801152',
+        groupId: 0,
+        name: 'Common Panel',
+        isActive: true,
+      },
+    ]);
   }
 
   override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
@@ -216,6 +257,7 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
     expect(curatedProperties.summary).toEqual([
       {
         key: 'Covered by',
+        desc: 'Partially or fully covered by these likely translucent layers',
         layerValues: [
           {
             layerId: '65',
@@ -246,8 +288,10 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
     describe('Specialized tests', () => {
       let presenter: Presenter;
       let uiData: UiData;
+      let userNotifierChecker: UserNotifierChecker;
 
       beforeAll(async () => {
+        userNotifierChecker = new UserNotifierChecker();
         await this.setUpTestEnvironment();
       });
 
@@ -256,10 +300,16 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
           uiData = newData;
         };
         presenter = this.createPresenter(
-          notifyViewCallback as NotifyHierarchyViewCallbackType,
+          notifyViewCallback as NotifyHierarchyViewCallbackType<UiData>,
+          new InMemoryStorage(),
         );
       });
 
+      afterEach(() => {
+        userNotifierChecker.expectNone();
+        userNotifierChecker.reset();
+      });
+
       it('handles displays with no visible layers', async () => {
         await presenter?.onAppEvent(
           assertDefined(this.positionUpdateMultiDisplayEntry),
@@ -267,15 +317,74 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
         expect(uiData?.displays?.length).toEqual(5);
         // we want the displays to be sorted by name
         expect(uiData?.displays).toEqual([
+          {
+            displayId: '4619827259835644672',
+            groupId: 0,
+            name: 'EMU_display_0',
+            isActive: true,
+          },
+          {
+            displayId: '4619827551948147201',
+            groupId: 2,
+            name: 'EMU_display_1',
+            isActive: true,
+          },
+          {
+            displayId: '4619827540095559171',
+            groupId: 4,
+            name: 'EMU_display_3',
+            isActive: true,
+          },
+          {
+            displayId: '4619827124781842690',
+            groupId: 3,
+            name: 'EMU_display_2',
+            isActive: true,
+          },
           {
             displayId: '11529215046312967684',
             groupId: 5,
             name: 'ClusterOsDouble-VD',
+            isActive: false,
+          },
+        ]);
+      });
+
+      it('uses WM focused display id to determine active display', async () => {
+        const traces = new Traces();
+        const traceSf = assertDefined(this.traceSf);
+        const traceWm = new TraceBuilder<HierarchyTreeNode>()
+          .setType(TraceType.WINDOW_MANAGER)
+          .setEntries([
+            new HierarchyTreeBuilder()
+              .setId('WindowManagerState entry')
+              .setName('root')
+              .setProperties({focusedDisplayId: 3})
+              .build(),
+          ])
+          .build();
+        traces.addTrace(traceSf);
+        traces.addTrace(traceWm);
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        const presenter = new Presenter(
+          traceSf,
+          traces,
+          new InMemoryStorage(),
+          notifyViewCallback,
+        );
+        const positionUpdate = TracePositionUpdate.fromTraceEntry(
+          traceSf.getEntry(0),
+        );
+        await presenter.onAppEvent(positionUpdate);
+        expect(uiData?.displays).toEqual([
+          {
+            displayId: '4619827677550801152',
+            groupId: 0,
+            name: 'Common Panel',
+            isActive: false,
           },
-          {displayId: '4619827259835644672', groupId: 0, name: 'EMU_display_0'},
-          {displayId: '4619827551948147201', groupId: 2, name: 'EMU_display_1'},
-          {displayId: '4619827124781842690', groupId: 3, name: 'EMU_display_2'},
-          {displayId: '4619827540095559171', groupId: 4, name: 'EMU_display_3'},
         ]);
       });
 
@@ -300,7 +409,7 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
           traceSf,
           traces,
           new InMemoryStorage(),
-          notifyViewCallback as NotifyHierarchyViewCallbackType,
+          notifyViewCallback as NotifyHierarchyViewCallbackType<UiData>,
         );
 
         const firstEntry = traceSf.getEntry(0);
@@ -309,8 +418,108 @@ class PresenterSurfaceFlingerTest extends AbstractHierarchyViewerPresenterTest {
         await presenter.onAppEvent(positionUpdate);
         expect(
           uiData.rectsToDraw.filter((rect) => rect.hasContent).length,
-        ).toEqual(1);
+        ).toEqual(2);
+      });
+
+      it('keeps alpha and transform type regardless of show/hide defaults', async () => {
+        const userOptions: UserOptions = {
+          showDiff: {
+            name: 'Show diff',
+            enabled: true,
+          },
+          showDefaults: {
+            name: 'Show defaults',
+            enabled: true,
+          },
+        };
+
+        const treeForAlphaCheck = this.getSelectedTree();
+        const treeForTransformCheck = this.getSelectedTreeAfterPositionUpdate();
+
+        await presenter.onAppEvent(this.getPositionUpdate());
+        await checkColorAndTransformProperties(
+          treeForAlphaCheck,
+          treeForTransformCheck,
+        );
+
+        await presenter.onPropertiesUserOptionsChange(userOptions);
+        await checkColorAndTransformProperties(
+          treeForAlphaCheck,
+          treeForTransformCheck,
+        );
       });
+
+      it('clears curated properties on position update if no properties tree found', async () => {
+        const trace = assertDefined(this.traceSf);
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(3)),
+        );
+
+        const nodeName =
+          '101 Surface(name=Task=1)/@0x47f46c9 - animation-leash of app_transition#101';
+
+        await presenter.onHighlightedIdChange(nodeName);
+        expect(uiData.propertiesTree).toBeDefined();
+        expect(uiData.curatedProperties).toBeDefined();
+
+        await presenter.onAppEvent(
+          TracePositionUpdate.fromTraceEntry(trace.getEntry(4)),
+        );
+        expect(uiData.propertiesTree).toBeUndefined();
+        expect(uiData.curatedProperties).toBeUndefined();
+      });
+
+      it('updates zOrderRelativeOf formatter and rel-z curated properties correctly', async () => {
+        await presenter.onAppEvent(this.getPositionUpdate());
+
+        const nodeWithRelZChild = assertDefined(
+          assertDefined(uiData.hierarchyTrees)[0].findDfs(
+            UiTreeUtils.makeNodeFilter(
+              '98 2c99222 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity#98',
+            ),
+          ),
+        );
+        const nodeWithRelZParent = assertDefined(
+          assertDefined(uiData.hierarchyTrees)[0].findDfs(
+            UiTreeUtils.makeNodeFilter('13 ImeContainer#13'),
+          ),
+        );
+
+        await presenter.onHighlightedNodeChange(nodeWithRelZChild);
+        expect(uiData.curatedProperties?.relativeParent).toEqual('none');
+        expect(uiData.curatedProperties?.relativeChildren).toEqual([
+          {
+            layerId: '13',
+            nodeId: nodeWithRelZParent.id,
+            name: nodeWithRelZParent.name,
+          },
+        ]);
+
+        await presenter.onHighlightedNodeChange(nodeWithRelZParent);
+        expect(uiData.curatedProperties?.relativeParent).toEqual({
+          layerId: '98',
+          nodeId: nodeWithRelZChild.id,
+          name: nodeWithRelZChild.name,
+        });
+        expect(uiData.curatedProperties?.relativeChildren).toEqual([]);
+      });
+
+      async function checkColorAndTransformProperties(
+        treeForAlphaCheck: UiHierarchyTreeNode,
+        treeForTransformCheck: UiHierarchyTreeNode,
+      ) {
+        await presenter.onHighlightedNodeChange(treeForAlphaCheck);
+        expect(
+          uiData.propertiesTree?.getChildByName('color')?.formattedValue(),
+        ).toEqual(`${EMPTY_OBJ_STRING}, alpha: 0`);
+
+        await presenter.onHighlightedNodeChange(treeForTransformCheck);
+        expect(
+          uiData.propertiesTree
+            ?.getChildByName('requestedTransform')
+            ?.formattedValue(),
+        ).toEqual('IDENTITY');
+      }
     });
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts b/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
index 348a2b6f0..6e093cc22 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/ui_data.ts
@@ -18,11 +18,12 @@ import {TraceType} from 'trace/trace_type';
 import {SfCuratedProperties} from 'viewers/common/curated_properties';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 
 export class UiData implements UiDataHierarchy {
   readonly dependencies: TraceType[] = [TraceType.SURFACE_FLINGER];
@@ -31,12 +32,15 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
+  hierarchyFilter = new TextFilter('', []);
+  propertiesFilter = new TextFilter('', []);
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
   propertiesUserOptions: UserOptions = {};
   hierarchyTrees: UiHierarchyTreeNode[] | undefined;
   propertiesTree: UiPropertyTreeNode | undefined;
+  isDarkMode = false;
 
   constructor(
     public curatedProperties: SfCuratedProperties | undefined = undefined,
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
index 08704ae32..1d3eee63e 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger.ts
@@ -14,17 +14,19 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
+import {ViewerSurfaceFlingerComponent} from './viewer_surface_flinger_component';
 
 export class ViewerSurfaceFlinger implements Viewer {
   static readonly DEPENDENCIES: TraceType[] = [TraceType.SURFACE_FLINGER];
@@ -34,23 +36,15 @@ export class ViewerSurfaceFlinger implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-surface-flinger');
 
     const notifyViewCallback = (uiData: UiData) => {
-      (this.htmlElement as any).inputData = uiData;
+      (this.htmlElement as unknown as ViewerSurfaceFlingerComponent).inputData =
+        uiData;
     };
-    this.presenter = new Presenter(
-      trace,
-      traces,
-      storage,
-      notifyViewCallback as NotifyHierarchyViewCallbackType,
-    );
+    this.presenter = new Presenter(trace, traces, storage, notifyViewCallback);
     this.presenter.addEventListeners(this.htmlElement);
 
     this.htmlElement.addEventListener(
@@ -65,7 +59,7 @@ export class ViewerSurfaceFlinger implements Viewer {
       ViewType.TAB,
       this.getTraces(),
       this.htmlElement,
-      'Surface Flinger',
+      TRACE_INFO[TraceType.SURFACE_FLINGER].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
index ca8b2414b..bec5f631e 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component.ts
@@ -19,7 +19,7 @@ import {PersistentStore} from 'common/persistent_store';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {ShadingMode} from 'viewers/components/rects/types3d';
+import {ShadingMode} from 'viewers/components/rects/shading_mode';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
@@ -45,15 +45,18 @@ import {UiData} from './ui_data';
         [shadingModes]="shadingModes"
         [dependencies]="inputData?.dependencies ?? []"
         [userOptions]="inputData?.rectsUserOptions ?? {}"
+        [pinnedItems]="inputData?.pinnedItems ?? []"
+        [isDarkMode]="inputData?.isDarkMode ?? false"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.RECTS, true)"></rects-view>
 
       <hierarchy-view
         class="hierarchy-view"
         [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.HIERARCHY)"
-        [tree]="inputData?.hierarchyTrees[0]"
+        [tree]="inputData?.hierarchyTrees?.at(0)"
         [dependencies]="inputData?.dependencies ?? []"
         [highlightedItem]="inputData?.highlightedItem ?? ''"
         [pinnedItems]="inputData?.pinnedItems ?? []"
+        [textFilter]="inputData?.hierarchyFilter"
         [store]="store"
         [userOptions]="inputData?.hierarchyUserOptions ?? {}"
         [rectIdToShowState]="inputData?.rectIdToShowState"
@@ -79,6 +82,7 @@ import {UiData} from './ui_data';
           [displayPropertyGroups]="inputData?.displayPropertyGroups"
           [isProtoDump]="true"
           placeholderText="No selected entry or layer."
+          [textFilter]="inputData?.propertiesFilter"
           (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"></properties-view>
       </div>
     </div>
diff --git a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component_test.ts b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component_test.ts
index 7f17a5076..51ed64e28 100644
--- a/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_surface_flinger/viewer_surface_flinger_component_test.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 import {CommonModule} from '@angular/common';
+import {HttpClientModule} from '@angular/common/http';
 import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
@@ -70,6 +71,7 @@ describe('ViewerSurfaceFlingerComponent', () => {
         MatTooltipModule,
         MatButtonModule,
         MatSelectModule,
+        HttpClientModule,
       ],
       schemas: [CUSTOM_ELEMENTS_SCHEMA],
     }).compileComponents();
diff --git a/tools/winscope/src/viewers/viewer_transactions/presenter.ts b/tools/winscope/src/viewers/viewer_transactions/presenter.ts
index c93160e65..c9da60ab0 100644
--- a/tools/winscope/src/viewers/viewer_transactions/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/presenter.ts
@@ -14,63 +14,38 @@
  * limitations under the License.
  */
 
-import {ArrayUtils} from 'common/array_utils';
 import {assertDefined} from 'common/assert_utils';
-import {FunctionUtils} from 'common/function_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
-import {
-  TracePositionUpdate,
-  WinscopeEvent,
-  WinscopeEventType,
-} from 'messaging/winscope_event';
-import {
-  EmitEvent,
-  WinscopeEventEmitter,
-} from 'messaging/winscope_event_emitter';
-import {AbsoluteEntryIndex} from 'trace/index_types';
-import {Trace, TraceEntry} from 'trace/trace';
-import {TraceEntryFinder} from 'trace/trace_entry_finder';
-import {TIMESTAMP_NODE_FORMATTER} from 'trace/tree_node/formatters';
+import {Store} from 'common/store';
+import {Trace} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {DEFAULT_PROPERTY_TREE_NODE_FACTORY} from 'trace/tree_node/property_tree_node_factory';
-import {Filter} from 'viewers/common/operations/filter';
-import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
-import {UiTreeFormatter} from 'viewers/common/ui_tree_formatter';
-import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {LogField, LogFieldType, LogFilter} from 'viewers/common/ui_data_log';
 import {UserOptions} from 'viewers/common/user_options';
 import {SetRootDisplayNames} from './operations/set_root_display_name';
-import {UiData, UiDataEntry, UiDataEntryType} from './ui_data';
-
-type NotifyViewCallbackType = (uiData: UiData) => void;
-
-export class Presenter implements WinscopeEventEmitter {
-  private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
-  private readonly trace: Trace<PropertyTreeNode>;
-  private entry?: TraceEntry<PropertyTreeNode>;
-  private originalIndicesOfUiDataEntries: number[];
-  private uiData = UiData.EMPTY;
-
+import {TransactionsEntry, TransactionsEntryType, UiData} from './ui_data';
+
+export class Presenter extends AbstractLogViewerPresenter<UiData> {
+  private static readonly FIELD_TYPES = [
+    LogFieldType.TRANSACTION_ID,
+    LogFieldType.VSYNC_ID,
+    LogFieldType.PID,
+    LogFieldType.UID,
+    LogFieldType.TRANSACTION_TYPE,
+    LogFieldType.LAYER_OR_DISPLAY_ID,
+    LogFieldType.FLAGS,
+  ];
+  private static readonly VALUE_NA = 'N/A';
   private isInitialized = false;
-  private allUiDataEntries: UiDataEntry[] = [];
-  private allVSyncIds: string[] = [];
-  private allPids: string[] = [];
-  private allUids: string[] = [];
-  private allTypes: string[] = [];
-  private allLayerAndDisplayIds: string[] = [];
-  private allTransactionIds: string[] = [];
-  private allFlags: string[] = [];
-
-  private vsyncIdFilter: string[] = [];
-  private pidFilter: string[] = [];
-  private uidFilter: string[] = [];
-  private typeFilter: string[] = [];
-  private layerIdFilter: string[] = [];
-  private whatFilter: string[] = [];
-  private transactionIdFilter: string[] = [];
 
-  private currentPropertiesTree: PropertyTreeNode | undefined;
-
-  private propertiesUserOptions: UserOptions =
+  protected override keepCalculated = true;
+  protected override logPresenter = new LogPresenter<TransactionsEntry>();
+  protected override propertiesPresenter = new PropertiesPresenter(
     PersistentStoreProxy.new<UserOptions>(
       'TransactionsPropertyOptions',
       {
@@ -85,322 +60,64 @@ export class Presenter implements WinscopeEventEmitter {
         },
       },
       this.storage,
-    );
-
-  private readonly notifyUiDataCallback: NotifyViewCallbackType;
-  private static readonly VALUE_NA = 'N/A';
+    ),
+    undefined,
+    [],
+    [new SetRootDisplayNames()],
+  );
 
   constructor(
     trace: Trace<PropertyTreeNode>,
-    private readonly storage: Storage,
-    notifyViewCallback: NotifyViewCallbackType,
+    readonly storage: Store,
+    notifyViewCallback: NotifyLogViewCallbackType<UiData>,
   ) {
-    this.trace = trace;
-    this.notifyUiDataCallback = notifyViewCallback;
-    this.originalIndicesOfUiDataEntries = [];
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  setEmitEvent(callback: EmitEvent) {
-    this.emitAppEvent = callback;
-  }
-
-  async onAppEvent(event: WinscopeEvent) {
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.initializeIfNeeded();
-        this.entry = TraceEntryFinder.findCorrespondingEntry(
-          this.trace,
-          event.position,
-        );
-        this.uiData.currentEntryIndex = this.computeCurrentEntryIndex();
-        this.uiData.selectedEntryIndex = undefined;
-        this.uiData.scrollToIndex = this.uiData.currentEntryIndex;
-        this.currentPropertiesTree = this.computePropertiesTree(
-          this.uiData.entries,
-          this.uiData.currentEntryIndex,
-          this.uiData.selectedEntryIndex,
-        );
-        this.uiData.currentPropertiesTree = this.formatPropertiesTree(
-          this.currentPropertiesTree,
-        );
-
-        this.notifyUiDataCallback(this.uiData);
-      },
-    );
-  }
-
-  onVSyncIdFilterChanged(vsyncIds: string[]) {
-    this.vsyncIdFilter = vsyncIds;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onPidFilterChanged(pids: string[]) {
-    this.pidFilter = pids;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onUidFilterChanged(uids: string[]) {
-    this.uidFilter = uids;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onTypeFilterChanged(types: string[]) {
-    this.typeFilter = types;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onLayerIdFilterChanged(ids: string[]) {
-    this.layerIdFilter = ids;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onWhatFilterChanged(flags: string[]) {
-    this.whatFilter = flags;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onTransactionIdFilterChanged(ids: string[]) {
-    this.transactionIdFilter = ids;
-    this.uiData = this.computeUiData();
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  onEntryClicked(index: number) {
-    if (this.uiData.selectedEntryIndex === index) {
-      return;
-    }
-    this.uiData.selectedEntryIndex = index;
-    this.uiData.scrollToIndex = undefined; // no scrolling
-    this.updatePropertiesTree();
-  }
-
-  onEntryChangedByKeyPress(index: number) {
-    if (this.uiData.selectedEntryIndex === index) {
-      return;
-    }
-    this.uiData.selectedEntryIndex = index;
-    this.uiData.scrollToIndex = index;
-    this.updatePropertiesTree();
+    super(trace, notifyViewCallback, UiData.createEmpty());
   }
 
-  onPropertiesUserOptionsChange(userOptions: UserOptions) {
-    this.propertiesUserOptions = userOptions;
-    this.uiData.propertiesUserOptions = this.propertiesUserOptions;
-    this.uiData.currentPropertiesTree = this.formatPropertiesTree(
-      this.currentPropertiesTree,
-    );
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  async onLogTimestampClicked(traceIndex: AbsoluteEntryIndex) {
-    await this.emitAppEvent(
-      TracePositionUpdate.fromTraceEntry(this.trace.getEntry(traceIndex), true),
-    );
-  }
-
-  private async initializeIfNeeded() {
+  protected override async initializeIfNeeded() {
     if (this.isInitialized) {
       return;
     }
 
-    this.allUiDataEntries = await this.makeUiDataEntries();
-
-    this.allVSyncIds = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.vsyncId.toString(),
-    );
-    this.allPids = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.pid,
-    );
-    this.allUids = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.uid,
-    );
-    this.allTypes = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.type,
-    );
-    this.allLayerAndDisplayIds = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.layerOrDisplayId,
-    );
-    this.allTransactionIds = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.transactionId,
-    );
-    this.allFlags = this.getUniqueUiDataEntryValues(
-      this.allUiDataEntries,
-      (entry: UiDataEntry) => entry.what.split('|').map((flag) => flag.trim()),
-    );
-
-    this.uiData = this.computeUiData();
-
-    this.isInitialized = true;
-  }
-
-  private computeUiData(): UiData {
-    const entries = this.allUiDataEntries;
-
-    let filteredEntries = entries;
-
-    if (this.vsyncIdFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.vsyncIdFilter.includes(entry.vsyncId.toString()),
-      );
-    }
-
-    if (this.pidFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.pidFilter.includes(entry.pid),
-      );
-    }
-
-    if (this.uidFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.uidFilter.includes(entry.uid),
-      );
-    }
-
-    if (this.typeFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.typeFilter.includes(entry.type),
-      );
-    }
+    const allEntries = await this.makeUiDataEntries();
+    const filters: LogFilter[] = [];
 
-    if (this.layerIdFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.layerIdFilter.includes(entry.layerOrDisplayId),
-      );
-    }
-
-    if (this.whatFilter.length > 0) {
-      filteredEntries = filteredEntries.filter(
-        (entry) =>
-          this.whatFilter.find((flag) => entry.what.includes(flag)) !==
-          undefined,
-      );
-    }
-
-    if (this.transactionIdFilter.length > 0) {
-      filteredEntries = filteredEntries.filter((entry) =>
-        this.transactionIdFilter.includes(entry.transactionId.toString()),
-      );
-    }
-
-    this.originalIndicesOfUiDataEntries = filteredEntries.map(
-      (entry) => entry.traceIndex,
-    );
-
-    const currentEntryIndex = this.computeCurrentEntryIndex();
-    const selectedEntryIndex = undefined;
-    this.currentPropertiesTree = this.computePropertiesTree(
-      filteredEntries,
-      currentEntryIndex,
-      selectedEntryIndex,
-    );
-
-    const formattedPropertiesTree = this.formatPropertiesTree(
-      this.currentPropertiesTree,
-    );
-
-    return new UiData(
-      this.allVSyncIds,
-      this.allPids,
-      this.allUids,
-      this.allTypes,
-      this.allLayerAndDisplayIds,
-      this.allTransactionIds,
-      this.allFlags,
-      filteredEntries,
-      currentEntryIndex,
-      selectedEntryIndex,
-      currentEntryIndex,
-      formattedPropertiesTree,
-      this.propertiesUserOptions,
-    );
-  }
-
-  private computeCurrentEntryIndex(): undefined | number {
-    if (!this.entry) {
-      return undefined;
-    }
-
-    if (this.originalIndicesOfUiDataEntries.length === 0) {
-      return undefined;
-    }
-
-    return (
-      ArrayUtils.binarySearchFirstGreaterOrEqual(
-        this.originalIndicesOfUiDataEntries,
-        this.entry.getIndex(),
-      ) ?? this.originalIndicesOfUiDataEntries.length - 1
-    );
-  }
-
-  private updatePropertiesTree() {
-    this.currentPropertiesTree = this.computePropertiesTree(
-      this.uiData.entries,
-      this.uiData.currentEntryIndex,
-      this.uiData.selectedEntryIndex,
-    );
-
-    this.uiData.currentPropertiesTree = this.formatPropertiesTree(
-      this.currentPropertiesTree,
-    );
-
-    this.notifyUiDataCallback(this.uiData);
-  }
-
-  private computePropertiesTree(
-    entries: UiDataEntry[],
-    currentEntryIndex: undefined | number,
-    selectedEntryIndex: undefined | number,
-  ): PropertyTreeNode | undefined {
-    if (selectedEntryIndex !== undefined) {
-      return entries[selectedEntryIndex].propertiesTree;
-    }
-    if (currentEntryIndex !== undefined) {
-      return entries[currentEntryIndex].propertiesTree;
-    }
-    return undefined;
-  }
-
-  private formatPropertiesTree(
-    propertiesTree: PropertyTreeNode | undefined,
-  ): UiPropertyTreeNode | undefined {
-    if (!propertiesTree) return undefined;
-
-    const uiTree = UiPropertyTreeNode.from(propertiesTree);
-    const formatter = new UiTreeFormatter<UiPropertyTreeNode>().setUiTree(
-      uiTree,
-    );
-
-    if (!this.propertiesUserOptions['showDefaults']?.enabled) {
-      formatter.addOperation(
-        new Filter(
-          [
-            UiTreeUtils.isNotDefault,
-            UiTreeUtils.makePropertyMatchFilter('IDENTITY'),
-          ],
-          false,
-        ),
-      );
+    for (const type of Presenter.FIELD_TYPES) {
+      if (type === LogFieldType.FLAGS) {
+        filters.push({
+          type,
+          options: this.getUniqueUiDataEntryValues(
+            allEntries,
+            (entry: TransactionsEntry) =>
+              assertDefined(
+                entry.fields.find((f) => f.type === type)?.value as string,
+              )
+                .split('|')
+                .map((flag) => flag.trim()),
+          ),
+        });
+      } else {
+        filters.push({
+          type,
+          options: this.getUniqueUiDataEntryValues(
+            allEntries,
+            (entry: TransactionsEntry) =>
+              assertDefined(
+                entry.fields.find((f) => f.type === type),
+              ).value.toString(),
+          ),
+        });
+      }
     }
 
-    return formatter.addOperation(new SetRootDisplayNames()).format();
+    this.logPresenter.setAllEntries(allEntries);
+    this.logPresenter.setFilters(filters);
+    this.refreshUiData();
+    this.isInitialized = true;
   }
 
-  private async makeUiDataEntries(): Promise<UiDataEntry[]> {
-    const entries: UiDataEntry[] = [];
+  private async makeUiDataEntries(): Promise<TransactionsEntry[]> {
+    const entries: TransactionsEntry[] = [];
 
     const entryProtos = await Promise.all(
       this.trace.mapEntry(async (entry) => {
@@ -419,183 +136,207 @@ export class Presenter implements WinscopeEventEmitter {
         assertDefined(entryNode.getChildByName('vsyncId')).getValue(),
       );
 
-      const entryTimestamp =
-        DEFAULT_PROPERTY_TREE_NODE_FACTORY.makeCalculatedProperty(
-          'TransactionsTraceEntry',
-          'timestamp',
-          entry.getTimestamp(),
-        );
-      entryTimestamp.setFormatter(TIMESTAMP_NODE_FORMATTER);
-
       for (const transactionState of assertDefined(
         entryNode.getChildByName('transactions'),
       ).getAllChildren()) {
+        const transactionId = assertDefined(
+          transactionState.getChildByName('transactionId'),
+        ).formattedValue();
         const pid = assertDefined(
           transactionState.getChildByName('pid'),
         ).formattedValue();
         const uid = assertDefined(
           transactionState.getChildByName('uid'),
         ).formattedValue();
-        const transactionId = assertDefined(
-          transactionState.getChildByName('transactionId'),
-        ).formattedValue();
-
         const layerChanges = assertDefined(
           transactionState.getChildByName('layerChanges'),
         ).getAllChildren();
+
         for (const layerState of layerChanges) {
-          entries.push(
-            new UiDataEntry(
-              traceIndex,
-              entryTimestamp,
-              vsyncId,
-              pid,
-              uid,
-              UiDataEntryType.LAYER_CHANGED,
-              assertDefined(
+          const fields: LogField[] = [
+            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
+            {type: LogFieldType.VSYNC_ID, value: vsyncId},
+            {type: LogFieldType.PID, value: pid},
+            {type: LogFieldType.UID, value: uid},
+            {
+              type: LogFieldType.TRANSACTION_TYPE,
+              value: TransactionsEntryType.LAYER_CHANGED,
+            },
+            {
+              type: LogFieldType.LAYER_OR_DISPLAY_ID,
+              value: assertDefined(
                 layerState.getChildByName('layerId'),
               ).formattedValue(),
-              transactionId,
-              assertDefined(layerState.getChildByName('what')).formattedValue(),
-              layerState,
-            ),
-          );
+            },
+            {
+              type: LogFieldType.FLAGS,
+              value: assertDefined(
+                layerState.getChildByName('what'),
+              ).formattedValue(),
+            },
+          ];
+          entries.push(new TransactionsEntry(entry, fields, layerState));
         }
 
         const displayChanges = assertDefined(
           transactionState.getChildByName('displayChanges'),
         ).getAllChildren();
         for (const displayState of displayChanges) {
-          entries.push(
-            new UiDataEntry(
-              traceIndex,
-              entryTimestamp,
-              vsyncId,
-              pid,
-              uid,
-              UiDataEntryType.DISPLAY_CHANGED,
-              assertDefined(displayState.getChildByName('id')).formattedValue(),
-              transactionId,
-              assertDefined(
+          const fields: LogField[] = [
+            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
+            {type: LogFieldType.VSYNC_ID, value: vsyncId},
+            {type: LogFieldType.PID, value: pid},
+            {type: LogFieldType.UID, value: uid},
+            {
+              type: LogFieldType.TRANSACTION_TYPE,
+              value: TransactionsEntryType.DISPLAY_CHANGED,
+            },
+            {
+              type: LogFieldType.LAYER_OR_DISPLAY_ID,
+              value: assertDefined(
+                displayState.getChildByName('id'),
+              ).formattedValue(),
+            },
+            {
+              type: LogFieldType.FLAGS,
+              value: assertDefined(
                 displayState.getChildByName('what'),
               ).formattedValue(),
-              displayState,
-            ),
-          );
+            },
+          ];
+          entries.push(new TransactionsEntry(entry, fields, displayState));
         }
 
         if (layerChanges.length === 0 && displayChanges.length === 0) {
-          entries.push(
-            new UiDataEntry(
-              traceIndex,
-              entryTimestamp,
-              vsyncId,
-              pid,
-              uid,
-              UiDataEntryType.NO_OP,
-              '',
-              transactionId,
-              '',
-              undefined,
-            ),
-          );
+          const fields: LogField[] = [
+            {type: LogFieldType.TRANSACTION_ID, value: transactionId},
+            {type: LogFieldType.VSYNC_ID, value: vsyncId},
+            {type: LogFieldType.PID, value: pid},
+            {type: LogFieldType.UID, value: uid},
+            {
+              type: LogFieldType.TRANSACTION_TYPE,
+              value: TransactionsEntryType.NO_OP,
+            },
+            {type: LogFieldType.LAYER_OR_DISPLAY_ID, value: ''},
+            {type: LogFieldType.FLAGS, value: ''},
+          ];
+          entries.push(new TransactionsEntry(entry, fields, undefined));
         }
       }
 
       for (const layerCreationArgs of assertDefined(
         entryNode.getChildByName('addedLayers'),
       ).getAllChildren()) {
-        entries.push(
-          new UiDataEntry(
-            traceIndex,
-            entryTimestamp,
-            vsyncId,
-            Presenter.VALUE_NA,
-            Presenter.VALUE_NA,
-            UiDataEntryType.LAYER_ADDED,
-            assertDefined(
+        const fields: LogField[] = [
+          {type: LogFieldType.TRANSACTION_ID, value: ''},
+          {type: LogFieldType.VSYNC_ID, value: vsyncId},
+          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
+          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            value: TransactionsEntryType.LAYER_ADDED,
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: assertDefined(
               layerCreationArgs.getChildByName('layerId'),
             ).formattedValue(),
-            '',
-            '',
-            layerCreationArgs,
-          ),
-        );
+          },
+          {type: LogFieldType.FLAGS, value: ''},
+        ];
+        entries.push(new TransactionsEntry(entry, fields, layerCreationArgs));
       }
 
       for (const destroyedLayerId of assertDefined(
         entryNode.getChildByName('destroyedLayers'),
       ).getAllChildren()) {
-        entries.push(
-          new UiDataEntry(
-            traceIndex,
-            entryTimestamp,
-            vsyncId,
-            Presenter.VALUE_NA,
-            Presenter.VALUE_NA,
-            UiDataEntryType.LAYER_DESTROYED,
-            destroyedLayerId.formattedValue(),
-            '',
-            '',
-            destroyedLayerId,
-          ),
-        );
+        const fields: LogField[] = [
+          {type: LogFieldType.TRANSACTION_ID, value: ''},
+          {type: LogFieldType.VSYNC_ID, value: vsyncId},
+          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
+          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            value: TransactionsEntryType.LAYER_DESTROYED,
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: destroyedLayerId.formattedValue(),
+          },
+          {type: LogFieldType.FLAGS, value: ''},
+        ];
+        entries.push(new TransactionsEntry(entry, fields, destroyedLayerId));
       }
 
       for (const displayState of assertDefined(
         entryNode.getChildByName('addedDisplays'),
       ).getAllChildren()) {
-        entries.push(
-          new UiDataEntry(
-            traceIndex,
-            entryTimestamp,
-            vsyncId,
-            Presenter.VALUE_NA,
-            Presenter.VALUE_NA,
-            UiDataEntryType.DISPLAY_ADDED,
-            assertDefined(displayState.getChildByName('id')).formattedValue(),
-            '',
-            assertDefined(displayState.getChildByName('what')).formattedValue(),
-            displayState,
-          ),
-        );
+        const fields: LogField[] = [
+          {type: LogFieldType.TRANSACTION_ID, value: ''},
+          {type: LogFieldType.VSYNC_ID, value: vsyncId},
+          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
+          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            value: TransactionsEntryType.DISPLAY_ADDED,
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: assertDefined(
+              displayState.getChildByName('id'),
+            ).formattedValue(),
+          },
+          {
+            type: LogFieldType.FLAGS,
+            value: assertDefined(
+              displayState.getChildByName('what'),
+            ).formattedValue(),
+          },
+        ];
+        entries.push(new TransactionsEntry(entry, fields, displayState));
       }
 
       for (const removedDisplayId of assertDefined(
         entryNode.getChildByName('removedDisplays'),
       ).getAllChildren()) {
-        entries.push(
-          new UiDataEntry(
-            traceIndex,
-            entryTimestamp,
-            vsyncId,
-            Presenter.VALUE_NA,
-            Presenter.VALUE_NA,
-            UiDataEntryType.DISPLAY_REMOVED,
-            removedDisplayId.formattedValue(),
-            '',
-            '',
-            removedDisplayId,
-          ),
-        );
+        const fields: LogField[] = [
+          {type: LogFieldType.TRANSACTION_ID, value: ''},
+          {type: LogFieldType.VSYNC_ID, value: vsyncId},
+          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
+          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            value: TransactionsEntryType.DISPLAY_REMOVED,
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: removedDisplayId.formattedValue(),
+          },
+          {type: LogFieldType.FLAGS, value: ''},
+        ];
+        entries.push(new TransactionsEntry(entry, fields, removedDisplayId));
       }
 
       for (const destroyedLayerHandleId of assertDefined(
         entryNode.getChildByName('destroyedLayerHandles'),
       ).getAllChildren()) {
+        const fields: LogField[] = [
+          {type: LogFieldType.TRANSACTION_ID, value: ''},
+          {type: LogFieldType.VSYNC_ID, value: vsyncId},
+          {type: LogFieldType.PID, value: Presenter.VALUE_NA},
+          {type: LogFieldType.UID, value: Presenter.VALUE_NA},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            value: TransactionsEntryType.LAYER_HANDLE_DESTROYED,
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: destroyedLayerHandleId.formattedValue(),
+          },
+          {type: LogFieldType.FLAGS, value: ''},
+        ];
         entries.push(
-          new UiDataEntry(
-            traceIndex,
-            entryTimestamp,
-            vsyncId,
-            Presenter.VALUE_NA,
-            Presenter.VALUE_NA,
-            UiDataEntryType.LAYER_HANDLE_DESTROYED,
-            destroyedLayerHandleId.formattedValue(),
-            '',
-            '',
-            destroyedLayerHandleId,
-          ),
+          new TransactionsEntry(entry, fields, destroyedLayerHandleId),
         );
       }
     }
@@ -604,11 +345,11 @@ export class Presenter implements WinscopeEventEmitter {
   }
 
   private getUniqueUiDataEntryValues<T>(
-    entries: UiDataEntry[],
-    getValue: (entry: UiDataEntry) => T | T[],
+    entries: TransactionsEntry[],
+    getValue: (entry: TransactionsEntry) => T | T[],
   ): T[] {
     const uniqueValues = new Set<T>();
-    entries.forEach((entry: UiDataEntry) => {
+    entries.forEach((entry: TransactionsEntry) => {
       const value = getValue(entry);
       if (Array.isArray(value)) {
         value.forEach((val) => uniqueValues.add(val));
diff --git a/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts b/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
index c0785b7b7..ccd3c668a 100644
--- a/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/presenter_test.ts
@@ -17,360 +17,241 @@
 import {assertDefined} from 'common/assert_utils';
 import {InMemoryStorage} from 'common/in_memory_storage';
 import {TracePositionUpdate} from 'messaging/winscope_event';
-import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TraceBuilder} from 'test/unit/trace_builder';
-import {TreeNodeUtils} from 'test/unit/tree_node_utils';
 import {UnitTestUtils} from 'test/unit/utils';
 import {Parser} from 'trace/parser';
 import {Trace} from 'trace/trace';
+import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {
+  LogEntry,
+  LogFieldType,
+  LogFieldValue,
+} from 'viewers/common/ui_data_log';
+import {UserOptions} from 'viewers/common/user_options';
 import {Presenter} from './presenter';
-import {UiData, UiDataEntryType} from './ui_data';
-
-describe('PresenterTransactions', () => {
-  let parser: Parser<PropertyTreeNode>;
-  let trace: Trace<PropertyTreeNode>;
-  let presenter: Presenter;
-  let outputUiData: undefined | UiData;
-  const TOTAL_OUTPUT_ENTRIES = 1647;
+import {TransactionsEntryType, UiData} from './ui_data';
+
+class PresenterTransactionsTest extends AbstractLogViewerPresenterTest<UiData> {
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private secondPositionUpdate: TracePositionUpdate | undefined;
+
+  override readonly shouldExecuteHeaderTests = false;
+  override readonly shouldExecuteFilterTests = true;
+  override readonly shouldExecutePropertiesTests = true;
+
+  override readonly totalOutputEntries = 1647;
+  override readonly expectedIndexOfFirstPositionUpdate = 0;
+  override readonly expectedIndexOfSecondPositionUpdate = 13;
+  override readonly expectedInitialFilterOptions = new Map<
+    LogFieldType,
+    string[] | number
+  >([
+    [
+      LogFieldType.PID,
+      ['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300'],
+    ],
+    [LogFieldType.UID, ['N/A', '1000', '1003', '10169', '10235', '10239']],
+    [
+      LogFieldType.TRANSACTION_TYPE,
+      [
+        'DISPLAY_CHANGED',
+        'LAYER_ADDED',
+        'LAYER_CHANGED',
+        'LAYER_DESTROYED',
+        'LAYER_HANDLE_DESTROYED',
+        'NO_OP',
+      ],
+    ],
+    [LogFieldType.TRANSACTION_ID, 1295],
+    [LogFieldType.LAYER_OR_DISPLAY_ID, 117],
+  ]);
+  override readonly filterValuesToSet = new Map<LogFieldType, string[][]>([
+    [LogFieldType.TRANSACTION_ID, [[], ['2211908157465']]],
+    [LogFieldType.VSYNC_ID, [[], ['1'], ['1', '3', '10']]],
+    [LogFieldType.PID, [[], ['0'], ['0', '515']]],
+    [LogFieldType.UID, [[], ['1000'], ['1000', '1003']]],
+    [
+      LogFieldType.TRANSACTION_TYPE,
+      [
+        [],
+        [TransactionsEntryType.LAYER_ADDED],
+        [
+          TransactionsEntryType.LAYER_ADDED,
+          TransactionsEntryType.LAYER_DESTROYED,
+        ],
+      ],
+    ],
+    [LogFieldType.LAYER_OR_DISPLAY_ID, [[], ['1'], ['1', '3']]],
+    [LogFieldType.FLAGS, [[], ['Crop'], ['STRING_WITH_NO_MATCHES']]],
+  ]);
+  override readonly expectedFieldValuesAfterFilter = new Map<
+    LogFieldType,
+    Array<LogFieldValue[] | number>
+  >([
+    [LogFieldType.TRANSACTION_ID, [this.totalOutputEntries, ['2211908157465']]],
+    [LogFieldType.VSYNC_ID, [this.totalOutputEntries, [1], [1, 3, 10]]],
+    [
+      LogFieldType.PID,
+      [
+        ['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300'],
+        ['0'],
+        ['0', '515'],
+      ],
+    ],
+    [
+      LogFieldType.UID,
+      [
+        ['N/A', '1000', '1003', '10169', '10235', '10239'],
+        ['1000'],
+        ['1000', '1003'],
+      ],
+    ],
+    [
+      LogFieldType.TRANSACTION_TYPE,
+      [
+        [
+          TransactionsEntryType.DISPLAY_CHANGED,
+          TransactionsEntryType.LAYER_ADDED,
+          TransactionsEntryType.LAYER_CHANGED,
+          TransactionsEntryType.LAYER_DESTROYED,
+          TransactionsEntryType.LAYER_HANDLE_DESTROYED,
+          TransactionsEntryType.NO_OP,
+        ],
+        [TransactionsEntryType.LAYER_ADDED],
+        [
+          TransactionsEntryType.LAYER_ADDED,
+          TransactionsEntryType.LAYER_DESTROYED,
+        ],
+      ],
+    ],
+    [
+      LogFieldType.LAYER_OR_DISPLAY_ID,
+      [this.totalOutputEntries, ['1'], ['1', '3']],
+    ],
+    [LogFieldType.FLAGS, [this.totalOutputEntries, 980, 0]],
+  ]);
+  override readonly logEntryClickIndex = 10;
+  override readonly filterNameForCurrentIndexTest = LogFieldType.PID;
+  override readonly filterChangeForCurrentIndexTest = ['0'];
+  override readonly secondFilterChangeForCurrentIndexTest = ['0', '515'];
+  override readonly expectedCurrentIndexAfterFilterChange = 10;
+  override readonly expectedCurrentIndexAfterSecondFilterChange = 11;
+
+  override executeSpecializedTests() {
+    describe('Specialized tests', () => {
+      let presenter: Presenter;
+      let uiData: UiData;
+
+      beforeAll(async () => {
+        await this.setUpTestEnvironment();
+      });
+
+      beforeEach(async () => {
+        const notifyViewCallback = (newData: UiData) => {
+          uiData = newData;
+        };
+        presenter = await this.createPresenter(notifyViewCallback);
+      });
+
+      it('includes no op transitions', async () => {
+        await presenter.onFilterChange(LogFieldType.TRANSACTION_TYPE, [
+          TransactionsEntryType.NO_OP,
+        ]);
+        const fieldValues = assertDefined(uiData).entries.map((entry) =>
+          getFieldValue(entry, LogFieldType.TRANSACTION_TYPE),
+        );
+        expect(new Set(fieldValues)).toEqual(
+          new Set([TransactionsEntryType.NO_OP]),
+        );
+
+        for (const entry of assertDefined(uiData).entries) {
+          expect(
+            getFieldValue(entry, LogFieldType.LAYER_OR_DISPLAY_ID),
+          ).toEqual('');
+          expect(getFieldValue(entry, LogFieldType.FLAGS)).toEqual('');
+          expect(entry.propertiesTree).toEqual(undefined);
+        }
+      });
+
+      it('shows/hides defaults', async () => {
+        const userOptions: UserOptions = {
+          showDiff: {
+            name: 'Show diff',
+            enabled: true,
+          },
+          showDefaults: {
+            name: 'Show defaults',
+            enabled: true,
+          },
+        };
+
+        await presenter.onAppEvent(this.getPositionUpdate());
+        await presenter.onLogEntryClick(this.logEntryClickIndex);
+        expect(
+          assertDefined(uiData.propertiesTree).getAllChildren().length,
+        ).toEqual(6);
+
+        await presenter.onPropertiesUserOptionsChange(userOptions);
+        expect(uiData.propertiesUserOptions).toEqual(userOptions);
+        expect(
+          assertDefined(uiData.propertiesTree).getAllChildren().length,
+        ).toEqual(42);
+      });
+
+      function getFieldValue(entry: LogEntry, logFieldName: LogFieldType) {
+        return entry.fields.find((f) => f.type === logFieldName)?.value;
+      }
+    });
+  }
 
-  beforeAll(async () => {
-    jasmine.addCustomEqualityTester(TreeNodeUtils.treeNodeEqualityTester);
-    parser = (await UnitTestUtils.getParser(
+  override async setUpTestEnvironment(): Promise<void> {
+    const parser = (await UnitTestUtils.getParser(
       'traces/elapsed_and_real_timestamp/Transactions.pb',
     )) as Parser<PropertyTreeNode>;
-  });
-
-  beforeEach(async () => {
-    outputUiData = undefined;
-    await setUpTestEnvironment();
-  });
-
-  it('is robust to empty trace', async () => {
-    const trace = new TraceBuilder<PropertyTreeNode>().setEntries([]).build();
-    presenter = new Presenter(trace, new InMemoryStorage(), (data: UiData) => {
-      outputUiData = data;
-    });
-
-    expect(outputUiData).toEqual(UiData.EMPTY);
-
-    const expectedUiData = UiData.EMPTY;
-    expectedUiData.propertiesUserOptions = {
-      showDefaults: {
-        name: 'Show defaults',
-        enabled: false,
-        tooltip: `
-                If checked, shows the value of all properties.
-                Otherwise, hides all properties whose value is
-                the default for its data type.
-              `,
-      },
-    };
-    await presenter.onAppEvent(
-      TracePositionUpdate.fromTimestamp(
-        TimestampConverterUtils.makeRealTimestamp(10n),
-      ),
-    );
-    expect(outputUiData).toEqual(UiData.EMPTY);
-  });
-
-  it('processes trace position update and computes output UI data', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(0));
-    checkInitialTracePositionUpdate();
-
-    expect(assertDefined(outputUiData).allPids).toEqual([
-      'N/A',
-      '0',
-      '515',
-      '1593',
-      '2022',
-      '2322',
-      '2463',
-      '3300',
-    ]);
-    expect(assertDefined(outputUiData).allUids).toEqual([
-      'N/A',
-      '1000',
-      '1003',
-      '10169',
-      '10235',
-      '10239',
-    ]);
-    expect(assertDefined(outputUiData).allTypes).toEqual([
-      'DISPLAY_CHANGED',
-      'LAYER_ADDED',
-      'LAYER_CHANGED',
-      'LAYER_DESTROYED',
-      'LAYER_HANDLE_DESTROYED',
-      'NO_OP',
-    ]);
-
-    expect(assertDefined(outputUiData).allTransactionIds.length).toEqual(1295);
-    expect(assertDefined(outputUiData).allLayerAndDisplayIds.length).toEqual(
-      117,
-    );
-    expect(assertDefined(outputUiData).entries.length).toEqual(
-      TOTAL_OUTPUT_ENTRIES,
-    );
-  });
-
-  it('processes trace position update and updates current entry and scroll position', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(0));
-    checkInitialTracePositionUpdate();
-
-    await presenter.onAppEvent(createTracePositionUpdate(10));
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(13);
-    expect(assertDefined(outputUiData).scrollToIndex).toEqual(13);
-  });
-
-  it('filters entries according to transaction ID filter', () => {
-    presenter.onTransactionIdFilterChanged([]);
-    expect(assertDefined(outputUiData).entries.length).toEqual(
-      TOTAL_OUTPUT_ENTRIES,
-    );
-
-    presenter.onTransactionIdFilterChanged(['2211908157465']);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map((entry) => entry.transactionId),
-      ),
-    ).toEqual(new Set(['2211908157465']));
-  });
-
-  it('filters entries according to VSYNC ID filter', () => {
-    presenter.onVSyncIdFilterChanged([]);
-    expect(assertDefined(outputUiData).entries.length).toEqual(
-      TOTAL_OUTPUT_ENTRIES,
-    );
-
-    presenter.onVSyncIdFilterChanged(['1']);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map((entry) => entry.vsyncId),
-      ),
-    ).toEqual(new Set([1]));
-
-    presenter.onVSyncIdFilterChanged(['1', '3', '10']);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map((entry) => entry.vsyncId),
-      ),
-    ).toEqual(new Set([1, 3, 10]));
-  });
-
-  it('filters entries according to PID filter', () => {
-    presenter.onPidFilterChanged([]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.pid)),
-    ).toEqual(
-      new Set(['N/A', '0', '515', '1593', '2022', '2322', '2463', '3300']),
-    );
-
-    presenter.onPidFilterChanged(['0']);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.pid)),
-    ).toEqual(new Set(['0']));
-
-    presenter.onPidFilterChanged(['0', '515']);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.pid)),
-    ).toEqual(new Set(['0', '515']));
-  });
-
-  it('filters entries according to UID filter', () => {
-    presenter.onUidFilterChanged([]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.uid)),
-    ).toEqual(new Set(['N/A', '1000', '1003', '10169', '10235', '10239']));
-
-    presenter.onUidFilterChanged(['1000']);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.uid)),
-    ).toEqual(new Set(['1000']));
-
-    presenter.onUidFilterChanged(['1000', '1003']);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.uid)),
-    ).toEqual(new Set(['1000', '1003']));
-  });
-
-  it('filters entries according to type filter', () => {
-    presenter.onTypeFilterChanged([]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.type)),
-    ).toEqual(
-      new Set([
-        UiDataEntryType.DISPLAY_CHANGED,
-        UiDataEntryType.LAYER_ADDED,
-        UiDataEntryType.LAYER_CHANGED,
-        UiDataEntryType.LAYER_DESTROYED,
-        UiDataEntryType.LAYER_HANDLE_DESTROYED,
-        UiDataEntryType.NO_OP,
-      ]),
+    this.trace = new TraceBuilder<PropertyTreeNode>().setParser(parser).build();
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
     );
-
-    presenter.onTypeFilterChanged([UiDataEntryType.LAYER_ADDED]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.type)),
-    ).toEqual(new Set([UiDataEntryType.LAYER_ADDED]));
-
-    presenter.onTypeFilterChanged([
-      UiDataEntryType.LAYER_ADDED,
-      UiDataEntryType.LAYER_DESTROYED,
-    ]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.type)),
-    ).toEqual(
-      new Set([UiDataEntryType.LAYER_ADDED, UiDataEntryType.LAYER_DESTROYED]),
-    );
-  });
-
-  it('filters entries according to layer or display ID filter', () => {
-    presenter.onLayerIdFilterChanged([]);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map(
-          (entry) => entry.layerOrDisplayId,
-        ),
-      ).size,
-    ).toBeGreaterThan(20);
-
-    presenter.onLayerIdFilterChanged(['1']);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map(
-          (entry) => entry.layerOrDisplayId,
-        ),
-      ),
-    ).toEqual(new Set(['1']));
-
-    presenter.onLayerIdFilterChanged(['1', '3']);
-    expect(
-      new Set(
-        assertDefined(outputUiData).entries.map(
-          (entry) => entry.layerOrDisplayId,
-        ),
-      ),
-    ).toEqual(new Set(['1', '3']));
-  });
-
-  it('includes no op transitions', () => {
-    presenter.onTypeFilterChanged([UiDataEntryType.NO_OP]);
-    expect(
-      new Set(assertDefined(outputUiData).entries.map((entry) => entry.type)),
-    ).toEqual(new Set([UiDataEntryType.NO_OP]));
-
-    for (const entry of assertDefined(outputUiData).entries) {
-      expect(entry.layerOrDisplayId).toEqual('');
-      expect(entry.what).toEqual('');
-      expect(entry.propertiesTree).toEqual(undefined);
-    }
-  });
-
-  it('filters entries according to "what" search string', () => {
-    expect(assertDefined(outputUiData).entries.length).toEqual(
-      TOTAL_OUTPUT_ENTRIES,
+    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(10),
     );
+  }
 
-    presenter.onWhatFilterChanged([]);
-    expect(assertDefined(outputUiData).entries.length).toEqual(
-      TOTAL_OUTPUT_ENTRIES,
-    );
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const emptyTrace = new TraceBuilder<PropertyTreeNode>()
+      .setType(TraceType.TRANSACTIONS)
+      .setEntries([])
+      .build();
+    return new Presenter(emptyTrace, new InMemoryStorage(), callback);
+  }
 
-    presenter.onWhatFilterChanged(['Crop']);
-    expect(assertDefined(outputUiData).entries.length).toBeLessThan(
-      TOTAL_OUTPUT_ENTRIES,
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const presenter = new Presenter(
+      assertDefined(this.trace),
+      new InMemoryStorage(),
+      callback,
     );
-
-    presenter.onWhatFilterChanged(['STRING_WITH_NO_MATCHES']);
-    expect(assertDefined(outputUiData).entries.length).toEqual(0);
-  });
-
-  it('updates selected entry ui data when entry clicked', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(0));
-    checkInitialTracePositionUpdate();
-
-    const newIndex = 10;
-    presenter.onEntryClicked(newIndex);
-    checkSelectedEntryUiData(newIndex);
-    expect(assertDefined(outputUiData).scrollToIndex).toEqual(undefined); // no scrolling
-
-    // does not remove selection when entry clicked again
-    presenter.onEntryClicked(newIndex);
-    checkSelectedEntryUiData(newIndex);
-    expect(assertDefined(outputUiData).scrollToIndex).toEqual(undefined);
-  });
-
-  it('updates selected entry ui data when entry changed by key press', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(0));
-    checkInitialTracePositionUpdate();
-
-    const newIndex = 10;
-    presenter.onEntryChangedByKeyPress(newIndex);
-    checkSelectedEntryUiData(newIndex);
-    expect(assertDefined(outputUiData).scrollToIndex).toEqual(newIndex);
-  });
-
-  it('computes current entry index', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(0));
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(0);
-
-    await presenter.onAppEvent(createTracePositionUpdate(10));
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(13);
-  });
-
-  it('updates current entry index when filters change', async () => {
-    await presenter.onAppEvent(createTracePositionUpdate(10));
-
-    presenter.onPidFilterChanged([]);
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(13);
-
-    presenter.onPidFilterChanged(['0']);
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(10);
-
-    presenter.onPidFilterChanged(['0', '515']);
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(11);
-
-    presenter.onPidFilterChanged(['0', '515', 'N/A']);
-    expect(assertDefined(outputUiData).currentEntryIndex).toEqual(13);
-  });
-
-  it('formats entry time', async () => {
-    await setUpTestEnvironment();
-    expect(
-      assertDefined(outputUiData).entries[0].time.formattedValue(),
-    ).toEqual('2022-08-03, 06:19:01.051');
-  });
-
-  async function setUpTestEnvironment() {
-    trace = new TraceBuilder<PropertyTreeNode>().setParser(parser).build();
-    presenter = new Presenter(trace, new InMemoryStorage(), (data: UiData) => {
-      outputUiData = data;
-    });
-    await presenter.onAppEvent(createTracePositionUpdate(0)); // trigger initialization
+    await presenter.onAppEvent(this.getPositionUpdate()); // trigger initialization
+    return presenter;
   }
 
-  function createTracePositionUpdate(entryIndex: number): TracePositionUpdate {
-    const entry = trace.getEntry(entryIndex);
-    return TracePositionUpdate.fromTraceEntry(entry);
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
   }
 
-  function checkInitialTracePositionUpdate() {
-    const uiData = assertDefined(outputUiData);
-    expect(uiData.currentEntryIndex).toEqual(0);
-    expect(uiData.selectedEntryIndex).toBeUndefined();
-    expect(uiData.scrollToIndex).toEqual(0);
-    expect(assertDefined(uiData.currentPropertiesTree).id).toEqual(
-      assertDefined(uiData.entries[0].propertiesTree).id,
-    );
+  override getSecondPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.secondPositionUpdate);
   }
+}
 
-  function checkSelectedEntryUiData(index: number) {
-    const uiData = assertDefined(outputUiData);
-    expect(uiData.currentEntryIndex).toEqual(0);
-    expect(uiData.selectedEntryIndex).toEqual(index);
-    expect(assertDefined(uiData.currentPropertiesTree).id).toEqual(
-      assertDefined(uiData.entries[index].propertiesTree).id,
-    );
-  }
+describe('PresenterTransactions', () => {
+  new PresenterTransactionsTest().execute();
 });
diff --git a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive.ts b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive.ts
index 793f83f8e..8625b030f 100644
--- a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_directive.ts
@@ -17,7 +17,7 @@
 import {VIRTUAL_SCROLL_STRATEGY} from '@angular/cdk/scrolling';
 import {Directive, forwardRef} from '@angular/core';
 import {VariableHeightScrollDirective} from 'viewers/common/variable_height_scroll_directive';
-import {UiDataEntry} from 'viewers/viewer_transactions/ui_data';
+import {TransactionsEntry} from 'viewers/viewer_transactions/ui_data';
 import {TransactionsScrollStrategy} from './transactions_scroll_strategy';
 
 @Directive({
@@ -30,6 +30,6 @@ import {TransactionsScrollStrategy} from './transactions_scroll_strategy';
     },
   ],
 })
-export class TransactionsScrollDirective extends VariableHeightScrollDirective<UiDataEntry> {
+export class TransactionsScrollDirective extends VariableHeightScrollDirective<TransactionsEntry> {
   scrollStrategy = new TransactionsScrollStrategy();
 }
diff --git a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
index 477c36eb8..98b466492 100644
--- a/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/scroll_strategy/transactions_scroll_strategy.ts
@@ -14,20 +14,26 @@
  * limitations under the License.
  */
 
+import {assertDefined} from 'common/assert_utils';
+import {LogFieldType} from 'viewers/common/ui_data_log';
 import {VariableHeightScrollStrategy} from 'viewers/common/variable_height_scroll_strategy';
-import {UiDataEntry} from 'viewers/viewer_transactions/ui_data';
+import {TransactionsEntry} from 'viewers/viewer_transactions/ui_data';
 
 export class TransactionsScrollStrategy extends VariableHeightScrollStrategy {
   protected readonly defaultRowSize = 24;
-  private readonly whatCharsPerRow = 40;
+  private readonly flagCharsPerRow = 40;
   private readonly timestampCharsPerRow = 20;
 
-  protected override predictScrollItemHeight(entry: UiDataEntry): number {
-    const whatHeight = this.subItemHeight(entry.what, this.whatCharsPerRow);
+  protected override predictScrollItemHeight(entry: TransactionsEntry): number {
+    const flagsHeight = this.subItemHeight(
+      assertDefined(entry.fields.find((f) => f.type === LogFieldType.FLAGS))
+        .value as string,
+      this.flagCharsPerRow,
+    );
     const timestampHeight = this.subItemHeight(
-      entry.time.formattedValue(),
+      entry.traceEntry.getTimestamp().format(),
       this.timestampCharsPerRow,
     );
-    return Math.max(whatHeight, timestampHeight);
+    return Math.max(flagsHeight, timestampHeight);
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_transactions/ui_data.ts b/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
index c5ae70181..b29490137 100644
--- a/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/ui_data.ts
@@ -14,69 +14,48 @@
  * limitations under the License.
  */
 
-import {AbsoluteEntryIndex} from 'trace/index_types';
+import {TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  LogEntry,
+  LogField,
+  LogFilter,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
 
-class UiData {
+export class UiData implements UiDataLog {
   constructor(
-    public allVSyncIds: string[],
-    public allPids: string[],
-    public allUids: string[],
-    public allTypes: string[],
-    public allLayerAndDisplayIds: string[],
-    public allTransactionIds: string[],
-    public allFlags: string[],
-    public entries: UiDataEntry[],
-    public currentEntryIndex: undefined | number,
-    public selectedEntryIndex: undefined | number,
+    public filters: LogFilter[],
+    public entries: LogEntry[],
+    public currentIndex: undefined | number,
+    public selectedIndex: undefined | number,
     public scrollToIndex: undefined | number,
-    public currentPropertiesTree: undefined | UiPropertyTreeNode,
+    public propertiesTree: undefined | UiPropertyTreeNode,
     public propertiesUserOptions: UserOptions,
   ) {}
 
-  static EMPTY = new UiData(
-    [],
-    [],
-    [],
-    [],
-    [],
-    [],
-    [],
-    [],
-    undefined,
-    undefined,
-    undefined,
-    undefined,
-    {},
-  );
+  static createEmpty(): UiData {
+    return new UiData([], [], undefined, undefined, undefined, undefined, {});
+  }
 }
 
-class UiDataEntry {
+export class TransactionsEntry implements LogEntry {
   constructor(
-    public traceIndex: AbsoluteEntryIndex,
-    public time: PropertyTreeNode,
-    public vsyncId: number,
-    public pid: string,
-    public uid: string,
-    public type: string,
-    public layerOrDisplayId: string,
-    public transactionId: string,
-    public what: string,
+    public traceEntry: TraceEntry<PropertyTreeNode>,
+    public fields: LogField[],
     public propertiesTree: PropertyTreeNode | undefined,
   ) {}
 }
 
-class UiDataEntryType {
-  static DISPLAY_ADDED = 'DISPLAY_ADDED';
-  static DISPLAY_REMOVED = 'DISPLAY_REMOVED';
-  static DISPLAY_CHANGED = 'DISPLAY_CHANGED';
-  static LAYER_ADDED = 'LAYER_ADDED';
-  static LAYER_DESTROYED = 'LAYER_DESTROYED';
-  static LAYER_CHANGED = 'LAYER_CHANGED';
-  static LAYER_HANDLE_DESTROYED = 'LAYER_HANDLE_DESTROYED';
-  static NO_OP = 'NO_OP';
+export enum TransactionsEntryType {
+  DISPLAY_ADDED = 'DISPLAY_ADDED',
+  DISPLAY_REMOVED = 'DISPLAY_REMOVED',
+  DISPLAY_CHANGED = 'DISPLAY_CHANGED',
+  LAYER_ADDED = 'LAYER_ADDED',
+  LAYER_DESTROYED = 'LAYER_DESTROYED',
+  LAYER_CHANGED = 'LAYER_CHANGED',
+  LAYER_HANDLE_DESTROYED = 'LAYER_HANDLE_DESTROYED',
+  NO_OP = 'NO_OP',
 }
-
-export {UiData, UiDataEntry, UiDataEntryType};
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
index 222e018c5..a7a90484a 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions.ts
@@ -14,14 +14,14 @@
  * limitations under the License.
  */
 
-import {assertDefined} from 'common/assert_utils';
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
@@ -34,99 +34,20 @@ class ViewerTransactions implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(
-    trace: Trace<PropertyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<PropertyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-transactions');
-
-    this.presenter = new Presenter(trace, storage, (data: UiData) => {
+    const notifyViewCallback = (data: UiData) => {
       (this.htmlElement as any).inputData = data;
-    });
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.VSyncIdFilterChanged,
-      (event) => {
-        this.presenter.onVSyncIdFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.PidFilterChanged,
-      (event) => {
-        this.presenter.onPidFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.UidFilterChanged,
-      (event) => {
-        this.presenter.onUidFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.TypeFilterChanged,
-      (event) => {
-        this.presenter.onTypeFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.LayerIdFilterChanged,
-      (event) => {
-        this.presenter.onLayerIdFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.WhatFilterChanged,
-      (event) => {
-        this.presenter.onWhatFilterChanged((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.TransactionIdFilterChanged,
-      (event) => {
-        this.presenter.onTransactionIdFilterChanged(
-          (event as CustomEvent).detail,
-        );
-      },
-    );
-
-    this.htmlElement.addEventListener(ViewerEvents.LogClicked, (event) => {
-      this.presenter.onEntryClicked((event as CustomEvent).detail);
-    });
-    this.htmlElement.addEventListener(
-      ViewerEvents.LogChangedByKeyPress,
-      (event) => {
-        this.presenter.onEntryChangedByKeyPress((event as CustomEvent).detail);
-      },
-    );
-    this.htmlElement.addEventListener(
-      ViewerEvents.TimestampClick,
-      async (event) => {
-        const detail: TimestampClickDetail = (event as CustomEvent).detail;
-        await this.presenter.onLogTimestampClicked(assertDefined(detail.index));
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.PropertiesUserOptionsChange,
-      (event) =>
-        this.presenter.onPropertiesUserOptionsChange(
-          (event as CustomEvent).detail.userOptions,
-        ),
-    );
+    };
+    this.presenter = new Presenter(trace, storage, notifyViewCallback);
+    this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
       ViewType.TAB,
       this.getTraces(),
       this.htmlElement,
-      'Transactions',
+      TRACE_INFO[TraceType.TRANSACTIONS].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
index 832ab572e..76f11b0f5 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component.ts
@@ -13,25 +13,13 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-import {CdkVirtualScrollViewport} from '@angular/cdk/scrolling';
-import {
-  Component,
-  ElementRef,
-  HostListener,
-  Inject,
-  Input,
-  ViewChild,
-} from '@angular/core';
-import {MatSelectChange} from '@angular/material/select';
+import {Component, Input, ViewChild} from '@angular/core';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
-import {timeButtonStyle} from 'viewers/components/styles/clickable_property.styles';
-import {currentElementStyle} from 'viewers/components/styles/current_element.styles';
-import {selectedElementStyle} from 'viewers/components/styles/selected_element.styles';
+import {LogComponent} from 'viewers/common/log_component';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
-import {UiData, UiDataEntry} from './ui_data';
+import {UiData} from './ui_data';
 
 @Component({
   selector: 'viewer-transactions',
@@ -42,129 +30,24 @@ import {UiData, UiDataEntry} from './ui_data';
         [sections]="sections"
         (sectionChange)="sections.onCollapseStateChange($event, false)">
       </collapsed-sections>
-      <div class="log-view entries">
-        <div class="filters">
-          <div class="time"></div>
-          <div class="id transaction-id">
-            <select-with-filter
-              label="TX ID"
-              [options]="uiData.allTransactionIds"
-              outerFilterWidth="125"
-              innerFilterWidth="125"
-              (selectChange)="onTransactionIdFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="vsyncid">
-            <select-with-filter
-              label="VSYNC ID"
-              [options]="uiData.allVSyncIds"
-              outerFilterWidth="110"
-              innerFilterWidth="90"
-              (selectChange)="onVSyncIdFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="pid">
-            <select-with-filter
-              label="PID"
-              [options]="uiData.allPids"
-              (selectChange)="onPidFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="uid">
-            <select-with-filter
-              label="UID"
-              [options]="uiData.allUids"
-              (selectChange)="onUidFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="type">
-            <select-with-filter
-              label="Type"
-              innerFilterWidth="175"
-              [options]="uiData.allTypes"
-              (selectChange)="onTypeFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="id layer-or-display-id">
-            <select-with-filter
-              label="LAYER/DISP ID"
-              outerFilterWidth="125"
-              innerFilterWidth="100"
-              [options]="uiData.allLayerAndDisplayIds"
-              (selectChange)="onLayerIdFilterChanged($event)">
-            </select-with-filter>
-          </div>
-          <div class="what">
-            <select-with-filter
-              label="Search text"
-              outerFilterWidth="250"
-              innerFilterWidth="250"
-              [options]="uiData.allFlags"
-              flex="2 0 250px"
-              (selectChange)="onWhatFilterChanged($event)">
-            </select-with-filter>
-          </div>
 
-          <button
-            color="primary"
-            mat-stroked-button
-            class="go-to-current-time"
-            (click)="onGoToCurrentTimeClick()">
-            Go to Current Time
-          </button>
-        </div>
-
-        <cdk-virtual-scroll-viewport
-          transactionsVirtualScroll
-          class="scroll"
-          [scrollItems]="uiData.entries">
-          <div
-            *cdkVirtualFor="let entry of uiData.entries; let i = index"
-            class="entry"
-            [attr.item-id]="i"
-            [class.current]="isCurrentEntry(i)"
-            [class.selected]="isSelectedEntry(i)"
-            (click)="onEntryClicked(i)">
-            <div class="time">
-              <button
-                mat-button
-                color="primary"
-                (click)="onTimestampClicked(entry)">
-                {{ entry.time.formattedValue() }}
-              </button>
-            </div>
-            <div class="id transaction-id">
-              <span class="mat-body-1">{{ entry.transactionId }}</span>
-            </div>
-            <div class="vsyncid">
-              <span class="mat-body-1">{{ entry.vsyncId }}</span>
-            </div>
-            <div class="pid">
-              <span class="mat-body-1">{{ entry.pid }}</span>
-            </div>
-            <div class="uid">
-              <span class="mat-body-1">{{ entry.uid }}</span>
-            </div>
-            <div class="type">
-              <span class="mat-body-1">{{ entry.type }}</span>
-            </div>
-            <div class="id layer-or-display-id">
-              <span class="mat-body-1">{{ entry.layerOrDisplayId }}</span>
-            </div>
-            <div class="what">
-              <span class="mat-body-1">{{ entry.what }}</span>
-            </div>
-          </div>
-        </cdk-virtual-scroll-viewport>
-      </div>
+      <log-view
+        class="log-view"
+        [selectedIndex]="inputData?.selectedIndex"
+        [scrollToIndex]="inputData?.scrollToIndex"
+        [currentIndex]="inputData?.currentIndex"
+        [entries]="inputData?.entries"
+        [filters]="inputData?.filters"
+        [traceType]="${TraceType.TRANSACTIONS}">
+      </log-view>
 
       <properties-view
-        *ngIf="uiData.currentPropertiesTree"
+        *ngIf="inputData?.propertiesTree"
         class="properties-view"
         [title]="propertiesTitle"
         [showFilter]="false"
-        [userOptions]="uiData.propertiesUserOptions"
-        [propertiesTree]="uiData.currentPropertiesTree"
+        [userOptions]="inputData?.propertiesUserOptions"
+        [propertiesTree]="inputData?.propertiesTree"
         [traceType]="${TraceType.TRANSACTIONS}"
         [isProtoDump]="false"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"
@@ -176,83 +59,19 @@ import {UiData, UiDataEntry} from './ui_data';
       .properties-view {
         flex: 1;
       }
-
-      .entries .filters {
-        display: flex;
-        flex-direction: row;
-      }
-
-      .entries .scroll {
-        flex: 1;
-        height: 100%;
-      }
-
-      .scroll .entry {
-        display: flex;
-        flex-direction: row;
-      }
-
-      .filters div,
-      .entries div {
-        padding: 4px;
-      }
-
-      .time {
-        flex: 0 1 250px;
-      }
-
-      .id {
-        flex: none;
-        width: 125px;
-      }
-
-      .vsyncid {
-        flex: none;
-        width: 110px;
-      }
-
-      .pid {
-        flex: none;
-        width: 75px;
-      }
-
-      .uid {
-        flex: none;
-        width: 75px;
-      }
-
-      .type {
-        width: 200px;
-      }
-
-      .what {
-        flex: 2 0 250px;
-      }
-
-      .filters .what {
-        margin-right: 16px;
-      }
-
-      .go-to-current-time {
-        flex: none;
-        margin-top: 4px;
-        font-size: 12px;
-        height: 65%;
-        width: fit-content;
-      }
     `,
-    selectedElementStyle,
-    currentElementStyle,
-    timeButtonStyle,
     viewerCardStyle,
   ],
 })
-class ViewerTransactionsComponent {
-  objectKeys = Object.keys;
-  uiData: UiData = UiData.EMPTY;
-  private lastClicked = '';
-  propertiesTitle = 'PROPERTIES - PROTO DUMP';
+export class ViewerTransactionsComponent {
+  @Input() inputData: UiData | undefined;
+
+  @ViewChild(LogComponent)
+  logComponent?: LogComponent;
+
   CollapsibleSectionType = CollapsibleSectionType;
+
+  propertiesTitle = 'PROPERTIES - PROTO DUMP';
   sections = new CollapsibleSections([
     {
       type: CollapsibleSectionType.PROPERTIES,
@@ -260,103 +79,4 @@ class ViewerTransactionsComponent {
       isCollapsed: false,
     },
   ]);
-
-  @ViewChild(CdkVirtualScrollViewport)
-  scrollComponent?: CdkVirtualScrollViewport;
-
-  constructor(@Inject(ElementRef) private elementRef: ElementRef) {}
-
-  @Input()
-  set inputData(data: UiData) {
-    this.uiData = data;
-    if (
-      this.uiData.scrollToIndex !== undefined &&
-      this.scrollComponent &&
-      this.lastClicked !==
-        this.uiData.entries[this.uiData.scrollToIndex].time.formattedValue()
-    ) {
-      this.scrollComponent.scrollToIndex(this.uiData.scrollToIndex);
-    }
-  }
-
-  onVSyncIdFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.VSyncIdFilterChanged, event.value);
-  }
-
-  onPidFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.PidFilterChanged, event.value);
-  }
-
-  onUidFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.UidFilterChanged, event.value);
-  }
-
-  onTypeFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.TypeFilterChanged, event.value);
-  }
-
-  onLayerIdFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.LayerIdFilterChanged, event.value);
-  }
-
-  onWhatFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.WhatFilterChanged, event.value);
-  }
-
-  onTransactionIdFilterChanged(event: MatSelectChange) {
-    this.emitEvent(ViewerEvents.TransactionIdFilterChanged, event.value);
-  }
-
-  onEntryClicked(index: number) {
-    this.emitEvent(ViewerEvents.LogClicked, index);
-  }
-
-  onGoToCurrentTimeClick() {
-    if (this.uiData.currentEntryIndex !== undefined && this.scrollComponent) {
-      this.scrollComponent.scrollToIndex(this.uiData.currentEntryIndex);
-    }
-  }
-
-  onTimestampClicked(entry: UiDataEntry) {
-    this.emitEvent(
-      ViewerEvents.TimestampClick,
-      new TimestampClickDetail(entry.time.getValue(), entry.traceIndex),
-    );
-  }
-
-  @HostListener('document:keydown', ['$event'])
-  async handleKeyboardEvent(event: KeyboardEvent) {
-    const index =
-      this.uiData.selectedEntryIndex ?? this.uiData.currentEntryIndex;
-    if (index === undefined) {
-      return;
-    }
-    if (event.key === 'ArrowDown' && index < this.uiData.entries.length - 1) {
-      event.preventDefault();
-      this.emitEvent(ViewerEvents.LogChangedByKeyPress, index + 1);
-    }
-
-    if (event.key === 'ArrowUp' && index > 0) {
-      event.preventDefault();
-      this.emitEvent(ViewerEvents.LogChangedByKeyPress, index - 1);
-    }
-  }
-
-  isCurrentEntry(index: number): boolean {
-    return index === this.uiData.currentEntryIndex;
-  }
-
-  isSelectedEntry(index: number): boolean {
-    return index === this.uiData.selectedEntryIndex;
-  }
-
-  private emitEvent(event: string, data: any) {
-    const customEvent = new CustomEvent(event, {
-      bubbles: true,
-      detail: data,
-    });
-    this.elementRef.nativeElement.dispatchEvent(customEvent);
-  }
 }
-
-export {ViewerTransactionsComponent};
diff --git a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
index c22939f36..c3e787cc6 100644
--- a/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_transactions/viewer_transactions_component_test.ts
@@ -33,17 +33,19 @@ import {BrowserAnimationsModule} from '@angular/platform-browser/animations';
 import {assertDefined} from 'common/assert_utils';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
-import {TIMESTAMP_NODE_FORMATTER} from 'trace/tree_node/formatters';
-import {executeScrollComponentTests} from 'viewers/common/scroll_component_test_utils';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {LogComponent} from 'viewers/common/log_component';
+import {executeScrollComponentTests} from 'viewers/common/scroll_component_tests';
+import {LogFieldType} from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
-import {ViewerEvents} from 'viewers/common/viewer_events';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
 import {SelectWithFilterComponent} from 'viewers/components/select_with_filter_component';
 import {TransactionsScrollDirective} from './scroll_strategy/transactions_scroll_directive';
-import {UiData, UiDataEntry} from './ui_data';
+import {TransactionsEntry, UiData} from './ui_data';
 import {ViewerTransactionsComponent} from './viewer_transactions_component';
 
 describe('ViewerTransactionsComponent', () => {
@@ -71,6 +73,7 @@ describe('ViewerTransactionsComponent', () => {
           CollapsedSectionsComponent,
           CollapsibleSectionTitleComponent,
           PropertiesComponent,
+          LogComponent,
         ],
         schemas: [CUSTOM_ELEMENTS_SCHEMA],
       }).compileComponents();
@@ -87,11 +90,19 @@ describe('ViewerTransactionsComponent', () => {
       expect(component).toBeTruthy();
     });
 
+    it('renders log component', () => {
+      expect(htmlElement.querySelector('.log-view')).toBeTruthy();
+    });
+
     it('renders filters', () => {
-      expect(htmlElement.querySelector('.entries .filters .pid')).toBeTruthy();
-      expect(htmlElement.querySelector('.entries .filters .uid')).toBeTruthy();
-      expect(htmlElement.querySelector('.entries .filters .type')).toBeTruthy();
-      expect(htmlElement.querySelector('.entries .filters .id')).toBeTruthy();
+      expect(htmlElement.querySelector('.filters .pid')).toBeTruthy();
+      expect(htmlElement.querySelector('.filters .uid')).toBeTruthy();
+      expect(
+        htmlElement.querySelector('.filters .transaction-type'),
+      ).toBeTruthy();
+      expect(
+        htmlElement.querySelector('.filters .transaction-id'),
+      ).toBeTruthy();
     });
 
     it('renders entries', () => {
@@ -111,170 +122,6 @@ describe('ViewerTransactionsComponent', () => {
       expect(htmlElement.querySelector('.properties-view')).toBeTruthy();
     });
 
-    it('applies transaction id filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(
-        ViewerEvents.TransactionIdFilterChanged,
-        (event) => {
-          if ((event as CustomEvent).detail.length === 0) {
-            component.uiData.entries = allEntries;
-            return;
-          }
-          component.uiData.entries = allEntries.filter((entry) =>
-            (event as CustomEvent).detail.includes(entry.transactionId),
-          );
-        },
-      );
-      await checkSelectFilter('.transaction-id');
-    });
-
-    it('applies vsync id filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(
-        ViewerEvents.VSyncIdFilterChanged,
-        (event) => {
-          if ((event as CustomEvent).detail.length === 0) {
-            component.uiData.entries = allEntries;
-            return;
-          }
-          component.uiData.entries = allEntries.filter((entry) => {
-            return (event as CustomEvent).detail.includes(`${entry.vsyncId}`);
-          });
-        },
-      );
-      await checkSelectFilter('.vsyncid');
-    });
-
-    it('applies pid filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(ViewerEvents.PidFilterChanged, (event) => {
-        if ((event as CustomEvent).detail.length === 0) {
-          component.uiData.entries = allEntries;
-          return;
-        }
-        component.uiData.entries = allEntries.filter((entry) => {
-          return (event as CustomEvent).detail.includes(entry.pid);
-        });
-      });
-      await checkSelectFilter('.pid');
-    });
-
-    it('applies uid filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(ViewerEvents.UidFilterChanged, (event) => {
-        if ((event as CustomEvent).detail.length === 0) {
-          component.uiData.entries = allEntries;
-          return;
-        }
-        component.uiData.entries = allEntries.filter((entry) => {
-          return (event as CustomEvent).detail.includes(entry.uid);
-        });
-      });
-      await checkSelectFilter('.uid');
-    });
-
-    it('applies type filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(ViewerEvents.TypeFilterChanged, (event) => {
-        if ((event as CustomEvent).detail.length === 0) {
-          component.uiData.entries = allEntries;
-          return;
-        }
-        component.uiData.entries = allEntries.filter((entry) => {
-          return (event as CustomEvent).detail.includes(entry.type);
-        });
-      });
-      await checkSelectFilter('.type');
-    });
-
-    it('applies layer/display id filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(
-        ViewerEvents.LayerIdFilterChanged,
-        (event) => {
-          if ((event as CustomEvent).detail.length === 0) {
-            component.uiData.entries = allEntries;
-            return;
-          }
-          component.uiData.entries = allEntries.filter((entry) => {
-            return (event as CustomEvent).detail.includes(
-              entry.layerOrDisplayId,
-            );
-          });
-        },
-      );
-      await checkSelectFilter('.layer-or-display-id');
-    });
-
-    it('applies what filter correctly', async () => {
-      const allEntries = makeUiData(0).entries;
-      htmlElement.addEventListener(ViewerEvents.WhatFilterChanged, (event) => {
-        if ((event as CustomEvent).detail.length === 0) {
-          component.uiData.entries = allEntries;
-          return;
-        }
-        component.uiData.entries = allEntries.filter((entry) => {
-          return (event as CustomEvent).detail.some((allowed: string) => {
-            return entry.what.includes(allowed);
-          });
-        });
-      });
-      await checkSelectFilter('.what');
-    });
-
-    it('scrolls to current entry on button click', () => {
-      const goToCurrentTimeButton = assertDefined(
-        htmlElement.querySelector('.go-to-current-time'),
-      ) as HTMLButtonElement;
-      const spy = spyOn(
-        assertDefined(component.scrollComponent),
-        'scrollToIndex',
-      );
-      goToCurrentTimeButton.click();
-      expect(spy).toHaveBeenCalledWith(1);
-    });
-
-    it('changes selected entry on arrow key press', () => {
-      htmlElement.addEventListener(
-        ViewerEvents.LogChangedByKeyPress,
-        (event) => {
-          component.inputData = makeUiData((event as CustomEvent).detail);
-          fixture.detectChanges();
-        },
-      );
-
-      // does not do anything if no prev entry available
-      component.handleKeyboardEvent(
-        new KeyboardEvent('keydown', {key: 'ArrowUp'}),
-      );
-      expect(component.uiData.selectedEntryIndex).toEqual(0);
-
-      component.handleKeyboardEvent(
-        new KeyboardEvent('keydown', {key: 'ArrowDown'}),
-      );
-      expect(component.uiData.selectedEntryIndex).toEqual(1);
-
-      component.handleKeyboardEvent(
-        new KeyboardEvent('keydown', {key: 'ArrowUp'}),
-      );
-      expect(component.uiData.selectedEntryIndex).toEqual(0);
-    });
-
-    it('propagates timestamp on click', () => {
-      component.inputData = makeUiData(0);
-      fixture.detectChanges();
-      let index: number | undefined;
-      htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
-        index = (event as CustomEvent).detail.index;
-      });
-      const logTimestampButton = assertDefined(
-        htmlElement.querySelector('.time button'),
-      ) as HTMLButtonElement;
-      logTimestampButton.click();
-
-      expect(index).toEqual(0);
-    });
-
     it('creates collapsed sections with no buttons', () => {
       UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
     });
@@ -295,48 +142,73 @@ describe('ViewerTransactionsComponent', () => {
         .setValue(null)
         .build();
 
-      const time = new PropertyTreeBuilder()
-        .setRootId(propertiesTree.id)
-        .setName('timestamp')
-        .setValue(TimestampConverterUtils.makeElapsedTimestamp(1n))
-        .setFormatter(TIMESTAMP_NODE_FORMATTER)
+      const ts = TimestampConverterUtils.makeElapsedTimestamp(1n);
+
+      const trace = new TraceBuilder<PropertyTreeNode>()
+        .setEntries([propertiesTree, propertiesTree])
+        .setTimestamps([ts, ts])
         .build();
 
-      const entry = new UiDataEntry(
-        0,
-        time,
-        -111,
-        'PID_VALUE',
-        'UID_VALUE',
-        'TYPE_VALUE',
-        'LAYER_OR_DISPLAY_ID_VALUE',
-        'TRANSACTION_ID_VALUE',
-        'flag1 | flag2',
+      const entry1 = new TransactionsEntry(
+        trace.getEntry(0),
+        [
+          {type: LogFieldType.VSYNC_ID, value: -111},
+          {type: LogFieldType.PID, value: 'PID_VALUE'},
+          {type: LogFieldType.UID, value: 'UID_VALUE'},
+          {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE'},
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: 'LAYER_OR_DISPLAY_ID_VALUE',
+          },
+          {type: LogFieldType.TRANSACTION_ID, value: 'TRANSACTION_ID_VALUE'},
+          {type: LogFieldType.FLAGS, value: 'flag1 | flag2'},
+        ],
         propertiesTree,
       );
 
-      const entry2 = new UiDataEntry(
-        1,
-        time,
-        -222,
-        'PID_VALUE_2',
-        'UID_VALUE_2',
-        'TYPE_VALUE_2',
-        'LAYER_OR_DISPLAY_ID_VALUE_2',
-        'TRANSACTION_ID_VALUE_2',
-        'flag3 | flag4',
+      const entry2 = new TransactionsEntry(
+        trace.getEntry(1),
+        [
+          {type: LogFieldType.VSYNC_ID, value: -222},
+          {type: LogFieldType.PID, value: 'PID_VALUE_2'},
+          {type: LogFieldType.UID, value: 'UID_VALUE_2'},
+          {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE_2'},
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            value: 'LAYER_OR_DISPLAY_ID_VALUE_2',
+          },
+          {type: LogFieldType.TRANSACTION_ID, value: 'TRANSACTION_ID_VALUE_2'},
+          {type: LogFieldType.FLAGS, value: 'flag3 | flag4'},
+        ],
         propertiesTree,
       );
 
       return new UiData(
-        ['-111', '-222'],
-        ['PID_VALUE', 'PID_VALUE_2'],
-        ['UID_VALUE', 'UID_VALUE_2'],
-        ['TYPE_VALUE', 'TYPE_VALUE_2'],
-        ['LAYER_OR_DISPLAY_ID_VALUE', 'LAYER_OR_DISPLAY_ID_VALUE_2'],
-        ['TRANSACTION_ID_VALUE', 'TRANSACTION_ID_VALUE_2'],
-        ['flag1', 'flag2', 'flag3', 'flag4'],
-        [entry, entry2],
+        [
+          {type: LogFieldType.VSYNC_ID, options: ['-111', '-222']},
+          {type: LogFieldType.PID, options: ['PID_VALUE', 'PID_VALUE_2']},
+          {type: LogFieldType.UID, options: ['UID_VALUE', 'UID_VALUE_2']},
+          {
+            type: LogFieldType.TRANSACTION_TYPE,
+            options: ['TYPE_VALUE', 'TYPE_VALUE_2'],
+          },
+          {
+            type: LogFieldType.LAYER_OR_DISPLAY_ID,
+            options: [
+              'LAYER_OR_DISPLAY_ID_VALUE',
+              'LAYER_OR_DISPLAY_ID_VALUE_2',
+            ],
+          },
+          {
+            type: LogFieldType.TRANSACTION_ID,
+            options: ['TRANSACTION_ID_VALUE', 'TRANSACTION_ID_VALUE_2'],
+          },
+          {
+            type: LogFieldType.FLAGS,
+            options: ['flag1', 'flag2', 'flag3', 'flag4'],
+          },
+        ],
+        [entry1, entry2],
         1,
         selectedEntryIndex,
         0,
@@ -344,34 +216,10 @@ describe('ViewerTransactionsComponent', () => {
         {},
       );
     }
-
-    async function checkSelectFilter(filterSelector: string) {
-      component.inputData = makeUiData(0);
-      fixture.detectChanges();
-      expect(component.uiData.entries.length).toEqual(2);
-      const filterTrigger = assertDefined(
-        htmlElement.querySelector(
-          `.filters ${filterSelector} .mat-select-trigger`,
-        ),
-      ) as HTMLInputElement;
-      filterTrigger.click();
-      await fixture.whenStable();
-
-      const firstOption = assertDefined(
-        document.querySelector('.mat-select-panel .mat-option'),
-      ) as HTMLElement;
-      firstOption.click();
-      fixture.detectChanges();
-      expect(component.uiData.entries.length).toEqual(1);
-
-      firstOption.click();
-      fixture.detectChanges();
-      expect(component.uiData.entries.length).toEqual(2);
-    }
   });
 
   describe('Scroll component', () => {
-    executeScrollComponentTests('entry', setUpTestEnvironment);
+    executeScrollComponentTests(setUpTestEnvironment);
 
     function makeUiDataForScroll(): UiData {
       const propertiesTree = new PropertyTreeBuilder()
@@ -380,20 +228,14 @@ describe('ViewerTransactionsComponent', () => {
         .setValue(null)
         .build();
 
-      const time = new PropertyTreeBuilder()
-        .setRootId(propertiesTree.id)
-        .setName('timestamp')
-        .setValue(TimestampConverterUtils.makeElapsedTimestamp(1n))
-        .setFormatter(TIMESTAMP_NODE_FORMATTER)
+      const ts = TimestampConverterUtils.makeElapsedTimestamp(1n);
+
+      const trace = new TraceBuilder<PropertyTreeNode>()
+        .setEntries([propertiesTree, propertiesTree])
+        .setTimestamps([ts, ts])
         .build();
 
       const uiData = new UiData(
-        [],
-        [],
-        [],
-        [],
-        [],
-        [],
         [],
         [],
         0,
@@ -405,16 +247,26 @@ describe('ViewerTransactionsComponent', () => {
       const shortMessage = 'flag1 | flag2';
       const longMessage = shortMessage.repeat(20);
       for (let i = 0; i < 200; i++) {
-        const entry = new UiDataEntry(
-          0,
-          time,
-          -111,
-          'PID_VALUE',
-          'UID_VALUE',
-          'TYPE_VALUE',
-          'LAYER_OR_DISPLAY_ID_VALUE',
-          'TRANSACTION_ID_VALUE',
-          i % 2 === 0 ? shortMessage : longMessage,
+        const entry = new TransactionsEntry(
+          trace.getEntry(0),
+          [
+            {type: LogFieldType.VSYNC_ID, value: -111},
+            {type: LogFieldType.PID, value: 'PID_VALUE'},
+            {type: LogFieldType.UID, value: 'UID_VALUE'},
+            {type: LogFieldType.TRANSACTION_TYPE, value: 'TYPE_VALUE'},
+            {
+              type: LogFieldType.LAYER_OR_DISPLAY_ID,
+              value: 'LAYER_OR_DISPLAY_ID_VALUE',
+            },
+            {
+              type: LogFieldType.TRANSACTION_ID,
+              value: 'TRANSACTION_ID_VALUE',
+            },
+            {
+              type: LogFieldType.FLAGS,
+              value: i % 2 === 0 ? shortMessage : longMessage,
+            },
+          ],
           propertiesTree,
         );
         uiData.entries.push(entry);
@@ -434,6 +286,7 @@ describe('ViewerTransactionsComponent', () => {
         imports: [ScrollingModule],
         declarations: [
           ViewerTransactionsComponent,
+          LogComponent,
           TransactionsScrollDirective,
         ],
         schemas: [CUSTOM_ELEMENTS_SCHEMA],
@@ -441,8 +294,11 @@ describe('ViewerTransactionsComponent', () => {
       const fixture = TestBed.createComponent(ViewerTransactionsComponent);
       const transactionsComponent = fixture.componentInstance;
       const htmlElement = fixture.nativeElement;
-      const viewport = assertDefined(transactionsComponent.scrollComponent);
       transactionsComponent.inputData = makeUiDataForScroll();
+      fixture.detectChanges();
+      const viewport = assertDefined(
+        transactionsComponent.logComponent?.scrollComponent,
+      );
       return [fixture, htmlElement, viewport];
     }
   });
diff --git a/tools/winscope/src/viewers/viewer_transitions/presenter.ts b/tools/winscope/src/viewers/viewer_transitions/presenter.ts
index 520ebe419..858206bdc 100644
--- a/tools/winscope/src/viewers/viewer_transitions/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/presenter.ts
@@ -15,102 +15,66 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
-import {FunctionUtils} from 'common/function_utils';
-import {Timestamp} from 'common/time';
-import {
-  TracePositionUpdate,
-  WinscopeEvent,
-  WinscopeEventType,
-} from 'messaging/winscope_event';
-import {
-  EmitEvent,
-  WinscopeEventEmitter,
-} from 'messaging/winscope_event_emitter';
 import {CustomQueryType} from 'trace/custom_query';
-import {AbsoluteEntryIndex, Trace} from 'trace/trace';
+import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
-import {TraceEntryFinder} from 'trace/trace_entry_finder';
 import {TraceType} from 'trace/trace_type';
-import {Transition} from 'trace/transition';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {Filter} from 'viewers/common/operations/filter';
-import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
-import {UiTreeFormatter} from 'viewers/common/ui_tree_formatter';
-import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
+import {
+  AbstractLogViewerPresenter,
+  NotifyLogViewCallbackType,
+} from 'viewers/common/abstract_log_viewer_presenter';
+import {LogPresenter} from 'viewers/common/log_presenter';
+import {PropertiesPresenter} from 'viewers/common/properties_presenter';
+import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
 import {UpdateTransitionChangesNames} from './operations/update_transition_changes_names';
-import {UiData} from './ui_data';
+import {TransitionsEntry, TransitionStatus, UiData} from './ui_data';
+
+export class Presenter extends AbstractLogViewerPresenter<UiData> {
+  static readonly FIELD_TYPES = [
+    LogFieldType.TRANSITION_ID,
+    LogFieldType.TRANSITION_TYPE,
+    LogFieldType.SEND_TIME,
+    LogFieldType.DISPATCH_TIME,
+    LogFieldType.DURATION,
+    LogFieldType.STATUS,
+  ];
+  private static readonly VALUE_NA = 'N/A';
 
-export class Presenter implements WinscopeEventEmitter {
   private isInitialized = false;
   private transitionTrace: Trace<PropertyTreeNode>;
   private surfaceFlingerTrace: Trace<HierarchyTreeNode> | undefined;
   private windowManagerTrace: Trace<HierarchyTreeNode> | undefined;
   private layerIdToName = new Map<number, string>();
   private windowTokenToTitle = new Map<string, string>();
-  private uiData = UiData.EMPTY;
-  private readonly notifyUiDataCallback: (data: UiData) => void;
-  private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
+
+  protected override keepCalculated = false;
+  protected override logPresenter = new LogPresenter<TransitionsEntry>(false);
+  protected override propertiesPresenter = new PropertiesPresenter(
+    {},
+    undefined,
+    [],
+    [
+      new UpdateTransitionChangesNames(
+        this.layerIdToName,
+        this.windowTokenToTitle,
+      ),
+    ],
+  );
 
   constructor(
     trace: Trace<PropertyTreeNode>,
     traces: Traces,
-    notifyUiDataCallback: (data: UiData) => void,
+    notifyViewCallback: NotifyLogViewCallbackType<UiData>,
   ) {
+    super(trace, notifyViewCallback, UiData.createEmpty());
     this.transitionTrace = trace;
     this.surfaceFlingerTrace = traces.getTrace(TraceType.SURFACE_FLINGER);
     this.windowManagerTrace = traces.getTrace(TraceType.WINDOW_MANAGER);
-    this.notifyUiDataCallback = notifyUiDataCallback;
-  }
-
-  setEmitEvent(callback: EmitEvent) {
-    this.emitAppEvent = callback;
-  }
-
-  async onAppEvent(event: WinscopeEvent) {
-    await event.visit(
-      WinscopeEventType.TRACE_POSITION_UPDATE,
-      async (event) => {
-        await this.initializeIfNeeded();
-
-        if (this.uiData === UiData.EMPTY) {
-          this.uiData = await this.computeUiData();
-        }
-
-        const entry = TraceEntryFinder.findCorrespondingEntry(
-          this.transitionTrace,
-          event.position,
-        );
-
-        const transition = await entry?.getValue();
-        if (transition !== undefined) {
-          this.onTransitionSelected(transition);
-        }
-
-        this.notifyUiDataCallback(this.uiData);
-      },
-    );
-  }
-
-  onTransitionSelected(transition: PropertyTreeNode): void {
-    this.uiData.selectedTransition = this.makeUiPropertiesTree(transition);
-    this.notifyUiDataCallback(this.uiData);
   }
 
-  async onRawTimestampClicked(timestamp: Timestamp) {
-    await this.emitAppEvent(TracePositionUpdate.fromTimestamp(timestamp, true));
-  }
-
-  async onLogTimestampClicked(traceIndex: AbsoluteEntryIndex) {
-    await this.emitAppEvent(
-      TracePositionUpdate.fromTraceEntry(
-        this.transitionTrace.getEntry(traceIndex),
-        true,
-      ),
-    );
-  }
-
-  private async initializeIfNeeded() {
+  protected async initializeIfNeeded() {
     if (this.isInitialized) {
       return;
     }
@@ -133,72 +97,108 @@ export class Presenter implements WinscopeEventEmitter {
       });
     }
 
+    const allEntries = await this.makeUiDataEntries();
+
+    this.logPresenter.setAllEntries(allEntries);
+    this.logPresenter.setHeaders(Presenter.FIELD_TYPES);
+    this.refreshUiData();
     this.isInitialized = true;
   }
 
-  private async computeUiData(): Promise<UiData> {
-    const entryPromises = this.transitionTrace.mapEntry((entry) => {
-      return entry.getValue();
-    });
-    const entries = await Promise.all(entryPromises);
+  private async makeUiDataEntries(): Promise<TransitionsEntry[]> {
     // TODO(b/339191691): Ideally we should refactor the parsers to
     // keep a map of time -> rowId, instead of relying on table order
-    const transitions = this.makeTransitions(entries);
+    const transitions = await this.makeTransitions();
     this.sortTransitions(transitions);
-    const selectedTransition = this.uiData?.selectedTransition ?? undefined;
-
-    return new UiData(transitions, selectedTransition);
+    return transitions;
   }
 
-  private sortTransitions(transitions: Transition[]) {
-    transitions.sort((a: Transition, b: Transition) => {
-      return a.id <= b.id ? -1 : 1;
+  private sortTransitions(transitions: TransitionsEntry[]) {
+    const getId = (a: TransitionsEntry) =>
+      assertDefined(a.fields.find((f) => f.type === LogFieldType.TRANSITION_ID))
+        .value;
+    transitions.sort((a: TransitionsEntry, b: TransitionsEntry) => {
+      return getId(a) <= getId(b) ? -1 : 1;
     });
   }
 
-  private makeTransitions(entries: PropertyTreeNode[]): Transition[] {
-    return entries.map((transitionNode, index) => {
+  private async makeTransitions(): Promise<TransitionsEntry[]> {
+    const transitions: TransitionsEntry[] = [];
+    for (
+      let traceIndex = 0;
+      traceIndex < this.transitionTrace.lengthEntries;
+      ++traceIndex
+    ) {
+      const entry = assertDefined(this.trace.getEntry(traceIndex));
+      let transitionNode: PropertyTreeNode;
+      try {
+        transitionNode = await entry.getValue();
+      } catch (e) {
+        continue;
+      }
       const wmDataNode = assertDefined(transitionNode.getChildByName('wmData'));
       const shellDataNode = assertDefined(
         transitionNode.getChildByName('shellData'),
       );
 
-      const transition: Transition = {
-        id: assertDefined(transitionNode.getChildByName('id')).getValue(),
-        type: wmDataNode.getChildByName('type')?.formattedValue() ?? 'NONE',
-        sendTime: wmDataNode.getChildByName('sendTimeNs'),
-        dispatchTime: shellDataNode.getChildByName('dispatchTimeNs'),
-        duration: transitionNode.getChildByName('duration')?.formattedValue(),
-        merged: assertDefined(
-          transitionNode.getChildByName('merged'),
-        ).getValue(),
-        aborted: assertDefined(
-          transitionNode.getChildByName('aborted'),
-        ).getValue(),
-        played: assertDefined(
-          transitionNode.getChildByName('played'),
-        ).getValue(),
-        propertiesTree: transitionNode,
-        traceIndex: index,
-      };
-      return transition;
-    });
-  }
+      let status: TransitionStatus | undefined;
+      let statusIcon: string | undefined;
+      let statusIconColor: string | undefined;
+      if (assertDefined(transitionNode.getChildByName('merged')).getValue()) {
+        status = TransitionStatus.MERGED;
+        statusIcon = 'merge';
+        statusIconColor = 'gray';
+      } else if (
+        assertDefined(transitionNode.getChildByName('aborted')).getValue()
+      ) {
+        status = TransitionStatus.ABORTED;
+        statusIcon = 'close';
+        statusIconColor = 'red';
+      } else if (
+        assertDefined(transitionNode.getChildByName('played')).getValue()
+      ) {
+        status = TransitionStatus.PLAYED;
+        statusIcon = 'check';
+        statusIconColor = 'green';
+      }
+
+      const fields: LogField[] = [
+        {
+          type: LogFieldType.TRANSITION_ID,
+          value: assertDefined(transitionNode.getChildByName('id')).getValue(),
+        },
+        {
+          type: LogFieldType.TRANSITION_TYPE,
+          value: wmDataNode.getChildByName('type')?.formattedValue() ?? 'NONE',
+        },
+        {
+          type: LogFieldType.SEND_TIME,
+          value:
+            wmDataNode.getChildByName('sendTimeNs')?.getValue() ??
+            Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.DISPATCH_TIME,
+          value:
+            shellDataNode.getChildByName('dispatchTimeNs')?.getValue() ??
+            Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.DURATION,
+          value:
+            transitionNode.getChildByName('duration')?.formattedValue() ??
+            Presenter.VALUE_NA,
+        },
+        {
+          type: LogFieldType.STATUS,
+          value: status ?? Presenter.VALUE_NA,
+          icon: statusIcon,
+          iconColor: statusIconColor,
+        },
+      ];
+      transitions.push(new TransitionsEntry(entry, fields, transitionNode));
+    }
 
-  private makeUiPropertiesTree(
-    transitionNode: PropertyTreeNode,
-  ): UiPropertyTreeNode {
-    const tree = UiPropertyTreeNode.from(transitionNode);
-
-    return new UiTreeFormatter<UiPropertyTreeNode>()
-      .setUiTree(tree)
-      .addOperation(new Filter([UiTreeUtils.isNotCalculated], false))
-      .addOperation(
-        new UpdateTransitionChangesNames(
-          this.layerIdToName,
-          this.windowTokenToTitle,
-        ),
-      )
-      .format();
+    return transitions;
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts b/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
index 227eba11f..3f3ba0d38 100644
--- a/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/presenter_test.ts
@@ -16,65 +16,134 @@
 
 import {assertDefined} from 'common/assert_utils';
 import {TracePositionUpdate} from 'messaging/winscope_event';
+import {ParserBuilder} from 'test/unit/parser_builder';
+import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
 import {TracesBuilder} from 'test/unit/traces_builder';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
+import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {NotifyLogViewCallbackType} from 'viewers/common/abstract_log_viewer_presenter';
+import {AbstractLogViewerPresenterTest} from 'viewers/common/abstract_log_viewer_presenter_test';
+import {UiDataLog} from 'viewers/common/ui_data_log';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
 
-describe('PresenterTransitions', () => {
-  it('is robust to empty trace', async () => {
-    const traces = new TracesBuilder()
-      .setEntries(TraceType.TRANSITION, [])
-      .build();
-    const trace = assertDefined(traces.getTrace(TraceType.TRANSITION));
-    let outputUiData: UiData | undefined;
-    const presenter = new Presenter(trace, traces, (data: UiData) => {
-      outputUiData = data;
-    });
+class PresenterTransitionsTest extends AbstractLogViewerPresenterTest<UiData> {
+  private trace: Trace<PropertyTreeNode> | undefined;
+  private positionUpdate: TracePositionUpdate | undefined;
+  private secondPositionUpdate: TracePositionUpdate | undefined;
 
-    await presenter.onAppEvent(
-      TracePositionUpdate.fromTimestamp(
-        TimestampConverterUtils.makeRealTimestamp(10n),
-      ),
-    );
-    expect(outputUiData).toEqual(UiData.EMPTY);
-  });
+  override readonly shouldExecuteHeaderTests = true;
+  override readonly shouldExecuteFilterTests = false;
+  override readonly shouldExecutePropertiesTests = true;
+
+  override readonly totalOutputEntries = 4;
+  override readonly expectedIndexOfFirstPositionUpdate = 3;
+  override readonly expectedIndexOfSecondPositionUpdate = 1;
+  override readonly logEntryClickIndex = 2;
 
-  it('updates selected transition', async () => {
+  override async setUpTestEnvironment(): Promise<void> {
     const parser = await UnitTestUtils.getPerfettoParser(
       TraceType.TRANSITION,
       'traces/perfetto/shell_transitions_trace.perfetto-trace',
     );
 
-    const trace = new TraceBuilder<PropertyTreeNode>()
+    this.trace = new TraceBuilder<PropertyTreeNode>()
       .setType(TraceType.TRANSITION)
       .setParser(parser)
       .build();
 
+    this.positionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(0),
+    );
+    this.secondPositionUpdate = TracePositionUpdate.fromTraceEntry(
+      this.trace.getEntry(2),
+    );
+  }
+
+  override async createPresenterWithEmptyTrace(
+    callback: NotifyLogViewCallbackType<UiData>,
+  ): Promise<Presenter> {
+    const traces = new TracesBuilder()
+      .setEntries(TraceType.TRANSITION, [])
+      .build();
+    const trace = assertDefined(traces.getTrace(TraceType.TRANSITION));
+    return new Presenter(trace, traces, callback);
+  }
+
+  override async createPresenter(
+    callback: NotifyLogViewCallbackType<UiData>,
+    trace = this.trace,
+    positionUpdate = assertDefined(this.getPositionUpdate()),
+  ): Promise<Presenter> {
+    const transitionTrace = assertDefined(trace);
     const traces = new Traces();
-    traces.addTrace(trace);
+    traces.addTrace(transitionTrace);
 
-    let outputUiData = UiData.EMPTY;
-    const presenter = new Presenter(trace, traces, (data: UiData) => {
-      outputUiData = data;
-    });
+    const presenter = new Presenter(transitionTrace, traces, callback);
+    await presenter.onAppEvent(positionUpdate); // trigger initialization
+    return presenter;
+  }
 
-    const entry = trace.getEntry(1);
-    await presenter.onAppEvent(TracePositionUpdate.fromTraceEntry(entry));
+  override getPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.positionUpdate);
+  }
 
-    expect(outputUiData.entries.length).toEqual(4);
+  override getSecondPositionUpdate(): TracePositionUpdate {
+    return assertDefined(this.secondPositionUpdate);
+  }
 
-    const selectedTransition = assertDefined(outputUiData.selectedTransition);
+  override executePropertiesChecksAfterPositionUpdate(uiData: UiDataLog) {
+    expect(uiData.entries.length).toEqual(4);
+
+    const selectedTransition = assertDefined(uiData.propertiesTree);
     const wmData = assertDefined(selectedTransition.getChildByName('wmData'));
-    expect(wmData.getChildByName('id')?.formattedValue()).toEqual('32');
+    expect(wmData.getChildByName('id')?.formattedValue()).toEqual('35');
     expect(wmData.getChildByName('type')?.formattedValue()).toEqual('OPEN');
     expect(wmData.getChildByName('createTimeNs')?.formattedValue()).toEqual(
-      '2023-11-21, 13:30:25.428',
+      '2023-11-21, 13:30:33.176',
     );
-  });
+  }
+
+  override executeSpecializedTests() {
+    describe('Specialized tests', () => {
+      it('robust to corrupted transitions trace', async () => {
+        const timestamp10 = TimestampConverterUtils.makeRealTimestamp(10n);
+        const trace = new TraceBuilder<PropertyTreeNode>()
+          .setType(TraceType.TRANSITION)
+          .setParser(
+            new ParserBuilder<PropertyTreeNode>()
+              .setIsCorrupted(true)
+              .setEntries([
+                new PropertyTreeBuilder()
+                  .setRootId('TransitionsTraceEntry')
+                  .setName('transition0')
+                  .build(),
+              ])
+              .setTimestamps([timestamp10])
+              .build(),
+          )
+          .build();
+        const positionUpdate = TracePositionUpdate.fromTimestamp(timestamp10);
+        let uiData: UiData | undefined;
+        const presenter = await this.createPresenter(
+          (newData) => {
+            uiData = newData;
+          },
+          trace,
+          positionUpdate,
+        );
+        await presenter.onAppEvent(positionUpdate);
+        expect(uiData?.entries).toEqual([]);
+      });
+    });
+  }
+}
+
+describe('PresenterTransitions', () => {
+  new PresenterTransitionsTest().execute();
 });
diff --git a/tools/winscope/src/viewers/viewer_transitions/ui_data.ts b/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
index 6f7bd6d45..91b44d457 100644
--- a/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/ui_data.ts
@@ -14,14 +14,41 @@
  * limitations under the License.
  */
 
-import {Transition} from 'trace/transition';
+import {TraceEntry} from 'trace/trace';
+import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
+import {
+  LogEntry,
+  LogField,
+  LogFieldType,
+  UiDataLog,
+} from 'viewers/common/ui_data_log';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 
-export class UiData {
+export class UiData implements UiDataLog {
   constructor(
-    public entries: Transition[],
-    public selectedTransition?: UiPropertyTreeNode,
+    public headers: LogFieldType[],
+    public entries: LogEntry[],
+    public currentIndex: undefined | number,
+    public selectedIndex: undefined | number,
+    public scrollToIndex: undefined | number,
+    public propertiesTree: undefined | UiPropertyTreeNode,
   ) {}
 
-  static EMPTY = new UiData([], undefined);
+  static createEmpty(): UiData {
+    return new UiData([], [], undefined, undefined, undefined, undefined);
+  }
+}
+
+export class TransitionsEntry implements LogEntry {
+  constructor(
+    public traceEntry: TraceEntry<PropertyTreeNode>,
+    public fields: LogField[],
+    public propertiesTree: PropertyTreeNode | undefined,
+  ) {}
+}
+
+export enum TransitionStatus {
+  ABORTED = 'ABORTED',
+  MERGED = 'MERGED',
+  PLAYED = 'PLAYED',
 }
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
index 123fdbe15..fb3a12e7d 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions.ts
@@ -17,9 +17,9 @@ import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
@@ -35,35 +35,17 @@ export class ViewerTransitions implements Viewer {
   constructor(trace: Trace<PropertyTreeNode>, traces: Traces) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-transitions');
-
-    this.presenter = new Presenter(trace, traces, (data: UiData) => {
+    const notifyViewCallback = (data: UiData) => {
       (this.htmlElement as any).inputData = data;
-    });
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.TransitionSelected,
-      (event) => {
-        this.presenter.onTransitionSelected((event as CustomEvent).detail);
-      },
-    );
-
-    this.htmlElement.addEventListener(
-      ViewerEvents.TimestampClick,
-      async (event) => {
-        const detail: TimestampClickDetail = (event as CustomEvent).detail;
-        if (detail.index !== undefined) {
-          await this.presenter.onLogTimestampClicked(detail.index);
-        } else if (detail.timestamp !== undefined) {
-          await this.presenter.onRawTimestampClicked(detail.timestamp);
-        }
-      },
-    );
+    };
+    this.presenter = new Presenter(trace, traces, notifyViewCallback);
+    this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
       ViewType.TAB,
       this.getTraces(),
       this.htmlElement,
-      'Transitions',
+      TRACE_INFO[TraceType.TRANSITION].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
index 22e6b6d0f..f890fbac8 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component.ts
@@ -14,14 +14,11 @@
  * limitations under the License.
  */
 
-import {Component, ElementRef, Inject, Input} from '@angular/core';
+import {Component, Input, ViewChild} from '@angular/core';
 import {TraceType} from 'trace/trace_type';
-import {Transition} from 'trace/transition';
-import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
-import {timeButtonStyle} from 'viewers/components/styles/clickable_property.styles';
+import {LogComponent} from 'viewers/common/log_component';
 import {selectedElementStyle} from 'viewers/components/styles/selected_element.styles';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
@@ -29,93 +26,30 @@ import {UiData} from './ui_data';
 @Component({
   selector: 'viewer-transitions',
   template: `
-    <div class="card-grid container">
+    <div class="card-grid">
       <collapsed-sections
         [class.empty]="sections.areAllSectionsExpanded()"
         [sections]="sections"
         (sectionChange)="sections.onCollapseStateChange($event, false)">
       </collapsed-sections>
-      <div class="log-view entries">
-        <div class="table-header table-row">
-          <div class="id mat-body-2">Id</div>
-          <div class="type mat-body-2">Type</div>
-          <div class="send-time mat-body-2">Send Time</div>
-          <div class="dispatch-time mat-body-2">Dispatch Time</div>
-          <div class="duration mat-body-2">Duration</div>
-          <div class="status mat-body-2">Status</div>
-        </div>
-        <cdk-virtual-scroll-viewport itemSize="53" class="scroll">
-          <div
-            *cdkVirtualFor="let transition of uiData.entries; let i = index"
-            class="entry table-row"
-            [class.selected]="isSelectedTransition(transition)"
-            (click)="onTransitionClicked(transition)">
-            <div class="id">
-              <span class="mat-body-1">{{ transition.id }}</span>
-            </div>
-            <div class="type">
-              <span class="mat-body-1">{{ transition.type }}</span>
-            </div>
-            <div class="send-time time">
-              <button
-                mat-button
-                color="primary"
-                *ngIf="transition.sendTime"
-                (click)="onSendTimeClicked(transition)">
-                {{ transition.sendTime.formattedValue() }}
-              </button>
-              <span *ngIf="!transition.sendTime" class="mat-body-1"> n/a </span>
-            </div>
-            <div class="dispatch-time time">
-              <button
-                mat-button
-                color="primary"
-                *ngIf="transition.dispatchTime"
-                (click)="onDispatchTimeClicked(transition)">
-                {{ transition.dispatchTime.formattedValue() }}
-              </button>
-              <span *ngIf="!transition.dispatchTime" class="mat-body-1"> n/a </span>
-            </div>
-            <div class="duration">
-              <span *ngIf="transition.duration" class="mat-body-1">{{ transition.duration }}</span>
-              <span *ngIf="!transition.duration" class="mat-body-1"> n/a </span>
-            </div>
-            <div class="status">
-              <div *ngIf="transition.merged">
-                <span class="mat-body-1">MERGED</span>
-                <mat-icon aria-hidden="false" fontIcon="merge" matTooltip="merged" icon-gray>
-                </mat-icon>
-              </div>
 
-              <div *ngIf="transition.aborted && !transition.merged">
-                <span class="mat-body-1">ABORTED</span>
-                <mat-icon
-                  aria-hidden="false"
-                  fontIcon="close"
-                  matTooltip="aborted"
-                  style="color: red"
-                  icon-red></mat-icon>
-              </div>
-
-              <div *ngIf="transition.played && !transition.aborted && !transition.merged">
-                <span class="mat-body-1">PLAYED</span>
-                <mat-icon
-                  aria-hidden="false"
-                  fontIcon="check"
-                  matTooltip="played"
-                  style="color: green"
-                  *ngIf="transition.played && !transition.aborted && !transition.merged"></mat-icon>
-              </div>
-            </div>
-          </div>
-        </cdk-virtual-scroll-viewport>
-      </div>
+      <log-view
+        class="log-view"
+        [selectedIndex]="inputData?.selectedIndex"
+        [scrollToIndex]="inputData?.scrollToIndex"
+        [currentIndex]="inputData?.currentIndex"
+        [entries]="inputData?.entries"
+        [headers]="inputData?.headers"
+        [traceType]="${TraceType.TRANSITION}"
+        [showTraceEntryTimes]="false"
+        [showCurrentTimeButton]="false">
+      </log-view>
 
       <properties-view
         class="properties-view"
         [title]="propertiesTitle"
         [showFilter]="false"
-        [propertiesTree]="uiData.selectedTransition"
+        [propertiesTree]="inputData?.propertiesTree"
         [traceType]="${TraceType.TRANSITION}"
         [isProtoDump]="false"
         placeholderText="No selected transition."
@@ -125,97 +59,20 @@ import {UiData} from './ui_data';
   `,
   styles: [
     `
-      .container {
-        display: flex;
-        flex-grow: 1;
-        flex-direction: row;
-      }
-
-      .entries {
-        flex: 3;
-        display: flex;
-        flex-direction: column;
-        padding: 16px;
-      }
-
-      .entries .scroll {
-        height: 100%;
-      }
-
-      .entries .table-header {
-        flex: 1;
-      }
-
-      .table-row {
-        display: flex;
-        flex-direction: row;
-        cursor: pointer;
-        border-bottom: solid 1px rgba(0, 0, 0, 0.12);
-      }
-
-      .table-header.table-row {
-        font-weight: bold;
-        border-bottom: solid 1px rgba(0, 0, 0, 0.5);
-      }
-
-      .table-row > div {
-        padding: 16px;
-      }
-
-      .table-row .id {
-        flex: 1;
-      }
-
-      .table-row .type {
-        flex: 2;
-      }
-
-      .table-row .dispatch-time {
-        flex: 4;
-      }
-
-      .table-row .send-time {
-        flex: 4;
-      }
-
-      .table-row .duration {
-        flex: 3;
-      }
-
-      .table-row .status {
-        flex: 2;
-      }
-
-      .status > div {
-        display: flex;
-        justify-content: center;
-        align-items: center;
-        gap: 5px;
-      }
-
-      .transition-timeline .row svg rect {
-        cursor: pointer;
-      }
-
-      .label {
-        width: 300px;
-        padding: 1rem;
-      }
-
-      .lines {
-        flex-grow: 1;
-        padding: 0.5rem;
-      }
       .properties-view {
         flex: 1;
       }
     `,
     selectedElementStyle,
-    timeButtonStyle,
     viewerCardStyle,
   ],
 })
 export class ViewerTransitionsComponent {
+  @Input() inputData: UiData | undefined;
+
+  @ViewChild(LogComponent)
+  logComponent?: LogComponent;
+
   propertiesTitle = 'SELECTED TRANSITION';
   CollapsibleSectionType = CollapsibleSectionType;
   sections = new CollapsibleSections([
@@ -225,57 +82,4 @@ export class ViewerTransitionsComponent {
       isCollapsed: false,
     },
   ]);
-
-  constructor(@Inject(ElementRef) private elementRef: ElementRef) {}
-
-  @Input()
-  set inputData(data: UiData) {
-    this.uiData = data;
-  }
-
-  onTransitionClicked(transition: Transition): void {
-    this.emitEvent(ViewerEvents.TransitionSelected, transition.propertiesTree);
-  }
-
-  isSelectedTransition(transition: Transition): boolean {
-    return (
-      transition.id ===
-        this.uiData.selectedTransition
-          ?.getChildByName('wmData')
-          ?.getChildByName('id')
-          ?.getValue() ||
-      transition.id ===
-        this.uiData.selectedTransition
-          ?.getChildByName('shellData')
-          ?.getChildByName('id')
-          ?.getValue()
-    );
-  }
-
-  onDispatchTimeClicked(transition: Transition) {
-    this.emitEvent(
-      ViewerEvents.TimestampClick,
-      new TimestampClickDetail(
-        transition.dispatchTime?.getValue(),
-        transition.traceIndex,
-      ),
-    );
-  }
-
-  onSendTimeClicked(transition: Transition) {
-    this.emitEvent(
-      ViewerEvents.TimestampClick,
-      new TimestampClickDetail(transition.sendTime?.getValue(), undefined),
-    );
-  }
-
-  emitEvent(event: string, data: PropertyTreeNode | TimestampClickDetail) {
-    const customEvent = new CustomEvent(event, {
-      bubbles: true,
-      detail: data,
-    });
-    this.elementRef.nativeElement.dispatchEvent(customEvent);
-  }
-
-  uiData: UiData = UiData.EMPTY;
 }
diff --git a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
index 5b6e4f1dd..0371a938b 100644
--- a/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_transitions/viewer_transitions_component_test.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {ClipboardModule} from '@angular/cdk/clipboard';
 import {ScrollingModule} from '@angular/cdk/scrolling';
 import {
   ComponentFixture,
@@ -23,19 +24,14 @@ import {
 import {MatDividerModule} from '@angular/material/divider';
 import {MatIconModule} from '@angular/material/icon';
 import {assertDefined} from 'common/assert_utils';
-import {TracePositionUpdate} from 'messaging/winscope_event';
 import {PropertyTreeBuilder} from 'test/unit/property_tree_builder';
 import {TimestampConverterUtils} from 'test/unit/timestamp_converter_utils';
+import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
-import {Parser} from 'trace/parser';
-import {Trace} from 'trace/trace';
-import {Traces} from 'trace/traces';
-import {TracePosition} from 'trace/trace_position';
-import {TraceType} from 'trace/trace_type';
-import {Transition} from 'trace/transition';
-import {TIMESTAMP_NODE_FORMATTER} from 'trace/tree_node/formatters';
+import {Trace, TraceEntry} from 'trace/trace';
 import {PropertyTreeNode} from 'trace/tree_node/property_tree_node';
-import {TimestampClickDetail, ViewerEvents} from 'viewers/common/viewer_events';
+import {LogComponent} from 'viewers/common/log_component';
+import {LogField, LogFieldType} from 'viewers/common/ui_data_log';
 import {CollapsedSectionsComponent} from 'viewers/components/collapsed_sections_component';
 import {CollapsibleSectionTitleComponent} from 'viewers/components/collapsible_section_title_component';
 import {PropertiesComponent} from 'viewers/components/properties_component';
@@ -43,7 +39,7 @@ import {PropertyTreeNodeDataViewComponent} from 'viewers/components/property_tre
 import {TreeComponent} from 'viewers/components/tree_component';
 import {TreeNodeComponent} from 'viewers/components/tree_node_component';
 import {Presenter} from './presenter';
-import {UiData} from './ui_data';
+import {TransitionsEntry, TransitionStatus, UiData} from './ui_data';
 import {ViewerTransitionsComponent} from './viewer_transitions_component';
 
 describe('ViewerTransitionsComponent', () => {
@@ -51,10 +47,32 @@ describe('ViewerTransitionsComponent', () => {
   let component: ViewerTransitionsComponent;
   let htmlElement: HTMLElement;
 
+  let transitionTree: PropertyTreeNode;
+  let trace: Trace<PropertyTreeNode>;
+  let entry: TraceEntry<PropertyTreeNode>;
+
+  beforeAll(() => {
+    transitionTree = new PropertyTreeBuilder()
+      .setIsRoot(true)
+      .setRootId('TransitionTraceEntry')
+      .setName('transition')
+      .build();
+    trace = new TraceBuilder<PropertyTreeNode>()
+      .setEntries([transitionTree])
+      .setTimestamps([TimestampConverterUtils.makeElapsedTimestamp(20n)])
+      .build();
+    entry = trace.getEntry(0);
+  });
+
   beforeEach(async () => {
     await TestBed.configureTestingModule({
       providers: [{provide: ComponentFixtureAutoDetect, useValue: true}],
-      imports: [MatDividerModule, ScrollingModule, MatIconModule],
+      imports: [
+        MatDividerModule,
+        ScrollingModule,
+        MatIconModule,
+        ClipboardModule,
+      ],
       declarations: [
         ViewerTransitionsComponent,
         TreeComponent,
@@ -63,6 +81,7 @@ describe('ViewerTransitionsComponent', () => {
         PropertiesComponent,
         CollapsedSectionsComponent,
         CollapsibleSectionTitleComponent,
+        LogComponent,
       ],
       schemas: [],
     }).compileComponents();
@@ -71,7 +90,7 @@ describe('ViewerTransitionsComponent', () => {
     component = fixture.componentInstance;
     htmlElement = fixture.nativeElement;
 
-    component.uiData = makeUiData();
+    component.inputData = makeUiData();
     fixture.detectChanges();
   });
 
@@ -88,139 +107,14 @@ describe('ViewerTransitionsComponent', () => {
   });
 
   it('shows message when no transition is selected', () => {
+    assertDefined(component.inputData).propertiesTree = undefined;
+    fixture.detectChanges();
     expect(
       htmlElement.querySelector('.properties-view .placeholder-text')
         ?.innerHTML,
     ).toContain('No selected transition');
   });
 
-  it('emits TransitionSelected event on transition clicked', () => {
-    const emitEventSpy = spyOn(component, 'emitEvent');
-
-    const entries = htmlElement.querySelectorAll('.entry.table-row');
-    const entry1 = assertDefined(entries[0]) as HTMLElement;
-    const entry2 = assertDefined(entries[1]) as HTMLElement;
-    const treeView = assertDefined(
-      htmlElement.querySelector('.properties-view'),
-    ) as HTMLElement;
-    expect(
-      assertDefined(treeView.querySelector('.placeholder-text')).textContent,
-    ).toContain('No selected transition');
-
-    expect(emitEventSpy).not.toHaveBeenCalled();
-
-    const id0 = assertDefined(entry1.querySelector('.id')).textContent;
-    expect(id0).toEqual('0');
-    entry1.click();
-    fixture.detectChanges();
-
-    expect(emitEventSpy).toHaveBeenCalled();
-    expect(emitEventSpy).toHaveBeenCalledWith(
-      ViewerEvents.TransitionSelected,
-      jasmine.any(Object),
-    );
-    expect(
-      (emitEventSpy.calls.mostRecent().args[1] as PropertyTreeNode)
-        .getChildByName('id')
-        ?.getValue(),
-    ).toEqual(0);
-
-    const id1 = assertDefined(entry2.querySelector('.id')).textContent;
-    expect(id1).toEqual('1');
-    entry2.click();
-    fixture.detectChanges();
-
-    expect(emitEventSpy).toHaveBeenCalled();
-    expect(emitEventSpy).toHaveBeenCalledWith(
-      ViewerEvents.TransitionSelected,
-      jasmine.any(Object),
-    );
-    expect(
-      (emitEventSpy.calls.mostRecent().args[1] as PropertyTreeNode)
-        .getChildByName('id')
-        ?.getValue(),
-    ).toEqual(1);
-  });
-
-  it('updates tree view on TracePositionUpdate event', async () => {
-    const parser = (await UnitTestUtils.getTracesParser([
-      'traces/elapsed_and_real_timestamp/wm_transition_trace.pb',
-      'traces/elapsed_and_real_timestamp/shell_transition_trace.pb',
-    ])) as Parser<PropertyTreeNode>;
-    const trace = Trace.fromParser(parser);
-    const traces = new Traces();
-    traces.addTrace(trace);
-
-    let treeView = assertDefined(
-      htmlElement.querySelector('.properties-view'),
-    ) as any as HTMLElement;
-    expect(
-      assertDefined(treeView.querySelector('.placeholder-text')).textContent,
-    ).toContain('No selected transition');
-
-    const presenter = new Presenter(trace, traces, (data) => {
-      component.inputData = data;
-    });
-    const selectedTransitionEntry = assertDefined(
-      traces.getTrace(TraceType.TRANSITION)?.getEntry(2),
-    );
-    const selectedTransition = await selectedTransitionEntry.getValue();
-    const selectedTransitionId = assertDefined(
-      selectedTransition.getChildByName('id'),
-    ).getValue();
-    await presenter.onAppEvent(
-      new TracePositionUpdate(
-        TracePosition.fromTraceEntry(selectedTransitionEntry),
-      ),
-    );
-
-    expect(
-      assertDefined(
-        component.uiData.selectedTransition
-          ?.getChildByName('wmData')
-          ?.getChildByName('id'),
-      ).getValue(),
-    ).toEqual(selectedTransitionId);
-
-    fixture.detectChanges();
-
-    treeView = assertDefined(
-      fixture.nativeElement.querySelector('.properties-view'),
-    ) as any as HTMLElement;
-    const textContentWithoutWhitespaces = treeView.textContent?.replace(
-      /(\s|\t|\n)*/g,
-      '',
-    );
-    expect(textContentWithoutWhitespaces).toContain(
-      `id:${selectedTransitionId}`,
-    );
-  });
-
-  it('propagates timestamp on click', () => {
-    let timestamp: string | undefined;
-    let index: number | undefined;
-    htmlElement.addEventListener(ViewerEvents.TimestampClick, (event) => {
-      const detail: TimestampClickDetail = (event as CustomEvent).detail;
-      timestamp = detail.timestamp?.format();
-      index = detail.index;
-    });
-    const sendTimeButton = assertDefined(
-      htmlElement.querySelector('.send-time button'),
-    ) as HTMLButtonElement;
-    sendTimeButton.click();
-
-    expect(index).toBeUndefined();
-    expect(timestamp).toEqual('20ns');
-
-    const dispatchTimeButton = assertDefined(
-      htmlElement.querySelector('.dispatch-time button'),
-    ) as HTMLButtonElement;
-    dispatchTimeButton.click();
-
-    expect(index).toEqual(0);
-    expect(timestamp).toEqual('25ns');
-  });
-
   it('creates collapsed sections with no buttons', () => {
     UnitTestUtils.checkNoCollapsedSectionButtons(htmlElement);
   });
@@ -233,61 +127,76 @@ describe('ViewerTransitionsComponent', () => {
       'SELECTED TRANSITION',
     );
   });
-});
-
-function makeUiData(): UiData {
-  let mockTransitionIdCounter = 0;
-
-  const transitions = [
-    createMockTransition(20, 30, mockTransitionIdCounter++),
-    createMockTransition(42, 50, mockTransitionIdCounter++),
-    createMockTransition(46, 49, mockTransitionIdCounter++),
-    createMockTransition(58, 70, mockTransitionIdCounter++),
-  ];
-
-  return new UiData(transitions, undefined);
-}
 
-function createMockTransition(
-  sendTimeNanos: number,
-  finishTimeNanos: number,
-  id: number,
-): Transition {
-  const transitionTree = new PropertyTreeBuilder()
-    .setIsRoot(true)
-    .setRootId('TransitionTraceEntry')
-    .setName('transition')
-    .setChildren([{name: 'id', value: id}])
-    .build();
-
-  const sendTimeNode = new PropertyTreeBuilder()
-    .setRootId(transitionTree.id)
-    .setName('sendTimeNs')
-    .setValue(
-      TimestampConverterUtils.makeElapsedTimestamp(BigInt(sendTimeNanos)),
-    )
-    .setFormatter(TIMESTAMP_NODE_FORMATTER)
-    .build();
-
-  const dispatchTimeNode = new PropertyTreeBuilder()
-    .setRootId(transitionTree.id)
-    .setName('dispatchTimeNs')
-    .setValue(
-      TimestampConverterUtils.makeElapsedTimestamp(BigInt(sendTimeNanos) + 5n),
-    )
-    .setFormatter(TIMESTAMP_NODE_FORMATTER)
-    .build();
-
-  return {
-    id,
-    type: 'TO_FRONT',
-    sendTime: sendTimeNode,
-    dispatchTime: dispatchTimeNode,
-    duration: (finishTimeNanos - sendTimeNanos).toString() + 'ns',
-    merged: false,
-    aborted: false,
-    played: false,
-    propertiesTree: transitionTree,
-    traceIndex: 0,
-  };
-}
+  function makeUiData(): UiData {
+    let mockTransitionIdCounter = 0;
+
+    const transitions = [
+      createMockTransition(entry, 20, 30, mockTransitionIdCounter++),
+      createMockTransition(
+        entry,
+        42,
+        50,
+        mockTransitionIdCounter++,
+        TransitionStatus.MERGED,
+      ),
+      createMockTransition(entry, 46, 49, mockTransitionIdCounter++),
+      createMockTransition(
+        entry,
+        58,
+        70,
+        mockTransitionIdCounter++,
+        TransitionStatus.ABORTED,
+      ),
+    ];
+
+    const uiData = UiData.createEmpty();
+    uiData.entries = transitions;
+    uiData.selectedIndex = 0;
+    uiData.headers = Presenter.FIELD_TYPES;
+    return uiData;
+  }
+
+  function createMockTransition(
+    entry: TraceEntry<PropertyTreeNode>,
+    sendTimeNanos: number,
+    finishTimeNanos: number,
+    id: number,
+    status = TransitionStatus.PLAYED,
+  ): TransitionsEntry {
+    const fields: LogField[] = [
+      {
+        type: LogFieldType.TRANSITION_ID,
+        value: id,
+      },
+      {
+        type: LogFieldType.TRANSITION_TYPE,
+        value: 'TO_FRONT',
+      },
+      {
+        type: LogFieldType.SEND_TIME,
+        value: TimestampConverterUtils.makeElapsedTimestamp(
+          BigInt(sendTimeNanos),
+        ),
+      },
+      {
+        type: LogFieldType.DISPATCH_TIME,
+        value: TimestampConverterUtils.makeElapsedTimestamp(
+          BigInt(sendTimeNanos) + 5n,
+        ),
+      },
+      {
+        type: LogFieldType.DURATION,
+        value: (finishTimeNanos - sendTimeNanos).toString() + 'ns',
+      },
+      {
+        type: LogFieldType.STATUS,
+        value: status,
+        icon: 'check',
+        iconColor: 'green',
+      },
+    ];
+
+    return new TransitionsEntry(entry, fields, transitionTree);
+  }
+});
diff --git a/tools/winscope/src/viewers/viewer_view_capture/presenter.ts b/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
index 2e341ca70..14d30af09 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/presenter.ts
@@ -16,6 +16,7 @@
 
 import {assertDefined, assertTrue} from 'common/assert_utils';
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
+import {Store} from 'common/store';
 import {
   TabbedViewSwitchRequest,
   WinscopeEvent,
@@ -38,13 +39,14 @@ import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {HierarchyPresenter} from 'viewers/common/hierarchy_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
 import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UI_RECT_FACTORY} from 'viewers/common/ui_rect_factory';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UiData} from './ui_data';
 
-export class Presenter extends AbstractHierarchyViewerPresenter {
+export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
   static readonly DENYLIST_PROPERTY_NAMES = ['children', 'isComputedVisible'];
 
   private windowNames: string[] = [];
@@ -69,6 +71,11 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'VcHierarchyFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
     false,
     true,
@@ -77,7 +84,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     PersistentStoreProxy.new<UserOptions>(
       'VcRectsOptions',
       {
-        ignoreNonHidden: {
+        ignoreRectShowState: {
           name: 'Ignore',
           icon: 'visibility',
           enabled: false,
@@ -95,6 +102,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         tree,
         this.getIdFromViewCaptureTrace(trace),
       ),
+    undefined,
   );
   protected override propertiesPresenter = new PropertiesPresenter(
     PersistentStoreProxy.new<UserOptions>(
@@ -117,6 +125,11 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'VcPropertiesFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
   );
   protected override readonly multiTraceType = TraceType.VIEW_CAPTURE;
@@ -130,8 +143,8 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
 
   constructor(
     traces: Traces,
-    storage: Readonly<Storage>,
-    notifyViewCallback: NotifyHierarchyViewCallbackType,
+    storage: Readonly<Store>,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<UiData>,
   ) {
     super(undefined, traces, storage, notifyViewCallback, new UiData());
     this.viewCaptureTraces = traces.getTraces(TraceType.VIEW_CAPTURE);
@@ -156,6 +169,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
   }
 
   override async onAppEvent(event: WinscopeEvent) {
+    await this.handleCommonWinscopeEvents(event);
     await event.visit(
       WinscopeEventType.TRACE_POSITION_UPDATE,
       async (event) => {
@@ -179,6 +193,15 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         this.refreshUIData();
       },
     );
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        const filterPresetName = event.name;
+        await this.applyPresetConfig(filterPresetName);
+        this.updateCuratedProperties();
+        this.refreshUIData();
+      },
+    );
   }
 
   override async onHighlightedNodeChange(node: UiHierarchyTreeNode) {
@@ -248,16 +271,15 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
   }
 
   private getWindows(windowNames: string[]): DisplayIdentifier[] {
-    return this.viewCaptureTraces
-      .map((trace, i) => {
-        const traceId = this.getIdFromViewCaptureTrace(trace);
-        return {
-          displayId: traceId,
-          groupId: traceId,
-          name: windowNames[i],
-        };
-      })
-      .sort((a, b) => a.name.localeCompare(b.name));
+    return this.viewCaptureTraces.map((trace, i) => {
+      const traceId = this.getIdFromViewCaptureTrace(trace);
+      return {
+        displayId: traceId,
+        groupId: traceId,
+        name: windowNames[i],
+        isActive: true,
+      };
+    });
   }
 
   private updateCuratedProperties() {
@@ -311,8 +333,8 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
   }
 
   private refreshUIData() {
-    this.refreshHierarchyViewerUiData(
-      new UiData(this.sfRects, this.curatedProperties),
-    );
+    this.uiData.sfRects = this.sfRects;
+    this.uiData.curatedProperties = this.curatedProperties;
+    this.refreshHierarchyViewerUiData();
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts b/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
index 3a583c58b..10ff5392b 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/presenter_test.ts
@@ -15,8 +15,9 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {Rect} from 'common/rect';
+import {Store} from 'common/store';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
@@ -29,13 +30,14 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
 import {DiffType} from 'viewers/common/diff_type';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {Presenter} from 'viewers/viewer_view_capture/presenter';
 import {UiData} from 'viewers/viewer_view_capture/ui_data';
 
-class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest {
+class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest<UiData> {
   private traces: Traces | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
   private secondPositionUpdate: TracePositionUpdate | undefined;
@@ -45,19 +47,20 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest {
   override readonly shouldExecuteFlatTreeTest = false;
   override readonly shouldExecuteRectTests = true;
   override readonly shouldExecuteShowDiffTests = true;
+  override readonly shouldExecuteDumpTests = false;
   override readonly shouldExecuteSimplifyNamesTest = true;
 
   override readonly numberOfDefaultProperties = 3;
   override readonly numberOfNonDefaultProperties = 15;
   override readonly expectedFirstRect = new Rect(0, 0, 1080, 249);
-  override readonly propertiesFilterString = 'alpha';
+  override readonly propertiesFilter = new TextFilter('alpha', []);
   override readonly expectedTotalRects = 13;
   override readonly expectedVisibleRects = 5;
   override readonly treeNodeLongName =
     'com.android.launcher3.taskbar.TaskbarView@80213537';
   override readonly treeNodeShortName = 'TaskbarView@80213537';
   override readonly numberOfFilteredProperties = 1;
-  override readonly hierarchyFilterString = 'BubbleBarView';
+  override readonly hierarchyFilter = new TextFilter('BubbleBarView', []);
   override readonly expectedHierarchyChildrenAfterStringFilter = 1;
   override readonly propertyWithDiff = 'translationY';
   override readonly expectedPropertyDiffType = DiffType.MODIFIED;
@@ -103,7 +106,7 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest {
   }
 
   override createPresenterWithEmptyTrace(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
     const trace = new TraceBuilder<HierarchyTreeNode>()
       .setType(TraceType.VIEW_CAPTURE)
@@ -118,14 +121,28 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest {
     return new Presenter(traces, new InMemoryStorage(), callback);
   }
 
+  override createPresenterWithCorruptedTrace(
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+  ): Presenter {
+    const trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.VIEW_CAPTURE)
+      .setEntries([assertDefined(this.selectedTree)])
+      .setParserCustomQueryResult(CustomQueryType.VIEW_CAPTURE_METADATA, {
+        packageName: 'the_package_name',
+        windowName: 'the_window_name',
+      })
+      .setIsCorrupted(true)
+      .build();
+    const traces = new Traces();
+    traces.addTrace(trace);
+    return new Presenter(traces, new InMemoryStorage(), callback);
+  }
+
   override createPresenter(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+    storage: Store,
   ): Presenter {
-    return new Presenter(
-      assertDefined(this.traces),
-      new InMemoryStorage(),
-      callback,
-    );
+    return new Presenter(assertDefined(this.traces), storage, callback);
   }
 
   override getPositionUpdate(): TracePositionUpdate {
@@ -177,6 +194,10 @@ class PresenterViewCaptureTest extends AbstractHierarchyViewerPresenterTest {
         propertiesTree.getChildByName('translationY'),
       ).formattedValue(),
     ).toEqual('-0.633');
+    expect(uiData.displays).toEqual([
+      {displayId: 0, groupId: 0, name: 'Taskbar', isActive: true},
+      {displayId: 1, groupId: 1, name: 'PhoneWindow@25063d9', isActive: true},
+    ]);
   }
 
   override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
diff --git a/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts b/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
index d99805555..39e24c9b3 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/ui_data.ts
@@ -18,11 +18,12 @@ import {TraceType} from 'trace/trace_type';
 import {VcCuratedProperties} from 'viewers/common/curated_properties';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 
 export class UiData implements UiDataHierarchy {
   readonly dependencies: TraceType[] = [TraceType.VIEW_CAPTURE];
@@ -31,12 +32,15 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
+  hierarchyFilter = new TextFilter('', []);
+  propertiesFilter = new TextFilter('', []);
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
   propertiesUserOptions: UserOptions = {};
   hierarchyTrees: UiHierarchyTreeNode[] | undefined;
   propertiesTree: UiPropertyTreeNode | undefined;
+  isDarkMode = false;
 
   constructor(
     public sfRects: UiRect[] | undefined = undefined,
diff --git a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
index f2442bef8..fc9c7de2f 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture.ts
@@ -15,6 +15,7 @@
  */
 
 import {FunctionUtils} from 'common/function_utils';
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {EmitEvent} from 'messaging/winscope_event_emitter';
 import {Trace} from 'trace/trace';
@@ -22,7 +23,6 @@ import {Traces} from 'trace/traces';
 import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {ViewerEvents} from 'viewers/common/viewer_events';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
@@ -37,17 +37,13 @@ export class ViewerViewCapture implements Viewer {
   private readonly view: View;
   private emitAppEvent: EmitEvent = FunctionUtils.DO_NOTHING_ASYNC;
 
-  constructor(traces: Traces, storage: Storage) {
+  constructor(traces: Traces, storage: Store) {
     this.traces = traces;
     this.htmlElement = document.createElement('viewer-view-capture');
     const notifyViewCallback = (uiData: UiData) => {
       (this.htmlElement as any).inputData = uiData;
     };
-    this.presenter = new Presenter(
-      traces,
-      storage,
-      notifyViewCallback as NotifyHierarchyViewCallbackType,
-    );
+    this.presenter = new Presenter(traces, storage, notifyViewCallback);
     this.presenter.addEventListeners(this.htmlElement);
 
     this.htmlElement.addEventListener(
diff --git a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component.ts b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component.ts
index 3785b59b9..709154d83 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component.ts
@@ -19,7 +19,8 @@ import {PersistentStore} from 'common/persistent_store';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {ShadingMode} from 'viewers/components/rects/types3d';
+import {ShadingMode} from 'viewers/components/rects/shading_mode';
+
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
@@ -50,6 +51,8 @@ import {UiData} from './ui_data';
         [shadingModes]="shadingModes"
         [dependencies]="inputData?.dependencies ?? []"
         [userOptions]="inputData?.rectsUserOptions ?? {}"
+        [pinnedItems]="inputData?.pinnedItems ?? []"
+        [isDarkMode]="inputData?.isDarkMode ?? false"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.RECTS, true)"></rects-view>
       <hierarchy-view
         class="hierarchy-view"
@@ -58,6 +61,7 @@ import {UiData} from './ui_data';
         [dependencies]="inputData?.dependencies ?? []"
         [highlightedItem]="inputData?.highlightedItem ?? ''"
         [pinnedItems]="inputData?.pinnedItems ?? []"
+        [textFilter]="inputData?.hierarchyFilter"
         [store]="store"
         [userOptions]="inputData?.hierarchyUserOptions ?? {}"
         [rectIdToShowState]="inputData?.rectIdToShowState"
@@ -71,6 +75,8 @@ import {UiData} from './ui_data';
         [traceType]="${TraceType.VIEW_CAPTURE}"
         [store]="store"
         [isProtoDump]="false"
+        placeholderText="No selected item."
+        [textFilter]="inputData?.propertiesFilter"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.PROPERTIES, true)"></properties-view>
     </div>
   `,
diff --git a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component_test.ts b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component_test.ts
index 779071c1d..3ac24e8fd 100644
--- a/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component_test.ts
+++ b/tools/winscope/src/viewers/viewer_view_capture/viewer_view_capture_component_test.ts
@@ -14,6 +14,7 @@
  * limitations under the License.
  */
 
+import {HttpClientModule} from '@angular/common/http';
 import {CUSTOM_ELEMENTS_SCHEMA} from '@angular/core';
 import {
   ComponentFixture,
@@ -55,6 +56,7 @@ describe('ViewerViewCaptureComponent', () => {
         FormsModule,
         BrowserAnimationsModule,
         MatSelectModule,
+        HttpClientModule,
       ],
       declarations: [
         ViewerViewCaptureComponent,
diff --git a/tools/winscope/src/viewers/viewer_window_manager/presenter.ts b/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
index 89d2129db..1ffd4dfd0 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/presenter.ts
@@ -15,10 +15,11 @@
  */
 
 import {PersistentStoreProxy} from 'common/persistent_store_proxy';
-import {INVALID_TIME_NS} from 'common/time';
+import {Store} from 'common/store';
 import {WinscopeEvent, WinscopeEventType} from 'messaging/winscope_event';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {
   AbstractHierarchyViewerPresenter,
@@ -29,14 +30,15 @@ import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {HierarchyPresenter} from 'viewers/common/hierarchy_presenter';
 import {PropertiesPresenter} from 'viewers/common/properties_presenter';
 import {RectsPresenter} from 'viewers/common/rects_presenter';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UI_RECT_FACTORY} from 'viewers/common/ui_rect_factory';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 import {UpdateDisplayNames} from './operations/update_display_names';
 import {UiData} from './ui_data';
 
-export class Presenter extends AbstractHierarchyViewerPresenter {
+export class Presenter extends AbstractHierarchyViewerPresenter<UiData> {
   static readonly DENYLIST_PROPERTY_NAMES = [
     'name',
     'children',
@@ -69,25 +71,22 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'WmHierarchyFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
     true,
     false,
-    (entry) => {
-      if (
-        entry.getFullTrace().lengthEntries === 1 &&
-        entry.getTimestamp().getValueNs() === INVALID_TIME_NS
-      ) {
-        return 'Dump';
-      }
-      return entry.getTimestamp().format();
-    },
-    [new UpdateDisplayNames()],
+    this.getEntryFormattedTimestamp,
+    [[TraceType.WINDOW_MANAGER, [new UpdateDisplayNames()]]],
   );
   protected override rectsPresenter = new RectsPresenter(
     PersistentStoreProxy.new<UserOptions>(
       'WmRectsOptions',
       {
-        ignoreNonHidden: {
+        ignoreRectShowState: {
           name: 'Ignore',
           icon: 'visibility',
           enabled: false,
@@ -102,6 +101,7 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     ),
     (tree: HierarchyTreeNode) => UI_RECT_FACTORY.makeUiRects(tree),
     this.getDisplays,
+    this.convertRectIdtoContainerName,
   );
   protected override propertiesPresenter = new PropertiesPresenter(
     PersistentStoreProxy.new<UserOptions>(
@@ -124,6 +124,11 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
       },
       this.storage,
     ),
+    PersistentStoreProxy.new<TextFilter>(
+      'WmPropertiesFilter',
+      new TextFilter('', []),
+      this.storage,
+    ),
     Presenter.DENYLIST_PROPERTY_NAMES,
   );
   protected override multiTraceType = undefined;
@@ -131,13 +136,14 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
   constructor(
     trace: Trace<HierarchyTreeNode>,
     traces: Traces,
-    storage: Readonly<Storage>,
-    notifyViewCallback: NotifyHierarchyViewCallbackType,
+    storage: Readonly<Store>,
+    notifyViewCallback: NotifyHierarchyViewCallbackType<UiData>,
   ) {
     super(trace, traces, storage, notifyViewCallback, new UiData());
   }
 
   override async onAppEvent(event: WinscopeEvent) {
+    await this.handleCommonWinscopeEvents(event);
     await event.visit(
       WinscopeEventType.TRACE_POSITION_UPDATE,
       async (event) => {
@@ -145,6 +151,14 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
         this.refreshUIData();
       },
     );
+    await event.visit(
+      WinscopeEventType.FILTER_PRESET_APPLY_REQUEST,
+      async (event) => {
+        const filterPresetName = event.name;
+        await this.applyPresetConfig(filterPresetName);
+        this.refreshUIData();
+      },
+    );
   }
 
   override async onHighlightedNodeChange(item: UiHierarchyTreeNode) {
@@ -177,20 +191,22 @@ export class Presenter extends AbstractHierarchyViewerPresenter {
     rects.forEach((rect: UiRect) => {
       if (!rect.isDisplay) return;
       const displayName = rect.label.slice(10, rect.label.length);
-      ids.push({displayId: rect.id, groupId: rect.groupId, name: displayName});
-    });
-    return ids.sort((a, b) => {
-      if (a.name < b.name) {
-        return -1;
-      }
-      if (a.name > b.name) {
-        return 1;
-      }
-      return 0;
+      ids.push({
+        displayId: rect.id,
+        groupId: rect.groupId,
+        name: displayName,
+        isActive: rect.isActiveDisplay,
+      });
     });
+    return ids.sort();
+  }
+
+  private convertRectIdtoContainerName(id: string) {
+    const parts = id.split(' ');
+    return parts.slice(2).join(' ');
   }
 
   private refreshUIData() {
-    this.refreshHierarchyViewerUiData(new UiData());
+    this.refreshHierarchyViewerUiData();
   }
 }
diff --git a/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts b/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
index 469613715..ec392d0c8 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/presenter_test.ts
@@ -15,8 +15,9 @@
  */
 
 import {assertDefined} from 'common/assert_utils';
+import {Rect} from 'common/geometry/rect';
 import {InMemoryStorage} from 'common/in_memory_storage';
-import {Rect} from 'common/rect';
+import {Store} from 'common/store';
 import {TracePositionUpdate} from 'messaging/winscope_event';
 import {TraceBuilder} from 'test/unit/trace_builder';
 import {UnitTestUtils} from 'test/unit/utils';
@@ -27,12 +28,13 @@ import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
 import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {AbstractHierarchyViewerPresenterTest} from 'viewers/common/abstract_hierarchy_viewer_presenter_test';
 import {DiffType} from 'viewers/common/diff_type';
-import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiTreeUtils} from 'viewers/common/ui_tree_utils';
 import {Presenter} from './presenter';
+import {UiData} from './ui_data';
 
-class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
+class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest<UiData> {
   private trace: Trace<HierarchyTreeNode> | undefined;
   private positionUpdate: TracePositionUpdate | undefined;
   private secondPositionUpdate: TracePositionUpdate | undefined;
@@ -42,12 +44,13 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
   override readonly shouldExecuteFlatTreeTest = true;
   override readonly shouldExecuteRectTests = true;
   override readonly shouldExecuteShowDiffTests = true;
+  override readonly shouldExecuteDumpTests = true;
   override readonly shouldExecuteSimplifyNamesTest = true;
 
   override readonly numberOfDefaultProperties = 29;
   override readonly numberOfNonDefaultProperties = 21;
   override readonly expectedFirstRect = new Rect(0, 0, 1080, 2400);
-  override readonly propertiesFilterString = 'requested';
+  override readonly propertiesFilter = new TextFilter('requested', []);
   override readonly expectedTotalRects = 12;
   override readonly expectedVisibleRects = 7;
   override readonly treeNodeLongName =
@@ -55,7 +58,7 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
   override readonly treeNodeShortName =
     'com.google.(...).NexusLauncherActivity';
   override readonly numberOfFilteredProperties = 2;
-  override readonly hierarchyFilterString = 'ScreenDecor';
+  override readonly hierarchyFilter = new TextFilter('ScreenDecor', []);
   override readonly expectedHierarchyChildrenAfterStringFilter = 2;
   override readonly propertyWithDiff = 'animator';
   override readonly expectedPropertyDiffType = DiffType.ADDED;
@@ -82,18 +85,18 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
     const firstEntryDataTree = await firstEntry.getValue();
     this.selectedTree = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(UiTreeUtils.makeIdFilter('93d3f3c')),
+        firstEntryDataTree.findDfs(UiTreeUtils.makeNodeFilter('93d3f3c')),
       ),
     );
     this.selectedTreeAfterPositionUpdate = UiHierarchyTreeNode.from(
       assertDefined(
-        firstEntryDataTree.findDfs(UiTreeUtils.makeIdFilter('f7092ed')),
+        firstEntryDataTree.findDfs(UiTreeUtils.makeNodeFilter('f7092ed')),
       ),
     );
   }
 
   override createPresenterWithEmptyTrace(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<UiData>,
   ): Presenter {
     const trace = new TraceBuilder<HierarchyTreeNode>()
       .setType(TraceType.WINDOW_MANAGER)
@@ -104,13 +107,27 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
     return new Presenter(trace, traces, new InMemoryStorage(), callback);
   }
 
+  override createPresenterWithCorruptedTrace(
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+  ): Presenter {
+    const trace = new TraceBuilder<HierarchyTreeNode>()
+      .setType(TraceType.WINDOW_MANAGER)
+      .setEntries([assertDefined(this.selectedTree)])
+      .setIsCorrupted(true)
+      .build();
+    const traces = new Traces();
+    traces.addTrace(trace);
+    return new Presenter(trace, traces, new InMemoryStorage(), callback);
+  }
+
   override createPresenter(
-    callback: NotifyHierarchyViewCallbackType,
+    callback: NotifyHierarchyViewCallbackType<UiData>,
+    storage: Store,
   ): Presenter {
     const traces = new Traces();
     const trace = assertDefined(this.trace);
     traces.addTrace(trace);
-    return new Presenter(trace, traces, new InMemoryStorage(), callback);
+    return new Presenter(trace, traces, storage, callback);
   }
 
   override getPositionUpdate(): TracePositionUpdate {
@@ -153,17 +170,23 @@ class PresenterWindowManagerTest extends AbstractHierarchyViewerPresenterTest {
     return assertDefined(this.selectedTreeAfterPositionUpdate);
   }
 
-  override executeChecksForPropertiesTreeAfterPositionUpdate(
-    uiData: UiDataHierarchy,
-  ) {
+  override executeChecksForPropertiesTreeAfterPositionUpdate(uiData: UiData) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
     expect(
       assertDefined(propertiesTree.getChildByName('state')).formattedValue(),
     ).toEqual('STOPPED');
+    expect(uiData.displays).toEqual([
+      {
+        displayId: 'DisplayContent 1f3454e Built-in Screen',
+        groupId: 0,
+        name: 'Built-in Screen',
+        isActive: true,
+      },
+    ]);
   }
 
   override executeChecksForPropertiesTreeAfterSecondPositionUpdate(
-    uiData: UiDataHierarchy,
+    uiData: UiData,
   ) {
     const propertiesTree = assertDefined(uiData.propertiesTree);
     expect(
diff --git a/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts b/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
index cee6a1103..d71c6ec59 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/ui_data.ts
@@ -13,14 +13,16 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+
 import {TraceType} from 'trace/trace_type';
 import {DisplayIdentifier} from 'viewers/common/display_identifier';
 import {RectShowState} from 'viewers/common/rect_show_state';
+import {TextFilter} from 'viewers/common/text_filter';
 import {UiDataHierarchy} from 'viewers/common/ui_data_hierarchy';
 import {UiHierarchyTreeNode} from 'viewers/common/ui_hierarchy_tree_node';
 import {UiPropertyTreeNode} from 'viewers/common/ui_property_tree_node';
 import {UserOptions} from 'viewers/common/user_options';
-import {UiRect} from 'viewers/components/rects/types2d';
+import {UiRect} from 'viewers/components/rects/ui_rect';
 
 export class UiData implements UiDataHierarchy {
   readonly dependencies: TraceType[] = [TraceType.WINDOW_MANAGER];
@@ -29,10 +31,13 @@ export class UiData implements UiDataHierarchy {
   displays: DisplayIdentifier[] = [];
   highlightedItem = '';
   highlightedProperty = '';
+  hierarchyFilter = new TextFilter('', []);
+  propertiesFilter = new TextFilter('', []);
   pinnedItems: UiHierarchyTreeNode[] = [];
   rectsUserOptions: UserOptions = {};
   hierarchyUserOptions: UserOptions = {};
   propertiesUserOptions: UserOptions = {};
   hierarchyTrees: UiHierarchyTreeNode[] | undefined;
   propertiesTree: UiPropertyTreeNode | undefined;
+  isDarkMode = false;
 }
diff --git a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
index aad1c1dc2..4f54f7232 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager.ts
@@ -14,12 +14,13 @@
  * limitations under the License.
  */
 
+import {Store} from 'common/store';
 import {WinscopeEvent} from 'messaging/winscope_event';
 import {Trace} from 'trace/trace';
 import {Traces} from 'trace/traces';
+import {TRACE_INFO} from 'trace/trace_info';
 import {TraceType} from 'trace/trace_type';
 import {HierarchyTreeNode} from 'trace/tree_node/hierarchy_tree_node';
-import {NotifyHierarchyViewCallbackType} from 'viewers/common/abstract_hierarchy_viewer_presenter';
 import {View, Viewer, ViewType} from 'viewers/viewer';
 import {Presenter} from './presenter';
 import {UiData} from './ui_data';
@@ -32,30 +33,21 @@ export class ViewerWindowManager implements Viewer {
   private readonly presenter: Presenter;
   private readonly view: View;
 
-  constructor(
-    trace: Trace<HierarchyTreeNode>,
-    traces: Traces,
-    storage: Storage,
-  ) {
+  constructor(trace: Trace<HierarchyTreeNode>, traces: Traces, storage: Store) {
     this.trace = trace;
     this.htmlElement = document.createElement('viewer-window-manager');
 
     const notifyViewCallback = (uiData: UiData) => {
       (this.htmlElement as any).inputData = uiData;
     };
-    this.presenter = new Presenter(
-      trace,
-      traces,
-      storage,
-      notifyViewCallback as NotifyHierarchyViewCallbackType,
-    );
+    this.presenter = new Presenter(trace, traces, storage, notifyViewCallback);
     this.presenter.addEventListeners(this.htmlElement);
 
     this.view = new View(
       ViewType.TAB,
       this.getTraces(),
       this.htmlElement,
-      'Window Manager',
+      TRACE_INFO[TraceType.WINDOW_MANAGER].name,
     );
   }
 
diff --git a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager_component.ts b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager_component.ts
index 4f928d12b..de9659575 100644
--- a/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager_component.ts
+++ b/tools/winscope/src/viewers/viewer_window_manager/viewer_window_manager_component.ts
@@ -18,7 +18,7 @@ import {PersistentStore} from 'common/persistent_store';
 import {TraceType} from 'trace/trace_type';
 import {CollapsibleSections} from 'viewers/common/collapsible_sections';
 import {CollapsibleSectionType} from 'viewers/common/collapsible_section_type';
-import {ShadingMode} from 'viewers/components/rects/types3d';
+import {ShadingMode} from 'viewers/components/rects/shading_mode';
 import {viewerCardStyle} from 'viewers/components/styles/viewer_card.styles';
 import {UiData} from './ui_data';
 
@@ -42,14 +42,17 @@ import {UiData} from './ui_data';
         [shadingModes]="shadingModes"
         [dependencies]="inputData?.dependencies ?? []"
         [userOptions]="inputData?.rectsUserOptions ?? {}"
+        [pinnedItems]="inputData?.pinnedItems ?? []"
+        [isDarkMode]="inputData?.isDarkMode ?? false"
         (collapseButtonClicked)="sections.onCollapseStateChange(CollapsibleSectionType.RECTS, true)"></rects-view>
       <hierarchy-view
         class="hierarchy-view"
         [class.collapsed]="sections.isSectionCollapsed(CollapsibleSectionType.HIERARCHY)"
-        [tree]="inputData?.hierarchyTrees[0]"
+        [tree]="inputData?.hierarchyTrees?.at(0)"
         [dependencies]="inputData?.dependencies ?? []"
         [highlightedItem]="inputData?.highlightedItem ?? ''"
         [pinnedItems]="inputData?.pinnedItems ?? []"
+        [textFilter]="inputData?.hierarchyFilter"
         [store]="store"
         [userOptions]="inputData?.hierarchyUserOptions ?? {}"
         [rectIdToShowState]="inputData?.rectIdToShowState"
@@ -60,6 +63,7 @@ import {UiData} from './ui_data';
         [userOptions]="inputData?.propertiesUserOptions ?? {}"
         [propertiesTree]="inputData?.propertiesTree"
         [traceType]="${TraceType.WINDOW_MANAGER}"
+        [textFilter]="inputData?.propertiesFilter"
         [highlightedProperty]="inputData?.highlightedProperty ?? ''"
         [store]="store"
         [isProtoDump]="false"
diff --git a/treble/compare_bp_system_image.sh b/treble/compare_bp_system_image.sh
index 7e8a736bd..d1fcdf49b 100755
--- a/treble/compare_bp_system_image.sh
+++ b/treble/compare_bp_system_image.sh
@@ -1,8 +1,7 @@
 #!/bin/bash
 echo "Note: Should run 'lunch aosp_cf_x86_64_only_phone-trunk_staging-userdebug && m aosp_cf_system_x86_64 && m' before running this script"
 bp_base_path=$ANDROID_BUILD_TOP/out/soong/.intermediates/device/google/cuttlefish/system_image/aosp_cf_system_x86_64/android_common
-latest_hash=$(ls $bp_base_path -t | head -1)
-bp_path=$bp_base_path/$latest_hash/root
+bp_path=$bp_base_path/root
 echo $OUT
 echo $bp_path
 compare_images -t $OUT $bp_path -s system -i
diff --git a/vndk/tools/elfcheck/bpflatten/main.go b/vndk/tools/elfcheck/bpflatten/main.go
index c4450b190..19ac368db 100644
--- a/vndk/tools/elfcheck/bpflatten/main.go
+++ b/vndk/tools/elfcheck/bpflatten/main.go
@@ -48,13 +48,13 @@ func populatePropertyMap(propMap map[string]interface{}, prefix string, m *parse
 		if prefix != "" {
 			name = prefix + "." + name
 		}
-		value := prop.Value.Eval()
+		value := prop.Value
 		if s, isScalar := expandScalarTypeExpression(value); isScalar {
 			propMap[name] = s
 		} else if list, ok := value.(*parser.List); ok {
 			var l []interface{}
 			for _, v := range list.Values {
-				if s, isScalar := expandScalarTypeExpression(v.Eval()); isScalar {
+				if s, isScalar := expandScalarTypeExpression(v); isScalar {
 					l = append(l, s)
 				}
 			}
@@ -70,7 +70,7 @@ var anonymousModuleCount int
 func flattenModule(module *parser.Module) (flattened FlatModule) {
 	flattened.Type = module.Type
 	if prop, found := module.GetProperty("name"); found {
-		if value, ok := prop.Value.Eval().(*parser.String); ok {
+		if value, ok := prop.Value.(*parser.String); ok {
 			flattened.Name = value.Value
 		}
 	} else {
diff --git a/vndk/tools/header-checker/Android.bp b/vndk/tools/header-checker/Android.bp
index 541f2064d..2d020d856 100644
--- a/vndk/tools/header-checker/Android.bp
+++ b/vndk/tools/header-checker/Android.bp
@@ -146,7 +146,6 @@ cc_library_host_static {
         "src/repr/json/converter.cpp",
         "src/repr/json/ir_dumper.cpp",
         "src/repr/json/ir_reader.cpp",
-        "src/repr/protobuf/converter.cpp",
         "src/repr/protobuf/ir_diff_dumper.cpp",
         "src/repr/protobuf/ir_dumper.cpp",
         "src/repr/protobuf/ir_reader.cpp",
diff --git a/vndk/tools/header-checker/android/build-prebuilts.sh b/vndk/tools/header-checker/android/build-prebuilts.sh
index f7abce27d..89ac89040 100755
--- a/vndk/tools/header-checker/android/build-prebuilts.sh
+++ b/vndk/tools/header-checker/android/build-prebuilts.sh
@@ -39,7 +39,6 @@ VALID_SOONG_BINARIES=(
     "ide_query_cc_analyzer"
     "proto_metadata_plugin"
     "protoc_extractor"
-    "versioner"
 )
 
 VALID_SOONG_TESTS=(
diff --git a/vndk/tools/header-checker/android/envsetup.sh b/vndk/tools/header-checker/android/envsetup.sh
index dba68fcb1..378376975 100644
--- a/vndk/tools/header-checker/android/envsetup.sh
+++ b/vndk/tools/header-checker/android/envsetup.sh
@@ -15,5 +15,5 @@
 # limitations under the License.
 
 export LLVM_BUILD_HOST_TOOLS=true
-export LLVM_PREBUILTS_VERSION=clang-r510928
-export LLVM_RELEASE_VERSION=18
+export LLVM_PREBUILTS_VERSION=clang-r530567
+export LLVM_RELEASE_VERSION=19
diff --git a/vndk/tools/header-checker/src/diff/header_abi_diff.cpp b/vndk/tools/header-checker/src/diff/header_abi_diff.cpp
index 31d9e8ddf..62476ec6b 100644
--- a/vndk/tools/header-checker/src/diff/header_abi_diff.cpp
+++ b/vndk/tools/header-checker/src/diff/header_abi_diff.cpp
@@ -215,6 +215,10 @@ static std::string GetErrorMessage(CompatibilityStatusIR status) {
   if (!allow_extensions && (status & CompatibilityStatusIR::Extension)) {
     return "EXTENDING CHANGES";
   }
+  if (!allow_extensions && !allow_unreferenced_elf_symbol_changes &&
+      (status & CompatibilityStatusIR::ElfExtension)) {
+    return "ELF Symbols not referenced by exported headers added";
+  }
   if (!allow_unreferenced_changes &&
       (status & CompatibilityStatusIR::UnreferencedChanges)) {
     return "changes in exported headers, which are not directly referenced "
diff --git a/vndk/tools/header-checker/src/dumper/abi_wrappers.cpp b/vndk/tools/header-checker/src/dumper/abi_wrappers.cpp
index 24749e7fe..db5503661 100644
--- a/vndk/tools/header-checker/src/dumper/abi_wrappers.cpp
+++ b/vndk/tools/header-checker/src/dumper/abi_wrappers.cpp
@@ -140,6 +140,32 @@ bool ABIWrapper::SetupFunctionParameter(
   return true;
 }
 
+void ABIWrapper::SetupAvailabilityAttrs(repr::HasAvailabilityAttrs *decl_ir,
+                                        const clang::Decl *decl) {
+  for (const clang::AvailabilityAttr *attr :
+       decl->specific_attrs<clang::AvailabilityAttr>()) {
+    if (attr->getPlatform()->getName() !=
+        ast_contextp_->getTargetInfo().getPlatformName()) {
+      continue;
+    }
+    repr::AvailabilityAttrIR attr_ir;
+    clang::VersionTuple introduced = attr->getIntroduced();
+    if (!introduced.empty()) {
+      attr_ir.SetIntroduced(introduced.getMajor());
+    }
+    clang::VersionTuple deprecated = attr->getDeprecated();
+    if (!deprecated.empty()) {
+      attr_ir.SetDeprecated(deprecated.getMajor());
+    }
+    clang::VersionTuple obsoleted = attr->getObsoleted();
+    if (!obsoleted.empty()) {
+      attr_ir.SetObsoleted(obsoleted.getMajor());
+    }
+    attr_ir.SetUnavailable(attr->getUnavailable());
+    decl_ir->AddAvailabilityAttr(std::move(attr_ir));
+  }
+}
+
 static const clang::RecordDecl *GetAnonymousRecord(clang::QualType type) {
   const clang::Type *type_ptr = type.getTypePtr();
   assert(type_ptr != nullptr);
@@ -233,7 +259,7 @@ static std::string GetAnonymousEnumUniqueId(llvm::StringRef mangled_name,
     const std::ssub_match &old_name = match_result[1];
     old_suffix = std::to_string(old_name.length()) + match_result[0].str();
     nested_name_suffix = match_result[2].str();
-    if (!mangled_name.endswith(old_suffix)) {
+    if (!mangled_name.ends_with(old_suffix)) {
       llvm::errs() << "Unexpected length of anonymous enum type name: "
                    << mangled_name << "\n";
       ::exit(1);
@@ -543,6 +569,7 @@ bool FunctionDeclWrapper::SetupFunction(repr::FunctionIR *functionp,
 
   functionp->SetReturnType(GetTypeUniqueId(return_type));
   functionp->SetAccess(AccessClangToIR(function_decl_->getAccess()));
+  SetupAvailabilityAttrs(functionp, function_decl_);
   return CreateBasicNamedAndTypedDecl(return_type, source_file) &&
       SetupFunctionParameters(functionp, source_file) &&
       SetupTemplateInfo(functionp, source_file);
@@ -607,9 +634,11 @@ bool RecordDeclWrapper::SetupRecordFields(repr::RecordTypeIR *recordp,
     uint64_t field_offset = record_layout.getFieldOffset(field_index);
     uint64_t bit_width =
         field->isBitField() ? field->getBitWidthValue(*ast_contextp_) : 0;
-    recordp->AddRecordField(repr::RecordFieldIR(
+    repr::RecordFieldIR record_field_ir(
         field_name, GetTypeUniqueId(field_type), field_offset,
-        AccessClangToIR(field->getAccess()), field->isBitField(), bit_width));
+        AccessClangToIR(field->getAccess()), field->isBitField(), bit_width);
+    SetupAvailabilityAttrs(&record_field_ir, *field);
+    recordp->AddRecordField(std::move(record_field_ir));
     field++;
     field_index++;
   }
@@ -720,7 +749,7 @@ repr::VTableComponentIR RecordDeclWrapper::SetupRecordVTableComponent(
         const clang::CXXMethodDecl *method_decl =
             vtable_component.getFunctionDecl();
         assert(method_decl != nullptr);
-        is_pure = method_decl->isPure();
+        is_pure = method_decl->isPureVirtual();
         switch (clang_component_kind) {
           case clang::VTableComponent::CK_FunctionPointer:
             kind = repr::VTableComponentIR::Kind::FunctionPointer;
@@ -819,6 +848,7 @@ bool RecordDeclWrapper::SetupRecordInfo(repr::RecordTypeIR *record_declp,
     record_declp->SetAnonymity(true);
   }
   record_declp->SetAccess(AccessClangToIR(record_decl_->getAccess()));
+  SetupAvailabilityAttrs(record_declp, record_decl_);
   return SetupRecordFields(record_declp, source_file) &&
       SetupCXXRecordInfo(record_declp, source_file);
 }
@@ -883,13 +913,16 @@ bool EnumDeclWrapper::SetupEnumFields(repr::EnumTypeIR *enump) {
   }
   clang::EnumDecl::enumerator_iterator enum_it = enum_decl_->enumerator_begin();
   while (enum_it != enum_decl_->enumerator_end()) {
-    std::string name = enum_it->getQualifiedNameAsString();
+    repr::EnumFieldIR enum_field_ir;
+    enum_field_ir.SetName(enum_it->getQualifiedNameAsString());
     const llvm::APSInt &value = enum_it->getInitVal();
     if (value.isUnsigned()) {
-      enump->AddEnumField(repr::EnumFieldIR(name, value.getZExtValue()));
+      enum_field_ir.SetUnsignedValue(value.getZExtValue());
     } else {
-      enump->AddEnumField(repr::EnumFieldIR(name, value.getSExtValue()));
+      enum_field_ir.SetSignedValue(value.getSExtValue());
     }
+    SetupAvailabilityAttrs(&enum_field_ir, *enum_it);
+    enump->AddEnumField(std::move(enum_field_ir));
     enum_it++;
   }
   return true;
@@ -905,6 +938,7 @@ bool EnumDeclWrapper::SetupEnum(repr::EnumTypeIR *enum_type,
   enum_type->SetSourceFile(source_file);
   enum_type->SetUnderlyingType(GetTypeUniqueId(enum_decl_->getIntegerType()));
   enum_type->SetAccess(AccessClangToIR(enum_decl_->getAccess()));
+  SetupAvailabilityAttrs(enum_type, enum_decl_);
   return SetupEnumFields(enum_type) &&
       CreateBasicNamedAndTypedDecl(enum_decl_->getIntegerType(), "");
 }
@@ -949,6 +983,7 @@ bool GlobalVarDeclWrapper::SetupGlobalVar(repr::GlobalVarIR *global_varp,
   global_varp->SetLinkerSetKey(mangled_name);
   global_varp->SetAccess(AccessClangToIR(global_var_decl_->getAccess()));
   global_varp->SetReferencedType(GetTypeUniqueId(global_var_decl_->getType()));
+  SetupAvailabilityAttrs(global_varp, global_var_decl_);
   return true;
 }
 
diff --git a/vndk/tools/header-checker/src/dumper/abi_wrappers.h b/vndk/tools/header-checker/src/dumper/abi_wrappers.h
index b2a039ef1..d4d6044e0 100644
--- a/vndk/tools/header-checker/src/dumper/abi_wrappers.h
+++ b/vndk/tools/header-checker/src/dumper/abi_wrappers.h
@@ -65,7 +65,6 @@ class ABIWrapper {
                               repr::TemplatedArtifactIR *ta,
                               const std::string &source_file);
 
- protected:
   // Shared between FunctionTypeWrapper and FunctionDeclWrapper.
   bool SetupFunctionParameter(repr::CFunctionLikeIR *functionp,
                               const clang::QualType qual_type,
@@ -73,6 +72,11 @@ class ABIWrapper {
                               const std::string &source_file,
                               bool is_this_parameter = false);
 
+  // Shared between FunctionDeclWrapper, GlobalVarDeclWrapper,
+  // RecordDeclWrapper, and EnumDeclWrapper.
+  void SetupAvailabilityAttrs(repr::HasAvailabilityAttrs *decl_ir,
+                              const clang::Decl *decl);
+
  protected:
   // Type-related functions
   std::string GetTypeUniqueId(clang::QualType qual_type);
diff --git a/vndk/tools/header-checker/src/dumper/ast_processing.cpp b/vndk/tools/header-checker/src/dumper/ast_processing.cpp
index 1cf094e6c..2e92e386a 100644
--- a/vndk/tools/header-checker/src/dumper/ast_processing.cpp
+++ b/vndk/tools/header-checker/src/dumper/ast_processing.cpp
@@ -115,7 +115,7 @@ bool HeaderASTVisitor::ShouldSkipFunctionDecl(const clang::FunctionDecl *decl) {
     return true;
   }
   if (decl->getLinkageAndVisibility().getLinkage() !=
-      clang::Linkage::ExternalLinkage) {
+      clang::Linkage::External) {
     return true;
   }
   if (const clang::CXXMethodDecl *method_decl =
diff --git a/vndk/tools/header-checker/src/linker/header_abi_linker.cpp b/vndk/tools/header-checker/src/linker/header_abi_linker.cpp
index 3ca3b0715..44a559ffc 100644
--- a/vndk/tools/header-checker/src/linker/header_abi_linker.cpp
+++ b/vndk/tools/header-checker/src/linker/header_abi_linker.cpp
@@ -119,9 +119,15 @@ static llvm::cl::opt<std::string> arch(
     "arch", llvm::cl::desc("<arch>"), llvm::cl::Optional,
     llvm::cl::cat(header_linker_category));
 
+static llvm::cl::opt<std::string> availability_arg(
+    "availability",
+    llvm::cl::desc("Specify the version to filter the ABI annotated with "
+                   "availability attributes."),
+    llvm::cl::Optional, llvm::cl::cat(header_linker_category));
+
 static llvm::cl::opt<bool> no_filter(
-    "no-filter", llvm::cl::desc("Do not filter any abi"), llvm::cl::Optional,
-    llvm::cl::cat(header_linker_category));
+    "no-filter", llvm::cl::desc("Do not filter any ABI by exported headers."),
+    llvm::cl::Optional, llvm::cl::cat(header_linker_category));
 
 static llvm::cl::opt<std::string> so_file(
     "so", llvm::cl::desc("<path to so file>"), llvm::cl::Optional,
@@ -155,12 +161,14 @@ class HeaderAbiLinker {
                   const std::vector<std::string> &exported_header_dirs,
                   repr::VersionScriptParser &version_script_parser,
                   const std::string &version_script, const std::string &so_file,
+                  std::optional<utils::ApiLevel> availability,
                   const std::string &linked_dump)
       : dump_files_(dump_files),
         exported_header_dirs_(exported_header_dirs),
         version_script_parser_(version_script_parser),
         version_script_(version_script),
         so_file_(so_file),
+        availability_(availability),
         out_dump_name_(linked_dump) {}
 
   bool LinkAndDump();
@@ -207,6 +215,7 @@ class HeaderAbiLinker {
   repr::VersionScriptParser &version_script_parser_;
   const std::string &version_script_;
   const std::string &so_file_;
+  const std::optional<utils::ApiLevel> availability_;
   const std::string &out_dump_name_;
 
   std::set<std::string> exported_headers_;
@@ -221,11 +230,15 @@ static void DeDuplicateAbiElementsThread(
     std::vector<std::string>::const_iterator dump_files_begin,
     std::vector<std::string>::const_iterator dump_files_end,
     const std::set<std::string> *exported_headers,
-    linker::ModuleMerger *merger) {
+    std::optional<utils::ApiLevel> availability, linker::ModuleMerger *merger) {
   for (auto it = dump_files_begin; it != dump_files_end; it++) {
-    std::unique_ptr<repr::IRReader> reader =
-        repr::IRReader::CreateIRReader(input_format, exported_headers);
-    assert(reader != nullptr);
+    std::unique_ptr<repr::IRReader> reader = repr::IRReader::CreateIRReader(
+        input_format,
+        std::make_unique<repr::ModuleIR>(exported_headers, availability));
+    if (reader == nullptr) {
+      llvm::errs() << "Failed to create IRReader for " << input_format << "\n";
+      ::exit(1);
+    }
     if (!reader->ReadDump(*it)) {
       llvm::errs() << "ReadDump failed\n";
       ::exit(1);
@@ -235,8 +248,8 @@ static void DeDuplicateAbiElementsThread(
 }
 
 std::unique_ptr<linker::ModuleMerger> HeaderAbiLinker::ReadInputDumpFiles() {
-  std::unique_ptr<linker::ModuleMerger> merger(
-      new linker::ModuleMerger(&exported_headers_));
+  std::unique_ptr<linker::ModuleMerger> merger =
+      std::make_unique<linker::ModuleMerger>();
   std::size_t max_threads = std::thread::hardware_concurrency();
   std::size_t num_threads = std::max<std::size_t>(
       std::min(dump_files_.size() / sources_per_thread, max_threads), 1);
@@ -252,11 +265,11 @@ std::unique_ptr<linker::ModuleMerger> HeaderAbiLinker::ReadInputDumpFiles() {
     if (i == 0) {
       first_end_index = cnt;
     } else {
-      thread_mergers.emplace_back(&exported_headers_);
-      threads.emplace_back(DeDuplicateAbiElementsThread,
-                           dump_files_.begin() + dump_files_index,
-                           dump_files_.begin() + dump_files_index + cnt,
-                           &exported_headers_, &thread_mergers.back());
+      thread_mergers.emplace_back();
+      threads.emplace_back(
+          DeDuplicateAbiElementsThread, dump_files_.begin() + dump_files_index,
+          dump_files_.begin() + dump_files_index + cnt, &exported_headers_,
+          availability_, &thread_mergers.back());
     }
     dump_files_index += cnt;
   }
@@ -264,7 +277,7 @@ std::unique_ptr<linker::ModuleMerger> HeaderAbiLinker::ReadInputDumpFiles() {
 
   DeDuplicateAbiElementsThread(dump_files_.begin(),
                                dump_files_.begin() + first_end_index,
-                               &exported_headers_, merger.get());
+                               &exported_headers_, availability_, merger.get());
 
   for (std::size_t i = 0; i < threads.size(); i++) {
     threads[i].join();
@@ -291,16 +304,15 @@ bool HeaderAbiLinker::LinkAndDump() {
   const repr::ModuleIR &module = merger->GetModule();
 
   // Link input ABI dumps.
-  std::unique_ptr<repr::ModuleIR> linked_module(
-      new repr::ModuleIR(&exported_headers_));
+  repr::ModuleIR linked_module;
 
-  if (!LinkExportedSymbols(linked_module.get())) {
+  if (!LinkExportedSymbols(&linked_module)) {
     return false;
   }
 
-  if (!LinkTypes(module, linked_module.get()) ||
-      !LinkFunctions(module, linked_module.get()) ||
-      !LinkGlobalVars(module, linked_module.get())) {
+  if (!LinkTypes(module, &linked_module) ||
+      !LinkFunctions(module, &linked_module) ||
+      !LinkGlobalVars(module, &linked_module)) {
     llvm::errs() << "Failed to link elements\n";
     return false;
   }
@@ -309,7 +321,7 @@ bool HeaderAbiLinker::LinkAndDump() {
   std::unique_ptr<repr::IRDumper> ir_dumper =
       repr::IRDumper::CreateIRDumper(output_format, out_dump_name_);
   assert(ir_dumper != nullptr);
-  if (!ir_dumper->Dump(*linked_module)) {
+  if (!ir_dumper->Dump(linked_module)) {
     llvm::errs() << "Failed to serialize the linked output to ostream\n";
     return false;
   }
@@ -473,8 +485,7 @@ bool HeaderAbiLinker::ReadExportedSymbolsFromSharedObjectFile() {
   return true;
 }
 
-static bool InitializeVersionScriptParser(repr::VersionScriptParser &parser) {
-  utils::ApiLevelMap api_level_map;
+static bool LoadApiLevelMap(utils::ApiLevelMap &api_level_map) {
   if (!api_map.empty()) {
     std::ifstream stream(api_map);
     if (!stream) {
@@ -486,17 +497,15 @@ static bool InitializeVersionScriptParser(repr::VersionScriptParser &parser) {
       return false;
     }
   }
+  return true;
+}
 
-  std::optional<utils::ApiLevel> api_level = api_level_map.Parse(api);
-  if (!api_level) {
-    llvm::errs() << "-api must be \"current\", an integer, or a codename in "
-                    "-api-map\n";
-    return false;
-  }
-
+static bool InitializeVersionScriptParser(repr::VersionScriptParser &parser,
+                                          utils::ApiLevel api_level,
+                                          utils::ApiLevelMap &&api_level_map) {
   parser.SetArch(arch);
-  parser.SetApiLevel(api_level.value());
-  parser.SetApiLevelMap(api_level_map);
+  parser.SetApiLevel(api_level);
+  parser.SetApiLevelMap(std::move(api_level_map));
   for (auto &&version : excluded_symbol_versions) {
     parser.AddExcludedSymbolVersion(version);
   }
@@ -523,8 +532,30 @@ int main(int argc, const char **argv) {
     return -1;
   }
 
+  utils::ApiLevelMap api_level_map;
+  if (!LoadApiLevelMap(api_level_map)) {
+    return -1;
+  }
+
+  std::optional<utils::ApiLevel> api_level = api_level_map.Parse(api);
+  if (!api_level) {
+    llvm::errs() << "-api must be \"current\", an integer, or a codename in "
+                    "-api-map\n";
+    return -1;
+  }
+
+  std::optional<utils::ApiLevel> availability;
+  if (!availability_arg.empty()) {
+    availability = api_level_map.Parse(availability_arg);
+    if (!availability) {
+      llvm::errs() << "-availability must be \"current\", an integer, or a "
+                      "codename in -api-map\n";
+    }
+  }
+
   repr::VersionScriptParser version_script_parser;
-  if (!InitializeVersionScriptParser(version_script_parser)) {
+  if (!InitializeVersionScriptParser(version_script_parser, api_level.value(),
+                                     std::move(api_level_map))) {
     return -1;
   }
 
@@ -532,11 +563,11 @@ int main(int argc, const char **argv) {
     static_cast<std::vector<std::string> &>(exported_header_dirs).clear();
   }
 
-  HeaderAbiLinker Linker(dump_files, exported_header_dirs,
+  HeaderAbiLinker linker(dump_files, exported_header_dirs,
                          version_script_parser, version_script, so_file,
-                         linked_dump);
+                         availability, linked_dump);
 
-  if (!Linker.LinkAndDump()) {
+  if (!linker.LinkAndDump()) {
     llvm::errs() << "Failed to link and dump elements\n";
     return -1;
   }
diff --git a/vndk/tools/header-checker/src/linker/module_merger.h b/vndk/tools/header-checker/src/linker/module_merger.h
index b49305feb..e9f66b4e7 100644
--- a/vndk/tools/header-checker/src/linker/module_merger.h
+++ b/vndk/tools/header-checker/src/linker/module_merger.h
@@ -40,12 +40,9 @@ public:
 
 class ModuleMerger {
 public:
-  ModuleMerger(const std::set<std::string> *exported_headers)
-      : module_(new repr::ModuleIR(exported_headers)) {}
+  ModuleMerger() : module_(std::make_unique<repr::ModuleIR>()) {}
 
-  const repr::ModuleIR &GetModule() {
-    return *module_;
-  }
+  const repr::ModuleIR &GetModule() { return *module_; }
 
   void MergeGraphs(const repr::ModuleIR &addend);
 
diff --git a/vndk/tools/header-checker/src/repr/abi_diff_helpers.cpp b/vndk/tools/header-checker/src/repr/abi_diff_helpers.cpp
index 9c4f20c7d..c00d21875 100644
--- a/vndk/tools/header-checker/src/repr/abi_diff_helpers.cpp
+++ b/vndk/tools/header-checker/src/repr/abi_diff_helpers.cpp
@@ -357,6 +357,23 @@ DiffStatus AbiDiffHelper::CompareAccess(AccessSpecifierIR old_access,
   return DiffStatus::kDirectDiff;
 }
 
+// This function returns a map from field names to RecordFieldIR.
+// It appends anonymous fields to anonymous_fields.
+static AbiElementMap<const RecordFieldIR *> BuildRecordFieldNameMap(
+    const std::vector<RecordFieldIR> &fields,
+    std::vector<const RecordFieldIR *> &anonymous_fields) {
+  AbiElementMap<const RecordFieldIR *> field_map;
+  for (const RecordFieldIR &field : fields) {
+    const std::string &name = field.GetName();
+    if (name.empty()) {
+      anonymous_fields.emplace_back(&field);
+    } else {
+      field_map.emplace(name, &field);
+    }
+  }
+  return field_map;
+}
+
 DiffStatus AbiDiffHelper::CompareCommonRecordFields(
     const RecordFieldIR *old_field, const RecordFieldIR *new_field,
     DiffMessageIR::DiffKind diff_kind) {
@@ -376,6 +393,27 @@ DiffStatus AbiDiffHelper::CompareCommonRecordFields(
   return field_diff_status;
 }
 
+// FilterOutRenamedRecordFields calls this function to compare record fields in
+// two dumps.
+// If this function returns 0, the fields may be compatible.
+// If it returns -1 or 1, the fields must be incompatible.
+static int CompareRenamedRecordFields(const RecordFieldIR *old_field,
+                                      const RecordFieldIR *new_field) {
+  if (old_field->GetOffset() != new_field->GetOffset()) {
+    return old_field->GetOffset() < new_field->GetOffset() ? -1 : 1;
+  }
+  if (old_field->IsBitField() != new_field->IsBitField()) {
+    return old_field->IsBitField() < new_field->IsBitField() ? -1 : 1;
+  }
+  if (old_field->GetBitWidth() != new_field->GetBitWidth()) {
+    return old_field->GetBitWidth() < new_field->GetBitWidth() ? -1 : 1;
+  }
+  // Skip GetReferencedType because the same type in old and new dumps may have
+  // different IDs, especially in the cases of anonymous types and multiple
+  // definitions.
+  return 0;
+}
+
 // This function filters out the pairs of old and new fields that meet the
 // following conditions:
 //   The old field's (offset, bit width, type) is unique in old_fields.
@@ -391,17 +429,12 @@ DiffStatus AbiDiffHelper::FilterOutRenamedRecordFields(
   DiffStatus diff_status = DiffStatus::kNoDiff;
   const auto old_end = old_fields.end();
   const auto new_end = new_fields.end();
+  // Sort fields by (offset, bit width, type).
   auto is_less = [](const RecordFieldIR *first, const RecordFieldIR *second) {
-    if (first->GetOffset() != second->GetOffset()) {
-      return first->GetOffset() < second->GetOffset();
-    }
-    if (first->IsBitField() != second->IsBitField()) {
-      return first->IsBitField() < second->IsBitField();
-    }
-    if (first->GetBitWidth() != second->GetBitWidth()) {
-      return first->GetBitWidth() < second->GetBitWidth();
-    }
-    return first->GetReferencedType() < second->GetReferencedType();
+    int result = CompareRenamedRecordFields(first, second);
+    return result != 0
+               ? result < 0
+               : first->GetReferencedType() < second->GetReferencedType();
   };
   std::sort(old_fields.begin(), old_end, is_less);
   std::sort(new_fields.begin(), new_end, is_less);
@@ -411,11 +444,12 @@ DiffStatus AbiDiffHelper::FilterOutRenamedRecordFields(
   auto old_it = old_fields.begin();
   auto new_it = new_fields.begin();
   while (old_it != old_end && new_it != new_end) {
+    int old_new_cmp = CompareRenamedRecordFields(*old_it, *new_it);
     auto next_old_it = std::next(old_it);
     while (next_old_it != old_end && !is_less(*old_it, *next_old_it)) {
       next_old_it++;
     }
-    if (is_less(*old_it, *new_it) || next_old_it - old_it > 1) {
+    if (old_new_cmp < 0 || next_old_it - old_it > 1) {
       out_old_fields.insert(out_old_fields.end(), old_it, next_old_it);
       old_it = next_old_it;
       continue;
@@ -425,7 +459,7 @@ DiffStatus AbiDiffHelper::FilterOutRenamedRecordFields(
     while (next_new_it != new_end && !is_less(*new_it, *next_new_it)) {
       next_new_it++;
     }
-    if (is_less(*new_it, *old_it) || next_new_it - new_it > 1) {
+    if (old_new_cmp > 0 || next_new_it - new_it > 1) {
       out_new_fields.insert(out_new_fields.end(), new_it, next_new_it);
       new_it = next_new_it;
       continue;
@@ -457,25 +491,17 @@ RecordFieldDiffResult AbiDiffHelper::CompareRecordFields(
   RecordFieldDiffResult result;
   DiffStatus &diff_status = result.status;
   diff_status = DiffStatus::kNoDiff;
-  // Map names to RecordFieldIR.
-  AbiElementMap<const RecordFieldIR *> old_fields_map;
-  AbiElementMap<const RecordFieldIR *> new_fields_map;
-
-  auto get_field_name = [](const RecordFieldIR *f) -> std::string {
-    return !f->GetName().empty()
-               ? f->GetName()
-               : std::to_string(f->GetOffset()) + "#" + f->GetReferencedType();
-  };
-
-  utils::AddToMap(&old_fields_map, old_fields, get_field_name,
-                  [](const RecordFieldIR *f) { return f; });
-  utils::AddToMap(&new_fields_map, new_fields, get_field_name,
-                  [](const RecordFieldIR *f) { return f; });
-  // Compare the fields whose names are not present in both records.
-  result.removed_fields =
-      utils::FindRemovedElements(old_fields_map, new_fields_map);
-  result.added_fields =
-      utils::FindRemovedElements(new_fields_map, old_fields_map);
+  AbiElementMap<const RecordFieldIR *> old_fields_map =
+      BuildRecordFieldNameMap(old_fields, result.removed_fields);
+  AbiElementMap<const RecordFieldIR *> new_fields_map =
+      BuildRecordFieldNameMap(new_fields, result.added_fields);
+
+  // Compare the anonymous fields and the fields whose names are not present in
+  // both records.
+  utils::InsertAll(result.removed_fields,
+                   utils::FindRemovedElements(old_fields_map, new_fields_map));
+  utils::InsertAll(result.added_fields,
+                   utils::FindRemovedElements(new_fields_map, old_fields_map));
   diff_status.CombineWith(FilterOutRenamedRecordFields(
       diff_kind, result.removed_fields, result.added_fields));
   if (result.removed_fields.size() != 0) {
diff --git a/vndk/tools/header-checker/src/repr/ir_reader.cpp b/vndk/tools/header-checker/src/repr/ir_reader.cpp
index 04de74264..806849eef 100644
--- a/vndk/tools/header-checker/src/repr/ir_reader.cpp
+++ b/vndk/tools/header-checker/src/repr/ir_reader.cpp
@@ -30,21 +30,22 @@ namespace header_checker {
 namespace repr {
 
 
-std::unique_ptr<IRReader>
-IRReader::CreateIRReader(
-    TextFormatIR text_format, const std::set<std::string> *exported_headers) {
+std::unique_ptr<IRReader> IRReader::CreateIRReader(
+    TextFormatIR text_format, std::unique_ptr<ModuleIR> module_ir) {
+  if (module_ir == nullptr) {
+    module_ir = std::make_unique<ModuleIR>();
+  }
   switch (text_format) {
     case TextFormatIR::ProtobufTextFormat:
-      return CreateProtobufIRReader(exported_headers);
+      return CreateProtobufIRReader(std::move(module_ir));
     case TextFormatIR::Json:
-      return CreateJsonIRReader(exported_headers);
+      return CreateJsonIRReader(std::move(module_ir));
     default:
       llvm::errs() << "Text format not supported yet\n";
       return nullptr;
   }
 }
 
-
 bool IRReader::ReadDump(const std::string &dump_file) {
   module_->SetCompilationUnitPath(dump_file);
   return ReadDumpImpl(dump_file);
diff --git a/vndk/tools/header-checker/src/repr/ir_reader.h b/vndk/tools/header-checker/src/repr/ir_reader.h
index ecd64bbf3..7cd74a73a 100644
--- a/vndk/tools/header-checker/src/repr/ir_reader.h
+++ b/vndk/tools/header-checker/src/repr/ir_reader.h
@@ -18,7 +18,6 @@
 #include "repr/ir_representation.h"
 
 #include <memory>
-#include <set>
 #include <string>
 
 
@@ -28,24 +27,19 @@ namespace repr {
 
 class IRReader {
  public:
+  // Construct an IRReader that loads a dump file to module_ir.
+  // If module_ir is nullptr, create a ModuleIR with the default constructor.
   static std::unique_ptr<IRReader> CreateIRReader(
-      TextFormatIR text_format,
-      const std::set<std::string> *exported_headers = nullptr);
+      TextFormatIR text_format, std::unique_ptr<ModuleIR> module_ir = nullptr);
 
-  IRReader(const std::set<std::string> *exported_headers)
-      : module_(new ModuleIR(exported_headers)) {}
+  IRReader(std::unique_ptr<ModuleIR> module_ir)
+      : module_(std::move(module_ir)) {}
 
   virtual ~IRReader() {}
 
   bool ReadDump(const std::string &dump_file);
 
-  ModuleIR &GetModule() {
-    return *module_;
-  }
-
-  std::unique_ptr<ModuleIR> TakeModule() {
-    return std::move(module_);
-  }
+  const ModuleIR &GetModule() const { return *module_; }
 
  private:
   virtual bool ReadDumpImpl(const std::string &dump_file) = 0;
diff --git a/vndk/tools/header-checker/src/repr/ir_representation.cpp b/vndk/tools/header-checker/src/repr/ir_representation.cpp
index 6f512fdaa..80fb5a7df 100644
--- a/vndk/tools/header-checker/src/repr/ir_representation.cpp
+++ b/vndk/tools/header-checker/src/repr/ir_representation.cpp
@@ -86,7 +86,8 @@ bool ModuleIR::AddElfSymbol(const ElfSymbolIR &elf_symbol) {
 
 
 void ModuleIR::AddFunction(FunctionIR &&function) {
-  if (!IsLinkableMessageInExportedHeaders(&function)) {
+  if (!IsLinkableMessageInExportedHeaders(&function) ||
+      !IsAvailable(function)) {
     return;
   }
   functions_.insert({function.GetLinkerSetKey(), std::move(function)});
@@ -94,7 +95,8 @@ void ModuleIR::AddFunction(FunctionIR &&function) {
 
 
 void ModuleIR::AddGlobalVariable(GlobalVarIR &&global_var) {
-  if (!IsLinkableMessageInExportedHeaders(&global_var)) {
+  if (!IsLinkableMessageInExportedHeaders(&global_var) ||
+      !IsAvailable(global_var)) {
     return;
   }
   global_variables_.insert(
@@ -102,10 +104,26 @@ void ModuleIR::AddGlobalVariable(GlobalVarIR &&global_var) {
 }
 
 
+void ModuleIR::FilterRecordFields(RecordTypeIR &record_type) const {
+  if (!availability_.has_value()) {
+    return;
+  }
+  std::vector<RecordFieldIR> new_fields;
+  for (const RecordFieldIR &field : record_type.GetFields()) {
+    if (IsAvailable(field)) {
+      new_fields.emplace_back(field);
+    }
+  }
+  record_type.SetRecordFields(std::move(new_fields));
+}
+
+
 void ModuleIR::AddRecordType(RecordTypeIR &&record_type) {
-  if (!IsLinkableMessageInExportedHeaders(&record_type)) {
+  if (!IsLinkableMessageInExportedHeaders(&record_type) ||
+      !IsAvailable(record_type)) {
     return;
   }
+  FilterRecordFields(record_type);
   auto it = AddToMapAndTypeGraph(
       std::move(record_type), &record_types_, &type_graph_);
   const std::string &key = GetODRListMapKey(&(it->second));
@@ -124,10 +142,26 @@ void ModuleIR::AddFunctionType(FunctionTypeIR &&function_type) {
 }
 
 
+void ModuleIR::FilterEnumFields(EnumTypeIR &enum_type) const {
+  if (!availability_.has_value()) {
+    return;
+  }
+  std::vector<EnumFieldIR> new_fields;
+  for (const EnumFieldIR &field : enum_type.GetFields()) {
+    if (IsAvailable(field)) {
+      new_fields.emplace_back(field);
+    }
+  }
+  enum_type.SetFields(std::move(new_fields));
+}
+
+
 void ModuleIR::AddEnumType(EnumTypeIR &&enum_type) {
-  if (!IsLinkableMessageInExportedHeaders(&enum_type)) {
+  if (!IsLinkableMessageInExportedHeaders(&enum_type) ||
+      !IsAvailable(enum_type)) {
     return;
   }
+  FilterEnumFields(enum_type);
   auto it = AddToMapAndTypeGraph(
       std::move(enum_type), &enum_types_, &type_graph_);
   const std::string &key = GetODRListMapKey(&(it->second));
@@ -235,5 +269,26 @@ bool ModuleIR::IsLinkableMessageInExportedHeaders(
 }
 
 
+bool ModuleIR::IsAvailable(const HasAvailabilityAttrs &decl_ir) const {
+  if (!availability_.has_value()) {
+    return true;
+  }
+  for (const AvailabilityAttrIR &attr : decl_ir.GetAvailabilityAttrs()) {
+    if (attr.IsUnavailable()) {
+      return false;
+    }
+    if (auto introduced = attr.GetIntroduced();
+        introduced.has_value() && availability_.value() < introduced.value()) {
+      return false;
+    }
+    if (auto obsoleted = attr.GetObsoleted();
+        obsoleted.has_value() && availability_.value() >= obsoleted.value()) {
+      return false;
+    }
+  }
+  return true;
+}
+
+
 }  // namespace repr
 }  // namespace header_checker
diff --git a/vndk/tools/header-checker/src/repr/ir_representation.h b/vndk/tools/header-checker/src/repr/ir_representation.h
index 731af2753..973881906 100644
--- a/vndk/tools/header-checker/src/repr/ir_representation.h
+++ b/vndk/tools/header-checker/src/repr/ir_representation.h
@@ -15,9 +15,12 @@
 #ifndef IR_REPRESENTATION_H_
 #define IR_REPRESENTATION_H_
 
+#include "utils/api_level.h"
+
 #include <list>
 #include <map>
 #include <memory>
+#include <optional>
 #include <set>
 #include <string>
 #include <unordered_map>
@@ -44,9 +47,14 @@ enum TextFormatIR {
 
 enum CompatibilityStatusIR {
   Compatible = 0,
+  // Changing classes or enums not referenced by functions or variables.
   UnreferencedChanges = 1,
+  // Adding symbols.
+  ElfExtension = 2,
+  // Adding functions, classes, class members, etc.
   Extension = 4,
   Incompatible = 8,
+  // Removing symbols.
   ElfIncompatible = 16
 };
 
@@ -155,6 +163,45 @@ class ReferencesOtherType {
   std::string referenced_type_;
 };
 
+class AvailabilityAttrIR {
+ public:
+  void SetIntroduced(uint32_t version) { introduced_major_ = version; }
+
+  std::optional<uint32_t> GetIntroduced() const { return introduced_major_; }
+
+  void SetDeprecated(uint32_t version) { deprecated_major_ = version; }
+
+  std::optional<uint32_t> GetDeprecated() const { return deprecated_major_; }
+
+  void SetObsoleted(uint32_t version) { obsoleted_major_ = version; }
+
+  std::optional<uint32_t> GetObsoleted() const { return obsoleted_major_; }
+
+  void SetUnavailable(bool unavailable) { unavailable_ = unavailable; }
+
+  bool IsUnavailable() const { return unavailable_; }
+
+ private:
+  std::optional<uint32_t> introduced_major_;
+  std::optional<uint32_t> deprecated_major_;
+  std::optional<uint32_t> obsoleted_major_;
+  bool unavailable_ = false;
+};
+
+class HasAvailabilityAttrs {
+ public:
+  void AddAvailabilityAttr(AvailabilityAttrIR &&attr) {
+    availability_attrs_.emplace_back(std::move(attr));
+  }
+
+  const std::vector<AvailabilityAttrIR> &GetAvailabilityAttrs() const {
+    return availability_attrs_;
+  }
+
+ private:
+  std::vector<AvailabilityAttrIR> availability_attrs_;
+};
+
 // TODO: Break this up into types with sizes and those without types?
 class TypeIR : public LinkableMessageIR, public ReferencesOtherType {
  public:
@@ -327,7 +374,7 @@ class TemplatedArtifactIR {
   TemplateInfoIR template_info_;
 };
 
-class RecordFieldIR : public ReferencesOtherType {
+class RecordFieldIR : public ReferencesOtherType, public HasAvailabilityAttrs {
  public:
   RecordFieldIR(const std::string &name, const std::string &type,
                 uint64_t offset, AccessSpecifierIR access, bool is_bit_field,
@@ -365,7 +412,9 @@ class RecordFieldIR : public ReferencesOtherType {
   uint64_t bit_width_ = 0;
 };
 
-class RecordTypeIR : public TypeIR, public TemplatedArtifactIR {
+class RecordTypeIR : public TypeIR,
+                     public TemplatedArtifactIR,
+                     public HasAvailabilityAttrs {
  public:
   enum RecordKind {
     struct_kind,
@@ -452,13 +501,9 @@ class RecordTypeIR : public TypeIR, public TemplatedArtifactIR {
   RecordKind record_kind_;
 };
 
-class EnumFieldIR {
+class EnumFieldIR : public HasAvailabilityAttrs {
  public:
-  EnumFieldIR(const std::string &name, int64_t value)
-      : name_(name), signed_value_(value), is_signed_(true) {}
-
-  EnumFieldIR(const std::string &name, uint64_t value)
-      : name_(name), unsigned_value_(value), is_signed_(false) {}
+  void SetName(std::string name) { name_ = std::move(name); }
 
   const std::string &GetName() const {
     return name_;
@@ -466,20 +511,30 @@ class EnumFieldIR {
 
   bool IsSigned() const { return is_signed_; }
 
+  void SetSignedValue(int64_t value) {
+    signed_value_ = value;
+    is_signed_ = true;
+  }
+
   int64_t GetSignedValue() const { return signed_value_; }
 
+  void SetUnsignedValue(uint64_t value) {
+    unsigned_value_ = value;
+    is_signed_ = false;
+  }
+
   uint64_t GetUnsignedValue() const { return unsigned_value_; }
 
  protected:
   std::string name_;
   union {
     int64_t signed_value_;
-    uint64_t unsigned_value_;
+    uint64_t unsigned_value_ = 0;
   };
-  bool is_signed_;
+  bool is_signed_ = false;
 };
 
-class EnumTypeIR : public TypeIR {
+class EnumTypeIR : public TypeIR, public HasAvailabilityAttrs {
  public:
   // Add Methods to get information from the IR.
   void AddEnumField(EnumFieldIR &&field) {
@@ -624,7 +679,9 @@ class QualifiedTypeIR : public TypeIR {
   bool is_volatile_;
 };
 
-class GlobalVarIR : public LinkableMessageIR , public ReferencesOtherType {
+class GlobalVarIR : public LinkableMessageIR,
+                    public ReferencesOtherType,
+                    public HasAvailabilityAttrs {
  public:
   // Add Methods to get information from the IR.
   void SetName(std::string &&name) {
@@ -709,8 +766,10 @@ class FunctionTypeIR : public TypeIR, public CFunctionLikeIR {
   }
 };
 
-class FunctionIR : public LinkableMessageIR, public TemplatedArtifactIR,
-                   public CFunctionLikeIR {
+class FunctionIR : public LinkableMessageIR,
+                   public TemplatedArtifactIR,
+                   public CFunctionLikeIR,
+                   public HasAvailabilityAttrs {
  public:
   void SetAccess(AccessSpecifierIR access) {
     access_ = access;
@@ -808,8 +867,9 @@ class TypeDefinition {
 
 class ModuleIR {
  public:
-  ModuleIR(const std::set<std::string> *exported_headers)
-      : exported_headers_(exported_headers) {}
+  ModuleIR(const std::set<std::string> *exported_headers = nullptr,
+           std::optional<utils::ApiLevel> availability = {})
+      : exported_headers_(exported_headers), availability_(availability) {}
 
   const std::string &GetCompilationUnitPath() const {
     return compilation_unit_path_;
@@ -934,6 +994,11 @@ class ModuleIR {
   bool IsLinkableMessageInExportedHeaders(
       const LinkableMessageIR *linkable_message) const;
 
+  void FilterRecordFields(RecordTypeIR &record_type) const;
+
+  void FilterEnumFields(EnumTypeIR &enum_type) const;
+
+  bool IsAvailable(const HasAvailabilityAttrs &decl_ir) const;
 
  public:
   // File path to the compilation unit (*.sdump)
@@ -962,11 +1027,11 @@ class ModuleIR {
   // maps unique_id + source_file -> TypeDefinition
   AbiElementUnorderedMap<std::list<TypeDefinition>> odr_list_map_;
 
-
  private:
   // The compilation unit paths referenced by odr_list_map_;
   std::set<std::string> compilation_unit_paths_;
   const std::set<std::string> *exported_headers_;
+  const std::optional<utils::ApiLevel> availability_;
 };
 
 
diff --git a/vndk/tools/header-checker/src/repr/json/api.h b/vndk/tools/header-checker/src/repr/json/api.h
index 95c1c37c1..48270a32d 100644
--- a/vndk/tools/header-checker/src/repr/json/api.h
+++ b/vndk/tools/header-checker/src/repr/json/api.h
@@ -16,7 +16,6 @@
 #define HEADER_CHECKER_REPR_JSON_API_H_
 
 #include <memory>
-#include <set>
 #include <string>
 
 
@@ -26,12 +25,12 @@ namespace repr {
 
 class IRDumper;
 class IRReader;
-
+class ModuleIR;
 
 std::unique_ptr<IRDumper> CreateJsonIRDumper(const std::string &dump_path);
 
 std::unique_ptr<IRReader> CreateJsonIRReader(
-    const std::set<std::string> *exported_headers);
+    std::unique_ptr<ModuleIR> module_ir);
 
 
 }  // namespace repr
diff --git a/vndk/tools/header-checker/src/repr/json/ir_dumper.cpp b/vndk/tools/header-checker/src/repr/json/ir_dumper.cpp
index faf49d677..8efb0e7d7 100644
--- a/vndk/tools/header-checker/src/repr/json/ir_dumper.cpp
+++ b/vndk/tools/header-checker/src/repr/json/ir_dumper.cpp
@@ -15,19 +15,13 @@
 #include "repr/json/ir_dumper.h"
 
 #include "repr/ir_dumper.h"
-#include "repr/ir_reader.h"
-#include "repr/ir_representation_internal.h"
+#include "repr/ir_representation.h"
 #include "repr/json/api.h"
 #include "repr/json/converter.h"
 
-#include <json/reader.h>
 #include <json/writer.h>
 
-#include <llvm/Support/raw_ostream.h>
-
-#include <cstdlib>
 #include <fstream>
-#include <sstream>
 #include <string>
 
 
@@ -52,6 +46,31 @@ static void AddRecordKind(JsonObject &record_type,
   }
 }
 
+static void AddAvailabilityAttrs(JsonObject &decl,
+                                 const HasAvailabilityAttrs *decl_ir) {
+  if (decl_ir->GetAvailabilityAttrs().empty()) {
+    return;
+  }
+  JsonArray attrs;
+  for (auto &&attr_ir : decl_ir->GetAvailabilityAttrs()) {
+    JsonObject attr;
+    if (auto introduced = attr_ir.GetIntroduced(); introduced.has_value()) {
+      attr.Set("introduced_major", (uint64_t)introduced.value());
+    }
+    if (auto deprecated = attr_ir.GetDeprecated(); deprecated.has_value()) {
+      attr.Set("deprecated_major", (uint64_t)deprecated.value());
+    }
+    if (auto obsoleted = attr_ir.GetObsoleted(); obsoleted.has_value()) {
+      attr.Set("obsoleted_major", (uint64_t)obsoleted.value());
+    }
+    if (attr_ir.IsUnavailable()) {
+      attr.Set("unavailable", true);
+    }
+    attrs.append(std::move(attr));
+  }
+  decl.Set("availability_attrs", attrs);
+}
+
 static void AddVtableComponentKind(JsonObject &vtable_component,
                                    VTableComponentIR::Kind value) {
   if (value != default_vtable_component_kind_ir) {
@@ -70,8 +89,8 @@ static void AddElfSymbolBinding(JsonObject &elf_symbol,
   }
 }
 
-void IRToJsonConverter::AddTemplateInfo(
-    JsonObject &type_decl, const TemplatedArtifactIR *template_ir) {
+static void AddTemplateInfo(JsonObject &type_decl,
+                            const TemplatedArtifactIR *template_ir) {
   JsonArray args;
   for (auto &&template_element_ir : template_ir->GetTemplateElements()) {
     args.append(template_element_ir.GetReferencedType());
@@ -79,8 +98,7 @@ void IRToJsonConverter::AddTemplateInfo(
   type_decl.Set("template_args", args);
 }
 
-void IRToJsonConverter::AddTypeInfo(JsonObject &type_decl,
-                                    const TypeIR *type_ir) {
+static void AddTypeInfo(JsonObject &type_decl, const TypeIR *type_ir) {
   // LinkableMessageIR
   type_decl.Set("source_file", type_ir->GetSourceFile());
   const std::string &linker_set_key = type_ir->GetLinkerSetKey();
@@ -108,11 +126,12 @@ static JsonObject ConvertRecordFieldIR(const RecordFieldIR *record_field_ir) {
   record_field.Set("field_offset", (uint64_t)record_field_ir->GetOffset());
   record_field.Set("is_bit_field", record_field_ir->IsBitField());
   record_field.Set("bit_width", (uint64_t)record_field_ir->GetBitWidth());
+  AddAvailabilityAttrs(record_field, record_field_ir);
   return record_field;
 }
 
-void IRToJsonConverter::AddRecordFields(JsonObject &record_type,
-                                        const RecordTypeIR *record_ir) {
+static void AddRecordFields(JsonObject &record_type,
+                            const RecordTypeIR *record_ir) {
   JsonArray fields;
   for (auto &&field_ir : record_ir->GetFields()) {
     fields.append(ConvertRecordFieldIR(&field_ir));
@@ -129,8 +148,8 @@ ConvertBaseSpecifierIR(const CXXBaseSpecifierIR &base_specifier_ir) {
   return base_specifier;
 }
 
-void IRToJsonConverter::AddBaseSpecifiers(JsonObject &record_type,
-                                          const RecordTypeIR *record_ir) {
+static void AddBaseSpecifiers(JsonObject &record_type,
+                              const RecordTypeIR *record_ir) {
   JsonArray base_specifiers;
   for (auto &&base_ir : record_ir->GetBases()) {
     base_specifiers.append(ConvertBaseSpecifierIR(base_ir));
@@ -149,8 +168,8 @@ ConvertVTableComponentIR(const VTableComponentIR &vtable_component_ir) {
   return vtable_component;
 }
 
-void IRToJsonConverter::AddVTableLayout(JsonObject &record_type,
-                                        const RecordTypeIR *record_ir) {
+static void AddVTableLayout(JsonObject &record_type,
+                            const RecordTypeIR *record_ir) {
   JsonArray vtable_components;
   for (auto &&vtable_component_ir :
        record_ir->GetVTableLayout().GetVTableComponents()) {
@@ -159,7 +178,7 @@ void IRToJsonConverter::AddVTableLayout(JsonObject &record_type,
   record_type.Set("vtable_components", vtable_components);
 }
 
-JsonObject IRToJsonConverter::ConvertRecordTypeIR(const RecordTypeIR *recordp) {
+static JsonObject ConvertRecordTypeIR(const RecordTypeIR *recordp) {
   JsonObject record_type;
 
   AddAccess(record_type, recordp->GetAccess());
@@ -170,17 +189,12 @@ JsonObject IRToJsonConverter::ConvertRecordTypeIR(const RecordTypeIR *recordp) {
   AddBaseSpecifiers(record_type, recordp);
   AddVTableLayout(record_type, recordp);
   AddTemplateInfo(record_type, recordp);
+  AddAvailabilityAttrs(record_type, recordp);
   return record_type;
 }
 
-void IRToJsonConverter::AddFunctionParametersAndSetReturnType(
-    JsonObject &function, const CFunctionLikeIR *cfunction_like_ir) {
-  function.Set("return_type", cfunction_like_ir->GetReturnType());
-  AddFunctionParameters(function, cfunction_like_ir);
-}
-
-void IRToJsonConverter::AddFunctionParameters(
-    JsonObject &function, const CFunctionLikeIR *cfunction_like_ir) {
+static void AddFunctionParameters(JsonObject &function,
+                                  const CFunctionLikeIR *cfunction_like_ir) {
   JsonArray parameters;
   for (auto &&parameter_ir : cfunction_like_ir->GetParameters()) {
     JsonObject parameter;
@@ -192,15 +206,20 @@ void IRToJsonConverter::AddFunctionParameters(
   function.Set("parameters", parameters);
 }
 
-JsonObject
-IRToJsonConverter::ConvertFunctionTypeIR(const FunctionTypeIR *function_typep) {
+static void AddFunctionParametersAndSetReturnType(
+    JsonObject &function, const CFunctionLikeIR *cfunction_like_ir) {
+  function.Set("return_type", cfunction_like_ir->GetReturnType());
+  AddFunctionParameters(function, cfunction_like_ir);
+}
+
+static JsonObject ConvertFunctionTypeIR(const FunctionTypeIR *function_typep) {
   JsonObject function_type;
   AddTypeInfo(function_type, function_typep);
   AddFunctionParametersAndSetReturnType(function_type, function_typep);
   return function_type;
 }
 
-JsonObject IRToJsonConverter::ConvertFunctionIR(const FunctionIR *functionp) {
+static JsonObject ConvertFunctionIR(const FunctionIR *functionp) {
   JsonObject function;
   AddAccess(function, functionp->GetAccess());
   function.Set("linker_set_key", functionp->GetLinkerSetKey());
@@ -208,6 +227,7 @@ JsonObject IRToJsonConverter::ConvertFunctionIR(const FunctionIR *functionp) {
   function.Set("function_name", functionp->GetName());
   AddFunctionParametersAndSetReturnType(function, functionp);
   AddTemplateInfo(function, functionp);
+  AddAvailabilityAttrs(function, functionp);
   return function;
 }
 
@@ -221,11 +241,11 @@ static JsonObject ConvertEnumFieldIR(const EnumFieldIR *enum_field_ir) {
   } else {
     enum_field_value = Json::UInt64(enum_field_ir->GetUnsignedValue());
   }
+  AddAvailabilityAttrs(enum_field, enum_field_ir);
   return enum_field;
 }
 
-void IRToJsonConverter::AddEnumFields(JsonObject &enum_type,
-                                      const EnumTypeIR *enum_ir) {
+static void AddEnumFields(JsonObject &enum_type, const EnumTypeIR *enum_ir) {
   JsonArray enum_fields;
   for (auto &&field : enum_ir->GetFields()) {
     enum_fields.append(ConvertEnumFieldIR(&field));
@@ -233,17 +253,17 @@ void IRToJsonConverter::AddEnumFields(JsonObject &enum_type,
   enum_type.Set("enum_fields", enum_fields);
 }
 
-JsonObject IRToJsonConverter::ConvertEnumTypeIR(const EnumTypeIR *enump) {
+static JsonObject ConvertEnumTypeIR(const EnumTypeIR *enump) {
   JsonObject enum_type;
   AddAccess(enum_type, enump->GetAccess());
   enum_type.Set("underlying_type", enump->GetUnderlyingType());
   AddTypeInfo(enum_type, enump);
   AddEnumFields(enum_type, enump);
+  AddAvailabilityAttrs(enum_type, enump);
   return enum_type;
 }
 
-JsonObject
-IRToJsonConverter::ConvertGlobalVarIR(const GlobalVarIR *global_varp) {
+static JsonObject ConvertGlobalVarIR(const GlobalVarIR *global_varp) {
   JsonObject global_var;
   // GlobalVarIR
   global_var.Set("name", global_varp->GetName());
@@ -257,18 +277,17 @@ IRToJsonConverter::ConvertGlobalVarIR(const GlobalVarIR *global_varp) {
   if (linker_set_key != referenced_type) {
     global_var.Set("referenced_type", referenced_type);
   }
+  AddAvailabilityAttrs(global_var, global_varp);
   return global_var;
 }
 
-JsonObject
-IRToJsonConverter::ConvertPointerTypeIR(const PointerTypeIR *pointerp) {
+static JsonObject ConvertPointerTypeIR(const PointerTypeIR *pointerp) {
   JsonObject pointer_type;
   AddTypeInfo(pointer_type, pointerp);
   return pointer_type;
 }
 
-JsonObject
-IRToJsonConverter::ConvertQualifiedTypeIR(const QualifiedTypeIR *qualtypep) {
+static JsonObject ConvertQualifiedTypeIR(const QualifiedTypeIR *qualtypep) {
   JsonObject qualified_type;
   AddTypeInfo(qualified_type, qualtypep);
   qualified_type.Set("is_const", qualtypep->IsConst());
@@ -277,8 +296,7 @@ IRToJsonConverter::ConvertQualifiedTypeIR(const QualifiedTypeIR *qualtypep) {
   return qualified_type;
 }
 
-JsonObject
-IRToJsonConverter::ConvertBuiltinTypeIR(const BuiltinTypeIR *builtin_typep) {
+static JsonObject ConvertBuiltinTypeIR(const BuiltinTypeIR *builtin_typep) {
   JsonObject builtin_type;
   builtin_type.Set("is_unsigned", builtin_typep->IsUnsigned());
   builtin_type.Set("is_integral", builtin_typep->IsIntegralType());
@@ -286,22 +304,21 @@ IRToJsonConverter::ConvertBuiltinTypeIR(const BuiltinTypeIR *builtin_typep) {
   return builtin_type;
 }
 
-JsonObject
-IRToJsonConverter::ConvertArrayTypeIR(const ArrayTypeIR *array_typep) {
+static JsonObject ConvertArrayTypeIR(const ArrayTypeIR *array_typep) {
   JsonObject array_type;
   array_type.Set("is_of_unknown_bound", array_typep->IsOfUnknownBound());
   AddTypeInfo(array_type, array_typep);
   return array_type;
 }
 
-JsonObject IRToJsonConverter::ConvertLvalueReferenceTypeIR(
+static JsonObject ConvertLvalueReferenceTypeIR(
     const LvalueReferenceTypeIR *lvalue_reference_typep) {
   JsonObject lvalue_reference_type;
   AddTypeInfo(lvalue_reference_type, lvalue_reference_typep);
   return lvalue_reference_type;
 }
 
-JsonObject IRToJsonConverter::ConvertRvalueReferenceTypeIR(
+static JsonObject ConvertRvalueReferenceTypeIR(
     const RvalueReferenceTypeIR *rvalue_reference_typep) {
   JsonObject rvalue_reference_type;
   AddTypeInfo(rvalue_reference_type, rvalue_reference_typep);
diff --git a/vndk/tools/header-checker/src/repr/json/ir_dumper.h b/vndk/tools/header-checker/src/repr/json/ir_dumper.h
index dae290a69..ccebfb2b0 100644
--- a/vndk/tools/header-checker/src/repr/json/ir_dumper.h
+++ b/vndk/tools/header-checker/src/repr/json/ir_dumper.h
@@ -16,7 +16,6 @@
 #define HEADER_CHECKER_REPR_JSON_IR_DUMPER_H_
 
 #include "repr/ir_dumper.h"
-#include "repr/ir_reader.h"
 #include "repr/ir_representation.h"
 #include "repr/json/converter.h"
 
@@ -25,58 +24,7 @@ namespace header_checker {
 namespace repr {
 
 
-class IRToJsonConverter {
- private:
-  static void AddTemplateInfo(JsonObject &type_decl,
-                              const TemplatedArtifactIR *template_ir);
-
-  // BasicNamedAndTypedDecl
-  static void AddTypeInfo(JsonObject &type_decl, const TypeIR *type_ir);
-
-  static void AddRecordFields(JsonObject &record_type,
-                              const RecordTypeIR *record_ir);
-
-  static void AddBaseSpecifiers(JsonObject &record_type,
-                                const RecordTypeIR *record_ir);
-
-  static void AddVTableLayout(JsonObject &record_type,
-                              const RecordTypeIR *record_ir);
-
-  static void AddEnumFields(JsonObject &enum_type, const EnumTypeIR *enum_ir);
-
- public:
-  static JsonObject ConvertEnumTypeIR(const EnumTypeIR *enump);
-
-  static JsonObject ConvertRecordTypeIR(const RecordTypeIR *recordp);
-
-  static JsonObject ConvertFunctionTypeIR(const FunctionTypeIR *function_typep);
-
-  static void AddFunctionParametersAndSetReturnType(
-      JsonObject &function, const CFunctionLikeIR *cfunction_like_ir);
-
-  static void AddFunctionParameters(JsonObject &function,
-                                    const CFunctionLikeIR *cfunction_like_ir);
-
-  static JsonObject ConvertFunctionIR(const FunctionIR *functionp);
-
-  static JsonObject ConvertGlobalVarIR(const GlobalVarIR *global_varp);
-
-  static JsonObject ConvertPointerTypeIR(const PointerTypeIR *pointerp);
-
-  static JsonObject ConvertQualifiedTypeIR(const QualifiedTypeIR *qualtypep);
-
-  static JsonObject ConvertBuiltinTypeIR(const BuiltinTypeIR *builtin_typep);
-
-  static JsonObject ConvertArrayTypeIR(const ArrayTypeIR *array_typep);
-
-  static JsonObject ConvertLvalueReferenceTypeIR(
-      const LvalueReferenceTypeIR *lvalue_reference_typep);
-
-  static JsonObject ConvertRvalueReferenceTypeIR(
-      const RvalueReferenceTypeIR *rvalue_reference_typep);
-};
-
-class JsonIRDumper : public IRDumper, public IRToJsonConverter {
+class JsonIRDumper : public IRDumper {
  public:
   JsonIRDumper(const std::string &dump_path);
 
diff --git a/vndk/tools/header-checker/src/repr/json/ir_reader.cpp b/vndk/tools/header-checker/src/repr/json/ir_reader.cpp
index 9c41d4538..b16507f6d 100644
--- a/vndk/tools/header-checker/src/repr/json/ir_reader.cpp
+++ b/vndk/tools/header-checker/src/repr/json/ir_reader.cpp
@@ -57,6 +57,10 @@ JsonObjectRef::JsonObjectRef(const Json::Value &json_value, bool &ok)
   }
 }
 
+bool JsonObjectRef::IsMember(const std::string &key) const {
+  return object_.isMember(key);
+}
+
 const Json::Value &
 JsonObjectRef::Get(const std::string &key, const Json::Value &default_value,
                    IsExpectedJsonType is_expected_type) const {
@@ -227,6 +231,24 @@ void JsonIRReader::ReadTypeInfo(const JsonObjectRef &type_decl,
       type_decl.GetString("referenced_type", type_ir->GetSelfType()));
 }
 
+static void ReadAvailabilityAttrs(const JsonObjectRef &object,
+                                  HasAvailabilityAttrs *decl_ir) {
+  for (auto &&attr : object.GetObjects("availability_attrs")) {
+    repr::AvailabilityAttrIR attr_ir;
+    if (attr.IsMember("introduced_major")) {
+      attr_ir.SetIntroduced(attr.GetUint("introduced_major"));
+    }
+    if (attr.IsMember("deprecated_major")) {
+      attr_ir.SetDeprecated(attr.GetUint("deprecated_major"));
+    }
+    if (attr.IsMember("obsoleted_major")) {
+      attr_ir.SetObsoleted(attr.GetUint("obsoleted_major"));
+    }
+    attr_ir.SetUnavailable(attr.GetBool("unavailable"));
+    decl_ir->AddAvailabilityAttr(std::move(attr_ir));
+  }
+}
+
 void JsonIRReader::ReadRecordFields(const JsonObjectRef &record_type,
                                     RecordTypeIR *record_ir) {
   for (auto &&field : record_type.GetObjects("fields")) {
@@ -234,6 +256,7 @@ void JsonIRReader::ReadRecordFields(const JsonObjectRef &record_type,
         field.GetString("field_name"), field.GetString("referenced_type"),
         field.GetUint("field_offset"), GetAccess(field),
         field.GetBool("is_bit_field"), field.GetUint("bit_width"));
+    ReadAvailabilityAttrs(field, &record_field_ir);
     record_ir->AddRecordField(std::move(record_field_ir));
   }
 }
@@ -265,13 +288,16 @@ void JsonIRReader::ReadVTableLayout(const JsonObjectRef &record_type,
 void JsonIRReader::ReadEnumFields(const JsonObjectRef &enum_type,
                                   EnumTypeIR *enum_ir) {
   for (auto &&field : enum_type.GetObjects("enum_fields")) {
-    std::string name = field.GetString("name");
+    EnumFieldIR enum_field_ir;
+    enum_field_ir.SetName(field.GetString("name"));
     const Json::Value &value = field.GetIntegralValue("enum_field_value");
     if (value.isUInt64()) {
-      enum_ir->AddEnumField(EnumFieldIR(name, value.asUInt64()));
+      enum_field_ir.SetUnsignedValue(value.asUInt64());
     } else {
-      enum_ir->AddEnumField(EnumFieldIR(name, value.asInt64()));
+      enum_field_ir.SetSignedValue(value.asInt64());
     }
+    ReadAvailabilityAttrs(field, &enum_field_ir);
+    enum_ir->AddEnumField(std::move(enum_field_ir));
   }
 }
 
@@ -294,6 +320,7 @@ FunctionIR JsonIRReader::FunctionJsonToIR(const JsonObjectRef &function) {
   function_ir.SetSourceFile(function.GetString("source_file"));
   ReadFunctionParametersAndReturnType(function, &function_ir);
   ReadTemplateInfo(function, &function_ir);
+  ReadAvailabilityAttrs(function, &function_ir);
   return function_ir;
 }
 
@@ -316,6 +343,7 @@ JsonIRReader::RecordTypeJsonToIR(const JsonObjectRef &record_type) {
   ReadBaseSpecifiers(record_type, &record_type_ir);
   record_type_ir.SetRecordKind(GetRecordKind(record_type));
   record_type_ir.SetAnonymity(record_type.GetBool("is_anonymous"));
+  ReadAvailabilityAttrs(record_type, &record_type_ir);
   return record_type_ir;
 }
 
@@ -325,6 +353,7 @@ EnumTypeIR JsonIRReader::EnumTypeJsonToIR(const JsonObjectRef &enum_type) {
   enum_type_ir.SetUnderlyingType(enum_type.GetString("underlying_type"));
   enum_type_ir.SetAccess(GetAccess(enum_type));
   ReadEnumFields(enum_type, &enum_type_ir);
+  ReadAvailabilityAttrs(enum_type, &enum_type_ir);
   return enum_type_ir;
 }
 
@@ -341,6 +370,7 @@ void JsonIRReader::ReadGlobalVariables(const JsonObjectRef &tu) {
     // ReferencesOtherType
     global_variable_ir.SetReferencedType(global_variable.GetString(
         "referenced_type", global_variable_ir.GetLinkerSetKey()));
+    ReadAvailabilityAttrs(global_variable, &global_variable_ir);
     module_->AddGlobalVariable(std::move(global_variable_ir));
   }
 }
@@ -445,8 +475,8 @@ void JsonIRReader::ReadElfObjects(const JsonObjectRef &tu) {
 }
 
 std::unique_ptr<IRReader> CreateJsonIRReader(
-    const std::set<std::string> *exported_headers) {
-  return std::make_unique<JsonIRReader>(exported_headers);
+    std::unique_ptr<ModuleIR> module_ir) {
+  return std::make_unique<JsonIRReader>(std::move(module_ir));
 }
 
 
diff --git a/vndk/tools/header-checker/src/repr/json/ir_reader.h b/vndk/tools/header-checker/src/repr/json/ir_reader.h
index ce13d3710..c7ec44620 100644
--- a/vndk/tools/header-checker/src/repr/json/ir_reader.h
+++ b/vndk/tools/header-checker/src/repr/json/ir_reader.h
@@ -15,7 +15,6 @@
 #ifndef HEADER_CHECKER_REPR_JSON_IR_READER_H_
 #define HEADER_CHECKER_REPR_JSON_IR_READER_H_
 
-#include "repr/ir_dumper.h"
 #include "repr/ir_reader.h"
 #include "repr/ir_representation.h"
 
@@ -34,6 +33,8 @@ class JsonObjectRef {
   // The constructor sets ok to false if json_value is not an object.
   JsonObjectRef(const Json::Value &json_value, bool &ok);
 
+  bool IsMember(const std::string &key) const;
+
   // This method gets a value from the object and checks the type.
   // If the type mismatches, it sets ok_ to false and returns default value.
   // If the key doesn't exist, it doesn't change ok_ and returns default value.
@@ -119,8 +120,8 @@ template <> std::string JsonArrayRef<std::string>::Iterator::operator*() const;
 
 class JsonIRReader : public IRReader {
  public:
-  JsonIRReader(const std::set<std::string> *exported_headers)
-      : IRReader(exported_headers) {}
+  JsonIRReader(std::unique_ptr<ModuleIR> module_ir)
+      : IRReader(std::move(module_ir)) {}
 
  private:
   bool ReadDumpImpl(const std::string &dump_file) override;
diff --git a/vndk/tools/header-checker/src/repr/protobuf/api.h b/vndk/tools/header-checker/src/repr/protobuf/api.h
index 22a03ee50..ef0598fd8 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/api.h
+++ b/vndk/tools/header-checker/src/repr/protobuf/api.h
@@ -16,7 +16,6 @@
 #define HEADER_CHECKER_REPR_PROTOBUF_API_H_
 
 #include <memory>
-#include <set>
 #include <string>
 
 
@@ -27,12 +26,12 @@ namespace repr {
 class IRDiffDumper;
 class IRDumper;
 class IRReader;
-
+class ModuleIR;
 
 std::unique_ptr<IRDumper> CreateProtobufIRDumper(const std::string &dump_path);
 
 std::unique_ptr<IRReader> CreateProtobufIRReader(
-    const std::set<std::string> *exported_headers);
+    std::unique_ptr<ModuleIR> module_ir);
 
 std::unique_ptr<IRDiffDumper> CreateProtobufIRDiffDumper(
     const std::string &dump_path);
diff --git a/vndk/tools/header-checker/src/repr/protobuf/converter.cpp b/vndk/tools/header-checker/src/repr/protobuf/converter.cpp
deleted file mode 100644
index 3bf620d47..000000000
--- a/vndk/tools/header-checker/src/repr/protobuf/converter.cpp
+++ /dev/null
@@ -1,295 +0,0 @@
-// Copyright (C) 2019 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-#include "repr/protobuf/converter.h"
-
-#include <llvm/Support/raw_ostream.h>
-
-#include <fstream>
-#include <iostream>
-#include <memory>
-#include <string>
-
-
-namespace header_checker {
-namespace repr {
-
-
-bool IRDiffToProtobufConverter::AddTypeInfoDiff(
-    abi_diff::TypeInfoDiff *type_info_diff_protobuf,
-    const TypeDiffIR *type_diff_ir) {
-  abi_diff::TypeInfo *old_type_info_protobuf =
-      type_info_diff_protobuf->mutable_old_type_info();
-  abi_diff::TypeInfo *new_type_info_protobuf =
-      type_info_diff_protobuf->mutable_new_type_info();
-  if (old_type_info_protobuf == nullptr || new_type_info_protobuf == nullptr) {
-    return false;
-  }
-  const std::pair<uint64_t, uint64_t> &sizes = type_diff_ir->GetSizes();
-  const std::pair<uint32_t, uint32_t> &alignments =
-      type_diff_ir->GetAlignments();
-  old_type_info_protobuf->set_size(sizes.first);
-  new_type_info_protobuf->set_size(sizes.second);
-
-  old_type_info_protobuf->set_alignment(alignments.first);
-  new_type_info_protobuf->set_alignment(alignments.second);
-  return true;
-}
-
-bool IRDiffToProtobufConverter::AddVTableLayoutDiff(
-    abi_diff::VTableLayoutDiff *vtable_layout_diff_protobuf,
-    const VTableLayoutDiffIR *vtable_layout_diff_ir) {
-  abi_dump:: VTableLayout *old_vtable =
-      vtable_layout_diff_protobuf->mutable_old_vtable();
-  abi_dump:: VTableLayout *new_vtable =
-      vtable_layout_diff_protobuf->mutable_new_vtable();
-  if (old_vtable == nullptr || new_vtable == nullptr ||
-      !IRToProtobufConverter::ConvertVTableLayoutIR(
-          old_vtable, vtable_layout_diff_ir->GetOldVTable()) ||
-      !IRToProtobufConverter::ConvertVTableLayoutIR(
-          new_vtable, vtable_layout_diff_ir->GetNewVTable())) {
-    return false;
-  }
-  return true;
-}
-
-static bool CopyBaseSpecifiersDiffIRToProtobuf(
-    google::protobuf::RepeatedPtrField<abi_dump::CXXBaseSpecifier> *dst,
-    const std::vector<CXXBaseSpecifierIR> &bases_ir) {
-  for (auto &&base_ir : bases_ir) {
-    abi_dump::CXXBaseSpecifier *added_base = dst->Add();
-    if (!IRToProtobufConverter::ConvertCXXBaseSpecifierIR(added_base,
-                                                          base_ir)) {
-      return false;
-    }
-  }
-  return true;
-}
-
-bool IRDiffToProtobufConverter::AddBaseSpecifierDiffs(
-    abi_diff::CXXBaseSpecifierDiff *base_specifiers_diff_protobuf,
-    const CXXBaseSpecifierDiffIR *base_specifiers_diff_ir) {
-  if (!CopyBaseSpecifiersDiffIRToProtobuf(
-          base_specifiers_diff_protobuf->mutable_old_bases(),
-          base_specifiers_diff_ir->GetOldBases()) ||
-      !CopyBaseSpecifiersDiffIRToProtobuf(
-          base_specifiers_diff_protobuf->mutable_new_bases(),
-          base_specifiers_diff_ir->GetNewBases())) {
-    return false;
-  }
-  return true;
-}
-
-bool IRDiffToProtobufConverter::AddRecordFields(
-    abi_diff::RecordTypeDiff *record_diff_protobuf,
-    const std::vector<const RecordFieldIR *> &record_fields_ir,
-    bool field_removed) {
-  for (auto &&record_field_ir : record_fields_ir) {
-    abi_dump::RecordFieldDecl *field = nullptr;
-    if (field_removed) {
-      field = record_diff_protobuf->add_fields_removed();
-    } else {
-      field = record_diff_protobuf->add_fields_added();
-    }
-    if (!IRToProtobufConverter::ConvertRecordFieldIR(field, record_field_ir)) {
-      return false;
-    }
-  }
-  return true;
-}
-
-bool IRDiffToProtobufConverter::AddRecordFieldDiffs(
-    abi_diff::RecordTypeDiff *record_diff_protobuf,
-    const std::vector<RecordFieldDiffIR> &record_field_diffs_ir) {
-  for (auto &&record_field_diff_ir : record_field_diffs_ir) {
-    abi_diff::RecordFieldDeclDiff *record_field_diff =
-        record_diff_protobuf->add_fields_diff();
-    if (record_field_diff == nullptr) {
-      return false;
-    }
-    abi_dump::RecordFieldDecl *old_field =
-        record_field_diff->mutable_old_field();
-    abi_dump::RecordFieldDecl *new_field =
-        record_field_diff->mutable_new_field();
-    if (old_field == nullptr || new_field == nullptr) {
-      return false;
-    }
-    IRToProtobufConverter::ConvertRecordFieldIR(
-        old_field, record_field_diff_ir.GetOldField());
-    IRToProtobufConverter::ConvertRecordFieldIR(
-        new_field, record_field_diff_ir.GetNewField());
-  }
-  return true;
-}
-
-abi_diff::RecordTypeDiff IRDiffToProtobufConverter::ConvertRecordTypeDiffIR(
-    const RecordTypeDiffIR *record_type_diff_ir) {
-  abi_diff::RecordTypeDiff record_type_diff_protobuf;
-  record_type_diff_protobuf.set_name(record_type_diff_ir->GetName());
-  record_type_diff_protobuf.set_linker_set_key(
-      record_type_diff_ir->GetLinkerSetKey());
-  // If a type_info diff exists
-  const TypeDiffIR *type_diff_ir = record_type_diff_ir->GetTypeDiff();
-  if (type_diff_ir != nullptr) {
-    abi_diff::TypeInfoDiff *type_info_diff =
-        record_type_diff_protobuf.mutable_type_info_diff();
-    if (!AddTypeInfoDiff(type_info_diff, type_diff_ir)) {
-      llvm::errs() << "RecordType could not be converted\n";
-      ::exit(1);
-    }
-  }
-  // If vtables differ.
-  const VTableLayoutDiffIR *vtable_layout_diff_ir =
-      record_type_diff_ir->GetVTableLayoutDiff();
-  if (vtable_layout_diff_ir != nullptr) {
-    abi_diff::VTableLayoutDiff *vtable_layout_diff_protobuf =
-        record_type_diff_protobuf.mutable_vtable_layout_diff();
-    if (!AddVTableLayoutDiff(vtable_layout_diff_protobuf,
-                             vtable_layout_diff_ir)) {
-      llvm::errs() << "VTable layout diff could not be added\n";
-      ::exit(1);
-    }
-  }
-  // If base specifiers differ.
-  const CXXBaseSpecifierDiffIR *base_specifier_diff_ir =
-      record_type_diff_ir->GetBaseSpecifiers();
-  if (base_specifier_diff_ir != nullptr) {
-    abi_diff::CXXBaseSpecifierDiff *base_specifier_diff_protobuf =
-        record_type_diff_protobuf.mutable_bases_diff();
-    if (!AddBaseSpecifierDiffs(base_specifier_diff_protobuf,
-                               base_specifier_diff_ir)) {
-      llvm::errs() << "Base Specifier diff could not be added\n";
-      ::exit(1);
-    }
-  }
-  // Field diffs
-  if (!AddRecordFields(&record_type_diff_protobuf,
-                       record_type_diff_ir->GetFieldsRemoved(), true) ||
-      !AddRecordFields(&record_type_diff_protobuf,
-                       record_type_diff_ir->GetFieldsAdded(), false) ||
-      !AddRecordFieldDiffs(&record_type_diff_protobuf,
-                           record_type_diff_ir->GetFieldDiffs())) {
-    llvm::errs() << "Record Field diff could not be added\n";
-    ::exit(1);
-  }
-  return record_type_diff_protobuf;
-}
-
-bool IRDiffToProtobufConverter::AddEnumUnderlyingTypeDiff(
-    abi_diff::UnderlyingTypeDiff *underlying_type_diff_protobuf,
-    const std::pair<std::string, std::string> *underlying_type_diff_ir) {
-  if (underlying_type_diff_protobuf == nullptr) {
-    return false;
-  }
-  underlying_type_diff_protobuf->set_old_type(underlying_type_diff_ir->first);
-  underlying_type_diff_protobuf->set_new_type(underlying_type_diff_ir->second);
-  return true;
-}
-
-static bool AddEnumFields(
-    google::protobuf::RepeatedPtrField<abi_dump::EnumFieldDecl> *dst,
-    const std::vector<const EnumFieldIR *> &enum_fields) {
-  for (auto &&enum_field : enum_fields) {
-    abi_dump::EnumFieldDecl *added_enum_field = dst->Add();
-    if (!IRToProtobufConverter::ConvertEnumFieldIR(added_enum_field,
-                                                   enum_field)) {
-      return false;
-    }
-  }
-  return true;
-}
-
-static bool AddEnumFieldDiffs(
-    google::protobuf::RepeatedPtrField<abi_diff::EnumFieldDeclDiff> *dst,
-    const std::vector<EnumFieldDiffIR> &fields_diff_ir) {
-  for (auto &&field_diff_ir : fields_diff_ir) {
-    abi_diff::EnumFieldDeclDiff *field_diff_protobuf = dst->Add();
-    if (field_diff_protobuf == nullptr) {
-      return false;
-    }
-    if (!IRToProtobufConverter::ConvertEnumFieldIR(
-            field_diff_protobuf->mutable_old_field(),
-            field_diff_ir.GetOldField()) ||
-        !IRToProtobufConverter::ConvertEnumFieldIR(
-            field_diff_protobuf->mutable_new_field(),
-            field_diff_ir.GetNewField())) {
-      return false;
-    }
-  }
-  return true;
-}
-
-abi_diff::EnumTypeDiff IRDiffToProtobufConverter::ConvertEnumTypeDiffIR(
-    const EnumTypeDiffIR *enum_type_diff_ir) {
-  abi_diff::EnumTypeDiff enum_type_diff_protobuf;
-  enum_type_diff_protobuf.set_name(enum_type_diff_ir->GetName());
-  enum_type_diff_protobuf.set_linker_set_key(
-      enum_type_diff_ir->GetLinkerSetKey());
-  const std::pair<std::string, std::string> *underlying_type_diff =
-      enum_type_diff_ir->GetUnderlyingTypeDiff();
-  if ((underlying_type_diff != nullptr &&
-       !AddEnumUnderlyingTypeDiff(
-           enum_type_diff_protobuf.mutable_underlying_type_diff(),
-           underlying_type_diff)) ||
-      !AddEnumFields(enum_type_diff_protobuf.mutable_fields_removed(),
-                     enum_type_diff_ir->GetFieldsRemoved()) ||
-      !AddEnumFields(enum_type_diff_protobuf.mutable_fields_added(),
-                     enum_type_diff_ir->GetFieldsAdded()) ||
-      !AddEnumFieldDiffs(enum_type_diff_protobuf.mutable_fields_diff(),
-                         enum_type_diff_ir->GetFieldsDiff())) {
-    llvm::errs() << "Enum field diff could not be added\n";
-    ::exit(1);
-  }
-  return enum_type_diff_protobuf;
-}
-
-abi_diff::GlobalVarDeclDiff IRDiffToProtobufConverter::ConvertGlobalVarDiffIR(
-    const GlobalVarDiffIR *global_var_diff_ir) {
-  abi_diff::GlobalVarDeclDiff global_var_diff;
-  global_var_diff.set_name(global_var_diff_ir->GetName());
-  abi_dump::GlobalVarDecl *old_global_var = global_var_diff.mutable_old();
-  abi_dump::GlobalVarDecl *new_global_var = global_var_diff.mutable_new_();
-  if (old_global_var == nullptr || new_global_var == nullptr) {
-    llvm::errs() << "Globar Var diff could not be added\n";
-    ::exit(1);
-  }
-  *old_global_var =
-      IRToProtobufConverter::ConvertGlobalVarIR(
-          global_var_diff_ir->GetOldGlobalVar());
-  *new_global_var =
-      IRToProtobufConverter::ConvertGlobalVarIR(
-          global_var_diff_ir->GetNewGlobalVar());
-  return global_var_diff;
-}
-
-abi_diff::FunctionDeclDiff IRDiffToProtobufConverter::ConvertFunctionDiffIR(
-    const FunctionDiffIR *function_diff_ir) {
-  abi_diff::FunctionDeclDiff function_diff;
-  function_diff.set_name(function_diff_ir->GetName());
-  abi_dump::FunctionDecl *old_function = function_diff.mutable_old();
-  abi_dump::FunctionDecl *new_function = function_diff.mutable_new_();
-  if (old_function == nullptr || new_function == nullptr) {
-    llvm::errs() << "Function diff could not be added\n";
-    ::exit(1);
-  }
-  *old_function = IRToProtobufConverter::ConvertFunctionIR(
-      function_diff_ir->GetOldFunction());
-  *new_function = IRToProtobufConverter::ConvertFunctionIR(
-      function_diff_ir->GetNewFunction());
-  return function_diff;
-}
-
-
-}  // namespace repr
-}  // namespace header_checker
diff --git a/vndk/tools/header-checker/src/repr/protobuf/converter.h b/vndk/tools/header-checker/src/repr/protobuf/converter.h
index 7325951aa..7d82d827b 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/converter.h
+++ b/vndk/tools/header-checker/src/repr/protobuf/converter.h
@@ -27,13 +27,14 @@ namespace repr {
 
 inline abi_diff::CompatibilityStatus CompatibilityStatusIRToProtobuf(
     CompatibilityStatusIR status) {
-  switch (status) {
-    case CompatibilityStatusIR::Incompatible:
-      return abi_diff::CompatibilityStatus::INCOMPATIBLE;
-    case CompatibilityStatusIR::Extension:
-      return abi_diff::CompatibilityStatus::EXTENSION;
-    default:
-      break;
+  if (status & (CompatibilityStatusIR::Incompatible |
+                CompatibilityStatusIR::ElfIncompatible |
+                CompatibilityStatusIR::UnreferencedChanges)) {
+    return abi_diff::CompatibilityStatus::INCOMPATIBLE;
+  }
+  if (status & (CompatibilityStatusIR::Extension |
+                CompatibilityStatusIR::ElfExtension)) {
+    return abi_diff::CompatibilityStatus::EXTENSION;
   }
   return abi_diff::CompatibilityStatus::COMPATIBLE;
 }
@@ -188,130 +189,32 @@ inline VTableComponentIR::Kind VTableComponentKindProtobufToIR(
   assert(false);
 }
 
-// Convert IR to the messages defined in abi_dump.proto.
-class IRToProtobufConverter {
- private:
-  static bool AddTemplateInformation(
-      abi_dump::TemplateInfo *ti, const TemplatedArtifactIR *ta);
-
-  static bool AddTypeInfo(
-      abi_dump::BasicNamedAndTypedDecl *type_info, const TypeIR *typep);
-
-  static bool AddRecordFields(
-      abi_dump::RecordType *record_protobuf, const RecordTypeIR *record_ir);
-
-  static bool AddBaseSpecifiers(
-      abi_dump::RecordType *record_protobuf, const RecordTypeIR *record_ir);
-
-  static bool AddVTableLayout(
-      abi_dump::RecordType *record_protobuf, const RecordTypeIR *record_ir);
-
-  static bool AddEnumFields(abi_dump::EnumType *enum_protobuf,
-                            const EnumTypeIR *enum_ir);
-
- public:
-  static bool ConvertRecordFieldIR(
-      abi_dump::RecordFieldDecl *record_field_protobuf,
-      const RecordFieldIR *record_field_ir);
-
-  static bool ConvertCXXBaseSpecifierIR(
-      abi_dump::CXXBaseSpecifier *base_specifier_protobuf,
-      const CXXBaseSpecifierIR &base_specifier_ir);
-
-  static bool ConvertVTableLayoutIR(
-      abi_dump::VTableLayout *vtable_layout_protobuf,
-      const VTableLayoutIR &vtable_layout_ir);
-
-  static bool ConvertEnumFieldIR(abi_dump::EnumFieldDecl *enum_field_protobuf,
-                                 const EnumFieldIR *enum_field_ir);
-
-  static abi_dump::EnumType ConvertEnumTypeIR(const EnumTypeIR *enump);
-
-  static abi_dump::RecordType ConvertRecordTypeIR(const RecordTypeIR *recordp);
-
-  static abi_dump::FunctionType ConvertFunctionTypeIR (
-      const FunctionTypeIR *function_typep);
-
-  template <typename CFunctionLikeMessage>
-  static bool AddFunctionParametersAndSetReturnType(
-      CFunctionLikeMessage *function_like_protobuf,
-      const CFunctionLikeIR *cfunction_like_ir);
-
-  template <typename CFunctionLikeMessage>
-  static bool AddFunctionParameters(CFunctionLikeMessage *function_protobuf,
-                                    const CFunctionLikeIR *cfunction_like_ir);
-
-  static abi_dump::FunctionDecl ConvertFunctionIR(const FunctionIR *functionp);
-
-  static abi_dump::GlobalVarDecl ConvertGlobalVarIR(
-      const GlobalVarIR *global_varp);
-
-  static abi_dump::PointerType ConvertPointerTypeIR(
-      const PointerTypeIR *pointerp);
-
-  static abi_dump::QualifiedType ConvertQualifiedTypeIR(
-      const QualifiedTypeIR *qualtypep);
-
-  static abi_dump::BuiltinType ConvertBuiltinTypeIR(
-      const BuiltinTypeIR *builtin_typep);
-
-  static abi_dump::ArrayType ConvertArrayTypeIR(
-      const ArrayTypeIR *array_typep);
-
-  static abi_dump::LvalueReferenceType ConvertLvalueReferenceTypeIR(
-      const LvalueReferenceTypeIR *lvalue_reference_typep);
-
-  static abi_dump::RvalueReferenceType ConvertRvalueReferenceTypeIR(
-      const RvalueReferenceTypeIR *rvalue_reference_typep);
-
-  static abi_dump::ElfFunction ConvertElfFunctionIR(
-      const ElfFunctionIR *elf_function_ir);
-
-  static abi_dump::ElfObject ConvertElfObjectIR(
-      const ElfObjectIR *elf_object_ir);
-};
-
-// Convert IR to the messages defined in abi_diff.proto.
-class IRDiffToProtobufConverter {
- private:
-  static bool AddTypeInfoDiff(
-      abi_diff::TypeInfoDiff *type_info_diff_protobuf,
-      const TypeDiffIR *type_diff_ir);
+// ProtobufIRDiffDumper calls the following functions.
+bool ConvertVTableLayoutIR(abi_dump::VTableLayout *vtable_layout_protobuf,
+                           const VTableLayoutIR &vtable_layout_ir);
 
-  static bool AddVTableLayoutDiff(
-      abi_diff::VTableLayoutDiff *vtable_layout_diff_protobuf,
-      const VTableLayoutDiffIR *vtable_layout_diff_ir);
+bool ConvertCXXBaseSpecifierIR(
+    abi_dump::CXXBaseSpecifier *base_specifier_protobuf,
+    const CXXBaseSpecifierIR &base_specifier_ir);
 
-  static bool AddBaseSpecifierDiffs(
-      abi_diff::CXXBaseSpecifierDiff *base_specifier_diff_protobuf,
-      const CXXBaseSpecifierDiffIR *base_specifier_diff_ir);
+bool ConvertRecordFieldIR(abi_dump::RecordFieldDecl *record_field_protobuf,
+                          const RecordFieldIR *record_field_ir);
 
-  static bool AddRecordFields(
-      abi_diff::RecordTypeDiff *record_diff_protobuf,
-      const std::vector<const RecordFieldIR *> &record_fields_removed_ir,
-      bool removed);
+bool ConvertEnumFieldIR(abi_dump::EnumFieldDecl *enum_field_protobuf,
+                        const EnumFieldIR *enum_field_ir);
 
-  static bool AddRecordFieldDiffs(
-      abi_diff::RecordTypeDiff *record_diff_protobuf,
-      const std::vector<RecordFieldDiffIR> &record_field_diff_ir);
+abi_dump::FunctionDecl ConvertFunctionIR(const FunctionIR *functionp);
 
-  static bool AddEnumUnderlyingTypeDiff(
-      abi_diff::UnderlyingTypeDiff *underlying_type_diff_protobuf,
-      const std::pair<std::string, std::string> *underlying_type_diff_ir);
+abi_dump::GlobalVarDecl ConvertGlobalVarIR(const GlobalVarIR *global_varp);
 
- public:
-  static abi_diff::RecordTypeDiff ConvertRecordTypeDiffIR(
-      const RecordTypeDiffIR *record_type_diffp);
+abi_dump::ElfFunction ConvertElfFunctionIR(
+    const ElfFunctionIR *elf_function_ir);
 
-  static abi_diff::EnumTypeDiff ConvertEnumTypeDiffIR(
-      const EnumTypeDiffIR *enum_type_diffp);
+abi_dump::ElfObject ConvertElfObjectIR(const ElfObjectIR *elf_object_ir);
 
-  static abi_diff::FunctionDeclDiff ConvertFunctionDiffIR(
-      const FunctionDiffIR *function_diffp);
+abi_dump::RecordType ConvertRecordTypeIR(const RecordTypeIR *recordp);
 
-  static abi_diff::GlobalVarDeclDiff ConvertGlobalVarDiffIR(
-      const GlobalVarDiffIR *global_var_diffp);
-};
+abi_dump::EnumType ConvertEnumTypeIR(const EnumTypeIR *enump);
 
 
 }  // namespace repr
diff --git a/vndk/tools/header-checker/src/repr/protobuf/ir_diff_dumper.cpp b/vndk/tools/header-checker/src/repr/protobuf/ir_diff_dumper.cpp
index 0dab87bf4..7d8ff0d5a 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/ir_diff_dumper.cpp
+++ b/vndk/tools/header-checker/src/repr/protobuf/ir_diff_dumper.cpp
@@ -31,6 +31,256 @@
 namespace header_checker {
 namespace repr {
 
+static bool AddTypeInfoDiff(abi_diff::TypeInfoDiff *type_info_diff_protobuf,
+                            const TypeDiffIR *type_diff_ir) {
+  abi_diff::TypeInfo *old_type_info_protobuf =
+      type_info_diff_protobuf->mutable_old_type_info();
+  abi_diff::TypeInfo *new_type_info_protobuf =
+      type_info_diff_protobuf->mutable_new_type_info();
+  if (old_type_info_protobuf == nullptr || new_type_info_protobuf == nullptr) {
+    return false;
+  }
+  const std::pair<uint64_t, uint64_t> &sizes = type_diff_ir->GetSizes();
+  const std::pair<uint32_t, uint32_t> &alignments =
+      type_diff_ir->GetAlignments();
+  old_type_info_protobuf->set_size(sizes.first);
+  new_type_info_protobuf->set_size(sizes.second);
+
+  old_type_info_protobuf->set_alignment(alignments.first);
+  new_type_info_protobuf->set_alignment(alignments.second);
+  return true;
+}
+
+static bool AddVTableLayoutDiff(
+    abi_diff::VTableLayoutDiff *vtable_layout_diff_protobuf,
+    const VTableLayoutDiffIR *vtable_layout_diff_ir) {
+  abi_dump::VTableLayout *old_vtable =
+      vtable_layout_diff_protobuf->mutable_old_vtable();
+  abi_dump::VTableLayout *new_vtable =
+      vtable_layout_diff_protobuf->mutable_new_vtable();
+  if (old_vtable == nullptr || new_vtable == nullptr ||
+      !ConvertVTableLayoutIR(old_vtable,
+                             vtable_layout_diff_ir->GetOldVTable()) ||
+      !ConvertVTableLayoutIR(new_vtable,
+                             vtable_layout_diff_ir->GetNewVTable())) {
+    return false;
+  }
+  return true;
+}
+
+static bool CopyBaseSpecifiersDiffIRToProtobuf(
+    google::protobuf::RepeatedPtrField<abi_dump::CXXBaseSpecifier> *dst,
+    const std::vector<CXXBaseSpecifierIR> &bases_ir) {
+  for (auto &&base_ir : bases_ir) {
+    abi_dump::CXXBaseSpecifier *added_base = dst->Add();
+    if (!ConvertCXXBaseSpecifierIR(added_base, base_ir)) {
+      return false;
+    }
+  }
+  return true;
+}
+
+static bool AddBaseSpecifierDiffs(
+    abi_diff::CXXBaseSpecifierDiff *base_specifiers_diff_protobuf,
+    const CXXBaseSpecifierDiffIR *base_specifiers_diff_ir) {
+  if (!CopyBaseSpecifiersDiffIRToProtobuf(
+          base_specifiers_diff_protobuf->mutable_old_bases(),
+          base_specifiers_diff_ir->GetOldBases()) ||
+      !CopyBaseSpecifiersDiffIRToProtobuf(
+          base_specifiers_diff_protobuf->mutable_new_bases(),
+          base_specifiers_diff_ir->GetNewBases())) {
+    return false;
+  }
+  return true;
+}
+
+static bool AddRecordFields(
+    abi_diff::RecordTypeDiff *record_diff_protobuf,
+    const std::vector<const RecordFieldIR *> &record_fields_ir,
+    bool field_removed) {
+  for (auto &&record_field_ir : record_fields_ir) {
+    abi_dump::RecordFieldDecl *field = nullptr;
+    if (field_removed) {
+      field = record_diff_protobuf->add_fields_removed();
+    } else {
+      field = record_diff_protobuf->add_fields_added();
+    }
+    if (!ConvertRecordFieldIR(field, record_field_ir)) {
+      return false;
+    }
+  }
+  return true;
+}
+
+static bool AddRecordFieldDiffs(
+    abi_diff::RecordTypeDiff *record_diff_protobuf,
+    const std::vector<RecordFieldDiffIR> &record_field_diffs_ir) {
+  for (auto &&record_field_diff_ir : record_field_diffs_ir) {
+    abi_diff::RecordFieldDeclDiff *record_field_diff =
+        record_diff_protobuf->add_fields_diff();
+    if (record_field_diff == nullptr) {
+      return false;
+    }
+    abi_dump::RecordFieldDecl *old_field =
+        record_field_diff->mutable_old_field();
+    abi_dump::RecordFieldDecl *new_field =
+        record_field_diff->mutable_new_field();
+    if (old_field == nullptr || new_field == nullptr) {
+      return false;
+    }
+    ConvertRecordFieldIR(old_field, record_field_diff_ir.GetOldField());
+    ConvertRecordFieldIR(new_field, record_field_diff_ir.GetNewField());
+  }
+  return true;
+}
+
+static abi_diff::RecordTypeDiff ConvertRecordTypeDiffIR(
+    const RecordTypeDiffIR *record_type_diff_ir) {
+  abi_diff::RecordTypeDiff record_type_diff_protobuf;
+  record_type_diff_protobuf.set_name(record_type_diff_ir->GetName());
+  record_type_diff_protobuf.set_linker_set_key(
+      record_type_diff_ir->GetLinkerSetKey());
+  // If a type_info diff exists
+  const TypeDiffIR *type_diff_ir = record_type_diff_ir->GetTypeDiff();
+  if (type_diff_ir != nullptr) {
+    abi_diff::TypeInfoDiff *type_info_diff =
+        record_type_diff_protobuf.mutable_type_info_diff();
+    if (!AddTypeInfoDiff(type_info_diff, type_diff_ir)) {
+      llvm::errs() << "RecordType could not be converted\n";
+      ::exit(1);
+    }
+  }
+  // If vtables differ.
+  const VTableLayoutDiffIR *vtable_layout_diff_ir =
+      record_type_diff_ir->GetVTableLayoutDiff();
+  if (vtable_layout_diff_ir != nullptr) {
+    abi_diff::VTableLayoutDiff *vtable_layout_diff_protobuf =
+        record_type_diff_protobuf.mutable_vtable_layout_diff();
+    if (!AddVTableLayoutDiff(vtable_layout_diff_protobuf,
+                             vtable_layout_diff_ir)) {
+      llvm::errs() << "VTable layout diff could not be added\n";
+      ::exit(1);
+    }
+  }
+  // If base specifiers differ.
+  const CXXBaseSpecifierDiffIR *base_specifier_diff_ir =
+      record_type_diff_ir->GetBaseSpecifiers();
+  if (base_specifier_diff_ir != nullptr) {
+    abi_diff::CXXBaseSpecifierDiff *base_specifier_diff_protobuf =
+        record_type_diff_protobuf.mutable_bases_diff();
+    if (!AddBaseSpecifierDiffs(base_specifier_diff_protobuf,
+                               base_specifier_diff_ir)) {
+      llvm::errs() << "Base Specifier diff could not be added\n";
+      ::exit(1);
+    }
+  }
+  // Field diffs
+  if (!AddRecordFields(&record_type_diff_protobuf,
+                       record_type_diff_ir->GetFieldsRemoved(), true) ||
+      !AddRecordFields(&record_type_diff_protobuf,
+                       record_type_diff_ir->GetFieldsAdded(), false) ||
+      !AddRecordFieldDiffs(&record_type_diff_protobuf,
+                           record_type_diff_ir->GetFieldDiffs())) {
+    llvm::errs() << "Record Field diff could not be added\n";
+    ::exit(1);
+  }
+  return record_type_diff_protobuf;
+}
+
+static bool AddEnumUnderlyingTypeDiff(
+    abi_diff::UnderlyingTypeDiff *underlying_type_diff_protobuf,
+    const std::pair<std::string, std::string> *underlying_type_diff_ir) {
+  if (underlying_type_diff_protobuf == nullptr) {
+    return false;
+  }
+  underlying_type_diff_protobuf->set_old_type(underlying_type_diff_ir->first);
+  underlying_type_diff_protobuf->set_new_type(underlying_type_diff_ir->second);
+  return true;
+}
+
+static bool AddEnumFields(
+    google::protobuf::RepeatedPtrField<abi_dump::EnumFieldDecl> *dst,
+    const std::vector<const EnumFieldIR *> &enum_fields) {
+  for (auto &&enum_field : enum_fields) {
+    abi_dump::EnumFieldDecl *added_enum_field = dst->Add();
+    if (!ConvertEnumFieldIR(added_enum_field, enum_field)) {
+      return false;
+    }
+  }
+  return true;
+}
+
+static bool AddEnumFieldDiffs(
+    google::protobuf::RepeatedPtrField<abi_diff::EnumFieldDeclDiff> *dst,
+    const std::vector<EnumFieldDiffIR> &fields_diff_ir) {
+  for (auto &&field_diff_ir : fields_diff_ir) {
+    abi_diff::EnumFieldDeclDiff *field_diff_protobuf = dst->Add();
+    if (field_diff_protobuf == nullptr) {
+      return false;
+    }
+    if (!ConvertEnumFieldIR(field_diff_protobuf->mutable_old_field(),
+                            field_diff_ir.GetOldField()) ||
+        !ConvertEnumFieldIR(field_diff_protobuf->mutable_new_field(),
+                            field_diff_ir.GetNewField())) {
+      return false;
+    }
+  }
+  return true;
+}
+
+static abi_diff::EnumTypeDiff ConvertEnumTypeDiffIR(
+    const EnumTypeDiffIR *enum_type_diff_ir) {
+  abi_diff::EnumTypeDiff enum_type_diff_protobuf;
+  enum_type_diff_protobuf.set_name(enum_type_diff_ir->GetName());
+  enum_type_diff_protobuf.set_linker_set_key(
+      enum_type_diff_ir->GetLinkerSetKey());
+  const std::pair<std::string, std::string> *underlying_type_diff =
+      enum_type_diff_ir->GetUnderlyingTypeDiff();
+  if ((underlying_type_diff != nullptr &&
+       !AddEnumUnderlyingTypeDiff(
+           enum_type_diff_protobuf.mutable_underlying_type_diff(),
+           underlying_type_diff)) ||
+      !AddEnumFields(enum_type_diff_protobuf.mutable_fields_removed(),
+                     enum_type_diff_ir->GetFieldsRemoved()) ||
+      !AddEnumFields(enum_type_diff_protobuf.mutable_fields_added(),
+                     enum_type_diff_ir->GetFieldsAdded()) ||
+      !AddEnumFieldDiffs(enum_type_diff_protobuf.mutable_fields_diff(),
+                         enum_type_diff_ir->GetFieldsDiff())) {
+    llvm::errs() << "Enum field diff could not be added\n";
+    ::exit(1);
+  }
+  return enum_type_diff_protobuf;
+}
+
+static abi_diff::GlobalVarDeclDiff ConvertGlobalVarDiffIR(
+    const GlobalVarDiffIR *global_var_diff_ir) {
+  abi_diff::GlobalVarDeclDiff global_var_diff;
+  global_var_diff.set_name(global_var_diff_ir->GetName());
+  abi_dump::GlobalVarDecl *old_global_var = global_var_diff.mutable_old();
+  abi_dump::GlobalVarDecl *new_global_var = global_var_diff.mutable_new_();
+  if (old_global_var == nullptr || new_global_var == nullptr) {
+    llvm::errs() << "Globar Var diff could not be added\n";
+    ::exit(1);
+  }
+  *old_global_var = ConvertGlobalVarIR(global_var_diff_ir->GetOldGlobalVar());
+  *new_global_var = ConvertGlobalVarIR(global_var_diff_ir->GetNewGlobalVar());
+  return global_var_diff;
+}
+
+static abi_diff::FunctionDeclDiff ConvertFunctionDiffIR(
+    const FunctionDiffIR *function_diff_ir) {
+  abi_diff::FunctionDeclDiff function_diff;
+  function_diff.set_name(function_diff_ir->GetName());
+  abi_dump::FunctionDecl *old_function = function_diff.mutable_old();
+  abi_dump::FunctionDecl *new_function = function_diff.mutable_new_();
+  if (old_function == nullptr || new_function == nullptr) {
+    llvm::errs() << "Function diff could not be added\n";
+    ::exit(1);
+  }
+  *old_function = ConvertFunctionIR(function_diff_ir->GetOldFunction());
+  *new_function = ConvertFunctionIR(function_diff_ir->GetNewFunction());
+  return function_diff;
+}
 
 void ProtobufIRDiffDumper::AddLibNameIR(const std::string &name) {
   diff_tu_->set_lib_name(name);
@@ -77,6 +327,11 @@ CompatibilityStatusIR ProtobufIRDiffDumper::GetCompatibilityStatusIR() {
     combined_status = combined_status | CompatibilityStatusIR::ElfIncompatible;
   }
 
+  if (diff_tu_->added_elf_functions().size() != 0 ||
+      diff_tu_->added_elf_objects().size() != 0) {
+    combined_status = combined_status | CompatibilityStatusIR::ElfExtension;
+  }
+
   return combined_status;
 }
 
@@ -166,8 +421,7 @@ bool ProtobufIRDiffDumper::AddElfFunctionIR(
   if (added_elf_function == nullptr) {
     return false;
   }
-  *added_elf_function =
-      IRToProtobufConverter::ConvertElfFunctionIR(elf_function_ir);
+  *added_elf_function = ConvertElfFunctionIR(elf_function_ir);
   return true;
 }
 
@@ -188,8 +442,7 @@ bool ProtobufIRDiffDumper::AddElfObjectIR(
   if (added_elf_object == nullptr) {
     return false;
   }
-  *added_elf_object =
-      IRToProtobufConverter::ConvertElfObjectIR(elf_object_ir);
+  *added_elf_object = ConvertElfObjectIR(elf_object_ir);
   return true;
 }
 
@@ -213,8 +466,7 @@ bool ProtobufIRDiffDumper::AddLoneRecordTypeDiffIR(
   if (added_record_type == nullptr) {
     return false;
   }
-  *added_record_type =
-      IRToProtobufConverter::ConvertRecordTypeIR(record_type_ir);
+  *added_record_type = ConvertRecordTypeIR(record_type_ir);
   return true;
 }
 
@@ -232,7 +484,7 @@ bool ProtobufIRDiffDumper::AddLoneFunctionDiffIR(
       llvm::errs() << "Invalid call to AddLoneFunctionDiffIR\n";
       return false;
   }
-  *added_function = IRToProtobufConverter::ConvertFunctionIR(function_ir);
+  *added_function = ConvertFunctionIR(function_ir);
   return true;
 }
 
@@ -256,7 +508,7 @@ bool ProtobufIRDiffDumper::AddLoneEnumTypeDiffIR(
   if (added_enum_type == nullptr) {
     return false;
   }
-  *added_enum_type = IRToProtobufConverter::ConvertEnumTypeIR(enum_type_ir);
+  *added_enum_type = ConvertEnumTypeIR(enum_type_ir);
   return true;
 }
 
@@ -274,7 +526,7 @@ bool ProtobufIRDiffDumper::AddLoneGlobalVarDiffIR(
       llvm::errs() << "Invalid call to AddLoneFunctionDiffIR\n";
       return false;
   }
-  *added_global_var = IRToProtobufConverter::ConvertGlobalVarIR(global_var_ir);
+  *added_global_var = ConvertGlobalVarIR(global_var_ir);
   return true;
 }
 
@@ -306,8 +558,7 @@ bool ProtobufIRDiffDumper::AddRecordTypeDiffIR(
     return false;
   }
 
-  *added_record_type_diff =
-      IRDiffToProtobufConverter::ConvertRecordTypeDiffIR(record_diff_ir);
+  *added_record_type_diff = ConvertRecordTypeDiffIR(record_diff_ir);
   added_record_type_diff->set_type_stack(type_stack);
   return true;
 }
@@ -321,8 +572,7 @@ bool ProtobufIRDiffDumper::AddFunctionDiffIR(
   if (!added_function_diff) {
     return false;
   }
-  *added_function_diff =
-      IRDiffToProtobufConverter::ConvertFunctionDiffIR(function_diff_ir);
+  *added_function_diff = ConvertFunctionDiffIR(function_diff_ir);
   return true;
 }
 
@@ -355,8 +605,7 @@ bool ProtobufIRDiffDumper::AddEnumTypeDiffIR(const EnumTypeDiffIR *enum_diff_ir,
   if (!added_enum_type_diff) {
     return false;
   }
-  *added_enum_type_diff =
-      IRDiffToProtobufConverter::ConvertEnumTypeDiffIR(enum_diff_ir);
+  *added_enum_type_diff = ConvertEnumTypeDiffIR(enum_diff_ir);
   added_enum_type_diff->set_type_stack(type_stack);
   return true;
 }
@@ -369,8 +618,7 @@ bool ProtobufIRDiffDumper::AddGlobalVarDiffIR(
   if (!added_global_var_diff) {
     return false;
   }
-  *added_global_var_diff =
-      IRDiffToProtobufConverter::ConvertGlobalVarDiffIR(global_var_diff_ir);
+  *added_global_var_diff = ConvertGlobalVarDiffIR(global_var_diff_ir);
   return true;
 }
 
diff --git a/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.cpp b/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.cpp
index 317cd773a..8081e4975 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.cpp
+++ b/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.cpp
@@ -16,6 +16,7 @@
 
 #include "repr/protobuf/abi_dump.h"
 #include "repr/protobuf/api.h"
+#include "repr/protobuf/converter.h"
 
 #include <fstream>
 #include <memory>
@@ -29,9 +30,8 @@
 namespace header_checker {
 namespace repr {
 
-
-bool IRToProtobufConverter::AddTemplateInformation(
-    abi_dump::TemplateInfo *ti, const TemplatedArtifactIR *ta) {
+static bool AddTemplateInformation(abi_dump::TemplateInfo *ti,
+                                   const TemplatedArtifactIR *ta) {
   for (auto &&template_element : ta->GetTemplateElements()) {
     abi_dump::TemplateElement *added_element = ti->add_elements();
     if (!added_element) {
@@ -43,8 +43,8 @@ bool IRToProtobufConverter::AddTemplateInformation(
   return true;
 }
 
-bool IRToProtobufConverter::AddTypeInfo(
-    abi_dump::BasicNamedAndTypedDecl *type_info, const TypeIR *typep) {
+static bool AddTypeInfo(abi_dump::BasicNamedAndTypedDecl *type_info,
+                        const TypeIR *typep) {
   if (!type_info || !typep) {
     llvm::errs() << "Typeinfo not valid\n";
     return false;
@@ -59,9 +59,29 @@ bool IRToProtobufConverter::AddTypeInfo(
   return true;
 }
 
-bool IRToProtobufConverter::ConvertRecordFieldIR(
-    abi_dump::RecordFieldDecl *record_field_protobuf,
-    const RecordFieldIR *record_field_ir) {
+template <typename HasAvailabilityAttrsMessage>
+void AddAvailabilityAttrs(HasAvailabilityAttrsMessage *decl_protobuf,
+                          const HasAvailabilityAttrs *decl_ir) {
+  for (const AvailabilityAttrIR &attr : decl_ir->GetAvailabilityAttrs()) {
+    abi_dump::AvailabilityAttr *attr_protobuf =
+        decl_protobuf->add_availability_attrs();
+    if (auto introduced = attr.GetIntroduced(); introduced.has_value()) {
+      attr_protobuf->set_introduced_major(introduced.value());
+    }
+    if (auto deprecated = attr.GetDeprecated(); deprecated.has_value()) {
+      attr_protobuf->set_deprecated_major(deprecated.value());
+    }
+    if (auto obsoleted = attr.GetObsoleted(); obsoleted.has_value()) {
+      attr_protobuf->set_obsoleted_major(obsoleted.value());
+    }
+    if (attr.IsUnavailable()) {
+      attr_protobuf->set_unavailable(true);
+    }
+  }
+}
+
+bool ConvertRecordFieldIR(abi_dump::RecordFieldDecl *record_field_protobuf,
+                          const RecordFieldIR *record_field_ir) {
   if (!record_field_protobuf) {
     llvm::errs() << "Invalid record field\n";
     return false;
@@ -76,21 +96,22 @@ bool IRToProtobufConverter::ConvertRecordFieldIR(
     record_field_protobuf->set_is_bit_field(true);
     record_field_protobuf->set_bit_width(record_field_ir->GetBitWidth());
   }
+  AddAvailabilityAttrs(record_field_protobuf, record_field_ir);
   return true;
 }
 
-bool IRToProtobufConverter::AddRecordFields(
-    abi_dump::RecordType *record_protobuf, const RecordTypeIR *record_ir) {
+static bool AddRecordFields(abi_dump::RecordType *record_protobuf,
+                            const RecordTypeIR *record_ir) {
   for (auto &&field_ir : record_ir->GetFields()) {
     abi_dump::RecordFieldDecl *added_field = record_protobuf->add_fields();
-    if (!IRToProtobufConverter::ConvertRecordFieldIR(added_field, &field_ir)) {
+    if (!ConvertRecordFieldIR(added_field, &field_ir)) {
       return false;
     }
   }
   return true;
 }
 
-bool IRToProtobufConverter::ConvertCXXBaseSpecifierIR(
+bool ConvertCXXBaseSpecifierIR(
     abi_dump::CXXBaseSpecifier *base_specifier_protobuf,
     const CXXBaseSpecifierIR &base_specifier_ir) {
   if (!base_specifier_protobuf) {
@@ -105,8 +126,8 @@ bool IRToProtobufConverter::ConvertCXXBaseSpecifierIR(
   return true;
 }
 
-bool IRToProtobufConverter::AddBaseSpecifiers(
-    abi_dump::RecordType *record_protobuf, const RecordTypeIR *record_ir) {
+static bool AddBaseSpecifiers(abi_dump::RecordType *record_protobuf,
+                              const RecordTypeIR *record_ir) {
   for (auto &&base_ir : record_ir->GetBases()) {
     abi_dump::CXXBaseSpecifier *added_base =
         record_protobuf->add_base_specifiers();
@@ -117,9 +138,8 @@ bool IRToProtobufConverter::AddBaseSpecifiers(
   return true;
 }
 
-bool IRToProtobufConverter::ConvertVTableLayoutIR(
-    abi_dump::VTableLayout *vtable_layout_protobuf,
-    const VTableLayoutIR &vtable_layout_ir) {
+bool ConvertVTableLayoutIR(abi_dump::VTableLayout *vtable_layout_protobuf,
+                           const VTableLayoutIR &vtable_layout_ir) {
   if (vtable_layout_protobuf == nullptr) {
     llvm::errs() << "vtable layout protobuf not valid\n";
     return false;
@@ -141,9 +161,8 @@ bool IRToProtobufConverter::ConvertVTableLayoutIR(
   return true;
 }
 
-bool IRToProtobufConverter::AddVTableLayout(
-    abi_dump::RecordType *record_protobuf,
-    const RecordTypeIR *record_ir) {
+static bool AddVTableLayout(abi_dump::RecordType *record_protobuf,
+                            const RecordTypeIR *record_ir) {
   // If there are no entries in the vtable, just return.
   if (record_ir->GetVTableNumEntries() == 0) {
     return true;
@@ -157,8 +176,7 @@ bool IRToProtobufConverter::AddVTableLayout(
   return true;
 }
 
-abi_dump::RecordType IRToProtobufConverter::ConvertRecordTypeIR(
-    const RecordTypeIR *recordp) {
+abi_dump::RecordType ConvertRecordTypeIR(const RecordTypeIR *recordp) {
   abi_dump::RecordType added_record_type;
   added_record_type.set_access(AccessIRToProtobuf(recordp->GetAccess()));
   added_record_type.set_record_kind(
@@ -176,11 +194,11 @@ abi_dump::RecordType IRToProtobufConverter::ConvertRecordTypeIR(
     llvm::errs() << "Template information could not be added\n";
     ::exit(1);
   }
+  AddAvailabilityAttrs(&added_record_type, recordp);
   return added_record_type;
 }
 
-abi_dump::ElfObject IRToProtobufConverter::ConvertElfObjectIR(
-    const ElfObjectIR *elf_object_ir) {
+abi_dump::ElfObject ConvertElfObjectIR(const ElfObjectIR *elf_object_ir) {
   abi_dump::ElfObject elf_object_protobuf;
   elf_object_protobuf.set_name(elf_object_ir->GetName());
   elf_object_protobuf.set_binding(
@@ -188,7 +206,7 @@ abi_dump::ElfObject IRToProtobufConverter::ConvertElfObjectIR(
   return elf_object_protobuf;
 }
 
-abi_dump::ElfFunction IRToProtobufConverter::ConvertElfFunctionIR(
+abi_dump::ElfFunction ConvertElfFunctionIR(
     const ElfFunctionIR *elf_function_ir) {
   abi_dump::ElfFunction elf_function_protobuf;
   elf_function_protobuf.set_name(elf_function_ir->GetName());
@@ -198,7 +216,7 @@ abi_dump::ElfFunction IRToProtobufConverter::ConvertElfFunctionIR(
 }
 
 template <typename CFunctionLikeMessage>
-bool IRToProtobufConverter::AddFunctionParametersAndSetReturnType(
+static bool AddFunctionParametersAndSetReturnType(
     CFunctionLikeMessage *function_like_protobuf,
     const CFunctionLikeIR *cfunction_like_ir) {
   function_like_protobuf->set_return_type(cfunction_like_ir->GetReturnType());
@@ -206,9 +224,8 @@ bool IRToProtobufConverter::AddFunctionParametersAndSetReturnType(
 }
 
 template <typename CFunctionLikeMessage>
-bool IRToProtobufConverter::AddFunctionParameters(
-    CFunctionLikeMessage *function_like_protobuf,
-    const CFunctionLikeIR *cfunction_like_ir) {
+static bool AddFunctionParameters(CFunctionLikeMessage *function_like_protobuf,
+                                  const CFunctionLikeIR *cfunction_like_ir) {
   for (auto &&parameter : cfunction_like_ir->GetParameters()) {
     abi_dump::ParamDecl *added_parameter =
         function_like_protobuf->add_parameters();
@@ -223,7 +240,7 @@ bool IRToProtobufConverter::AddFunctionParameters(
   return true;
 }
 
-abi_dump::FunctionType IRToProtobufConverter::ConvertFunctionTypeIR (
+static abi_dump::FunctionType ConvertFunctionTypeIR(
     const FunctionTypeIR *function_typep) {
   abi_dump::FunctionType added_function_type;
   if (!AddTypeInfo(added_function_type.mutable_type_info(), function_typep) ||
@@ -235,8 +252,7 @@ abi_dump::FunctionType IRToProtobufConverter::ConvertFunctionTypeIR (
   return added_function_type;
 }
 
-abi_dump::FunctionDecl IRToProtobufConverter::ConvertFunctionIR(
-    const FunctionIR *functionp) {
+abi_dump::FunctionDecl ConvertFunctionIR(const FunctionIR *functionp) {
   abi_dump::FunctionDecl added_function;
   added_function.set_access(AccessIRToProtobuf(functionp->GetAccess()));
   added_function.set_linker_set_key(functionp->GetLinkerSetKey());
@@ -249,12 +265,12 @@ abi_dump::FunctionDecl IRToProtobufConverter::ConvertFunctionIR(
     llvm::errs() << "Template information could not be added\n";
     ::exit(1);
   }
+  AddAvailabilityAttrs(&added_function, functionp);
   return added_function;
 }
 
-bool IRToProtobufConverter::ConvertEnumFieldIR(
-    abi_dump::EnumFieldDecl *enum_field_protobuf,
-    const EnumFieldIR *enum_field_ir) {
+bool ConvertEnumFieldIR(abi_dump::EnumFieldDecl *enum_field_protobuf,
+                        const EnumFieldIR *enum_field_ir) {
   if (enum_field_protobuf == nullptr) {
     llvm::errs() << "Invalid enum field\n";
     return false;
@@ -265,11 +281,12 @@ bool IRToProtobufConverter::ConvertEnumFieldIR(
   // dump file. Despite the wrong representation, the diff result isn't affected
   // because every integer has a unique representation.
   enum_field_protobuf->set_enum_field_value(enum_field_ir->GetSignedValue());
+  AddAvailabilityAttrs(enum_field_protobuf, enum_field_ir);
   return true;
 }
 
-bool IRToProtobufConverter::AddEnumFields(abi_dump::EnumType *enum_protobuf,
-                                          const EnumTypeIR *enum_ir) {
+static bool AddEnumFields(abi_dump::EnumType *enum_protobuf,
+                          const EnumTypeIR *enum_ir) {
   for (auto &&field : enum_ir->GetFields()) {
     abi_dump::EnumFieldDecl *enum_fieldp = enum_protobuf->add_enum_fields();
     if (!ConvertEnumFieldIR(enum_fieldp, &field)) {
@@ -279,9 +296,7 @@ bool IRToProtobufConverter::AddEnumFields(abi_dump::EnumType *enum_protobuf,
   return true;
 }
 
-
-abi_dump::EnumType IRToProtobufConverter::ConvertEnumTypeIR(
-    const EnumTypeIR *enump) {
+abi_dump::EnumType ConvertEnumTypeIR(const EnumTypeIR *enump) {
   abi_dump::EnumType added_enum_type;
   added_enum_type.set_access(AccessIRToProtobuf(enump->GetAccess()));
   added_enum_type.set_underlying_type(enump->GetUnderlyingType());
@@ -290,11 +305,11 @@ abi_dump::EnumType IRToProtobufConverter::ConvertEnumTypeIR(
     llvm::errs() << "EnumTypeIR could not be converted\n";
     ::exit(1);
   }
+  AddAvailabilityAttrs(&added_enum_type, enump);
   return added_enum_type;
 }
 
-abi_dump::GlobalVarDecl IRToProtobufConverter::ConvertGlobalVarIR(
-    const GlobalVarIR *global_varp) {
+abi_dump::GlobalVarDecl ConvertGlobalVarIR(const GlobalVarIR *global_varp) {
   abi_dump::GlobalVarDecl added_global_var;
   added_global_var.set_referenced_type(global_varp->GetReferencedType());
   added_global_var.set_source_file(global_varp->GetSourceFile());
@@ -302,10 +317,11 @@ abi_dump::GlobalVarDecl IRToProtobufConverter::ConvertGlobalVarIR(
   added_global_var.set_linker_set_key(global_varp->GetLinkerSetKey());
   added_global_var.set_access(
       AccessIRToProtobuf(global_varp->GetAccess()));
+  AddAvailabilityAttrs(&added_global_var, global_varp);
   return added_global_var;
 }
 
-abi_dump::PointerType IRToProtobufConverter::ConvertPointerTypeIR(
+static abi_dump::PointerType ConvertPointerTypeIR(
     const PointerTypeIR *pointerp) {
   abi_dump::PointerType added_pointer_type;
   if (!AddTypeInfo(added_pointer_type.mutable_type_info(), pointerp)) {
@@ -315,7 +331,7 @@ abi_dump::PointerType IRToProtobufConverter::ConvertPointerTypeIR(
   return added_pointer_type;
 }
 
-abi_dump::QualifiedType IRToProtobufConverter::ConvertQualifiedTypeIR(
+static abi_dump::QualifiedType ConvertQualifiedTypeIR(
     const QualifiedTypeIR *qualtypep) {
   abi_dump::QualifiedType added_qualified_type;
   if (!AddTypeInfo(added_qualified_type.mutable_type_info(), qualtypep)) {
@@ -328,7 +344,7 @@ abi_dump::QualifiedType IRToProtobufConverter::ConvertQualifiedTypeIR(
   return added_qualified_type;
 }
 
-abi_dump::BuiltinType IRToProtobufConverter::ConvertBuiltinTypeIR(
+static abi_dump::BuiltinType ConvertBuiltinTypeIR(
     const BuiltinTypeIR *builtin_typep) {
   abi_dump::BuiltinType added_builtin_type;
   added_builtin_type.set_is_unsigned(builtin_typep->IsUnsigned());
@@ -340,8 +356,7 @@ abi_dump::BuiltinType IRToProtobufConverter::ConvertBuiltinTypeIR(
   return added_builtin_type;
 }
 
-abi_dump::ArrayType IRToProtobufConverter::ConvertArrayTypeIR(
-    const ArrayTypeIR *array_typep) {
+static abi_dump::ArrayType ConvertArrayTypeIR(const ArrayTypeIR *array_typep) {
   abi_dump::ArrayType added_array_type;
   added_array_type.set_is_of_unknown_bound(array_typep->IsOfUnknownBound());
   if (!AddTypeInfo(added_array_type.mutable_type_info(), array_typep)) {
@@ -351,8 +366,7 @@ abi_dump::ArrayType IRToProtobufConverter::ConvertArrayTypeIR(
   return added_array_type;
 }
 
-abi_dump::LvalueReferenceType
-IRToProtobufConverter::ConvertLvalueReferenceTypeIR(
+static abi_dump::LvalueReferenceType ConvertLvalueReferenceTypeIR(
     const LvalueReferenceTypeIR *lvalue_reference_typep) {
   abi_dump::LvalueReferenceType added_lvalue_reference_type;
   if (!AddTypeInfo(added_lvalue_reference_type.mutable_type_info(),
@@ -363,8 +377,7 @@ IRToProtobufConverter::ConvertLvalueReferenceTypeIR(
   return added_lvalue_reference_type;
 }
 
-abi_dump::RvalueReferenceType
-IRToProtobufConverter::ConvertRvalueReferenceTypeIR(
+static abi_dump::RvalueReferenceType ConvertRvalueReferenceTypeIR(
     const RvalueReferenceTypeIR *rvalue_reference_typep) {
   abi_dump::RvalueReferenceType added_rvalue_reference_type;
   if (!AddTypeInfo(added_rvalue_reference_type.mutable_type_info(),
diff --git a/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.h b/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.h
index e5ed27882..f55fc355c 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.h
+++ b/vndk/tools/header-checker/src/repr/protobuf/ir_dumper.h
@@ -17,7 +17,6 @@
 
 #include "repr/ir_dumper.h"
 #include "repr/protobuf/abi_dump.h"
-#include "repr/protobuf/converter.h"
 #include "repr/protobuf/ir_dumper.h"
 
 
@@ -25,7 +24,7 @@ namespace header_checker {
 namespace repr {
 
 
-class ProtobufIRDumper : public IRDumper, public IRToProtobufConverter {
+class ProtobufIRDumper : public IRDumper {
  private:
   // Types
   bool AddRecordTypeIR(const RecordTypeIR *);
diff --git a/vndk/tools/header-checker/src/repr/protobuf/ir_reader.cpp b/vndk/tools/header-checker/src/repr/protobuf/ir_reader.cpp
index 47c4f3761..c70f56d18 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/ir_reader.cpp
+++ b/vndk/tools/header-checker/src/repr/protobuf/ir_reader.cpp
@@ -40,6 +40,26 @@ void ProtobufIRReader::ReadTypeInfo(
   typep->SetAlignment(type_info.alignment());
 }
 
+static void ReadAvailabilityAttrs(
+    const google::protobuf::RepeatedPtrField<abi_dump::AvailabilityAttr>
+        &attrs_protobuf,
+    HasAvailabilityAttrs *decl_ir) {
+  for (const abi_dump::AvailabilityAttr &attr_protobuf : attrs_protobuf) {
+    AvailabilityAttrIR attr;
+    if (attr_protobuf.has_introduced_major()) {
+      attr.SetIntroduced(attr_protobuf.introduced_major());
+    }
+    if (attr_protobuf.has_deprecated_major()) {
+      attr.SetDeprecated(attr_protobuf.deprecated_major());
+    }
+    if (attr_protobuf.has_obsoleted_major()) {
+      attr.SetObsoleted(attr_protobuf.obsoleted_major());
+    }
+    attr.SetUnavailable(attr_protobuf.unavailable());
+    decl_ir->AddAvailabilityAttr(std::move(attr));
+  }
+}
+
 bool ProtobufIRReader::ReadDumpImpl(const std::string &dump_file) {
   abi_dump::TranslationUnit tu;
   std::ifstream input(dump_file);
@@ -105,6 +125,7 @@ FunctionIR ProtobufIRReader::FunctionProtobufToIR(
   // Set Template info
   function_ir.SetTemplateInfo(
       TemplateInfoProtobufToIR(function_protobuf.template_info()));
+  ReadAvailabilityAttrs(function_protobuf.availability_attrs(), &function_ir);
   return function_ir;
 }
 
@@ -138,6 +159,7 @@ std::vector<RecordFieldIR> ProtobufIRReader::RecordFieldsProtobufToIR(
         field.field_name(), field.referenced_type(), field.field_offset(),
         AccessProtobufToIR(field.access()), field.is_bit_field(),
         field.bit_width());
+    ReadAvailabilityAttrs(field.availability_attrs(), &record_field_ir);
     record_type_fields_ir.emplace_back(std::move(record_field_ir));
   }
   return record_type_fields_ir;
@@ -174,6 +196,8 @@ RecordTypeIR ProtobufIRReader::RecordTypeProtobufToIR(
   record_type_ir.SetRecordKind(
       RecordKindProtobufToIR(record_type_protobuf.record_kind()));
   record_type_ir.SetAnonymity(record_type_protobuf.is_anonymous());
+  ReadAvailabilityAttrs(record_type_protobuf.availability_attrs(),
+                        &record_type_ir);
   return record_type_ir;
 }
 
@@ -181,7 +205,11 @@ std::vector<EnumFieldIR> ProtobufIRReader::EnumFieldsProtobufToIR(
     const google::protobuf::RepeatedPtrField<abi_dump::EnumFieldDecl> &efp) {
   std::vector<EnumFieldIR> enum_type_fields_ir;
   for (auto &&field : efp) {
-    EnumFieldIR enum_field_ir(field.name(), field.enum_field_value());
+    EnumFieldIR enum_field_ir;
+    enum_field_ir.SetName(field.name());
+    // enum_field_value is declared as int64.
+    enum_field_ir.SetSignedValue(field.enum_field_value());
+    ReadAvailabilityAttrs(field.availability_attrs(), &enum_field_ir);
     enum_type_fields_ir.emplace_back(std::move(enum_field_ir));
   }
   return enum_type_fields_ir;
@@ -195,6 +223,7 @@ EnumTypeIR ProtobufIRReader::EnumTypeProtobufToIR(
   enum_type_ir.SetAccess(AccessProtobufToIR(enum_type_protobuf.access()));
   enum_type_ir.SetFields(
       EnumFieldsProtobufToIR(enum_type_protobuf.enum_fields()));
+  ReadAvailabilityAttrs(enum_type_protobuf.availability_attrs(), &enum_type_ir);
   return enum_type_ir;
 }
 
@@ -209,6 +238,8 @@ void ProtobufIRReader::ReadGlobalVariables(
         global_variable_protobuf.referenced_type());
     global_variable_ir.SetLinkerSetKey(
         global_variable_protobuf.linker_set_key());
+    ReadAvailabilityAttrs(global_variable_protobuf.availability_attrs(),
+                          &global_variable_ir);
     module_->AddGlobalVariable(std::move(global_variable_ir));
   }
 }
@@ -319,8 +350,8 @@ void ProtobufIRReader::ReadElfObjects(const abi_dump::TranslationUnit &tu) {
 }
 
 std::unique_ptr<IRReader> CreateProtobufIRReader(
-    const std::set<std::string> *exported_headers) {
-  return std::make_unique<ProtobufIRReader>(exported_headers);
+    std::unique_ptr<ModuleIR> module_ir) {
+  return std::make_unique<ProtobufIRReader>(std::move(module_ir));
 }
 
 
diff --git a/vndk/tools/header-checker/src/repr/protobuf/ir_reader.h b/vndk/tools/header-checker/src/repr/protobuf/ir_reader.h
index b33e68670..a0cb70a95 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/ir_reader.h
+++ b/vndk/tools/header-checker/src/repr/protobuf/ir_reader.h
@@ -19,7 +19,6 @@
 #include "repr/protobuf/abi_diff.h"
 #include "repr/protobuf/abi_dump.h"
 
-#include <set>
 #include <string>
 #include <vector>
 
@@ -38,9 +37,8 @@ class ProtobufIRReader : public IRReader {
 
 
  public:
-  ProtobufIRReader(const std::set<std::string> *exported_headers)
-      : IRReader(exported_headers) {}
-
+  ProtobufIRReader(std::unique_ptr<ModuleIR> module_ir)
+      : IRReader(std::move(module_ir)) {}
 
  private:
   bool ReadDumpImpl(const std::string &dump_file) override;
diff --git a/vndk/tools/header-checker/src/repr/protobuf/proto/abi_dump.proto b/vndk/tools/header-checker/src/repr/protobuf/proto/abi_dump.proto
index 110699c23..7399c9eb4 100644
--- a/vndk/tools/header-checker/src/repr/protobuf/proto/abi_dump.proto
+++ b/vndk/tools/header-checker/src/repr/protobuf/proto/abi_dump.proto
@@ -61,6 +61,15 @@ message FunctionType {
   repeated ParamDecl parameters = 3;
 }
 
+message AvailabilityAttr {
+  // A version tuple consists of major, minor, subminor, and build.
+  // This tool dumps the major version only.
+  optional uint32 introduced_major = 1;
+  optional uint32 deprecated_major = 2;
+  optional uint32 obsoleted_major = 3;
+  optional bool unavailable = 4;
+}
+
 message FunctionDecl {
   // Return type reference
   optional string return_type = 1;
@@ -70,6 +79,7 @@ message FunctionDecl {
   optional TemplateInfo template_info = 5;
   optional string linker_set_key = 6;
   optional AccessSpecifier access = 7 [default = public_access];
+  repeated AvailabilityAttr availability_attrs = 8;
 }
 
 message ParamDecl {
@@ -85,11 +95,13 @@ message RecordFieldDecl {
   optional AccessSpecifier access = 4 [default = public_access];
   optional bool is_bit_field = 5;
   optional uint64 bit_width = 6;
+  repeated AvailabilityAttr availability_attrs = 7;
 }
 
 message EnumFieldDecl {
   optional int64 enum_field_value = 1;  // assumption: fits int64
   optional string name = 3;
+  repeated AvailabilityAttr availability_attrs = 4;
 }
 
 message TemplateInfo {
@@ -139,6 +151,7 @@ message RecordType {
   optional AccessSpecifier access = 8 [default = public_access];
   optional bool is_anonymous = 9;
   optional RecordKind record_kind = 10 [default = struct_kind];
+  repeated AvailabilityAttr availability_attrs = 11;
 }
 
 message EnumType {
@@ -146,6 +159,7 @@ message EnumType {
   optional string underlying_type = 2;
   repeated EnumFieldDecl enum_fields = 3;
   optional AccessSpecifier access = 4 [default = public_access];
+  repeated AvailabilityAttr availability_attrs = 5;
 }
 
 message GlobalVarDecl {
@@ -154,6 +168,7 @@ message GlobalVarDecl {
   optional string linker_set_key = 3;
   optional string referenced_type = 4;
   optional AccessSpecifier access = 5 [default = public_access];
+  repeated AvailabilityAttr availability_attrs = 6;
 }
 
 enum ElfSymbolBinding {
diff --git a/vndk/tools/header-checker/src/utils/command_line_utils.cpp b/vndk/tools/header-checker/src/utils/command_line_utils.cpp
index be8cb5f73..34c0c0ee1 100644
--- a/vndk/tools/header-checker/src/utils/command_line_utils.cpp
+++ b/vndk/tools/header-checker/src/utils/command_line_utils.cpp
@@ -40,7 +40,7 @@ void HideIrrelevantCommandLineOptions(
     if (IsOptionInCategory(*p.second, category)) {
       continue;
     }
-    if (p.first().startswith("help")) {
+    if (p.first().starts_with("help")) {
       continue;
     }
     p.second->setHiddenFlag(llvm::cl::Hidden);
diff --git a/vndk/tools/header-checker/src/utils/header_abi_util.h b/vndk/tools/header-checker/src/utils/header_abi_util.h
index 9915c5203..9ca60f758 100644
--- a/vndk/tools/header-checker/src/utils/header_abi_util.h
+++ b/vndk/tools/header-checker/src/utils/header_abi_util.h
@@ -93,6 +93,11 @@ std::vector<std::pair<T, T>> FindCommonElements(
   return common_elements;
 }
 
+template <typename T>
+void InsertAll(std::vector<T> &first, const std::vector<T> &second) {
+  first.insert(first.end(), second.begin(), second.end());
+}
+
 
 }  // namespace utils
 }  // namespace header_checker
diff --git a/vndk/tools/header-checker/src/utils/source_path_utils.cpp b/vndk/tools/header-checker/src/utils/source_path_utils.cpp
index d112087eb..1efec0508 100644
--- a/vndk/tools/header-checker/src/utils/source_path_utils.cpp
+++ b/vndk/tools/header-checker/src/utils/source_path_utils.cpp
@@ -34,7 +34,7 @@ static const std::vector<std::string> libcxx_include_dir{"libcxx", "include"};
 static bool HasHeaderExtension(llvm::StringRef file_name) {
   return std::find_if(header_extensions.begin(), header_extensions.end(),
                       [file_name](const std::string &e) {
-                        return file_name.endswith(e);
+                        return file_name.ends_with(e);
                       }) != header_extensions.end();
 }
 
@@ -112,19 +112,19 @@ std::string NormalizePath(std::string_view path, const RootDirs &root_dirs) {
   for (const RootDir &root_dir : root_dirs) {
     // llvm::sys::path::replace_path_prefix("AB", "A", "") returns "B", so do
     // not use it.
-    if (!norm_path.startswith(root_dir.path)) {
+    if (!norm_path.starts_with(root_dir.path)) {
       continue;
     }
     if (norm_path.size() == root_dir.path.size()) {
       return root_dir.replacement;
     }
     llvm::StringRef suffix = norm_path.substr(root_dir.path.size());
-    if (suffix.startswith(separator)) {
+    if (suffix.starts_with(separator)) {
       if (root_dir.replacement.empty()) {
         return suffix.substr(separator.size()).str();
       }
       // replacement == "/"
-      if (llvm::StringRef(root_dir.replacement).endswith(separator)) {
+      if (llvm::StringRef(root_dir.replacement).ends_with(separator)) {
         return root_dir.replacement + suffix.substr(separator.size()).str();
       }
       return root_dir.replacement + suffix.str();
@@ -155,7 +155,7 @@ static bool CollectExportedHeaderSet(const std::string &dir_name,
     const std::string &file_path = walker->path();
 
     llvm::StringRef file_name(llvm::sys::path::filename(file_path));
-    if (file_name.empty() || file_name.startswith(".")) {
+    if (file_name.empty() || file_name.starts_with(".")) {
       // Ignore hidden files and directories.
       walker.no_push();
       continue;
diff --git a/vndk/tools/header-checker/tests/integration/availability/include/base.h b/vndk/tools/header-checker/tests/integration/availability/include/base.h
new file mode 100644
index 000000000..3325a69cd
--- /dev/null
+++ b/vndk/tools/header-checker/tests/integration/availability/include/base.h
@@ -0,0 +1,35 @@
+#define __INTRODUCED_IN(api_level) \
+  __attribute__((__availability__(android, introduced = api_level)))
+
+#define __DEPRECATED_IN(api_level) \
+  __attribute__((__availability__(android, deprecated = api_level)))
+
+#define __OBSOLETED_IN(api_level) \
+  __attribute__((__availability__(android, obsoleted = api_level)))
+
+#define __UNAVAILABLE __attribute__((__availability__(android, unavailable)))
+
+struct Struct {
+  int ignored_field __INTRODUCED_IN(36)
+      __attribute__((availability(macos, introduced = 35)));
+  int field __attribute__((availability(macos, unavailable)));
+} __INTRODUCED_IN(35);
+
+struct IgnoredStruct {
+  int field;
+} __INTRODUCED_IN(36);
+
+enum {
+  ALPHABETICALLY_SMALLEST_IGNORED_FIELD __INTRODUCED_IN(36),
+  DEPRECATED __DEPRECATED_IN(35),
+  FIELD,
+  OBSOLETED __OBSOLETED_IN(35),
+  UNAVAILABLE __UNAVAILABLE
+} __INTRODUCED_IN(35);
+
+extern "C" {
+int func(Struct*, IgnoredStruct*) __INTRODUCED_IN(35);
+int ignored_func() __INTRODUCED_IN(36);
+int var __INTRODUCED_IN(35) __OBSOLETED_IN(36);
+int ignored_var __INTRODUCED_IN(36);
+}
diff --git a/vndk/tools/header-checker/tests/integration/availability/map.txt b/vndk/tools/header-checker/tests/integration/availability/map.txt
new file mode 100644
index 000000000..a99b9f0ba
--- /dev/null
+++ b/vndk/tools/header-checker/tests/integration/availability/map.txt
@@ -0,0 +1,7 @@
+libattribute {
+  global:
+    func;
+    ignored_func;
+    var; # var
+    ignored_var; # var
+};
diff --git a/vndk/tools/header-checker/tests/integration/union/include/base.h b/vndk/tools/header-checker/tests/integration/union/include/base.h
index d68209e70..03dd9e3e1 100644
--- a/vndk/tools/header-checker/tests/integration/union/include/base.h
+++ b/vndk/tools/header-checker/tests/integration/union/include/base.h
@@ -21,6 +21,16 @@ struct ChangeTypeInStruct {
   int member_4[0];
 };
 
+union ReorderAnonymousType {
+  struct {
+    int member_1;
+  } member_1;
+  struct {
+    int member_2;
+  };
+};
+
 extern "C" {
-void function(ChangeType, Rename, Swap, ChangeTypeInStruct);
+void function(ChangeType, Rename, Swap, ChangeTypeInStruct,
+              ReorderAnonymousType);
 }
diff --git a/vndk/tools/header-checker/tests/integration/union/include/diff.h b/vndk/tools/header-checker/tests/integration/union/include/diff.h
index 2f5d62ed9..51595f5a9 100644
--- a/vndk/tools/header-checker/tests/integration/union/include/diff.h
+++ b/vndk/tools/header-checker/tests/integration/union/include/diff.h
@@ -21,6 +21,16 @@ struct ChangeTypeInStruct {
   int member_4[0];
 };
 
+union ReorderAnonymousType {
+  struct {
+    int rename_2;
+  };
+  struct {
+    int rename_1;
+  } member_1;
+};
+
 extern "C" {
-void function(ChangeType, Rename, Swap, ChangeTypeInStruct);
+void function(ChangeType, Rename, Swap, ChangeTypeInStruct,
+              ReorderAnonymousType);
 }
diff --git a/vndk/tools/header-checker/tests/module.py b/vndk/tools/header-checker/tests/module.py
index 0a9763595..87382d398 100755
--- a/vndk/tools/header-checker/tests/module.py
+++ b/vndk/tools/header-checker/tests/module.py
@@ -840,6 +840,27 @@ TEST_MODULES = [
         dumper_flags=['-output-format', 'Json'],
         linker_flags=['-input-format', 'Json', '-output-format', 'Json'],
     ),
+    LsdumpModule(
+        name='libavailability',
+        arch='arm64',
+        srcs=['integration/availability/include/base.h'],
+        version_script='integration/availability/map.txt',
+        export_include_dirs=['integration/availability/include'],
+        dumper_flags=['-output-format', 'Json'],
+        linker_flags=['-input-format', 'Json', '-output-format', 'Json'],
+        has_reference_dump=True,
+    ),
+    LsdumpModule(
+        name='libavailability_35',
+        arch='arm64',
+        srcs=['integration/availability/include/base.h'],
+        version_script='integration/availability/map.txt',
+        export_include_dirs=['integration/availability/include'],
+        dumper_flags=['-output-format', 'Json'],
+        linker_flags=['-input-format', 'Json', '-output-format', 'Json',
+                      '-availability', '35'],
+        has_reference_dump=True,
+    ),
 ]
 
 TEST_MODULES = {m.name: m for m in TEST_MODULES}
diff --git a/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability.so.lsdump b/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability.so.lsdump
new file mode 100644
index 000000000..447e0db0c
--- /dev/null
+++ b/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability.so.lsdump
@@ -0,0 +1,246 @@
+{
+ "array_types" : [],
+ "builtin_types" :
+ [
+  {
+   "alignment" : 4,
+   "is_integral" : true,
+   "linker_set_key" : "_ZTIi",
+   "name" : "int",
+   "size" : 4
+  },
+  {
+   "alignment" : 4,
+   "is_integral" : true,
+   "is_unsigned" : true,
+   "linker_set_key" : "_ZTIj",
+   "name" : "unsigned int",
+   "size" : 4
+  }
+ ],
+ "elf_functions" :
+ [
+  {
+   "name" : "func"
+  },
+  {
+   "name" : "ignored_func"
+  }
+ ],
+ "elf_objects" :
+ [
+  {
+   "name" : "ignored_var"
+  },
+  {
+   "name" : "var"
+  }
+ ],
+ "enum_types" :
+ [
+  {
+   "alignment" : 4,
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "enum_fields" :
+   [
+    {
+     "availability_attrs" :
+     [
+      {
+       "introduced_major" : 36
+      }
+     ],
+     "enum_field_value" : 0,
+     "name" : "ALPHABETICALLY_SMALLEST_IGNORED_FIELD"
+    },
+    {
+     "availability_attrs" :
+     [
+      {
+       "deprecated_major" : 35
+      }
+     ],
+     "enum_field_value" : 1,
+     "name" : "DEPRECATED"
+    },
+    {
+     "enum_field_value" : 2,
+     "name" : "FIELD"
+    },
+    {
+     "availability_attrs" :
+     [
+      {
+       "obsoleted_major" : 35
+      }
+     ],
+     "enum_field_value" : 3,
+     "name" : "OBSOLETED"
+    },
+    {
+     "availability_attrs" :
+     [
+      {
+       "unavailable" : true
+      }
+     ],
+     "enum_field_value" : 4,
+     "name" : "UNAVAILABLE"
+    }
+   ],
+   "linker_set_key" : "_ZTI38$ALPHABETICALLY_SMALLEST_IGNORED_FIELD",
+   "name" : "(unnamed)",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h",
+   "underlying_type" : "_ZTIj"
+  }
+ ],
+ "function_types" : [],
+ "functions" :
+ [
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "function_name" : "func",
+   "linker_set_key" : "func",
+   "parameters" :
+   [
+    {
+     "referenced_type" : "_ZTIP6Struct"
+    },
+    {
+     "referenced_type" : "_ZTIP13IgnoredStruct"
+    }
+   ],
+   "return_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  },
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 36
+    }
+   ],
+   "function_name" : "ignored_func",
+   "linker_set_key" : "ignored_func",
+   "return_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "global_vars" :
+ [
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 36
+    }
+   ],
+   "linker_set_key" : "ignored_var",
+   "name" : "ignored_var",
+   "referenced_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  },
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    },
+    {
+     "obsoleted_major" : 36
+    }
+   ],
+   "linker_set_key" : "var",
+   "name" : "var",
+   "referenced_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "lvalue_reference_types" : [],
+ "pointer_types" :
+ [
+  {
+   "alignment" : 8,
+   "linker_set_key" : "_ZTIP13IgnoredStruct",
+   "name" : "IgnoredStruct *",
+   "referenced_type" : "_ZTI13IgnoredStruct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  },
+  {
+   "alignment" : 8,
+   "linker_set_key" : "_ZTIP6Struct",
+   "name" : "Struct *",
+   "referenced_type" : "_ZTI6Struct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "qualified_types" : [],
+ "record_types" :
+ [
+  {
+   "alignment" : 4,
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 36
+    }
+   ],
+   "fields" :
+   [
+    {
+     "field_name" : "field",
+     "referenced_type" : "_ZTIi"
+    }
+   ],
+   "linker_set_key" : "_ZTI13IgnoredStruct",
+   "name" : "IgnoredStruct",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  },
+  {
+   "alignment" : 4,
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "fields" :
+   [
+    {
+     "availability_attrs" :
+     [
+      {
+       "introduced_major" : 36
+      }
+     ],
+     "field_name" : "ignored_field",
+     "referenced_type" : "_ZTIi"
+    },
+    {
+     "field_name" : "field",
+     "field_offset" : 32,
+     "referenced_type" : "_ZTIi"
+    }
+   ],
+   "linker_set_key" : "_ZTI6Struct",
+   "name" : "Struct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "rvalue_reference_types" : []
+}
diff --git a/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability_35.so.lsdump b/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability_35.so.lsdump
new file mode 100644
index 000000000..3bb31ebfa
--- /dev/null
+++ b/vndk/tools/header-checker/tests/reference_dumps/arm64/libavailability_35.so.lsdump
@@ -0,0 +1,162 @@
+{
+ "array_types" : [],
+ "builtin_types" :
+ [
+  {
+   "alignment" : 4,
+   "is_integral" : true,
+   "linker_set_key" : "_ZTIi",
+   "name" : "int",
+   "size" : 4
+  },
+  {
+   "alignment" : 4,
+   "is_integral" : true,
+   "is_unsigned" : true,
+   "linker_set_key" : "_ZTIj",
+   "name" : "unsigned int",
+   "size" : 4
+  }
+ ],
+ "elf_functions" :
+ [
+  {
+   "name" : "func"
+  },
+  {
+   "name" : "ignored_func"
+  }
+ ],
+ "elf_objects" :
+ [
+  {
+   "name" : "ignored_var"
+  },
+  {
+   "name" : "var"
+  }
+ ],
+ "enum_types" :
+ [
+  {
+   "alignment" : 4,
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "enum_fields" :
+   [
+    {
+     "availability_attrs" :
+     [
+      {
+       "deprecated_major" : 35
+      }
+     ],
+     "enum_field_value" : 1,
+     "name" : "DEPRECATED"
+    },
+    {
+     "enum_field_value" : 2,
+     "name" : "FIELD"
+    }
+   ],
+   "linker_set_key" : "_ZTI38$ALPHABETICALLY_SMALLEST_IGNORED_FIELD",
+   "name" : "(unnamed)",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h",
+   "underlying_type" : "_ZTIj"
+  }
+ ],
+ "function_types" : [],
+ "functions" :
+ [
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "function_name" : "func",
+   "linker_set_key" : "func",
+   "parameters" :
+   [
+    {
+     "referenced_type" : "_ZTIP6Struct"
+    },
+    {
+     "referenced_type" : "_ZTIP13IgnoredStruct"
+    }
+   ],
+   "return_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "global_vars" :
+ [
+  {
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    },
+    {
+     "obsoleted_major" : 36
+    }
+   ],
+   "linker_set_key" : "var",
+   "name" : "var",
+   "referenced_type" : "_ZTIi",
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "lvalue_reference_types" : [],
+ "pointer_types" :
+ [
+  {
+   "alignment" : 8,
+   "linker_set_key" : "_ZTIP13IgnoredStruct",
+   "name" : "IgnoredStruct *",
+   "referenced_type" : "_ZTI13IgnoredStruct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  },
+  {
+   "alignment" : 8,
+   "linker_set_key" : "_ZTIP6Struct",
+   "name" : "Struct *",
+   "referenced_type" : "_ZTI6Struct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "qualified_types" : [],
+ "record_types" :
+ [
+  {
+   "alignment" : 4,
+   "availability_attrs" :
+   [
+    {
+     "introduced_major" : 35
+    }
+   ],
+   "fields" :
+   [
+    {
+     "field_name" : "field",
+     "field_offset" : 32,
+     "referenced_type" : "_ZTIi"
+    }
+   ],
+   "linker_set_key" : "_ZTI6Struct",
+   "name" : "Struct",
+   "size" : 8,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/availability/include/base.h"
+  }
+ ],
+ "rvalue_reference_types" : []
+}
diff --git a/vndk/tools/header-checker/tests/reference_dumps/arm64/libunion.so.lsdump b/vndk/tools/header-checker/tests/reference_dumps/arm64/libunion.so.lsdump
index 4f323c72d..14dfa6604 100644
--- a/vndk/tools/header-checker/tests/reference_dumps/arm64/libunion.so.lsdump
+++ b/vndk/tools/header-checker/tests/reference_dumps/arm64/libunion.so.lsdump
@@ -65,6 +65,9 @@
     },
     {
      "referenced_type" : "_ZTI18ChangeTypeInStruct"
+    },
+    {
+     "referenced_type" : "_ZTI20ReorderAnonymousType"
     }
    ],
    "return_type" : "_ZTIv",
@@ -129,6 +132,24 @@
    "size" : 4,
    "source_file" : "development/vndk/tools/header-checker/tests/integration/union/include/base.h"
   },
+  {
+   "alignment" : 4,
+   "fields" :
+   [
+    {
+     "field_name" : "member_1",
+     "referenced_type" : "_ZTIN20ReorderAnonymousTypeUt_E"
+    },
+    {
+     "referenced_type" : "_ZTIN20ReorderAnonymousTypeUt0_E"
+    }
+   ],
+   "linker_set_key" : "_ZTI20ReorderAnonymousType",
+   "name" : "ReorderAnonymousType",
+   "record_kind" : "union",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/union/include/base.h"
+  },
   {
    "alignment" : 4,
    "fields" :
@@ -166,6 +187,36 @@
    "record_kind" : "union",
    "size" : 4,
    "source_file" : "development/vndk/tools/header-checker/tests/integration/union/include/base.h"
+  },
+  {
+   "alignment" : 4,
+   "fields" :
+   [
+    {
+     "field_name" : "member_2",
+     "referenced_type" : "_ZTIi"
+    }
+   ],
+   "is_anonymous" : true,
+   "linker_set_key" : "_ZTIN20ReorderAnonymousTypeUt0_E",
+   "name" : "ReorderAnonymousType::(anonymous)",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/union/include/base.h"
+  },
+  {
+   "alignment" : 4,
+   "fields" :
+   [
+    {
+     "field_name" : "member_1",
+     "referenced_type" : "_ZTIi"
+    }
+   ],
+   "is_anonymous" : true,
+   "linker_set_key" : "_ZTIN20ReorderAnonymousTypeUt_E",
+   "name" : "ReorderAnonymousType::(unnamed)",
+   "size" : 4,
+   "source_file" : "development/vndk/tools/header-checker/tests/integration/union/include/base.h"
   }
  ],
  "rvalue_reference_types" : []
diff --git a/vndk/tools/header-checker/tests/test.py b/vndk/tools/header-checker/tests/test.py
index 39934a96d..6af54338d 100755
--- a/vndk/tools/header-checker/tests/test.py
+++ b/vndk/tools/header-checker/tests/test.py
@@ -198,7 +198,7 @@ class HeaderCheckerTest(unittest.TestCase):
 
     def test_libgolden_cpp_add_function(self):
         self.prepare_and_run_abi_diff_all_archs(
-            "libgolden_cpp", "libgolden_cpp_add_function", 4)
+            "libgolden_cpp", "libgolden_cpp_add_function", 6)
 
     def test_libgolden_cpp_add_function_allow_extension(self):
         self.prepare_and_run_abi_diff_all_archs(
@@ -208,7 +208,7 @@ class HeaderCheckerTest(unittest.TestCase):
     def test_libgolden_cpp_add_function_and_elf_symbol(self):
         self.prepare_and_run_abi_diff_all_archs(
             "libgolden_cpp", "libgolden_cpp_add_function_and_unexported_elf",
-            4)
+            6)
 
     def test_libgolden_cpp_fabricated_function_ast_removed_diff(self):
         self.prepare_and_run_abi_diff_all_archs(
@@ -221,7 +221,7 @@ class HeaderCheckerTest(unittest.TestCase):
 
     def test_libgolden_cpp_add_global_variable(self):
         self.prepare_and_run_abi_diff_all_archs(
-            "libgolden_cpp", "libgolden_cpp_add_global_variable", 4)
+            "libgolden_cpp", "libgolden_cpp_add_global_variable", 6)
 
     def test_libgolden_cpp_change_global_var_access(self):
         self.prepare_and_run_abi_diff_all_archs(
@@ -279,6 +279,11 @@ class HeaderCheckerTest(unittest.TestCase):
             "libgolden_cpp", "libgolden_cpp_unreferenced_elf_symbol_removed",
             16)
 
+    def test_libgolden_cpp_unreferenced_elf_symbol_added(self):
+        self.prepare_and_run_abi_diff_all_archs(
+            "libgolden_cpp_unreferenced_elf_symbol_removed", "libgolden_cpp",
+            2, create_old=True, create_new=False)
+
     def test_libreproducability(self):
         self.prepare_and_absolute_diff_all_archs(
             "libreproducability", "libreproducability")
@@ -547,6 +552,12 @@ class HeaderCheckerTest(unittest.TestCase):
             flags=["-input-format-new", "Json", "-input-format-old", "Json"],
             create_old=False, create_new=True)
 
+    def test_availability(self):
+        self.prepare_and_absolute_diff_all_archs(
+            "libavailability", "libavailability")
+        self.prepare_and_absolute_diff_all_archs(
+            "libavailability_35", "libavailability_35")
+
 
 if __name__ == '__main__':
     unittest.main()
```

