```diff
diff --git a/PREUPLOAD.cfg b/PREUPLOAD.cfg
index f46950835..b3cbaa145 100644
--- a/PREUPLOAD.cfg
+++ b/PREUPLOAD.cfg
@@ -11,4 +11,4 @@ checkstyle_hook = ${REPO_ROOT}/prebuilts/checkstyle/checkstyle.py --sha ${PREUPL
 ktlint_hook = ${REPO_ROOT}/prebuilts/ktlint/ktlint.py --no-verify-format -f ${PREUPLOAD_FILES}
 
 [Tool Paths]
-ktfmt = ${REPO_ROOT}/prebuilts/build-tools/common/framework/ktfmt.jar
\ No newline at end of file
+ktfmt = ${REPO_ROOT}/external/ktfmt/ktfmt.sh
\ No newline at end of file
diff --git a/build/tasks/tests/native_test_list.mk b/build/tasks/tests/native_test_list.mk
index e604371e9..bf671731f 100644
--- a/build/tasks/tests/native_test_list.mk
+++ b/build/tasks/tests/native_test_list.mk
@@ -38,7 +38,6 @@ native_tests := \
     boringssl_crypto_test \
     boringssl_ssl_test \
     bsdiff_unittest \
-    buffer_hub-test \
     bugreportz_test \
     bytes_test_tests_test_buf \
     bytes_test_tests_test_buf_mut \
@@ -94,6 +93,7 @@ native_tests := \
     libnativehelper_tests \
     libnetworkstats_test \
     libprocinfo_test \
+    librenderengine_test \
     libtextclassifier_tests-tplus \
     libtextclassifier_tests-sminus \
     libsurfaceflinger_unittest \
diff --git a/host_runners/boot/src/com/android/boot/BootTimeTest.java b/host_runners/boot/src/com/android/boot/BootTimeTest.java
index 133a07fd3..dce72f47b 100644
--- a/host_runners/boot/src/com/android/boot/BootTimeTest.java
+++ b/host_runners/boot/src/com/android/boot/BootTimeTest.java
@@ -415,7 +415,11 @@ public class BootTimeTest extends InstalledInstrumentationsTest
             throws DeviceNotAvailableException {
         mTestInfo = testInfo;
         long start = System.currentTimeMillis();
-        listener.testRunStarted(mTestRunName, mBootCount + 1);
+        if (mRebootUnlock) {
+            listener.testRunStarted(mTestRunName, mBootCount * 2 + 2);
+        } else {
+            listener.testRunStarted(mTestRunName, mBootCount + 1);
+        }
         for (IMetricCollector collector : mCollectors) {
             listener = collector.init(mInvocationContext, listener);
         }
diff --git a/libraries/annotations/Android.bp b/libraries/annotations/Android.bp
index 122e7fe49..c0dc8af81 100644
--- a/libraries/annotations/Android.bp
+++ b/libraries/annotations/Android.bp
@@ -32,3 +32,13 @@ java_library_host {
     name: "platform-test-annotations-host",
     static_libs: ["platform-test-annotations"],
 }
+
+python_library {
+    name: "platform-test-py-annotations",
+    host_supported: true,
+    srcs: [
+        "__init__.py",
+        "src/**/*.py",
+    ],
+    pkg_path: "android/platform/test/annotations",
+}
diff --git a/libraries/annotations/OWNERS b/libraries/annotations/OWNERS
new file mode 100644
index 000000000..cd1d29848
--- /dev/null
+++ b/libraries/annotations/OWNERS
@@ -0,0 +1 @@
+per-file **.py = slotus@google.com
\ No newline at end of file
diff --git a/tests/bettertogether/betocq/__init__.py b/libraries/annotations/__init__.py
similarity index 68%
rename from tests/bettertogether/betocq/__init__.py
rename to libraries/annotations/__init__.py
index f915584ae..d2e7e5291 100644
--- a/tests/bettertogether/betocq/__init__.py
+++ b/libraries/annotations/__init__.py
@@ -11,3 +11,12 @@
 #  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 #  See the License for the specific language governing permissions and
 #  limitations under the License.
+
+"""Android platform test annotation module."""
+
+from .src.py.ApiTest import ApiTest
+from .src.py.CddTest import CddTest
+from .src.py.GmsTest import GmsTest
+from .src.py.NonApiTest import NonApiTest
+from .src.py.ReasonType import ReasonType
+from .src.py.VsrTest import VsrTest
diff --git a/libraries/annotations/src/py/ApiTest.py b/libraries/annotations/src/py/ApiTest.py
new file mode 100644
index 000000000..a05877146
--- /dev/null
+++ b/libraries/annotations/src/py/ApiTest.py
@@ -0,0 +1,34 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+"""ApiTest decorator."""
+
+from typing import List
+
+
+class ApiTest(object):
+  """Marks the type of CTS test with purpose of asserting API functionalities and behaviors.
+
+  Args:
+      apis: the list of APIs being tested.
+
+  Example:
+      @ApiTest(apis=['android.example.ClassA#MethodA', 'android.example.ClassB#MethodB'])
+  """
+
+  def __init__(self, apis: List[str] = []):
+    self._apis = apis
+
+  def __call__(self, func):
+    return func
diff --git a/libraries/annotations/src/py/CddTest.py b/libraries/annotations/src/py/CddTest.py
new file mode 100644
index 000000000..fa1f9fe03
--- /dev/null
+++ b/libraries/annotations/src/py/CddTest.py
@@ -0,0 +1,34 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+"""CddTest decorator."""
+
+from typing import List
+
+
+class CddTest(object):
+  """Marks the type of test with purpose of asserting CDD requirements.
+
+  Args:
+      requirements: the list of CDD requirements.
+
+  Example:
+      @CddTest(requirements=['2.5.3/3/A-0-1', '2.5.3/3/A-0-2'])
+  """
+
+  def __init__(self, requirements: List[str] = []):
+    self._requirements = requirements
+
+  def __call__(self, func):
+    return func
diff --git a/tests/bettertogether/betocq/version.py b/libraries/annotations/src/py/GmsTest.py
similarity index 62%
rename from tests/bettertogether/betocq/version.py
rename to libraries/annotations/src/py/GmsTest.py
index 36cff958e..6aeee1259 100644
--- a/tests/bettertogether/betocq/version.py
+++ b/libraries/annotations/src/py/GmsTest.py
@@ -12,13 +12,20 @@
 #  See the License for the specific language governing permissions and
 #  limitations under the License.
 
-"""Define the Beto CQ test script version."""
+"""GmsTest decorator."""
 
+from typing import List
 
-TEST_SCRIPT_VERSION = '2.3.0'
 
-# VERSION_LOG (only add new description for new version, keep the history log)
-# '2.0.0': 'initial version'
-# '2.1.0': 'add iperf for WFD and fix missing data of failed test cases.'
-# '2.2.0': 'add iperf for AWARE,HOTSPOT mode and disable WLAN deny list.'
-# '2.3.0': 'fix the low NC speed issue.'
+class GmsTest(object):
+  """Marks the type of test with purpose of asserting GMS requirements.
+
+  Args:
+      requirements: the list of GMS requirements.
+  """
+
+  def __init__(self, requirements: List[str] = []):
+    self._requirements = requirements
+
+  def __call__(self, func):
+    return func
diff --git a/libraries/annotations/src/py/NonApiTest.py b/libraries/annotations/src/py/NonApiTest.py
new file mode 100644
index 000000000..935d21f20
--- /dev/null
+++ b/libraries/annotations/src/py/NonApiTest.py
@@ -0,0 +1,38 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+"""NonApiTest decorator."""
+
+from typing import List
+from ReasonType import ReasonType
+
+
+class NonApiTest(object):
+  """Marks the type of CTS test not enforcing API functionalities and behaviors.
+
+  @NonApiTest should be used only after a consultation with ape-relpgm-cls@.
+
+  Args:
+    exemption_reasons: the list of reasons for not enforcing API behaviors.
+    justification: additional explanation for reason types listed.
+  """
+
+  def __init__(
+      self, exemption_reasons: List[ReasonType] = [], justification: str = ''
+  ):
+    self._exemption_reasons = exemption_reasons
+    self._justification = justification
+
+  def __call__(self, func):
+    return func
diff --git a/libraries/annotations/src/py/ReasonType.py b/libraries/annotations/src/py/ReasonType.py
new file mode 100644
index 000000000..4c1fb62f8
--- /dev/null
+++ b/libraries/annotations/src/py/ReasonType.py
@@ -0,0 +1,27 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+"""ReasonType enum for @NonApiTest."""
+
+from enum import Enum
+
+
+class ReasonType(Enum):
+  """The reason types for @NonApiTest.
+
+  The constants of this enumerated type describe various reason types for a CTS
+  test not enforcing API functionalities and behaviors. They are used in
+  conjunction with the @NonApiTest. A new reason type must be reviewed by
+  ape-relpgm-cls@.
+  """
diff --git a/libraries/annotations/src/py/VsrTest.py b/libraries/annotations/src/py/VsrTest.py
new file mode 100644
index 000000000..a300c142e
--- /dev/null
+++ b/libraries/annotations/src/py/VsrTest.py
@@ -0,0 +1,31 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+"""VsrTest decorator."""
+
+from typing import List
+
+
+class VsrTest(object):
+  """Marks the type of test with purpose of asserting VSR requirements.
+
+  Args:
+      requirements: the list of VSR requirements.
+  """
+
+  def __init__(self, requirements: List[str] = []):
+    self._requirements = requirements
+
+  def __call__(self, func):
+    return func
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoBluetoothSettingsHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoBluetoothSettingsHelper.java
index b4004bdc2..92f5b9bb2 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoBluetoothSettingsHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoBluetoothSettingsHelper.java
@@ -46,6 +46,13 @@ public interface IAutoBluetoothSettingsHelper extends IAppHelper, Scrollable {
      */
     boolean isPhonePreferenceChecked();
 
+    /**
+     * Setup Expectations: The bluetooth settings view is open
+     *
+     * @return - Whether the use bluetooth toggle is currently checked
+     */
+    boolean isUseBluetoothToggleChecked();
+
     /**
      * Setup Expectations: The bluetooth settings view is open, and at least one device is listed
      * under "Paired devices"
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoHomeHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoHomeHelper.java
index 95c87c6ce..e998722c7 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoHomeHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoHomeHelper.java
@@ -124,4 +124,18 @@ public interface IAutoHomeHelper extends IAppHelper {
      * <p>Opens Assistant Widget button on Home screen
      */
     void clickAssistantWidget();
+
+    /**
+     * Setup expectations: To open HVAC panel
+     *
+     * <p>Clicks home Temeprature buttons
+     */
+    void openHVAC();
+
+    /**
+     * Setup expectations: Checks HVAC panel is opened
+     *
+     * <p>Checks HVAC panel is opened
+     */
+    boolean isHVACOpen();
 }
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoNotificationHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoNotificationHelper.java
index 09337a005..6c7cf62ef 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoNotificationHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoNotificationHelper.java
@@ -68,4 +68,18 @@ public interface IAutoNotificationHelper extends Scrollable, IAppHelper {
      * <p>Checks if notification are received under older category.
      */
     boolean isOlderNotification();
+
+    /**
+     * Setup expectations: A notification is received.
+     *
+     * <p>Clicks in check recent permissions
+     */
+    void clickOnCheckRecentPermissions(String title);
+
+    /**
+     * Setup expectations: Check recent permission is launched.
+     *
+     * <p>Checks App Permissions is present
+     */
+    boolean checkAppPermissionsExists(String title);
 }
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoPhoneHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoPhoneHelper.java
index 7d4c5c84c..22b27753c 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoPhoneHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoPhoneHelper.java
@@ -36,6 +36,9 @@ public interface IAutoPhoneHelper extends IAppHelper {
      */
     void pressDialpadIcon();
 
+    /** Checks if the dial pad is open */
+    boolean isDialPadOpen();
+
     /**
      * Assumes mobile device is on home screen, and phone icon is present.
      *
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoSettingHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoSettingHelper.java
index f32b64fb0..022c9ce84 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoSettingHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoSettingHelper.java
@@ -19,7 +19,7 @@ package android.platform.helpers;
 import androidx.test.uiautomator.UiObject2;
 
 /** Helper class for functional tests of Settings facet */
-public interface IAutoSettingHelper extends IAppHelper, Scrollable {
+public interface IAutoSettingHelper extends IAppHelper {
 
     /**
      * enum for Day/Night mode.
@@ -42,10 +42,8 @@ public interface IAutoSettingHelper extends IAppHelper, Scrollable {
         }
     }
 
-    /**
-     * enum for changing(increasing, decreasing) value.
-     */
-    enum ChangeType{
+    /** enum for changing(increasing, decreasing) value. */
+    enum ChangeType {
         INCREASE,
         DECREASE
     }
@@ -57,6 +55,20 @@ public interface IAutoSettingHelper extends IAppHelper, Scrollable {
      */
     UiObject2 findSettingMenu(String setting);
 
+    /**
+     * Setup expectations: The app is open and the settings facet is open
+     *
+     * <p>Scroll backward(down) in the settings menu page.
+     */
+    boolean scrollBackward();
+
+    /**
+     * Setup expectations: The app is open and the settings facet is open.
+     *
+     * <p>Scroll forward(up) in the settings menu page.
+     */
+    boolean scrollForward();
+
     /**
      * Setup expectations: The app is open and the settings facet is open
      *
@@ -133,19 +145,18 @@ public interface IAutoSettingHelper extends IAppHelper, Scrollable {
     /**
      * Setup expectations: settings app is open.
      *
-     * This method is used to open Settings Menu with menuOptions.
-     * Example - Settings->App info->Calandar->Permissions
-     *           openMenuWith("App info", "Calandar", "Permissions");
+     * <p>This method is used to open Settings Menu with menuOptions. Example - Settings->App
+     * info->Calandar->Permissions openMenuWith("App info", "Calandar", "Permissions");
      *
      * @param - menuOptions used to pass multiple level of menu options in one go.
-     *
      */
     void openMenuWith(String... menuOptions);
 
     /**
      * Setup expectations: settings app is open.
      *
-     * gets the value of the setting.
+     * <p>gets the value of the setting.
+     *
      * @param setting should be passed. example for setting is screen_brightness.
      */
     int getValue(String setting);
@@ -153,7 +164,8 @@ public interface IAutoSettingHelper extends IAppHelper, Scrollable {
     /**
      * Setup expectations: settings app is open
      *
-     * sets the value of the setting.
+     * <p>sets the value of the setting.
+     *
      * @param setting should be passed. example for setting is screen_brightness.
      */
     void setValue(String setting, int value);
diff --git a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoStatusBarHelper.java b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoStatusBarHelper.java
index 7030d67cf..e1ce259fd 100644
--- a/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoStatusBarHelper.java
+++ b/libraries/app-helpers/interfaces/auto/src/android/platform/helpers/IAutoStatusBarHelper.java
@@ -246,4 +246,41 @@ public interface IAutoStatusBarHelper extends IAppHelper {
      * <p>This method performs click operation on media button
      */
     void clickOnBluetoothPaletteMediaButton();
+
+    /**
+     * Setup expectations: Open Sound Palette On Status bar
+     *
+     * <p>This method performs click operation and opens Sound Palette On statusBar
+     */
+    void openSoundPaletteOnStatusBar();
+
+    /**
+     * Setup expectations: Has Sound Button
+     *
+     * <p>This method checks whether Sound button is on Status Bar
+     */
+    boolean hasSoundButton();
+
+    /**
+     * Setup expectations: Open Sound Palette
+     *
+     * <p>This method verifies UI buttons present in Sound Palette
+     *
+     * @param targetSelector UI button name selector EX: IN-Call Voulme
+     */
+    boolean isUIButtonPresentOnSoundPalette(String targetSelector);
+
+    /**
+     * Setup expectations: Open Sound Palette
+     *
+     * <p>This method clicks and open Sound Settings Page
+     */
+    void openSoundSettings();
+
+    /**
+     * Setup expectations: Open Sound Palette
+     *
+     * <p>Checks if sound settings page title is present
+     */
+    boolean hasSoundSettingsPageTitle();
 }
diff --git a/libraries/app-helpers/interfaces/common/src/android/platform/helpers/IMapsHelper.java b/libraries/app-helpers/interfaces/common/src/android/platform/helpers/IMapsHelper.java
index eb4c03a9a..e07fa290d 100644
--- a/libraries/app-helpers/interfaces/common/src/android/platform/helpers/IMapsHelper.java
+++ b/libraries/app-helpers/interfaces/common/src/android/platform/helpers/IMapsHelper.java
@@ -215,4 +215,11 @@ public interface IMapsHelper extends IAppHelper {
     public default boolean isOnMapsMainPage(boolean sidePanelOpened) {
         throw new UnsupportedOperationException("Not implemented yet.");
     }
+
+    /**
+     * Setup expectation: On the home screen.
+     *
+     * <p>Get the UiObject2 of scroll view container.
+     */
+    UiObject2 getHomeScrollViewContainer();
 }
diff --git a/libraries/app-helpers/interfaces/handheld/src/android/platform/helpers/IGmailHelper.java b/libraries/app-helpers/interfaces/handheld/src/android/platform/helpers/IGmailHelper.java
index 38de619d9..f98f4e666 100644
--- a/libraries/app-helpers/interfaces/handheld/src/android/platform/helpers/IGmailHelper.java
+++ b/libraries/app-helpers/interfaces/handheld/src/android/platform/helpers/IGmailHelper.java
@@ -312,4 +312,11 @@ public interface IGmailHelper extends IAppHelper {
      * <p>This method will check if the current view is on Gmail list page.
      */
     public boolean isOnGmailListPage();
+
+    /**
+     * Setup expectations: Gmail is open and an email is open.
+     *
+     * <p>This method will check if the search mail is found or not.
+     */
+    boolean isSearchMailFound();
 }
diff --git a/libraries/app-helpers/spectatio/spectatio-util/Android.bp b/libraries/app-helpers/spectatio/spectatio-util/Android.bp
index 0d7f670e9..d1363c5aa 100644
--- a/libraries/app-helpers/spectatio/spectatio-util/Android.bp
+++ b/libraries/app-helpers/spectatio/spectatio-util/Android.bp
@@ -21,10 +21,11 @@ package {
 java_library {
     name: "spectatio-util-lib",
     static_libs: [
+        "androidx.test.monitor",
         "androidx.test.uiautomator_uiautomator",
         "gson",
         "guava",
     ],
     srcs: ["src/**/*.java"],
     sdk_version: "test_current",
-}
\ No newline at end of file
+}
diff --git a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/CommandLineParameters.java b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/CommandLineParameters.java
new file mode 100644
index 000000000..a8a17f26a
--- /dev/null
+++ b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/CommandLineParameters.java
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.spectatio.configs;
+
+import android.os.Bundle;
+
+import androidx.test.platform.app.InstrumentationRegistry;
+
+/**
+ * Simple wrapper around {@link InstrumentationRegistry#getArguments()}. Since that method creates a
+ * new Bundle instance each call, this class caches that Bundle.
+ */
+public class CommandLineParameters {
+    private static final CommandLineParameters INSTANCE = new CommandLineParameters();
+
+    private Bundle mArguments = InstrumentationRegistry.getArguments();
+
+    /**
+     * Retrieve a `-e {key} {value}` value from the instrumentation command
+     *
+     * @param key The key given to `-e`
+     * @param defaultValue Value to return if this parameter wasn't specified
+     * @return The value given to `-e`, or defaultValue if the key wasn't specified
+     */
+    public static String getValue(String key, String defaultValue) {
+        return INSTANCE.mArguments.getString(key, defaultValue);
+    }
+}
diff --git a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/UiElement.java b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/UiElement.java
index ef5b4d851..980940359 100644
--- a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/UiElement.java
+++ b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/UiElement.java
@@ -136,6 +136,8 @@ public class UiElement {
                     return By.clazz(mPackage, mValue);
                 }
                 return By.clazz(mValue);
+            case JsonConfigConstants.DISPLAY_ID:
+                return By.displayId(Integer.parseInt(mValue));
             case JsonConfigConstants.HAS_ANCESTOR:
                 return By.hasAncestor(mAncestor.getBySelectorForUiElement(), mMaxDepth);
             case JsonConfigConstants.HAS_DESCENDANT:
@@ -184,6 +186,9 @@ public class UiElement {
                 }
                 s.clazz(mValue);
                 break;
+            case JsonConfigConstants.DISPLAY_ID:
+                s.displayId(Integer.parseInt(mValue));
+                break;
             case JsonConfigConstants.HAS_ANCESTOR:
                 s.hasAncestor(mAncestor.getBySelectorForUiElement(), mMaxDepth);
                 break;
diff --git a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/validators/ValidateUiElement.java b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/validators/ValidateUiElement.java
index dd6faeed2..4ccd2a558 100644
--- a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/validators/ValidateUiElement.java
+++ b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/configs/validators/ValidateUiElement.java
@@ -16,6 +16,7 @@
 
 package android.platform.spectatio.configs.validators;
 
+import android.platform.spectatio.configs.CommandLineParameters;
 import android.platform.spectatio.configs.UiElement;
 import android.platform.spectatio.constants.JsonConfigConstants;
 
@@ -48,6 +49,7 @@ public class ValidateUiElement implements JsonDeserializer<UiElement> {
                     JsonConfigConstants.TEXT_CONTAINS,
                     JsonConfigConstants.DESCRIPTION,
                     JsonConfigConstants.CLASS,
+                    JsonConfigConstants.DISPLAY_ID,
                     JsonConfigConstants.HAS_ANCESTOR,
                     JsonConfigConstants.HAS_DESCENDANT,
                     JsonConfigConstants.MULTIPLE,
@@ -57,6 +59,8 @@ public class ValidateUiElement implements JsonDeserializer<UiElement> {
             Set.of(
                     JsonConfigConstants.TYPE,
                     JsonConfigConstants.VALUE,
+                    JsonConfigConstants.COMMAND_LINE_KEY,
+                    JsonConfigConstants.DEFAULT_VALUE,
                     JsonConfigConstants.PACKAGE,
                     JsonConfigConstants.FLAG,
                     JsonConfigConstants.MAX_DEPTH,
@@ -127,8 +131,17 @@ public class ValidateUiElement implements JsonDeserializer<UiElement> {
                     maxDepth);
         }
 
-        String value =
-                validateAndGetValue(JsonConfigConstants.VALUE, jsonObject, /*isOptional*/ false);
+        String value;
+        if (jsonObject.has(JsonConfigConstants.COMMAND_LINE_KEY)) {
+            String key =
+                    validateAndGetValue(JsonConfigConstants.COMMAND_LINE_KEY, jsonObject, false);
+            String defaultValue =
+                    validateAndGetValue(JsonConfigConstants.DEFAULT_VALUE, jsonObject, false);
+            value = CommandLineParameters.getValue(key, defaultValue);
+            System.out.printf("Key %s has value %s%n", key, value);
+        } else {
+            value = validateAndGetValue(JsonConfigConstants.VALUE, jsonObject, false);
+        }
 
         // Package is not required for SCROLLABLE, CLICKABLE, TEXT, TEXT_CONTAINS and DESCRIPTION
 
diff --git a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/constants/JsonConfigConstants.java b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/constants/JsonConfigConstants.java
index 21f5712e2..be0a6697e 100644
--- a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/constants/JsonConfigConstants.java
+++ b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/constants/JsonConfigConstants.java
@@ -27,6 +27,8 @@ public class JsonConfigConstants {
     // UI Element Constants
     public static final String TYPE = "TYPE";
     public static final String VALUE = "VALUE";
+    public static final String COMMAND_LINE_KEY = "COMMAND_LINE_KEY";
+    public static final String DEFAULT_VALUE = "DEFAULT_VALUE";
     public static final String FLAG = "FLAG";
     public static final String PACKAGE = "PACKAGE";
     public static final String ANCESTOR = "ANCESTOR";
@@ -41,6 +43,7 @@ public class JsonConfigConstants {
     public static final String TEXT_CONTAINS = "TEXT_CONTAINS";
     public static final String DESCRIPTION = "DESCRIPTION";
     public static final String CLASS = "CLASS";
+    public static final String DISPLAY_ID = "DISPLAY_ID";
     public static final String HAS_ANCESTOR = "HAS_ANCESTOR";
     public static final String HAS_DESCENDANT = "HAS_DESCENDANT";
     public static final String MULTIPLE = "MULTIPLE";
diff --git a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/utils/SpectatioUiUtil.java b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/utils/SpectatioUiUtil.java
index da005bf43..83a2e33d6 100644
--- a/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/utils/SpectatioUiUtil.java
+++ b/libraries/app-helpers/spectatio/spectatio-util/src/android/platform/spectatio/utils/SpectatioUiUtil.java
@@ -578,6 +578,8 @@ public class SpectatioUiUtil {
                 padXStart = bounds.right / 4 * 3;
                 padYStart = bounds.bottom / 4 * 3;
                 break;
+            case DEFAULT:
+                break; // handled above the switch
         }
 
         switch (swipeDirection) {
diff --git a/libraries/audio-test-harness/instrumentation/Android.bp b/libraries/audio-test-harness/instrumentation/Android.bp
index 746d3332d..a805fdd8f 100644
--- a/libraries/audio-test-harness/instrumentation/Android.bp
+++ b/libraries/audio-test-harness/instrumentation/Android.bp
@@ -23,8 +23,8 @@ android_test {
     name: "audiotestharness-instrumentation-app",
     srcs: ["src/**/*.java"],
     libs: [
-        "android.test.runner",
-        "android.test.base",
+        "android.test.runner.stubs.system",
+        "android.test.base.stubs.system",
     ],
     static_libs: [
         "androidx.test.ext.junit",
diff --git a/libraries/automotive-helpers/auto-default-config/resources/assets/defaultSpectatioConfig.json b/libraries/automotive-helpers/auto-default-config/resources/assets/defaultSpectatioConfig.json
index 5902f079e..df31cb9e1 100644
--- a/libraries/automotive-helpers/auto-default-config/resources/assets/defaultSpectatioConfig.json
+++ b/libraries/automotive-helpers/auto-default-config/resources/assets/defaultSpectatioConfig.json
@@ -27,6 +27,8 @@
     "SECURITY_SETTINGS_SCROLL_DIRECTION": "VERTICAL",
     "NOTIFICATION_LIST_SCROLL_ACTION": "USE_GESTURE",
     "NOTIFICATION_LIST_SCROLL_DIRECTION": "VERTICAL",
+    "SETTINGS_SCROLL_ACTION": "USE_GESTURE",
+    "SETTINGS_SCROLL_DIRECTION": "VERTICAL",
     "SYSTEM_SETTINGS_SCROLL_ACTION": "USE_GESTURE",
     "SYSTEM_SETTINGS_SCROLL_DIRECTION": "VERTICAL",
     "SYSTEM_SETTINGS_SCROLL_MARGIN": "6",
@@ -62,7 +64,7 @@
   "COMMANDS": {
     "OPEN_DIAL_PAD_COMMAND": "am start -a android.intent.action.DIAL",
     "OPEN_PHONE_ACTIVITY_COMMAND": "am start -n com.android.car.dialer/.ui.TelecomActivity",
-    "OPEN_SMS_ACTIVITY_COMMAND": "am start -n com.android.car.messenger/.core.ui.launcher.MessageLauncherActivity",
+    "OPEN_SMS_ACTIVITY_COMMAND": "am start -n com.android.car.messenger/com.android.car.messenger.ui.launcher.MessageLauncherActivity",
     "OPEN_APP_GRID_COMMAND": "am start -n com.android.car.carlauncher/.GASAppGridActivity",
     "OPEN_NOTIFICATIONS_COMMAND": "service call statusbar 1",
     "STOP_SETTING_APP_COMMAND": "am force-stop com.android.car.settings",
@@ -101,6 +103,10 @@
       "TYPE": "RESOURCE_ID",
       "VALUE": "dialpad_fab"
     },
+    "MOBILE_DIALPAD": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "dialpad"
+    },
     "MOBILE_DIALPAD_INPUT": {
       "TYPE": "CLASS",
       "VALUE": "android.widget.EditText"
@@ -265,7 +271,6 @@
             }
           }
         }
-
       ]
     },
     "CONTACT_DETAIL": {
@@ -277,7 +282,6 @@
       "TYPE": "DESCRIPTION",
       "VALUE": "com.android.car.ui.utils.ROTARY_CONTAINER"
     },
-
     "CALL_HISTORY_INFO": {
       "TYPE": "RESOURCE_ID",
       "VALUE": "call_action_id",
@@ -1004,6 +1008,27 @@
       "VALUE": "summary",
       "PACKAGE": "android"
     },
+    "USE_BLUETOOTH_SETTINGS_TOGGLE": {
+      "TYPE": "MULTIPLE",
+      "SPECIFIERS": [
+        {
+          "TYPE": "CLASS",
+          "VALUE": "android.widget.Switch"
+        },
+        {
+          "TYPE": "HAS_ANCESTOR",
+          "MAX_DEPTH": 3,
+          "ANCESTOR": {
+            "TYPE": "HAS_DESCENDANT",
+            "MAX_DEPTH": 2,
+            "DESCENDANT": {
+              "TYPE": "TEXT",
+              "VALUE": "Use Bluetooth"
+            }
+          }
+        }
+      ]
+    },
     "DISPLAY_SETTINGS_SCROLL_ELEMENT": {
       "TYPE": "RESOURCE_ID",
       "VALUE": "car_ui_internal_recycler_view",
@@ -1130,7 +1155,7 @@
     },
     "DATE_TIME_SETTINGS_SET_TIME": {
       "TYPE": "TEXT",
-      "VALUE": "Set time"
+      "VALUE": "Set clock"
     },
     "DATE_TIME_SETTINGS_USE_24_HOUR_FORMAT": {
       "TYPE": "TEXT",
@@ -1289,7 +1314,6 @@
         }
       ]
     },
-
     "USER_SETTINGS_MAKE_TIME_PATTERN": {
       "TYPE": "TEXT",
       "VALUE": "(1[012]|[1-9]):[0-5][0-9](\\s)?.*"
@@ -1410,7 +1434,7 @@
     },
     "ARTIST_TITLE": {
       "TYPE": "RESOURCE_ID",
-      "VALUE": "artist",
+      "VALUE": "subtitle",
       "PACKAGE": "com.android.car.media"
     },
     "ALBUM_TITLE": {
@@ -1571,8 +1595,7 @@
     },
     "DEVICE_CONNECTION_BACK_BUTTON": {
       "TYPE": "RESOURCE_ID",
-      "VALUE": "car_ui_toolbar_nav_icon_container",
-      "PACKAGE": "com.android.car.settings"
+      "VALUE": "car_ui_toolbar_nav_icon"
     },
     "DEVICE_FORGET_BUTTON": {
       "TYPE": "MULTIPLE",
@@ -1604,7 +1627,8 @@
         {
           "TYPE": "DESCRIPTION",
           "VALUE": "com.android.car.ui.utils.ROTARY_CONTAINER"
-        },{
+        },
+        {
           "TYPE": "CLASS",
           "VALUE": "androidx.recyclerview.widget.RecyclerView"
         }
@@ -1622,6 +1646,21 @@
       "TYPE": "TEXT",
       "VALUE": "Settings"
     },
+    "SETTINGS_SCROLL_FORWARD_BUTTON": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "car_ui_scrollbar_page_down",
+      "PACKAGE": "com.android.car.ui.sharedlibrary"
+    },
+    "SETTINGS_SCROLL_BACKWARD_BUTTON": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "car_ui_scrollbar_page_up",
+      "PACKAGE": "com.android.car.ui.sharedlibrary"
+    },
+    "SETTINGS_SCROLL_ELEMENT": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "top_level_recycler_view",
+      "PACKAGE": "com.android.car.settings"
+    },
     "SETTINGS_SUB_SETTING_SCROLL_BACKWARD_BUTTON": {
       "TYPE": "DESCRIPTION",
       "VALUE": "Scroll up"
@@ -1722,7 +1761,7 @@
     },
     "TOGGLE_MICROPHONE": {
       "TYPE": "TEXT",
-      "VALUE": "Use microphone"
+      "VALUE": "Infotainment apps"
     },
     "MICRO_PHONE_MUTED_CHIP_STATUS_BAR": {
       "TYPE": "RESOURCE_ID",
@@ -1850,7 +1889,7 @@
     },
     "TOGGLE_LOCATION": {
       "TYPE": "TEXT",
-      "VALUE": "Use location"
+      "VALUE": "Infotainment apps"
     },
     "LOCATION_SWITCH": {
       "TYPE": "CLASS",
@@ -1981,21 +2020,24 @@
       "VALUE": "radio_button",
       "PACKAGE": "com.android.permissioncontroller"
     },
-    "PRIVACY_PERMISSION_MANAGER":{
+    "PRIVACY_PERMISSION_MANAGER": {
       "TYPE": "TEXT",
       "VALUE": "Permission manager"
     },
     "BLUETOOTH_CONNECTED_DISCONNECTED_TEXT": {
       "TYPE": "MULTIPLE",
       "SPECIFIERS": [
+        {
+          "TYPE": "HAS_ANCESTOR",
+          "ANCESTOR": {
+            "TYPE": "CLASS",
+            "VALUE": "android.view.ViewGroup"
+          }
+          },
         {
           "TYPE": "RESOURCE_ID",
           "VALUE": "qc_summary",
           "PACKAGE": "com.android.systemui"
-        },
-        {
-          "TYPE": "CLASS",
-          "VALUE": "android.widget.TextView"
         }
       ]
     },
@@ -2136,6 +2178,70 @@
       "TYPE": "RESOURCE_ID",
       "VALUE": "clock",
       "PACKAGE": "com.android.systemui"
+    },
+    "STATUS_BAR_SOUND_BUTTON": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "volume_panel"
+    },
+    "SOUND_PALETTE_INCALL": {
+      "TYPE": "TEXT",
+      "VALUE": "In-call volume"
+    },
+    "SOUND_PALETTE_MEDIA": {
+      "TYPE": "TEXT",
+      "VALUE": "Media volume"
+    },
+    "SOUND_PALETTE_NAVIGATION": {
+      "TYPE": "TEXT",
+      "VALUE": "Navigation volume"
+    },
+    "SOUND_PALETTE_SOUND_SETTINGS": {
+      "TYPE": "TEXT",
+      "VALUE": "Sound settings"
+    },
+    "SOUND_PALETTE_SOUND_SETTINGS_PAGE_TITLE": {
+      "TYPE": "TEXT",
+      "VALUE": "Sound"
+},
+    "LANGUAGES_INPUT_IN_SYSTEM": {
+      "TYPE": "TEXT",
+      "VALUE": "Languages & input"
+    },
+    "SYSTEM_SETTINGS_UNITS": {
+      "TYPE": "TEXT",
+      "VALUE": "Units"
+    },
+    "LANGUAGE_SYSTEM_SETTINGS_AUTOFILL_SERVICE": {
+      "TYPE": "TEXT",
+      "VALUE": "Autofill service"
+    },
+    "LANGUAGE_SYSTEM_SETTINGS_KEYBOARD": {
+      "TYPE": "TEXT",
+      "VALUE": "Keyboard"
+    },
+    "LANGUAGE_SYSTEM_SETTINGS_TEXT_TO_SPEECH_OUTPUT": {
+      "TYPE": "TEXT",
+      "VALUE": "Text-to-speech output"
+    },
+    "UNIT_SYSTEM_SETTINGS_SPEED": {
+      "TYPE": "TEXT",
+      "VALUE": "Speed"
+    },
+    "UNIT_SYSTEM_SETTINGS_DISTANCE": {
+      "TYPE": "TEXT",
+      "VALUE": "Distance"
+    },
+    "UNIT_SYSTEM_SETTINGS_TEMPERATURE": {
+      "TYPE": "TEXT",
+      "VALUE": "Temperature"
+    },
+    "UNIT_SYSTEM_SETTINGS_PRESSURE": {
+      "TYPE": "TEXT",
+      "VALUE": "Pressure"
+    },
+    "USER_SETTINGS_USER_AVATAR": {
+      "TYPE": "RESOURCE_ID",
+      "VALUE": "user_avatar"
     }
   },
   "WORKFLOWS": {
@@ -2667,5 +2773,3 @@
     ]
   }
 }
-
-
diff --git a/libraries/automotive-helpers/auto-default-config/src/android/platform/helpers/AutomotiveConfigConstants.java b/libraries/automotive-helpers/auto-default-config/src/android/platform/helpers/AutomotiveConfigConstants.java
index fb3a1e158..b81d2482e 100644
--- a/libraries/automotive-helpers/auto-default-config/src/android/platform/helpers/AutomotiveConfigConstants.java
+++ b/libraries/automotive-helpers/auto-default-config/src/android/platform/helpers/AutomotiveConfigConstants.java
@@ -231,6 +231,9 @@ public class AutomotiveConfigConstants {
     // Display Settings Constants
     public static final String BRIGHTNESS_SEEKBAR = "BRIGHTNESS_SEEKBAR";
 
+    // Bluetooth Settings Constants
+    public static final String USE_BLUETOOTH_SETTINGS_TOGGLE = "USE_BLUETOOTH_SETTINGS_TOGGLE";
+
     // Date and time Settings Constants
     public static final String DATE_TIME_SETTINGS_SCROLL_ACTION =
             "DATE_TIME_SETTINGS_SCROLL_ACTION";
@@ -381,6 +384,11 @@ public class AutomotiveConfigConstants {
     public static final String APPS_SETTINGS = "OPEN_APPS_SETTINGS_WORKFLOW";
     public static final String SECURITY_SETTINGS = "OPEN_SECURITY_SETTINGS_WORKFLOW";
 
+    public static final String SETTINGS_SCROLL_ACTION = "SETTINGS_SCROLL_ACTION";
+    public static final String SETTINGS_SCROLL_DIRECTION = "SETTINGS_SCROLL_DIRECTION";
+    public static final String SETTINGS_SCROLL_BACKWARD_BUTTON = "SETTINGS_SCROLL_BACKWARD_BUTTON";
+    public static final String SETTINGS_SCROLL_FORWARD_BUTTON = "SETTINGS_SCROLL_FORWARD_BUTTON";
+    public static final String SETTINGS_SCROLL_ELEMENT = "SETTINGS_SCROLL_ELEMENT";
     public static final String SETTINGS_SUB_SETTING_SCROLL_ACTION =
             "SETTINGS_SUB_SETTING_SCROLL_ACTION";
     public static final String SETTINGS_SUB_SETTING_SCROLL_DIRECTION =
@@ -665,6 +673,7 @@ public class AutomotiveConfigConstants {
 
     // Phone Device Identifiers
     public static final String MOBILE_CALL_BUTTON = "MOBILE_CALL_BUTTON";
+    public static final String MOBILE_DIALPAD = "MOBILE_DIALPAD";
     public static final String MOBILE_DIAL_PAD_ICON = "MOBILE_DIALPAD_ICON";
     public static final String MOBILE_PHONE_ICON = "MOBILE_PHONE_ICON";
     public static final String PHONE_DEVICE_PACKAGE = "PHONE_DEVICE_PACAKAGE";
@@ -672,4 +681,28 @@ public class AutomotiveConfigConstants {
 
     // Phone Card Identifiers
     public static final String PHONE_CARD_DIALER_BUTTON = "PHONE_CARD_DIALER_BUTTON";
+
+    // Sound Palette
+    public static final String STATUS_BAR_SOUND_BUTTON = "STATUS_BAR_SOUND_BUTTON";
+    public static final String SOUND_PALETTE_INCALL = "SOUND_PALETTE_INCALL";
+    public static final String SOUND_PALETTE_MEDIA = "SOUND_PALETTE_MEDIA";
+    public static final String SOUND_PALETTE_NAVIGATION = "SOUND_PALETTE_NAVIGATION";
+    public static final String SOUND_PALETTE_SOUND_SETTINGS = "SOUND_PALETTE_SOUND_SETTINGS";
+    public static final String SOUND_PALETTE_SOUND_SETTINGS_PAGE_TITLE =
+            "SOUND_PALETTE_SOUND_SETTINGS_PAGE_TITLE";
+
+    // System Setting UI elements
+    public static final String SYSTEM_SETTINGS_UNITS = "SYSTEM_SETTINGS_UNITS";
+    public static final String LANGUAGE_SYSTEM_SETTINGS_AUTOFILL_SERVICE =
+            "LANGUAGE_SYSTEM_SETTINGS_AUTOFILL_SERVICE";
+    public static final String LANGUAGE_SYSTEM_SETTINGS_KEYBOARD =
+            "LANGUAGE_SYSTEM_SETTINGS_KEYBOARD";
+    public static final String LANGUAGE_SYSTEM_SETTINGS_TEXT_TO_SPEECH_OUTPUT =
+            "LANGUAGE_SYSTEM_SETTINGS_TEXT_TO_SPEECH_OUTPUT";
+    public static final String UNIT_SYSTEM_SETTINGS_SPEED = "UNIT_SYSTEM_SETTINGS_SPEED";
+    public static final String UNIT_SYSTEM_SETTINGS_DISTANCE = "UNIT_SYSTEM_SETTINGS_DISTANCE";
+    public static final String UNIT_SYSTEM_SETTINGS_TEMPERATURE =
+            "UNIT_SYSTEM_SETTINGS_TEMPERATURE";
+    public static final String UNIT_SYSTEM_SETTINGS_PRESSURE = "UNIT_SYSTEM_SETTINGS_PRESSURE";
+    public static final String LANGUAGES_INPUT_IN_SYSTEM = "LANGUAGES_INPUT_IN_SYSTEM";
 }
diff --git a/libraries/automotive-helpers/home-helper/src/android/platform/helpers/HomeHelperImpl.java b/libraries/automotive-helpers/home-helper/src/android/platform/helpers/HomeHelperImpl.java
index c920cfadc..761883a66 100644
--- a/libraries/automotive-helpers/home-helper/src/android/platform/helpers/HomeHelperImpl.java
+++ b/libraries/automotive-helpers/home-helper/src/android/platform/helpers/HomeHelperImpl.java
@@ -262,4 +262,19 @@ public class HomeHelperImpl extends AbstractStandardAppHelper implements IAutoHo
         getSpectatioUiUtil().clickAndWait(assistantWidget);
         getSpectatioUiUtil().wait5Seconds();
     }
+
+    @Override
+    public void openHVAC() {
+        BySelector homeTemperatureButttonSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.HOME_TEMPERATURE_BUTTON);
+        UiObject2 homeTemperatureButton =
+                getSpectatioUiUtil().findUiObject(homeTemperatureButttonSelector);
+        getSpectatioUiUtil().clickAndWait(homeTemperatureButton);
+    }
+
+    @Override
+    public boolean isHVACOpen() {
+        BySelector hvacPanelSelector = getUiElementFromConfig(AutomotiveConfigConstants.HVAC_PANEL);
+        return getSpectatioUiUtil().hasUiElement(hvacPanelSelector);
+    }
 }
diff --git a/libraries/automotive-helpers/notifications-app-helper/src/android/platform/helpers/AutoNotificationHelperImpl.java b/libraries/automotive-helpers/notifications-app-helper/src/android/platform/helpers/AutoNotificationHelperImpl.java
index 8c4870228..94a350bdf 100644
--- a/libraries/automotive-helpers/notifications-app-helper/src/android/platform/helpers/AutoNotificationHelperImpl.java
+++ b/libraries/automotive-helpers/notifications-app-helper/src/android/platform/helpers/AutoNotificationHelperImpl.java
@@ -167,6 +167,18 @@ public class AutoNotificationHelperImpl extends AbstractStandardAppHelper
         return postedNotification != null;
     }
 
+    @Override
+    public boolean checkAppPermissionsExists(String title) {
+        return getSpectatioUiUtil().hasUiElement(title);
+    }
+
+    @Override
+    public void clickOnCheckRecentPermissions(String title) {
+        BySelector notificationSelector = By.text(title);
+        UiObject2 notification = getSpectatioUiUtil().findUiObject(notificationSelector);
+        getSpectatioUiUtil().clickAndWait(notification);
+    }
+
     /** {@inheritDoc} */
     @Override
     public void removeNotification(String title) {
diff --git a/libraries/automotive-helpers/phone-helper/src/android/platform/helpers/PhoneHelperImpl.java b/libraries/automotive-helpers/phone-helper/src/android/platform/helpers/PhoneHelperImpl.java
index f7d8c32bc..8a4cc00fc 100644
--- a/libraries/automotive-helpers/phone-helper/src/android/platform/helpers/PhoneHelperImpl.java
+++ b/libraries/automotive-helpers/phone-helper/src/android/platform/helpers/PhoneHelperImpl.java
@@ -39,6 +39,13 @@ public class PhoneHelperImpl extends AbstractStandardAppHelper implements IAutoP
         pressUIElement(AutomotiveConfigConstants.MOBILE_DIAL_PAD_ICON);
     }
 
+    @Override
+    public boolean isDialPadOpen() {
+        BySelector dialPadSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.MOBILE_DIALPAD);
+        return getSpectatioUiUtil().hasUiElement(dialPadSelector);
+    }
+
     /** {@inheritDoc} */
     @Override
     public void pressPhoneIcon() {
diff --git a/libraries/automotive-helpers/settings-app-helper/Android.bp b/libraries/automotive-helpers/settings-app-helper/Android.bp
index 1d0936a29..4021c40c6 100644
--- a/libraries/automotive-helpers/settings-app-helper/Android.bp
+++ b/libraries/automotive-helpers/settings-app-helper/Android.bp
@@ -28,6 +28,7 @@ java_library {
         "automotive-config-lib",
         "android.car-system-stubs",
         "automotive-utility-helper",
+        "com_android_car_settings_flags_lib",
     ],
     srcs: ["src/**/*.java"],
     sdk_version: "test_current",
diff --git a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingHelperImpl.java b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingHelperImpl.java
index 766ba48bd..c6265d1d3 100644
--- a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingHelperImpl.java
+++ b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingHelperImpl.java
@@ -41,7 +41,12 @@ public class SettingHelperImpl extends AbstractStandardAppHelper implements IAut
 
     private static final String SCREEN_BRIGHTNESS = "screen_brightness";
 
-    private final ScrollUtility mScrollUtility;
+    private ScrollUtility mScrollUtility;
+    private ScrollActions mScrollAction;
+    private BySelector mBackwardButtonSelector;
+    private BySelector mForwardButtonSelector;
+    private BySelector mScrollableElementSelector;
+    private ScrollDirection mScrollDirection;
     private final SeekUtility mSeekUtility;
     private Context mContext;
     private boolean mUseCommandToOpenSettings = true;
@@ -54,6 +59,18 @@ public class SettingHelperImpl extends AbstractStandardAppHelper implements IAut
                         InstrumentationRegistry.getArguments()
                                 .getString("use_command_to_open_settings", "true"));
         mScrollUtility = ScrollUtility.getInstance(getSpectatioUiUtil());
+        mScrollAction =
+                ScrollActions.valueOf(
+                        getActionFromConfig(AutomotiveConfigConstants.SETTINGS_SCROLL_ACTION));
+        mBackwardButtonSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.SETTINGS_SCROLL_BACKWARD_BUTTON);
+        mForwardButtonSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.SETTINGS_SCROLL_FORWARD_BUTTON);
+        mScrollableElementSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.SETTINGS_SCROLL_ELEMENT);
+        mScrollDirection =
+                ScrollDirection.valueOf(
+                        getActionFromConfig(AutomotiveConfigConstants.SETTINGS_SCROLL_DIRECTION));
         mSeekUtility = SeekUtility.getInstance(getSpectatioUiUtil());
     }
 
@@ -213,6 +230,28 @@ public class SettingHelperImpl extends AbstractStandardAppHelper implements IAut
         return ba.isEnabled();
     }
 
+    /** {@inheritDoc} */
+    @Override
+    public boolean scrollBackward() {
+        return mScrollUtility.scrollBackward(
+                mScrollAction,
+                mScrollDirection,
+                mBackwardButtonSelector,
+                mScrollableElementSelector,
+                String.format("Scroll backward on the settings menu page"));
+    }
+
+    /** {@inheritDoc} */
+    @Override
+    public boolean scrollForward() {
+        return mScrollUtility.scrollForward(
+                mScrollAction,
+                mScrollDirection,
+                mForwardButtonSelector,
+                mScrollableElementSelector,
+                String.format("Scroll forward on the settings menu page"));
+    }
+
     /** {@inheritDoc} */
     @Override
     public void searchAndSelect(String item) {
diff --git a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingUserHelperImpl.java b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingUserHelperImpl.java
index fed365fc7..ec517a358 100644
--- a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingUserHelperImpl.java
+++ b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingUserHelperImpl.java
@@ -93,12 +93,11 @@ public class SettingUserHelperImpl extends AbstractStandardAppHelper implements
     // opens permission page of a user
     @Override
     public void openPermissionsPage(String user) {
-        if (isUserPresent(user)) {
-            BySelector userSelector = By.text(user);
-            UiObject2 userObject = getSpectatioUiUtil().findUiObject(userSelector);
-            getSpectatioUiUtil().validateUiObject(userObject, String.format("User %s", user));
-            getSpectatioUiUtil().clickAndWait(userObject);
-        }
+        clickbutton(AutomotiveConfigConstants.USER_SETTINGS_MANAGE_OTHER_PROFILES);
+        BySelector userSelector = By.text(user);
+        UiObject2 userObject = getSpectatioUiUtil().findUiObject(userSelector);
+        getSpectatioUiUtil().validateUiObject(userObject, String.format("User %s", user));
+        getSpectatioUiUtil().clickAndWait(userObject);
     }
 
     // delete an existing user
diff --git a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsBluetoothHelperImpl.java b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsBluetoothHelperImpl.java
index 2079a608b..456521b89 100644
--- a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsBluetoothHelperImpl.java
+++ b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsBluetoothHelperImpl.java
@@ -47,6 +47,12 @@ public class SettingsBluetoothHelperImpl extends AbstractStandardAppHelper
         return buttonChecked(AutomotiveConfigConstants.TOGGLE_DEVICE_BLUETOOTH);
     }
 
+    /** {@inheritDoc} */
+    @Override
+    public boolean isUseBluetoothToggleChecked() {
+        return buttonChecked(AutomotiveConfigConstants.USE_BLUETOOTH_SETTINGS_TOGGLE);
+    }
+
     /** {@inheritDoc} */
     @Override
     public boolean isMediaPreferenceChecked() {
diff --git a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDateTimeHelperImpl.java b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDateTimeHelperImpl.java
index 50e2c93f6..fe099d6dd 100644
--- a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDateTimeHelperImpl.java
+++ b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDateTimeHelperImpl.java
@@ -19,7 +19,8 @@ package android.platform.helpers;
 import static junit.framework.Assert.assertTrue;
 
 import android.app.Instrumentation;
-import android.content.ContentResolver;
+import android.app.time.Capabilities;
+import android.app.time.TimeManager;
 import android.platform.helpers.ScrollUtility.ScrollActions;
 import android.platform.helpers.ScrollUtility.ScrollDirection;
 import android.text.format.DateFormat;
@@ -31,6 +32,8 @@ import androidx.test.uiautomator.UiObject2;
 import androidx.test.uiautomator.UiScrollable;
 import androidx.test.uiautomator.UiSelector;
 
+import com.android.car.settings.Flags;
+
 import java.time.LocalDate;
 import java.time.Month;
 import java.time.format.TextStyle;
@@ -115,9 +118,7 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
         assertTrue("set date menu is not clickable", setDateMenu.isEnabled()); // from UI
         getSpectatioUiUtil().clickAndWait(setDateMenu);
         getSpectatioUiUtil().wait1Second();
-        assertTrue(
-                "automatic date & time is not switched off",
-                !isAutomaticOn("auto_time")); // from API
+        assertTrue("automatic date & time is not switched off", !isAutomaticOn()); // from API
         int year = date.getYear();
         Month month = date.getMonth();
         int day = date.getDayOfMonth();
@@ -205,9 +206,7 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
         UiObject2 setTimeMenu = getSetTimeMenu();
         assertTrue("set time menu is not clickable", setTimeMenu.isEnabled()); // from UI
         getSpectatioUiUtil().clickAndWait(setTimeMenu);
-        assertTrue(
-                "automatic date & time is not switched off",
-                !isAutomaticOn("auto_time")); // from API
+        assertTrue("automatic date & time is not switched off", !isAutomaticOn()); // from API
         String minute_string = "" + minute;
         String am_pm = "";
         am_pm = am ? "AM" : "PM";
@@ -244,9 +243,7 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
         UiObject2 setTimeMenu = getSetTimeMenu();
         assertTrue("set time menu is not clickable", setTimeMenu.isEnabled()); // from UI
         getSpectatioUiUtil().clickAndWait(setTimeMenu);
-        assertTrue(
-                "automatic date & time is not switched off",
-                !isAutomaticOn("auto_time")); // from API
+        assertTrue("automatic date & time is not switched off", !isAutomaticOn()); // from API
         String minute_string = "" + minute;
         if (minute < 10) {
             minute_string = "0" + minute;
@@ -413,22 +410,24 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
     /** {@inheritDoc} */
     @Override
     public void setTimeZone(String timezone) {
-        UiObject2 autoTimeZoneSwitchWidget = getAutoTimeZoneSwitchWidget();
         UiObject2 autoTimeZoneMenu =
                 getMenu(
                         getUiElementFromConfig(
-                                AutomotiveConfigConstants
-                                        .DATE_TIME_SETTINGS_SET_TIME_ZONE_AUTOMATICALLY));
-        if (getAutoTimeZoneSwitchWidget().isChecked()) {
+                                Flags.updateDateAndTimePage()
+                                        ? AutomotiveConfigConstants
+                                                .DATE_TIME_SETTINGS_SET_TIME_AUTOMATICALLY
+                                        : AutomotiveConfigConstants
+                                                .DATE_TIME_SETTINGS_SET_TIME_ZONE_AUTOMATICALLY));
+        if (Flags.updateDateAndTimePage()
+                ? getAutoDateTimeSwitchWidget().isChecked()
+                : getAutoTimeZoneSwitchWidget().isChecked()) {
             getSpectatioUiUtil().clickAndWait(autoTimeZoneMenu);
         }
         UiObject2 selectTimeZoneMenu = getSelectTimeZoneMenu();
         assertTrue(
                 "select time zone menu is not clickable",
                 selectTimeZoneMenu.isEnabled()); // from UI
-        assertTrue(
-                "automatic time zone is not switched off",
-                !isAutomaticOn("auto_time_zone")); // from API
+        assertTrue("automatic time zone is not switched off", !isAutomaticOn()); // from API
         getSpectatioUiUtil().clickAndWait(selectTimeZoneMenu);
         BySelector selector = By.clickable(true).hasDescendant(By.text(timezone));
         ScrollActions scrollAction =
@@ -557,7 +556,11 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
     private UiObject2 getAutoTimeZoneSwitchWidget() {
         return getSwitchWidget(
                 getUiElementFromConfig(
-                        AutomotiveConfigConstants.DATE_TIME_SETTINGS_SET_TIME_ZONE_AUTOMATICALLY));
+                        Flags.updateDateAndTimePage()
+                                ? AutomotiveConfigConstants
+                                        .DATE_TIME_SETTINGS_SET_TIME_AUTOMATICALLY
+                                : AutomotiveConfigConstants
+                                        .DATE_TIME_SETTINGS_SET_TIME_ZONE_AUTOMATICALLY));
     }
 
     private UiObject2 getUseTwentyFourHourFormatSwitchWidget() {
@@ -586,15 +589,32 @@ public class SettingsDateTimeHelperImpl extends AbstractStandardAppHelper
         return obj.findObject(mSummarySelector).getText();
     }
 
-    private boolean isAutomaticOn(String name) {
-        ContentResolver cr = mInstrumentation.getContext().getContentResolver();
-        int status = 0;
+    private boolean isAutomaticOn() {
+        TimeManager timeManager = mInstrumentation.getContext().getSystemService(TimeManager.class);
+        boolean status;
         try {
-            status = android.provider.Settings.Global.getInt(cr, name);
+            status = timeManager
+                            .getTimeCapabilitiesAndConfig()
+                            .getCapabilities()
+                            .getConfigureAutoDetectionEnabledCapability()
+                                    == Capabilities.CAPABILITY_POSSESSED
+                    && timeManager
+                            .getTimeCapabilitiesAndConfig()
+                            .getConfiguration()
+                            .isAutoDetectionEnabled()
+                    && timeManager
+                            .getTimeZoneCapabilitiesAndConfig()
+                            .getCapabilities()
+                            .getConfigureAutoDetectionEnabledCapability()
+                                    == Capabilities.CAPABILITY_POSSESSED
+                    && timeManager
+                            .getTimeZoneCapabilitiesAndConfig()
+                            .getConfiguration()
+                            .isAutoDetectionEnabled();
         } catch (Exception e) {
             throw new RuntimeException(e);
         }
-        return status == 1 ? true : false;
+        return status;
     }
 
 }
diff --git a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDisplayHelperImpl.java b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDisplayHelperImpl.java
index f55cc1014..a38d9aee5 100644
--- a/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDisplayHelperImpl.java
+++ b/libraries/automotive-helpers/settings-app-helper/src/android/platform/helpers/SettingsDisplayHelperImpl.java
@@ -111,6 +111,9 @@ public class SettingsDisplayHelperImpl extends AbstractStandardAppHelper
     @Override
     public void toggleAdaptiveBrightness() {
         getAdaptiveBrightnessSwitch().click();
+        //Wait time if Gestures takes longer time
+        getSpectatioUiUtil().waitForIdle();
+        getSpectatioUiUtil().wait1Second();
     }
 
     /** {@inheritDoc} */
diff --git a/libraries/automotive-helpers/status-bar-helper/src/android/platform/helpers/StatusBarHelperImpl.java b/libraries/automotive-helpers/status-bar-helper/src/android/platform/helpers/StatusBarHelperImpl.java
index 939526407..eaf9c2233 100644
--- a/libraries/automotive-helpers/status-bar-helper/src/android/platform/helpers/StatusBarHelperImpl.java
+++ b/libraries/automotive-helpers/status-bar-helper/src/android/platform/helpers/StatusBarHelperImpl.java
@@ -68,6 +68,31 @@ public class StatusBarHelperImpl extends AbstractStandardAppHelper implements IA
         getSpectatioUiUtil().clickAndWait(bluetoothButtonLink);
     }
 
+    /** {@inheritDoc} */
+    @Override
+    public void openSoundPaletteOnStatusBar() {
+        BySelector soundButtonSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.STATUS_BAR_SOUND_BUTTON);
+        UiObject2 soundButton = getSpectatioUiUtil().findUiObject(soundButtonSelector);
+        getSpectatioUiUtil()
+                .validateUiObject(soundButton, AutomotiveConfigConstants.STATUS_BAR_SOUND_BUTTON);
+        getSpectatioUiUtil().clickAndWait(soundButton);
+    }
+
+    /** {@inheritDoc} */
+    @Override
+    public boolean hasSoundButton() {
+        BySelector soundButtonSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.STATUS_BAR_SOUND_BUTTON);
+        return (getSpectatioUiUtil().hasUiElement(soundButtonSelector));
+    }
+
+    @Override
+    public boolean isUIButtonPresentOnSoundPalette(String targetSelector) {
+        BySelector uiButtonSelector = getUiElementFromConfig(targetSelector);
+        return (getSpectatioUiUtil().hasUiElement(uiButtonSelector));
+    }
+
     /** {@inheritDoc} */
     @Override
     public boolean hasBluetoothSwitch() {
@@ -406,6 +431,7 @@ public class StatusBarHelperImpl extends AbstractStandardAppHelper implements IA
                 getSpectatioUiUtil()
                         .executeShellCommand(
                                 getCommandFromConfig(AutomotiveConfigConstants.DAY_MODE_COMMAND));
+
         boolean result = dayModeResult.contains("changed to: day");
         return result;
     }
@@ -463,4 +489,27 @@ public class StatusBarHelperImpl extends AbstractStandardAppHelper implements IA
         getSpectatioUiUtil().clickAndWait(disabledMediaProfile);
         getSpectatioUiUtil().wait5Seconds();
     }
+
+    /** {@inheritDoc} */
+    @Override
+    public void openSoundSettings() {
+        BySelector soundSettingsSelector =
+                getUiElementFromConfig(AutomotiveConfigConstants.SOUND_PALETTE_SOUND_SETTINGS);
+        UiObject2 soundSettingsObject = getSpectatioUiUtil().findUiObject(soundSettingsSelector);
+        getSpectatioUiUtil()
+                .validateUiObject(
+                        soundSettingsObject,
+                        AutomotiveConfigConstants.SOUND_PALETTE_SOUND_SETTINGS);
+        getSpectatioUiUtil().clickAndWait(soundSettingsObject);
+        getSpectatioUiUtil().wait5Seconds();
+    }
+
+    /** {@inheritDoc} */
+    @Override
+    public boolean hasSoundSettingsPageTitle() {
+        BySelector soundSettingsPageTitleSelector =
+                getUiElementFromConfig(
+                        AutomotiveConfigConstants.SOUND_PALETTE_SOUND_SETTINGS_PAGE_TITLE);
+        return (getSpectatioUiUtil().hasUiElement(soundSettingsPageTitleSelector));
+    }
 }
diff --git a/libraries/car-helpers/multiuser-helper/Android.bp b/libraries/car-helpers/multiuser-helper/Android.bp
index 32f4911b9..61bd4de5f 100644
--- a/libraries/car-helpers/multiuser-helper/Android.bp
+++ b/libraries/car-helpers/multiuser-helper/Android.bp
@@ -12,7 +12,6 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.
 
-
 package {
     default_applicable_licenses: ["Android-Apache-2.0"],
 }
diff --git a/libraries/car-helpers/multiuser-helper/src/android/platform/helpers/MultiUserHelper.java b/libraries/car-helpers/multiuser-helper/src/android/platform/helpers/MultiUserHelper.java
index 7d38cf926..703be9213 100644
--- a/libraries/car-helpers/multiuser-helper/src/android/platform/helpers/MultiUserHelper.java
+++ b/libraries/car-helpers/multiuser-helper/src/android/platform/helpers/MultiUserHelper.java
@@ -18,9 +18,17 @@ package android.platform.helpers;
 import android.annotation.Nullable;
 import android.app.ActivityManager;
 import android.car.Car;
+import android.car.CarOccupantZoneManager;
+import android.car.SyncResultCallback;
 import android.car.user.CarUserManager;
 import android.car.user.CarUserManager.UserLifecycleListener;
+import android.car.user.UserCreationRequest;
+import android.car.user.UserCreationResult;
+import android.car.user.UserStartResponse;
+import android.car.user.UserStartRequest;
 import android.car.user.UserSwitchResult;
+import android.car.user.UserStopRequest;
+import android.car.user.UserStopResponse;
 import android.car.util.concurrent.AsyncFuture;
 import android.content.Context;
 import android.content.pm.UserInfo;
@@ -43,22 +51,27 @@ import java.util.concurrent.TimeUnit;
  * {@link CarUserManager}, {@link UserManager} to expose functions for user switch end-to-end tests.
  */
 public class MultiUserHelper {
+    private static final int CREATE_USER_TIMEOUT_MS = 20_000;
     private static final String LOG_TAG = MultiUserHelper.class.getSimpleName();
 
     /** For testing purpose we allow a wide range of switching time. */
     private static final int USER_SWITCH_TIMEOUT_SECOND = 300;
 
-    private static final String SWITCH_USER_COMMAND = "cmd car_service switch-user ";
+    private static final String CREATE_USER_COMMAND = "cmd car_service create-user ";
 
     private static MultiUserHelper sMultiUserHelper;
     private CarUserManager mCarUserManager;
     private UserManager mUserManager;
+    private ActivityManager mActivityManager;
+    private CarOccupantZoneManager mCarOccupantZoneManager;
 
     private MultiUserHelper() {
         Context context = InstrumentationRegistry.getTargetContext();
         mUserManager = UserManager.get(context);
         Car car = Car.createCar(context);
         mCarUserManager = (CarUserManager) car.getCarManager(Car.CAR_USER_SERVICE);
+        mActivityManager = context.getSystemService(ActivityManager.class);
+        mCarOccupantZoneManager = car.getCarManager(CarOccupantZoneManager.class);
     }
 
     /**
@@ -73,6 +86,21 @@ public class MultiUserHelper {
         return sMultiUserHelper;
     }
 
+    /**
+     * Creates a user if it does not exist already.
+     *
+     * @param name the name of the user or guest
+     * @param isGuestUser true if want to create a guest, otherwise create a regular user
+     * @return User Id for newly created user or existing user if it already exists
+     */
+    public int createUserIfDoesNotExist(String name, boolean isGuestUser) throws Exception {
+        UserInfo userInfo = getUserByName(name);
+        if (userInfo != null) {
+            return userInfo.id;
+        }
+        return createUser(name, isGuestUser);
+    }
+
     /**
      * Creates a regular user or guest
      *
@@ -81,11 +109,67 @@ public class MultiUserHelper {
      * @return User Id for newly created user
      */
     public int createUser(String name, boolean isGuestUser) throws Exception {
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
+            Log.d(
+                    LOG_TAG,
+                    "An Android version earlier than UDC is detected. Using the shell for user "
+                            + "creation");
+            return createUserUsingShell(name, isGuestUser);
+        }
+        Log.d(
+                LOG_TAG,
+                "Creating new "
+                        + (isGuestUser ? "guest" : "user")
+                        + " with name '"
+                        + name
+                        + "' using CarUserManager");
+        SyncResultCallback<UserCreationResult> userCreationResultCallback =
+                new SyncResultCallback<>();
         if (isGuestUser) {
-            return mUserManager.createUser(name, UserManager.USER_TYPE_FULL_GUEST, /* flags= */ 0)
-                    .id;
+            // Create a new guest
+            mCarUserManager.createUser(
+                    new UserCreationRequest.Builder().setName(name).setGuest().build(),
+                    Runnable::run,
+                    userCreationResultCallback);
+        } else {
+            // Create a new user
+            mCarUserManager.createUser(
+                    new UserCreationRequest.Builder().setName(name).build(),
+                    Runnable::run,
+                    userCreationResultCallback);
+        }
+        UserCreationResult result =
+                userCreationResultCallback.get(CREATE_USER_TIMEOUT_MS, TimeUnit.MILLISECONDS);
+        if (!result.isSuccess()) {
+            throw new Exception(String.format("The user was not created successfully: %s", result));
         }
-        return mUserManager.createUser(name, /* flags= */ 0).id;
+        return result.getUser().getIdentifier();
+    }
+
+    private int createUserUsingShell(String name, boolean isGuest) throws Exception {
+        String retStr;
+        Log.d(
+                LOG_TAG,
+                "Creating new " + (isGuest ? "guest" : "user") + " with name '" + name + "'");
+        if (isGuest) {
+            retStr = SystemUtil.runShellCommand(CREATE_USER_COMMAND + "--guest " + name);
+        } else {
+            retStr = SystemUtil.runShellCommand(CREATE_USER_COMMAND + name);
+        }
+        if (!retStr.contains("STATUS_SUCCESSFUL")) {
+            throw new Exception(
+                    "failed to create a new user: "
+                            + name
+                            + ". User creation shell command output: "
+                            + retStr);
+        }
+        // Extract the user ID out and return it
+        String userIdPattern = "id=";
+        int newUserId = -1;
+        if (retStr.contains(userIdPattern) && retStr.split(userIdPattern).length > 1) {
+            newUserId = Integer.parseInt(retStr.split(userIdPattern)[1].trim());
+        }
+        return newUserId;
     }
 
     /**
@@ -110,16 +194,11 @@ public class MultiUserHelper {
      * @param id Id of the user to switch to
      */
     public void switchToUserId(int id) throws Exception {
-        Log.v(
+        Log.d(
                 LOG_TAG,
                 String.format(
                         "Switching from user %d to user %d",
                         getCurrentForegroundUserInfo().id, id));
-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU) {
-            switchUserUsingShell(id);
-            return;
-        }
-
         final CountDownLatch latch = new CountDownLatch(1);
         // A UserLifeCycleListener to wait for user switch event. It is equivalent to
         // UserSwitchObserver#onUserSwitchComplete callback
@@ -153,6 +232,66 @@ public class MultiUserHelper {
         mCarUserManager.removeListener(userSwitchListener);
     }
 
+    /**
+     * Starts a user on a display. Awaits {@link CarUserManager#USER_LIFECYCLE_EVENT_TYPE_STARTING} event.
+     *
+     * <p>User start complete only means the user ready at API level. It doesn't mean the UI is
+     * completely ready for the target user. It doesn't include unlocking user data and loading car
+     * launcher page
+     *
+     * @param id Id of the user to start
+     * @param displayId Id of the display to start the user on
+     */
+    public void startUser(int id, int displayId) throws Exception {
+        final CountDownLatch latch = new CountDownLatch(1);
+        UserLifecycleListener userStartListener =
+                e -> {
+                    if (e.getEventType() == CarUserManager.USER_LIFECYCLE_EVENT_TYPE_STARTING) {
+                        latch.countDown();
+                    }
+                };
+        mCarUserManager.addListener(Runnable::run, userStartListener);
+        UserStartRequest userStartRequest =
+                new UserStartRequest.Builder(mUserManager.getUserInfo(id).getUserHandle())
+                        .setDisplayId(displayId)
+                        .build();
+        Log.d(LOG_TAG, String.format("Starting a user with id %d on display %d", id, displayId));
+        SyncResultCallback<UserStartResponse> userStartResponseCallback =
+                new SyncResultCallback<>();
+        mCarUserManager.startUser(userStartRequest, Runnable::run, userStartResponseCallback);
+        UserStartResponse response =
+                userStartResponseCallback.get(USER_SWITCH_TIMEOUT_SECOND, TimeUnit.SECONDS);
+        if (!response.isSuccess()) {
+            throw new Exception(
+                    String.format(
+                            "Failed to start user %d on display %d: %s", id, displayId, response));
+        }
+        if (!latch.await(USER_SWITCH_TIMEOUT_SECOND, TimeUnit.SECONDS)) {
+            throw new Exception(
+                    String.format(
+                            "Timeout while starting user %d after %d seconds",
+                            id, USER_SWITCH_TIMEOUT_SECOND));
+        }
+        mCarUserManager.removeListener(userStartListener);
+    }
+
+    /**
+     * Stops a user.
+     *
+     * @param id Id of the user to stop
+     */
+    public void stopUser(int id) throws Exception {
+        UserStopRequest userStopRequest =
+                new UserStopRequest.Builder(mUserManager.getUserInfo(id).getUserHandle()).build();
+        SyncResultCallback<UserStopResponse> userStopResponseCallback = new SyncResultCallback<>();
+        mCarUserManager.stopUser(userStopRequest, Runnable::run, userStopResponseCallback);
+        UserStopResponse response =
+                userStopResponseCallback.get(USER_SWITCH_TIMEOUT_SECOND, TimeUnit.SECONDS);
+        if (!response.isSuccess()) {
+            throw new Exception(String.format("Failed to stop user %d: %s", id, response));
+        }
+    }
+
     /**
      * Removes the target user. For now it is a non-blocking call.
      *
@@ -160,7 +299,17 @@ public class MultiUserHelper {
      * @return true if removed successfully
      */
     public boolean removeUser(UserInfo userInfo) {
-        return mUserManager.removeUser(userInfo.id);
+        return removeUser(userInfo.id);
+    }
+
+    /**
+     * Removes the target user. For now it is a non-blocking call.
+     *
+     * @param userId id of the user to be removed
+     * @return true if removed successfully
+     */
+    public boolean removeUser(int userId) {
+        return mUserManager.removeUser(userId);
     }
 
     public UserInfo getCurrentForegroundUserInfo() {
@@ -196,10 +345,22 @@ public class MultiUserHelper {
                 .orElse(null);
     }
 
-    private void switchUserUsingShell(int userId) throws Exception {
-        String retStr = SystemUtil.runShellCommand(SWITCH_USER_COMMAND + userId);
-        if (!retStr.contains("STATUS_SUCCESSFUL")) {
-            throw new Exception("failed to switch to user: " + userId);
-        }
+    /**
+     * Returns the list of displays that are available for starting visible background users.
+     *
+     * @return The list of displays that are available for starting visible background users.
+     */
+    public int[] getDisplayIdsForStartingVisibleBackgroundUsers() {
+        return mActivityManager.getDisplayIdsForStartingVisibleBackgroundUsers();
+    }
+
+    /**
+     * Returns the user id for the given display id.
+     *
+     * @param displayId The display id.
+     * @return The user id for the given display id.
+     */
+    public int getUserForDisplayId(int displayId) {
+        return mCarOccupantZoneManager.getUserForDisplayId(displayId);
     }
 }
diff --git a/libraries/collectors-helper/memory/src/com/android/helpers/ShowmapSnapshotHelper.java b/libraries/collectors-helper/memory/src/com/android/helpers/ShowmapSnapshotHelper.java
index f1edd4d20..91618c314 100644
--- a/libraries/collectors-helper/memory/src/com/android/helpers/ShowmapSnapshotHelper.java
+++ b/libraries/collectors-helper/memory/src/com/android/helpers/ShowmapSnapshotHelper.java
@@ -53,13 +53,14 @@ public class ShowmapSnapshotHelper implements ICollectorHelper<String> {
     public static final String ALL_PROCESSES_CMD = "ps -A";
     private static final String SHOWMAP_CMD = "showmap -v %d";
     private static final String CHILD_PROCESSES_CMD = "ps -A --ppid %d";
+    private static final String ACTIVITY_LRU_CMD = "dumpsys activity lru";
+    private static final String DUMP_SYS_THREADS_CMD = "ps -ATw -o pid,tid,ppid,name,cmd,cmdline";
     @VisibleForTesting public static final String OOM_SCORE_ADJ_CMD = "cat /proc/%d/oom_score_adj";
+    @VisibleForTesting public static final String COUNT_THREADS_CMD = "sh /sdcard/countThreads.sh";
     private static final int PROCESS_OOM_SCORE_IMPERCEPTIBLE = 200;
     private static final int PROCESS_OOM_SCORE_CACHED = 899;
-    private static final String ACTIVITY_LRU_CMD = "dumpsys activity lru";
-    private static final String THREADS_FILE_PATH = "/sdcard/countThreads.sh";
-    @VisibleForTesting public static final String THREADS_CMD = "sh /sdcard/countThreads.sh";
-    private static final String THREADS_EXEC_SCRIPT =
+    private static final String COUNT_THREADS_FILE_PATH = "/sdcard/countThreads.sh";
+    private static final String COUNT_THREADS_EXEC_SCRIPT =
             "for i in $(ls /proc | grep -E [0-9]+); do echo \"threads_count_$(cat"
                     + " /proc/$i/cmdline) : $(ls /proc/$i/task | wc -l)\"; done;";
     public static final String THREADS_PATTERN = "(?<key>^threads_count_.+) : (?<value>[0-9]+)";
@@ -67,6 +68,7 @@ public class ShowmapSnapshotHelper implements ICollectorHelper<String> {
     public static final String OUTPUT_IMPERCEPTIBLE_METRIC_PATTERN =
             "showmap_%s_bytes_imperceptible";
     public static final String OUTPUT_FILE_PATH_KEY = "showmap_output_file";
+    public static final String SYSTEM_THREADS_FILE_PATH_KEY = "system_threads_output_file";
     public static final String PROCESS_COUNT = "process_count";
     public static final String CHILD_PROCESS_COUNT_PREFIX = "child_processes_count";
     public static final String OUTPUT_CHILD_PROCESS_COUNT_KEY = CHILD_PROCESS_COUNT_PREFIX + "_%s";
@@ -81,7 +83,7 @@ public class ShowmapSnapshotHelper implements ICollectorHelper<String> {
     private String[] mProcessNames = null;
     private String mTestOutputDir = null;
     private String mTestOutputFile = null;
-
+    private String mSysThreadsDebugFile = null;
     private int mDropCacheOption;
     private boolean mCollectForAllProcesses = false;
     private UiDevice mUiDevice;
@@ -145,6 +147,58 @@ public class ShowmapSnapshotHelper implements ICollectorHelper<String> {
         }
 
         mTestOutputFile = filePath;
+
+        if (mRunCountThreads) {
+            // Prepare system threads output debugging file
+            String sysThreadsDebugFilePath =
+                    String.format(
+                            "%s/system_threads_snapshot%d.txt",
+                            mTestOutputDir, UUID.randomUUID().hashCode());
+            File sysThreadsDebugFile = new File(sysThreadsDebugFilePath);
+
+            // Make sure directory exists and file does not
+            if (directory.exists()) {
+                if (sysThreadsDebugFile.exists() && !sysThreadsDebugFile.delete()) {
+                    Log.e(
+                            TAG,
+                            String.format(
+                                    "Failed to delete threads debugging files %s",
+                                    sysThreadsDebugFile));
+                    return false;
+                }
+            } else {
+                if (!directory.mkdirs()) {
+                    Log.e(
+                            TAG,
+                            String.format(
+                                    "Failed to create result output directory %s", mTestOutputDir));
+                    return false;
+                }
+            }
+
+            // Create an empty file to fail early in case there are no write permissions
+            try {
+                if (!sysThreadsDebugFile.createNewFile()) {
+                    // This should not happen unless someone created the file right after we deleted
+                    // it
+                    Log.e(
+                            TAG,
+                            String.format(
+                                    "Race with another user of threads debugging files %s",
+                                    sysThreadsDebugFile));
+                    return false;
+                }
+            } catch (IOException e) {
+                Log.e(
+                        TAG,
+                        String.format(
+                                "Failed to create threads debugging files %s", sysThreadsDebugFile),
+                        e);
+                return false;
+            }
+            mSysThreadsDebugFile = sysThreadsDebugFilePath;
+        }
+
         return true;
     }
 
@@ -388,14 +442,22 @@ public class ShowmapSnapshotHelper implements ICollectorHelper<String> {
         String countOutput;
         Map<String, String> countResults = new HashMap<>();
         try {
-            File execTempFile = new File(THREADS_FILE_PATH);
+            // Run ps -AT into file for debugging
+            try (FileWriter sysThreadsDebugFileWriter =
+                    new FileWriter(new File(mSysThreadsDebugFile), true)) {
+                sysThreadsDebugFileWriter.write(executeShellCommand(DUMP_SYS_THREADS_CMD));
+            }
+            countResults.put(SYSTEM_THREADS_FILE_PATH_KEY, mSysThreadsDebugFile);
+
+            // Run count threads command and save it to metrics map
+            File execTempFile = new File(COUNT_THREADS_FILE_PATH);
             execTempFile.setWritable(true);
             execTempFile.setExecutable(true, /*ownersOnly*/ false);
             String countThreadsScriptPath = execTempFile.getAbsolutePath();
             BufferedWriter writer = new BufferedWriter(new FileWriter(countThreadsScriptPath));
-            writer.write(THREADS_EXEC_SCRIPT);
+            writer.write(COUNT_THREADS_EXEC_SCRIPT);
             writer.close();
-            countOutput = executeShellCommand(THREADS_CMD);
+            countOutput = executeShellCommand(COUNT_THREADS_CMD);
             Pattern pattern =
                     Pattern.compile(THREADS_PATTERN, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE);
             String[] lines = countOutput.split("\n");
diff --git a/libraries/collectors-helper/memory/test/src/com/android/helpers/tests/ShowmapSnapshotHelperTest.java b/libraries/collectors-helper/memory/test/src/com/android/helpers/tests/ShowmapSnapshotHelperTest.java
index 5d13bcd05..3b4016950 100644
--- a/libraries/collectors-helper/memory/test/src/com/android/helpers/tests/ShowmapSnapshotHelperTest.java
+++ b/libraries/collectors-helper/memory/test/src/com/android/helpers/tests/ShowmapSnapshotHelperTest.java
@@ -403,7 +403,7 @@ public class ShowmapSnapshotHelperTest {
                         + "threads_count_com.google.android.connectivitymonitor : 21\n";
         doReturn(countThreadsSampleOutput)
                 .when(mShowmapSnapshotHelper)
-                .executeShellCommand(matches(mShowmapSnapshotHelper.THREADS_CMD));
+                .executeShellCommand(matches(mShowmapSnapshotHelper.COUNT_THREADS_CMD));
         mShowmapSnapshotHelper.setCountThreadsOption(true);
         Map<String, String> metrics = mShowmapSnapshotHelper.getMetrics();
         assertFalse(metrics.isEmpty());
@@ -421,6 +421,6 @@ public class ShowmapSnapshotHelperTest {
         Map<String, String> metrics = mShowmapSnapshotHelper.getMetrics();
         assertTrue(metrics.isEmpty());
         verify(mShowmapSnapshotHelper, never())
-                .executeShellCommand(matches(mShowmapSnapshotHelper.THREADS_CMD));
+                .executeShellCommand(matches(mShowmapSnapshotHelper.COUNT_THREADS_CMD));
     }
 }
diff --git a/libraries/collectors-helper/system/src/com/android/helpers/FailureCountHelper.java b/libraries/collectors-helper/system/src/com/android/helpers/FailureCountHelper.java
new file mode 100644
index 000000000..c8ce2d989
--- /dev/null
+++ b/libraries/collectors-helper/system/src/com/android/helpers/FailureCountHelper.java
@@ -0,0 +1,74 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.helpers;
+
+import android.util.Log;
+
+import androidx.annotation.VisibleForTesting;
+
+import org.junit.runner.Description;
+
+import java.util.HashMap;
+import java.util.Map;
+
+/** FailureCountHelper is used to collect the number of times a test case fails. */
+public class FailureCountHelper implements ICollectorHelper<Integer> {
+
+    private static final String TAG = FailureCountHelper.class.getSimpleName();
+    private Map<String, Integer> mMetrics;
+
+    public FailureCountHelper() {
+        super();
+        mMetrics = new HashMap<>();
+    }
+
+    @Override
+    public boolean startCollecting() {
+        Log.d(TAG, "Started collecting for FailureCount.");
+        return true;
+    }
+
+    @Override
+    public Map<String, Integer> getMetrics() {
+        Log.d(TAG, "Grabbing mMetrics for FailureCount.");
+        return mMetrics;
+    }
+
+    @Override
+    public boolean stopCollecting() {
+        Log.d(TAG, "Stopped collecting for FailureCount.");
+        return true;
+    }
+
+    /** Method for recording the name of a failed test case as a metric. */
+    @VisibleForTesting
+    public void recordFailure(Description description) {
+        String key = convertTestDescriptionToKey(description);
+        mMetrics.putIfAbsent(key, 0);
+        mMetrics.put(key, mMetrics.get(key) + 1);
+    }
+
+    /** Converts test descriptions to metric keys. */
+    @VisibleForTesting
+    public String convertTestDescriptionToKey(Description description) {
+        String testClass = description.getClassName();
+        String testMethod = description.getMethodName();
+        // The iteration count must be removed if it exists.
+        return String.format(
+                "failure_count_%s.%s", testClass.split("\\$")[0], testMethod.split("\\$")[0]);
+    }
+}
diff --git a/libraries/collectors-helper/system/test/src/com/android/helpers/tests/FailureCountHelperTest.java b/libraries/collectors-helper/system/test/src/com/android/helpers/tests/FailureCountHelperTest.java
new file mode 100644
index 000000000..8bd97f425
--- /dev/null
+++ b/libraries/collectors-helper/system/test/src/com/android/helpers/tests/FailureCountHelperTest.java
@@ -0,0 +1,92 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.helpers.tests;
+
+import static org.junit.Assert.assertEquals;
+
+import androidx.test.runner.AndroidJUnit4;
+
+import com.android.helpers.FailureCountHelper;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.Description;
+import org.junit.runner.RunWith;
+
+import java.io.IOException;
+import java.util.Map;
+
+/**
+ * Android Unit tests for {@link FailureCountHelper}.
+ *
+ * <p>atest CollectorsHelperTest:com.android.helpers.FailureCountHelperTest
+ */
+@RunWith(AndroidJUnit4.class)
+public class FailureCountHelperTest {
+
+    private static final String TAG = FailureCountHelperTest.class.getSimpleName();
+    private static final double DELTA = 0.00001;
+
+    private FailureCountHelper mHelper;
+
+    @Before
+    public void setUp() throws IOException {
+        mHelper = new FailureCountHelper();
+        mHelper.startCollecting();
+    }
+
+    @After
+    public void tearDown() {
+        // stopCollecting() is currently a no-op but is included here in case it is updated.
+        mHelper.stopCollecting();
+    }
+
+    @Test
+    public void testGetMetricsWithFailure() {
+        Description testDesc1 =
+                Description.createTestDescription(
+                        "android.platform.test.scenario.youtube.PlayVideo$12", "testPlayVideo");
+        Description testDesc2 =
+                Description.createTestDescription(
+                        "android.platform.test.scenario.youtube.PlayVideo$15", "testPlayVideo");
+        Description testDesc3 =
+                Description.createTestDescription(
+                        "android.platform.test.scenario.system.RotateScreen$5", "testRotateScreen");
+        mHelper.recordFailure(testDesc1);
+        mHelper.recordFailure(testDesc2);
+        mHelper.recordFailure(testDesc3);
+        Map<String, Integer> metrics = mHelper.getMetrics();
+        assertEquals(2, metrics.size(), DELTA);
+        assertEquals(2, metrics.get(mHelper.convertTestDescriptionToKey(testDesc1)), DELTA);
+        assertEquals(1, metrics.get(mHelper.convertTestDescriptionToKey(testDesc3)), DELTA);
+    }
+
+    @Test
+    public void testConvertTestDisplayNameToKey() {
+        Description testDesc1 =
+                Description.createTestDescription(
+                        "android.platform.test.scenario.youtube.PlayVideo$12", "testPlayVideo");
+        Description testDesc2 =
+                Description.createTestDescription(
+                        "android.platform.test.scenario.youtube.PlayVideo", "testPlayVideo");
+
+        String expectedKey =
+                "failure_count_android.platform.test.scenario.youtube.PlayVideo.testPlayVideo";
+        assertEquals(expectedKey, mHelper.convertTestDescriptionToKey(testDesc1));
+        assertEquals(expectedKey, mHelper.convertTestDescriptionToKey(testDesc2));
+    }
+}
diff --git a/libraries/compatibility-common-util/src/com/android/compatibility/common/util/DesktopTest.java b/libraries/compatibility-common-util/src/com/android/compatibility/common/util/DesktopTest.java
new file mode 100644
index 000000000..bf2b372f0
--- /dev/null
+++ b/libraries/compatibility-common-util/src/com/android/compatibility/common/util/DesktopTest.java
@@ -0,0 +1,31 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.compatibility.common.util;
+
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+
+/**
+ * Marks the type of test with purpose of asserting Desktop requirements.
+ */
+@Retention(RetentionPolicy.RUNTIME)
+@Target({ElementType.METHOD, ElementType.TYPE})
+public @interface DesktopTest {
+    String[] requirements() default {""};
+}
diff --git a/libraries/compatibility-common-util/src/com/android/compatibility/common/util/ScreenshotsMetadataHandler.java b/libraries/compatibility-common-util/src/com/android/compatibility/common/util/ScreenshotsMetadataHandler.java
index a5b0a4e84..8e9c5912e 100644
--- a/libraries/compatibility-common-util/src/com/android/compatibility/common/util/ScreenshotsMetadataHandler.java
+++ b/libraries/compatibility-common-util/src/com/android/compatibility/common/util/ScreenshotsMetadataHandler.java
@@ -38,6 +38,7 @@ public class ScreenshotsMetadataHandler {
     private static final String CASE_TAG = "TestCase";
     private static final String MODULE_TAG = "Module";
     private static final String NAME_ATTR = "name";
+    private static final String ABI_ATTR = "abi";
     private static final String RESULT_TAG = "Result";
     private static final String TEST_TAG = "Test";
 
@@ -61,6 +62,7 @@ public class ScreenshotsMetadataHandler {
         for (IModuleResult module : result.getModules()) {
             serializer.startTag(NS, MODULE_TAG);
             serializer.attribute(NS, NAME_ATTR, module.getName());
+            serializer.attribute(NS, ABI_ATTR, module.getAbi());
             for (ICaseResult cr : module.getResults()) {
                 serializer.startTag(NS, CASE_TAG);
                 serializer.attribute(NS, NAME_ATTR, cr.getName());
diff --git a/libraries/device-collectors/src/main/java/android/device/collectors/BaseMetricListener.java b/libraries/device-collectors/src/main/java/android/device/collectors/BaseMetricListener.java
index b1bcb13fe..ee1f61ea3 100644
--- a/libraries/device-collectors/src/main/java/android/device/collectors/BaseMetricListener.java
+++ b/libraries/device-collectors/src/main/java/android/device/collectors/BaseMetricListener.java
@@ -36,7 +36,9 @@ import java.io.ByteArrayOutputStream;
 import java.io.File;
 import java.io.IOException;
 import java.io.InputStream;
+import java.io.OutputStream;
 import java.io.PrintStream;
+import java.nio.charset.StandardCharsets;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.HashMap;
@@ -50,8 +52,9 @@ import java.util.Set;
  * test run or test cases. Collectors will have access to {@link DataRecord} objects where they
  * can put results and the base class ensure these results will be send to the instrumentation.
  *
- * Any subclass that calls {@link #createAndEmptyDirectory(String)} needs external storage
- * permission. So to use this class at runtime, your test need to
+ * Unless the shell is used to write files, any subclass that uses the directory created with
+ * {@link #createAndEmptyDirectory(String)} needs external storage permission. So to use this class
+ * at runtime in such subclasses, your test need to
  * <a href="{@docRoot}training/basics/data-storage/files.html#GetWritePermission">have storage
  * permission enabled</a>, and preferably granted at install time (to avoid interrupting the test).
  * For testing at desk, run adb install -r -g testpackage.apk
@@ -348,6 +351,11 @@ public class BaseMetricListener extends InstrumentationRunListener {
         }
     }
 
+    private boolean fileExists(File file) {
+        final byte[] cmdOut = executeCommandBlocking("ls -d " + file.getAbsolutePath());
+        return cmdOut != null && cmdOut.length > 0;
+    }
+
     /**
      * Create a directory inside external storage, and optionally empty it.
      *
@@ -361,7 +369,10 @@ public class BaseMetricListener extends InstrumentationRunListener {
         if (empty) {
             executeCommandBlocking("rm -rf " + destDir.getAbsolutePath());
         }
-        if (!destDir.exists() && !destDir.mkdirs()) {
+        if (!fileExists(destDir)) {
+            executeCommandBlocking("mkdir -p " + destDir.getAbsolutePath());
+        }
+        if (!fileExists(destDir)) {
             Log.e(getTag(), "Unable to create dir: " + destDir.getAbsolutePath());
             return null;
         }
@@ -379,21 +390,40 @@ public class BaseMetricListener extends InstrumentationRunListener {
     }
 
     /**
-     * Delete a directory and all the file inside.
+     * Get an OutputStream to a file using the shell.
      *
-     * @param rootDir the {@link File} directory to delete.
+     * This allows tests to write to files without requiring storage permissions, which is in
+     * particular useful when testing apps that should not have the permission.
+     * @param file The file where the OutputStream should write to. Will be deleted if existing.
+     * @return A stream to write to the file.
+     */
+    public OutputStream getOutputStreamViaShell(File file) throws IOException {
+        if (fileExists(file)) {
+            Log.w(getTag(), String.format("File exists: %s", file.getAbsolutePath()));
+            recursiveDelete(file);
+        }
+
+        final ParcelFileDescriptor[] fds = getInstrumentation().getUiAutomation()
+            .executeShellCommandRw("sh");
+
+        fds[0].close();
+        final ParcelFileDescriptor stdin = fds[1];
+        final OutputStream os = new ParcelFileDescriptor.AutoCloseOutputStream(stdin);
+
+        final String cmd = "cat > " + file.getAbsolutePath() + "\n";
+        os.write(cmd.getBytes(StandardCharsets.UTF_8));
+
+        return os;
+    }
+
+    /**
+     * Delete a directory and all the files inside.
+     *
+     * @param rootDir the {@link File} directory or file to delete.
      */
     public void recursiveDelete(File rootDir) {
         if (rootDir != null) {
-            if (rootDir.isDirectory()) {
-                File[] childFiles = rootDir.listFiles();
-                if (childFiles != null) {
-                    for (File child : childFiles) {
-                        recursiveDelete(child);
-                    }
-                }
-            }
-            rootDir.delete();
+            executeCommandBlocking("rm -r " + rootDir.getAbsolutePath());
         }
     }
 
diff --git a/libraries/device-collectors/src/main/java/android/device/collectors/FailureCountCollector.java b/libraries/device-collectors/src/main/java/android/device/collectors/FailureCountCollector.java
new file mode 100644
index 000000000..eb5a465bc
--- /dev/null
+++ b/libraries/device-collectors/src/main/java/android/device/collectors/FailureCountCollector.java
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.device.collectors;
+
+import android.device.collectors.annotations.OptionClass;
+
+import com.android.helpers.FailureCountHelper;
+
+import org.junit.runner.Description;
+import org.junit.runner.notification.Failure;
+
+/** A {link FailureCountCollector} captures the number of times a test case fails in a test run. */
+@OptionClass(alias = "failure-count-collector")
+public class FailureCountCollector extends BaseCollectionListener<Integer> {
+
+    private FailureCountHelper mHelper;
+
+    public FailureCountCollector() {
+        // We hold on to the FailureCountHelper because this collector has methods that fire on test
+        // failures, but the helper is responsible for computing and returning metrics.
+        mHelper = new FailureCountHelper();
+        createHelperInstance(mHelper);
+    }
+
+    @Override
+    public void onTestFail(DataRecord testData, Description description, Failure failure) {
+        mHelper.recordFailure(description);
+        super.onTestFail(testData, description, failure);
+    }
+}
diff --git a/libraries/device-collectors/src/main/java/android/device/collectors/ScreenshotOnFailureCollector.java b/libraries/device-collectors/src/main/java/android/device/collectors/ScreenshotOnFailureCollector.java
index 0d0039629..2b6c9c9ad 100644
--- a/libraries/device-collectors/src/main/java/android/device/collectors/ScreenshotOnFailureCollector.java
+++ b/libraries/device-collectors/src/main/java/android/device/collectors/ScreenshotOnFailureCollector.java
@@ -25,9 +25,7 @@ import androidx.test.uiautomator.UiDevice;
 import org.junit.runner.Description;
 import org.junit.runner.notification.Failure;
 
-import java.io.BufferedOutputStream;
 import java.io.File;
-import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
 import java.util.Map;
@@ -37,8 +35,9 @@ import java.util.HashMap;
 /**
  * A {@link BaseMetricListener} that captures screenshots when a test fails.
  *
- * <p>This class needs external storage permission. See {@link BaseMetricListener} how to grant
- * external storage permission, especially at install time.
+ * <p>Dumping the UI XML requires external storage permission. See {@link BaseMetricListener} how to
+ * grant external storage permission, especially at install time. Only collecting a screenshot does
+ * not require storage permissions.
  *
  * <p>Options: -e screenshot-quality [0-100]: set screenshot image quality. Default is 75. -e
  * include-ui-xml [true, false]: include the UI XML on failure too, if true.
@@ -138,19 +137,13 @@ public class ScreenshotOnFailureCollector extends BaseMetricListener {
     @VisibleForTesting
     public File takeScreenshot(String fileName) {
         File img = new File(mDestDir, fileName);
-        if (img.exists()) {
-            Log.w(getTag(), String.format("File exists: %s", img.getAbsolutePath()));
-            img.delete();
-        }
-        try (
-                OutputStream out = new BufferedOutputStream(new FileOutputStream(img))
-        ){
+        try (OutputStream out = getOutputStreamViaShell(img)) {
             screenshotToStream(out);
             out.flush();
             return img;
         } catch (Exception e) {
             Log.e(getTag(), "Unable to save screenshot", e);
-            img.delete();
+            recursiveDelete(img);
             return null;
         }
     }
diff --git a/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/README.md b/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/README.md
index adc5f6e59..d4a6b2b3a 100644
--- a/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/README.md
+++ b/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/README.md
@@ -1,3 +1,4 @@
 # Latency information for sandbox APIs
 
-Event metric for latency for the APIs called from app to the sandbox
\ No newline at end of file
+Event metric for latency for the APIs called from app to the sandbox and APIs
+related to sandbox activities.
diff --git a/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/sandbox-latency-metrics.pb b/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/sandbox-latency-metrics.pb
index e4459073a..1baa1044d 100644
Binary files a/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/sandbox-latency-metrics.pb and b/libraries/device-collectors/src/main/platform-collectors/res/statsd-configs/sandbox-latency-metrics/sandbox-latency-metrics.pb differ
diff --git a/libraries/device-collectors/src/test/java/android/device/collectors/GcaEventLogCollectorTest.java b/libraries/device-collectors/src/test/java/android/device/collectors/GcaEventLogCollectorTest.java
index b06f6869c..e42c5b9a0 100644
--- a/libraries/device-collectors/src/test/java/android/device/collectors/GcaEventLogCollectorTest.java
+++ b/libraries/device-collectors/src/test/java/android/device/collectors/GcaEventLogCollectorTest.java
@@ -26,7 +26,6 @@ import android.os.Bundle;
 
 import androidx.test.ext.junit.runners.AndroidJUnit4;
 
-import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.junit.runner.Description;
@@ -51,28 +50,19 @@ public class GcaEventLogCollectorTest {
     private static final Description TEST_FAILURE_DESCRIPTION =
             Description.createTestDescription("TestClass", "testCaseFailed");
     @Mock private Instrumentation mMockInstrumentation;
-    private File mEventLogDir;
-    private File mDestDir;
     private GcaEventLogCollector mCollector;
 
     @Before
     public void setUp() throws Exception {
         MockitoAnnotations.initMocks(this);
-        mEventLogDir = new File("/sdcard", "camera_events");
-        mDestDir = new File("/sdcard", "camera_events_dest");
-    }
-
-    @After
-    public void tearDown() {
-        mCollector.recursiveDelete(mEventLogDir);
-        mCollector.recursiveDelete(mDestDir);
     }
 
     private GcaEventLogCollector initListener(Bundle bundle) {
         mCollector = new GcaEventLogCollector(bundle);
         GcaEventLogCollector listener = Mockito.spy(mCollector);
         listener.setInstrumentation(mMockInstrumentation);
-        Mockito.doReturn(mDestDir).when(listener).createAndEmptyDirectory(Mockito.anyString());
+        Mockito.doReturn(new File("/sdcard", "camera_events_dest"))
+                .when(listener).createAndEmptyDirectory(Mockito.anyString());
         Mockito.doReturn(new byte[10]).when(listener).executeCommandBlocking(Mockito.anyString());
         Mockito.doNothing().when(listener).copyEventLogToSharedStorage(Mockito.anyString());
         return listener;
diff --git a/libraries/device-collectors/src/test/java/android/device/collectors/IncidentReportListenerTest.java b/libraries/device-collectors/src/test/java/android/device/collectors/IncidentReportListenerTest.java
index e64acc154..acd3dbbf7 100644
--- a/libraries/device-collectors/src/test/java/android/device/collectors/IncidentReportListenerTest.java
+++ b/libraries/device-collectors/src/test/java/android/device/collectors/IncidentReportListenerTest.java
@@ -27,6 +27,8 @@ import static org.mockito.Mockito.spy;
 
 import android.app.Instrumentation;
 import android.os.Bundle;
+
+import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
@@ -69,6 +71,8 @@ public class IncidentReportListenerTest {
         MockitoAnnotations.initMocks(this);
         mListener = spy(new IncidentReportListener());
         mListener.setInstrumentation(mInstrumentation);
+        doReturn(InstrumentationRegistry.getInstrumentation().getUiAutomation())
+                .when(mInstrumentation).getUiAutomation();
     }
 
     @After
diff --git a/libraries/device-collectors/src/test/java/android/device/collectors/LogcatCollectorTest.java b/libraries/device-collectors/src/test/java/android/device/collectors/LogcatCollectorTest.java
index 7beeec323..93d2e633c 100644
--- a/libraries/device-collectors/src/test/java/android/device/collectors/LogcatCollectorTest.java
+++ b/libraries/device-collectors/src/test/java/android/device/collectors/LogcatCollectorTest.java
@@ -22,6 +22,7 @@ import android.os.Environment;
 import android.os.SystemClock;
 import android.util.Log;
 
+import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
@@ -85,6 +86,7 @@ public final class LogcatCollectorTest {
 
     @After
     public void tearDown() {
+        mCollector.setInstrumentation(InstrumentationRegistry.getInstrumentation());
         mCollector.recursiveDelete(mLogDir);
     }
 
diff --git a/libraries/flag-helpers/junit/Android.bp b/libraries/flag-helpers/junit/Android.bp
index ede3524e7..a5c837cdd 100644
--- a/libraries/flag-helpers/junit/Android.bp
+++ b/libraries/flag-helpers/junit/Android.bp
@@ -50,7 +50,7 @@ java_library {
         "flag-junit-base",
     ],
     libs: [
-        "framework-configinfrastructure",
+        "framework-configinfrastructure.stubs.module_lib",
     ],
     sdk_version: "module_current",
 }
diff --git a/libraries/flag-helpers/libflagtest/Android.bp b/libraries/flag-helpers/libflagtest/Android.bp
index 722da2f78..93de91cf6 100644
--- a/libraries/flag-helpers/libflagtest/Android.bp
+++ b/libraries/flag-helpers/libflagtest/Android.bp
@@ -91,6 +91,7 @@ cc_test {
     ],
     shared_libs: [
         "libbase",
+        "liblog",
         "server_configurable_flags",
         "libaconfig_storage_read_api_cc",
     ],
diff --git a/libraries/flicker/appHelpers/src/android/tools/device/apphelpers/StandardAppHelper.kt b/libraries/flicker/appHelpers/src/android/tools/device/apphelpers/StandardAppHelper.kt
index 2ea4e1ceb..84785bb01 100644
--- a/libraries/flicker/appHelpers/src/android/tools/device/apphelpers/StandardAppHelper.kt
+++ b/libraries/flicker/appHelpers/src/android/tools/device/apphelpers/StandardAppHelper.kt
@@ -176,11 +176,32 @@ open class StandardAppHelper(
     ) {
         withTracing("${this::class.simpleName}#doWaitShown") {
             val expectedWindow = launchedAppComponentMatcherOverride ?: componentMatcher
-            val builder = waitConditionsBuilder.withWindowSurfaceAppeared(expectedWindow)
-            builder.waitForAndVerify()
+            doWaitShownLight(expectedWindow)
+            doWaitShownHeavy(expectedWindow, waitConditionsBuilder)
         }
     }
 
+    private fun doWaitShownLight(expectedWindow: IComponentMatcher) {
+        try {
+            val expectedPackageName =
+                ComponentNameMatcher.unflattenFromString(expectedWindow.toWindowIdentifier())
+                    .packageName
+            val appSelector = getAppSelector(expectedPackageName)
+            uiDevice.wait(Until.hasObject(appSelector), APP_LAUNCH_WAIT_TIME_MS)
+        } catch (e: Exception) {
+            // IComponentMatcher#toWindowIdentifier() might not be implemented.
+            // Let's just skip the light-weight busy waiting.
+        }
+    }
+
+    private fun doWaitShownHeavy(
+        expectedWindow: IComponentMatcher,
+        waitConditionsBuilder: WindowManagerStateHelper.StateSyncBuilder
+    ) {
+        val builder = waitConditionsBuilder.withWindowSurfaceAppeared(expectedWindow)
+        builder.waitForAndVerify()
+    }
+
     override fun isAvailable(): Boolean {
         return try {
             pkgManager.getPackageInfo(packageName, PackageManager.PackageInfoFlags.of(0))
diff --git a/libraries/flicker/src/android/tools/flicker/ScenarioInstanceImpl.kt b/libraries/flicker/src/android/tools/flicker/ScenarioInstanceImpl.kt
index 215aa55c5..ff828c60b 100644
--- a/libraries/flicker/src/android/tools/flicker/ScenarioInstanceImpl.kt
+++ b/libraries/flicker/src/android/tools/flicker/ScenarioInstanceImpl.kt
@@ -24,7 +24,7 @@ import android.tools.flicker.config.FlickerConfigEntry
 import android.tools.flicker.extractors.TraceSlice
 import android.tools.flicker.extractors.Utils
 import android.tools.io.Reader
-import android.tools.traces.events.CujType
+import android.tools.traces.events.ICujType
 import android.tools.traces.wm.Transition
 import android.tools.withTracing
 
@@ -35,7 +35,7 @@ data class ScenarioInstanceImpl(
     val startTimestamp: Timestamp,
     val endTimestamp: Timestamp,
     override val reader: Reader,
-    val associatedCuj: CujType? = null,
+    val associatedCuj: ICujType? = null,
     override val associatedTransition: Transition? = null,
 ) : ScenarioInstance {
     // b/227752705
diff --git a/libraries/flicker/src/android/tools/flicker/Utils.kt b/libraries/flicker/src/android/tools/flicker/Utils.kt
index 28e24240b..71bd1c5c3 100644
--- a/libraries/flicker/src/android/tools/flicker/Utils.kt
+++ b/libraries/flicker/src/android/tools/flicker/Utils.kt
@@ -40,9 +40,8 @@ object Utils {
     // Order matters since this is used to start traces in the order the monitors are defined here
     // and stop them in reverse order.
     val ALL_MONITORS: List<TraceMonitor> =
-        mutableListOf(
+        mutableListOf<TraceMonitor>(
                 ScreenRecorder(InstrumentationRegistry.getInstrumentation().targetContext),
-                WindowManagerTraceMonitor(),
             )
             .apply {
                 val perfettoMonitorBuilder = PerfettoTraceMonitor.newBuilder()
@@ -61,6 +60,12 @@ object Utils {
                     this.add(LegacyShellTransitionTraceMonitor())
                 }
 
+                if (android.tracing.Flags.perfettoWmTracing()) {
+                    perfettoMonitorBuilder.enableWindowManagerTrace()
+                } else {
+                    this.add(WindowManagerTraceMonitor())
+                }
+
                 if (android.tracing.Flags.perfettoProtologTracing()) {
                     perfettoMonitorBuilder.enableProtoLog()
                 }
diff --git a/libraries/flicker/src/android/tools/flicker/assertions/ScenarioAssertionImpl.kt b/libraries/flicker/src/android/tools/flicker/assertions/ScenarioAssertionImpl.kt
index b1c2a5779..91848ed4f 100644
--- a/libraries/flicker/src/android/tools/flicker/assertions/ScenarioAssertionImpl.kt
+++ b/libraries/flicker/src/android/tools/flicker/assertions/ScenarioAssertionImpl.kt
@@ -41,13 +41,19 @@ data class ScenarioAssertionImpl(
         withTracing("executeAssertion") {
             val assertionExceptions = assertionData.map { assertionRunner.runAssertion(it) }
 
-            require(
-                assertionExceptions.all {
-                    it == null || it is FlickerAssertionError || it is AssumptionViolatedException
+            val unexpectedExceptions =
+                assertionExceptions.filterNot {
+                    it == null ||
+                        it is FlickerAssertionError ||
+                        it is AssumptionViolatedException ||
+                        it is IllegalArgumentException
                 }
-            ) {
-                "Expected all assertion exceptions to be " +
-                    "FlickerAssertionErrors or AssumptionViolatedExceptions"
+            if (unexpectedExceptions.isNotEmpty()) {
+                throw IllegalArgumentException(
+                    "Expected all assertion exceptions to be " +
+                        "FlickerAssertionErrors or AssumptionViolatedExceptions",
+                    unexpectedExceptions.first()
+                )
             }
 
             val assertionErrors = assertionExceptions.filterIsInstance<FlickerAssertionError>()
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerIncreasesInSize.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerIncreasesInSize.kt
new file mode 100644
index 000000000..802619958
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerIncreasesInSize.kt
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+
+/** Checks that the visible region of [component] always increases during the animation */
+class AppLayerIncreasesInSize(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        val layerMatcher = component.build(scenarioInstance)
+        flicker.assertLayers {
+            val layerList = layers { layerMatcher.layerMatchesAnyOf(it) && it.isVisible }
+            layerList.zipWithNext { previous, current ->
+                current.visibleRegion.coversAtLeast(previous.visibleRegion.region)
+            }
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReduces.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReducesInSize.kt
similarity index 95%
rename from libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReduces.kt
rename to libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReducesInSize.kt
index a6d037f96..97440edfc 100644
--- a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReduces.kt
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppLayerReducesInSize.kt
@@ -21,7 +21,7 @@ import android.tools.flicker.assertions.FlickerTest
 import android.tools.flicker.assertors.ComponentTemplate
 
 /** Checks that the visible region of [component] always reduces during the animation */
-class AppLayerReduces(private val component: ComponentTemplate) :
+class AppLayerReducesInSize(private val component: ComponentTemplate) :
     AssertionTemplateWithComponent(component) {
     /** {@inheritDoc} */
     override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowAlignsWithOnlyOneDisplayCornerAtEnd.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowAlignsWithOnlyOneDisplayCornerAtEnd.kt
new file mode 100644
index 000000000..66d651931
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowAlignsWithOnlyOneDisplayCornerAtEnd.kt
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
+
+/** Checks that [component] window aligns with only one of the display app corners at the end. */
+class AppWindowAlignsWithOnlyOneDisplayCornerAtEnd(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            val displayAppBounds = WindowUtils.getInsetDisplayBounds()
+            val windowBounds = visibleRegion(component.build(scenarioInstance)).region.bounds
+
+            val onRightSide = windowBounds.right == displayAppBounds.right
+            val onLeftSide = windowBounds.left == displayAppBounds.left
+            val onTopSide = windowBounds.top == displayAppBounds.top
+            val onBottomSide = windowBounds.bottom == displayAppBounds.bottom
+            val alignedOnCorners = onRightSide.xor(onLeftSide) and onTopSide.xor(onBottomSide)
+
+            check { "window corner must meet display corner" }.that(alignedOnCorners).isEqual(true)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversLeftHalfScreenAtEnd.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversLeftHalfScreenAtEnd.kt
new file mode 100644
index 000000000..9530032bf
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversLeftHalfScreenAtEnd.kt
@@ -0,0 +1,34 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
+
+class AppWindowCoversLeftHalfScreenAtEnd(
+    private val component: ComponentTemplate,
+) : AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            val expectedBounds = WindowUtils.getInsetDisplayBounds().apply { right = centerX() }
+            visibleRegion(component.build(scenarioInstance)).coversExactly(expectedBounds)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversRightHalfScreenAtEnd.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversRightHalfScreenAtEnd.kt
new file mode 100644
index 000000000..a694a6616
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowCoversRightHalfScreenAtEnd.kt
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2023 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
+
+class AppWindowCoversRightHalfScreenAtEnd(
+    private val component: ComponentTemplate,
+) : AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            // Build expected bounds of half the display
+            val expectedBounds = WindowUtils.getInsetDisplayBounds().apply { left = centerX() }
+            visibleRegion(component.build(scenarioInstance)).coversExactly(expectedBounds)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasDesktopModeInitialBoundsAtTheEnd.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasDesktopModeInitialBoundsAtTheEnd.kt
index 877895234..1df08d52a 100644
--- a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasDesktopModeInitialBoundsAtTheEnd.kt
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasDesktopModeInitialBoundsAtTheEnd.kt
@@ -18,30 +18,36 @@ package android.tools.flicker.assertors.assertions
 
 import android.graphics.Rect
 import android.os.SystemProperties
+import android.tools.PlatformConsts.DESKTOP_MODE_INITIAL_WINDOW_HEIGHT_PROPORTION
 import android.tools.flicker.ScenarioInstance
 import android.tools.flicker.assertions.FlickerTest
 import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
 
 class AppWindowHasDesktopModeInitialBoundsAtTheEnd(private val component: ComponentTemplate) :
     AssertionTemplateWithComponent(component) {
+
     /** {@inheritDoc} */
     override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
         flicker.assertLayersEnd {
             val displayBounds =
                 entry.physicalDisplayBounds ?: error("Missing physical display bounds")
-            val scale =
+            val stableBounds = WindowUtils.getInsetDisplayBounds()
+            val desktopModeInitialBoundsScale =
                 SystemProperties.getInt("persist.wm.debug.desktop_mode_initial_bounds_scale", 75) /
                     100f
 
-            val desiredWidth = displayBounds.width().times(scale).toInt()
-            val desiredHeight = displayBounds.height().times(scale).toInt()
+            val desiredWidth = displayBounds.width().times(desktopModeInitialBoundsScale)
+            val desiredHeight = displayBounds.height().times(desktopModeInitialBoundsScale)
 
-            val outBounds = Rect(0, 0, desiredWidth, desiredHeight)
-            // Center the task in screen bounds
-            outBounds.offset(
-                displayBounds.centerX() - outBounds.centerX(),
-                displayBounds.centerY() - outBounds.centerY()
-            )
+            val outBounds = Rect(0, 0, desiredWidth.toInt(), desiredHeight.toInt())
+            val xOffset = ((stableBounds.width() - desiredWidth) / 2).toInt()
+            val yOffset =
+                ((stableBounds.height() - desiredHeight) *
+                        DESKTOP_MODE_INITIAL_WINDOW_HEIGHT_PROPORTION + stableBounds.top)
+                    .toInt()
+            // Position the task in screen bounds
+            outBounds.offset(xOffset, yOffset)
 
             visibleRegion(component.build(scenarioInstance)).coversExactly(outBounds)
         }
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxBoundsInOnlyOneDimension.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxBoundsInOnlyOneDimension.kt
new file mode 100644
index 000000000..5ffeb71c4
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxBoundsInOnlyOneDimension.kt
@@ -0,0 +1,41 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
+
+class AppWindowHasMaxBoundsInOnlyOneDimension(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            val maxDisplayBounds = WindowUtils.getInsetDisplayBounds()
+            val windowBounds = visibleRegion(component.build(scenarioInstance)).region.bounds
+
+            val hasMaxHeight = windowBounds.top == maxDisplayBounds.top
+                    && windowBounds.bottom == maxDisplayBounds.bottom
+            val hasMaxWidth = windowBounds.left == maxDisplayBounds.left
+                    && windowBounds.right == maxDisplayBounds.right
+            val isMaxInOneDimension = hasMaxHeight.xor(hasMaxWidth)
+
+            check { "only one max bounds" }.that(isMaxInOneDimension).isEqual(true)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayHeight.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayHeight.kt
new file mode 100644
index 000000000..29f1ce224
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayHeight.kt
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import android.tools.helpers.WindowUtils
+
+class AppWindowHasMaxDisplayHeight(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            val expectedBounds = WindowUtils.getInsetDisplayBounds()
+            visibleRegion(component.build(scenarioInstance))
+                .hasSameTopPosition(expectedBounds)
+                .hasSameBottomPosition(expectedBounds)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayWidth.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayWidth.kt
new file mode 100644
index 000000000..be3106e90
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasMaxDisplayWidth.kt
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+
+class AppWindowHasMaxDisplayWidth(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertLayersEnd {
+            val displayBounds =
+                entry.physicalDisplayBounds ?: error("Missing physical display bounds")
+
+            visibleRegion(component.build(scenarioInstance))
+                .hasSameLeftPosition(displayBounds)
+                .hasSameRightPosition(displayBounds)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasSizeOfAtLeast.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasSizeOfAtLeast.kt
new file mode 100644
index 000000000..7d38478ce
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowHasSizeOfAtLeast.kt
@@ -0,0 +1,37 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.graphics.Region
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+
+class AppWindowHasSizeOfAtLeast(
+    private val component: ComponentTemplate,
+    private val minimumWidth: Int,
+    private val minimumHeight: Int
+) : AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertLayersEnd {
+            val minimumSize = Region(0, 0, minimumWidth, minimumHeight)
+
+            visibleRegion(component.build(scenarioInstance)).notSmallerThan(minimumSize)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowInsideDisplayBoundsAtEnd.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowInsideDisplayBoundsAtEnd.kt
new file mode 100644
index 000000000..fc0f1439d
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowInsideDisplayBoundsAtEnd.kt
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+
+/** Checks that [component] window is inside the display bounds at the end of the animation. */
+class AppWindowInsideDisplayBoundsAtEnd(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    /** {@inheritDoc} */
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertWmEnd {
+            val display = wmState.getDefaultDisplay()!!
+            visibleRegion(component.build(scenarioInstance)).coversAtMost(display.displayRect)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowMaintainsAspectRatioAlways.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowMaintainsAspectRatioAlways.kt
new file mode 100644
index 000000000..cabec060f
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowMaintainsAspectRatioAlways.kt
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+
+class AppWindowMaintainsAspectRatioAlways(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertLayers {
+            val desktopWindowLayerList = layers {
+                component.build(scenarioInstance).layerMatchesAnyOf(it) && it.isVisible
+            }
+            desktopWindowLayerList.zipWithNext { previous, current ->
+                current.visibleRegion.isSameAspectRatio(previous.visibleRegion)
+            }
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowRemainInsideDisplayBounds.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowRemainInsideDisplayBounds.kt
index 3b100cb87..be4191683 100644
--- a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowRemainInsideDisplayBounds.kt
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowRemainInsideDisplayBounds.kt
@@ -29,7 +29,7 @@ class AppWindowRemainInsideDisplayBounds(private val component: ComponentTemplat
     override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
         flicker.assertWm {
             containsAtLeastOneDisplay().invoke("appWindowRemainInsideDisplayBounds") { entry ->
-                val display = entry.wmState.displays.minByOrNull { it.id }!!
+                val display = entry.wmState.getDefaultDisplay()!!
                 entry
                     .visibleRegion(component.build(scenarioInstance))
                     .coversAtMost(display.displayRect)
diff --git a/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowReturnsToStartBoundsAndPosition.kt b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowReturnsToStartBoundsAndPosition.kt
new file mode 100644
index 000000000..24fb29095
--- /dev/null
+++ b/libraries/flicker/src/android/tools/flicker/assertors/assertions/AppWindowReturnsToStartBoundsAndPosition.kt
@@ -0,0 +1,40 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.flicker.assertors.assertions
+
+import android.tools.flicker.ScenarioInstance
+import android.tools.flicker.assertions.FlickerTest
+import android.tools.flicker.assertors.ComponentTemplate
+import kotlin.math.abs
+
+class AppWindowReturnsToStartBoundsAndPosition(private val component: ComponentTemplate) :
+    AssertionTemplateWithComponent(component) {
+    override fun doEvaluate(scenarioInstance: ScenarioInstance, flicker: FlickerTest) {
+        flicker.assertLayers {
+            val startRegion = first().visibleRegion(component.build(scenarioInstance))
+            val endRegion = last().visibleRegion(component.build(scenarioInstance))
+
+            val heightDiff = startRegion.region.bounds.height() - endRegion.region.bounds.height()
+            val widthDiff = startRegion.region.bounds.width() - endRegion.region.bounds.width()
+            val xDiff = startRegion.region.bounds.centerX() - endRegion.region.bounds.centerX()
+
+            check { "height" }.that(abs(heightDiff)).isLowerOrEqual(1)
+            check { "width" }.that(abs(widthDiff)).isLowerOrEqual(1)
+            check { "horizontal position" }.that(abs(xDiff)).isGreaterOrEqual(2)
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/config/AssertionTemplates.kt b/libraries/flicker/src/android/tools/flicker/config/AssertionTemplates.kt
index 68fe74f0a..450d69776 100644
--- a/libraries/flicker/src/android/tools/flicker/config/AssertionTemplates.kt
+++ b/libraries/flicker/src/android/tools/flicker/config/AssertionTemplates.kt
@@ -17,6 +17,7 @@
 package android.tools.flicker.config
 
 import android.tools.flicker.AssertionInvocationGroup
+import android.tools.flicker.assertors.AssertionTemplate
 import android.tools.flicker.assertors.assertions.AppLayerBecomesInvisible
 import android.tools.flicker.assertors.assertions.AppLayerBecomesVisible
 import android.tools.flicker.assertors.assertions.AppLayerCoversFullScreenAtEnd
@@ -37,6 +38,7 @@ import android.tools.flicker.assertors.assertions.AppWindowIsVisibleAtEnd
 import android.tools.flicker.assertors.assertions.AppWindowIsVisibleAtStart
 import android.tools.flicker.assertors.assertions.AppWindowOnTopAtEnd
 import android.tools.flicker.assertors.assertions.AppWindowOnTopAtStart
+import android.tools.flicker.assertors.assertions.AppWindowRemainInsideDisplayBounds
 import android.tools.flicker.assertors.assertions.EntireScreenCoveredAlways
 import android.tools.flicker.assertors.assertions.FocusChanges
 import android.tools.flicker.assertors.assertions.HasAtMostOneWindowMatching
@@ -52,6 +54,7 @@ import android.tools.flicker.assertors.assertions.WindowRemainInsideVisibleBound
 import android.tools.flicker.config.appclose.Components.CLOSING_APPS
 import android.tools.flicker.config.applaunch.Components.OPENING_APPS
 import android.tools.flicker.config.common.Components.LAUNCHER
+import android.tools.flicker.config.desktopmode.Components.DESKTOP_MODE_APP
 import android.tools.flicker.config.pip.Components.PIP_APP
 import android.tools.flicker.config.pip.Components.PIP_DISMISS_OVERLAY
 import android.tools.flicker.config.splitscreen.Components.SPLIT_SCREEN_DIVIDER
@@ -208,4 +211,12 @@ object AssertionTemplates {
                     AppWindowIsVisibleAlways(SPLIT_SCREEN_SECONDARY_APP),
                 )
                 .associateBy({ it }, { AssertionInvocationGroup.BLOCKING })
+
+    val DESKTOP_MODE_APP_VISIBILITY_ASSERTIONS: Map<AssertionTemplate, AssertionInvocationGroup> =
+        listOf(
+                AppWindowIsVisibleAlways(DESKTOP_MODE_APP),
+                AppWindowOnTopAtEnd(DESKTOP_MODE_APP),
+                AppWindowRemainInsideDisplayBounds(DESKTOP_MODE_APP),
+            )
+            .associateBy({ it }, { AssertionInvocationGroup.BLOCKING })
 }
diff --git a/libraries/flicker/src/android/tools/flicker/config/desktopmode/Components.kt b/libraries/flicker/src/android/tools/flicker/config/desktopmode/Components.kt
index 919dedd57..eba258ea5 100644
--- a/libraries/flicker/src/android/tools/flicker/config/desktopmode/Components.kt
+++ b/libraries/flicker/src/android/tools/flicker/config/desktopmode/Components.kt
@@ -22,6 +22,9 @@ import android.tools.flicker.config.ScenarioId
 import android.tools.helpers.SYSTEMUI_PACKAGE
 import android.tools.traces.component.ComponentNameMatcher
 import android.tools.traces.component.FullComponentIdMatcher
+import android.tools.traces.component.IComponentMatcher
+import android.tools.traces.wm.Transition
+import android.tools.traces.wm.TransitionType
 
 object Components {
     val DESKTOP_MODE_CAPTION =
@@ -33,21 +36,60 @@ object Components {
                 scenarioInstance.associatedTransition
                     ?: error("Can only extract DESKTOP_MODE_APP from scenario with transition")
 
-            if (isSupported(scenarioInstance.type)) {
-                val change = associatedTransition.changes.last()
-                FullComponentIdMatcher(change.windowId, change.layerId)
-            } else {
-                error("Unsupported transition type")
-            }
+            getDesktopAppForScenario(scenarioInstance.type, associatedTransition)
+        }
+
+    val NON_RESIZABLE_APP =
+        ComponentTemplate("NON_RESIZABLE_APP") {
+            ComponentNameMatcher(
+                "com.android.server.wm.flicker.testapp",
+                "com.android.server.wm.flicker.testapp.NonResizeableActivity"
+            )
         }
 
-    private fun isSupported(type: ScenarioId): Boolean {
+    val DESKTOP_WALLPAPER =
+        ComponentTemplate("DesktopWallpaper") {
+            ComponentNameMatcher(
+                SYSTEMUI_PACKAGE,
+                "com.android.wm.shell.desktopmode.DesktopWallpaperActivity"
+            )
+        }
+
+    private fun getDesktopAppForScenario(
+        type: ScenarioId,
+        associatedTransition: Transition
+    ): IComponentMatcher {
         return when (type) {
-            ScenarioId("END_DRAG_TO_DESKTOP") -> true
-            ScenarioId("CLOSE_APP") -> true
-            ScenarioId("CLOSE_LAST_APP") -> true
-            ScenarioId("CORNER_RESIZE") -> true
-            else -> false
+            ScenarioId("END_DRAG_TO_DESKTOP") -> {
+                val change =
+                    associatedTransition.changes.first { it.transitMode == TransitionType.CHANGE }
+                FullComponentIdMatcher(change.windowId, change.layerId)
+            }
+            ScenarioId("CLOSE_APP"),
+            ScenarioId("CLOSE_LAST_APP") -> {
+                val change =
+                    associatedTransition.changes.first { it.transitMode == TransitionType.CLOSE }
+                FullComponentIdMatcher(change.windowId, change.layerId)
+            }
+            ScenarioId("CASCADE_APP") -> {
+                val change =
+                    associatedTransition.changes.first { it.transitMode == TransitionType.OPEN }
+                FullComponentIdMatcher(change.windowId, change.layerId)
+            }
+            ScenarioId("CORNER_RESIZE"),
+            ScenarioId("CORNER_RESIZE_TO_MINIMUM_SIZE"),
+            ScenarioId("CORNER_RESIZE_TO_MAXIMUM_SIZE"),
+            ScenarioId("EDGE_RESIZE"),
+            ScenarioId("SNAP_RESIZE_LEFT_WITH_DRAG"),
+            ScenarioId("SNAP_RESIZE_RIGHT_WITH_DRAG"),
+            ScenarioId("SNAP_RESIZE_LEFT_WITH_BUTTON"),
+            ScenarioId("SNAP_RESIZE_RIGHT_WITH_BUTTON"),
+            ScenarioId("MAXIMIZE_APP"),
+            ScenarioId("MAXIMIZE_APP_NON_RESIZABLE") -> {
+                val change = associatedTransition.changes.first()
+                FullComponentIdMatcher(change.windowId, change.layerId)
+            }
+            else -> error("Unsupported transition type")
         }
     }
 }
diff --git a/libraries/flicker/src/android/tools/flicker/extractors/TaggedScenarioExtractor.kt b/libraries/flicker/src/android/tools/flicker/extractors/TaggedScenarioExtractor.kt
index b12de7d9c..a616cd2a4 100644
--- a/libraries/flicker/src/android/tools/flicker/extractors/TaggedScenarioExtractor.kt
+++ b/libraries/flicker/src/android/tools/flicker/extractors/TaggedScenarioExtractor.kt
@@ -126,7 +126,11 @@ class TaggedScenarioExtractor(
     ): Timestamp {
         val interpolatedEndTimestamp =
             if (associatedTransition != null) {
-                Utils.interpolateFinishTimestampFromTransition(associatedTransition, reader)
+                Utils.interpolateFinishTimestampFromTransition(
+                    associatedTransition,
+                    reader,
+                    cujEntry.toString()
+                )
             } else {
                 val layersTrace = reader.readLayersTrace() ?: error("Missing layers trace")
                 val nextSfEntry = layersTrace.getFirstEntryWithOnDisplayAfter(cujEntry.endTimestamp)
diff --git a/libraries/flicker/src/android/tools/flicker/extractors/TraceSlice.kt b/libraries/flicker/src/android/tools/flicker/extractors/TraceSlice.kt
index d7fb08577..63e91531f 100644
--- a/libraries/flicker/src/android/tools/flicker/extractors/TraceSlice.kt
+++ b/libraries/flicker/src/android/tools/flicker/extractors/TraceSlice.kt
@@ -17,12 +17,21 @@
 package android.tools.flicker.extractors
 
 import android.tools.Timestamp
-import android.tools.traces.events.CujType
+import android.tools.traces.events.ICujType
 import android.tools.traces.wm.Transition
 
 data class TraceSlice(
     val startTimestamp: Timestamp,
     val endTimestamp: Timestamp,
     val associatedTransition: Transition? = null,
-    val associatedCuj: CujType? = null
-)
+    val associatedCuj: ICujType? = null
+) {
+    init {
+        require(startTimestamp.hasAllTimestamps) {
+            "startTimestamp ($startTimestamp) has missing timestamps"
+        }
+        require(endTimestamp.hasAllTimestamps) {
+            "endTimestamp ($endTimestamp) has missing timestamps"
+        }
+    }
+}
diff --git a/libraries/flicker/src/android/tools/flicker/extractors/Utils.kt b/libraries/flicker/src/android/tools/flicker/extractors/Utils.kt
index 0ae410660..91512313a 100644
--- a/libraries/flicker/src/android/tools/flicker/extractors/Utils.kt
+++ b/libraries/flicker/src/android/tools/flicker/extractors/Utils.kt
@@ -53,7 +53,8 @@ object Utils {
 
     fun interpolateFinishTimestampFromTransition(
         transition: Transition,
-        reader: Reader
+        reader: Reader,
+        debugString: String? = null,
     ): Timestamp {
         val layersTrace = reader.readLayersTrace() ?: error("Missing layers trace")
         val wmTrace = reader.readWmTrace() ?: error("Missing WM trace")
@@ -93,8 +94,7 @@ object Utils {
                     val closestWmEntry =
                         wmTrace.entries.minByOrNull {
                             abs(it.timestamp.elapsedNanos - transition.finishTime.elapsedNanos)
-                        }
-                            ?: error("WM entry was unexpectedly empty!")
+                        } ?: error("WM entry was unexpectedly empty!")
                     val offset =
                         closestWmEntry.timestamp.unixNanos - closestWmEntry.timestamp.elapsedNanos
                     transition.finishTime.elapsedNanos + offset
@@ -107,10 +107,7 @@ object Utils {
         } else {
             elapsedNanos =
                 (wmTrace.entries.firstOrNull { it.timestamp >= finishTransactionAppliedTimestamp }
-                        ?: error(
-                            "No WM trace entry with timestamp greater than or equal to the " +
-                                "layers trace the finish transaction was applied in"
-                        ))
+                        ?: wmTrace.entries.last())
                     .timestamp
                     .elapsedNanos
             systemUptimeNanos =
diff --git a/libraries/flicker/src/android/tools/flicker/legacy/FlickerBuilder.kt b/libraries/flicker/src/android/tools/flicker/legacy/FlickerBuilder.kt
index 402d336e8..96e032bff 100644
--- a/libraries/flicker/src/android/tools/flicker/legacy/FlickerBuilder.kt
+++ b/libraries/flicker/src/android/tools/flicker/legacy/FlickerBuilder.kt
@@ -25,6 +25,7 @@ import android.tools.traces.monitors.NoTraceMonitor
 import android.tools.traces.monitors.ScreenRecorder
 import android.tools.traces.parsers.WindowManagerStateHelper
 import androidx.test.uiautomator.UiDevice
+import org.junit.rules.TestRule
 import java.io.File
 
 /** Build Flicker tests using Flicker DSL */
@@ -38,6 +39,7 @@ class FlickerBuilder(
     private val transitionCommands: MutableList<FlickerTestData.() -> Any> = mutableListOf(),
     private val teardownCommands: MutableList<FlickerTestData.() -> Any> = mutableListOf(),
     val device: UiDevice = UiDevice.getInstance(instrumentation),
+    private val rules: MutableList<TestRule> = mutableListOf(),
     private val traceMonitors: MutableList<ITransitionMonitor> = ALL_MONITORS.toMutableList()
 ) {
     private var usingExistingTraces = false
@@ -74,6 +76,11 @@ class FlickerBuilder(
         transitionCommands.add(command)
     }
 
+    /** Adds JUnit rules to be executed with the provided transitions.*/
+    fun withRules(vararg rules: TestRule) {
+        this.rules.addAll(rules)
+    }
+
     data class TraceFiles(
         val wmTrace: File,
         val perfetto: File,
@@ -117,6 +124,7 @@ class FlickerBuilder(
             setupCommands,
             transitionCommands,
             teardownCommands,
+            rules,
             wmHelper
         )
     }
@@ -124,15 +132,16 @@ class FlickerBuilder(
     /** Returns a copy of the current builder with the changes of [block] applied */
     fun copy(block: FlickerBuilder.() -> Unit) =
         FlickerBuilder(
-                instrumentation,
-                outputDir.absoluteFile,
-                wmHelper,
-                setupCommands.toMutableList(),
-                transitionCommands.toMutableList(),
-                teardownCommands.toMutableList(),
-                device,
-                traceMonitors.toMutableList(),
-            )
+            instrumentation,
+            outputDir.absoluteFile,
+            wmHelper,
+            setupCommands.toMutableList(),
+            transitionCommands.toMutableList(),
+            teardownCommands.toMutableList(),
+            device,
+            rules.toMutableList(),
+            traceMonitors.toMutableList(),
+        )
             .apply(block)
 
     private fun addMonitor(newMonitor: ITransitionMonitor?) {
diff --git a/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestData.kt b/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestData.kt
index b43b64f8c..1a9212d5a 100644
--- a/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestData.kt
+++ b/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestData.kt
@@ -20,6 +20,7 @@ import android.app.Instrumentation
 import android.tools.traces.monitors.ITransitionMonitor
 import android.tools.traces.parsers.WindowManagerStateHelper
 import androidx.test.uiautomator.UiDevice
+import org.junit.rules.TestRule
 import java.io.File
 
 interface FlickerTestData {
@@ -37,6 +38,8 @@ interface FlickerTestData {
     val transitions: List<FlickerTestData.() -> Any>
     /** Commands to be executed after the transition */
     val transitionTeardown: List<FlickerTestData.() -> Any>
+    /** JUnit rules to be executed around transition */
+    val rules: List<TestRule>
     /** Helper object for WM Synchronization */
     val wmHelper: WindowManagerStateHelper
 
diff --git a/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestDataImpl.kt b/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestDataImpl.kt
index 37428c21d..2f49a97f2 100644
--- a/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestDataImpl.kt
+++ b/libraries/flicker/src/android/tools/flicker/legacy/FlickerTestDataImpl.kt
@@ -22,6 +22,7 @@ import android.tools.traces.parsers.WindowManagerStateHelper
 import android.tools.traces.surfaceflinger.LayersTrace
 import android.tools.traces.wm.WindowManagerTrace
 import androidx.test.uiautomator.UiDevice
+import org.junit.rules.TestRule
 import java.io.File
 
 /**
@@ -45,6 +46,8 @@ open class FlickerTestDataImpl(
     override val transitions: List<FlickerTestData.() -> Any>,
     /** Commands to be executed after the transition */
     override val transitionTeardown: List<FlickerTestData.() -> Any>,
+    /** JUnit rules to be executed around transition */
+    override val rules: List<TestRule>,
     /** Helper object for WM Synchronization */
     override val wmHelper: WindowManagerStateHelper
 ) : AbstractFlickerTestData()
diff --git a/libraries/flicker/src/android/tools/flicker/legacy/runner/TransitionRunner.kt b/libraries/flicker/src/android/tools/flicker/legacy/runner/TransitionRunner.kt
index 3ea5e87ae..7371af17c 100644
--- a/libraries/flicker/src/android/tools/flicker/legacy/runner/TransitionRunner.kt
+++ b/libraries/flicker/src/android/tools/flicker/legacy/runner/TransitionRunner.kt
@@ -74,41 +74,39 @@ class TransitionRunner(
      */
     private fun buildTestRuleChain(flicker: FlickerTestData): RuleChain {
         val errorRule = ArtifactSaverRule()
-        return RuleChain.outerRule(errorRule)
-            .around(StopAllTracesRule())
-            .around(errorRule)
-            .around(UnlockScreenRule())
-            .around(errorRule)
-            .around(NavigationModeRule(scenario.navBarMode.value, false))
-            .around(errorRule)
-            .around(
-                LaunchAppRule(MessagingAppHelper(instrumentation), clearCacheAfterParsing = false)
-            )
-            .around(errorRule)
-            .around(RemoveAllTasksButHomeRule())
-            .around(errorRule)
-            .around(
-                ChangeDisplayOrientationRule(
-                    scenario.startRotation,
-                    resetOrientationAfterTest = false,
-                    clearCacheAfterParsing = false
-                )
-            )
-            .around(errorRule)
-            .around(PressHomeRule())
-            .around(errorRule)
-            .around(
-                TraceMonitorRule(
-                    flicker.traceMonitors,
-                    scenario,
-                    flicker.wmHelper,
-                    resultWriter,
-                    instrumentation
-                )
-            )
-            .around(errorRule)
-            .around(SetupTeardownRule(flicker, resultWriter, scenario, instrumentation))
-            .around(errorRule)
-            .around(TransitionExecutionRule(flicker, resultWriter, scenario, instrumentation))
+
+        val rules = listOf(
+            StopAllTracesRule(),
+            UnlockScreenRule(),
+            NavigationModeRule(scenario.navBarMode.value, false),
+            LaunchAppRule(MessagingAppHelper(instrumentation), clearCacheAfterParsing = false),
+            RemoveAllTasksButHomeRule(),
+            ChangeDisplayOrientationRule(
+                scenario.startRotation,
+                resetOrientationAfterTest = false,
+                clearCacheAfterParsing = false
+            ),
+            PressHomeRule(),
+            TraceMonitorRule(
+                flicker.traceMonitors,
+                scenario,
+                flicker.wmHelper,
+                resultWriter,
+                instrumentation
+            ),
+            *flicker.rules.toTypedArray(),
+            SetupTeardownRule(flicker, resultWriter, scenario, instrumentation),
+            TransitionExecutionRule(flicker, resultWriter, scenario, instrumentation)
+        )
+
+        return rules.foldIndexed(RuleChain.outerRule(errorRule)) { index, chain, rule ->
+            chain.around(rule).let {
+                if (index != rules.lastIndex) {
+                    it.around(errorRule)
+                } else {
+                    it
+                }
+            }
+        }
     }
 }
diff --git a/libraries/flicker/src/android/tools/flicker/subject/FlickerSubjectException.kt b/libraries/flicker/src/android/tools/flicker/subject/FlickerSubjectException.kt
index 15d7baf7e..76be10aed 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/FlickerSubjectException.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/FlickerSubjectException.kt
@@ -25,6 +25,8 @@ class FlickerSubjectException(
     val facts: List<Fact>,
     override val cause: Throwable? = null
 ) : AssertionError() {
+    private val errorType: String =
+        if (cause == null) "Flicker assertion error" else "Unknown error"
     override val message = buildString {
         appendLine(errorType)
 
@@ -43,7 +45,4 @@ class FlickerSubjectException(
         appendLine("Facts")
         facts.forEach { appendLine(it.toString().prependIndent("\t")) }
     }
-
-    private val errorType: String =
-        if (cause == null) "Flicker assertion error" else "Unknown error"
 }
diff --git a/libraries/flicker/src/android/tools/flicker/subject/layers/ILayerSubject.kt b/libraries/flicker/src/android/tools/flicker/subject/layers/ILayerSubject.kt
index 9ccb8c12a..a445fd52f 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/layers/ILayerSubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/layers/ILayerSubject.kt
@@ -99,6 +99,13 @@ interface ILayerSubject<LayerSubjectType, RegionSubjectType> {
      */
     fun hasRoundedCorners(componentMatcher: IComponentMatcher): LayerSubjectType
 
+    /**
+     * Asserts that all [Layer]s matching [componentMatcher] have no rounded corners.
+     *
+     * @param componentMatcher Components to search
+     */
+    fun hasNoRoundedCorners(componentMatcher: IComponentMatcher): LayerSubjectType
+
     /**
      * Obtains a [LayerSubject] for the first occurrence of a [Layer] with [Layer.name] containing
      * [name] in [frameNumber].
diff --git a/libraries/flicker/src/android/tools/flicker/subject/layers/LayerTraceEntrySubject.kt b/libraries/flicker/src/android/tools/flicker/subject/layers/LayerTraceEntrySubject.kt
index dee03525d..63bde12a4 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/layers/LayerTraceEntrySubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/layers/LayerTraceEntrySubject.kt
@@ -311,6 +311,28 @@ class LayerTraceEntrySubject(
             }
         }
 
+    /** {@inheritDoc} */
+    override fun hasNoRoundedCorners(componentMatcher: IComponentMatcher): LayerTraceEntrySubject =
+        apply {
+            contains(componentMatcher)
+
+            val hasNoRoundedCornersLayer =
+                componentMatcher.check(subjects.map { it.layer }) {
+                    it.all { layer -> layer.cornerRadius == 0f }
+                }
+
+            if (!hasNoRoundedCornersLayer) {
+                val errorMsgBuilder =
+                    ExceptionMessageBuilder()
+                        .forSubject(this)
+                        .forInvalidProperty("RoundedCorners")
+                        .setExpected("0")
+                        .setActual("Not 0")
+                        .addExtraDescription("Filter", componentMatcher.toLayerIdentifier())
+                throw InvalidPropertyException(errorMsgBuilder)
+            }
+        }
+
     /** See [layer] */
     fun layer(componentMatcher: IComponentMatcher): LayerSubject? {
         return layer { componentMatcher.layerMatchesAnyOf(it) }
diff --git a/libraries/flicker/src/android/tools/flicker/subject/layers/LayersTraceSubject.kt b/libraries/flicker/src/android/tools/flicker/subject/layers/LayersTraceSubject.kt
index 9c00a690e..6f495678f 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/layers/LayersTraceSubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/layers/LayersTraceSubject.kt
@@ -191,6 +191,14 @@ class LayersTraceSubject(val trace: LayersTrace, override val reader: Reader? =
             }
         }
 
+    /** {@inheritDoc} */
+    override fun hasNoRoundedCorners(componentMatcher: IComponentMatcher): LayersTraceSubject =
+        apply {
+            addAssertion("hasNoRoundedCorners(${componentMatcher.toLayerIdentifier()})") {
+                it.hasNoRoundedCorners(componentMatcher)
+            }
+        }
+
     /** See [isSplashScreenVisibleFor] */
     fun isSplashScreenVisibleFor(
         componentMatcher: IComponentNameMatcher,
diff --git a/libraries/flicker/src/android/tools/flicker/subject/region/IRegionSubject.kt b/libraries/flicker/src/android/tools/flicker/subject/region/IRegionSubject.kt
index 1ecb4f2f7..faa26e136 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/region/IRegionSubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/region/IRegionSubject.kt
@@ -132,6 +132,14 @@ interface IRegionSubject {
      */
     fun notBiggerThan(other: Region): IRegionSubject
 
+    /**
+     * Asserts that region is not smaller than [other], even if the regions don't overlap.
+     *
+     * @param other Area to compare to
+     * @throws AssertionError
+     */
+    fun notSmallerThan(other: Region): IRegionSubject
+
     /**
      * Asserts that region is positioned to the right and bottom from [other], but the regions can
      * overlap and region can be smaller than [other]
diff --git a/libraries/flicker/src/android/tools/flicker/subject/region/RegionSubject.kt b/libraries/flicker/src/android/tools/flicker/subject/region/RegionSubject.kt
index a2876da62..28a5caf0b 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/region/RegionSubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/region/RegionSubject.kt
@@ -273,6 +273,24 @@ class RegionSubject(
         }
     }
 
+    /** {@inheritDoc} */
+    override fun notSmallerThan(other: Region): RegionSubject = apply {
+        val testArea = other.bounds.area
+        val area = region.bounds.area
+
+        if (area < testArea) {
+            val errorMsgBuilder =
+                ExceptionMessageBuilder()
+                    .forSubject(this)
+                    .forIncorrectRegion("region. $region area should not be smaller than $testArea")
+                    .setExpected(testArea)
+                    .setActual(area)
+                    .addExtraDescription("Expected region", other)
+                    .addExtraDescription("Actual region", regionEntry.region)
+            throw IncorrectRegionException(errorMsgBuilder)
+        }
+    }
+
     /** {@inheritDoc} */
     override fun isToTheRightBottom(other: Region, threshold: Int): RegionSubject = apply {
         val horizontallyPositionedToTheRight = other.bounds.left - threshold <= region.bounds.left
diff --git a/libraries/flicker/src/android/tools/flicker/subject/region/RegionTraceSubject.kt b/libraries/flicker/src/android/tools/flicker/subject/region/RegionTraceSubject.kt
index 349ba1c66..efd2c05fa 100644
--- a/libraries/flicker/src/android/tools/flicker/subject/region/RegionTraceSubject.kt
+++ b/libraries/flicker/src/android/tools/flicker/subject/region/RegionTraceSubject.kt
@@ -82,7 +82,7 @@ class RegionTraceSubject(val trace: RegionTrace, override val reader: Reader? =
 
     /** {@inheritDoc} */
     override fun coversAtMost(other: Region): RegionTraceSubject = apply {
-        addAssertion("coversAtMost($other, $componentsAsString") { it.coversAtMost(other) }
+        addAssertion("coversAtMost($other, $componentsAsString)") { it.coversAtMost(other) }
     }
 
     /** {@inheritDoc} */
@@ -90,19 +90,24 @@ class RegionTraceSubject(val trace: RegionTrace, override val reader: Reader? =
 
     /** {@inheritDoc} */
     override fun notBiggerThan(other: Region): RegionTraceSubject = apply {
-        addAssertion("notBiggerThan($other, $componentsAsString") { it.notBiggerThan(other) }
+        addAssertion("notBiggerThan($other, $componentsAsString)") { it.notBiggerThan(other) }
+    }
+
+    /** {@inheritDoc} */
+    override fun notSmallerThan(other: Region): RegionTraceSubject = apply {
+        addAssertion("notSmallerThan($other, $componentsAsString)") { it.notSmallerThan(other) }
     }
 
     /** {@inheritDoc} */
     override fun isToTheRightBottom(other: Region, threshold: Int): RegionTraceSubject = apply {
-        addAssertion("isToTheRightBottom($other, $componentsAsString") {
+        addAssertion("isToTheRightBottom($other, $componentsAsString)") {
             it.isToTheRightBottom(other, threshold)
         }
     }
 
     /** {@inheritDoc} */
     override fun regionsCenterPointInside(other: Rect): RegionTraceSubject = apply {
-        addAssertion("regionsCenterPointInside($other, $componentsAsString") {
+        addAssertion("regionsCenterPointInside($other, $componentsAsString)") {
             it.regionsCenterPointInside(other)
         }
     }
@@ -122,12 +127,12 @@ class RegionTraceSubject(val trace: RegionTrace, override val reader: Reader? =
 
     /** {@inheritDoc} */
     override fun coversExactly(other: Rect): RegionTraceSubject = apply {
-        addAssertion("coversExactly($other, $componentsAsString") { it.coversExactly(other) }
+        addAssertion("coversExactly($other, $componentsAsString)") { it.coversExactly(other) }
     }
 
     /** {@inheritDoc} */
     override fun overlaps(other: Region): RegionTraceSubject = apply {
-        addAssertion("overlaps($other, $componentsAsString") { it.overlaps(other) }
+        addAssertion("overlaps($other, $componentsAsString)") { it.overlaps(other) }
     }
 
     /** {@inheritDoc} */
@@ -135,7 +140,7 @@ class RegionTraceSubject(val trace: RegionTrace, override val reader: Reader? =
 
     /** {@inheritDoc} */
     override fun notOverlaps(other: Region): RegionTraceSubject = apply {
-        addAssertion("notOverlaps($other, $componentsAsString") { it.notOverlaps(other) }
+        addAssertion("notOverlaps($other, $componentsAsString)") { it.notOverlaps(other) }
     }
 
     /** {@inheritDoc} */
@@ -146,24 +151,26 @@ class RegionTraceSubject(val trace: RegionTrace, override val reader: Reader? =
 
     /** {@inheritDoc} */
     override fun isSameAspectRatio(other: Region, threshold: Double): RegionTraceSubject = apply {
-        addAssertion("isSameAspectRatio($other, $componentsAsString") {
+        addAssertion("isSameAspectRatio($other, $componentsAsString)") {
             it.isSameAspectRatio(other, threshold)
         }
     }
 
     override fun hasSameLeftPosition(displayRect: Rect): RegionTraceSubject = apply {
-        addAssertion("hasSameLeftPosition($displayRect") { it.hasSameLeftPosition(displayRect) }
+        addAssertion("hasSameLeftPosition($displayRect)") { it.hasSameLeftPosition(displayRect) }
     }
 
     override fun hasSameBottomPosition(displayRect: Rect): RegionTraceSubject = apply {
-        addAssertion("hasSameBottomPosition($displayRect") { it.hasSameBottomPosition(displayRect) }
+        addAssertion("hasSameBottomPosition($displayRect)") {
+            it.hasSameBottomPosition(displayRect)
+        }
     }
 
     override fun hasSameRightPosition(displayRect: Rect): RegionTraceSubject = apply {
-        addAssertion("hasSameRightPosition($displayRect") { it.hasSameRightPosition(displayRect) }
+        addAssertion("hasSameRightPosition($displayRect)") { it.hasSameRightPosition(displayRect) }
     }
 
     override fun hasSameTopPosition(displayRect: Rect): RegionTraceSubject = apply {
-        addAssertion("hasSameTopPosition($displayRect") { it.hasSameTopPosition(displayRect) }
+        addAssertion("hasSameTopPosition($displayRect)") { it.hasSameTopPosition(displayRect) }
     }
 }
diff --git a/libraries/flicker/test/Android.bp b/libraries/flicker/test/Android.bp
index ffe137ec4..5cbbf3eab 100644
--- a/libraries/flicker/test/Android.bp
+++ b/libraries/flicker/test/Android.bp
@@ -27,7 +27,7 @@ java_defaults {
     certificate: "platform",
     platform_apis: true,
     test_suites: ["device-tests"],
-    libs: ["android.test.runner"],
+    libs: ["android.test.runner.stubs.system"],
     optimize: {
         enabled: false,
     },
@@ -40,7 +40,7 @@ java_defaults {
     ],
     data: [
         "trace_config/*",
-    ]
+    ],
 }
 
 android_test {
@@ -68,10 +68,10 @@ android_test {
     instrumentation_target_package: "android.tools.integration",
     srcs: [
         "src/android/tools/integration/**/*.kt",
-        "src/android/tools/rules/**/*.kt",
-        "src/android/tools/Utils.kt",
+        "src/android/tools/testrules/**/*.kt",
+        "src/android/tools/TestUtils.kt",
     ],
     static_libs: [
-            "//frameworks/base/packages/SystemUI/aconfig:com_android_systemui_flags_lib",
-        ],
+        "//frameworks/base/packages/SystemUI/aconfig:com_android_systemui_flags_lib",
+    ],
 }
diff --git a/libraries/flicker/test/assets/testdata/quick_switch_to_app_killed_in_background_trace.perfetto-trace b/libraries/flicker/test/assets/testdata/quick_switch_to_app_killed_in_background_trace.perfetto-trace
new file mode 100644
index 000000000..947a677fc
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/quick_switch_to_app_killed_in_background_trace.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/tablet/wm_dump_home_screen.perfetto-trace b/libraries/flicker/test/assets/testdata/tablet/wm_dump_home_screen.perfetto-trace
new file mode 100644
index 000000000..eb2e2fb0a
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/tablet/wm_dump_home_screen.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_chrome.perfetto-trace b/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_chrome.perfetto-trace
new file mode 100644
index 000000000..b8f2f2b08
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_chrome.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_recents.perfetto-trace b/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_recents.perfetto-trace
new file mode 100644
index 000000000..9547ce28c
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/tablet/wm_trace_open_recents.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace.perfetto-trace
new file mode 100644
index 000000000..bd4ce5578
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace.perfetto_trace b/libraries/flicker/test/assets/testdata/wm_trace.perfetto_trace
new file mode 100644
index 000000000..bd4ce5578
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace.perfetto_trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_2activities_same_name.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_2activities_same_name.perfetto-trace
new file mode 100644
index 000000000..ff2baac1a
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_2activities_same_name.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_ime.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_ime.perfetto-trace
new file mode 100644
index 000000000..15e97721e
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_ime.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_launcher_visible_background.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_launcher_visible_background.perfetto-trace
new file mode 100644
index 000000000..8da196ee7
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_launcher_visible_background.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace
new file mode 100644
index 000000000..c33af2ee3
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_open_from_overview.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_open_from_overview.perfetto-trace
new file mode 100644
index 000000000..7d28ab19e
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_open_from_overview.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_openchrome.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_openchrome.perfetto-trace
new file mode 100644
index 000000000..14ed69faf
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_openchrome.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_split_screen.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_split_screen.perfetto-trace
new file mode 100644
index 000000000..536dc968d
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_split_screen.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_taskfragment.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_taskfragment.perfetto-trace
new file mode 100644
index 000000000..885679b6b
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_taskfragment.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_unlock.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_unlock.perfetto-trace
new file mode 100644
index 000000000..23927eaa2
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_unlock.perfetto-trace differ
diff --git a/libraries/flicker/test/assets/testdata/wm_trace_valid_visible_windows.perfetto-trace b/libraries/flicker/test/assets/testdata/wm_trace_valid_visible_windows.perfetto-trace
new file mode 100644
index 000000000..652bef4db
Binary files /dev/null and b/libraries/flicker/test/assets/testdata/wm_trace_valid_visible_windows.perfetto-trace differ
diff --git a/libraries/flicker/test/src/android/tools/Utils.kt b/libraries/flicker/test/src/android/tools/TestUtils.kt
similarity index 92%
rename from libraries/flicker/test/src/android/tools/Utils.kt
rename to libraries/flicker/test/src/android/tools/TestUtils.kt
index 285ae7573..36ae437fa 100644
--- a/libraries/flicker/test/src/android/tools/Utils.kt
+++ b/libraries/flicker/test/src/android/tools/TestUtils.kt
@@ -25,7 +25,12 @@ import android.tools.io.PERFETTO_EXT
 import android.tools.io.Reader
 import android.tools.io.WINSCOPE_EXT
 import android.tools.parsers.events.EventLogParser
-import android.tools.rules.DataStoreCleanupRule
+import android.tools.testrules.DataStoreCleanupRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.ParsedTracesReader
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.TestArtifact
+import android.tools.testutils.readAsset
 import android.tools.traces.monitors.ITransitionMonitor
 import android.tools.traces.monitors.PerfettoTraceMonitor
 import android.tools.traces.monitors.wm.WindowManagerTraceMonitor
@@ -34,12 +39,7 @@ import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransactionsTraceParser
 import android.tools.traces.parsers.wm.LegacyTransitionTraceParser
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.ParsedTracesReader
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.TestArtifact
-import android.tools.utils.readAsset
+import android.tools.traces.parsers.wm.LegacyWindowManagerTraceParser
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.UiDevice
 import java.io.File
@@ -62,7 +62,7 @@ internal fun getTraceReaderFromScenario(scenario: String): Reader {
 
     return ParsedTracesReader(
         artifact = TestArtifact(scenario),
-        wmTrace = WindowManagerTraceParser().parse(scenarioTraces.wmTrace.readBytes()),
+        wmTrace = LegacyWindowManagerTraceParser().parse(scenarioTraces.wmTrace.readBytes()),
         layersTrace = layersTrace,
         transitionsTrace =
             LegacyTransitionTraceParser()
diff --git a/libraries/flicker/test/src/android/tools/flicker/FlickerServiceResultsCollectorTest.kt b/libraries/flicker/test/src/android/tools/flicker/FlickerServiceResultsCollectorTest.kt
index db0303843..a79675272 100644
--- a/libraries/flicker/test/src/android/tools/flicker/FlickerServiceResultsCollectorTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/FlickerServiceResultsCollectorTest.kt
@@ -32,13 +32,13 @@ import android.tools.flicker.assertions.SubjectsParser
 import android.tools.flicker.subject.exceptions.FlickerAssertionError
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
 import android.tools.io.Reader
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.KotlinMockito
+import android.tools.testutils.MockLayersTraceBuilder
+import android.tools.testutils.MockWindowManagerTraceBuilder
+import android.tools.testutils.ParsedTracesReader
+import android.tools.testutils.TestArtifact
 import android.tools.traces.wm.TransitionsTrace
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.KotlinMockito
-import android.tools.utils.MockLayersTraceBuilder
-import android.tools.utils.MockWindowManagerTraceBuilder
-import android.tools.utils.ParsedTracesReader
-import android.tools.utils.TestArtifact
 import com.google.common.truth.Truth
 import org.junit.AssumptionViolatedException
 import org.junit.ClassRule
@@ -447,6 +447,7 @@ class FlickerServiceResultsCollectorTest {
 
         private class SpyDataRecord : DataRecord() {
             val stringMetrics = mutableMapOf<String, String>()
+
             override fun addStringMetric(key: String, value: String) {
                 super.addStringMetric(key, value)
                 stringMetrics[key] = value
diff --git a/libraries/flicker/test/src/android/tools/flicker/FlickerServiceRuleTest.kt b/libraries/flicker/test/src/android/tools/flicker/FlickerServiceRuleTest.kt
index fac41b2b0..07c930564 100644
--- a/libraries/flicker/test/src/android/tools/flicker/FlickerServiceRuleTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/FlickerServiceRuleTest.kt
@@ -23,8 +23,8 @@ import android.tools.flicker.legacy.runner.Consts
 import android.tools.flicker.rules.FlickerServiceRule
 import android.tools.flicker.subject.exceptions.FlickerAssertionError
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.KotlinMockito
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.KotlinMockito
 import com.google.common.truth.Truth
 import org.junit.Assert.assertThrows
 import org.junit.Assume
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/ArtifactAssertionRunnerTest.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/ArtifactAssertionRunnerTest.kt
index 9ff165eff..a36f110b7 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/ArtifactAssertionRunnerTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/ArtifactAssertionRunnerTest.kt
@@ -18,13 +18,13 @@ package android.tools.flicker.assertions
 
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.IResultData
 import android.tools.traces.monitors.events.EventLogMonitor
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionStateDataFactoryTest.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionStateDataFactoryTest.kt
index 56e534fdd..354c86c1f 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionStateDataFactoryTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionStateDataFactoryTest.kt
@@ -20,7 +20,7 @@ import android.tools.Tag
 import android.tools.flicker.subject.events.EventLogSubject
 import android.tools.flicker.subject.layers.LayerTraceEntrySubject
 import android.tools.flicker.subject.wm.WindowManagerStateSubject
-import android.tools.utils.CleanFlickerEnvironmentRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import kotlin.reflect.KClass
 import org.junit.ClassRule
@@ -30,8 +30,10 @@ import org.junit.Test
 open class AssertionStateDataFactoryTest {
     protected open val wmAssertionFactory
         get() = AssertionStateDataFactory(WindowManagerStateSubject::class)
+
     protected open val layersAssertionFactory
         get() = AssertionStateDataFactory(LayerTraceEntrySubject::class)
+
     protected open val eventLogAssertionFactory
         get() = AssertionStateDataFactory(EventLogSubject::class)
 
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionsCheckerTest.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionsCheckerTest.kt
index 2b3a356d8..f55448fb9 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionsCheckerTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/AssertionsCheckerTest.kt
@@ -20,8 +20,8 @@ import android.tools.Timestamp
 import android.tools.Timestamps
 import android.tools.TraceEntry
 import android.tools.flicker.subject.FlickerSubject
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.assertFail
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.assertFail
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
 import org.junit.Test
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTestParse.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTest.kt
similarity index 75%
rename from libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTestParse.kt
rename to libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTest.kt
index f9c18c87a..7182f910a 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTestParse.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/BaseSubjectsParserTest.kt
@@ -20,22 +20,27 @@ import android.tools.Tag
 import android.tools.Timestamp
 import android.tools.flicker.subject.FlickerSubject
 import android.tools.flicker.subject.FlickerTraceSubject
+import android.tools.flicker.subject.events.EventLogSubject
+import android.tools.flicker.subject.layers.LayerTraceEntrySubject
+import android.tools.flicker.subject.layers.LayersTraceSubject
+import android.tools.flicker.subject.wm.WindowManagerStateSubject
+import android.tools.flicker.subject.wm.WindowManagerTraceSubject
 import android.tools.io.RunStatus
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import com.google.common.truth.Truth
 import java.io.File
 import org.junit.Before
 import org.junit.ClassRule
 import org.junit.Test
 
-abstract class BaseSubjectsParserTestParse {
+abstract class BaseSubjectsParserTest {
     protected abstract val assetFile: File
     protected abstract val subjectName: String
     protected abstract val expectedStartTime: Timestamp
@@ -108,6 +113,23 @@ abstract class BaseSubjectsParserTestParse {
             .isEqualTo(getTime(expectedTime))
     }
 
+    /** Wrapper for [SubjectsParser] with looser visibility */
+    inner class TestSubjectsParser(resultReader: ResultReader) : SubjectsParser(resultReader) {
+        public override fun doGetEventLogSubject(): EventLogSubject? = super.doGetEventLogSubject()
+
+        public override fun doGetWmTraceSubject(): WindowManagerTraceSubject? =
+            super.doGetWmTraceSubject()
+
+        public override fun doGetLayersTraceSubject(): LayersTraceSubject? =
+            super.doGetLayersTraceSubject()
+
+        public override fun doGetLayerTraceEntrySubject(tag: String): LayerTraceEntrySubject? =
+            super.doGetLayerTraceEntrySubject(tag)
+
+        public override fun doGetWmStateSubject(tag: String): WindowManagerStateSubject? =
+            super.doGetWmStateSubject(tag)
+    }
+
     companion object {
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTest.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTest.kt
index be68f4a83..a8a839128 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTest.kt
@@ -18,11 +18,11 @@ package android.tools.flicker.assertions
 
 import android.tools.Tag
 import android.tools.flicker.subject.layers.LayersTraceSubject
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.assertThrows
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.assertThrows
-import android.tools.utils.newTestResultWriter
 import java.io.FileNotFoundException
 import org.junit.ClassRule
 import org.junit.Test
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseLayers.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestLayers.kt
similarity index 93%
rename from libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseLayers.kt
rename to libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestLayers.kt
index c1c2a6ccc..5957e5f8a 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseLayers.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestLayers.kt
@@ -21,10 +21,10 @@ import android.tools.Timestamp
 import android.tools.flicker.subject.FlickerSubject
 import android.tools.flicker.subject.FlickerTraceSubject
 import android.tools.io.TraceType
-import android.tools.utils.TestTraces
+import android.tools.testutils.TestTraces
 
 @SuppressLint("VisibleForTests")
-class SubjectsParserTestParseLayers : BaseSubjectsParserTestParse() {
+class SubjectsParserTestLayers : BaseSubjectsParserTest() {
     override val assetFile = TestTraces.LayerTrace.FILE
     override val expectedStartTime = TestTraces.LayerTrace.START_TIME
     override val expectedEndTime = TestTraces.LayerTrace.END_TIME
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseWM.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestWM.kt
similarity index 68%
rename from libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseWM.kt
rename to libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestWM.kt
index e248bf3d5..d461f54f8 100644
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestParseWM.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/assertions/SubjectsParserTestWM.kt
@@ -21,15 +21,25 @@ import android.tools.Timestamp
 import android.tools.flicker.subject.FlickerSubject
 import android.tools.flicker.subject.FlickerTraceSubject
 import android.tools.io.TraceType
-import android.tools.utils.TestTraces
+import android.tools.testutils.TestTraces
 
 @SuppressLint("VisibleForTests")
-class SubjectsParserTestParseWM : BaseSubjectsParserTestParse() {
-    override val assetFile = TestTraces.WMTrace.FILE
-    override val expectedStartTime = TestTraces.WMTrace.START_TIME
-    override val expectedEndTime = TestTraces.WMTrace.END_TIME
+class SubjectsParserTestWM : BaseSubjectsParserTest() {
+    override val assetFile =
+        if (android.tracing.Flags.perfettoWmTracing()) {
+            TestTraces.WMTrace.FILE
+        } else {
+            TestTraces.LegacyWMTrace.FILE
+        }
+    override val expectedStartTime = TestTraces.LegacyWMTrace.START_TIME
+    override val expectedEndTime = TestTraces.LegacyWMTrace.END_TIME
     override val subjectName = "WM Trace"
-    override val traceType = TraceType.WM
+    override val traceType =
+        if (android.tracing.Flags.perfettoWmTracing()) {
+            TraceType.PERFETTO
+        } else {
+            TraceType.WM
+        }
 
     override fun getTime(timestamp: Timestamp) = timestamp.elapsedNanos
 
diff --git a/libraries/flicker/test/src/android/tools/flicker/assertions/TestSubjectsParser.kt b/libraries/flicker/test/src/android/tools/flicker/assertions/TestSubjectsParser.kt
deleted file mode 100644
index d8abd5aa7..000000000
--- a/libraries/flicker/test/src/android/tools/flicker/assertions/TestSubjectsParser.kt
+++ /dev/null
@@ -1,41 +0,0 @@
-/*
- * Copyright (C) 2023 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package android.tools.flicker.assertions
-
-import android.tools.flicker.subject.events.EventLogSubject
-import android.tools.flicker.subject.layers.LayerTraceEntrySubject
-import android.tools.flicker.subject.layers.LayersTraceSubject
-import android.tools.flicker.subject.wm.WindowManagerStateSubject
-import android.tools.flicker.subject.wm.WindowManagerTraceSubject
-import android.tools.traces.io.ResultReader
-
-/** Wrapper for [SubjectsParser] with looser visibility */
-class TestSubjectsParser(resultReader: ResultReader) : SubjectsParser(resultReader) {
-    public override fun doGetEventLogSubject(): EventLogSubject? = super.doGetEventLogSubject()
-
-    public override fun doGetWmTraceSubject(): WindowManagerTraceSubject? =
-        super.doGetWmTraceSubject()
-
-    public override fun doGetLayersTraceSubject(): LayersTraceSubject? =
-        super.doGetLayersTraceSubject()
-
-    public override fun doGetLayerTraceEntrySubject(tag: String): LayerTraceEntrySubject? =
-        super.doGetLayerTraceEntrySubject(tag)
-
-    public override fun doGetWmStateSubject(tag: String): WindowManagerStateSubject? =
-        super.doGetWmStateSubject(tag)
-}
diff --git a/libraries/flicker/test/src/android/tools/flicker/config/FlickerConfigTest.kt b/libraries/flicker/test/src/android/tools/flicker/config/FlickerConfigTest.kt
index dd9ea7ea4..25b753a10 100644
--- a/libraries/flicker/test/src/android/tools/flicker/config/FlickerConfigTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/config/FlickerConfigTest.kt
@@ -27,7 +27,7 @@ import android.tools.flicker.extractors.ScenarioExtractor
 import android.tools.flicker.extractors.TraceSlice
 import android.tools.getTraceReaderFromScenario
 import android.tools.io.Reader
-import android.tools.utils.assertThrows
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.Test
 
diff --git a/libraries/flicker/test/src/android/tools/flicker/config/QuickswitchTest.kt b/libraries/flicker/test/src/android/tools/flicker/config/QuickswitchTest.kt
index 8def5f7e9..f636b6bae 100644
--- a/libraries/flicker/test/src/android/tools/flicker/config/QuickswitchTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/config/QuickswitchTest.kt
@@ -24,9 +24,9 @@ import android.tools.device.apphelpers.BrowserAppHelper
 import android.tools.device.apphelpers.CameraAppHelper
 import android.tools.flicker.Utils
 import android.tools.flicker.config.gesturenav.Quickswitch
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import android.tools.traces.getDefaultFlickerOutputDir
 import android.tools.traces.parsers.WindowManagerStateHelper
-import android.tools.utils.CleanFlickerEnvironmentRule
 import android.view.Display
 import androidx.test.platform.app.InstrumentationRegistry
 import com.android.launcher3.tapl.LauncherInstrumentation
diff --git a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedAssertionRunnerTest.kt b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedAssertionRunnerTest.kt
index 0ad030e76..3cf1eaef1 100644
--- a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedAssertionRunnerTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedAssertionRunnerTest.kt
@@ -23,11 +23,11 @@ import android.tools.flicker.subject.FlickerSubject
 import android.tools.flicker.subject.events.EventLogSubject
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.monitors.events.EventLogMonitor
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.newTestResultWriter
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultReaderTest.kt b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultReaderTest.kt
index 81064cd26..c1867d52d 100644
--- a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultReaderTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultReaderTest.kt
@@ -19,10 +19,10 @@ package android.tools.flicker.datastore
 import android.annotation.SuppressLint
 import android.tools.CleanFlickerEnvironmentRuleWithDataStore
 import android.tools.io.TraceType
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.TestTraces
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.TestTraces
-import android.tools.utils.newTestResultWriter
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultWriterTest.kt b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultWriterTest.kt
index 626b58fc2..477de48f6 100644
--- a/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultWriterTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/datastore/CachedResultWriterTest.kt
@@ -19,9 +19,9 @@ package android.tools.flicker.datastore
 import android.annotation.SuppressLint
 import android.tools.CleanFlickerEnvironmentRuleWithDataStore
 import android.tools.newTestCachedResultWriter
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.Rule
 import org.junit.Test
diff --git a/libraries/flicker/test/src/android/tools/flicker/datastore/Consts.kt b/libraries/flicker/test/src/android/tools/flicker/datastore/Consts.kt
index 11a49da74..ece31c293 100644
--- a/libraries/flicker/test/src/android/tools/flicker/datastore/Consts.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/datastore/Consts.kt
@@ -18,8 +18,8 @@ package android.tools.flicker.datastore
 
 import android.tools.Timestamps
 import android.tools.io.TransitionTimeRange
+import android.tools.testutils.TestArtifact
 import android.tools.traces.io.ResultData
-import android.tools.utils.TestArtifact
 
 object Consts {
     internal const val FAILURE = "Expected failure"
diff --git a/libraries/flicker/test/src/android/tools/flicker/datastore/DataStoreTest.kt b/libraries/flicker/test/src/android/tools/flicker/datastore/DataStoreTest.kt
index 4b56832b6..e48da4437 100644
--- a/libraries/flicker/test/src/android/tools/flicker/datastore/DataStoreTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/datastore/DataStoreTest.kt
@@ -17,10 +17,10 @@
 package android.tools.flicker.datastore
 
 import android.annotation.SuppressLint
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceCachedTestCaseTest.kt b/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceCachedTestCaseTest.kt
index 68e9322f5..456269ed7 100644
--- a/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceCachedTestCaseTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceCachedTestCaseTest.kt
@@ -29,8 +29,8 @@ import android.tools.flicker.assertions.SubjectsParser
 import android.tools.flicker.subject.exceptions.FlickerAssertionError
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
 import android.tools.io.Reader
-import android.tools.utils.KotlinMockito
-import android.tools.utils.assertThrows
+import android.tools.testutils.KotlinMockito
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.AssumptionViolatedException
 import org.junit.Test
diff --git a/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceDecoratorTest.kt b/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceDecoratorTest.kt
index ee19b42b9..eea378ba3 100644
--- a/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceDecoratorTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/junit/FlickerServiceDecoratorTest.kt
@@ -34,8 +34,8 @@ import android.tools.flicker.config.FlickerServiceConfig
 import android.tools.flicker.config.ScenarioId
 import android.tools.flicker.extractors.ScenarioExtractor
 import android.tools.io.Reader
-import android.tools.utils.KotlinMockito
-import android.tools.utils.assertThrows
+import android.tools.testutils.KotlinMockito
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.Ignore
 import org.junit.Test
@@ -82,8 +82,7 @@ class FlickerServiceDecoratorTest {
                 Mockito.anyInt(),
                 KotlinMockito.argThat<Bundle> {
                     this.getString(Instrumentation.REPORT_KEY_STREAMRESULT)
-                        ?.contains("Running setup")
-                        ?: false
+                        ?.contains("Running setup") ?: false
                 }
             )
         Mockito.verify(instrumentation)
@@ -91,8 +90,7 @@ class FlickerServiceDecoratorTest {
                 Mockito.anyInt(),
                 KotlinMockito.argThat {
                     this.getString(Instrumentation.REPORT_KEY_STREAMRESULT)
-                        ?.contains("Running transition")
-                        ?: false
+                        ?.contains("Running transition") ?: false
                 }
             )
         Mockito.verify(instrumentation)
@@ -100,8 +98,7 @@ class FlickerServiceDecoratorTest {
                 Mockito.anyInt(),
                 KotlinMockito.argThat {
                     this.getString(Instrumentation.REPORT_KEY_STREAMRESULT)
-                        ?.contains("Running teardown")
-                        ?: false
+                        ?.contains("Running teardown") ?: false
                 }
             )
     }
diff --git a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerDecoratorTest.kt b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerDecoratorTest.kt
index 32eade37e..1a5e3a2f4 100644
--- a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerDecoratorTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerDecoratorTest.kt
@@ -18,11 +18,10 @@ package android.tools.flicker.junit
 
 import android.annotation.SuppressLint
 import android.tools.ScenarioBuilder
-import android.tools.flicker.datastore.DataStore
 import android.tools.flicker.legacy.FlickerBuilder
 import android.tools.flicker.legacy.LegacyFlickerTest
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.KotlinMockito
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.KotlinMockito
 import com.google.common.truth.Truth
 import kotlin.reflect.KClass
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerJUnit4ClassRunnerTest.kt b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerJUnit4ClassRunnerTest.kt
index e4d43ff44..88139509a 100644
--- a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerJUnit4ClassRunnerTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerJUnit4ClassRunnerTest.kt
@@ -19,7 +19,6 @@ package android.tools.flicker.junit
 import android.annotation.SuppressLint
 import android.app.Instrumentation
 import android.os.Bundle
-import android.platform.test.annotations.FlakyTest
 import android.tools.Scenario
 import android.tools.Timestamps
 import android.tools.device.apphelpers.BrowserAppHelper
@@ -42,7 +41,8 @@ import android.tools.flicker.legacy.LegacyFlickerTest
 import android.tools.flicker.legacy.LegacyFlickerTestFactory
 import android.tools.getScenarioTraces
 import android.tools.io.Reader
-import android.tools.utils.CleanFlickerEnvironmentRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import androidx.test.filters.FlakyTest
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
 import org.junit.Assume
diff --git a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerServiceDecoratorTest.kt b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerServiceDecoratorTest.kt
index 1e84715b7..a6eac3748 100644
--- a/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerServiceDecoratorTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/junit/LegacyFlickerServiceDecoratorTest.kt
@@ -19,8 +19,8 @@ package android.tools.flicker.junit
 import android.annotation.SuppressLint
 import android.tools.flicker.isShellTransitionsEnabled
 import android.tools.flicker.legacy.LegacyFlickerTest
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestFactoryTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestFactoryTest.kt
index d6e2e06df..98b1069c9 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestFactoryTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestFactoryTest.kt
@@ -17,7 +17,7 @@
 package android.tools.flicker.legacy
 
 import android.tools.Rotation
-import android.tools.utils.CleanFlickerEnvironmentRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestTest.kt
index af286aea2..145bae34c 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/LegacyFlickerTestTest.kt
@@ -20,16 +20,14 @@ import android.annotation.SuppressLint
 import android.tools.CleanFlickerEnvironmentRuleWithDataStore
 import android.tools.ScenarioBuilder
 import android.tools.flicker.assertions.FlickerTest
-import android.tools.flicker.datastore.CachedResultReader
-import android.tools.flicker.datastore.DataStore
 import android.tools.io.TraceType
 import android.tools.newTestCachedResultWriter
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.TestTraces
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.TestTraces
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
 import com.google.common.truth.Truth
 import java.io.File
 import kotlin.io.path.name
@@ -118,9 +116,10 @@ class LegacyFlickerTestTest {
     fun executesWm() {
         val predicate: (FlickerTest) -> Unit = { it.assertWm { executionCount++ } }
         doWriteTraceExecuteAssertionAndVerify(
-            TraceType.WM,
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
             predicate,
-            TestTraces.WMTrace.FILE,
+            if (android.tracing.Flags.perfettoWmTracing()) TestTraces.WMTrace.FILE
+            else TestTraces.LegacyWMTrace.FILE,
             expectedExecutionCount = 2
         )
     }
@@ -129,9 +128,10 @@ class LegacyFlickerTestTest {
     fun executesWmStart() {
         val predicate: (FlickerTest) -> Unit = { it.assertWmStart { executionCount++ } }
         doWriteTraceExecuteAssertionAndVerify(
-            TraceType.WM,
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
             predicate,
-            TestTraces.WMTrace.FILE,
+            if (android.tracing.Flags.perfettoWmTracing()) TestTraces.WMTrace.FILE
+            else TestTraces.LegacyWMTrace.FILE,
             expectedExecutionCount = 2
         )
     }
@@ -140,9 +140,10 @@ class LegacyFlickerTestTest {
     fun executesWmEnd() {
         val predicate: (FlickerTest) -> Unit = { it.assertWmEnd { executionCount++ } }
         doWriteTraceExecuteAssertionAndVerify(
-            TraceType.WM,
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
             predicate,
-            TestTraces.WMTrace.FILE,
+            if (android.tracing.Flags.perfettoWmTracing()) TestTraces.WMTrace.FILE
+            else TestTraces.LegacyWMTrace.FILE,
             expectedExecutionCount = 2
         )
     }
@@ -150,28 +151,38 @@ class LegacyFlickerTestTest {
     @Test
     fun doesNotExecuteWmWithoutTrace() {
         val predicate: (FlickerTest) -> Unit = { it.assertWm { executionCount++ } }
-        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(TraceType.WM, predicate)
+        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
+            predicate
+        )
     }
 
     @Test
     fun doesNotExecuteWmStartWithoutTrace() {
         val predicate: (FlickerTest) -> Unit = { it.assertWmStart { executionCount++ } }
-        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(TraceType.WM, predicate)
+        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
+            predicate
+        )
     }
 
     @Test
     fun doesNotExecuteWmEndWithoutTrace() {
         val predicate: (FlickerTest) -> Unit = { it.assertWmEnd { executionCount++ } }
-        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(TraceType.WM, predicate)
+        doExecuteAssertionWithoutTraceAndVerifyNotExecuted(
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
+            predicate
+        )
     }
 
     @Test
     fun doesNotExecuteWmTagWithoutTag() {
         val predicate: (FlickerTest) -> Unit = { it.assertWmTag("tag") { executionCount++ } }
         doWriteTraceExecuteAssertionAndVerify(
-            TraceType.WM,
+            if (android.tracing.Flags.perfettoWmTracing()) TraceType.PERFETTO else TraceType.WM,
             predicate,
-            TestTraces.WMTrace.FILE,
+            if (android.tracing.Flags.perfettoWmTracing()) TestTraces.WMTrace.FILE
+            else TestTraces.LegacyWMTrace.FILE,
             expectedExecutionCount = 0
         )
     }
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/SetupTeardownRuleTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/SetupTeardownRuleTest.kt
index 08d698696..87cdff08b 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/SetupTeardownRuleTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/SetupTeardownRuleTest.kt
@@ -19,11 +19,11 @@ package android.tools.flicker.legacy.runner
 import android.app.Instrumentation
 import android.tools.flicker.legacy.AbstractFlickerTestData
 import android.tools.flicker.legacy.FlickerTestData
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertThrows
 import android.tools.traces.io.ResultWriter
 import android.tools.traces.parsers.WindowManagerStateHelper
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertThrows
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TraceMonitorRuleTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TraceMonitorRuleTest.kt
index dd1acbe54..1e924600f 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TraceMonitorRuleTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TraceMonitorRuleTest.kt
@@ -17,12 +17,12 @@
 package android.tools.flicker.legacy.runner
 
 import android.app.Instrumentation
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertThrows
 import android.tools.traces.io.ResultWriter
 import android.tools.traces.monitors.ITransitionMonitor
 import android.tools.traces.parsers.WindowManagerStateHelper
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertThrows
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionExecutionRuleTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionExecutionRuleTest.kt
index 786ba0309..8713be57d 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionExecutionRuleTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionExecutionRuleTest.kt
@@ -21,16 +21,16 @@ import android.app.Instrumentation
 import android.os.SystemClock
 import android.tools.flicker.legacy.AbstractFlickerTestData
 import android.tools.flicker.legacy.FlickerTestData
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
 import android.tools.traces.monitors.TraceMonitor
 import android.tools.traces.parsers.WindowManagerStateHelper
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
-import android.tools.utils.newTestResultWriter
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionRunnerTest.kt b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionRunnerTest.kt
index 0a8a6e2fc..cc8cd3ef5 100644
--- a/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionRunnerTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/legacy/runner/TransitionRunnerTest.kt
@@ -22,13 +22,13 @@ import android.os.SystemClock
 import android.tools.createMockedFlicker
 import android.tools.flicker.legacy.FlickerTestData
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertExceptionMessage
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
 import android.tools.traces.monitors.ITransitionMonitor
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertExceptionMessage
 import android.view.WindowManagerGlobal
 import androidx.test.platform.app.InstrumentationRegistry
 import com.google.common.truth.Truth
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/events/EventLogSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/events/EventLogSubjectTest.kt
index 5602e8658..933f67cc6 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/events/EventLogSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/events/EventLogSubjectTest.kt
@@ -18,11 +18,11 @@ package android.tools.flicker.subject.events
 
 import android.tools.Timestamps
 import android.tools.flicker.assertions.SubjectsParser
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.ParsedTracesReader
+import android.tools.testutils.TestArtifact
 import android.tools.traces.events.EventLog
 import android.tools.traces.events.FocusEvent
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.ParsedTracesReader
-import android.tools.utils.TestArtifact
 import org.junit.ClassRule
 import org.junit.Test
 
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/region/RegionSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/region/RegionSubjectTest.kt
index 0420ce195..392d9a0e6 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/region/RegionSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/region/RegionSubjectTest.kt
@@ -19,8 +19,8 @@ package android.tools.flicker.subject.region
 import android.graphics.Rect
 import android.graphics.Region
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.assertFail
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.assertFail
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
 import org.junit.Test
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerSubjectTest.kt
index 163cbeb42..3bfb6edbb 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerSubjectTest.kt
@@ -20,8 +20,8 @@ import android.tools.Cache
 import android.tools.datatypes.Size
 import android.tools.flicker.subject.layers.LayerSubject
 import android.tools.flicker.subject.layers.LayersTraceSubject
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.getLayerTraceReaderFromAsset
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerTraceEntrySubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerTraceEntrySubjectTest.kt
index bf29a248f..bf2fbd02a 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerTraceEntrySubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayerTraceEntrySubjectTest.kt
@@ -21,16 +21,16 @@ import android.graphics.Region
 import android.tools.Cache
 import android.tools.flicker.subject.layers.LayerTraceEntrySubject
 import android.tools.flicker.subject.layers.LayersTraceSubject
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.MockLayerBuilder
+import android.tools.testutils.MockLayerTraceEntryBuilder
+import android.tools.testutils.TestComponents
+import android.tools.testutils.assertFail
+import android.tools.testutils.assertThatErrorContainsDebugInfo
+import android.tools.testutils.assertThrows
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import android.tools.traces.component.ComponentNameMatcher
 import android.tools.traces.component.OrComponentMatcher
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.MockLayerBuilder
-import android.tools.utils.MockLayerTraceEntryBuilder
-import android.tools.utils.TestComponents
-import android.tools.utils.assertFail
-import android.tools.utils.assertThatErrorContainsDebugInfo
-import android.tools.utils.assertThrows
-import android.tools.utils.getLayerTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayersTraceSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayersTraceSubjectTest.kt
index dd0d91434..d3f7e278d 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayersTraceSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/surfaceflinger/LayersTraceSubjectTest.kt
@@ -25,13 +25,13 @@ import android.tools.flicker.legacy.LegacyFlickerTest
 import android.tools.flicker.subject.layers.LayersTraceSubject
 import android.tools.flicker.subject.region.RegionSubject
 import android.tools.io.Reader
+import android.tools.testutils.TestComponents
+import android.tools.testutils.assertFail
+import android.tools.testutils.assertThatErrorContainsDebugInfo
+import android.tools.testutils.assertThrows
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import android.tools.traces.component.ComponentNameMatcher
 import android.tools.traces.io.IResultData
-import android.tools.utils.TestComponents
-import android.tools.utils.assertFail
-import android.tools.utils.assertThatErrorContainsDebugInfo
-import android.tools.utils.assertThrows
-import android.tools.utils.getLayerTraceReaderFromAsset
 import androidx.test.filters.FlakyTest
 import com.google.common.truth.Truth
 import org.junit.Before
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerStateSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerStateSubjectTest.kt
index 1566aa2fa..4cd510bb4 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerStateSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerStateSubjectTest.kt
@@ -18,17 +18,17 @@ package android.tools.flicker.subject.wm
 
 import android.graphics.Region
 import android.tools.Cache
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TestComponents
+import android.tools.testutils.assertFail
+import android.tools.testutils.assertThatErrorContainsDebugInfo
+import android.tools.testutils.assertThrows
+import android.tools.testutils.getWmDumpReaderFromAsset
+import android.tools.testutils.getWmTraceReaderFromAsset
+import android.tools.testutils.newEmptyRootContainer
 import android.tools.traces.component.ComponentNameMatcher
 import android.tools.traces.wm.KeyguardControllerState
 import android.tools.traces.wm.WindowManagerState
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TestComponents
-import android.tools.utils.assertFail
-import android.tools.utils.assertThatErrorContainsDebugInfo
-import android.tools.utils.assertThrows
-import android.tools.utils.getWmDumpReaderFromAsset
-import android.tools.utils.getWmTraceReaderFromAsset
-import android.tools.utils.newEmptyRootContainer
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
@@ -42,7 +42,7 @@ import org.junit.runners.MethodSorters
  */
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
 class WindowManagerStateSubjectTest {
-    private val reader = getWmTraceReaderFromAsset("wm_trace_openchrome.pb", legacyTrace = true)
+    private val reader = getWmTraceReaderFromAsset("wm_trace_openchrome", legacyTrace = true)
     private val trace
         get() = reader.readWmTrace() ?: error("Unable to read WM trace")
 
@@ -235,7 +235,7 @@ class WindowManagerStateSubjectTest {
     @Test
     fun canDetectAppWindowVisibilitySubject() {
         val reader =
-            getWmTraceReaderFromAsset("wm_trace_launcher_visible_background.pb", legacyTrace = true)
+            getWmTraceReaderFromAsset("wm_trace_launcher_visible_background", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val firstEntry = WindowManagerTraceSubject(trace, reader).first()
         val appWindowNames = firstEntry.wmState.appWindows.map { it.name }
@@ -252,7 +252,7 @@ class WindowManagerStateSubjectTest {
     @Test
     fun canDetectLauncherVisibility() {
         val reader =
-            getWmTraceReaderFromAsset("wm_trace_launcher_visible_background.pb", legacyTrace = true)
+            getWmTraceReaderFromAsset("wm_trace_launcher_visible_background", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val subject = WindowManagerTraceSubject(trace, reader)
         val firstTrace = subject.first()
@@ -311,7 +311,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectActivityVisibility() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_split_screen.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_split_screen", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val lastEntry = WindowManagerTraceSubject(trace, reader).last()
         lastEntry.isAppWindowVisible(TestComponents.SHELL_SPLIT_SCREEN_PRIMARY)
@@ -352,7 +352,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectNoVisibleAppWindows() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_unlock.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_unlock", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val firstEntry = WindowManagerTraceSubject(trace, reader).first()
         firstEntry.hasNoVisibleAppWindow()
@@ -360,7 +360,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectHasVisibleAppWindows() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_unlock.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_unlock", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val lastEntry = WindowManagerTraceSubject(trace, reader).last()
         assertFail("Visible app windows") { lastEntry.hasNoVisibleAppWindow() }
@@ -369,7 +369,7 @@ class WindowManagerStateSubjectTest {
     @Test
     fun canDetectTaskFragment() {
         // Verify if parser can read a dump file with 2 TaskFragments showed side-by-side.
-        val reader = getWmDumpReaderFromAsset("wm_trace_taskfragment.winscope")
+        val reader = getWmDumpReaderFromAsset("wm_trace_taskfragment")
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         // There's only one entry in dump file.
         val entry = WindowManagerTraceSubject(trace, reader).first()
@@ -379,7 +379,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectIsHomeActivityVisibleTablet() {
-        val reader = getWmDumpReaderFromAsset("tablet/wm_dump_home_screen.winscope")
+        val reader = getWmDumpReaderFromAsset("tablet/wm_dump_home_screen")
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         // There's only one entry in dump file.
         val entry = WindowManagerTraceSubject(trace, reader).first()
@@ -391,7 +391,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectTaskBarIsVisible() {
-        val reader = getWmDumpReaderFromAsset("tablet/wm_dump_home_screen.winscope")
+        val reader = getWmDumpReaderFromAsset("tablet/wm_dump_home_screen")
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         // There's only one entry in dump file.
         val entry = WindowManagerTraceSubject(trace, reader).first()
@@ -401,8 +401,7 @@ class WindowManagerStateSubjectTest {
 
     @Test
     fun canDetectWindowVisibilityWhen2WindowsHaveSameName() {
-        val reader =
-            getWmTraceReaderFromAsset("wm_trace_2activities_same_name.winscope", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_2activities_same_name", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val componentMatcher =
             ComponentNameMatcher(
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerTraceSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerTraceSubjectTest.kt
index b656f096e..74fc7a93c 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerTraceSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowManagerTraceSubjectTest.kt
@@ -18,11 +18,11 @@ package android.tools.flicker.subject.wm
 
 import android.tools.Cache
 import android.tools.CleanFlickerEnvironmentRuleWithDataStore
+import android.tools.testutils.TestComponents
+import android.tools.testutils.assertThatErrorContainsDebugInfo
+import android.tools.testutils.assertThrows
+import android.tools.testutils.getWmTraceReaderFromAsset
 import android.tools.traces.component.ComponentNameMatcher
-import android.tools.utils.TestComponents
-import android.tools.utils.assertThatErrorContainsDebugInfo
-import android.tools.utils.assertThrows
-import android.tools.utils.getWmTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
@@ -37,10 +37,11 @@ import org.junit.runners.MethodSorters
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
 class WindowManagerTraceSubjectTest {
     private val chromeTraceReader =
-        getWmTraceReaderFromAsset("wm_trace_openchrome.pb", legacyTrace = true)
+        getWmTraceReaderFromAsset("wm_trace_openchrome", legacyTrace = true)
     private val chromeTrace
         get() = chromeTraceReader.readWmTrace() ?: error("Unable to read WM trace")
-    private val imeTraceReader = getWmTraceReaderFromAsset("wm_trace_ime.pb", legacyTrace = true)
+
+    private val imeTraceReader = getWmTraceReaderFromAsset("wm_trace_ime", legacyTrace = true)
     private val imeTrace = imeTraceReader.readWmTrace() ?: error("Unable to read WM trace")
 
     @Before
@@ -86,7 +87,7 @@ class WindowManagerTraceSubjectTest {
 
     @Test
     fun testCanDetectTransitionWithOptionalValue() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_open_from_overview.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_from_overview", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val subject = WindowManagerTraceSubject(trace, reader)
         subject
@@ -175,7 +176,7 @@ class WindowManagerTraceSubjectTest {
 
     @Test
     fun testCanTransitionBelowAppWindow() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         WindowManagerTraceSubject(trace, reader)
             .skipUntilFirstAssertion()
@@ -187,8 +188,7 @@ class WindowManagerTraceSubjectTest {
 
     @Test
     fun testCanDetectVisibleWindowsMoreThanOneConsecutiveEntry() {
-        val reader =
-            getWmTraceReaderFromAsset("wm_trace_valid_visible_windows.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_valid_visible_windows", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         WindowManagerTraceSubject(trace, reader)
             .visibleWindowsShownMoreThanOneConsecutiveEntry()
@@ -227,7 +227,7 @@ class WindowManagerTraceSubjectTest {
     fun testCanDetectSnapshotStartingWindow() {
         val reader =
             getWmTraceReaderFromAsset(
-                "quick_switch_to_app_killed_in_background_trace.pb",
+                "quick_switch_to_app_killed_in_background_trace",
                 legacyTrace = true
             )
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
@@ -258,7 +258,7 @@ class WindowManagerTraceSubjectTest {
     fun canDetectAppInvisibleSnapshotStartingWindowVisible() {
         val reader =
             getWmTraceReaderFromAsset(
-                "quick_switch_to_app_killed_in_background_trace.pb",
+                "quick_switch_to_app_killed_in_background_trace",
                 legacyTrace = true
             )
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
@@ -275,8 +275,7 @@ class WindowManagerTraceSubjectTest {
 
     @Test
     fun canDetectAppVisibleTablet() {
-        val reader =
-            getWmTraceReaderFromAsset("tablet/wm_trace_open_chrome.winscope", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("tablet/wm_trace_open_chrome", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         WindowManagerTraceSubject(trace, reader)
             .isAppWindowVisible(TestComponents.CHROME)
@@ -285,8 +284,7 @@ class WindowManagerTraceSubjectTest {
 
     @Test
     fun canDetectAppOpenRecentsTablet() {
-        val reader =
-            getWmTraceReaderFromAsset("tablet/wm_trace_open_recents.winscope", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("tablet/wm_trace_open_recents", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         WindowManagerTraceSubject(trace, reader).isRecentsActivityVisible().forAllEntries()
     }
diff --git a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowStateSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowStateSubjectTest.kt
index 534026be1..c52684825 100644
--- a/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowStateSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/subject/wm/WindowStateSubjectTest.kt
@@ -17,9 +17,9 @@
 package android.tools.flicker.subject.wm
 
 import android.tools.Cache
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TestComponents
-import android.tools.utils.getWmTraceReaderFromAsset
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TestComponents
+import android.tools.testutils.getWmTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
@@ -33,7 +33,7 @@ class WindowStateSubjectTest {
 
     @Test
     fun exceptionContainsDebugInfoImaginary() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_openchrome.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_openchrome", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val foundWindow =
             WindowManagerTraceSubject(trace, reader)
diff --git a/libraries/flicker/test/src/android/tools/flicker/surfaceflinger/LayerTraceSubjectTest.kt b/libraries/flicker/test/src/android/tools/flicker/surfaceflinger/LayerTraceSubjectTest.kt
index fcb67ba08..b4495f69e 100644
--- a/libraries/flicker/test/src/android/tools/flicker/surfaceflinger/LayerTraceSubjectTest.kt
+++ b/libraries/flicker/test/src/android/tools/flicker/surfaceflinger/LayerTraceSubjectTest.kt
@@ -17,9 +17,9 @@
 package android.tools.flicker.surfaceflinger
 
 import android.tools.flicker.subject.layers.LayersTraceSubject
-import android.tools.utils.assertThatErrorContainsDebugInfo
-import android.tools.utils.assertThrows
-import android.tools.utils.getLayerTraceReaderFromAsset
+import android.tools.testutils.assertThatErrorContainsDebugInfo
+import android.tools.testutils.assertThrows
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import org.junit.Test
 
 class LayerTraceSubjectTest {
diff --git a/libraries/flicker/test/src/android/tools/integration/AssertionErrorTest.kt b/libraries/flicker/test/src/android/tools/integration/AssertionErrorTest.kt
index 5562e4705..3324b9f40 100644
--- a/libraries/flicker/test/src/android/tools/integration/AssertionErrorTest.kt
+++ b/libraries/flicker/test/src/android/tools/integration/AssertionErrorTest.kt
@@ -16,13 +16,13 @@
 
 package android.tools.integration
 
-import android.tools.flicker.datastore.CachedResultReader
 import android.tools.flicker.legacy.LegacyFlickerTest
 import android.tools.flicker.subject.exceptions.SimpleFlickerAssertionError
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
+import androidx.test.filters.FlakyTest
 import com.google.common.truth.Truth
 import java.io.File
 import org.junit.Before
@@ -35,6 +35,7 @@ import org.junit.Test
  *
  * To run this test: `atest FlickerLibTest:AssertionErrorTest`
  */
+@FlakyTest(bugId = 362942901)
 class AssertionErrorTest {
     private var assertionExecuted = false
     private val testParam = LegacyFlickerTest().also { it.initialize(TEST_SCENARIO.testClass) }
@@ -55,7 +56,7 @@ class AssertionErrorTest {
         val result = runCatching {
             testParam.assertLayers {
                 assertionExecuted = true
-                throw SimpleFlickerAssertionError(Utils.FAILURE)
+                throw SimpleFlickerAssertionError(TestUtils.FAILURE)
             }
         }
 
@@ -64,7 +65,7 @@ class AssertionErrorTest {
         Truth.assertWithMessage("Expected exception")
             .that(result.exceptionOrNull())
             .hasMessageThat()
-            .contains(Utils.FAILURE)
+            .contains(TestUtils.FAILURE)
         val reader =
             android.tools.flicker.datastore.CachedResultReader(
                 TEST_SCENARIO,
@@ -88,9 +89,10 @@ class AssertionErrorTest {
 
     companion object {
         private var transitionExecuted = false
+
         @BeforeClass
         @JvmStatic
-        fun runTransition() = Utils.runTransition { transitionExecuted = true }
+        fun runTransition() = TestUtils.runTransition { transitionExecuted = true }
 
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/test/src/android/tools/integration/FlickerServiceTracesCollectorTest.kt b/libraries/flicker/test/src/android/tools/integration/FlickerServiceTracesCollectorTest.kt
index d2cc7552b..a14682cc9 100644
--- a/libraries/flicker/test/src/android/tools/integration/FlickerServiceTracesCollectorTest.kt
+++ b/libraries/flicker/test/src/android/tools/integration/FlickerServiceTracesCollectorTest.kt
@@ -22,12 +22,12 @@ import android.tools.flicker.FlickerServiceTracesCollector
 import android.tools.flicker.isShellTransitionsEnabled
 import android.tools.flicker.rules.ArtifactSaverRule
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.assertArchiveContainsFiles
+import android.tools.testutils.getLauncherPackageName
+import android.tools.testutils.getSystemUiUidName
 import android.tools.traces.parsers.WindowManagerStateHelper
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.assertArchiveContainsFiles
-import android.tools.utils.getLauncherPackageName
-import android.tools.utils.getSystemUiUidName
 import androidx.test.platform.app.InstrumentationRegistry
 import com.android.systemui.Flags.enableViewCaptureTracing
 import com.google.common.truth.Truth
@@ -115,70 +115,67 @@ class FlickerServiceTracesCollectorTest {
 
     companion object {
         val EXPECTED_TRACES_LAUNCHER_ONLY =
-            if (android.tracing.Flags.perfettoTransitionTracing()) {
-                listOf(
-                    TraceType.WM.fileName,
-                    TraceType.PROTOLOG.fileName,
+            mutableListOf(
                     TraceType.EVENT_LOG.fileName,
                     TraceType.PERFETTO.fileName,
-                    "${getLauncherPackageName()}_0.vc__view_capture_trace.winscope",
                 )
-            } else {
-                listOf(
-                    TraceType.WM.fileName,
-                    TraceType.PROTOLOG.fileName,
-                    TraceType.LEGACY_WM_TRANSITION.fileName,
-                    TraceType.LEGACY_SHELL_TRANSITION.fileName,
-                    TraceType.EVENT_LOG.fileName,
-                    TraceType.PERFETTO.fileName,
-                    "${getLauncherPackageName()}_0.vc__view_capture_trace.winscope",
-                )
-            }
+                .also {
+                    if (!android.tracing.Flags.perfettoProtologTracing()) {
+                        it.add(TraceType.PROTOLOG.fileName)
+                    }
+
+                    if (!android.tracing.Flags.perfettoTransitionTracing()) {
+                        it.add(TraceType.LEGACY_WM_TRANSITION.fileName)
+                        it.add(TraceType.LEGACY_SHELL_TRANSITION.fileName)
+                    }
+
+                    if (!android.tracing.Flags.perfettoViewCaptureTracing()) {
+                        it.add("${getLauncherPackageName()}_0.vc__view_capture_trace.winscope")
+                    }
+
+                    if (!android.tracing.Flags.perfettoWmTracing()) {
+                        it.add(TraceType.WM.fileName)
+                    }
+                }
+                .toList()
 
         val EXPECTED_TRACES_LAUNCHER_FIRST =
-            if (android.tracing.Flags.perfettoTransitionTracing()) {
-                listOf(
-                    TraceType.WM.fileName,
-                    TraceType.PROTOLOG.fileName,
-                    TraceType.EVENT_LOG.fileName,
-                    TraceType.PERFETTO.fileName,
-                    "${getLauncherPackageName()}_0.vc__view_capture_trace.winscope",
-                    "${getSystemUiUidName()}_1.vc__view_capture_trace.winscope",
-                )
-            } else {
-                listOf(
+            mutableListOf(
                     TraceType.WM.fileName,
                     TraceType.PROTOLOG.fileName,
-                    TraceType.LEGACY_WM_TRANSITION.fileName,
-                    TraceType.LEGACY_SHELL_TRANSITION.fileName,
                     TraceType.EVENT_LOG.fileName,
                     TraceType.PERFETTO.fileName,
-                    "${getLauncherPackageName()}_0.vc__view_capture_trace.winscope",
-                    "${getSystemUiUidName()}_1.vc__view_capture_trace.winscope",
                 )
-            }
+                .also {
+                    if (!android.tracing.Flags.perfettoTransitionTracing()) {
+                        it.add(TraceType.LEGACY_WM_TRANSITION.fileName)
+                        it.add(TraceType.LEGACY_SHELL_TRANSITION.fileName)
+                    }
+
+                    if (!android.tracing.Flags.perfettoViewCaptureTracing()) {
+                        it.add("${getLauncherPackageName()}_0.vc__view_capture_trace.winscope")
+                        it.add("${getSystemUiUidName()}_1.vc__view_capture_trace.winscope")
+                    }
+                }
+                .toList()
 
         val EXPECTED_TRACES_SYSUI_FIRST =
-            if (android.tracing.Flags.perfettoTransitionTracing()) {
-                listOf(
+            mutableListOf(
                     TraceType.WM.fileName,
                     TraceType.PROTOLOG.fileName,
                     TraceType.EVENT_LOG.fileName,
                     TraceType.PERFETTO.fileName,
-                    "${getSystemUiUidName()}_0.vc__view_capture_trace.winscope",
-                    "${getLauncherPackageName()}_1.vc__view_capture_trace.winscope",
                 )
-            } else {
-                listOf(
-                    TraceType.WM.fileName,
-                    TraceType.PROTOLOG.fileName,
-                    TraceType.LEGACY_WM_TRANSITION.fileName,
-                    TraceType.LEGACY_SHELL_TRANSITION.fileName,
-                    TraceType.EVENT_LOG.fileName,
-                    TraceType.PERFETTO.fileName,
-                    "${getSystemUiUidName()}_0.vc__view_capture_trace.winscope",
-                    "${getLauncherPackageName()}_1.vc__view_capture_trace.winscope",
-                )
-            }
+                .also {
+                    if (!android.tracing.Flags.perfettoTransitionTracing()) {
+                        it.add(TraceType.LEGACY_WM_TRANSITION.fileName)
+                        it.add(TraceType.LEGACY_SHELL_TRANSITION.fileName)
+                    }
+
+                    if (!android.tracing.Flags.perfettoViewCaptureTracing()) {
+                        it.add("${getSystemUiUidName()}_0.vc__view_capture_trace.winscope")
+                        it.add("${getLauncherPackageName()}_1.vc__view_capture_trace.winscope")
+                    }
+                }
     }
 }
diff --git a/libraries/flicker/test/src/android/tools/integration/FullLegacyTestRun.kt b/libraries/flicker/test/src/android/tools/integration/FullLegacyRunTest.kt
similarity index 99%
rename from libraries/flicker/test/src/android/tools/integration/FullLegacyTestRun.kt
rename to libraries/flicker/test/src/android/tools/integration/FullLegacyRunTest.kt
index da8453774..6cc2419c1 100644
--- a/libraries/flicker/test/src/android/tools/integration/FullLegacyTestRun.kt
+++ b/libraries/flicker/test/src/android/tools/integration/FullLegacyRunTest.kt
@@ -43,7 +43,7 @@ import org.junit.runners.Parameterized
 @FlickerServiceCompatible(expectedCujs = ["ENTIRE_TRACE"])
 @RunWith(Parameterized::class)
 @Parameterized.UseParametersRunnerFactory(FlickerParametersRunnerFactory::class)
-class FullLegacyTestRun(private val flicker: LegacyFlickerTest) {
+class FullLegacyRunTest(private val flicker: LegacyFlickerTest) {
     private val instrumentation: Instrumentation = InstrumentationRegistry.getInstrumentation()
     private val testApp = MessagingAppHelper(instrumentation)
     private val tapl: LauncherInstrumentation = LauncherInstrumentation()
diff --git a/libraries/flicker/test/src/android/tools/integration/FullTestRun.kt b/libraries/flicker/test/src/android/tools/integration/FullServiceRunTest.kt
similarity index 99%
rename from libraries/flicker/test/src/android/tools/integration/FullTestRun.kt
rename to libraries/flicker/test/src/android/tools/integration/FullServiceRunTest.kt
index 44e43f5a4..4429d63f5 100644
--- a/libraries/flicker/test/src/android/tools/integration/FullTestRun.kt
+++ b/libraries/flicker/test/src/android/tools/integration/FullServiceRunTest.kt
@@ -48,7 +48,7 @@ import org.junit.Test
 import org.junit.runner.RunWith
 
 @RunWith(FlickerServiceJUnit4ClassRunner::class)
-class FullTestRun {
+class FullServiceRunTest {
     private val instrumentation: Instrumentation = InstrumentationRegistry.getInstrumentation()
     private val wmHelper = WindowManagerStateHelper(instrumentation)
     private val testApp = MessagingAppHelper(instrumentation)
diff --git a/libraries/flicker/test/src/android/tools/integration/NoErrorTest.kt b/libraries/flicker/test/src/android/tools/integration/NoErrorTest.kt
index 09d8a3f2b..4f50e6b22 100644
--- a/libraries/flicker/test/src/android/tools/integration/NoErrorTest.kt
+++ b/libraries/flicker/test/src/android/tools/integration/NoErrorTest.kt
@@ -16,12 +16,12 @@
 
 package android.tools.integration
 
-import android.tools.flicker.datastore.CachedResultReader
 import android.tools.flicker.legacy.LegacyFlickerTest
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
+import androidx.test.filters.FlakyTest
 import com.google.common.truth.Truth
 import java.io.File
 import org.junit.Before
@@ -40,6 +40,7 @@ import org.mockito.junit.MockitoJUnitRunner
  */
 @RunWith(MockitoJUnitRunner::class)
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
+@FlakyTest(bugId = 362942901)
 class NoErrorTest {
     private var assertionExecuted = false
     private val testParam = LegacyFlickerTest().also { it.initialize(TEST_SCENARIO.testClass) }
@@ -62,11 +63,13 @@ class NoErrorTest {
                 require(
                     this.subjects.none {
                         it.wmState
-                            .getActivitiesForWindow(Utils.setupAndTearDownTestApp.componentMatcher)
+                            .getActivitiesForWindow(
+                                TestUtils.setupAndTearDownTestApp.componentMatcher
+                            )
                             .isNotEmpty()
                     }
                 ) {
-                    "${Utils.setupAndTearDownTestApp.appName} window existed at some point " +
+                    "${TestUtils.setupAndTearDownTestApp.appName} window existed at some point " +
                         "but shouldn't have."
                 }
             }
@@ -81,11 +84,11 @@ class NoErrorTest {
                 require(
                     this.subjects.any {
                         it.wmState
-                            .getActivitiesForWindow(Utils.transitionTestApp.componentMatcher)
+                            .getActivitiesForWindow(TestUtils.transitionTestApp.componentMatcher)
                             .isNotEmpty()
                     }
                 ) {
-                    "${Utils.transitionTestApp.appName} window didn't exist at any point " +
+                    "${TestUtils.transitionTestApp.appName} window didn't exist at any point " +
                         "but should have."
                 }
             }
@@ -99,23 +102,23 @@ class NoErrorTest {
                 assertionExecuted = true
                 require(
                     this.subjects.none {
-                        Utils.setupAndTearDownTestApp.componentMatcher.layerMatchesAnyOf(
+                        TestUtils.setupAndTearDownTestApp.componentMatcher.layerMatchesAnyOf(
                             it.entry.flattenedLayers.filter { layer -> layer.isVisible }
                         )
                     }
                 ) {
-                    "${Utils.setupAndTearDownTestApp.appName} layer was visible at some point " +
-                        "but shouldn't have."
+                    "${TestUtils.setupAndTearDownTestApp.appName} layer was visible at some " +
+                        "point but shouldn't have."
                 }
 
                 require(
                     this.subjects.none {
-                        Utils.setupAndTearDownTestApp.componentMatcher.layerMatchesAnyOf(
+                        TestUtils.setupAndTearDownTestApp.componentMatcher.layerMatchesAnyOf(
                             it.entry.flattenedLayers
                         )
                     }
                 ) {
-                    "${Utils.setupAndTearDownTestApp.appName} layer existed at some point " +
+                    "${TestUtils.setupAndTearDownTestApp.appName} layer existed at some point " +
                         "but shouldn't have."
                 }
             }
@@ -129,12 +132,12 @@ class NoErrorTest {
                 assertionExecuted = true
                 require(
                     this.subjects.any {
-                        Utils.transitionTestApp.componentMatcher.layerMatchesAnyOf(
+                        TestUtils.transitionTestApp.componentMatcher.layerMatchesAnyOf(
                             it.entry.flattenedLayers
                         )
                     }
                 ) {
-                    "${Utils.transitionTestApp.appName} layer didn't exist at any point " +
+                    "${TestUtils.transitionTestApp.appName} layer didn't exist at any point " +
                         "but should have."
                 }
             }
@@ -184,7 +187,7 @@ class NoErrorTest {
     @Test
     fun assertTagStateLayersIsNotEmpty() {
         assertPredicatePasses {
-            testParam.assertLayersTag(Utils.TAG) {
+            testParam.assertLayersTag(TestUtils.TAG) {
                 assertionExecuted = true
                 isNotEmpty()
             }
@@ -194,7 +197,7 @@ class NoErrorTest {
     @Test
     fun assertTagStateWmIsNotEmpty() {
         assertPredicatePasses {
-            testParam.assertWmTag(Utils.TAG) {
+            testParam.assertWmTag(TestUtils.TAG) {
                 assertionExecuted = true
                 isNotEmpty()
             }
@@ -232,9 +235,10 @@ class NoErrorTest {
 
     companion object {
         private var transitionExecuted = false
+
         @BeforeClass
         @JvmStatic
-        fun runTransition() = Utils.runTransition { transitionExecuted = true }
+        fun runTransition() = TestUtils.runTransition { transitionExecuted = true }
 
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/test/src/android/tools/integration/Utils.kt b/libraries/flicker/test/src/android/tools/integration/TestUtils.kt
similarity index 96%
rename from libraries/flicker/test/src/android/tools/integration/Utils.kt
rename to libraries/flicker/test/src/android/tools/integration/TestUtils.kt
index c6a25a9eb..62f31c1f4 100644
--- a/libraries/flicker/test/src/android/tools/integration/Utils.kt
+++ b/libraries/flicker/test/src/android/tools/integration/TestUtils.kt
@@ -20,15 +20,14 @@ import android.annotation.SuppressLint
 import android.app.Instrumentation
 import android.tools.device.apphelpers.BrowserAppHelper
 import android.tools.device.apphelpers.MessagingAppHelper
-import android.tools.flicker.datastore.DataStore
 import android.tools.flicker.legacy.FlickerBuilder
 import android.tools.flicker.legacy.runner.TransitionRunner
-import android.tools.utils.TEST_SCENARIO
+import android.tools.testutils.TEST_SCENARIO
 import androidx.test.platform.app.InstrumentationRegistry
 import org.junit.runner.Description
 
 @SuppressLint("VisibleForTests")
-object Utils {
+object TestUtils {
     private val instrumentation: Instrumentation = InstrumentationRegistry.getInstrumentation()
     internal const val TAG = "tag"
     internal const val FAILURE = "Expected failure"
diff --git a/libraries/flicker/test/src/android/tools/integration/TransitionErrorTest.kt b/libraries/flicker/test/src/android/tools/integration/TransitionErrorTest.kt
index 31e0b2639..4a1f94b3b 100644
--- a/libraries/flicker/test/src/android/tools/integration/TransitionErrorTest.kt
+++ b/libraries/flicker/test/src/android/tools/integration/TransitionErrorTest.kt
@@ -16,12 +16,11 @@
 
 package android.tools.integration
 
-import android.tools.flicker.datastore.CachedResultReader
 import android.tools.flicker.legacy.LegacyFlickerTest
 import android.tools.io.RunStatus
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
 import com.google.common.truth.Truth
 import java.io.File
 import org.junit.Before
@@ -67,7 +66,7 @@ class TransitionErrorTest {
             Truth.assertWithMessage("Expected exception")
                 .that(result.exceptionOrNull())
                 .hasMessageThat()
-                .contains(Utils.FAILURE)
+                .contains(TestUtils.FAILURE)
         }
         val reader =
             android.tools.flicker.datastore.CachedResultReader(
@@ -91,7 +90,9 @@ class TransitionErrorTest {
     companion object {
         private const val WRONG_EXCEPTION = "Wrong exception"
 
-        @BeforeClass @JvmStatic fun runTransition() = Utils.runTransition { error(Utils.FAILURE) }
+        @BeforeClass
+        @JvmStatic
+        fun runTransition() = TestUtils.runTransition { error(TestUtils.FAILURE) }
 
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/test/src/android/tools/rules/DataStoreCleanupRule.kt b/libraries/flicker/test/src/android/tools/testrules/DataStoreCleanupRule.kt
similarity index 95%
rename from libraries/flicker/test/src/android/tools/rules/DataStoreCleanupRule.kt
rename to libraries/flicker/test/src/android/tools/testrules/DataStoreCleanupRule.kt
index 5cec73f9e..b1e80bfcd 100644
--- a/libraries/flicker/test/src/android/tools/rules/DataStoreCleanupRule.kt
+++ b/libraries/flicker/test/src/android/tools/testrules/DataStoreCleanupRule.kt
@@ -14,11 +14,11 @@
  * limitations under the License.
  */
 
-package android.tools.rules
+package android.tools.testrules
 
 import android.annotation.SuppressLint
 import android.tools.flicker.datastore.DataStore
-import android.tools.utils.TEST_SCENARIO
+import android.tools.testutils.TEST_SCENARIO
 import org.junit.rules.TestWatcher
 import org.junit.runner.Description
 
diff --git a/libraries/flicker/utils/Android.bp b/libraries/flicker/utils/Android.bp
index 0cabc1af5..ecd3a65ac 100644
--- a/libraries/flicker/utils/Android.bp
+++ b/libraries/flicker/utils/Android.bp
@@ -53,7 +53,7 @@ java_library {
         "src/android/tools/**/*.kt",
     ],
     exclude_srcs: [
-        ":flickerlib-helpers-src",    
+        ":flickerlib-helpers-src",
     ],
     static_libs: [
         "androidx.benchmark_benchmark-macro",
@@ -62,5 +62,6 @@ java_library {
         "platformprotosnano",
         "//frameworks/libs/systemui:view_capture_proto",
         "WindowManager-Shell-proto",
+        "com_android_wm_shell_flags_lib",
     ],
 }
diff --git a/libraries/flicker/utils/src/android/tools/PlatformConsts.kt b/libraries/flicker/utils/src/android/tools/PlatformConsts.kt
index b5e3cb55b..6bd3a5fa2 100644
--- a/libraries/flicker/utils/src/android/tools/PlatformConsts.kt
+++ b/libraries/flicker/utils/src/android/tools/PlatformConsts.kt
@@ -90,6 +90,8 @@ object PlatformConsts {
     const val STATE_PAUSED = "PAUSED"
     const val STATE_STOPPED = "STOPPED"
     const val STATE_DESTROYED = "DESTROYED"
+    const val DESKTOP_MODE_MINIMUM_WINDOW_WIDTH = 386
+    const val DESKTOP_MODE_MINIMUM_WINDOW_HEIGHT = 352
     internal const val APP_STATE_IDLE = "APP_STATE_IDLE"
     internal const val ACTIVITY_TYPE_UNDEFINED = 0
     internal const val ACTIVITY_TYPE_STANDARD = 1
@@ -129,4 +131,6 @@ object PlatformConsts {
     internal const val DEBUGGER_WINDOW_PREFIX = "Waiting For Debugger: "
 
     const val SPLIT_SCREEN_TRANSITION_HANDLER = "com.android.wm.shell.splitscreen.StageCoordinator"
+
+    const val DESKTOP_MODE_INITIAL_WINDOW_HEIGHT_PROPORTION = 0.375
 }
diff --git a/libraries/flicker/utils/src/android/tools/Rotation.kt b/libraries/flicker/utils/src/android/tools/Rotation.kt
index 0a08b1fba..af705a3dc 100644
--- a/libraries/flicker/utils/src/android/tools/Rotation.kt
+++ b/libraries/flicker/utils/src/android/tools/Rotation.kt
@@ -30,6 +30,9 @@ enum class Rotation(val description: String, val value: Int) {
 
     companion object {
         private val VALUES = values()
+
         fun getByValue(value: Int) = if (value == -1) ROTATION_0 else VALUES[value]
+
+        fun getByName(name: String?): Rotation? = Rotation.values().find { it.name == name }
     }
 }
diff --git a/libraries/flicker/utils/src/android/tools/helpers/WindowUtils.kt b/libraries/flicker/utils/src/android/tools/helpers/WindowUtils.kt
index 4f376cd1a..1be9d0236 100644
--- a/libraries/flicker/utils/src/android/tools/helpers/WindowUtils.kt
+++ b/libraries/flicker/utils/src/android/tools/helpers/WindowUtils.kt
@@ -23,8 +23,12 @@ import android.tools.Rotation
 import android.tools.traces.getCurrentStateDump
 import android.tools.traces.surfaceflinger.Display
 import android.tools.traces.wm.DisplayContent
+import android.tools.traces.wm.InsetsSource
 import android.util.LruCache
+import android.view.WindowInsets
 import androidx.test.platform.app.InstrumentationRegistry
+import kotlin.math.max
+import kotlin.math.min
 
 object WindowUtils {
 
@@ -32,10 +36,10 @@ object WindowUtils {
     private val instrumentation = InstrumentationRegistry.getInstrumentation()
 
     /** Helper functions to retrieve system window sizes and positions. */
-    private val context = instrumentation.context
+    private val context by lazy { instrumentation.context }
 
     private val resources
-        get() = context.getResources()
+        get() = context.resources
 
     /** Get the display bounds */
     val displayBounds: Rect
@@ -44,11 +48,16 @@ object WindowUtils {
             return currState.layerState.physicalDisplay?.layerStackSpace ?: Rect()
         }
 
+    val displayStableBounds: Rect
+        get() {
+            val currState = getCurrentStateDump(clearCacheAfterParsing = false)
+            return currState.wmState.getDefaultDisplay()?.stableBounds ?: Rect()
+        }
+
     /** Gets the current display rotation */
     val displayRotation: Rotation
         get() {
             val currState = getCurrentStateDump(clearCacheAfterParsing = false)
-
             return currState.wmState.getRotation(PlatformConsts.DEFAULT_DISPLAY)
         }
 
@@ -77,6 +86,29 @@ object WindowUtils {
             }
     }
 
+    fun getInsetDisplayBounds(): Rect {
+        val currState = getCurrentStateDump(clearCacheAfterParsing = false)
+        val display = currState.wmState.getDefaultDisplay() ?: error("Missing physical display")
+
+        val insetDisplayBounds = Rect(display.displayRect)
+        display.insetsSourceProviders.forEach {
+            val insetsSource: InsetsSource = it.source ?: return@forEach
+            val insets: Rect = it.frame ?: return@forEach
+            if (!insetsSource.visible) return@forEach
+
+            when (insetsSource.type) {
+                WindowInsets.Type.statusBars() -> {
+                    insetDisplayBounds.top = max(insetDisplayBounds.top, insets.bottom)
+                }
+                WindowInsets.Type.navigationBars() -> {
+                    insetDisplayBounds.bottom = min(insetDisplayBounds.bottom, insets.top)
+                }
+            }
+        }
+
+        return insetDisplayBounds
+    }
+
     /** Gets the status bar height with a specific display cutout. */
     private fun getExpectedStatusBarHeight(displayContent: DisplayContent): Int {
         val cutout = displayContent.cutout
diff --git a/libraries/flicker/utils/src/android/tools/traces/ConditionsFactory.kt b/libraries/flicker/utils/src/android/tools/traces/ConditionsFactory.kt
index 149eb4298..3ea36e039 100644
--- a/libraries/flicker/utils/src/android/tools/traces/ConditionsFactory.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/ConditionsFactory.kt
@@ -27,6 +27,8 @@ import android.tools.traces.surfaceflinger.Transform.Companion.isFlagSet
 import android.tools.traces.wm.WindowManagerState
 import android.tools.traces.wm.WindowState
 
+import com.android.wm.shell.Flags
+
 object ConditionsFactory {
 
     /** Check if this is a phone device instead of a folded foldable. */
@@ -45,7 +47,7 @@ object ConditionsFactory {
 
     fun getNavBarComponent(wmState: WindowManagerState): IComponentMatcher {
         var component: IComponentMatcher = ComponentNameMatcher.NAV_BAR
-        if (wmState.isTablet || !isPhoneNavBar()) {
+        if (wmState.isTablet || !isPhoneNavBar() || Flags.enableTaskbarOnPhones()) {
             component = component.or(ComponentNameMatcher.TASK_BAR)
         }
         return component
diff --git a/libraries/flicker/utils/src/android/tools/traces/Utils.kt b/libraries/flicker/utils/src/android/tools/traces/Utils.kt
index f0c3220d7..deb9e10b3 100644
--- a/libraries/flicker/utils/src/android/tools/traces/Utils.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/Utils.kt
@@ -21,6 +21,8 @@ package android.tools.traces
 import android.app.UiAutomation
 import android.os.IBinder
 import android.os.ParcelFileDescriptor
+import android.os.Process
+import android.os.SystemClock
 import android.tools.MILLISECOND_AS_NANOSECONDS
 import android.tools.io.TraceType
 import android.tools.traces.monitors.PerfettoTraceMonitor
@@ -29,10 +31,13 @@ import android.tools.traces.surfaceflinger.LayerTraceEntry
 import android.tools.traces.wm.WindowManagerState
 import android.util.Log
 import androidx.test.platform.app.InstrumentationRegistry
+import com.google.protobuf.InvalidProtocolBufferException
 import java.text.SimpleDateFormat
 import java.util.Date
 import java.util.Locale
+import java.util.Optional
 import java.util.TimeZone
+import perfetto.protos.PerfettoConfig.TracingServiceState
 
 fun formatRealTimestamp(timestampNs: Long): String {
     val timestampMs = timestampNs / MILLISECOND_AS_NANOSECONDS
@@ -54,6 +59,20 @@ fun executeShellCommand(cmd: String): ByteArray {
     }
 }
 
+fun executeShellCommand(cmd: String, stdin: ByteArray): ByteArray {
+    Log.d(LOG_TAG, "Executing shell command $cmd")
+    val uiAutomation: UiAutomation = InstrumentationRegistry.getInstrumentation().uiAutomation
+    val fileDescriptors = uiAutomation.executeShellCommandRw(cmd)
+    val stdoutFileDescriptor = fileDescriptors[0]
+    val stdinFileDescriptor = fileDescriptors[1]
+
+    ParcelFileDescriptor.AutoCloseOutputStream(stdinFileDescriptor).use { it.write(stdin) }
+
+    ParcelFileDescriptor.AutoCloseInputStream(stdoutFileDescriptor).use {
+        return it.readBytes()
+    }
+}
+
 private fun doBinderDump(name: String): ByteArray {
     // create an fd for the binder transaction
     val pipe = ParcelFileDescriptor.createPipe()
@@ -101,7 +120,11 @@ fun getCurrentState(
     Log.d(LOG_TAG, "Requesting new device state dump")
     val wmTraceData =
         if (dumpTypes.contains(TraceType.WM_DUMP)) {
-            getCurrentWindowManagerState()
+            if (android.tracing.Flags.perfettoWmDump()) {
+                PerfettoTraceMonitor.newBuilder().enableWindowManagerDump().build().withTracing {}
+            } else {
+                getCurrentWindowManagerState()
+            }
         } else {
             ByteArray(0)
         }
@@ -129,25 +152,75 @@ fun getCurrentState(
 @JvmOverloads
 fun getCurrentStateDumpNullable(
     vararg dumpTypes: TraceType = arrayOf(TraceType.SF_DUMP, TraceType.WM_DUMP),
-    clearCacheAfterParsing: Boolean = true
+    clearCacheAfterParsing: Boolean = true,
 ): NullableDeviceStateDump {
     val currentStateDump = getCurrentState(*dumpTypes)
     return DeviceDumpParser.fromNullableDump(
         currentStateDump.first,
         currentStateDump.second,
-        clearCacheAfterParsing = clearCacheAfterParsing
+        clearCacheAfterParsing = clearCacheAfterParsing,
     )
 }
 
 @JvmOverloads
 fun getCurrentStateDump(
     vararg dumpTypes: TraceType = arrayOf(TraceType.SF_DUMP, TraceType.WM_DUMP),
-    clearCacheAfterParsing: Boolean = true
+    clearCacheAfterParsing: Boolean = true,
 ): DeviceStateDump {
     val currentStateDump = getCurrentState(*dumpTypes)
     return DeviceDumpParser.fromDump(
         currentStateDump.first,
         currentStateDump.second,
-        clearCacheAfterParsing = clearCacheAfterParsing
+        clearCacheAfterParsing = clearCacheAfterParsing,
     )
 }
+
+@JvmOverloads
+fun busyWaitForDataSourceRegistration(
+    dataSourceName: String,
+    busyWaitIntervalMs: Long = 100,
+    timeoutMs: Long = 10000,
+) {
+    var elapsedMs = 0L
+
+    while (!isDataSourceAvailable(dataSourceName)) {
+        SystemClock.sleep(busyWaitIntervalMs)
+        elapsedMs += busyWaitIntervalMs
+        if (elapsedMs >= timeoutMs) {
+            throw java.lang.RuntimeException(
+                "Data source didn't become available. Waited for: $timeoutMs ms"
+            )
+        }
+    }
+}
+
+fun isDataSourceAvailable(dataSourceName: String): Boolean {
+    val proto = executeShellCommand("perfetto --query-raw")
+
+    try {
+        val state = TracingServiceState.parseFrom(proto)
+
+        var producerId = Optional.empty<Int>()
+
+        for (producer in state.producersList) {
+            if (producer.pid == Process.myPid()) {
+                producerId = Optional.of(producer.id)
+                break
+            }
+        }
+
+        if (!producerId.isPresent) {
+            return false
+        }
+
+        for (ds in state.dataSourcesList) {
+            if (ds.dsDescriptor.name.equals(dataSourceName) && ds.producerId == producerId.get()) {
+                return true
+            }
+        }
+    } catch (e: InvalidProtocolBufferException) {
+        throw RuntimeException(e)
+    }
+
+    return false
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/component/ComponentRegexMatcher.kt b/libraries/flicker/utils/src/android/tools/traces/component/ComponentRegexMatcher.kt
new file mode 100644
index 000000000..fdce49743
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/component/ComponentRegexMatcher.kt
@@ -0,0 +1,64 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.component
+
+import android.tools.traces.surfaceflinger.Layer
+import android.tools.traces.wm.Activity
+import android.tools.traces.wm.WindowContainer
+
+/** ComponentMatcher based on a regular expression for a name */
+data class ComponentRegexMatcher(
+    private val regex: Regex
+) : IComponentMatcher {
+
+    private val identifierDescription: String =
+        "Regular expression: $regex"
+
+    /** {@inheritDoc} */
+    override fun windowMatchesAnyOf(windows: Collection<WindowContainer>): Boolean =
+        windows.any { regex.matches(it.name) }
+
+    /** {@inheritDoc} */
+    override fun activityMatchesAnyOf(activities: Collection<Activity>): Boolean =
+        activities.any { regex.matches(it.name) }
+
+    /** {@inheritDoc} */
+    override fun layerMatchesAnyOf(layers: Collection<Layer>): Boolean =
+        layers.any { regex.matches(it.name) }
+
+    /** {@inheritDoc} */
+    override fun check(
+        layers: Collection<Layer>,
+        condition: (Collection<Layer>) -> Boolean
+    ): Boolean = condition(layers.filter { layerMatchesAnyOf(it) })
+
+    /** {@inheritDoc} */
+    override fun toActivityIdentifier(): String = identifierDescription
+
+    /** {@inheritDoc} */
+    override fun toWindowIdentifier(): String = identifierDescription
+
+    /** {@inheritDoc} */
+    override fun toLayerIdentifier(): String = identifierDescription
+
+    companion object {
+        val FOLD_OVERLAY_MATCHER =
+            ComponentRegexMatcher(
+                regex = "^fold-animation-overlay.*".toRegex()
+            )
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/events/Cuj.kt b/libraries/flicker/utils/src/android/tools/traces/events/Cuj.kt
index a6038eb4f..762b48228 100644
--- a/libraries/flicker/utils/src/android/tools/traces/events/Cuj.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/events/Cuj.kt
@@ -20,7 +20,7 @@ import android.tools.Timestamp
 import android.tools.TraceEntry
 
 data class Cuj(
-    val cuj: CujType,
+    val cuj: ICujType,
     val startTimestamp: Timestamp,
     val endTimestamp: Timestamp,
     val canceled: Boolean,
diff --git a/libraries/flicker/utils/src/android/tools/traces/events/CujEvent.kt b/libraries/flicker/utils/src/android/tools/traces/events/CujEvent.kt
index e2f75014c..b637b27f0 100644
--- a/libraries/flicker/utils/src/android/tools/traces/events/CujEvent.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/events/CujEvent.kt
@@ -26,7 +26,7 @@ import android.tools.Timestamps
  */
 class CujEvent(
     timestamp: Timestamp,
-    val cuj: CujType,
+    val cuj: ICujType,
     processId: Int,
     uid: String,
     threadId: Int,
@@ -70,7 +70,7 @@ class CujEvent(
             )
         }
 
-        private fun getCujMarkerFromData(data: String, cujType: Type): CujType {
+        private fun getCujMarkerFromData(data: String, cujType: Type): ICujType {
             val dataEntries = getDataEntries(data, cujType)
             val eventId = dataEntries.first().toInt()
             return CujType.from(eventId)
diff --git a/libraries/flicker/utils/src/android/tools/traces/events/CujType.kt b/libraries/flicker/utils/src/android/tools/traces/events/CujType.kt
index 648be0fae..df20a2336 100644
--- a/libraries/flicker/utils/src/android/tools/traces/events/CujType.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/events/CujType.kt
@@ -16,13 +16,22 @@
 
 package android.tools.traces.events
 
+interface ICujType {
+    val id: Int
+    val name: String
+}
+
+data class UnknownCuj(override val id: Int) : ICujType {
+    override val name: String = "UnknownCuj($id)"
+}
+
 /**
  * From com.android.internal.jank.InteractionJankMonitor.
  *
  * NOTE: Make sure order is the same as in {@see com.android.internal.jank.InteractionJankMonitor}.
  */
 // TODO: Can we re-use to enum generated from the proto stats/enums/jank/enums.proto?
-enum class CujType(val id: Int) {
+enum class CujType(override val id: Int) : ICujType {
     CUJ_NOTIFICATION_SHADE_EXPAND_COLLAPSE(0),
     CUJ_NOTIFICATION_SHADE_SCROLL_FLING(2),
     CUJ_NOTIFICATION_SHADE_ROW_EXPAND(3),
@@ -100,12 +109,38 @@ enum class CujType(val id: Int) {
     CUJ_SHADE_EXPAND_FROM_STATUS_BAR(79),
     CUJ_IME_INSETS_SHOW_ANIMATION(80),
     CUJ_IME_INSETS_HIDE_ANIMATION(81),
-
-    // KEEP AS LAST TYPE
-    // used to handle new types that haven't been added here yet but might be dumped by the platform
-    UNKNOWN(-1);
+    CUJ_SPLIT_SCREEN_DOUBLE_TAP_DIVIDER(82),
+    CUJ_LAUNCHER_UNFOLD_ANIM(83),
+    CUJ_PREDICTIVE_BACK_CROSS_ACTIVITY(84),
+    CUJ_PREDICTIVE_BACK_CROSS_TASK(85),
+    CUJ_PREDICTIVE_BACK_HOME(86),
+    // 87 is reserved - previously assigned to deprecated CUJ_LAUNCHER_SEARCH_QSB_OPEN.
+    CUJ_BACK_PANEL_ARROW(88),
+    CUJ_LAUNCHER_CLOSE_ALL_APPS_BACK(89),
+    CUJ_LAUNCHER_SEARCH_QSB_WEB_SEARCH(90),
+    CUJ_LAUNCHER_LAUNCH_APP_PAIR_FROM_WORKSPACE(91),
+    CUJ_LAUNCHER_LAUNCH_APP_PAIR_FROM_TASKBAR(92),
+    CUJ_LAUNCHER_SAVE_APP_PAIR(93),
+    CUJ_LAUNCHER_ALL_APPS_SEARCH_BACK(95),
+    CUJ_LAUNCHER_TASKBAR_ALL_APPS_CLOSE_BACK(96),
+    CUJ_LAUNCHER_TASKBAR_ALL_APPS_SEARCH_BACK(97),
+    CUJ_LAUNCHER_WIDGET_PICKER_CLOSE_BACK(98),
+    CUJ_LAUNCHER_WIDGET_PICKER_SEARCH_BACK(99),
+    CUJ_LAUNCHER_WIDGET_BOTTOM_SHEET_CLOSE_BACK(100),
+    CUJ_LAUNCHER_WIDGET_EDU_SHEET_CLOSE_BACK(101),
+    CUJ_LAUNCHER_PRIVATE_SPACE_LOCK(102),
+    CUJ_LAUNCHER_PRIVATE_SPACE_UNLOCK(103),
+    CUJ_DESKTOP_MODE_MAXIMIZE_WINDOW(104),
+    CUJ_FOLD_ANIM(105),
+    CUJ_DESKTOP_MODE_RESIZE_WINDOW(106),
+    CUJ_DESKTOP_MODE_ENTER_MODE(107),
+    CUJ_DESKTOP_MODE_EXIT_MODE(108),
+    CUJ_DESKTOP_MODE_MINIMIZE_WINDOW(109),
+    CUJ_DESKTOP_MODE_DRAG_WINDOW(110),
+    CUJ_DESKTOP_MODE_SNAP_RESIZE(118);
 
     companion object {
-        fun from(eventId: Int): CujType = values().firstOrNull { it.id == eventId } ?: UNKNOWN
+        fun from(eventId: Int): ICujType =
+            values().firstOrNull { it.id == eventId } ?: UnknownCuj(eventId)
     }
 }
diff --git a/libraries/flicker/utils/src/android/tools/traces/io/IoUtils.kt b/libraries/flicker/utils/src/android/tools/traces/io/IoUtils.kt
index 2911af0cf..4c5775b5d 100644
--- a/libraries/flicker/utils/src/android/tools/traces/io/IoUtils.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/io/IoUtils.kt
@@ -16,7 +16,6 @@
 
 package android.tools.traces.io
 
-import android.os.SystemClock
 import android.tools.traces.executeShellCommand
 import java.io.File
 import java.nio.file.Files
@@ -42,25 +41,6 @@ object IoUtils {
         executeShellCommand("rm $src")
     }
 
-    fun waitFileExists(file: File, timeoutMs: Long) {
-        val sleepIncrementMs = 50L
-        var elapsedMs = 0L
-
-        while (elapsedMs < timeoutMs) {
-            val out = String(executeShellCommand("ls $file")).trim()
-            val configFileInPerfettoDirExists = out == file.toString()
-
-            if (configFileInPerfettoDirExists) {
-                return
-            }
-
-            SystemClock.sleep(sleepIncrementMs)
-            elapsedMs += sleepIncrementMs
-        }
-
-        error("Failed to wait for file to exist: $file. Timed out after $timeoutMs ms.")
-    }
-
     private fun moveDirectory(src: File, dst: File) {
         require(src.isDirectory) { "$src is not a directory" }
 
diff --git a/libraries/flicker/utils/src/android/tools/traces/io/ResultReader.kt b/libraries/flicker/utils/src/android/tools/traces/io/ResultReader.kt
index 1116f2163..539ea3f1b 100644
--- a/libraries/flicker/utils/src/android/tools/traces/io/ResultReader.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/io/ResultReader.kt
@@ -33,9 +33,10 @@ import android.tools.traces.parsers.perfetto.ProtoLogTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransactionsTraceParser
 import android.tools.traces.parsers.perfetto.TransitionsTraceParser
+import android.tools.traces.parsers.perfetto.WindowManagerTraceParser
 import android.tools.traces.parsers.wm.LegacyTransitionTraceParser
+import android.tools.traces.parsers.wm.LegacyWindowManagerTraceParser
 import android.tools.traces.parsers.wm.WindowManagerDumpParser
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
 import android.tools.traces.protolog.ProtoLogTrace
 import android.tools.traces.surfaceflinger.LayersTrace
 import android.tools.traces.surfaceflinger.TransactionsTrace
@@ -56,15 +57,20 @@ open class ResultReader(_result: IResultData, internal val traceConfig: TraceCon
     @VisibleForTesting
     var result = _result
         internal set
+
     override val artifact: Artifact = result.artifact
     override val artifactPath: String
         get() = result.artifact.absolutePath
+
     override val runStatus
         get() = result.runStatus
+
     internal val transitionTimeRange
         get() = result.transitionTimeRange
+
     override val isFailure
         get() = runStatus.isFailure
+
     override val executionError
         get() = result.executionError
 
@@ -82,7 +88,15 @@ open class ResultReader(_result: IResultData, internal val traceConfig: TraceCon
             val descriptor = ResultArtifactDescriptor(TraceType.WM_DUMP, tag)
             Log.d(FLICKER_IO_TAG, "Reading WM trace descriptor=$descriptor from $result")
             val traceData = artifact.readBytes(descriptor)
-            traceData?.let { WindowManagerDumpParser().parse(it, clearCache = true) }
+            traceData?.let {
+                if (android.tracing.Flags.perfettoWmDump()) {
+                    TraceProcessorSession.loadPerfettoTrace(it) { session ->
+                        WindowManagerTraceParser().parse(session)
+                    }
+                } else {
+                    WindowManagerDumpParser().parse(it, clearCache = true)
+                }
+            }
         }
     }
 
@@ -94,17 +108,13 @@ open class ResultReader(_result: IResultData, internal val traceConfig: TraceCon
     @Throws(IOException::class)
     override fun readWmTrace(): WindowManagerTrace? {
         return withTracing("readWmTrace") {
-            val descriptor = ResultArtifactDescriptor(TraceType.WM)
-            artifact.readBytes(descriptor)?.let {
-                val trace =
-                    WindowManagerTraceParser()
-                        .parse(
-                            it,
-                            from = transitionTimeRange.start,
-                            to = transitionTimeRange.end,
-                            addInitialEntry = true,
-                            clearCache = true
-                        )
+            val trace =
+                if (android.tracing.Flags.perfettoWmTracing()) {
+                    readPerfettoWindowManagerTrace()
+                } else {
+                    readLegacyWindowManagerTrace()
+                }
+            if (trace != null) {
                 val minimumEntries = minimumTraceEntriesForConfig(traceConfig.wmTrace)
                 require(trace.entries.size >= minimumEntries) {
                     "WM trace contained ${trace.entries.size} entries, " +
@@ -112,8 +122,8 @@ open class ResultReader(_result: IResultData, internal val traceConfig: TraceCon
                         "transition starts at ${transitionTimeRange.start} and " +
                         "ends at ${transitionTimeRange.end}."
                 }
-                trace
             }
+            trace
         }
     }
 
@@ -243,6 +253,32 @@ open class ResultReader(_result: IResultData, internal val traceConfig: TraceCon
         }
     }
 
+    private fun readPerfettoWindowManagerTrace(): WindowManagerTrace? {
+        val traceData = artifact.readBytes(ResultArtifactDescriptor(TraceType.PERFETTO))
+
+        return traceData?.let {
+            TraceProcessorSession.loadPerfettoTrace(traceData) { session ->
+                WindowManagerTraceParser()
+                    .parse(session, from = transitionTimeRange.start, to = transitionTimeRange.end)
+            }
+        }
+    }
+
+    private fun readLegacyWindowManagerTrace(): WindowManagerTrace? {
+        val traceData = artifact.readBytes(ResultArtifactDescriptor(TraceType.WM))
+
+        return traceData?.let {
+            LegacyWindowManagerTraceParser()
+                .parse(
+                    it,
+                    from = transitionTimeRange.start,
+                    to = transitionTimeRange.end,
+                    addInitialEntry = true,
+                    clearCache = true
+                )
+        }
+    }
+
     private fun readPerfettoTransitionsTrace(): TransitionsTrace? {
         val traceData = artifact.readBytes(ResultArtifactDescriptor(TraceType.PERFETTO))
 
diff --git a/libraries/flicker/utils/src/android/tools/traces/monitors/MonitorUtils.kt b/libraries/flicker/utils/src/android/tools/traces/monitors/MonitorUtils.kt
index ebe9e0196..570833d22 100644
--- a/libraries/flicker/utils/src/android/tools/traces/monitors/MonitorUtils.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/monitors/MonitorUtils.kt
@@ -32,7 +32,7 @@ import android.tools.traces.monitors.wm.WindowManagerTraceMonitor
 import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransactionsTraceParser
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
+import android.tools.traces.parsers.wm.LegacyWindowManagerTraceParser
 import android.tools.traces.surfaceflinger.LayersTrace
 import android.tools.traces.surfaceflinger.TransactionsTrace
 import android.tools.traces.wm.WindowManagerTrace
@@ -47,7 +47,7 @@ import perfetto.protos.PerfettoConfig.SurfaceFlingerLayersConfig
  * @throws UnsupportedOperationException If tracing is already activated
  */
 fun withWMTracing(predicate: () -> Unit): WindowManagerTrace {
-    return WindowManagerTraceParser()
+    return LegacyWindowManagerTraceParser()
         .parse(WindowManagerTraceMonitor().withTracing(Tag.ALL, predicate))
 }
 
@@ -102,10 +102,23 @@ fun withTransactionsTracing(predicate: () -> Unit): TransactionsTrace {
  */
 fun withTracing(
     traceMonitors: List<TraceMonitor> =
-        listOf(
-            WindowManagerTraceMonitor(),
-            PerfettoTraceMonitor.newBuilder().enableLayersTrace().enableTransactionsTrace().build(),
-        ),
+        mutableListOf<TraceMonitor>()
+            .apply {
+                if (!android.tracing.Flags.perfettoWmTracing()) {
+                    this.add(WindowManagerTraceMonitor())
+                }
+            }
+            .apply {
+                val monitorBuilder =
+                    PerfettoTraceMonitor.newBuilder().enableLayersTrace().enableTransactionsTrace()
+
+                if (android.tracing.Flags.perfettoWmTracing()) {
+                    monitorBuilder.enableWindowManagerTrace()
+                }
+
+                this.add(monitorBuilder.build())
+            }
+            .toList(),
     predicate: () -> Unit
 ): Reader {
     val tmpFile = File.createTempFile("recordTraces", "")
diff --git a/libraries/flicker/utils/src/android/tools/traces/monitors/PerfettoTraceMonitor.kt b/libraries/flicker/utils/src/android/tools/traces/monitors/PerfettoTraceMonitor.kt
index 4bd170024..97243376f 100644
--- a/libraries/flicker/utils/src/android/tools/traces/monitors/PerfettoTraceMonitor.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/monitors/PerfettoTraceMonitor.kt
@@ -18,7 +18,6 @@ package android.tools.traces.monitors
 
 import android.tools.io.TraceType
 import android.tools.traces.executeShellCommand
-import android.tools.traces.io.IoUtils
 import com.android.internal.protolog.common.LogLevel
 import java.io.File
 import java.util.concurrent.locks.ReentrantLock
@@ -27,6 +26,7 @@ import perfetto.protos.PerfettoConfig.DataSourceConfig
 import perfetto.protos.PerfettoConfig.SurfaceFlingerLayersConfig
 import perfetto.protos.PerfettoConfig.SurfaceFlingerTransactionsConfig
 import perfetto.protos.PerfettoConfig.TraceConfig
+import perfetto.protos.PerfettoConfig.WindowManagerConfig
 
 /* Captures traces from Perfetto. */
 open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
@@ -35,35 +35,23 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
         get() = perfettoPid != null
 
     private var perfettoPid: Int? = null
-    private var configFileInPerfettoDir: File? = null
     private var traceFile: File? = null
-    private var traceFileInPerfettoDir: File? = null
-    private val PERFETTO_CONFIGS_DIR = File("/data/misc/perfetto-configs")
     private val PERFETTO_TRACES_DIR = File("/data/misc/perfetto-traces")
 
-    override fun doStart() {
-        val configFile = File.createTempFile("flickerlib-config-", ".cfg")
-        configFileInPerfettoDir = PERFETTO_CONFIGS_DIR.resolve(requireNotNull(configFile).name)
-
-        traceFile = File.createTempFile(traceType.fileName, "")
-        traceFileInPerfettoDir = PERFETTO_TRACES_DIR.resolve(requireNotNull(traceFile).name)
-
-        configFile.writeBytes(config.toByteArray())
-
-        // Experiment for sporadic failures like b/333220956.
-        // The perfetto command below sometimes fails to find the config file on disk,
-        // so let's try to wait till the file exists on disk.
-        IoUtils.waitFileExists(configFile, 2000)
+    fun captureDump(): File {
+        doStart()
+        return doStop()
+    }
 
-        IoUtils.moveFile(configFile, requireNotNull(configFileInPerfettoDir))
-        IoUtils.waitFileExists(requireNotNull(configFileInPerfettoDir), 2000)
+    override fun doStart() {
+        val fileName = File.createTempFile(traceType.fileName, "").name
+        traceFile = PERFETTO_TRACES_DIR.resolve(fileName)
 
         val command =
-            "perfetto --background-wait" +
-                " --config ${configFileInPerfettoDir?.absolutePath}" +
-                " --out ${traceFileInPerfettoDir?.absolutePath}"
-        val stdout = String(executeShellCommand(command))
+            "perfetto --background-wait" + " --config -" + " --out ${traceFile?.absolutePath}"
+        val stdout = String(executeShellCommand(command, config.toByteArray()))
         val pid = stdout.trim().toInt()
+
         perfettoPid = pid
         allPerfettoPidsLock.lock()
         try {
@@ -77,8 +65,6 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
         require(isEnabled) { "Attempted to stop disabled trace monitor" }
         killPerfettoProcess(requireNotNull(perfettoPid))
         waitPerfettoProcessExits(requireNotNull(perfettoPid))
-        IoUtils.moveFile(requireNotNull(traceFileInPerfettoDir), requireNotNull(traceFile))
-        executeShellCommand("rm ${configFileInPerfettoDir?.absolutePath}")
         perfettoPid = null
         return requireNotNull(traceFile)
     }
@@ -122,12 +108,35 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
             val collectStackTrace: Boolean,
         )
 
+        fun enableProtoLog(dataSourceName: String): Builder = apply {
+            enableProtoLog(logAll = true, dataSourceName = dataSourceName)
+        }
+
         @JvmOverloads
         fun enableProtoLog(
             logAll: Boolean = true,
-            groupOverrides: List<ProtoLogGroupOverride> = emptyList()
+            groupOverrides: List<ProtoLogGroupOverride> = emptyList(),
+            dataSourceName: String = PROTOLOG_DATA_SOURCE,
         ): Builder = apply {
-            enableCustomTrace(createProtoLogDataSourceConfig(logAll, groupOverrides))
+            enableCustomTrace(
+                createProtoLogDataSourceConfig(logAll, null, groupOverrides, dataSourceName)
+            )
+        }
+
+        @JvmOverloads
+        fun enableProtoLog(
+            defaultLogFrom: LogLevel,
+            groupOverrides: List<ProtoLogGroupOverride> = emptyList(),
+            dataSourceName: String = PROTOLOG_DATA_SOURCE,
+        ): Builder = apply {
+            enableCustomTrace(
+                createProtoLogDataSourceConfig(
+                    false,
+                    defaultLogFrom,
+                    groupOverrides,
+                    dataSourceName
+                )
+            )
         }
 
         fun enableViewCaptureTrace(): Builder = apply {
@@ -135,6 +144,45 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
             enableCustomTrace(config)
         }
 
+        @JvmOverloads
+        fun enableWindowManagerTrace(
+            logFrequency: WindowManagerConfig.LogFrequency =
+                WindowManagerConfig.LogFrequency.LOG_FREQUENCY_FRAME,
+            dataSourceName: String = WINDOWMANAGER_DATA_SOURCE
+        ): Builder = apply {
+            val config =
+                DataSourceConfig.newBuilder()
+                    .setName(dataSourceName)
+                    .setWindowmanagerConfig(
+                        WindowManagerConfig.newBuilder()
+                            .setLogLevel(WindowManagerConfig.LogLevel.LOG_LEVEL_VERBOSE)
+                            .setLogFrequency(logFrequency)
+                            .build()
+                    )
+                    .build()
+
+            enableCustomTrace(config)
+        }
+
+        @JvmOverloads
+        fun enableWindowManagerDump(dataSourceName: String = WINDOWMANAGER_DATA_SOURCE): Builder =
+            apply {
+                val config =
+                    DataSourceConfig.newBuilder()
+                        .setName(dataSourceName)
+                        .setWindowmanagerConfig(
+                            WindowManagerConfig.newBuilder()
+                                .setLogLevel(WindowManagerConfig.LogLevel.LOG_LEVEL_VERBOSE)
+                                .setLogFrequency(
+                                    WindowManagerConfig.LogFrequency.LOG_FREQUENCY_SINGLE_DUMP
+                                )
+                                .build()
+                        )
+                        .build()
+
+                enableCustomTrace(config)
+            }
+
         fun enableCustomTrace(dataSourceConfig: DataSourceConfig): Builder = apply {
             dataSourceConfigs.add(dataSourceConfig)
         }
@@ -215,7 +263,9 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
 
         private fun createProtoLogDataSourceConfig(
             logAll: Boolean,
-            groupOverrides: List<ProtoLogGroupOverride>
+            logFrom: LogLevel?,
+            groupOverrides: List<ProtoLogGroupOverride>,
+            dataSourceName: String = PROTOLOG_DATA_SOURCE,
         ): DataSourceConfig {
             val protoLogConfigBuilder = PerfettoConfig.ProtoLogConfig.newBuilder()
 
@@ -225,21 +275,25 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
                 )
             }
 
+            if (logFrom != null) {
+                protoLogConfigBuilder.setDefaultLogFromLevel(
+                    PerfettoConfig.ProtoLogLevel.forNumber(logFrom.id)
+                )
+            }
+
             for (groupOverride in groupOverrides) {
                 protoLogConfigBuilder.addGroupOverrides(
                     PerfettoConfig.ProtoLogGroup.newBuilder()
                         .setGroupName(groupOverride.groupName)
                         .setLogFrom(
-                            PerfettoConfig.ProtoLogLevel.forNumber(
-                                groupOverride.logFrom.ordinal + 1
-                            )
+                            PerfettoConfig.ProtoLogLevel.forNumber(groupOverride.logFrom.id)
                         )
                         .setCollectStacktrace(groupOverride.collectStackTrace)
                 )
             }
 
             return DataSourceConfig.newBuilder()
-                .setName(PROTOLOG_DATA_SOURCE)
+                .setName(dataSourceName)
                 .setProtologConfig(protoLogConfigBuilder)
                 .build()
         }
@@ -260,6 +314,7 @@ open class PerfettoTraceMonitor(val config: TraceConfig) : TraceMonitor() {
         private const val TRANSITIONS_DATA_SOURCE = "com.android.wm.shell.transition"
         private const val PROTOLOG_DATA_SOURCE = "android.protolog"
         private const val VIEWCAPTURE_DATA_SOURCE = "android.viewcapture"
+        private const val WINDOWMANAGER_DATA_SOURCE = "android.windowmanager"
 
         private val allPerfettoPids = mutableListOf<Int>()
         private val allPerfettoPidsLock = ReentrantLock()
diff --git a/libraries/flicker/utils/src/android/tools/traces/monitors/wm/WindowManagerTraceMonitor.kt b/libraries/flicker/utils/src/android/tools/traces/monitors/wm/WindowManagerTraceMonitor.kt
index 66d3bfab7..4ff7e4c49 100644
--- a/libraries/flicker/utils/src/android/tools/traces/monitors/wm/WindowManagerTraceMonitor.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/monitors/wm/WindowManagerTraceMonitor.kt
@@ -43,9 +43,11 @@ open class WindowManagerTraceMonitor : TraceMonitor() {
 
     override fun doStopTraces(): Map<TraceType, File> {
         val result = mutableMapOf(traceType to doStop())
-        val protologFile = TRACE_DIR.resolve(TraceType.PROTOLOG.fileName)
-        Log.d(LOG_TAG, "Adding protolog trace from $protologFile")
-        result[TraceType.PROTOLOG] = protologFile
+        if (!android.tracing.Flags.perfettoProtologTracing()) {
+            val protologFile = TRACE_DIR.resolve(TraceType.PROTOLOG.fileName)
+            Log.d(LOG_TAG, "Adding protolog trace from $protologFile")
+            result[TraceType.PROTOLOG] = protologFile
+        }
         return result
     }
 }
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/DeviceDumpParser.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/DeviceDumpParser.kt
index d2173940f..719bd16e9 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/DeviceDumpParser.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/DeviceDumpParser.kt
@@ -20,6 +20,7 @@ import android.tools.traces.DeviceStateDump
 import android.tools.traces.NullableDeviceStateDump
 import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
+import android.tools.traces.parsers.perfetto.WindowManagerTraceParser
 import android.tools.traces.parsers.wm.WindowManagerDumpParser
 import android.tools.traces.surfaceflinger.LayerTraceEntry
 import android.tools.traces.surfaceflinger.LayersTrace
@@ -56,18 +57,30 @@ class DeviceDumpParser {
             clearCacheAfterParsing: Boolean
         ): NullableDeviceStateDump {
             return withTracing("fromNullableDump") {
-                    NullableDeviceStateDump(
-                        wmState =
-                            if (wmTraceData.isNotEmpty()) {
-                                WindowManagerDumpParser()
-                                    .parse(wmTraceData, clearCache = clearCacheAfterParsing)
-                                    .entries
-                                    .first()
-                            } else {
-                                null
-                            },
-                        layerState =
-                            if (layersTraceData.isNotEmpty()) {
+                    val wmState =
+                        wmTraceData
+                            .takeIf { it.isNotEmpty() }
+                            ?.let {
+                                if (android.tracing.Flags.perfettoWmDump()) {
+                                    TraceProcessorSession.loadPerfettoTrace(wmTraceData) { session
+                                        ->
+                                        WindowManagerTraceParser()
+                                            .parse(session, clearCache = clearCacheAfterParsing)
+                                            .entries
+                                            .first()
+                                    }
+                                } else {
+                                    WindowManagerDumpParser()
+                                        .parse(wmTraceData, clearCache = clearCacheAfterParsing)
+                                        .entries
+                                        .first()
+                                }
+                            }
+
+                    val layerState =
+                        layersTraceData
+                            .takeIf { it.isNotEmpty() }
+                            ?.let {
                                 TraceProcessorSession.loadPerfettoTrace(layersTraceData) { session
                                     ->
                                     LayersTraceParser()
@@ -75,10 +88,9 @@ class DeviceDumpParser {
                                         .entries
                                         .first()
                                 }
-                            } else {
-                                null
                             }
-                    )
+
+                    NullableDeviceStateDump(wmState = wmState, layerState = layerState)
                 }
                 .also {
                     lastWmTraceData = wmTraceData
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/WindowManagerStateHelper.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/WindowManagerStateHelper.kt
index 1d9438c38..a36d0a4f2 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/WindowManagerStateHelper.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/WindowManagerStateHelper.kt
@@ -343,6 +343,15 @@ constructor(
                 .add(ConditionsFactory.isWindowSurfaceShown(componentMatcher))
                 .add(ConditionsFactory.isLayerVisible(componentMatcher))
 
+        /**
+         * Wait until least one [LayerState] matching [componentMatcher] is visible
+         *
+         * @param componentMatcher Components to search
+         */
+        fun withLayerVisible(
+            componentMatcher: IComponentMatcher
+        ) = add(ConditionsFactory.isLayerVisible(componentMatcher))
+
         /**
          * Wait until least one layer matching [componentMatcher] has [expectedRegion]
          *
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/ProtoLogTraceParser.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/ProtoLogTraceParser.kt
index af5a46805..9965e88b9 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/ProtoLogTraceParser.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/ProtoLogTraceParser.kt
@@ -43,15 +43,28 @@ class ProtoLogTraceParser :
                 input.query(getSqlQueryProtoLogMessages()) { rows ->
                     this.addAll(
                         rows.map {
+                            val entryDebugString =
+                                it.entries.joinToString { entry -> "${entry.key}: ${entry.value}" }
+                            requireNotNull(it["ts"]) {
+                                "Timestamp was null. Entry: $entryDebugString"
+                            }
+                            requireNotNull(it["level"]) {
+                                "Level was null. Entry: $entryDebugString"
+                            }
+                            requireNotNull(it["tag"]) { "Tag was null. Entry: $entryDebugString" }
+                            requireNotNull(it["message"]) {
+                                "Message was null. Entry: $entryDebugString"
+                            }
+
                             ProtoLogMessage(
                                 it["ts"] as Long,
                                 LogLevel.entries.firstOrNull { entry ->
                                     it["level"] == entry.toString()
-                                }
-                                    ?: error("Failed to convert ${it["level"]} to LogLevel enum"),
+                                } ?: error("Failed to convert ${it["level"]} to LogLevel enum"),
                                 it["tag"] as String,
                                 it["message"] as String,
                                 it["stacktrace"]?.let { it as String },
+                                it["location"]?.let { it as String },
                             )
                         }
                     )
@@ -67,6 +80,6 @@ class ProtoLogTraceParser :
 
     companion object {
         private fun getSqlQueryProtoLogMessages() =
-            "SELECT ts, level, tag, message, stacktrace FROM protolog;"
+            "SELECT ts, level, tag, message, stacktrace, location FROM protolog;"
     }
 }
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/Utils.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/Utils.kt
index 082c9c083..5e3bc648a 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/Utils.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/Utils.kt
@@ -26,6 +26,12 @@ fun queryRealToMonotonicTimeOffsetNs(session: TraceProcessorSession, tableName:
     return real - monotonic
 }
 
+fun queryRealToElapsedTimeOffsetNs(session: TraceProcessorSession, tableName: String): Long {
+    val elapsed = queryLastEntryTimestamp(session, tableName) ?: return 0L
+    val real = queryToRealtime(session, elapsed)
+    return real - elapsed
+}
+
 fun queryLastEntryTimestamp(session: TraceProcessorSession, tableName: String): Long? {
     val sql =
         """
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerStateBuilder.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerStateBuilder.kt
new file mode 100644
index 000000000..b59819383
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerStateBuilder.kt
@@ -0,0 +1,738 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.parsers.perfetto
+
+import android.graphics.Insets
+import android.graphics.Rect
+import android.tools.PlatformConsts
+import android.tools.Rotation
+import android.tools.datatypes.Size
+import android.tools.traces.wm.Activity
+import android.tools.traces.wm.ColorMode
+import android.tools.traces.wm.Configuration
+import android.tools.traces.wm.ConfigurationContainer
+import android.tools.traces.wm.ConfigurationContainerImpl
+import android.tools.traces.wm.DisplayArea
+import android.tools.traces.wm.DisplayContent
+import android.tools.traces.wm.DisplayCutout
+import android.tools.traces.wm.InsetsSource
+import android.tools.traces.wm.InsetsSourceProvider
+import android.tools.traces.wm.KeyguardControllerState
+import android.tools.traces.wm.PixelFormat
+import android.tools.traces.wm.RootWindowContainer
+import android.tools.traces.wm.RotationAnimation
+import android.tools.traces.wm.ScreenOrientation
+import android.tools.traces.wm.Task
+import android.tools.traces.wm.TaskFragment
+import android.tools.traces.wm.UserRotationMode
+import android.tools.traces.wm.WindowConfiguration
+import android.tools.traces.wm.WindowContainer
+import android.tools.traces.wm.WindowContainerImpl
+import android.tools.traces.wm.WindowLayoutParams
+import android.tools.traces.wm.WindowManagerPolicy
+import android.tools.traces.wm.WindowManagerState
+import android.tools.traces.wm.WindowState
+import android.tools.traces.wm.WindowToken
+
+/** Builder for [WindowManagerState] objects */
+class WindowManagerStateBuilder(val entry: Args, val realToElapsedTimeOffsetNs: Long) {
+    var computedZCounter = 0
+
+    fun build(): WindowManagerState {
+        computedZCounter = 0
+
+        val service =
+            entry.getChild("window_manager_service")
+                ?: error("window_manager_service field should not be null")
+        val elapsedTimestampNs =
+            entry.getChild("elapsed_realtime_nanos")?.getLong()
+                ?: error("elapsed_realtime_nanos field should not be null")
+        val realTimestampNs = elapsedTimestampNs + realToElapsedTimeOffsetNs
+
+        return WindowManagerState(
+            elapsedTimestamp = elapsedTimestampNs,
+            clockTimestamp = realTimestampNs,
+            where = entry.getChild("where")?.getString() ?: "",
+            policy = buildPolicy(service.getChild("policy")!!),
+            focusedApp = service.getChild("focused_app")?.getString() ?: "",
+            focusedDisplayId = service.getChild("focused_display_id")?.getInt() ?: 0,
+            _focusedWindow =
+                service.getChild("focused_window")?.getChild("title")?.getString() ?: "",
+            inputMethodWindowAppToken =
+                service.getChild("input_method_window")?.getChild("hash_code")?.getInt()?.let {
+                    Integer.toHexString(it)
+                } ?: "",
+            isHomeRecentsComponent =
+                service
+                    .getChild("root_window_container")
+                    ?.getChild("is_home_recents_component")
+                    ?.getBoolean() ?: false,
+            isDisplayFrozen = service.getChild("display_frozen")?.getBoolean() ?: false,
+            _pendingActivities =
+                service.getChild("root_window_container")?.getChildren("pending_activities")?.map {
+                    it.getChild("title")?.getString() ?: ""
+                } ?: emptyList(),
+            root = buildRootWindowContainer(service.getChild("root_window_container")!!),
+            keyguardControllerState =
+                buildKeyguardControllerState(
+                    service.getChild("root_window_container")?.getChild("keyguard_controller")
+                )
+        )
+    }
+
+    private fun buildPolicy(windowManagerPolicyProto: Args): WindowManagerPolicy {
+        return WindowManagerPolicy.from(
+            focusedAppToken =
+                windowManagerPolicyProto.getChild("focused_app_token")?.getString() ?: "",
+            forceStatusBar =
+                windowManagerPolicyProto.getChild("force_status_bar")?.getBoolean() ?: false,
+            forceStatusBarFromKeyguard =
+                windowManagerPolicyProto.getChild("force_status_bar_from_keyguard")?.getBoolean()
+                    ?: false,
+            keyguardDrawComplete =
+                windowManagerPolicyProto.getChild("keyguard_draw_complete")?.getBoolean() ?: false,
+            keyguardOccluded =
+                windowManagerPolicyProto.getChild("keyguard_occluded")?.getBoolean() ?: false,
+            keyguardOccludedChanged =
+                windowManagerPolicyProto.getChild("keyguard_occluded_changed")?.getBoolean()
+                    ?: false,
+            keyguardOccludedPending =
+                windowManagerPolicyProto.getChild("keyguard_occluded_pending")?.getBoolean()
+                    ?: false,
+            lastSystemUiFlags =
+                windowManagerPolicyProto.getChild("last_system_ui_flags")?.getInt() ?: 0,
+            orientation =
+                ScreenOrientation.fromName(
+                        windowManagerPolicyProto.getChild("orientation")?.getString()
+                    )
+                    ?.value ?: 0,
+            rotation =
+                Rotation.getByName(windowManagerPolicyProto.getChild("rotation")?.getString())
+                    ?: Rotation.ROTATION_0,
+            rotationMode =
+                UserRotationMode.fromName(
+                        windowManagerPolicyProto.getChild("rotation_mode")?.getString()
+                    )
+                    ?.value ?: 0,
+            screenOnFully =
+                windowManagerPolicyProto.getChild("screen_on_fully")?.getBoolean() ?: false,
+            windowManagerDrawComplete =
+                windowManagerPolicyProto.getChild("window_manager_draw_complete")?.getBoolean()
+                    ?: false
+        )
+    }
+
+    private fun buildRootWindowContainer(rootWindowContainerProto: Args): RootWindowContainer {
+        val windowContainer =
+            buildWindowContainer(
+                windowContainerProto = rootWindowContainerProto.getChild("window_container"),
+                windowContainerChildProtos =
+                    rootWindowContainerProto.getChild("window_container")?.getChildren("children"),
+                isActivityInTree = false
+            ) ?: error("Window container should not be null")
+
+        return RootWindowContainer(windowContainer)
+    }
+
+    private fun buildWindowContainer(
+        windowContainerProto: Args?,
+        windowContainerChildProtos: List<Args>?,
+        isActivityInTree: Boolean,
+        nameOverride: String? = null,
+        visibleOverride: Boolean? = null
+    ): WindowContainer? {
+        if (windowContainerProto == null) {
+            return null
+        }
+
+        val children =
+            windowContainerChildProtos?.mapNotNull {
+                buildWindowContainerChild(it, isActivityInTree)
+            } ?: listOf<WindowContainer>()
+
+        return WindowContainerImpl(
+            title =
+                nameOverride
+                    ?: windowContainerProto.getChild("identifier")?.getChild("title")?.getString()
+                    ?: "",
+            token =
+                windowContainerProto.getChild("identifier")?.getChild("hash_code")?.getInt()?.let {
+                    Integer.toHexString(it)
+                } ?: "",
+            orientation = windowContainerProto.getChild("orientation")?.getInt() ?: 0,
+            _isVisible =
+                visibleOverride ?: windowContainerProto.getChild("visible")?.getBoolean() ?: false,
+            configurationContainer =
+                buildConfigurationContainer(
+                    windowContainerProto.getChild("configuration_container")
+                ),
+            layerId =
+                windowContainerProto.getChild("surfaceControl")?.getChild("layerId")?.getInt() ?: 0,
+            _children = children,
+            computedZ = computedZCounter++
+        )
+    }
+
+    private fun buildConfigurationContainer(
+        configurationContainerProto: Args?
+    ): ConfigurationContainer {
+        return ConfigurationContainerImpl.from(
+            overrideConfiguration =
+                buildConfiguration(configurationContainerProto?.getChild("override_configuration")),
+            fullConfiguration =
+                buildConfiguration(configurationContainerProto?.getChild("full_configuration")),
+            mergedOverrideConfiguration =
+                buildConfiguration(
+                    configurationContainerProto?.getChild("merged_override_configuration")
+                )
+        )
+    }
+
+    private fun buildConfiguration(configurationProto: Args?): Configuration? {
+        if (configurationProto == null) {
+            return null
+        }
+
+        return Configuration.from(
+            windowConfiguration =
+                buildWindowConfiguration(configurationProto.getChild("window_configuration")),
+            densityDpi = configurationProto.getChild("density_dpi")?.getInt() ?: 0,
+            orientation = configurationProto.getChild("orientation")?.getInt() ?: 0,
+            screenHeightDp = configurationProto.getChild("screen_height_dp")?.getInt() ?: 0,
+            screenWidthDp = configurationProto.getChild("screen_width_dp")?.getInt() ?: 0,
+            smallestScreenWidthDp =
+                configurationProto.getChild("smallest_screen_width_dp")?.getInt() ?: 0,
+            screenLayout = configurationProto.getChild("screen_layout")?.getInt() ?: 0,
+            uiMode = configurationProto.getChild("ui_mode")?.getInt() ?: 0
+        )
+    }
+
+    private fun buildWindowConfiguration(windowConfigurationProto: Args?): WindowConfiguration? {
+        if (windowConfigurationProto == null) {
+            return null
+        }
+
+        return WindowConfiguration.from(
+            appBounds = buildRect(windowConfigurationProto.getChild("app_bounds")),
+            bounds = buildRect(windowConfigurationProto.getChild("bounds")),
+            maxBounds = buildRect(windowConfigurationProto.getChild("max_bounds")),
+            windowingMode = windowConfigurationProto.getChild("windowing_mode")?.getInt() ?: 0,
+            activityType = windowConfigurationProto.getChild("activity_type")?.getInt() ?: 0
+        )
+    }
+
+    private fun buildKeyguardControllerState(
+        keyguardControllerProto: Args?
+    ): KeyguardControllerState {
+        return KeyguardControllerState.from(
+            isAodShowing = keyguardControllerProto?.getChild("aod_showing")?.getBoolean() ?: false,
+            isKeyguardShowing =
+                keyguardControllerProto?.getChild("keyguard_showing")?.getBoolean() ?: false,
+            keyguardOccludedStates =
+                keyguardControllerProto?.getChildren("keyguard_occluded_states")?.associate {
+                    val displayId = it.getChild("display_id")?.getInt() ?: 0
+                    val keyguardOccuded = it.getChild("keyguard_occluded")?.getBoolean() ?: false
+                    displayId to keyguardOccuded
+                } ?: emptyMap()
+        )
+    }
+
+    private fun buildWindowContainerChild(
+        windowContainerChildProto: Args,
+        isActivityInTree: Boolean
+    ): WindowContainer? {
+        return buildDisplayContent(
+            windowContainerChildProto.getChild("display_content"),
+            isActivityInTree
+        )
+            ?: buildDisplayArea(
+                windowContainerChildProto.getChild("display_area"),
+                isActivityInTree
+            )
+            ?: buildTask(windowContainerChildProto.getChild("task"), isActivityInTree)
+            ?: buildTaskFragment(
+                windowContainerChildProto.getChild("task_fragment"),
+                isActivityInTree
+            )
+            ?: buildActivity(windowContainerChildProto.getChild("activity"))
+            ?: buildWindowToken(
+                windowContainerChildProto.getChild("window_token"),
+                isActivityInTree
+            )
+            ?: buildWindowState(windowContainerChildProto.getChild("window"), isActivityInTree)
+            ?: buildWindowContainer(
+                windowContainerChildProto.getChild("window_container"),
+                windowContainerChildProtos = null,
+                isActivityInTree = isActivityInTree
+            )
+    }
+
+    private fun buildDisplayContent(
+        displayContentProto: Args?,
+        isActivityInTree: Boolean
+    ): DisplayContent? {
+        if (displayContentProto == null) {
+            return null
+        }
+
+        return DisplayContent(
+            displayId = displayContentProto.getChild("id")?.getInt() ?: 0,
+            focusedRootTaskId = displayContentProto.getChild("focused_root_task_id")?.getInt() ?: 0,
+            resumedActivity =
+                displayContentProto.getChild("resumed_activity")?.getChild("title")?.getString()
+                    ?: "",
+            singleTaskInstance =
+                displayContentProto.getChild("single_task_instance")?.getBoolean() ?: false,
+            defaultPinnedStackBounds =
+                buildRect(
+                    displayContentProto
+                        .getChild("pinned_task_controller")
+                        ?.getChild("default_bounds")
+                ),
+            pinnedStackMovementBounds =
+                buildRect(
+                    displayContentProto
+                        .getChild("pinned_task_controller")
+                        ?.getChild("movement_bounds")
+                ),
+            displayRect =
+                Rect(
+                    0,
+                    0,
+                    displayContentProto
+                        .getChild("display_info")
+                        ?.getChild("logical_width")
+                        ?.getInt() ?: 0,
+                    displayContentProto
+                        .getChild("display_info")
+                        ?.getChild("logical_height")
+                        ?.getInt() ?: 0
+                ),
+            appRect =
+                Rect(
+                    0,
+                    0,
+                    displayContentProto.getChild("display_info")?.getChild("app_width")?.getInt()
+                        ?: 0,
+                    displayContentProto.getChild("display_info")?.getChild("app_height")?.getInt()
+                        ?: 0
+                ),
+            dpi = displayContentProto.getChild("dpi")?.getInt() ?: 0,
+            flags = displayContentProto.getChild("display_info")?.getChild("flags")?.getInt() ?: 0,
+            stableBounds =
+                buildRect(
+                    displayContentProto.getChild("display_frames")?.getChild("stable_bounds")
+                ),
+            surfaceSize = displayContentProto.getChild("surface_size")?.getInt() ?: 0,
+            focusedApp = displayContentProto.getChild("focused_app")?.getString() ?: "",
+            lastTransition =
+                displayContentProto
+                    .getChild("app_transition")
+                    ?.getChild("last_used_app_transition")
+                    ?.getString() ?: DEFAULT_TRANSITION_TYPE,
+            appTransitionState =
+                displayContentProto
+                    .getChild("app_transition")
+                    ?.getChild("app_transition_state")
+                    ?.getString() ?: DEFAULT_APP_STATE,
+            rotation =
+                Rotation.getByValue(
+                    displayContentProto.getChild("display_rotation")?.getChild("rotation")?.getInt()
+                        ?: 0
+                ),
+            lastOrientation =
+                displayContentProto
+                    .getChild("display_rotation")
+                    ?.getChild("last_orientation")
+                    ?.getInt() ?: 0,
+            cutout =
+                buildDisplayCutout(
+                    displayContentProto.getChild("display_info")?.getChild("cutout")
+                ),
+            insetsSourceProviders =
+                buildInsetsSourceProviders(
+                    displayContentProto.getChildren("insets_source_providers"),
+                ),
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto =
+                        displayContentProto
+                            .getChild("root_display_area")
+                            ?.getChild("window_container"),
+                    windowContainerChildProtos =
+                        displayContentProto
+                            .getChild("root_display_area")
+                            ?.getChild("window_container")
+                            ?.getChildren("children"),
+                    isActivityInTree = isActivityInTree,
+                    nameOverride =
+                        displayContentProto.getChild("display_info")?.getChild("name")?.getString()
+                            ?: ""
+                ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildDisplayArea(displayAreaProto: Args?, isActivityInTree: Boolean): DisplayArea? {
+        if (displayAreaProto == null) {
+            return null
+        }
+
+        return DisplayArea(
+            isTaskDisplayArea =
+                displayAreaProto.getChild("is_task_display_area")?.getBoolean() ?: false,
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto = displayAreaProto.getChild("window_container"),
+                    windowContainerChildProtos =
+                        displayAreaProto.getChild("window_container")?.getChildren("children"),
+                    isActivityInTree = isActivityInTree,
+                ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildTask(taskProto: Args?, isActivityInTree: Boolean): Task? {
+        if (taskProto == null) {
+            return null
+        }
+
+        return Task(
+            activityType =
+                taskProto.getChild("task_fragment")?.getChild("activity_type")?.getInt()
+                    ?: taskProto.getChild("activity_type")?.getInt()
+                    ?: 0,
+            isFullscreen = taskProto.getChild("fills_parent")?.getBoolean() ?: false,
+            bounds = buildRect(taskProto.getChild("bounds")),
+            taskId = taskProto.getChild("id")?.getInt() ?: 0,
+            rootTaskId = taskProto.getChild("root_task_id")?.getInt() ?: 0,
+            displayId =
+                taskProto.getChild("task_fragment")?.getChild("display_id")?.getInt()
+                    ?: taskProto.getChild("display_id")?.getInt()
+                    ?: 0,
+            lastNonFullscreenBounds = buildRect(taskProto.getChild("last_non_fullscreen_bounds")),
+            realActivity = taskProto.getChild("real_activity")?.getString() ?: "",
+            origActivity = taskProto.getChild("orig_activity")?.getString() ?: "",
+            resizeMode = taskProto.getChild("resize_mode")?.getInt() ?: 0,
+            _resumedActivity =
+                taskProto.getChild("resumed_activity")?.getChild("title")?.getString() ?: "",
+            animatingBounds = taskProto.getChild("animating_bounds")?.getBoolean() ?: false,
+            surfaceWidth = taskProto.getChild("surface_width")?.getInt() ?: 0,
+            surfaceHeight = taskProto.getChild("surface_height")?.getInt() ?: 0,
+            createdByOrganizer = taskProto.getChild("created_by_organizer")?.getBoolean() ?: false,
+            minWidth =
+                taskProto.getChild("task_fragment")?.getChild("min_width")?.getInt()
+                    ?: taskProto.getChild("min_width")?.getInt()
+                    ?: 0,
+            minHeight =
+                taskProto.getChild("task_fragment")?.getChild("min_height")?.getInt()
+                    ?: taskProto.getChild("min_height")?.getInt()
+                    ?: 0,
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto =
+                        taskProto.getChild("task_fragment")?.getChild("window_container")
+                            ?: taskProto.getChild("window_container"),
+                    windowContainerChildProtos =
+                        if (taskProto.getChild("task_fragment") != null) {
+                            taskProto
+                                .getChild("task_fragment")
+                                ?.getChild("window_container")
+                                ?.getChildren("children")
+                        } else {
+                            taskProto.getChild("window_container")?.getChildren("children")
+                        },
+                    isActivityInTree = isActivityInTree
+                ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildTaskFragment(
+        taskFragmentProto: Args?,
+        isActivityInTree: Boolean
+    ): TaskFragment? {
+        if (taskFragmentProto == null) {
+            return null
+        }
+
+        return TaskFragment(
+            activityType = taskFragmentProto.getChild("activity_type")?.getInt() ?: 0,
+            displayId = taskFragmentProto.getChild("display_id")?.getInt() ?: 0,
+            minWidth = taskFragmentProto.getChild("min_width")?.getInt() ?: 0,
+            minHeight = taskFragmentProto.getChild("min_height")?.getInt() ?: 0,
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto = taskFragmentProto.getChild("window_container"),
+                    windowContainerChildProtos =
+                        taskFragmentProto.getChild("window_container")?.getChildren("children"),
+                    isActivityInTree = isActivityInTree
+                ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildActivity(activityRecordProto: Args?): Activity? {
+        if (activityRecordProto == null) {
+            return null
+        }
+
+        return Activity(
+            state = activityRecordProto.getChild("state")?.getString() ?: "",
+            frontOfTask = activityRecordProto.getChild("front_of_task")?.getBoolean() ?: false,
+            procId = activityRecordProto.getChild("proc_id")?.getInt() ?: 0,
+            isTranslucent = activityRecordProto.getChild("translucent")?.getBoolean() ?: false,
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto =
+                        activityRecordProto.getChild("window_token")?.getChild("window_container"),
+                    windowContainerChildProtos =
+                        activityRecordProto
+                            .getChild("window_token")
+                            ?.getChild("window_container")
+                            ?.getChildren("children"),
+                    isActivityInTree = true,
+                    nameOverride = activityRecordProto.getChild("name")?.getString() ?: ""
+                ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildWindowToken(windowTokenProto: Args?, isActivityInTree: Boolean): WindowToken? {
+        if (windowTokenProto == null) {
+            return null
+        }
+
+        return WindowToken(
+            buildWindowContainer(
+                windowContainerProto = windowTokenProto.getChild("window_container"),
+                windowContainerChildProtos =
+                    windowTokenProto.getChild("window_container")?.getChildren("children"),
+                isActivityInTree = isActivityInTree
+            ) ?: error("Window container should not be null")
+        )
+    }
+
+    private fun buildWindowState(windowStateProto: Args?, isActivityInTree: Boolean): WindowState? {
+        if (windowStateProto == null) {
+            return null
+        }
+
+        val identifierName =
+            windowStateProto
+                .getChild("window_container")
+                ?.getChild("identifier")
+                ?.getChild("title")
+                ?.getString() ?: ""
+        return WindowState(
+            attributes = buildWindowLayoutParams(windowStateProto.getChild("attributes")),
+            displayId = windowStateProto.getChild("display_id")?.getInt() ?: 0,
+            stackId = windowStateProto.getChild("stack_id")?.getInt() ?: 0,
+            layer =
+                windowStateProto
+                    .getChild("animator")
+                    ?.getChild("surface")
+                    ?.getChild("layer")
+                    ?.getInt() ?: 0,
+            isSurfaceShown =
+                windowStateProto
+                    .getChild("animator")
+                    ?.getChild("surface")
+                    ?.getChild("shown")
+                    ?.getBoolean() ?: false,
+            windowType =
+                when {
+                    identifierName.startsWith(PlatformConsts.STARTING_WINDOW_PREFIX) ->
+                        PlatformConsts.WINDOW_TYPE_STARTING
+                    windowStateProto.getChild("animating_exit")?.getBoolean() ?: false ->
+                        PlatformConsts.WINDOW_TYPE_EXITING
+                    identifierName.startsWith(PlatformConsts.DEBUGGER_WINDOW_PREFIX) ->
+                        PlatformConsts.WINDOW_TYPE_STARTING
+                    else -> 0
+                },
+            requestedSize =
+                Size.from(
+                    windowStateProto.getChild("requested_width")?.getInt() ?: 0,
+                    windowStateProto.getChild("requested_height")?.getInt() ?: 0
+                ),
+            surfacePosition = buildRect(windowStateProto.getChild("surface_position")),
+            frame = buildRect(windowStateProto.getChild("window_frames")?.getChild("frame")),
+            containingFrame =
+                buildRect(windowStateProto.getChild("window_frames")?.getChild("containing_frame")),
+            parentFrame =
+                buildRect(windowStateProto.getChild("window_frames")?.getChild("parent_frame")),
+            contentFrame =
+                buildRect(windowStateProto.getChild("window_frames")?.getChild("content_frame")),
+            contentInsets =
+                buildRect(windowStateProto.getChild("window_frames")?.getChild("content_insets")),
+            surfaceInsets = buildRect(windowStateProto.getChild("surface_insets")),
+            givenContentInsets = buildRect(windowStateProto.getChild("given_content_insets")),
+            crop = buildRect(windowStateProto.getChild("animator")?.getChild("last_clip_rect")),
+            windowContainer =
+                buildWindowContainer(
+                    windowContainerProto = windowStateProto.getChild("window_container"),
+                    windowContainerChildProtos =
+                        windowStateProto.getChild("window_container")?.getChildren("children"),
+                    isActivityInTree = isActivityInTree,
+                    nameOverride =
+                        getWindowTitle(
+                            when {
+                                // Existing code depends on the prefix being removed
+                                identifierName.startsWith(PlatformConsts.STARTING_WINDOW_PREFIX) ->
+                                    identifierName.substring(
+                                        PlatformConsts.STARTING_WINDOW_PREFIX.length
+                                    )
+                                identifierName.startsWith(PlatformConsts.DEBUGGER_WINDOW_PREFIX) ->
+                                    identifierName.substring(
+                                        PlatformConsts.DEBUGGER_WINDOW_PREFIX.length
+                                    )
+                                else -> identifierName
+                            }
+                        )
+                ) ?: error("Window container should not be null"),
+            isAppWindow = isActivityInTree
+        )
+    }
+
+    private fun buildDisplayCutout(displayCutoutProto: Args?): DisplayCutout? {
+        if (displayCutoutProto == null) {
+            return null
+        }
+
+        return DisplayCutout.from(
+            buildInsets(displayCutoutProto.getChild("insets")),
+            buildRect(displayCutoutProto.getChild("bound_left")),
+            buildRect(displayCutoutProto.getChild("bound_top")),
+            buildRect(displayCutoutProto.getChild("bound_right")),
+            buildRect(displayCutoutProto.getChild("bound_bottom")),
+            buildInsets(displayCutoutProto.getChild("waterfall_insets"))
+        )
+    }
+
+    private fun buildInsetsSource(insetsSourceProto: Args?): InsetsSource? {
+        if (insetsSourceProto == null) {
+            return null
+        }
+
+        return InsetsSource.from(
+            type = insetsSourceProto.getChild("type_number")?.getInt() ?: -1,
+            frame = buildRect(insetsSourceProto.getChild("frame")),
+            visible = insetsSourceProto.getChild("visible")?.getBoolean() ?: false,
+        )
+    }
+
+    private fun buildInsetsSourceProviders(
+        insetsProvidersProto: List<Args>?
+    ): Array<InsetsSourceProvider> {
+        return insetsProvidersProto
+            ?.map {
+                InsetsSourceProvider(
+                    buildRect(it.getChild("frame")),
+                    buildInsetsSource(it.getChild("source"))
+                )
+            }
+            ?.toTypedArray() ?: emptyArray<InsetsSourceProvider>()
+    }
+
+    private fun buildWindowLayoutParams(windowLayoutParamsProto: Args?): WindowLayoutParams {
+        return WindowLayoutParams.from(
+            type = windowLayoutParamsProto?.getChild("type")?.getInt() ?: 0,
+            x = windowLayoutParamsProto?.getChild("x")?.getInt() ?: 0,
+            y = windowLayoutParamsProto?.getChild("y")?.getInt() ?: 0,
+            width = windowLayoutParamsProto?.getChild("width")?.getInt() ?: 0,
+            height = windowLayoutParamsProto?.getChild("height")?.getInt() ?: 0,
+            horizontalMargin =
+                windowLayoutParamsProto?.getChild("horizontal_margin")?.getFloat() ?: 0f,
+            verticalMargin = windowLayoutParamsProto?.getChild("vertical_margin")?.getFloat() ?: 0f,
+            gravity = windowLayoutParamsProto?.getChild("gravity")?.getInt() ?: 0,
+            softInputMode = windowLayoutParamsProto?.getChild("soft_input_mode")?.getInt() ?: 0,
+            format =
+                PixelFormat.fromName(windowLayoutParamsProto?.getChild("format")?.getString())
+                    ?.value ?: 0,
+            windowAnimations =
+                windowLayoutParamsProto?.getChild("window_animations")?.getInt() ?: 0,
+            alpha = windowLayoutParamsProto?.getChild("alpha")?.getFloat() ?: 0f,
+            screenBrightness =
+                windowLayoutParamsProto?.getChild("screen_brightness")?.getFloat() ?: 0f,
+            buttonBrightness =
+                windowLayoutParamsProto?.getChild("button_brightness")?.getFloat() ?: 0f,
+            rotationAnimation =
+                RotationAnimation.fromName(
+                        windowLayoutParamsProto?.getChild("rotation_animation")?.getString()
+                    )
+                    ?.value ?: 0,
+            preferredRefreshRate =
+                windowLayoutParamsProto?.getChild("preferred_refresh_rate")?.getFloat() ?: 0f,
+            preferredDisplayModeId =
+                windowLayoutParamsProto?.getChild("preferred_display_mode_id")?.getInt() ?: 0,
+            hasSystemUiListeners =
+                windowLayoutParamsProto?.getChild("has_system_ui_listeners")?.getBoolean() ?: false,
+            inputFeatureFlags =
+                windowLayoutParamsProto?.getChild("input_feature_flags")?.getInt() ?: 0,
+            userActivityTimeout =
+                windowLayoutParamsProto?.getChild("user_activity_timeout")?.getLong() ?: 0,
+            colorMode =
+                ColorMode.fromName(windowLayoutParamsProto?.getChild("color_mode")?.getString())
+                    ?.value ?: 0,
+            flags = windowLayoutParamsProto?.getChild("flags")?.getInt() ?: 0,
+            privateFlags = windowLayoutParamsProto?.getChild("private_flags")?.getInt() ?: 0,
+            systemUiVisibilityFlags =
+                windowLayoutParamsProto?.getChild("system_ui_visibility_flags")?.getInt() ?: 0,
+            subtreeSystemUiVisibilityFlags =
+                windowLayoutParamsProto?.getChild("subtree_system_ui_visibility_flags")?.getInt()
+                    ?: 0,
+            appearance = windowLayoutParamsProto?.getChild("appearance")?.getInt() ?: 0,
+            behavior = windowLayoutParamsProto?.getChild("behavior")?.getInt() ?: 0,
+            fitInsetsTypes = windowLayoutParamsProto?.getChild("fit_insets_types")?.getInt() ?: 0,
+            fitInsetsSides = windowLayoutParamsProto?.getChild("fit_insets_sides")?.getInt() ?: 0,
+            fitIgnoreVisibility =
+                windowLayoutParamsProto?.getChild("fit_ignore_visibility")?.getBoolean() ?: false
+        )
+    }
+
+    private fun buildInsets(rectProto: Args?): Insets {
+        if (rectProto == null) {
+            return Insets.NONE
+        }
+
+        return Insets.of(
+            rectProto?.getChild("left")?.getInt() ?: 0,
+            rectProto?.getChild("top")?.getInt() ?: 0,
+            rectProto?.getChild("right")?.getInt() ?: 0,
+            rectProto?.getChild("bottom")?.getInt() ?: 0
+        )
+    }
+
+    private fun buildRect(rectProto: Args?): Rect =
+        Rect(
+            rectProto?.getChild("left")?.getInt() ?: 0,
+            rectProto?.getChild("top")?.getInt() ?: 0,
+            rectProto?.getChild("right")?.getInt() ?: 0,
+            rectProto?.getChild("bottom")?.getInt() ?: 0
+        )
+
+    private fun getWindowTitle(title: String): String {
+        return when {
+            // Existing code depends on the prefix being removed
+            title.startsWith(PlatformConsts.STARTING_WINDOW_PREFIX) ->
+                title.substring(PlatformConsts.STARTING_WINDOW_PREFIX.length)
+            title.startsWith(PlatformConsts.DEBUGGER_WINDOW_PREFIX) ->
+                title.substring(PlatformConsts.DEBUGGER_WINDOW_PREFIX.length)
+            else -> title
+        }
+    }
+
+    companion object {
+        private const val DEFAULT_TRANSITION_TYPE = "TRANSIT_NONE"
+        private const val DEFAULT_APP_STATE = "APP_STATE_IDLE"
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerTraceParser.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerTraceParser.kt
new file mode 100644
index 000000000..e325989d8
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/perfetto/WindowManagerTraceParser.kt
@@ -0,0 +1,93 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.parsers.perfetto
+
+import android.tools.parsers.AbstractTraceParser
+import android.tools.traces.wm.WindowManagerState
+import android.tools.traces.wm.WindowManagerTrace
+
+/** Parser for [WindowManagerTrace] objects containing traces */
+class WindowManagerTraceParser :
+    AbstractTraceParser<
+        TraceProcessorSession,
+        WindowManagerState,
+        WindowManagerState,
+        WindowManagerTrace
+    >() {
+    override val traceName: String = "WM Trace"
+
+    override fun doDecodeByteArray(bytes: ByteArray): TraceProcessorSession {
+        error("This parser can only read from perfetto trace processor")
+    }
+
+    override fun createTrace(entries: Collection<WindowManagerState>): WindowManagerTrace =
+        WindowManagerTrace(entries)
+
+    override fun getEntries(input: TraceProcessorSession): List<WindowManagerState> {
+        return input.query("INCLUDE PERFETTO MODULE android.winscope.windowmanager;") {
+            val realToElapsedTimeOffsetNs = queryRealToElapsedTimeOffsetNs(input, TABLE_NAME)
+
+            val traceEntries = mutableListOf<WindowManagerState>()
+            val entryIds = queryEntryIds(input)
+
+            for (entryId in entryIds) {
+                val entry =
+                    input.query(getSqlQueryEntry(entryId)) { rows ->
+                        val args = Args.build(rows)
+                        WindowManagerStateBuilder(args, realToElapsedTimeOffsetNs).build()
+                    }
+                traceEntries.add(entry)
+            }
+
+            traceEntries
+        }
+    }
+
+    override fun getTimestamp(entry: WindowManagerState) = entry.timestamp
+
+    override fun doParseEntry(entry: WindowManagerState) = entry
+
+    companion object {
+        val TABLE_NAME = "android_windowmanager"
+
+        private fun queryEntryIds(input: TraceProcessorSession): List<Long> {
+            val sql =
+                """
+                SELECT id FROM $TABLE_NAME ORDER BY ts;
+            """
+                    .trimIndent()
+            return input.query(sql) { rows ->
+                val ids = rows.map { it["id"] as Long }
+                ids
+            }
+        }
+
+        private fun getSqlQueryEntry(entryId: Long): String {
+            return """
+                SELECT
+                    args.key as key,
+                    args.display_value as value,
+                    args.value_type
+                FROM
+                    $TABLE_NAME as wm
+                INNER JOIN args ON wm.arg_set_id = args.arg_set_id
+                WHERE wm.id = $entryId;
+            """
+                .trimIndent()
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerTraceParser.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/wm/LegacyWindowManagerTraceParser.kt
similarity index 91%
rename from libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerTraceParser.kt
rename to libraries/flicker/utils/src/android/tools/traces/parsers/wm/LegacyWindowManagerTraceParser.kt
index 151c24987..9ccf18834 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerTraceParser.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/wm/LegacyWindowManagerTraceParser.kt
@@ -25,9 +25,12 @@ import com.android.server.wm.nano.WindowManagerTraceFileProto
 import com.android.server.wm.nano.WindowManagerTraceProto
 
 /** Parser for [WindowManagerTrace] objects containing traces */
-open class WindowManagerTraceParser(private val legacyTrace: Boolean = false) :
+open class LegacyWindowManagerTraceParser(private val legacyTrace: Boolean = false) :
     AbstractTraceParser<
-        WindowManagerTraceFileProto, WindowManagerTraceProto, WindowManagerState, WindowManagerTrace
+        WindowManagerTraceFileProto,
+        WindowManagerTraceProto,
+        WindowManagerState,
+        WindowManagerTrace
     >() {
     private var realToElapsedTimeOffsetNanos = 0L
 
diff --git a/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerStateBuilder.kt b/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerStateBuilder.kt
index a86e8e986..8783bd04c 100644
--- a/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerStateBuilder.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/parsers/wm/WindowManagerStateBuilder.kt
@@ -31,6 +31,8 @@ import android.tools.traces.wm.ConfigurationContainerImpl
 import android.tools.traces.wm.DisplayArea
 import android.tools.traces.wm.DisplayContent
 import android.tools.traces.wm.DisplayCutout
+import android.tools.traces.wm.InsetsSource
+import android.tools.traces.wm.InsetsSourceProvider
 import android.tools.traces.wm.KeyguardControllerState
 import android.tools.traces.wm.RootWindowContainer
 import android.tools.traces.wm.Task
@@ -46,6 +48,7 @@ import android.tools.traces.wm.WindowState
 import android.tools.traces.wm.WindowToken
 import android.view.Surface
 import android.view.nano.DisplayCutoutProto
+import android.view.nano.InsetsSourceProto
 import android.view.nano.ViewProtoEnums
 import android.view.nano.WindowLayoutParamsProto
 import com.android.server.wm.nano.ActivityRecordProto
@@ -53,6 +56,7 @@ import com.android.server.wm.nano.AppTransitionProto
 import com.android.server.wm.nano.ConfigurationContainerProto
 import com.android.server.wm.nano.DisplayAreaProto
 import com.android.server.wm.nano.DisplayContentProto
+import com.android.server.wm.nano.InsetsSourceProviderProto
 import com.android.server.wm.nano.KeyguardControllerProto
 import com.android.server.wm.nano.RootWindowContainerProto
 import com.android.server.wm.nano.TaskFragmentProto
@@ -135,8 +139,7 @@ class WindowManagerStateBuilder {
                 proto.windowContainer.children.mapNotNull { p ->
                     createWindowContainerChild(p, isActivityInTree = false)
                 }
-            )
-                ?: error("Window container should not be null")
+            ) ?: error("Window container should not be null")
         )
     }
 
@@ -158,12 +161,12 @@ class WindowManagerStateBuilder {
     ): WindowContainer? {
         return createDisplayContent(proto.displayContent, isActivityInTree)
             ?: createDisplayArea(proto.displayArea, isActivityInTree)
-                ?: createTask(proto.task, isActivityInTree)
-                ?: createTaskFragment(proto.taskFragment, isActivityInTree)
-                ?: createActivity(proto.activity)
-                ?: createWindowToken(proto.windowToken, isActivityInTree)
-                ?: createWindowState(proto.window, isActivityInTree)
-                ?: createWindowContainer(proto.windowContainer, children = emptyList())
+            ?: createTask(proto.task, isActivityInTree)
+            ?: createTaskFragment(proto.taskFragment, isActivityInTree)
+            ?: createActivity(proto.activity)
+            ?: createWindowToken(proto.windowToken, isActivityInTree)
+            ?: createWindowState(proto.window, isActivityInTree)
+            ?: createWindowContainer(proto.windowContainer, children = emptyList())
     }
 
     private fun createDisplayContent(
@@ -178,10 +181,10 @@ class WindowManagerStateBuilder {
                 focusedRootTaskId = proto.focusedRootTaskId,
                 resumedActivity = proto.resumedActivity?.title ?: "",
                 singleTaskInstance = proto.singleTaskInstance,
-                defaultPinnedStackBounds = proto.pinnedTaskController?.defaultBounds?.toRect()
-                        ?: Rect(),
-                pinnedStackMovementBounds = proto.pinnedTaskController?.movementBounds?.toRect()
-                        ?: Rect(),
+                defaultPinnedStackBounds =
+                    proto.pinnedTaskController?.defaultBounds?.toRect() ?: Rect(),
+                pinnedStackMovementBounds =
+                    proto.pinnedTaskController?.movementBounds?.toRect() ?: Rect(),
                 displayRect =
                     Rect(
                         0,
@@ -203,6 +206,7 @@ class WindowManagerStateBuilder {
                     Rotation.getByValue(proto.displayRotation?.rotation ?: Surface.ROTATION_0),
                 lastOrientation = proto.displayRotation?.lastOrientation ?: 0,
                 cutout = createDisplayCutout(proto.displayInfo?.cutout),
+                insetsSourceProviders = buildInsetsSourceProviders(proto.insetsSourceProviders),
                 windowContainer =
                     createWindowContainer(
                         proto.rootDisplayArea.windowContainer,
@@ -210,8 +214,7 @@ class WindowManagerStateBuilder {
                             createWindowContainerChild(p, isActivityInTree)
                         },
                         nameOverride = proto.displayInfo?.name ?: ""
-                    )
-                        ?: error("Window container should not be null")
+                    ) ?: error("Window container should not be null")
             )
         }
     }
@@ -231,8 +234,7 @@ class WindowManagerStateBuilder {
                         proto.windowContainer.children.mapNotNull { p ->
                             createWindowContainerChild(p, isActivityInTree)
                         }
-                    )
-                        ?: error("Window container should not be null")
+                    ) ?: error("Window container should not be null")
             )
         }
     }
@@ -271,8 +273,7 @@ class WindowManagerStateBuilder {
                                 createWindowContainerChild(p, isActivityInTree)
                             }
                         }
-                    )
-                        ?: error("Window container should not be null")
+                    ) ?: error("Window container should not be null")
             )
         }
     }
@@ -295,8 +296,7 @@ class WindowManagerStateBuilder {
                         proto.windowContainer.children.mapNotNull { p ->
                             createWindowContainerChild(p, isActivityInTree)
                         }
-                    )
-                        ?: error("Window container should not be null")
+                    ) ?: error("Window container should not be null")
             )
         }
     }
@@ -317,8 +317,7 @@ class WindowManagerStateBuilder {
                             createWindowContainerChild(p, isActivityInTree = true)
                         },
                         nameOverride = proto.name
-                    )
-                        ?: error("Window container should not be null")
+                    ) ?: error("Window container should not be null")
             )
         }
     }
@@ -336,8 +335,7 @@ class WindowManagerStateBuilder {
                     proto.windowContainer.children.mapNotNull { p ->
                         createWindowContainerChild(p, isActivityInTree)
                     }
-                )
-                    ?: error("Window container should not be null")
+                ) ?: error("Window container should not be null")
             )
         }
     }
@@ -400,8 +398,7 @@ class WindowManagerStateBuilder {
                                     else -> identifierName
                                 }
                             )
-                    )
-                        ?: error("Window container should not be null"),
+                    ) ?: error("Window container should not be null"),
                 isAppWindow = isActivityInTree
             )
         }
@@ -564,6 +561,24 @@ class WindowManagerStateBuilder {
 
     private fun RectProto.toInsets() = Insets.of(this.left, this.top, this.right, this.bottom)
 
+    private fun createInsetsSource(proto: InsetsSourceProto?): InsetsSource? {
+        return if (proto == null) {
+            null
+        } else {
+            InsetsSource.from(proto.typeNumber, proto.frame?.toRect() ?: Rect(), proto.visible)
+        }
+    }
+
+    private fun buildInsetsSourceProviders(
+        insetsSourceProviders: Array<InsetsSourceProviderProto>
+    ): Array<InsetsSourceProvider> {
+        return insetsSourceProviders
+            .map {
+                InsetsSourceProvider(it.frame?.toRect() ?: Rect(), createInsetsSource(it.source))
+            }
+            .toTypedArray()
+    }
+
     companion object {
         private const val TRANSIT_ACTIVITY_OPEN = "TRANSIT_ACTIVITY_OPEN"
         private const val TRANSIT_ACTIVITY_CLOSE = "TRANSIT_ACTIVITY_CLOSE"
diff --git a/libraries/flicker/utils/src/android/tools/traces/protolog/ProtoLogMessage.kt b/libraries/flicker/utils/src/android/tools/traces/protolog/ProtoLogMessage.kt
index 889a79f50..dc7c40510 100644
--- a/libraries/flicker/utils/src/android/tools/traces/protolog/ProtoLogMessage.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/protolog/ProtoLogMessage.kt
@@ -26,6 +26,7 @@ class ProtoLogMessage(
     val tag: String,
     val message: String,
     val stacktrace: String?,
+    val location: String?,
 ) : TraceEntry {
     override val timestamp = Timestamps.from(elapsedNanos = elapsedTimestamp)
 }
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/ColorMode.kt b/libraries/flicker/utils/src/android/tools/traces/wm/ColorMode.kt
new file mode 100644
index 000000000..aab228b7d
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/ColorMode.kt
@@ -0,0 +1,38 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+enum class ColorMode(val value: Int) {
+    COLOR_MODE_INVALID(-1),
+    // The default or native gamut of the display.
+    COLOR_MODE_DEFAULT(0),
+    COLOR_MODE_BT601_625(1),
+    COLOR_MODE_BT601_625_UNADJUSTED(2),
+    COLOR_MODE_BT601_525(3),
+    COLOR_MODE_BT601_525_UNADJUSTED(4),
+    COLOR_MODE_BT709(5),
+    COLOR_MODE_DCI_P3(6),
+    COLOR_MODE_SRGB(7),
+    COLOR_MODE_ADOBE_RGB(8),
+    COLOR_MODE_DISPLAY_P3(9);
+
+    companion object {
+        fun fromName(name: String?): ColorMode? {
+            return name?.let { ColorMode.values().find { it.name == name } }
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/DisplayContent.kt b/libraries/flicker/utils/src/android/tools/traces/wm/DisplayContent.kt
index 14ef34e01..73a1d771e 100644
--- a/libraries/flicker/utils/src/android/tools/traces/wm/DisplayContent.kt
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/DisplayContent.kt
@@ -28,6 +28,9 @@ import kotlin.math.min
  *
  * This is a generic object that is reused by both Flicker and Winscope and cannot access internal
  * Java/Android functionality
+ *
+ * @property displayRect The logical display rect.
+ * @property stableBounds The logical display bounds excluding the navigation and status bar areas.
  */
 class DisplayContent(
     val displayId: Int,
@@ -48,6 +51,7 @@ class DisplayContent(
     val rotation: Rotation,
     val lastOrientation: Int,
     val cutout: DisplayCutout?,
+    val insetsSourceProviders: Array<InsetsSourceProvider>,
     private val windowContainer: WindowContainer
 ) : WindowContainer by windowContainer {
     override val name: String = displayId.toString()
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSource.kt b/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSource.kt
new file mode 100644
index 000000000..ad4d25a7f
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSource.kt
@@ -0,0 +1,50 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+import android.graphics.Rect
+import android.tools.withCache
+
+class InsetsSource private constructor(val type: Int, val frame: Rect, val visible: Boolean) {
+    override fun equals(other: Any?): Boolean {
+        if (this === other) return true
+        if (other !is InsetsSource) return false
+
+        if (type != other.type) return false
+        if (frame != other.frame) return false
+        if (visible != other.visible) return false
+
+        return true
+    }
+
+    override fun hashCode(): Int {
+        var result = type.hashCode()
+        result = 31 * result + frame.hashCode()
+        result = 31 * result + visible.hashCode()
+        return result
+    }
+
+    override fun toString(): String {
+        return "InsetsSource(" + "type=$type, " + "frame=$frame, " + "visible=$visible" + ")"
+    }
+
+    companion object {
+        fun from(type: Int, frame: Rect, visible: Boolean): InsetsSource = withCache {
+            InsetsSource(type, frame, visible)
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSourceProvider.kt b/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSourceProvider.kt
new file mode 100644
index 000000000..f4795c2f3
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/InsetsSourceProvider.kt
@@ -0,0 +1,21 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+import android.graphics.Rect
+
+data class InsetsSourceProvider(val frame: Rect?, val source: InsetsSource?)
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/PixelFormat.kt b/libraries/flicker/utils/src/android/tools/traces/wm/PixelFormat.kt
new file mode 100644
index 000000000..b0bf80455
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/PixelFormat.kt
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+enum class PixelFormat(val value: Int) {
+    UNKNOWN(0),
+    TRANSLUCENT(-3),
+    TRANSPARENT(-2),
+    OPAQUE(-1),
+    RGBA_8888(1),
+    RGBX_8888(2),
+    RGB_888(3),
+    RGB_565(4),
+    RGBA_F16(0x16),
+    RGBA_1010102(0x2B);
+
+    companion object {
+        fun fromName(name: String?): PixelFormat? {
+            return name?.let { PixelFormat.values().find { it.name == name } }
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/RotationAnimation.kt b/libraries/flicker/utils/src/android/tools/traces/wm/RotationAnimation.kt
new file mode 100644
index 000000000..35663d706
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/RotationAnimation.kt
@@ -0,0 +1,30 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+enum class RotationAnimation(val value: Int) {
+    ROTATION_ANIMATION_UNSPECIFIED(-1),
+    ROTATION_ANIMATION_CROSSFADE(1),
+    ROTATION_ANIMATION_JUMPCUT(2),
+    ROTATION_ANIMATION_SEAMLESS(3);
+
+    companion object {
+        fun fromName(name: String?): RotationAnimation? {
+            return name?.let { RotationAnimation.values().find { it.name == name } }
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/ScreenOrientation.kt b/libraries/flicker/utils/src/android/tools/traces/wm/ScreenOrientation.kt
new file mode 100644
index 000000000..99c914e5a
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/ScreenOrientation.kt
@@ -0,0 +1,43 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+enum class ScreenOrientation(val value: Int) {
+    SCREEN_ORIENTATION_UNSET(-2),
+    SCREEN_ORIENTATION_UNSPECIFIED(-1),
+    SCREEN_ORIENTATION_LANDSCAPE(0),
+    SCREEN_ORIENTATION_PORTRAIT(1),
+    SCREEN_ORIENTATION_USER(2),
+    SCREEN_ORIENTATION_BEHIND(3),
+    SCREEN_ORIENTATION_SENSOR(4),
+    SCREEN_ORIENTATION_NOSENSOR(5),
+    SCREEN_ORIENTATION_SENSOR_LANDSCAPE(6),
+    SCREEN_ORIENTATION_SENSOR_PORTRAIT(7),
+    SCREEN_ORIENTATION_REVERSE_LANDSCAPE(8),
+    SCREEN_ORIENTATION_REVERSE_PORTRAIT(9),
+    SCREEN_ORIENTATION_FULL_SENSOR(10),
+    SCREEN_ORIENTATION_USER_LANDSCAPE(11),
+    SCREEN_ORIENTATION_USER_PORTRAIT(12),
+    SCREEN_ORIENTATION_FULL_USER(13),
+    SCREEN_ORIENTATION_LOCKED(14);
+
+    companion object {
+        fun fromName(name: String?): ScreenOrientation? {
+            return name?.let { values().find { it.name == name } }
+        }
+    }
+}
diff --git a/libraries/flicker/utils/src/android/tools/traces/wm/UserRotationMode.kt b/libraries/flicker/utils/src/android/tools/traces/wm/UserRotationMode.kt
new file mode 100644
index 000000000..320fbeeef
--- /dev/null
+++ b/libraries/flicker/utils/src/android/tools/traces/wm/UserRotationMode.kt
@@ -0,0 +1,28 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.traces.wm
+
+enum class UserRotationMode(val value: Int) {
+    USER_ROTATION_FREE(0),
+    USER_ROTATION_LOCKED(1);
+
+    companion object {
+        fun fromName(name: String?): UserRotationMode? {
+            return name?.let { UserRotationMode.values().find { it.name == name } }
+        }
+    }
+}
diff --git a/libraries/flicker/utils/test/Android.bp b/libraries/flicker/utils/test/Android.bp
index 5b9609f08..df6dd15c3 100644
--- a/libraries/flicker/utils/test/Android.bp
+++ b/libraries/flicker/utils/test/Android.bp
@@ -22,8 +22,8 @@ package {
 filegroup {
     name: "FlickerLibTest-Utils-src",
     srcs: [
-        "src/**/utils/*.kt",
-        "src/**/rules/*.kt",
+        "src/**/testutils/*.kt",
+        "src/**/testrules/*.kt",
     ],
 }
 
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace.perfetto-trace
new file mode 100644
index 000000000..bd4ce5578
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_activity_transition.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_activity_transition.perfetto-trace
new file mode 100644
index 000000000..d422cf93a
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_activity_transition.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_dump.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_dump.perfetto-trace
new file mode 100644
index 000000000..94e4ccc16
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_dump.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_ime.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_ime.perfetto-trace
new file mode 100644
index 000000000..15e97721e
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_ime.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_open_and_close_chrome.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_open_and_close_chrome.perfetto-trace
new file mode 100644
index 000000000..73fa321a3
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_open_and_close_chrome.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace
new file mode 100644
index 000000000..c33af2ee3
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_open_app_cold.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome.perfetto-trace
new file mode 100644
index 000000000..14ed69faf
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome2.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome2.perfetto-trace
new file mode 100644
index 000000000..d6a1f9950
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_openchrome2.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_resumed_activities_in_stack.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_resumed_activities_in_stack.perfetto-trace
new file mode 100644
index 000000000..917cb03e9
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_resumed_activities_in_stack.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/assets/testdata/wm_trace_rotation.perfetto-trace b/libraries/flicker/utils/test/assets/testdata/wm_trace_rotation.perfetto-trace
new file mode 100644
index 000000000..faa587894
Binary files /dev/null and b/libraries/flicker/utils/test/assets/testdata/wm_trace_rotation.perfetto-trace differ
diff --git a/libraries/flicker/utils/test/src/android/tools/TimeUtilsTest.kt b/libraries/flicker/utils/test/src/android/tools/TimeUtilsTest.kt
index 58bac59a2..524eab9eb 100644
--- a/libraries/flicker/utils/test/src/android/tools/TimeUtilsTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/TimeUtilsTest.kt
@@ -16,8 +16,8 @@
 
 package android.tools
 
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import android.tools.traces.formatRealTimestamp
-import android.tools.utils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/UtilsTest.kt b/libraries/flicker/utils/test/src/android/tools/UtilsTest.kt
index 428efbcc9..4d57fb24a 100644
--- a/libraries/flicker/utils/test/src/android/tools/UtilsTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/UtilsTest.kt
@@ -17,10 +17,10 @@
 package android.tools
 
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import android.tools.traces.NullableDeviceStateDump
 import android.tools.traces.getCurrentState
 import android.tools.traces.getCurrentStateDumpNullable
-import android.tools.utils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ArtifactBuilderTest.kt b/libraries/flicker/utils/test/src/android/tools/io/ArtifactBuilderTest.kt
index 38f492b4d..48d5ff1d1 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ArtifactBuilderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ArtifactBuilderTest.kt
@@ -16,10 +16,10 @@
 
 package android.tools.io
 
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.createDefaultArtifactBuilder
 import android.tools.traces.io.ArtifactBuilder
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.createDefaultArtifactBuilder
 import com.google.common.truth.Truth
 import java.io.File
 import kotlin.io.path.createTempDirectory
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ArtifactTest.kt b/libraries/flicker/utils/test/src/android/tools/io/ArtifactTest.kt
index 7c6284244..58ef03dae 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ArtifactTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ArtifactTest.kt
@@ -16,7 +16,7 @@
 
 package android.tools.io
 
-import android.tools.utils.createDefaultArtifactBuilder
+import android.tools.testutils.createDefaultArtifactBuilder
 import com.google.common.truth.Truth
 import kotlin.io.path.createTempDirectory
 import org.junit.Test
diff --git a/libraries/flicker/utils/test/src/android/tools/io/BaseResultReaderTestParseTrace.kt b/libraries/flicker/utils/test/src/android/tools/io/BaseResultReaderTestParseTrace.kt
index 60b532d08..571f31d95 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/BaseResultReaderTestParseTrace.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/BaseResultReaderTestParseTrace.kt
@@ -19,16 +19,16 @@ package android.tools.io
 import android.tools.Timestamp
 import android.tools.Timestamps
 import android.tools.Trace
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TestTraces
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TestTraces
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import com.google.common.truth.Truth
 import java.io.File
 import org.junit.Before
@@ -48,6 +48,7 @@ abstract class BaseResultReaderTestParseTrace {
         get() = "$traceName contained 0 entries, expected at least 2"
 
     protected abstract fun doParse(reader: ResultReader): Trace<*>?
+
     protected abstract fun getTime(traceTime: Timestamp): Long
 
     protected open fun setupWriter(writer: ResultWriter): ResultWriter {
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultArtifactDescriptorTest.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultArtifactDescriptorTest.kt
index 6628c3c72..fbc60c987 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultArtifactDescriptorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultArtifactDescriptorTest.kt
@@ -16,7 +16,7 @@
 
 package android.tools.io
 
-import android.tools.utils.CleanFlickerEnvironmentRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseEventLog.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseEventLogTest.kt
similarity index 93%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseEventLog.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseEventLogTest.kt
index 22635dd58..af0f83f5b 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseEventLog.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseEventLogTest.kt
@@ -17,14 +17,14 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 import org.junit.FixMethodOrder
 import org.junit.runners.MethodSorters
 
 /** Tests for [ResultReader] parsing event log */
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
-class ResultReaderTestParseEventLog : BaseResultReaderTestParseTrace() {
+class ResultReaderParseEventLogTest : BaseResultReaderTestParseTrace() {
     override val assetFiles = mapOf(TraceType.EVENT_LOG to TestTraces.EventLog.FILE)
     override val traceName = "Event Log"
     override val startTimeTrace = TestTraces.EventLog.START_TIME
@@ -35,5 +35,6 @@ class ResultReaderTestParseEventLog : BaseResultReaderTestParseTrace() {
     override val invalidSizeMessage: String = "'to' needs to be greater than 'from'"
 
     override fun doParse(reader: ResultReader) = reader.readEventLogTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.unixNanos
 }
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLayers.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLayersTest.kt
similarity index 92%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLayers.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLayersTest.kt
index bba2c24f3..17b06e81e 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLayers.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLayersTest.kt
@@ -17,11 +17,11 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 
 /** Tests for [ResultReader] parsing [TraceType.SF] */
-class ResultReaderTestParseLayers : BaseResultReaderTestParseTrace() {
+class ResultReaderParseLayersTest : BaseResultReaderTestParseTrace() {
     override val assetFiles = mapOf(TraceType.SF to TestTraces.LayerTrace.FILE)
     override val traceName = "Layers trace"
     override val startTimeTrace = TestTraces.LayerTrace.START_TIME
@@ -31,5 +31,6 @@ class ResultReaderTestParseLayers : BaseResultReaderTestParseTrace() {
     override val expectedSlicedTraceSize = 2
 
     override fun doParse(reader: ResultReader) = reader.readLayersTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.systemUptimeNanos
 }
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLegacyTransitions.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLegacyTransitionsTest.kt
similarity index 93%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLegacyTransitions.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLegacyTransitionsTest.kt
index 81db2a00b..c44ae9a6b 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseLegacyTransitions.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseLegacyTransitionsTest.kt
@@ -17,15 +17,15 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
+import android.tools.testutils.readAssetAsFile
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
-import android.tools.utils.TestTraces
-import android.tools.utils.readAssetAsFile
 import org.junit.Assume.assumeFalse
 import org.junit.Before
 
 /** Tests for [ResultReader] parsing [TraceType.TRANSITION] */
-class ResultReaderTestParseLegacyTransitions : BaseResultReaderTestParseTrace() {
+class ResultReaderParseLegacyTransitionsTest : BaseResultReaderTestParseTrace() {
     override val assetFiles =
         mapOf(
             TraceType.LEGACY_WM_TRANSITION to TestTraces.LegacyTransitionTrace.WM_FILE,
@@ -45,7 +45,9 @@ class ResultReaderTestParseLegacyTransitions : BaseResultReaderTestParseTrace()
     }
 
     override fun doParse(reader: ResultReader) = reader.readTransitionsTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.elapsedNanos
+
     override fun setupWriter(writer: ResultWriter): ResultWriter {
         return super.setupWriter(writer).also {
             val wmTransitionTrace = readAssetAsFile("wm_transition_trace.winscope")
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseProtoLog.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseProtoLogTest.kt
similarity index 94%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseProtoLog.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseProtoLogTest.kt
index 256adf00d..7388d0e18 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseProtoLog.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseProtoLogTest.kt
@@ -17,15 +17,15 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 import org.junit.Assume.assumeTrue
 import org.junit.Before
 import org.junit.Ignore
 import org.junit.Test
 
 /** Tests for [ResultReader] parsing [TraceType.PROTOLOG] */
-class ResultReaderTestParseProtoLog : BaseResultReaderTestParseTrace() {
+class ResultReaderParseProtoLogTest : BaseResultReaderTestParseTrace() {
     override val assetFiles = mapOf(TraceType.PERFETTO to TestTraces.ProtoLogTrace.FILE)
     override val traceName = "ProtoLog trace"
     override val startTimeTrace = TestTraces.ProtoLogTrace.START_TIME
@@ -41,6 +41,7 @@ class ResultReaderTestParseProtoLog : BaseResultReaderTestParseTrace() {
     }
 
     override fun doParse(reader: ResultReader) = reader.readProtoLogTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.elapsedNanos
 
     @Test
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransactions.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransactionsTest.kt
similarity index 93%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransactions.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransactionsTest.kt
index eeb489713..2a054eb8a 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransactions.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransactionsTest.kt
@@ -17,11 +17,11 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 
 /** Tests for [ResultReader] parsing [TraceType.TRANSACTION] */
-class ResultReaderTestParseTransactions : BaseResultReaderTestParseTrace() {
+class ResultReaderParseTransactionsTest : BaseResultReaderTestParseTrace() {
     override val assetFiles = mapOf(TraceType.TRANSACTION to TestTraces.TransactionTrace.FILE)
     override val traceName = "Transactions trace"
     override val startTimeTrace = TestTraces.TransactionTrace.START_TIME
@@ -32,5 +32,6 @@ class ResultReaderTestParseTransactions : BaseResultReaderTestParseTrace() {
     override val expectedSlicedTraceSize = 2
 
     override fun doParse(reader: ResultReader) = reader.readTransactionsTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.elapsedNanos
 }
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransitions.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransitionsTest.kt
similarity index 94%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransitions.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransitionsTest.kt
index b36369896..cae26bcc1 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseTransitions.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseTransitionsTest.kt
@@ -17,13 +17,13 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 import org.junit.Assume.assumeTrue
 import org.junit.Before
 
 /** Tests for [ResultReader] parsing [TraceType.TRANSITION] */
-class ResultReaderTestParseTransitions : BaseResultReaderTestParseTrace() {
+class ResultReaderParseTransitionsTest : BaseResultReaderTestParseTrace() {
     override val assetFiles = mapOf(TraceType.PERFETTO to TestTraces.TransitionTrace.FILE)
     override val traceName = "Transitions trace"
     override val startTimeTrace = TestTraces.TransitionTrace.START_TIME
@@ -39,5 +39,6 @@ class ResultReaderTestParseTransitions : BaseResultReaderTestParseTrace() {
     }
 
     override fun doParse(reader: ResultReader) = reader.readTransitionsTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.elapsedNanos
 }
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseWM.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseWMTest.kt
similarity index 81%
rename from libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseWM.kt
rename to libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseWMTest.kt
index 8b6373e7e..bac5fcb92 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTestParseWM.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderParseWMTest.kt
@@ -17,12 +17,16 @@
 package android.tools.io
 
 import android.tools.Timestamp
+import android.tools.testutils.TestTraces
 import android.tools.traces.io.ResultReader
-import android.tools.utils.TestTraces
 
 /** Tests for [ResultReader] parsing [TraceType.WM] */
-class ResultReaderTestParseWM : BaseResultReaderTestParseTrace() {
-    override val assetFiles = mapOf(TraceType.WM to TestTraces.WMTrace.FILE)
+class ResultReaderParseWMTest : BaseResultReaderTestParseTrace() {
+    override val assetFiles =
+        mapOf(
+            TraceType.PERFETTO to TestTraces.WMTrace.FILE,
+            TraceType.WM to TestTraces.LegacyWMTrace.FILE
+        )
     override val traceName = "WM trace"
     override val startTimeTrace = TestTraces.WMTrace.START_TIME
     override val endTimeTrace = TestTraces.WMTrace.END_TIME
@@ -31,5 +35,6 @@ class ResultReaderTestParseWM : BaseResultReaderTestParseTrace() {
     override val expectedSlicedTraceSize: Int = 2
 
     override fun doParse(reader: ResultReader) = reader.readWmTrace()
+
     override fun getTime(traceTime: Timestamp) = traceTime.elapsedNanos
 }
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTest.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTest.kt
index 37beb0f5d..95c0f1efc 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultReaderTest.kt
@@ -17,13 +17,13 @@
 package android.tools.io
 
 import android.tools.Timestamps
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.assertThrows
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.ResultReader
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.assertThrows
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import com.google.common.truth.Truth
 import java.io.FileNotFoundException
 import org.junit.Before
diff --git a/libraries/flicker/utils/test/src/android/tools/io/ResultWriterTest.kt b/libraries/flicker/utils/test/src/android/tools/io/ResultWriterTest.kt
index 2808f46df..6772db336 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/ResultWriterTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/ResultWriterTest.kt
@@ -19,17 +19,17 @@ package android.tools.io
 import android.annotation.SuppressLint
 import android.tools.ScenarioBuilder
 import android.tools.Timestamps
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
+import android.tools.testutils.TestTraces
+import android.tools.testutils.assertExceptionMessage
+import android.tools.testutils.assertThrows
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.ResultReader
 import android.tools.traces.io.ResultWriter
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
-import android.tools.utils.TestTraces
-import android.tools.utils.assertExceptionMessage
-import android.tools.utils.assertThrows
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import com.google.common.truth.Truth
 import java.io.File
 import kotlin.io.path.createTempDirectory
@@ -121,7 +121,8 @@ class ResultWriterTest {
 
     @Test
     fun writeWMTrace() {
-        val writer = newTestResultWriter().addTraceResult(TraceType.WM, TestTraces.WMTrace.FILE)
+        val writer =
+            newTestResultWriter().addTraceResult(TraceType.WM, TestTraces.LegacyWMTrace.FILE)
         val result = writer.write()
         val reader = ResultReader(result, TRACE_CONFIG_REQUIRE_CHANGES)
         Truth.assertWithMessage("File count").that(reader.countFiles()).isEqualTo(1)
@@ -181,7 +182,7 @@ class ResultWriterTest {
     fun writeAllTraces() {
         val writer =
             newTestResultWriter()
-                .addTraceResult(TraceType.WM, TestTraces.WMTrace.FILE)
+                .addTraceResult(TraceType.WM, TestTraces.LegacyWMTrace.FILE)
                 .addTraceResult(TraceType.SF, TestTraces.LayerTrace.FILE)
                 .addTraceResult(TraceType.TRANSACTION, TestTraces.TransactionTrace.FILE)
                 .addTraceResult(
diff --git a/libraries/flicker/utils/test/src/android/tools/io/RunStatusTest.kt b/libraries/flicker/utils/test/src/android/tools/io/RunStatusTest.kt
index 196937b9d..e9e7be15f 100644
--- a/libraries/flicker/utils/test/src/android/tools/io/RunStatusTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/io/RunStatusTest.kt
@@ -16,9 +16,9 @@
 
 package android.tools.io
 
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.TEST_SCENARIO
 import android.tools.traces.io.ArtifactBuilder
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.TEST_SCENARIO
 import com.google.common.truth.Truth
 import kotlin.io.path.createTempDirectory
 import org.junit.ClassRule
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/PerfettoTraceMonitorTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/PerfettoTraceMonitorTest.kt
index c1bbd6512..7edb01176 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/PerfettoTraceMonitorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/PerfettoTraceMonitorTest.kt
@@ -18,6 +18,7 @@ package android.tools.monitors
 
 import android.tools.device.apphelpers.BrowserAppHelper
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import android.tools.traces.monitors.PerfettoTraceMonitor
 import android.tools.traces.monitors.withSFTracing
 import android.tools.traces.monitors.withTransactionsTracing
@@ -25,7 +26,6 @@ import android.tools.traces.parsers.WindowManagerStateHelper
 import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransitionsTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
 import com.android.server.wm.flicker.helpers.ImeAppHelper
 import com.google.common.truth.Truth
 import org.junit.Assume.assumeTrue
@@ -115,18 +115,19 @@ class PerfettoTraceMonitorTest : TraceMonitorTest<PerfettoTraceMonitor>() {
         assumeTrue("PerfettoIme flag should be enabled", android.tracing.Flags.perfettoIme())
 
         val traceMonitor = PerfettoTraceMonitor.newBuilder().enableImeTrace().build()
-        val traceData = traceMonitor.withTracing {
-            val wmHelper = WindowManagerStateHelper()
-            val imeApp = ImeAppHelper(instrumentation)
-            imeApp.launchViaIntent(wmHelper)
-            imeApp.openIME(wmHelper)
-        }
+        val traceData =
+            traceMonitor.withTracing {
+                val wmHelper = WindowManagerStateHelper()
+                val imeApp = ImeAppHelper(instrumentation)
+                imeApp.launchViaIntent(wmHelper)
+                imeApp.openIME(wmHelper)
+            }
         assertTrace(traceData)
 
         val queryRowsCount = { session: TraceProcessorSession, tableName: String ->
             val sql =
                 "INCLUDE PERFETTO MODULE android.winscope.inputmethod;" +
-                        "SELECT COUNT(*) FROM $tableName;"
+                    "SELECT COUNT(*) FROM $tableName;"
             session.query(
                 sql,
                 { rows ->
@@ -146,11 +147,14 @@ class PerfettoTraceMonitorTest : TraceMonitorTest<PerfettoTraceMonitor>() {
             }
 
         Truth.assertWithMessage("TP doesn't contain IME client rows")
-            .that(countRowsClients).isGreaterThan(0L)
+            .that(countRowsClients)
+            .isGreaterThan(0L)
         Truth.assertWithMessage("TP doesn't contain IME manager service rows")
-            .that(countRowsManagerService).isGreaterThan(0L)
+            .that(countRowsManagerService)
+            .isGreaterThan(0L)
         Truth.assertWithMessage("TP doesn't contain IME service rows")
-            .that(countRowsService).isGreaterThan(0L)
+            .that(countRowsService)
+            .isGreaterThan(0L)
     }
 
     @Test
@@ -188,6 +192,71 @@ class PerfettoTraceMonitorTest : TraceMonitorTest<PerfettoTraceMonitor>() {
             .isGreaterThan(0L)
     }
 
+    @Test
+    fun windowManagerTracingTest() {
+        assumeTrue(
+            "PerfettoWmTracing flag should be enabled",
+            android.tracing.Flags.perfettoWmTracing()
+        )
+
+        val traceMonitor = PerfettoTraceMonitor.newBuilder().enableWindowManagerTrace().build()
+        val traceData =
+            traceMonitor.withTracing {
+                BrowserAppHelper().launchViaIntent()
+                device.pressHome()
+                device.pressRecentApps()
+            }
+        assertTrace(traceData)
+
+        val countRows =
+            TraceProcessorSession.loadPerfettoTrace(traceData) { session ->
+                val sql =
+                    "INCLUDE PERFETTO MODULE android.winscope.windowmanager;" +
+                        "SELECT COUNT(*) FROM android_windowmanager;"
+                session.query(
+                    sql,
+                    { rows ->
+                        require(rows.size == 1)
+                        rows.get(0).get("COUNT(*)") as Long
+                    }
+                )
+            }
+
+        Truth.assertWithMessage("TP doesn't contain WindowManager rows")
+            .that(countRows)
+            .isGreaterThan(0L)
+    }
+
+    @Test
+    fun windowManagerDumpTest() {
+        assumeTrue(
+            "PerfettoWmTracing flag should be enabled",
+            android.tracing.Flags.perfettoWmTracing()
+        )
+
+        val traceData =
+            PerfettoTraceMonitor.newBuilder().enableWindowManagerDump().build().withTracing {}
+        assertTrace(traceData)
+
+        val countRows =
+            TraceProcessorSession.loadPerfettoTrace(traceData) { session ->
+                val sql =
+                    "INCLUDE PERFETTO MODULE android.winscope.windowmanager;" +
+                        "SELECT COUNT(*) FROM android_windowmanager;"
+                session.query(
+                    sql,
+                    { rows ->
+                        require(rows.size == 1)
+                        rows.get(0).get("COUNT(*)") as Long
+                    }
+                )
+            }
+
+        Truth.assertWithMessage("TP doesn't contain WindowManager dump rows")
+            .that(countRows)
+            .isEqualTo(1L)
+    }
+
     companion object {
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/ScreenRecorderTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/ScreenRecorderTest.kt
index 4340ea9f5..99f197c12 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/ScreenRecorderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/ScreenRecorderTest.kt
@@ -22,11 +22,11 @@ import android.media.MediaFormat
 import android.media.MediaParser
 import android.os.SystemClock
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
 import android.tools.traces.monitors.ScreenRecorder
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newTestResultWriter
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.UiDevice
 import com.google.common.truth.Truth
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/TraceMonitorTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/TraceMonitorTest.kt
index 579cafbbd..f13e5b543 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/TraceMonitorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/TraceMonitorTest.kt
@@ -20,13 +20,13 @@ import android.app.Instrumentation
 import android.tools.Tag
 import android.tools.io.RunStatus
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newTestResultWriter
+import android.tools.testutils.outputFileName
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.deleteIfExists
 import android.tools.traces.io.ResultReader
 import android.tools.traces.monitors.TraceMonitor
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newTestResultWriter
-import android.tools.utils.outputFileName
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.UiDevice
 import com.google.common.truth.Truth
@@ -37,7 +37,9 @@ import org.junit.Test
 
 abstract class TraceMonitorTest<T : TraceMonitor> {
     abstract fun getMonitor(): T
+
     abstract fun assertTrace(traceData: ByteArray)
+
     abstract val traceType: TraceType
 
     protected open val tag = Tag.ALL
@@ -46,7 +48,7 @@ abstract class TraceMonitorTest<T : TraceMonitor> {
     protected val traceMonitor by lazy { getMonitor() }
 
     @Before
-    fun before() {
+    open fun before() {
         Truth.assertWithMessage("Trace already enabled before starting test")
             .that(traceMonitor.isEnabled)
             .isFalse()
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/events/EventLogMonitorTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/events/EventLogMonitorTest.kt
index 178718c84..c5f88c00a 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/events/EventLogMonitorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/events/EventLogMonitorTest.kt
@@ -18,16 +18,17 @@ package android.tools.monitors.events
 
 import android.tools.io.TraceType
 import android.tools.monitors.TraceMonitorTest
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.events.CujEvent
 import android.tools.traces.events.CujType
 import android.tools.traces.events.EventLog.Companion.MAGIC_NUMBER
 import android.tools.traces.events.FocusEvent
+import android.tools.traces.events.UnknownCuj
 import android.tools.traces.io.ResultReader
 import android.tools.traces.monitors.events.EventLogMonitor
 import android.tools.traces.now
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newTestResultWriter
 import android.util.EventLog
 import com.android.internal.jank.EventLogTags
 import com.google.common.truth.Truth
@@ -42,6 +43,7 @@ import org.junit.Test
  */
 class EventLogMonitorTest : TraceMonitorTest<EventLogMonitor>() {
     override val traceType = TraceType.EVENT_LOG
+
     override fun getMonitor(): EventLogMonitor = EventLogMonitor()
 
     override fun assertTrace(traceData: ByteArray) {
@@ -438,9 +440,9 @@ class EventLogMonitorTest : TraceMonitorTest<EventLogMonitor>() {
         requireNotNull(eventLog) { "EventLog should have been created" }
 
         assertEquals(3, eventLog.cujEvents.size)
-        Truth.assertThat(eventLog.cujEvents.first().cuj).isEqualTo(CujType.UNKNOWN)
-        Truth.assertThat(eventLog.cujEvents.drop(1).first().cuj).isEqualTo(CujType.UNKNOWN)
-        Truth.assertThat(eventLog.cujEvents.drop(2).first().cuj).isEqualTo(CujType.UNKNOWN)
+        Truth.assertThat(eventLog.cujEvents.first().cuj).isEqualTo(UnknownCuj(unknownCujId))
+        Truth.assertThat(eventLog.cujEvents.drop(1).first().cuj).isEqualTo(UnknownCuj(unknownCujId))
+        Truth.assertThat(eventLog.cujEvents.drop(2).first().cuj).isEqualTo(UnknownCuj(unknownCujId))
     }
 
     private companion object {
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/view/ViewTraceMonitorTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/view/ViewTraceMonitorTest.kt
index 2c0df3fa5..99c5fce7b 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/view/ViewTraceMonitorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/view/ViewTraceMonitorTest.kt
@@ -18,17 +18,20 @@ package android.tools.monitors.view
 
 import android.tools.io.TraceType
 import android.tools.monitors.TraceMonitorTest
+import android.tools.testutils.assertArchiveContainsFiles
+import android.tools.testutils.getActualTraceFilesFromArchive
+import android.tools.testutils.getLauncherPackageName
+import android.tools.testutils.getSystemUiUidName
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
 import android.tools.traces.monitors.view.ViewTraceMonitor
-import android.tools.utils.assertArchiveContainsFiles
-import android.tools.utils.getActualTraceFilesFromArchive
-import android.tools.utils.getLauncherPackageName
-import android.tools.utils.getSystemUiUidName
-import android.tools.utils.newTestResultWriter
+import android.tracing.Flags
 import com.android.systemui.Flags.enableViewCaptureTracing
 import com.google.common.truth.Truth
 import java.io.File
+import org.junit.Assume
+import org.junit.Before
 import org.junit.FixMethodOrder
 import org.junit.Test
 import org.junit.runners.MethodSorters
@@ -44,6 +47,12 @@ class ViewTraceMonitorTest : TraceMonitorTest<ViewTraceMonitor>() {
         Truth.assertThat(traceData.size).isGreaterThan(0)
     }
 
+    @Before
+    override fun before() {
+        Assume.assumeFalse(Flags.perfettoViewCaptureTracing())
+        super.before()
+    }
+
     @Test
     @Throws(Exception::class)
     override fun captureTrace() {
diff --git a/libraries/flicker/utils/test/src/android/tools/monitors/wm/WindowManagerTraceMonitorTest.kt b/libraries/flicker/utils/test/src/android/tools/monitors/wm/WindowManagerTraceMonitorTest.kt
index 1e04cd0fa..9d9eaa222 100644
--- a/libraries/flicker/utils/test/src/android/tools/monitors/wm/WindowManagerTraceMonitorTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/monitors/wm/WindowManagerTraceMonitorTest.kt
@@ -18,13 +18,15 @@ package android.tools.monitors.wm
 
 import android.tools.io.TraceType
 import android.tools.monitors.TraceMonitorTest
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newTestResultWriter
 import android.tools.traces.TRACE_CONFIG_REQUIRE_CHANGES
 import android.tools.traces.io.ResultReader
 import android.tools.traces.monitors.wm.WindowManagerTraceMonitor
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newTestResultWriter
 import com.android.server.wm.nano.WindowManagerTraceFileProto
 import com.google.common.truth.Truth
+import org.junit.Assume
+import org.junit.Before
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
 import org.junit.Test
@@ -34,6 +36,7 @@ import org.junit.runners.MethodSorters
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
 class WindowManagerTraceMonitorTest : TraceMonitorTest<WindowManagerTraceMonitor>() {
     override val traceType = TraceType.WM
+
     override fun getMonitor() = WindowManagerTraceMonitor()
 
     override fun assertTrace(traceData: ByteArray) {
@@ -46,8 +49,15 @@ class WindowManagerTraceMonitorTest : TraceMonitorTest<WindowManagerTraceMonitor
             )
     }
 
+    @Before
+    override fun before() {
+        Assume.assumeFalse(android.tracing.Flags.perfettoWmTracing())
+    }
+
     @Test
     fun includesProtologTrace() {
+        Assume.assumeFalse(android.tracing.Flags.perfettoProtologTracing())
+
         val monitor = getMonitor()
         monitor.start()
         val writer = newTestResultWriter()
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/TraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/TraceParserTest.kt
index 57146a008..dba7c04a1 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/TraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/TraceParserTest.kt
@@ -18,9 +18,9 @@ package android.tools.parsers
 
 import android.tools.Timestamp
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.MockWindowManagerTraceBuilder
-import android.tools.utils.MockWindowStateBuilder
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.MockWindowManagerTraceBuilder
+import android.tools.testutils.MockWindowStateBuilder
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.Test
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/WindowManagerStateHelperTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/WindowManagerStateHelperTest.kt
index c03f606bb..871a5ad18 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/WindowManagerStateHelperTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/WindowManagerStateHelperTest.kt
@@ -25,6 +25,9 @@ import android.tools.Timestamps
 import android.tools.datatypes.ActiveBuffer
 import android.tools.datatypes.Matrix33
 import android.tools.datatypes.defaultColor
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.getWmDumpReaderFromAsset
+import android.tools.testutils.getWmTraceReaderFromAsset
 import android.tools.traces.ConditionsFactory
 import android.tools.traces.DeviceStateDump
 import android.tools.traces.component.ComponentNameMatcher
@@ -36,9 +39,6 @@ import android.tools.traces.surfaceflinger.LayerTraceEntryBuilder
 import android.tools.traces.surfaceflinger.Transform
 import android.tools.traces.wm.WindowManagerState
 import android.tools.traces.wm.WindowManagerTrace
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.getWmDumpReaderFromAsset
-import android.tools.utils.getWmTraceReaderFromAsset
 import androidx.core.graphics.toRect
 import androidx.test.filters.FlakyTest
 import androidx.test.platform.app.InstrumentationRegistry
@@ -193,7 +193,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canWaitForIme() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_ime.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_ime", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -214,7 +214,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canFailImeNotShown() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_ime.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_ime", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -235,7 +235,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canWaitForWindow() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -259,7 +259,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canFailWindowNotShown() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_app_cold", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -280,8 +280,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canDetectHomeActivityVisibility() {
-        val reader =
-            getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -306,8 +305,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canWaitActivityRemoved() {
-        val reader =
-            getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -333,8 +331,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canWaitAppStateIdle() {
-        val reader =
-            getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_and_close_chrome", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val initialTimestamp = 69443918698679
         val supplier = trace.asSupplier(startingTimestamp = initialTimestamp)
@@ -354,7 +351,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canWaitForRotation() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_rotation.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_rotation", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
@@ -379,7 +376,7 @@ class WindowManagerStateHelperTest {
 
     @Test
     fun canDetectResumedActivitiesInStacks() {
-        val reader = getWmDumpReaderFromAsset("wm_trace_resumed_activities_in_stack.pb")
+        val reader = getWmDumpReaderFromAsset("wm_trace_resumed_activities_in_stack")
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val entry = trace.entries.first()
         Truth.assertWithMessage("Trace should have a resumed activity in stacks")
@@ -390,7 +387,7 @@ class WindowManagerStateHelperTest {
     @FlakyTest
     @Test
     fun canWaitForRecents() {
-        val reader = getWmTraceReaderFromAsset("wm_trace_open_recents.pb", legacyTrace = true)
+        val reader = getWmTraceReaderFromAsset("wm_trace_open_recents", legacyTrace = true)
         val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
         val supplier = trace.asSupplier()
         val helper =
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/ArgsTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/ArgsTest.kt
index a48ddfc93..e2ff49284 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/ArgsTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/ArgsTest.kt
@@ -16,8 +16,8 @@
 
 package android.tools.parsers.perfetto
 
+import android.tools.testutils.assertThrows
 import android.tools.traces.parsers.perfetto.Args
-import android.tools.utils.assertThrows
 import com.google.common.truth.Truth
 import java.lang.ClassCastException
 import org.junit.Test
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/LayerTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/LayerTraceParserTest.kt
index 348487331..e7729f965 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/LayerTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/LayerTraceParserTest.kt
@@ -17,10 +17,10 @@
 package android.tools.parsers.perfetto
 
 import android.tools.Cache
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/TransactionsTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/TransactionsTraceParserTest.kt
index 09d7c3f37..2a6d3a21c 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/TransactionsTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/TransactionsTraceParserTest.kt
@@ -17,10 +17,10 @@
 package android.tools.parsers.perfetto
 
 import android.tools.Cache
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransactionsTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/WindowManagerTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/WindowManagerTraceParserTest.kt
new file mode 100644
index 000000000..49bd041a1
--- /dev/null
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/perfetto/WindowManagerTraceParserTest.kt
@@ -0,0 +1,76 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.tools.parsers.perfetto
+
+import android.tools.Cache
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
+import android.tools.traces.monitors.PerfettoTraceMonitor
+import android.tools.traces.parsers.perfetto.TraceProcessorSession
+import android.tools.traces.parsers.perfetto.WindowManagerTraceParser
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.UiDevice
+import com.google.common.truth.Truth
+import org.junit.Assume
+import org.junit.Before
+import org.junit.ClassRule
+import org.junit.Test
+
+/** Tests for [WindowManagerTraceParser] */
+class WindowManagerTraceParserTest {
+    @Before
+    fun before() {
+        Cache.clear()
+    }
+
+    @Test
+    fun canParseAllEntriesFromStoredTrace() {
+        val trace =
+            TraceProcessorSession.loadPerfettoTrace(
+                readAsset("wm_trace_openchrome.perfetto-trace")
+            ) { session ->
+                WindowManagerTraceParser().parse(session)
+            }
+        val firstEntry = trace.entries.first()
+        Truth.assertThat(firstEntry.timestamp.elapsedNanos).isEqualTo(9213763541297L)
+        Truth.assertThat(firstEntry.windowStates.size).isEqualTo(10)
+        Truth.assertThat(firstEntry.visibleWindows.size).isEqualTo(5)
+        Truth.assertThat(trace.entries.last().timestamp.elapsedNanos).isEqualTo(9216093628925L)
+    }
+
+    @Test
+    fun canParseAllEntriesFromNewTrace() {
+        Assume.assumeTrue(android.tracing.Flags.perfettoWmTracing())
+
+        val device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
+        val monitor = PerfettoTraceMonitor.Builder().enableWindowManagerTrace().build()
+        val data =
+            monitor.withTracing {
+                device.pressHome()
+                device.pressRecentApps()
+            }
+        val trace =
+            TraceProcessorSession.loadPerfettoTrace(data) { session ->
+                WindowManagerTraceParser().parse(session)
+            }
+        Truth.assertThat(trace.entries).isNotEmpty()
+    }
+
+    companion object {
+        @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
+    }
+}
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyShellLegacyTransitionTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyShellLegacyTransitionTraceParserTest.kt
index 443e2582b..3343e24c1 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyShellLegacyTransitionTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyShellLegacyTransitionTraceParserTest.kt
@@ -19,10 +19,10 @@ package android.tools.parsers.wm
 import android.app.Instrumentation
 import android.tools.Cache
 import android.tools.device.apphelpers.MessagingAppHelper
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.monitors.wm.LegacyShellTransitionTraceMonitor
 import android.tools.traces.parsers.wm.ShellTransitionTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
 import android.tracing.Flags
 import androidx.test.filters.FlakyTest
 import androidx.test.platform.app.InstrumentationRegistry
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyTransitionTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyTransitionTraceParserTest.kt
index d68fc3cb8..703c6c121 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyTransitionTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyTransitionTraceParserTest.kt
@@ -17,15 +17,11 @@
 package android.tools.parsers.wm
 
 import android.tools.Cache
-import android.tools.traces.monitors.wm.WindowManagerTraceMonitor
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
 import android.tools.traces.parsers.perfetto.TransitionsTraceParser
 import android.tools.traces.parsers.wm.LegacyTransitionTraceParser
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
-import androidx.test.platform.app.InstrumentationRegistry
-import androidx.test.uiautomator.UiDevice
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
@@ -66,18 +62,6 @@ class LegacyTransitionTraceParserTest {
             .contains(35)
     }
 
-    @Test
-    fun canParseAllEntriesFromNewTrace() {
-        val device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
-        val data =
-            WindowManagerTraceMonitor().withTracing {
-                device.pressHome()
-                device.pressRecentApps()
-            }
-        val trace = WindowManagerTraceParser().parse(data, clearCache = false)
-        Truth.assertThat(trace.entries).isNotEmpty()
-    }
-
     companion object {
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWindowManagerTraceParserTest.kt
similarity index 79%
rename from libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerTraceParserTest.kt
rename to libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWindowManagerTraceParserTest.kt
index 1e121e8f3..6832539d2 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWindowManagerTraceParserTest.kt
@@ -17,19 +17,20 @@
 package android.tools.parsers.wm
 
 import android.tools.Cache
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.monitors.wm.WindowManagerTraceMonitor
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
+import android.tools.traces.parsers.wm.LegacyWindowManagerTraceParser
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.UiDevice
 import com.google.common.truth.Truth
+import org.junit.Assume
 import org.junit.Before
 import org.junit.ClassRule
 import org.junit.Test
 
-/** Tests for [WindowManagerTraceParser] */
-class WindowManagerTraceParserTest {
+/** Tests for [LegacyWindowManagerTraceParser] */
+class LegacyWindowManagerTraceParserTest {
     @Before
     fun before() {
         Cache.clear()
@@ -38,7 +39,7 @@ class WindowManagerTraceParserTest {
     @Test
     fun canParseAllEntriesFromStoredTrace() {
         val trace =
-            WindowManagerTraceParser(legacyTrace = true)
+            LegacyWindowManagerTraceParser(legacyTrace = true)
                 .parse(readAsset("wm_trace_openchrome.pb"), clearCache = false)
         val firstEntry = trace.entries.first()
         Truth.assertThat(firstEntry.timestamp.elapsedNanos).isEqualTo(9213763541297L)
@@ -49,13 +50,15 @@ class WindowManagerTraceParserTest {
 
     @Test
     fun canParseAllEntriesFromNewTrace() {
+        Assume.assumeFalse(android.tracing.Flags.perfettoWmTracing())
+
         val device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
         val data =
             WindowManagerTraceMonitor().withTracing {
                 device.pressHome()
                 device.pressRecentApps()
             }
-        val trace = WindowManagerTraceParser().parse(data, clearCache = false)
+        val trace = LegacyWindowManagerTraceParser().parse(data, clearCache = false)
         Truth.assertThat(trace.entries).isNotEmpty()
     }
 
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWmLegacyTransitionTraceParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWmLegacyTransitionTraceParserTest.kt
index 3cd404752..9c5b6cc5b 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWmLegacyTransitionTraceParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/wm/LegacyWmLegacyTransitionTraceParserTest.kt
@@ -19,10 +19,10 @@ package android.tools.parsers.wm
 import android.app.Instrumentation
 import android.tools.Cache
 import android.tools.device.apphelpers.BrowserAppHelper
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.monitors.wm.LegacyWmTransitionTraceMonitor
 import android.tools.traces.parsers.wm.WmTransitionTraceParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
 import android.tracing.Flags
 import androidx.test.platform.app.InstrumentationRegistry
 import com.android.launcher3.tapl.LauncherInstrumentation
@@ -64,6 +64,7 @@ class LegacyWmLegacyTransitionTraceParserTest {
         val trace = WmTransitionTraceParser().parse(data, clearCache = false)
         Truth.assertThat(trace.entries).isNotEmpty()
     }
+
     companion object {
         @ClassRule @JvmField val ENV_CLEANUP = CleanFlickerEnvironmentRule()
     }
diff --git a/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerDumpParserTest.kt b/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerDumpParserTest.kt
index f11415545..e0250cb92 100644
--- a/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerDumpParserTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/parsers/wm/WindowManagerDumpParserTest.kt
@@ -18,11 +18,12 @@ package android.tools.parsers.wm
 
 import android.tools.Cache
 import android.tools.io.TraceType
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.readAsset
 import android.tools.traces.getCurrentState
 import android.tools.traces.parsers.wm.WindowManagerDumpParser
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.readAsset
 import com.google.common.truth.Truth
+import org.junit.Assume
 import org.junit.Before
 import org.junit.ClassRule
 import org.junit.Test
@@ -31,6 +32,7 @@ import org.junit.Test
 class WindowManagerDumpParserTest {
     @Before
     fun before() {
+        Assume.assumeFalse(android.tracing.Flags.perfettoWmTracing())
         Cache.clear()
     }
 
diff --git a/libraries/flicker/utils/test/src/android/tools/rules/CacheCleanupRule.kt b/libraries/flicker/utils/test/src/android/tools/testrules/CacheCleanupRule.kt
similarity index 92%
rename from libraries/flicker/utils/test/src/android/tools/rules/CacheCleanupRule.kt
rename to libraries/flicker/utils/test/src/android/tools/testrules/CacheCleanupRule.kt
index 222a89892..685b1f4db 100644
--- a/libraries/flicker/utils/test/src/android/tools/rules/CacheCleanupRule.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testrules/CacheCleanupRule.kt
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2023 The Android Open Source Project
+ * Copyright (C) 2024 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.rules
+package android.tools.testrules
 
 import android.tools.Cache
 import android.tools.ICache
@@ -23,6 +23,7 @@ import org.junit.runner.Description
 
 class CacheCleanupRule : TestWatcher() {
     private var cacheBackup: ICache.Backup? = null
+
     override fun starting(description: Description?) {
         super.starting(description)
         cacheBackup = Cache.backup()
diff --git a/libraries/flicker/utils/test/src/android/tools/rules/InitializeCrossPlatformRule.kt b/libraries/flicker/utils/test/src/android/tools/testrules/InitializeCrossPlatformRule.kt
similarity index 96%
rename from libraries/flicker/utils/test/src/android/tools/rules/InitializeCrossPlatformRule.kt
rename to libraries/flicker/utils/test/src/android/tools/testrules/InitializeCrossPlatformRule.kt
index b3f040aff..4a2d42cc7 100644
--- a/libraries/flicker/utils/test/src/android/tools/rules/InitializeCrossPlatformRule.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testrules/InitializeCrossPlatformRule.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.rules
+package android.tools.testrules
 
 import org.junit.rules.TestRule
 import org.junit.runner.Description
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/KotlinMockito.kt b/libraries/flicker/utils/test/src/android/tools/testutils/KotlinMockito.kt
similarity index 97%
rename from libraries/flicker/utils/test/src/android/tools/utils/KotlinMockito.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/KotlinMockito.kt
index 2c298001a..e6ab08f34 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/KotlinMockito.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/KotlinMockito.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import org.mockito.ArgumentMatchers
 import org.mockito.Mockito
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerBuilder.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerBuilder.kt
similarity index 99%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockLayerBuilder.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockLayerBuilder.kt
index e526b9e0d..2af6d084b 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerBuilder.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerBuilder.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.graphics.Rect
 import android.graphics.Region
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceBuilderTest.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceBuilderTest.kt
similarity index 98%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceBuilderTest.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceBuilderTest.kt
index d6624d42e..3d9ed6963 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceBuilderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceBuilderTest.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.graphics.Rect
 import com.google.common.truth.Truth
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceEntryBuilder.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceEntryBuilder.kt
similarity index 98%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceEntryBuilder.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceEntryBuilder.kt
index 621449888..db2c2c81d 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockLayerTraceEntryBuilder.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayerTraceEntryBuilder.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.graphics.Rect
 import android.tools.datatypes.Size
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockLayersTraceBuilder.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayersTraceBuilder.kt
similarity index 97%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockLayersTraceBuilder.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockLayersTraceBuilder.kt
index 5168d2b10..c3827fa6a 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockLayersTraceBuilder.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockLayersTraceBuilder.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.traces.surfaceflinger.LayersTrace
 
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockWindowManagerTraceBuilder.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockWindowManagerTraceBuilder.kt
similarity index 97%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockWindowManagerTraceBuilder.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockWindowManagerTraceBuilder.kt
index b9884a827..62a5c6d51 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockWindowManagerTraceBuilder.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockWindowManagerTraceBuilder.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.traces.wm.WindowManagerTrace
 
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/MockWindowStateBuilder.kt b/libraries/flicker/utils/test/src/android/tools/testutils/MockWindowStateBuilder.kt
similarity index 98%
rename from libraries/flicker/utils/test/src/android/tools/utils/MockWindowStateBuilder.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/MockWindowStateBuilder.kt
index 9e5b6425f..2fe270814 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/MockWindowStateBuilder.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/MockWindowStateBuilder.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.traces.wm.KeyguardControllerState
 import android.tools.traces.wm.WindowManagerState
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/ParsedTracesReader.kt b/libraries/flicker/utils/test/src/android/tools/testutils/ParsedTracesReader.kt
similarity index 99%
rename from libraries/flicker/utils/test/src/android/tools/utils/ParsedTracesReader.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/ParsedTracesReader.kt
index bcdc8ea5c..42410a77e 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/ParsedTracesReader.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/ParsedTracesReader.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.Timestamp
 import android.tools.io.Reader
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/TestArtifact.kt b/libraries/flicker/utils/test/src/android/tools/testutils/TestArtifact.kt
similarity index 98%
rename from libraries/flicker/utils/test/src/android/tools/utils/TestArtifact.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/TestArtifact.kt
index 4ab8cf0ca..d43c7c6e0 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/TestArtifact.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/TestArtifact.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.io.Artifact
 import android.tools.io.ResultArtifactDescriptor
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/TestComponents.kt b/libraries/flicker/utils/test/src/android/tools/testutils/TestComponents.kt
similarity index 98%
rename from libraries/flicker/utils/test/src/android/tools/utils/TestComponents.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/TestComponents.kt
index ca2943dc3..74c981746 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/TestComponents.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/TestComponents.kt
@@ -16,7 +16,7 @@
 
 @file:JvmName("CommonConstants")
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.traces.component.ComponentNameMatcher
 
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/TestTraces.kt b/libraries/flicker/utils/test/src/android/tools/testutils/TestTraces.kt
similarity index 93%
rename from libraries/flicker/utils/test/src/android/tools/utils/TestTraces.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/TestTraces.kt
index cb6f2056b..caaccc6b2 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/TestTraces.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/TestTraces.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.tools.Timestamps
 import android.tools.traces.TraceConfig
@@ -31,6 +31,15 @@ object TestTraces {
     }
 
     object WMTrace {
+        private const val ASSET = "wm_trace.perfetto-trace"
+        val START_TIME = Timestamps.from(elapsedNanos = 1618650751245)
+        val SLICE_TIME = Timestamps.from(elapsedNanos = 1618730362295)
+        val END_TIME = Timestamps.from(elapsedNanos = 1620756218174)
+        val FILE
+            get() = readAssetAsFile(ASSET)
+    }
+
+    object LegacyWMTrace {
         private const val ASSET = "wm_trace.winscope"
         val START_TIME = Timestamps.from(elapsedNanos = 1618650751245)
         val SLICE_TIME = Timestamps.from(elapsedNanos = 1618730362295)
@@ -85,6 +94,7 @@ object TestTraces {
 
         val WM_FILE
             get() = readAssetAsFile(WM_ASSET)
+
         val SHELL_FILE
             get() = readAssetAsFile(SHELL_ASSET)
     }
diff --git a/libraries/flicker/utils/test/src/android/tools/utils/Utils.kt b/libraries/flicker/utils/test/src/android/tools/testutils/Utils.kt
similarity index 72%
rename from libraries/flicker/utils/test/src/android/tools/utils/Utils.kt
rename to libraries/flicker/utils/test/src/android/tools/testutils/Utils.kt
index 3195a50b1..ca9cb37e3 100644
--- a/libraries/flicker/utils/test/src/android/tools/utils/Utils.kt
+++ b/libraries/flicker/utils/test/src/android/tools/testutils/Utils.kt
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.tools.utils
+package android.tools.testutils
 
 import android.content.Context
 import android.tools.Scenario
@@ -25,18 +25,20 @@ import android.tools.Timestamps
 import android.tools.io.Reader
 import android.tools.io.ResultArtifactDescriptor
 import android.tools.io.RunStatus
-import android.tools.rules.CacheCleanupRule
-import android.tools.rules.InitializeCrossPlatformRule
 import android.tools.rules.StopAllTracesRule
+import android.tools.testrules.CacheCleanupRule
+import android.tools.testrules.InitializeCrossPlatformRule
 import android.tools.traces.io.ArtifactBuilder
 import android.tools.traces.io.ResultWriter
 import android.tools.traces.parsers.perfetto.LayersTraceParser
 import android.tools.traces.parsers.perfetto.TraceProcessorSession
+import android.tools.traces.parsers.perfetto.WindowManagerTraceParser
+import android.tools.traces.parsers.wm.LegacyWindowManagerTraceParser
 import android.tools.traces.parsers.wm.WindowManagerDumpParser
-import android.tools.traces.parsers.wm.WindowManagerTraceParser
 import android.tools.traces.wm.ConfigurationContainerImpl
 import android.tools.traces.wm.RootWindowContainer
 import android.tools.traces.wm.WindowContainerImpl
+import android.tools.traces.wm.WindowManagerTrace
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.UiDevice
 import com.google.common.io.ByteStreams
@@ -113,7 +115,14 @@ fun assertArchiveContainsFiles(archivePath: File, possibleExpectedFiles: List<Li
         }
     }
 
-    Truth.assertWithMessage("Trace archive doesn't contain all expected traces")
+    val messageActualFiles = "[${actualFiles.joinToString(", ")}]"
+    val messageExpectedFiles =
+        "${possibleExpectedFiles.map { "[${it.joinToString(", ")}]"}.joinToString(", ")}"
+    Truth.assertWithMessage(
+            "Trace archive doesn't contain expected traces." +
+                "\n Actual: $messageActualFiles" +
+                "\n Expected: $messageExpectedFiles"
+        )
         .that(isActualTraceAsExpected)
         .isTrue()
 }
@@ -126,30 +135,78 @@ fun getActualTraceFilesFromArchive(archivePath: File): List<String> {
 fun <T> List<T>.equalsIgnoreOrder(other: List<T>) = this.toSet() == other.toSet()
 
 fun getWmTraceReaderFromAsset(
-    relativePath: String,
+    relativePathWithoutExtension: String,
     from: Long = Long.MIN_VALUE,
     to: Long = Long.MAX_VALUE,
     addInitialEntry: Boolean = true,
     legacyTrace: Boolean = false,
 ): Reader {
-    return ParsedTracesReader(
-        artifact = TestArtifact(relativePath),
-        wmTrace =
-            WindowManagerTraceParser(legacyTrace)
+    fun parseTrace(): WindowManagerTrace {
+        val traceData = readAsset("$relativePathWithoutExtension.perfetto-trace")
+        return TraceProcessorSession.loadPerfettoTrace(traceData) { session ->
+            WindowManagerTraceParser()
                 .parse(
-                    readAsset(relativePath),
+                    session,
                     Timestamps.from(elapsedNanos = from),
-                    Timestamps.from(elapsedNanos = to),
-                    addInitialEntry,
-                    clearCache = false
+                    Timestamps.from(elapsedNanos = to)
                 )
+        }
+    }
+
+    fun parseLegacyTrace(): WindowManagerTrace {
+        val traceData =
+            runCatching { readAsset("$relativePathWithoutExtension.pb") }.getOrNull()
+                ?: runCatching { readAsset("$relativePathWithoutExtension.winscope") }.getOrNull()
+                ?: error("Can't find legacy trace file $relativePathWithoutExtension")
+
+        return LegacyWindowManagerTraceParser(legacyTrace)
+            .parse(
+                traceData,
+                Timestamps.from(elapsedNanos = from),
+                Timestamps.from(elapsedNanos = to),
+                addInitialEntry,
+                clearCache = false
+            )
+    }
+
+    val trace =
+        if (android.tracing.Flags.perfettoWmTracing()) {
+            parseTrace()
+        } else {
+            parseLegacyTrace()
+        }
+
+    return ParsedTracesReader(
+        artifact = TestArtifact(relativePathWithoutExtension),
+        wmTrace = trace
     )
 }
 
-fun getWmDumpReaderFromAsset(relativePath: String): Reader {
+fun getWmDumpReaderFromAsset(relativePathWithoutExtension: String): Reader {
+    fun parseDump(): WindowManagerTrace {
+        val traceData = readAsset("$relativePathWithoutExtension.perfetto-trace")
+        return TraceProcessorSession.loadPerfettoTrace(traceData) { session ->
+            WindowManagerTraceParser().parse(session)
+        }
+    }
+
+    fun parseLegacyDump(): WindowManagerTrace {
+        val traceData =
+            runCatching { readAsset("$relativePathWithoutExtension.pb") }.getOrNull()
+                ?: runCatching { readAsset("$relativePathWithoutExtension.winscope") }.getOrNull()
+                ?: error("Can't find legacy trace file $relativePathWithoutExtension")
+        return WindowManagerDumpParser().parse(traceData, clearCache = false)
+    }
+
+    val wmTrace =
+        if (android.tracing.Flags.perfettoWmDump()) {
+            parseDump()
+        } else {
+            parseLegacyDump()
+        }
     return ParsedTracesReader(
-        artifact = TestArtifact(relativePath),
-        wmTrace = WindowManagerDumpParser().parse(readAsset(relativePath), clearCache = false)
+        artifact = TestArtifact(relativePathWithoutExtension),
+        wmTrace = wmTrace
     )
 }
 
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/TraceTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/TraceTest.kt
index 57425fb21..bd1ae24ab 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/TraceTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/TraceTest.kt
@@ -20,7 +20,7 @@ import android.tools.Timestamp
 import android.tools.Timestamps
 import android.tools.Trace
 import android.tools.TraceEntry
-import android.tools.utils.assertThrows
+import android.tools.testutils.assertThrows
 import com.google.common.truth.Truth
 import org.junit.Test
 
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/events/CujTraceTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/events/CujTraceTest.kt
index be876b994..d7505af61 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/events/CujTraceTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/events/CujTraceTest.kt
@@ -17,7 +17,7 @@
 package android.tools.traces.events
 
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.Test
@@ -173,9 +173,25 @@ class CujTraceTest {
         Truth.assertThat(trace.entries).isEmpty()
     }
 
+    @Test
+    fun canHandleUnknownType() {
+        val UNKNOWN_TAG_ID = 8888
+
+        val trace =
+            CujTrace.from(
+                listOf(
+                    createCujEvent(1, UnknownCuj(UNKNOWN_TAG_ID), CujEvent.JANK_CUJ_BEGIN_TAG),
+                    createCujEvent(2, UnknownCuj(UNKNOWN_TAG_ID), CujEvent.JANK_CUJ_END_TAG),
+                )
+            )
+
+        Truth.assertThat(trace.entries).hasSize(1)
+        Truth.assertThat(trace.entries.first().cuj.id).isEqualTo(UNKNOWN_TAG_ID)
+    }
+
     private fun createCujEvent(
         timestamp: Long,
-        cuj: CujType,
+        cuj: ICujType,
         type: String,
         tag: String? = null
     ): CujEvent {
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayerTraceEntryBuilderTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayerTraceEntryBuilderTest.kt
index 5f945ffc5..56de2feaa 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayerTraceEntryBuilderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayerTraceEntryBuilderTest.kt
@@ -23,8 +23,8 @@ import android.tools.Timestamps
 import android.tools.datatypes.ActiveBuffer
 import android.tools.datatypes.Size
 import android.tools.datatypes.emptyColor
+import android.tools.testutils.CleanFlickerEnvironmentRule
 import android.tools.traces.surfaceflinger.Display.Companion.BLANK_LAYER_STACK
-import android.tools.utils.CleanFlickerEnvironmentRule
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceEntryTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceEntryTest.kt
index 606f3cfb6..9053cce4c 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceEntryTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceEntryTest.kt
@@ -18,8 +18,8 @@ package android.tools.traces.surfaceflinger
 
 import android.tools.Cache
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.getLayerTraceReaderFromAsset
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceTest.kt
index 7d18c9b5c..77777aafa 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/surfaceflinger/LayersTraceTest.kt
@@ -18,9 +18,9 @@ package android.tools.traces.surfaceflinger
 
 import android.tools.Cache
 import android.tools.Timestamps
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.getLayerTraceReaderFromAsset
 import android.tools.traces.component.ComponentNameMatcher
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.getLayerTraceReaderFromAsset
 import com.google.common.truth.Truth
 import org.junit.Before
 import org.junit.ClassRule
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerStateTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerStateTest.kt
index ea5e77fb7..fe9e9466e 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerStateTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerStateTest.kt
@@ -17,8 +17,8 @@
 package android.tools.traces.wm
 
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newEmptyRootContainer
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newEmptyRootContainer
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceEntryBuilderTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceEntryBuilderTest.kt
index 33ad8213e..8a921afd7 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceEntryBuilderTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceEntryBuilderTest.kt
@@ -17,8 +17,8 @@
 package android.tools.traces.wm
 
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.newEmptyRootContainer
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.newEmptyRootContainer
 import com.google.common.truth.Truth
 import org.junit.ClassRule
 import org.junit.FixMethodOrder
diff --git a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceTest.kt b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceTest.kt
index 0604d9bc4..6260dcaf2 100644
--- a/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceTest.kt
+++ b/libraries/flicker/utils/test/src/android/tools/traces/wm/WindowManagerTraceTest.kt
@@ -18,8 +18,8 @@ package android.tools.traces.wm
 
 import android.tools.Cache
 import android.tools.Timestamps
-import android.tools.utils.CleanFlickerEnvironmentRule
-import android.tools.utils.getWmTraceReaderFromAsset
+import android.tools.testutils.CleanFlickerEnvironmentRule
+import android.tools.testutils.getWmTraceReaderFromAsset
 import com.google.common.truth.Truth.assertThat
 import com.google.common.truth.Truth.assertWithMessage
 import java.lang.reflect.Modifier
@@ -35,7 +35,7 @@ import org.junit.runners.MethodSorters
  */
 @FixMethodOrder(MethodSorters.NAME_ASCENDING)
 class WindowManagerTraceTest {
-    private val reader = getWmTraceReaderFromAsset("wm_trace_openchrome.pb", legacyTrace = true)
+    private val reader = getWmTraceReaderFromAsset("wm_trace_openchrome", legacyTrace = true)
     private val trace
         get() = reader.readWmTrace() ?: error("Unable to read WM trace")
 
@@ -96,7 +96,7 @@ class WindowManagerTraceTest {
      */
     @Test
     fun canAccessAllProperties() {
-        listOf("wm_trace_activity_transition.pb", "wm_trace_openchrome2.pb").forEach { traceName ->
+        listOf("wm_trace_activity_transition", "wm_trace_openchrome2").forEach { traceName ->
             val reader = getWmTraceReaderFromAsset(traceName, legacyTrace = true)
             val trace = reader.readWmTrace() ?: error("Unable to read WM trace")
             assertWithMessage("Unable to parse dump").that(trace.entries.size).isGreaterThan(1)
@@ -130,7 +130,7 @@ class WindowManagerTraceTest {
     fun canSlice() {
         val reader =
             getWmTraceReaderFromAsset(
-                "wm_trace_openchrome2.pb",
+                "wm_trace_openchrome2",
                 from = 174686204723645,
                 to = 174686640998584,
                 legacyTrace = true
@@ -146,7 +146,7 @@ class WindowManagerTraceTest {
     fun canSliceWithWrongTimestamps() {
         val reader =
             getWmTraceReaderFromAsset(
-                "wm_trace_openchrome2.pb",
+                "wm_trace_openchrome2",
                 from = 9213763541297,
                 to = 9215895891561,
                 legacyTrace = true
diff --git a/libraries/health/rules/multivalentTests/AndroidManifest.xml b/libraries/health/rules/multivalentTests/AndroidManifest.xml
new file mode 100644
index 000000000..c9707b2fc
--- /dev/null
+++ b/libraries/health/rules/multivalentTests/AndroidManifest.xml
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2018 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<!-- This is identical to tests/AndroidManifest.xml,
+     but removes namespace to avoid gradle issues
+     -->
+<manifest xmlns:android="http://schemas.android.com/apk/res/android">
+    <uses-sdk android:minSdkVersion="26" android:targetSdkVersion="26" />
+    <uses-permission android:name="android.permission.READ_LOGS" />
+    <application>
+        <uses-library android:name="android.test.runner"/>
+    </application>
+    <instrumentation
+        android:name="androidx.test.runner.AndroidJUnitRunner"
+        android:targetPackage="android.platform.test.rule.tests"
+        android:label="Platform Rule Library Tests" />
+</manifest>
diff --git a/libraries/health/rules/tests/src/android/platform/test/rule/LimitDevicesRuleTest.kt b/libraries/health/rules/multivalentTests/src/android/platform/test/rule/LimitDevicesRuleTest.kt
similarity index 96%
rename from libraries/health/rules/tests/src/android/platform/test/rule/LimitDevicesRuleTest.kt
rename to libraries/health/rules/multivalentTests/src/android/platform/test/rule/LimitDevicesRuleTest.kt
index f2cde9bdc..7c09be4af 100644
--- a/libraries/health/rules/tests/src/android/platform/test/rule/LimitDevicesRuleTest.kt
+++ b/libraries/health/rules/multivalentTests/src/android/platform/test/rule/LimitDevicesRuleTest.kt
@@ -20,23 +20,15 @@ import android.platform.test.rule.DeviceProduct.CF_TABLET
 import com.google.common.truth.Truth.assertThat
 import org.junit.Assert.assertEquals
 import org.junit.AssumptionViolatedException
-import org.junit.Before
 import org.junit.Rule
 import org.junit.Test
 import org.junit.runner.Description
 import org.junit.runner.RunWith
 import org.junit.runners.JUnit4
 import org.junit.runners.model.Statement
-import org.mockito.MockitoAnnotations
 
 @RunWith(JUnit4::class)
 class LimitDevicesRuleTest {
-
-    @Before
-    fun setup() {
-        MockitoAnnotations.initMocks(this)
-    }
-
     @Test
     fun allowOnPhone_withPhone_succeeds() {
         val rule = LimitDevicesRule(thisDevice = CF_PHONE.product)
diff --git a/libraries/health/rules/tests/src/android/platform/test/rule/StringingListener.kt b/libraries/health/rules/multivalentTests/src/android/platform/test/rule/StringingListener.kt
similarity index 100%
rename from libraries/health/rules/tests/src/android/platform/test/rule/StringingListener.kt
rename to libraries/health/rules/multivalentTests/src/android/platform/test/rule/StringingListener.kt
diff --git a/libraries/health/rules/multivalentTestsForDevice b/libraries/health/rules/multivalentTestsForDevice
new file mode 120000
index 000000000..eea09d2ac
--- /dev/null
+++ b/libraries/health/rules/multivalentTestsForDevice
@@ -0,0 +1 @@
+multivalentTests/
\ No newline at end of file
diff --git a/libraries/health/rules/multivalentTestsForDeviceless b/libraries/health/rules/multivalentTestsForDeviceless
new file mode 120000
index 000000000..20ee34ada
--- /dev/null
+++ b/libraries/health/rules/multivalentTestsForDeviceless
@@ -0,0 +1 @@
+multivalentTests
\ No newline at end of file
diff --git a/libraries/health/rules/src/android/platform/test/rule/DeviceTypeRule.kt b/libraries/health/rules/src/android/platform/test/rule/DeviceTypeRule.kt
index 72f44d0ec..a5b4f5380 100644
--- a/libraries/health/rules/src/android/platform/test/rule/DeviceTypeRule.kt
+++ b/libraries/health/rules/src/android/platform/test/rule/DeviceTypeRule.kt
@@ -85,6 +85,16 @@ class DeviceTypeRule : TestRule {
             )
         }
 
+        if (description.getAnnotationClearly<FoldableOnly>() != null && isFoldable
+            && isCuttlefish) {
+            return wrongDeviceTypeStatement(
+                description,
+                "Skipping test on ${Build.PRODUCT} as E2E foldable tests are not " +
+                        "supported on Cuttlefish targets. " +
+                        "See go/e2e-cf-foldable-maybe-not for more details"
+            )
+        }
+
         if (description.getAnnotationClearly<TabletOnly>() != null && !isTablet) {
             return wrongDeviceTypeStatement(
                 description,
@@ -104,6 +114,8 @@ internal fun isFoldable(): Boolean {
         .isNotEmpty()
 }
 
+private val isCuttlefish get() = Build.BOARD == "cutf"
+
 /** Returns whether the device default display is currently considered large screen. */
 fun isLargeScreen(): Boolean {
     val sizeDp = getUiDevice().displaySizeDp
diff --git a/libraries/health/rules/src/android/platform/test/rule/LimitDevicesRule.kt b/libraries/health/rules/src/android/platform/test/rule/LimitDevicesRule.kt
index 9bab80d6d..705467793 100644
--- a/libraries/health/rules/src/android/platform/test/rule/LimitDevicesRule.kt
+++ b/libraries/health/rules/src/android/platform/test/rule/LimitDevicesRule.kt
@@ -75,7 +75,7 @@ annotation class FlakyDevices(vararg val flaky: DeviceProduct)
  */
 class LimitDevicesRule(
     private val thisDevice: String = Build.PRODUCT,
-    private val runningFlakyTests: Boolean = false
+    private val runningFlakyTests: Boolean = false,
 ) : TestRule {
     override fun apply(base: Statement, description: Description): Statement {
         if (description.ignoreLimit()) {
@@ -116,7 +116,7 @@ class LimitDevicesRule(
     private fun Description.allowedDevices(): List<String> =
         listOf(
                 getMostSpecificAnnotation<AllowedDevices>()?.allowed,
-                getMostSpecificAnnotation<ScreenshotTestDevices>()?.allowed
+                getMostSpecificAnnotation<ScreenshotTestDevices>()?.allowed,
             )
             .collectProducts()
 
@@ -131,7 +131,7 @@ class LimitDevicesRule(
                 getMostSpecificAnnotation<AllowedDevices>(),
                 getMostSpecificAnnotation<DeniedDevices>(),
                 getMostSpecificAnnotation<ScreenshotTestDevices>(),
-                getMostSpecificAnnotation<FlakyDevices>()
+                getMostSpecificAnnotation<FlakyDevices>(),
             )
             .toSet()
 
@@ -162,6 +162,8 @@ class LimitDevicesRule(
             return isRunning
         }
 
+        @JvmOverloads
+        @JvmStatic
         fun readParamsFromInstrumentation(thisDevice: String = Build.PRODUCT) =
             LimitDevicesRule(thisDevice, isRunningFlakyTests())
 
@@ -178,6 +180,8 @@ enum class DeviceProduct(val product: String) {
     TANGORPRO("tangorpro"),
     FELIX("felix"),
     ROBOLECTRIC("robolectric"),
+    COMET("comet"),
+    CHEETAH("cheetah"),
 }
 
 private fun makeAssumptionViolatedStatement(errorMessage: String): Statement =
diff --git a/libraries/health/rules/src/android/platform/test/rule/OverridePermissionsRule.kt b/libraries/health/rules/src/android/platform/test/rule/OverridePermissionsRule.kt
new file mode 100644
index 000000000..aa41b8333
--- /dev/null
+++ b/libraries/health/rules/src/android/platform/test/rule/OverridePermissionsRule.kt
@@ -0,0 +1,72 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.test.rule
+
+import android.content.pm.PackageManager
+import android.os.Process
+import androidx.test.platform.app.InstrumentationRegistry
+import org.junit.runner.Description
+
+/**
+ * A rule that allows to apply overrides (revoke or grant) for Android permissions
+ */
+class OverridePermissionsRule : TestWatcher() {
+
+    private val uiAutomation = InstrumentationRegistry.getInstrumentation().uiAutomation
+    private val overrides: MutableList<PermissionOverride> = arrayListOf()
+
+    fun overridePermission(
+        permission: String,
+        @PackageManager.PermissionResult operation: Int,
+        uid: Int = Process.myUid()
+    ) {
+        val override = PermissionOverride(
+            uid = uid,
+            permission = permission,
+            operation = operation
+        )
+        overrides.add(override)
+        applyOverride(override)
+    }
+
+    override fun finished(description: Description?) {
+        overrides.forEach {
+            resetOverride(it)
+        }
+    }
+
+    private fun applyOverride(override: PermissionOverride) {
+        uiAutomation.addOverridePermissionState(
+            override.uid,
+            override.permission,
+            override.operation
+        )
+    }
+
+    private fun resetOverride(override: PermissionOverride) {
+        uiAutomation.removeOverridePermissionState(
+            override.uid,
+            override.permission,
+        )
+    }
+
+    private data class PermissionOverride(
+        val uid: Int,
+        val permission: String,
+        @PackageManager.PermissionResult val operation: Int
+    )
+}
\ No newline at end of file
diff --git a/libraries/health/rules/src/android/platform/test/rule/PresubmitRule.java b/libraries/health/rules/src/android/platform/test/rule/PresubmitRule.java
index 662c12d50..c2a9aa6cb 100644
--- a/libraries/health/rules/src/android/platform/test/rule/PresubmitRule.java
+++ b/libraries/health/rules/src/android/platform/test/rule/PresubmitRule.java
@@ -16,6 +16,7 @@
 
 package android.platform.test.rule;
 
+
 import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.uiautomator.UiDevice;
 
@@ -37,12 +38,27 @@ import java.util.Arrays;
  * skipped, for presubmit runs, on devices not in the list.
  */
 public class PresubmitRule implements TestRule {
+
+    /**
+     * For test running in config that implements the instrumentation argument is-presubmit (such as
+     * cl/663453103), return true if the test is actually running in presubmit.
+     *
+     * <p>Otherwise, return true if there is a parameter to exclude postsubmit.
+     */
     public static boolean runningInPresubmit() {
+        final String isPresubmit =
+                InstrumentationRegistry.getArguments().getString("is-presubmit", "unknown");
+        if (isPresubmit.equals("true")) {
+            return true;
+        } else if (isPresubmit.equals("false")) {
+            return false;
+        }
+
         // We run in presubmit when there is a parameter to exclude postsubmits.
         final String nonAnnotationArgument =
                 InstrumentationRegistry.getArguments().getString("notAnnotation", "");
-        return Arrays.stream(nonAnnotationArgument.split(","))
-                .anyMatch("android.platform.test.annotations.Postsubmit"::equals);
+        return Arrays.asList(nonAnnotationArgument.split(","))
+                .contains("android.platform.test.annotations.Postsubmit");
     }
 
     @Override
diff --git a/libraries/health/rules/src/android/platform/test/rule/TouchModeRule.kt b/libraries/health/rules/src/android/platform/test/rule/TouchModeRule.kt
new file mode 100644
index 000000000..4cdcfc244
--- /dev/null
+++ b/libraries/health/rules/src/android/platform/test/rule/TouchModeRule.kt
@@ -0,0 +1,41 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.test.rule
+
+import androidx.test.platform.app.InstrumentationRegistry
+import org.junit.runner.Description
+
+/**
+ * Ensures that the test is executed with specified touch mode.
+ * When device is in touch mode it will show virtual keyboard when focusing input fields,
+ * when touch mode is disabled it will rely only on physical keyboard event and won't show
+ * virtual keyboard.
+ *
+ * By default the rule ensures that touch mode is enabled.
+ */
+class TouchModeRule(private val enabled: Boolean = true) : TestWatcher() {
+
+    private val instrumentation = InstrumentationRegistry.getInstrumentation()
+
+    override fun starting(description: Description?) {
+        instrumentation.setInTouchMode(enabled)
+    }
+
+    override fun finished(description: Description?) {
+        instrumentation.resetInTouchMode()
+    }
+}
diff --git a/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Functional.java b/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Functional.java
index 179e6d46a..e4947b210 100644
--- a/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Functional.java
+++ b/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Functional.java
@@ -23,6 +23,7 @@ import android.platform.test.rule.SamplerRule;
 import org.junit.internal.AssumptionViolatedException;
 import org.junit.internal.runners.statements.RunAfters;
 import org.junit.internal.runners.statements.RunBefores;
+import org.junit.rules.TestRule;
 import org.junit.runner.Description;
 import org.junit.runner.manipulation.Filter;
 import org.junit.runner.manipulation.NoTestsRemainException;
@@ -31,9 +32,11 @@ import org.junit.runner.notification.RunNotifier;
 import org.junit.runners.BlockJUnit4ClassRunner;
 import org.junit.runners.model.FrameworkMethod;
 import org.junit.runners.model.InitializationError;
+import org.junit.runners.model.MemberValueConsumer;
 import org.junit.runners.model.Statement;
 import org.junit.runners.model.TestClass;
 
+import java.util.ArrayList;
 import java.util.HashSet;
 import java.util.List;
 import java.util.Set;
@@ -43,12 +46,25 @@ import java.util.stream.Stream;
 /**
  * Runner for functional tests that's compatible with annotations used in microbenchmark
  * tests. @Before/@After are nested inside @NoMetricBefore/@NoMetricAfter.
+ * @NoMetricBefore/@NoMetricAfter are nested inside @NoMetricRule
  *
  * <p>Microbenchmarks are functional tests executed with the {@link Microbenchmark} test runner.
  * This runner, in addition to the standard @Before/@After, executes methods annotated with {@link
  * Microbenchmark.NoMetricBefore} and {@link Microbenchmark.NoMetricAfter} (custom annotation).
  * Without using this runner, those methods would not be executed (see b/205019000).
  *
+ * The order of the execution:
+ *   - @ClassRule before
+ *      - @NoMetricRule before
+ *      - @Rule before
+ *          - @NoMetricBefore method
+ *          - @Before method
+ *              - Test method body
+ *          - @After method
+ *          - @NoMetricAfter method
+ *      - @Rule after
+ *      - @NoMetricRule after
+ *   - @ClassRule after
  * <p>In addition, this runner saves artifacts early, as soon as the failure happens. If the failure
  * happens in @Before, then the standard error callback would be triggered only after @After was
  * being executed. As a consequence, we might have the device in a state different than the failure
@@ -143,6 +159,30 @@ public class Functional extends BlockJUnit4ClassRunner {
         return withTrace("Afters", artifactSaver(statement, Stream.of(method)));
     }
 
+    @Override
+    protected List<TestRule> getTestRules(Object target) {
+        List<TestRule> rules = super.getTestRules(target);
+        rules.addAll(getNoMetricTestRules(target));
+        return rules;
+    }
+
+    /**
+     * @param target the test case instance
+     * @return a list of NoMetricTestRules that should be applied when executing this
+     *         test
+     */
+    private List<TestRule> getNoMetricTestRules(Object target) {
+        final List<TestRule> result = new ArrayList<>();
+        final MemberValueConsumer<TestRule> collector = (member, value) -> result.add(value);
+
+        getTestClass().collectAnnotatedMethodValues(target, Microbenchmark.NoMetricRule.class, TestRule.class,
+                collector);
+        getTestClass().collectAnnotatedFieldValues(target, Microbenchmark.NoMetricRule.class, TestRule.class,
+                collector);
+
+        return result;
+    }
+
     @Override
     protected Statement methodBlock(FrameworkMethod method) {
         // Error artifact saver for exceptions thrown outside "method-afters", i.e. in method rules.
diff --git a/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Microbenchmark.java b/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Microbenchmark.java
index 774ce1ed7..3fbedd3ff 100644
--- a/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Microbenchmark.java
+++ b/libraries/health/runners/microbenchmark/src/android/platform/test/microbenchmark/Microbenchmark.java
@@ -31,10 +31,10 @@ import android.util.Log;
 import androidx.annotation.VisibleForTesting;
 import androidx.test.InstrumentationRegistry;
 
+import org.junit.Rule;
 import org.junit.internal.AssumptionViolatedException;
 import org.junit.internal.runners.model.EachTestNotifier;
 import org.junit.internal.runners.model.ReflectiveCallable;
-import org.junit.internal.runners.statements.RunAfters;
 import org.junit.rules.RunRules;
 import org.junit.rules.TestRule;
 import org.junit.runner.Description;
@@ -42,6 +42,8 @@ import org.junit.runner.notification.RunNotifier;
 import org.junit.runners.BlockJUnit4ClassRunner;
 import org.junit.runners.model.FrameworkMethod;
 import org.junit.runners.model.InitializationError;
+import org.junit.runners.model.MemberValueConsumer;
+import org.junit.runners.model.MultipleFailureException;
 import org.junit.runners.model.Statement;
 
 import java.lang.annotation.Annotation;
@@ -68,6 +70,41 @@ import java.util.Map;
  * with the corresponding annotations, {@link @NoMetricBefore}, {@link @NoMetricAfter}, and
  * {@link @TightMethodRule}.
  *
+ * The order of the execution for 2 iterations of a test with single test method:
+ *  - @ClassRule before
+ *      *iteration 1*
+ *      - @NoMetricRule before
+ *      - @NoMetricBefore method
+ *          - *starts tracing*
+ *              - @Rule before
+ *              - @Before method
+ *              - @TightMethodRule before
+ *                  - Test method body
+ *              - @TightMethodRule after
+ *              - @After method
+ *              - @Rule after
+ *          - *ends tracing*
+ *      - @NoMetricAfter method
+ *      - @NoMetricRule after
+ *      *iteration 2*
+ *      - @NoMetricRule before
+ *      - @NoMetricBefore method
+ *          - *starts tracing*
+ *              - @Rule before
+ *              - @Before method
+ *              - @TightMethodRule before
+ *                  - Test method body
+ *              - @TightMethodRule after
+ *              - @After method
+ *              - @Rule after
+ *          - *ends tracing*
+ *      - @NoMetricAfter method
+ *      - @NoMetricRule after
+ *   - @ClassRule after
+ *
+ * Note: the order of the execution is different from Functional runner.
+ * See documentation for {@link Functional} for details.
+ *
  * <p>Finally, this runner supports some power-specific testing features used to denoise (also
  * documented below), and can be configured to terminate early if the battery drops too low or if
  * any test fails.
@@ -279,6 +316,11 @@ public class Microbenchmark extends BlockJUnit4ClassRunner {
     @Target({ElementType.FIELD, ElementType.METHOD})
     public @interface NoMetricAfter {}
 
+    /** A temporary annotation, same as the above, but for replacing JUnit {@code @Rule}. */
+    @Retention(RetentionPolicy.RUNTIME)
+    @Target({ElementType.FIELD, ElementType.METHOD})
+    public @interface NoMetricRule {}
+
     /**
      * Rename the child class name to add iterations if the renaming iteration option is enabled.
      *
@@ -323,6 +365,23 @@ public class Microbenchmark extends BlockJUnit4ClassRunner {
         return result;
     }
 
+    /**
+     * @param target the test case instance
+     * @return a list of NoMetricTestRules that should be applied when executing this
+     *         test
+     */
+    private List<TestRule> getNoMetricTestRules(Object target) {
+        final List<TestRule> result = new ArrayList<>();
+        final MemberValueConsumer<TestRule> collector = (member, value) -> result.add(value);
+
+        getTestClass().collectAnnotatedMethodValues(target, NoMetricRule.class, TestRule.class,
+                collector);
+        getTestClass().collectAnnotatedFieldValues(target, NoMetricRule.class, TestRule.class,
+                collector);
+
+        return result;
+    }
+
     /** Add {@link DynamicRuleChain} to existing class rules. */
     @Override
     protected List<TestRule> classRules() {
@@ -373,17 +432,11 @@ public class Microbenchmark extends BlockJUnit4ClassRunner {
                                 return createTest();
                             }
                         }.run();
-
-                // Run {@code NoMetricBefore} methods first. Fail fast if they fail.
-                for (FrameworkMethod noMetricBefore :
-                        getTestClass().getAnnotatedMethods(NoMetricBefore.class)) {
-                    noMetricBefore.invokeExplosively(test);
-                }
             } catch (Throwable e) {
                 eachNotifier.fireTestStarted();
                 eachNotifier.addFailure(e);
                 eachNotifier.fireTestFinished();
-                if(mTerminateOnTestFailure) {
+                if (mTerminateOnTestFailure) {
                     throw new TerminateEarlyException("test failed.");
                 }
                 return;
@@ -396,40 +449,102 @@ public class Microbenchmark extends BlockJUnit4ClassRunner {
             statement = withAfters(method, test, statement);
             statement = withRules(method, test, statement);
 
-            boolean testFailed = false;
             // Fire test events from inside to exclude "no metric" methods.
-            eachNotifier.fireTestStarted();
+            statement = withTestEventsNotifier(eachNotifier, statement);
+
+            statement = withNoMetricsAfters(eachNotifier, test, statement);
+            statement = withNoMetricsBefores(eachNotifier, test, statement);
+            statement = withNoMetricsRules(method, test, statement);
+
+            boolean testFailed = false;
+
             try {
                 statement.evaluate();
-            } catch (AssumptionViolatedException e) {
-                eachNotifier.addFailedAssumption(e);
-                testFailed = true;
             } catch (Throwable e) {
-                eachNotifier.addFailure(e);
                 testFailed = true;
-            } finally {
-                eachNotifier.fireTestFinished();
             }
 
-            try {
-                // Run {@code NoMetricAfter} methods last, reporting all errors.
-                List<FrameworkMethod> afters =
-                        getTestClass().getAnnotatedMethods(NoMetricAfter.class);
-                if (!afters.isEmpty()) {
-                    new RunAfters(EMPTY_STATEMENT, afters, test).evaluate();
+            if (mTerminateOnTestFailure && testFailed) {
+                throw new TerminateEarlyException("test failed.");
+            }
+        }
+    }
+
+    private Statement withNoMetricsBefores(EachTestNotifier eachNotifier, Object test,
+            Statement next) {
+        return new Statement() {
+            @Override
+            public void evaluate() throws Throwable {
+                try {
+                    for (FrameworkMethod noMetricBefore :
+                            getTestClass().getAnnotatedMethods(NoMetricBefore.class)) {
+                        noMetricBefore.invokeExplosively(test);
+                    }
+                } catch (Throwable e) {
+                    eachNotifier.fireTestStarted();
+                    eachNotifier.addFailure(e);
+                    eachNotifier.fireTestFinished();
+                    throw e;
                 }
-            } catch (AssumptionViolatedException e) {
-                eachNotifier.addFailedAssumption(e);
-                testFailed = true;
-            } catch (Throwable e) {
-                eachNotifier.addFailure(e);
-                testFailed = true;
+
+                next.evaluate();
             }
+        };
+    }
 
-            if(mTerminateOnTestFailure && testFailed) {
-                throw new TerminateEarlyException("test failed.");
+    private Statement withNoMetricsAfters(EachTestNotifier eachNotifier, Object test,
+            Statement next) {
+        final List<FrameworkMethod> afters = getTestClass()
+                .getAnnotatedMethods(NoMetricAfter.class);
+        return new Statement() {
+            @Override
+            public void evaluate() throws Throwable {
+                final List<Throwable> errors = new ArrayList<Throwable>();
+                try {
+                    next.evaluate();
+                } catch (Throwable e) {
+                    errors.add(e);
+                } finally {
+                    for (FrameworkMethod each : afters) {
+                        try {
+                            each.invokeExplosively(test);
+                        } catch (AssumptionViolatedException e) {
+                            eachNotifier.addFailedAssumption(e);
+                            errors.add(e);
+                        } catch (Throwable e) {
+                            eachNotifier.addFailure(e);
+                            errors.add(e);
+                        }
+                    }
+                }
+                MultipleFailureException.assertEmpty(errors);
             }
-        }
+        };
+    }
+
+    private Statement withTestEventsNotifier(EachTestNotifier eachNotifier, Statement next) {
+        return new Statement() {
+            @Override
+            public void evaluate() throws Throwable {
+                eachNotifier.fireTestStarted();
+                try {
+                    next.evaluate();
+                } catch (AssumptionViolatedException e) {
+                    eachNotifier.addFailedAssumption(e);
+                    throw e;
+                } catch (Throwable e) {
+                    eachNotifier.addFailure(e);
+                    throw e;
+                } finally {
+                    eachNotifier.fireTestFinished();
+                }
+            }
+        };
+    }
+
+    private Statement withNoMetricsRules(FrameworkMethod method, Object target,
+            Statement next) {
+        return new RunRules(next, getNoMetricTestRules(target), describeChild(method));
     }
 
     /* Checks if the battery level is below the specified level where the test should terminate. */
diff --git a/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/FunctionalTest.java b/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/FunctionalTest.java
new file mode 100644
index 000000000..212bfa4f6
--- /dev/null
+++ b/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/FunctionalTest.java
@@ -0,0 +1,260 @@
+/*
+ * Copyright (C) 2018 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.platform.test.microbenchmark;
+
+import static com.google.common.truth.Truth.assertThat;
+
+import android.platform.test.microbenchmark.Microbenchmark.NoMetricAfter;
+import android.platform.test.microbenchmark.Microbenchmark.NoMetricBefore;
+import android.platform.test.rule.TestWatcher;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.ClassRule;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.TestRule;
+import org.junit.runner.Description;
+import org.junit.runner.JUnitCore;
+import org.junit.runner.Result;
+import org.junit.runner.RunWith;
+import org.junit.runners.JUnit4;
+import org.junit.runners.model.InitializationError;
+import org.junit.runners.model.Statement;
+
+import java.util.ArrayList;
+import java.util.List;
+
+/**
+ * Unit tests for the {@link Functional} runner.
+ */
+@RunWith(JUnit4.class)
+public final class FunctionalTest {
+    // Static logs are needed to validate dynamic rules and tests that use TestRequestBuilder, where
+    // objects are instantiated with reflection and not directly accessible.
+    private static List<String> sLogs = new ArrayList<>();
+
+    @Before
+    public void before() {
+        sLogs.clear();
+    }
+
+    @After
+    public void after() {
+        sLogs.clear();
+    }
+
+    @Test
+    public void successTest_reportsSuccess() throws InitializationError {
+        Functional runner = new Functional(LoggingTest.class);
+
+        Result result = new JUnitCore().run(runner);
+
+        assertThat(result.wasSuccessful()).isTrue();
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@Rule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@Test method body",
+                        "@NoMetricAfter",
+                        "@After",
+                        "@Rule finished",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+    @Test
+    public void failedTest_reportsFailure() throws InitializationError {
+        Functional runner = new Functional(LoggingFailedTest.class);
+
+        Result result = new JUnitCore().run(runner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@Rule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@NoMetricAfter",
+                        "@After",
+                        "@Rule finished",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+
+    @Test
+    public void testNoMetricBeforeFailure_reportsFailedTest() throws InitializationError {
+        Functional runner = new Functional(LoggingNoMetricBeforeFailure.class);
+
+        Result result = new JUnitCore().run(runner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getRunCount()).isEqualTo(1);
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@Rule starting",
+                        "@NoMetricAfter",
+                        "@After",
+                        "@Rule finished",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+
+    @Test
+    public void testNoMetricAfterFailure_runsTestBodyAndReportsFailedTest() throws InitializationError {
+        Functional runner = new Functional(LoggingNoMetricAfterFailure.class);
+
+        Result result = new JUnitCore().run(runner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getRunCount()).isEqualTo(1);
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@Rule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@Test method body",
+                        "@NoMetricAfter",
+                        "@After",
+                        "@Rule finished",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+
+    /**
+     * A test that logs {@link Before}, {@link After}, {@link Test} included,
+     * used in conjunction with {@link Functional} to
+     * determine all {@link Statement}s are evaluated in the proper order.
+     */
+    @RunWith(Functional.class)
+    public static class LoggingTest {
+        @Microbenchmark.NoMetricRule
+        public NoMetricRule noMetricRule = new NoMetricRule();
+
+        @Rule
+        public LoggingRule loggingRule = new LoggingRule();
+
+        @NoMetricBefore
+        public void noMetricBeforeMethod() {
+            sLogs.add("@NoMetricBefore");
+        }
+
+        @Before
+        public void beforeMethod() {
+            sLogs.add("@Before");
+        }
+
+        @Test
+        public void testMethod() {
+            sLogs.add("@Test method body");
+        }
+
+        @After
+        public void afterMethod() {
+            sLogs.add("@After");
+        }
+
+        @NoMetricAfter
+        public void noMetricAfterMethod() {
+            sLogs.add("@NoMetricAfter");
+        }
+    }
+
+    public static class LoggingTestWithRules extends LoggingTest {
+        @ClassRule
+        public static TestRule hardCodedClassRule =
+                new TestWatcher() {
+                    @Override
+                    public void starting(Description description) {
+                        sLogs.add("hardcoded class rule starting");
+                    }
+
+                    @Override
+                    public void finished(Description description) {
+                        sLogs.add("hardcoded class rule finished");
+                    }
+                };
+
+        @Rule
+        public TestRule hardCodedRule =
+                new TestWatcher() {
+                    @Override
+                    public void starting(Description description) {
+                        sLogs.add("hardcoded test rule starting");
+                    }
+
+                    @Override
+                    public void finished(Description description) {
+                        sLogs.add("hardcoded test rule finished");
+                    }
+                };
+    }
+
+    public static class LoggingFailedTest extends LoggingTest {
+        @Test
+        public void testMethod() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingTestCreationFailure extends LoggingTest {
+        public LoggingTestCreationFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingNoMetricBeforeFailure extends LoggingTest {
+        @NoMetricBefore
+        public void noMetricBeforeFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingNoMetricAfterFailure extends LoggingTest {
+        @NoMetricAfter
+        public void noMetricAfterFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingRule extends TestWatcher {
+        @Override
+        public void starting(Description description) {
+            sLogs.add("@Rule starting");
+        }
+
+        @Override
+        public void finished(Description description) {
+            sLogs.add("@Rule finished");
+        }
+    }
+
+    public static class NoMetricRule extends TestWatcher {
+        @Override
+        public void starting(Description description) {
+            sLogs.add("@NoMetricRule starting");
+        }
+
+        @Override
+        public void finished(Description description) {
+            sLogs.add("@NoMetricRule finished");
+        }
+    }
+}
diff --git a/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/MicrobenchmarkTest.java b/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/MicrobenchmarkTest.java
index 76b9ba6c8..105a19a5c 100644
--- a/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/MicrobenchmarkTest.java
+++ b/libraries/health/runners/microbenchmark/tests/src/android/platform/test/microbenchmark/MicrobenchmarkTest.java
@@ -25,6 +25,8 @@ import static org.mockito.Mockito.verify;
 
 import android.os.Bundle;
 import android.os.SystemClock;
+import android.platform.test.microbenchmark.Microbenchmark.NoMetricAfter;
+import android.platform.test.microbenchmark.Microbenchmark.NoMetricBefore;
 import android.platform.test.microbenchmark.Microbenchmark.TerminateEarlyException;
 import android.platform.test.rule.TestWatcher;
 import android.platform.test.rule.TracePointRule;
@@ -111,15 +113,60 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+
+    @Test
+    public void testNoMetricBeforeFailure_reportsFailedTest() throws InitializationError {
+        LoggingMicrobenchmark loggingRunner = new LoggingMicrobenchmark(
+                LoggingNoMetricBeforeFailure.class);
+
+        Result result = new JUnitCore().run(loggingRunner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getRunCount()).isEqualTo(1);
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@NoMetricRule finished")
+                .inOrder();
+    }
+
+    @Test
+    public void testNoMetricAfterFailure_runsTestBodyAndReportsFailedTest() throws InitializationError {
+        LoggingMicrobenchmark loggingRunner = new LoggingMicrobenchmark(
+                LoggingNoMetricAfterFailure.class);
+
+        Result result = new JUnitCore().run(loggingRunner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getRunCount()).isEqualTo(1);
+        assertThat(sLogs)
+                .containsExactly(
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
+                        "begin: testMethod(android.platform.test.microbenchmark.MicrobenchmarkTest$LoggingNoMetricAfterFailure)",
+                        "@Test method body",
+                        "end",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -140,24 +187,32 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod$1("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "before",
-                        "tight before",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod$2("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -179,24 +234,32 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod--1("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "before",
-                        "tight before",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod--2("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -216,15 +279,19 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -245,24 +312,28 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTest)",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
-                        "test",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -397,13 +468,17 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isFalse();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingFailedTest)",
                         "end",
-                        "after")
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -423,23 +498,63 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isFalse();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingFailedTest)",
                         "end",
-                        "after",
-                        "before",
-                        "tight before",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingFailedTest)",
                         "end",
-                        "after")
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
+    @Test
+    public void testCreationFailed_terminateOnFailEnabled_testIsNotExecuted() throws InitializationError {
+        Bundle args = new Bundle();
+        args.putString("iterations", "2");
+        args.putString("rename-iterations", "false");
+        args.putString("terminate-on-test-fail", "true");
+        LoggingMicrobenchmark loggingRunner = new LoggingMicrobenchmark(
+                LoggingTestCreationFailure.class, args);
+
+        Result result = new JUnitCore().run(loggingRunner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getFailureCount()).isEqualTo(2);
+        assertThat(sLogs).isEmpty();
+    }
+
+    @Test
+    public void testCreationFailed_terminateOnFailDisabled_testIsNotExecuted() throws InitializationError {
+        Bundle args = new Bundle();
+        args.putString("iterations", "2");
+        args.putString("rename-iterations", "false");
+        args.putString("terminate-on-test-fail", "false");
+        LoggingMicrobenchmark loggingRunner = new LoggingMicrobenchmark(
+                LoggingTestCreationFailure.class, args);
+
+        Result result = new JUnitCore().run(loggingRunner);
+
+        assertThat(result.wasSuccessful()).isFalse();
+        assertThat(result.getFailureCount()).isEqualTo(2);
+        assertThat(sLogs).isEmpty();
+    }
+
     /** Test dynamic test rule injection. */
     @Test
     public void testDynamicTestRuleInjection() throws InitializationError {
@@ -456,38 +571,46 @@ public final class MicrobenchmarkTest {
         new JUnitCore().run(loggingRunner);
         assertThat(sLogs)
                 .containsExactly(
-                        "hardcoded class rule starting",
-                        "logging rule 2 starting",
-                        "hardcoded test rule starting",
-                        "logging rule 1 starting",
-                        "before",
-                        "tight before",
+                        "@ClassRule hardcoded starting",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Rule rule 2 starting",
+                        "@Rule hardcoded starting",
+                        "@Rule rule 1 starting",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTestWithRules)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "logging rule 1 finished",
-                        "hardcoded test rule finished",
-                        "logging rule 2 finished",
-                        "logging rule 2 starting",
-                        "hardcoded test rule starting",
-                        "logging rule 1 starting",
-                        "before",
-                        "tight before",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@Rule rule 1 finished",
+                        "@Rule hardcoded finished",
+                        "@Rule rule 2 finished",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Rule rule 2 starting",
+                        "@Rule hardcoded starting",
+                        "@Rule rule 1 starting",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTestWithRules)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "logging rule 1 finished",
-                        "hardcoded test rule finished",
-                        "logging rule 2 finished",
-                        "hardcoded class rule finished")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@Rule rule 1 finished",
+                        "@Rule hardcoded finished",
+                        "@Rule rule 2 finished",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@ClassRule hardcoded finished")
                 .inOrder();
     }
 
@@ -507,34 +630,42 @@ public final class MicrobenchmarkTest {
         new JUnitCore().run(loggingRunner);
         assertThat(sLogs)
                 .containsExactly(
-                        "logging rule 2 starting",
-                        "hardcoded class rule starting",
-                        "logging rule 1 starting",
-                        "hardcoded test rule starting",
-                        "before",
-                        "tight before",
+                        "@Rule rule 2 starting",
+                        "@ClassRule hardcoded starting",
+                        "@Rule rule 1 starting",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Rule hardcoded starting",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTestWithRules)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "hardcoded test rule finished",
-                        "hardcoded test rule starting",
-                        "before",
-                        "tight before",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@Rule hardcoded finished",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Rule hardcoded starting",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest"
                                 + "$LoggingTestWithRules)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "hardcoded test rule finished",
-                        "logging rule 1 finished",
-                        "hardcoded class rule finished",
-                        "logging rule 2 finished")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@Rule hardcoded finished",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@Rule rule 1 finished",
+                        "@ClassRule hardcoded finished",
+                        "@Rule rule 2 finished")
                 .inOrder();
     }
 
@@ -563,24 +694,32 @@ public final class MicrobenchmarkTest {
         assertThat(result.wasSuccessful()).isTrue();
         assertThat(sLogs)
                 .containsExactly(
-                        "before",
-                        "tight before",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod$1("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "AnnotatedLoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after",
-                        "before",
-                        "tight before",
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished",
+                        "@NoMetricRule starting",
+                        "@NoMetricBefore",
+                        "@Before",
+                        "@TightMethodRule before",
                         "begin: testMethod$2("
                                 + "android.platform.test.microbenchmark.MicrobenchmarkTest$"
                                 + "AnnotatedLoggingTest)",
-                        "test",
+                        "@Test method body",
                         "end",
-                        "tight after",
-                        "after")
+                        "@TightMethodRule after",
+                        "@After",
+                        "@NoMetricAfter",
+                        "@NoMetricRule finished")
                 .inOrder();
     }
 
@@ -655,19 +794,32 @@ public final class MicrobenchmarkTest {
         @Microbenchmark.TightMethodRule
         public TightRule orderRule = new TightRule();
 
+        @Microbenchmark.NoMetricRule
+        public NoMetricRule noMetricRule = new NoMetricRule();
+
+        @NoMetricBefore
+        public void noMetricBeforeMethod() {
+            sLogs.add("@NoMetricBefore");
+        }
+
         @Before
         public void beforeMethod() {
-            sLogs.add("before");
+            sLogs.add("@Before");
         }
 
         @Test
         public void testMethod() {
-            sLogs.add("test");
+            sLogs.add("@Test method body");
         }
 
         @After
         public void afterMethod() {
-            sLogs.add("after");
+            sLogs.add("@After");
+        }
+
+        @NoMetricAfter
+        public void noMetricAfterMethod() {
+            sLogs.add("@NoMetricAfter");
         }
 
         class TightRule implements TestRule {
@@ -676,9 +828,9 @@ public final class MicrobenchmarkTest {
                 return new Statement() {
                     @Override
                     public void evaluate() throws Throwable {
-                        sLogs.add("tight before");
+                        sLogs.add("@TightMethodRule before");
                         base.evaluate();
-                        sLogs.add("tight after");
+                        sLogs.add("@TightMethodRule after");
                     }
                 };
             }
@@ -699,12 +851,12 @@ public final class MicrobenchmarkTest {
                 new TestWatcher() {
                     @Override
                     public void starting(Description description) {
-                        sLogs.add("hardcoded class rule starting");
+                        sLogs.add("@ClassRule hardcoded starting");
                     }
 
                     @Override
                     public void finished(Description description) {
-                        sLogs.add("hardcoded class rule finished");
+                        sLogs.add("@ClassRule hardcoded finished");
                     }
                 };
 
@@ -713,12 +865,12 @@ public final class MicrobenchmarkTest {
                 new TestWatcher() {
                     @Override
                     public void starting(Description description) {
-                        sLogs.add("hardcoded test rule starting");
+                        sLogs.add("@Rule hardcoded starting");
                     }
 
                     @Override
                     public void finished(Description description) {
-                        sLogs.add("hardcoded test rule finished");
+                        sLogs.add("@Rule hardcoded finished");
                     }
                 };
     }
@@ -730,27 +882,59 @@ public final class MicrobenchmarkTest {
         }
     }
 
+    public static class LoggingTestCreationFailure extends LoggingTest {
+        public LoggingTestCreationFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingNoMetricBeforeFailure extends LoggingTest {
+        @NoMetricBefore
+        public void noMetricBeforeFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
+    public static class LoggingNoMetricAfterFailure extends LoggingTest {
+        @NoMetricAfter
+        public void noMetricAfterFailure() {
+            throw new RuntimeException("I failed.");
+        }
+    }
+
     public static class LoggingRule1 extends TestWatcher {
         @Override
         public void starting(Description description) {
-            sLogs.add("logging rule 1 starting");
+            sLogs.add("@Rule rule 1 starting");
         }
 
         @Override
         public void finished(Description description) {
-            sLogs.add("logging rule 1 finished");
+            sLogs.add("@Rule rule 1 finished");
         }
     }
 
     public static class LoggingRule2 extends TestWatcher {
         @Override
         public void starting(Description description) {
-            sLogs.add("logging rule 2 starting");
+            sLogs.add("@Rule rule 2 starting");
+        }
+
+        @Override
+        public void finished(Description description) {
+            sLogs.add("@Rule rule 2 finished");
+        }
+    }
+
+    public static class NoMetricRule extends TestWatcher {
+        @Override
+        public void starting(Description description) {
+            sLogs.add("@NoMetricRule starting");
         }
 
         @Override
         public void finished(Description description) {
-            sLogs.add("logging rule 2 finished");
+            sLogs.add("@NoMetricRule finished");
         }
     }
 }
diff --git a/libraries/metrics-helper/tests/Android.bp b/libraries/metrics-helper/tests/Android.bp
index 31f939466..f70a4355b 100644
--- a/libraries/metrics-helper/tests/Android.bp
+++ b/libraries/metrics-helper/tests/Android.bp
@@ -25,8 +25,8 @@ android_test {
     srcs: ["src/**/*.java"],
 
     libs: [
-        "android.test.runner",
-        "android.test.base",
+        "android.test.runner.stubs.system",
+        "android.test.base.stubs.system",
     ],
     static_libs: [
         "androidx.test.rules",
diff --git a/libraries/motion/compose/src/platform/test/motion/compose/ComposeToolkit.kt b/libraries/motion/compose/src/platform/test/motion/compose/ComposeToolkit.kt
index cb7b4ac4e..6bd7ff8d9 100644
--- a/libraries/motion/compose/src/platform/test/motion/compose/ComposeToolkit.kt
+++ b/libraries/motion/compose/src/platform/test/motion/compose/ComposeToolkit.kt
@@ -69,7 +69,7 @@ import platform.test.screenshot.DeviceEmulationSpec
 import platform.test.screenshot.Displays
 import platform.test.screenshot.GoldenPathManager
 
-/** Toolkit class to use for View-based [MotionTestRule] tests. */
+/** Toolkit to support Compose-based [MotionTestRule] tests. */
 class ComposeToolkit(
     val composeContentTestRule: ComposeContentTestRule,
     val testScope: TestScope,
diff --git a/libraries/motion/golden_updater/watch_local_tests.py b/libraries/motion/golden_updater/watch_local_tests.py
index 80d7b88d6..aa2a3f2be 100755
--- a/libraries/motion/golden_updater/watch_local_tests.py
+++ b/libraries/motion/golden_updater/watch_local_tests.py
@@ -33,6 +33,8 @@ import mimetypes
 import hashlib
 import shutil
 import secrets
+import datetime
+
 
 from collections import defaultdict
 
@@ -54,26 +56,12 @@ def main():
         help="The ADB device serial to pull goldens from.",
     )
 
-    parser.add_argument(
-        "--watch",
-        nargs="*",
-        action="append",
-        help="package:subdirectory where motion goldens are expected.",
-    )
-
     parser.add_argument(
         "--android_build_top",
         default=os.environ.get("ANDROID_BUILD_TOP"),
         help="The root directory of the android checkout.",
     )
 
-    parser.add_argument(
-        "--clean",
-        default=False,
-        type=bool,
-        help="Whether to clean the golden directory on device at startup.",
-    )
-
     parser.add_argument(
         "--client_url",
         default="http://motion.teams.x20web.corp.google.com/",
@@ -114,23 +102,6 @@ def main():
         global golden_watcher, this_server_address
         golden_watcher = GoldenFileWatcher(tmpdir, adb_client)
 
-        for dir in golden_watcher.list_golden_output_directories():
-            golden_watcher.add_remote_dir(dir)
-
-        if args.watch is not None:
-            for watching in args.watch:
-                parts = watching.split(":", 1)
-                package, output_dir = parts
-                if len(parts) == 2:
-                    golden_watcher.add_remote_dir(
-                        f"/data/user/0/{package}/files/{output_dir}/"
-                    )
-                else:
-                    print(f"skipping wrongly formatted watch arg [{watching}]")
-
-        if args.clean:
-            golden_watcher.clean()
-
         this_server_address = f"http://localhost:{args.port}"
 
         with socketserver.TCPServer(
@@ -142,6 +113,7 @@ def main():
             try:
                 httpd.serve_forever()
             except KeyboardInterrupt:
+                httpd.shutdown()
                 print("Shutting down")
 
 
@@ -181,13 +153,28 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
 
         if parsed.path == "/service/list":
             self.service_list_goldens()
+            return
         elif parsed.path.startswith("/golden/"):
             requested_file_start_index = parsed.path.find("/", len("/golden/") + 1)
             requested_file = parsed.path[requested_file_start_index + 1 :]
             print(requested_file)
             self.serve_file(golden_watcher.temp_dir, requested_file)
-        else:
-            self.send_error(404)
+            return
+        elif parsed.path.startswith("/expected/"):
+            golden_id = parsed.path[len("/expected/") :]
+            print(golden_id)
+
+            goldens = golden_watcher.cached_goldens.values()
+            for golden in goldens:
+                if golden.id != golden_id:
+                    continue
+
+                self.serve_file(
+                    android_build_top, golden.golden_repo_path, "application/json"
+                )
+                return
+
+        self.send_error(404)
 
     def do_POST(self):
         if not self.verify_access_token():
@@ -221,7 +208,7 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
         else:
             self.send_error(404)
 
-    def serve_file(self, root_directory, file_relative_to_root):
+    def serve_file(self, root_directory, file_relative_to_root, mime_type=None):
         resolved_path = path.abspath(path.join(root_directory, file_relative_to_root))
 
         print(resolved_path)
@@ -231,12 +218,9 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
             [resolved_path, root_directory]
         ) == root_directory and path.isfile(resolved_path):
             self.send_response(200)
-            self.send_header("Content-type", mimetypes.guess_type(resolved_path)[0])
-            # Accept-ranges: bytes is needed for chrome to allow seeking the
-            # video. At this time, won't handle ranges on subsequent gets,
-            # but that is likely OK given the size of these videos and that
-            # its local only.
-            self.send_header("Accept-ranges", "bytes")
+            self.send_header(
+                "Content-type", mime_type or mimetypes.guess_type(resolved_path)[0]
+            )
             self.add_standard_headers()
             self.end_headers()
             with open(resolved_path, "rb") as f:
@@ -259,34 +243,22 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
             golden_data["label"] = golden.golden_identifier
             golden_data["goldenRepoPath"] = golden.golden_repo_path
             golden_data["updated"] = golden.updated
+            golden_data["testClassName"] = golden.test_class_name
+            golden_data["testMethodName"] = golden.test_method_name
+            golden_data["testTime"] = golden.test_time
 
-            if isinstance(golden, CachedMotionGolden):
-                golden_data["type"] = "motion"
-                golden_data["actualUrl"] = (
-                    f"{this_server_address}/golden/{golden.checksum}/{golden.local_file[len(golden_watcher.temp_dir) + 1 :]}"
-                )
-                golden_data["videoUrl"] = (
-                    f"{this_server_address}/golden/{golden.checksum}/{golden.video_location}"
+            golden_data["actualUrl"] = (
+                f"{this_server_address}/golden/{golden.checksum}/{golden.local_file[len(golden_watcher.temp_dir) + 1 :]}"
+            )
+            expected_file = path.join(android_build_top, golden.golden_repo_path)
+            if os.path.exists(expected_file):
+                golden_data["expectedUrl"] = (
+                    f"{this_server_address}/expected/{golden.id}"
                 )
 
-            elif isinstance(golden, CachedScreenshotGolden):
-                golden_data["type"] = "screenshot"
-
-                golden_data["label"] = golden.golden_identifier
-                golden_data["actualUrl"] = (
-                    f"{this_server_address}/golden/{golden.checksum}/{golden.actual_image}"
-                )
-                if golden.expected_image:
-                    golden_data["expectedUrl"] = (
-                        f"{this_server_address}/golden/{golden.checksum}/{golden.expected_image}"
-                    )
-                if golden.diff_image:
-                    golden_data["diffUrl"] = (
-                        f"{this_server_address}/golden/{golden.checksum}/{golden.diff_image}"
-                    )
-
-            else:
-                continue
+            golden_data["videoUrl"] = (
+                f"{this_server_address}/golden/{golden.checksum}/{golden.video_location}"
+            )
 
             goldens_list.append(golden_data)
 
@@ -295,9 +267,7 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
     def service_refresh_goldens(self, clear):
         if clear:
             golden_watcher.clean()
-        for dir in golden_watcher.list_golden_output_directories():
-            golden_watcher.add_remote_dir(dir)
-        golden_watcher.refresh_all_golden_files()
+        golden_watcher.refresh_golden_files()
         self.service_list_goldens()
 
     def service_update_golden(self, id):
@@ -307,24 +277,14 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
                 print("skip", golden.id)
                 continue
 
-            if isinstance(golden, CachedMotionGolden):
-                shutil.copyfile(
-                    golden.local_file,
-                    path.join(android_build_top, golden.golden_repo_path),
-                )
-
-                golden.updated = True
-                self.send_json({"result": "OK"})
-                return
-            elif isinstance(golden, CachedScreenshotGolden):
-                shutil.copyfile(
-                    path.join(golden_watcher.temp_dir, golden.actual_image),
-                    path.join(android_build_top, golden.golden_repo_path),
-                )
+            shutil.copyfile(
+                golden.local_file,
+                path.join(android_build_top, golden.golden_repo_path),
+            )
 
-                golden.updated = True
-                self.send_json({"result": "OK"})
-                return
+            golden.updated = True
+            self.send_json({"result": "OK"})
+            return
 
         self.send_error(400)
 
@@ -338,14 +298,18 @@ class WatchWebAppRequestHandler(http.server.BaseHTTPRequestHandler):
         self.wfile.write(data_encoded)
 
     def add_standard_headers(self):
-        self.send_header("Cache-Control", "no-cache, no-store, must-revalidate")
         self.send_header("Access-Control-Allow-Origin", "*")
         self.send_header("Access-Control-Allow-Methods", "POST, PUT, GET, OPTIONS")
         self.send_header(
             "Access-Control-Allow-Headers",
-            GOLDEN_ACCESS_TOKEN_HEADER + ", Content-Type, Content-Length",
+            GOLDEN_ACCESS_TOKEN_HEADER
+            + ", Content-Type, Content-Length, Range, Accept-ranges",
         )
-        self.send_header("Access-Control-Expose-Headers", "Winscope-Proxy-Version")
+        # Accept-ranges: bytes is needed for chrome to allow seeking the
+        # video. At this time, won't handle ranges on subsequent gets,
+        # but that is likely OK given the size of these videos and that
+        # its local only.
+        self.send_header("Accept-ranges", "bytes")
 
 
 class GoldenFileWatcher:
@@ -353,93 +317,32 @@ class GoldenFileWatcher:
     def __init__(self, temp_dir, adb_client):
         self.temp_dir = temp_dir
         self.adb_client = adb_client
-        self.remote_dirs = set()
 
         # name -> CachedGolden
         self.cached_goldens = {}
-
-    def add_remote_dir(self, remote_dir):
-        self.remote_dirs.add(remote_dir)
-        self.refresh_golden_files(remote_dir)
-
-    def list_golden_output_directories(self):
-        marker_name = ".motion_test_output_marker"
-        command = f"find /data/user/0/ -type f -name {marker_name}"
-
-        files = self.run_adb_command(["shell", command]).splitlines()
-        print(f"Found {len(files)} motion directories")
-
-        return [name[: -len(marker_name)] for name in files]
+        self.refresh_golden_files()
 
     def clean(self):
         self.cached_goldens = {}
-        for remote_path in self.remote_dirs:
-            self.run_adb_command(["shell", f"rm -rf {remote_path}"])
-
-    def refresh_all_golden_files(self):
-        for remote_path in self.remote_dirs:
-            self.refresh_golden_files(remote_path)
-
-    def refresh_golden_files(self, remote_dir):
 
-        updated_goldens = self.list_golden_files(remote_dir)
+    def refresh_golden_files(self):
+        command = f"find /data/user/0/ -type f -name *.actual.json"
+        updated_goldens = self.run_adb_command(["shell", command]).splitlines()
+        print(f"Updating goldens - found {len(updated_goldens)} files")
 
         for golden_remote_file in updated_goldens:
-
             local_file = self.adb_pull(golden_remote_file)
 
-            golden = None
-            if local_file.endswith(".json"):
-                golden = self.motion_golden(remote_dir, golden_remote_file, local_file)
-            elif local_file.endswith("goldResult.textproto"):
-                golden = self.screenshot_golden(
-                    remote_dir, golden_remote_file, local_file
-                )
-
-            if golden != None:
-                self.cached_goldens[golden_remote_file] = golden
-            else:
-                print(f"skipping unknonwn golden ")
-
-    def motion_golden(self, remote_dir, remote_file, local_file):
-
-        golden = CachedMotionGolden(remote_file, local_file)
-        golden.checksum = hashlib.md5(open(local_file, "rb").read()).hexdigest()
-
-        if golden.video_location:
-            self.adb_pull_image(remote_dir, golden.video_location)
-
-        return golden
-
-    def screenshot_golden(self, remote_dir, remote_file, local_file):
-        golden = CachedScreenshotGolden(remote_file, local_file)
-
-        if golden.actual_image:
-            local_actual_image = self.adb_pull_image(remote_dir, golden.actual_image)
-            golden.checksum = hashlib.md5(
-                open(local_actual_image, "rb").read()
-            ).hexdigest()
-        if golden.expected_image:
-            self.adb_pull_image(remote_dir, golden.expected_image)
-        if golden.diff_image:
-            self.adb_pull_image(remote_dir, golden.diff_image)
-
-        return golden
-
-    def list_golden_files(self, remote_dir):
-        print(f"Polling for updated goldens")
-
-        command = f"find {remote_dir} -type f \\( -name *.json -o -name *.textproto \\)"
+            golden = CachedGolden(golden_remote_file, local_file)
+            if golden.video_location:
+                self.adb_pull_image(golden.device_local_path, golden.video_location)
 
-        files = self.run_adb_command(["shell", command]).splitlines()
-        print(f"Found {len(files)} files")
-
-        return files
+            self.cached_goldens[golden_remote_file] = golden
 
     def adb_pull(self, remote_file):
         local_file = os.path.join(self.temp_dir, os.path.basename(remote_file))
         self.run_adb_command(["pull", remote_file, local_file])
-        # self.run_adb_command(["shell", "rm", remote_file])
+        self.run_adb_command(["shell", "rm", remote_file])
         return local_file
 
     def adb_pull_image(self, remote_dir, remote_file):
@@ -447,7 +350,7 @@ class GoldenFileWatcher:
         local_path = os.path.join(self.temp_dir, remote_file)
         os.makedirs(os.path.dirname(local_path), exist_ok=True)
         self.run_adb_command(["pull", remote_path, local_path])
-        # self.run_adb_command(["shell", "rm", remote_path])
+        self.run_adb_command(["shell", "rm", remote_path])
         return local_path
 
     def run_adb_command(self, args):
@@ -461,12 +364,11 @@ class CachedGolden:
         self.remote_file = remote_file
         self.local_file = local_file
         self.updated = False
-        self.checksum = "0"
-
-
-class CachedMotionGolden(CachedGolden):
+        self.test_time = datetime.datetime.now().isoformat()
+        # Checksum is the time the test data was loaded, forcing unique URLs
+        # every time the golden is reloaded
+        self.checksum = hashlib.md5(self.test_time.encode("utf-8")).hexdigest()
 
-    def __init__(self, remote_file, local_file):
         motion_golden_data = None
         with open(local_file, "r") as json_file:
             motion_golden_data = json.load(json_file)
@@ -475,38 +377,17 @@ class CachedMotionGolden(CachedGolden):
         self.result = metadata["result"]
         self.golden_repo_path = metadata["goldenRepoPath"]
         self.golden_identifier = metadata["goldenIdentifier"]
+        self.test_class_name = metadata["testClassName"]
+        self.test_method_name = metadata["testMethodName"]
+        self.device_local_path = metadata["deviceLocalPath"]
         self.video_location = None
         if "videoLocation" in metadata:
-          self.video_location = metadata["videoLocation"]
-
-        self.test_identifier = metadata["filmstripTestIdentifier"]
+            self.video_location = metadata["videoLocation"]
 
         with open(local_file, "w") as json_file:
             del motion_golden_data["//metadata"]
             json.dump(motion_golden_data, json_file, indent=2)
 
-        super().__init__(remote_file, local_file)
-
-
-class CachedScreenshotGolden(CachedGolden):
-
-    def __init__(self, remote_file, local_file):
-
-        metadata = parse_text_proto(local_file)
-
-        self.golden_repo_path = metadata["image_location_golden"]
-        self.actual_image = metadata["image_location_test"]
-
-        match = re.search(r"_actual_(.*?)\.png$", self.actual_image)
-        if match:
-            self.golden_identifier = match.group(1)
-
-        self.expected_image = metadata["image_location_reference"]
-        self.diff_image = metadata["image_location_diff"]
-        self.result = metadata["result_type"]
-
-        super().__init__(remote_file, local_file)
-
 
 class AdbClient:
     def __init__(self, adb_serial):
@@ -542,40 +423,6 @@ def find_free_port():
         return s.getsockname()[1]  # Get the port number
 
 
-def parse_text_proto(filename):
-    data = defaultdict(dict)
-    level = 0
-
-    with open(filename, "r") as file:
-        for line in file:
-            line = line.strip()
-
-            if line.endswith("{"):
-                level += 1
-                continue
-
-            if line == "}":
-                level -= 1
-                continue
-
-            # not consuming nested messages for now
-            if not line or line.startswith("#") or level > 0:
-                continue
-
-            key, value = line.split(":", 1)
-            if not key or not value:
-                continue
-
-            key, value = key.strip(), value.strip()
-
-            if value.startswith('"') and value.endswith('"'):
-                value = value[1:-1]
-
-            data[key] = value
-
-    return data
-
-
 def get_token() -> str:
     try:
         with open(GOLDEN_ACCESS_TOKEN_LOCATION, "r") as token_file:
diff --git a/libraries/motion/src/platform/test/motion/MotionTestRule.kt b/libraries/motion/src/platform/test/motion/MotionTestRule.kt
index 78b9ef491..3ba63e37e 100644
--- a/libraries/motion/src/platform/test/motion/MotionTestRule.kt
+++ b/libraries/motion/src/platform/test/motion/MotionTestRule.kt
@@ -72,7 +72,6 @@ class MotionTestRule<Toolkit>(
             override fun finished(description: Description?) {
                 testClassName = null
                 testMethodName = null
-                ensureOutputDirectoryMarkerCreated()
             }
         }
 
@@ -129,7 +128,7 @@ class MotionTestRule<Toolkit>(
         requireValidGoldenIdentifier(goldenIdentifier)
 
         val relativeGoldenPath =
-            goldenPathManager.goldenIdentifierResolver(goldenIdentifier, JSON_EXTENSION)
+            goldenPathManager.goldenIdentifierResolver(goldenIdentifier, JSON_ACTUAL_EXTENSION)
         val deviceLocalPath = File(goldenPathManager.deviceLocalPath)
         val goldenFile =
             deviceLocalPath.resolve(recordedMotion.testClassName).resolve(relativeGoldenPath)
@@ -142,10 +141,13 @@ class MotionTestRule<Toolkit>(
         val metadata = JSONObject()
         metadata.put(
             "goldenRepoPath",
-            "${goldenPathManager.assetsPathRelativeToBuildRoot}/$relativeGoldenPath"
+            "${goldenPathManager.assetsPathRelativeToBuildRoot}/${relativeGoldenPath.replace(
+                JSON_ACTUAL_EXTENSION, JSON_EXTENSION)}"
         )
-        metadata.put("filmstripTestIdentifier", debugFilmstripTestIdentifier(recordedMotion))
         metadata.put("goldenIdentifier", goldenIdentifier)
+        metadata.put("testClassName", recordedMotion.testClassName)
+        metadata.put("testMethodName", recordedMotion.testMethodName)
+        metadata.put("deviceLocalPath", deviceLocalPath)
         metadata.put("result", result.name)
 
         recordedMotion.videoRenderer?.let { videoRenderer ->
@@ -178,29 +180,9 @@ class MotionTestRule<Toolkit>(
         }
     }
 
-    /**
-     * The golden screenshot identifier used by []writeDebugFilmstrip]
-     *
-     * Allows tooling to recognize the debug filmstrip related to a motion test
-     */
-    private fun debugFilmstripTestIdentifier(
-        recordedMotion: RecordedMotion,
-    ) = "motion_debug_filmstrip_${recordedMotion.testClassName}"
-
-    private fun ensureOutputDirectoryMarkerCreated() {
-        try {
-            val markerFile =
-                File(goldenPathManager.deviceLocalPath).resolve(".motion_test_output_marker")
-            if (!markerFile.exists()) {
-                markerFile.createNewFile()
-            }
-        } catch (e: IOException) {
-            Log.e(TAG, "Unable to create golden output marker file", e)
-        }
-    }
-
     companion object {
         private const val JSON_EXTENSION = "json"
+        private const val JSON_ACTUAL_EXTENSION = "actual.${JSON_EXTENSION}"
         private const val VIDEO_EXTENSION = "mp4"
         private const val JSON_INDENTATION = 2
         private val GOLDEN_IDENTIFIER_REGEX = "^[A-Za-z0-9_-]+$".toRegex()
diff --git a/libraries/motion/src/platform/test/motion/filmstrip/VideoRenderer.kt b/libraries/motion/src/platform/test/motion/filmstrip/VideoRenderer.kt
index 8836d2db8..a74202d4f 100644
--- a/libraries/motion/src/platform/test/motion/filmstrip/VideoRenderer.kt
+++ b/libraries/motion/src/platform/test/motion/filmstrip/VideoRenderer.kt
@@ -29,8 +29,9 @@ import platform.test.motion.golden.TimestampFrameId
 /** Produces an MP4 based on the [screenshots]. */
 class VideoRenderer(private val screenshots: List<MotionScreenshot>) {
 
-    private var screenshotWidth = screenshots.maxOf { it.bitmap.width }
-    private var screenshotHeight = screenshots.maxOf { it.bitmap.height }
+    private var screenshotWidth = screenshots.maxOf { it.bitmap.width }.roundUpToNextMultipleOf16()
+    private var screenshotHeight =
+        screenshots.maxOf { it.bitmap.height }.roundUpToNextMultipleOf16()
 
     /**
      * Creates an MP4 file at [path], which will contain all screenshots.
@@ -155,5 +156,7 @@ class VideoRenderer(private val screenshots: List<MotionScreenshot>) {
         const val FRAME_DURATION = 16L
         const val FRAME_RATE = 1000f / FRAME_DURATION
         const val DEQUEUE_TIMEOUT_US = 10_000L
+
+        private fun Int.roundUpToNextMultipleOf16(): Int = (this + 15) and 0xF.inv()
     }
 }
diff --git a/libraries/motion/tests/src/platform/test/motion/MotionTestRuleTest.kt b/libraries/motion/tests/src/platform/test/motion/MotionTestRuleTest.kt
index f2f1e7f8c..7227a1c86 100644
--- a/libraries/motion/tests/src/platform/test/motion/MotionTestRuleTest.kt
+++ b/libraries/motion/tests/src/platform/test/motion/MotionTestRuleTest.kt
@@ -79,7 +79,7 @@ class MotionTestRuleTest {
             TimeSeriesVerificationResult.PASSED
         )
         val expectedFile =
-            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.json")
+            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.actual.json")
 
         assertThat(expectedFile.exists()).isTrue()
     }
@@ -92,7 +92,7 @@ class MotionTestRuleTest {
             TimeSeriesVerificationResult.PASSED
         )
         val expectedFile =
-            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.json")
+            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.actual.json")
 
         val fileContentsWithoutMetadata =
             JSONObject(expectedFile.readText()).apply { remove("//metadata") }
@@ -114,16 +114,27 @@ class MotionTestRuleTest {
             TimeSeriesVerificationResult.MISSING_REFERENCE
         )
         val expectedFile =
-            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.json")
+            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.actual.json")
 
         val fileContents = JSONObject(expectedFile.readText())
-
-        assertThat(fileContents.get("//metadata") as JSONObject)
+        val metadataJson = fileContents.get("//metadata") as JSONObject
+
+        assertThat(metadataJson.has("deviceLocalPath")).isTrue()
+        // should be `/data/user/0/platform.test.motion.tests/files/goldens`, but the gradle
+        // setup ends up using `platform.test.motion.test` (without the `s`), even though the
+        // testNamespace property is configured otherwise. Verifying the presence of this
+        // property manually, to ensure the test passes both on gradle and soong. The difference
+        // itself does not matter
+        val deviceLocalPath = metadataJson.remove("deviceLocalPath") as String
+        assertThat(deviceLocalPath).startsWith("/data/user/0/platform.test.motion.test")
+
+        assertThat(metadataJson)
             .isEqualTo(
                 JSONObject().apply {
                     put("goldenRepoPath", "assets/updated_golden.json")
-                    put("filmstripTestIdentifier", "motion_debug_filmstrip_FooClass")
                     put("goldenIdentifier", "updated_golden")
+                    put("testClassName", "FooClass")
+                    put("testMethodName", "bar_test")
                     put("result", "MISSING_REFERENCE")
                 }
             )
@@ -153,21 +164,32 @@ class MotionTestRuleTest {
         )
 
         val expectedVideo =
-            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.mp4")
+            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.actual.mp4")
         assertThat(expectedVideo.exists()).isTrue()
 
         val expectedFile =
-            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.json")
+            File(goldenPathManager.deviceLocalPath).resolve("FooClass/updated_golden.actual.json")
         val fileContents = JSONObject(expectedFile.readText())
-
-        assertThat(fileContents.get("//metadata") as JSONObject)
+        val metadataJson = fileContents.get("//metadata") as JSONObject
+
+        assertThat(metadataJson.has("deviceLocalPath")).isTrue()
+        // should be `/data/user/0/platform.test.motion.tests/files/goldens`, but the gradle
+        // setup ends up using `platform.test.motion.test` (without the `s`), even though the
+        // testNamespace property is configured otherwise. Verifying the presence of this
+        // property manually, to ensure the test passes both on gradle and soong. The difference
+        // itself does not matter
+        val deviceLocalPath = metadataJson.remove("deviceLocalPath") as String
+        assertThat(deviceLocalPath).startsWith("/data/user/0/platform.test.motion.test")
+
+        assertThat(metadataJson)
             .isEqualTo(
                 JSONObject().apply {
                     put("goldenRepoPath", "assets/updated_golden.json")
-                    put("filmstripTestIdentifier", "motion_debug_filmstrip_FooClass")
                     put("goldenIdentifier", "updated_golden")
+                    put("testClassName", "FooClass")
+                    put("testMethodName", "bar_test")
                     put("result", "MISSING_REFERENCE")
-                    put("videoLocation", "FooClass/updated_golden.mp4")
+                    put("videoLocation", "FooClass/updated_golden.actual.mp4")
                 }
             )
     }
diff --git a/libraries/notes-role-test-helper/Android.bp b/libraries/notes-role-test-helper/Android.bp
index e3b31bf35..ec57e54d4 100644
--- a/libraries/notes-role-test-helper/Android.bp
+++ b/libraries/notes-role-test-helper/Android.bp
@@ -21,14 +21,14 @@ package {
 java_library {
     name: "notes-role-test-helper",
     static_libs: [
+        "androidx.activity_activity-ktx",
         "androidx.core_core-ktx",
         "androidx.test.core",
         "androidx.test.uiautomator_uiautomator",
         "uiautomator-helpers",
     ],
     srcs: [
-	"src/**/*.java",
+        "src/**/*.java",
         "src/**/*.kt",
     ],
 }
-
diff --git a/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/AppClipsScreenshotActivity.kt b/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/AppClipsScreenshotActivity.kt
new file mode 100644
index 000000000..0ba19acb4
--- /dev/null
+++ b/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/AppClipsScreenshotActivity.kt
@@ -0,0 +1,107 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.helpers.notesrole
+
+import android.content.BroadcastReceiver
+import android.content.ComponentName
+import android.content.Context
+import android.content.Intent
+import android.content.Intent.FLAG_ACTIVITY_LAUNCH_ADJACENT
+import android.content.Intent.FLAG_ACTIVITY_MULTIPLE_TASK
+import android.content.Intent.FLAG_ACTIVITY_NEW_DOCUMENT
+import android.content.Intent.FLAG_ACTIVITY_NEW_TASK
+import android.content.IntentFilter
+import android.os.Bundle
+import androidx.activity.ComponentActivity
+
+/** Empty activity for app clips screenshots. */
+class AppClipsScreenshotActivity : ComponentActivity() {
+
+    private val launchDifferentAppInSplitScreenReceiver: BroadcastReceiver =
+        object : BroadcastReceiver() {
+            override fun onReceive(context: Context?, intent: Intent?) {
+                launchDifferentAppInSplitScreen()
+            }
+        }
+
+    private val launchSameAppInSplitScreenReceiver: BroadcastReceiver =
+        object : BroadcastReceiver() {
+            override fun onReceive(context: Context?, intent: Intent?) {
+                launchSameAppInSplitScreen()
+            }
+        }
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+
+        registerReceiver(
+            launchDifferentAppInSplitScreenReceiver,
+            IntentFilter(LAUNCH_DIFFERENT_APP_IN_SPLIT_SCREEN_ACTION),
+            RECEIVER_EXPORTED
+        )
+
+        registerReceiver(
+            launchSameAppInSplitScreenReceiver,
+            IntentFilter(LAUNCH_SAME_APP_IN_SPLIT_SCREEN_ACTION),
+            RECEIVER_EXPORTED
+        )
+    }
+
+    override fun onDestroy() {
+        super.onDestroy()
+        unregisterReceiver(launchDifferentAppInSplitScreenReceiver)
+        unregisterReceiver(launchSameAppInSplitScreenReceiver)
+    }
+
+    private fun launchDifferentAppInSplitScreen() =
+        startActivity(
+            Intent().apply {
+                setComponent(ComponentName(packageName, SPLIT_DIFFERENT_ACTIVITY_NAME))
+                addFlags(
+                    FLAG_ACTIVITY_NEW_TASK or
+                        FLAG_ACTIVITY_LAUNCH_ADJACENT or
+                        FLAG_ACTIVITY_MULTIPLE_TASK or
+                        FLAG_ACTIVITY_NEW_DOCUMENT
+                )
+            }
+        )
+
+    private fun launchSameAppInSplitScreen() =
+        startActivity(
+            Intent().apply {
+                setComponent(this@AppClipsScreenshotActivity.componentName)
+                addFlags(
+                    FLAG_ACTIVITY_NEW_TASK or
+                        FLAG_ACTIVITY_LAUNCH_ADJACENT or
+                        FLAG_ACTIVITY_MULTIPLE_TASK or
+                        FLAG_ACTIVITY_NEW_DOCUMENT
+                )
+            }
+        )
+
+    companion object {
+        const val LAUNCH_DIFFERENT_APP_IN_SPLIT_SCREEN_ACTION: String =
+            "LAUNCH_DIFFERENT_APP_IN_SPLIT_SCREEN_ACTION"
+        const val LAUNCH_SAME_APP_IN_SPLIT_SCREEN_ACTION: String =
+            "LAUNCH_SAME_APP_IN_SPLIT_SCREEN_ACTION"
+        private const val SPLIT_DIFFERENT_ACTIVITY_NAME: String =
+            "android.platform.helpers.notesrole.AppClipsScreenshotActivity.Split"
+
+        fun getIntent(context: Context): Intent =
+            Intent(context, AppClipsScreenshotActivity::class.java).addFlags(FLAG_ACTIVITY_NEW_TASK)
+    }
+}
diff --git a/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/NotesAppActivity.kt b/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/NotesAppActivity.kt
new file mode 100644
index 000000000..c1a303e33
--- /dev/null
+++ b/libraries/notes-role-test-helper/src/android/platform/helpers/notesrole/NotesAppActivity.kt
@@ -0,0 +1,161 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.helpers.notesrole
+
+import android.content.BroadcastReceiver
+import android.content.ClipData
+import android.content.ClipDescription.MIMETYPE_TEXT_INTENT
+import android.content.ClipDescription.MIMETYPE_TEXT_URILIST
+import android.content.Context
+import android.content.Intent
+import android.content.Intent.ACTION_LAUNCH_CAPTURE_CONTENT_ACTIVITY_FOR_NOTE
+import android.content.Intent.CAPTURE_CONTENT_FOR_NOTE_FAILED
+import android.content.Intent.CAPTURE_CONTENT_FOR_NOTE_SUCCESS
+import android.content.Intent.EXTRA_CAPTURE_CONTENT_FOR_NOTE_STATUS_CODE
+import android.content.IntentFilter
+import android.net.Uri
+import android.os.Bundle
+import android.view.View
+import android.widget.Button
+import android.widget.ImageView
+import android.widget.LinearLayout
+import android.widget.TextView
+import androidx.activity.ComponentActivity
+import androidx.activity.result.ActivityResult
+import androidx.activity.result.ActivityResultLauncher
+import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
+import androidx.core.view.setPadding
+
+/** Sample notes app activity for app clips verification in end to end tests. */
+class NotesAppActivity : ComponentActivity() {
+
+    private val finishBroadcastReceiver: BroadcastReceiver =
+        object : BroadcastReceiver() {
+            override fun onReceive(context: Context?, intent: Intent?) {
+                finish()
+            }
+        }
+
+    private lateinit var appClipsLauncher: ActivityResultLauncher<Intent>
+    private lateinit var rootLinearLayout: LinearLayout
+    private var screenshotUri: Uri? = null
+
+    override fun onCreate(savedInstanceState: Bundle?) {
+        super.onCreate(savedInstanceState)
+
+        registerReceiver(
+            finishBroadcastReceiver,
+            IntentFilter(FINISH_NOTES_APP_ACTIVITY_ACTION),
+            RECEIVER_EXPORTED
+        )
+
+        appClipsLauncher =
+            registerForActivityResult(StartActivityForResult(), this::onAppClipsActivityResult)
+
+        actionBar?.hide()
+        setContentView(createContentView())
+    }
+
+    override fun onDestroy() {
+        super.onDestroy()
+        unregisterReceiver(finishBroadcastReceiver)
+        screenshotUri?.let { contentResolver.delete(it, /* extras= */ null) }
+    }
+
+    private fun createContentView(): View =
+        LinearLayout(this)
+            .apply {
+                orientation = LinearLayout.VERTICAL
+                setPadding(PADDING)
+                addView(createTriggerAppClipsButton())
+            }
+            .also { rootLinearLayout = it }
+
+    private fun createTriggerAppClipsButton(): Button =
+        Button(this).apply {
+            text = APP_CLIPS_BUTTON_TEXT
+            setOnClickListener {
+                appClipsLauncher.launch(Intent(ACTION_LAUNCH_CAPTURE_CONTENT_ACTIVITY_FOR_NOTE))
+            }
+        }
+
+    private fun onAppClipsActivityResult(activityResult: ActivityResult) {
+        // Activity/app is killed after each test, so de-clutter views for easier verification.
+        rootLinearLayout.removeAllViews()
+
+        // Add a text view with specific text to make it easier for verification in tests.
+        TextView(this).apply { text = RESPONSE_TEXT }.also { rootLinearLayout.addView(it) }
+
+        val result = activityResult.data
+        val statusCode =
+            result?.getIntExtra(
+                EXTRA_CAPTURE_CONTENT_FOR_NOTE_STATUS_CODE,
+                CAPTURE_CONTENT_FOR_NOTE_FAILED
+            )
+        // In case app clips returns error, show it and return early.
+        if (statusCode != CAPTURE_CONTENT_FOR_NOTE_SUCCESS) {
+            showErrorViewWithText("Error status code: $statusCode")
+            return
+        }
+
+        // Show backlinks data, if available.
+        rootLinearLayout.addView(
+            result.clipData.let { clipData ->
+                TextView(this).apply {
+                    text =
+                        clipData?.let { getStringFormattedBacklinksData(it) } ?: NO_BACKLINKS_TEXT
+                }
+            }
+        )
+
+        // Show app clips screenshot, if available.
+        result.data
+            ?.also { screenshotUri = it }
+            ?.let { uri ->
+                val imageView = ImageView(this).apply { setImageURI(uri) }
+                rootLinearLayout.addView(imageView)
+            }
+    }
+
+    private fun showErrorViewWithText(error: String) {
+        TextView(this).apply { text = error }.also { rootLinearLayout.addView(it) }
+    }
+
+    companion object {
+        private const val PADDING = 50
+
+        const val FINISH_NOTES_APP_ACTIVITY_ACTION: String = "FINISH_NOTES_APP_ACTIVITY_ACTION"
+        const val APP_CLIPS_BUTTON_TEXT: String = "TRIGGER APP CLIPS"
+        const val RESPONSE_TEXT: String = "RESPONSE"
+        const val NO_BACKLINKS_TEXT: String = "NO BACKLINKS AVAILABLE"
+
+        /** Formats Backlinks [ClipData] in readable format for verification. */
+        fun getStringFormattedBacklinksData(clipData: ClipData): String =
+            clipData.let { data ->
+                data
+                    .getItemAt(0)
+                    .let { dataItem ->
+                        when (data.description.getMimeType(0)) {
+                            MIMETYPE_TEXT_URILIST -> dataItem.uri.toString()
+                            MIMETYPE_TEXT_INTENT -> dataItem.intent.toString()
+                            else -> dataItem.toString()
+                        }
+                    }
+                    .let { backlinksData -> "${data.description.label}\n$backlinksData" }
+            }
+    }
+}
diff --git a/libraries/screenshot/src/main/java/platform/test/screenshot/DeviceEmulationRule.kt b/libraries/screenshot/src/main/java/platform/test/screenshot/DeviceEmulationRule.kt
index dbb0f2d49..3c2996fab 100644
--- a/libraries/screenshot/src/main/java/platform/test/screenshot/DeviceEmulationRule.kt
+++ b/libraries/screenshot/src/main/java/platform/test/screenshot/DeviceEmulationRule.kt
@@ -24,6 +24,7 @@ import android.os.UserHandle
 import android.view.Display
 import android.view.WindowManagerGlobal
 import androidx.test.platform.app.InstrumentationRegistry
+import org.junit.Assume
 import org.junit.rules.TestRule
 import org.junit.runner.Description
 import org.junit.runners.model.Statement
@@ -55,9 +56,16 @@ class DeviceEmulationRule(private val spec: DeviceEmulationSpec) : TestRule {
     }
 
     override fun apply(base: Statement, description: Description): Statement {
+        val skipDarkTheme: String =
+            InstrumentationRegistry.getArguments().getString("skip-dark-theme", "unknown")
+
         // The statement which calls beforeTest() before running the test.
         return object : Statement() {
             override fun evaluate() {
+                Assume.assumeFalse(
+                    "Skipping test: ${description.displayName}, because skip-dark-theme is true.",
+                    skipDarkTheme == "true" && spec.isDarkTheme
+                )
                 beforeTest()
                 base.evaluate()
             }
diff --git a/libraries/screenshot/src/main/java/platform/test/screenshot/ResetDeviceEmulationRule.kt b/libraries/screenshot/src/main/java/platform/test/screenshot/ResetDeviceEmulationRule.kt
new file mode 100644
index 000000000..47568fdc1
--- /dev/null
+++ b/libraries/screenshot/src/main/java/platform/test/screenshot/ResetDeviceEmulationRule.kt
@@ -0,0 +1,72 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package platform.test.screenshot
+
+import android.os.UserHandle
+import android.view.Display
+import android.view.WindowManagerGlobal
+import org.junit.rules.TestRule
+import org.junit.runner.Description
+import org.junit.runners.model.Statement
+
+/**
+ * Rule to reset forced display and density, as set by the [DeviceEmulationRule].
+ *
+ * NOTE: Use this only as a `@ClassRule` to cleanup after the test class finishes, and only in
+ * scenarios where the vast majority of tests cases does not depend on the [DeviceEmulationRule]:
+ * Resetting the display settings comes at a runtime cost for tests, which is unnecessary if the
+ * next test is simply forcing setting the display setting again.
+ *
+ * ```
+ * @RunWith(AndroidJUnit4::class)
+ * class MyTest {
+ *   companion object {
+ *     @JvmField @ClassRule val cleanupRule: ResetDeviceEmulationRule = ResetDeviceEmulationRule()
+ *   }
+ *
+ *   @get:Rule val emulationRule = DeviceEmulationRule(/*...*/)
+ *
+ *   // ...
+ * }
+ * ```
+ */
+class ResetDeviceEmulationRule : TestRule {
+    override fun apply(base: Statement?, description: Description?): Statement =
+        object : Statement() {
+            override fun evaluate() {
+                try {
+                    base?.evaluate()
+                } finally {
+                    clearForcedDisplaySettings()
+
+                    // Reset the DeviceEmulationRule's in-memory cache about display setting have
+                    // been set.
+                    DeviceEmulationRule.prevDensity = -1
+                    DeviceEmulationRule.prevWidth = -1
+                    DeviceEmulationRule.prevHeight = -1
+                }
+            }
+        }
+
+    private fun clearForcedDisplaySettings() {
+        val wm =
+            WindowManagerGlobal.getWindowManagerService()
+                ?: error("Unable to acquire WindowManager")
+        wm.clearForcedDisplaySize(Display.DEFAULT_DISPLAY)
+        wm.clearForcedDisplayDensityForUser(Display.DEFAULT_DISPLAY, UserHandle.myUserId())
+    }
+}
diff --git a/libraries/screenshot/src/main/java/platform/test/screenshot/ScreenshotTestRule.kt b/libraries/screenshot/src/main/java/platform/test/screenshot/ScreenshotTestRule.kt
index e4aa2d994..15b4ab7fc 100644
--- a/libraries/screenshot/src/main/java/platform/test/screenshot/ScreenshotTestRule.kt
+++ b/libraries/screenshot/src/main/java/platform/test/screenshot/ScreenshotTestRule.kt
@@ -34,7 +34,9 @@ import org.junit.runner.Description
 import org.junit.runners.model.Statement
 import platform.test.screenshot.matchers.BitmapMatcher
 import platform.test.screenshot.matchers.MSSIMMatcher
+import platform.test.screenshot.matchers.MatchResult
 import platform.test.screenshot.matchers.PixelPerfectMatcher
+import platform.test.screenshot.parity.ParityStatsCollector
 import platform.test.screenshot.proto.ScreenshotResultProto
 import platform.test.screenshot.report.DiffResultExportStrategy
 
@@ -67,8 +69,16 @@ internal constructor(
         disableIconPool
     )
 
+    private val doesCollectScreenshotParityStats =
+        "yes".equals(
+            java.lang.System.getProperty("screenshot.collectScreenshotParityStats"),
+            ignoreCase = true)
     private lateinit var testIdentifier: String
 
+    companion object {
+        private val parityStatsCollector = ParityStatsCollector()
+    }
+
     override fun apply(base: Statement, description: Description): Statement =
         object : Statement() {
             override fun evaluate() {
@@ -190,6 +200,24 @@ internal constructor(
             )
         }
 
+        if (expected.sameAs(actual)) {
+            if (doesCollectScreenshotParityStats) {
+                val stats =
+                    ScreenshotResultProto.DiffResult.ComparisonStatistics.newBuilder()
+                        .setNumberPixelsCompared(actual.width * actual.height)
+                        .setNumberPixelsIdentical(actual.width * actual.height)
+                        .setNumberPixelsDifferent(0)
+                        .setNumberPixelsIgnored(0)
+                        .build()
+                parityStatsCollector.collectTestStats(
+                    testIdentifier,
+                    MatchResult(matches = true, diff = null, comparisonStatistics = stats))
+                parityStatsCollector.report()
+            }
+            expected.recycle()
+            return
+        }
+
         if (actual.width != expected.width || actual.height != expected.height) {
             val comparisonResult =
                 matcher.compareBitmaps(
@@ -209,6 +237,10 @@ internal constructor(
                 expected = expected,
                 diff = comparisonResult.diff
             )
+            if (doesCollectScreenshotParityStats) {
+                parityStatsCollector.collectTestStats(testIdentifier, comparisonResult)
+                parityStatsCollector.report()
+            }
 
             val expectedWidth = expected.width
             val expectedHeight = expected.height
@@ -230,6 +262,10 @@ internal constructor(
                 height = actual.height,
                 regions = regions
             )
+        if (doesCollectScreenshotParityStats) {
+            parityStatsCollector.collectTestStats(testIdentifier, comparisonResult)
+            parityStatsCollector.report()
+        }
 
         val status =
             if (comparisonResult.matches) {
diff --git a/libraries/screenshot/src/main/java/platform/test/screenshot/ViewScreenshotTestRule.kt b/libraries/screenshot/src/main/java/platform/test/screenshot/ViewScreenshotTestRule.kt
index 81655db05..3f91d09da 100644
--- a/libraries/screenshot/src/main/java/platform/test/screenshot/ViewScreenshotTestRule.kt
+++ b/libraries/screenshot/src/main/java/platform/test/screenshot/ViewScreenshotTestRule.kt
@@ -41,7 +41,7 @@ open class ViewScreenshotTestRule(
     pathManager: GoldenPathManager,
     private val matcher: BitmapMatcher = UnitTestBitmapMatcher,
     private val decorFitsSystemWindows: Boolean = false,
-    private val screenshotRule: ScreenshotTestRule = ScreenshotTestRule(pathManager)
+    protected val screenshotRule: ScreenshotTestRule = ScreenshotTestRule(pathManager)
 ) : TestRule, BitmapDiffer by screenshotRule, ScreenshotAsserterFactory by screenshotRule {
     private val colorsRule = MaterialYouColorsRule()
     private val fontsRule = FontsRule()
@@ -56,8 +56,11 @@ open class ViewScreenshotTestRule(
     // though their relative orders are not critical.
     private val deviceRule = RuleChain.outerRule(colorsRule).around(commonRule)
     private val roboRule =
-        RuleChain.outerRule(colorsRule).around(fontsRule).around(timeZoneRule)
-            .around(hardwareRenderingRule).around(commonRule)
+        RuleChain.outerRule(colorsRule)
+            .around(fontsRule)
+            .around(timeZoneRule)
+            .around(hardwareRenderingRule)
+            .around(commonRule)
     private val isRobolectric = if (Build.FINGERPRINT.contains("robolectric")) true else false
 
     var frameLimit = 10
diff --git a/libraries/screenshot/src/main/java/platform/test/screenshot/parity/ParityStatsCollector.kt b/libraries/screenshot/src/main/java/platform/test/screenshot/parity/ParityStatsCollector.kt
new file mode 100644
index 000000000..f6a2c0dd3
--- /dev/null
+++ b/libraries/screenshot/src/main/java/platform/test/screenshot/parity/ParityStatsCollector.kt
@@ -0,0 +1,84 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package platform.test.screenshot.parity
+
+import platform.test.screenshot.matchers.MatchResult
+import platform.test.screenshot.proto.ScreenshotResultProto.DiffResult.ComparisonStatistics
+
+/**
+ * A class which collects and reports statistics of screenshot test parity.
+ *
+ * The objects of this class collect screenshot test parity (in terms of percentage of different
+ * pixels between test and golden images), and report parity spectrum upon user's request.
+ *
+ * Screenshot test parity spectrum is interpreted as statements like:
+ * - X1 (Y1 percent of) test images match golden images.
+ * - X2 (Y2 percent of) test images are at least 99% the same as golden images.
+ * - X3 (Y3 percent of) test images are 95% - 99% the same as golden images.
+ * - ...
+ */
+public class ParityStatsCollector {
+    private val testStats : HashMap<String, MutableList<String>>
+        = HashMap<String, MutableList<String>>()
+
+    fun clear() {
+        testStats.clear()
+    }
+
+    fun collectTestStats(testIdentifier: String, matchResult: MatchResult) {
+        if (matchResult.matches) {
+            val tmpList = testStats.getOrDefault(EXACTLY_SAME, mutableListOf<String>())
+            tmpList.add(testIdentifier)
+            testStats[EXACTLY_SAME] = tmpList
+        } else {
+            val numDiffPixels = matchResult.comparisonStatistics.numberPixelsDifferent
+            val numPixels = matchResult.comparisonStatistics.numberPixelsCompared
+            if (numDiffPixels < numPixels * 0.01) {
+                val tmpList = testStats.getOrDefault(SAME99, mutableListOf<String>())
+                tmpList.add(testIdentifier)
+                testStats[SAME99] = tmpList
+            } else if (numDiffPixels < numPixels * 0.05) {
+                val tmpList = testStats.getOrDefault(SAME95, mutableListOf<String>())
+                tmpList.add(testIdentifier)
+                testStats[SAME95] = tmpList
+            } else if (numDiffPixels < numPixels * 0.10) {
+                val tmpList = testStats.getOrDefault(SAME90, mutableListOf<String>())
+                tmpList.add(testIdentifier)
+                testStats[SAME90] = tmpList
+            } else {
+                val tmpList = testStats.getOrDefault(PIXEL_DIFFERENT, mutableListOf<String>())
+                tmpList.add(testIdentifier)
+                testStats[PIXEL_DIFFERENT] = tmpList
+            }
+        }
+    }
+
+    fun report() {
+        testStats.forEach { entry ->
+            println("${entry.key} : ${entry.value.size} test(s).")
+        }
+        println("Tests with significant different pixel number: ${testStats[PIXEL_DIFFERENT]}")
+    }
+
+    private companion object {
+        const val EXACTLY_SAME = "exactly_same"
+        const val SAME99 = "pixel_same99"
+        const val SAME95 = "pixel_same95"
+        const val SAME90 = "pixel_same90"
+        const val PIXEL_DIFFERENT = "pixel_different"
+    }
+}
diff --git a/libraries/screenshot/update_goldens2.py b/libraries/screenshot/update_goldens2.py
new file mode 100755
index 000000000..991cf4c78
--- /dev/null
+++ b/libraries/screenshot/update_goldens2.py
@@ -0,0 +1,143 @@
+#!/usr/bin/env python3
+
+import argparse
+import os
+import shutil
+
+
+def parse_arguments():
+    """Parses command-line arguments and returns the parsed arguments object."""
+    parser = argparse.ArgumentParser(description="Validate directories and golden files.")
+    parser.add_argument("--source-directory", required=True, help="Path to the source directory.")
+    parser.add_argument("--android-build-top", required=True,
+                        help="Path to the Android build directory.")
+    return parser.parse_args()
+
+
+def validate_directories(args):
+    """Validates the provided source and Android directory arguments and returns their paths if valid."""
+    if not args.source_directory or not args.android_build_top:
+        print("Error: Both --source-directory and --android-build-top arguments are required.")
+        return None
+
+    source_dir = args.source_directory
+    android_dir = args.android_build_top
+
+    is_source_dir_valid = os.path.isdir(source_dir)
+    is_android_dir_valid = os.path.isdir(android_dir)
+
+    if not is_source_dir_valid:
+        print(f"Error: Source directory does not exist: {source_dir}")
+
+    if not is_android_dir_valid:
+        print(f"Error: Android build directory does not exist: {android_dir}")
+
+    if not is_source_dir_valid or not is_android_dir_valid:
+        return None
+
+    return [source_dir, android_dir]
+
+
+def find_golden_files(source_dir):
+    """Finds golden files within the source directory and returns their filenames or handles errors."""
+    golden_files = []
+    for root, _, files in os.walk(source_dir):
+        for file in files:
+            if "_goldResult_" in file and file.endswith(".textproto"):
+                golden_files.append(file)
+
+    if not golden_files:
+        print("Error: No golden files found in the source directory.")
+        return None
+
+    return golden_files
+
+
+def validate_protos(source_dir, proto_files):
+    """Validates proto files, extracts image locations, and handles errors."""
+    all_image_locations = []
+    for filename in proto_files:
+        required_image_locations = {"image_location_diff": False, "image_location_golden": False,
+                                    "image_location_reference": False, "image_location_test": False}
+        found_image_locations = {}
+
+        with open(os.path.join(source_dir, filename), 'r') as file:
+            for line in file:
+                for location in required_image_locations:
+                    if line.startswith(location):
+                        if required_image_locations[location]:
+                            print(f"Error: Duplicate '{location}' entry found in {filename}.")
+                            return None
+                        required_image_locations[location] = True
+                        found_image_locations[location] = line.split(": ")[1].strip().strip('"')
+                        break
+
+        if not all(required_image_locations.values()):
+            missing_keys = [key for key, found in required_image_locations.items() if not found]
+            print(f"Error: Missing image location(s) in {filename}: {', '.join(missing_keys)}")
+            return None
+        else:
+            print(f"Proto file {filename} is valid.")
+            all_image_locations.append(found_image_locations)
+    return all_image_locations
+
+
+def validate_test_images(source_dir, all_image_locations):
+    """Validates if PNG files exist in the source directory based on provided image locations."""
+    for image_locations in all_image_locations:
+        for location, path in image_locations.items():
+            if location != "image_location_golden":
+                base_name = os.path.splitext(os.path.basename(path))[0]
+                for root, _, files in os.walk(source_dir):
+                    for file in files:
+                        if file.startswith(base_name) and file.endswith(".png"):
+                            image_locations[location] = os.path.join(root, file)
+                            break
+                    else:
+                        print(f"Error: No PNG file found matching {path} in {source_dir}")
+                        return None
+        filename_without_ext = \
+        os.path.splitext(os.path.basename(image_locations["image_location_golden"]))[0]
+        print(f"Golden {filename_without_ext} is valid.")
+    return all_image_locations
+
+
+def update_goldens(android_dir, updated_image_locations_list):
+    """Copies updated 'image_location_test' images to their 'image_location_golden' paths in the android_build_top directory."""
+    for image_locations in updated_image_locations_list:
+        test_image_path = image_locations["image_location_test"]
+        golden_image_path = os.path.join(android_dir, image_locations["image_location_golden"])
+
+        try:
+            shutil.copy2(test_image_path, golden_image_path)
+            print(f"Updated golden image: {golden_image_path}")
+        except IOError as e:
+            print(f"Error updating golden image: {e}")
+
+
+def main():
+    args = parse_arguments()
+
+    directories = validate_directories(args)
+    if directories is None:
+        return
+
+    source_dir, android_dir = directories
+
+    proto_files = find_golden_files(source_dir)
+    if proto_files is None:
+        return
+
+    all_image_locations = validate_protos(source_dir, proto_files)
+    if all_image_locations is None:
+        return
+
+    updated_image_locations_list = validate_test_images(source_dir, all_image_locations)
+    if updated_image_locations_list is None:
+        return
+
+    update_goldens(android_dir, updated_image_locations_list)
+
+
+if __name__ == "__main__":
+    main()
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/FridaUtils.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/FridaUtils.java
index c0c9f993e..a904b4e95 100644
--- a/libraries/sts-common-util/host-side/src/com/android/sts/common/FridaUtils.java
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/FridaUtils.java
@@ -17,26 +17,31 @@
 package com.android.sts.common;
 
 import static com.android.sts.common.CommandUtil.runAndCheck;
-
-import static org.junit.Assert.assertEquals;
-import static org.junit.Assert.assertNotNull;
-import static org.junit.Assert.fail;
+import static com.android.sts.common.SystemUtil.poll;
+import static com.android.tradefed.util.FileUtil.createNamedTempDir;
 
 import static java.util.stream.Collectors.toList;
 
 import com.android.compatibility.common.tradefed.build.CompatibilityBuildHelper;
+import com.android.sts.common.GitHubUtils.GitHubRepo;
 import com.android.sts.common.util.FridaUtilsBusinessLogicHandler;
+import com.android.tradefed.build.BuildRetrievalError;
+import com.android.tradefed.build.FileDownloadCache;
+import com.android.tradefed.build.FileDownloadCacheFactory;
 import com.android.tradefed.build.IBuildInfo;
+import com.android.tradefed.build.IFileDownloader;
+import com.android.tradefed.config.Option;
+import com.android.tradefed.config.OptionClass;
 import com.android.tradefed.device.DeviceNotAvailableException;
 import com.android.tradefed.device.ITestDevice;
+import com.android.tradefed.invoker.TestInformation;
 import com.android.tradefed.log.LogUtil.CLog;
+import com.android.tradefed.targetprep.BaseTargetPreparer;
+import com.android.tradefed.targetprep.TargetSetupError;
 import com.android.tradefed.util.FileUtil;
 import com.android.tradefed.util.RunUtil;
 
-import com.google.gson.JsonArray;
-import com.google.gson.JsonElement;
 import com.google.gson.JsonParseException;
-import com.google.gson.JsonParser;
 
 import org.tukaani.xz.XZInputStream;
 
@@ -44,92 +49,145 @@ import java.io.ByteArrayOutputStream;
 import java.io.File;
 import java.io.FileNotFoundException;
 import java.io.IOException;
-import java.io.InputStreamReader;
+import java.net.MalformedURLException;
+import java.net.URI;
+import java.net.URISyntaxException;
 import java.net.URL;
 import java.net.URLConnection;
 import java.nio.charset.StandardCharsets;
 import java.text.MessageFormat;
 import java.util.ArrayList;
 import java.util.Arrays;
+import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
 import java.util.Optional;
 import java.util.UUID;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
 import java.util.stream.Stream;
 
 /** AutoCloseable that downloads and push frida and scripts to device and cleans up when done */
-public class FridaUtils implements AutoCloseable {
+@OptionClass(alias = "frida-preparer")
+public class FridaUtils extends BaseTargetPreparer implements AutoCloseable {
+    private static final Object LOCK_SETUP = new Object(); // Locks setUpFrida
     private static final String PRODUCT_CPU_ABI_KEY = "ro.product.cpu.abi";
     private static final String PRODUCT_CPU_ABILIST_KEY = "ro.product.cpu.abilist";
     private static final String FRIDA_PACKAGE = "frida-inject";
     private static final String FRIDA_OS = "android";
     private static final String TMP_PATH = "/data/local/tmp/";
+    private static final String FRIDA_OWNER_AND_REPO = "frida";
+    private static final String VERSION_THRESHOLD = "16.4.8";
+
+    // Default value as per fridaAssetTemplate.gcl
+    private static final String FRIDA_FILE_NAME_TEMPLATE = "{0}-{1}-{2}-{3}.xz";
+
+    private static final Map<String, FridaUtils> DEVICE_FRIDA_UTILS_MAP = new HashMap<>();
+
+    private List<String> mFridaFiles = new ArrayList<>();
+    private String mFridaAbi;
+    private ITestDevice mDevice;
+    private CompatibilityBuildHelper mBuildHelper;
+    private String mRemoteFridaExeName;
+    private String mFridaVersion =
+            "version"; // Hardcoding the Frida version to avoid confusion with version naming during
+    // manual downloads.
+    private Map<Integer, Integer> mTargetPidsToFridaPids = new HashMap<>();
+
+    @Option(name = "frida-url", description = "Custom url for frida-inject xz download.")
+    private String mCustomFridaUrl = null;
 
-    // https://docs.github.com/en/rest/releases/releases
-    private static final String FRIDA_LATEST_GITHUB_API_URL =
-            "https://api.github.com/repos/frida/frida/releases/latest";
-    private static final String FRIDA_ASSETS_GITHUB_API_URL =
-            "https://api.github.com/repos/frida/frida/releases";
-
-    private final String fridaAbi;
-    private final String fridaVersion;
-    private final ITestDevice device;
-    private final CompatibilityBuildHelper buildHelper;
-    private final String remoteFridaExeName;
-    private List<Integer> runningPids = new ArrayList<>();
-    private List<String> fridaFiles = new ArrayList<>();
-
-    private FridaUtils(ITestDevice device, IBuildInfo buildInfo)
-            throws DeviceNotAvailableException, UnsupportedOperationException, IOException {
-        this.device = device;
-        this.buildHelper = new CompatibilityBuildHelper(buildInfo);
-
-        // Figure out which version we should be using
-        Optional<String> versionOpt = FridaUtilsBusinessLogicHandler.getFridaVersion();
-        String version = versionOpt.isPresent() ? versionOpt.get() : getLatestFridaVersion();
-
-        // Figure out which Frida arch we should be using for our device
-        fridaAbi = getFridaAbiFor(device);
-        fridaVersion = version;
-        String fridaExeName =
-                String.format("%s-%s-%s-%s", FRIDA_PACKAGE, fridaVersion, FRIDA_OS, fridaAbi);
-
-        // Download Frida if needed
-        File localFridaExe;
+    @Override
+    public void setUp(TestInformation testInformation) throws TargetSetupError {
+        ITestDevice device = testInformation.getDevice();
+        String deviceSerialNum = device.getSerialNumber();
         try {
-            localFridaExe = buildHelper.getTestFile(fridaExeName);
-            CLog.d("%s found at %s", fridaExeName, localFridaExe.getAbsolutePath());
-        } catch (FileNotFoundException e) {
-            CLog.d("%s not found.", fridaExeName);
-            String fridaUrl = getFridaDownloadUrl(fridaVersion);
-            CLog.d("Downloading Frida from %s", fridaUrl);
+            if (!DEVICE_FRIDA_UTILS_MAP.containsKey(deviceSerialNum)) {
+                setUpFrida(device, testInformation.getBuildInfo());
+                DEVICE_FRIDA_UTILS_MAP.put(deviceSerialNum, this);
+            }
+        } catch (Exception e) {
+            throw new TargetSetupError(
+                    "Set up failed for device: " + deviceSerialNum,
+                    e,
+                    device.getDeviceDescriptor(),
+                    false /* deviceSide */);
+        }
+    }
+
+    private void setUpFrida(ITestDevice device, IBuildInfo buildInfo)
+            throws DeviceNotAvailableException, UnsupportedOperationException, IOException,
+                    URISyntaxException, BuildRetrievalError, TargetSetupError {
+        synchronized (LOCK_SETUP) {
+            this.mDevice = device;
+            this.mBuildHelper = new CompatibilityBuildHelper(buildInfo);
+            String fridaUrl = null;
+
+            // Figure out which version we should be using
+            Optional<String> releaseTagName = FridaUtilsBusinessLogicHandler.getFridaVersion();
+
+            // Figure out which Frida arch we should be using for our device
+            mFridaAbi = getFridaAbiFor(device);
+            String fridaExeName =
+                    String.format("%s-%s-%s-%s", FRIDA_PACKAGE, mFridaVersion, FRIDA_OS, mFridaAbi);
+
+            // Preference order for sourcing frida binary:
+            // pre-existing or manually downloaded > custom url > GitHub.
+            File localFridaExe = null;
             try {
-                URL url = new URL(fridaUrl);
-                URLConnection conn = url.openConnection();
-                XZInputStream in = new XZInputStream(conn.getInputStream());
-                File tmpOutput = FileUtil.createTempFile("STS", fridaExeName);
-                FileUtil.writeToFile(in, tmpOutput);
-                localFridaExe = new File(buildHelper.getTestsDir(), fridaExeName);
-                FileUtil.copyFile(tmpOutput, localFridaExe);
-                tmpOutput.delete();
-            } catch (Exception e2) {
-                CLog.e(
-                        "Could not download Frida. Please manually download '%s' and extract to "
-                                + "'%s', renaming the file to '%s' as necessary.",
-                        fridaUrl, buildHelper.getTestsDir(), fridaExeName);
-                throw e2;
+                // Check for an existing Frida binary.
+                localFridaExe = mBuildHelper.getTestFile(fridaExeName);
+                CLog.d("%s found at %s", fridaExeName, localFridaExe.getAbsolutePath());
+
+                // Throw if the version threshold is not met
+                pushAndCheckVersion(localFridaExe);
+            } catch (Exception e) {
+                try {
+                    CLog.d("Downloading Frida due to Exception: %s", e);
+
+                    // Fetch Frida download url from GitHub if a custom URL is not provided.
+                    fridaUrl =
+                            mCustomFridaUrl != null
+                                    ? mCustomFridaUrl
+                                    : getFridaDownloadUrl(releaseTagName);
+                    CLog.d(
+                            "Downloading Frida from %s url = %s",
+                            mCustomFridaUrl != null ? "custom" : "latest", fridaUrl);
+                    localFridaExe = new File(mBuildHelper.getTestsDir(), fridaExeName);
+                    FileDownloadCache fileDownloadCache =
+                            FileDownloadCacheFactory.getInstance()
+                                    .getCache(createNamedTempDir("frida_cache"));
+                    fileDownloadCache.fetchRemoteFile(
+                            new FridaFileDownloader(), fridaUrl, localFridaExe);
+
+                    // Throw if the version threshold is not met
+                    pushAndCheckVersion(localFridaExe);
+                } catch (Exception e2) {
+                    // In case download fails, provide instructions for manual setup.
+                    showManualSetupInstructions(e2, fridaUrl);
+                }
             }
         }
+    }
 
+    private void pushAndCheckVersion(File localFridaExe)
+            throws DeviceNotAvailableException, IOException, TargetSetupError {
         // Upload Frida binary to device
-        device.enableAdbRoot();
-        remoteFridaExeName = new File(TMP_PATH, localFridaExe.getName()).getAbsolutePath();
-        device.pushFile(localFridaExe, remoteFridaExeName);
-        runAndCheck(device, String.format("chmod a+x '%s'", remoteFridaExeName));
-        fridaFiles.add(remoteFridaExeName);
-        device.disableAdbRoot();
+        mRemoteFridaExeName = new File(TMP_PATH, localFridaExe.getName()).getAbsolutePath();
+        mDevice.pushFile(localFridaExe, mRemoteFridaExeName);
+        runAndCheck(mDevice, String.format("chmod a+x '%s'", mRemoteFridaExeName));
+        mFridaFiles.add(mRemoteFridaExeName);
+        if (!mDevice.doesFileExist(mRemoteFridaExeName.toString())) {
+            throw new TargetSetupError("Failed to push Frida into the device");
+        }
+
+        // Throw if the version threshold is not met
+        meetsVersionThreshold();
+        CLog.d(
+                "Frida is installed at %s in the device:%s",
+                mRemoteFridaExeName, mDevice.getSerialNumber());
     }
 
     /**
@@ -137,54 +195,87 @@ public class FridaUtils implements AutoCloseable {
      *
      * @param device device to use Frida on
      * @param buildInfo test device build info (from test.getBuild())
-     * @return an AutoCloseable FridaUtils object that can be used to run Frida scripts with
+     * @return FridaUtils object that can be used to run Frida scripts with
+     */
+    public static FridaUtils withFrida(ITestDevice device, IBuildInfo buildInfo) {
+        String deviceSerialNum = device.getSerialNumber();
+        if (DEVICE_FRIDA_UTILS_MAP.containsKey(deviceSerialNum)) {
+            return DEVICE_FRIDA_UTILS_MAP.get(deviceSerialNum);
+        }
+        throw new IllegalStateException(
+                "Unable to find FridaUtils object for device: " + deviceSerialNum);
+    }
+
+    /**
+     * Upload and run frida script on given process.
+     *
+     * @param fridaJsScriptContent Content of the Frida JS script. Note: this is not a file name
+     * @param targetProcessPid PID of the process to attach Frida to
+     * @return ByteArrayOutputStream containing stdout and stderr of frida command
      */
-    public static FridaUtils withFrida(ITestDevice device, IBuildInfo buildInfo)
-            throws DeviceNotAvailableException, UnsupportedOperationException, IOException {
-        return new FridaUtils(device, buildInfo);
+    public ByteArrayOutputStream withFridaScript(
+            final String fridaJsScriptContent, int targetProcessPid)
+            throws DeviceNotAvailableException, FileNotFoundException, IOException,
+                    TimeoutException, InterruptedException {
+        return withFridaScript(fridaJsScriptContent, targetProcessPid, false);
     }
 
     /**
      * Upload and run frida script on given process.
      *
      * @param fridaJsScriptContent Content of the Frida JS script. Note: this is not a file name
-     * @param pid PID of the process to attach Frida to
+     * @param targetProcessPid PID of the process to attach Frida to
+     * @param allowMultipleFridaProcess allows multiple Frida processes when true
      * @return ByteArrayOutputStream containing stdout and stderr of frida command
      */
-    public ByteArrayOutputStream withFridaScript(final String fridaJsScriptContent, int pid)
+    public ByteArrayOutputStream withFridaScript(
+            final String fridaJsScriptContent,
+            int targetProcessPid,
+            boolean allowMultipleFridaProcess)
             throws DeviceNotAvailableException, FileNotFoundException, IOException,
                     TimeoutException, InterruptedException {
+        if (!(mTargetPidsToFridaPids.isEmpty() || allowMultipleFridaProcess)) {
+            throw new RuntimeException(
+                    "Multiple Frida processes are disabled, set allowMultipleFridaProcess to"
+                            + " enable multiple frida processes");
+        }
+        if (mTargetPidsToFridaPids.containsKey(targetProcessPid)) {
+            throw new RuntimeException(
+                    "Frida is already attached to process with PID:" + targetProcessPid);
+        }
+
         // Upload Frida script to device
-        device.enableAdbRoot();
+        mDevice.enableAdbRoot();
         String uuid = UUID.randomUUID().toString();
         String remoteFridaJsScriptName =
                 new File(TMP_PATH, "frida_" + uuid + ".js").getAbsolutePath();
-        device.pushString(fridaJsScriptContent, remoteFridaJsScriptName);
-        fridaFiles.add(remoteFridaJsScriptName);
+        mDevice.pushString(fridaJsScriptContent, remoteFridaJsScriptName);
+        mFridaFiles.add(remoteFridaJsScriptName);
 
         // Execute Frida, binding to given PID, in the background
-        List<String> cmd =
-                List.of(
-                        "adb",
-                        "-s",
-                        device.getSerialNumber(),
-                        "shell",
-                        remoteFridaExeName,
-                        "-p",
-                        String.valueOf(pid),
-                        "-s",
-                        remoteFridaJsScriptName,
-                        "--runtime=v8");
-        ByteArrayOutputStream output = new ByteArrayOutputStream();
-        RunUtil.getDefault().runCmdInBackground(cmd, output);
+        ByteArrayOutputStream output =
+                runFrida(
+                        List.of(
+                                "-p",
+                                String.valueOf(targetProcessPid),
+                                "-s",
+                                remoteFridaJsScriptName,
+                                "--runtime=v8"));
 
-        // frida can fail to attach after a short pause so wait for that
+        // Frida can fail to attach after a short pause so wait for that
         TimeUnit.SECONDS.sleep(5);
         try {
-            Map<Integer, String> pids =
-                    ProcessUtil.waitProcessRunning(device, "^" + remoteFridaExeName);
-            assertEquals("Unexpected Frida processes with the same name", 1, pids.size());
-            runningPids.add(pids.keySet().iterator().next());
+            Map<Integer, String> fridaProcessPids =
+                    ProcessUtil.waitProcessRunning(
+                            mDevice, "^" + mRemoteFridaExeName + ".-p." + targetProcessPid);
+            if (fridaProcessPids.isEmpty()) {
+                throw new RuntimeException(
+                        "Frida process not found for target PID:" + targetProcessPid);
+            }
+
+            // Store target process pid and Frida process pid in mTargetPidsToFridaPids
+            mTargetPidsToFridaPids.put(
+                    targetProcessPid, fridaProcessPids.keySet().iterator().next());
         } catch (Exception e) {
             CLog.e(e);
             CLog.e("Frida attach output: %s", output.toString(StandardCharsets.UTF_8));
@@ -194,22 +285,35 @@ public class FridaUtils implements AutoCloseable {
     }
 
     @Override
-    /** Kill all running Frida processes and delete all files uploaded. */
+    /* Kill all running Frida processes. */
     public void close() throws DeviceNotAvailableException, TimeoutException {
-        device.enableAdbRoot();
-        for (Integer pid : runningPids) {
+        mDevice.enableAdbRoot();
+        for (Integer pid : mTargetPidsToFridaPids.values()) {
+            CLog.e("Killing frida pid: " + pid);
             try {
-                ProcessUtil.killPid(device, pid.intValue(), 10_000L);
+                ProcessUtil.killPid(mDevice, pid.intValue(), 10_000L);
             } catch (ProcessUtil.KillException e) {
                 if (e.getReason() != ProcessUtil.KillException.Reason.NO_SUCH_PROCESS) {
                     CLog.e(e);
                 }
             }
         }
-        for (String file : fridaFiles) {
-            device.deleteFile(file);
+        mTargetPidsToFridaPids.clear(); // Remove killed pids from mTargetPidsToFridaPids
+        mDevice.disableAdbRoot();
+    }
+
+    @Override
+    /* Delete Frida files from device and remove FridaUtils object from DEVICE_FRIDA_UTILS_MAP */
+    public void tearDown(TestInformation testInformation, Throwable e) {
+        try {
+            for (String file : mFridaFiles) {
+                testInformation.getDevice().deleteFile(file);
+            }
+            mFridaFiles.clear();
+            DEVICE_FRIDA_UTILS_MAP.remove(testInformation.getDevice().getSerialNumber());
+        } catch (Exception ignore) {
+            // Ignore exceptions while cleanup
         }
-        device.disableAdbRoot();
     }
 
     /**
@@ -234,7 +338,7 @@ public class FridaUtils implements AutoCloseable {
                 String.format("Device %s is not supported by Frida", device.getSerialNumber()));
     }
 
-    /** Return a list of supported ABIs by the device in order of preference. */
+    /* Return a list of supported ABIs by the device in order of preference. */
     private List<String> getSupportedAbis(ITestDevice device) throws DeviceNotAvailableException {
         String primaryAbi = device.getProperty(PRODUCT_CPU_ABI_KEY);
         String[] supportedAbis = device.getProperty(PRODUCT_CPU_ABILIST_KEY).split(",");
@@ -243,40 +347,149 @@ public class FridaUtils implements AutoCloseable {
                 .collect(toList());
     }
 
-    private static JsonElement getJson(String url) throws IOException, JsonParseException {
-        URLConnection conn = new URL(url).openConnection();
-        InputStreamReader reader = new InputStreamReader(conn.getInputStream());
-        return new JsonParser().parse(reader);
+    private ByteArrayOutputStream runFrida(List<String> args)
+            throws DeviceNotAvailableException, IOException {
+        mDevice.enableAdbRoot();
+        ByteArrayOutputStream output = new ByteArrayOutputStream();
+        List<String> cmd =
+                new ArrayList<>(
+                        List.of(
+                                "adb",
+                                "-s",
+                                mDevice.getSerialNumber(),
+                                "shell",
+                                mRemoteFridaExeName));
+        cmd.addAll(args);
+        RunUtil.getDefault().runCmdInBackground(cmd, output);
+        return output;
+    }
+
+    private void meetsVersionThreshold()
+            throws IOException, IllegalArgumentException, DeviceNotAvailableException,
+                    TargetSetupError {
+        // Get version from Frida binary
+        ByteArrayOutputStream output = runFrida(List.of("--version"));
+        poll(() -> output.size() > 0);
+        String version = output.toString(StandardCharsets.UTF_8).trim();
+        CLog.d("Current version is: %s", version);
+
+        // Get version threshold
+        Optional<String> minVersionFromBl = FridaUtilsBusinessLogicHandler.getFridaVersion();
+        String versionThreshold =
+                minVersionFromBl.isPresent() ? minVersionFromBl.get() : VERSION_THRESHOLD;
+
+        // Throw if threshold is not met
+        if (compareVersion(version, versionThreshold) < 0) {
+            throw new TargetSetupError(
+                    String.format(
+                            "Minimum version required is %s. Current version is %s.",
+                            versionThreshold.toString(), version.toString()));
+        }
+    }
+
+    /** Helper method to parse version parts and default missing parts to 0 */
+    private int[] parseVersion(String version) {
+        String[] parts = version.split("\\.");
+        int major = (parts.length > 0) ? Integer.parseInt(parts[0]) : 0;
+        int minor = (parts.length > 1) ? Integer.parseInt(parts[1]) : 0;
+        int patch = (parts.length > 2) ? Integer.parseInt(parts[2]) : 0;
+        return new int[] {major, minor, patch};
     }
 
-    private static String getLatestFridaVersion() throws IOException, JsonParseException {
-        return getJson(FRIDA_LATEST_GITHUB_API_URL).getAsJsonObject().get("tag_name").getAsString();
+    /** Helper method to compare versions */
+    private int compareVersion(String version, String otherVersion) {
+        // Parse the version, defaulting missing parts to 0
+        int[] versionParts = parseVersion(version);
+        int major = versionParts[0];
+        int minor = versionParts[1];
+        int patch = versionParts[2];
+
+        // Parse the other version, defaulting missing parts to 0
+        int[] otherVersionParts = parseVersion(otherVersion);
+        int otherMajor = otherVersionParts[0];
+        int otherMinor = otherVersionParts[1];
+        int otherPatch = otherVersionParts[2];
+
+        // Compare versions
+        int res = Integer.compare(major, otherMajor);
+        if (res == 0) {
+            res = Integer.compare(minor, otherMinor);
+            if (res == 0) {
+                res = Integer.compare(patch, otherPatch);
+            }
+        }
+        return res;
+    }
+
+    private void showManualSetupInstructions(Exception e, String fridaUrl)
+            throws FileNotFoundException, TargetSetupError {
+        throw new TargetSetupError(
+                String.format(
+                        "Could not download Frida. Please manually download %s and"
+                                + " extract to '%s' renaming the extracted file to '%s' exactly."
+                                + " Incorrect naming will cause a setup failure.",
+                        fridaUrl != null
+                                ? fridaUrl
+                                : String.format(
+                                        "the latest '%s-x.x.x-%s-%s.xz' from"
+                                                + " https://github.com/%4$s/%4$s/releases",
+                                        FRIDA_PACKAGE, FRIDA_OS, mFridaAbi, FRIDA_OWNER_AND_REPO),
+                        mBuildHelper.getTestsDir(),
+                        String.format(
+                                "%s-%s-%s-%s", FRIDA_PACKAGE, mFridaVersion, FRIDA_OS, mFridaAbi)),
+                e,
+                mDevice.getDeviceDescriptor(),
+                false /* deviceSide */);
     }
 
-    private String getFridaDownloadUrl(String version) throws IOException, JsonParseException {
-        assertNotNull(
-                "Did not get frida filename template from BusinessLogic",
-                FridaUtilsBusinessLogicHandler.getFridaFilenameTemplate());
+    private String getFridaDownloadUrl(Optional<String> releaseTagName)
+            throws IOException, JsonParseException, MalformedURLException, URISyntaxException {
+        String fridaFileNameTemplate = FridaUtilsBusinessLogicHandler.getFridaFilenameTemplate();
         String name =
                 MessageFormat.format(
-                        FridaUtilsBusinessLogicHandler.getFridaFilenameTemplate(),
+                        fridaFileNameTemplate != null
+                                ? fridaFileNameTemplate
+                                : FRIDA_FILE_NAME_TEMPLATE,
                         FRIDA_PACKAGE,
-                        fridaVersion,
+                        releaseTagName.isPresent() ? releaseTagName.get() : "(.*.)",
                         FRIDA_OS,
-                        fridaAbi);
+                        mFridaAbi);
 
-        JsonArray releases = getJson(FRIDA_ASSETS_GITHUB_API_URL).getAsJsonArray();
+        // Get the map of frida asset names to the download uris
+        Map<String, URI> fridaAssetNameToUri =
+                new GitHubRepo(FRIDA_OWNER_AND_REPO, FRIDA_OWNER_AND_REPO)
+                        .getReleaseAssetUris(releaseTagName);
 
-        for (JsonElement release : releases) {
-            if (release.getAsJsonObject().get("tag_name").getAsString().equals(version)) {
-                for (JsonElement asset : release.getAsJsonObject().getAsJsonArray("assets")) {
-                    if (asset.getAsJsonObject().get("name").getAsString().equals(name)) {
-                        return asset.getAsJsonObject().get("browser_download_url").getAsString();
-                    }
-                }
+        // Get the download url from 'fridaAssetNameToUri' map
+        for (Map.Entry<String, URI> entry : fridaAssetNameToUri.entrySet()) {
+            Matcher matcher = Pattern.compile(name).matcher(entry.getKey());
+            if (matcher.matches()) {
+                return entry.getValue().toString();
+            }
+        }
+        throw new RuntimeException("Could not fetch frida download url");
+    }
+
+    private static class FridaFileDownloader implements IFileDownloader {
+
+        /** {@inheritDoc} */
+        @Override
+        public File downloadFile(String remoteFilePath) throws BuildRetrievalError {
+            throw new UnsupportedOperationException();
+        }
+
+        /** {@inheritDoc} */
+        @Override
+        public void downloadFile(String relativeRemotePath, File destFile)
+                throws BuildRetrievalError {
+            try {
+                // Download Frida binary
+                URLConnection conn = new URL(relativeRemotePath).openConnection();
+                XZInputStream in = new XZInputStream(conn.getInputStream());
+                FileUtil.writeToFile(in, destFile);
+            } catch (Exception e) {
+                throw new BuildRetrievalError("Downloading frida failed.", e);
             }
         }
-        fail("Could not find frida asset '" + name + "' in '" + FRIDA_ASSETS_GITHUB_API_URL + "'");
-        return null;
     }
 }
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/LockSettingsUtil.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/LockSettingsUtil.java
new file mode 100644
index 000000000..2aa1dac8b
--- /dev/null
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/LockSettingsUtil.java
@@ -0,0 +1,214 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.sts.common;
+
+import static java.lang.String.format;
+
+import com.android.tradefed.device.DeviceNotAvailableException;
+import com.android.tradefed.device.ITestDevice;
+import com.android.tradefed.util.CommandResult;
+import com.android.tradefed.util.RunUtil;
+
+import java.util.Locale;
+
+/** Util to manage lock settings */
+public class LockSettingsUtil {
+    ITestDevice mDevice = null;
+
+    public static final String DEFAULT_LOCKSCREEN_CODE = "1234";
+    public static final long DEFAULT_TIMEOUT_MS = 10_000L;
+    public static final long DEFAULT_POLL_CYCLE_MS = 500;
+
+    /**
+     * Create an instance of LockSettingsUtil.
+     *
+     * @param device the {@link ITestDevice} test device.
+     * @throws IllegalArgumentException when {@code context} is null.
+     */
+    public LockSettingsUtil(ITestDevice device) throws IllegalArgumentException {
+        // Device should not be null
+        if (device == null) {
+            throw new IllegalArgumentException("Device should not be null");
+        }
+        mDevice = device;
+    }
+
+    /** Different options for setting the lock screen */
+    private enum LockScreenType {
+        PIN,
+        PASSWORD,
+        PATTERN,
+        SWIPE
+    }
+
+    /**
+     * Set the lock screen using a default pin and remove it upon closing.
+     *
+     * @return AutoCloseable that clears the lock upon closing
+     */
+    public AutoCloseable withLockScreen()
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        return this.withPin(DEFAULT_LOCKSCREEN_CODE);
+    }
+
+    /**
+     * Set the lockscreen using a pin and remove it upon closing.
+     *
+     * @param pin the pin that needs to be set
+     * @return AutoCloseable that clears the pin upon closing
+     */
+    public AutoCloseable withPin(String pin)
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        return this.withLockScreen(LockScreenType.PIN, pin);
+    }
+
+    /**
+     * Set the lockscreen using a pattern and remove it upon closing.
+     *
+     * @param pattern the pattern that needs to be set
+     * @return AutoCloseable that clears the pattern upon closing
+     */
+    public AutoCloseable withPattern(String pattern)
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        return this.withLockScreen(LockScreenType.PATTERN, pattern);
+    }
+
+    /**
+     * Set the lockscreen using a password and remove it upon closing.
+     *
+     * @param password the password that needs to be set
+     * @return AutoCloseable that clears the password upon closing
+     */
+    public AutoCloseable withPassword(String password)
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        return this.withLockScreen(LockScreenType.PASSWORD, password);
+    }
+
+    /**
+     * Set the swipe lockscreen and remove it upon closing.
+     *
+     * @return AutoCloseable that clears the swipe lock upon closing
+     */
+    public AutoCloseable withSwipe()
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        return this.withLockScreen(LockScreenType.SWIPE, null);
+    }
+
+    /**
+     * Set the lockscreen using either of a pin, pattern, password, or swipe and remove it upon
+     * closing.
+     *
+     * @param lockScreenType the lock screen type, it can take one of the values defined in the enum
+     *     LockScreenType.
+     * @param lockScreenCode the code[PIN or PATTERN or PASSWORD] that needs to be set
+     * @return AutoCloseable that clears the lock screen upon closing
+     * @throws IllegalArgumentException if the lock screen type is not supported or if lock screen
+     *     code is null when it's not "SWIPE".
+     * @throws IllegalStateException if device was already secure before setting the lock or if we
+     *     are unable to secure the device after attempting to set the lock.
+     * @throws InterruptedException if the polling thread is interrupted
+     */
+    private AutoCloseable withLockScreen(LockScreenType lockScreenType, String lockScreenCode)
+            throws IllegalStateException, IllegalArgumentException, InterruptedException,
+                    DeviceNotAvailableException {
+        // If the lock screen type is not "SWIPE" then the lock screen code cannot be null
+        if (lockScreenType != LockScreenType.SWIPE && lockScreenCode == null) {
+            throw new IllegalArgumentException("Lock screen code cannot be null");
+        }
+
+        // Check the keyguard status, do not proceed if it's already secure
+        CommandResult verifyResult = mDevice.executeShellV2Command("locksettings verify");
+        if (!verifyResult.getStdout().toLowerCase(Locale.getDefault()).contains("success")) {
+            throw new IllegalStateException("Keyguard is already secure");
+        }
+
+        // Enable the lock using the adb shell command corresponding to the lock type
+        switch (lockScreenType) {
+            case PIN:
+                mDevice.executeShellV2Command(format("locksettings set-pin %s", lockScreenCode));
+                break;
+            case PASSWORD:
+                mDevice.executeShellV2Command(
+                        format("locksettings set-password %s", lockScreenCode));
+                break;
+            case PATTERN:
+                mDevice.executeShellV2Command(
+                        format("locksettings set-pattern %s", lockScreenCode));
+                break;
+            case SWIPE:
+                mDevice.executeShellV2Command("locksettings set-disabled false");
+                break;
+            default:
+                throw new IllegalArgumentException(
+                        format("Non-supported Lockscreen Type: %s", lockScreenType));
+        }
+
+        // If the lock type is "SWIPE", then check if it is set successfully otherwise wait for
+        // the lock to be enabled
+        if (lockScreenType == LockScreenType.SWIPE) {
+            CommandResult commandResult =
+                    mDevice.executeShellV2Command("locksettings get-disabled");
+            String disabled = commandResult.getStdout().trim();
+            if (!disabled.equals("false")) {
+                throw new IllegalStateException("Failed to enable the swipe lockscreen");
+            }
+        } else {
+            CommandResult checkKeyguardSecure = null;
+            long endTime = System.currentTimeMillis() + DEFAULT_TIMEOUT_MS;
+            while (true) {
+                checkKeyguardSecure =
+                        mDevice.executeShellV2Command(
+                                "locksettings verify --old " + lockScreenCode);
+                if (checkKeyguardSecure
+                        .getStdout()
+                        .toLowerCase(Locale.getDefault())
+                        .contains("success")) {
+                    break;
+                }
+                if (System.currentTimeMillis() > endTime) {
+                    break;
+                }
+                RunUtil.getDefault().sleep(DEFAULT_POLL_CYCLE_MS);
+            }
+
+            if (!checkKeyguardSecure
+                    .getStdout()
+                    .toLowerCase(Locale.getDefault())
+                    .contains("success")) {
+                throw new IllegalStateException("Failed to secure the device");
+            }
+        }
+
+        return new AutoCloseable() {
+            @Override
+            public void close() throws DeviceNotAvailableException {
+                // Clear the lock screen code
+                if (lockScreenType == LockScreenType.SWIPE) {
+                    mDevice.executeShellV2Command("locksettings set-disabled true");
+                } else {
+                    mDevice.executeShellV2Command(
+                            format("locksettings clear --old %s", lockScreenCode));
+                }
+            }
+        };
+    }
+}
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/NativePoc.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/NativePoc.java
index 1acbdd00b..e13a78fca 100644
--- a/libraries/sts-common-util/host-side/src/com/android/sts/common/NativePoc.java
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/NativePoc.java
@@ -202,13 +202,9 @@ public abstract class NativePoc {
             } else {
                 newVal = "/system/lib64:/system/lib";
             }
-            Map<String, String> newMap =
-                    new HashMap<>() {
-                        {
-                            putAll(envVars());
-                            put(key, newVal);
-                        }
-                    };
+            Map<String, String> newMap = new HashMap<>();
+            newMap.putAll(envVars());
+            newMap.put(key, newVal);
             envVars(ImmutableMap.copyOf(newMap));
         }
     }
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/SystemUtil.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/SystemUtil.java
index 30651952d..70f02d072 100644
--- a/libraries/sts-common-util/host-side/src/com/android/sts/common/SystemUtil.java
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/SystemUtil.java
@@ -16,18 +16,39 @@
 
 package com.android.sts.common;
 
-import static org.hamcrest.CoreMatchers.equalTo;
-import static org.junit.Assume.assumeThat;
-import static org.junit.Assume.assumeTrue;
+import static com.android.sts.common.CommandUtil.runAndCheck;
 
 import com.android.tradefed.device.DeviceNotAvailableException;
 import com.android.tradefed.device.ITestDevice;
-import com.android.tradefed.util.CommandResult;
+import com.android.tradefed.log.LogUtil.CLog;
+import com.android.tradefed.util.RunUtil;
 
 import java.util.Optional;
+import java.util.function.BooleanSupplier;
+import java.util.function.Predicate;
 
 /** Various system-related helper functions */
 public class SystemUtil {
+    public static final long DEFAULT_MAX_POLL_TIME_MS = 30_000L;
+    public static final long DEFAULT_POLL_TIME_MS = 100L;
+
+    /** Different namespaces for settings */
+    public enum Namespace {
+        SYSTEM("system"),
+        SECURE("secure"),
+        GLOBAL("global");
+
+        private final String namespace;
+
+        private Namespace(String namespace) {
+            this.namespace = namespace;
+        }
+
+        public final String getValue() {
+            return this.namespace;
+        }
+    }
+
     private SystemUtil() {}
 
     /**
@@ -41,14 +62,17 @@ public class SystemUtil {
     public static AutoCloseable withProperty(
             final ITestDevice device, final String name, final String value)
             throws DeviceNotAvailableException {
+        // Set the property with the specified value
         final String oldValue = device.getProperty(name);
-        assumeTrue("Could not set property: " + name, device.setProperty(name, value));
-        return new AutoCloseable() {
-            @Override
-            public void close() throws Exception {
-                assumeTrue(
-                        "Could not reset property: " + name,
-                        device.setProperty(name, oldValue == null ? "" : oldValue));
+        if (!device.setProperty(name, value)) {
+            throw new IllegalStateException(String.format("Could not reset property: %s", name));
+        }
+
+        // Return AutoCloseable to reset the property back to old value
+        return () -> {
+            if (!device.setProperty(name, oldValue == null ? "" : oldValue)) {
+                throw new IllegalStateException(
+                        String.format("Could not reset property: %s", name));
             }
         };
     }
@@ -57,40 +81,125 @@ public class SystemUtil {
      * Set the value of a device setting and set it back to old value upon closing.
      *
      * @param device the device to use
-     * @param namespace "system", "secure", or "global"
+     * @param namespace the namespace from the enum Namespace [SYSTEM, SECURE, or GLOBAL]
      * @param key setting key to set
      * @param value setting value to set to
-     * @return AutoCloseable that resets the setting back to existing value upon closing.
+     * @param userId the ID of the user for whom the setting should be applied
+     * @return AutoCloseable that resets the setting back to existing value upon closing
      */
     public static AutoCloseable withSetting(
-            final ITestDevice device, final String namespace, final String key, String value)
+            final ITestDevice device,
+            final Namespace namespace,
+            final String key,
+            final String value,
+            final int userId)
             throws DeviceNotAvailableException {
-        String getSettingRes = device.getSetting(namespace, key);
-        final Optional<String> oldSetting = Optional.ofNullable(getSettingRes);
-
-        device.setSetting(namespace, key, value);
-        assumeThat(
-                String.format("Could not set %s:%s to %s", namespace, key, value),
-                device.getSetting(namespace, key),
-                equalTo(value));
-
-        return new AutoCloseable() {
-            @Override
-            public void close() throws Exception {
-                if (!oldSetting.isPresent()) {
-                    String cmd = String.format("settings delete %s %s", namespace, key);
-                    CommandResult res = CommandUtil.runAndCheck(device, cmd);
-                } else {
-                    String oldValue = oldSetting.get();
-                    device.setSetting(namespace, key, oldValue);
-                    String failMsg =
-                            String.format("could not reset '%s' back to '%s'", key, oldValue);
-                    assumeThat(failMsg, device.getSetting(namespace, key), equalTo(oldValue));
-                }
+        // Check if the user associated with the userId exists
+        if (!device.listUsers().contains(userId)) {
+            throw new IllegalArgumentException("User " + userId + " does not exist");
+        }
+
+        // Return if the required value is already set
+        final String namespaceStr = namespace.getValue();
+        final String currentAssignedValue = device.getSetting(namespaceStr, key);
+        if (currentAssignedValue.equals(value)) {
+            return () -> {};
+        }
+
+        // Set the settings field
+        final Optional<String> oldSetting = Optional.ofNullable(currentAssignedValue);
+        device.setSetting(userId, namespaceStr, key, value);
+        final Predicate<String> wasSettingSetSuccessfully =
+                (currentValue) ->
+                        poll(
+                                () -> {
+                                    try {
+                                        return device.getSetting(userId, namespaceStr, key)
+                                                .equals(currentValue);
+                                    } catch (Exception e) {
+                                        throw new IllegalStateException(e);
+                                    }
+                                });
+        if (!wasSettingSetSuccessfully.test(value)) {
+            throw new IllegalStateException(
+                    String.format(
+                            "Failed to set %s settings : %s to %s for user %d",
+                            namespaceStr, key, value, userId));
+        }
+
+        // Return an AutoCloseable to restore the settings
+        return () -> {
+            final String oldValue = oldSetting.get();
+            if (oldSetting.isEmpty()) {
+                String cmd =
+                        String.format("settings delete --user %d %s %s", userId, namespaceStr, key);
+                runAndCheck(device, cmd);
+            } else {
+                device.setSetting(userId, namespaceStr, key, oldValue);
             }
+            if (!wasSettingSetSuccessfully.test(oldValue))
+                throw new IllegalStateException(
+                        String.format(
+                                "Failed to restore the %s setting from '%s' back to '%s' for user"
+                                        + " %d",
+                                namespaceStr, key, oldValue, userId));
         };
     }
 
+    /**
+     * Set the value of a device setting and set it back to old value upon closing.
+     *
+     * @param device the device to use
+     * @param namespace the namespace from the enum Namespace [SYSTEM, SECURE, or GLOBAL]
+     * @param key setting key to set
+     * @param value setting value to set to
+     * @return AutoCloseable that resets the setting back to existing value upon closing
+     */
+    public static AutoCloseable withSetting(
+            final ITestDevice device,
+            final Namespace namespace,
+            final String key,
+            final String value)
+            throws DeviceNotAvailableException {
+        return withSetting(device, namespace, key, value, device.getCurrentUser());
+    }
+
+    /**
+     * Set the value of a device setting and set it back to old value upon closing.
+     *
+     * @param device the device to use
+     * @param namespace "system", "secure", or "global"
+     * @param key setting key to set
+     * @param value setting value to set to
+     * @return AutoCloseable that resets the setting back to existing value upon closing.
+     * @deprecated Use {@link #withSetting(ITestDevice, Namespace, String, String)} instead.
+     */
+    @Deprecated
+    public static AutoCloseable withSetting(
+            final ITestDevice device, final String namespace, final String key, final String value)
+            throws DeviceNotAvailableException {
+        // Check if the value of namespace corresponds to one of 'system', 'secure', or 'global'
+        Namespace targetNamespace = null;
+        switch (namespace) {
+            case "system":
+                targetNamespace = Namespace.SYSTEM;
+                break;
+            case "secure":
+                targetNamespace = Namespace.SECURE;
+                break;
+            case "global":
+                targetNamespace = Namespace.GLOBAL;
+                break;
+            default:
+                throw new IllegalArgumentException(
+                        String.format(
+                                "'%s' was provided. Namespace must be one of the following:"
+                                    + " 'system', 'secure', 'global'",
+                                namespace));
+        }
+        return withSetting(device, targetNamespace, key, value);
+    }
+
     /**
      * Ensures Bluetooth is enabled on the specified test device.
      *
@@ -109,7 +218,59 @@ public class SystemUtil {
         }
 
         // Enable bluetooth and disable it later
-        CommandUtil.runAndCheck(device, "svc bluetooth enable");
-        return () -> CommandUtil.runAndCheck(device, "svc bluetooth disable");
+        runAndCheck(device, "svc bluetooth enable");
+        return () -> runAndCheck(device, "svc bluetooth disable");
+    }
+
+    /**
+     * Poll on a condition supplied by the user.
+     *
+     * @param waitCondition returns true when the polling condition is met, false otherwise.
+     * @return boolean value of {@code waitCondition}.
+     * @throws IllegalArgumentException when {@code pollingTime} is not a positive integer and is
+     *     not less than {@code maxPollingTime}.
+     */
+    public static boolean poll(BooleanSupplier waitCondition) throws IllegalArgumentException {
+        return poll(waitCondition, DEFAULT_POLL_TIME_MS, DEFAULT_MAX_POLL_TIME_MS);
+    }
+
+    /**
+     * Poll on a condition supplied by the user.
+     *
+     * @param waitCondition returns true when the polling condition is met, false otherwise.
+     * @param pollingTime wait between successive calls to fetch value of {@code waitCondition} in
+     *     milliseconds
+     * @param maxPollingTime maximum waiting time before return.
+     * @return boolean value of {@code waitCondition}.
+     * @throws IllegalArgumentException when {@code pollingTime} is not a positive ineteger and is
+     *     not less than {@code maxPollingTime}.
+     */
+    public static boolean poll(BooleanSupplier waitCondition, long pollingTime, long maxPollingTime)
+            throws IllegalArgumentException {
+        // The value of pollingTime should be a positive integer
+        if (pollingTime <= 0) {
+            throw new IllegalArgumentException("pollingTime should be a positive integer");
+        }
+
+        // The value of pollingTime should be less than maxPollingTime
+        // If not, use the minimum of the two.
+        pollingTime = Math.min(pollingTime, maxPollingTime);
+        if (pollingTime == maxPollingTime) {
+            CLog.i(
+                    String.format(
+                            "Provided polling time %d is greater than the maximum limit."
+                                    + " Using %d as the polling time",
+                            pollingTime, maxPollingTime));
+        }
+
+        final long startTime = System.currentTimeMillis();
+        do {
+            if (waitCondition.getAsBoolean()) {
+                return true;
+            }
+            RunUtil.getDefault().sleep(pollingTime);
+        } while (System.currentTimeMillis() - startTime <= maxPollingTime);
+
+        return waitCondition.getAsBoolean();
     }
 }
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/UserUtils.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/UserUtils.java
index 7f8d8bc86..fc799d4df 100644
--- a/libraries/sts-common-util/host-side/src/com/android/sts/common/UserUtils.java
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/UserUtils.java
@@ -22,6 +22,7 @@ import com.android.tradefed.util.CommandStatus;
 
 import java.util.HashMap;
 import java.util.Map;
+import java.util.Optional;
 
 /** Util to manage secondary user */
 public class UserUtils {
@@ -37,8 +38,10 @@ public class UserUtils {
         private boolean mIsPreCreateOnly; // User type : --pre-created-only
         private boolean mIsRestricted; // User type : --restricted
         private boolean mSwitch; // Switch to newly created user
+        private boolean mSkipSetupWizard; // Skip setup-wizard for a newly created user
         private int mProfileOf; // Userid associated with managed user
-        private int mTestUserId;
+        private Optional<Integer>
+                mTestUserId; // Userid associated with newly created secondary user
         private Map<String, String> mUserRestrictions; // Map of user-restrictions for new user
 
         /**
@@ -71,6 +74,8 @@ public class UserUtils {
             mIsPreCreateOnly = false;
             mIsRestricted = false;
             mSwitch = false;
+            mSkipSetupWizard = false;
+            mTestUserId = Optional.empty();
         }
 
         /**
@@ -173,8 +178,18 @@ public class UserUtils {
         }
 
         /**
-         * Set user-restrictions on newly created secondary user.
-         * Note: Setting user-restrictions requires enabling root.
+         * Set if skipping the 'setup-wizard' is required while switching to newly created user
+         *
+         * @return this object for method chaining.
+         */
+        public SecondaryUser doSkipSetupWizard() {
+            mSkipSetupWizard = true;
+            return this;
+        }
+
+        /**
+         * Set user-restrictions on newly created secondary user. Note: Setting user-restrictions
+         * requires enabling root.
          *
          * @return this object for method chaining.
          */
@@ -183,6 +198,13 @@ public class UserUtils {
             return this;
         }
 
+        /**
+         * Get userId of a newly created secondary user without switching to the newly created user
+         */
+        public int getTestUserId() {
+            return mTestUserId.get();
+        }
+
         /**
          * Create a secondary user and if required, switch to it. Returns an Autocloseable that
          * removes the secondary user.
@@ -215,8 +237,9 @@ public class UserUtils {
             }
             final String outputStdout = output.getStdout();
             mTestUserId =
-                    Integer.parseInt(outputStdout.substring(outputStdout.lastIndexOf(" ")).trim());
-
+                    Optional.ofNullable(
+                            Integer.parseInt(
+                                    outputStdout.substring(outputStdout.lastIndexOf(" ")).trim()));
             AutoCloseable asSecondaryUser =
                     () -> {
                         // Switch back to the caller user if required and the user type is
@@ -227,17 +250,20 @@ public class UserUtils {
 
                         // Stop and remove the user if user type is not ephemeral
                         if (!mIsEphemeral) {
-                            mDevice.stopUser(mTestUserId);
-                            mDevice.removeUser(mTestUserId);
+                            mDevice.stopUser(mTestUserId.get());
+                            mDevice.removeUser(mTestUserId.get());
+                            mTestUserId = Optional.empty();
                         }
                     };
 
             // Start the user
-            if (!mDevice.startUser(mTestUserId, true /* waitFlag */)) {
+            if (!mDevice.startUser(mTestUserId.get(), true /* waitFlag */)) {
                 // Remove the user
+                final Exception failedToStartUserException =
+                        new IllegalStateException(
+                                String.format("Failed to start the user: %s", mTestUserId.get()));
                 asSecondaryUser.close();
-                throw new IllegalStateException(
-                        String.format("Failed to start the user: %s", mTestUserId));
+                throw failedToStartUserException;
             }
 
             // Add user-restrictions to newly created secondary user
@@ -251,7 +277,7 @@ public class UserUtils {
                             mDevice.executeShellV2Command(
                                     String.format(
                                             "pm set-user-restriction --user %d %s %s",
-                                            mTestUserId, entry.getKey(), entry.getValue()));
+                                            mTestUserId.get(), entry.getKey(), entry.getValue()));
                     if (cmdOutput.getStatus() != CommandStatus.SUCCESS) {
                         asSecondaryUser.close();
                         throw new IllegalStateException(
@@ -263,13 +289,47 @@ public class UserUtils {
                 }
             }
 
+            // Skip the 'setup wizard' if required
+            if (mSkipSetupWizard) {
+                // Check if 'user-setup' is complete
+                final String cmdOutputUserSetup =
+                        mDevice.getSetting(mTestUserId.get(), "secure", "user_setup_complete");
+                if (cmdOutputUserSetup.contains("0")) {
+                    // Skip the 'setup wizard' for the secondary user if the 'user-setup' is not
+                    // complete
+                    SystemUtil.withSetting(
+                            mDevice,
+                            SystemUtil.Namespace.SYSTEM,
+                            "setup_wizard_has_run",
+                            "1",
+                            mTestUserId.get());
+                    SystemUtil.withSetting(
+                            mDevice,
+                            SystemUtil.Namespace.SECURE,
+                            "user_setup_complete",
+                            "1",
+                            mTestUserId.get());
+                    SystemUtil.withSetting(
+                            mDevice,
+                            SystemUtil.Namespace.GLOBAL,
+                            "device_provisioned",
+                            "1",
+                            mTestUserId.get());
+                }
+            }
+
             // Switch to the user if required and the user type is neither managed nor
             // pre-created-only
-            if (mSwitch && !mIsManaged && !mIsPreCreateOnly && !mDevice.switchUser(mTestUserId)) {
+            if (mSwitch
+                    && !mIsManaged
+                    && !mIsPreCreateOnly
+                    && !mDevice.switchUser(mTestUserId.get())) {
                 // Stop and remove the user
+                final Exception failedToSwitchUserException =
+                        new IllegalStateException(
+                                String.format("Failed to switch the user: %s", mTestUserId.get()));
                 asSecondaryUser.close();
-                throw new IllegalStateException(
-                        String.format("Failed to switch the user: %s", mTestUserId));
+                throw failedToSwitchUserException;
             }
             return asSecondaryUser;
         }
diff --git a/libraries/sts-common-util/host-side/src/com/android/sts/common/ghidra/GhidraPreparer.java b/libraries/sts-common-util/host-side/src/com/android/sts/common/ghidra/GhidraPreparer.java
index 84a7be1c4..8f6603af5 100644
--- a/libraries/sts-common-util/host-side/src/com/android/sts/common/ghidra/GhidraPreparer.java
+++ b/libraries/sts-common-util/host-side/src/com/android/sts/common/ghidra/GhidraPreparer.java
@@ -31,12 +31,15 @@ import com.android.tradefed.config.Option;
 import com.android.tradefed.config.OptionClass;
 import com.android.tradefed.device.DeviceNotAvailableException;
 import com.android.tradefed.invoker.TestInformation;
+import com.android.tradefed.log.LogUtil.CLog;
 import com.android.tradefed.targetprep.BaseTargetPreparer;
 import com.android.tradefed.targetprep.BuildError;
 import com.android.tradefed.targetprep.TargetSetupError;
 import com.android.tradefed.util.net.HttpHelper;
 
 import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.net.URI;
@@ -47,6 +50,7 @@ import java.nio.file.Paths;
 import java.util.AbstractMap;
 import java.util.Map;
 import java.util.Optional;
+import java.util.Properties;
 import java.util.stream.Stream;
 import java.util.zip.ZipFile;
 
@@ -56,6 +60,11 @@ public class GhidraPreparer extends BaseTargetPreparer {
     private static final Object LOCK_SETUP = new Object(); // Locks the setup
     private static final String GHIDRA_REPO_OWNER = "NationalSecurityAgency";
     private static final String GHIDRA_REPO_NAME = "ghidra";
+    private static final String VERSION_THRESHOLD = "11.1.2";
+    private static final String DEFAULT_ZIP_NAME = "ghidra.zip";
+    private static final String BASE_INSTALLATION_DIR = "tradefed_ghidra";
+    private static final String BASE_CACHE_DIR = "ghidra_cache";
+    private static final String ANALYZE_HEADLESS = "analyzeHeadless";
     public static final String PROPERTY_KEY = "ghidra_analyze_headless";
     private File mGhidraZipDir = null; // Stores the ghidra zip directory
     private File mGhidraZipFile = null; // Stores the ghidra zip file
@@ -74,6 +83,9 @@ public class GhidraPreparer extends BaseTargetPreparer {
             description = "Overrides 'gitReleaseAssetName' of GhidraBusinessLogicHandler.")
     private String mAssetName = null;
 
+    @Option(name = "ghidra-url", description = "Custom url for Ghidra zip download.")
+    private String mCustomGhidraUri = null;
+
     /** {@inheritDoc} */
     @Override
     public void setUp(TestInformation testInformation)
@@ -81,86 +93,157 @@ public class GhidraPreparer extends BaseTargetPreparer {
         synchronized (LOCK_SETUP) {
             mGhidraZipNameFromBl = GhidraBusinessLogicHandler.getReleaseAssetName();
             String ghidraZipName =
-                    mGhidraZipNameFromBl.isPresent() ? mGhidraZipNameFromBl.get() : "ghidra.zip";
+                    mGhidraZipNameFromBl.isPresent()
+                            ? mGhidraZipNameFromBl.get()
+                            : DEFAULT_ZIP_NAME;
             ghidraZipName = (mAssetName == null) ? ghidraZipName : mAssetName;
-            try {
-                // Fetch value of property 'ghidra_analyze_headless' to restore later
-                mPreviousPropertyVal = testInformation.properties().get(PROPERTY_KEY);
-
-                // Check if Ghidra zip was manually downloaded. If not then create required
-                // directories, download ghidra and extract the zip at
-                // /tmp/tradefed_ghidra/<mGhidraZipDir>/<ghidra_zip_here>
-                if (!Paths.get("/tmp/tradefed_ghidra", ghidraZipName).toFile().exists()) {
-                    Map.Entry<String, URI> assetNameToUri = getZipNameAndUri();
-                    ghidraZipName = assetNameToUri.getKey();
-                    mGhidraZipUri = assetNameToUri.getValue();
-                    mGhidraZipDir =
-                            createNamedTempDir(
-                                    Paths.get("tradefed_ghidra", ghidraZipName).toString());
-                    mCacheDir = createNamedTempDir("ghidra_cache");
-                } else {
-                    mGhidraZipDir = Paths.get("/tmp/tradefed_ghidra", ghidraZipName).toFile();
-                }
 
-                // If 'analyzeHeadless' already exists add path to properties and return.
-                String analyzeHeadlessPath = getAnalyzeHeadlessPath();
-                if (analyzeHeadlessPath != null) {
-                    testInformation.properties().put(PROPERTY_KEY, analyzeHeadlessPath);
-                    return;
-                }
+            // Fetch value of property 'ghidra_analyze_headless' to restore later
+            mPreviousPropertyVal = testInformation.properties().get(PROPERTY_KEY);
+
+            // Set PROPERTY_KEY with the location of ANALYZE_HEADLESS
+            // Preference order for sourcing Ghidra zip:
+            // pre-existing or manually downloaded > Custom url > GitHub.
+            // After downloading, the zip is extracted at
+            // /tmp/tradefed_ghidra/<mGhidraZipDir>/<ghidra_zip_here>
+            try {
+                // Verify the existing Ghidra installation if found
+                File existingZipDir =
+                        Paths.get(String.format("/tmp/%s", BASE_INSTALLATION_DIR), ghidraZipName)
+                                .toFile();
 
-                // Download and extract ghidra zip if needed
-                lazyDownloadAndExtractGhidra();
+                // Update current installation directory
+                mGhidraZipDir = existingZipDir;
+                CLog.d(
+                        "Setting current Ghidra installation directory to %s and verifying the"
+                                + " installation",
+                        mGhidraZipDir);
 
-                // Add path of 'analyzeHeadless' to properties
-                analyzeHeadlessPath = getAnalyzeHeadlessPath();
-                if (analyzeHeadlessPath != null) {
-                    testInformation.properties().put(PROPERTY_KEY, analyzeHeadlessPath);
+                if (!existingZipDir.exists()) {
+                    throw new RuntimeException(
+                            String.format(
+                                    "Ghidra not found in %s directory hence downloading if"
+                                            + " required",
+                                    mGhidraZipDir));
                 } else {
-                    throw new TargetSetupError("Failed to fetch 'analyzeHeadless' location.");
+                    // Set PROPERTY_KEY if installation is proper
+                    verifyInstallation(testInformation);
                 }
             } catch (Exception e) {
-                // Remove the ghidra directory for the current version
-                if (mGhidraZipDir != null) {
-                    recursiveDelete(mGhidraZipDir);
-                    mGhidraZipDir = null;
-                }
+                try {
+                    CLog.d("Downloading Ghidra zip due to Exception: %s", e);
+
+                    // Create required directories for Ghidra installation
+                    // Fetch Ghidra download url from GitHub if a custom URL is not provided.
+                    if (mCustomGhidraUri != null) {
+                        mGhidraZipUri = new URI(mCustomGhidraUri);
+
+                        // Create required directories and update current installation directory
+                        createZipAndCacheDirs(ghidraZipName);
+                    } else {
+                        Map.Entry<String, URI> assetNameToUri = getZipNameAndUri();
+                        ghidraZipName = assetNameToUri.getKey();
+                        mGhidraZipUri = assetNameToUri.getValue();
+
+                        // Create required directories and update current installation directory
+                        createZipAndCacheDirs(ghidraZipName);
+                    }
+
+                    // Set PROPERTY_KEY if installation is proper
+                    verifyInstallation(testInformation);
+                } catch (Exception e2) {
+                    // Remove the ghidra directory for the current version
+                    if (mGhidraZipDir != null) {
+                        recursiveDelete(mGhidraZipDir);
+                        mGhidraZipDir = null;
+                    }
 
-                // Remove the cache directory
-                if (mCacheDir != null) {
-                    recursiveDelete(mCacheDir);
-                    mCacheDir = null;
+                    // Remove the cache directory
+                    if (mCacheDir != null) {
+                        recursiveDelete(mCacheDir);
+                        mCacheDir = null;
+                    }
+                    throw new TargetSetupError(
+                            String.format(
+                                    "Please manually download the latest version of Ghidra zip"
+                                        + " from:"
+                                        + " [https://github.com/NationalSecurityAgency/ghidra/releases]"
+                                        + " to /tmp/%s/%2$s/%2$s. Make sure to rename the zip to"
+                                        + " %2$s. Ensure /tmp/%s/%2$s/ directory does not contain"
+                                        + " any other files. \n",
+                                    BASE_INSTALLATION_DIR, ghidraZipName),
+                            e2,
+                            null /* deviceDescriptor */,
+                            false /* deviceSide */);
                 }
-                throw new TargetSetupError(
-                        String.format(
-                                "Please manually download ghidra from"
-                                    + " 'https://github.com/NationalSecurityAgency/ghidra/releases'"
-                                    + " to /tmp/tradefed_ghidra/%1$s/%1$s. Make sure to rename the"
-                                    + " zip to %1$s if required.",
-                                ghidraZipName),
-                        e,
-                        null /* deviceDescriptor */,
-                        false /* deviceSide */);
             }
         }
     }
 
-    private void lazyDownloadAndExtractGhidra() throws Exception {
+    private boolean lazyDownloadAndExtractGhidra() throws Exception {
+        boolean result = false;
         // Download Ghidra zip
         mGhidraZipFile = new File(mGhidraZipDir, mGhidraZipDir.getName());
-        if (!mGhidraZipFile.exists()) {
+        if (!mGhidraZipFile.exists() && (mGhidraZipUri != null)) {
+            CLog.d("Downloading Ghidra zip from %s to %s", mGhidraZipUri, mGhidraZipFile);
             FileDownloadCache fileDownloadCache =
                     FileDownloadCacheFactory.getInstance().getCache(mCacheDir);
             fileDownloadCache.fetchRemoteFile(
                     new GhidraFileDownloader(), mGhidraZipUri.toString(), mGhidraZipFile);
+            result = true;
+        }
+
+        if (mGhidraZipFile.exists()) {
+            // Unzip Ghidra zip and delete the zip
+            CLog.d("Unzipping %s", mGhidraZipFile);
+            extractZip(new ZipFile(mGhidraZipFile), mGhidraZipDir);
+            recursiveDelete(mGhidraZipFile);
+
+            // Chmod rwx 'mGhidraZipDir'
+            chmodRWXRecursively(mGhidraZipDir);
+            result = true;
         }
+        return result;
+    }
 
-        // Unzip Ghidra zip and delete the zip
-        extractZip(new ZipFile(mGhidraZipFile), mGhidraZipDir);
-        recursiveDelete(mGhidraZipFile);
+    /** Downloads and extracts if required. Checks for correct version. Sets PROPERTY_KEY */
+    private void verifyInstallation(TestInformation testInformation) throws Exception {
+        // Return if installation already exists
+        if (findAnalyzeHeadlessAndSetProperty(testInformation)) {
+            return;
+        }
 
-        // Chmod rwx 'mGhidraZipDir'
-        chmodRWXRecursively(mGhidraZipDir);
+        // Download and extract if required
+        if (lazyDownloadAndExtractGhidra()) {
+            // Set PROPERTY_KEY with ANALYZE_HEADLESS path if found else throws
+            if (!findAnalyzeHeadlessAndSetProperty(testInformation)) {
+                throw new TargetSetupError(
+                        String.format("Ghidra installation at %s is not proper.", mGhidraZipDir));
+            }
+        } else {
+            throw new TargetSetupError(
+                    String.format("No Ghidra zip found inside %s", mGhidraZipDir));
+        }
+    }
+
+    private boolean findAnalyzeHeadlessAndSetProperty(TestInformation testInformation)
+            throws IOException, TargetSetupError {
+        String analyzeHeadlessPath = getFilePath(String.format("/%s", ANALYZE_HEADLESS));
+        if (analyzeHeadlessPath == null) {
+            return false;
+        } else {
+            CLog.d("analyzeHeadless found at %s", analyzeHeadlessPath);
+            if (meetsVersionThreshold() < 0) {
+                CLog.d(
+                        "Ghidra installation at %s does not meet the minimum version"
+                                + " requirement of %s and higher",
+                        analyzeHeadlessPath, VERSION_THRESHOLD);
+                return false;
+            }
+        }
+        CLog.d("Setting property to %s", analyzeHeadlessPath);
+        testInformation.properties().put(PROPERTY_KEY, analyzeHeadlessPath);
+        return true;
     }
 
     @Override
@@ -195,7 +278,9 @@ public class GhidraPreparer extends BaseTargetPreparer {
             URI assetUri = mapOfAssetNameToUris.get(assetName);
             if (assetUri == null) {
                 throw new IllegalStateException(
-                        "The asset name:" + assetName + " was not found in ghidra release.");
+                        String.format(
+                                "The asset name: '%s' was not found in ghidra releases.",
+                                assetName));
             }
             return new AbstractMap.SimpleEntry(assetName, assetUri);
         }
@@ -203,27 +288,107 @@ public class GhidraPreparer extends BaseTargetPreparer {
         // Throw if more than one entry was found in the map
         if (mapOfAssetNameToUris.size() != 1) {
             throw new IllegalStateException(
-                    "More than one entries found in 'mapOfAssetNameToUris'. Entries: "
-                            + mapOfAssetNameToUris.toString());
+                    String.format(
+                            "More than one entries found in 'mapOfAssetNameToUris'. Entries: %s",
+                            mapOfAssetNameToUris.toString()));
         }
 
         // Return the first entry from the map
         return mapOfAssetNameToUris.entrySet().iterator().next();
     }
 
-    /** If found returns the path to 'analyzeHeadless' else returns null. */
-    private String getAnalyzeHeadlessPath() {
-        Optional<Path> pathToAnalyzeHeadless = Optional.empty();
+    private void createZipAndCacheDirs(String ghidraZipName) throws IOException {
+        mGhidraZipDir =
+                createNamedTempDir(Paths.get(BASE_INSTALLATION_DIR, ghidraZipName).toString());
+        CLog.d(
+                "Setting current Ghidra installation directory to %s and verifying the"
+                        + " installation",
+                mGhidraZipDir);
+
+        mCacheDir = createNamedTempDir(BASE_CACHE_DIR);
+    }
+
+    /** If found returns the path to 'fileName' else returns null. */
+    private String getFilePath(String fileName) {
+        Optional<Path> pathToFile = Optional.empty();
         try (Stream<Path> walkStream = Files.walk(mGhidraZipDir.toPath())) {
-            pathToAnalyzeHeadless =
+            pathToFile =
                     walkStream
                             .filter(path -> path.toFile().isFile())
-                            .filter(path -> path.toString().endsWith("/analyzeHeadless"))
+                            .filter(path -> path.toString().endsWith(fileName))
                             .findFirst();
         } catch (Exception e) {
             // Ignore exceptions
         }
-        return pathToAnalyzeHeadless.isPresent() ? pathToAnalyzeHeadless.get().toString() : null;
+        return pathToFile.isPresent() ? pathToFile.get().toString() : null;
+    }
+
+    /** Returns 1 if threshold is met, returns -1 if not met, returns 0 if versions match */
+    private int meetsVersionThreshold()
+            throws IOException, FileNotFoundException, TargetSetupError {
+        // Get version threshold
+        Optional<String> minGhidraVersionFromBl = GhidraBusinessLogicHandler.getMinGhidraVersion();
+        String versionThreshold =
+                minGhidraVersionFromBl.isPresent()
+                        ? minGhidraVersionFromBl.get()
+                        : VERSION_THRESHOLD;
+
+        String ghidraPropertiesPath = getFilePath("application.properties");
+        if (ghidraPropertiesPath == null) {
+            throw new TargetSetupError(
+                    String.format("application.properties not found inside %s", mGhidraZipDir));
+        }
+        Properties ghidraProperties = new Properties();
+        ghidraProperties.load(new FileInputStream(getFilePath("application.properties")));
+
+        // Get current installation version from Ghidra application properties file
+        String currentVersion = ghidraProperties.getProperty("application.version");
+
+        // Check if currentVersion is available and properly formatted
+        if (currentVersion == null || !currentVersion.matches("^\\d+(\\.\\d+)*$")) {
+            throw new TargetSetupError(
+                    String.format(
+                            "Unable to read version from %s. Current version is %s",
+                            ghidraPropertiesPath, currentVersion));
+        }
+        CLog.d(
+                "Minimum Ghidra version required: %s. The current installation's version: %s",
+                versionThreshold, currentVersion);
+        return compareVersion(currentVersion, versionThreshold);
+    }
+
+    /** Helper method to parse version parts and default missing parts to 0 */
+    private int[] parseVersion(String version) {
+        String[] parts = version.split("\\.");
+        int major = (parts.length > 0) ? Integer.parseInt(parts[0]) : 0;
+        int minor = (parts.length > 1) ? Integer.parseInt(parts[1]) : 0;
+        int patch = (parts.length > 2) ? Integer.parseInt(parts[2]) : 0;
+        return new int[] {major, minor, patch};
+    }
+
+    /** Helper method to compare versions */
+    private int compareVersion(String version, String otherVersion) {
+        // Parse the version, defaulting missing parts to 0
+        int[] versionParts = parseVersion(version);
+        int major = versionParts[0];
+        int minor = versionParts[1];
+        int patch = versionParts[2];
+
+        // Parse the other version, defaulting missing parts to 0
+        int[] otherVersionParts = parseVersion(otherVersion);
+        int otherMajor = otherVersionParts[0];
+        int otherMinor = otherVersionParts[1];
+        int otherPatch = otherVersionParts[2];
+
+        // Compare versions
+        int res = Integer.compare(major, otherMajor);
+        if (res == 0) {
+            res = Integer.compare(minor, otherMinor);
+            if (res == 0) {
+                res = Integer.compare(patch, otherPatch);
+            }
+        }
+        return res;
     }
 
     private static class GhidraFileDownloader implements IFileDownloader {
diff --git a/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/UserUtilsTest.java b/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/UserUtilsTest.java
index aa58f1022..ec1699ff3 100644
--- a/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/UserUtilsTest.java
+++ b/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/UserUtilsTest.java
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2023 The Android Open Source Project
+ * Copyright (C) 2024 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -18,9 +18,6 @@ package com.android.sts.common;
 
 import static com.google.common.truth.Truth.assertWithMessage;
 
-import static org.junit.Assert.assertFalse;
-import static org.junit.Assert.assertTrue;
-
 import com.android.tradefed.testtype.DeviceJUnit4ClassRunner;
 import com.android.tradefed.testtype.junit4.BaseHostJUnit4Test;
 
@@ -53,47 +50,91 @@ public class UserUtilsTest extends BaseHostJUnit4Test {
 
     @Test
     public void testUserUtilsNonRoot() throws Exception {
-        assertTrue(getDevice().disableAdbRoot());
+        assertWithMessage("must test with non rootable device")
+                .that(getDevice().disableAdbRoot())
+                .isTrue();
         try (AutoCloseable user =
                 new UserUtils.SecondaryUser(getDevice()).name(TEST_USER_NAME).withUser()) {
-            assertFalse(
-                    "device should not implicitly root to create a user", getDevice().isAdbRoot());
+            assertWithMessage("device should not implicitly root to create a user")
+                    .that(getDevice().isAdbRoot())
+                    .isFalse();
             assertWithMessage("did not create the test user")
                     .that(CommandUtil.runAndCheck(getDevice(), CMD_PM_LIST_USERS).getStdout())
                     .contains(TEST_USER_NAME);
         }
-        assertFalse("device should not implicitly root to cleanup", getDevice().isAdbRoot());
+        assertWithMessage("device should not implicitly root to cleanup")
+                .that(getDevice().isAdbRoot())
+                .isFalse();
     }
 
     @Test
     public void testUserUtilsRoot() throws Exception {
-        assertTrue("must test with rootable device", getDevice().enableAdbRoot());
+        assertWithMessage("must test with rootable device")
+                .that(getDevice().enableAdbRoot())
+                .isTrue();
         try (AutoCloseable user =
                 new UserUtils.SecondaryUser(getDevice()).name(TEST_USER_NAME).withUser()) {
-            assertTrue(
-                    "device should still be root after user creation if started with root",
-                    getDevice().isAdbRoot());
+            assertWithMessage(
+                            "device should still be root after user creation if started with root")
+                    .that(getDevice().isAdbRoot())
+                    .isTrue();
             assertWithMessage("did not create the test user")
                     .that(CommandUtil.runAndCheck(getDevice(), CMD_PM_LIST_USERS).getStdout())
                     .contains(TEST_USER_NAME);
         }
-        assertTrue(
-                "device should still be root after cleanup if started with root",
-                getDevice().isAdbRoot());
+        assertWithMessage("device should still be root after cleanup if started with root")
+                .that(getDevice().isAdbRoot())
+                .isTrue();
     }
 
     @Test
     public void testUserUtilsUserRestriction() throws Exception {
-        assertTrue("must test with rootable device", getDevice().enableAdbRoot());
+        assertWithMessage("must test with rootable device")
+                .that(getDevice().enableAdbRoot())
+                .isTrue();
+        try (AutoCloseable user =
+                new UserUtils.SecondaryUser(getDevice())
+                        .name(TEST_USER_NAME)
+                        .withUserRestrictions(Map.of("test_restriction", "1"))
+                        .withUser()) {
+            // Exception is thrown if any error occurs while setting user restriction above
+        }
+        assertWithMessage("device should still be root after cleanup if started with root")
+                .that(getDevice().isAdbRoot())
+                .isTrue();
+    }
+
+    @Test
+    public void testUserUtilsSkipSetupWizardNonRoot() throws Exception {
+        assertWithMessage("must test with non rootable device")
+                .that(getDevice().disableAdbRoot())
+                .isTrue();
+        try (AutoCloseable user =
+                new UserUtils.SecondaryUser(getDevice())
+                        .name(TEST_USER_NAME)
+                        .doSkipSetupWizard()
+                        .withUser()) {
+            // Exception is thrown if any error occurs while setting user restriction above
+        }
+        assertWithMessage("device should not implicitly root to cleanup")
+                .that(getDevice().isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testUserUtilsSkipSetupWizardRoot() throws Exception {
+        assertWithMessage("must test with rootable device")
+                .that(getDevice().enableAdbRoot())
+                .isTrue();
         try (AutoCloseable user =
                 new UserUtils.SecondaryUser(getDevice())
-                    .name(TEST_USER_NAME)
-                    .withUserRestrictions(Map.of("test_restriction", "1"))
-                    .withUser()) {
+                        .name(TEST_USER_NAME)
+                        .doSkipSetupWizard()
+                        .withUser()) {
             // Exception is thrown if any error occurs while setting user restriction above
         }
-        assertTrue(
-                "device should still be root after cleanup if started with root",
-                getDevice().isAdbRoot());
+        assertWithMessage("device should still be root after cleanup if started with root")
+                .that(getDevice().isAdbRoot())
+                .isTrue();
     }
 }
diff --git a/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/util/LockSettingsUtilTest.java b/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/util/LockSettingsUtilTest.java
new file mode 100644
index 000000000..7addc7ae1
--- /dev/null
+++ b/libraries/sts-common-util/host-side/tests/src/com/android/sts/common/util/LockSettingsUtilTest.java
@@ -0,0 +1,232 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.sts.common.util;
+
+import static com.android.sts.common.LockSettingsUtil.DEFAULT_LOCKSCREEN_CODE;
+
+import static com.google.common.truth.Truth.assertWithMessage;
+
+import com.android.sts.common.LockSettingsUtil;
+import com.android.tradefed.device.DeviceNotAvailableException;
+import com.android.tradefed.device.ITestDevice;
+import com.android.tradefed.testtype.DeviceJUnit4ClassRunner;
+import com.android.tradefed.testtype.junit4.BaseHostJUnit4Test;
+import com.android.tradefed.util.CommandResult;
+
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
+/** Unit tests for {@link LockSettingsUtil}. */
+@RunWith(DeviceJUnit4ClassRunner.class)
+public class LockSettingsUtilTest extends BaseHostJUnit4Test {
+    private LockSettingsUtil mLockSettingsUtil;
+    private static final String TEST_CREDENTIALS = "123456";
+    private ITestDevice mDevice;
+
+    @Before
+    public void setUp() throws Exception {
+        mDevice = getDevice();
+        mLockSettingsUtil = new LockSettingsUtil(mDevice);
+
+        // Assert that keyguard is not already secure
+        assertLockCredentialsCleared("Device already secure!");
+    }
+
+    @Test
+    public void testDefaultLockScreenNonRoot() throws Exception {
+        assertWithMessage("Must be able to unroot the device")
+                .that(mDevice.disableAdbRoot())
+                .isTrue();
+
+        testDefaultLockScreen();
+
+        assertWithMessage("Device should not implicitly root to cleanup")
+                .that(mDevice.isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testSetPinNonRoot() throws Exception {
+        assertWithMessage("Must be able to unroot the device")
+                .that(mDevice.disableAdbRoot())
+                .isTrue();
+
+        testSetPin();
+
+        assertWithMessage("Device should not implicitly root to cleanup")
+                .that(mDevice.isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testSetPasswordNonRoot() throws Exception {
+        assertWithMessage("Must be able to unroot the device")
+                .that(mDevice.disableAdbRoot())
+                .isTrue();
+
+        testSetPassword();
+
+        assertWithMessage("Device should not implicitly root to cleanup")
+                .that(mDevice.isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testSetPatternNonRoot() throws Exception {
+        assertWithMessage("Must be able to unroot the device")
+                .that(mDevice.disableAdbRoot())
+                .isTrue();
+
+        testSetPattern();
+
+        assertWithMessage("Device should not implicitly root to cleanup")
+                .that(mDevice.isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testSetSwipeNonRoot() throws Exception {
+        assertWithMessage("Must be able to unroot the device")
+                .that(mDevice.disableAdbRoot())
+                .isTrue();
+
+        testSetSwipe();
+
+        assertWithMessage("Device should not implicitly root to cleanup")
+                .that(mDevice.isAdbRoot())
+                .isFalse();
+    }
+
+    @Test
+    public void testSetDefaultLockScreenRoot() throws Exception {
+        assertWithMessage("Must test with rootable device").that(mDevice.enableAdbRoot()).isTrue();
+
+        testDefaultLockScreen();
+
+        assertWithMessage("Device should still be root after cleanup if started with root")
+                .that(mDevice.isAdbRoot())
+                .isTrue();
+    }
+
+    @Test
+    public void testSetPinRoot() throws Exception {
+        assertWithMessage("Must test with rootable device").that(mDevice.enableAdbRoot()).isTrue();
+
+        testSetPin();
+
+        assertWithMessage("Device should still be root after cleanup if started with root")
+                .that(mDevice.isAdbRoot())
+                .isTrue();
+    }
+
+    @Test
+    public void testSetPasswordRoot() throws Exception {
+        assertWithMessage("Must test with rootable device").that(mDevice.enableAdbRoot()).isTrue();
+
+        testSetPassword();
+
+        assertWithMessage("Device should still be root after cleanup if started with root")
+                .that(mDevice.isAdbRoot())
+                .isTrue();
+    }
+
+    @Test
+    public void testSetPatternRoot() throws Exception {
+        assertWithMessage("Must test with rootable device").that(mDevice.enableAdbRoot()).isTrue();
+
+        testSetPattern();
+
+        assertWithMessage("Device should still be root after cleanup if started with root")
+                .that(mDevice.isAdbRoot())
+                .isTrue();
+    }
+
+    @Test
+    public void testSetSwipeRoot() throws Exception {
+        assertWithMessage("Must test with rootable device").that(mDevice.enableAdbRoot()).isTrue();
+
+        testSetSwipe();
+
+        assertWithMessage("Device should still be root after cleanup if started with root")
+                .that(mDevice.isAdbRoot())
+                .isTrue();
+    }
+
+    private void testDefaultLockScreen() throws Exception {
+        try (AutoCloseable withLockScreen = mLockSettingsUtil.withLockScreen()) {
+            assertLockCredentialsSet(DEFAULT_LOCKSCREEN_CODE, "Did not secure the device");
+        }
+        assertLockCredentialsCleared("Did not clear the lock after use");
+    }
+
+    private void testSetPin() throws Exception {
+        try (AutoCloseable withLockScreen = mLockSettingsUtil.withPin(TEST_CREDENTIALS)) {
+            assertLockCredentialsSet(TEST_CREDENTIALS, "Did not secure the device with a pin");
+        }
+        assertLockCredentialsCleared("Did not clear the pin after use");
+    }
+
+    private void testSetPassword() throws Exception {
+        try (AutoCloseable withLockScreen = mLockSettingsUtil.withPassword(TEST_CREDENTIALS)) {
+            assertLockCredentialsSet(TEST_CREDENTIALS, "Did not secure the device with a password");
+        }
+        assertLockCredentialsCleared("Did not clear the password after use");
+    }
+
+    private void testSetPattern() throws Exception {
+        try (AutoCloseable withLockScreen = mLockSettingsUtil.withPattern(TEST_CREDENTIALS)) {
+            assertLockCredentialsSet(TEST_CREDENTIALS, "Did not secure the device with a pattern");
+        }
+        assertLockCredentialsCleared("Did not clear the pattern after use");
+    }
+
+    private void testSetSwipe() throws Exception {
+        try (AutoCloseable withLockScreen = mLockSettingsUtil.withSwipe()) {
+            assertKeyguardDisabledStatus("false", "Did not set the swipe lockscreen");
+        }
+        assertKeyguardDisabledStatus("true", "Did not clear the swipe lockscreen after use");
+    }
+
+    private void assertLockCredentialsSet(String credentials, String failMessage)
+            throws DeviceNotAvailableException {
+        CommandResult verifyResult =
+                mDevice.executeShellV2Command("locksettings verify --old " + credentials);
+        assertWithMessage(failMessage)
+                .that(verifyResult.getStdout())
+                .ignoringCase()
+                .contains("success");
+    }
+
+    private void assertLockCredentialsCleared(String failMessage)
+            throws DeviceNotAvailableException {
+        CommandResult verifyResult = mDevice.executeShellV2Command("locksettings verify");
+        assertWithMessage(failMessage)
+                .that(verifyResult.getStdout())
+                .ignoringCase()
+                .contains("success");
+    }
+
+    private void assertKeyguardDisabledStatus(String expectedState, String failMessage)
+            throws DeviceNotAvailableException {
+        CommandResult lockDisabledState =
+                mDevice.executeShellV2Command("locksettings get-disabled");
+        assertWithMessage(failMessage)
+                .that(expectedState)
+                .isEqualTo(lockDisabledState.getStdout().trim());
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/example/.gitignore b/libraries/sts-common-util/sts-sdk/example/.gitignore
new file mode 100644
index 000000000..1ffc05ae6
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/.gitignore
@@ -0,0 +1,14 @@
+# Ignore Gradle project-specific cache directory
+.gradle
+
+# Ignore Gradle build output directory
+build
+
+# Ignore Gradle local properties
+local.properties
+
+# Ignore Idea workspace files
+.idea
+
+# ignore cmake builds
+*.cxx
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_arm.xml b/libraries/sts-common-util/sts-sdk/example/.run/assembleStsSdkSubmissionZip.run.xml
similarity index 69%
rename from libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_arm.xml
rename to libraries/sts-common-util/sts-sdk/example/.run/assembleStsSdkSubmissionZip.run.xml
index c79a3b0b9..7885f4a9e 100644
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_arm.xml
+++ b/libraries/sts-common-util/sts-sdk/example/.run/assembleStsSdkSubmissionZip.run.xml
@@ -1,8 +1,8 @@
 <component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="assembleStsArm" type="GradleRunConfiguration" factoryName="Gradle">
+  <configuration default="false" name="assembleStsSdkSubmissionZip" type="GradleRunConfiguration" factoryName="Gradle">
     <ExternalSystemSettings>
       <option name="executionName" />
-      <option name="externalProjectPath" value="$PROJECT_DIR$" />
+      <option name="externalProjectPath" value="$PROJECT_DIR$/submission" />
       <option name="externalSystemIdString" value="GRADLE" />
       <option name="scriptParameters" value="" />
       <option name="taskDescriptions">
@@ -10,7 +10,7 @@
       </option>
       <option name="taskNames">
         <list>
-          <option value="assembleStsARM" />
+          <option value="assembleStsSdkSubmissionZip" />
         </list>
       </option>
       <option name="vmOptions" />
@@ -18,6 +18,7 @@
     <ExternalSystemDebugServerProcess>true</ExternalSystemDebugServerProcess>
     <ExternalSystemReattachDebugProcess>true</ExternalSystemReattachDebugProcess>
     <DebugAllEnabled>false</DebugAllEnabled>
+    <RunAsTest>false</RunAsTest>
     <method v="2" />
   </configuration>
-</component>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_x86.xml b/libraries/sts-common-util/sts-sdk/example/.run/assembleSubmissionSources.run.xml
similarity index 69%
rename from libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_x86.xml
rename to libraries/sts-common-util/sts-sdk/example/.run/assembleSubmissionSources.run.xml
index 790e4276b..471d1af37 100644
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/assemble_STS_x86.xml
+++ b/libraries/sts-common-util/sts-sdk/example/.run/assembleSubmissionSources.run.xml
@@ -1,8 +1,8 @@
 <component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="assembleStsx86" type="GradleRunConfiguration" factoryName="Gradle">
+  <configuration default="false" name="assembleSubmissionSources" type="GradleRunConfiguration" factoryName="Gradle">
     <ExternalSystemSettings>
       <option name="executionName" />
-      <option name="externalProjectPath" value="$PROJECT_DIR$" />
+      <option name="externalProjectPath" value="$PROJECT_DIR$/submission" />
       <option name="externalSystemIdString" value="GRADLE" />
       <option name="scriptParameters" value="" />
       <option name="taskDescriptions">
@@ -10,7 +10,7 @@
       </option>
       <option name="taskNames">
         <list>
-          <option value="assembleStsx86" />
+          <option value="assembStsSdkSubmissionSources" />
         </list>
       </option>
       <option name="vmOptions" />
@@ -18,6 +18,7 @@
     <ExternalSystemDebugServerProcess>true</ExternalSystemDebugServerProcess>
     <ExternalSystemReattachDebugProcess>true</ExternalSystemReattachDebugProcess>
     <DebugAllEnabled>false</DebugAllEnabled>
+    <RunAsTest>false</RunAsTest>
     <method v="2" />
   </configuration>
-</component>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/clean.xml b/libraries/sts-common-util/sts-sdk/example/.run/copyInvocationResultsToSubmission.run.xml
similarity index 68%
rename from libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/clean.xml
rename to libraries/sts-common-util/sts-sdk/example/.run/copyInvocationResultsToSubmission.run.xml
index 9480f9523..45ee95cfd 100644
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/clean.xml
+++ b/libraries/sts-common-util/sts-sdk/example/.run/copyInvocationResultsToSubmission.run.xml
@@ -1,8 +1,8 @@
 <component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="clean" type="GradleRunConfiguration" factoryName="Gradle">
+  <configuration default="false" name="copyInvocationResultsToSubmission" type="GradleRunConfiguration" factoryName="Gradle">
     <ExternalSystemSettings>
       <option name="executionName" />
-      <option name="externalProjectPath" value="$PROJECT_DIR$" />
+      <option name="externalProjectPath" value="$PROJECT_DIR$/submission" />
       <option name="externalSystemIdString" value="GRADLE" />
       <option name="scriptParameters" value="" />
       <option name="taskDescriptions">
@@ -10,7 +10,7 @@
       </option>
       <option name="taskNames">
         <list>
-          <option value="clean" />
+          <option value="copyInvocationResultsToSubmission" />
         </list>
       </option>
       <option name="vmOptions" />
@@ -18,6 +18,7 @@
     <ExternalSystemDebugServerProcess>true</ExternalSystemDebugServerProcess>
     <ExternalSystemReattachDebugProcess>true</ExternalSystemReattachDebugProcess>
     <DebugAllEnabled>false</DebugAllEnabled>
+    <RunAsTest>false</RunAsTest>
     <method v="2" />
   </configuration>
-</component>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_arm64.run.xml b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_arm64.run.xml
new file mode 100644
index 000000000..201d016c7
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_arm64.run.xml
@@ -0,0 +1,19 @@
+<component name="ProjectRunConfigurationManager">
+  <configuration default="false" name="sts-tradefed_linux_nonroot_arm64" type="ShConfigurationType">
+    <option name="SCRIPT_TEXT" value="" />
+    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
+    <option name="SCRIPT_PATH" value="$PROJECT_DIR$/submission/build/test_suites_arm64/android-sts/tools/sts-tradefed" />
+    <option name="SCRIPT_OPTIONS" value="run commandAndExit sts-sdk-nonroot --log-level debug --log-level-display debug" />
+    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
+    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+    <option name="INDEPENDENT_INTERPRETER_PATH" value="true" />
+    <option name="INTERPRETER_PATH" value="/bin/bash" />
+    <option name="INTERPRETER_OPTIONS" value="" />
+    <option name="EXECUTE_IN_TERMINAL" value="true" />
+    <option name="EXECUTE_SCRIPT_FILE" value="true" />
+    <envs />
+    <method v="2">
+      <option name="Gradle.BeforeRunTask" enabled="false" tasks="assembleStsSdkTradefed-test_suites_arm64" externalProjectPath="$PROJECT_DIR$/submission" vmOptions="" scriptParameters="" />
+    </method>
+  </configuration>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_x86_64.run.xml b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_x86_64.run.xml
new file mode 100644
index 000000000..ba3116654
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_nonroot_x86_64.run.xml
@@ -0,0 +1,19 @@
+<component name="ProjectRunConfigurationManager">
+  <configuration default="false" name="sts-tradefed_linux_nonroot_x86_64" type="ShConfigurationType">
+    <option name="SCRIPT_TEXT" value="" />
+    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
+    <option name="SCRIPT_PATH" value="$PROJECT_DIR$/submission/build/test_suites_x86_64/android-sts/tools/sts-tradefed" />
+    <option name="SCRIPT_OPTIONS" value="run commandAndExit sts-sdk-nonroot --log-level debug --log-level-display debug" />
+    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
+    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+    <option name="INDEPENDENT_INTERPRETER_PATH" value="true" />
+    <option name="INTERPRETER_PATH" value="/bin/bash" />
+    <option name="INTERPRETER_OPTIONS" value="" />
+    <option name="EXECUTE_IN_TERMINAL" value="true" />
+    <option name="EXECUTE_SCRIPT_FILE" value="true" />
+    <envs />
+    <method v="2">
+      <option name="Gradle.BeforeRunTask" enabled="false" tasks="assembleStsSdkTradefed-test_suites_x86_64" externalProjectPath="$PROJECT_DIR$/submission" vmOptions="" scriptParameters="" />
+    </method>
+  </configuration>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_arm64.run.xml b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_arm64.run.xml
new file mode 100644
index 000000000..3b7e6422c
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_arm64.run.xml
@@ -0,0 +1,19 @@
+<component name="ProjectRunConfigurationManager">
+  <configuration default="false" name="sts-tradefed_linux_root_arm64" type="ShConfigurationType">
+    <option name="SCRIPT_TEXT" value="" />
+    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
+    <option name="SCRIPT_PATH" value="$PROJECT_DIR$/submission/build/test_suites_arm64/android-sts/tools/sts-tradefed" />
+    <option name="SCRIPT_OPTIONS" value="run commandAndExit sts-sdk-root --log-level debug --log-level-display debug" />
+    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
+    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+    <option name="INDEPENDENT_INTERPRETER_PATH" value="true" />
+    <option name="INTERPRETER_PATH" value="/bin/bash" />
+    <option name="INTERPRETER_OPTIONS" value="" />
+    <option name="EXECUTE_IN_TERMINAL" value="true" />
+    <option name="EXECUTE_SCRIPT_FILE" value="true" />
+    <envs />
+    <method v="2">
+      <option name="Gradle.BeforeRunTask" enabled="true" tasks="assembleStsSdkTradefed-test_suites_arm64" externalProjectPath="$PROJECT_DIR$/submission" vmOptions="" scriptParameters="" />
+    </method>
+  </configuration>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_x86_64.run.xml b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_x86_64.run.xml
new file mode 100644
index 000000000..9c2a0cdc6
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/.run/sts-tradefed_linux_root_x86_64.run.xml
@@ -0,0 +1,19 @@
+<component name="ProjectRunConfigurationManager">
+  <configuration default="false" name="sts-tradefed_linux_root_x86_64" type="ShConfigurationType">
+    <option name="SCRIPT_TEXT" value="" />
+    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
+    <option name="SCRIPT_PATH" value="$PROJECT_DIR$/submission/build/test_suites_x86_64/android-sts/tools/sts-tradefed" />
+    <option name="SCRIPT_OPTIONS" value="run commandAndExit sts-sdk-root --log-level debug --log-level-display debug" />
+    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
+    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+    <option name="INDEPENDENT_INTERPRETER_PATH" value="true" />
+    <option name="INTERPRETER_PATH" value="/bin/bash" />
+    <option name="INTERPRETER_OPTIONS" value="" />
+    <option name="EXECUTE_IN_TERMINAL" value="true" />
+    <option name="EXECUTE_SCRIPT_FILE" value="true" />
+    <envs />
+    <method v="2">
+      <option name="Gradle.BeforeRunTask" enabled="true" tasks="assembleStsSdkTradefed-test_suites_x86_64" externalProjectPath="$PROJECT_DIR$/submission" vmOptions="" scriptParameters="" />
+    </method>
+  </configuration>
+</component>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/package/gradle.properties b/libraries/sts-common-util/sts-sdk/example/gradle.properties
similarity index 51%
rename from libraries/sts-common-util/sts-sdk/package/gradle.properties
rename to libraries/sts-common-util/sts-sdk/example/gradle.properties
index 0b3615460..cc18a0cd2 100644
--- a/libraries/sts-common-util/sts-sdk/package/gradle.properties
+++ b/libraries/sts-common-util/sts-sdk/example/gradle.properties
@@ -1,4 +1,3 @@
 org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
 android.useAndroidX=true
-android.nonTransitiveRClass=true
-gradle=build -x lint -x lintVitalRelease
\ No newline at end of file
+android.enableJetifier=true
diff --git a/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.jar b/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.jar
new file mode 100644
index 000000000..033e24c4c
Binary files /dev/null and b/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.jar differ
diff --git a/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.properties b/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.properties
new file mode 100644
index 000000000..bb5a3af3a
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/gradle/wrapper/gradle-wrapper.properties
@@ -0,0 +1,8 @@
+#Wed Aug 07 16:22:12 UTC 2024
+distributionBase=GRADLE_USER_HOME
+distributionPath=wrapper/dists
+distributionUrl=https\://services.gradle.org/distributions/gradle-8.8-bin.zip
+networkTimeout=10000
+validateDistributionUrl=true
+zipStoreBase=GRADLE_USER_HOME
+zipStorePath=wrapper/dists
diff --git a/libraries/sts-common-util/sts-sdk/example/gradlew b/libraries/sts-common-util/sts-sdk/example/gradlew
new file mode 100755
index 000000000..fcb6fca14
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/gradlew
@@ -0,0 +1,248 @@
+#!/bin/sh
+
+#
+# Copyright  2015-2021 the original authors.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      https://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+##############################################################################
+#
+#   Gradle start up script for POSIX generated by Gradle.
+#
+#   Important for running:
+#
+#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
+#       noncompliant, but you have some other compliant shell such as ksh or
+#       bash, then to run this script, type that shell name before the whole
+#       command line, like:
+#
+#           ksh Gradle
+#
+#       Busybox and similar reduced shells will NOT work, because this script
+#       requires all of these POSIX shell features:
+#         * functions;
+#         * expansions $var, ${var}, ${var:-default}, ${var+SET},
+#           ${var#prefix}, ${var%suffix}, and $( cmd );
+#         * compound commands having a testable exit status, especially case;
+#         * various built-in commands including command, set, and ulimit.
+#
+#   Important for patching:
+#
+#   (2) This script targets any POSIX shell, so it avoids extensions provided
+#       by Bash, Ksh, etc; in particular arrays are avoided.
+#
+#       The "traditional" practice of packing multiple parameters into a
+#       space-separated string is a well documented source of bugs and security
+#       problems, so this is (mostly) avoided, by progressively accumulating
+#       options in "$@", and eventually passing that to Java.
+#
+#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
+#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
+#       see the in-line comments for details.
+#
+#       There are tweaks for specific operating systems such as AIX, CygWin,
+#       Darwin, MinGW, and NonStop.
+#
+#   (3) This script is generated from the Groovy template
+#       https://github.com/gradle/gradle/blob/HEAD/subprojects/plugins/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
+#       within the Gradle project.
+#
+#       You can find Gradle at https://github.com/gradle/gradle/.
+#
+##############################################################################
+
+# Attempt to set APP_HOME
+
+# Resolve links: $0 may be a link
+app_path=$0
+
+# Need this for daisy-chained symlinks.
+while
+    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
+    [ -h "$app_path" ]
+do
+    ls=$( ls -ld "$app_path" )
+    link=${ls#*' -> '}
+    case $link in             #(
+      /*)   app_path=$link ;; #(
+      *)    app_path=$APP_HOME$link ;;
+    esac
+done
+
+# This is normally unused
+# shellcheck disable=SC2034
+APP_BASE_NAME=${0##*/}
+APP_HOME=$( cd "${APP_HOME:-./}" && pwd -P ) || exit
+
+# Use the maximum available, or set MAX_FD != -1 to use that value.
+MAX_FD=maximum
+
+warn () {
+    echo "$*"
+} >&2
+
+die () {
+    echo
+    echo "$*"
+    echo
+    exit 1
+} >&2
+
+# OS specific support (must be 'true' or 'false').
+cygwin=false
+msys=false
+darwin=false
+nonstop=false
+case "$( uname )" in                #(
+  CYGWIN* )         cygwin=true  ;; #(
+  Darwin* )         darwin=true  ;; #(
+  MSYS* | MINGW* )  msys=true    ;; #(
+  NONSTOP* )        nonstop=true ;;
+esac
+
+CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
+
+
+# Determine the Java command to use to start the JVM.
+if [ -n "$JAVA_HOME" ] ; then
+    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
+        # IBM's JDK on AIX uses strange locations for the executables
+        JAVACMD=$JAVA_HOME/jre/sh/java
+    else
+        JAVACMD=$JAVA_HOME/bin/java
+    fi
+    if [ ! -x "$JAVACMD" ] ; then
+        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
+
+Please set the JAVA_HOME variable in your environment to match the
+location of your Java installation."
+    fi
+else
+    JAVACMD=java
+    if ! command -v java >/dev/null 2>&1
+    then
+        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
+
+Please set the JAVA_HOME variable in your environment to match the
+location of your Java installation."
+    fi
+fi
+
+# Increase the maximum file descriptors if we can.
+if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
+    case $MAX_FD in #(
+      max*)
+        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
+        # shellcheck disable=SC3045
+        MAX_FD=$( ulimit -H -n ) ||
+            warn "Could not query maximum file descriptor limit"
+    esac
+    case $MAX_FD in  #(
+      '' | soft) :;; #(
+      *)
+        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
+        # shellcheck disable=SC3045
+        ulimit -n "$MAX_FD" ||
+            warn "Could not set maximum file descriptor limit to $MAX_FD"
+    esac
+fi
+
+# Collect all arguments for the java command, stacking in reverse order:
+#   * args from the command line
+#   * the main class name
+#   * -classpath
+#   * -D...appname settings
+#   * --module-path (only if needed)
+#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.
+
+# For Cygwin or MSYS, switch paths to Windows format before running java
+if "$cygwin" || "$msys" ; then
+    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
+    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )
+
+    JAVACMD=$( cygpath --unix "$JAVACMD" )
+
+    # Now convert the arguments - kludge to limit ourselves to /bin/sh
+    for arg do
+        if
+            case $arg in                                #(
+              -*)   false ;;                            # don't mess with options #(
+              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
+                    [ -e "$t" ] ;;                      #(
+              *)    false ;;
+            esac
+        then
+            arg=$( cygpath --path --ignore --mixed "$arg" )
+        fi
+        # Roll the args list around exactly as many times as the number of
+        # args, so each arg winds up back in the position where it started, but
+        # possibly modified.
+        #
+        # NB: a `for` loop captures its iteration list before it begins, so
+        # changing the positional parameters here affects neither the number of
+        # iterations, nor the values presented in `arg`.
+        shift                   # remove old arg
+        set -- "$@" "$arg"      # push replacement arg
+    done
+fi
+
+
+# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
+DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
+
+# Collect all arguments for the java command;
+#   * $DEFAULT_JVM_OPTS, $JAVA_OPTS, and $GRADLE_OPTS can contain fragments of
+#     shell script including quotes and variable substitutions, so put them in
+#     double quotes to make sure that they get re-expanded; and
+#   * put everything else in single quotes, so that it's not re-expanded.
+
+set -- \
+        "-Dorg.gradle.appname=$APP_BASE_NAME" \
+        -classpath "$CLASSPATH" \
+        org.gradle.wrapper.GradleWrapperMain \
+        "$@"
+
+# Stop when "xargs" is not available.
+if ! command -v xargs >/dev/null 2>&1
+then
+    die "xargs is not available"
+fi
+
+# Use "xargs" to parse quoted args.
+#
+# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
+#
+# In Bash we could simply go:
+#
+#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
+#   set -- "${ARGS[@]}" "$@"
+#
+# but POSIX shell has neither arrays nor command substitution, so instead we
+# post-process each arg (as a line of input to sed) to backslash-escape any
+# character that might be a shell metacharacter, then use eval to reverse
+# that process (while maintaining the separation between arguments), and wrap
+# the whole thing up as a single "set" statement.
+#
+# This will of course break if any of these variables contains a newline or
+# an unmatched quote.
+#
+
+eval "set -- $(
+        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
+        xargs -n1 |
+        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
+        tr '\n' ' '
+    )" '"$@"'
+
+exec "$JAVACMD" "$@"
diff --git a/libraries/sts-common-util/sts-sdk/example/gradlew.bat b/libraries/sts-common-util/sts-sdk/example/gradlew.bat
new file mode 100644
index 000000000..6689b85be
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/gradlew.bat
@@ -0,0 +1,92 @@
+@rem
+@rem Copyright 2015 the original author or authors.
+@rem
+@rem Licensed under the Apache License, Version 2.0 (the "License");
+@rem you may not use this file except in compliance with the License.
+@rem You may obtain a copy of the License at
+@rem
+@rem      https://www.apache.org/licenses/LICENSE-2.0
+@rem
+@rem Unless required by applicable law or agreed to in writing, software
+@rem distributed under the License is distributed on an "AS IS" BASIS,
+@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+@rem See the License for the specific language governing permissions and
+@rem limitations under the License.
+@rem
+
+@if "%DEBUG%"=="" @echo off
+@rem ##########################################################################
+@rem
+@rem  Gradle startup script for Windows
+@rem
+@rem ##########################################################################
+
+@rem Set local scope for the variables with windows NT shell
+if "%OS%"=="Windows_NT" setlocal
+
+set DIRNAME=%~dp0
+if "%DIRNAME%"=="" set DIRNAME=.
+@rem This is normally unused
+set APP_BASE_NAME=%~n0
+set APP_HOME=%DIRNAME%
+
+@rem Resolve any "." and ".." in APP_HOME to make it shorter.
+for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi
+
+@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
+set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"
+
+@rem Find java.exe
+if defined JAVA_HOME goto findJavaFromJavaHome
+
+set JAVA_EXE=java.exe
+%JAVA_EXE% -version >NUL 2>&1
+if %ERRORLEVEL% equ 0 goto execute
+
+echo.
+echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
+echo.
+echo Please set the JAVA_HOME variable in your environment to match the
+echo location of your Java installation.
+
+goto fail
+
+:findJavaFromJavaHome
+set JAVA_HOME=%JAVA_HOME:"=%
+set JAVA_EXE=%JAVA_HOME%/bin/java.exe
+
+if exist "%JAVA_EXE%" goto execute
+
+echo.
+echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
+echo.
+echo Please set the JAVA_HOME variable in your environment to match the
+echo location of your Java installation.
+
+goto fail
+
+:execute
+@rem Setup the command line
+
+set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
+
+
+@rem Execute Gradle
+"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*
+
+:end
+@rem End local scope for the variables with windows NT shell
+if %ERRORLEVEL% equ 0 goto mainEnd
+
+:fail
+rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
+rem the _cmd.exe /c_ return code!
+set EXIT_CODE=%ERRORLEVEL%
+if %EXIT_CODE% equ 0 set EXIT_CODE=1
+if not ""=="%GRADLE_EXIT_CONSOLE%" exit %EXIT_CODE%
+exit /b %EXIT_CODE%
+
+:mainEnd
+if "%OS%"=="Windows_NT" endlocal
+
+:omega
diff --git a/libraries/sts-common-util/sts-sdk/example/settings.gradle.kts b/libraries/sts-common-util/sts-sdk/example/settings.gradle.kts
new file mode 100644
index 000000000..4afcbcdc4
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/settings.gradle.kts
@@ -0,0 +1,57 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+// repositories of plugins
+pluginManagement {
+    repositories {
+        mavenLocal()
+        gradlePluginPortal()
+        google()
+        mavenCentral()
+    }
+}
+
+// repositories of project dependencies
+dependencyResolutionManagement {
+    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
+    repositories {
+        google()
+        mavenCentral()
+    }
+}
+
+plugins {
+    // Apply the foojay-resolver plugin to allow automatic download of JDKs
+    id("org.gradle.toolchains.foojay-resolver-convention") version "0.4.0"
+    id("com.android.sts.sdksubmission") version "1.0.0" apply false
+    id("com.android.sts.apptest") version "1.0.0" apply false
+    id("com.android.sts.javahosttest") version "1.0.0" apply false
+}
+
+rootProject.name = "sts-sdk-example"
+
+// glob and include gradle projects
+fileTree(rootDir) {
+        // only include subprojects of ":submission"
+        include("submission/**/build.gradle*")
+        // don't include subprojects from build directories
+        exclude("**/build")
+    }
+    .forEach {
+        val path = rootDir.toPath().relativize(it.toPath().getParent())
+        val gradlePath = path.toString().replace('/', ':')
+        include(gradlePath)
+    }
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/appTest/build.gradle.kts b/libraries/sts-common-util/sts-sdk/example/submission/appTest/build.gradle.kts
new file mode 100644
index 000000000..042f0e9ad
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest/build.gradle.kts
@@ -0,0 +1,19 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+plugins { id("com.android.sts.apptest") }
+
+// Note: the Gradle package name is appended to the namespace "android.security.sts"
+appTest {}
diff --git a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/AndroidManifest.xml b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/AndroidManifest.xml
similarity index 86%
rename from libraries/sts-common-util/sts-sdk/package/test-app/src/main/AndroidManifest.xml
rename to libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/AndroidManifest.xml
index a16eccb9d..13807eaea 100644
--- a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/AndroidManifest.xml
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/AndroidManifest.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
-  Copyright 2022 The Android Open Source Project
+  Copyright 2024 The Android Open Source Project
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
@@ -16,12 +16,11 @@
   -->
 
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
-    package="android.security.sts.sts_test_app_package"
     android:versionCode="1"
     android:versionName="1.0">
     <instrumentation
         android:name="androidx.test.runner.AndroidJUnitRunner"
-        android:targetPackage="android.security.sts.sts_test_app_package" />
+        android:targetPackage="${applicationId}" />
     <application
         android:supportsRtl="true">
         <activity
diff --git a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/DeviceTest.java b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/DeviceTest.java
similarity index 93%
rename from libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/DeviceTest.java
rename to libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/DeviceTest.java
index a218e81f6..6993204da 100644
--- a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/DeviceTest.java
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/DeviceTest.java
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package android.security.sts.sts_test_app_package;
+package android.security.sts;
 
 import static androidx.test.core.app.ApplicationProvider.getApplicationContext;
 import static androidx.test.platform.app.InstrumentationRegistry.getInstrumentation;
@@ -48,6 +48,7 @@ public class DeviceTest {
 
     /** Test broadcast action */
     public static final String ACTION_BROADCAST = "action_security_test_broadcast";
+
     /** Broadcast intent extra name for artifacts */
     public static final String INTENT_ARTIFACT = "artifact";
 
@@ -77,9 +78,9 @@ public class DeviceTest {
                         }
                     }
                 };
-        IntentFilter filter = new IntentFilter(); // see if there's a shorthand
-        filter.addAction(ACTION_BROADCAST); // what does this return?
-        mContext.registerReceiver(broadcastReceiver, filter);
+        IntentFilter filter = new IntentFilter();
+        filter.addAction(ACTION_BROADCAST);
+        mContext.registerReceiver(broadcastReceiver, filter, Context.RECEIVER_EXPORTED);
 
         // start the target app
         try {
diff --git a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/PocActivity.java b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/PocActivity.java
similarity index 93%
rename from libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/PocActivity.java
rename to libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/PocActivity.java
index daeb76c8b..9adb2b5cf 100644
--- a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/java/android/security/sts/sts_test_app_package/PocActivity.java
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/java/android/security/sts/PocActivity.java
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2022 The Android Open Source Project
+ * Copyright 2022 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -13,8 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
-package android.security.sts.sts_test_app_package;
+package android.security.sts;
 
 import android.app.Activity;
 import android.content.Intent;
diff --git a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/res/layout/activity_main.xml b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/res/layout/activity_main.xml
similarity index 94%
rename from libraries/sts-common-util/sts-sdk/package/test-app/src/main/res/layout/activity_main.xml
rename to libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/res/layout/activity_main.xml
index f14c7ce6e..0edbaaeaa 100644
--- a/libraries/sts-common-util/sts-sdk/package/test-app/src/main/res/layout/activity_main.xml
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest/src/main/res/layout/activity_main.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
-  Copyright 2022 The Android Open Source Project
+  Copyright 2024 The Android Open Source Project
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
@@ -24,3 +24,4 @@
         android:layout_width="match_parent"
         android:layout_height="match_parent"/>
 </LinearLayout>
+
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/appTest2/build.gradle.kts b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/build.gradle.kts
new file mode 100644
index 000000000..d4e34cd14
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/build.gradle.kts
@@ -0,0 +1,18 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+plugins { id("com.android.sts.apptest") }
+
+appTest {}
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/AndroidManifest.xml b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/AndroidManifest.xml
new file mode 100644
index 000000000..13807eaea
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/AndroidManifest.xml
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2024 The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License");
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+  -->
+
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    android:versionCode="1"
+    android:versionName="1.0">
+    <instrumentation
+        android:name="androidx.test.runner.AndroidJUnitRunner"
+        android:targetPackage="${applicationId}" />
+    <application
+        android:supportsRtl="true">
+        <activity
+            android:name=".PocActivity"
+            android:exported="true">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.LAUNCHER" />
+            </intent-filter>
+        </activity>
+    </application>
+</manifest>
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/java/android/security/sts/PocActivity.java b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/java/android/security/sts/PocActivity.java
new file mode 100644
index 000000000..effa60619
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/java/android/security/sts/PocActivity.java
@@ -0,0 +1,31 @@
+/*
+ * Copyright 2022 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.security.sts;
+
+import android.app.Activity;
+import android.os.Bundle;
+import android.util.Log;
+
+public class PocActivity extends Activity {
+    private static final String TAG = PocActivity.class.getSimpleName();
+
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+        setContentView(R.layout.activity_main);
+        Log.d(TAG, "poc activity started");
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/res/layout/activity_main.xml b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/res/layout/activity_main.xml
new file mode 100644
index 000000000..0edbaaeaa
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/appTest2/src/main/res/layout/activity_main.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2024 The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License");
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+  -->
+
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:orientation="vertical"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent">
+    <View
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"/>
+</LinearLayout>
+
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/build.gradle.kts b/libraries/sts-common-util/sts-sdk/example/submission/build.gradle.kts
new file mode 100644
index 000000000..f8fba7264
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/build.gradle.kts
@@ -0,0 +1,26 @@
+plugins { id("com.android.sts.sdksubmission") }
+
+fun getSubprojects(): List<Project> {
+    // glob for gradle direct subprojects
+    return fileTree(projectDir) { include("*/build.gradle*") }
+        .map {
+            val path = projectDir.toPath().relativize(it.toPath().getParent())
+            val gradlePath = path.toString().replace('/', ':')
+            gradlePath
+        }
+        .filter({
+            // filter out self build.gradle*
+            !it.isEmpty()
+        })
+        .map { project(it) }
+}
+
+// NOTE! all STS SDK dependencies must be subprojects
+dependencies {
+    // Automatically add each subproject as an STS SDK Test Resource
+    getSubprojects().forEach { stsSdkTestResource(it) }
+}
+
+stsSdkSubmission {
+    // Please configure your submission attributes here
+}
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/hostTest/build.gradle.kts b/libraries/sts-common-util/sts-sdk/example/submission/hostTest/build.gradle.kts
new file mode 100644
index 000000000..4a6ca1a34
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/hostTest/build.gradle.kts
@@ -0,0 +1,16 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+plugins { id("com.android.sts.javahosttest") }
diff --git a/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/java/android/security/sts/StsHostSideTestCase.java b/libraries/sts-common-util/sts-sdk/example/submission/hostTest/src/main/java/android/security/sts/sts_sdk_placeholder/HostsideTest.java
similarity index 86%
rename from libraries/sts-common-util/sts-sdk/package/sts-test/src/main/java/android/security/sts/StsHostSideTestCase.java
rename to libraries/sts-common-util/sts-sdk/example/submission/hostTest/src/main/java/android/security/sts/sts_sdk_placeholder/HostsideTest.java
index dbc55e21a..697202d34 100644
--- a/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/java/android/security/sts/StsHostSideTestCase.java
+++ b/libraries/sts-common-util/sts-sdk/example/submission/hostTest/src/main/java/android/security/sts/sts_sdk_placeholder/HostsideTest.java
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2022 The Android Open Source Project
+ * Copyright 2022 The Android Open Source Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -13,8 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
-package android.security.sts;
+package android.security.sts.sts_sdk_placeholder;
 
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeTrue;
@@ -41,11 +40,14 @@ import java.util.Optional;
 import java.util.regex.Pattern;
 
 @RunWith(DeviceJUnit4ClassRunner.class)
-public class StsHostSideTestCase extends NonRootSecurityTestCase {
+public class HostsideTest extends NonRootSecurityTestCase {
 
-    static final String TEST_APP = "sts_test_app_package.apk";
-    static final String TEST_PKG = "android.security.sts.sts_test_app_package";
-    static final String TEST_CLASS = TEST_PKG + "." + "DeviceTest";
+    // Set from the Gradle project for the AppTest plugins.
+    static final String TEST_APP = "appTest_StsSdkPlaceholder.apk";
+    // The Gradle project name is appended to the namespace "android.security.sts".
+    static final String TEST_PKG = "android.security.sts.appTest_StsSdkPlaceholder";
+    // The class name will be different from the application ID but will match the source code.
+    static final String TEST_CLASS = "android.security.sts.DeviceTest";
 
     /** An app test, which uses this host Java test to launch an Android instrumented test */
     @Test
@@ -68,9 +70,9 @@ public class StsHostSideTestCase extends NonRootSecurityTestCase {
     public void testWithNativePoc() throws Exception {
         NativePoc.builder()
                 // the name of the PoC
-                .pocName("native-poc")
+                .pocName("ndkTest_StsSdkPlaceholder")
                 // extra files pushed to the device
-                .resources("res.txt")
+                .resources("StsSdkPlaceholder/res.txt")
                 // command-line arguments for the PoC
                 .args("res.txt", "vulnerable")
                 // other options allow different linker paths for library shims
@@ -97,13 +99,13 @@ public class StsHostSideTestCase extends NonRootSecurityTestCase {
                 MallocDebug.withLibcMallocDebugOnNewProcess(
                         getDevice(),
                         "backtrace guard", // malloc debug options
-                        "native-poc" // process name
+                        "ndkTest_StsSdkPlaceholder" // process name
                         )) {
             assumeTrue("could not disable root", getDevice().disableAdbRoot());
 
             // run a native PoC
             NativePoc.builder()
-                    .pocName("native-poc")
+                    .pocName("ndkTest_StsSdkPlaceholder")
                     .args("memory_corrupt")
                     .build() // add more as needed
                     .run(this);
@@ -137,7 +139,7 @@ public class StsHostSideTestCase extends NonRootSecurityTestCase {
 
         // attack the service
         NativePoc.builder()
-                .pocName("native-poc")
+                .pocName("ndkTest_StsSdkPlaceholder")
                 // pass the library path to the PoC
                 .args(libFileEntry.get().getFullPath())
                 .assumePocExitSuccess(false) // example returns EXIT_FAILURE if not enough args
@@ -146,7 +148,8 @@ public class StsHostSideTestCase extends NonRootSecurityTestCase {
                                 new TombstoneUtils.Config()
                                         // Because the vulnerability is in the shared library, the
                                         // process crash is the PoC.
-                                        .setProcessPatterns(Pattern.compile("native-poc"))))
+                                        .setProcessPatterns(
+                                                Pattern.compile("ndkTest_StsSdkPlaceholder"))))
                 .build()
                 .run(this);
     }
@@ -158,7 +161,7 @@ public class StsHostSideTestCase extends NonRootSecurityTestCase {
 
         // attack the device, which can be native poc, echo to socket, send intent, app, etc
         NativePoc.builder()
-                .pocName("native-poc")
+                .pocName("ndkTest_StsSdkPlaceholder")
                 .assumePocExitSuccess(false) // example returns EXIT_FAILURE if no args
                 .build() // add more as needed
                 .run(this);
diff --git a/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/resources/res.txt b/libraries/sts-common-util/sts-sdk/example/submission/hostTest/src/main/resources/StsSdkPlaceholder/res.txt
similarity index 100%
rename from libraries/sts-common-util/sts-sdk/package/sts-test/src/main/resources/res.txt
rename to libraries/sts-common-util/sts-sdk/example/submission/hostTest/src/main/resources/StsSdkPlaceholder/res.txt
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/CMakeLists.txt b/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/CMakeLists.txt
new file mode 100644
index 000000000..0f8409281
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/CMakeLists.txt
@@ -0,0 +1,12 @@
+cmake_minimum_required(VERSION 3.22.1)
+
+project("ndkTest")
+
+add_executable(
+        ndkTest
+        src/native-sample.cpp
+)
+
+find_library( # Sets the name of the path variable.
+        log-lib
+        log)
diff --git a/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/build.gradle.kts b/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/build.gradle.kts
new file mode 100644
index 000000000..c4cc6fb0b
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/build.gradle.kts
@@ -0,0 +1,10 @@
+plugins {
+    // my sts sdk plugin
+    id("com.android.sts.ndktest")
+}
+
+nativeTest {
+    minSdk = 33
+    targetSdk = 33
+    compileSdk = 33
+}
diff --git a/libraries/sts-common-util/sts-sdk/package/native-poc/src/native-sample.cpp b/libraries/sts-common-util/sts-sdk/example/submission/ndkTest/src/native-sample.cpp
similarity index 100%
rename from libraries/sts-common-util/sts-sdk/package/native-poc/src/native-sample.cpp
rename to libraries/sts-common-util/sts-sdk/example/submission/ndkTest/src/native-sample.cpp
diff --git a/libraries/sts-common-util/sts-sdk/package/README.md b/libraries/sts-common-util/sts-sdk/package/README.md
deleted file mode 100644
index 41b399a14..000000000
--- a/libraries/sts-common-util/sts-sdk/package/README.md
+++ /dev/null
@@ -1,2 +0,0 @@
-See https://source.android.com/docs/security/test/sts-sdk for instructions and
-documentation.
diff --git a/libraries/sts-common-util/sts-sdk/package/build.gradle b/libraries/sts-common-util/sts-sdk/package/build.gradle
deleted file mode 100644
index d08dd5e71..000000000
--- a/libraries/sts-common-util/sts-sdk/package/build.gradle
+++ /dev/null
@@ -1,101 +0,0 @@
-plugins {
-    id 'com.android.application' version '7.2.1' apply false
-    id 'com.android.library' version '7.2.1' apply false
-}
-
-task clean(type: Delete) {
-    delete layout.buildDirectory
-    if (findProject('native-poc') != null) {
-        delete project('native-poc').layout.projectDirectory.dir('.cxx')
-    }
-}
-
-ext.copyArtifacts = { nativeDir ->
-    copy {
-        from project('sts-test').layout.buildDirectory.file('testcases')
-
-        if (findProject('native-poc') != null) {
-            from project('native-poc').layout.buildDirectory.file(nativeDir)
-        }
-
-        into layout.buildDirectory.dir('android-sts/testcases')
-    }
-
-    // TODO: figure out variants
-    if (findProject('test-app') != null) {
-        copy {
-            from project('test-app').layout.buildDirectory.file('outputs/apk/debug')
-            rename '(.*).apk', 'sts_test_app_package.apk'
-            include '**/*.apk'
-            into layout.buildDirectory.dir('android-sts/testcases')
-        }
-    }
-
-    // To add another Android apk to the test, copy the block above and rename
-    // the project name to your submodule as well as the APK output filename.
-    // Remember to use that APK file name in your `sts-test`.
-
-    copy {
-        from project('sts-test').layout.projectDirectory.file('libs')
-        into layout.buildDirectory.dir('android-sts/tools')
-    }
-    copy {
-        from project('sts-test').layout.projectDirectory.dir('jdk')
-        into layout.buildDirectory.dir('android-sts/jdk')
-    }
-}
-
-task assembleStsARM {
-    dependsOn ':sts-test:copyHostSideTest'
-
-    if (findProject('native-poc') != null) {
-        dependsOn ':native-poc:copyarmeabi-v7a'
-        dependsOn ':native-poc:copyarm64-v8a'
-    }
-
-    if (findProject('test-app') != null) {
-        dependsOn ':test-app:assemble'
-    }
-
-    // To add another Android apk to the test, copy the block above and rename
-    // the project name to your new submodule
-
-    doLast {
-        copyArtifacts('testcases_arm')
-    }
-}
-
-task assembleStsx86 {
-    dependsOn ':sts-test:copyHostSideTest'
-
-    if (findProject('native-poc') != null) {
-        dependsOn ':native-poc:copyx86'
-        dependsOn ':native-poc:copyx86_64'
-    }
-
-    if (findProject('test-app') != null) {
-        dependsOn ':test-app:assemble'
-    }
-
-    // To add another Android apk to the test, copy the block above and rename
-    // the project name to your new submodule
-
-    doLast {
-        copyArtifacts('testcases_x86')
-    }
-}
-
-task zipForSubmission(type: Zip) {
-    from('.') {
-        exclude "**/build"
-        exclude '.gradle'
-        exclude 'test-app/libs'
-        exclude 'sts-test/libs'
-        exclude 'sts-test/jdk'
-        exclude 'sts-test/utils'
-        exclude "**/.cxx"
-    }
-    from project('sts-test').layout.projectDirectory.file('libs/version.txt')
-    archiveFileName.set("codesubmission.zip")
-    destinationDirectory.set(layout.buildDirectory)
-}
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/create_zip.xml b/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/create_zip.xml
deleted file mode 100644
index 50d26e205..000000000
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/create_zip.xml
+++ /dev/null
@@ -1,24 +0,0 @@
-<component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="zipForSubmission" type="GradleRunConfiguration" factoryName="Gradle">
-    <ExternalSystemSettings>
-      <option name="executionName" />
-      <option name="externalProjectPath" value="$PROJECT_DIR$" />
-      <option name="externalSystemIdString" value="GRADLE" />
-      <option name="scriptParameters" value="" />
-      <option name="taskDescriptions">
-        <list />
-      </option>
-      <option name="taskNames">
-        <list>
-          <option value="zipForSubmission" />
-        </list>
-      </option>
-      <option name="vmOptions" />
-    </ExternalSystemSettings>
-    <ExternalSystemDebugServerProcess>true</ExternalSystemDebugServerProcess>
-    <ExternalSystemReattachDebugProcess>true</ExternalSystemReattachDebugProcess>
-    <DebugAllEnabled>false</DebugAllEnabled>
-    <method v="2" />
-  </configuration>
-</component>
-
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_nonroot.xml b/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_nonroot.xml
deleted file mode 100644
index a8e0ca65b..000000000
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_nonroot.xml
+++ /dev/null
@@ -1,12 +0,0 @@
-<component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="run STS on device without root" type="ShConfigurationType">
-    <option name="SCRIPT_TEXT" value="./sts-tradefed run commandAndExit sts-sdk-nonroot --log-level debug --log-level-display debug -m hostsidetest" />
-    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
-    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
-    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$/build/android-sts/tools" />
-    <option name="EXECUTE_IN_TERMINAL" value="false" />
-    <option name="EXECUTE_SCRIPT_FILE" value="false" />
-    <envs />
-    <method v="2" />
-  </configuration>
-</component>
diff --git a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_root.xml b/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_root.xml
deleted file mode 100644
index 053744bbb..000000000
--- a/libraries/sts-common-util/sts-sdk/package/dotidea/runConfigurations/run_STS_root.xml
+++ /dev/null
@@ -1,12 +0,0 @@
-<component name="ProjectRunConfigurationManager">
-  <configuration default="false" name="run STS on device with root" type="ShConfigurationType">
-    <option name="SCRIPT_TEXT" value="./sts-tradefed run commandAndExit sts-sdk-root --log-level debug --log-level-display debug -m hostsidetest" />
-    <option name="INDEPENDENT_SCRIPT_PATH" value="true" />
-    <option name="INDEPENDENT_SCRIPT_WORKING_DIRECTORY" value="true" />
-    <option name="SCRIPT_WORKING_DIRECTORY" value="$PROJECT_DIR$/build/android-sts/tools" />
-    <option name="EXECUTE_IN_TERMINAL" value="false" />
-    <option name="EXECUTE_SCRIPT_FILE" value="false" />
-    <envs />
-    <method v="2" />
-  </configuration>
-</component>
diff --git a/libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.jar b/libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.jar
deleted file mode 100644
index 1948b9074..000000000
Binary files a/libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.jar and /dev/null differ
diff --git a/libraries/sts-common-util/sts-sdk/package/gradlew b/libraries/sts-common-util/sts-sdk/package/gradlew
deleted file mode 100755
index cccdd3d51..000000000
--- a/libraries/sts-common-util/sts-sdk/package/gradlew
+++ /dev/null
@@ -1,172 +0,0 @@
-#!/usr/bin/env sh
-
-##############################################################################
-##
-##  Gradle start up script for UN*X
-##
-##############################################################################
-
-# Attempt to set APP_HOME
-# Resolve links: $0 may be a link
-PRG="$0"
-# Need this for relative symlinks.
-while [ -h "$PRG" ] ; do
-    ls=`ls -ld "$PRG"`
-    link=`expr "$ls" : '.*-> \(.*\)$'`
-    if expr "$link" : '/.*' > /dev/null; then
-        PRG="$link"
-    else
-        PRG=`dirname "$PRG"`"/$link"
-    fi
-done
-SAVED="`pwd`"
-cd "`dirname \"$PRG\"`/" >/dev/null
-APP_HOME="`pwd -P`"
-cd "$SAVED" >/dev/null
-
-APP_NAME="Gradle"
-APP_BASE_NAME=`basename "$0"`
-
-# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
-DEFAULT_JVM_OPTS=""
-
-# Use the maximum available, or set MAX_FD != -1 to use that value.
-MAX_FD="maximum"
-
-warn () {
-    echo "$*"
-}
-
-die () {
-    echo
-    echo "$*"
-    echo
-    exit 1
-}
-
-# OS specific support (must be 'true' or 'false').
-cygwin=false
-msys=false
-darwin=false
-nonstop=false
-case "`uname`" in
-  CYGWIN* )
-    cygwin=true
-    ;;
-  Darwin* )
-    darwin=true
-    ;;
-  MINGW* )
-    msys=true
-    ;;
-  NONSTOP* )
-    nonstop=true
-    ;;
-esac
-
-CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
-
-# Determine the Java command to use to start the JVM.
-if [ -n "$JAVA_HOME" ] ; then
-    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
-        # IBM's JDK on AIX uses strange locations for the executables
-        JAVACMD="$JAVA_HOME/jre/sh/java"
-    else
-        JAVACMD="$JAVA_HOME/bin/java"
-    fi
-    if [ ! -x "$JAVACMD" ] ; then
-        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
-
-Please set the JAVA_HOME variable in your environment to match the
-location of your Java installation."
-    fi
-else
-    JAVACMD="java"
-    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
-
-Please set the JAVA_HOME variable in your environment to match the
-location of your Java installation."
-fi
-
-# Increase the maximum file descriptors if we can.
-if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
-    MAX_FD_LIMIT=`ulimit -H -n`
-    if [ $? -eq 0 ] ; then
-        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
-            MAX_FD="$MAX_FD_LIMIT"
-        fi
-        ulimit -n $MAX_FD
-        if [ $? -ne 0 ] ; then
-            warn "Could not set maximum file descriptor limit: $MAX_FD"
-        fi
-    else
-        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
-    fi
-fi
-
-# For Darwin, add options to specify how the application appears in the dock
-if $darwin; then
-    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
-fi
-
-# For Cygwin, switch paths to Windows format before running java
-if $cygwin ; then
-    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
-    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
-    JAVACMD=`cygpath --unix "$JAVACMD"`
-
-    # We build the pattern for arguments to be converted via cygpath
-    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
-    SEP=""
-    for dir in $ROOTDIRSRAW ; do
-        ROOTDIRS="$ROOTDIRS$SEP$dir"
-        SEP="|"
-    done
-    OURCYGPATTERN="(^($ROOTDIRS))"
-    # Add a user-defined pattern to the cygpath arguments
-    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
-        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
-    fi
-    # Now convert the arguments - kludge to limit ourselves to /bin/sh
-    i=0
-    for arg in "$@" ; do
-        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
-        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option
-
-        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
-            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
-        else
-            eval `echo args$i`="\"$arg\""
-        fi
-        i=$((i+1))
-    done
-    case $i in
-        (0) set -- ;;
-        (1) set -- "$args0" ;;
-        (2) set -- "$args0" "$args1" ;;
-        (3) set -- "$args0" "$args1" "$args2" ;;
-        (4) set -- "$args0" "$args1" "$args2" "$args3" ;;
-        (5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
-        (6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
-        (7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
-        (8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
-        (9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
-    esac
-fi
-
-# Escape application args
-save () {
-    for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
-    echo " "
-}
-APP_ARGS=$(save "$@")
-
-# Collect all arguments for the java command, following the shell quoting and substitution rules
-eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"
-
-# by default we should be in the correct project dir, but when run from Finder on Mac, the cwd is wrong
-if [ "$(uname)" = "Darwin" ] && [ "$HOME" = "$PWD" ]; then
-  cd "$(dirname "$0")"
-fi
-
-exec "$JAVACMD" "$@"
diff --git a/libraries/sts-common-util/sts-sdk/package/native-poc/build.gradle.template b/libraries/sts-common-util/sts-sdk/package/native-poc/build.gradle.template
deleted file mode 100644
index 08b4333d3..000000000
--- a/libraries/sts-common-util/sts-sdk/package/native-poc/build.gradle.template
+++ /dev/null
@@ -1,32 +0,0 @@
-plugins {
-    id 'com.android.library'
-}
-
-android {
-    compileSdk {{PLATFORM_SDK_VERSION}}
-    externalNativeBuild {
-        cmake {
-            path file('src/CMakeLists.txt')
-            version '3.18.1'
-        }
-    }
-    defaultConfig {
-        targetSdk {{PLATFORM_SDK_VERSION}}
-        minSdk 29
-    }
-}
-
-ext.copyArtifact = { arch, suffix, outputDir ->
-    tasks.register("copy${arch}", Copy) {
-        dependsOn 'externalNativeBuildDebug'
-        from layout.buildDirectory.file("intermediates/cmake/debug/obj/${arch}/nativepoc")
-        rename ('nativepoc', "${project.name.replaceFirst(/-native/, '')}${suffix}")
-        into layout.buildDirectory.dir(outputDir)
-    }
-}
-
-copyArtifact('armeabi-v7a', '_sts32', 'testcases_arm')
-copyArtifact('arm64-v8a', '_sts64', 'testcases_arm')
-copyArtifact('x86', '_sts32', 'testcases_x86')
-copyArtifact('x86_64', '_sts64', 'testcases_x86')
-
diff --git a/libraries/sts-common-util/sts-sdk/package/native-poc/src/CMakeLists.txt b/libraries/sts-common-util/sts-sdk/package/native-poc/src/CMakeLists.txt
deleted file mode 100644
index cda521d8c..000000000
--- a/libraries/sts-common-util/sts-sdk/package/native-poc/src/CMakeLists.txt
+++ /dev/null
@@ -1,12 +0,0 @@
-cmake_minimum_required(VERSION 3.18.1)
-
-project("nativepoc")
-
-add_executable(
-        nativepoc
-        native-sample.cpp
-)
-
-find_library( # Sets the name of the path variable.
-        log-lib
-        log)
diff --git a/libraries/sts-common-util/sts-sdk/package/native-poc/src/main/AndroidManifest.xml b/libraries/sts-common-util/sts-sdk/package/native-poc/src/main/AndroidManifest.xml
deleted file mode 100644
index cf2ccb768..000000000
--- a/libraries/sts-common-util/sts-sdk/package/native-poc/src/main/AndroidManifest.xml
+++ /dev/null
@@ -1,5 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<manifest xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:tools="http://schemas.android.com/tools"
-    package="com.android.sts">
-</manifest>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/package/settings.gradle b/libraries/sts-common-util/sts-sdk/package/settings.gradle
deleted file mode 100644
index c73df1c72..000000000
--- a/libraries/sts-common-util/sts-sdk/package/settings.gradle
+++ /dev/null
@@ -1,27 +0,0 @@
-pluginManagement {
-    repositories {
-        gradlePluginPortal()
-        google()
-        mavenCentral()
-    }
-}
-
-dependencyResolutionManagement {
-    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
-    repositories {
-        google()
-        mavenCentral()
-    }
-}
-
-rootProject.name = 'STS test'
-
-if (new File('native-poc').isDirectory()) {
-    include ':native-poc'
-}
-
-if (new File('test-app').isDirectory()) {
-    include ':test-app'
-}
-
-include ':sts-test'
diff --git a/libraries/sts-common-util/sts-sdk/package/sts-test/build.gradle b/libraries/sts-common-util/sts-sdk/package/sts-test/build.gradle
deleted file mode 100644
index f5f4a1545..000000000
--- a/libraries/sts-common-util/sts-sdk/package/sts-test/build.gradle
+++ /dev/null
@@ -1,31 +0,0 @@
-plugins {
-    id 'java-library'
-}
-
-task copyConfig(type: Copy) {
-    from layout.projectDirectory.file('src/hostsidetest.config.tmpl')
-    rename 'hostsidetest.config.tmpl', 'hostsidetest.config'
-    filter { l -> l.replaceAll('@@jarname@@', jar.outputs.getFiles().getSingleFile().getName()) }
-    into layout.buildDirectory.dir('config')
-}
-
-task copyHostSideTest(type: Copy) {
-    from jar
-    from copyConfig
-    into layout.buildDirectory.dir('testcases')
-}
-
-dependencies {
-    implementation files('libs/sts-tradefed.jar')
-    implementation files('libs/tradefed.jar')
-    implementation files('libs/compatibility-host-util.jar')
-    implementation files('libs/sts-host-util.jar')
-
-    implementation 'androidx.annotation:annotation:1.4.0'
-    implementation files('libs/hamcrest-library.jar')
-}
-
-java {
-    sourceCompatibility = JavaVersion.VERSION_1_8
-    targetCompatibility = JavaVersion.VERSION_1_8
-}
diff --git a/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/AndroidManifest.xml b/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/AndroidManifest.xml
deleted file mode 100644
index c94d4eb75..000000000
--- a/libraries/sts-common-util/sts-sdk/package/sts-test/src/main/AndroidManifest.xml
+++ /dev/null
@@ -1,5 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<manifest xmlns:android="http://schemas.android.com/apk/res/android"
-    package="android.security.sts">
-
-</manifest>
\ No newline at end of file
diff --git a/libraries/sts-common-util/sts-sdk/package/test-app/build.gradle b/libraries/sts-common-util/sts-sdk/package/test-app/build.gradle
deleted file mode 100644
index 17881ccc6..000000000
--- a/libraries/sts-common-util/sts-sdk/package/test-app/build.gradle
+++ /dev/null
@@ -1,40 +0,0 @@
-plugins {
-    id 'com.android.application'
-}
-
-android {
-    compileSdk 31
-
-    defaultConfig {
-        applicationId "android.security.sts.sts_test_app_package"
-        minSdk 29
-        targetSdk 31
-        versionCode 1
-        versionName "1.0"
-    }
-
-    buildTypes {
-        release {
-            minifyEnabled false
-        }
-    }
-    compileOptions {
-        sourceCompatibility JavaVersion.VERSION_1_8
-        targetCompatibility JavaVersion.VERSION_1_8
-    }
-
-    lintOptions {
-        checkReleaseBuilds false
-        abortOnError false
-    }
-}
-
-dependencies {
-
-    implementation 'androidx.appcompat:appcompat:1.4.2'
-    implementation 'com.google.android.material:material:1.6.1'
-    implementation 'junit:junit:4.13.2'
-    implementation 'androidx.test.ext:junit:1.1.3'
-    implementation 'androidx.test.espresso:espresso-core:3.4.0'
-    implementation 'androidx.test.uiautomator:uiautomator:2.2.0'
-}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/.gitignore b/libraries/sts-common-util/sts-sdk/plugin/.gitignore
new file mode 100644
index 000000000..095931957
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/.gitignore
@@ -0,0 +1,8 @@
+# Ignore Gradle project-specific cache directory
+.gradle
+
+# Ignore Gradle build output directory
+build
+
+# Ignore idea
+.idea
diff --git a/libraries/sts-common-util/sts-sdk/Android.bp b/libraries/sts-common-util/sts-sdk/plugin/Android.bp
similarity index 50%
rename from libraries/sts-common-util/sts-sdk/Android.bp
rename to libraries/sts-common-util/sts-sdk/plugin/Android.bp
index 0d56bc99d..2d1d3c734 100644
--- a/libraries/sts-common-util/sts-sdk/Android.bp
+++ b/libraries/sts-common-util/sts-sdk/plugin/Android.bp
@@ -17,40 +17,36 @@ package {
 }
 
 filegroup {
-    name: "sts-sdk-samples-srcs",
+    name: "sts-sdk-skel-srcs",
     srcs: [
-        "package/**/*",
+        "**/*",
     ],
     exclude_srcs: [
-        "package/**/.*",
+        "**/.*",
+        "Android.bp",
     ],
 }
 
 genrule {
-    name: "sts-sdk-samples.zip-gen",
+    name: "sts-sdk-plugin-skel.zip-gen",
     srcs: [
-        ":sts-sdk-samples-srcs",
+        ":sts-sdk-skel-srcs",
     ],
-    out: ["sts-sdk-samples.zip"],
+    out: ["sts-sdk-plugin-skel.zip"],
     tools: [
         "soong_zip",
     ],
     product_variables: {
         platform_sdk_version: {
-            cmd: "mkdir -p $(genDir)/tmp/ " +
-                "&& cp -rf platform_testing/libraries/sts-common-util/sts-sdk/package/* $(genDir)/tmp/" +
-                "&& mv $(genDir)/tmp/dotidea $(genDir)/tmp/.idea && " +
-                "for tmplfile in $$(find $(genDir)/tmp/ -type f -iname *.template); do " +
-                "  echo $${tmplfile}; " +
-                "  sed -i 's~{{PLATFORM_SDK_VERSION}}~%d~g' $${tmplfile}; " +
-                "  mv $${tmplfile} $${tmplfile/.template/}; " +
-                "done && " +
-                "$(location soong_zip) -o $(out) -C $(genDir)/tmp -D $(genDir)/tmp -D $(genDir)/tmp/.idea",
+            cmd: "files=($(in)) " +
+                "&& mkdir -p $(genDir)/tmp/ " +
+                "&& echo $(in) > $(genDir)/tmp/sts-sdk-plugin-skel.zip.list " +
+                "&& $(location soong_zip) -o $(out) -C $$(dirname $${files[0]}) -l $(genDir)/tmp/sts-sdk-plugin-skel.zip.list",
         },
     },
 }
 
 prebuilt_etc {
-    name: "sts-sdk-samples.zip",
-    src: ":sts-sdk-samples.zip-gen",
+    name: "sts-sdk-plugin-skel.zip",
+    src: ":sts-sdk-plugin-skel.zip-gen",
 }
diff --git a/libraries/sts-common-util/sts-sdk/plugin/extract-and-gradle.sh b/libraries/sts-common-util/sts-sdk/plugin/extract-and-gradle.sh
new file mode 100755
index 000000000..6e2743b34
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/extract-and-gradle.sh
@@ -0,0 +1,37 @@
+#!/bin/bash
+
+# Because the build environment is not passed to this script, please `m sts-sdk`.
+
+# usage:
+# $ m sts-sdk && ./extract-and-gradle.sh *commands*
+
+# publish to local; useful for testing examples:
+# $ m sts-sdk && ./extract-and-gradle.sh publishToMavenLocal
+
+# build only:
+# $ m sts-sdk && ./extract-and-gradle.sh assemble
+
+# build and test:
+# $ m sts-sdk && ./extract-and-gradle.sh build
+
+# Exit on error
+set -e
+
+if [ -z "${ANDROID_HOST_OUT}" ]; then
+  echo "ANDROID_HOST_OUT is not set. Did you source and lunch?"
+  exit 1
+fi
+
+STS_SDK_OUT=/tmp/sts-sdk
+
+# Remove output directory.
+# This breaks incremental compile but in practice the difference is negligible.
+rm -rf $STS_SDK_OUT
+
+# -q quiet
+# -o overwrite without prompting
+# -d output directory
+unzip -q -o $ANDROID_HOST_OUT/sts-sdk/sts-sdk.zip -d $STS_SDK_OUT
+
+cd $STS_SDK_OUT
+./gradlew $@
diff --git a/libraries/sts-common-util/sts-sdk/plugin/gradle/libs.versions.toml b/libraries/sts-common-util/sts-sdk/plugin/gradle/libs.versions.toml
new file mode 100644
index 000000000..bfe9d124f
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/gradle/libs.versions.toml
@@ -0,0 +1,20 @@
+# Copyright 2024 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+# https://docs.gradle.org/current/userguide/platforms.html#sub::toml-dependencies-format
+
+[plugins]
+androidApp = { id = "com.android.application", version = "8.5.2" }
+androidLib = { id = "com.android.library", version = "8.5.2" }
+jvm = { id = "org.jetbrains.kotlin.jvm", version = "2.0.20" }
diff --git a/libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.jar b/libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.jar
new file mode 100644
index 000000000..d64cd4917
Binary files /dev/null and b/libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.jar differ
diff --git a/libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.properties b/libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.properties
similarity index 74%
rename from libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.properties
rename to libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.properties
index 48c8d88a6..a80b22ce5 100644
--- a/libraries/sts-common-util/sts-sdk/package/gradle/wrapper/gradle-wrapper.properties
+++ b/libraries/sts-common-util/sts-sdk/plugin/gradle/wrapper/gradle-wrapper.properties
@@ -1,6 +1,7 @@
-#Wed Jun 29 11:41:03 PDT 2022
 distributionBase=GRADLE_USER_HOME
-distributionUrl=https\://services.gradle.org/distributions/gradle-7.3.3-bin.zip
 distributionPath=wrapper/dists
-zipStorePath=wrapper/dists
+distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-bin.zip
+networkTimeout=10000
+validateDistributionUrl=true
 zipStoreBase=GRADLE_USER_HOME
+zipStorePath=wrapper/dists
diff --git a/libraries/sts-common-util/sts-sdk/plugin/gradlew b/libraries/sts-common-util/sts-sdk/plugin/gradlew
new file mode 100755
index 000000000..1aa94a426
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/gradlew
@@ -0,0 +1,249 @@
+#!/bin/sh
+
+#
+# Copyright  2015-2021 the original authors.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      https://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+##############################################################################
+#
+#   Gradle start up script for POSIX generated by Gradle.
+#
+#   Important for running:
+#
+#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
+#       noncompliant, but you have some other compliant shell such as ksh or
+#       bash, then to run this script, type that shell name before the whole
+#       command line, like:
+#
+#           ksh Gradle
+#
+#       Busybox and similar reduced shells will NOT work, because this script
+#       requires all of these POSIX shell features:
+#         * functions;
+#         * expansions $var, ${var}, ${var:-default}, ${var+SET},
+#           ${var#prefix}, ${var%suffix}, and $( cmd );
+#         * compound commands having a testable exit status, especially case;
+#         * various built-in commands including command, set, and ulimit.
+#
+#   Important for patching:
+#
+#   (2) This script targets any POSIX shell, so it avoids extensions provided
+#       by Bash, Ksh, etc; in particular arrays are avoided.
+#
+#       The "traditional" practice of packing multiple parameters into a
+#       space-separated string is a well documented source of bugs and security
+#       problems, so this is (mostly) avoided, by progressively accumulating
+#       options in "$@", and eventually passing that to Java.
+#
+#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
+#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
+#       see the in-line comments for details.
+#
+#       There are tweaks for specific operating systems such as AIX, CygWin,
+#       Darwin, MinGW, and NonStop.
+#
+#   (3) This script is generated from the Groovy template
+#       https://github.com/gradle/gradle/blob/HEAD/subprojects/plugins/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
+#       within the Gradle project.
+#
+#       You can find Gradle at https://github.com/gradle/gradle/.
+#
+##############################################################################
+
+# Attempt to set APP_HOME
+
+# Resolve links: $0 may be a link
+app_path=$0
+
+# Need this for daisy-chained symlinks.
+while
+    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
+    [ -h "$app_path" ]
+do
+    ls=$( ls -ld "$app_path" )
+    link=${ls#*' -> '}
+    case $link in             #(
+      /*)   app_path=$link ;; #(
+      *)    app_path=$APP_HOME$link ;;
+    esac
+done
+
+# This is normally unused
+# shellcheck disable=SC2034
+APP_BASE_NAME=${0##*/}
+# Discard cd standard output in case $CDPATH is set (https://github.com/gradle/gradle/issues/25036)
+APP_HOME=$( cd "${APP_HOME:-./}" > /dev/null && pwd -P ) || exit
+
+# Use the maximum available, or set MAX_FD != -1 to use that value.
+MAX_FD=maximum
+
+warn () {
+    echo "$*"
+} >&2
+
+die () {
+    echo
+    echo "$*"
+    echo
+    exit 1
+} >&2
+
+# OS specific support (must be 'true' or 'false').
+cygwin=false
+msys=false
+darwin=false
+nonstop=false
+case "$( uname )" in                #(
+  CYGWIN* )         cygwin=true  ;; #(
+  Darwin* )         darwin=true  ;; #(
+  MSYS* | MINGW* )  msys=true    ;; #(
+  NONSTOP* )        nonstop=true ;;
+esac
+
+CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
+
+
+# Determine the Java command to use to start the JVM.
+if [ -n "$JAVA_HOME" ] ; then
+    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
+        # IBM's JDK on AIX uses strange locations for the executables
+        JAVACMD=$JAVA_HOME/jre/sh/java
+    else
+        JAVACMD=$JAVA_HOME/bin/java
+    fi
+    if [ ! -x "$JAVACMD" ] ; then
+        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
+
+Please set the JAVA_HOME variable in your environment to match the
+location of your Java installation."
+    fi
+else
+    JAVACMD=java
+    if ! command -v java >/dev/null 2>&1
+    then
+        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
+
+Please set the JAVA_HOME variable in your environment to match the
+location of your Java installation."
+    fi
+fi
+
+# Increase the maximum file descriptors if we can.
+if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
+    case $MAX_FD in #(
+      max*)
+        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
+        # shellcheck disable=SC2039,SC3045
+        MAX_FD=$( ulimit -H -n ) ||
+            warn "Could not query maximum file descriptor limit"
+    esac
+    case $MAX_FD in  #(
+      '' | soft) :;; #(
+      *)
+        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
+        # shellcheck disable=SC2039,SC3045
+        ulimit -n "$MAX_FD" ||
+            warn "Could not set maximum file descriptor limit to $MAX_FD"
+    esac
+fi
+
+# Collect all arguments for the java command, stacking in reverse order:
+#   * args from the command line
+#   * the main class name
+#   * -classpath
+#   * -D...appname settings
+#   * --module-path (only if needed)
+#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.
+
+# For Cygwin or MSYS, switch paths to Windows format before running java
+if "$cygwin" || "$msys" ; then
+    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
+    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )
+
+    JAVACMD=$( cygpath --unix "$JAVACMD" )
+
+    # Now convert the arguments - kludge to limit ourselves to /bin/sh
+    for arg do
+        if
+            case $arg in                                #(
+              -*)   false ;;                            # don't mess with options #(
+              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
+                    [ -e "$t" ] ;;                      #(
+              *)    false ;;
+            esac
+        then
+            arg=$( cygpath --path --ignore --mixed "$arg" )
+        fi
+        # Roll the args list around exactly as many times as the number of
+        # args, so each arg winds up back in the position where it started, but
+        # possibly modified.
+        #
+        # NB: a `for` loop captures its iteration list before it begins, so
+        # changing the positional parameters here affects neither the number of
+        # iterations, nor the values presented in `arg`.
+        shift                   # remove old arg
+        set -- "$@" "$arg"      # push replacement arg
+    done
+fi
+
+
+# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
+DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
+
+# Collect all arguments for the java command:
+#   * DEFAULT_JVM_OPTS, JAVA_OPTS, JAVA_OPTS, and optsEnvironmentVar are not allowed to contain shell fragments,
+#     and any embedded shellness will be escaped.
+#   * For example: A user cannot expect ${Hostname} to be expanded, as it is an environment variable and will be
+#     treated as '${Hostname}' itself on the command line.
+
+set -- \
+        "-Dorg.gradle.appname=$APP_BASE_NAME" \
+        -classpath "$CLASSPATH" \
+        org.gradle.wrapper.GradleWrapperMain \
+        "$@"
+
+# Stop when "xargs" is not available.
+if ! command -v xargs >/dev/null 2>&1
+then
+    die "xargs is not available"
+fi
+
+# Use "xargs" to parse quoted args.
+#
+# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
+#
+# In Bash we could simply go:
+#
+#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
+#   set -- "${ARGS[@]}" "$@"
+#
+# but POSIX shell has neither arrays nor command substitution, so instead we
+# post-process each arg (as a line of input to sed) to backslash-escape any
+# character that might be a shell metacharacter, then use eval to reverse
+# that process (while maintaining the separation between arguments), and wrap
+# the whole thing up as a single "set" statement.
+#
+# This will of course break if any of these variables contains a newline or
+# an unmatched quote.
+#
+
+eval "set -- $(
+        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
+        xargs -n1 |
+        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
+        tr '\n' ' '
+    )" '"$@"'
+
+exec "$JAVACMD" "$@"
diff --git a/libraries/sts-common-util/sts-sdk/plugin/settings.gradle.kts b/libraries/sts-common-util/sts-sdk/plugin/settings.gradle.kts
new file mode 100644
index 000000000..372ae04dd
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/settings.gradle.kts
@@ -0,0 +1,35 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+pluginManagement {
+    repositories {
+        gradlePluginPortal()
+        google()
+        mavenCentral()
+    }
+}
+
+dependencyResolutionManagement {
+    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
+    repositories {
+        google()
+        mavenCentral()
+    }
+}
+
+rootProject.name = "sts-sdk"
+
+include("sts-sdk")
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/build.gradle.kts b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/build.gradle.kts
new file mode 100644
index 000000000..9ff831956
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/build.gradle.kts
@@ -0,0 +1,78 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+plugins {
+    // Apply the Java Gradle plugin development plugin to add support for developing Gradle plugins
+    `java-gradle-plugin`
+
+    // Apply the Kotlin JVM plugin to add support for Kotlin.
+    alias(libs.plugins.jvm)
+
+    `maven-publish`
+
+    alias(libs.plugins.androidApp) apply false
+    alias(libs.plugins.androidLib) apply false
+}
+
+dependencies {
+    implementation("com.android.tools.build:gradle:8.5.2")
+
+    // Use the Kotlin JUnit 5 integration.
+    testImplementation("org.jetbrains.kotlin:kotlin-test-junit5")
+
+    testRuntimeOnly("org.junit.platform:junit-platform-launcher")
+
+    // https://mvnrepository.com/artifact/com.google.code.gson/gson
+    implementation("com.google.code.gson:gson:2.11.0")
+}
+
+java {
+    toolchain {
+        // The Android Gradle Plugin is currently only compatible with Java 17
+        languageVersion = JavaLanguageVersion.of(17)
+    }
+}
+
+// Define the overall plugin
+group = "com.android.sts"
+
+version = "1.0.0"
+
+// Define the individual sub-plugins
+gradlePlugin {
+    plugins {
+        create("stsSdkBasePlugin") {
+            id = "com.android.sts.base"
+            implementationClass = "com.android.sts.StsSdkBasePlugin"
+        }
+        create("stsSdkSubmissionPlugin") {
+            id = "com.android.sts.sdksubmission"
+            implementationClass = "com.android.sts.StsSdkSubmissionPlugin"
+        }
+        create("StsSdkJavaHostTestPlugin") {
+            id = "com.android.sts.javahosttest"
+            implementationClass = "com.android.sts.StsSdkJavaHostTestPlugin"
+        }
+        create("StsSdkAppTestPlugin") {
+            id = "com.android.sts.apptest"
+            implementationClass = "com.android.sts.StsSdkAppTestPlugin"
+        }
+        create("StsSdkNdkTestPlugin") {
+            id = "com.android.sts.ndktest"
+            implementationClass = "com.android.sts.StsSdkNdkTestPlugin"
+        }
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkAppTestPlugin.kt b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkAppTestPlugin.kt
new file mode 100644
index 000000000..9cfc5f22b
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkAppTestPlugin.kt
@@ -0,0 +1,164 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.sts
+
+import com.android.build.api.artifact.SingleArtifact
+import com.android.build.api.variant.ApplicationAndroidComponentsExtension
+import com.android.build.gradle.internal.dsl.BaseAppModuleExtension
+import com.google.gson.Gson
+import java.io.BufferedWriter
+import org.gradle.api.GradleException
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.tasks.Copy
+
+// This is a restricted version of the "android" extension block provided by the AGP
+// The interface is restricted to simplify the translation between AGP and the Android Build System
+// More fields can be added here in response to needs that arise
+// All fields must be JSON serializable for inclusion in the submission zip
+// https://developer.android.com/guide/app-bundle/configure-base
+// See "android_test_helper_app" at the "Soong reference files"
+// https://ci.android.com/builds/latest/branches/aosp-build-tools/targets/linux/view/soong_build.html
+open class AppTestExtension {
+    var minSdk: Int = 31 // oldest security-supported
+    var targetSdk: Int = 34 // newest security-supported
+    var compileSdk: Int = 34 // compile = target
+}
+
+class StsSdkAppTestPlugin : Plugin<Project> {
+    override fun apply(project: Project) {
+        val namespace = "android.security.sts"
+        val appTest = project.extensions.create("appTest", AppTestExtension::class.java)
+
+        // The APK artifact will be published to the "stsSdkTestResource" configuration
+        project.plugins.apply("com.android.sts.base")
+
+        val writeManifestTask =
+            project.tasks.register("writeManifestTask") { task ->
+                task.outputs.file(
+                    project.layout.buildDirectory.file("sts-sdk/sts-sdk-manifest.json")
+                )
+                task.doLast {
+                    val writer = BufferedWriter(task.outputs.files.singleFile.writer())
+                    val moduleManifest =
+                        StsSdkBasePlugin.ModuleManifest<AppTestExtension>(
+                            project,
+                            "AppTest",
+                            appTest
+                        )
+                    writer.use { out -> out.write(Gson().toJson(moduleManifest)) }
+                }
+            }
+
+        // Perform this work in the "afterEvaluate" callback because the extensions are not
+        // initialized yet.
+        project.afterEvaluate {
+            project.plugins.apply("com.android.application")
+
+            // https://developer.android.com/build/configure-app-module
+            // "All characters must be alphanumeric or an underscore [a-zA-Z0-9_]."
+            val nameRegex = """[a-zA-Z0-9_]+""".toRegex()
+            if (!project.name.matches(nameRegex)) {
+                throw GradleException("Project name doesn't match $nameRegex: ${project.name}")
+            }
+
+            // Because every module must be unique, append a placeholder to find/replace on import.
+            // https://source.android.com/docs/setup/reference/androidbp
+            // "every module must have a name property, and the value must be unique"
+            val rename = project.name + "_StsSdkPlaceholder"
+
+            // Copy our restricted-scope AppTestExtension into the normal Android extension
+            // BaseAppModuleExtension is internal to the AGP, but is widely used by similar
+            // extensions and unlikely to break
+            project.extensions.configure<BaseAppModuleExtension>("android") {
+                // Base on the Gradle project name so each APK is guaranteed to have unique id
+                it.defaultConfig.applicationId = "$namespace.$rename"
+                // Set the namespace to reduce refactoring requirements for STS integration
+                // https://developer.android.com/build/configure-app-module#set-namespace
+                it.namespace = namespace
+                it.compileSdk = appTest.compileSdk
+                it.defaultConfig.minSdk = appTest.minSdk
+                it.defaultConfig.targetSdk = appTest.targetSdk
+            }
+
+            val implementationConfiguration = project.configurations.getByName("implementation")
+            // TODO: https://github.com/gradle/gradle/issues/16634 - Can't use version catalog
+            // because the extension is not registered by subproject or root project
+            listOf(
+                    "androidx.appcompat:appcompat:1.6.1",
+                    "androidx.core:core:1.13.1",
+                    "com.google.android.material:material:1.12.0",
+                    "junit:junit:4.13.2",
+                    "androidx.test.ext:junit:1.1.5",
+                    "androidx.test.espresso:espresso-core:3.5.1",
+                    "androidx.test.uiautomator:uiautomator:2.3.0",
+                    "org.jetbrains.kotlin:kotlin-stdlib:1.8.22"
+                )
+                .forEach { dependencyString ->
+                    implementationConfiguration.dependencies.add(
+                        project.dependencies.create(dependencyString)
+                    )
+                }
+
+            // Register callbacks for "onVariants" so that we can attach the APK to the
+            // stsSdkTestResource configuration.
+            // This is the technique used by the "gradle-play-publisher" plugin
+            // https://developer.android.com/reference/tools/gradle-api/8.3/com/android/build/api/variant/AndroidComponentsExtension
+            // The order of this task is sensitive because the callbacks must be registered before
+            // they are called internally.
+            // The best time to register the callbacks is immediately when applying the plugin.
+            val androidComponentsExtension =
+                project.extensions.getByType(ApplicationAndroidComponentsExtension::class.java)
+            androidComponentsExtension.onVariants(androidComponentsExtension.selector().all()) {
+                variant ->
+                // We only care about the debug variant for now; release APKs don't have any
+                // features needed for STS.
+                // If necessary, add a field to AppTestExtension to control this
+                val variantName = variant.name
+                if (variantName == "debug") {
+                    // This is the same as the "outgoing variant" for "*RuntimeElement" secondary
+                    // variant "apk"
+                    // It's the dir containing the APK; typically "build/outputs/apk/debug"
+                    val apkDir = variant.artifacts.get(SingleArtifact.APK)
+                    val copyAppTestcaseResourceTask =
+                        project.tasks.register<Copy>(
+                            "copyAppTestcaseResource-$variantName",
+                            Copy::class.java
+                        ) { task ->
+                            task.from(apkDir) {
+                                // Rename to expected Soong module name
+                                it.rename(".*\\.apk", rename + ".apk")
+                                // Only include apks (glob, not regex)
+                                it.include("*.apk")
+                            }
+                            task.into(project.layout.buildDirectory.dir("sts-sdk/testcases/"))
+                        }
+
+                    val copyAppTestcaseResourceTasks =
+                        StsSdkBasePlugin.Abi.entries.map { abi ->
+                            Pair(abi, copyAppTestcaseResourceTask)
+                        }
+                    StsSdkBasePlugin.applyConfiguration(
+                        project = project,
+                        sourceDirectoryArtifact = project.layout.projectDirectory.dir("src/main"),
+                        manifestArtifact = writeManifestTask,
+                        resourceArtifacts = copyAppTestcaseResourceTasks
+                    )
+                }
+            }
+        }
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkBasePlugin.kt b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkBasePlugin.kt
new file mode 100644
index 000000000..7d5935e10
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkBasePlugin.kt
@@ -0,0 +1,91 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.sts
+
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.attributes.Attribute
+
+class StsSdkBasePlugin : Plugin<Project> {
+    class AbiAttributes(name: String, bitness: Int) {
+        val name = name
+        val bitness = bitness
+    }
+
+    // https://developer.android.com/ndk/guides/abis#sa
+    enum class Abi(val attr: AbiAttributes) {
+        ABI_ARMEABI_V7A(AbiAttributes("armeabi-v7a", 32)),
+        ABI_ARM64_V8A(AbiAttributes("arm64-v8a", 64)),
+        ABI_X86(AbiAttributes("x86", 32)),
+        ABI_X86_64(AbiAttributes("x86_64", 64)),
+    }
+
+    companion object {
+        val STS_SDK_TESTCASES_RESOURCE_CONFIGURATION_NAME = "stsSdkTestResource"
+
+        fun applyConfiguration(
+            project: Project,
+            sourceDirectoryArtifact: Any,
+            manifestArtifact: Any,
+            resourceArtifacts: List<Pair<Abi, Any>>,
+        ) {
+            val stsSdkTestResourceConfiguration =
+                project.configurations.getByName(STS_SDK_TESTCASES_RESOURCE_CONFIGURATION_NAME)
+            val abiAttribute = Attribute.of("com.android.sts.abi", Abi::class.java)
+            stsSdkTestResourceConfiguration.outgoing { configurationPublications ->
+                configurationPublications.artifact(sourceDirectoryArtifact) {
+                    configurePublishArtifact ->
+                    configurePublishArtifact.setType("source")
+                }
+                configurationPublications.artifact(manifestArtifact) { configurePublishArtifact ->
+                    configurePublishArtifact.setType("manifest")
+                }
+                configurationPublications.variants { namedDomainObjectContainer ->
+                    resourceArtifacts.forEach { resourceArtifact ->
+                        val (abi, artifact) = resourceArtifact
+                        val abiName = abi.attr.name
+                        namedDomainObjectContainer.create("abi-$abiName") { configurationVariant ->
+                            configurationVariant.attributes { attributeContainer ->
+                                attributeContainer.attribute(abiAttribute, abi)
+                            }
+                            configurationVariant.artifact(artifact) { configurablePublishArtifact ->
+                                configurablePublishArtifact.setType("resource")
+                            }
+                        }
+                    }
+                }
+            }
+        }
+    }
+
+    override fun apply(project: Project) {
+        // Export a configuration for users to add dependencies.
+        // "stsSdkTestResource" represents Soong modules for the Tradefed testcases/ directory.
+        // See "android_test_helper_app" and "cc_test" Soong modules.
+        // Dependencies should map 1:1 to tradefed Android.bp files for easy reconstruction.
+        project.configurations.create(STS_SDK_TESTCASES_RESOURCE_CONFIGURATION_NAME) { configuration
+            ->
+            configuration.isCanBeConsumed = true
+            configuration.isCanBeResolved = false
+        }
+    }
+
+    class ModuleManifest<T>(project: Project, type: String, resource: T) {
+        val name: String = project.name
+        val type: String = type
+        val resource: T = resource
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkJavaHostTestPlugin.kt b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkJavaHostTestPlugin.kt
new file mode 100644
index 000000000..40c3f52f4
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkJavaHostTestPlugin.kt
@@ -0,0 +1,143 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.sts
+
+import com.google.gson.Gson
+import java.io.BufferedWriter
+import java.util.regex.Pattern
+import org.gradle.api.GradleException
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.tasks.Copy
+import org.gradle.api.tasks.SourceSetContainer
+
+class StsSdkJavaHostTestPlugin : Plugin<Project> {
+    override fun apply(project: Project) {
+        val pluginJarUrl = this.javaClass.getProtectionDomain().getCodeSource().getLocation()
+
+        project.plugins.apply("java-library")
+        val compileOnlyConfiguration = project.configurations.getByName("compileOnly")
+        val dependencies =
+            project.dependencies.create(
+                project.zipTree(pluginJarUrl).matching { filter ->
+                    filter.include(
+                        listOf(
+                            "sts-tradefed-tools/sts-tradefed.jar",
+                            "sts-tradefed-tools/tradefed.jar",
+                            "sts-tradefed-tools/compatibility-host-util.jar",
+                            "sts-tradefed-tools/sts-host-util.jar",
+                            "sts-tradefed-tools/hamcrest-library.jar",
+                        )
+                    )
+                }
+            )
+        compileOnlyConfiguration.dependencies.add(dependencies)
+
+        val writeManifestTask =
+            project.tasks.register("writeManifestTask") { task ->
+                task.outputs.file(
+                    project.layout.buildDirectory.file("sts-sdk/sts-sdk-manifest.json")
+                )
+                task.doLast {
+                    val writer = BufferedWriter(task.outputs.files.singleFile.writer())
+                    // Note: this module has no extension so using Kotlin Unit as void/null
+                    val moduleManifest =
+                        StsSdkBasePlugin.ModuleManifest<Unit>(project, "JavaHostTest", Unit)
+                    writer.use { out -> out.write(Gson().toJson(moduleManifest)) }
+                }
+            }
+
+        val copyTestcasesResourcesTask =
+            project.tasks.register<Copy>("copyTestcasesResourcesJar", Copy::class.java) { task ->
+                task.from(project.tasks.getByName("jar")) { copySpec ->
+                    copySpec.rename(".*", "HostsideTest.jar")
+                }
+                task.from(project.zipTree(pluginJarUrl)) { copySpec ->
+                    // only include the single file instead of all jar contents
+                    copySpec.include("HostsideTest.config")
+                }
+                task.into(project.layout.buildDirectory.dir("android-sts/testcases"))
+            }
+        val copyTestcasesResourcesTasks =
+            StsSdkBasePlugin.Abi.entries.map { abi -> Pair(abi, copyTestcasesResourcesTask) }
+
+        project.plugins.apply("com.android.sts.base")
+        StsSdkBasePlugin.applyConfiguration(
+            project = project,
+            sourceDirectoryArtifact = project.layout.projectDirectory.dir("src/main"),
+            manifestArtifact = writeManifestTask,
+            resourceArtifacts = copyTestcasesResourcesTasks
+        )
+
+        val verifyPackageNamesTask =
+            project.tasks.register("verifyPackageNames") { task ->
+                task.doLast {
+                    val sourceSets = project.extensions.getByType(SourceSetContainer::class.java)
+                    sourceSets.getByName("main").java.forEach { file ->
+                        val expectedPackagePrefix = "android.security.sts.sts_sdk_placeholder"
+                        val fileText = file.readText()
+                        // Extract the package from the Java file
+                        val packageRegex = """^package\s+(?<package>[\w.]+);?$"""
+                        val packageMatcher =
+                            Pattern.compile(packageRegex, Pattern.MULTILINE).matcher(fileText)
+                        if (!packageMatcher.find()) {
+                            throw GradleException("Could not find package pattern in file: $file")
+                        }
+                        val packageName = packageMatcher.group("package")
+                        if (packageName == null) {
+                            throw GradleException("Could not find package name in file: $file")
+                        }
+                        if (!packageName.startsWith(expectedPackagePrefix)) {
+                            throw GradleException(
+                                "Package name doesn't start with \"$expectedPackagePrefix\" in " +
+                                    "file: $file"
+                            )
+                        }
+                    }
+                }
+            }
+
+        val verifyResourcesTask =
+            project.tasks.register("verifyResources") { task ->
+                task.doLast {
+                    val sourceSets = project.extensions.getByType(SourceSetContainer::class.java)
+                    val resourcesSourceSet = sourceSets.getByName("main").resources
+                    val expectedResourceDirectory = "StsSdkPlaceholder"
+
+                    val invalidPrefixResourceIterator =
+                        resourcesSourceSet.asFileTree
+                            .matching { patternFilterable ->
+                                patternFilterable.exclude(expectedResourceDirectory)
+                            }
+                            .iterator()
+                    if (invalidPrefixResourceIterator.hasNext()) {
+                        val invalidPrefixResources =
+                            invalidPrefixResourceIterator.asSequence().toList()
+                        throw GradleException(
+                            "All resource files need to be contained within " +
+                                "$expectedResourceDirectory/ in the resources directory: " +
+                                "$invalidPrefixResources"
+                        )
+                    }
+                }
+            }
+
+        // Perform verification when classes are being compiled.
+        project.tasks.named("classes").configure { task ->
+            task.dependsOn(verifyPackageNamesTask, verifyResourcesTask)
+        }
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkNdkTestPlugin.kt b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkNdkTestPlugin.kt
new file mode 100644
index 000000000..e17185b13
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkNdkTestPlugin.kt
@@ -0,0 +1,126 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.sts
+
+import com.android.build.api.artifact.SingleArtifact
+import com.android.build.api.variant.LibraryAndroidComponentsExtension
+import com.android.build.gradle.LibraryExtension
+import com.google.gson.Gson
+import java.io.BufferedWriter
+import java.io.File
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.file.RelativePath
+import org.gradle.api.tasks.Copy
+
+open class NdkTestExtension {
+    var minSdk: Int = 31 // oldest security-supported
+    var targetSdk: Int = 34 // newest security-supported
+    var compileSdk: Int = 34 // compile = target
+}
+
+class StsSdkNdkTestPlugin : Plugin<Project> {
+    override fun apply(project: Project) {
+        val nativeTest = project.extensions.create("nativeTest", NdkTestExtension::class.java)
+
+        project.plugins.apply("com.android.sts.base")
+        val ndkTest = project.extensions.create("appTest", NdkTestExtension::class.java)
+
+        val writeManifestTask =
+            project.tasks.register("writeManifestTask") { task ->
+                task.outputs.file(
+                    project.layout.buildDirectory.file("sts-sdk/sts-sdk-manifest.json")
+                )
+                task.doLast {
+                    val writer = BufferedWriter(task.outputs.files.singleFile.writer())
+                    val moduleManifest =
+                        StsSdkBasePlugin.ModuleManifest<NdkTestExtension>(
+                            project,
+                            "NdkTest",
+                            ndkTest
+                        )
+                    writer.use { out -> out.write(Gson().toJson(moduleManifest)) }
+                }
+            }
+
+        project.afterEvaluate {
+            val rename = project.name + "_StsSdkPlaceholder"
+
+            project.plugins.apply("com.android.library")
+            project.extensions.configure<LibraryExtension>("android") {
+                it.namespace = "com.android.sts"
+                it.compileSdk = nativeTest.compileSdk
+                it.externalNativeBuild.cmake.path = File("CMakeLists.txt")
+                // externalNativeBuild.cmake.version will be automatically set
+                it.defaultConfig.targetSdk = nativeTest.targetSdk
+                it.defaultConfig.minSdk = nativeTest.minSdk
+
+                // publish the pocs to the .aar artifact
+                // https://developer.android.com/build/native-dependencies?agpversion=4.1#publish-native-libs-in-aars
+                it.buildFeatures.prefabPublishing = true
+                it.prefab.create(project.name)
+            }
+
+            val androidComponentsExtension =
+                project.extensions.getByType(LibraryAndroidComponentsExtension::class.java)
+            androidComponentsExtension.onVariants { variant ->
+                val projectName = project.name
+                val variantName = variant.name
+                // Only select the "debug" variant
+                if (variantName == "debug") {
+                    val aarDir = variant.artifacts.get(SingleArtifact.AAR)
+                    val copyNdkTestcaseResourceTasks =
+                        StsSdkBasePlugin.Abi.entries.map { abi ->
+                            val abiName = abi.attr.name
+                            val aarPrefabPath =
+                                "prefab/modules/$projectName/libs/android.$abiName/$projectName"
+                            val copyNdkTestcaseResourceTask =
+                                project.tasks.register<Copy>(
+                                    "copyNdkTestcaseResource-$variantName-$abiName",
+                                    Copy::class.java
+                                ) { task ->
+                                    task.from(project.zipTree(aarDir)) { copySpec ->
+                                        copySpec.include(aarPrefabPath)
+                                        copySpec.rename(".*", "${rename}_sts${abi.attr.bitness}")
+                                        copySpec.eachFile { fileCopyDetails ->
+                                            // drop the path prefix
+                                            fileCopyDetails.relativePath =
+                                                RelativePath(
+                                                    true /* endsWithFile */,
+                                                    fileCopyDetails.relativePath.lastName
+                                                )
+                                        }
+                                        copySpec.includeEmptyDirs = false
+                                    }
+                                    task.into(
+                                        project.layout.buildDirectory.dir(
+                                            "sts-sdk/resources/$abiName"
+                                        )
+                                    )
+                                }
+                            Pair(abi, copyNdkTestcaseResourceTask)
+                        }
+                    StsSdkBasePlugin.applyConfiguration(
+                        project = project,
+                        sourceDirectoryArtifact = project.layout.projectDirectory.dir("src"),
+                        manifestArtifact = writeManifestTask,
+                        resourceArtifacts = copyNdkTestcaseResourceTasks
+                    )
+                }
+            }
+        }
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkSubmissionPlugin.kt b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkSubmissionPlugin.kt
new file mode 100644
index 000000000..dbcabfab2
--- /dev/null
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/kotlin/com/android/sts/StsSdkSubmissionPlugin.kt
@@ -0,0 +1,365 @@
+/*
+ * Copyright 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.sts
+
+import com.google.gson.Gson
+import com.google.gson.GsonBuilder
+import com.google.gson.JsonArray
+import com.google.gson.JsonObject
+import com.google.gson.JsonParser
+import java.nio.file.Files
+import org.gradle.api.Action
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.artifacts.Configuration
+import org.gradle.api.artifacts.ProjectDependency
+import org.gradle.api.attributes.Attribute
+import org.gradle.api.file.RelativePath
+import org.gradle.api.tasks.Copy
+import org.gradle.api.tasks.bundling.Zip
+
+open class StsSdkSubmissionExtension {
+    var deviceType: String? = null // phone, tv, wear, etc. enum?
+    var isRootRequired: Boolean = false
+    var isExternalHardwareRequired: Boolean = false // string?
+    var isPersistentExploit: Boolean = false
+}
+
+class StsSdkSubmissionPlugin : Plugin<Project> {
+    val taskGroup = "STS SDK"
+    val stsSdkSubmissionSourcesDir = "sts-sdk-submission"
+    val stsSdkTradefedDir = "android-sts"
+
+    // get plugin jar path from current class; plugin jar has resources
+    val pluginJarUrl = this.javaClass.getProtectionDomain().getCodeSource().getLocation()
+
+    val abiAttribute = Attribute.of("com.android.sts.abi", StsSdkBasePlugin.Abi::class.java)
+    var stsSdkTestResourceConfiguration: Configuration? = null
+
+    fun dependencyProjectConfiguration(
+        project: Project,
+        configuration: Configuration,
+        action: Action<Pair<Project, Configuration>>,
+    ) {
+        // By default, Gradle considers "evaluation" of the "configure" lifecycle to be done before
+        // the subprojects/dependencies are "configured/evaluated".
+        // This means that we can't process the subproject's configurations or artifacts unless this
+        // is set.
+        // Note: This likely only works for subprojects instead of all dependencies. I don't see
+        // another way because dependencies aren't available until afterEvaluate.
+        project.evaluationDependsOnChildren()
+
+        // Need to perform this work in the "afterEvaluate" callback because the extensions,
+        // dependencies, and dependency artifacts are not initialized yet.
+        project.afterEvaluate {
+            configuration.dependencies.forEach { dependency ->
+                if (dependency is ProjectDependency) {
+                    val dependencyProject = dependency.dependencyProject
+                    val dependencyConfiguration =
+                        dependencyProject.configurations.getByName(configuration.name)
+                    action.execute(Pair(dependencyProject, dependencyConfiguration))
+                }
+            }
+        }
+    }
+
+    fun registerAssembleStsSdkTradefedTask(
+        project: Project,
+        target: String,
+        abis: Set<StsSdkBasePlugin.Abi>,
+    ) {
+        val copyStsSdkTradefedToolsTask =
+            project.tasks.register<Copy>("copyStsSdkTradefedTools-$target", Copy::class.java) { task
+                ->
+                // use ziptree to copy the zip contents instead of the jar itself
+                task.from(project.zipTree(pluginJarUrl)) { copySpec ->
+                    // only include the "sts-tradefed-tools" path instead of all jar contents
+                    copySpec.include("sts-tradefed-tools/**")
+                    copySpec.eachFile { fileCopyDetails ->
+                        // drop the "sts-tradefed-tools" path prefix
+                        fileCopyDetails.relativePath =
+                            RelativePath(
+                                true /* endsWithFile */,
+                                *fileCopyDetails.relativePath.segments.drop(1).toTypedArray()
+                            )
+                    }
+                    // don't include the "sts-tradefed-tools" dir itself
+                    copySpec.includeEmptyDirs = false
+                }
+                task.into(project.layout.buildDirectory.dir("$target/$stsSdkTradefedDir/tools"))
+            }
+
+        val copyTradefedJdkTask =
+            project.tasks.register<Copy>("copyTradefedJdk-$target", Copy::class.java) { task ->
+                task.from(project.zipTree(pluginJarUrl)) { copySpec -> copySpec.include("jdk/**") }
+                task.into(project.layout.buildDirectory.dir("$target/$stsSdkTradefedDir"))
+            }
+
+        val assembleStsSdkTradefedTask =
+            project.tasks.register("assembleStsSdkTradefed-$target") { task ->
+                task.description =
+                    "Assemble the STS SDK Tradefed executable test suite for $target."
+                task.group = taskGroup
+                task.dependsOn(
+                    copyStsSdkTradefedToolsTask,
+                    copyTradefedJdkTask,
+                )
+            }
+
+        abis.forEach { abi ->
+            dependencyProjectConfiguration(project, stsSdkTestResourceConfiguration!!) {
+                dependencyProjectConfigurationPair ->
+                val (dependencyProject, dependencyConfiguration) =
+                    dependencyProjectConfigurationPair
+                val projectName = dependencyProject.name
+                dependencyConfiguration.outgoing { configurationPublications ->
+                    configurationPublications.variants { namedDomainObjectContainer ->
+                        namedDomainObjectContainer
+                            .filter { configurationVariant ->
+                                configurationVariant.attributes.getAttribute(abiAttribute) == abi
+                            }
+                            .forEach { configurationVariant ->
+                                val abiName = abi.attr.name
+                                configurationVariant.artifacts
+                                    .filter { publishArtifact ->
+                                        publishArtifact.type == "resource"
+                                    }
+                                    .forEach { publishArtifact ->
+                                        val copyTestcaseResourceTaskName =
+                                            "copyTestcaseResource-$target-$projectName-$abiName"
+                                        val copyTestcaseResourceTask =
+                                            project.tasks.register<Copy>(
+                                                copyTestcaseResourceTaskName,
+                                                Copy::class.java
+                                            ) { task ->
+                                                // Don't copy until entire task done
+                                                task.dependsOn(publishArtifact)
+                                                // TODO:
+                                                // https://github.com/gradle/gradle/issues/25587 -
+                                                // use publishArtifact directly
+                                                task.from(publishArtifact.file)
+                                                task.into(
+                                                    project.layout.buildDirectory.dir(
+                                                        "$target/$stsSdkTradefedDir/testcases"
+                                                    )
+                                                )
+                                            }
+                                        assembleStsSdkTradefedTask.configure { task ->
+                                            task.dependsOn(copyTestcaseResourceTask)
+                                        }
+                                    }
+                            }
+                    }
+                }
+            }
+        }
+
+        // Build STS SDK Tradefed tasks on assemble
+        project.tasks.named("assemble").configure { task ->
+            task.dependsOn(assembleStsSdkTradefedTask)
+        }
+    }
+
+    override fun apply(project: Project) {
+        val stsSdkSubmissionExtension =
+            project.extensions.create("stsSdkSubmission", StsSdkSubmissionExtension::class.java)
+
+        stsSdkTestResourceConfiguration =
+            project.configurations.create("stsSdkTestResource") { configuration ->
+                configuration.isCanBeConsumed = false
+                configuration.isCanBeResolved = true
+            }
+
+        // The standard lifecycle tasks including `assemble` are defined in `base`
+        // By applying the plugin, we essentially export it
+        // Without it, users will hit an error that "assemble" isn't found
+        project.plugins.apply("base")
+
+        val mergeManifestsTask =
+            project.tasks.register("mergeManifests") { task ->
+                task.outputs.file(
+                    // project.layout.buildDirectory.file("sts-sdk-submission/manifest.json")
+                    project.layout.buildDirectory.dir("$stsSdkSubmissionSourcesDir/manifest.json")
+                )
+                task.doLast {
+                    val submissionJson = JsonObject()
+                    val resources = JsonArray()
+                    task.inputs.files.forEach {
+                        val resourcesJsonString = Files.readString(it.toPath())
+                        resources.add(JsonParser.parseString(resourcesJsonString))
+                    }
+                    submissionJson.add("resources", resources)
+                    submissionJson.add("submission", Gson().toJsonTree(stsSdkSubmissionExtension))
+                    val gson = GsonBuilder().setPrettyPrinting().create()
+                    val jsonOutput = gson.toJson(submissionJson)
+                    task.outputs.files.singleFile.writeText(jsonOutput)
+                }
+            }
+
+        val copyRootProjectTask =
+            project.tasks.register<Copy>("copyRootProject", Copy::class.java) { task ->
+                val rootProjectDir = project.rootProject.layout.projectDirectory
+                task.from(rootProjectDir) { copySpec ->
+                    // Ignore system-specific files
+                    copySpec.exclude("local.properties")
+
+                    // Ignore gradle build
+                    project.rootProject.subprojects.forEach { subproject ->
+                        // exclude must be a String pattern relative to the copySpec "from"
+                        val subprojectBuildDirFile = subproject.layout.buildDirectory.asFile.get()
+                        copySpec.exclude(
+                            subprojectBuildDirFile.relativeTo(rootProjectDir.asFile).toString()
+                        )
+                    }
+                    // Ignore Gradle work dir and executable files
+                    copySpec.exclude(".gradle")
+                    copySpec.exclude("gradle")
+                    copySpec.exclude("gradlew")
+                    copySpec.exclude("gradlew.bat")
+
+                    // Ignore git
+                    copySpec.exclude(".git*")
+
+                    // Ignore Idea workspace files
+                    copySpec.exclude(".idea")
+
+                    // Ignore native build directories
+                    copySpec.exclude("**/.cxx")
+                }
+                task.into(project.layout.buildDirectory.dir("$stsSdkSubmissionSourcesDir/project"))
+            }
+
+        val assembleStsSdkSubmissionSourcesTask =
+            project.tasks.register("assembleStsSdkSubmissionSources") { task ->
+                task.description = "Assemble the source files for the submission zip."
+                task.group = taskGroup
+                task.dependsOn(mergeManifestsTask)
+                task.dependsOn(copyRootProjectTask)
+                task.outputs.file(project.layout.buildDirectory.dir(stsSdkSubmissionSourcesDir))
+            }
+
+        val assembleStsSdkSubmissionZipTask =
+            project.tasks.register<Zip>("assembleStsSdkSubmissionZip", Zip::class.java) { task ->
+                task.description = "Assemble the submission zip for upload."
+                task.group = taskGroup
+                task.from(assembleStsSdkSubmissionSourcesTask)
+                task.archiveFileName.set("sts-sdk-submission.zip")
+                task.destinationDirectory.set(project.layout.buildDirectory)
+            }
+
+        // matching Android Build configs
+        val targetToMultiAbiSets =
+            mapOf(
+                "test_suites_arm64" to
+                    setOf(StsSdkBasePlugin.Abi.ABI_ARMEABI_V7A, StsSdkBasePlugin.Abi.ABI_ARM64_V8A),
+                "test_suites_x86_64" to
+                    setOf(StsSdkBasePlugin.Abi.ABI_X86, StsSdkBasePlugin.Abi.ABI_X86_64),
+            )
+        targetToMultiAbiSets.entries.forEach { mapEntry ->
+            val (target, abis) = mapEntry
+            registerAssembleStsSdkTradefedTask(project, target, abis)
+        }
+
+        // By default, Gradle considers "evaluation" of the "configure" lifecycle to be done before
+        // the subprojects/dependencies are "configured/evaluated".
+        // This means that we can't process the subproject's configurations or artifacts unless this
+        // is set.
+        // Note: This likely only works for subprojects instead of all dependencies. I don't see
+        // another way because dependencies aren't available until afterEvaluate.
+        project.evaluationDependsOnChildren()
+
+        // Need to perform this work in the "afterEvaluate" callback because the extensions,
+        // dependencies, and dependency artifacts are not initialized yet.
+        project.afterEvaluate {
+            stsSdkTestResourceConfiguration!!.dependencies.forEach { dependency ->
+                if (dependency is ProjectDependency) {
+                    val dependencyProject = dependency.dependencyProject
+                    val configuration =
+                        dependencyProject.configurations.getByName(
+                            stsSdkTestResourceConfiguration!!.name
+                        )
+                    val projectName = dependencyProject.name
+
+                    configuration.artifacts.forEach { publishArtifact ->
+                        when (publishArtifact.type) {
+                            "manifest" -> {
+                                mergeManifestsTask.configure { task ->
+                                    task.dependsOn(dependencyProject.tasks.getByName("assemble"))
+                                    task.inputs.file(publishArtifact.file)
+                                }
+                            }
+                            "source" -> {
+                                val copyStsSdkTestcaseResourceSourceTask =
+                                    project.tasks.register<Copy>(
+                                        "copyStsSdkTestcaseResourceSource-$projectName",
+                                        Copy::class.java
+                                    ) { task ->
+                                        // TODO: https://github.com/gradle/gradle/issues/25587 - use
+                                        // publishArtifact directly
+                                        task.from(publishArtifact.file)
+                                        task.into(
+                                            project.layout.buildDirectory.dir(
+                                                "$stsSdkSubmissionSourcesDir/source/$projectName/"
+                                            )
+                                        )
+                                    }
+                                assembleStsSdkSubmissionSourcesTask.configure { task ->
+                                    task.dependsOn(copyStsSdkTestcaseResourceSourceTask)
+                                }
+                            }
+                            else -> {
+                                throw IllegalStateException(
+                                    "A resource added to the ${configuration.name} configuration " +
+                                        "has an unknown type. name: ${publishArtifact.name}, " +
+                                        "type: ${publishArtifact.type}"
+                                )
+                            }
+                        }
+                    }
+                }
+            }
+        }
+
+        val copyInvocationResultsResultsToSubmissionTask =
+            project.tasks.register("copyInvocationResultsToSubmission") { task ->
+                task.description =
+                    "Copy the results from previous Tradefed invocations into the STS SDK " +
+                        "submission sources directory to assist with the review process. Note " +
+                        "that this contains logs from both the host and device; please review " +
+                        "the contents before or after running this."
+                task.group = taskGroup
+            }
+        targetToMultiAbiSets.entries.forEach { mapEntry ->
+            val (target, _) = mapEntry
+            val targetTask =
+                project.tasks.register<Copy>(
+                    "copyInvocationResultsToSubmission-$target",
+                    Copy::class.java
+                ) { task ->
+                    task.dependsOn(assembleStsSdkSubmissionZipTask)
+                    task.from(project.layout.buildDirectory.dir("$target/$stsSdkTradefedDir")) {
+                        copySpec ->
+                        copySpec.include("logs/**")
+                        copySpec.include("results/**")
+                    }
+                    task.into(project.layout.buildDirectory.dir(stsSdkSubmissionSourcesDir))
+                }
+            copyInvocationResultsResultsToSubmissionTask.configure { task ->
+                task.dependsOn(targetTask)
+            }
+        }
+    }
+}
diff --git a/libraries/sts-common-util/sts-sdk/package/sts-test/src/hostsidetest.config.tmpl b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/resources/HostsideTest.config
similarity index 76%
rename from libraries/sts-common-util/sts-sdk/package/sts-test/src/hostsidetest.config.tmpl
rename to libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/resources/HostsideTest.config
index 39e3867af..ed95e86b9 100644
--- a/libraries/sts-common-util/sts-sdk/package/sts-test/src/hostsidetest.config.tmpl
+++ b/libraries/sts-common-util/sts-sdk/plugin/sts-sdk/src/main/resources/HostsideTest.config
@@ -2,6 +2,6 @@
 
 <configuration description="Runs host-side STS tests">
     <test class="com.android.tradefed.testtype.HostTest" >
-        <option name="jar" value="@@jarname@@" />
+        <option name="jar" value="HostsideTest.jar" />
     </test>
 </configuration>
diff --git a/libraries/sts-common-util/util/src/com/android/sts/common/util/FridaUtilsBusinessLogicHandler.java b/libraries/sts-common-util/util/src/com/android/sts/common/util/FridaUtilsBusinessLogicHandler.java
index fee29efb1..b15d624ac 100644
--- a/libraries/sts-common-util/util/src/com/android/sts/common/util/FridaUtilsBusinessLogicHandler.java
+++ b/libraries/sts-common-util/util/src/com/android/sts/common/util/FridaUtilsBusinessLogicHandler.java
@@ -1,3 +1,19 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
 package com.android.sts.common.util;
 
 import java.util.Optional;
@@ -5,12 +21,12 @@ import java.util.Optional;
 /** GCL-accessible Business Logic utility for FridaUtils */
 public class FridaUtilsBusinessLogicHandler {
     // {0} = FRIDA_PACKAGE (e.g. 'frida-inject')
-    // {1} = fridaVersion (e.g. '15.1.17')
+    // {1} = fridaVersionThreshold (e.g. '16.4.8')
     // {2} = FRIDA_OS (e.g. 'android')
     // {3} = fridaAbi (e.g. 'arm64')
     // Obtained from BusinessLogic, e.g. "{0}-{1}-{2}-{3}.xz"
     private static String fridaFilenameTemplate;
-    private static String fridaVersion;
+    private static String fridaVersionThreshold;
 
     public static String getFridaFilenameTemplate() {
         return fridaFilenameTemplate;
@@ -21,10 +37,10 @@ public class FridaUtilsBusinessLogicHandler {
     }
 
     public static Optional<String> getFridaVersion() {
-        return Optional.ofNullable(fridaVersion);
+        return Optional.ofNullable(fridaVersionThreshold);
     }
 
     public void setFridaVersion(String version) {
-        fridaVersion = version;
+        fridaVersionThreshold = version;
     }
 }
diff --git a/libraries/sts-common-util/util/src/com/android/sts/common/util/GhidraBusinessLogicHandler.java b/libraries/sts-common-util/util/src/com/android/sts/common/util/GhidraBusinessLogicHandler.java
index 1b3e0c1fd..802738bb2 100644
--- a/libraries/sts-common-util/util/src/com/android/sts/common/util/GhidraBusinessLogicHandler.java
+++ b/libraries/sts-common-util/util/src/com/android/sts/common/util/GhidraBusinessLogicHandler.java
@@ -20,8 +20,9 @@ import java.util.Optional;
 
 /** GCL-accessible Business Logic utility for GhidraPreparer */
 public class GhidraBusinessLogicHandler {
-    private static String gitReleaseTagName; // eg. "Ghidra_11.0.1_build"
-    private static String gitReleaseAssetName; // eg. "ghidra_11.0.1_PUBLIC_20240130.zip"
+    private static String gitReleaseTagName; // eg. "Ghidra_11.1.2_build"
+    private static String gitReleaseAssetName; // eg. "ghidra_11.1.2_PUBLIC_20240709.zip"
+    private static String versionThreshold; // eg. 11.1.2
 
     public static Optional<String> getGitReleaseTagName() {
         return Optional.ofNullable(gitReleaseTagName);
@@ -35,4 +36,12 @@ public class GhidraBusinessLogicHandler {
         gitReleaseTagName = tagName;
         gitReleaseAssetName = assetName;
     }
+
+    public void setMinGhidraVersion(String version) {
+        versionThreshold = version;
+    }
+
+    public static Optional<String> getMinGhidraVersion() {
+        return Optional.ofNullable(versionThreshold);
+    }
 }
diff --git a/libraries/systemui-helper/src/android/platform/helpers/LaunchAppUtils.kt b/libraries/systemui-helper/src/android/platform/helpers/LaunchAppUtils.kt
index 04e0f2c27..91a39d4e8 100644
--- a/libraries/systemui-helper/src/android/platform/helpers/LaunchAppUtils.kt
+++ b/libraries/systemui-helper/src/android/platform/helpers/LaunchAppUtils.kt
@@ -19,10 +19,14 @@ package android.platform.helpers
 import android.content.Context
 import android.content.Intent.FLAG_ACTIVITY_CLEAR_TASK
 import android.content.Intent.FLAG_ACTIVITY_NEW_TASK
+import android.platform.uiautomator_helpers.DeviceHelpers
+import android.platform.helpers.LaunchAppUtils.launchApp
 import androidx.test.platform.app.InstrumentationRegistry
 import androidx.test.uiautomator.By
 import androidx.test.uiautomator.UiDevice
 import androidx.test.uiautomator.Until
+import org.junit.rules.TestWatcher
+import org.junit.runner.Description
 import java.time.Duration
 
 /** Utilities to launch an [App]. */
@@ -59,6 +63,22 @@ object LaunchAppUtils {
         get() = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
 }
 
+/**
+ * Rule that launches specified app and closes it after the test execution
+ */
+class LaunchAppRule(private val app: App) : TestWatcher() {
+
+    override fun starting(description: Description?) {
+        InstrumentationRegistry.getInstrumentation()
+            .targetContext
+            .launchApp(app)
+    }
+
+    override fun finished(description: Description?) {
+        DeviceHelpers.uiDevice.executeShellCommand("am force-stop ${app.packageName}")
+    }
+}
+
 /** Describes an app that can be launched with [LaunchAppUtils]. */
 enum class App(internal val packageName: String) {
     CALCULATOR("com.google.android.calculator"),
diff --git a/libraries/systemui-helper/src/android/platform/helpers/SysuiRestarter.kt b/libraries/systemui-helper/src/android/platform/helpers/SysuiRestarter.kt
index af8f85d98..409f37ab7 100644
--- a/libraries/systemui-helper/src/android/platform/helpers/SysuiRestarter.kt
+++ b/libraries/systemui-helper/src/android/platform/helpers/SysuiRestarter.kt
@@ -24,22 +24,27 @@ import android.platform.uiautomator_helpers.DeviceHelpers.uiDevice
 import android.platform.uiautomator_helpers.DurationUtils.platformAdjust
 import androidx.test.uiautomator.By
 import com.android.app.tracing.traceSection
-import com.android.systemui.Flags.migrateClocksToBlueprint
+import com.android.systemui.Flags
 import java.time.Duration
-import java.util.regex.Pattern
 
 /** Restarts system ui. */
 object SysuiRestarter {
 
     private val sysuiProcessUtils = ProcessUtil(UI_PACKAGE_NAME_SYSUI)
 
-    // https://hsv.googleplex.com/5130837462876160?node=117
-    private val PAGE_TITLE_SELECTOR_PATTERN = if (migrateClocksToBlueprint()) {
-        Pattern.compile(String.format("com.android.systemui:id/%s", "keyguard_indication_area"))
-    } else {
-        Pattern.compile(String.format("com.android.systemui:id/%s", "keyguard_clock_container"))
-    }
-    private val PAGE_TITLE_SELECTOR = By.res(PAGE_TITLE_SELECTOR_PATTERN)
+    val LOCKSCREEN_SELECTOR =
+        if (Flags.sceneContainer()) {
+            By.res("element:lockscreen")
+        } else {
+            By.res(
+                "com.android.systemui",
+                if (Flags.migrateClocksToBlueprint()) {
+                    "keyguard_indication_area"
+                } else {
+                    "keyguard_clock_container"
+                }
+            )
+        }
 
     /**
      * Restart System UI by running `am crash com.android.systemui`.
@@ -72,7 +77,7 @@ object SysuiRestarter {
 
     private fun assertLockscreenVisibility(visible: Boolean, errorMessageProvider: () -> String) {
         uiDevice.assertVisibility(
-            PAGE_TITLE_SELECTOR,
+            LOCKSCREEN_SELECTOR,
             visible,
             timeout = Duration.ofSeconds(10).platformAdjust(),
             errorProvider = errorMessageProvider
diff --git a/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableDeviceController.kt b/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableDeviceController.kt
index 4729e45cf..815fb2fbe 100644
--- a/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableDeviceController.kt
+++ b/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableDeviceController.kt
@@ -57,6 +57,7 @@ internal class FoldableDeviceController {
     fun fold() {
         trace("FoldableDeviceController#fold") {
             printInstrumentationStatus(TAG, "Folding")
+            setHingeAngle(0f)
             setDeviceState(foldedState)
         }
     }
@@ -65,6 +66,7 @@ internal class FoldableDeviceController {
     fun unfold() {
         trace("FoldableDeviceController#unfold") {
             printInstrumentationStatus(TAG, "Unfolding")
+            setHingeAngle(180f)
             setDeviceState(unfoldedState)
         }
     }
@@ -73,6 +75,7 @@ internal class FoldableDeviceController {
     fun halfFold() {
         trace("FoldableDeviceController#halfFold") {
             printInstrumentationStatus(TAG, "Half-folding")
+            setHingeAngle(100f)
             setDeviceState(halfFoldedState)
         }
     }
diff --git a/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableRule.kt b/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableRule.kt
index 016644330..2a4fe4f4b 100644
--- a/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableRule.kt
+++ b/libraries/systemui-helper/src/android/platform/helpers/foldable/FoldableRule.kt
@@ -61,8 +61,14 @@ class FoldableRule(private val ensureScreenOn: Boolean = false) : TestWatcher()
         }
     }
 
+    /**
+     * Folds a foldable device
+     * @param turnOffDisplayAfterFold if true, then triggers the device to go to sleep
+     * @param ensureFinished if true, waits for the display switch to happen
+     *                       and for the fold animation to play
+     */
     @JvmOverloads
-    fun fold(turnOffDisplayAfterFold: Boolean = true) {
+    fun fold(turnOffDisplayAfterFold: Boolean = true, ensureFinished: Boolean = true) {
         trace("FoldableRule#fold") {
             check(!controller.isFolded) { "Trying to fold when already folded" }
             if (ensureScreenOn) {
@@ -75,6 +81,13 @@ class FoldableRule(private val ensureScreenOn: Boolean = false) : TestWatcher()
 
             if (turnOffDisplayAfterFold) {
                 uiDevice.sleep()
+            }
+
+            if (!ensureFinished) {
+                return
+            }
+
+            if (turnOffDisplayAfterFold) {
                 SystemClock.sleep(ANIMATION_TIMEOUT) // Wait for fold + screen off animations
                 ensureThat("screen is off after folding") { !screenOn }
             } else {
diff --git a/libraries/systemui-helper/src/android/platform/helpers/foldable/SensorInjectionController.kt b/libraries/systemui-helper/src/android/platform/helpers/foldable/SensorInjectionController.kt
index 1572edfa6..c60bd7a10 100644
--- a/libraries/systemui-helper/src/android/platform/helpers/foldable/SensorInjectionController.kt
+++ b/libraries/systemui-helper/src/android/platform/helpers/foldable/SensorInjectionController.kt
@@ -17,9 +17,10 @@
 package android.platform.helpers.foldable
 
 import android.hardware.SensorManager
+import android.hardware.SensorManager.HAL_BYPASS_REPLAY_DATA_INJECTION
 import android.platform.test.rule.TestWatcher
-import kotlin.properties.Delegates.notNull
 import org.junit.Assume
+import kotlin.properties.Delegates.notNull
 
 /**
  * Allows to inject values to a sensor. Assumes that sensor injection is supported. Note that
@@ -37,7 +38,8 @@ class SensorInjectionController(sensorType: Int) : TestWatcher() {
     fun init() {
         executeShellCommand(SENSOR_SERVICE_ENABLE)
         executeShellCommand(SENSOR_SERVICE_DATA_INJECTION + context.packageName)
-        injectionSupported = sensorManager.initDataInjection(true)
+        injectionSupported = sensorManager.initDataInjection(true,
+            HAL_BYPASS_REPLAY_DATA_INJECTION)
         initialized = true
     }
 
@@ -65,6 +67,6 @@ class SensorInjectionController(sensorType: Int) : TestWatcher() {
 
     companion object {
         private const val SENSOR_SERVICE_ENABLE = "dumpsys sensorservice enable"
-        private const val SENSOR_SERVICE_DATA_INJECTION = "dumpsys sensorservice data_injection "
+        private const val SENSOR_SERVICE_DATA_INJECTION = "dumpsys sensorservice hal_bypass_replay_data_injection "
     }
 }
diff --git a/libraries/uiautomator-helpers/src/android/platform/uiautomator_helpers/DeviceHelpers.kt b/libraries/uiautomator-helpers/src/android/platform/uiautomator_helpers/DeviceHelpers.kt
index 9971e426e..f2bfa6332 100644
--- a/libraries/uiautomator-helpers/src/android/platform/uiautomator_helpers/DeviceHelpers.kt
+++ b/libraries/uiautomator-helpers/src/android/platform/uiautomator_helpers/DeviceHelpers.kt
@@ -16,12 +16,12 @@
 
 package android.platform.uiautomator_helpers
 
-import android.os.SystemClock.uptimeMillis
 import android.animation.TimeInterpolator
 import android.app.Instrumentation
 import android.content.Context
 import android.graphics.PointF
 import android.os.Bundle
+import android.os.SystemClock.uptimeMillis
 import android.platform.uiautomator_helpers.TracingUtils.trace
 import android.platform.uiautomator_helpers.WaitUtils.ensureThat
 import android.platform.uiautomator_helpers.WaitUtils.waitFor
@@ -60,7 +60,7 @@ object DeviceHelpers {
      */
     @Deprecated(
         "Use [DeviceHelpers.waitForObj] instead.",
-        ReplaceWith("DeviceHelpers.waitForObj(selector, timeout, errorProvider)")
+        ReplaceWith("DeviceHelpers.waitForObj(selector, timeout, errorProvider)"),
     )
     fun UiDevice.waitForObj(
         selector: BySelector,
@@ -82,6 +82,26 @@ object DeviceHelpers {
     ): UiObject2 =
         waitFor("$selector object", timeout, errorProvider) { uiDevice.findObject(selector) }
 
+    /**
+     * Waits for an object that satisfies on the many possible [selectors] and returns it along with
+     * the matching selector.
+     *
+     * Throws an error with message provided by [errorProvider] if the object is not found.
+     */
+    fun waitForFirstObj(
+        vararg selectors: BySelector,
+        timeout: Duration = SHORT_WAIT,
+        errorProvider: () -> String = { "No object found for any $selectors" },
+    ): Pair<UiObject2, BySelector> {
+        return waitFor("$selectors objects", timeout, errorProvider) {
+                selectors.firstNotNullOfOrNull { selector ->
+                    uiDevice.findObject(selector)?.let {
+                        it to selector
+                    }
+                }
+            }
+    }
+
     /**
      * Waits for an object to be visible and returns it.
      *
@@ -93,12 +113,32 @@ object DeviceHelpers {
         errorProvider: () -> String = { "Object $selector not found" },
     ): UiObject2 = waitFor("$selector object", timeout, errorProvider) { findObject(selector) }
 
+    /**
+     * Waits for an object that satisfies on the many possible [selectors] and returns it along with
+     * the matching selector.
+     *
+     * Throws an error with message provided by [errorProvider] if the object is not found.
+     */
+    fun UiObject2.waitForFirstObj(
+        vararg selectors: BySelector,
+        timeout: Duration = SHORT_WAIT,
+        errorProvider: () -> String = { "No object found for any $selectors" },
+    ): Pair<UiObject2, BySelector> {
+        return waitFor("$selectors objects", timeout, errorProvider) {
+            selectors.firstNotNullOfOrNull { selector ->
+                findObject(selector)?.let {
+                    it to selector
+                }
+            }
+        }
+    }
+
     /**
      * Waits for an object to be visible and returns it. Returns `null` if the object is not found.
      */
     @Deprecated(
         "Use [DeviceHelpers.waitForNullableObj] instead.",
-        ReplaceWith("DeviceHelpers.waitForNullableObj(selector, timeout)")
+        ReplaceWith("DeviceHelpers.waitForNullableObj(selector, timeout)"),
     )
     fun UiDevice.waitForNullableObj(
         selector: BySelector,
@@ -108,10 +148,7 @@ object DeviceHelpers {
     /**
      * Waits for an object to be visible and returns it. Returns `null` if the object is not found.
      */
-    fun waitForNullableObj(
-        selector: BySelector,
-        timeout: Duration = SHORT_WAIT,
-    ): UiObject2? =
+    fun waitForNullableObj(selector: BySelector, timeout: Duration = SHORT_WAIT): UiObject2? =
         waitForNullable("nullable $selector objects", timeout) { uiDevice.findObject(selector) }
 
     /**
@@ -130,8 +167,8 @@ object DeviceHelpers {
         "Use DeviceHelpers.waitForPossibleEmpty",
         ReplaceWith(
             "waitForPossibleEmpty(selector, timeout)",
-            "android.platform.uiautomator_helpers.DeviceHelpers.waitForPossibleEmpty"
-        )
+            "android.platform.uiautomator_helpers.DeviceHelpers.waitForPossibleEmpty",
+        ),
     )
     fun waitForNullableObjects(
         selector: BySelector,
@@ -154,7 +191,7 @@ object DeviceHelpers {
      */
     @Deprecated(
         "Use DeviceHelpers.waitForNullableObjects",
-        ReplaceWith("DeviceHelpers.waitForNullableObjects(selector, timeout)")
+        ReplaceWith("DeviceHelpers.waitForNullableObjects(selector, timeout)"),
     )
     fun UiDevice.waitForNullableObjects(
         selector: BySelector,
@@ -162,9 +199,8 @@ object DeviceHelpers {
     ): List<UiObject2>? = DeviceHelpers.waitForNullableObjects(selector, timeout)
 
     /** Returns [true] when the [selector] is visible. */
-    fun hasObject(
-        selector: BySelector,
-    ): Boolean = trace("Checking if device has $selector") { uiDevice.hasObject(selector) }
+    fun hasObject(selector: BySelector): Boolean =
+        trace("Checking if device has $selector") { uiDevice.hasObject(selector) }
 
     /** Finds an object with this selector and clicks on it. */
     fun BySelector.click() {
@@ -181,7 +217,7 @@ object DeviceHelpers {
     @JvmStatic
     @Deprecated(
         "Use DeviceHelpers.assertVisibility directly",
-        ReplaceWith("DeviceHelpers.assertVisibility(selector, visible, timeout, errorProvider)")
+        ReplaceWith("DeviceHelpers.assertVisibility(selector, visible, timeout, errorProvider)"),
     )
     fun UiDevice.assertVisibility(
         selector: BySelector,
@@ -230,7 +266,7 @@ object DeviceHelpers {
         ensureThat(
             "$selector is ${visible.asVisibilityBoolean()} inside $this",
             timeout,
-            errorProvider
+            errorProvider,
         ) {
             hasObject(selector) == visible
         }
@@ -239,13 +275,13 @@ object DeviceHelpers {
     /** Asserts that a this selector is visible. Throws otherwise. */
     fun BySelector.assertVisible(
         timeout: Duration = LONG_WAIT,
-        errorProvider: (() -> String)? = null
+        errorProvider: (() -> String)? = null,
     ) {
         uiDevice.assertVisibility(
             selector = this,
             visible = true,
             timeout = timeout,
-            errorProvider = errorProvider
+            errorProvider = errorProvider,
         )
     }
 
@@ -254,13 +290,13 @@ object DeviceHelpers {
     @JvmOverloads
     fun BySelector.assertInvisible(
         timeout: Duration = LONG_WAIT,
-        errorProvider: (() -> String)? = null
+        errorProvider: (() -> String)? = null,
     ) {
         uiDevice.assertVisibility(
             selector = this,
             visible = false,
             timeout = timeout,
-            errorProvider = errorProvider
+            errorProvider = errorProvider,
         )
     }
 
@@ -312,14 +348,14 @@ object DeviceHelpers {
     @JvmStatic
     @Deprecated(
         "Use DeviceHelpers.betterSwipe directly",
-        ReplaceWith("DeviceHelpers.betterSwipe(startX, startY, endX, endY, interpolator)")
+        ReplaceWith("DeviceHelpers.betterSwipe(startX, startY, endX, endY, interpolator)"),
     )
     fun UiDevice.betterSwipe(
         startX: Int,
         startY: Int,
         endX: Int,
         endY: Int,
-        interpolator: TimeInterpolator = FLING_GESTURE_INTERPOLATOR
+        interpolator: TimeInterpolator = FLING_GESTURE_INTERPOLATOR,
     ) {
         DeviceHelpers.betterSwipe(startX, startY, endX, endY, interpolator)
     }
@@ -336,12 +372,12 @@ object DeviceHelpers {
         startY: Int,
         endX: Int,
         endY: Int,
-        interpolator: TimeInterpolator = FLING_GESTURE_INTERPOLATOR
+        interpolator: TimeInterpolator = FLING_GESTURE_INTERPOLATOR,
     ) {
         trace("Swiping ($startX,$startY) -> ($endX,$endY)") {
             BetterSwipe.from(PointF(startX.toFloat(), startY.toFloat()))
-                    .to(PointF(endX.toFloat(), endY.toFloat()), interpolator = interpolator)
-                    .release()
+                .to(PointF(endX.toFloat(), endY.toFloat()), interpolator = interpolator)
+                .release()
         }
     }
 
diff --git a/scripts/perf-setup/Android.bp b/scripts/perf-setup/Android.bp
new file mode 100644
index 000000000..77b5d8ed0
--- /dev/null
+++ b/scripts/perf-setup/Android.bp
@@ -0,0 +1,91 @@
+//
+// Copyright (C) 2016 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+// Rules to generate setup script for device perf tests
+// Different devices may share the same script. To add a new script, define a
+// new variable named <device name>_script, pointing at the script in current
+// source folder.
+// At execution time, scripts will be pushed onto device and run with root
+// identity.
+
+// Only define the target if a perf setup script is defined by the BoardConfig
+// of the device we are building.
+//
+// To add a new script:
+// 1. add a new setup script suitable for the device at:
+//    platform_testing/scripts/perf-setup/
+// 2. modify BoardConfig.mk of the corresponding device under:
+//    device/<OEM name>/<device name/
+// 3. add variable "BOARD_PERFSETUP_SCRIPT", and point it at the path to the new
+//    perf setup script; the path should be relative to the build root
+// 4. add below soong config setting below the line added on step 3:
+//    $(call soong_config_set,perf,board_perfsetup_script,$(notdir $(BOARD_PERFSETUP_SCRIPT)))
+
+package {
+    // See: http://go/android-license-faq
+    default_applicable_licenses: [
+        "Android-Apache-2.0",
+    ],
+    default_team: "trendy_team_performance",
+}
+
+soong_config_module_type {
+    name: "perf_script_filegroup",
+    module_type: "filegroup",
+    config_namespace: "perf",
+    value_variables: [
+        "board_perfsetup_script",
+    ],
+    properties: [
+        "srcs",
+    ],
+}
+
+perf_script_filegroup {
+    name: "perf-setup-script",
+    soong_config_variables: {
+        board_perfsetup_script: {
+            srcs: ["%s"],
+            conditions_default: {
+                srcs: ["empty-setup.sh"],
+            },
+        },
+    },
+}
+
+sh_test {
+    name: "perf-setup",
+    src: ":perf-setup-script",
+    filename: "perf-setup.sh",
+    test_suites: [
+        "device-tests",
+        "device-pixel-tests",
+    ],
+    auto_gen_config: false,
+    product_variables: {
+        debuggable: {
+            required: [
+                "perf-setup-sh",
+            ],
+        },
+    },
+}
+
+sh_binary {
+    name: "perf-setup-sh",
+    src: ":perf-setup-script",
+    filename: "perf-setup.sh",
+    soc_specific: true,
+}
diff --git a/scripts/perf-setup/Android.mk b/scripts/perf-setup/Android.mk
deleted file mode 100644
index ff2289c7d..000000000
--- a/scripts/perf-setup/Android.mk
+++ /dev/null
@@ -1,54 +0,0 @@
-#
-# Copyright (C) 2016 The Android Open Source Project
-#
-# Licensed under the Apache License, Version 2.0 (the "License");
-# you may not use this file except in compliance with the License.
-# You may obtain a copy of the License at
-#
-#      http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing, software
-# distributed under the License is distributed on an "AS IS" BASIS,
-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-# See the License for the specific language governing permissions and
-# limitations under the License.
-
-
-# Rules to generate setup script for device perf tests
-# Different devices may share the same script. To add a new script, define a
-# new variable named <device name>_script, pointing at the script in current
-# source folder.
-# At execution time, scripts will be pushed onto device and run with root
-# identity
-
-LOCAL_PATH:= $(call my-dir)
-
-# only define the target if a perf setup script is defined by the BoardConfig
-# of the device we are building.
-#
-# To add a new script:
-# 1. add a new setup script suitable for the device at:
-#    platform_testing/scripts/perf-setup/
-# 2. modify BoardConfig.mk of the corresponding device under:
-#    device/<OEM name>/<device name/
-# 3. add variable "BOARD_PERFSETUP_SCRIPT", and point it at the path to the new
-#    perf setup script; the path should be relative to the build root
-ifeq ($(strip $(BOARD_PERFSETUP_SCRIPT)),)
-perfsetup_script := platform_testing/scripts/perf-setup/empty-setup.sh
-else
-perfsetup_script := $(BOARD_PERFSETUP_SCRIPT)
-endif
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := perf-setup
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := EXECUTABLES
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_MODULE_STEM := perf-setup.sh
-LOCAL_PREBUILT_MODULE_FILE := $(perfsetup_script)
-LOCAL_COMPATIBILITY_SUITE := device-tests
-include $(BUILD_PREBUILT)
-
-perfsetup_script :=
diff --git a/scripts/perfetto-setup/Android.mk b/scripts/perfetto-setup/Android.mk
deleted file mode 100644
index d63a62083..000000000
--- a/scripts/perfetto-setup/Android.mk
+++ /dev/null
@@ -1,146 +0,0 @@
-#
-# Copyright (C) 2019 The Android Open Source Project
-#
-# Licensed under the Apache License, Version 2.0 (the "License");
-# you may not use this file except in compliance with the License.
-# You may obtain a copy of the License at
-#
-#      http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing, software
-# distributed under the License is distributed on an "AS IS" BASIS,
-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-# See the License for the specific language governing permissions and
-# limitations under the License.
-
-LOCAL_PATH:= $(call my-dir)
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_detailed.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_detailed.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := long_trace_config.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/long_trace_config.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := long_trace_binder_config.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/long_trace_binder_config.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_experimental.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_experimental.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_multi_user_cuj_tests.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_multi_user_cuj_tests.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_multi_user.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := frameworks/base/apct-tests/perftests/multiuser/trace_configs/trace_config_multi_user.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_detailed_heapdump.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_detailed_heapdump.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_post_boot.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_post_boot.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_power.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_power.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_boot_time.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_boot_time.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := trace_config_boot_time_stop.textproto
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := ETC
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/configs/trace_config_boot_time_stop.textproto
-include $(BUILD_PREBUILT)
-
-include $(CLEAR_VARS)
-LOCAL_MODULE := perfetto_trace_processor_shell
-LOCAL_LICENSE_KINDS := SPDX-license-identifier-Apache-2.0
-LOCAL_LICENSE_CONDITIONS := notice
-LOCAL_MODULE_CLASS := EXECUTABLES
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_PATH := $(TARGET_OUT_DATA)/local/tmp
-LOCAL_CHECK_ELF_FILES := false
-LOCAL_PREBUILT_MODULE_FILE := prebuilts/tools/linux-x86_64/perfetto/trace_processor_shell
-include $(BUILD_PREBUILT)
diff --git a/tests/automotive/functional/home/src/android/platform/tests/HomeTest.java b/tests/automotive/functional/home/src/android/platform/tests/HomeTest.java
index a4591d08e..9530e1bd9 100644
--- a/tests/automotive/functional/home/src/android/platform/tests/HomeTest.java
+++ b/tests/automotive/functional/home/src/android/platform/tests/HomeTest.java
@@ -54,4 +54,10 @@ public class HomeTest {
     public void testTempetraureWidget() {
         assertTrue("Driver temperature is not displayed", mHomeHelper.get().hasTemperatureWidget());
     }
+
+    @Test
+    public void testHvacPanel() {
+        mHomeHelper.get().openHVAC();
+        assertTrue("HVAC panel is not opened", mHomeHelper.get().isHVACOpen());
+    }
 }
diff --git a/tests/automotive/functional/home/src/android/platform/tests/SystemUiTest.java b/tests/automotive/functional/home/src/android/platform/tests/SystemUiTest.java
index 53f916835..bd5e12f1a 100644
--- a/tests/automotive/functional/home/src/android/platform/tests/SystemUiTest.java
+++ b/tests/automotive/functional/home/src/android/platform/tests/SystemUiTest.java
@@ -21,20 +21,15 @@ import static junit.framework.Assert.assertTrue;
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoFacetBarHelper;
 import android.platform.helpers.IAutoHomeHelper;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.Before;
-import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 @RunWith(AndroidJUnit4.class)
 public class SystemUiTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private HelperAccessor<IAutoHomeHelper> mHomeHelper;
     private HelperAccessor<IAutoFacetBarHelper> mFacetBarHelper;
@@ -50,7 +45,6 @@ public class SystemUiTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testSystemUi() {
         mHomeHelper.get().openSystemUi();
         assertTrue("Maps widget is not displayed", mHomeHelper.get().hasMapsWidget());
diff --git a/tests/automotive/functional/locationstatusbar/Android.bp b/tests/automotive/functional/locationstatusbar/Android.bp
index 687316387..8d64501e7 100644
--- a/tests/automotive/functional/locationstatusbar/Android.bp
+++ b/tests/automotive/functional/locationstatusbar/Android.bp
@@ -24,6 +24,7 @@ android_test {
         "androidx.test.rules",
         "automotive-settings-app-helper",
         "app-helpers-auto-interfaces",
+        "com_android_car_settings_flags_lib",
         "platform-test-junit-rules",
         "platform-test-options",
     ],
diff --git a/tests/automotive/functional/locationstatusbar/src/android/platform/tests/SettingsLocationTest.java b/tests/automotive/functional/locationstatusbar/src/android/platform/tests/SettingsLocationTest.java
index 9a8d1e92a..b74ffda78 100644
--- a/tests/automotive/functional/locationstatusbar/src/android/platform/tests/SettingsLocationTest.java
+++ b/tests/automotive/functional/locationstatusbar/src/android/platform/tests/SettingsLocationTest.java
@@ -16,26 +16,34 @@
 
 package android.platform.tests;
 
-import static junit.framework.Assert.assertFalse;
 import static junit.framework.Assert.assertTrue;
 
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.helpers.IAutoSettingsLocationHelper;
 import android.platform.helpers.SettingsConstants;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.SetFlagsRule;
+import android.platform.test.rules.ConditionalIgnore;
+import android.platform.test.rules.ConditionalIgnoreRule;
+import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 @RunWith(AndroidJUnit4.class)
 public class SettingsLocationTest {
+    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private HelperAccessor<IAutoSettingsLocationHelper> mSettingLocationHelper;
     private HelperAccessor<IAutoSettingHelper> mSettingHelper;
 
+    @Rule public final SetFlagsRule mSetFlagsRule = new SetFlagsRule();
+
     public SettingsLocationTest() {
         mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
         mSettingLocationHelper = new HelperAccessor<>(IAutoSettingsLocationHelper.class);
@@ -49,15 +57,22 @@ public class SettingsLocationTest {
     }
 
     @Test
+    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
+    @RequiresFlagsEnabled(
+            com.android.car.settings.Flags.FLAG_REQUIRED_INFOTAINMENT_APPS_SETTINGS_PAGE)
     public void testToVerifyToggleLocation() {
         mSettingLocationHelper.get().locationAccess();
-        mSettingLocationHelper.get().isLocationOn();
-        assertFalse("Location widget is displayed ", mSettingLocationHelper.get().hasMapsWidget());
-        mSettingLocationHelper.get().toggleLocation(true);
+        boolean defaultState = mSettingLocationHelper.get().isLocationOn();
+        String widgetShownMessage = "Location widget is displayed ";
+        String widgetNotShownMessage = "Location widget is not displayed ";
+        mSettingLocationHelper.get().toggleLocation(!defaultState);
+        assertTrue(
+                defaultState ? widgetShownMessage : widgetNotShownMessage,
+                mSettingLocationHelper.get().hasMapsWidget() != defaultState);
+        mSettingLocationHelper.get().toggleLocation(defaultState);
         assertTrue(
-                "Location widget is not displayed ", mSettingLocationHelper.get().hasMapsWidget());
-        mSettingLocationHelper.get().toggleLocation(false);
-        assertFalse("Location widget is displayed ", mSettingLocationHelper.get().hasMapsWidget());
+                defaultState ? widgetShownMessage : widgetNotShownMessage,
+                mSettingLocationHelper.get().hasMapsWidget() == defaultState);
     }
 
     @Test
diff --git a/tests/automotive/functional/navigationbar/src/android/platform/tests/BrightnessPaletteTest.java b/tests/automotive/functional/navigationbar/src/android/platform/tests/BrightnessPaletteTest.java
index fd73ddbad..10ade2a65 100644
--- a/tests/automotive/functional/navigationbar/src/android/platform/tests/BrightnessPaletteTest.java
+++ b/tests/automotive/functional/navigationbar/src/android/platform/tests/BrightnessPaletteTest.java
@@ -20,21 +20,16 @@ import static junit.framework.Assert.assertTrue;
 
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoHomeHelper;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
 import org.junit.Before;
-import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 @RunWith(AndroidJUnit4.class)
 public class BrightnessPaletteTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private HelperAccessor<IAutoHomeHelper> mHomeHelper;
 
@@ -48,14 +43,12 @@ public class BrightnessPaletteTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testIfBrightnessPaletteExist() {
         assertTrue(
                 "Brightness palette did not open", mHomeHelper.get().hasDisplayBrightessPalette());
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testIfAdaptiveBrightnessSettingExist() {
         assertTrue("Adaptive brightness did not open", mHomeHelper.get().hasAdaptiveBrightness());
     }
diff --git a/tests/automotive/functional/notifications/src/android/platform/tests/NotificationTest.java b/tests/automotive/functional/notifications/src/android/platform/tests/NotificationTest.java
index df49c6648..7f6c82c11 100644
--- a/tests/automotive/functional/notifications/src/android/platform/tests/NotificationTest.java
+++ b/tests/automotive/functional/notifications/src/android/platform/tests/NotificationTest.java
@@ -22,21 +22,16 @@ import static junit.framework.Assert.assertTrue;
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoNotificationHelper;
 import android.platform.helpers.IAutoNotificationMockingHelper;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
 import org.junit.Before;
-import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 @RunWith(AndroidJUnit4.class)
 public class NotificationTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private HelperAccessor<IAutoNotificationHelper> mNotificationHelper;
     private HelperAccessor<IAutoNotificationMockingHelper> mNotificationMockingHelper;
@@ -86,7 +81,6 @@ public class NotificationTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testSwipeAwayNotification() {
         mNotificationHelper.get().tapClearAllBtn();
         mNotificationMockingHelper.get().postNotifications(1);
@@ -109,7 +103,6 @@ public class NotificationTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testRecentAndOlderNotifications() {
         mNotificationHelper.get().tapClearAllBtn();
         mNotificationMockingHelper.get().postNotifications(1);
diff --git a/tests/automotive/functional/profileiconlist/src/android/platform/tests/ProfileIconsListTest.java b/tests/automotive/functional/profileiconlist/src/android/platform/tests/ProfileIconsListTest.java
index 949303346..dc44795a8 100644
--- a/tests/automotive/functional/profileiconlist/src/android/platform/tests/ProfileIconsListTest.java
+++ b/tests/automotive/functional/profileiconlist/src/android/platform/tests/ProfileIconsListTest.java
@@ -23,13 +23,9 @@ import android.platform.helpers.IAutoHomeHelper;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.helpers.MultiUserHelper;
 import android.platform.scenario.multiuser.MultiUserConstants;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
-import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -37,7 +33,6 @@ import java.util.List;
 
 @RunWith(AndroidJUnit4.class)
 public class ProfileIconsListTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private static final String USER_NAME = MultiUserConstants.SECONDARY_USER_NAME;
 
@@ -58,7 +53,6 @@ public class ProfileIconsListTest {
      * <p>This method is used to compare profiles based on position.
      */
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testListOfProfiles() throws Exception {
         mMultiUserHelper.createUser(USER_NAME, false);
         mHomeHelper.get().openStatusBarProfiles();
diff --git a/tests/automotive/functional/settings/Android.bp b/tests/automotive/functional/settings/Android.bp
index d5394bd8b..af115fd86 100644
--- a/tests/automotive/functional/settings/Android.bp
+++ b/tests/automotive/functional/settings/Android.bp
@@ -31,6 +31,7 @@ android_test {
         "platform-test-options",
         "automotive-facet-bar-helper",
         "automotive-app-grid-helper",
+        "com_android_car_settings_flags_lib",
     ],
     srcs: ["src/**/*.java"],
     test_suites: [
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/BluetoothSettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/BluetoothSettingTest.java
new file mode 100644
index 000000000..ed5f891e9
--- /dev/null
+++ b/tests/automotive/functional/settings/src/android/platform/tests/BluetoothSettingTest.java
@@ -0,0 +1,56 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.platform.tests;
+
+import static junit.framework.Assert.assertTrue;
+
+import android.platform.helpers.HelperAccessor;
+import android.platform.helpers.IAutoBluetoothSettingsHelper;
+import android.platform.helpers.IAutoSettingHelper;
+import android.platform.helpers.SettingsConstants;
+
+import androidx.test.runner.AndroidJUnit4;
+
+import org.junit.After;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
+@RunWith(AndroidJUnit4.class)
+public class BluetoothSettingTest {
+    private HelperAccessor<IAutoBluetoothSettingsHelper> mBluetoothSettingHelper;
+    private HelperAccessor<IAutoSettingHelper> mSettingHelper;
+
+    public BluetoothSettingTest() throws Exception {
+        mBluetoothSettingHelper = new HelperAccessor<>(IAutoBluetoothSettingsHelper.class);
+        mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
+    }
+
+    @After
+    public void goBackToSettingsScreen() {
+        mSettingHelper.get().goBackToSettingsScreen();
+    }
+
+    @Test
+    public void testBluetoothDefaultState() {
+        mSettingHelper.get().openSetting(SettingsConstants.BLUETOOTH_SETTINGS);
+        assertTrue(
+                "Bluetooth default state is not turned on in the System",
+                mSettingHelper.get().isBluetoothOn());
+        assertTrue(
+                "Use Bluetooth toggle is not turned on in the Settings",
+                mBluetoothSettingHelper.get().isUseBluetoothToggleChecked());
+    }
+}
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/DateTimeSettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/DateTimeSettingTest.java
index 3b03f9d03..1748a8b10 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/DateTimeSettingTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/DateTimeSettingTest.java
@@ -18,11 +18,16 @@ package android.platform.tests;
 
 import static junit.framework.Assert.assertTrue;
 
+import static org.junit.Assume.assumeFalse;
+
+import android.app.time.Capabilities;
+import android.app.time.TimeManager;
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoDateTimeSettingsHelper;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.helpers.SettingsConstants;
 
+import androidx.test.platform.app.InstrumentationRegistry;
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
@@ -36,6 +41,7 @@ import java.time.LocalDate;
 public class DateTimeSettingTest {
     private HelperAccessor<IAutoDateTimeSettingsHelper> mDateTimeSettingsHelper;
     private HelperAccessor<IAutoSettingHelper> mSettingHelper;
+    private TimeManager mTimeManager;
 
     private static final boolean IS_AM = true;
     private static final int DEFAULT_WAIT_TIME = 5000;
@@ -54,45 +60,60 @@ public class DateTimeSettingTest {
     public DateTimeSettingTest() throws Exception {
         mDateTimeSettingsHelper = new HelperAccessor<>(IAutoDateTimeSettingsHelper.class);
         mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
+        mTimeManager =
+                InstrumentationRegistry.getInstrumentation()
+                        .getContext()
+                        .getSystemService(TimeManager.class);
     }
 
 
     @Before
     public void openDateTimeFacet() {
+        InstrumentationRegistry.getInstrumentation()
+                .getUiAutomation()
+                .adoptShellPermissionIdentity("android.permission.MANAGE_TIME_AND_ZONE_DETECTION");
         mSettingHelper.get().openSetting(SettingsConstants.DATE_AND_TIME_SETTINGS);
     }
 
     @After
     public void goBackToSettingsScreen() {
+        InstrumentationRegistry.getInstrumentation()
+                .getUiAutomation()
+                .dropShellPermissionIdentity();
         mSettingHelper.get().goBackToSettingsScreen();
     }
 
     @Test
     public void testSetDate() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         mDateTimeSettingsHelper.get().setDate(DATE);
         assertTrue(mDateTimeSettingsHelper.get().getDate().equals(DATE));
     }
 
     @Test
     public void testSetTimeTwelveHourFormat() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         mDateTimeSettingsHelper.get().setTimeInTwelveHourFormat(HOUR, MINUTE, IS_AM);
         assertTrue(mDateTimeSettingsHelper.get().getTime().matches(FULL_TIME_TWELVE_REGEX));
     }
 
     @Test
     public void testSetTimeTwentyFourHourFormat() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         mDateTimeSettingsHelper.get().setTimeInTwentyFourHourFormat(HOUR, MINUTE);
         assertTrue(mDateTimeSettingsHelper.get().getTime().equals(FULL_TIME_TWENTYFOUR));
     }
 
     @Test
     public void testSetTimeZone() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         mDateTimeSettingsHelper.get().setTimeZone(TIME_ZONE);
         assertTrue(mDateTimeSettingsHelper.get().getTimeZone().equals(TIME_ZONE_FULL));
     }
 
     @Test
     public void testSetTwentyFourHourFormat() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         if (!mDateTimeSettingsHelper.get().isTwentyFourHourFormatEnabled()) {
             mDateTimeSettingsHelper.get().toggleTwentyFourHourFormatSwitch();
         }
@@ -102,10 +123,28 @@ public class DateTimeSettingTest {
 
     @Test
     public void testSetTwelveHourFormat() {
+        assumeFalse(checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled());
         if (mDateTimeSettingsHelper.get().isTwentyFourHourFormatEnabled()) {
             mDateTimeSettingsHelper.get().toggleTwentyFourHourFormatSwitch();
         }
         String currentUiTime = mDateTimeSettingsHelper.get().getTime();
         assertTrue(currentUiTime.indexOf("AM") != -1 || currentUiTime.indexOf("PM") != -1);
     }
+
+    private boolean checkCapabilitiesNotPossessedAndAutoLocalTimeEnabled() {
+        return (mTimeManager.getTimeCapabilitiesAndConfig()
+                                        .getCapabilities()
+                                        .getConfigureAutoDetectionEnabledCapability()
+                                != Capabilities.CAPABILITY_POSSESSED
+                        && mTimeManager.getTimeCapabilitiesAndConfig()
+                                .getConfiguration()
+                                .isAutoDetectionEnabled())
+                || (mTimeManager.getTimeZoneCapabilitiesAndConfig()
+                                        .getCapabilities()
+                                        .getConfigureAutoDetectionEnabledCapability()
+                                != Capabilities.CAPABILITY_POSSESSED
+                        && mTimeManager.getTimeZoneCapabilitiesAndConfig()
+                                .getConfiguration()
+                                .isAutoDetectionEnabled());
+    }
 }
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/DisplaySettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/DisplaySettingTest.java
index 2cd30be5e..61da94f5f 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/DisplaySettingTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/DisplaySettingTest.java
@@ -23,15 +23,10 @@ import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoDisplaySettingsHelper;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.helpers.SettingsConstants;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
-import org.junit.Rule;
 import org.junit.Test;
 
 public class DisplaySettingTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private final HelperAccessor<IAutoSettingHelper> mSettingHelper;
     private HelperAccessor<IAutoDisplaySettingsHelper> mDisplaySettingsHelper;
@@ -64,7 +59,6 @@ public class DisplaySettingTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testAdaptiveBrightnessDefaultValue() {
         mSettingHelper.get().openSetting(SettingsConstants.DISPLAY_SETTINGS);
         assertTrue(
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/MicroPhoneSettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/MicroPhoneSettingTest.java
index 4bea7ea5c..6c2b14e55 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/MicroPhoneSettingTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/MicroPhoneSettingTest.java
@@ -24,11 +24,14 @@ import android.platform.helpers.IAutoFacetBarHelper;
 import android.platform.helpers.IAutoPrivacySettingsHelper;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.helpers.SettingsConstants;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.SetFlagsRule;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -40,6 +43,7 @@ public class MicroPhoneSettingTest {
     private HelperAccessor<IAutoFacetBarHelper> mFacetBarHelper;
     private HelperAccessor<IAutoSettingHelper> mSettingHelper;
     private HelperAccessor<IAutoPrivacySettingsHelper> mPrivacySettingsHelper;
+    @Rule public final SetFlagsRule mSetFlagsRule = new SetFlagsRule();
 
     public MicroPhoneSettingTest() throws Exception {
         mFacetBarHelper = new HelperAccessor<>(IAutoFacetBarHelper.class);
@@ -47,7 +51,6 @@ public class MicroPhoneSettingTest {
         mPrivacySettingsHelper = new HelperAccessor<>(IAutoPrivacySettingsHelper.class);
     }
 
-
     @Before
     public void openPrivacySetting() {
         mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
@@ -57,10 +60,27 @@ public class MicroPhoneSettingTest {
         mSettingHelper.get().openMenuWith("MicroPhone");
         assertTrue(
                 "MicroPhone settings did not open",
-                mSettingHelper.get().checkMenuExists("Use microphone"));
+                mSettingHelper.get().checkMenuExists("Microphone access"));
+        mSettingHelper.get().openMenuWith("Microphone access");
+        assertTrue(
+                "MicroPhone access did not open",
+                mSettingHelper.get().checkMenuExists("Infotainment apps"));
+    }
+
+    @After
+    public void goBackToSettingsScreen() {
+        mSettingHelper.get().goBackToSettingsScreen();
+        mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
+        mSettingHelper.get().openMenuWith("MicroPhone");
+        mSettingHelper.get().openMenuWith("Microphone access");
+        // MicroPhone is on by default
+        if (!mPrivacySettingsHelper.get().isMicroPhoneOn()) {
+            mPrivacySettingsHelper.get().turnOnOffMicroPhone(true);
+        }
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void manageMicrophonePermissions() {
         mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
         assertTrue(
@@ -73,22 +93,15 @@ public class MicroPhoneSettingTest {
                 mPrivacySettingsHelper.get().verifyMicrophoneManagePermissionsPage());
     }
 
-    @After
-    public void goBackToSettingsScreen() {
-        mSettingHelper.get().goBackToSettingsScreen();
-        mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
-        mSettingHelper.get().openMenuWith("MicroPhone");
-        // MicroPhone is on by default
-        if (!mPrivacySettingsHelper.get().isMicroPhoneOn()) {
-            mPrivacySettingsHelper.get().turnOnOffMicroPhone(true);
-        }
-    }
-
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhoneToggleOff() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
         assertFalse("MicroPhone is still on", mPrivacySettingsHelper.get().isMicroPhoneOn());
+        mSettingHelper.get().goBackToSettingsScreen();
+        mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
+        mSettingHelper.get().openMenuWith("MicroPhone");
         assertFalse(
                 "Recent apps is displayed",
                 mSettingHelper.get().checkMenuExists("Recently accessed"));
@@ -98,12 +111,16 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhoneToggleOn() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
         // turn on microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(true);
         assertTrue("MicroPhone is still off", mPrivacySettingsHelper.get().isMicroPhoneOn());
+        mSettingHelper.get().goBackToSettingsScreen();
+        mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
+        mSettingHelper.get().openMenuWith("MicroPhone");
         assertTrue(
                 "Recently accessed is not present",
                 mSettingHelper.get().checkMenuExists("Recently accessed"));
@@ -116,6 +133,7 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhonePanelStatusBar() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
@@ -133,6 +151,7 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhonePanelStatusBarFromHome() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
@@ -148,6 +167,7 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhonePanelSettingsLink() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
@@ -161,6 +181,7 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
     public void testMicroPhonePanelToggle() {
         // turn off microphone
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
@@ -182,7 +203,8 @@ public class MicroPhoneSettingTest {
     }
 
     @Test
-    public void testMicroPhoneButtonDimiss() {
+    @RequiresFlagsEnabled(com.android.car.settings.Flags.FLAG_MICROPHONE_PRIVACY_UPDATES)
+    public void testMicroPhoneButtonDismiss() {
         mPrivacySettingsHelper.get().turnOnOffMicroPhone(false);
         mPrivacySettingsHelper.get().clickMicroPhoneStatusBar();
         // turn microphone on
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingTest.java
index f5a45bb37..d45f68019 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingTest.java
@@ -19,9 +19,11 @@ package android.platform.tests;
 import static junit.framework.Assert.assertFalse;
 import static junit.framework.Assert.assertTrue;
 
+import android.platform.helpers.AutomotiveConfigConstants;
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoPrivacySettingsHelper;
 import android.platform.helpers.IAutoSettingHelper;
+import android.platform.helpers.IAutoUISettingsHelper;
 import android.platform.helpers.SettingsConstants;
 
 import androidx.test.runner.AndroidJUnit4;
@@ -35,10 +37,12 @@ import org.junit.runner.RunWith;
 public class PrivacySettingTest {
     private HelperAccessor<IAutoSettingHelper> mSettingHelper;
     private HelperAccessor<IAutoPrivacySettingsHelper> mPrivacySettingsHelper;
+    private HelperAccessor<IAutoUISettingsHelper> mSettingsUIHelper;
 
     public PrivacySettingTest() throws Exception {
         mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
         mPrivacySettingsHelper = new HelperAccessor<>(IAutoPrivacySettingsHelper.class);
+        mSettingsUIHelper = new HelperAccessor<>(IAutoUISettingsHelper.class);
     }
 
     @Before
@@ -46,7 +50,7 @@ public class PrivacySettingTest {
         mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
         assertTrue(
                 "Privacy settings did not open",
-                mSettingHelper.get().checkMenuExists("Microphone"));
+                mSettingsUIHelper.get().hasUIElement(AutomotiveConfigConstants.MICROPHONE));
     }
 
     @After
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingVerifyUIElementsTest.java b/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingVerifyUIElementsTest.java
index 72b6e99d0..0fabff2c7 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingVerifyUIElementsTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/PrivacySettingVerifyUIElementsTest.java
@@ -47,7 +47,7 @@ public class PrivacySettingVerifyUIElementsTest {
         mSettingHelper.get().openSetting(SettingsConstants.PRIVACY_SETTINGS);
         assertTrue(
                 "Privacy settings did not open",
-                mSettingHelper.get().checkMenuExists("Microphone"));
+                mSettingsUIHelper.get().hasUIElement(AutomotiveConfigConstants.MICROPHONE));
     }
 
     @After
@@ -64,7 +64,7 @@ public class PrivacySettingVerifyUIElementsTest {
         mSettingsUIHelper.get().openUIOptions(AutomotiveConfigConstants.MICROPHONE);
         assertTrue(
                 "Microphone settings did not open",
-                mSettingHelper.get().checkMenuExists("Use microphone"));
+                mSettingHelper.get().checkMenuExists("Microphone"));
         String currentTitle = mSettingHelper.get().getPageTitleText();
         mSettingsUIHelper.get().pressBackButton();
         String newTitle = mSettingHelper.get().getPageTitleText();
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/SettingSearchTest.java b/tests/automotive/functional/settings/src/android/platform/tests/SettingSearchTest.java
index ee57f32d2..b796469d7 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/SettingSearchTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/SettingSearchTest.java
@@ -21,22 +21,17 @@ import static junit.framework.Assert.assertTrue;
 import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoSettingHelper;
 import android.platform.test.option.StringOption;
-import android.platform.test.rules.ConditionalIgnore;
-import android.platform.test.rules.ConditionalIgnoreRule;
-import android.platform.test.rules.IgnoreOnPortrait;
 
 import androidx.test.runner.AndroidJUnit4;
 
 import org.junit.After;
 import org.junit.Before;
 import org.junit.ClassRule;
-import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
 @RunWith(AndroidJUnit4.class)
 public class SettingSearchTest {
-    @Rule public ConditionalIgnoreRule rule = new ConditionalIgnoreRule();
 
     private static final String SEARCH_APP = "search-app";
     private static final String SEARCH_SETTING = "search-setting";
@@ -68,7 +63,6 @@ public class SettingSearchTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testSearchApplication() {
         String searchApp = SEARCH_DEFAULT_APP;
         if (mSearchApp != null && mSearchApp.get() != null && !mSearchApp.get().isEmpty()) {
@@ -81,7 +75,6 @@ public class SettingSearchTest {
     }
 
     @Test
-    @ConditionalIgnore(condition = IgnoreOnPortrait.class)
     public void testSearchSetting() {
         String searchSetting = SEARCH_DEFAULT_SETTING;
         if (mSearchSetting != null
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingTest.java b/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingTest.java
index 61ab6dbf6..f73367b9d 100644
--- a/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingTest.java
+++ b/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingTest.java
@@ -67,9 +67,14 @@ public class SystemSettingTest {
     @Test
     public void testAndroidVersion() {
         String androidVersion = android.os.Build.VERSION.RELEASE;
+        String androidVersionCodename = android.os.Build.VERSION.RELEASE_OR_CODENAME;
         assertTrue(
                 "Android Version from API and Android Version from UI are not the same",
-                mSystemSettingsHelper.get().getAndroidVersion().endsWith(androidVersion));
+                mSystemSettingsHelper.get().getAndroidVersion().endsWith(androidVersion)
+                        || mSystemSettingsHelper
+                                .get()
+                                .getAndroidVersion()
+                                .endsWith(androidVersionCodename));
     }
 
     @Test
diff --git a/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingVerifyUIElementsTest.java b/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingVerifyUIElementsTest.java
new file mode 100644
index 000000000..7059e63d4
--- /dev/null
+++ b/tests/automotive/functional/settings/src/android/platform/tests/SystemSettingVerifyUIElementsTest.java
@@ -0,0 +1,110 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.tests;
+
+import static junit.framework.Assert.assertTrue;
+
+import android.platform.helpers.AutomotiveConfigConstants;
+import android.platform.helpers.HelperAccessor;
+import android.platform.helpers.IAutoSettingHelper;
+import android.platform.helpers.IAutoSystemSettingsHelper;
+import android.platform.helpers.IAutoUISettingsHelper;
+import android.platform.helpers.SettingsConstants;
+
+import androidx.test.runner.AndroidJUnit4;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
+@RunWith(AndroidJUnit4.class)
+public class SystemSettingVerifyUIElementsTest {
+    private HelperAccessor<IAutoSettingHelper> mSettingHelper;
+    private HelperAccessor<IAutoUISettingsHelper> mSettingsUIHelper;
+
+    public SystemSettingVerifyUIElementsTest() throws Exception {
+        mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
+        mSettingsUIHelper = new HelperAccessor<>(IAutoUISettingsHelper.class);
+    }
+
+    @Before
+    public void openSystemFacet() {
+        mSettingHelper.get().openSetting(SettingsConstants.SYSTEM_SETTINGS);
+        assertTrue(
+                "System settings did not open",
+                mSettingHelper.get().checkMenuExists("Languages & input"));
+    }
+
+    @After
+    public void goBackToSettingsScreen() {
+        mSettingHelper.get().goBackToSettingsScreen();
+    }
+
+    @Test
+    public void testLanguagesinputSystemSettings() {
+        mSettingsUIHelper.get().openUIOptions(AutomotiveConfigConstants.LANGUAGES_INPUT_IN_SYSTEM);
+
+        assertTrue(
+                "Languages displayed in Languages & input",
+                mSettingsUIHelper.get().hasUIElement(AutomotiveConfigConstants.LANGUAGES_MENU));
+        assertTrue(
+                "Autofill service displayed in Languages & input",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(
+                                AutomotiveConfigConstants
+                                        .LANGUAGE_SYSTEM_SETTINGS_AUTOFILL_SERVICE));
+        assertTrue(
+                "Keyboard service displayed in Languages & input",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(AutomotiveConfigConstants.LANGUAGE_SYSTEM_SETTINGS_KEYBOARD));
+        assertTrue(
+                "Text to speechoutput displayed in Languages & input",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(
+                                AutomotiveConfigConstants
+                                        .LANGUAGE_SYSTEM_SETTINGS_TEXT_TO_SPEECH_OUTPUT));
+    }
+
+    @Test
+    public void testUnitSystemSettings() {
+        mSettingsUIHelper.get().openUIOptions(AutomotiveConfigConstants.SYSTEM_SETTINGS_UNITS);
+        assertTrue(
+                "Speed displayed in Units",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(AutomotiveConfigConstants.UNIT_SYSTEM_SETTINGS_SPEED));
+        assertTrue(
+                "Distance displayed in Units",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(AutomotiveConfigConstants.UNIT_SYSTEM_SETTINGS_DISTANCE));
+        assertTrue(
+                "Temperature displayed in Units",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(AutomotiveConfigConstants.UNIT_SYSTEM_SETTINGS_TEMPERATURE));
+        assertTrue(
+                "Pressure displayed in Units",
+                mSettingsUIHelper
+                        .get()
+                        .hasUIElement(AutomotiveConfigConstants.UNIT_SYSTEM_SETTINGS_PRESSURE));
+    }
+}
diff --git a/tests/automotive/functional/statusbar/src/android/platform/tests/SoundPaletteTest.java b/tests/automotive/functional/statusbar/src/android/platform/tests/SoundPaletteTest.java
new file mode 100644
index 000000000..e63dfa142
--- /dev/null
+++ b/tests/automotive/functional/statusbar/src/android/platform/tests/SoundPaletteTest.java
@@ -0,0 +1,83 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.platform.tests;
+
+import static junit.framework.Assert.assertTrue;
+
+import android.platform.helpers.AutomotiveConfigConstants;
+import android.platform.helpers.HelperAccessor;
+import android.platform.helpers.IAutoSettingHelper;
+import android.platform.helpers.IAutoStatusBarHelper;
+
+import androidx.test.runner.AndroidJUnit4;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
+@RunWith(AndroidJUnit4.class)
+public class SoundPaletteTest {
+    private HelperAccessor<IAutoStatusBarHelper> mStatusBarHelper;
+    private HelperAccessor<IAutoSettingHelper> mSettingHelper;
+
+    public SoundPaletteTest() {
+        mSettingHelper = new HelperAccessor<>(IAutoSettingHelper.class);
+        mStatusBarHelper = new HelperAccessor<>(IAutoStatusBarHelper.class);
+    }
+
+    @After
+    public void goBackToHomeScreen() {
+        mSettingHelper.get().exit();
+    }
+
+    @Before
+    public void testVerifySoundButtonInHomePage() {
+        assertTrue(
+                "Sound Button is not displayed on Home Page",
+                mStatusBarHelper.get().hasSoundButton());
+    }
+
+    @Test
+    public void testSoundPaletteOnStatusBar() {
+        mStatusBarHelper.get().openSoundPaletteOnStatusBar();
+        assertTrue(
+                "In-call Volume is not displayed on Sound Palette",
+                mStatusBarHelper.get().isUIButtonPresentOnSoundPalette(AutomotiveConfigConstants.SOUND_SETTING_INCALL));
+        assertTrue(
+                "Media Voulme is not displayed on Sound Palette",
+                mStatusBarHelper.get().isUIButtonPresentOnSoundPalette(AutomotiveConfigConstants.SOUND_PALETTE_MEDIA));
+        assertTrue(
+                "Navigation Volume is not displayed on Sound Palette",
+                mStatusBarHelper
+                        .get()
+                        .isUIButtonPresentOnSoundPalette(AutomotiveConfigConstants.SOUND_PALETTE_NAVIGATION));
+        assertTrue(
+                "Sound Settings is not displayed on Sound Palette",
+                mStatusBarHelper
+                        .get()
+                        .isUIButtonPresentOnSoundPalette(AutomotiveConfigConstants.SOUND_PALETTE_SOUND_SETTINGS));
+    }
+
+    @Test
+    public void testSoundSettingsButton() {
+        mStatusBarHelper.get().openSoundPaletteOnStatusBar();
+        mStatusBarHelper.get().openSoundSettings();
+        assertTrue(
+                "Sound settings page is not opened",
+                mStatusBarHelper.get().hasSoundSettingsPageTitle());
+    }
+}
diff --git a/tests/automotive/functional/uxrestriction/src/android/platform/tests/DrivingOptimizedAppsTest.java b/tests/automotive/functional/uxrestriction/src/android/platform/tests/DrivingOptimizedAppsTest.java
index 941d951b9..fd1c05acf 100644
--- a/tests/automotive/functional/uxrestriction/src/android/platform/tests/DrivingOptimizedAppsTest.java
+++ b/tests/automotive/functional/uxrestriction/src/android/platform/tests/DrivingOptimizedAppsTest.java
@@ -43,6 +43,7 @@ public class DrivingOptimizedAppsTest {
     private HelperAccessor<IAutoNotificationHelper> mNotificationHelper;
 
     private static final String NOTIFICATION_TITLE = "Check recent permissions";
+    private static final String APP_PERMISSIONS = "App permissions";
     private static final int SPEED_TWENTY = 20;
 
     public DrivingOptimizedAppsTest() throws Exception {
@@ -118,5 +119,9 @@ public class DrivingOptimizedAppsTest {
         assertTrue(
                 "Recent Permission is not Notified",
                 mNotificationHelper.get().checkNotificationExists(NOTIFICATION_TITLE));
+        mNotificationHelper.get().clickOnCheckRecentPermissions(NOTIFICATION_TITLE);
+        assertTrue(
+                "App Permissions page is not launched",
+                mNotificationHelper.get().checkAppPermissionsExists(APP_PERMISSIONS));
     }
 }
diff --git a/tests/automotive/health/boottime/src/android/boottime/BootTimeTest.java b/tests/automotive/health/boottime/src/android/boottime/BootTimeTest.java
index c56e06cb1..1d70f8469 100644
--- a/tests/automotive/health/boottime/src/android/boottime/BootTimeTest.java
+++ b/tests/automotive/health/boottime/src/android/boottime/BootTimeTest.java
@@ -205,9 +205,9 @@ public class BootTimeTest extends BaseHostJUnit4Test {
                     String.format(
                             "%s%s%d", IMMEDIATE_DMESG_FILENAME, METRIC_KEY_SEPARATOR, iteration));
         }
+        waitForBootComplete();
         CLog.v("Waiting for %d msecs immediately after successive boot.", mAfterBootDelayTime);
         sleep(mAfterBootDelayTime);
-        waitForBootComplete();
         if (mPostBootTestRunner != null) {
             sleep(2000);
             getDevice().runInstrumentationTests(mPostBootTestRunner, new CollectingTestListener());
diff --git a/tests/automotive/health/boottime/src/android/boottime/postprocessor/LogcatPostProcessor.java b/tests/automotive/health/boottime/src/android/boottime/postprocessor/LogcatPostProcessor.java
index ba6c323f4..afe0a300e 100644
--- a/tests/automotive/health/boottime/src/android/boottime/postprocessor/LogcatPostProcessor.java
+++ b/tests/automotive/health/boottime/src/android/boottime/postprocessor/LogcatPostProcessor.java
@@ -46,11 +46,9 @@ import java.util.stream.Collectors;
 /** A Post Processor that processes text file containing logcat logs into key-value pairs */
 @OptionClass(alias = "logcat-post-processor")
 public class LogcatPostProcessor extends BaseBootTimeTestLogPostProcessor {
-    private static final String BOOT_PHASE_1000 = "starting_phase_1000";
+    private static final String BOOT_COMPLETE_KEY = "boot_complete_key";
     /** Matches the line indicating kernel start. It is starting point of the whole boot process */
     private static final Pattern KERNEL_START_PATTERN = Pattern.compile("Linux version");
-    /** Matches the logcat line indicating boot completed */
-    private static final Pattern LOGCAT_BOOT_COMPLETED = Pattern.compile("Starting phase 1000");
 
     // 03-10 21:43:40.328 1005 1005 D SystemServerTiming:StartWifi took to
     // complete: 3474ms
@@ -81,7 +79,19 @@ public class LogcatPostProcessor extends BaseBootTimeTestLogPostProcessor {
                             + " logcat line. Maybe repeated.")
     private Map<String, String> mBootTimePatterns = new HashMap<>();
 
+    @Option(
+            name = "starting-phase-signal",
+            description =
+                    "Keywords to match the starting phase of the boot.")
+    private String startingPhase = "Starting phase 1000";
+
     private List<Double> mDmesgBootCompleteTimes;
+    private Pattern mBootCompletePattern;
+
+    @Override
+    public void setUp() {
+        mBootCompletePattern = Pattern.compile(startingPhase);
+    }
 
     /** {@inheritDoc} */
     @Override
@@ -202,7 +212,7 @@ public class LogcatPostProcessor extends BaseBootTimeTestLogPostProcessor {
             Map<String, GenericTimingItem> itemsMap =
                     items.stream()
                             .collect(Collectors.toMap(GenericTimingItem::getName, item -> item));
-            if (!itemsMap.containsKey(BOOT_PHASE_1000)) {
+            if (!itemsMap.containsKey(BOOT_COMPLETE_KEY)) {
                 LogUtil.CLog.e("Missing boot complete signals from logcat");
                 return metrics;
             }
@@ -226,13 +236,13 @@ public class LogcatPostProcessor extends BaseBootTimeTestLogPostProcessor {
 
     private TimingsLogParser createCustomTimingsParser() {
         TimingsLogParser parser = new TimingsLogParser();
-        parser.addDurationPatternPair(BOOT_PHASE_1000, KERNEL_START_PATTERN, LOGCAT_BOOT_COMPLETED);
+        parser.addDurationPatternPair(BOOT_COMPLETE_KEY, KERNEL_START_PATTERN, mBootCompletePattern);
         for (Map.Entry<String, String> pattern : mBootTimePatterns.entrySet()) {
             LogUtil.CLog.d(
                     "Adding boot metric with name: %s, pattern: %s",
                     pattern.getKey(), pattern.getValue());
             parser.addDurationPatternPair(
-                    pattern.getKey(), LOGCAT_BOOT_COMPLETED, Pattern.compile(pattern.getValue()));
+                    pattern.getKey(), mBootCompletePattern, Pattern.compile(pattern.getValue()));
         }
         return parser;
     }
diff --git a/tests/automotive/health/multiuser/Android.bp b/tests/automotive/health/multiuser/Android.bp
index 889a1eb8a..d3d9ccb36 100644
--- a/tests/automotive/health/multiuser/Android.bp
+++ b/tests/automotive/health/multiuser/Android.bp
@@ -18,7 +18,7 @@ package {
 
 java_library_static {
     name: "automotive-multiuser-scenarios",
-    min_sdk_version: "24",
+    min_sdk_version: "29",
     srcs: ["src/**/*.java"],
     libs: [
         "androidx.test.runner",
diff --git a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/StartNewUser.java b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/StartNewUser.java
new file mode 100644
index 000000000..ff5325486
--- /dev/null
+++ b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/StartNewUser.java
@@ -0,0 +1,164 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.scenario.multiuser;
+
+import android.app.UiAutomation;
+import android.content.pm.UserInfo;
+import android.os.Bundle;
+import android.os.SystemClock;
+import android.platform.helpers.MultiUserHelper;
+import android.platform.test.scenario.annotation.Scenario;
+import android.util.Log;
+
+import androidx.test.platform.app.InstrumentationRegistry;
+
+import java.util.ArrayList;
+import org.junit.After;
+import org.junit.AfterClass;
+import org.junit.Assert;
+import org.junit.Assume;
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.junit.runners.JUnit4;
+
+import java.util.HashMap;
+import java.util.List;
+import java.util.Locale;
+import java.util.Map;
+
+/**
+ * This test will create a new user and start it on the display under test.
+ * Additionally, it can create and start additional users on other displays.
+ *
+ * <p>It should be running under user 0, otherwise instrumentation may be killed after user
+ * switched.
+ */
+@Scenario
+@RunWith(JUnit4.class)
+public class StartNewUser {
+    private static final String LOG_TAG = StartNewUser.class.getSimpleName();
+
+    private static final String DISPLAY_UNDER_TEST = "display-under-test";
+    private static final String START_USERS_ON_ADDITIONAL_DISPLAYS =
+            "start-users-on-additional-displays";
+    private static final String TARGET_USER_GUEST = "target-user-guest";
+    private static final int WAIT_FOR_USER_START_TIME_MS = 10000;
+
+    private final MultiUserHelper mMultiUserHelper = MultiUserHelper.getInstance();
+    private UiAutomation mUiAutomation = null;
+    private static final String CREATE_USERS_PERMISSION = "android.permission.CREATE_USERS";
+    private int mDisplayUnderTest;
+    private boolean mTargetUserGuest;
+
+    private int mStartUsersOnAdditionalDisplays;
+    private Map<Integer, Integer> mDisplayToUserIdMap = new HashMap<>();
+
+    static List<Integer> usersToDelete = new ArrayList<>();
+
+    @Before
+    public void setup() throws Exception {
+        mUiAutomation = InstrumentationRegistry.getInstrumentation().getUiAutomation();
+        mUiAutomation.adoptShellPermissionIdentity(CREATE_USERS_PERMISSION);
+
+        final Bundle arguments = InstrumentationRegistry.getArguments();
+        mDisplayUnderTest = Integer.parseInt(arguments.getString(DISPLAY_UNDER_TEST, "1"));
+        mStartUsersOnAdditionalDisplays =
+                Integer.parseInt(arguments.getString(START_USERS_ON_ADDITIONAL_DISPLAYS, "0"));
+        mTargetUserGuest = Boolean.valueOf(arguments.getString(TARGET_USER_GUEST, "false"));
+        Log.d(
+                LOG_TAG,
+                String.format(
+                        Locale.US,
+                        "Testing user start latency on %d display with %d additional users",
+                        mDisplayUnderTest,
+                        mStartUsersOnAdditionalDisplays));
+
+        int[] displays = mMultiUserHelper.getDisplayIdsForStartingVisibleBackgroundUsers();
+        // Device must have enough displays to start users on additional displays
+        // and the display under test
+        Assume.assumeTrue(
+                String.format(
+                        Locale.US,
+                        "Maximum additional visible background users allowed is %d (# of displays -"
+                                + " 1), but %d were requested",
+                        displays.length - 1,
+                        mStartUsersOnAdditionalDisplays),
+                displays.length > mStartUsersOnAdditionalDisplays);
+
+        // Target User must be created first so the userId will be 11
+        mDisplayToUserIdMap.put(
+                mDisplayUnderTest,
+                mMultiUserHelper.createUserIfDoesNotExist(
+                        "user" + mDisplayUnderTest, mTargetUserGuest));
+
+        mDisplayToUserIdMap.putAll(createAndStartAdditionalUsers(displays));
+        SystemClock.sleep(MultiUserConstants.WAIT_FOR_IDLE_TIME_MS);
+
+        StartNewUser.usersToDelete = new ArrayList<>(mDisplayToUserIdMap.values());
+    }
+
+    @Test
+    public void testStartNewUser() throws Exception {
+        int userId = mDisplayToUserIdMap.get(mDisplayUnderTest);
+        mMultiUserHelper.startUser(userId, mDisplayUnderTest);
+        // TODO(ivankozlov): instead of sleep, wait for an event(carlauncher drawn or smth else)
+        SystemClock.sleep(WAIT_FOR_USER_START_TIME_MS);
+        int actualUserId = mMultiUserHelper.getUserForDisplayId(mDisplayUnderTest);
+        Assert.assertEquals(
+            String.format(Locale.US, "User %d is not started on display %d", userId, mDisplayUnderTest),
+            userId,
+            actualUserId
+        );
+    }
+
+    @After
+    public void dropShellPermissionIdentity() throws Exception {
+        for (int userId : mDisplayToUserIdMap.values()) {
+            mMultiUserHelper.stopUser(userId);
+        }
+        mUiAutomation.dropShellPermissionIdentity();
+    }
+
+    @AfterClass
+    public static void deleteUsers() throws Exception {
+        for (int userId : usersToDelete) {
+            MultiUserHelper.getInstance().removeUser(userId);
+        }
+    }
+
+    private Map<Integer, Integer> createAndStartAdditionalUsers(int[] displays) throws Exception {
+        Map<Integer, Integer> displayToUserIdMap = new HashMap<>();
+        for (int display : displays) {
+            if (display == mDisplayUnderTest) {
+                continue;
+            }
+            boolean reachedMaxAdditionalUsers =
+                    displayToUserIdMap.size() >= mStartUsersOnAdditionalDisplays;
+            if (reachedMaxAdditionalUsers) {
+                break;
+            }
+            int userId = mMultiUserHelper.createUserIfDoesNotExist("user" + display, false);
+            Log.d(
+                    LOG_TAG,
+                    String.format(Locale.US, "Mapping user id %d for display %d", userId, display));
+            mMultiUserHelper.startUser(userId, display);
+            displayToUserIdMap.put(display, userId);
+        }
+        return displayToUserIdMap;
+    }
+}
diff --git a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToExistingSecondaryUser.java b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToExistingSecondaryUser.java
index e921be765..3850abead 100644
--- a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToExistingSecondaryUser.java
+++ b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToExistingSecondaryUser.java
@@ -18,6 +18,7 @@ package android.platform.scenario.multiuser;
 
 import android.app.UiAutomation;
 import android.content.pm.UserInfo;
+import android.os.Build;
 import android.os.SystemClock;
 import android.platform.helpers.MultiUserHelper;
 import android.platform.test.scenario.annotation.Scenario;
@@ -25,6 +26,7 @@ import android.util.Log;
 
 import androidx.test.platform.app.InstrumentationRegistry;
 
+
 import org.junit.After;
 import org.junit.Assume;
 import org.junit.Before;
@@ -55,6 +57,10 @@ public class SwitchToExistingSecondaryUser {
         /*
         TODO: Create setup util API
          */
+        // Execute these tests only on devices running Android T or higher
+        Assume.assumeTrue(
+                "Skipping below Android T", Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU);
+
         // Execute user manager APIs with elevated permissions
         mUiAutomation = getUiAutomation();
         // TODO: b/302175460 - update minimum SDK version
diff --git a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewGuest.java b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewGuest.java
index a4f3c7e59..b1948f0c4 100644
--- a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewGuest.java
+++ b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewGuest.java
@@ -18,6 +18,7 @@ package android.platform.scenario.multiuser;
 
 import android.app.UiAutomation;
 import android.content.pm.UserInfo;
+import android.os.Build;
 import android.os.SystemClock;
 import android.platform.helpers.MultiUserHelper;
 import android.platform.test.scenario.annotation.Scenario;
@@ -53,6 +54,10 @@ public class SwitchToNewGuest {
         /*
         TODO: Create setup util API
          */
+        // Execute these tests only on devices running Android T or higher
+        Assume.assumeTrue(
+                "Skipping below Android T", Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU);
+
         // Execute user manager APIs with elevated permissions
         mUiAutomation = getUiAutomation();
         // TODO: b/302175460 - update minimum SDK version
diff --git a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewSecondaryUser.java b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewSecondaryUser.java
index 18e21f132..39ad0dc96 100644
--- a/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewSecondaryUser.java
+++ b/tests/automotive/health/multiuser/src/android/platform/scenario/multiuser/nonui/SwitchToNewSecondaryUser.java
@@ -18,6 +18,7 @@ package android.platform.scenario.multiuser;
 
 import android.app.UiAutomation;
 import android.content.pm.UserInfo;
+import android.os.Build;
 import android.os.SystemClock;
 import android.platform.helpers.MultiUserHelper;
 import android.platform.test.scenario.annotation.Scenario;
@@ -54,6 +55,10 @@ public class SwitchToNewSecondaryUser {
         TODO(b/194536236): Refactor setup code in multiuser nonui tests
          * and create setup util API instead
          */
+        // Execute these tests only on devices running Android T or higher
+        Assume.assumeTrue(
+                "Skipping below Android T", Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU);
+
         // Execute user manager APIs with elevated permissions
         mUiAutomation = getUiAutomation();
         // TODO: b/302175460 - update minimum SDK version
diff --git a/tests/automotive/health/multiuser/tests/src/android/platform/scenario/multiuser/nonui/StartNewUserBenchmark.java b/tests/automotive/health/multiuser/tests/src/android/platform/scenario/multiuser/nonui/StartNewUserBenchmark.java
new file mode 100644
index 000000000..91f82b496
--- /dev/null
+++ b/tests/automotive/health/multiuser/tests/src/android/platform/scenario/multiuser/nonui/StartNewUserBenchmark.java
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.scenario.multiuser;
+
+import android.platform.test.microbenchmark.Microbenchmark;
+import android.platform.test.microbenchmark.Microbenchmark.TightMethodRule;
+import android.platform.test.rule.StopwatchRule;
+import android.platform.test.scenario.SleepAtTestFinishRule;
+import org.junit.Rule;
+import org.junit.runner.RunWith;
+
+@RunWith(Microbenchmark.class)
+public class StartNewUserBenchmark extends StartNewUser {
+    @Rule
+    public SleepAtTestFinishRule sleepRule =
+            new SleepAtTestFinishRule(MultiUserConstants.WAIT_FOR_IDLE_TIME_MS);
+
+    @TightMethodRule public StopwatchRule stopwatchRule = new StopwatchRule();
+}
diff --git a/tests/automotive/health/notification/tests/AndroidTest.xml b/tests/automotive/health/notification/tests/AndroidTest.xml
new file mode 100644
index 000000000..b22b93b22
--- /dev/null
+++ b/tests/automotive/health/notification/tests/AndroidTest.xml
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+  ~ Copyright (C) 2023 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<configuration description="Runs AndroidAutomotiveNotificationScenarioTests metrics instrumentation">
+    <option name="config-descriptor:metadata" key="test-type" value="performance" />
+    <target_preparer class="com.android.tradefed.targetprep.suite.SuiteApkInstaller">
+        <option name="cleanup-apks" value="true" />
+        <option name="test-file-name" value="AndroidAutomotiveNotificationScenarioTests.apk" />
+    </target_preparer>
+
+    <test class="com.android.tradefed.testtype.AndroidJUnitTest" >
+        <option name="package" value="android.platform.test.scenario.notification" />
+        <option name="class" value="android.platform.test.scenario.notification.Scroll" />
+        <option name="runner" value="androidx.test.runner.AndroidJUnitRunner" />
+        <option name="device-listeners" value="android.device.collectors.JankListener" />
+        <option name="instrumentation-arg" key="iterations" value="3" />
+        <option name="instrumentation-arg" key="newRunListenerMode" value="true" />
+    </test>
+
+    <metric_post_processor class="com.android.tradefed.postprocessor.MetricFilePostProcessor">
+        <option name="aggregate-similar-tests" value="true" />
+    </metric_post_processor>
+  </configuration>
diff --git a/tests/automotive/health/property/Android.bp b/tests/automotive/health/property/Android.bp
new file mode 100644
index 000000000..d8be9d3ed
--- /dev/null
+++ b/tests/automotive/health/property/Android.bp
@@ -0,0 +1,46 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+package {
+    default_team: "trendy_team_aaos_framework",
+    default_applicable_licenses: [
+        "Android-Apache-2.0",
+    ],
+}
+
+android_test {
+    name: "CarPropertyStressTestDeviceApp",
+
+    static_libs: [
+        "androidx.test.core",
+        "androidx.test.rules",
+        "testng",
+        "truth",
+        "androidx.test.runner",
+        "collector-device-lib-platform",
+    ],
+
+    libs: [
+        "android.car",
+        "android.test.runner.stubs",
+        "android.test.base.stubs",
+    ],
+
+    srcs: ["src/**/*.java"],
+    host_required: ["CarPropertyManagerStressTestLogPostProcessor"],
+    min_sdk_version: "28",
+    test_suites: [
+        "general-tests",
+    ],
+}
diff --git a/tests/automotive/health/property/AndroidManifest.xml b/tests/automotive/health/property/AndroidManifest.xml
new file mode 100644
index 000000000..18344a86d
--- /dev/null
+++ b/tests/automotive/health/property/AndroidManifest.xml
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    package="android.platform.test.scenario.stress"
+    android:sharedUserId="com.google.uid.shared"
+    android:sharedUserMaxSdkVersion="34">
+    <uses-permission android:name="android.car.permission.CAR_SPEED"/>
+    <uses-permission android:name="android.car.permission.CONTROL_CAR_CLIMATE"/>
+
+    <uses-sdk android:minSdkVersion="28" android:targetSdkVersion="28" />
+
+    <application>
+        <uses-library android:name="android.test.runner" />
+    </application>
+
+    <instrumentation
+        android:name="androidx.test.runner.AndroidJUnitRunner"
+        android:targetPackage="android.platform.test.scenario.stress"
+        android:label="Android Automotive car property Scenario-Based Tests" />
+</manifest>
\ No newline at end of file
diff --git a/tests/automotive/health/property/AndroidTest.xml b/tests/automotive/health/property/AndroidTest.xml
new file mode 100644
index 000000000..1d7a3f1b2
--- /dev/null
+++ b/tests/automotive/health/property/AndroidTest.xml
@@ -0,0 +1,41 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<configuration description="Config for CarBenchmarkTests">
+    <option name="test-suite-tag" value="CarBenchmarkTest"/>
+    <option name="config-descriptor:metadata" key="test-type" value="performance" />
+    <target_preparer class="com.android.tradefed.targetprep.suite.SuiteApkInstaller">
+        <option name="cleanup-apks" value="true" />
+        <option name="test-file-name" value="CarPropertyStressTestDeviceApp.apk" />
+    </target_preparer>
+    <target_preparer class="com.android.tradefed.targetprep.RootTargetPreparer"/>
+    <test class="com.android.tradefed.testtype.AndroidJUnitTest" >
+        <option name="package" value="android.platform.test.scenario.stress" />
+        <option name="runner" value="androidx.test.runner.AndroidJUnitRunner" />
+        <option name="device-listeners" value="android.device.loggers.LogFileLogger" />
+    </test>
+    <metrics_collector class="com.android.tradefed.device.metric.FilePullerLogCollector">
+        <option name="pull-pattern-keys" value="getPropertySync_latency_in_nanos"/>
+        <option name="pull-pattern-keys" value="setPropertySync_latency_in_nanos"/>
+        <option name="collect-on-run-ended-only" value="true" />
+    </metrics_collector>
+    <metric_post_processor class="com.android.tradefed.postprocessor.MetricFilePostProcessor">
+        <option name="aggregate-run-metrics" value="true" />
+    </metric_post_processor>
+    <metric_post_processor class="android.platform.test.stress.postprocessor.CarPropertyManagerStressTestLogPostProcessor">
+    </metric_post_processor>
+</configuration>
\ No newline at end of file
diff --git a/tests/automotive/health/property/TEST_MAPPING b/tests/automotive/health/property/TEST_MAPPING
new file mode 100644
index 000000000..8e8c07411
--- /dev/null
+++ b/tests/automotive/health/property/TEST_MAPPING
@@ -0,0 +1,7 @@
+{
+    "auto-postsubmit": [
+        {
+            "name": "CarPropertyStressTestDeviceApp"
+        }
+    ]
+}
\ No newline at end of file
diff --git a/tests/automotive/health/property/postprocessor/Android.bp b/tests/automotive/health/property/postprocessor/Android.bp
new file mode 100644
index 000000000..a554712e4
--- /dev/null
+++ b/tests/automotive/health/property/postprocessor/Android.bp
@@ -0,0 +1,33 @@
+// Copyright (C) 2024 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+package {
+    default_applicable_licenses: [
+        "Android-Apache-2.0",
+    ],
+}
+
+java_test_helper_library {
+    name: "CarPropertyManagerStressTestLogPostProcessor",
+    srcs: ["src/**/*.java"],
+    libs: [
+        "tradefed",
+        "loganalysis",
+    ],
+    host_supported: true,
+    device_supported: false,
+    test_suites: [
+        "general-tests",
+    ],
+}
diff --git a/tests/automotive/health/property/postprocessor/src/andorid/platform/test/postprocessor/stress/CarPropertyManagerStressTestLogPostProcessor.java b/tests/automotive/health/property/postprocessor/src/andorid/platform/test/postprocessor/stress/CarPropertyManagerStressTestLogPostProcessor.java
new file mode 100644
index 000000000..b67d12024
--- /dev/null
+++ b/tests/automotive/health/property/postprocessor/src/andorid/platform/test/postprocessor/stress/CarPropertyManagerStressTestLogPostProcessor.java
@@ -0,0 +1,113 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.platform.test.stress.postprocessor;
+
+import com.android.tradefed.log.LogUtil;
+import com.android.tradefed.metrics.proto.MetricMeasurement;
+import com.android.tradefed.postprocessor.BasePostProcessor;
+import com.android.tradefed.result.LogFile;
+
+import java.io.BufferedReader;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileReader;
+import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.RandomAccessFile;
+import java.util.HashMap;
+import java.util.Map;
+import java.util.zip.GZIPInputStream;
+
+public class CarPropertyManagerStressTestLogPostProcessor extends BasePostProcessor {
+    private static final String GET_METRIC_NAME = "GET_PROPERTY_TIMING";
+    private static final String SET_METRIC_NAME = "SET_PROPERTY_TIMING";
+    private static final String FILE_NAME = "values_for_test";
+
+    /** {@inheritDoc} */
+    /**
+     * Returns {@link MetricMeasurement.DataType.RAW} for metrics reported by the post processor.
+     * RAW is required in order for {@link
+     * com.android.tradefed.postprocessor.MetricFilePostProcessor} to aggregate the values
+     */
+    @Override
+    protected MetricMeasurement.DataType getMetricType() {
+        // Return raw metrics in order for MetricFilePostProcessor to aggregate
+        return MetricMeasurement.DataType.RAW;
+    }
+
+    /** {@inheritDoc} */
+    @Override
+    public Map<String, MetricMeasurement.Metric.Builder> processRunMetricsAndLogs(
+            HashMap<String, MetricMeasurement.Metric> rawMetrics, Map<String, LogFile> runLogs) {
+        Map<String, MetricMeasurement.Metric.Builder> metrics = new HashMap<>();
+        for (String key : runLogs.keySet()) {
+            LogUtil.CLog.i("Reading file: %s", key);
+            if (!key.contains(FILE_NAME)) {
+                continue;
+            }
+            String metricName = key.contains("get") ? GET_METRIC_NAME : SET_METRIC_NAME;
+            BufferedReader br;
+            try {
+                File file = new File(runLogs.get(key).getPath());
+                if (isGZipped(file)) {
+                    LogUtil.CLog.i("File %s is gzipped", file);
+                    br =
+                            new BufferedReader(
+                                    new InputStreamReader(
+                                            new GZIPInputStream(new FileInputStream(file))));
+                } else {
+                    LogUtil.CLog.i("File %s is not gzipped", file);
+                    br = new BufferedReader(new FileReader(file));
+                }
+                StringBuilder stringBuilder = new StringBuilder();
+                String line = br.readLine();
+                while (line != null) {
+                    stringBuilder.append(line + ",");
+                    line = br.readLine();
+                }
+                MetricMeasurement.Measurements.Builder measurement =
+                        MetricMeasurement.Measurements.newBuilder()
+                                .setSingleString(stringBuilder.toString());
+                MetricMeasurement.Metric.Builder metric =
+                        MetricMeasurement.Metric.newBuilder().setMeasurements(measurement);
+                metrics.put(metricName, metric);
+            } catch (IOException e) {
+                LogUtil.CLog.e("Unable to open buffered reader");
+                throw new RuntimeException(e);
+            }
+        }
+        return metrics;
+    }
+
+    /**
+     * Checks if a file is gzipped.
+     *
+     * @param f File to check if its is gzipped
+     * @return True if it is gzipped false otherwise
+     */
+    public static boolean isGZipped(File f) {
+        int magic = 0;
+        try {
+            RandomAccessFile raf = new RandomAccessFile(f, "r");
+            magic = (raf.read() & 0xff) | ((raf.read() << 8) & 0xff00);
+            raf.close();
+        } catch (Throwable e) {
+            e.printStackTrace(System.err);
+        }
+        return magic == GZIPInputStream.GZIP_MAGIC;
+    }
+}
diff --git a/tests/automotive/health/property/src/android/platform/test/scenario/stress/CarPropertyManagerBenchmarkTest.java b/tests/automotive/health/property/src/android/platform/test/scenario/stress/CarPropertyManagerBenchmarkTest.java
new file mode 100644
index 000000000..7b41bda91
--- /dev/null
+++ b/tests/automotive/health/property/src/android/platform/test/scenario/stress/CarPropertyManagerBenchmarkTest.java
@@ -0,0 +1,155 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.platform.test.scenario.stress;
+
+import static android.car.VehiclePropertyIds.HVAC_TEMPERATURE_SET;
+import static android.car.VehiclePropertyIds.PERF_VEHICLE_SPEED;
+
+import static com.google.common.truth.Truth.assertThat;
+
+import static org.junit.Assume.assumeTrue;
+
+import android.car.Car;
+import android.car.hardware.CarPropertyConfig;
+import android.car.hardware.property.CarPropertyManager;
+import android.content.Context;
+import android.device.loggers.TestLogData;
+import android.util.Log;
+
+import androidx.test.platform.app.InstrumentationRegistry;
+import androidx.test.runner.AndroidJUnit4;
+
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
+import java.io.File;
+import java.io.FileWriter;
+import java.util.Random;
+import java.util.concurrent.ConcurrentLinkedQueue;
+import java.util.concurrent.CountDownLatch;
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
+import java.util.concurrent.TimeUnit;
+
+@RunWith(AndroidJUnit4.class)
+public class CarPropertyManagerBenchmarkTest {
+    private static final String TAG = CarPropertyManagerBenchmarkTest.class.getSimpleName();
+    private static final int NUM_TASKS = 30;
+    private static final int NUM_RUNS = 30;
+    private static final int MIN_TEMP = 16;
+    private static final int MAX_TEMP = 25;
+    private CarPropertyManager mCarPropertyManager;
+    private Context mContext;
+    @Rule public TestLogData logs = new TestLogData();
+
+    @Before
+    public void setup() {
+        mContext = InstrumentationRegistry.getInstrumentation().getContext();
+        Car car = Car.createCar(mContext);
+        assertThat(car).isNotNull();
+        mCarPropertyManager = (CarPropertyManager) car.getCarManager(Car.PROPERTY_SERVICE);
+        assertThat(mCarPropertyManager).isNotNull();
+    }
+
+    @Test
+    public void testGetPropertyStress() throws Exception {
+        ExecutorService executorService = Executors.newFixedThreadPool(NUM_TASKS);
+        final CountDownLatch latch = new CountDownLatch(NUM_TASKS); // For synchronization
+        ConcurrentLinkedQueue<Long> concurrentLinkedQueue = new ConcurrentLinkedQueue<>();
+        for (int i = 0; i < NUM_TASKS; i++) {
+            executorService.execute(
+                    () -> {
+                        for (int j = 0; j < NUM_RUNS; j++) {
+                            long timeBeforeRun = System.nanoTime();
+                            try {
+                                mCarPropertyManager.getProperty(PERF_VEHICLE_SPEED, 0);
+                            } catch (IllegalStateException e) {
+                                // This is expected because car service only allows up to 16 sync
+                                // get/set operations happening at the same time.
+                                Log.i(TAG, "getProperty threw an error", e);
+                            }
+                            concurrentLinkedQueue.add((System.nanoTime() - timeBeforeRun));
+                        }
+                        latch.countDown();
+                    });
+        }
+        executorService.shutdown();
+        latch.await(10, TimeUnit.SECONDS);
+
+        File fileToLog = writeToFile("values_for_test_get", concurrentLinkedQueue);
+        if (fileToLog != null) {
+            logs.addTestLog("getPropertySync_latency_in_nanos", fileToLog);
+        }
+    }
+
+    @Test
+    public void testSetPropertyStress() throws Exception {
+        ExecutorService executorService = Executors.newFixedThreadPool(NUM_TASKS);
+        final CountDownLatch latch = new CountDownLatch(NUM_TASKS); // For synchronization
+        ConcurrentLinkedQueue<Long> concurrentLinkedQueue = new ConcurrentLinkedQueue<>();
+        CarPropertyConfig<?> hvacTempSetConfig =
+                mCarPropertyManager.getCarPropertyConfig(HVAC_TEMPERATURE_SET);
+        assumeTrue("Cannot set hvacTemp", hvacTempSetConfig != null);
+        int areaId = hvacTempSetConfig.getAreaIdConfigs().get(0).getAreaId();
+        for (int i = 0; i < NUM_TASKS; i++) {
+            executorService.execute(
+                    () -> {
+                        for (int j = 0; j < NUM_RUNS; j++) {
+                            Random rd = new Random();
+                            long timeBeforeRun = System.nanoTime();
+                            try {
+                                mCarPropertyManager.setProperty(
+                                        Float.class,
+                                        HVAC_TEMPERATURE_SET,
+                                        /* areaId= */ areaId,
+                                        /* val= */ MIN_TEMP
+                                                + rd.nextFloat() * (MAX_TEMP - MIN_TEMP));
+                            } catch (IllegalStateException e) {
+                                // This is expected because car service only allows up to 16 sync
+                                // get/set operations happening at the same time.
+                                Log.i(TAG, "getProperty threw an error", e);
+                            }
+                            concurrentLinkedQueue.add((System.nanoTime() - timeBeforeRun));
+                        }
+                        latch.countDown();
+                    });
+        }
+        executorService.shutdown();
+        latch.await(10, TimeUnit.SECONDS);
+
+        File fileToLog = writeToFile("values_for_test_set", concurrentLinkedQueue);
+        if (fileToLog != null) {
+            logs.addTestLog("setPropertySync_latency_in_nanos", fileToLog);
+        }
+    }
+
+    private File writeToFile(String fileName, ConcurrentLinkedQueue<Long> valuesToWrite)
+            throws Exception {
+        File file = new File(mContext.getFilesDir() + "/" + fileName);
+        if (!file.exists()) {
+            file.createNewFile();
+        }
+        try (FileWriter writer = new FileWriter(file, true)) {
+            for (long valueToWrite : valuesToWrite) {
+                writer.write(String.valueOf(valueToWrite));
+                writer.write(System.lineSeparator());
+            }
+        }
+        return file;
+    }
+}
diff --git a/tests/automotive/health/settings/src/android/platform/scenario/settings/ScrollInApp.java b/tests/automotive/health/settings/src/android/platform/scenario/settings/ScrollInApp.java
index 1350af3a3..2dee1f5e8 100644
--- a/tests/automotive/health/settings/src/android/platform/scenario/settings/ScrollInApp.java
+++ b/tests/automotive/health/settings/src/android/platform/scenario/settings/ScrollInApp.java
@@ -32,8 +32,8 @@ public class ScrollInApp {
             new HelperAccessor<>(IAutoSettingHelper.class);
 
     @Test
-    public void testScrollDownAndUp() {
-        sHelper.get().scrollDownOnePage();
-        sHelper.get().scrollUpOnePage();
+    public void testScrollForwardAndBackward() {
+        sHelper.get().scrollForward();
+        sHelper.get().scrollBackward();
     }
 }
diff --git a/tests/automotive/mobly_tests/bluetooth_base_test.py b/tests/automotive/mobly_tests/bluetooth_base_test.py
index c39fd008c..a86aedda6 100644
--- a/tests/automotive/mobly_tests/bluetooth_base_test.py
+++ b/tests/automotive/mobly_tests/bluetooth_base_test.py
@@ -39,10 +39,11 @@ class BluetoothBaseTest(base_test.BaseTestClass):
         logging.info("\tInitializing Utilities")
         self.call_utils = (spectatio_utils.CallUtils(self.discoverer))
         self.bt_utils = (bt_utils.BTUtils(self.discoverer, self.target))
-        logging.info("\tInitializing video services")
+
+        logging.info("\tInitializing video services on HU")
         self.video_utils_service = VideoRecording(self.discoverer, self.__class__.__name__)
-        logging.info("Enabling video recording for Discoverer device")
-        self.video_utils_service.enable_screen_recording()
+        logging.info("\tInitializing video services on target")
+        self.video_utils_service_target = VideoRecording(self.target, self.__class__.__name__)
 
     def setup_test(self):
         # Make sure bluetooth is on.
@@ -55,13 +56,26 @@ class BluetoothBaseTest(base_test.BaseTestClass):
     def teardown_test(self):
         # Turn Bluetooth off on both devices.
         logging.info("Running basic test teardown.")
+        self.call_utils.press_home()
+        self.call_utils.press_phone_home_icon_using_adb_command(self.target)
+        self.hu_recording_handler()
         self.bt_utils.unpair()
         logging.info("Disable Bluetooth on Discoverer device")
         self.discoverer.mbs.btDisable()
         logging.info("Disable Bluetooth on Target device")
         self.target.mbs.btDisable()
+
+    def teardown_no_video_recording(self):
+        # Turn Bluetooth off on both devices.
+        logging.info("Running basic test teardown.")
         self.call_utils.press_home()
-        self.hu_recording_handler()
+        self.call_utils.press_phone_home_icon_using_adb_command(self.target)
+        self.bt_utils.unpair()
+        logging.info("Disable Bluetooth on Discoverer device")
+        self.discoverer.mbs.btDisable()
+        logging.info("Disable Bluetooth on Target device")
+        self.target.mbs.btDisable()
+
 
     def hu_recording_handler(self):
         logging.info("Stopping the screen recording on Discoverer Device")
@@ -71,6 +85,19 @@ class BluetoothBaseTest(base_test.BaseTestClass):
         logging.info("delete the screen recording from the Discoverer device")
         self.video_utils_service.delete_screen_recording_from_device()
 
+        logging.info("Stopping the screen recording on Target Device")
+        self.video_utils_service_target.stop_screen_recording()
+        logging.info("Pull the screen recording from Target device")
+        self.video_utils_service_target.pull_recording_file(self.log_path)
+        logging.info("delete the screen recording from the Target device")
+        self.video_utils_service_target.delete_screen_recording_from_device()
+
+    def enable_recording(self):
+        logging.info("Enabling video recording for Discoverer device")
+        self.video_utils_service.enable_screen_recording()
+        logging.info("Enabling video recording for Target device")
+        self.video_utils_service_target.enable_screen_recording()
+        logging.info("Video recording started on Discoverer and Target")
 
 if __name__ == '__main__':
     common_main()
diff --git a/tests/automotive/mobly_tests/bluetooth_palette/bluetooth_button_enable_disable_test.py b/tests/automotive/mobly_tests/bluetooth_palette/bluetooth_button_enable_disable_test.py
index 5b2115726..1004c34be 100644
--- a/tests/automotive/mobly_tests/bluetooth_palette/bluetooth_button_enable_disable_test.py
+++ b/tests/automotive/mobly_tests/bluetooth_palette/bluetooth_button_enable_disable_test.py
@@ -26,7 +26,9 @@ class BluetoothPalette(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         """Setup steps before any test is executed."""
         # Pair the devices
-        self.bt_utils.pair_primary_to_secondary();
+        self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.call_utils.press_home()
 
     def test_enable_disable_bluetooth_button(self):
         """Tests enable and disable functionality of bluetooth."""
diff --git a/tests/automotive/mobly_tests/bluetooth_palette/disable_enable_phone_hfp_bluetooth_profile_test.py b/tests/automotive/mobly_tests/bluetooth_palette/disable_enable_phone_hfp_bluetooth_profile_test.py
index 6b784e82e..2754dcd7a 100644
--- a/tests/automotive/mobly_tests/bluetooth_palette/disable_enable_phone_hfp_bluetooth_profile_test.py
+++ b/tests/automotive/mobly_tests/bluetooth_palette/disable_enable_phone_hfp_bluetooth_profile_test.py
@@ -25,6 +25,7 @@ class DisableEnableHFPBluetoothProfile(bluetooth_base_test.BluetoothBaseTest):
     # Pair caller phone with automotive device
     self.call_utils.press_home()
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
   def test_disable_enable_phone_hfp_bluetooth_profile(self):
     """Disable - Enable Phone-HFP Bluetooth profile"""
diff --git a/tests/automotive/mobly_tests/bluetooth_palette/enable-disable_bluetooth_audio_via_music_button.py b/tests/automotive/mobly_tests/bluetooth_palette/enable-disable_bluetooth_audio_via_music_button.py
index 9c8dcabf8..2702fabec 100644
--- a/tests/automotive/mobly_tests/bluetooth_palette/enable-disable_bluetooth_audio_via_music_button.py
+++ b/tests/automotive/mobly_tests/bluetooth_palette/enable-disable_bluetooth_audio_via_music_button.py
@@ -29,13 +29,21 @@ from mobly import asserts
 
 from utilities import constants
 from utilities.main_utils import common_main
+from utilities.common_utils import CommonUtils
 
 class EnableDisableBluetoothAudioViaMusicButton(bluetooth_base_test.BluetoothBaseTest):
   """Enable and Disable Bluetooth Audio Bluetooth Palette."""
 
+  def setup_class(self):
+    super().setup_class()
+    self.common_utils = CommonUtils(self.target, self.discoverer)
+    super().enable_recording()
+    self.call_utils.press_home()
+
   def setup_test(self):
     """Setup steps before any test is executed."""
     # Pair caller phone with automotive device
+    self.common_utils.grant_local_mac_address_permission()
     self.bt_utils.pair_primary_to_secondary()
 
   def test_enable_disable_bluetooth_audio_via_music_button(self):
@@ -46,7 +54,7 @@ class EnableDisableBluetoothAudioViaMusicButton(bluetooth_base_test.BluetoothBas
     self.call_utils.click_on_bluetooth_palette_media_button()
     asserts.assert_false(self.call_utils.is_bluetooth_media_button_enabled(),'Media Button is Not disabled')
     self.call_utils.open_bluetooth_media_app()
-    self.call_utils.click_cancel_label_visible_on_bluetooth_audio_page()
+    self.call_utils.wait_with_log(5)
     asserts.assert_true(self.call_utils.is_connect_to_bluetooth_label_visible_on_bluetooth_audio_page(), "Connect to Bluetooth Label is not visible")
     self.call_utils.open_bluetooth_palette()
     self.call_utils.click_on_bluetooth_palette_media_button()
diff --git a/tests/automotive/mobly_tests/bluetooth_palette/verify_bluetooth_palette_buttons_test.py b/tests/automotive/mobly_tests/bluetooth_palette/verify_bluetooth_palette_buttons_test.py
index 20a2becdf..520f0be31 100644
--- a/tests/automotive/mobly_tests/bluetooth_palette/verify_bluetooth_palette_buttons_test.py
+++ b/tests/automotive/mobly_tests/bluetooth_palette/verify_bluetooth_palette_buttons_test.py
@@ -28,6 +28,7 @@ class BluetoothPalette(bluetooth_base_test.BluetoothBaseTest):
   def setup_test(self):
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
   def test_bluetooth_palette_verification(self):
     """Tests Bluetooth Palette Verification."""
diff --git a/tests/automotive/mobly_tests/bluetooth_sms_base_test.py b/tests/automotive/mobly_tests/bluetooth_sms_base_test.py
index 9715b36ce..ed53c5c5d 100644
--- a/tests/automotive/mobly_tests/bluetooth_sms_base_test.py
+++ b/tests/automotive/mobly_tests/bluetooth_sms_base_test.py
@@ -5,6 +5,7 @@ This test class serves as a base class for tests which needs three devices
 
 """
 
+import logging
 import sys
 
 from mobly import test_runner
@@ -13,6 +14,7 @@ from mobly.controllers import android_device
 from utilities import spectatio_utils
 from utilities import bt_utils
 from bluetooth_test import bluetooth_base_test
+from utilities.video_utils_service import VideoRecording
 
 class BluetoothSMSBaseTest(bluetooth_base_test.BluetoothBaseTest):
 
@@ -39,6 +41,18 @@ class BluetoothSMSBaseTest(bluetooth_base_test.BluetoothBaseTest):
         self.call_utils = (spectatio_utils.CallUtils(self.discoverer))
         self.bt_utils = (bt_utils.BTUtils(self.discoverer, self.target))
 
+        logging.info("\tInitializing video services")
+        self.video_utils_service = VideoRecording(self.discoverer, self.__class__.__name__)
+        logging.info("Enabling video recording for Discoverer device")
+        self.video_utils_service.enable_screen_recording()
+
+        logging.info("\tInitializing video services")
+        self.video_utils_service_target = VideoRecording(self.target, self.__class__.__name__)
+        logging.info("Enabling video recording for Target device")
+        self.video_utils_service_target.enable_screen_recording()
+
+        self.call_utils.press_phone_home_icon_using_adb_command(self.phone_notpaired)
+
 
 if __name__ == '__main__':
     common_main()
diff --git a/tests/automotive/mobly_tests/connectivity/Android.bp b/tests/automotive/mobly_tests/connectivity/Android.bp
index e9876a80e..e40c369b9 100644
--- a/tests/automotive/mobly_tests/connectivity/Android.bp
+++ b/tests/automotive/mobly_tests/connectivity/Android.bp
@@ -24,7 +24,7 @@ python_test_host {
     libs: [
         "mobly",
         "utilities",
-        "bluetooth_test"
+        "bluetooth_test",
     ],
     test_suites: [
         "catbox",
@@ -105,7 +105,7 @@ python_test_host {
     libs: [
         "mobly",
         "utilities",
-        "bluetooth_test"
+        "bluetooth_test",
     ],
     test_suites: [
         "catbox",
@@ -132,7 +132,7 @@ python_test_host {
     libs: [
         "mobly",
         "utilities",
-        "bluetooth_test"
+        "bluetooth_test",
     ],
     test_suites: [
         "catbox",
@@ -159,7 +159,34 @@ python_test_host {
     libs: [
         "mobly",
         "utilities",
-        "bluetooth_test"
+        "bluetooth_test",
+    ],
+    test_suites: [
+        "catbox",
+    ],
+    test_options: {
+        unit_test: false,
+    },
+    data: [
+        // Package the snippet with the mobly test
+        ":AutomotiveSnippet",
+        ":PhoneSnippet",
+    ],
+    version: {
+        py3: {
+            embedded_launcher: true,
+        },
+    },
+}
+
+python_test_host {
+    name: "BTProfilesTest",
+    main: "connectivity_test_bluetooth_profile.py",
+    srcs: ["connectivity_test_bluetooth_profile.py"],
+    libs: [
+        "mobly",
+        "utilities",
+        "bluetooth_test",
     ],
     test_suites: [
         "catbox",
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_bluetooth_profile.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_bluetooth_profile.py
new file mode 100644
index 000000000..62fd7395d
--- /dev/null
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_bluetooth_profile.py
@@ -0,0 +1,90 @@
+"""
+  Copyright (C) 2023 The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License");
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+
+
+
+  Test Steps:
+  (0. Flash device)
+    1. Navigate to the Bluetooth settings page
+    2. Disconnect - Connect Mobile Device via Layer1 - via Bluetooth Button
+    3. Tap Device to see DisconnectedStatus in Layer2
+    4. Reconnect - Via layer 1
+    5. Tap device to see Connected status in Layer2
+
+    "Layer Two" represents the device-specific screen (the screen you see when clicking the device in the bluetooth settings page.
+
+"""
+
+from bluetooth_test import bluetooth_base_test
+from mobly import asserts
+from utilities.main_utils import common_main
+from utilities import constants
+
+import logging
+MOBILE_DEVICE_NAME = 'target'
+AUTOMOTIVE_DEVICE_NAME = 'discoverer'
+
+class BluetoothProfiles(bluetooth_base_test.BluetoothBaseTest):
+
+
+    def setup_test(self):
+        # Pair the devices
+        self.bt_utils.pair_primary_to_secondary()
+
+    def test_bluetooth_profiles(self):
+       """Test is validating BT Profiles"""
+
+       # Waiting for bt profiles sync
+       self.call_utils.wait_with_log(5)
+
+       # Validate BT Connection State after pairing
+       bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+       logging.info("BT State after pairing : <%s>", bt_connection_state)
+       if 'STATE_CONNECTED' in bt_connection_state:
+          logging.info('BT State connected')
+       else:
+          logging.info('BT State disconnected')
+
+       asserts.assert_true('STATE_CONNECTED' in bt_connection_state, 'BT is not paired, correctly')
+
+       # Validate HFP Profile after pairing
+       bt_hfp_status_txt = self.call_utils.get_bt_profile_status_using_adb_command(self.discoverer, constants.BLUETOOTH_HFP)
+       logging.info("BT HFP Status: <%s>", bt_hfp_status_txt)
+       asserts.assert_true('HfpClientDeviceBlock' in bt_hfp_status_txt, 'HFP Profile not mapped')
+
+       # Validate MAP Profile after pairing
+       bt_map_status = self.call_utils.get_bt_profile_status_using_adb_command(self.discoverer, constants.BLUETOOTH_MAP)
+       logging.info("Getting BT MAP Status: <%s>", bt_map_status)
+       asserts.assert_true(bt_map_status, 'MAP Profile not mapped')
+
+       # Validate AVRCP Profile after pairing
+       bt_avrcp_status = self.call_utils.get_bt_profile_status_using_adb_command(self.discoverer, constants.BLUETOOTH_AVRCP)
+       logging.info("Getting BT AVRCP Status: <%s>", bt_avrcp_status)
+       asserts.assert_true(bt_avrcp_status, 'AVRCP Profile not mapped')
+
+    def teardown_test(self):
+        # Turn Bluetooth off on both devices.
+        logging.info("Running basic test teardown.")
+        self.call_utils.press_home()
+        self.call_utils.press_phone_home_icon_using_adb_command(self.target)
+        self.bt_utils.unpair()
+        logging.info("Disable Bluetooth on Discoverer device")
+        self.discoverer.mbs.btDisable()
+        logging.info("Disable Bluetooth on Target device")
+        self.target.mbs.btDisable()
+
+if __name__ == '__main__':
+    # Take test args
+    common_main()
\ No newline at end of file
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_default_state.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_default_state.py
index 9b86f3dfc..feb9c12e3 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_default_state.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_default_state.py
@@ -29,6 +29,10 @@ from bluetooth_test import bluetooth_base_test
 
 class BluetoothDefaultStateTest(bluetooth_base_test.BluetoothBaseTest):
 
+    def setup_test(self):
+    # The base class setup should not run, to correctly verify the default HU state
+      pass
+
     def test_bluetooth_default_state(self):
         # Confirm that the bluetooth state is ON
         asserts.assert_true(
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_media.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_media.py
index 69ff7823b..373e8b930 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_media.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_media.py
@@ -26,6 +26,7 @@ from mobly import asserts
 from utilities.main_utils import common_main
 from bluetooth_test import bluetooth_base_test
 from utilities import constants
+import logging
 
 class BluetoothDisableEnableMediaTest(bluetooth_base_test.BluetoothBaseTest):
 
@@ -37,8 +38,13 @@ class BluetoothDisableEnableMediaTest(bluetooth_base_test.BluetoothBaseTest):
         self.bt_utils.pair_primary_to_secondary()
         self.call_utils.wait_with_log(constants.DEVICE_CONNECT_WAIT_TIME)
         self.target_name = self.target.mbs.btGetName()
+        super().enable_recording()
 
     def test_disable_enable_media(self):
+        # Log BT Connection State after pairing
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT State after pairing : <%s>", bt_connection_state)
+
         # Navigate to the bluetooth settings page
         self.call_utils.open_bluetooth_settings()
         # Disable media for the listed paired device via the preference button
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_phone.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_phone.py
index 6acf765d9..9c5fe49e8 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_phone.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_disable_phone.py
@@ -22,6 +22,8 @@
 
 """
 
+import logging
+
 from mobly import asserts
 from utilities.main_utils import common_main
 from bluetooth_test import bluetooth_base_test
@@ -34,9 +36,14 @@ class BluetoothDisableEnablePhoneTest(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
 
     def test_disable_enable_phone(self):
+        # Log BT Connection State after pairing
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT State after pairing : <%s>", bt_connection_state)
+
         # Navigate to the bluetooth settings page
         self.call_utils.open_bluetooth_settings()
         target_name = self.target.mbs.btGetName()
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnect_from_settings.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnect_from_settings.py
index 8a578de90..dd6f81082 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnect_from_settings.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnect_from_settings.py
@@ -25,6 +25,7 @@
 
 """
 
+import logging
 from mobly import asserts
 from utilities import constants
 from utilities.main_utils import common_main
@@ -37,13 +38,21 @@ class BluetoothDisconnectFromSettingsTest(bluetooth_base_test.BluetoothBaseTest)
         super().setup_test()
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_disconnect_from_settings(self):
+        # Log BT Connection State after pairing
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT State after pairing : <%s>", bt_connection_state)
+
         # Allow time for connection to fully sync.
         self.call_utils.wait_with_log(constants.WAIT_THIRTY_SECONDS)
 
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT Connection State after wait time : <%s>", bt_connection_state)
+
         # Navigate to Bluetooth Settings
-        self.call_utils.open_bluetooth_settings()
+        self.call_utils.open_bluetooth_settings_form_status_bar()
         self.call_utils.wait_with_log(constants.WAIT_TWO_SECONDS)
         # Press the Bluetooth toggle button to disconnect
         # (Recall that the toggle is the leftmost of the three buttons listed with the name)
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnected_summary_status.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnected_summary_status.py
index b3c95ac13..f191a6ac7 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnected_summary_status.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_disconnected_summary_status.py
@@ -49,10 +49,15 @@ class BluetoothConnectionStatusOnLevelTwo(bluetooth_base_test.BluetoothBaseTest)
 
         self.bt_utils.pair_primary_to_secondary()
         self.call_utils.wait_with_log(constants.DEVICE_CONNECT_WAIT_TIME)
+        super().enable_recording()
 
     def test_connection_status_displayed_on_device_screen(self):
+        # Log BT Connection State after pairing
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT State after pairing : <%s>", bt_connection_state)
+
         # Open bluetooth settings.
-        self.call_utils.open_bluetooth_settings()
+        self.call_utils.open_bluetooth_settings_form_status_bar()
         self.call_utils.wait_with_log(2)
 
         # Find the target device and disconnect it on the Level One page
diff --git a/tests/automotive/mobly_tests/connectivity/connectivity_test_status_displayed_in_l2.py b/tests/automotive/mobly_tests/connectivity/connectivity_test_status_displayed_in_l2.py
index ac485667e..20967a282 100644
--- a/tests/automotive/mobly_tests/connectivity/connectivity_test_status_displayed_in_l2.py
+++ b/tests/automotive/mobly_tests/connectivity/connectivity_test_status_displayed_in_l2.py
@@ -31,7 +31,7 @@ from bluetooth_test import bluetooth_base_test
 from mobly import asserts
 from utilities.main_utils import common_main
 from utilities import constants
-
+import logging
 
 MOBILE_DEVICE_NAME = 'target'
 AUTOMOTIVE_DEVICE_NAME = 'discoverer'
@@ -42,8 +42,13 @@ class BluetoothConnectionStatusOnLevelTwo(bluetooth_base_test.BluetoothBaseTest)
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_connection_status_displayed_on_device_screen(self):
+        # Log BT Connection State after pairing
+        bt_connection_state=self.call_utils.get_bt_connection_status_using_adb_command(self.discoverer)
+        logging.info("BT State after pairing : <%s>", bt_connection_state)
+
         # Open bluetooth settings.
         self.call_utils.open_bluetooth_settings()
 
diff --git a/tests/automotive/mobly_tests/dialer/bt_utility_test.py b/tests/automotive/mobly_tests/dialer/bt_utility_test.py
index c55fae6cb..888d965b0 100644
--- a/tests/automotive/mobly_tests/dialer/bt_utility_test.py
+++ b/tests/automotive/mobly_tests/dialer/bt_utility_test.py
@@ -55,6 +55,7 @@ class UtilityClassTest(bluetooth_base_test.BluetoothBaseTest):
         super().setup_test()
         # Pair caller phone with automotive device
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_call_utility(self):
         # Navigate to the phone app page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_hfp_error_test.py b/tests/automotive/mobly_tests/dialer/dialer_hfp_error_test.py
index b2c19ad36..4c64e88f4 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_hfp_error_test.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_hfp_error_test.py
@@ -15,6 +15,7 @@ class DialerHFPError(bluetooth_base_test.BluetoothBaseTest):
     """Setup steps before any test is executed."""
     # Pair caller phone with automotive device
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
 
   def test_dialer_hfp_error(self):
@@ -25,5 +26,10 @@ class DialerHFPError(bluetooth_base_test.BluetoothBaseTest):
     self.call_utils.wait_with_log(5)
     asserts.assert_true(self.call_utils.is_bluetooth_hfp_error_displayed(),'hfp error is displayed')
 
+  def teardown_test(self):
+    # enabling the Bluetooth
+    self.target.mbs.btEnable()
+    super().teardown_test()
+
 if __name__ == '__main__':
     common_main()
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_active_call_off.py b/tests/automotive/mobly_tests/dialer/dialer_test_active_call_off.py
index 325a60b1b..c14626cc2 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_active_call_off.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_active_call_off.py
@@ -37,6 +37,7 @@ class DialerActiveCallOff(bluetooth_sms_base_test.BluetoothSMSBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_active_call_off(self):
 
@@ -55,7 +56,7 @@ class DialerActiveCallOff(bluetooth_sms_base_test.BluetoothSMSBaseTest):
 
         # Receive and answer the call
         self.call_utils.wait_with_log(5)
-        self.discoverer.mbs.clickUIElementWithText(constants.ACCEPT_CALL_TEXT)
+        self.discoverer.mbs.clickUIElementWithText(constants.ANSWER_CALL_TEXT)
         self.call_utils.wait_with_log(2)
         # Verify that the in-progress call is displayed in full-screen view.
         asserts.assert_false(
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_active_call_on.py b/tests/automotive/mobly_tests/dialer/dialer_test_active_call_on.py
index 0f08a8386..998843937 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_active_call_on.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_active_call_on.py
@@ -37,6 +37,7 @@ class DialerActiveCallOn(bluetooth_sms_base_test.BluetoothSMSBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_active_call_on(self):
 
@@ -56,7 +57,7 @@ class DialerActiveCallOn(bluetooth_sms_base_test.BluetoothSMSBaseTest):
 
         # Receive and answer the call
         self.call_utils.wait_with_log(10)
-        self.discoverer.mbs.clickUIElementWithText(constants.ACCEPT_CALL_TEXT)
+        self.discoverer.mbs.clickUIElementWithText(constants.ANSWER_CALL_TEXT)
         self.call_utils.wait_with_log(2)
         # Verify that the in-progress call is displayed in full-screen view.
         asserts.assert_true(
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_add_remove_favorite_contact.py b/tests/automotive/mobly_tests/dialer/dialer_test_add_remove_favorite_contact.py
index b7eb4e549..c68d85180 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_add_remove_favorite_contact.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_add_remove_favorite_contact.py
@@ -27,6 +27,7 @@ from bluetooth_test import bluetooth_base_test
 
 from utilities import constants
 from utilities.main_utils import common_main
+from mobly import asserts
 
 class AddRemoveFavoriteContact(bluetooth_base_test.BluetoothBaseTest):
   """Enable and Disable Bluetooth from Bluetooth Palette."""
@@ -41,15 +42,27 @@ class AddRemoveFavoriteContact(bluetooth_base_test.BluetoothBaseTest):
     self.call_utils.wait_with_log(5)
     # Pair caller phone with automotive device
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
   def test_add_remove_favorite_contact(self):
     """Tests add remove favorite contact."""
-    contact_name = "John Smith"
+    contact_name = "Adam Allen"
     self.call_utils.open_phone_app()
 
     # Adding the contacts to favorites from the favorites tab and verifying it
     self.call_utils.add_favorites_from_favorites_tab(
         contact_name)
+    asserts.assert_true(self.discoverer.mbs.hasUIElementWithText(contact_name),
+                        'Favorite contact should be displayed on Favorites Tab')
+    self.discoverer.mbs.clickUIElementWithText(contact_name)
+
+    self.call_utils.wait_with_log(2)
+    self.call_utils.is_ongoing_call_displayed_on_home(True)
+    self.call_utils.open_phone_app_from_home()
+    asserts.assert_true(self.discoverer.mbs.hasUIElementWithText(contact_name),
+                        'Favorite contact should be displayed on homescreen during call')
+
+    self.call_utils.end_call()
     self.call_utils.is_contact_in_favorites(
         contact_name, True)
     self.call_utils.wait_with_log(10)
@@ -61,5 +74,12 @@ class AddRemoveFavoriteContact(bluetooth_base_test.BluetoothBaseTest):
     self.call_utils.is_contact_in_favorites(
         contact_name, False)
 
+  def teardown_test(self):
+      # End call if test failed
+    self.call_utils.end_call_using_adb_command(self.target)
+    self.call_utils.wait_with_log(5)
+    self.call_utils.press_home()
+    super().teardown_test()
+
 if __name__ == '__main__':
     common_main()
\ No newline at end of file
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_basic_calling_test_with_reject_call.py b/tests/automotive/mobly_tests/dialer/dialer_test_basic_calling_test_with_reject_call.py
index f7d3bdd5c..477a367da 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_basic_calling_test_with_reject_call.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_basic_calling_test_with_reject_call.py
@@ -35,6 +35,7 @@ class CallingDeclineBtTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_basic_call(self):
          # call the callee phone with automotive device
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_bluetooth_settings_reflection.py b/tests/automotive/mobly_tests/dialer/dialer_test_bluetooth_settings_reflection.py
index 11874a95b..46d1fcdd1 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_bluetooth_settings_reflection.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_bluetooth_settings_reflection.py
@@ -36,6 +36,7 @@ class BluetoothSettingsReflection(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_bluetooth_settings_reflected_in_dialer(self):
 
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_call_audio_source_transferring.py b/tests/automotive/mobly_tests/dialer/dialer_test_call_audio_source_transferring.py
index 27bc0b6f5..dc0e471bf 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_call_audio_source_transferring.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_call_audio_source_transferring.py
@@ -23,6 +23,7 @@ class ChangeAudioSourceTest(bluetooth_base_test.BluetoothBaseTest):
     """Setup steps before any test is executed."""
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
   def test_switch_audio_sources_while_in_call(self):
     """Test audio source transferring functionality."""
 
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_call_from_history.py b/tests/automotive/mobly_tests/dialer/dialer_test_call_from_history.py
index 5245a1f10..f08899713 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_call_from_history.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_call_from_history.py
@@ -14,17 +14,19 @@ from utilities.main_utils import common_main
 from bluetooth_test import bluetooth_base_test
 
 
-class MakeCallFromHistotyTest(bluetooth_base_test.BluetoothBaseTest):
+class MakeCallFromHistoryTest(bluetooth_base_test.BluetoothBaseTest):
   """Implement calling to ten digits number test."""
   def setup_test(self):
 
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
+
   def test_dial_large_digits_number(self):
-    """Tests the calling tten digits number functionality."""
+    """Tests the calling ten digits number functionality."""
     #Variable
-    dialer_test_phone_number = constants.DIALER_THREE_DIGIT_NUMBER
-    #Tests the calling three digits number functionality
+    dialer_test_phone_number = constants.DIALER_LARGE_DIGIT_NUMBER
+    #Tests the calling ten digits number functionality
 
     self.call_utils.dial_a_number(dialer_test_phone_number)
     self.call_utils.make_call()
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_connected_phone_in_settings.py b/tests/automotive/mobly_tests/dialer/dialer_test_connected_phone_in_settings.py
index aadae8c41..c9b3cc054 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_connected_phone_in_settings.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_connected_phone_in_settings.py
@@ -41,6 +41,7 @@ class ConnectedPhoneTest(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_connected_phone_displayed(self):
         # Navigate to the Dialer App page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_contact_test.py b/tests/automotive/mobly_tests/dialer/dialer_test_contact_test.py
index 6b569a831..0925804f9 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_contact_test.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_contact_test.py
@@ -40,6 +40,7 @@ class CallContactTest(bluetooth_base_test.BluetoothBaseTest):
 
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_call_contact(self):
         # Navigate to the Contacts page
@@ -47,10 +48,10 @@ class CallContactTest(bluetooth_base_test.BluetoothBaseTest):
         self.call_utils.open_contacts()
         self.call_utils.wait_with_log(5)
 
-        contactToCall = super.discoverer.mbs.getFirstContactFromContactList()
+        contactToCall = self.discoverer.mbs.getFirstContactFromContactList()
         logging.info("Attempting to call contact: %s", contactToCall)
 
-        super.discoverer.mbs.callContact(contactToCall)
+        self.discoverer.mbs.callContact(contactToCall)
 
         # end_call() acts as an automatic verifying that a call is underway
         # since end_call() will throw an exception if no end_call button is available.
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_decline_incoming_call.py b/tests/automotive/mobly_tests/dialer/dialer_test_decline_incoming_call.py
index c2855a275..1ac5eea4d 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_decline_incoming_call.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_decline_incoming_call.py
@@ -39,6 +39,7 @@ class BTDialerDeclineCall(bluetooth_sms_base_test.BluetoothSMSBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
 
     def test_reject_incoming_call(self):
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_delete_dialed_number.py b/tests/automotive/mobly_tests/dialer/dialer_test_delete_dialed_number.py
index 6c85af03c..6f2b82520 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_delete_dialed_number.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_delete_dialed_number.py
@@ -26,6 +26,8 @@ class DeleteDialedNumberTest(bluetooth_base_test.BluetoothBaseTest):
     """Setup steps before any test is executed."""
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
+
   def test_delete_dialed_number(self):
     """Test the calling three digits number functionality."""
 
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_dial_test.py b/tests/automotive/mobly_tests/dialer/dialer_test_dial_test.py
index 2c2ff4bb6..6900e2bb7 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_dial_test.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_dial_test.py
@@ -33,10 +33,11 @@ class BluetoothDialTest(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_dial_large_digits_number(self):
         #Variable
-        dialer_test_phone_number = constants.DIALER_THREE_DIGIT_NUMBER
+        dialer_test_phone_number = constants.INFORMATION_THREE_DIGIT_NUMBER
         #Tests the calling three digits number functionality
         logging.info(
             'Calling from %s calling to %s',
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_import_address_details.py b/tests/automotive/mobly_tests/dialer/dialer_test_import_address_details.py
index 72aa55067..4bf33ed21 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_import_address_details.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_import_address_details.py
@@ -52,6 +52,7 @@ class ImportAddressDetailsTest(bluetooth_base_test.BluetoothBaseTest):
 
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_import_address_details(self):
         # Open the dialer app, and then the contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_launch_from_phone_card.py b/tests/automotive/mobly_tests/dialer/dialer_test_launch_from_phone_card.py
index 2e6c9a281..ba838305a 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_launch_from_phone_card.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_launch_from_phone_card.py
@@ -35,6 +35,7 @@ class BTDialerPhoneCard(bluetooth_sms_base_test.BluetoothSMSBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
 
     def test_launch_dialer_from_phone_card(self):
@@ -42,20 +43,20 @@ class BTDialerPhoneCard(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         # call from the unpaired phone to the paired phone
         callee_number = self.phone_notpaired.mbs.getPhoneNumber()
         self.phone_utils.call_number_from_home_screen(callee_number)
-        self.call_utils.wait_with_log(constants.DEFAULT_WAIT_TIME_FIFTEEN_SECS)
+        self.call_utils.wait_with_log(10)
 
         # accept the call (on the unpaired phone)
         self.phone_notpaired.mbs.clickUIElementWithText(constants.ACCEPT_CALL_TEXT)
-        self.call_utils.wait_with_log(constants.WAIT_FOR_LOAD)
+        self.call_utils.wait_with_log(10)
+        self.call_utils.press_home()
 
         # Confirm that a call is ongoing
         asserts.assert_true(
             self.discoverer.mbs.isOngoingCallDisplayedOnHome(),
-            "Expected no ongoing call to be displayed on home after Declining call, but found one."
+            "Expected ongoing call to be displayed on home, but found none."
         )
 
         # Launch the dialer from the phone card
-        self.call_utils.press_home()
         self.call_utils.press_dialer_button_on_phone_card()
         # Verify that the in-progress call is displayed in full-screen view.
         asserts.assert_true(
@@ -68,7 +69,7 @@ class BTDialerPhoneCard(bluetooth_sms_base_test.BluetoothSMSBaseTest):
 
     def teardown_test(self):
         # End call if test failed
-        self.call_utils.end_call_using_adb_command(self.phone_notpaired)
+        self.call_utils.end_call_using_adb_command(self.target)
         super().teardown_test()
 
 if __name__ == '__main__':
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_mute_unmute_call.py b/tests/automotive/mobly_tests/dialer/dialer_test_mute_unmute_call.py
index ffd30ad33..558747e45 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_mute_unmute_call.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_mute_unmute_call.py
@@ -33,11 +33,12 @@ class BluetoothMuteUnmuteCallTest(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_dial_phone_number(self):
         """Tests mute and unmute during phone call functionality."""
         #Variable
-        dialer_test_phone_number = constants.DIALER_THREE_DIGIT_NUMBER
+        dialer_test_phone_number = constants.INFORMATION_THREE_DIGIT_NUMBER
         logging.info(
             'Calling from %s calling to %s',
             self.target.serial,
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_page_refresh.py b/tests/automotive/mobly_tests/dialer/dialer_test_page_refresh.py
index f998c6da8..69ca80a89 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_page_refresh.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_page_refresh.py
@@ -35,6 +35,7 @@ class DialerPageRefresh(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_dialer_page_refresh(self):
 
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_search_contact_by_phone_number.py b/tests/automotive/mobly_tests/dialer/dialer_test_search_contact_by_phone_number.py
index 92aa05f53..52f19fe02 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_search_contact_by_phone_number.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_search_contact_by_phone_number.py
@@ -37,6 +37,7 @@ class SearchContactByPhoneNumberTest(bluetooth_base_test.BluetoothBaseTest):
      self.call_utils.upload_vcf_contacts_to_device(self.target, file_path)
      # Pair the devices
      self.bt_utils.pair_primary_to_secondary()
+     super().enable_recording()
 
 
     def test_search_contact_by_phone_number(self):
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_and_call.py b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_and_call.py
index fb3abde6c..724cba21e 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_and_call.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_and_call.py
@@ -38,6 +38,7 @@ class ContactSearchAndCall(bluetooth_base_test.BluetoothBaseTest):
 
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_search_contacts_and_call(self):
         # Navigate to the Contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_first_name.py b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_first_name.py
index d1ead7153..6254b37e4 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_first_name.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_first_name.py
@@ -39,6 +39,7 @@ class ContactSearchByFirstNameTest(bluetooth_base_test.BluetoothBaseTest):
 
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
   def test_sort_contacts_by_first_name(self):
     # Navigate to the Contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_last_name.py b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_last_name.py
index 5d47b292e..c6aa78d15 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_last_name.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_search_contacts_by_last_name.py
@@ -39,6 +39,7 @@ class ContactSearchByLastNameTest(bluetooth_base_test.BluetoothBaseTest):
 
     # Pair the devices
     self.bt_utils.pair_primary_to_secondary()
+    super().enable_recording()
 
   def test_sort_contacts_by_last_name(self):
     # Navigate to the Contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_search_showing_found_contacts.py b/tests/automotive/mobly_tests/dialer/dialer_test_search_showing_found_contacts.py
index 287056640..314bec553 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_search_showing_found_contacts.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_search_showing_found_contacts.py
@@ -38,6 +38,7 @@ class SearchShowingFoundContact(bluetooth_base_test.BluetoothBaseTest):
      self.call_utils.upload_vcf_contacts_to_device(self.target, file_path)
      # Pair the devices
      self.bt_utils.pair_primary_to_secondary()
+     super().enable_recording()
 
 
     def test_search_contact_by_phone_number(self):
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_first_name.py b/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_first_name.py
index c805413fd..44d26f1ad 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_first_name.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_first_name.py
@@ -39,6 +39,7 @@ class CallContactSortTest(bluetooth_base_test.BluetoothBaseTest):
 
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_sort_contacts_by_first_name(self):
         # Navigate to the Contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_last_name.py b/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_last_name.py
index 9ed93cf83..fc3f2fa16 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_last_name.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_sort_contacts_by_last_name.py
@@ -56,6 +56,7 @@ class CallContactSortTest(bluetooth_base_test.BluetoothBaseTest):
 
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
 
     def test_sort_contacts_by_last_name(self):
         # Navigate to the Contacts page
diff --git a/tests/automotive/mobly_tests/dialer/dialer_test_verify_call_history.py b/tests/automotive/mobly_tests/dialer/dialer_test_verify_call_history.py
index b93f177b3..8c2716706 100644
--- a/tests/automotive/mobly_tests/dialer/dialer_test_verify_call_history.py
+++ b/tests/automotive/mobly_tests/dialer/dialer_test_verify_call_history.py
@@ -34,11 +34,14 @@ class VerifyCallHistory(bluetooth_base_test.BluetoothBaseTest):
         """Setup steps before any test is executed."""
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+
     def test_verify_call_history(self):
         """
             Assumes a new phone image with no call history.
         """
         # Set up mobile device
+        contact_name = "Adam Allen"
         primary_test_number = constants.DIALER_THREE_DIGIT_NUMBER
         secondary_test_number = constants.INFORMATION_THREE_DIGIT_NUMBER
 
@@ -63,9 +66,9 @@ class VerifyCallHistory(bluetooth_base_test.BluetoothBaseTest):
         # TODO: This test may be upgraded to get the number of history entries from the
         # target device for comparison, and to compare call history type (i.e., 'correct arrows')
         asserts.assert_true(
-            self.discoverer.mbs.hasUIElementWithText(primary_test_number),
-            "Expected number %s in call history, but did not see it on screen"
-            % primary_test_number
+            self.discoverer.mbs.hasUIElementWithText(contact_name),
+            "Expected name %s in call history, but did not see it on screen"
+            % contact_name
         )
 
         asserts.assert_true(
diff --git a/tests/automotive/mobly_tests/media/media_test_avrcp_tree_displayed.py b/tests/automotive/mobly_tests/media/media_test_avrcp_tree_displayed.py
index 565d3369e..821acc308 100644
--- a/tests/automotive/mobly_tests/media/media_test_avrcp_tree_displayed.py
+++ b/tests/automotive/mobly_tests/media/media_test_avrcp_tree_displayed.py
@@ -20,7 +20,6 @@ from utilities import constants
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
 from utilities.media_utils import MediaUtils
-from utilities.video_utils_service import VideoRecording
 
 
 class IsTreeDisplayedTest(bluetooth_base_test.BluetoothBaseTest):
@@ -32,18 +31,20 @@ class IsTreeDisplayedTest(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        self.media_utils.enable_bt_media_debugging_logs()
+        super().enable_recording()
+
 
     def test_media_is_tree_displayed(self):
         """Tests validating is AVRCP Tree - Displayed"""
+        self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
         asserts.assert_true(current_phone_song_title == current_hu_song_title,
                             'Invalid song titles. '
@@ -64,12 +65,6 @@ class IsTreeDisplayedTest(bluetooth_base_test.BluetoothBaseTest):
         # Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_categories_playlists_selectable.py b/tests/automotive/mobly_tests/media/media_test_categories_playlists_selectable.py
index b9bb0602e..1374c7808 100644
--- a/tests/automotive/mobly_tests/media/media_test_categories_playlists_selectable.py
+++ b/tests/automotive/mobly_tests/media/media_test_categories_playlists_selectable.py
@@ -37,16 +37,15 @@ class IsCategoriesPlaylistsSelectable(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        self.media_utils.enable_bt_media_debugging_logs()
+        super().enable_recording()
 
     def test_is_categories_playlists_selectable(self):
         """Tests validating is categories selectable on HU"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -75,12 +74,6 @@ class IsCategoriesPlaylistsSelectable(bluetooth_base_test.BluetoothBaseTest):
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_device_not_paired.py b/tests/automotive/mobly_tests/media/media_test_device_not_paired.py
index 573ba4314..163244c06 100644
--- a/tests/automotive/mobly_tests/media/media_test_device_not_paired.py
+++ b/tests/automotive/mobly_tests/media/media_test_device_not_paired.py
@@ -23,6 +23,7 @@ class DeviceNotPairedTest(bluetooth_base_test.BluetoothBaseTest):
     def setup_test(self):
         """Enable and disable BT on Head unit"""
         super().setup_test()
+        super().enable_recording()
 
     def test_device_not_paired(self):
         """Tests lunch Bluetooth Audio app and verify <Bluetooth Disconnected> displayed."""
diff --git a/tests/automotive/mobly_tests/media/media_test_device_sync_after_hu_start.py b/tests/automotive/mobly_tests/media/media_test_device_sync_after_hu_start.py
index 33b96f772..32ceb6da2 100644
--- a/tests/automotive/mobly_tests/media/media_test_device_sync_after_hu_start.py
+++ b/tests/automotive/mobly_tests/media/media_test_device_sync_after_hu_start.py
@@ -32,29 +32,24 @@ class IsDeviceSyncedAfterHuStart(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for phone Target")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_is_hu_synced_after_hu_start(self):
         """Tests validating is media synced after HU start"""
         # Reboot HU
         self.discoverer.unload_snippet('mbs')
-        super().hu_recording_handler()
         self.discoverer.reboot()
         self.call_utils.wait_with_log(10)
-        logging.info("\tInitializing video services on HU post reboot")
-        self.video_utils_service = VideoRecording(self.discoverer, self.__class__.__name__)
-        logging.info("Enabling video recording for HU post reboot")
         self.video_utils_service.enable_screen_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
         self.media_utils.open_youtube_music_app()
         self.call_utils.wait_with_log(30)
         self.discoverer.load_snippet('mbs', android_device.MBS_PACKAGE)
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
         asserts.assert_true(self.media_utils.is_song_playing_on_hu(),
                             'Song should be playing after HU reboot')
@@ -66,13 +61,7 @@ class IsDeviceSyncedAfterHuStart(bluetooth_base_test.BluetoothBaseTest):
         # Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
-        super().teardown_test()
+        super().teardown_no_video_recording()
 
 
 if __name__ == '__main__':
diff --git a/tests/automotive/mobly_tests/media/media_test_now_playing_label_displayed.py b/tests/automotive/mobly_tests/media/media_test_now_playing_label_displayed.py
index 0d5e74184..b568b23d3 100644
--- a/tests/automotive/mobly_tests/media/media_test_now_playing_label_displayed.py
+++ b/tests/automotive/mobly_tests/media/media_test_now_playing_label_displayed.py
@@ -19,7 +19,6 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
 
 
 class IsNowPlayingLabelDisplayed(bluetooth_base_test.BluetoothBaseTest):
@@ -31,34 +30,36 @@ class IsNowPlayingLabelDisplayed(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        self.media_utils.enable_bt_media_debugging_logs()
+        super().enable_recording()
 
     def test_is_now_paying_label_displayed(self):
         """Tests is Now Playing label displayed on HU"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         self.call_utils.wait_with_log(5)
         logging.info("Getting song title from phone device: %s", self.media_utils.get_song_title_from_phone())
         self.media_utils.pause_media_on_hu()
         self.media_utils.maximize_now_playing()
+        self.call_utils.wait_with_log(5)
         asserts.assert_true(self.media_utils.is_now_playing_label_displayed(),
                             '<Now Playing> label should be displayed')
 
     def teardown_test(self):
+        # Minimize now_playing
+        self.media_utils.minimize_now_playing()
         # Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
+#         logging.info("Stopping the screen recording on Target")
+#         self.video_utils_service_target.stop_screen_recording()
+#         logging.info("Pull the screen recording from Target")
+#         self.video_utils_service_target.pull_recording_file(self.log_path)
+#         logging.info("delete the screen recording from the Target")
+#         self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_play_media_from_widget.py b/tests/automotive/mobly_tests/media/media_test_play_media_from_widget.py
index 68472b7b9..86c91c383 100644
--- a/tests/automotive/mobly_tests/media/media_test_play_media_from_widget.py
+++ b/tests/automotive/mobly_tests/media/media_test_play_media_from_widget.py
@@ -19,7 +19,6 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
 
 
 class IsAbleToPlayMediaFromWidgetTest(bluetooth_base_test.BluetoothBaseTest):
@@ -31,22 +30,23 @@ class IsAbleToPlayMediaFromWidgetTest(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for phone Target")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_media_is_song_playing(self):
         """Tests validating play/pause media on HU"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         logging.info("Getting song title from phone device: %s", self.media_utils.get_song_title_from_phone())
         self.media_utils.press_pause_song_button()
+        self.call_utils.wait_with_log(3)
         asserts.assert_false(self.media_utils.is_song_playing_on_hu(),
                              'Media player should be on PAUSE mode')
         self.media_utils.play_media_on_hu()
+        self.call_utils.wait_with_log(3)
         asserts.assert_true(self.media_utils.is_song_playing_on_hu(),
                             'Media player should be on PLAY mode')
 
@@ -54,12 +54,6 @@ class IsAbleToPlayMediaFromWidgetTest(bluetooth_base_test.BluetoothBaseTest):
         #   Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_play_status_after_reboot.py b/tests/automotive/mobly_tests/media/media_test_play_status_after_reboot.py
index dd03ef5e2..ff2267952 100644
--- a/tests/automotive/mobly_tests/media/media_test_play_status_after_reboot.py
+++ b/tests/automotive/mobly_tests/media/media_test_play_status_after_reboot.py
@@ -32,17 +32,15 @@ class IsSongPLayingAfterRebootTest(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for phone Target")
-        self.video_utils_service_target.enable_screen_recording()
-
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        self.media_utils.enable_bt_media_debugging_logs()
+        super().enable_recording()
 
     def test_is_song_playing_after_reboot(self):
         """Tests validating is song playing on HU after reboot HU"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -52,17 +50,12 @@ class IsSongPLayingAfterRebootTest(bluetooth_base_test.BluetoothBaseTest):
 
         # Reboot HU
         self.discoverer.unload_snippet('mbs')
-        super().hu_recording_handler()
         self.discoverer.reboot()
         self.call_utils.wait_with_log(30)
         self.discoverer.load_snippet('mbs', android_device.MBS_PACKAGE)
-
-        logging.info("\tInitializing video services on HU post reboot")
-        self.video_utils_service = VideoRecording(self.discoverer, self.__class__.__name__)
-        logging.info("Enabling video recording for HU post reboot")
-        self.video_utils_service.enable_screen_recording()
-
+        self.media_utils.enable_bt_media_debugging_logs()
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         # Assert song is playing after HU reboot
         asserts.assert_true(self.media_utils.is_song_playing_on_hu(),
                             'Song should be playing after HU reboot')
@@ -77,13 +70,7 @@ class IsSongPLayingAfterRebootTest(bluetooth_base_test.BluetoothBaseTest):
         # Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
-        super().teardown_test()
+        super().teardown_no_video_recording()
 
 
 if __name__ == '__main__':
diff --git a/tests/automotive/mobly_tests/media/media_test_playlist_rendering.py b/tests/automotive/mobly_tests/media/media_test_playlist_rendering.py
index ebbeca45d..820b344a1 100644
--- a/tests/automotive/mobly_tests/media/media_test_playlist_rendering.py
+++ b/tests/automotive/mobly_tests/media/media_test_playlist_rendering.py
@@ -19,8 +19,6 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
-
 
 class PlaylistRendering(bluetooth_base_test.BluetoothBaseTest):
 
@@ -31,17 +29,16 @@ class PlaylistRendering(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for phone Target")
-        self.video_utils_service_target.enable_screen_recording()
 
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_playlist_rendering(self):
         """Tests validating is song selectable using playlist on HU"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         logging.info("Getting song title from phone device: %s", self.media_utils.get_song_title_from_phone())
         self.media_utils.maximize_now_playing()
@@ -58,15 +55,11 @@ class PlaylistRendering(bluetooth_base_test.BluetoothBaseTest):
                             'Song title on phone device and HU should be the same')
 
     def teardown_test(self):
+        # Minimize now_playing
+        self.media_utils.minimize_now_playing()
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_prev_and_next_song_metadata_validation.py b/tests/automotive/mobly_tests/media/media_test_prev_and_next_song_metadata_validation.py
index b0ecf3d45..86a333378 100644
--- a/tests/automotive/mobly_tests/media/media_test_prev_and_next_song_metadata_validation.py
+++ b/tests/automotive/mobly_tests/media/media_test_prev_and_next_song_metadata_validation.py
@@ -22,7 +22,7 @@ from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
 from utilities.video_utils_service import VideoRecording
 
-TIMESTAMP_MATCHER = "^([0-5]?[0-9]):([0-5][0-9])$"
+TIMESTAMP_MATCHER = "^([0-5]?[0-9]):([0-5][0-9]):([0-5]?[0-9])$"
 
 
 class IsMediaMetadataForNextAndPrevSongOnHuValid(bluetooth_base_test.BluetoothBaseTest):
@@ -31,6 +31,8 @@ class IsMediaMetadataForNextAndPrevSongOnHuValid(bluetooth_base_test.BluetoothBa
         super().setup_class()
         self.media_utils = MediaUtils(self.target, self.discoverer)
         self.common_utils = CommonUtils(self.target, self.discoverer)
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
@@ -44,6 +46,7 @@ class IsMediaMetadataForNextAndPrevSongOnHuValid(bluetooth_base_test.BluetoothBa
     def test_is_media_metadata_valid_on_hu(self):
         """Tests is media metadata on HU valid"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         logging.info("Getting song title from phone device: %s", self.media_utils.get_song_title_from_phone())
         self.call_utils.wait_with_log(5)
@@ -128,6 +131,8 @@ class IsMediaMetadataForNextAndPrevSongOnHuValid(bluetooth_base_test.BluetoothBa
                                       '<' + actual_previous_current_song_max_playing_time + '>')
 
     def teardown_test(self):
+        # Minimize now_playing
+        self.media_utils.minimize_now_playing()
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
diff --git a/tests/automotive/mobly_tests/media/media_test_select_song_from_playlist.py b/tests/automotive/mobly_tests/media/media_test_select_song_from_playlist.py
index cb17a06b1..c06c3fc01 100644
--- a/tests/automotive/mobly_tests/media/media_test_select_song_from_playlist.py
+++ b/tests/automotive/mobly_tests/media/media_test_select_song_from_playlist.py
@@ -19,7 +19,6 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
 
 
 class SelectSongFromPlaylist(bluetooth_base_test.BluetoothBaseTest):
@@ -31,16 +30,16 @@ class SelectSongFromPlaylist(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
+
 
     def test_media_select_song_from_playlist(self):
         """Tests validating is song playing on HU after after changing song in playlist"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -67,15 +66,11 @@ class SelectSongFromPlaylist(bluetooth_base_test.BluetoothBaseTest):
                             'Song title on phone device and HU should be the same')
 
     def teardown_test(self):
+        # Minimize now_playing
+        self.media_utils.minimize_now_playing()
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_song_is_playing.py b/tests/automotive/mobly_tests/media/media_test_song_is_playing.py
index 4d3de1bcb..cb14df37c 100644
--- a/tests/automotive/mobly_tests/media/media_test_song_is_playing.py
+++ b/tests/automotive/mobly_tests/media/media_test_song_is_playing.py
@@ -19,7 +19,7 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
+# from utilities.video_utils_service import VideoRecording
 
 
 class IsSongPlayingTest(bluetooth_base_test.BluetoothBaseTest):
@@ -31,16 +31,15 @@ class IsSongPlayingTest(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target device")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_media_is_song_playing(self):
         """Tests validating is song playing on HU, and song title"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -60,12 +59,6 @@ class IsSongPlayingTest(bluetooth_base_test.BluetoothBaseTest):
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_song_metadata_validation.py b/tests/automotive/mobly_tests/media/media_test_song_metadata_validation.py
index 234f101c1..71e440153 100644
--- a/tests/automotive/mobly_tests/media/media_test_song_metadata_validation.py
+++ b/tests/automotive/mobly_tests/media/media_test_song_metadata_validation.py
@@ -20,9 +20,8 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
 
-TIMESTAMP_MATCHER = "^([0-5]?[0-9]):([0-5][0-9])$"
+TIMESTAMP_MATCHER = "^([0-5]?[0-9]):([0-5][0-9]):([0-5]?[0-9])$"
 
 
 class IsMediaMetadataOnHuValid(bluetooth_base_test.BluetoothBaseTest):
@@ -34,16 +33,15 @@ class IsMediaMetadataOnHuValid(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_is_media_metadata_valid_on_hu(self):
         """Tests is media metadata on HU valid"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         self.media_utils.pause_media_on_hu()
@@ -89,15 +87,11 @@ class IsMediaMetadataOnHuValid(bluetooth_base_test.BluetoothBaseTest):
                                       '<' + actual_current_song_max_playing_time + '>')
 
     def teardown_test(self):
+        # Minimize now_playing
+        self.media_utils.minimize_now_playing()
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_stream_when_radio_lunched.py b/tests/automotive/mobly_tests/media/media_test_stream_when_radio_lunched.py
index f7a87c2e4..a33943d4d 100644
--- a/tests/automotive/mobly_tests/media/media_test_stream_when_radio_lunched.py
+++ b/tests/automotive/mobly_tests/media/media_test_stream_when_radio_lunched.py
@@ -20,7 +20,6 @@ from utilities import constants
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
 from utilities.media_utils import MediaUtils
-from utilities.video_utils_service import VideoRecording
 
 
 class IsMediaStreamPairedWhenRadioLunchedTest(bluetooth_base_test.BluetoothBaseTest):
@@ -32,22 +31,21 @@ class IsMediaStreamPairedWhenRadioLunchedTest(bluetooth_base_test.BluetoothBaseT
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_media_stream_when_radio_lunched(self):
         """Pair Mobile when Mobile device is streaming when Radio launched """
         self.media_utils.open_youtube_music_app()
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_media_apps_menu()
         asserts.assert_true(self.common_utils.has_ui_element_with_text(constants.RADIO_APP),
                             '<' + constants.RADIO_APP + '> has to be present on HU screen')
-        self.media_utils.open_radio_app_on_hu()
+        self.media_utils.open_radio_app()
         self.media_utils.tune_fm_radio_on_hu(constants.DEFAULT_FM_FREQUENCY)
-        self.bt_utils.pair_primary_to_secondary()
+#         self.bt_utils.pair_primary_to_secondary()
         self.media_utils.open_media_app_on_hu()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -59,12 +57,6 @@ class IsMediaStreamPairedWhenRadioLunchedTest(bluetooth_base_test.BluetoothBaseT
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_switch_app_validation.py b/tests/automotive/mobly_tests/media/media_test_switch_app_validation.py
index 95b423b60..b2f7553ab 100644
--- a/tests/automotive/mobly_tests/media/media_test_switch_app_validation.py
+++ b/tests/automotive/mobly_tests/media/media_test_switch_app_validation.py
@@ -20,7 +20,6 @@ from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
 from utilities import constants
-from utilities.video_utils_service import VideoRecording
 
 
 class IsAbleToSwitchAppTest(bluetooth_base_test.BluetoothBaseTest):
@@ -32,16 +31,15 @@ class IsAbleToSwitchAppTest(bluetooth_base_test.BluetoothBaseTest):
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for Target device")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_media_is_able_to_switch_app(self):
         """Tests validating song title on HU after switch media app"""
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -82,12 +80,6 @@ class IsAbleToSwitchAppTest(bluetooth_base_test.BluetoothBaseTest):
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/media/media_test_synchronized_device_disconnected_connected.py b/tests/automotive/mobly_tests/media/media_test_synchronized_device_disconnected_connected.py
index 6f9aa7f4c..d9810b33f 100644
--- a/tests/automotive/mobly_tests/media/media_test_synchronized_device_disconnected_connected.py
+++ b/tests/automotive/mobly_tests/media/media_test_synchronized_device_disconnected_connected.py
@@ -20,7 +20,6 @@ from mobly import asserts
 from utilities.media_utils import MediaUtils
 from utilities.common_utils import CommonUtils
 from utilities.main_utils import common_main
-from utilities.video_utils_service import VideoRecording
 
 
 class IsMediaSynchronizedForReconnectedDevice(bluetooth_base_test.BluetoothBaseTest):
@@ -32,17 +31,16 @@ class IsMediaSynchronizedForReconnectedDevice(bluetooth_base_test.BluetoothBaseT
 
     def setup_test(self):
         self.common_utils.grant_local_mac_address_permission()
-        logging.info("\tInitializing video services on Target")
-        self.video_utils_service_target = VideoRecording(self.target,self.__class__.__name__)
-        logging.info("Enabling video recording for phone Target")
-        self.video_utils_service_target.enable_screen_recording()
         self.common_utils.enable_wifi_on_phone_device()
         self.bt_utils.pair_primary_to_secondary()
+        super().enable_recording()
+        self.media_utils.enable_bt_media_debugging_logs()
 
     def test_is_media_synchronized_after_reconnect_device(self):
         """Tests validating is Media data synchronized after reconnect device"""
         # Validate current song is playing on both devices
         self.media_utils.open_media_app_on_hu()
+        self.call_utils.handle_bluetooth_audio_pop_up()
         self.media_utils.open_youtube_music_app()
         current_phone_song_title = self.media_utils.get_song_title_from_phone()
         current_hu_song_title = self.media_utils.get_song_title_from_hu()
@@ -57,8 +55,6 @@ class IsMediaSynchronizedForReconnectedDevice(bluetooth_base_test.BluetoothBaseT
         # Assert <Bluetooth Audio disconnected> label is present
         asserts.assert_true(self.call_utils.is_bluetooth_audio_disconnected_label_visible(),
                             '<Bluetooth Audio disconnected> label should be present')
-        # Close <Bluetooth Audio disconnected> page
-        self.media_utils.click_on_cancel_bt_audio_connection_button_on_hu()
         # Enable BT on HU
         self.discoverer.mbs.btEnable()
         self.call_utils.wait_with_log(5)
@@ -76,12 +72,6 @@ class IsMediaSynchronizedForReconnectedDevice(bluetooth_base_test.BluetoothBaseT
         #  Close YouTube Music app
         self.media_utils.close_youtube_music_app()
         self.call_utils.press_home()
-        logging.info("Stopping the screen recording on Target")
-        self.video_utils_service_target.stop_screen_recording()
-        logging.info("Pull the screen recording from Target")
-        self.video_utils_service_target.pull_recording_file(self.log_path)
-        logging.info("delete the screen recording from the Target")
-        self.video_utils_service_target.delete_screen_recording_from_device()
         super().teardown_test()
 
 
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_new_unread_sms_auto_sync_test.py b/tests/automotive/mobly_tests/sms/bt_sms_new_unread_sms_auto_sync_test.py
index 8c0464650..04709b119 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_new_unread_sms_auto_sync_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_new_unread_sms_auto_sync_test.py
@@ -53,9 +53,10 @@ class SMSNewUnreadSMSAutoSyncTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.clear_sms_app(self.target)
         # Reboot Phone
         self.target.unload_snippet('mbs')
-        self.call_utils.reboot_device(self.target)
+        self.target.reboot()
         self.call_utils.wait_with_log(30)
         self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
+        super().enable_recording()
 
     def test_new_unread_sms_auto_sync(self):
         # To test that new unread sms appear on HU
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_no_messages_test.py b/tests/automotive/mobly_tests/sms/bt_sms_no_messages_test.py
index 6bb1b1e8a..e29c82358 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_no_messages_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_no_messages_test.py
@@ -51,9 +51,10 @@ class SMSNewUnreadSMSAutoSyncTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
       self.call_utils.clear_sms_app(self.target)
       # Reboot Phone
       self.target.unload_snippet('mbs')
-      self.call_utils.reboot_device(self.target)
+      self.target.reboot()
       self.call_utils.wait_with_log(30)
       self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
+      super().enable_recording()
 
     def test_no_messages_sms(self):
       # To test 'No messages' appears on HU, when there is no sms
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_read_auto_sync_test.py b/tests/automotive/mobly_tests/sms/bt_sms_read_auto_sync_test.py
index 413ad16bd..36807137b 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_read_auto_sync_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_read_auto_sync_test.py
@@ -49,7 +49,7 @@ class SMSReadAutoSync(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.clear_sms_app(self.target)
         # Reboot Phone
         self.target.unload_snippet('mbs')
-        self.call_utils.reboot_device(self.target)
+        self.target.reboot()
         self.call_utils.wait_with_log(30)
         self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
 
@@ -57,6 +57,7 @@ class SMSReadAutoSync(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         target_phone_number = self.target.mbs.getPhoneNumber()
         self.phone_notpaired.mbs.sendSms(target_phone_number,constants.SMS_TEXT)
         self.call_utils.wait_with_log(10)
+        super().enable_recording()
 
     def test_read_sms_auto_sync(self):
 
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_read_messagebd_sync_test.py b/tests/automotive/mobly_tests/sms/bt_sms_read_messagebd_sync_test.py
index 7b4be1711..ef0b4fc34 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_read_messagebd_sync_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_read_messagebd_sync_test.py
@@ -49,9 +49,10 @@ class SMSReadMessageDBSync(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.clear_sms_app(self.target)
         # Reboot Phone
         self.target.unload_snippet('mbs')
-        self.call_utils.reboot_device(self.target)
+        self.target.reboot()
         self.call_utils.wait_with_log(30)
         self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
+        super().enable_recording()
 
     def test_read_sms_messagedb_sync(self):
         # Open the sms app
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_reply_from_phone_sync_test.py b/tests/automotive/mobly_tests/sms/bt_sms_reply_from_phone_sync_test.py
index 2e90588c9..77e4e293f 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_reply_from_phone_sync_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_reply_from_phone_sync_test.py
@@ -61,6 +61,7 @@ class SMSReplyFromPhoneSync(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.open_sms_app()
         self.call_utils.verify_sms_app_unread_message(False)
         self.call_utils.verify_sms_preview_text(True, constants.REPLY_SMS)
+        super().enable_recording()
 
     def teardown_test(self):
          # Go to home screen
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_test_device_not_paired.py b/tests/automotive/mobly_tests/sms/bt_sms_test_device_not_paired.py
index 0f197bf00..b594d0420 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_test_device_not_paired.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_test_device_not_paired.py
@@ -26,6 +26,7 @@ class BTSMSDeviceNotPairedTest(bluetooth_base_test.BluetoothBaseTest):
     # Disable BT on devices
     self.target.mbs.btDisable()
     self.discoverer.mbs.btDisable()
+    super().enable_recording()
 
   def test_messenger_device_not_paired(self):
     """Tests launches SMS Audio app and verify <Bluetooth Disconnected> displayed."""
diff --git a/tests/automotive/mobly_tests/sms/bt_sms_unread_sms_messagedb_sync_test.py b/tests/automotive/mobly_tests/sms/bt_sms_unread_sms_messagedb_sync_test.py
index 83d0069c7..1049e2788 100644
--- a/tests/automotive/mobly_tests/sms/bt_sms_unread_sms_messagedb_sync_test.py
+++ b/tests/automotive/mobly_tests/sms/bt_sms_unread_sms_messagedb_sync_test.py
@@ -49,13 +49,14 @@ class SMSUnreadMessageDBSyncTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.clear_sms_app(self.target)
         # Reboot Phone
         self.target.unload_snippet('mbs')
-        self.call_utils.reboot_device(self.target)
+        self.target.reboot()
         self.call_utils.wait_with_log(30)
         self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
         # send a new sms
         target_phone_number = self.target.mbs.getPhoneNumber()
         self.phone_notpaired.mbs.sendSms(target_phone_number,constants.SMS_TEXT)
         self.call_utils.wait_with_log(10)
+        super().enable_recording()
 
     def test_unread_sms_message_db_sync(self):
         # to test that the unread sms appears on phone after pairing
diff --git a/tests/automotive/mobly_tests/utilities/bt_utils.py b/tests/automotive/mobly_tests/utilities/bt_utils.py
index ad78f5c85..516c10da3 100644
--- a/tests/automotive/mobly_tests/utilities/bt_utils.py
+++ b/tests/automotive/mobly_tests/utilities/bt_utils.py
@@ -77,11 +77,13 @@ class BTUtils:
 
     def pair_primary_to_secondary(self):
         """Enable discovery on the target so the discoverer can find it."""
+        self.check_device_pairing_state()
         # Turn bluetooth on in both machines
         logging.info('Enabling Bluetooth logs')
         self.enable_bt_logs()
         logging.info('Enabling Bluetooth on both devices')
         self.discoverer.mbs.btEnable()
+        self.wakeup_target_device_screen()
         self.target.mbs.btEnable()
         self.disable_android_auto_popup_on_hu()
         logging.info('Setting devices to be discoverable')
@@ -103,6 +105,7 @@ class BTUtils:
             target_address)
         time.sleep(constants.DEFAULT_WAIT_TIME_FIVE_SECS)
         self.handle_assistant_pop_up()
+        logging.info("BT pairing completed.")
 
     def unpair(self):
         # unpair Discoverer device from Target
@@ -153,4 +156,19 @@ class BTUtils:
         logging.info('Enable bluetooth logs')
         self.media_utils.execute_shell_on_hu_device(constants.BLUETOOTH_TAG)
         self.media_utils.execute_shell_on_hu_device(constants.BLUETOOTH_NOOPERABLE)
-        self.media_utils.execute_shell_on_hu_device(constants.BLUETOOTH_BTSNOOP_DEFAULT_MODE)
\ No newline at end of file
+        self.media_utils.execute_shell_on_hu_device(constants.BLUETOOTH_BTSNOOP_DEFAULT_MODE)
+
+    def check_device_pairing_state(self):
+        logging.info('Checking the bt pairing status')
+        if  self.discoverer.mbs.btGetPairedDevices() :
+            logging.info('Device is still paired, unpair the device')
+            self.unpair()
+
+    def is_target_device_screen_on(self):
+        logging.info('Checking the target screen state')
+        return 'Awake' in self.media_utils.execute_shell_on_device(constants.DUMPSYS_POWER).decode('utf8')
+
+    def wakeup_target_device_screen(self):
+        if not self.is_target_device_screen_on():
+          logging.info('Target screen is off, waking it up')
+          self.media_utils.execute_shell_on_device(constants.KEYCODE_WAKEUP)
diff --git a/tests/automotive/mobly_tests/utilities/constants.py b/tests/automotive/mobly_tests/utilities/constants.py
index 689d37597..c6763480f 100644
--- a/tests/automotive/mobly_tests/utilities/constants.py
+++ b/tests/automotive/mobly_tests/utilities/constants.py
@@ -31,6 +31,7 @@ AUTOMOTIVE_DEVICE_NAME = 'discoverer'
 REBOOT = 'reboot'
 DIALER_THREE_DIGIT_NUMBER = "511"
 INFORMATION_THREE_DIGIT_NUMBER = "411"
+DIALER_LARGE_DIGIT_NUMBER="8007770133"
 EXPECTED_CONTACT_FULL_NAME = "John Smith"
 EXPECTED_CONTACT_FIRST_NAME = "John"
 EXPECTED_CONTACT_LAST_NAME = "Smith"
@@ -46,6 +47,7 @@ DECLINE_CALL_TEXT = "Decline"
 ANSWER_CALL_TEXT = "Answer"
 ACCEPT_CALL_TEXT = "Accept"
 DISABLE_ANDROID_AUTO_POP_UP = "pm disable --user 10 com.google.android.embedded.projection"
+NOT_NOW_TEXT ="Not Now"
 
 BTSNOOP_LOG_PATH_ON_DEVICE = '/data/misc/bluetooth/logs/btsnoop_hci.log'
 BTSNOOP_LAST_LOG_PATH_ON_DEVICE = (
@@ -102,7 +104,7 @@ IMPOST_CONTACTS_SHELL_COMAND = (
 )
 
 # Screen recording
-SCREEN_RECORDING_COMMAND = 'screenrecord'
+SCREEN_RECORDING_COMMAND = 'screenrecord --time-limit 180'
 RECORDED_VIDEO_FILE_LOCATION = '/sdcard/'
 RECORDED_VIDEO_FILE_OUTPUT_FILE = '_screenrecord_output_mp4_'
 STOP_VIDEO_RECORDING = f'pkill -SIGINT {SCREEN_RECORDING_COMMAND}'
@@ -118,6 +120,8 @@ KEYCODE_MEDIA_PREVIOUS = 'input keyevent KEYCODE_MEDIA_PREVIOUS'
 KEYCODE_MEDIA_PAUSE = 'input keyevent KEYCODE_MEDIA_PAUSE'
 KEYCODE_MEDIA_PLAY = 'input keyevent KEYCODE_MEDIA_PLAY'
 KEYCODE_MEDIA_STOP = 'input keyevent KEYCODE_MEDIA_STOP'
+KEYCODE_WAKEUP = 'input keyevent KEYCODE_WAKEUP'
+DUMPSYS_POWER= 'dumpsys power|grep mWakefulness'
 
 # YouTube Media
 YOUTUBE_MUSIC_PACKAGE = 'com.google.android.apps.youtube.music'
@@ -162,4 +166,18 @@ DIALER_DIALPAD_LABEL = "Dialpad"
 # Bluetooth Logs
 BLUETOOTH_TAG="setprop persist.log.tag.bluetooth verbose"
 BLUETOOTH_NOOPERABLE="setprop persist.bluetooth.btsnoopenable true"
-BLUETOOTH_BTSNOOP_DEFAULT_MODE="settings put global bluetooth_btsnoop_default_mode full"
\ No newline at end of file
+BLUETOOTH_BTSNOOP_DEFAULT_MODE="settings put global bluetooth_btsnoop_default_mode full"
+
+
+# Media Logs
+PLAYBACK_VIEW_MODEL="setprop persist.log.tag.PlaybackViewModel DEBUG"
+MEDIA_BROWSER_CONNECTOR="setprop persist.log.tag.MediaBrowserConnector DEBUG"
+SETTINGS_CLOCK_SECONDS="settings put secure clock_seconds 1"
+
+
+# Bluetooth State Verification commands
+BLUETOOTH_CONNECTION_STATE = "dumpsys bluetooth_manager | grep ConnectionState"
+BLUETOOTH_MAP = "dumpsys bluetooth_manager | grep -E MceStateMachine"
+BLUETOOTH_HFP ="dumpsys bluetooth_manager | grep HfpClientConnectionService"
+BLUETOOTH_AVRCP =  "dumpsys bluetooth_manager | grep AvrcpControllerStateMachine"
+
diff --git a/tests/automotive/mobly_tests/utilities/contacts_test.vcf b/tests/automotive/mobly_tests/utilities/contacts_test.vcf
index 09ae844fb..5cafde53c 100644
--- a/tests/automotive/mobly_tests/utilities/contacts_test.vcf
+++ b/tests/automotive/mobly_tests/utilities/contacts_test.vcf
@@ -1,5 +1,13 @@
 BEGIN:VCARD
 VERSION:2.1
+N:Allen;Adam;;;
+FN:Adam Allen
+TEL;CELL:511
+TEL;WORK:
+ADR;TYPE#WORK;PREF#1;LABEL#"Normality\nTesttown\, XX 00000\nTestland":;;111 Test Street;Testtown;XX;00000;Testland
+END:VCARD
+BEGIN:VCARD
+VERSION:2.1
 N:Boo;Anna;;;
 FN:Anna Goo
 TEL;CELL:1-844-825-5234
diff --git a/tests/automotive/mobly_tests/utilities/media_utils.py b/tests/automotive/mobly_tests/utilities/media_utils.py
index aebcf1e84..a631e0c98 100644
--- a/tests/automotive/mobly_tests/utilities/media_utils.py
+++ b/tests/automotive/mobly_tests/utilities/media_utils.py
@@ -302,3 +302,8 @@ class MediaUtils:
         else:
             logging.error("Invalid FM Radio frequency. Expected pattern: <%s>",
                           constants.FM_FREQUENCY_PATTERN)
+
+    def enable_bt_media_debugging_logs(self):
+        self.execute_shell_on_hu_device(constants.PLAYBACK_VIEW_MODEL)
+        self.execute_shell_on_hu_device(constants.MEDIA_BROWSER_CONNECTOR)
+        self.execute_shell_on_hu_device(constants.SETTINGS_CLOCK_SECONDS)
diff --git a/tests/automotive/mobly_tests/utilities/phone_device_utils.py b/tests/automotive/mobly_tests/utilities/phone_device_utils.py
index a8a8a875f..3909b1cd3 100644
--- a/tests/automotive/mobly_tests/utilities/phone_device_utils.py
+++ b/tests/automotive/mobly_tests/utilities/phone_device_utils.py
@@ -32,7 +32,14 @@ class PhoneDeviceUtils:
         """Assumes the phone is on its home screen.
         Opens the phone app, then dial pad, enters the given number, and starts a call"""
         self.phone_device.mbs.pressPhoneIcon()
-        self.phone_device.mbs.pressDialpadIcon()
+        logging.info("Close the video call popup on Phone")
+        self.phone_device.mbs.clickUIElementWithText(constants.NOT_NOW_TEXT)
+        isDialPadOpen = self.phone_device.mbs.isDialPadOpen()
+        logging.info("Check if the dial pad is already open: %s", isDialPadOpen)
+        if not isDialPadOpen :
+            logging.info("Opening the dial pad now")
+            self.phone_device.mbs.pressDialpadIcon()
+        logging.info("Dial pad should be open now %s :", self.phone_device.mbs.isDialPadOpen())
         logging.info("Calling %s from phone device" % number)
         self.phone_device.mbs.enterNumberOnDialpad(number)
         self.phone_device.mbs.pressCallButton()
\ No newline at end of file
diff --git a/tests/automotive/mobly_tests/utilities/spectatio_utils.py b/tests/automotive/mobly_tests/utilities/spectatio_utils.py
index cc2adca9a..999432286 100644
--- a/tests/automotive/mobly_tests/utilities/spectatio_utils.py
+++ b/tests/automotive/mobly_tests/utilities/spectatio_utils.py
@@ -127,9 +127,15 @@ class CallUtils:
     def open_bluetooth_settings(self):
         """Assumes we are on the home screen.
         Navigate to the Bluetooth setting page"""
-        logging.info("Opening bluetooth settings (via the Status Bar)")
+        logging.info("Opening bluetooth settings (via the home screen)")
         self.device.mbs.openBluetoothSettings()
 
+    def open_bluetooth_settings_form_status_bar(self):
+        """Assumes we are on the home screen.
+        Navigate to the Bluetooth setting page"""
+        logging.info("Opening bluetooth settings (via the Status Bar)")
+        self.device.mbs.openBluetoothSettingsFromStatusBar()
+
     def press_active_call_toggle(self):
         logging.info("Pressing the Active Call toggle")
         self.device.mbs.pressActiveCallToggle()
@@ -361,6 +367,16 @@ class CallUtils:
         self.device.mbs.cancelBluetoothAudioConncetion()
         logging.info('Clicked on <Cancel> label present on bluetooth Audio page')
 
+    def handle_bluetooth_audio_pop_up(self):
+        """ Close on BT audio popup if present on bluetooth Audio page"""
+        logging.info('Adding wait to check the Bluetooth Audio popup')
+        time.sleep(constants.DEFAULT_WAIT_TIME_FIVE_SECS)
+        is_bluetooth_media_popup_present = self.is_connect_to_bluetooth_label_visible_on_bluetooth_audio_page()
+        if is_bluetooth_media_popup_present:
+          logging.info('BT Audio popup present, cancelling that.')
+          self.click_cancel_label_visible_on_bluetooth_audio_page()
+
+
     def update_device_timezone(self, expected_timezone):
         logging.info('Update the device timezone to %s',
                      expected_timezone)
@@ -416,6 +432,7 @@ class CallUtils:
     def verify_dialing_number(self, expected_dialing_number):
         """Replace all non-digits characters to null"""
         actual_dialing_number = re.sub(r'\D', '', str(self.get_dialing_number()))
+        logging.info('dialing number: %s',self.get_dialing_number())
         logging.info(
             'Expected dialing number: %s, Actual: %s',
             expected_dialing_number,
@@ -632,9 +649,11 @@ class CallUtils:
     def delete_dialed_number_on_dial_pad(self):
         logging.info('Deleting dialed number on Dial Pad')
         self.device.mbs.deleteDialedNumber()
+
     # End call on IVI using adb shell command
     def end_call_using_adb_command(self, device_target):
         self.execute_shell_on_device(device_target, 'input keyevent KEYCODE_ENDCALL')
+        self.execute_shell_on_device(device_target, 'input keyevent KEYCODE_POWER')
 
     # Make a call most recent history
     def call_most_recent_call_history(self):
@@ -652,9 +671,11 @@ class CallUtils:
         self.device.mbs.changeAudioSourceToCarSpeakers()
 
     def enable_driving_mode(self):
+        logging.info('Enabling the drive mode')
         self.device.mbs.enableDrivingMode()
 
     def disable_driving_mode(self):
+        logging.info('Disabling the drive mode')
         self.device.mbs.disableDrivingMode()
 
     # Check if microphone chip is displayed on status bar
@@ -693,3 +714,19 @@ class CallUtils:
 
     def press_phone_home_icon_using_adb_command(self, device_target):
         self.execute_shell_on_device(device_target, 'input keyevent KEYCODE_HOME')
+
+    def get_bt_profile_status_using_adb_command(self, device_target, profile):
+        try:
+           bt_profile_status = self.execute_shell_on_device(device_target, profile).decode('utf8')
+           logging.debug(bt_profile_status)
+           return bt_profile_status
+        except adb.AdbError:
+           logging.info("Adb returned null")
+
+    def get_bt_connection_status_using_adb_command(self, device_target):
+            try:
+               bt_connection_status = self.execute_shell_on_device(device_target, constants.BLUETOOTH_CONNECTION_STATE).decode('utf8')
+               logging.debug(bt_connection_status)
+               return bt_connection_status
+            except adb.AdbError:
+               logging.info("Adb returned null")
\ No newline at end of file
diff --git a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_call_from_dialer.py b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_call_from_dialer.py
index f5275d17a..ba9cf09f4 100644
--- a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_call_from_dialer.py
+++ b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_call_from_dialer.py
@@ -24,6 +24,7 @@
         8) Enable the Park Mode in IVI device
 """
 
+import logging
 from bluetooth_test import bluetooth_base_test
 from utilities import constants
 from utilities.main_utils import common_main
@@ -31,6 +32,10 @@ from utilities.main_utils import common_main
 
 class UxRestrictionBluetoothCallFromDialerTest(bluetooth_base_test.BluetoothBaseTest):
 
+    def setup_class(self):
+        super().setup_class()
+        self.common_utils = CommonUtils(self.target, self.discoverer)
+
     def setup_test(self):
         # Pair the devices
         self.bt_utils.pair_primary_to_secondary()
@@ -48,11 +53,17 @@ class UxRestrictionBluetoothCallFromDialerTest(bluetooth_base_test.BluetoothBase
         self.call_utils.verify_dialing_number(dialer_test_phone_number)
         self.call_utils.end_call()
         self.call_utils.wait_with_log(5)
+        logging.info("Call ended, open history now ")
         self.call_utils.open_call_history()
+        self.call_utils.wait_with_log(15)
         self.call_utils.verify_last_dialed_number(dialer_test_phone_number)
+        logging.info("Number verified")
 
     def teardown_test(self):
-        #Disable driving mode
+        self.call_utils.end_call_using_adb_command(self.target)
+        self.call_utils.wait_with_log(5)
+        self.call_utils.press_home()
+        # Disable driving mode
         self.call_utils.disable_driving_mode()
         super().teardown_test()
 
diff --git a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_play_message_while_driving.py b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_play_message_while_driving.py
index ff7952b73..a25e499a4 100644
--- a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_play_message_while_driving.py
+++ b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_play_message_while_driving.py
@@ -41,7 +41,7 @@ class UxRestrictionPlayUnreadMessageWhileDrivingTest(bluetooth_sms_base_test.Blu
 
     # Reboot Phone
     self.target.unload_snippet('mbs')
-    self.call_utils.reboot_device(self.target)
+    self.target.reboot()
     self.call_utils.wait_with_log(30)
     self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
 
diff --git a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_receive_call_answer_decline.py b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_receive_call_answer_decline.py
index 07c43b65e..c56729440 100644
--- a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_receive_call_answer_decline.py
+++ b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_receive_call_answer_decline.py
@@ -49,8 +49,7 @@ class UxRestrictionReceiveAnswerDeclineCallTest(bluetooth_sms_base_test.Bluetoot
     self.common_utils.click_on_ui_element_with_text('Allow')
 
   def setup_test(self):
-
-    #set driving mode
+    # set driving mode
     self.call_utils.enable_driving_mode()
 
   def test_answer_incoming_call(self):
diff --git a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_sms_db_sync.py b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_sms_db_sync.py
index dace5a2c9..289041d74 100644
--- a/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_sms_db_sync.py
+++ b/tests/automotive/mobly_tests/uxrestriction/uxrestriction_test_sms_db_sync.py
@@ -46,7 +46,7 @@ class UxRestrictionSMSDBTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         self.call_utils.clear_sms_app(self.target)
         # Reboot Phone
         self.target.unload_snippet('mbs')
-        self.call_utils.reboot_device(self.target)
+        self.target.reboot()
         self.call_utils.wait_with_log(30)
         self.target.load_snippet('mbs', android_device.MBS_PACKAGE)
 
@@ -58,7 +58,7 @@ class UxRestrictionSMSDBTest(bluetooth_sms_base_test.BluetoothSMSBaseTest):
         # set driving mode
         self.call_utils.enable_driving_mode()
 
-    def test_call_from_dialer_during_drive_mode(self):
+    def test_sms_db_sync_during_drive_mode(self):
         # to test that the unread sms appears on phone during drive mode
 
         # Open the sms app
diff --git a/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/PhoneSnippet.java b/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/PhoneSnippet.java
index 31950ab0a..5c8fd4ee7 100644
--- a/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/PhoneSnippet.java
+++ b/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/PhoneSnippet.java
@@ -81,6 +81,12 @@ public class PhoneSnippet implements Snippet {
         mPhoneHelper.get().pressDialpadIcon();
     }
 
+    /** Checks if the dial pad is open */
+    @Rpc(description = "Checks if the dial pad is open.")
+    public boolean isDialPadOpen() {
+        return mPhoneHelper.get().isDialPadOpen();
+    }
+
     /** (Directly) enter a number into the dial pad) */
     @Rpc(description = "Enter phone number on dial pad.")
     public void enterNumberOnDialpad(String numberToDial) {
diff --git a/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/SettingsSnippet.java b/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/SettingsSnippet.java
index a7bb818cb..84153c99a 100644
--- a/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/SettingsSnippet.java
+++ b/tests/automotive/snippets/phone/src/com/google/android/mobly/snippet/bundled/SettingsSnippet.java
@@ -20,6 +20,7 @@ import android.platform.helpers.HelperAccessor;
 import android.platform.helpers.IAutoBluetoothSettingsHelper;
 import android.platform.helpers.IAutoDateTimeSettingsHelper;
 import android.platform.helpers.IAutoSettingHelper;
+import android.platform.helpers.IAutoStatusBarHelper;
 import android.platform.helpers.SettingsConstants;
 
 import com.google.android.mobly.snippet.Snippet;
@@ -30,6 +31,7 @@ public class SettingsSnippet implements Snippet {
 
     private HelperAccessor<IAutoSettingHelper> mSettingsHelper;
     private HelperAccessor<IAutoBluetoothSettingsHelper> mBluetoothSettingsHelper;
+    private HelperAccessor<IAutoStatusBarHelper> mStatusBarHelper;
 
     private static String sBluetoothSettings = "OPEN_BLUETOOTH_SETTINGS_WORKFLOW";
     private HelperAccessor<IAutoDateTimeSettingsHelper> mDateTimeSettingsHelper;
@@ -37,6 +39,7 @@ public class SettingsSnippet implements Snippet {
     public SettingsSnippet() {
         mSettingsHelper = new HelperAccessor<>(IAutoSettingHelper.class);
         mBluetoothSettingsHelper = new HelperAccessor<>(IAutoBluetoothSettingsHelper.class);
+        mStatusBarHelper = new HelperAccessor<>(IAutoStatusBarHelper.class);
         mDateTimeSettingsHelper = new HelperAccessor<>(IAutoDateTimeSettingsHelper.class);
     }
 
@@ -82,6 +85,17 @@ public class SettingsSnippet implements Snippet {
     public void openBluetoothSettings() {
         mSettingsHelper.get().openSetting(sBluetoothSettings);
     }
+    @Rpc(description = "Open the bluetooth settings (from status bar)")
+    public void openBluetoothSettingsFromStatusBar() {
+        mStatusBarHelper.get().openBluetoothPalette();
+        mStatusBarHelper.get().openBluetoothSettings();
+    }
+
+    /** Go Back to bluetooth settings (from L2 Pages) */
+    @Rpc(description = "Go Back to bluetooth settings (from L2 Pages)")
+    public void goBackToBluetoothSettings() {
+        mBluetoothSettingsHelper.get().goBackToBluetoothSettings();
+    }
 
     /** Press the phone preference toggle button */
     @Rpc(description = "Press the phone toggle on a entry under 'Paired Devices'")
diff --git a/tests/bettertogether/OWNERS b/tests/bettertogether/OWNERS
deleted file mode 100644
index 08672f462..000000000
--- a/tests/bettertogether/OWNERS
+++ /dev/null
@@ -1,9 +0,0 @@
-# Better Together EngProd
-lancefluger@google.com
-angli@google.com
-xianyuanjia@google.com
-kolinlu@google.com
-
-# Android Connectivity
-kaishi@google.com
-steveliu@google.com
diff --git a/tests/bettertogether/betocq/Android.bp b/tests/bettertogether/betocq/Android.bp
deleted file mode 100644
index 5b8add991..000000000
--- a/tests/bettertogether/betocq/Android.bp
+++ /dev/null
@@ -1,153 +0,0 @@
-// Copyright (C) 2024 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-package {
-    default_applicable_licenses: ["Android-Apache-2.0"],
-    default_team: "trendy_team_fwk_uwb",
-}
-
-python_defaults {
-    name: "betocq_lib_defaults",
-    pkg_path: "betocq",
-}
-
-python_defaults {
-    name: "betocq_test_defaults",
-    version: {
-        py3: {
-            embedded_launcher: false,
-        },
-    },
-}
-
-// Libraries
-
-python_library_host {
-    name: "betocq_lib",
-    defaults: ["betocq_lib_defaults"],
-    srcs: [
-        "android_wifi_utils.py",
-        "gms_auto_updates_util.py",
-        "nc_constants.py",
-        "nearby_connection_wrapper.py",
-        "setup_utils.py",
-        "iperf_utils.py",
-        "version.py",
-    ],
-    libs: [
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "base_betocq_suite",
-    defaults: ["betocq_lib_defaults"],
-    srcs: [
-        "base_betocq_suite.py",
-    ],
-    libs: [
-        "mobly",
-        "pyyaml",
-    ],
-}
-
-python_library_host {
-    name: "d2d_performance_test_base",
-    defaults: ["betocq_lib_defaults"],
-    srcs: [
-        "d2d_performance_test_base.py",
-    ],
-    libs: [
-        "betocq_lib",
-        "mobly",
-        "betocq_nc_base_test",
-    ],
-}
-
-python_library_host {
-    name: "betocq_nc_base_test",
-    defaults: ["betocq_lib_defaults"],
-    srcs: [
-        "nc_base_test.py",
-    ],
-    libs: [
-        "betocq_lib",
-        "mobly",
-        "pyyaml",
-    ],
-}
-
-python_library_host {
-    name: "betocq_compound_tests",
-    defaults: ["betocq_lib_defaults"],
-    srcs: ["compound_tests/*.py"],
-    libs: [
-        "betocq_lib",
-        "d2d_performance_test_base",
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "betocq_directed_tests",
-    defaults: ["betocq_lib_defaults"],
-    srcs: ["directed_tests/*.py"],
-    libs: [
-        "betocq_lib",
-        "d2d_performance_test_base",
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "betocq_function_tests",
-    defaults: ["betocq_lib_defaults"],
-    srcs: ["function_tests/*.py"],
-    libs: [
-        "betocq_lib",
-        "mobly",
-    ],
-}
-
-// TODO: Add modules for individual test classes.
-
-// Test suites
-
-python_test_host {
-    name: "betocq_test_suite",
-    defaults: ["betocq_test_defaults"],
-    main: "betocq_test_suite.py",
-    srcs: ["betocq_test_suite.py"],
-    libs: [
-        "base_betocq_suite",
-        "betocq_compound_tests",
-        "betocq_directed_tests",
-        "betocq_function_tests",
-        "betocq_lib",
-        "mobly",
-    ],
-    data: [
-        "cuj_and_test_config.yml",
-        // package the snippets for atest
-        ":nearby_snippet",
-        ":nearby_snippet_2",
-        ":nearby_snippet_3p",
-    ],
-    test_suites: [],
-    test_options: {
-        unit_test: false, // as Mobly tests require device(s)
-        // This tag is used to enable the ATest Mobly runner
-        tags: ["mobly"],
-    },
-}
diff --git a/tests/bettertogether/betocq/CHANGELOG.md b/tests/bettertogether/betocq/CHANGELOG.md
deleted file mode 100644
index 978f13222..000000000
--- a/tests/bettertogether/betocq/CHANGELOG.md
+++ /dev/null
@@ -1,94 +0,0 @@
-# BetoCQ test suite release history
-
-## 2.3 (05/28/2024)
-
-## New
-* Skip test if wifi_chipset is empty.
-* Add MCC Aware test case with STAs connected to 2G/5G.
-* Make connection, advertising/discovery mediums configurable.
-* Allow the two devices connect to different SSIDs.
-* Raise NC speed bar back to 40MB/s except for WLAN.
-* Generate per-test openwrt syslog.
-* Add 3p api function into nearby_connections_function_test.py.
-* Report the suite name to the test summary.
-* Enable individual test selection from the command-line.
-
-### Bug fixes
-* Add 10s delay after sta connection to allow scan, DHCP and internet
-  validation to complete.
-* Fix the bug that it can not run the test cases of eSIM and Quick Share.
-* Clarify the failure reasons for some test failures.
-* Fix the issue that wlan1 is not correctly detected.
-* Fix the timestamp in failed iteration logs.
-* Reduce wait time between iteration from 13s to 3s.
-
-## 2.2 (05/10/2024)
-
-## New
-* Add iperf test for Aware, hotspot modes.
-* Disable WLAN deny list so that the past failure won't affect the new runs.
-* Add the key test info in test summary.
-* Add the STA and medium info of failed iterations.
-* Add P2P frequency check for MCC test cases.
-* Add more failure triage tips.
-
-### Bug fixes
-* Improve the format of common triaging tips.
-* Don't check max link speed for the disconnection check.
-* Fix the format of triaging tips.
-* Fix the control in test config.
-* Fall back to use "adb shell cmd wifi status" when wifiGetConnectionInfo() fails.
-
-## 2.1 (05/02/2024)
-
-## New
-* Add iperf test for WFD mode. iperf test speed requirement is 40MB/s while Nearby
-  Connections speed requirement is 20MB/s in 2-stream 80MHz mode.
-* Add the BT coex performance test.
-* Add the support of BLE scan throttling during 2G transfer (enabled by default)
-* Change the success rate target to 98%.
-* Add Aware test case and enable it for QuickShare CUJ.
-* Enable scc_2g_wfd_sta_tests for all devices.
-
-### Bug fixes
-* Fix the missing data of failed test cases by replacing all "sponge_properties"
-  with "properties".
-* Remove the unnecessary flag overriding and rely on the production config instead.
-* Add the check of AP connection. If AP is disconnected or connect to a wrong
-  frequency on the target side, mark the test as failed.
-* Consolidate AP connection and speed check codes to one function.
-* Add P2P frequency check for WFD/HS SCC test cases.
-* Reduce 2G speed check from 3 to 1 MB/s until it is improved in NC.
-* Remove AP frequency check for the test cases with empty wifi_ssid.
-* Fix typo in DFS test cases and reduce BT transfer size by 50%.
-* Skip p2p frequency check if wifi speed check is disabled or it is a DBS test.
-* Add the method overriding annotation.
-* Add more triaging tips for AP disconnected, wrong AP frequency and P2P/STA
-  frequency mismatch cases.
-
-## 2.0 (04/10/2024)
-
-### New
-* BetoCQ test suite: improved test coverage with the right quality bar taking into
-  device capabilities
-  * CUJ tests: Connectivity performance evaluation for the specific CUJs, such
-  as Quickstart, Quickshare, etc.
-  * Directed tests: Performance test with fixed D2D medium.
-  * Function tests: Tests for the basic functions used by D2D connection.
-
-## 1.6
-
-### New
-* `nearby_share_stress_test.py` for testing Nearby Share using Wifi only.
-
-### Fixes
-* Change discovery medium to BLE only.
-* Increase 1G file transfer timeout to 400s.
-* Disable GMS auto-updates for the duration of the test.
-
-## 1.5
-
-### New
-* `esim_transfer_stress_test.py` for testing eSIM transfer using Bluetooth only.
-* `quick_start_stress_test.py` for testing the Quickstart flow using both
-   Bluetooth and Wifi.
diff --git a/tests/bettertogether/betocq/ReadMe.md b/tests/bettertogether/betocq/ReadMe.md
deleted file mode 100644
index c6c2e7f92..000000000
--- a/tests/bettertogether/betocq/ReadMe.md
+++ /dev/null
@@ -1,531 +0,0 @@
-# Better Together Connectivity Quality (BeToCQ) Test Suite
-
-Better Together Connectivity Quality (BeToCQ) is a new test tool built by
-Android to test the cross-device connectivity performance that isn't covered
-by the existing Android tests.
-
-This tool is built on the top of the Nearby Connections API. Under Nearby
-Connections, it has Android connectivity stack including Bluetooth, Wi-Fi, NFC,
-and UWB technologies.
-
-BeToCQ is designed to catch connectivity software and hardware performance
-issues by measuring detailed quality signals including the discovery, connection
-latency, transfer speed, and overall success rate.
-
-Depending on the device capabilities, the test takes two to six hours to
-complete.
-
-## Test types {:#test-types}
-
-BeToCQ consists of three parts:
-
-- Function test
-
-  The function test ensures hardware and software readiness for each radio
-  technology.
-
-- Directed test
-
-  The directed test measures performance of each wireless medium against
-  expectations. To discover the radio concurrency issue, sometimes multiple
-  mediums are enabled at the same time during the test.
-
-  The function and direct tests are the foundational tests running with
-  fixed wireless mediums. This helps isolate the issue to an individual medium
-  and makes the debugging process more straightforward.
-
-- Critical user journey (CUJ) test
-
-  The CUJ test tests the real use case. Different from function and
-  directed test, the CUJ test can use multiple radios in a more dynamic way. So the
-  debugging is typically more difficult in CUJ tests. That's why CUJ tests run as
-  the last step when the other tests have already passed.
-
-  CUJ test are implemented as the test cases defined in the `compound_test`
-  directory, and are dynamically configured based on the CUJ requirements. The
-  term `compound_test` refers to the fact that it uses multiple radios in a
-  dynamic way.
-
-  The test suite currently supports three CUJs: Quick Start, Quick Share, and eSIM
-  transfer. We plan to add more CUJs in later releases.
-
-## Device capabilities {:#device-capabilities}
-
-The exact connectivity performance depends on the device capability.
-For example, the low-cost 2&nbsp;GHz-only Wi-Fi device achieves a lower speed
-than the dual-band Wi-Fi device. On the other hand, the dual-band-simultaneous
-(DBS) capable device can support a 2G infrastructure-STA connection and 5G
-device-to-device connection in parallel and thus can support higher
-device-to-device transfer speed.
-
-As a result, this test suite uses the wireless capabilities of test devices as
-inputs to customize the test case and set the right performance expectations.
-
-## Test cases {:#test-cases}
-
-In the directed and CUJ tests, depending on the device capabilities,
-test cases are defined to cover:
-
-- Different Wi-Fi concurrencies: single-channel concurrency (SCC) versus
-  multi-channel concurrency (MCC)
-- Different wireless channels: 2G, 5G, 5G DFS, and 5G indoor
-
-The test cases uses the following naming convention:
-
-```
- ConcurrencyMode_MediumBand_MediumName_StaBand_sta_test
-```
-
-For example, `scc_indoor_5g_wfd_sta_test` means:
-
-- WLAN and Wi-Fi Direct (WFD) concurrency mode operates in the same channel.
-- Transfer medium is WFD.
-- Both STA and WFD are connected to 5G indoor channel (for example, 5180 in JP).
-
-Similarly, `mcc_5g_all_wifi_non_dbs_2g_sta_test` means:
-outmod betocq_test_suite
-
-- Transfer medium can be any 5G Wi-Fi medium.
-- STA is connected to the 2G band and the transfer medium is connected to the 5G band.
-- Device isn't capable of DBS and so it operates in MCC mode.
-
-Note that some test cases are skipped if they aren't supported by the device
-capabilities. For example:
-
-- `scc_indoor_5g_wfd_sta_test` is skipped if the device doesn't
- support WFD group owner (GO) at the 5G indoor channel.
-
-- `mcc_5g_all_wifi_non_dbs_2g_sta_test` is skipped for DBS capable devices.
-
-Each test case runs multiple iterations to collect the following stats:
-
-- Success rate
-- Failure reason for each failed iteration
-- Discovery latency stats
-- Connection latency stats
-- Wi-Fi upgrade latency stats
-- Transfer speed stats
-
-MCC test cases run more iterations than SCC test cases.
-5G test cases transfer larger files than 2G test cases.
-
-The test cases execution depends on the device capability, so it's
-important to fill in the device capabilities section correctly in the test
-configuration file. We'll discuss this in more detail in the following sections.
-
-## Actionable test results {:#actional-test-results}
-
-Running the test is straightforward, but it can be difficult to get insights out
-of the test results and determine further action to take.
-
-BetoCQ takes three steps to address this issue:
-
-- Simplifies the test report review with the visualized test summary.
-
-- Sets the proper performance expectations based
-  on devices capabilities.  The test results are compared against the expectations
-  so that there are clear pass/failure signals.
-
-- Makes debugging job more straightforward, with the test isolating each failure
-  to a single component. The tool also provides the most likely failure
-  reasons and suggest next steps for debugging and appropriate component owner.
-
-## Prerequisites {:#test-prerequisites}
-
-*   **Environment.**
-
-    We recommend an RF shielding box or room to run the test.
-
-*   **Wi-Fi Access Point (AP) and network.**
-
-    The test AP must be a dual-band capable Wi-Fi AP with two SSIDs (one at
-    2&nbsp;GHz and one at 5&nbsp;GHz) with support for DFS channels. Example of
-    routers that meet the testing requirements include NETGEAR RAX50 AX5400,
-    NETGEAR RAX120 AX6000, and NETGEAR R8000b AC3200. It's ideal to use two APs
-    to support all test cases. The test AP must have the access to
-    google.com. Note that in China, this test requires an office VPN network or
-    installing a VPN app in devices.
-
-*   **Target device.**
-
-    The target device must run a userdebug image of the latest Android version,
-    for example, Android 14. **This is the device that is being validated.**
-
-*   **Source device.**
-
-    Run the suite and pass the quality bar with one source device
-    running a userdebug image of the latest Android version. We recommend a
-    model with known good connectivity performance. Some options are:
-    - A model that already passed the automated test suite as a target.
-    - A flagship model with no known major Bluetooth and Wi-Fi issues.
-    - A Google Pixel 8
-
-*   **Prepare devices.**
-
-    Before you run the automated test, prepare all devices by completing the
-    device setup processes. After the new devices are set up, connect them to
-    the internet for at least one hour to ensure each is properly configured.
-
-    Follow the instructions listed in [Google Play Protect]
-    (https://support.google.com/googleplay/answer/2812853)
-    to turn off Google Play Protect so that the test APK can run properly.
-
-    Keep the device awake while charging so that the operating system doesn't
-    suspend the test snippet process.
-
-    To avoid the strong signal issue, keep two devices at least 10 cm away. This
-    is especially important for 2G test as the 2G signal is typically stronger
-    than 5G or 6G signal.
-
-
-## Test steps {:#test-steps}
-
-Follow these steps to prepare and execute tests and review test results.
-
-### Prepare the test {:#test-prep}
-
-Prepare the following materials to be used for the tests.
-
-#### Get the test codes, tools, and configure build {:#test-codes}
-
-1.  Download the release test binary files (see release instructions) and save them
-in a local directory:
-  - `betocq_test_suite` (Linux and macOS)
-  - `betocq_test_suite_windows.zip` (Windows only)
-  - `local_mobly_runner.py`
-  - `cuj_and_test_config.yml`
-
-2. Make these two files executable (Linux and macOS only):
-
-  ```
-  chmod +x betocq_test_suite
-  chmod +x local_mobly_runner.py
-  ```
-
-3.  Check and install Python version 3.11 or later:
-    -   Check your Python 3 version number:
-
-      ```
-      python3 --version
-      ```
-
-    -   If your version is lower than Python 3.11, install Python 3.11 or later:
-
-      ```
-      sudo apt install python3
-      ```
-      Or install the latest version from
-      [python.org](https://www.python.org/downloads/windows) for Windows.
-
-4. Windows only: Download [adb](https://developer.android.com/tools/releases/platform-tools)
-   and add its path to the [`Path` environment variable](https://stackoverflow.com/questions/44272416/how-to-add-a-folder-to-path-environment-variable-in-windows-10-with-screensho).
-
-#### Configure Wi-Fi AP and test {:#config}
-
-1. Configure Wi-Fi AP channel frequency:
-
-  -   There are three Wi-Fi channels to be tested: 2437, 5180, and 5260.
-      5260 is a [DFS channel]
-        (https://en.wikipedia.org/wiki/List_of_WLAN_channels).
-
-  -   If there are two dual-band APs, all three Wi-Fi channels can be supported.
-
-
-2. Modify the test config file `cuj_and_test_config.yml` as follows:
-    -  Find device serial numbers:
-
-        ```
-        adb devices -l
-        List of devices attached
-          17011FDEE0002N  device usb:1-1 product:raven model:Pixel_6_Pro
-          R3CN90YNAR      device usb:1-2 product:p3sksx model:SM_G998N
-        ```
-
-        In this example, the source device is 17011FDEE0002N and the target
-        device is R3CN90YNAR.
-
-    -  Specify the target and source device serial numbers:
-
-        ```
-        - serial: "17011FDEE0002N"
-          role: "source_device"
-        ```
-
-        ```
-        - serial: "R3CN90YNAR"
-          role: "target_device"
-        ```
-
-    -  Specify `wifi_ssid` and `wifi_password` for each Wi-Fi channel:
-
-        ```
-          wifi_2g_ssid: "NETGEAR62-2G"
-          wifi_2g_password: "yourpassword"
-          wifi_5g_ssid: "NETGEAR62-5G-1"
-          wifi_5g_password: "yourpassword"
-          wifi_dfs_5g_ssid: "ASUS_5G"
-          wifi_dfs_5g_password: "yourpassword"
-        ```
-
-        Where `wifi_2g_ssid` is for the channel of 2437, `wifi_2g_ssid` is for
-        the channel of 5180 and `wifi_dfs_5g_ssid` is for the channel of 5260.
-
-        Leave `wifi_password` as an empty string `""` if it's an open network.
-
-    - Split the test into two runs if the required channels can't be supported
-      at the same time:
-
-      1. In the first run, define 2G and 5G SSID but leave the 5G DFS SSID to an empty
-         string `""` so that the 5G DFS test cases are skipped.
-      2. In the second run, define the 5G DFS SSID but leave the 2G and 5G SSID as empty
-         strings to cover the 5G DFS test case.
-
-3. Configure device capabilities for both source and target devices.
-
-      For example, the following configuration means the device uses Wi-Fi
-      chipset WCN6710, and supports two spatial streams with the maximum PHY rate of
-      2402&nbsp;Mbps (2x2, 11AX, 160&nbsp;MHz) at 5G and 287&nbsp;Mbps (2x2, 11AX,
-      20&nbsp;MHz) at 2G. This device doesn't support STA + WFD concurrency in DBS mode.
-      It doesn't support starting WFD group owner mode at an STA-associated DFS or
-      indoor channel.
-
-      ```
-        wifi_chipset: "wcn6710"
-        # The max number of spatial streams
-        max_num_streams: 2
-        # The max PHY rate at 5G, in Mbps
-        max_phy_rate_5g_mbps: 2402
-        # The max PHY rate at 2G, in Mbps
-        max_phy_rate_2g_mbps: 287
-        # if the device supports 5G Wi-Fi
-        supports_5g: True
-        # if the device supports DBS in STA and Wi-Fi Direct concurrency mode
-        supports_dbs_sta_wfd: False
-        # The max number of spatial streams in DBS mode.
-        max_num_streams_dbs: 1
-        # if the device supports to start WFD group owner at a STA-associated DFS channel
-        enable_sta_dfs_channel_for_peer_network: False
-        # if the device supports to start WFD group owner at a STA-associated indoor channel
-        enable_sta_indoor_channel_for_peer_network: False
-      ```
-
-      For the last two parameters, review `config_wifiEnableStaDfsChannelForPeerNetwork`
-      and `config_wifiEnableStaIndoorChannelForPeerNetwork` in the Wi-Fi device
-      overlay file [`config.xml`] (https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml).
-
-      Check with the Wi-Fi engineering team about device capabilities details.
-
-
-### Run the test {:#run-test}
-To run the test on Linux directly from AOSP repo:
-
-  - Refer to release instructions below to set up the build environment.
-
-    ```
-    source build/envsetup.sh
-    lunch aosp_arm-trunk_staging-eng
-    ```
-
-  - Run the test with atest:
-
-    ```
-    atest -v betocq_test_suite -- --config <local_testbed_directory>/cuj_and_test_config.yml --testbed Quickstart
-    ```
-
-To run the test on Linux and macOS with test binary, run the following commands from the local
-directory:
-
-  ```
-  python3 local_mobly_runner.py -p ./betocq_test_suite -tb Quickstart -i --novenv -c cuj_and_test_config.yml
-  ```
-
-Note that `Quickstart` is the CUJ test name and there are
-a few other supported CUJ tests listed in `cuj_and_test_config.yml`.
-
-If there are more than two devices connected to USB ports, specify the device
-serial number explicitly:
-
-  ```
-  python3 local_mobly_runner.py -p ./betocq_test_suite -tb Quickstart -i --novenv -s <serial1>,<serial2> -c cuj_and_test_config.yml
-  ```
-
-Note that no space is allowed between
-two device serial numbers in the above commafnd.
-
-To run the test on Windows:
-
-  ```
-  python3 local_mobly_runner.py -p ./betocq_test_suite_windows.zip -tb Quickstart -i -c cuj_and_test_config.yml
-  ```
-
-### Check the test result and debug failure {:#check-result}
-
-1.  Verify that these lines appear at the end of the test console output:
-
-  ```
-  Artifacts are saved in <TestResultDirectory>
-  Test summary saved in <TestResultDirectory>/test_summary.yaml
-  ```
-
-    Where `<TestResultDirectory>` is something like
-    `/tmp/logs/mobly/<CujTestName>/<TestDateTime>`.
-
-2.  Use Result Uploader to upload the artifact folder to Google's result storage
-  service so that the test results are visualized. The latest version of the tool
-  and instructions are provided in the
- [results_uploader](https://cs.android.com/android/platform/superproject/main/+/main:tools/test/mobly_extensions/tools/results_uploader/).
-    -   If this is your first time using the tool, file an issue with Google to
-        get onboarded.
-    -   Once you upload the artifacts, a link is displayed in the console
-        output. Click the link, then click **betocq_test_suite** to display
-        a dashboard view of your test results.
-
-3.  Click **MoblyTest** to display the overall test results.
-    -   Review the source and target device capability summary.
-    -   Review the completed function test result summary.
-    -   Review the completed directed and CUJ result summary.
-
-4. If the test passes, no further action is required.
-
-5.  Click each test case (for example, `test_scc_5g_wfd_sta`) to display the
-   status of each iteration under **Repeats**.
-    -   Green squares indicate passed tests, red squares indicate failed tests.
-
-6. If the test fails, follow the following steps to triage the results:
-   1. For each failed test case:
-
-      - Review the test case details including the transfer medium, concurrency
-        mode, the channel bands of STA, and the transfer medium.
-
-      - Check if the device capabilities are configured correctly.
-
-      - Review the failed iterations and reasons. Follow the debugging tips to
-        triage and work with the internal engineering team.
-
-   2. Click the failed (red) iterations to see the timestamp and detailed
-     failure signatures. Here is the list of failure signatures:
-      - Wi-Fi STA connection failure signature:
-
-          ```
-          Failed to connect to SSID
-          ```
-          or
-
-          ```
-          Failed to remove networks
-          ```
-      - Discovery failure signature:
-
-          ```
-          Timed out after waiting 30.0s for event "onEndpointFound" triggered by startDiscovery
-          ```
-      - BT connection failure signature:
-
-          ```
-          com.google.android.gms.common.api.ApiException: 8007: STATUS_RADIO_ERROR
-          at com.google.android.nearby.mobly.snippet.connection.ConnectionsClientSnippet.requestConnection(
-          ```
-      - Wi-Fi medium upgrade failure signature:
-
-          ```
-          Timed out after waiting 25.0s for event "onBandwidthChanged" triggered by requestConnection
-          ```
-      - Transfer failure signature:
-
-          ```
-          Timed out after 110.0s waiting for an "onPayloadTransferUpdate" event
-          ```
-
-      - Failure signature due to the GMS updates, which repeats a few times before the test exits:
-
-          ```
-          test_log.INFO:
-          In send_rpc_request
-          No response from server. Check the device logcat for crashes.
-          ```
-
-          ```
-          logcat and bug report:
-          stop com.google.android.gms due to installPackage
-          ```
-   3. Review the logcat and bug report of each failing iteration on both
-    source and target sides. You can find them as boxed links under the test
-    name.
-
-   4. Search the following keywords for the related logs in the bug report:
-    `WifiP2pService`, `wpa_supplicant`, `NearbyConnections`, and `NearbyMediums`.
-
-   5. Review the Wi-Fi Direct logs in the bug report if the `WIFI_DIRECT` medium is used.
-    Check if it's a group owner or client side error when bandwidth upgrade
-    fails.
-
-      ```
-      DUMP OF SERVICE wifip2p:
-      WifiP2pMetrics:
-      mConnectionEvents:
-      connectionType=FAST, groupRole=CLIENT, freq=5745, sta freq=2437, connectivityLevelFailureCode=NONE
-      ```
-
-   6. Check the above STA frequency and P2P frequency values. If both have valid
-    values but the values are different, the device likely operates in multiple
-    channel concurrency (MCC) mode unless it supports 2G + 5G concurrency.
-    In MCC mode, firmware could have the bugs resulting in bandwidth
-    upgrade failure or transfer issues. Check with the Wi-Fi chip vendor if there
-    are any known bug fixes for MCC mode.
-
-7. To rule out the test setup issue or device issue, repeat the test with a pair
-  of known good devices (or a pair of new devices).
-    - If the failure persists, check the test setup because it likely has the
-  issue. If possible, move the test to a clean environment to rule out the
-  interference issue.
-    - If the failure disappears, DUT likely has the issue. Work with the Wi-Fi/BT
-    engineering team to resolve the device issue. This might require getting
-    help from the Wi-Fi/BT chip vendor.
-
-8. If the issue can't be resolved by the internal engineering team and there is
-  strong evidence that there might be an issue on the Google side, create an issue
-  for Google. Be sure to include all test artifacts.
-
-## Linux and Windows release instructions {:#test-codes}
-
-Skip this unless you want to release the test binary from AOSP.
-
-- Get AOSP codes from
-  [AOSP](https://cs.android.com/android/platform/superproject/+/master:platform_testing/tests/bettertogether/betocq/;l=1).
-
-- Build the test binary for Linux and macOS:
-
-  ```
-  source build/envsetup.sh
-  lunch aosp_arm-trunk_staging-eng
-  make betocq_test_suite
-  outmod betocq_test_suite
-  ```
-
-- Upload these files to a shared drive:
-
-  ```
-  tools/test/mobly_extensions/scripts/local_mobly_runner.py
-  out/host/linux-x86/nativetest64/betocq_test_suite/betocq_test_suite
-  out/host/linux-x86/nativetest64/betocq_test_suite/cuj_and_test_config.yml
-  ```
-
-- Generate the zip file for Windows execution:
-
-  ```
-  mkdir ~/betocq_windows
-  cp platform_testing/tests/bettertogether/betocq/betocq_test_suite.py ~/betocq_windows/__main__.py
-  echo mobly > ~/betocq_windows/requirements.txt
-  cp -r platform_testing/tests/bettertogether/betocq ~/betocq_windows
-  cp out/host/linux-x86/nativetest64/betocq_test_suite/*.apk ~/betocq_windows
-  cd ~/betocq_windows
-  zip -r ~/betocq_test_suite_windows.zip ./
-  ```
-
-- Upload these files to a shared drive:
-
-  ```
-  tools/test/mobly_extensions/scripts/local_mobly_runner.py
-  out/host/linux-x86/nativetest64/betocq_test_suite/cuj_and_test_config.yml
-  ~/betocq_test_suite_windows.zip
-  ```
diff --git a/tests/bettertogether/betocq/android_wifi_utils.py b/tests/bettertogether/betocq/android_wifi_utils.py
deleted file mode 100644
index 1fe84be6c..000000000
--- a/tests/bettertogether/betocq/android_wifi_utils.py
+++ /dev/null
@@ -1,203 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Utils for Android Wi-Fi operations."""
-
-import dataclasses
-import datetime
-import enum
-import re
-import time
-
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import adb
-
-_DELAY_AFTER_CHANGE_WIFI_STATUS = datetime.timedelta(seconds=5)
-_WAIT_FOR_CONNECTION = datetime.timedelta(seconds=30)
-
-_SAVED_WIFI_LIST_PATTERN = re.compile(
-    r'(?P<id>\d+)\s+(?P<ssid>.*)\s+(?P<security>.*)'
-)
-_SSID_PATTERN = re.compile(rb'Wifi is connected to "(?P<ssid>.*?)"')
-
-
-@dataclasses.dataclass(frozen=True)
-class SavedWifiInfo:
-  """Information about a saved Wi-Fi network."""
-
-  id: str
-  ssid: str
-  security: str
-
-
-@enum.unique
-class WiFiSecurity(enum.StrEnum):
-  """Security type of the Wi-Fi network."""
-
-  OPEN = 'open'
-  OWE = 'owe'
-  WPA2 = 'wpa2'
-  WPA3 = 'wpa3'
-  WEP = 'wep'
-
-
-class AndroidWiFiError(Exception):
-  """Error when failed to operate Wi-Fi on Android device."""
-
-  def __init__(self, ad: android_device.AndroidDevice, message: str) -> None:
-    self._ad = ad
-    self._message = message
-
-  def __str__(self) -> str:
-    return self._message if self._ad is None else f'{self._ad} {self._message}'
-
-
-def connect_to_wifi(
-    ad: android_device.AndroidDevice,
-    ssid: str,
-    passphrase: str | None = None,
-    security: WiFiSecurity | None = None,
-) -> None:
-  """Connects to a W-Fi network and adds to saved networks list."""
-  enable_wifi(ad)
-  if get_current_wifi(ad) == ssid:
-    ad.log.info(f'Wi-Fi was already connected to {repr(ssid)}')
-    return
-  cmd = ['cmd', 'wifi', 'connect-network', f'"{ssid}"']
-  if passphrase is None:
-    cmd.append(f'"{security or WiFiSecurity.OPEN}"')
-  else:
-    cmd.extend([f'"{security or WiFiSecurity.WPA2}"', f'"{passphrase}"'])
-  ad.adb.shell(cmd)
-  if not _wait_for_data_connected(ad) or get_current_wifi(ad) != ssid:
-    raise AndroidWiFiError(ad, f'Fail to connect to Wi-Fi {repr(ssid)}')
-  ad.log.info(f'Wi-Fi connected to {repr(ssid)}')
-
-
-def disable_wifi(ad: android_device.AndroidDevice) -> None:
-  """Disables Wi-Fi."""
-  if not is_wifi_enabled(ad):
-    ad.log.info('Wi-Fi was already disabled.')
-    return
-  ad.log.info('Disabling Wi-Fi...')
-  ad.adb.shell(['cmd', 'wifi', 'set-wifi-enabled', 'disabled'])
-  start_time = time.monotonic()
-  timeout = start_time + _DELAY_AFTER_CHANGE_WIFI_STATUS.total_seconds()
-  while time.monotonic() < timeout:
-    if not is_wifi_enabled(ad):
-      ad.log.info('Wi-Fi is disabled.')
-      return
-  raise AndroidWiFiError(
-      ad,
-      'Fail to disable Wi-Fi after waiting for'
-      f' {_DELAY_AFTER_CHANGE_WIFI_STATUS.total_seconds()} seconds',
-  )
-
-
-def enable_wifi(ad: android_device.AndroidDevice) -> None:
-  """Enables Wi-Fi."""
-  if is_wifi_enabled(ad):
-    ad.log.info('Wi-Fi was already enabled.')
-    return
-  ad.log.info('Enabling Wi-Fi...')
-  ad.adb.shell(['cmd', 'wifi', 'set-wifi-enabled', 'enabled'])
-  start_time = time.monotonic()
-  timeout = start_time + _DELAY_AFTER_CHANGE_WIFI_STATUS.total_seconds()
-  while time.monotonic() < timeout:
-    if is_wifi_enabled(ad):
-      ad.log.info('Wi-Fi is enabled.')
-      return
-  raise AndroidWiFiError(
-      ad,
-      'Fail to enable Wi-Fi after waiting for'
-      f' {_DELAY_AFTER_CHANGE_WIFI_STATUS.total_seconds()} seconds',
-  )
-
-
-def forget_all_wifi(ad: android_device.AndroidDevice) -> None:
-  """Forgets all Wi-Fi from saved networks list."""
-  for saved_wifi in list_saved_wifi(ad):
-    ad.adb.shell(['cmd', 'wifi', 'forget-network', saved_wifi.id])
-  saved_wifis = list_saved_wifi(ad)
-  if saved_wifis:
-    raise AndroidWiFiError(
-        ad,
-        'Fail to forget all Wi-Fi networks, remaining in the list:'
-        f' {saved_wifis}',
-    )
-
-
-def forget_wifi(ad: android_device.AndroidDevice, ssid: str) -> None:
-  """Forgets Wi-Fi from saved networks list."""
-  saved_wifis = list_saved_wifi(ad)
-  for saved_wifi in saved_wifis:
-    if saved_wifi.ssid == ssid:
-      stdout = ad.adb.shell(['cmd', 'wifi', 'forget-network', saved_wifi.id])
-      if stdout == b'Forget successful\n':
-        ad.log.info(f'Wi-Fi {repr(ssid)} was forgotten from saved networks.')
-        return
-      raise AndroidWiFiError(ad, f'Fail to forget Wi-Fi {repr(ssid)}')
-  ad.log.info(f'Nothing was deleted since Wi-Fi {repr(ssid)} was not saved')
-  return
-
-
-def get_current_wifi(ad: android_device.AndroidDevice) -> str:
-  """Returns current Wi-Fi network."""
-  if match := _SSID_PATTERN.search(ad.adb.shell(['cmd', 'wifi', 'status'])):
-    return match.group('ssid').decode()
-  return ''
-
-
-def is_wifi_enabled(ad: android_device.AndroidDevice) -> bool:
-  """Returns True if Wi-Fi is enabled, False otherwise."""
-  return ad.adb.shell(['cmd', 'wifi', 'status']).startswith(b'Wifi is enabled')
-
-
-def list_saved_wifi(ad: android_device.AndroidDevice) -> list[SavedWifiInfo]:
-  """Returns list of saved Wi-Fi networks."""
-  saved_wifis = []
-  stdout = ad.adb.shell(['cmd', 'wifi', 'list-networks']).decode()
-  if stdout == 'No networks\n':
-    return saved_wifis
-  for line in stdout.splitlines()[1:]:
-    if match := _SAVED_WIFI_LIST_PATTERN.search(line):
-      saved_wifis.append(
-          SavedWifiInfo(
-              id=match.group('id'),
-              ssid=match.group('ssid').strip(),
-              security=match.group('security'),
-          )
-      )
-  return saved_wifis
-
-
-def _is_data_connected(ad: android_device.AndroidDevice) -> bool:
-  """Returns True if data is connected, False otherwise."""
-  try:
-    return b'5 received' in ad.adb.shell(['ping', '-c', '5', '8.8.8.8'])
-  except adb.AdbError:
-    return False
-
-
-def _wait_for_data_connected(
-    ad: android_device.AndroidDevice,
-    timeout: datetime.timedelta = _WAIT_FOR_CONNECTION,
-) -> bool:
-  """Returns True if data is connected before timeout, False otherwise."""
-  start_time = time.monotonic()
-  timeout = start_time + timeout.total_seconds()
-  while time.monotonic() < timeout:
-    if _is_data_connected(ad):
-      return True
-  return False
diff --git a/tests/bettertogether/betocq/base_betocq_suite.py b/tests/bettertogether/betocq/base_betocq_suite.py
deleted file mode 100644
index 373fc4c46..000000000
--- a/tests/bettertogether/betocq/base_betocq_suite.py
+++ /dev/null
@@ -1,121 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Base class for BetoCQ test suites."""
-
-import logging
-import os
-
-from mobly import base_suite
-from mobly import records
-import yaml
-
-from betocq import version
-
-
-_BETOCQ_SUITE_NAME = 'BeToCQ'
-
-
-class BaseBetocqSuite(base_suite.BaseSuite):
-  """Base class for BetoCQ test suites.
-
-  Contains methods for aggregating and exporting suite data.
-  """
-
-  def __init__(self, runner, config):
-    super().__init__(runner, config)
-    self._summary_path = None
-    self._summary_writer = None
-
-  def teardown_suite(self):
-    """Collects test class results and reports them as suite properties."""
-    user_data = self._retrieve_user_data_from_summary()
-    class_data = [
-        entry
-        for entry in user_data
-        if records.TestResultEnums.RECORD_CLASS in entry
-        and records.TestResultEnums.RECORD_NAME not in entry
-    ]
-    class_results = {
-      'suite_name': _BETOCQ_SUITE_NAME,
-      'run_identifier': f'v{version.TEST_SCRIPT_VERSION}',
-    }
-    for entry in class_data:
-      properties = entry.get('properties', {})
-      for key, value in properties.items():
-        # prepend '0'/'1' so the properties appear first in lexicographic order
-        if key.endswith('source_device'):
-          if '0_source_device' not in class_results:
-            class_results['0_source_device'] = value
-        if key.endswith('target_device'):
-          if '0_target_device' not in class_results:
-            class_results['0_target_device'] = value
-        if key.endswith('test_result'):
-          class_results[f'1_{entry[records.TestResultEnums.RECORD_CLASS]}'] = (
-              value
-          )
-        if key.endswith('detailed_stats'):
-          class_results[
-              f'1_{entry[records.TestResultEnums.RECORD_CLASS]}_detailed_stats'
-          ] = value
-    self._record_suite_properties(class_results)
-
-  @property
-  def summary_path(self):
-    """Returns the path to the summary file.
-
-    NOTE: This path is only correctly resolved if called within teardown_suite.
-    """
-    if self._summary_path is None:
-      # pylint: disable-next=protected-access
-      self._summary_path = self._runner._test_run_metadata.summary_file_path
-    return self._summary_path
-
-  def _retrieve_user_data_from_summary(self):
-    """Retrieves all user_data entries from the currently streamed summary.
-
-    Use this method to aggregate data written by record_data in test classes.
-
-    NOTE: This method can only be called within teardown_suite.
-
-    Returns:
-      A list of dictionaries, each corresponding to a USER_DATA entry.
-    """
-    if not os.path.isfile(self.summary_path):
-      logging.error(
-          'Cannot retrieve user data for the suite. '
-          'The summary file does not exist: %s',
-          self.summary_path,
-      )
-      return []
-
-    with open(self.summary_path, 'r') as f:
-      return [
-          entry
-          for entry in yaml.safe_load_all(f)
-          if entry['Type'] == records.TestSummaryEntryType.USER_DATA.value
-      ]
-
-  def _record_suite_properties(self, properties):
-    """Record suite properties to the test summary file.
-
-    NOTE: This method can only be called within teardown_suite.
-
-    Args:
-      properties: dict, the properties to add to the summary
-    """
-    if self._summary_writer is None:
-      self._summary_writer = records.TestSummaryWriter(self.summary_path)
-    content = {'properties': properties}
-    self._summary_writer.dump(content, records.TestSummaryEntryType.USER_DATA)
diff --git a/tests/bettertogether/betocq/betocq_test_suite.py b/tests/bettertogether/betocq/betocq_test_suite.py
deleted file mode 100644
index a6be16ce1..000000000
--- a/tests/bettertogether/betocq/betocq_test_suite.py
+++ /dev/null
@@ -1,237 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This test suite batches all tests to run in sequence.
-
-This requires 3 APs to be ready and configured in testbed.
-2G AP (wifi_2g_ssid): channel 6 (2437)
-5G AP (wifi_5g_ssid): channel 36 (5180)
-DFS 5G AP(wifi_dfs_5g_ssid): channel 52 (5260)
-"""
-
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly import suite_runner
-
-from betocq import base_betocq_suite
-from betocq import nc_constants
-from betocq.compound_tests import bt_2g_wifi_coex_test
-from betocq.compound_tests import mcc_5g_all_wifi_non_dbs_2g_sta_test
-from betocq.compound_tests import scc_2g_all_wifi_sta_test
-from betocq.compound_tests import scc_5g_all_wifi_dbs_2g_sta_test
-from betocq.compound_tests import scc_5g_all_wifi_sta_test
-from betocq.directed_tests import ble_performance_test
-from betocq.directed_tests import bt_performance_test
-from betocq.directed_tests import mcc_2g_wfd_indoor_5g_sta_test
-from betocq.directed_tests import mcc_5g_hotspot_dfs_5g_sta_test
-from betocq.directed_tests import mcc_5g_wfd_dfs_5g_sta_test
-from betocq.directed_tests import mcc_5g_wfd_non_dbs_2g_sta_test
-from betocq.directed_tests import mcc_aware_2g_5g_sta_test
-from betocq.directed_tests import scc_2g_wfd_sta_test
-from betocq.directed_tests import scc_2g_wlan_sta_test
-from betocq.directed_tests import scc_5g_aware_sta_test
-from betocq.directed_tests import scc_5g_wfd_dbs_2g_sta_test
-from betocq.directed_tests import scc_5g_wfd_sta_test
-from betocq.directed_tests import scc_5g_wlan_sta_test
-from betocq.directed_tests import scc_dfs_5g_hotspot_sta_test
-from betocq.directed_tests import scc_dfs_5g_wfd_sta_test
-from betocq.directed_tests import scc_indoor_5g_wfd_sta_test
-from betocq.function_tests import beto_cq_function_group_test
-from betocq.function_tests import nearbyconnections_function_test
-
-
-class BetoCqPerformanceTestSuite(base_betocq_suite.BaseBetocqSuite):
-  """Add all BetoCQ tests to run in sequence."""
-
-  def __init__(self, runner, config):
-    super().__init__(runner, config)
-    self._enabled_test_classes = {}
-
-  def enable_test_class(self, clazz, config=None):
-    """Enable the test class within the suite.
-
-    Once enabled, the test class will run if the user selects it explicitly from
-    the command line, or by default if no user selection is made.
-
-    Args:
-      clazz: class, a Mobly test class.
-      config: config_parser.TestRunConfig, the config to run the class with. If
-        not specified, the loaded config file is used as is.
-    """
-    self._enabled_test_classes[clazz] = config
-
-  def add_enabled_test_classes_from_selection(self):
-    """Add enabled test classes to run, based on the user selection."""
-    test_selector = suite_runner._parse_cli_args(None).tests
-    selected_tests = suite_runner.compute_selected_tests(
-        self._enabled_test_classes.keys(), test_selector
-    )
-    for test_class, tests in selected_tests.items():
-      self.add_test_class(
-          test_class, config=self._enabled_test_classes[test_class], tests=tests
-      )
-
-  def setup_suite(self, config):
-    """Add all BetoCQ tests to the suite."""
-    test_parameters = nc_constants.TestParameters.from_user_params(
-        config.user_params
-    )
-
-    if test_parameters.target_cuj_name == nc_constants.TARGET_CUJ_ESIM:
-      self.enable_test_class(bt_performance_test.BtPerformanceTest)
-      return
-
-    # enable function tests if required
-    if (
-        test_parameters.run_function_tests_with_performance_tests
-        or test_parameters.use_auto_controlled_wifi_ap
-    ):
-      self.enable_test_class(
-          beto_cq_function_group_test.BetoCqFunctionGroupTest
-      )
-
-    # enable nearby connections function tests if required
-    if test_parameters.run_nearby_connections_function_tests:
-      self.add_test_class(
-          nearbyconnections_function_test.NearbyConnectionsFunctionTest
-      )
-
-    if test_parameters.run_bt_coex_test:
-      self.enable_test_class(bt_2g_wifi_coex_test.Bt2gWifiCoexTest)
-
-    # enable bt and ble test
-    if test_parameters.run_bt_performance_test:
-      self.enable_test_class(bt_performance_test.BtPerformanceTest)
-
-    if test_parameters.run_ble_performance_test:
-      self.enable_test_class(ble_performance_test.BlePerformanceTest)
-
-    # enable directed/cuj tests which requires 2G wlan AP - channel 6
-    if (
-        test_parameters.wifi_2g_ssid
-        or test_parameters.use_auto_controlled_wifi_ap
-    ):
-      config = self._config.copy()
-      config.user_params['wifi_channel'] = 6
-
-      if test_parameters.run_directed_test:
-        self.enable_test_class(
-            clazz=mcc_5g_wfd_non_dbs_2g_sta_test.Mcc5gWfdNonDbs2gStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_2g_wfd_sta_test.Scc2gWfdStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_2g_wlan_sta_test.Scc2gWlanStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_5g_wfd_dbs_2g_sta_test.Scc5gWfdDbs2gStaTest,
-            config=config,
-        )
-      if test_parameters.run_compound_test:
-        self.enable_test_class(
-            clazz=mcc_5g_all_wifi_non_dbs_2g_sta_test.Mcc5gAllWifiNonDbs2gStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_2g_all_wifi_sta_test.Scc2gAllWifiStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_5g_all_wifi_dbs_2g_sta_test.Scc5gAllWifiDbs2gStaTest,
-            config=config,
-        )
-
-    # enable directed tests which requires 5G wlan AP - channel 36
-    if (
-        test_parameters.wifi_5g_ssid
-        or test_parameters.use_auto_controlled_wifi_ap
-    ):
-      config = self._config.copy()
-      config.user_params['wifi_channel'] = 36
-
-      if test_parameters.run_directed_test:
-        self.enable_test_class(
-            clazz=mcc_2g_wfd_indoor_5g_sta_test.Mcc2gWfdIndoor5gStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_5g_wfd_sta_test.Scc5gWfdStaTest,
-            config=config,
-        )
-        if test_parameters.run_aware_test:
-          self.add_test_class(
-              clazz=scc_5g_aware_sta_test.Scc5gAwareStaTest,
-              config=config,
-          )
-          self.add_test_class(
-              clazz=mcc_aware_2g_5g_sta_test.MccAware2g5gStaTest,
-              config=config,
-          )
-        self.enable_test_class(
-            clazz=scc_5g_wlan_sta_test.Scc5gWifiLanStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_indoor_5g_wfd_sta_test.SccIndoor5gWfdStaTest,
-            config=config,
-        )
-      if test_parameters.run_compound_test:
-        self.enable_test_class(
-            clazz=scc_5g_all_wifi_sta_test.Scc5gAllWifiStaTest,
-            config=config,
-        )
-
-    # enable directed/cuj tests which requires DFS 5G wlan AP - channel 52
-    if (
-        test_parameters.wifi_dfs_5g_ssid
-        or test_parameters.use_auto_controlled_wifi_ap
-    ):
-      config = self._config.copy()
-      config.user_params['wifi_channel'] = 52
-
-      if test_parameters.run_directed_test:
-        self.enable_test_class(
-            clazz=mcc_5g_hotspot_dfs_5g_sta_test.Mcc5gHotspotDfs5gStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=mcc_5g_wfd_dfs_5g_sta_test.Mcc5gWfdDfs5gStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_dfs_5g_hotspot_sta_test.SccDfs5gHotspotStaTest,
-            config=config,
-        )
-        self.enable_test_class(
-            clazz=scc_dfs_5g_wfd_sta_test.SccDfs5gWfdStaTest,
-            config=config,
-        )
-
-    self.add_enabled_test_classes_from_selection()
-
-
-if __name__ == '__main__':
-  # Use suite_runner's `main`.
-  suite_runner.run_suite_class()
diff --git a/tests/bettertogether/betocq/compound_tests/bt_2g_wifi_coex_test.py b/tests/bettertogether/betocq/compound_tests/bt_2g_wifi_coex_test.py
deleted file mode 100644
index ce8926ca6..000000000
--- a/tests/bettertogether/betocq/compound_tests/bt_2g_wifi_coex_test.py
+++ /dev/null
@@ -1,103 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the bluetooth and wifi 2G coex.
-
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-_PERFORMANCE_TEST_COUNT = 100
-_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 10
-
-
-class Bt2gWifiCoexTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for BT and 2G wifi coex with a complicated stress test."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    self.test_parameters.requires_bt_multiplex = True
-    # we don't care speed so that there is no need to wait
-    self.test_parameters.target_post_wifi_connection_idle_time_sec = 0
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_bt_2g_wifi_coex, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_bt_2g_wifi_coex(self):
-    """Test the BT and 2G wifi coex with a stress test."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_ALL_WIFI,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    # For 2G wifi medium
-    return nc_constants.TRANSFER_FILE_SIZE_20MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related log.'
-    )
-
-  # @typing.override
-  def _get_throughput_benchmark(
-      self, sta_frequency: int, sta_max_link_speed_mbps: int
-  ) -> tuple[float, float]:
-    # no requirement for throughput.
-    return (0.0, 0.0)
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}.'
-        ' This should never happen, you may ignore this error, this is'
-        ' not required for this case.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/compound_tests/mcc_5g_all_wifi_non_dbs_2g_sta_test.py b/tests/bettertogether/betocq/compound_tests/mcc_5g_all_wifi_non_dbs_2g_sta_test.py
deleted file mode 100644
index b80e1ded0..000000000
--- a/tests/bettertogether/betocq/compound_tests/mcc_5g_all_wifi_non_dbs_2g_sta_test.py
+++ /dev/null
@@ -1,118 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC in a general case.
-
-In this case, even though the expected wifi medium is the WFD, but the wifi D2D
-could be any wifi mediums, such as WFD, HOTSPOT, WifiLan; Once the WFD is
-failed, other meidums will be tried. As DBS is not supported by both devices,
-and the STA is coonected with 2G channel, D2D medium is using a 5G channel,
-this cause the MCC case.
-
-The device requirements:
-  support 5G: true
-  support DBS (target device): false
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Mcc5gAllWifiNonDbs2gStaTest(
-    d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for CUJ MCC with 5G D2D medium and 2G WLAN test."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_5g_all_wifi_non_dbs_2g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.MCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_5g_all_wifi_non_dbs_2g_sta(self):
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.UPGRADE_TO_ALL_WIFI,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-
-    return (
-        f'The upgraded wifi medium {upgraded_medium_name} might be broken, '
-        f'check the related log, Or {self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'{self._throughput_low_string}. The upgraded medium is'
-        f' {upgraded_medium_name} Check with the wifi chip vendor for any FW'
-        ' issue in MCC mode'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'supports_dbs_sta_wfd': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/compound_tests/scc_2g_all_wifi_sta_test.py b/tests/bettertogether/betocq/compound_tests/scc_2g_all_wifi_sta_test.py
deleted file mode 100644
index 1c7ef42be..000000000
--- a/tests/bettertogether/betocq/compound_tests/scc_2g_all_wifi_sta_test.py
+++ /dev/null
@@ -1,121 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC in a general case.
-
-In this case, even though the expected wifi medium is the WFD, but the wifi D2D
-could be any technologies, such as WFD, HOTSPOT, WifiLAN; Once the WFD is
-failed, other meidums will be tried. Both the D2D and STA are using the same 2G
-channel.
-
-The device requirements:
-  support 5G: false
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc2gAllWifiStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC 2G test associated with a specified CUJ."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_2g_d2d_wifi_medium = True
-    self.performance_test_iterations = getattr(
-        self.test_scc_2g_all_wifi_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_2g_all_wifi_sta(self):
-    """Test the 2G SCC case, both the wifi D2D medium and STA are using 2G."""
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.UPGRADE_TO_ALL_WIFI,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password)
-
-  def _get_transfer_file_size(self) -> int:
-    # For 2G wifi medium
-    return nc_constants.TRANSFER_FILE_SIZE_20MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'The upgraded wifi medium {upgraded_medium_name} might be broken, '
-        f'check the related log; Or {self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'{self._throughput_low_string}. The upgraded medium is'
-        f' {upgraded_medium_name}, this is a 2G SCC case. Check with the wifi'
-        ' chip vendor for any FW issue in this mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': False,
-        },
-        'advertiser': {
-            'supports_5g': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_dbs_2g_sta_test.py b/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_dbs_2g_sta_test.py
deleted file mode 100644
index a06d0bad8..000000000
--- a/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_dbs_2g_sta_test.py
+++ /dev/null
@@ -1,119 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC in a general case.
-
-In this case, even though the expected wifi medium is the WFD, but the wifi D2D
-could be any mediums, such as WFD, HOTSPOT, STA; Once the WFD is failed, other
-mediums will be tried. Also, though the WLAN is connected with 2G channel,
-as the devices support DBS, which don't need to switch between 5G and 2G, it is
-still a SCC case.
-
-The device requirements:
-  support 5G: true
-  support DBS (target device): true
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gAllWifiDbs2gStaTest(
-    d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for CUJ SCC with 5G D2D medium and 2G WLAN test.
-  """
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_dbs_mode = True
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_all_wifi_dbs_2g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_all_wifi_dbs_2g_sta(self):
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.UPGRADE_TO_ALL_WIFI,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'The upgraded wifi medium {upgraded_medium_name} might be broken, '
-        f'check the related log, Or {self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'{self._throughput_low_string}. The upgraded medium is'
-        f' {upgraded_medium_name}. This is a 5G SCC DBS case, In the'
-        ' configuration file, DBS support is set to true on the target side.'
-        ' Check if the device does support DBS with STA + WFD concurrency.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'supports_dbs_sta_wfd': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_sta_test.py b/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_sta_test.py
deleted file mode 100644
index 7c0289df8..000000000
--- a/tests/bettertogether/betocq/compound_tests/scc_5g_all_wifi_sta_test.py
+++ /dev/null
@@ -1,114 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC in a general case.
-
-In this case, even though the expected wifi medium is the WFD, but the wifi D2D
-could be any technologies, such as WFD, HOTSPOT, STA; Once the WFD is failed,
-other meidums will be tried. Both the D2D medium and STA are using the same 5G
-channel.
-
-The device requirements:
-  support 5G: true
-  country code: US
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gAllWifiStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC 5G test associated with a specified CUJ."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_all_wifi_sta_test, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_all_wifi_sta_test(self):
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.UPGRADE_TO_ALL_WIFI,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'The upgraded wifi medium {upgraded_medium_name} might be broken, '
-        f'check the related logs; Or {self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    upgraded_medium_name = None
-    if (self._current_test_result.quality_info.upgrade_medium
-        is not None):
-      upgraded_medium_name = (
-          self._current_test_result.quality_info.upgrade_medium.name
-      )
-    return (
-        f'{self._throughput_low_string}. The upgraded medium is'
-        f' {upgraded_medium_name}.'
-        ' This is a 5G SCC case. Check with the wifi'
-        ' chip vendor for any possible FW issue.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/cuj_and_test_config.yml b/tests/bettertogether/betocq/cuj_and_test_config.yml
deleted file mode 100644
index 95b4fd75e..000000000
--- a/tests/bettertogether/betocq/cuj_and_test_config.yml
+++ /dev/null
@@ -1,129 +0,0 @@
-x-test-params: &test-params
-  # for 2G wifi SSID - channel 6, frequency 2437, comment out if it is not available.
-  wifi_2g_ssid: "AP2437"
-  wifi_2g_password: "AP2437"
-  # for 5G wifi SSID - channel 36, frequency 5180, comment out if it is not available.
-  wifi_5g_ssid: "AP5180"
-  wifi_5g_password: "AP5180"
-  # for DFS 5G wifi SSID - channel 52, frequency 5260, comment out if it is not available.
-  wifi_dfs_5g_ssid: "AP5260"
-  wifi_dfs_5g_password: "AP5260"
-  # use the AP controlled by programming dynamically
-  use_auto_controlled_wifi_ap: False
-  run_function_tests_with_performance_tests: True
-  run_bt_performance_test: True
-  run_directed_test: True
-  run_compound_test: True
-  run_bt_coex_test: True
-  run_iperf_test: True
-  allow_unrooted_device: False
-  skip_bug_report: False
-
-x-controllers: &controllers
-  Controllers:
-    AndroidDevice:
-      - serial: "33141FDJH0002A"
-        role: "source_device"
-        wifi_chipset: "" # WiFi/BT chipset model, for example, wcn6710, MT7922
-        # The max number of spatial streams
-        max_num_streams: 2
-        # The max PHY rate at 5G, in Mbps
-        max_phy_rate_5g_mbps: 2402
-        # The max PHY rate at 2G, in Mbps
-        max_phy_rate_2g_mbps: 287
-        # if the device supports 5G Wifi
-        supports_5g: True
-        # if the device supports DBS (Dual Band Simultaneous) in STA + WiFi-Direct concurrency mode
-        supports_dbs_sta_wfd: True
-        # The max number of spatial streams in DBS mode.
-        max_num_streams_dbs: 2
-        # if the device supports to start WFD group owner at a STA-associated DFS channel
-        enable_sta_dfs_channel_for_peer_network: False
-        # if the device supports to start WFD group owner at a STA-associated indoor channel
-        enable_sta_indoor_channel_for_peer_network: False
-        # 14 - U, 13 - T, 12 - S
-        android_version: 14
-      - serial: "35081FDJG000FC"
-        role: "target_device"
-        wifi_chipset: "" # WiFi/BT chipset model, for example, wcn6710, MT7922
-        # The max number of spatial streams
-        max_num_streams: 2
-        # The max PHY rate at 5G, in Mbps
-        max_phy_rate_5g_mbps: 2402
-        # The max PHY rate at 2G, in Mbps
-        max_phy_rate_2g_mbps: 287
-        # if the device supports 5G Wifi
-        supports_5g: True
-        # if the device supports DBS (Dual Band Simultaneous) in STA + WiFi-Direct concurrency mode
-        supports_dbs_sta_wfd: True
-        # The max number of spatial streams in DBS mode.
-        max_num_streams_dbs: 2
-        # if the device supports to start WFD group owner at a STA-associated DFS channel
-        enable_sta_dfs_channel_for_peer_network: False
-        # if the device supports to start WFD group owner at a STA-associated indoor channel
-        enable_sta_indoor_channel_for_peer_network: False
-        # 14 - U, 13 - T, 12 - S
-        android_version: 14
-
-TestBeds:
-- Name: Default
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-
-- Name: Quickstart
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      target_cuj_name: "quick_start"
-      # before the performance test, run the function tests first
-      run_function_tests_with_performance_tests: True
-      # if the function tests is failed, abort the performance test
-      abort_all_tests_on_function_tests_fail: True
-
-- Name: Quickshare
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      target_cuj_name: "quick_share"
-      # before the performance test, run the function tests first
-      run_function_tests_with_performance_tests: True
-      # if the function tests is failed, abort the performance test
-      abort_all_tests_on_function_tests_fail: True
-      run_ble_performance_test: True
-
-- Name: EsimTransfer
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      target_cuj_name: "setting_based_esim_transfer"
-
-- Name: QuickstartFunction
-  Controllers:
-    <<: *controllers
-  TestParams:
-      <<: *test-params
-      target_cuj_name: "quick_start"
-
-- Name: NearbyConnectionsFunction
-  <<: *controllers
-  TestParams:
-    <<: *test-params
-    target_cuj_name: "nearby_connections_function"
-    requires_3p_api_test: True
-    connect_to_wifi_before_test: True
-    run_function_tests_with_performance_tests: False
-    run_bt_performance_test: False
-    run_ble_performance_test: False
-    run_bt_coex_test: False
-    run_directed_test: False
-    run_compound_test: False
-    run_iperf_test: False
-    run_nearby_connections_function_tests: True
-
-- Name: QuickshareFunctionTest
-  Controllers:
-    <<: *controllers
-  TestParams:
-      <<: *test-params
-      target_cuj_name: "quick_share"
diff --git a/tests/bettertogether/betocq/d2d_performance_test_base.py b/tests/bettertogether/betocq/d2d_performance_test_base.py
deleted file mode 100644
index f341f9470..000000000
--- a/tests/bettertogether/betocq/d2d_performance_test_base.py
+++ /dev/null
@@ -1,948 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Nearby Connection E2E stress tests for D2D wifi performance."""
-
-import abc
-import datetime
-import logging
-import time
-from typing import Any
-
-from mobly import asserts
-from mobly.controllers import android_device
-
-from betocq import iperf_utils
-from betocq import nc_base_test
-from betocq import nc_constants
-from betocq import nearby_connection_wrapper
-from betocq import setup_utils
-
-
-_DELAY_BETWEEN_EACH_TEST_CYCLE = datetime.timedelta(seconds=0)
-_BITS_PER_BYTE = 8
-_MAX_FREQ_2G_MHZ = 2500
-_MIN_FREQ_5G_DFS_MHZ = 5260
-_MAX_FREQ_5G_DFS_MHZ = 5720
-
-
-class D2dPerformanceTestBase(nc_base_test.NCBaseTestClass, abc.ABC):
-  """Abstract class for D2D performance test for different connection meidums."""
-
-  performance_test_iterations: int
-
-  # @typing.override
-  def __init__(self, configs):
-    super().__init__(configs)
-    self._is_mcc: bool = False
-    self._is_2g_d2d_wifi_medium: bool = False
-    self._is_dbs_mode: bool = False
-    self._throughput_low_string: str = ''
-    self._upgrade_medium_under_test: nc_constants.NearbyMedium = None
-    self._connection_medium: nc_constants.NearbyMedium = None
-    self._advertising_discovery_medium: nc_constants.NearbyMedium = None
-    self._current_test_result: nc_constants.SingleTestResult = (
-        nc_constants.SingleTestResult()
-    )
-    self._performance_test_metrics: nc_constants.NcPerformanceTestMetrics = (
-        nc_constants.NcPerformanceTestMetrics()
-    )
-    self._prior_bt_nc_fail_reason: nc_constants.SingleTestFailureReason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-    self._active_nc_fail_reason: nc_constants.SingleTestFailureReason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-    self._finished_test_iteration: int = 0
-    self._use_prior_bt: bool = False
-    self._start_time: datetime.datetime = datetime.datetime.now()
-    self._wifi_ssid: str = ''
-    self._test_results: list[nc_constants.SingleTestResult] = []
-
-  # @typing.override
-  def setup_test(self):
-    self._current_test_result: nc_constants.SingleTestResult = (
-        nc_constants.SingleTestResult()
-    )
-    self._prior_bt_nc_fail_reason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-    self._active_nc_fail_reason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-    super().setup_test()
-
-  def teardown_test(self):
-    self._write_current_test_report()
-    self._collect_current_test_metrics()
-    super().teardown_test()
-    time.sleep(_DELAY_BETWEEN_EACH_TEST_CYCLE.total_seconds())
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    """Returns the definition of devices capabilities."""
-    return {}
-
-  # @typing.override
-  def _get_skipped_test_class_reason(self) -> str | None:
-    if not self._is_wifi_ap_ready():
-      return 'Wifi AP is not ready for this test.'
-    skip_reason = self._check_devices_capabilities()
-    if skip_reason is not None:
-      return (
-          f'The test is not required per the device capabilities. {skip_reason}'
-      )
-    return None
-
-  @abc.abstractmethod
-  def _is_wifi_ap_ready(self) -> bool:
-    pass
-
-  def _check_devices_capabilities(self) -> str | None:
-    """Checks if all devices capabilities meet requirements."""
-    for ad_role, capabilities in self._devices_capabilities_definition.items():
-      for key, value in capabilities.items():
-        ad = getattr(self, ad_role)
-        capability = getattr(ad, key)
-        if capability != value:
-          return (
-              f'{ad} {ad_role}.{key} is'
-              f' {"enabled" if capability else "disabled"}'
-          )
-    return None
-
-  def _get_target_sta_frequency_and_max_link_speed(self) -> tuple[int, int]:
-    """Gets the STA frequency and max link speed."""
-    connection_info = self.advertiser.nearby.wifiGetConnectionInfo()
-    sta_frequency = int(
-        connection_info.get('mFrequency', nc_constants.INVALID_INT)
-    )
-
-    sta_max_link_speed_mbps = int(
-        connection_info.get(
-            'mMaxSupportedTxLinkSpeed', nc_constants.INVALID_INT
-        )
-    )
-    if sta_frequency == nc_constants.INVALID_INT:
-      sta_frequency = setup_utils.get_wifi_sta_frequency(self.advertiser)
-      sta_max_link_speed_mbps = setup_utils.get_wifi_sta_max_link_speed(
-          self.advertiser
-      )
-    return (sta_frequency, sta_max_link_speed_mbps)
-
-  def _get_throughput_benchmark(
-      self, sta_frequency: int, sta_max_link_speed_mbps: int
-  ) -> tuple[float, float]:
-    """Gets the throughput benchmark as MBps."""
-    max_num_streams = min(
-        self.discoverer.max_num_streams, self.advertiser.max_num_streams
-    )
-
-    if self._is_2g_d2d_wifi_medium:
-      max_phy_rate_mbps = min(
-          self.discoverer.max_phy_rate_2g_mbps,
-          self.advertiser.max_phy_rate_2g_mbps,
-      )
-      max_phy_rate_mbps = min(
-          max_phy_rate_mbps,
-          max_num_streams * nc_constants.MAX_PHY_RATE_PER_STREAM_N_20_MBPS,
-      )
-      min_throughput_mbyte_per_sec = int(
-          max_phy_rate_mbps
-          * nc_constants.MAX_PHY_RATE_TO_MIN_THROUGHPUT_RATIO_2G
-          / _BITS_PER_BYTE
-      )
-      nc_min_throughput_mbyte_per_sec = min_throughput_mbyte_per_sec
-    else:  # 5G wifi medium
-      max_phy_rate_mbps = min(
-          self.discoverer.max_phy_rate_5g_mbps,
-          self.advertiser.max_phy_rate_5g_mbps,
-      )
-      # max_num_streams could be smaller in DBS mode
-      if self._is_dbs_mode:
-        max_num_streams = self.advertiser.max_num_streams_dbs
-
-      max_phy_rate_ac80 = (
-          max_num_streams * nc_constants.MAX_PHY_RATE_PER_STREAM_AC_80_MBPS
-      )
-      max_phy_rate_mbps = min(max_phy_rate_mbps, max_phy_rate_ac80)
-
-      # if STA is connected to 5G AP with channel BW < 80,
-      # limit the max phy rate to AC 40.
-      if (
-          sta_frequency > 5000
-          and sta_max_link_speed_mbps > 0
-          and sta_max_link_speed_mbps < max_phy_rate_ac80
-      ):
-        max_phy_rate_mbps = min(
-            max_phy_rate_mbps,
-            max_num_streams * nc_constants.MAX_PHY_RATE_PER_STREAM_AC_40_MBPS,
-        )
-
-      min_throughput_mbyte_per_sec = int(
-          max_phy_rate_mbps
-          * nc_constants.MAX_PHY_RATE_TO_MIN_THROUGHPUT_RATIO_5G
-          / _BITS_PER_BYTE
-      )
-      if self._is_mcc:
-        min_throughput_mbyte_per_sec = int(
-            min_throughput_mbyte_per_sec
-            * nc_constants.MCC_THROUGHPUT_MULTIPLIER
-        )
-
-      nc_min_throughput_mbyte_per_sec = min_throughput_mbyte_per_sec
-      if (
-          self._current_test_result.quality_info.upgrade_medium
-          == nc_constants.NearbyConnectionMedium.WIFI_LAN
-      ):
-        nc_min_throughput_mbyte_per_sec = min(
-            nc_min_throughput_mbyte_per_sec,
-            nc_constants.WLAN_THROUGHPUT_CAP_MBPS,
-        )
-
-
-    self.advertiser.log.info(
-        f'target STA freq = {sta_frequency}, '
-        f'max STA speed (Mb/s): {sta_max_link_speed_mbps}, '
-        f'max D2D speed (MB/s): {max_phy_rate_mbps / _BITS_PER_BYTE}, '
-        f'min D2D speed (MB/s), iperf: {min_throughput_mbyte_per_sec}, '
-        f'nc: {nc_min_throughput_mbyte_per_sec}'
-    )
-    return (min_throughput_mbyte_per_sec, nc_min_throughput_mbyte_per_sec)
-
-  def _test_connection_medium_performance(
-      self,
-      upgrade_medium_under_test: nc_constants.NearbyMedium,
-      wifi_ssid: str = '',  # used by discoverer and possibly advertiser
-      wifi_password: str = '',  # used by discoverer and advertiser
-      force_disable_bt_multiplex: bool = False,
-      connection_medium: nc_constants.NearbyMedium = nc_constants.NearbyMedium.BT_ONLY,
-      wifi_ssid2: str = '',  # used by advertiser if not empty
-  ) -> None:
-    """Test the D2D performance with the specified upgrade medium."""
-    self._upgrade_medium_under_test = upgrade_medium_under_test
-    self._connection_medium = connection_medium
-    self._wifi_ssid = wifi_ssid
-
-    if self.test_parameters.toggle_airplane_mode_target_side:
-      setup_utils.toggle_airplane_mode(self.advertiser)
-    advertising_discovery_medium = nc_constants.NearbyMedium(
-        self.test_parameters.advertising_discovery_medium
-    )
-    self._advertising_discovery_medium = advertising_discovery_medium
-    if self.test_parameters.reset_wifi_connection:
-      self._reset_wifi_connection()
-    # 1. discoverer connect to wifi STA/AP
-    self._current_test_result = nc_constants.SingleTestResult()
-    if wifi_ssid:
-      self._active_nc_fail_reason = (
-          nc_constants.SingleTestFailureReason.SOURCE_WIFI_CONNECTION
-      )
-      discoverer_wifi_sta_latency = (
-          setup_utils.connect_to_wifi_sta_till_success(
-              self.discoverer, wifi_ssid, wifi_password
-          )
-      )
-      self._active_nc_fail_reason = nc_constants.SingleTestFailureReason.SUCCESS
-      self.discoverer.log.info(
-          'connecting to wifi in '
-          f'{round(discoverer_wifi_sta_latency.total_seconds())} s'
-      )
-      self._current_test_result.discoverer_sta_expected = True
-      self._current_test_result.discoverer_sta_latency = (
-          discoverer_wifi_sta_latency
-      )
-
-    # 2. set up BT connection if required
-    # Because target STA is not yet connected, discovery is done over BLE only.
-    advertising_discovery_medium = nc_constants.NearbyMedium.BLE_ONLY
-
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT,
-    )
-    prior_bt_snippet = None
-    if (
-        not force_disable_bt_multiplex
-        and self.test_parameters.requires_bt_multiplex
-    ):
-      logging.info('set up a prior BT connection.')
-      self._use_prior_bt = True
-      prior_bt_snippet = nearby_connection_wrapper.NearbyConnectionWrapper(
-          self.advertiser,
-          self.discoverer,
-          self.advertiser.nearby2,
-          self.discoverer.nearby2,
-          advertising_discovery_medium=nc_constants.NearbyMedium.BLE_ONLY,
-          connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-          upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-      )
-
-      try:
-        prior_bt_snippet.start_nearby_connection(
-            timeouts=connection_setup_timeouts,
-            medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE,
-        )
-      finally:
-        self._prior_bt_nc_fail_reason = prior_bt_snippet.test_failure_reason
-        self._current_test_result.prior_nc_quality_info = (
-            prior_bt_snippet.connection_quality_info
-        )
-
-    # set up Wifi connection and transfer
-    # 3. advertiser connect to wifi STA/AP
-    wifi_ssid_advertiser = wifi_ssid
-    if wifi_ssid2:
-      wifi_ssid_advertiser = wifi_ssid2
-    if wifi_ssid_advertiser:
-      self._active_nc_fail_reason = (
-          nc_constants.SingleTestFailureReason.TARGET_WIFI_CONNECTION
-      )
-      advertiser_wifi_sta_latency = (
-          setup_utils.connect_to_wifi_sta_till_success(
-              self.advertiser, wifi_ssid_advertiser, wifi_password
-          )
-      )
-      self.advertiser.log.info(
-          'connecting to wifi in '
-          f'{round(advertiser_wifi_sta_latency.total_seconds())} s'
-      )
-      self.advertiser.log.info(
-          self.advertiser.nearby.wifiGetConnectionInfo().get('mFrequency')
-      )
-      self._current_test_result.advertiser_wifi_expected = True
-      self._current_test_result.advertiser_sta_latency = (
-          advertiser_wifi_sta_latency
-      )
-      # Let scan, DHCP and internet validation complete before NC.
-      # This is important especially for the transfer speed test.
-      time.sleep(self.test_parameters.target_post_wifi_connection_idle_time_sec)
-
-    # 4. set up the D2D nearby connection
-    logging.info('set up a nearby connection for file transfer.')
-    active_snippet = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=connection_medium,
-        upgrade_medium=upgrade_medium_under_test,
-    )
-    if prior_bt_snippet:
-      connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-          nc_constants.SECOND_DISCOVERY_TIMEOUT,
-          nc_constants.SECOND_CONNECTION_INIT_TIMEOUT,
-          nc_constants.SECOND_CONNECTION_RESULT_TIMEOUT,
-      )
-    try:
-      active_snippet.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.DISRUPTIVE,
-          keep_alive_timeout_ms=self.test_parameters.keep_alive_timeout_ms,
-          keep_alive_interval_ms=self.test_parameters.keep_alive_interval_ms,
-      )
-    finally:
-      self._active_nc_fail_reason = active_snippet.test_failure_reason
-      self._current_test_result.quality_info = (
-          active_snippet.connection_quality_info
-      )
-
-    # 5. transfer file through the nearby connection and optionally run iperf
-    try:
-      self._current_test_result.file_transfer_throughput_kbps = (
-          active_snippet.transfer_file(
-              self._get_transfer_file_size(),
-              self._get_file_transfer_timeout(),
-              self.test_parameters.payload_type,
-          )
-      )
-      if (
-          self.test_parameters.run_iperf_test
-          and not self._is_mcc
-          and upgrade_medium_under_test
-          in [
-              nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-              nc_constants.NearbyMedium.UPGRADE_TO_WIFIHOTSPOT,
-              nc_constants.NearbyMedium.WIFILAN_ONLY,
-              nc_constants.NearbyMedium.WIFIAWARE_ONLY,
-          ]
-      ):
-        # TODO: b/338094399 - update this part for the connection over WFD.
-        self._current_test_result.iperf_throughput_kbps = (
-            iperf_utils.run_iperf_test(
-                self.discoverer,
-                self.advertiser,
-                self._current_test_result.quality_info.upgrade_medium,
-            )
-        )
-
-    finally:
-      self._active_nc_fail_reason = active_snippet.test_failure_reason
-      self._check_ap_connection_and_speed(wifi_ssid_advertiser)
-
-    # 6. disconnect prior BT connection if required
-    if prior_bt_snippet:
-      prior_bt_snippet.disconnect_endpoint()
-    # 7. disconnect D2D active connection
-    active_snippet.disconnect_endpoint()
-
-  def _check_ap_connection_and_speed(self, wifi_ssid: str) -> None:
-    (sta_frequency, max_link_speed_mbps) = (
-        self._get_target_sta_frequency_and_max_link_speed()
-    )
-    self._current_test_result.sta_frequency = sta_frequency
-    self._current_test_result.max_sta_link_speed_mbps = max_link_speed_mbps
-    if wifi_ssid and(
-        sta_frequency == nc_constants.INVALID_INT
-        or max_link_speed_mbps == nc_constants.INVALID_INT
-    ):
-      self._active_nc_fail_reason = (
-          nc_constants.SingleTestFailureReason.DISCONNECTED_FROM_AP
-      )
-      asserts.fail(
-          'Target device is disconnected from AP. Check AP DHCP config.'
-      )
-
-    iperf_speed_min_mbps, nc_speed_min_mbps = self._get_throughput_benchmark(
-        sta_frequency, max_link_speed_mbps
-    )
-
-    if wifi_ssid and not self._is_valid_sta_frequency(wifi_ssid, sta_frequency):
-      self._active_nc_fail_reason = (
-          nc_constants.SingleTestFailureReason.WRONG_AP_FREQUENCY
-      )
-      asserts.fail(f'AP is set to a wrong frequency {sta_frequency}')
-
-    if (
-        self._current_test_result.quality_info.upgrade_medium
-        in [
-            nc_constants.NearbyConnectionMedium.WIFI_DIRECT,
-            nc_constants.NearbyConnectionMedium.WIFI_HOTSPOT,
-        ]
-    ):
-      p2p_frequency = setup_utils.get_wifi_p2p_frequency(self.advertiser)
-      self._current_test_result.quality_info.medium_frequency = p2p_frequency
-      if all([
-          p2p_frequency != nc_constants.INVALID_INT,
-          p2p_frequency != sta_frequency,
-          not self._is_mcc,
-          not self._is_dbs_mode,
-          nc_speed_min_mbps > 0,
-      ]):
-        self._active_nc_fail_reason = (
-            nc_constants.SingleTestFailureReason.WRONG_P2P_FREQUENCY
-        )
-        asserts.fail(
-            f'P2P frequeny ({p2p_frequency}) is different from STA frequency'
-            f' ({sta_frequency}) in SCC test case. Check the device capability'
-            ' configuration especially for DBS, DFS, indoor capabilities.'
-        )
-      if all([
-          p2p_frequency != nc_constants.INVALID_INT,
-          p2p_frequency == sta_frequency,
-          self._is_mcc,
-          nc_speed_min_mbps > 0,
-      ]):
-        self._active_nc_fail_reason = (
-            nc_constants.SingleTestFailureReason.WRONG_P2P_FREQUENCY
-        )
-        asserts.fail(
-            f'P2P frequeny ({p2p_frequency}) is same as STA frequency'
-            f' ({sta_frequency}) in MCC test case. Check the device capability'
-            ' configuration especially for DBS, DFS, indoor capabilities.'
-        )
-
-    if (
-        self._active_nc_fail_reason
-        is nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      iperf_speed_mbps = int(
-          self._current_test_result.iperf_throughput_kbps / 1024
-      )
-      nc_speed_mbps = round(
-          self._current_test_result.file_transfer_throughput_kbps / 1024, 2
-      )
-
-      if (nc_speed_mbps < nc_speed_min_mbps) or (
-          iperf_speed_mbps > 0 and iperf_speed_mbps < iperf_speed_min_mbps
-      ):
-        self._active_nc_fail_reason = (
-            nc_constants.SingleTestFailureReason.FILE_TRANSFER_THROUGHPUT_LOW
-        )
-        result_str = ''
-        if iperf_speed_mbps > 0 and iperf_speed_mbps < iperf_speed_min_mbps:
-          result_str = result_str + (
-              f'iperf speed {iperf_speed_mbps} < target {iperf_speed_min_mbps}'
-          )
-        if nc_speed_mbps < nc_speed_min_mbps:
-          result_str = result_str + (
-              f' file speed {nc_speed_mbps} < target {nc_speed_min_mbps}'
-          )
-        self._throughput_low_string = result_str + ' MB/s'
-        asserts.fail(self._throughput_low_string)
-
-  def _is_valid_sta_frequency(self, wifi_ssid: str, sta_frequency: int) -> bool:
-    if wifi_ssid == self.test_parameters.wifi_2g_ssid:
-      return sta_frequency <= _MAX_FREQ_2G_MHZ
-    elif wifi_ssid == self.test_parameters.wifi_5g_ssid:
-      return sta_frequency > _MAX_FREQ_2G_MHZ and (
-          sta_frequency < _MIN_FREQ_5G_DFS_MHZ
-          or sta_frequency > _MAX_FREQ_5G_DFS_MHZ
-      )
-    else:  # 5G DFS band
-      return (
-          sta_frequency >= _MIN_FREQ_5G_DFS_MHZ
-          and sta_frequency <= _MAX_FREQ_5G_DFS_MHZ
-      )
-
-  def _get_transfer_file_size(self) -> int:
-    return nc_constants.TRANSFER_FILE_SIZE_500MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_500M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _write_current_test_report(self) -> None:
-    """Writes test report for each iteration."""
-    self._current_test_result.test_iteration = self._finished_test_iteration
-    self._finished_test_iteration += 1
-    if (
-        self._use_prior_bt
-        and self._prior_bt_nc_fail_reason
-        is not nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      self._current_test_result.is_failed_with_prior_bt = True
-      self._current_test_result.failure_reason = self._prior_bt_nc_fail_reason
-    else:
-      self._current_test_result.failure_reason = self._active_nc_fail_reason
-    result_message = self._get_current_test_result_message()
-    self._current_test_result.result_message = result_message
-    self._test_results.append(self._current_test_result)
-
-    quality_info: list[Any] = []
-    if self._use_prior_bt:
-      quality_info.append(
-          'prior_bt:'
-          f'{self._current_test_result.prior_nc_quality_info.get_dict()}'
-      )
-    quality_info.append(
-        'file_transfer:'
-        f'{self._current_test_result.quality_info.get_dict()}'
-    )
-    quality_info.append(
-        'speed: '
-        f'{round(self._current_test_result.file_transfer_throughput_kbps/1024, 1)}'
-        'MBps'
-    )
-    if self._current_test_result.iperf_throughput_kbps > 0:
-      quality_info.append(
-          'iperf: '
-          f'{round(self._current_test_result.iperf_throughput_kbps/1024, 1)}'
-          'MBps'
-      )
-
-    if self._current_test_result.discoverer_sta_expected:
-      src_connection_latency = round(
-          self._current_test_result.discoverer_sta_latency.total_seconds()
-      )
-      quality_info.append(f'src_sta: {src_connection_latency}s')
-    if self._current_test_result.advertiser_wifi_expected:
-      tgt_connection_latency = round(
-          self._current_test_result.advertiser_sta_latency.total_seconds()
-      )
-      quality_info.append(f'tgt_sta: {tgt_connection_latency}s')
-
-    test_report = {
-        'result': result_message,
-        'quality_info': quality_info,
-    }
-
-    self.discoverer.log.info(test_report)
-    self.record_data({
-        'Test Class': self.TAG,
-        'Test Name': self.current_test_info.name,
-        'properties': test_report,
-    })
-
-  def _get_current_test_result_message(self) -> str:
-    if (
-        self._use_prior_bt
-        and self._prior_bt_nc_fail_reason
-        is not nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return ''.join([
-          'FAIL (The prior BT connection): ',
-          f'{self._prior_bt_nc_fail_reason.name} - ',
-          nc_constants.COMMON_TRIAGE_TIP.get(self._prior_bt_nc_fail_reason),
-      ])
-
-    if (
-        self._active_nc_fail_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return 'PASS'
-    if (
-        self._active_nc_fail_reason
-        == nc_constants.SingleTestFailureReason.SOURCE_WIFI_CONNECTION
-    ):
-      return ''.join([
-          f'FAIL: {self._active_nc_fail_reason.name} - ',
-          nc_constants.COMMON_TRIAGE_TIP.get(self._active_nc_fail_reason),
-      ])
-
-    if (
-        self._active_nc_fail_reason
-        is nc_constants.SingleTestFailureReason.WIFI_MEDIUM_UPGRADE
-    ):
-      return ''.join([
-          f'FAIL: {self._active_nc_fail_reason.name} - ',
-          self._get_medium_upgrade_failure_tip(),
-      ])
-    if (
-        self._active_nc_fail_reason
-        is nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-    ):
-      return ''.join([
-          f'{self._active_nc_fail_reason.name} - ',
-          self._get_file_transfer_failure_tip(),
-      ])
-    if (
-        self._active_nc_fail_reason
-        is nc_constants.SingleTestFailureReason.FILE_TRANSFER_THROUGHPUT_LOW
-    ):
-      return ''.join([
-          f'{self._active_nc_fail_reason.name} - ',
-          self._get_throughput_low_tip(),
-      ])
-
-    return ''.join([
-        f'{self._active_nc_fail_reason.name} - ',
-        nc_constants.COMMON_TRIAGE_TIP.get(
-            self._active_nc_fail_reason, 'UNKNOWN'
-        ),
-    ])
-
-  def _get_medium_upgrade_failure_tip(self) -> str:
-    return nc_constants.MEDIUM_UPGRADE_FAIL_TRIAGE_TIPS.get(
-        self._upgrade_medium_under_test,
-        f'unexpected upgrade medium - {self._upgrade_medium_under_test}',
-    )
-
-  @abc.abstractmethod
-  def _get_file_transfer_failure_tip(self) -> str:
-    pass
-
-  @abc.abstractmethod
-  def _get_throughput_low_tip(self) -> str:
-    pass
-
-  def _collect_current_test_metrics(self) -> None:
-    """Collects test result metrics for each iteration."""
-    if self._use_prior_bt:
-      self._performance_test_metrics.prior_bt_discovery_latencies.append(
-          self._current_test_result.prior_nc_quality_info.discovery_latency
-      )
-      self._performance_test_metrics.prior_bt_connection_latencies.append(
-          self._current_test_result.prior_nc_quality_info.connection_latency
-      )
-
-    self._performance_test_metrics.file_transfer_discovery_latencies.append(
-        self._current_test_result.quality_info.discovery_latency
-    )
-    self._performance_test_metrics.file_transfer_connection_latencies.append(
-        self._current_test_result.quality_info.connection_latency
-    )
-    self._performance_test_metrics.upgraded_wifi_transfer_mediums.append(
-        self._current_test_result.quality_info.upgrade_medium
-    )
-    self._performance_test_metrics.file_transfer_throughputs_kbps.append(
-        self._current_test_result.file_transfer_throughput_kbps
-    )
-    self._performance_test_metrics.iperf_throughputs_kbps.append(
-        self._current_test_result.iperf_throughput_kbps
-    )
-    self._performance_test_metrics.discoverer_wifi_sta_latencies.append(
-        self._current_test_result.discoverer_sta_latency
-    )
-    self._performance_test_metrics.advertiser_wifi_sta_latencies.append(
-        self._current_test_result.advertiser_sta_latency
-    )
-    if (
-        self._current_test_result.quality_info.medium_upgrade_expected
-    ):
-      self._performance_test_metrics.medium_upgrade_latencies.append(
-          self._current_test_result.quality_info.medium_upgrade_latency
-      )
-
-  def __convert_kbps_to_mbps(self, throughput_kbps: float) -> float:
-    """Convert throughput from kbyte/s to mbyte/s."""
-    return round(throughput_kbps / 1024, 1)
-
-  def __get_transfer_stats(
-      self,
-      throughput_indicators: list[float],
-  ) -> nc_constants.TestResultStats:
-    """get the min, median and max throughput from iterations which finished file transfer."""
-    filtered = [
-        x
-        for x in throughput_indicators
-        if x != nc_constants.UNSET_THROUGHPUT_KBPS
-    ]
-    if not filtered:
-      # all test cases are failed
-      return nc_constants.TestResultStats(0, 0, 0, 0)
-    # use the descenting order of the throughput
-    filtered.sort(reverse=True)
-    return nc_constants.TestResultStats(
-        len(filtered),
-        self.__convert_kbps_to_mbps(filtered[len(filtered) - 1]),
-        self.__convert_kbps_to_mbps(
-            filtered[int(len(filtered) * nc_constants.PERCENTILE_50_FACTOR)]
-        ),
-        self.__convert_kbps_to_mbps(filtered[0]),
-    )
-
-  def __get_latency_stats(
-      self, latency_indicators: list[datetime.timedelta]
-  ) -> nc_constants.TestResultStats:
-    filtered = [
-        latency.total_seconds()
-        for latency in latency_indicators
-        if latency != nc_constants.UNSET_LATENCY
-    ]
-    if not filtered:
-      # All test cases are failed.
-      return nc_constants.TestResultStats(0, 0, 0, 0)
-
-    filtered.sort()
-
-    percentile_50 = round(
-        filtered[int(len(filtered) * nc_constants.PERCENTILE_50_FACTOR)],
-        nc_constants.LATENCY_PRECISION_DIGITS,
-    )
-    return nc_constants.TestResultStats(
-        len(filtered),
-        round(filtered[0], nc_constants.LATENCY_PRECISION_DIGITS),
-        percentile_50,
-        round(
-            filtered[len(filtered) - 1], nc_constants.LATENCY_PRECISION_DIGITS
-        ),
-    )
-
-  # @typing.override
-  def _summary_test_results(self) -> None:
-    """Summarizes test results of all iterations."""
-    success_count = sum(
-        test_result.failure_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-        for test_result in self._test_results
-    )
-    passed = success_count >= round(
-        self.performance_test_iterations * nc_constants.SUCCESS_RATE_TARGET
-    )
-    final_result_message = (
-        'PASS'
-        if passed
-        else (
-            'FAIL: low successe rate: '
-            f' {success_count / self.performance_test_iterations:.2%} is lower'
-            f' than the target {nc_constants.SUCCESS_RATE_TARGET:.2%}'
-        )
-    )
-    detailed_stats = [
-        f'Required Iterations: {self.performance_test_iterations}',
-        f'Finished Iterations: {len(self._test_results)}',
-    ]
-    detailed_stats.append('Failed Iterations:')
-    detailed_stats.extend(self.__get_failed_iteration_messages())
-    detailed_stats.append('File Transfer Connection Stats:')
-    detailed_stats.extend(self.__get_file_transfer_connection_stats())
-
-    if self._use_prior_bt:
-      detailed_stats.append('Prior BT Connection Stats:')
-      detailed_stats.extend(self.__get_prior_bt_connection_stats())
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'properties': {
-            '01_test_result': final_result_message,
-            '02_source_device': '\n'.join(
-                self.__get_device_attributes(self.discoverer)
-            ),
-            '03_target_device': '\n'.join(
-                self.__get_device_attributes(self.advertiser)
-            ),
-            '04_test_config': '\n'.join([
-                f'Country Code: {self._get_country_code()}',
-                f'MCC mode: {self._is_mcc}',
-                f'2G medium {self._is_2g_d2d_wifi_medium}',
-                f'DBS mode: {self._is_dbs_mode}',
-                (
-                    'advertising_discovery_medium:'
-                    f' {self._advertising_discovery_medium.name}'
-                ),
-                f'connection_medium: {self._connection_medium.name}',
-                f'upgrade_medium: {self._upgrade_medium_under_test.name}',
-                f'wifi_ssid: {self._wifi_ssid}',
-                f'Start time: {self._start_time}',
-                f'End time: {datetime.datetime.now()}',
-            ]),
-            '05_detailed_stats': '\n'.join(detailed_stats),
-        },
-    })
-
-    asserts.assert_true(passed, final_result_message)
-
-  def __get_failed_iteration_messages(self) -> list[str]:
-    stats = []
-    for test_result in self._test_results:
-      if (
-          test_result.failure_reason
-          is not nc_constants.SingleTestFailureReason.SUCCESS
-      ):
-        stats.append(
-            f'- Iter: {test_result.test_iteration}: {test_result.start_time}'
-            f' {test_result.result_message}\n'
-            f' sta freq: {test_result.sta_frequency},'
-            f' sta max link speed: {test_result.max_sta_link_speed_mbps},'
-            f' used medium: {test_result.quality_info.get_medium_name()},'
-            f' medium freq: {test_result.quality_info.medium_frequency}.'
-        )
-
-    if stats:
-      return stats
-    else:
-      return ['  - NA']
-
-  def __get_prior_bt_connection_stats(self) -> list[str]:
-    if not self._use_prior_bt:
-      return []
-    discovery_latency_stats = self.__get_latency_stats(
-        self._performance_test_metrics.prior_bt_discovery_latencies
-    )
-    connection_latency_stats = self.__get_latency_stats(
-        self._performance_test_metrics.prior_bt_connection_latencies
-    )
-    return [
-        (
-            '  - Min / Median / Max Discovery Latency'
-            f' ({discovery_latency_stats.success_count} discovery):'
-            f' {discovery_latency_stats.min_val} /'
-            f' {discovery_latency_stats.median_val} /'
-            f' {discovery_latency_stats.max_val}s '
-        ),
-        (
-            '  - Min / Median / Max Connection Latency'
-            f' ({connection_latency_stats.success_count} connections):'
-            f' {connection_latency_stats.min_val} /'
-            f' {connection_latency_stats.median_val} /'
-            f' {connection_latency_stats.max_val}s '
-        ),
-    ]
-
-  def __get_file_transfer_connection_stats(self) -> list[str]:
-    discovery_latency_stats = self.__get_latency_stats(
-        self._performance_test_metrics.file_transfer_discovery_latencies
-    )
-    connection_latency_stats = self.__get_latency_stats(
-        self._performance_test_metrics.file_transfer_connection_latencies
-    )
-    transfer_stats = self.__get_transfer_stats(
-        self._performance_test_metrics.file_transfer_throughputs_kbps
-    )
-    iperf_stats = self.__get_transfer_stats(
-        self._performance_test_metrics.iperf_throughputs_kbps
-    )
-    stats = [
-        (
-            '  - Min / Median / Max Discovery Latency'
-            f' ({discovery_latency_stats.success_count} discovery):'
-            f' {discovery_latency_stats.min_val} /'
-            f' {discovery_latency_stats.median_val} /'
-            f' {discovery_latency_stats.max_val}s '
-        ),
-        (
-            '  - Min / Median / Max Connection Latency'
-            f' ({connection_latency_stats.success_count} connections):'
-            f' {connection_latency_stats.min_val} /'
-            f' {connection_latency_stats.median_val} /'
-            f' {connection_latency_stats.max_val}s '
-        ),
-        (
-            '  - Min / Median / Max Speed'
-            f' ({transfer_stats.success_count} transfer):'
-            f' {transfer_stats.min_val} / {transfer_stats.median_val} /'
-            f' {transfer_stats.max_val} MBps'
-        ),
-        (
-            '  - Min / Median / Max iperf Speed'
-            f' ({iperf_stats.success_count} transfer):'
-            f' {iperf_stats.min_val} / {iperf_stats.median_val} /'
-            f' {iperf_stats.max_val} MBps'
-        ),
-    ]
-    if nc_constants.is_high_quality_medium(self._upgrade_medium_under_test):
-      medium_upgrade_latency_stats = self.__get_latency_stats(
-          self._performance_test_metrics.medium_upgrade_latencies
-      )
-      stats.extend([
-          (
-              '  - Min / Median / Max Upgrade Latency '
-              f' ({medium_upgrade_latency_stats. success_count} upgrade):'
-              f' {medium_upgrade_latency_stats.min_val} /'
-              f' {medium_upgrade_latency_stats.median_val} /'
-              f' {medium_upgrade_latency_stats.max_val}s '
-          ),
-          '  - Upgrade Medium Stats:',
-      ])
-      stats.extend(self._summary_upgraded_wifi_transfer_mediums())
-
-    return stats
-
-  def _summary_upgraded_wifi_transfer_mediums(self) -> list[str]:
-    medium_counts = {}
-    for (
-        upgraded_medium
-    ) in self._performance_test_metrics.upgraded_wifi_transfer_mediums:
-      if upgraded_medium:
-        medium_counts[upgraded_medium.name] = (
-            medium_counts.get(upgraded_medium.name, 0) + 1
-        )
-    return [f'    - {name}: {count}' for name, count in medium_counts.items()]
-
-  def __get_device_attributes(
-      self, ad: android_device.AndroidDevice
-  ) -> list[str]:
-    return [
-        f'Device Serial: {ad.serial}',
-        f'Device Model: {ad.model}',
-        f'Build: {ad.build_info}',
-        f'Wifi chipset: {ad.wifi_chipset}',
-        f'Wifi FW: {ad.adb.getprop("vendor.wlan.firmware.version")}',
-        f'Supports 5G Wifi: {ad.supports_5g}',
-        f'Supports DBS: {ad.supports_dbs_sta_wfd}',
-        (
-            'Enable STA DFS channel for peer network:'
-            f' {ad.enable_sta_dfs_channel_for_peer_network}'
-        ),
-        (
-            'Enable STA Indoor channel for peer network:'
-            f' {ad.enable_sta_indoor_channel_for_peer_network}'
-        ),
-        f'Max num of streams: {ad.max_num_streams}',
-        f'Max num of streams (DBS): {ad.max_num_streams_dbs}',
-        f'Android Version: {ad.android_version}',
-        f'GMS_version: {setup_utils.dump_gms_version(ad)}',
-    ]
diff --git a/tests/bettertogether/betocq/directed_tests/ble_performance_test.py b/tests/bettertogether/betocq/directed_tests/ble_performance_test.py
deleted file mode 100644
index b802c6dde..000000000
--- a/tests/bettertogether/betocq/directed_tests/ble_performance_test.py
+++ /dev/null
@@ -1,98 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the BLE performance."""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class BlePerformanceTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for the BLE connection performance."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_ble_performance, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.BT_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.BT_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_ble_performance(self):
-    """Test the performance of the BLE."""
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.BLE_ONLY,
-        force_disable_bt_multiplex=True,
-        connection_medium=nc_constants.NearbyMedium.BLE_ONLY,
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    return nc_constants.TRANSFER_FILE_SIZE_500KB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.BLE_500K_PAYLOAD_TRANSFER_TIMEOUT
-
-  # @typing.override
-  def _get_throughput_benchmark(
-      self, sta_frequency: int, sta_max_link_speed_mbps: int
-  ) -> tuple[float, float]:
-    return (
-        nc_constants.BLE_MEDIUM_THROUGHPUT_BENCHMARK_MBPS,
-        nc_constants.BLE_MEDIUM_THROUGHPUT_BENCHMARK_MBPS,
-    )
-
-  def _get_medium_upgrade_failure_tip(self) -> str:
-    return 'Not Applied'  # No medium upgrade required for BLE.
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The BLE connection might be broken, check the related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. Check with the chip vendor if there is'
-        ' any BT firmware issue.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    # don't require wifi STA.
-    return True
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/bt_performance_test.py b/tests/bettertogether/betocq/directed_tests/bt_performance_test.py
deleted file mode 100644
index 9b1a833da..000000000
--- a/tests/bettertogether/betocq/directed_tests/bt_performance_test.py
+++ /dev/null
@@ -1,97 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the classic Bluetooth performance."""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class BtPerformanceTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for the classic Bluetooth connection performance."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_classic_bt_performance, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.BT_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.BT_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_classic_bt_performance(self):
-    """Test the performance of the classic BT connetion."""
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.BT_ONLY,
-        force_disable_bt_multiplex=True
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    return nc_constants.TRANSFER_FILE_SIZE_500KB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.BT_500K_PAYLOAD_TRANSFER_TIMEOUT
-
-  # @typing.override
-  def _get_throughput_benchmark(
-      self, sta_frequency: int, sta_max_link_speed_mbps: int
-  ) -> tuple[float, float]:
-    return (
-        nc_constants.CLASSIC_BT_MEDIUM_THROUGHPUT_BENCHMARK_MBPS,
-        nc_constants.CLASSIC_BT_MEDIUM_THROUGHPUT_BENCHMARK_MBPS,
-    )
-
-  def _get_medium_upgrade_failure_tip(self) -> str:
-    return 'Not Applied'  # No medium upgrade required for BT.
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The classic Bluetooth connection might be broken, check related log, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. Check with the chip vendor if there is'
-        ' any BT firmware issue.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    # don't require wifi STA.
-    return True
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/mcc_2g_wfd_indoor_5g_sta_test.py b/tests/bettertogether/betocq/directed_tests/mcc_2g_wfd_indoor_5g_sta_test.py
deleted file mode 100644
index b61037685..000000000
--- a/tests/bettertogether/betocq/directed_tests/mcc_2g_wfd_indoor_5g_sta_test.py
+++ /dev/null
@@ -1,116 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC with the indoor channels case.
-
-This is about the feature - using indoor channels for WFD, for details, refer to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-and config_wifiEnableStaIndoorChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1147
-In this case, the feature is disable for the device; The WFD will be started on
-a 2G channel, but the STA is using the 5G channel.
-
-The device requirements:
-  support 5G: true
-  using indoor channels for peer network: false
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Mcc2gWfdIndoor5gStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for wifi MCC with 2G WFD and indoor 5G STA."""
-
-  def _get_country_code(self) -> str:
-    return 'JP'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self._is_2g_d2d_wifi_medium = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_2g_wfd_indoor_5g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_2g_wfd_indoor_5g_sta(self):
-    """Test the performance for wifi MCC with 2G WFD and indoor 5G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    # For 2G wifi medium
-    return nc_constants.TRANSFER_FILE_SIZE_20MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a MCC test case where WFD uses'
-        ' a 2G channel and the STA uses a 5G indoor channel. Check with the'
-        ' wifi chip vendor about the possible firmware Tx/Rx issues in MCC'
-        ' mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_indoor_channel_for_peer_network': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/mcc_5g_hotspot_dfs_5g_sta_test.py b/tests/bettertogether/betocq/directed_tests/mcc_5g_hotspot_dfs_5g_sta_test.py
deleted file mode 100644
index c0f9b0e5c..000000000
--- a/tests/bettertogether/betocq/directed_tests/mcc_5g_hotspot_dfs_5g_sta_test.py
+++ /dev/null
@@ -1,110 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC with the DFS channels case.
-
-This is about the feature - using DFS channels for Hotspot, for details, refer
-to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-andconfig_wifiEnableStaDfsChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1151
-In this case, the feature is disable for the device; The WLAN is using the DFS
-5G channel, but the hotspot will be started on another non DFS 5G channel.
-
-The device requirements:
-  support 5G: true
-  using DFS channels for peer network (target device): false
-The AP requirements:
-  wifi channel: 52 (5260)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Mcc5gHotspotDfs5gStaTest(
-    d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for MCC with 5G HOTSPOT and DFS 5G STA."""
-
-  def _get_country_code(self) -> str:
-    return 'GB'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_5g_hotspot_dfs_5g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.MCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_5g_hotspot_dfs_5g_sta(self):
-    """Test the performance for wifi MCC with 5G HOTSPOT and DFS 5G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIHOTSPOT,
-        wifi_ssid=self.test_parameters.wifi_dfs_5g_ssid,
-        wifi_password=self.test_parameters.wifi_dfs_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The hotspot connection might be broken, check the related log, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a MCC test case where hotspot'
-        ' uses a 5G non-DFS channel and STA uses a5G DFS channel. Note that in'
-        ' hotspot mode, the target acts as a WFD GOwhile the source device'
-        ' acts as the legcy STA. Check with the wifi chip vendorabout the'
-        ' possible firmware Tx/Rx issues in MCC mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_dfs_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_dfs_channel_for_peer_network': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_dfs_5g_sta_test.py b/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_dfs_5g_sta_test.py
deleted file mode 100644
index 5f8d6de39..000000000
--- a/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_dfs_5g_sta_test.py
+++ /dev/null
@@ -1,106 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC with the DFS channels case.
-
-This is about the feature - using DFS channels for WFD, for details, refer to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-and config_wifiEnableStaDfsChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1151
-In this case, the feature is disable for the device; The STA is using the DFS 5G
-channel, but the WFD will be started on another 5G channel.
-
-The device requirements:
-  support 5G: true
-  using DFS channels for peer network: false
-The AP requirements:
-  wifi channel: 52 (5260)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Mcc5gWfdDfs5gStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for MCC with 5G WFD and DFS 5G STA."""
-
-  def _get_country_code(self) -> str:
-    return 'GB'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_5g_wfd_dfs_5g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.MCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_5g_wfd_dfs_5g_sta(self):
-    """Test the performance for wifi MCC with 5G WFD and DFS 5G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_dfs_5g_ssid,
-        wifi_password=self.test_parameters.wifi_dfs_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check the related log, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a MCC test case where WFD uses'
-        ' a 5G non-DFS channel and STA uses a5G DFS channel. Check with the'
-        ' wifi chip vendorabout the possible firmware Tx/Rx issues in MCC mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_dfs_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_dfs_channel_for_peer_network': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_non_dbs_2g_sta_test.py b/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_non_dbs_2g_sta_test.py
deleted file mode 100644
index 9f2908a95..000000000
--- a/tests/bettertogether/betocq/directed_tests/mcc_5g_wfd_non_dbs_2g_sta_test.py
+++ /dev/null
@@ -1,106 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC in a general case.
-
-In this case, the WFD is using the 5G channel, but STA is connected to 2G
-channel, as the device(don't support DBS) can not handle the 5G and 2G at
-the same time, there is concurrent contention for the 5G channel and 2G
-channel handling in firmware, the firmware needs to switch 5G and 2G from time
-to time.
-
-The device requirements:
-  support 5G: true
-  support DBS(Target Device): False
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Mcc5gWfdNonDbs2gStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for MCC case with 5G WFD and 2G STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_5g_wfd_non_dbs_2g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.MCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_5g_wfd_non_dbs_2g_sta(self):
-    """Test the performance for wifi MCC with 5G WFD and 2G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}.'
-        ' This is a MCC test case where WFD uses a 5G channel and STA uses a'
-        ' 2G channel. Check with the wifi chip vendor'
-        ' about the possible firmware Tx/Rx issues in MCC mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'supports_dbs_sta_wfd': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/mcc_aware_2g_5g_sta_test.py b/tests/bettertogether/betocq/directed_tests/mcc_aware_2g_5g_sta_test.py
deleted file mode 100644
index 4668952eb..000000000
--- a/tests/bettertogether/betocq/directed_tests/mcc_aware_2g_5g_sta_test.py
+++ /dev/null
@@ -1,108 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This test is to test the Aware MCC when STAs are connected to 2G/5G.
-
-The device requirements:
-  support 5G: true
-The AP requirements:
-  wifi channel: 36 (5180) and 6 (2437) in the same subnet
-"""
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class MccAware2g5gStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Aware MCC with the STA connected to 2G/5G channels."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_mcc = True
-    self.performance_test_iterations = getattr(
-        self.test_mcc_aware_2g_5g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.MCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_mcc_aware_2g_5g_sta(self):
-    """Test the performance for Aware MCC."""
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.WIFIAWARE_ONLY,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-        force_disable_bt_multiplex=True,
-        connection_medium=nc_constants.NearbyMedium(
-            self.test_parameters.connection_medium
-        ),
-        wifi_ssid2=self.test_parameters.wifi_2g_ssid,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Aware connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a MCC 5G test case with Aware'
-        ' and STA operating at different 5G channels. Check with the wifi chip'
-        ' vendor about the possible firmware Tx/Rx issues in this mode.'
-        ' Also check if the AP channel is set correctly and is supported by the'
-        ' used wifi medium.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return (
-        True
-        if self.test_parameters.wifi_5g_ssid
-        and self.test_parameters.wifi_2g_ssid
-        else False
-    )
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_2g_wfd_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_2g_wfd_sta_test.py
deleted file mode 100644
index d0839db8e..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_2g_wfd_sta_test.py
+++ /dev/null
@@ -1,94 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC in a general case.
-
-In this case, both the WFD and WLAN are using the smae 2G channel
-Note that The country code is set to JP so that 5G is not available for
-any D2D mediums.
-
-The device requirements: N/A.
-"""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc2gWfdStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with 2G WFD and STA."""
-
-  def _get_country_code(self) -> str:
-    return 'JP'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_2g_d2d_wifi_medium = True
-    self.performance_test_iterations = getattr(
-        self.test_scc_2g_wfd_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_2g_wfd_sta(self):
-    """Test the performance for Wifi SCC with 2G WFD and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    # For 2G wifi medium
-    return nc_constants.TRANSFER_FILE_SIZE_20MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}.'
-        ' This is a SCC 2G test case with WFD medium. Check with the wifi chip'
-        ' vendor about the possible firmware Tx/Rx issues in this mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_2g_wlan_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_2g_wlan_sta_test.py
deleted file mode 100644
index 98612a4da..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_2g_wlan_sta_test.py
+++ /dev/null
@@ -1,111 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi LAN 2G SCC in a general case.
-
-In this case, both the Wifi LAN and STA(internet AP) are using the 2G channel,
-the Wifi LAN and STA should use the same channel.
-Wifi LAN - The target device starts WFD GO as the role of AP, the source device
-is connected to the AP.
-
-The device requirements:
-  support 5G: false
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import datetime
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc2gWlanStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with 2G WifiLAN and STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_2g_d2d_wifi_medium = True
-    self.performance_test_iterations = getattr(
-        self.test_scc_2g_wifilan_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_2g_wifilan_sta(self):
-    """Test the performance for Wifi SCC with 2G WifiLAN and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.WIFILAN_ONLY,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_transfer_file_size(self) -> int:
-    # For 2G wifi medium
-    return nc_constants.TRANSFER_FILE_SIZE_20MB
-
-  def _get_file_transfer_timeout(self) -> datetime.timedelta:
-    return nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The WLAN connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}.'
-        ' This is a SCC 2G test case with WLAN medium. Check with the wifi chip'
-        ' vendor if TDLS is supported correctly. Also check if'
-        ' the AP has the firewall which could block the mDNS traffic.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': False,
-        },
-        'advertiser': {
-            'supports_5g': False,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_5g_aware_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_5g_aware_sta_test.py
deleted file mode 100644
index ab75ea572..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_5g_aware_sta_test.py
+++ /dev/null
@@ -1,104 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This test is to test the Wifi SCC in a general case.
-
-In this case, both the Aware and WLAN are using the same 5G channel.
-
-The device requirements:
-  support 5G: true
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gAwareStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with 5G Aware and STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_aware_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_aware_sta(self):
-    """Test the performance for Wifi SCC with 5G Aware and STA."""
-    self._test_connection_medium_performance(
-        upgrade_medium_under_test=nc_constants.NearbyMedium.WIFIAWARE_ONLY,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-        force_disable_bt_multiplex=True,
-        connection_medium=nc_constants.NearbyMedium(
-            self.test_parameters.connection_medium
-        ),
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Aware connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a SCC 5G test case with Aware'
-        ' and STA operating at the same 5G channel. Check STA and Aware'
-        ' frequencies in the target logs and ensure they'
-        ' have the same value. Check with the wifi chip vendor about the'
-        ' possible firmware Tx/Rx issues in this mode. Also check if the AP'
-        ' channel is set correctly and is supported by the used wifi medium.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_dbs_2g_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_dbs_2g_sta_test.py
deleted file mode 100644
index a5cf61c11..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_dbs_2g_sta_test.py
+++ /dev/null
@@ -1,105 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi MCC in a general case.
-
-In this case, even though the STA is connected to a 2G channel, and the WFD is
-using the 5G channel, as both devices support DBS, which can handle the 5G and
-2G at the same time, this is still a SCC case.
-
-The device requirements:
-  support 5G: true
-  support DBS(target): true
-The AP requirements:
-  wifi channel: 6 (2437)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gWfdDbs2gStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for SCC with 5G WFD and 2G STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self._is_dbs_mode = True
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_wfd_dbs_2g_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_wfd_dbs_2g_sta(self):
-    """Test the performance for wifi SCC with 5G WFD and 2G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_2g_ssid,
-        wifi_password=self.test_parameters.wifi_2g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a SCC 5G test case with WFD'
-        ' medium operating at 5G and STA operating at 2G. In the configuration'
-        ' file, DBS support is set to true. Check if the device does support'
-        ' DBS with STA + WFD concurrency. Check with the wifi chipvendor about'
-        ' the possible firmware Tx/Rx issues in this mode.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_2g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'supports_dbs_sta_wfd': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_sta_test.py
deleted file mode 100644
index f10099299..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_5g_wfd_sta_test.py
+++ /dev/null
@@ -1,92 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC in a general case.
-
-In this case, both the WFD and WLAN are using the 5G channel, the WFD and WLAN
-should use the same channel.
-
-The device requirements:
-  support 5G: true
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gWfdStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with 5G WFD and STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_wfd_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_wfd_sta(self):
-    """Test the performance for Wifi SCC with 5G WFD and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is a SCC 5G test case with WFD'
-        ' and STA operating at the same 5G channel.Check with the wifi chip'
-        ' vendor about the possible firmware Tx/Rx issues inthis mode. Also'
-        ' check if the AP channel is set correctly and is supported bythe used'
-        ' wifi medium.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  def _are_devices_capabilities_ok(self) -> bool:
-    return self.discoverer.supports_5g and self.advertiser.supports_5g
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_5g_wlan_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_5g_wlan_sta_test.py
deleted file mode 100644
index 78c9474d1..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_5g_wlan_sta_test.py
+++ /dev/null
@@ -1,91 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC of LAN in a general case.
-
-In this case, both the D2D_LAN and WLAN are using the 5G channel, the D2d_LAN
-and WLAN should use the same channel.
-
-The device requirements:
-  support 5G: true
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class Scc5gWifiLanStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with 5G WifiLAN and STA."""
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_5g_wifilan_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_5g_wifilan_sta(self):
-    """Test the performance for Wifi SCC with 5G WifiLAN and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.WIFILAN_ONLY,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The WLAN connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is 5G WLAN test case. Check with'
-        ' the wifi chip vendor if TDLS is supported correctly. Also check if'
-        ' the AP has the firewall which could block the mDNS traffic.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  def _are_devices_capabilities_ok(self) -> bool:
-    return self.discoverer.supports_5g and self.advertiser.supports_5g
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_hotspot_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_hotspot_sta_test.py
deleted file mode 100644
index db6a0be89..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_hotspot_sta_test.py
+++ /dev/null
@@ -1,111 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC with the DFS channels case.
-
-This is about the feature - using DFS channels for Hotspot, for details, refer
-to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-and config_wifiEnableStaDfsChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1151
-In this case, the feature is enabled for the target device.
-
-The device requirements:
-  support 5G: true
-  using DFS channels for peer network(target device): true
-The AP requirements:
-  wifi channel: 52 (5260)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class SccDfs5gHotspotStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for SCC with Hotspot on a 5G DFS channel."""
-
-  def _get_country_code(self) -> str:
-    return 'GB'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_dfs_5g_hotspot_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_dfs_5g_hotspot_sta(self):
-    """Test the performance for wifi SCC with DFS 5G Hotspot and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIHOTSPOT,
-        wifi_ssid=self.test_parameters.wifi_dfs_5g_ssid,
-        wifi_password=self.test_parameters.wifi_dfs_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Hotspot connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is 5G SCC DFS hotspot test case.'
-        ' Check STA and WFD GO frequencies in the target logs (dumpsys'
-        ' wifip2p) and ensure they have the same value. In the configuration'
-        ' file, enable_sta_dfs_channel_for_peer_network is set to true. Check'
-        ' if the target device does support WFD group owner in the'
-        ' STA-associated DFS channel. Check if'
-        ' config_wifiEnableStaDfsChannelForPeerNetwork'
-        ' https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml'
-        ' is set to true and has the correct driver/FW implementation.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_dfs_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_dfs_channel_for_peer_network': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_wfd_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_wfd_sta_test.py
deleted file mode 100644
index 760abdc75..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_dfs_5g_wfd_sta_test.py
+++ /dev/null
@@ -1,111 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC with the DFS channels case.
-
-This is about the feature - using DFS channels for WFD, for details, refer to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-and config_wifiEnableStaDfsChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1151
-In this case, the feature is enabled for the target device.
-
-The device requirements:
-  support 5G: true
-  using DFS channels for peer network: true
-The AP requirements:
-  wifi channel: 52 (5260)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class SccDfs5gWfdStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """Test class for Wifi SCC with the DFS 5G channels case."""
-
-  def _get_country_code(self) -> str:
-    return 'GB'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_dfs_5g_wfd_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_dfs_5g_wfd_sta(self):
-    """Test the performance for Wifi SCC with DFS 5G WFD and STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_dfs_5g_ssid,
-        wifi_password=self.test_parameters.wifi_dfs_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is 5G SCC DFS WFD test case.'
-        ' Check STA and WFD GO frequencies in the target logs (dumpsys wifip2p)'
-        ' and ensure they have the same value. In the configuration file,'
-        ' enable_sta_dfs_channel_for_peer_network is set to true on both'
-        ' source  and target sides. Check if both device do support WFD group'
-        ' owner in the STA-associated DFS channel. Check if'
-        ' config_wifiEnableStaDfsChannelForPeerNetwork'
-        ' https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml'
-        ' is set to true and has the correct driver/FW implementation.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_dfs_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-            'enable_sta_dfs_channel_for_peer_network': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_dfs_channel_for_peer_network': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/directed_tests/scc_indoor_5g_wfd_sta_test.py b/tests/bettertogether/betocq/directed_tests/scc_indoor_5g_wfd_sta_test.py
deleted file mode 100644
index 9279b70a4..000000000
--- a/tests/bettertogether/betocq/directed_tests/scc_indoor_5g_wfd_sta_test.py
+++ /dev/null
@@ -1,111 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""This Test is to test the Wifi SCC with the indoor channels case.
-
-This is about the feature - using indoor channels for WFD, for details, refer to
-https://docs.google.com/presentation/d/18Fl0fY4piq_sfXfo3rCr2Ca55AJHEOvB7rC-rV3SQ9E/edit?usp=sharing
-and config_wifiEnableStaIndoorChannelForPeerNetwork -
-https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml;l=1147
-In this case, the feature is enabled on both devices; the WFD and STA both are
-operating on the same 5G indoor channel.
-
-The device requirements:
-  support 5G: true
-  using indoor channels for WFD: true
-The AP requirements:
-  wifi channel: 36 (5180)
-"""
-
-import logging
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly  import base_test
-from mobly import test_runner
-
-from betocq import d2d_performance_test_base
-from betocq import nc_constants
-
-
-class SccIndoor5gWfdStaTest(d2d_performance_test_base.D2dPerformanceTestBase):
-  """This class is to test the Wifi SCC with the indoor channel case."""
-
-  def _get_country_code(self) -> str:
-    return 'JP'
-
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_scc_indoor_5g_wfd_sta, base_test.ATTR_REPEAT_CNT
-    )
-    logging.info(
-        'performance test iterations: %s', self.performance_test_iterations
-    )
-
-  @base_test.repeat(
-      count=nc_constants.SCC_PERFORMANCE_TEST_COUNT,
-      max_consecutive_error=nc_constants.SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR,
-  )
-  def test_scc_indoor_5g_wfd_sta(self):
-    """Test the performance for Wifi SCC with 5G indoor WFD and 5G STA."""
-    self._test_connection_medium_performance(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-        wifi_ssid=self.test_parameters.wifi_5g_ssid,
-        wifi_password=self.test_parameters.wifi_5g_password,
-    )
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    return (
-        'The Wifi Direct connection might be broken, check related logs, '
-        f'{self._get_throughput_low_tip()}'
-    )
-
-  def _get_throughput_low_tip(self) -> str:
-    return (
-        f'{self._throughput_low_string}. This is 5G SCC indoor WFD test case.'
-        ' Check STA and WFD GO frequencies in the target logs (dumpsys'
-        ' wifip2p) and ensure they have the same value. In the configuration'
-        ' file, enable_sta_indoor_channel_for_peer_network is set to true.'
-        ' Check if the target device does support WFD group owner in the'
-        ' STA-associated indoor channel. Check if'
-        ' config_wifiEnableStaIndoorChannelForPeerNetwork'
-        ' https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Wifi/service/ServiceWifiResources/res/values/config.xml'
-        ' is set to true and has the correct driver/FW implementation.'
-    )
-
-  def _is_wifi_ap_ready(self) -> bool:
-    return True if self.test_parameters.wifi_5g_ssid else False
-
-  @property
-  def _devices_capabilities_definition(self) -> dict[str, dict[str, bool]]:
-    return {
-        'discoverer': {
-            'supports_5g': True,
-        },
-        'advertiser': {
-            'supports_5g': True,
-            'enable_sta_indoor_channel_for_peer_network': True,
-        },
-    }
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/function_tests/beto_cq_function_group_test.py b/tests/bettertogether/betocq/function_tests/beto_cq_function_group_test.py
deleted file mode 100644
index 7dbda0f80..000000000
--- a/tests/bettertogether/betocq/function_tests/beto_cq_function_group_test.py
+++ /dev/null
@@ -1,139 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Group all function tests."""
-
-import os
-import sys
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_betocq_dir = os.path.dirname(os.path.dirname(__file__))
-if _betocq_dir not in sys.path:
-  sys.path.append(_betocq_dir)
-
-from mobly import test_runner
-
-from betocq import nc_base_test
-from betocq import nc_constants
-from betocq import setup_utils
-from betocq import version
-from betocq.function_tests import bt_ble_function_test_actor
-from betocq.function_tests import bt_multiplex_function_test_actor
-from betocq.function_tests import fixed_wifi_medium_function_test_actor
-from betocq.function_tests import function_test_actor_base
-
-
-class BetoCqFunctionGroupTest(nc_base_test.NCBaseTestClass):
-  """The test class to group all function tests in one mobly test."""
-
-  def __init__(self, configs):
-    super().__init__(configs)
-
-    self._test_result_messages: dict[str, str] = {}
-
-  def test_bt_ble_function(self):
-    """Test the NC with the BT/BLE medium only."""
-    self._current_test_actor = self.bt_ble_test_actor
-    self.bt_ble_test_actor.test_bt_ble_connection()
-
-  def test_wifilan_function(self):
-    """Test the NC with upgrading to the Wifi LAN medium.
-
-    step 1: connect to wifi
-    step 2: set up a nearby connection with the WifiLAN medium and transfer a
-    small file.
-    """
-    self._current_test_actor = self.fixed_wifi_medium_test_actor
-    self.fixed_wifi_medium_test_actor.connect_to_wifi()
-    self.fixed_wifi_medium_test_actor.run_fixed_wifi_medium_test(
-        nc_constants.NearbyMedium.WIFILAN_ONLY)
-
-  def test_d2d_hotspot_function(self):
-    """Test the NC with upgrading to the HOTSPOT as connection medium.
-    """
-    self._current_test_actor = self.fixed_wifi_medium_test_actor
-    self.fixed_wifi_medium_test_actor.run_fixed_wifi_medium_test(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIHOTSPOT)
-
-  def test_wifi_direct_function(self):
-    """Test the NC with upgrading to the WiFi Direct as connection medium.
-    """
-    self._current_test_actor = self.fixed_wifi_medium_test_actor
-    self.fixed_wifi_medium_test_actor.run_fixed_wifi_medium_test(
-        nc_constants.NearbyMedium.UPGRADE_TO_WIFIDIRECT)
-
-  def test_bt_multiplex_connections(self):
-    """Test the BT multiplex function of nearby connection.
-
-    set up 2 Bluetooth connections with NearbyConnection APIs.
-    """
-    self._current_test_actor = self.bt_multiplex_test_actor
-    self.bt_multiplex_test_actor.test_bt_multiplex_connections()
-
-  def setup_class(self):
-    super().setup_class()
-
-    self.bt_ble_test_actor = bt_ble_function_test_actor.BtBleFunctionTestActor(
-        self.test_parameters, self.discoverer, self.advertiser
-    )
-    self.fixed_wifi_medium_test_actor = (
-        fixed_wifi_medium_function_test_actor.FixedWifiMediumFunctionTestActor(
-            self.test_parameters, self.discoverer, self.advertiser
-        )
-    )
-    self.bt_multiplex_test_actor = (
-        bt_multiplex_function_test_actor.BtMultiplexFunctionTestActor(
-            self.test_parameters, self.discoverer, self.advertiser
-        )
-    )
-    self._current_test_actor: function_test_actor_base.FunctionTestActorBase = (
-        None
-    )
-
-  def teardown_test(self) -> None:
-    self._test_result_messages[self.current_test_info.name] = (
-        self._current_test_actor.get_test_result_message()
-    )
-    self.record_data({
-        'Test Name': self.current_test_info.name,
-        'properties': {
-            'result': self._current_test_actor.get_test_result_message(),
-        },
-    })
-    super().teardown_test()
-
-  # @typing.override
-  def _summary_test_results(self):
-    """Summarizes test results of all function tests."""
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'properties': {
-            '00_test_script_verion': version.TEST_SCRIPT_VERSION,
-            '01_source_device_serial': self.discoverer.serial,
-            '02_target_device_serial': self.advertiser.serial,
-            '03_source_GMS_version': setup_utils.dump_gms_version(
-                self.discoverer
-            ),
-            '04_target_GMS_version': setup_utils.dump_gms_version(
-                self.advertiser
-            ),
-            '05_test_result': self._test_result_messages,
-        },
-    })
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/betocq/function_tests/bt_ble_function_test_actor.py b/tests/bettertogether/betocq/function_tests/bt_ble_function_test_actor.py
deleted file mode 100644
index 3af658df7..000000000
--- a/tests/bettertogether/betocq/function_tests/bt_ble_function_test_actor.py
+++ /dev/null
@@ -1,88 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Bluetooth nearby connection functional test actor."""
-
-from betocq import nc_constants
-from betocq import nearby_connection_wrapper
-from betocq.function_tests import function_test_actor_base
-
-
-class BtBleFunctionTestActor(function_test_actor_base.FunctionTestActorBase):
-  """The actor for running the BT/BlE function test."""
-
-  def test_bt_ble_connection(self):
-    """Test the basic BT and BLE connection.
-
-    Use BLE as discovery/advertising medium
-    Use BT as connection and upgrade medium
-    """
-
-    # 1. set up BT connection
-    advertising_discovery_medium = nc_constants.NearbyMedium.BLE_ONLY
-
-    nearby_snippet = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-    )
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-    try:
-      nearby_snippet.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-      self._test_result.quality_info = (
-          nearby_snippet.connection_quality_info
-      )
-
-    # 2. transfer file through bluetooth
-    try:
-      self._test_result.file_transfer_throughput_kbps = (
-          nearby_snippet.transfer_file(
-              nc_constants.TRANSFER_FILE_SIZE_1KB,
-              nc_constants.BT_1K_PAYLOAD_TRANSFER_TIMEOUT,
-              nc_constants.PayloadType.FILE,
-          )
-      )
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-
-    # 3. disconnect
-    nearby_snippet.disconnect_endpoint()
-
-  def get_test_result_message(self) -> str:
-    """Gets the test result of current test."""
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return 'PASS'
-    if (
-        self._test_failure_reason
-        is nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-    ):
-      return 'The Bluetooth performance is really bad or unknown reason.'
-    return ''.join([
-        f'FAIL: due to {self._test_failure_reason.name} - ',
-        f'{nc_constants.COMMON_TRIAGE_TIP.get(self._test_failure_reason)}'
-        ])
diff --git a/tests/bettertogether/betocq/function_tests/bt_multiplex_function_test_actor.py b/tests/bettertogether/betocq/function_tests/bt_multiplex_function_test_actor.py
deleted file mode 100644
index f72c54fd4..000000000
--- a/tests/bettertogether/betocq/function_tests/bt_multiplex_function_test_actor.py
+++ /dev/null
@@ -1,133 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Bluetooth nearby connection functional test actor."""
-
-from mobly import asserts
-
-from betocq import nc_constants
-from betocq import nearby_connection_wrapper
-from betocq.function_tests import function_test_actor_base
-
-
-class BtMultiplexFunctionTestActor(
-    function_test_actor_base.FunctionTestActorBase):
-  """The actor for running BT/BlE multiplex function test.
-
-  It allows to setup multiple BT connections.
-  """
-
-  def test_bt_multiplex_connections(self):
-    """Test the capability of setting up two BT connections (multiplex).
-
-    This is only required for specific CUJ: quick start
-    step 1: set up 2 BT connections
-    step 2: transfer a small file with the 2nd BT connection
-    """
-    if (
-        self.test_parameters.target_cuj_name
-        != nc_constants.TARGET_CUJ_QUICK_START
-        and not self.test_parameters.requires_bt_multiplex
-    ):
-      self._skipped = True
-      asserts.skip(
-          'BT multiplex is not required for this CUJ -'
-          f' {self.test_parameters.target_cuj_name}'
-      )
-
-    # 1. set up 1st BT connection
-    advertising_discovery_medium = nc_constants.NearbyMedium.BLE_ONLY
-    nearby_snippet_2 = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby2,
-        self.discoverer.nearby2,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-    )
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-
-    try:
-      nearby_snippet_2.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_failure_reason = nearby_snippet_2.test_failure_reason
-      self._test_result.quality_info = (
-          nearby_snippet_2.connection_quality_info
-      )
-    # 2nd bt connection
-    nearby_snippet = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-    )
-
-    second_connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.SECOND_DISCOVERY_TIMEOUT,
-        nc_constants.SECOND_CONNECTION_INIT_TIMEOUT,
-        nc_constants.SECOND_CONNECTION_RESULT_TIMEOUT)
-    try:
-      nearby_snippet.start_nearby_connection(
-          timeouts=second_connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-      self._test_result.prior_nc_quality_info = (
-          nearby_snippet.connection_quality_info
-      )
-
-    # 2. transfer file through bluetooth
-    try:
-      self._test_result.file_transfer_throughput_kbps = (
-          nearby_snippet.transfer_file(
-              nc_constants.TRANSFER_FILE_SIZE_1KB,
-              nc_constants.BT_1K_PAYLOAD_TRANSFER_TIMEOUT,
-              nc_constants.PayloadType.FILE))
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-
-    # 3. disconnect
-    nearby_snippet_2.disconnect_endpoint()
-    nearby_snippet.disconnect_endpoint()
-
-  def get_test_result_message(self) -> str:
-    if self._skipped:
-      return (
-          'SKIPPED - not required for the target CUJ: '
-          f'{self.test_parameters.target_cuj_name}'
-      )
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return 'PASS'
-    if (
-        self._test_failure_reason
-        is nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-    ):
-      return 'The Bluetooth performance is really bad.'
-    else:
-      return ''.join([
-          f'FAIL: due to {self._test_failure_reason.name} - ',
-          f'{nc_constants.COMMON_TRIAGE_TIP.get(self._test_failure_reason)}'
-          ])
diff --git a/tests/bettertogether/betocq/function_tests/fixed_wifi_medium_function_test_actor.py b/tests/bettertogether/betocq/function_tests/fixed_wifi_medium_function_test_actor.py
deleted file mode 100644
index 5a8c2c441..000000000
--- a/tests/bettertogether/betocq/function_tests/fixed_wifi_medium_function_test_actor.py
+++ /dev/null
@@ -1,152 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Base class for all fixed wifi medium function test actors."""
-import logging
-from mobly import asserts
-
-from betocq import nc_constants
-from betocq import nearby_connection_wrapper
-from betocq import setup_utils
-from betocq.function_tests import function_test_actor_base
-
-
-class FixedWifiMediumFunctionTestActor(
-    function_test_actor_base.FunctionTestActorBase):
-  """The base of actors for running the specified fixed wifi D2D medium."""
-
-  def run_fixed_wifi_medium_test(
-      self, wifi_medium: nc_constants.NearbyMedium) -> None:
-    """upgrade the medium from BT to the specified medium and transfer a sample data."""
-    self._wifi_medium_under_test = wifi_medium
-    self._test_result = nc_constants.SingleTestResult()
-
-    # 1. set up BT and WiFi connection
-    advertising_discovery_medium = nc_constants.NearbyMedium(
-        self.test_parameters.advertising_discovery_medium
-    )
-    nearby_snippet = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=self._wifi_medium_under_test,
-    )
-
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-
-    try:
-      nearby_snippet.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-      self._test_result.quality_info = (
-          nearby_snippet.connection_quality_info
-      )
-
-    # 2. transfer file through WiFi
-    try:
-      self._test_result.file_transfer_throughput_kbps = (
-          nearby_snippet.transfer_file(
-              nc_constants.TRANSFER_FILE_SIZE_1KB,
-              nc_constants.WIFI_1K_PAYLOAD_TRANSFER_TIMEOUT,
-              nc_constants.PayloadType.FILE))
-    finally:
-      self._test_failure_reason = nearby_snippet.test_failure_reason
-
-    # 3. disconnect
-    nearby_snippet.disconnect_endpoint()
-
-  def connect_to_wifi(self):
-    if self.test_parameters.toggle_airplane_mode_target_side:
-      setup_utils.toggle_airplane_mode(self.advertiser)
-
-    wifi_ssid, wifi_password = self._get_wifi_ssid_password()
-
-    if not wifi_ssid:
-      self._test_failure_reason = (
-          nc_constants.SingleTestFailureReason.AP_IS_NOT_CONFIGURED
-      )
-      asserts.fail('Wifi AP must be specified.')
-
-    logging.info('connect to wifi: %s', wifi_ssid)
-
-    # source device
-    self._test_failure_reason = (
-        nc_constants.SingleTestFailureReason.SOURCE_WIFI_CONNECTION
-    )
-    discoverer_wifi_latency = setup_utils.connect_to_wifi_sta_till_success(
-        self.discoverer, wifi_ssid, wifi_password
-    )
-    self.discoverer.log.info(
-        'connecting to wifi in '
-        f'{round(discoverer_wifi_latency.total_seconds())} s'
-    )
-    # target device
-    self._test_failure_reason = (
-        nc_constants.SingleTestFailureReason.TARGET_WIFI_CONNECTION
-    )
-    advertiser_wlan_latency = setup_utils.connect_to_wifi_sta_till_success(
-        self.advertiser, wifi_ssid, wifi_password)
-    self.advertiser.log.info(
-        'connecting to wifi in '
-        f'{round(advertiser_wlan_latency.total_seconds())} s')
-    self.advertiser.log.info(
-        self.advertiser.nearby.wifiGetConnectionInfo().get('mFrequency')
-    )
-    self._test_failure_reason = (
-        nc_constants.SingleTestFailureReason.SUCCESS
-    )
-
-  def get_test_result_message(self) -> str:
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return 'PASS'
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.WIFI_MEDIUM_UPGRADE
-    ):
-      return ''.join([
-          f'{self._test_failure_reason.name} - ',
-          self._get_medium_upgrade_failure_tip()
-      ])
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-    ):
-      return ''.join([
-          f'{self._test_failure_reason.name} - ',
-          self._get_file_transfer_failure_tip()
-      ])
-    return ''.join([
-        f'{self._test_failure_reason.name} - ',
-        nc_constants.COMMON_TRIAGE_TIP.get(self._test_failure_reason),
-    ])
-
-  def _get_medium_upgrade_failure_tip(self) -> str:
-    return nc_constants.MEDIUM_UPGRADE_FAIL_TRIAGE_TIPS.get(
-        self._wifi_medium_under_test, ' unsupported test medium')
-
-  def _get_file_transfer_failure_tip(self) -> str:
-    if self._wifi_medium_under_test is not None:
-      return f'{self._wifi_medium_under_test.name}: the performance is too bad.'
-    asserts.fail('unexpected calling of _get_file_transfer_failure_tip')
diff --git a/tests/bettertogether/betocq/function_tests/function_test_actor_base.py b/tests/bettertogether/betocq/function_tests/function_test_actor_base.py
deleted file mode 100644
index c0ecf122d..000000000
--- a/tests/bettertogether/betocq/function_tests/function_test_actor_base.py
+++ /dev/null
@@ -1,74 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Provides the actor base for all function tests."""
-
-from typing import Tuple
-
-from mobly.controllers import android_device
-
-from betocq import nc_constants
-
-
-class FunctionTestActorBase:
-  """Base class of actors for running all function tests."""
-
-  def __init__(self,
-               test_parameters: nc_constants.TestParameters,
-               discoverer: android_device.AndroidDevice,
-               advertiser: android_device.AndroidDevice
-               ):
-    self.test_parameters: nc_constants.TestParameters = test_parameters
-    self.advertiser: android_device.AndroidDevice = advertiser
-    self.discoverer: android_device.AndroidDevice = discoverer
-    self._test_result: nc_constants.SingleTestResult = (
-        nc_constants.SingleTestResult()
-    )
-    self._test_failure_reason: nc_constants.SingleTestFailureReason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-    self._wifi_medium_under_test = None
-    self._skipped: bool = False
-
-  def _get_wifi_ssid_password(self) -> Tuple[str, str]:
-    """Returns the available wifi username and password."""
-    if self.test_parameters.wifi_ssid:
-      return (
-          self.test_parameters.wifi_ssid,
-          self.test_parameters.wifi_password,
-      )
-    if self.test_parameters.wifi_5g_ssid:
-      return (
-          self.test_parameters.wifi_5g_ssid,
-          self.test_parameters.wifi_5g_password,
-      )
-    if self.test_parameters.wifi_dfs_5g_ssid:
-      return (
-          self.test_parameters.wifi_dfs_5g_ssid,
-          self.test_parameters.wifi_dfs_5g_password,
-      )
-    if self.test_parameters.wifi_2g_ssid:
-      return (
-          self.test_parameters.wifi_2g_ssid,
-          self.test_parameters.wifi_2g_password,
-      )
-    return ('', '')
-
-  def get_test_result_message(self) -> str:
-    """Returns the message about the test result."""
-    return 'Unknown'
-
-  def _get_test_failure_reason(self) -> nc_constants.SingleTestFailureReason:
-    """Returns the test failure reason."""
-    return self._test_failure_reason
diff --git a/tests/bettertogether/betocq/function_tests/nearbyconnections_function_test.py b/tests/bettertogether/betocq/function_tests/nearbyconnections_function_test.py
deleted file mode 100644
index 622c682f1..000000000
--- a/tests/bettertogether/betocq/function_tests/nearbyconnections_function_test.py
+++ /dev/null
@@ -1,147 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Tests for Neaby Connection between two Android devices."""
-
-from mobly import asserts
-from mobly import test_runner
-from mobly.snippet import errors
-
-from betocq import nc_base_test
-from betocq import nc_constants
-from betocq import nearby_connection_wrapper
-from betocq import setup_utils
-from betocq import version
-
-
-class NearbyConnectionsFunctionTest(nc_base_test.NCBaseTestClass):
-  """Nearby Connection E2E tests."""
-
-  def __init__(self, configs):
-    super().__init__(configs)
-    self._skipped: bool = False
-    self._test_failure_reason: nc_constants.SingleTestFailureReason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-    )
-
-  def test_nearby_connections_3p_apis(self):
-    """Test the capability of 3P APIs for Nearby Connections."""
-
-    # Verify that from the 3P snippet, it fails to call 1P APIs
-    with asserts.assert_raises(errors.ApiError):
-      self.advertiser.nearby3p.getLocalEndpointId()
-    with asserts.assert_raises(errors.ApiError):
-      self.discoverer.nearby3p.getLocalEndpointId()
-
-    self._test_result = nc_constants.SingleTestResult()
-    # 1. discovery/advertising
-    nearby_snippet_3p = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby3p,
-        self.discoverer.nearby3p,
-        advertising_discovery_medium=nc_constants.NearbyMedium.AUTO,
-        connection_medium=nc_constants.NearbyMedium.AUTO,
-        upgrade_medium=nc_constants.NearbyMedium.AUTO,
-    )
-
-    # 2. create connection
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT,
-    )
-    try:
-      nearby_snippet_3p.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE,
-      )
-    finally:
-      self._test_failure_reason = nearby_snippet_3p.test_failure_reason
-      self._test_result.file_transfer_nc_setup_quality_info = (
-          nearby_snippet_3p.connection_quality_info
-      )
-
-    # 3. transfer file
-    try:
-      self._test_result.file_transfer_throughput_kbps = (
-          nearby_snippet_3p.transfer_file(
-              nc_constants.TRANSFER_FILE_SIZE_20MB,
-              nc_constants.WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT,
-              nc_constants.PayloadType.FILE,
-          )
-      )
-    finally:
-      self._test_failure_reason = nearby_snippet_3p.test_failure_reason
-
-    # 4. disconnect
-    nearby_snippet_3p.disconnect_endpoint()
-    self._summary_test_results()
-
-  def teardown_test(self) -> None:
-    self._test_result_messages[self.current_test_info.name] = (
-        self._get_test_result_message()
-    )
-    self.record_data({
-        'Test Name': self.current_test_info.name,
-        'sponge_properties': {
-            'result': self._get_test_result_message(),
-        },
-    })
-    super().teardown_test()
-
-  def _summary_test_results(self):
-    """Summarizes test results of all function tests."""
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'sponge_properties': {
-            '00_test_script_verion': version.TEST_SCRIPT_VERSION,
-            '01_source_device_serial': self.discoverer.serial,
-            '02_target_device_serial': self.advertiser.serial,
-            '03_source_GMS_version': setup_utils.dump_gms_version(
-                self.discoverer
-            ),
-            '04_target_GMS_version': setup_utils.dump_gms_version(
-                self.advertiser
-            ),
-            '05_test_result': self._test_result_messages,
-        },
-    })
-
-  def _get_test_result_message(self) -> str:
-    if self._skipped:
-      return (
-          'SKIPPED - not required for the target CUJ: '
-          f'{self.test_parameters.target_cuj_name}'
-      )
-    if (
-        self._test_failure_reason
-        == nc_constants.SingleTestFailureReason.SUCCESS
-    ):
-      return 'PASS'
-    if (
-        self._test_failure_reason
-        is nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-    ):
-      return 'The Bluetooth performance is really bad.'
-    else:
-      return ''.join([
-          f'FAIL: due to {self._test_failure_reason.name} - ',
-          f'{nc_constants.COMMON_TRIAGE_TIP.get(self._test_failure_reason)}'
-          ])
-
-
-if __name__ == '__main__':
-  test_runner.main()
\ No newline at end of file
diff --git a/tests/bettertogether/betocq/gms_auto_updates_util.py b/tests/bettertogether/betocq/gms_auto_updates_util.py
deleted file mode 100644
index e6dbee9d7..000000000
--- a/tests/bettertogether/betocq/gms_auto_updates_util.py
+++ /dev/null
@@ -1,177 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""class to enable/disable GMS auto update."""
-
-import logging
-import os
-import tempfile
-# from xml import etree has a problem, don't use it.
-from xml.etree import ElementTree
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import adb
-
-
-_FINSKY_CONFIG_FILE = '/data/data/com.android.vending/shared_prefs/finsky.xml'
-_FINSKY_CONFIG_NAME = 'auto_update_enabled'
-_FINSKY_CONFIG_VALUE_DISABLE = 'false'
-_FINSKY_CONFIG_VALUE_ENABLE = 'true'
-_VENDING_CONFIG_FILE = '/data/data/com.android.vending/shared_prefs/com.android.vending_preferences.xml'
-_VENDING_CONFIG_NAME = 'auto-update-mode'
-_VENDING_CONFIG_VALUE_DISABLE = 'AUTO_UPDATE_NEVER'
-_VENDING_CONFIG_VALUE_ENABLE = 'AUTO_UPDATE_WIFI'
-_BLANK_CONFIG = '<?xml version="1.0" encoding="utf-8"?><map></map>'
-_XML_BOOL_TYPE = 'boolean'
-_XML_STRING_TYPE = 'string'
-_ENABLE_GSERVICES_CMD_TEMPLATE = [
-    (
-        'am broadcast '
-        '-a com.google.gservices.intent.action.GSERVICES_OVERRIDE '
-        '-e finsky.play_services_auto_update_enabled {}'
-    ),
-    (
-        'am broadcast '
-        '-a com.google.gservices.intent.action.GSERVICES_OVERRIDE '
-        '-e finsky.setup_wizard_additional_account_vpa_enable {}'
-    ),
-]
-
-
-class GmsAutoUpdatesUtil:
-  """class to enable/disable GMS auto updates."""
-
-  def __init__(self, ad: android_device.AndroidDevice):
-    self._device: android_device.AndroidDevice = ad
-
-  def enable_gms_auto_updates(self) -> None:
-    self._config_gms_auto_updates(True)
-
-  def disable_gms_auto_updates(self) -> None:
-    self._config_gms_auto_updates(False)
-
-  def _config_gms_auto_updates(self, enable_updates: bool) -> None:
-    """Configures GMS auto updates."""
-    if not self._device.is_adb_root:
-      self._device.log.info(
-          f'failed to set the play store auto updates as {enable_updates}'
-          'you should enable/disable it manually on an unrooted device.')
-    else:
-      if enable_updates:
-        self._configure_play_store_updates(
-            _FINSKY_CONFIG_VALUE_ENABLE, _VENDING_CONFIG_VALUE_ENABLE
-        )
-      else:
-        self._configure_play_store_updates(
-            _FINSKY_CONFIG_VALUE_DISABLE, _VENDING_CONFIG_VALUE_DISABLE
-        )
-    self._configure_gservice_updates(enable_updates)
-
-  def _configure_gservice_updates(self, enable_updates: bool) -> None:
-    """Overwites Gservice to enable/disable updates."""
-    for cmd in _ENABLE_GSERVICES_CMD_TEMPLATE:
-      self._device.adb.shell(
-          cmd.format('true' if enable_updates else 'false')
-      )
-
-  def _create_or_update_play_store_config(
-      self,
-      tmp_dir: str,
-      value_type: str,
-      name: str,
-      value: str,
-      device_path: str,
-  ) -> str:
-    """Creates or updates a Play Store configuration file.
-
-    The function retrieves the Play Store configuration file from the device
-    then update it. If the file does not exist, it creates a new one.
-
-    Args:
-        tmp_dir: The temporary directory to store the configuration file.
-        value_type: The type of the configuration field.
-        name: The name of the configuration field.
-        value: The value of the configuration field.
-        device_path: The path to the configuration file on the device.
-
-    Returns:
-        The path to the updated configuration file.
-    """
-    path = os.path.join(tmp_dir, f'play_store_config_{name}.xml')
-    try:
-      self._device.adb.pull([device_path, path])
-    except adb.AdbError as e:
-      self._device.log.warning('failed to pull %s: %s', device_path, e)
-
-    config_doc = ElementTree.parse(path) if os.path.isfile(path) else None
-
-    changing_element = None
-    root = (
-        ElementTree.fromstring(_BLANK_CONFIG.encode())
-        if config_doc is None
-        else config_doc.getroot()
-    )
-
-    # find the element, xPath doesn't work as the name is a reserved word.
-    for child in root:
-      if child.attrib['name'] == name:
-        changing_element = child
-        break
-    if changing_element is None:
-      if value_type == _XML_BOOL_TYPE:
-        changing_element = ElementTree.SubElement(root, 'boolean')
-      else:
-        changing_element = ElementTree.SubElement(root, 'string')
-    logging.info('element for %s is %s, %s', name, changing_element.tag,
-                 changing_element.attrib)
-    if value_type == _XML_BOOL_TYPE:
-      changing_element.set('name', name)
-      changing_element.set('value', value)
-    else:
-      changing_element.attrib['name'] = name
-      changing_element.text = value
-
-    tree = ElementTree.ElementTree(root)
-    tree.write(path, xml_declaration=True, encoding='utf-8')
-    return path
-
-  def _configure_play_store_updates(
-      self, finsky_config_value: str, vending_config_value: str
-  ) -> None:
-    """Configures the Play Store update related settings."""
-    with tempfile.TemporaryDirectory() as tmp_dir:
-      finsky_config = self._create_or_update_play_store_config(
-          tmp_dir,
-          _XML_BOOL_TYPE,
-          _FINSKY_CONFIG_NAME,
-          finsky_config_value,
-          _FINSKY_CONFIG_FILE,
-      )
-      self._device.adb.push([finsky_config, _FINSKY_CONFIG_FILE])
-      try:
-        os.remove(finsky_config)
-      except OSError as e:
-        logging.warning('failed to remove %s: %s', finsky_config, e)
-
-      vending_config = self._create_or_update_play_store_config(
-          tmp_dir,
-          _XML_STRING_TYPE,
-          _VENDING_CONFIG_NAME,
-          vending_config_value,
-          _VENDING_CONFIG_FILE,
-      )
-      self._device.adb.push([vending_config, _VENDING_CONFIG_FILE])
-      try:
-        os.remove(vending_config)
-      except OSError as e:
-        logging.warning('failed to remove %s: %s', vending_config, e)
diff --git a/tests/bettertogether/betocq/iperf_utils.py b/tests/bettertogether/betocq/iperf_utils.py
deleted file mode 100644
index 429462147..000000000
--- a/tests/bettertogether/betocq/iperf_utils.py
+++ /dev/null
@@ -1,264 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""iperf test util."""
-import time
-from mobly import utils
-from mobly.controllers import android_device
-
-from betocq import nc_constants
-
-# IPv4, 10 sec, 1 stream
-DEFAULT_IPV4_CLIENT_ARGS = '-t 10 -P1'
-DEFAULT_IPV4_SERVER_ARGS = '-J'
-GROUP_OWNER_IPV4_ADDR_LEN_MAX = 15
-IPERF_SERVER_START_DELAY_SEC = 1
-IPERF_DEBUG_TIME_SEC = 300
-
-
-class IPerfServerOnDevice:
-  """Class that handles iperf3 server operations on device."""
-
-  def __init__(self, serial, arg=DEFAULT_IPV4_SERVER_ARGS):
-    self.iperf_str = 'adb -s {serial} shell iperf3 -s {arg}'.format(
-        serial=serial, arg=arg
-    )
-    self.iperf_process = None
-    self.started = False
-
-  def start(self):
-    """Starts iperf server on specified port."""
-    if self.started:
-      return
-
-    cmd = self.iperf_str
-    self.iperf_process = utils.start_standing_subprocess(cmd, shell=True)
-    self.started = True
-
-  def stop(self):
-    if self.started:
-      utils.stop_standing_subprocess(self.iperf_process)
-      self.started = False
-
-
-def run_iperf_test(
-    ad_network_client: android_device.AndroidDevice,
-    ad_network_owner: android_device.AndroidDevice,
-    medium: nc_constants.NearbyConnectionMedium,
-) -> int:
-  """Run iperf test from ad_network_client to ad_network_owner.
-
-  Args:
-    ad_network_client: android device that is the client in the iperf test.
-    ad_network_owner: android device that is the server in the iperf test.
-    medium: wifi medium used in the transfer
-
-  Returns:
-    speed in KB/s if there is a valid result or nc_constants.INVALID_INT.
-  """
-  speed_kbyte_sec = nc_constants.INVALID_INT
-  owner_addr = get_owner_ip_addr(ad_network_client, ad_network_owner, medium)
-  if not owner_addr:
-    return nc_constants.INVALID_INT
-
-  client_arg = DEFAULT_IPV4_CLIENT_ARGS
-  server_arg = DEFAULT_IPV4_SERVER_ARGS
-  # Add IPv6 option if the owner address is an IPv6 address
-  if len(owner_addr) > GROUP_OWNER_IPV4_ADDR_LEN_MAX:
-    client_arg = DEFAULT_IPV4_CLIENT_ARGS + ' -6'
-    server_arg = DEFAULT_IPV4_SERVER_ARGS + ' -6'
-
-  server = IPerfServerOnDevice(ad_network_owner.serial, server_arg)
-  try:
-    ad_network_owner.log.info('Start iperf server')
-    server.start()
-    time.sleep(IPERF_SERVER_START_DELAY_SEC)
-    ad_network_client.log.info(f'Start iperf client {owner_addr}')
-    success, result_list = ad_network_client.run_iperf_client(
-        owner_addr, client_arg
-    )
-    result = ''.join(result_list)
-    last_mbits_sec_index = result.rfind('Mbits/sec')
-    if success and last_mbits_sec_index > 0:
-      speed_mbps = int(
-          float(result[:last_mbits_sec_index].strip().split(' ')[-1])
-      )
-      speed_kbyte_sec = int(speed_mbps * 1024 / 8)
-    else:
-      ad_network_client.log.info('Can not find valid iperf test result')
-  except android_device.adb.AdbError:
-    ad_network_client.log.info('run_iperf_client() failed')
-    owner_ifconfig = get_ifconfig(ad_network_owner)
-    client_ifconfig = get_ifconfig(ad_network_client)
-    ad_network_client.log.info(client_ifconfig)
-    ad_network_client.log.info(owner_addr)
-    ad_network_client.log.info(client_arg)
-    ad_network_owner.log.info(owner_ifconfig)
-    # time.sleep(IPERF_DEBUG_TIME_SEC)
-  else:
-    server.stop()
-  return speed_kbyte_sec
-
-
-def get_owner_ip_addr(
-    ad_network_client: android_device.AndroidDevice,
-    ad_network_owner: android_device.AndroidDevice,
-    medium: nc_constants.NearbyConnectionMedium,
-) -> str:
-  """Get owner ip address which for ipv6 is postfix-ed by the client interface name."""
-  ip_addr = ''
-  if medium == nc_constants.NearbyConnectionMedium.WIFI_DIRECT:
-    ip_addr = get_group_owner_addr(ad_network_client)
-  elif medium == nc_constants.NearbyConnectionMedium.WIFI_LAN:
-    ip_addr = get_wlan_ip_addr(ad_network_owner)
-    if len(ip_addr) > GROUP_OWNER_IPV4_ADDR_LEN_MAX:
-      ip_addr += '%' + get_wlan_ifname(ad_network_client)
-  elif medium == nc_constants.NearbyConnectionMedium.WIFI_HOTSPOT:
-    ip_addr = get_p2p_ip_addr(ad_network_owner)
-    if len(ip_addr) > GROUP_OWNER_IPV4_ADDR_LEN_MAX:
-      ip_addr = ip_addr + '%' + get_wlan_ifname(ad_network_client)
-  elif medium == nc_constants.NearbyConnectionMedium.WIFI_AWARE:
-    ip_addr = get_aware_ip_addr(ad_network_owner)
-    if len(ip_addr) > GROUP_OWNER_IPV4_ADDR_LEN_MAX:
-      ip_addr = ip_addr + '%' + get_aware_ifname(ad_network_client)
-  return ip_addr
-
-
-def get_aware_ip_addr(ad: android_device.AndroidDevice) -> str:
-  """Get wlan ip address from ifconfig."""
-  ifconfig = get_ifconfig_aware(ad)
-  return extract_ip_addr_from_ifconfig(ifconfig)
-
-
-def get_wlan_ip_addr(ad: android_device.AndroidDevice) -> str:
-  """Get wlan ip address from ifconfig."""
-  ifconfig = get_ifconfig_wlan(ad)
-  return extract_ip_addr_from_ifconfig(ifconfig)
-
-
-def get_p2p_ip_addr(ad: android_device.AndroidDevice) -> str:
-  """Get p2p ip address from ifconfig."""
-  ifconfig = get_ifconfig_p2p(ad)
-  return extract_ip_addr_from_ifconfig(ifconfig)
-
-
-def get_aware_ifname(ad: android_device.AndroidDevice) -> str:
-  """Get Aware interface name from ifconfig."""
-  return get_ifconfig_aware(ad).split()[0].strip()
-
-
-def get_wlan_ifname(ad: android_device.AndroidDevice) -> str:
-  """Get WLAN interface name from ifconfig."""
-  ifconfig = get_ifconfig_wlan(ad)
-  found_wlan1 = ifconfig.rfind('wlan1')
-  if found_wlan1 >= 0:
-    return 'wlan1'
-  found_wlan0 = ifconfig.rfind('wlan0')
-  if found_wlan0 >= 0:
-    return 'wlan0'
-  return ''
-
-
-
-def get_p2p_ifname(ad: android_device.AndroidDevice) -> str:
-  """Get P2P interface name from ifconfig."""
-  return  get_ifconfig_p2p(ad).split()[0].strip()
-
-
-def extract_ip_addr_from_ifconfig(ifconfig: str) -> str:
-  """Extract ip address from ifconfig with IPv6 preferred."""
-  ipv6 = get_substr_between_prefix_postfix(
-      ifconfig, 'inet6 addr:', '/64 Scope: Link'
-  )
-  if ipv6:
-    return ipv6
-  ipv4 = get_substr_between_prefix_postfix(ifconfig, 'inet addr:', 'Bcast')
-  if ipv4:
-    return ipv4
-  return ''
-
-
-def get_substr_between_prefix_postfix(
-    string: str, prefix: str, postfix: str
-) -> str:
-  """Get substring between prefix and postfix by searching postfix and then prefix."""
-  right_index = string.rfind(postfix)
-  if right_index == -1:
-    return ''
-  left_index = string[:right_index].rfind(prefix)
-  if left_index > 0:
-    try:
-      return string[left_index + len(prefix): right_index].strip()
-    except IndexError:
-      return ''
-  return ''
-
-
-def get_ifconfig(
-    ad: android_device.AndroidDevice,
-) -> str:
-  """Get network info from adb shell ifconfig."""
-  return ad.adb.shell('ifconfig').decode('utf-8').strip()
-
-
-def get_ifconfig_aware(
-    ad: android_device.AndroidDevice,
-) -> str:
-  """Get aware network info from adb shell ifconfig."""
-  ifconfig = ad.adb.shell('ifconfig | grep -A5 aware').decode('utf-8').strip()
-  # Use the last one if there are multiple aware interfaces.
-  index = ifconfig.rfind('aware')
-  return ifconfig[index:]
-
-
-def get_ifconfig_wlan(
-    ad: android_device.AndroidDevice,
-) -> str:
-  """Get wlan network info from adb shell ifconfig."""
-  return ad.adb.shell('ifconfig | grep -A5 wlan').decode('utf-8').strip()
-
-
-def get_ifconfig_p2p(
-    ad: android_device.AndroidDevice,
-) -> str:
-  """Get p2p network info from adb shell ifconfig."""
-  return ad.adb.shell('ifconfig | grep -A5 p2p').decode('utf-8').strip()
-
-
-def get_group_owner_addr(
-    ad: android_device.AndroidDevice,
-) -> str:
-  """Get the group owner address from adb shell dumpsys wifip2p.
-
-  This works only if group owner address is the last substring of the line.
-
-  Args:
-    ad: android device that is the group client
-  Returns:
-    ipv4 address or ipv6 address with the link interface
-  """
-
-  try:
-    return (
-        ad.adb.shell(
-            'dumpsys wifip2p | egrep "groupOwnerAddress|groupOwnerIpAddress"'
-        )
-        .decode('utf-8')
-        .strip()
-        .split()[-1]
-        .replace('/', '')
-    )
-  except android_device.adb.Error:
-    ad.log.info('Failed to get group owner address.')
-    return ''
diff --git a/tests/bettertogether/betocq/nc_base_test.py b/tests/bettertogether/betocq/nc_base_test.py
deleted file mode 100644
index afe8eea8d..000000000
--- a/tests/bettertogether/betocq/nc_base_test.py
+++ /dev/null
@@ -1,352 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Mobly base test class for Neaby Connections.
-
-Override the NCBaseTestClass#_get_country_code method if the test requires
-a special country code, the 'US' is used by default.
-"""
-
-import logging
-import os
-import time
-
-from mobly import asserts
-from mobly import base_test
-from mobly import records
-from mobly import utils
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import errors
-import yaml
-
-from betocq import android_wifi_utils
-from betocq import nc_constants
-from betocq import setup_utils
-from betocq import version
-
-NEARBY_SNIPPET_PACKAGE_NAME = 'com.google.android.nearby.mobly.snippet'
-NEARBY_SNIPPET_2_PACKAGE_NAME = 'com.google.android.nearby.mobly.snippet.second'
-NEARBY_SNIPPET_3P_PACKAGE_NAME = 'com.google.android.nearby.mobly.snippet.thirdparty'
-
-# TODO(b/330803934): Need to design external path for OEM.
-_CONFIG_EXTERNAL_PATH = 'TBD'
-
-
-class NCBaseTestClass(base_test.BaseTestClass):
-  """The Base of Nearby Connection E2E tests."""
-
-  def __init__(self, configs):
-    super().__init__(configs)
-    self.ads: list[android_device.AndroidDevice] = []
-    self.advertiser: android_device.AndroidDevice = None
-    self.discoverer: android_device.AndroidDevice = None
-    self.test_parameters: nc_constants.TestParameters = (
-        nc_constants.TestParameters.from_user_params(self.user_params)
-    )
-    self._test_result_messages: dict[str, str] = {}
-    self._nearby_snippet_apk_path: str = None
-    self._nearby_snippet_2_apk_path: str = None
-    self._nearby_snippet_3p_apk_path: str = None
-    self.performance_test_iterations: int = 1
-    self.num_bug_reports: int = 0
-    self._requires_2_snippet_apks = False
-    self._requires_3p_snippet_apks = False
-    self.__loaded_2_nearby_snippets = False
-    self.__loaded_3p_nearby_snippets = False
-    self.__skipped_test_class = False
-
-  def _get_skipped_test_class_reason(self) -> str | None:
-    return None
-
-  def setup_class(self) -> None:
-    self._setup_openwrt_wifi()
-    self.ads = self.register_controller(android_device, min_number=2)
-    try:
-      self.discoverer = android_device.get_device(
-          self.ads, role='source_device'
-      )
-      self.advertiser = android_device.get_device(
-          self.ads, role='target_device'
-      )
-    except errors.Error:
-      logging.warning(
-          'The source,target devices are not specified in testbed;'
-          'The result may not be expected.'
-      )
-      self.advertiser, self.discoverer = self.ads
-
-    utils.concurrent_exec(
-        self._setup_android_hw_capability,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-    skipped_test_class_reason = self._get_skipped_test_class_reason()
-    for ad in self.ads:
-      if (
-          not ad.wifi_chipset
-          and self.test_parameters.skip_test_if_wifi_chipset_is_empty
-      ):
-        skipped_test_class_reason = 'wifi_chipset is empty in the config file'
-        ad.log.warning(skipped_test_class_reason)
-    if skipped_test_class_reason:
-      self.__skipped_test_class = True
-      asserts.abort_class(skipped_test_class_reason)
-
-    file_tag = 'files' if 'files' in self.user_params else 'mh_files'
-    self._nearby_snippet_apk_path = self.user_params.get(file_tag, {}).get(
-        'nearby_snippet', ['']
-    )[0]
-    if self.test_parameters.requires_bt_multiplex:
-      self._requires_2_snippet_apks = True
-      self._nearby_snippet_2_apk_path = self.user_params.get(file_tag, {}).get(
-          'nearby_snippet_2', ['']
-      )[0]
-    if self.test_parameters.requires_3p_api_test:
-      self._requires_3p_snippet_apks = True
-      self._nearby_snippet_3p_apk_path = self.user_params.get(file_tag, {}).get(
-          'nearby_snippet_3p', ['']
-      )[0]
-
-    # disconnect from all wifi automatically
-    utils.concurrent_exec(
-        android_wifi_utils.forget_all_wifi,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-    utils.concurrent_exec(
-        self._setup_android_device,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-  def _setup_openwrt_wifi(self):
-    """Sets up the wifi connection with OpenWRT."""
-    if not self.user_params.get('use_auto_controlled_wifi_ap', False):
-      return
-
-    self.openwrt = self.register_controller(openwrt_device)[0]
-    if 'wifi_channel' in self.user_params:
-      wifi_channel = self.user_params['wifi_channel']
-      self.wifi_info = self.openwrt.start_wifi(
-          config=wifi_configs.WiFiConfig(
-              channel=wifi_channel,
-              country_code=self._get_country_code(),
-          )
-      )
-    else:
-      wifi_channel = None
-      self.wifi_info = self.openwrt.start_wifi(
-          config=wifi_configs.WiFiConfig(
-              country_code=self._get_country_code(),
-          )
-      )
-
-    if wifi_channel is None:
-      self.test_parameters.wifi_ssid = self.wifi_info.ssid
-      self.test_parameters.wifi_password = self.wifi_info.password
-    elif wifi_channel == 6:
-      self.test_parameters.wifi_2g_ssid = self.wifi_info.ssid
-      self.test_parameters.wifi_2g_password = self.wifi_info.password
-    elif wifi_channel == 36:
-      self.test_parameters.wifi_5g_ssid = self.wifi_info.ssid
-      self.test_parameters.wifi_5g_password = self.wifi_info.password
-    elif wifi_channel == 52:
-      self.test_parameters.wifi_dfs_5g_ssid = self.wifi_info.ssid
-      self.test_parameters.wifi_dfs_5g_password = self.wifi_info.password
-    else:
-      raise ValueError('Unknown Wi-Fi channel: %s' % wifi_channel)
-
-  def _setup_android_hw_capability(
-      self, ad: android_device.AndroidDevice
-  ) -> None:
-    ad.android_version = int(ad.adb.getprop('ro.build.version.release'))
-
-    # TODO(b/330803934): Need to design external path for OEM.
-    if not os.path.isfile(_CONFIG_EXTERNAL_PATH):
-      return
-
-    config_path = _CONFIG_EXTERNAL_PATH
-    with open(config_path, 'r') as f:
-      rule = yaml.safe_load(f).get(ad.model, None)
-      if rule is None:
-        ad.log.warning(f'{ad} Model {ad.model} is not supported in config file')
-        return
-      for key, value in rule.items():
-        ad.log.debug('Setting capability %s to %s', repr(key), repr(value))
-        setattr(ad, key, value)
-
-  def _get_country_code(self) -> str:
-    return 'US'
-
-  def _setup_android_device(self, ad: android_device.AndroidDevice) -> None:
-    ad.debug_tag = ad.serial + '(' + ad.adb.getprop('ro.product.model') + ')'
-    if not ad.is_adb_root:
-      if self.test_parameters.allow_unrooted_device:
-        ad.log.info('Unrooted device is detected. Test coverage is limited')
-      else:
-        asserts.abort_all('The test only can run on rooted device.')
-
-    setup_utils.disable_gms_auto_updates(ad)
-
-    ad.debug_tag = ad.serial + '(' + ad.adb.getprop('ro.product.model') + ')'
-    ad.log.info('try to install nearby_snippet_apk')
-    if self._nearby_snippet_apk_path:
-      setup_utils.install_apk(ad, self._nearby_snippet_apk_path)
-    else:
-      ad.log.warning(
-          'nearby_snippet apk is not specified, '
-          'make sure it is installed in the device'
-      )
-
-    ad.log.info('grant manage external storage permission')
-    setup_utils.grant_manage_external_storage_permission(
-        ad, NEARBY_SNIPPET_PACKAGE_NAME
-    )
-    ad.load_snippet('nearby', NEARBY_SNIPPET_PACKAGE_NAME)
-
-    if self._requires_2_snippet_apks:
-      ad.log.info('try to install nearby_snippet_2_apk')
-      if self._nearby_snippet_2_apk_path:
-        setup_utils.install_apk(ad, self._nearby_snippet_2_apk_path)
-      else:
-        ad.log.warning(
-            'nearby_snippet_2 apk is not specified, '
-            'make sure it is installed in the device'
-        )
-      setup_utils.grant_manage_external_storage_permission(
-          ad, NEARBY_SNIPPET_2_PACKAGE_NAME
-      )
-      ad.load_snippet('nearby2', NEARBY_SNIPPET_2_PACKAGE_NAME)
-      self.__loaded_2_nearby_snippets = True
-    if self._requires_3p_snippet_apks:
-      ad.log.info('try to install nearby_snippet_3p_apk')
-      if self._nearby_snippet_3p_apk_path:
-        setup_utils.install_apk(ad, self._nearby_snippet_3p_apk_path)
-      else:
-        ad.log.warning(
-            'nearby_snippet_3p apk is not specified, '
-            'make sure it is installed in the device'
-        )
-      setup_utils.grant_manage_external_storage_permission(
-          ad, NEARBY_SNIPPET_3P_PACKAGE_NAME
-      )
-      ad.load_snippet('nearby3p', NEARBY_SNIPPET_3P_PACKAGE_NAME)
-      self.__loaded_3p_nearby_snippets = True
-
-    if not ad.nearby.wifiIsEnabled():
-      ad.nearby.wifiEnable()
-    setup_utils.disconnect_from_wifi(ad)
-    setup_utils.enable_logs(ad)
-    setup_utils.disable_redaction(ad)
-    setup_utils.enable_wifi_aware(ad)
-    setup_utils.disable_wlan_deny_list(ad)
-
-    setup_utils.enable_ble_scan_throttling_during_2g_transfer(
-        ad, self.test_parameters.enable_2g_ble_scan_throttling
-    )
-
-    setup_utils.set_country_code(ad, self._get_country_code())
-
-  def setup_test(self):
-    self.record_data({
-        'Test Name': self.current_test_info.name,
-        'properties': {
-            'beto_team': 'Nearby Connections',
-            'beto_feature': 'Nearby Connections',
-        },
-    })
-    self._reset_nearby_connection()
-
-  def _reset_wifi_connection(self) -> None:
-    """Resets wifi connections on both devices."""
-    self.discoverer.nearby.wifiClearConfiguredNetworks()
-    self.advertiser.nearby.wifiClearConfiguredNetworks()
-    time.sleep(nc_constants.WIFI_DISCONNECTION_DELAY.total_seconds())
-
-  def _reset_nearby_connection(self) -> None:
-    """Resets nearby connection."""
-    self.discoverer.nearby.stopDiscovery()
-    self.discoverer.nearby.stopAllEndpoints()
-    self.advertiser.nearby.stopAdvertising()
-    self.advertiser.nearby.stopAllEndpoints()
-    if self.__loaded_2_nearby_snippets:
-      self.discoverer.nearby2.stopDiscovery()
-      self.discoverer.nearby2.stopAllEndpoints()
-      self.advertiser.nearby2.stopAdvertising()
-      self.advertiser.nearby2.stopAllEndpoints()
-    if self.__loaded_3p_nearby_snippets:
-      self.discoverer.nearby3p.stopDiscovery()
-      self.discoverer.nearby3p.stopAllEndpoints()
-      self.advertiser.nearby3p.stopAdvertising()
-      self.advertiser.nearby3p.stopAllEndpoints()
-    time.sleep(nc_constants.NEARBY_RESET_WAIT_TIME.total_seconds())
-
-  def _teardown_device(self, ad: android_device.AndroidDevice) -> None:
-    ad.nearby.transferFilesCleanup()
-    setup_utils.enable_gms_auto_updates(ad)
-
-    if self.test_parameters.disconnect_wifi_after_test:
-      setup_utils.disconnect_from_wifi(ad)
-
-    ad.unload_snippet('nearby')
-    if self.__loaded_2_nearby_snippets:
-      ad.unload_snippet('nearby2')
-    if self.__loaded_3p_nearby_snippets:
-      ad.unload_snippet('nearby3p')
-
-  def teardown_test(self) -> None:
-    utils.concurrent_exec(
-        lambda d: d.services.create_output_excerpts_all(self.current_test_info),
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-    if hasattr(self, 'openwrt'):
-      self.openwrt.services.create_output_excerpts_all(self.current_test_info)
-
-  def teardown_class(self) -> None:
-    if self.__skipped_test_class:
-      logging.info('Skipping teardown class.')
-      return
-
-    # handle summary results
-    self._summary_test_results()
-
-    utils.concurrent_exec(
-        self._teardown_device,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-    if hasattr(self, 'openwrt') and hasattr(self, 'wifi_info'):
-      self.openwrt.stop_wifi(self.wifi_info)
-
-  def _summary_test_results(self) -> None:
-    pass
-
-  def on_fail(self, record: records.TestResultRecord) -> None:
-    if self.__skipped_test_class:
-      logging.info('Skipping on_fail.')
-      return
-    if self.test_parameters.skip_bug_report:
-      logging.info('Skipping bug report.')
-      return
-    self.num_bug_reports = self.num_bug_reports + 1
-    if self.num_bug_reports <= nc_constants.MAX_NUM_BUG_REPORT:
-      logging.info('take bug report for failure')
-      android_device.take_bug_reports(
-          self.ads,
-          destination=self.current_test_info.output_path,
-      )
diff --git a/tests/bettertogether/betocq/nc_constants.py b/tests/bettertogether/betocq/nc_constants.py
deleted file mode 100644
index 1bd531280..000000000
--- a/tests/bettertogether/betocq/nc_constants.py
+++ /dev/null
@@ -1,476 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Constants for Nearby Connection."""
-
-import ast
-import dataclasses
-import datetime
-import enum
-import logging
-from typing import Any
-
-SUCCESS_RATE_TARGET = 0.98
-MCC_PERFORMANCE_TEST_COUNT = 100
-MCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 5
-SCC_PERFORMANCE_TEST_COUNT = 10
-SCC_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 2
-BT_PERFORMANCE_TEST_COUNT = 100
-BT_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 5
-
-TARGET_POST_WIFI_CONNECTION_IDLE_TIME_SEC = 10
-
-NEARBY_RESET_WAIT_TIME = datetime.timedelta(seconds=2)
-WIFI_DISCONNECTION_DELAY = datetime.timedelta(seconds=1)
-
-FIRST_DISCOVERY_TIMEOUT = datetime.timedelta(seconds=30)
-FIRST_CONNECTION_INIT_TIMEOUT = datetime.timedelta(seconds=30)
-FIRST_CONNECTION_RESULT_TIMEOUT = datetime.timedelta(seconds=35)
-BT_1K_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=20)
-BT_500K_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=25)
-BLE_500K_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=25)
-SECOND_DISCOVERY_TIMEOUT = datetime.timedelta(seconds=35)
-SECOND_CONNECTION_INIT_TIMEOUT = datetime.timedelta(seconds=10)
-SECOND_CONNECTION_RESULT_TIMEOUT = datetime.timedelta(seconds=25)
-CONNECTION_BANDWIDTH_CHANGED_TIMEOUT = datetime.timedelta(seconds=25)
-WIFI_1K_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=20)
-WIFI_2G_20M_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=20)
-WIFI_200M_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=100)
-WIFI_500M_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=250)
-WIFI_STA_CONNECTING_TIME_OUT = datetime.timedelta(seconds=25)
-DISCONNECTION_TIMEOUT = datetime.timedelta(seconds=15)
-
-MAX_PHY_RATE_PER_STREAM_AC_80_MBPS = 433
-MAX_PHY_RATE_PER_STREAM_AC_40_MBPS = 200
-MAX_PHY_RATE_PER_STREAM_N_20_MBPS = 72
-
-MCC_THROUGHPUT_MULTIPLIER = 0.25
-MAX_PHY_RATE_TO_MIN_THROUGHPUT_RATIO_5G = 0.37
-MAX_PHY_RATE_TO_MIN_THROUGHPUT_RATIO_2G = 0.10
-WLAN_THROUGHPUT_CAP_MBPS = 20  # cap for WLAN medium due to encryption overhead
-
-CLASSIC_BT_MEDIUM_THROUGHPUT_BENCHMARK_MBPS = 0.02
-BLE_MEDIUM_THROUGHPUT_BENCHMARK_MBPS = 0.02
-
-KEEP_ALIVE_TIMEOUT_BT_MS = 30000
-KEEP_ALIVE_INTERVAL_BT_MS = 5000
-
-KEEP_ALIVE_TIMEOUT_WIFI_MS = 10000
-KEEP_ALIVE_INTERVAL_WIFI_MS = 3000
-
-PERCENTILE_50_FACTOR = 0.5
-LATENCY_PRECISION_DIGITS = 1
-
-UNSET_LATENCY = datetime.timedelta.max
-UNSET_THROUGHPUT_KBPS = -1.0
-MAX_NUM_BUG_REPORT = 5
-INVALID_INT = -1
-
-TRANSFER_FILE_SIZE_500MB = 500 * 1024  # kB
-TRANSFER_FILE_SIZE_200MB = 200 * 1024  # kB
-TRANSFER_FILE_SIZE_20MB = 20 * 1024  # kB
-TRANSFER_FILE_SIZE_1MB = 1024  # kB
-TRANSFER_FILE_SIZE_500KB = 512  # kB
-TRANSFER_FILE_SIZE_1KB = 1  # kB
-
-TARGET_CUJ_QUICK_START = 'quick_start'
-TARGET_CUJ_ESIM = 'setting_based_esim_transfer'
-TARGET_CUJ_QUICK_SHARE = 'quick_share'
-
-
-@enum.unique
-class PayloadType(enum.IntEnum):
-  FILE = 2
-  STREAM = 3
-
-
-@enum.unique
-class NearbyMedium(enum.IntEnum):
-  """Medium options for discovery, advertising, connection and upgrade."""
-
-  AUTO = 0
-  BT_ONLY = 1
-  BLE_ONLY = 2
-  WIFILAN_ONLY = 3
-  WIFIAWARE_ONLY = 4
-  UPGRADE_TO_WEBRTC = 5
-  UPGRADE_TO_WIFIHOTSPOT = 6
-  UPGRADE_TO_WIFIDIRECT = 7
-  BLE_L2CAP_ONLY = 8
-  # including WIFI_LAN, WIFI_HOTSPOT, WIFI_DIRECT
-  UPGRADE_TO_ALL_WIFI = 9
-
-
-@dataclasses.dataclass(frozen=False)
-class TestParameters:
-  """Test parameters to be customized for Nearby Connection."""
-
-  target_cuj_name: str = 'unspecified'
-  requires_bt_multiplex: bool = False
-  requires_3p_api_test: bool = False
-  abort_all_tests_on_function_tests_fail: bool = True
-  fast_fail_on_any_error: bool = False
-  use_auto_controlled_wifi_ap: bool = False
-  wifi_2g_ssid: str = ''
-  wifi_2g_password: str = ''
-  wifi_5g_ssid: str = ''
-  wifi_5g_password: str = ''
-  wifi_dfs_5g_ssid: str = ''
-  wifi_dfs_5g_password: str = ''
-  wifi_ssid: str = ''  # optional, for tests which can use any wifi
-  wifi_password: str = ''
-  advertising_discovery_medium: NearbyMedium = NearbyMedium.BLE_ONLY
-  connection_medium: NearbyMedium = NearbyMedium.BT_ONLY
-  toggle_airplane_mode_target_side: bool = False
-  reset_wifi_connection: bool = True
-  disconnect_bt_after_test: bool = False
-  disconnect_wifi_after_test: bool = False
-  payload_type: PayloadType = PayloadType.FILE
-  allow_unrooted_device: bool = False
-  keep_alive_timeout_ms: int = KEEP_ALIVE_TIMEOUT_WIFI_MS
-  keep_alive_interval_ms: int = KEEP_ALIVE_INTERVAL_WIFI_MS
-  enable_2g_ble_scan_throttling: bool = True
-  target_post_wifi_connection_idle_time_sec: int = (
-      TARGET_POST_WIFI_CONNECTION_IDLE_TIME_SEC
-  )
-
-  run_function_tests_with_performance_tests: bool = True
-  run_bt_performance_test: bool = True
-  run_ble_performance_test: bool = False
-  run_bt_coex_test: bool = True
-  run_directed_test: bool = True
-  run_compound_test: bool = True
-  run_aware_test: bool = False
-  run_iperf_test: bool = True
-  run_nearby_connections_function_tests: bool = False
-  skip_test_if_wifi_chipset_is_empty: bool = True
-  skip_bug_report: bool = False
-
-  @classmethod
-  def from_user_params(
-      cls,
-      user_params: dict[str, Any]) -> 'TestParameters':
-    """convert the parameters from the testbed to the test parameter."""
-
-    # Convert G3 user int parameter in str format to int.
-    for key, value in user_params.items():
-      if key == 'mh_files':
-        continue
-      logging.info('[Test Parameters] %s: %s', key, value)
-      if value in ('true', 'True'):
-        user_params[key] = True
-      elif value in ('false', 'False'):
-        user_params[key] = False
-      elif isinstance(value, bool):
-        user_params[key] = value
-      elif isinstance(value, str) and value.isdigit():
-        user_params[key] = ast.literal_eval(value)
-
-    test_parameters_names = {
-        field.name for field in dataclasses.fields(cls)
-    }
-    test_parameters = cls(
-        **{
-            key: val
-            for key, val in user_params.items()
-            if key in test_parameters_names
-        }
-    )
-
-    if test_parameters.target_cuj_name == TARGET_CUJ_QUICK_START:
-      test_parameters.requires_bt_multiplex = True
-
-    return test_parameters
-
-
-@enum.unique
-class NearbyConnectionMedium(enum.IntEnum):
-  """The final connection medium selected, see BandWidthInfo.Medium."""
-  UNKNOWN = 0
-  # reserved 1, it's Medium.MDNS, not used now
-  BLUETOOTH = 2
-  WIFI_HOTSPOT = 3
-  BLE = 4
-  WIFI_LAN = 5
-  WIFI_AWARE = 6
-  NFC = 7
-  WIFI_DIRECT = 8
-  WEB_RTC = 9
-  # 10 is reserved.
-  USB = 11
-
-
-def is_high_quality_medium(medium: NearbyMedium) -> bool:
-  return medium in {
-      NearbyMedium.WIFILAN_ONLY,
-      NearbyMedium.WIFIAWARE_ONLY,
-      NearbyMedium.UPGRADE_TO_WEBRTC,
-      NearbyMedium.UPGRADE_TO_WIFIHOTSPOT,
-      NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-      NearbyMedium.UPGRADE_TO_ALL_WIFI,
-  }
-
-
-@enum.unique
-class MediumUpgradeType(enum.IntEnum):
-  DEFAULT = 0
-  DISRUPTIVE = 1
-  NON_DISRUPTIVE = 2
-
-
-@enum.unique
-class WifiD2DType(enum.IntEnum):
-  SCC_2G = 0
-  SCC_5G = 1
-  MCC_2G_WFD_5G_STA = 2
-  MCC_2G_WFD_5G_INDOOR_STA = 3
-  MCC_5G_WFD_5G_DFS_STA = 4
-  MCC_5G_HS_5G_DFS_STA = 5
-
-
-@enum.unique
-class SingleTestFailureReason(enum.IntEnum):
-  """The failure reasons for a nearby connect connection test."""
-  UNINITIALIZED = 0
-  SOURCE_START_DISCOVERY = 1
-  TARGET_START_ADVERTISING = 2
-  SOURCE_REQUEST_CONNECTION = 3
-  TARGET_ACCEPT_CONNECTION = 4
-  WIFI_MEDIUM_UPGRADE = 5
-  FILE_TRANSFER_FAIL = 6
-  FILE_TRANSFER_THROUGHPUT_LOW = 7
-  SOURCE_WIFI_CONNECTION = 8
-  TARGET_WIFI_CONNECTION = 9
-  AP_IS_NOT_CONFIGURED = 10
-  DISCONNECTED_FROM_AP = 11
-  WRONG_AP_FREQUENCY = 12
-  WRONG_P2P_FREQUENCY = 13
-  DEVICE_CONFIG_ERROR = 14
-  SUCCESS = 15
-
-
-COMMON_WIFI_CONNECTION_FAILURE_REASONS = (
-    ' 1) Check if the wifi ssid or password is correct;\n',
-    ' 2) Try to remove any saved wifi network from wifi settings;\n',
-    ' 3) Check if other device can connect to the same AP\n',
-    ' 4) Check the wifi connection related log on the device.\n',
-)
-
-COMMON_TRIAGE_TIP: dict[SingleTestFailureReason, str] = {
-    SingleTestFailureReason.UNINITIALIZED: (
-        'not executed, the whole test was exited earlier; the devices may be'
-        ' disconnected from the host, abnormal things, such as system crash, '
-        ' mobly snippet was killed; Or something wrong with the script, check'
-        ' the test running log and the corresponding bugreport log.'
-    ),
-    SingleTestFailureReason.SUCCESS: 'success!',
-    SingleTestFailureReason.SOURCE_START_DISCOVERY: (
-        'The source device fails to discover the target device.'
-    ),
-    SingleTestFailureReason.TARGET_START_ADVERTISING: (
-        'The target device can not start advertising.'
-    ),
-    SingleTestFailureReason.SOURCE_REQUEST_CONNECTION: (
-        'The source device fails to connect to the target device'
-    ),
-    SingleTestFailureReason.TARGET_ACCEPT_CONNECTION: (
-        'The target device fails to accept the connection.'
-    ),
-    SingleTestFailureReason.SOURCE_WIFI_CONNECTION: (
-        'The source device can not connect to the wifi AP.\n'
-        f'{COMMON_WIFI_CONNECTION_FAILURE_REASONS}'
-    ),
-    SingleTestFailureReason.TARGET_WIFI_CONNECTION: (
-        'The target device can not connect to the wifi AP.\n'
-        f'{COMMON_WIFI_CONNECTION_FAILURE_REASONS}'
-    ),
-    SingleTestFailureReason.AP_IS_NOT_CONFIGURED: (
-        'The test AP is not set correctly in the test configuration file.'
-    ),
-    SingleTestFailureReason.DISCONNECTED_FROM_AP: (
-        'The STA is disconnected from the AP. Check AP DHCP config. Check if'
-        ' other devices can connect to the same AP.'
-    ),
-    SingleTestFailureReason.WRONG_AP_FREQUENCY: (
-        'Check if the test AP is set to the expected frequency.'
-    ),
-    SingleTestFailureReason.WRONG_P2P_FREQUENCY: '\n'.join([
-        'The test P2P frequency is not set to the expected value.',
-        ' Check if device capabilities are set correctly in the config file.',
-        ' If it is SCC DBS test case, check if the device does support DBS;',
-        (
-            ' If it is the SCC indoor or DFS test case, check if the device'
-            ' does support indoor/DFS channels in WFD mode;'
-        ),
-        (
-            ' If it is a MCC test, check if devices actually supports DBS,'
-            ' indoor or DFS feature  and set device capabilities correctly.'
-        ),
-    ]),
-    SingleTestFailureReason.DEVICE_CONFIG_ERROR: (
-        'Check if device capabilities are set correctly in the config file.'
-    ),
-}
-
-COMMON_WFD_UPGRADE_FAILURE_REASONS = '\n'.join([
-    'If WFD GO fails to start, check your factory build to ensure that',
-    (
-        ' 1) includes the wpa_supplicant patch to avoid scan before starting GO'
-        ' https://w1.fi/cgit/hostap/commit/?id=b18d95759375834b6ca6f864c898f27d161b14ca.'
-    ),
-    (
-        ' 2) includes WiFi mainline module 34.11.10.06.0 or later version which'
-        ' fixes the out-of-order message issue between P2P and tethering'
-        ' modules'
-    ),
-    (
-        ' 3) HAL getUsableChannels() returns the correct channel list. Run "adb'
-        ' shell cmd wifi get-allowed-channel" and ensure it does not include'
-        ' DFS channels unless config_wifiEnableStaDfsChannelForPeerNetwork is'
-        ' set to true. DFS channels can be found from'
-        ' https://en.wikipedia.org/wiki/List_of_WLAN_channels.'
-    ),
-    (
-        'Also check if BT socket is still connected and read/write is normal'
-        ' when the upgrade failure happens'
-    ),
-])
-
-MEDIUM_UPGRADE_FAIL_TRIAGE_TIPS: dict[NearbyMedium, str] = {
-    NearbyMedium.WIFILAN_ONLY: (
-        ' WLAN, check if AP blocks the mDNS traffic. Check if STA is connected'
-        ' to AP during WiFi upgrade.'
-    ),
-    NearbyMedium.UPGRADE_TO_WIFIHOTSPOT: (
-        ' HOTSPOT, check the related wifip2p and NearbyConnections logs to see'
-        ' if the WFD group owner fails to start on'
-        ' the target side or the STA fails to connect on the source side.\n'
-        f' {COMMON_WFD_UPGRADE_FAILURE_REASONS}'
-    ),
-    NearbyMedium.UPGRADE_TO_WIFIDIRECT: (
-        ' WFD, check the related wifip2p and NearbyConnections logs if the WFD'
-        ' group owner fails to start on the target side or WFD group client'
-        ' fails to connect on the source side. \n'
-        f' {COMMON_WFD_UPGRADE_FAILURE_REASONS}'
-    ),
-    NearbyMedium.UPGRADE_TO_ALL_WIFI: (
-        ' all WiFI mediums, check NearbyConnections logs to see if WFD, WLAN'
-        ' and HOTSPOT mediums are tried and if the failure is on the target or'
-        ' source side. Check directed test results to see which medium fails.'
-    ),
-}
-
-
-@dataclasses.dataclass(frozen=True)
-class ConnectionSetupTimeouts:
-  """The timeouts of the nearby connection setup."""
-  discovery_timeout: datetime.timedelta | None = None
-  connection_init_timeout: datetime.timedelta | None = None
-  connection_result_timeout: datetime.timedelta | None = None
-
-
-@dataclasses.dataclass(frozen=False)
-class ConnectionSetupQualityInfo:
-  """The quality information of the nearby connection setup."""
-  discovery_latency: datetime.timedelta = UNSET_LATENCY
-  connection_latency: datetime.timedelta = UNSET_LATENCY
-  medium_upgrade_latency: datetime.timedelta = UNSET_LATENCY
-  medium_upgrade_expected: bool = False
-  upgrade_medium: NearbyConnectionMedium | None = None
-  medium_frequency: int = INVALID_INT
-
-  def get_dict(self) -> dict[str, str]:
-    dict_repr = {
-        'discovery': f'{round(self.discovery_latency.total_seconds(), 1)}s',
-        'connection': f'{round(self.connection_latency.total_seconds(), 1)}s'
-    }
-    if self.medium_upgrade_expected:
-      dict_repr['upgrade'] = (
-          f'{round(self.medium_upgrade_latency.total_seconds(), 1)}s'
-      )
-    if self.upgrade_medium:
-      dict_repr['medium'] = self.upgrade_medium.name
-    return dict_repr
-
-  def get_medium_name(self) -> str:
-    if self.upgrade_medium:
-      return self.upgrade_medium.name
-    return 'na'
-
-
-@dataclasses.dataclass(frozen=False)
-class SingleTestResult:
-  """The test result of a single iteration."""
-
-  test_iteration: int = 0
-  is_failed_with_prior_bt: bool = False
-  failure_reason: SingleTestFailureReason = (
-      SingleTestFailureReason.UNINITIALIZED
-  )
-  result_message: str = ''
-  prior_nc_quality_info: ConnectionSetupQualityInfo = dataclasses.field(
-      default_factory=ConnectionSetupQualityInfo
-  )
-  discoverer_sta_latency: datetime.timedelta = UNSET_LATENCY
-  quality_info: ConnectionSetupQualityInfo = (
-      dataclasses.field(default_factory=ConnectionSetupQualityInfo)
-  )
-  file_transfer_throughput_kbps: float = UNSET_THROUGHPUT_KBPS
-  iperf_throughput_kbps: float = UNSET_THROUGHPUT_KBPS
-  advertiser_sta_latency: datetime.timedelta = UNSET_LATENCY
-  discoverer_sta_expected: bool = False
-  advertiser_wifi_expected: bool = False
-  sta_frequency: int = INVALID_INT
-  max_sta_link_speed_mbps: int = INVALID_INT
-  start_time: datetime.datetime = datetime.datetime.now()
-
-
-@dataclasses.dataclass(frozen=False)
-class NcPerformanceTestMetrics:
-  """Metrics data for quick start test."""
-
-  prior_bt_discovery_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta]
-  )
-  prior_bt_connection_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta]
-  )
-  discoverer_wifi_sta_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta]
-  )
-  file_transfer_discovery_latencies: list[datetime.timedelta] = (
-      dataclasses.field(default_factory=list[datetime.timedelta])
-  )
-  file_transfer_connection_latencies: list[datetime.timedelta] = (
-      dataclasses.field(default_factory=list[datetime.timedelta])
-  )
-  medium_upgrade_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta])
-  advertiser_wifi_sta_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta])
-  file_transfer_throughputs_kbps: list[float] = dataclasses.field(
-      default_factory=list[float])
-  iperf_throughputs_kbps: list[float] = dataclasses.field(
-      default_factory=list[float])
-  upgraded_wifi_transfer_mediums: list[NearbyConnectionMedium] = (
-      dataclasses.field(default_factory=list[NearbyConnectionMedium]))
-
-
-@dataclasses.dataclass(frozen=True)
-class TestResultStats:
-  """The test result stats."""
-  success_count: int | None = None
-  min_val: float | None = None
-  median_val: float | None = None
-  max_val: float | None = None
diff --git a/tests/bettertogether/betocq/nearby_connection_wrapper.py b/tests/bettertogether/betocq/nearby_connection_wrapper.py
deleted file mode 100644
index edcbe8925..000000000
--- a/tests/bettertogether/betocq/nearby_connection_wrapper.py
+++ /dev/null
@@ -1,417 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Utils for handling Nearby Connection rpc."""
-
-import datetime
-import random
-import time
-
-from mobly import asserts
-from mobly import utils
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import callback_handler_v2
-from mobly.controllers.android_device_lib import snippet_client_v2
-from mobly.snippet import callback_event
-
-from betocq import nc_constants
-
-# This number should be large enough to cover advertising interval, firmware
-# scheduling timing interval and user action delay
-ADVERTISING_TO_DISCOVERY_MAX_DELAY_SEC = 4
-
-
-class NearbyConnectionWrapper:
-  """Wrapper for Nearby Connection Snippet Client Operations."""
-
-  def __init__(
-      self,
-      advertiser: android_device.AndroidDevice,
-      discoverer: android_device.AndroidDevice,
-      advertiser_nearby: snippet_client_v2.SnippetClientV2,
-      discoverer_nearby: snippet_client_v2.SnippetClientV2,
-      advertising_discovery_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BLE_ONLY
-      ),
-      connection_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BT_ONLY
-      ),
-      upgrade_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BT_ONLY
-      ),
-  ):
-    self.advertiser = advertiser
-    self.discoverer = discoverer
-    self.service_id = utils.rand_ascii_str(8)
-    self.advertising_discovery_medium = advertising_discovery_medium
-    self.connection_medium = connection_medium
-    self.upgrade_medium = upgrade_medium
-    self.discoverer_nearby = discoverer_nearby
-    self.advertiser_nearby = advertiser_nearby
-    self.test_failure_reason = (
-        nc_constants.SingleTestFailureReason.UNINITIALIZED
-        )
-
-    self.connection_quality_info: nc_constants.ConnectionSetupQualityInfo = (
-        nc_constants.ConnectionSetupQualityInfo())
-
-    self._advertiser_connection_lifecycle_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_endpoint_discovery_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_connection_lifecycle_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._advertiser_payload_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_payload_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._advertiser_endpoint_id: str = None
-    self._discoverer_endpoint_id: str = None
-
-  def start_advertising(self) -> None:
-    """Starts Nearby Connection advertising."""
-    advertiser_callback = self.advertiser_nearby.startAdvertising(
-        self.advertiser.serial,
-        self.service_id,
-        self.advertising_discovery_medium.value,
-        self.upgrade_medium.value,
-    )
-    self.advertiser.log.info(
-        f'Start advertising {self.advertising_discovery_medium.name}'
-    )
-    self._advertiser_connection_lifecycle_callback = advertiser_callback
-
-  def start_discovery(self, timeout: datetime.timedelta) -> None:
-    """Starts Nearby Connection discovery."""
-    self.discoverer.log.info(
-        f'Start discovery {self.advertising_discovery_medium.name}'
-    )
-    self._discoverer_endpoint_discovery_callback = (
-        self.discoverer_nearby.startDiscovery(
-            self.service_id, self.advertising_discovery_medium.value
-        )
-    )
-
-    endpoint_found_event = (
-        self._discoverer_endpoint_discovery_callback.waitAndGet(
-            'onEndpointFound', timeout=timeout.total_seconds()
-        )
-    )
-    endpoint_info = endpoint_found_event.data['discoveredEndpointInfo']
-    self.connection_quality_info.discovery_latency = datetime.timedelta(
-        microseconds=endpoint_found_event.data['discoveryTimeNs'] / 1_000
-    )
-    asserts.assert_equal(
-        endpoint_info['endpointName'], self.advertiser.serial,
-        'Received an unexpected endpoint during discovery: '
-        f'{endpoint_found_event}')
-
-    asserts.assert_equal(
-        endpoint_info['serviceId'], self.service_id,
-        f'Received an unexpected service id during discovery: '
-        f'{endpoint_found_event}')
-    self._advertiser_endpoint_id = endpoint_found_event.data['endpointId']
-
-  def stop_advertising(self) -> None:
-    """Stops Nearby Connection advertising."""
-    self.advertiser_nearby.stopAdvertising()
-    self.advertiser.log.info('Stop advertising')
-
-  def stop_discovery(self) -> None:
-    """Stops Nearby Connection discovery."""
-    self.discoverer_nearby.stopDiscovery()
-    self.discoverer.log.info('Stop discovery')
-
-  def request_connection(
-      self,
-      medium_upgrade_type: nc_constants.MediumUpgradeType,
-      timeout: datetime.timedelta,
-      keep_alive_timeout_ms: int = nc_constants.KEEP_ALIVE_TIMEOUT_BT_MS,
-      keep_alive_interval_ms: int = nc_constants.KEEP_ALIVE_INTERVAL_BT_MS,
-  ) -> None:
-    """Requests Nearby Connection."""
-
-    self.discoverer.log.info(
-        'Start connection request with keep_alive_timeout_ms'
-        f' {keep_alive_timeout_ms}'
-    )
-    self._discoverer_connection_lifecycle_callback = (
-        self.discoverer_nearby.requestConnection(
-            self.discoverer.serial,
-            self._advertiser_endpoint_id,
-            self.connection_medium.value,
-            self.upgrade_medium.value,
-            medium_upgrade_type.value,
-            keep_alive_timeout_ms,
-            keep_alive_interval_ms,
-        )
-    )
-
-    d_connection_init_event = (
-        self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onConnectionInitiated', timeout.total_seconds()
-        )
-    )
-    self.connection_quality_info.connection_latency = datetime.timedelta(
-        microseconds=d_connection_init_event.data['connectionTimeNs'] / 1_000
-    )
-
-    d_connection_info = d_connection_init_event.data['connectionInfo']
-    asserts.assert_false(
-        d_connection_info['isIncomingConnection'],
-        f'Received an incoming connection: {d_connection_init_event}'
-        'but expected an outgoing connection')
-
-    asserts.assert_equal(
-        d_connection_info['endpointName'],
-        self.advertiser.serial,
-        f'Received an unexpected endpoint: {d_connection_init_event}')
-
-    # wait for the advertiser connection initialized.
-    a_connection_init_event = (
-        self._advertiser_connection_lifecycle_callback.waitAndGet(
-            'onConnectionInitiated', timeout=timeout.total_seconds()
-        )
-    )
-    a_connection_info = a_connection_init_event.data['connectionInfo']
-    asserts.assert_true(
-        a_connection_info['isIncomingConnection'],
-        f'Received an outgoing connection: {d_connection_init_event}'
-        'but expected an incoming connection')
-
-    asserts.assert_equal(
-        a_connection_info['endpointName'],
-        self.discoverer.serial,
-        f'Received an unexpected endpoint: {a_connection_init_event}')
-
-    self._discoverer_endpoint_id = a_connection_init_event.data['endpointId']
-
-  def accept_connection(
-      self, timeout: datetime.timedelta
-  ) -> None:
-    """Accepts Nearby Connection."""
-    self._advertiser_payload_callback = (
-        self.advertiser_nearby.acceptConnection(
-            self._discoverer_endpoint_id
-        )
-    )
-    self.advertiser.log.info('Start connection accept')
-    self._discoverer_payload_callback = (
-        self.discoverer_nearby.acceptConnection(
-            self._advertiser_endpoint_id
-        )
-    )
-    self.discoverer.log.info('Start connection accept')
-
-    advertiser_connection_event = (
-        self._advertiser_connection_lifecycle_callback.waitAndGet(
-            'onConnectionResult', timeout=timeout.total_seconds()
-        )
-    )
-
-    asserts.assert_true(
-        advertiser_connection_event.data['isSuccess'],
-        f'Received an unsuccessful event: {advertiser_connection_event}')
-
-    asserts.assert_equal(
-        advertiser_connection_event.data['endpointId'],
-        self._discoverer_endpoint_id,
-        f'Received an unexpected endpoint: {advertiser_connection_event}')
-
-    discoverer_connection_event = (
-        self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onConnectionResult', timeout=timeout.total_seconds()
-        )
-    )
-    asserts.assert_true(
-        discoverer_connection_event.data['isSuccess'],
-        f'Received an unsuccessful event: {discoverer_connection_event}')
-
-    asserts.assert_equal(
-        discoverer_connection_event.data['endpointId'],
-        self._advertiser_endpoint_id,
-        f'Received an unexpected endpoint: {discoverer_connection_event}')
-
-    if nc_constants.is_high_quality_medium(self.upgrade_medium):
-      self.test_failure_reason = (
-          nc_constants.SingleTestFailureReason.WIFI_MEDIUM_UPGRADE
-      )
-      upgrade_start_time = datetime.datetime.now()
-      wait_high_quality = True
-      while wait_high_quality:
-        discoverer_medium_upgrade_event = self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onBandwidthChanged',
-            nc_constants.CONNECTION_BANDWIDTH_CHANGED_TIMEOUT.total_seconds(),
-        )
-        self.discoverer.log.info(
-            f'medium upgrade to {discoverer_medium_upgrade_event.data}'
-        )
-        if discoverer_medium_upgrade_event.data['isHighBwQuality']:
-          wait_high_quality = False
-          self.connection_quality_info.medium_upgrade_latency = (
-              datetime.datetime.now() - upgrade_start_time)
-          self.connection_quality_info.upgrade_medium = (
-              nc_constants.NearbyConnectionMedium(
-                  discoverer_medium_upgrade_event.data['medium']))
-          self.connection_quality_info.medium_upgrade_expected = True
-          self.discoverer.log.info(
-              f'upgraded to high quality medium: '
-              f'{self.connection_quality_info.upgrade_medium.name}')
-        else:
-          latency = datetime.datetime.now() - upgrade_start_time
-          if latency >= nc_constants.CONNECTION_BANDWIDTH_CHANGED_TIMEOUT:
-            raise TimeoutError('medium upgrade timeout')
-
-  def disconnect_endpoint(self) -> None:
-    """Disconnects Nearby Connection endpoint."""
-    if self:
-      self.discoverer_nearby.disconnectFromEndpoint(
-          self._advertiser_endpoint_id
-      )
-      self.discoverer.log.info(
-          f'Start disconnecting from endpoint: {self._advertiser_endpoint_id}'
-      )
-    else:
-      self.discoverer.log.info('no nearby connecty setup yet')
-      return nc_constants.OpResult(nc_constants.Result.SUCCESS)
-
-    if self._discoverer_connection_lifecycle_callback is not None:
-      disconnected_event = (
-          self._discoverer_connection_lifecycle_callback.waitAndGet(
-              'onDisconnected',
-              timeout=nc_constants.DISCONNECTION_TIMEOUT.total_seconds(),
-          )
-      )
-      asserts.assert_equal(
-          disconnected_event.data['endpointId'],
-          self._advertiser_endpoint_id,
-          f'Receive unexpected event on disconnect: {disconnected_event}')
-    self.discoverer.log.info(
-        f'disconnected with endpoint: {self._advertiser_endpoint_id}'
-    )
-
-  def start_nearby_connection(
-      self,
-      timeouts: nc_constants.ConnectionSetupTimeouts,
-      medium_upgrade_type: nc_constants.MediumUpgradeType = nc_constants.MediumUpgradeType.DEFAULT,
-      keep_alive_timeout_ms: int = 0,
-      keep_alive_interval_ms: int = 0,
-  ) -> None:
-    """Starts Nearby Connection between two Android devices."""
-    self.test_failure_reason = (
-        nc_constants.SingleTestFailureReason.TARGET_START_ADVERTISING)
-    # Start advertising.
-    self.start_advertising()
-    # Add a random delay between adversting and discovery
-    # to mimic the random delay between two devices' user action
-    time.sleep(ADVERTISING_TO_DISCOVERY_MAX_DELAY_SEC * random.random())
-
-    self.test_failure_reason = (
-        nc_constants.SingleTestFailureReason.SOURCE_START_DISCOVERY)
-    # Start discovery.
-    self.start_discovery(timeout=timeouts.discovery_timeout)
-
-    # Request connection.
-    self.test_failure_reason = (
-        nc_constants.SingleTestFailureReason.SOURCE_REQUEST_CONNECTION)
-    self.request_connection(
-        medium_upgrade_type=medium_upgrade_type,
-        timeout=timeouts.connection_init_timeout,
-        keep_alive_timeout_ms=keep_alive_timeout_ms,
-        keep_alive_interval_ms=keep_alive_interval_ms)
-
-    # Stop discovery.
-    self.stop_discovery()
-
-    # Accept connection.
-    self.test_failure_reason = (
-        nc_constants.SingleTestFailureReason.TARGET_ACCEPT_CONNECTION)
-    self.accept_connection(timeout=timeouts.connection_result_timeout)
-
-    # Stop advertising.
-    self.stop_advertising()
-    self.test_failure_reason = nc_constants.SingleTestFailureReason.SUCCESS
-
-  def transfer_file(
-      self,
-      file_size_kb: int,
-      timeout: datetime.timedelta,
-      payload_type: nc_constants.PayloadType,
-  ) -> float:
-    """Sends payloads and returns the transfer speed in kBS."""
-    try:
-      self.test_failure_reason = (
-          nc_constants.SingleTestFailureReason.FILE_TRANSFER_FAIL
-      )
-      transfer_speed_kbs = self._transfer_file(
-          file_size_kb, timeout, payload_type
-      )
-      self.test_failure_reason = nc_constants.SingleTestFailureReason.SUCCESS
-    finally:
-      # clean up
-      utils.concurrent_exec(
-          lambda nb: nb.transferFilesCleanup(),
-          param_list=[[self.discoverer_nearby], [self.advertiser_nearby]],
-          raise_on_exception=True)
-    return transfer_speed_kbs
-
-  def _transfer_file(
-      self, file_size_kb: int, timeout: datetime.timedelta,
-      payload_type: nc_constants.PayloadType
-  ) -> float:
-    """Sends payloads and returns the transfer speed in kBS."""
-    # Creates a file and send it to the advertiser.
-    file_name = utils.rand_ascii_str(8)
-    self.discoverer.log.info(
-        f'Start sending payloads with type: {payload_type.name}'
-    )
-    payload_id = self.discoverer_nearby.sendPayloadWithType(
-        self._advertiser_endpoint_id, file_name, file_size_kb, payload_type
-    )
-
-    # Waits for the advertiser received.
-    def on_receive(event: callback_event.CallbackEvent) -> bool:
-      return (
-          event.data['endpointId'] == self._discoverer_endpoint_id
-          and event.data['payload']['id'] == payload_id
-      )
-
-    asserts.assert_is_not_none(
-        self._advertiser_payload_callback,
-        'No nearby connection is set up, advertiser payload cb is none.')
-    asserts.assert_is_not_none(
-        self._discoverer_payload_callback,
-        'No nearby connection is set up, discoverer payload cb is none.')
-
-    self._advertiser_payload_callback.waitForEvent(
-        'onPayloadReceived',
-        predicate=on_receive,
-        timeout=timeout.total_seconds())
-
-    # Waits for complete transfer.
-    self._advertiser_payload_callback.waitForEvent(
-        'onPayloadTransferUpdate',
-        predicate=lambda event: event.data['update']['isSuccess'],
-        timeout=timeout.total_seconds())
-
-    payload_transfer_event = self._discoverer_payload_callback.waitForEvent(
-        'onPayloadTransferUpdate',
-        predicate=lambda event: event.data['update']['isSuccess'],
-        timeout=timeout.total_seconds(),
-    )
-    self.advertiser.log.info('payload received')
-
-    transfer_time = datetime.timedelta(
-        microseconds=payload_transfer_event.data['transferTimeNs'] / 1_000)
-    return round(file_size_kb/transfer_time.total_seconds())
diff --git a/tests/bettertogether/betocq/setup_utils.py b/tests/bettertogether/betocq/setup_utils.py
deleted file mode 100644
index bd36d50f4..000000000
--- a/tests/bettertogether/betocq/setup_utils.py
+++ /dev/null
@@ -1,534 +0,0 @@
-#  Copyright (C) 2024 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Android Nearby device setup."""
-
-import base64
-import dataclasses
-import datetime
-import time
-from typing import Mapping
-
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import adb
-
-from betocq import gms_auto_updates_util
-from betocq import nc_constants
-
-WIFI_COUNTRYCODE_CONFIG_TIME_SEC = 3
-TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC = 2
-PH_FLAG_WRITE_WAIT_TIME_SEC = 3
-WIFI_DISCONNECTION_DELAY_SEC = 3
-ADB_RETRY_WAIT_TIME_SEC = 2
-
-_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC = 2
-
-
-read_ph_flag_failed = False
-
-LOG_TAGS = [
-    'Nearby',
-    'NearbyMessages',
-    'NearbyDiscovery',
-    'NearbyConnections',
-    'NearbyMediums',
-    'NearbySetup',
-]
-
-
-def set_country_code(
-    ad: android_device.AndroidDevice, country_code: str
-) -> None:
-  """Sets Wi-Fi and Telephony country code.
-
-  When you set the phone to EU or JP, the available 5GHz channels shrinks.
-  Some phones, like Pixel 2, can't use Wi-Fi Direct or Hotspot on 5GHz
-  in these countries. Pixel 3+ can, but only on some channels.
-  Not all of them. So, test Nearby Share or Nearby Connections without
-  Wi-Fi LAN to catch any bugs and make sure we don't break it later.
-
-  Args:
-    ad: AndroidDevice, Mobly Android Device.
-    country_code: WiFi and Telephony Country Code.
-  """
-  try:
-    _do_set_country_code(ad, country_code)
-  except adb.AdbError:
-    ad.log.exception(
-        f'Failed to set country code on device "{ad.serial}, try again.'
-    )
-    time.sleep(ADB_RETRY_WAIT_TIME_SEC)
-    _do_set_country_code(ad, country_code)
-
-
-def _do_set_country_code(
-    ad: android_device.AndroidDevice, country_code: str
-) -> None:
-  """Sets Wi-Fi and Telephony country code."""
-  if not ad.is_adb_root:
-    ad.log.info(
-        f'Skipped setting wifi country code on device "{ad.serial}" '
-        'because we do not set country code on unrooted phone.'
-    )
-    return
-
-  ad.log.info(f'Set Wi-Fi and Telephony country code to {country_code}.')
-  ad.adb.shell('cmd wifi set-wifi-enabled disabled')
-  time.sleep(WIFI_COUNTRYCODE_CONFIG_TIME_SEC)
-  ad.adb.shell(
-      'am broadcast -a com.android.internal.telephony.action.COUNTRY_OVERRIDE'
-      f' --es country {country_code}'
-  )
-  ad.adb.shell(f'cmd wifi force-country-code enabled {country_code}')
-  enable_airplane_mode(ad)
-  time.sleep(WIFI_COUNTRYCODE_CONFIG_TIME_SEC)
-  disable_airplane_mode(ad)
-  ad.adb.shell('cmd wifi set-wifi-enabled enabled')
-  telephony_country_code = (
-      ad.adb.shell('dumpsys wifi | grep mTelephonyCountryCode')
-      .decode('utf-8')
-      .strip()
-  )
-  ad.log.info(f'Telephony country code: {telephony_country_code}')
-
-
-def enable_logs(ad: android_device.AndroidDevice) -> None:
-  """Enables Nearby related logs."""
-  ad.log.info('Enable Nearby loggings.')
-  for tag in LOG_TAGS:
-    ad.adb.shell(f'setprop log.tag.{tag} VERBOSE')
-
-
-def grant_manage_external_storage_permission(
-    ad: android_device.AndroidDevice, package_name: str
-) -> None:
-  """Grants MANAGE_EXTERNAL_STORAGE permission to Nearby snippet."""
-  try:
-    _do_grant_manage_external_storage_permission(ad, package_name)
-  except adb.AdbError:
-    ad.log.exception(
-        'Failed to grant MANAGE_EXTERNAL_STORAGE permission on device'
-        f' "{ad.serial}", try again.'
-    )
-    time.sleep(ADB_RETRY_WAIT_TIME_SEC)
-    _do_grant_manage_external_storage_permission(ad, package_name)
-
-
-def _do_grant_manage_external_storage_permission(
-    ad: android_device.AndroidDevice, package_name: str
-) -> None:
-  """Grants MANAGE_EXTERNAL_STORAGE permission to Nearby snippet."""
-  build_version_sdk = int(ad.build_info['build_version_sdk'])
-  if build_version_sdk < 30:
-    return
-  ad.log.info(
-      f'Grant MANAGE_EXTERNAL_STORAGE permission on device "{ad.serial}".'
-  )
-  _grant_manage_external_storage_permission(ad, package_name)
-
-
-def dump_gms_version(ad: android_device.AndroidDevice) -> Mapping[str, str]:
-  """Dumps GMS version from dumpsys to sponge properties."""
-  try:
-    gms_version = _do_dump_gms_version(ad)
-  except adb.AdbError:
-    ad.log.exception(
-        f'Failed to dump GMS version on device "{ad.serial}", try again.'
-    )
-    time.sleep(ADB_RETRY_WAIT_TIME_SEC)
-    gms_version = _do_dump_gms_version(ad)
-  return gms_version
-
-
-def _do_dump_gms_version(ad: android_device.AndroidDevice) -> Mapping[str, str]:
-  """Dumps GMS version from dumpsys to sponge properties."""
-  out = (
-      ad.adb.shell(
-          'dumpsys package com.google.android.gms | grep "versionCode="'
-      )
-      .decode('utf-8')
-      .strip()
-  )
-  return {f'GMS core version on {ad.serial}': out}
-
-
-def toggle_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Toggles airplane mode on the given device."""
-  ad.log.info('turn on airplane mode')
-  enable_airplane_mode(ad)
-  ad.log.info('turn off airplane mode')
-  disable_airplane_mode(ad)
-
-
-def connect_to_wifi_sta_till_success(
-    ad: android_device.AndroidDevice, wifi_ssid: str, wifi_password: str
-) -> datetime.timedelta:
-  """Connecting to the specified wifi STA/AP."""
-  ad.log.info('Start connecting to wifi STA/AP')
-  wifi_connect_start = datetime.datetime.now()
-  if not wifi_password:
-    wifi_password = None
-  connect_to_wifi(ad, wifi_ssid, wifi_password)
-  return datetime.datetime.now() - wifi_connect_start
-
-
-def connect_to_wifi(
-    ad: android_device.AndroidDevice,
-    ssid: str,
-    password: str | None = None,
-) -> None:
-  if not ad.nearby.wifiIsEnabled():
-    ad.nearby.wifiEnable()
-  # return until the wifi is connected.
-  password = password or None
-  ad.log.info('Connect to wifi: ssid: %s, password: %s', ssid, password)
-  ad.nearby.wifiConnectSimple(ssid, password)
-
-
-def disconnect_from_wifi(ad: android_device.AndroidDevice) -> None:
-  if not ad.is_adb_root:
-    ad.log.info("Can't clear wifi network in non-rooted device")
-    return
-  ad.nearby.wifiClearConfiguredNetworks()
-  time.sleep(WIFI_DISCONNECTION_DELAY_SEC)
-
-
-def _grant_manage_external_storage_permission(
-    ad: android_device.AndroidDevice, package_name: str
-) -> None:
-  """Grants MANAGE_EXTERNAL_STORAGE permission to Nearby snippet.
-
-  This permission will not grant automatically by '-g' option of adb install,
-  you can check the all permission granted by:
-  am start -a android.settings.APPLICATION_DETAILS_SETTINGS
-           -d package:{YOUR_PACKAGE}
-
-  Reference for MANAGE_EXTERNAL_STORAGE:
-  https://developer.android.com/training/data-storage/manage-all-files
-
-  This permission will reset to default "Allow access to media only" after
-  reboot if you never grant "Allow management of all files" through system UI.
-  The appops command and MANAGE_EXTERNAL_STORAGE only available on API 30+.
-
-  Args:
-    ad: AndroidDevice, Mobly Android Device.
-    package_name: The nearbu snippet package name.
-  """
-  try:
-    ad.adb.shell(
-        f'appops set --uid {package_name} MANAGE_EXTERNAL_STORAGE allow'
-    )
-  except adb.Error:
-    ad.log.info('Failed to grant MANAGE_EXTERNAL_STORAGE permission.')
-
-
-def enable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Enables airplane mode on the given device."""
-  try:
-    _do_enable_airplane_mode(ad)
-  except adb.AdbError:
-    ad.log.exception(
-        f'Failed to enable airplane mode on device "{ad.serial}", try again.'
-    )
-    time.sleep(ADB_RETRY_WAIT_TIME_SEC)
-    _do_enable_airplane_mode(ad)
-
-
-def _do_enable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  if (ad.is_adb_root):
-    ad.adb.shell(['settings', 'put', 'global', 'airplane_mode_on', '1'])
-    ad.adb.shell([
-        'am', 'broadcast', '-a', 'android.intent.action.AIRPLANE_MODE', '--ez',
-        'state', 'true'
-    ])
-  ad.adb.shell(['svc', 'wifi', 'disable'])
-  ad.adb.shell(['svc', 'bluetooth', 'disable'])
-  time.sleep(TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC)
-
-
-def disable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Disables airplane mode on the given device."""
-  try:
-    _do_disable_airplane_mode(ad)
-  except adb.AdbError:
-    ad.log.exception(
-        f'Failed to disable airplane mode on device "{ad.serial}", try again.'
-    )
-    time.sleep(ADB_RETRY_WAIT_TIME_SEC)
-    _do_disable_airplane_mode(ad)
-
-
-def _do_disable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  if (ad.is_adb_root):
-    ad.adb.shell(['settings', 'put', 'global', 'airplane_mode_on', '0'])
-    ad.adb.shell([
-        'am', 'broadcast', '-a', 'android.intent.action.AIRPLANE_MODE', '--ez',
-        'state', 'false'
-    ])
-  ad.adb.shell(['svc', 'wifi', 'enable'])
-  ad.adb.shell(['svc', 'bluetooth', 'enable'])
-  time.sleep(TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC)
-
-
-def check_if_ph_flag_committed(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-) -> bool:
-  """Check if P/H flag is committed.
-
-  Some devices don't support to check the flag with sqlite3. After the flag
-  check fails for the first time, it won't try it again.
-
-  Args:
-    ad: AndroidDevice, Mobly Android Device.
-    pname: The package name of the P/H flag.
-    flag_name: The name of the P/H flag.
-
-  Returns:
-    True if the P/H flag is committed.
-  """
-  global read_ph_flag_failed
-  if read_ph_flag_failed:
-    return False
-  sql_str = (
-      'sqlite3 /data/data/com.google.android.gms/databases/phenotype.db'
-      ' "select name, quote(coalesce(intVal, boolVal, floatVal, stringVal,'
-      ' extensionVal)) from FlagOverrides where committed=1 AND'
-      f' packageName=\'{pname}\';"'
-  )
-  try:
-    flag_result = ad.adb.shell(sql_str).decode('utf-8').strip()
-    return flag_name in flag_result
-  except adb.AdbError:
-    read_ph_flag_failed = True
-    ad.log.exception('Failed to check PH flag')
-  return False
-
-
-def write_ph_flag(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-    flag_type: str,
-    flag_value: str,
-) -> None:
-  """Write P/H flag."""
-  ad.adb.shell(
-      'am broadcast -a "com.google.android.gms.phenotype.FLAG_OVERRIDE" '
-      f'--es package "{pname}" --es user "*" '
-      f'--esa flags "{flag_name}" '
-      f'--esa types "{flag_type}" --esa values "{flag_value}" '
-      'com.google.android.gms'
-  )
-  time.sleep(PH_FLAG_WRITE_WAIT_TIME_SEC)
-
-
-def check_and_try_to_write_ph_flag(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-    flag_type: str,
-    flag_value: str,
-) -> None:
-  """Check and try to enable the given flag on the given device."""
-  if(not ad.is_adb_root):
-    ad.log.info(
-        "Can't read or write P/H flag value in non-rooted device. Use Mobile"
-        ' Utility app to config instead.'
-    )
-    return
-
-  if check_if_ph_flag_committed(ad, pname, flag_name):
-    ad.log.info(f'{flag_name} is already committed.')
-    return
-  ad.log.info(f'write {flag_name}.')
-  write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  if check_if_ph_flag_committed(ad, pname, flag_name):
-    ad.log.info(f'{flag_name} is configured successfully.')
-  else:
-    ad.log.info(f'failed to configure {flag_name}.')
-
-
-def enable_bluetooth_multiplex(ad: android_device.AndroidDevice) -> None:
-  """Enable bluetooth multiplex on the given device."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'mediums_supports_bluetooth_multiplex_socket'
-  flag_type = 'boolean'
-  flag_value = 'true'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def enable_wifi_aware(ad: android_device.AndroidDevice) -> None:
-  """Enable wifi aware on the given device."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'mediums_supports_wifi_aware'
-  flag_type = 'boolean'
-  flag_value = 'true'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def enable_dfs_scc(ad: android_device.AndroidDevice) -> None:
-  """Enable WFD/WIFI_HOTSPOT in a STA-associated DFS channel."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'mediums_lower_dfs_channel_priority'
-  flag_type = 'boolean'
-  flag_value = 'false'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def disable_wlan_deny_list(ad: android_device.AndroidDevice) -> None:
-  """Enable WFD/WIFI_HOTSPOT in a STA-associated DFS channel."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'wifi_lan_blacklist_verify_bssid_interval_hours'
-  flag_type = 'long'
-  flag_value = '0'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  flag_name = 'mediums_wifi_lan_temporary_blacklist_verify_bssid_interval_hours'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def enable_ble_scan_throttling_during_2g_transfer(
-    ad: android_device.AndroidDevice, enable_ble_scan_throttling: bool = False
-) -> None:
-  """Enable BLE scan throttling during 2G transfer.
-  """
-
-  # The default values for the following parameters are 3 mins which are long
-  # enough for the performance test.
-  # mediums_ble_client_wifi_24_ghz_warming_up_duration
-  # fast_pair_wifi_24_ghz_warming_up_duration
-  # sharing_wifi_24_ghz_warming_up_duration
-
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'fast_pair_enable_connection_state_changed_listener'
-  flag_type = 'boolean'
-  flag_value = 'true' if enable_ble_scan_throttling else 'false'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  flag_name = 'sharing_enable_connection_state_changed_listener'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  flag_name = 'mediums_ble_client_enable_connection_state_changed_listener'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def disable_redaction(ad: android_device.AndroidDevice) -> None:
-  """Disable info log redaction on the given device."""
-  pname = 'com.google.android.gms'
-  flag_name = 'ClientLogging__enable_info_log_redaction'
-  flag_type = 'boolean'
-  flag_value = 'false'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def install_apk(ad: android_device.AndroidDevice, apk_path: str) -> None:
-  """Installs the apk on the given device."""
-  ad.adb.install(['-r', '-g', '-t', apk_path])
-
-
-def disable_gms_auto_updates(ad: android_device.AndroidDevice) -> None:
-  """Disable GMS auto updates on the given device."""
-  if not ad.is_adb_root:
-    ad.log.warning(
-        'You should disable the play store auto updates manually on a'
-        'unrooted device, otherwise the test may be broken unexpected')
-  ad.log.info('try to disable GMS Auto Updates.')
-  gms_auto_updates_util.GmsAutoUpdatesUtil(ad).disable_gms_auto_updates()
-  time.sleep(_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC)
-
-
-def enable_gms_auto_updates(ad: android_device.AndroidDevice) -> None:
-  """Enable GMS auto updates on the given device."""
-  if not ad.is_adb_root:
-    ad.log.warning(
-        'You may enable the play store auto updates manually on a'
-        'unrooted device after test.')
-  ad.log.info('try to enable GMS Auto Updates.')
-  gms_auto_updates_util.GmsAutoUpdatesUtil(ad).enable_gms_auto_updates()
-  time.sleep(_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC)
-
-
-def get_wifi_sta_frequency(ad: android_device.AndroidDevice) -> int:
-  """Get wifi STA frequency on the given device."""
-  wifi_sta_status = dump_wifi_sta_status(ad)
-  if not wifi_sta_status:
-    return nc_constants.INVALID_INT
-  prefix = 'Frequency:'
-  postfix = 'MHz'
-  return get_int_between_prefix_postfix(wifi_sta_status, prefix, postfix)
-
-
-def get_wifi_p2p_frequency(ad: android_device.AndroidDevice) -> int:
-  """Get wifi p2p frequency on the given device."""
-  wifi_p2p_status = dump_wifi_p2p_status(ad)
-  if not wifi_p2p_status:
-    return nc_constants.INVALID_INT
-  prefix = 'channelFrequency='
-  postfix = ', groupRole=GroupOwner'
-  return get_int_between_prefix_postfix(wifi_p2p_status, prefix, postfix)
-
-
-def get_wifi_sta_max_link_speed(ad: android_device.AndroidDevice) -> int:
-  """Get wifi STA max supported Tx link speed on the given device."""
-  wifi_sta_status = dump_wifi_sta_status(ad)
-  if not wifi_sta_status:
-    return nc_constants.INVALID_INT
-  prefix = 'Max Supported Tx Link speed:'
-  postfix = 'Mbps'
-  return get_int_between_prefix_postfix(wifi_sta_status, prefix, postfix)
-
-
-def get_int_between_prefix_postfix(
-    string: str, prefix: str, postfix: str
-) -> int:
-  left_index = string.rfind(prefix)
-  right_index = string.rfind(postfix)
-  if left_index > 0 and right_index > left_index:
-    try:
-      return int(string[left_index + len(prefix): right_index].strip())
-    except ValueError:
-      return nc_constants.INVALID_INT
-  return nc_constants.INVALID_INT
-
-
-def dump_wifi_sta_status(ad: android_device.AndroidDevice) -> str:
-  """Dumps wifi STA status on the given device."""
-  try:
-    return (
-        ad.adb.shell('cmd wifi status | grep WifiInfo').decode('utf-8').strip()
-    )
-  except adb.AdbError:
-    return ''
-
-
-def dump_wifi_p2p_status(ad: android_device.AndroidDevice) -> str:
-  """Dumps wifi p2p status on the given device."""
-  try:
-    return (
-        ad.adb.shell('dumpsys wifip2p').decode('utf-8').strip()
-    )
-  except adb.AdbError:
-    return ''
-
-
-def get_hardware(ad: android_device.AndroidDevice) -> str:
-  """Gets hardware information on the given device."""
-  return ad.adb.getprop('ro.hardware')
diff --git a/tests/bettertogether/quickstart/performance_test/Android.bp b/tests/bettertogether/quickstart/performance_test/Android.bp
deleted file mode 100644
index 7859456f1..000000000
--- a/tests/bettertogether/quickstart/performance_test/Android.bp
+++ /dev/null
@@ -1,171 +0,0 @@
-// Copyright (C) 2023 The Android Open Source Project
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//      http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-package {
-    default_team: "trendy_team_fwk_uwb",
-    default_applicable_licenses: ["Android-Apache-2.0"],
-}
-
-python_defaults {
-    name: "quick_start_perf_test_defaults",
-    pkg_path: "performance_test",
-}
-
-python_library_host {
-    name: "nc_constants",
-    defaults: ["quick_start_perf_test_defaults"],
-    srcs: [
-        "nc_constants.py",
-    ],
-    libs: [
-    ],
-}
-
-python_library_host {
-    name: "gms_auto_updates_util",
-    defaults: ["quick_start_perf_test_defaults"],
-    srcs: [
-        "gms_auto_updates_util.py",
-    ],
-    libs: [
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "setup_utils",
-    defaults: ["quick_start_perf_test_defaults"],
-    srcs: [
-        "setup_utils.py",
-    ],
-    libs: [
-        "gms_auto_updates_util",
-        "nc_constants",
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "nc_base_test",
-    defaults: ["quick_start_perf_test_defaults"],
-    srcs: [
-        "nc_base_test.py",
-    ],
-    libs: [
-        "nc_constants",
-        "setup_utils",
-        "mobly",
-    ],
-}
-
-python_library_host {
-    name: "nearby_connection_wrapper",
-    defaults: ["quick_start_perf_test_defaults"],
-    srcs: [
-        "nearby_connection_wrapper.py",
-    ],
-    libs: [
-        "nc_constants",
-        "setup_utils",
-        "mobly",
-    ],
-}
-
-python_test_host {
-    name: "quick_start_stress_test",
-    main: "quick_start_stress_test.py",
-    srcs: ["quick_start_stress_test.py"],
-    libs: [
-        "nc_constants",
-        "setup_utils",
-        "nearby_connection_wrapper",
-        "nc_base_test",
-        "mobly",
-    ],
-    test_suites: [],
-    test_options: {
-        unit_test: false, // as Mobly tests require device(s)
-        // This tag is used to enable the ATest Mobly runner
-        tags: ["mobly"],
-    },
-    data: [
-        "local_dev_testbed.yml",
-        // package the snippes for atest
-        ":nearby_snippet",
-        ":nearby_snippet_2",
-    ],
-    version: {
-        py3: {
-            embedded_launcher: false,
-        },
-    },
-}
-
-python_test_host {
-    name: "esim_transfer_stress_test",
-    main: "esim_transfer_stress_test.py",
-    srcs: ["esim_transfer_stress_test.py"],
-    libs: [
-        "nc_constants",
-        "setup_utils",
-        "nearby_connection_wrapper",
-        "nc_base_test",
-        "mobly",
-    ],
-    test_suites: [],
-    test_options: {
-        unit_test: false, // as Mobly tests require device(s)
-        // This tag is used to enable the ATest Mobly runner
-        tags: ["mobly"],
-    },
-    data: [
-        "local_esim_testbed.yml",
-        // package the snippes for atest
-        ":nearby_snippet",
-    ],
-    version: {
-        py3: {
-            embedded_launcher: false,
-        },
-    },
-}
-
-python_test_host {
-    name: "nearby_share_stress_test",
-    main: "nearby_share_stress_test.py",
-    srcs: ["nearby_share_stress_test.py"],
-    libs: [
-        "nc_constants",
-        "setup_utils",
-        "nearby_connection_wrapper",
-        "nc_base_test",
-        "mobly",
-    ],
-    test_suites: [],
-    test_options: {
-        unit_test: false, // as Mobly tests require device(s)
-        // This tag is used to enable the ATest Mobly runner
-        tags: ["mobly"],
-    },
-    data: [
-        "local_nearby_share_testbed.yml",
-        // package the snippes for atest
-        ":nearby_snippet",
-    ],
-    version: {
-        py3: {
-            embedded_launcher: false,
-        },
-    },
-}
diff --git a/tests/bettertogether/quickstart/performance_test/CHANGELOG.md b/tests/bettertogether/quickstart/performance_test/CHANGELOG.md
deleted file mode 100644
index 1e51c2886..000000000
--- a/tests/bettertogether/quickstart/performance_test/CHANGELOG.md
+++ /dev/null
@@ -1,18 +0,0 @@
-# Quickstart performance test suite release history
-
-## 1.6
-
-### New
-* `nearby_share_stress_test.py` for testing Nearby Share using Wifi only.
-
-### Fixes
-* Change discovery medium to BLE only.
-* Increase 1G file transfer timeout to 400s.
-* Disable GMS auto-updates for the duration of the test.
-
-## 1.5
-
-### New
-* `esim_transfer_stress_test.py` for testing eSIM transfer using Bluetooth only.
-* `quick_start_stress_test.py` for testing the Quickstart flow using both
-   Bluetooth and Wifi.
\ No newline at end of file
diff --git a/tests/bettertogether/quickstart/performance_test/esim_transfer_stress_test.py b/tests/bettertogether/quickstart/performance_test/esim_transfer_stress_test.py
deleted file mode 100644
index 1338dc7b9..000000000
--- a/tests/bettertogether/quickstart/performance_test/esim_transfer_stress_test.py
+++ /dev/null
@@ -1,250 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Esim transfer stress test, only use Bluetooth connection."""
-
-import dataclasses
-import datetime
-import logging
-import os
-import sys
-import time
-
-# check the python version
-if sys.version_info < (3,10):
-  logging.error('The test only can run on python 3.10 and above')
-  exit()
-
-from mobly import asserts
-from mobly import base_test
-from mobly import test_runner
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_performance_test_dir = os.path.dirname(os.path.dirname(__file__))
-if _performance_test_dir not in sys.path:
-  sys.path.append(_performance_test_dir)
-
-from performance_test import nc_base_test
-from performance_test import nc_constants
-from performance_test import nearby_connection_wrapper
-from performance_test import setup_utils
-
-_TEST_SCRIPT_VERSION = '1.6'
-
-_DELAY_BETWEEN_EACH_TEST_CYCLE = datetime.timedelta(seconds=5)
-_TRANSFER_FILE_SIZE_1MB = 1024
-
-_PERFORMANCE_TEST_REPEAT_COUNT = 100
-_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 5
-
-
-class EsimTransferStressTest(nc_base_test.NCBaseTestClass):
-  """Esim transfer stress test."""
-
-  @dataclasses.dataclass(frozen=False)
-  class EsimTransferTestMetrics:
-    """Metrics data for esim transfer test."""
-    discovery_latencies: list[datetime.timedelta] = dataclasses.field(
-        default_factory=list[datetime.timedelta])
-    connection_latencies: list[datetime.timedelta] = dataclasses.field(
-        default_factory=list[datetime.timedelta])
-    bt_transfer_throughputs_kbps: list[float] = dataclasses.field(
-        default_factory=list[float])
-
-  # @typing.override
-  def __init__(self, configs):
-    super().__init__(configs)
-    self._test_result = nc_constants.SingleTestResult()
-    self._esim_transfer_test_metrics = self.EsimTransferTestMetrics()
-    self._test_script_version = _TEST_SCRIPT_VERSION
-
-  # @typing.override
-  def setup_class(self):
-    super().setup_class()
-    self.performance_test_iterations = getattr(
-        self.test_esim_transfer_performance, base_test.ATTR_REPEAT_CNT)
-    logging.info('performance test iterations: %s',
-                 self.performance_test_iterations)
-
-  @base_test.repeat(
-      count=_PERFORMANCE_TEST_REPEAT_COUNT,
-      max_consecutive_error=_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR)
-  def test_esim_transfer_performance(self):
-    """Esim transfer stress test, which only transfer data through BT."""
-    try:
-      self._mimic_esim_transfer()
-    finally:
-      self._write_current_test_report()
-      self._collect_current_test_metrics()
-      time.sleep(_DELAY_BETWEEN_EACH_TEST_CYCLE.total_seconds())
-
-  def _mimic_esim_transfer(self):
-    if self.test_parameters.toggle_airplane_mode_target_side:
-      setup_utils.toggle_airplane_mode(self.advertiser)
-    if self.test_parameters.reset_wifi_connection:
-      self._reset_wifi_connection()
-    self._test_result = nc_constants.SingleTestResult()
-    # 1. connect to wifi
-    wifi_ssid = self.test_parameters.wifi_ssid
-    wifi_password = self.test_parameters.wifi_password
-    if wifi_ssid:
-      discoverer_wifi_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          self.discoverer, wifi_ssid, wifi_password
-      )
-      self.discoverer.log.info(
-          'connecting to wifi in '
-          f'{round(discoverer_wifi_latency.total_seconds())} s'
-      )
-      advertiser_wlan_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          self.advertiser, wifi_ssid, wifi_password)
-      self.advertiser.log.info(
-          'connecting to wifi in '
-          f'{round(advertiser_wlan_latency.total_seconds())} s')
-      self.advertiser.log.info(
-          self.advertiser.nearby.wifiGetConnectionInfo().get('mFrequency')
-      )
-
-    # 2. set up BT connection
-    advertising_discovery_medium = nc_constants.NearbyMedium(
-        self.test_parameters.advertising_discovery_medium
-    )
-    nearby_snippet_1 = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-    )
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-
-    try:
-      nearby_snippet_1.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_result.connection_setup_quality_info = (
-          nearby_snippet_1.connection_quality_info
-      )
-
-    # 3. transfer file through bluetooth
-    file_1_mb = _TRANSFER_FILE_SIZE_1MB
-    self._test_result.bt_transfer_throughput_kbps = (
-        nearby_snippet_1.transfer_file(
-            file_1_mb, nc_constants.FILE_1M_PAYLOAD_TRANSFER_TIMEOUT,
-            nc_constants.PayloadType.FILE))
-    # 4. disconnect
-    nearby_snippet_1.disconnect_endpoint()
-
-  def _write_current_test_report(self):
-    """Writes test report for each iteration."""
-
-    quality_info = {
-        'bt connection': (
-            self._test_result.connection_setup_quality_info.get_dict()),
-        'bt_kBps': self._test_result.bt_transfer_throughput_kbps,
-    }
-    test_report = {'quality_info': quality_info}
-
-    self.discoverer.log.info(test_report)
-    self.record_data({
-        'Test Class': self.TAG,
-        'Test Name': self.current_test_info.name,
-        'properties': test_report,
-    })
-
-  def _collect_current_test_metrics(self):
-    """Collects test result metrics for each iteration."""
-    self._esim_transfer_test_metrics.discovery_latencies.append(
-        self._test_result.connection_setup_quality_info.discovery_latency
-    )
-    self._esim_transfer_test_metrics.connection_latencies.append(
-        self._test_result.connection_setup_quality_info.connection_latency
-    )
-    self._esim_transfer_test_metrics.bt_transfer_throughputs_kbps.append(
-        self._test_result.bt_transfer_throughput_kbps
-    )
-
-  # @typing.override
-  def _summary_test_results(self):
-    """Summarizes test results of all iterations."""
-    bt_transfer_stats = self._stats_throughput_result(
-        'BT',
-        self._esim_transfer_test_metrics.bt_transfer_throughputs_kbps,
-        nc_constants.BT_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE,
-        self.test_parameters.bt_transfer_throughput_median_benchmark_kbps)
-
-    discovery_stats = self._stats_latency_result(
-        self._esim_transfer_test_metrics.discovery_latencies)
-    connection_stats = self._stats_latency_result(
-        self._esim_transfer_test_metrics.connection_latencies)
-
-    passed = True
-    result_message = 'Passed'
-    fail_message = ''
-    if bt_transfer_stats.fail_targets:
-      fail_message += self._generate_target_fail_message(
-          bt_transfer_stats.fail_targets)
-    if fail_message:
-      passed = False
-      result_message = 'Test Failed due to:\n' + fail_message
-
-    detailed_stats = {
-        '0 test iterations': self.performance_test_iterations,
-        '1 Completed BT transfer': f'{bt_transfer_stats.success_count}',
-        '2 BT transfer failures': {
-            '1 discovery': discovery_stats.failure_count,
-            '2 connection': connection_stats.failure_count,
-            '3 transfer': self.performance_test_iterations - (
-                bt_transfer_stats.success_count),
-        },
-        '3 50% and 95% of BT transfer speed (KBps)': (
-            f'{bt_transfer_stats.percentile_50_kbps}'
-            f' / {bt_transfer_stats.percentile_95_kbps}'),
-        '4 50% and 95% of discovery latency(sec)': (
-            f'{discovery_stats.percentile_50}'
-            f' / {discovery_stats.percentile_95}'),
-
-        '5 50% and 95% of connection latency(sec)': (
-            f'{connection_stats.percentile_50}'
-            f' / {connection_stats.percentile_95}'),
-    }
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'properties': {
-            'test_script_version': self._test_script_version,
-            '00_test_report_alias_name': (
-                self.test_parameters.test_report_alias_name),
-            '01_test_result': result_message,
-            '02_source_device_serial': self.discoverer.serial,
-            '03_target_device_serial': self.advertiser.serial,
-            '04_source_GMS_version': setup_utils.dump_gms_version(
-                self.discoverer),
-            '05_target_GMS_version': setup_utils.dump_gms_version(
-                self.advertiser),
-            '06_detailed_stats': detailed_stats
-            }
-        })
-
-    asserts.assert_true(passed, result_message)
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/quickstart/performance_test/gms_auto_updates_util.py b/tests/bettertogether/quickstart/performance_test/gms_auto_updates_util.py
deleted file mode 100644
index f65d7d92c..000000000
--- a/tests/bettertogether/quickstart/performance_test/gms_auto_updates_util.py
+++ /dev/null
@@ -1,177 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""class to enable/disable GMS auto update."""
-
-import logging
-import os
-import tempfile
-# from xml import etree has a problem, don't use it.
-from xml.etree import ElementTree
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import adb
-
-
-_FINSKY_CONFIG_FILE = '/data/data/com.android.vending/shared_prefs/finsky.xml'
-_FINSKY_CONFIG_NAME = 'auto_update_enabled'
-_FINSKY_CONFIG_VALUE_DISABLE = 'false'
-_FINSKY_CONFIG_VALUE_ENABLE = 'true'
-_VENDING_CONFIG_FILE = '/data/data/com.android.vending/shared_prefs/com.android.vending_preferences.xml'
-_VENDING_CONFIG_NAME = 'auto-update-mode'
-_VENDING_CONFIG_VALUE_DISABLE = 'AUTO_UPDATE_NEVER'
-_VENDING_CONFIG_VALUE_ENABLE = 'AUTO_UPDATE_WIFI'
-_BLANK_CONFIG = '<?xml version="1.0" encoding="utf-8"?><map></map>'
-_XML_BOOL_TYPE = 'boolean'
-_XML_STRING_TYPE = 'string'
-_ENABLE_GSERVICES_CMD_TEMPLATE = [
-    (
-        'am broadcast '
-        '-a com.google.gservices.intent.action.GSERVICES_OVERRIDE '
-        '-e finsky.play_services_auto_update_enabled {}'
-    ),
-    (
-        'am broadcast '
-        '-a com.google.gservices.intent.action.GSERVICES_OVERRIDE '
-        '-e finsky.setup_wizard_additional_account_vpa_enable {}'
-    ),
-]
-
-
-class GmsAutoUpdatesUtil:
-  """class to enable/disable GMS auto updates."""
-
-  def __init__(self, ad: android_device.AndroidDevice):
-    self._device: android_device.AndroidDevice = ad
-
-  def enable_gms_auto_updates(self) -> None:
-    self._config_gms_auto_updates(True)
-
-  def disable_gms_auto_updates(self) -> None:
-    self._config_gms_auto_updates(False)
-
-  def _config_gms_auto_updates(self, enable_updates: bool) -> None:
-    """Configures GMS auto updates."""
-    if not self._device.is_adb_root:
-      self._device.log.info(
-          f'failed to set the play store auto updates as {enable_updates}'
-          'you should enable/disable it manually on an unrooted device.')
-    else:
-      if enable_updates:
-        self._configure_play_store_updates(
-            _FINSKY_CONFIG_VALUE_ENABLE, _VENDING_CONFIG_VALUE_ENABLE
-        )
-      else:
-        self._configure_play_store_updates(
-            _FINSKY_CONFIG_VALUE_DISABLE, _VENDING_CONFIG_VALUE_DISABLE
-        )
-    self._configure_gservice_updates(enable_updates)
-
-  def _configure_gservice_updates(self, enable_updates: bool) -> None:
-    """Overwites Gservice to enable/disable updates."""
-    for cmd in _ENABLE_GSERVICES_CMD_TEMPLATE:
-      self._device.adb.shell(
-          cmd.format('true' if enable_updates else 'false')
-      )
-
-  def _create_or_update_play_store_config(
-      self,
-      tmp_dir: str,
-      value_type: str,
-      name: str,
-      value: str,
-      device_path: str,
-  ) -> str:
-    """Creates or updates a Play Store configuration file.
-
-    The function retrieves the Play Store configuration file from the device
-    then update it. If the file does not exist, it creates a new one.
-
-    Args:
-        tmp_dir: The temporary directory to store the configuration file.
-        value_type: The type of the configuration field.
-        name: The name of the configuration field.
-        value: The value of the configuration field.
-        device_path: The path to the configuration file on the device.
-
-    Returns:
-        The path to the updated configuration file.
-    """
-    path = os.path.join(tmp_dir, f'play_store_config_{name}.xml')
-    try:
-      self._device.adb.pull([device_path, path])
-    except adb.AdbError as e:
-      self._device.log.warning('failed to pull %s: %s', device_path, e)
-
-    config_doc = ElementTree.parse(path) if os.path.isfile(path) else None
-
-    changing_element = None
-    root = (
-        ElementTree.fromstring(_BLANK_CONFIG.encode())
-        if config_doc is None
-        else config_doc.getroot()
-    )
-
-    # find the element, xPath doesn't work as the name is a reserved word.
-    for child in root:
-      if child.attrib['name'] == name:
-        changing_element = child
-        break
-    if changing_element is None:
-      if value_type == _XML_BOOL_TYPE:
-        changing_element = ElementTree.SubElement(root, 'boolean')
-      else:
-        changing_element = ElementTree.SubElement(root, 'string')
-    logging.info('element for %s is %s, %s', name, changing_element.tag,
-                 changing_element.attrib)
-    if value_type == _XML_BOOL_TYPE:
-      changing_element.set('name', name)
-      changing_element.set('value', value)
-    else:
-      changing_element.attrib['name'] = name
-      changing_element.text = value
-
-    tree = ElementTree.ElementTree(root)
-    tree.write(path, xml_declaration=True, encoding='utf-8')
-    return path
-
-  def _configure_play_store_updates(
-      self, finsky_config_value: str, vending_config_value: str
-  ) -> None:
-    """Configures the Play Store update related settings."""
-    with tempfile.TemporaryDirectory() as tmp_dir:
-      finsky_config = self._create_or_update_play_store_config(
-          tmp_dir,
-          _XML_BOOL_TYPE,
-          _FINSKY_CONFIG_NAME,
-          finsky_config_value,
-          _FINSKY_CONFIG_FILE,
-      )
-      self._device.adb.push([finsky_config, _FINSKY_CONFIG_FILE])
-      try:
-        os.remove(finsky_config)
-      except OSError as e:
-        logging.warning('failed to remove %s: %s', finsky_config, e)
-
-      vending_config = self._create_or_update_play_store_config(
-          tmp_dir,
-          _XML_STRING_TYPE,
-          _VENDING_CONFIG_NAME,
-          vending_config_value,
-          _VENDING_CONFIG_FILE,
-      )
-      self._device.adb.push([vending_config, _VENDING_CONFIG_FILE])
-      try:
-        os.remove(vending_config)
-      except OSError as e:
-        logging.warning('failed to remove %s: %s', vending_config, e)
diff --git a/tests/bettertogether/quickstart/performance_test/local_dev_testbed.yml b/tests/bettertogether/quickstart/performance_test/local_dev_testbed.yml
deleted file mode 100644
index 6c26c45df..000000000
--- a/tests/bettertogether/quickstart/performance_test/local_dev_testbed.yml
+++ /dev/null
@@ -1,63 +0,0 @@
-x-test-params: &test-params
-  wifi_country_code: "US"
-  wifi_ssid: ""
-  wifi_password: ""
-  advertising_discovery_medium: 2 # 0 - auto, 2 - BLE_ONLY
-  target_post_wifi_connection_idle_time_sec: 10
-
-x-controllers: &controllers
-  Controllers:
-    AndroidDevice:
-      - serial: "123456ABCDEF"
-        role: "source_device"
-      - serial: "ABCDEF123456"
-        role: "target_device"
-
-TestBeds:
-- Name: LocalCustomizedTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-
-- Name: LocalUS2GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "US-2G"
-      wifi_ssid: "AP-2437"
-      wifi_password: "YOURPASSWORD"
-      bt_transfer_throughput_median_benchmark_kbps: 20
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
-
-- Name: LocalUS5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "US-5G"
-      wifi_ssid: "AP-5180"
-      wifi_password: "YOURPASSWORD"
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 20480
-
-- Name: LocalJP5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "JP-5G"
-      wifi_country_code: "JP"
-      wifi_ssid: "AP-5180"
-      wifi_password: "YOURPASSWORD"
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
-
-- Name: LocalGB5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "GB-5G"
-      wifi_country_code: "GB"
-      wifi_ssid: "AP-5260"
-      wifi_password: "YOURPASSWORD"
-      upgrade_medium: 7
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
diff --git a/tests/bettertogether/quickstart/performance_test/local_esim_testbed.yml b/tests/bettertogether/quickstart/performance_test/local_esim_testbed.yml
deleted file mode 100644
index c47e50aa6..000000000
--- a/tests/bettertogether/quickstart/performance_test/local_esim_testbed.yml
+++ /dev/null
@@ -1,36 +0,0 @@
-x-test-params: &test-params
-  wifi_ssid: ""
-  wifi_password: ""
-  advertising_discovery_medium: 2 # 0 - auto, 2 - BLE_ONLY
-
-x-controllers: &controllers
-  Controllers:
-    AndroidDevice:
-      - serial: "123456ABCDEF"
-        role: "source_device"
-      - serial: "ABCDEF123456"
-        role: "target_device"
-
-TestBeds:
-- Name: LocalCustomizedTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-
-- Name: Local2GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "Wi-Fi_2G"
-      wifi_ssid: "AP-2G"
-      wifi_password: "AP-2G"
-      bt_transfer_throughput_median_benchmark_kbps: 20
-
-- Name: Local5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "Wi-Fi_5G"
-      wifi_ssid: "AP-5G"
-      wifi_password: "AP-5G"
-      bt_transfer_throughput_median_benchmark_kbps: 40
diff --git a/tests/bettertogether/quickstart/performance_test/local_nearby_share_testbed.yml b/tests/bettertogether/quickstart/performance_test/local_nearby_share_testbed.yml
deleted file mode 100644
index 4cb465db4..000000000
--- a/tests/bettertogether/quickstart/performance_test/local_nearby_share_testbed.yml
+++ /dev/null
@@ -1,63 +0,0 @@
-x-test-params: &test-params
-  wifi_country_code: "US"
-  wifi_ssid: ""
-  wifi_password: ""
-  connection_medium: 1 # BT_ONLY = 1, BLE_ONLY = 2, BLE_L2CAP_ONLY = 8
-  upgrade_medium: 7 # WIFIAWARE_ONLY = 4, UPGRADE_TO_ALL_WIFI = 9, MEDIUM_UPGRADE_TO_WIFIDIRECT= 7
-  allow_unrooted_device: True
-
-x-controllers: &controllers
-  Controllers:
-    AndroidDevice:
-      - serial: "123456ABCDEF"
-        role: "source_device"
-      - serial: "ABCDEF123456"
-        role: "target_device"
-
-TestBeds:
-- Name: LocalCustomizedTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-
-- Name: LocalUS2GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "US-2G"
-      wifi_ssid: "AP-2437"
-      wifi_password: "AP-2437"
-      bt_transfer_throughput_median_benchmark_kbps: 20
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
-
-- Name: LocalUS5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "US-5G"
-      wifi_ssid: "AP-5180"
-      wifi_password: "AP-5180"
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 20480
-
-- Name: LocalJP5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "JP-5G"
-      wifi_country_code: "JP"
-      wifi_ssid: "AP-5180"
-      wifi_password: "AP-5180"
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
-
-- Name: LocalGB5GTestbed
-  <<: *controllers
-  TestParams:
-      <<: *test-params
-      test_report_alias_name: "GB-5G"
-      wifi_country_code: "GB"
-      wifi_ssid: "AP-5260"
-      wifi_password: "AP-5260"
-      bt_transfer_throughput_median_benchmark_kbps: 40
-      wifi_transfer_throughput_median_benchmark_kbps: 10240
diff --git a/tests/bettertogether/quickstart/performance_test/nc_base_test.py b/tests/bettertogether/quickstart/performance_test/nc_base_test.py
deleted file mode 100644
index 0d540413f..000000000
--- a/tests/bettertogether/quickstart/performance_test/nc_base_test.py
+++ /dev/null
@@ -1,326 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Mobly base test class for Neaby Connections."""
-
-import dataclasses
-import datetime
-import logging
-import time
-
-from mobly import asserts
-from mobly import base_test
-from mobly import records
-from mobly import utils
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import errors
-
-from performance_test import nc_constants
-from performance_test import setup_utils
-
-NEARBY_SNIPPET_PACKAGE_NAME = 'com.google.android.nearby.mobly.snippet'
-
-
-class NCBaseTestClass(base_test.BaseTestClass):
-  """Nearby Connection E2E tests."""
-
-  def __init__(self, configs):
-    super().__init__(configs)
-    self.ads: list[android_device.AndroidDevice] = []
-    self.advertiser: android_device.AndroidDevice = None
-    self.discoverer: android_device.AndroidDevice = None
-    self.test_parameters: nc_constants.TestParameters = None
-    self._test_script_version = None
-    self._nearby_snippet_apk_path: str = None
-    self.performance_test_iterations: int = 1
-    self.num_bug_reports: int = 0
-
-  def setup_class(self) -> None:
-    self.ads = self.register_controller(android_device, min_number=2)
-    self.test_parameters = self._get_test_parameter()
-    self._nearby_snippet_apk_path = self.user_params.get('files', {}).get(
-        'nearby_snippet', [''])[0]
-
-    # set run identifier property
-    self._set_run_identifier()
-
-    utils.concurrent_exec(
-        self._setup_android_device,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-    try:
-      self.discoverer = android_device.get_device(
-          self.ads, role='source_device'
-      )
-      self.advertiser = android_device.get_device(
-          self.ads, role='target_device'
-      )
-    except errors.Error:
-      logging.warning(
-          'The source,target devices are not specified in testbed;'
-          'The result may not be expected.'
-      )
-      self.advertiser, self.discoverer = self.ads
-
-  def _set_run_identifier(self) -> None:
-    """Set a run_identifier property describing the test run context."""
-    run_identifier = {}
-    run_identifier['test_version'] = self._test_script_version
-    run_identifier['alias'] = self.test_parameters.test_report_alias_name
-    run_identifier['devices'] = [
-        f'{ad.model}({ad.build_info["build_id"]})' for ad in self.ads
-    ]
-    run_identifier_str = ', '.join(
-        [f'{key}:{value}' for key, value in run_identifier.items()]
-    )
-    run_identifier_str = f'{{{run_identifier_str}}}'
-    self.record_data(
-        {'properties': {'run_identifier': run_identifier_str}}
-    )
-
-  def _disconnect_from_wifi(self, ad: android_device.AndroidDevice) -> None:
-    if not ad.is_adb_root:
-      ad.log.info("Can't clear wifi network in non-rooted device")
-      return
-    ad.nearby.wifiClearConfiguredNetworks()
-    time.sleep(nc_constants.WIFI_DISCONNECTION_DELAY.total_seconds())
-
-  def _setup_android_device(self, ad: android_device.AndroidDevice) -> None:
-    if not ad.is_adb_root:
-      if self.test_parameters.allow_unrooted_device:
-        ad.log.info('Unrooted device is detected. Test coverage is limited')
-      else:
-        asserts.skip('The test only can run on rooted device.')
-
-    setup_utils.disable_gms_auto_updates(ad)
-
-    ad.debug_tag = ad.serial + '(' + ad.adb.getprop('ro.product.model') + ')'
-    ad.log.info('try to install nearby_snippet_apk')
-    if self._nearby_snippet_apk_path:
-      setup_utils.install_apk(ad, self._nearby_snippet_apk_path)
-    else:
-      ad.log.warning(
-          'nearby_snippet apk is not specified, '
-          'make sure it is installed in the device'
-      )
-    ad.load_snippet('nearby', NEARBY_SNIPPET_PACKAGE_NAME)
-
-    ad.log.info('grant manage external storage permission')
-    setup_utils.grant_manage_external_storage_permission(
-        ad, NEARBY_SNIPPET_PACKAGE_NAME
-    )
-
-    if not ad.nearby.wifiIsEnabled():
-      ad.nearby.wifiEnable()
-    self._disconnect_from_wifi(ad)
-    setup_utils.enable_logs(ad)
-
-    setup_utils.disable_redaction(ad)
-
-    if (
-        self.test_parameters.upgrade_medium
-        == nc_constants.NearbyMedium.WIFIAWARE_ONLY.value
-    ):
-      setup_utils.enable_wifi_aware(ad)
-
-    if self.test_parameters.wifi_country_code:
-      setup_utils.set_country_code(
-          ad, self.test_parameters.wifi_country_code
-      )
-
-  def setup_test(self):
-    self._reset_nearby_connection()
-
-  def _reset_wifi_connection(self) -> None:
-    """Resets wifi connections on both devices."""
-    self.discoverer.nearby.wifiClearConfiguredNetworks()
-    self.advertiser.nearby.wifiClearConfiguredNetworks()
-    time.sleep(nc_constants.WIFI_DISCONNECTION_DELAY.total_seconds())
-
-  def _reset_nearby_connection(self) -> None:
-    """Resets nearby connection."""
-    self.discoverer.nearby.stopDiscovery()
-    self.discoverer.nearby.stopAllEndpoints()
-    self.advertiser.nearby.stopAdvertising()
-    self.advertiser.nearby.stopAllEndpoints()
-    time.sleep(nc_constants.NEARBY_RESET_WAIT_TIME.total_seconds())
-
-  def _teardown_device(self, ad: android_device.AndroidDevice) -> None:
-    ad.nearby.transferFilesCleanup()
-    setup_utils.enable_gms_auto_updates(ad)
-    if self.test_parameters.disconnect_wifi_after_test:
-      self._disconnect_from_wifi(ad)
-    ad.unload_snippet('nearby')
-
-  def teardown_test(self) -> None:
-    utils.concurrent_exec(
-        lambda d: d.services.create_output_excerpts_all(self.current_test_info),
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-
-  def teardown_class(self) -> None:
-    utils.concurrent_exec(
-        self._teardown_device,
-        param_list=[[ad] for ad in self.ads],
-        raise_on_exception=True,
-    )
-    # handle summary results
-    self._summary_test_results()
-
-  def _summary_test_results(self) -> None:
-    pass
-
-  def _get_test_parameter(self) -> nc_constants.TestParameters:
-    test_parameters_names = {
-        field.name for field in dataclasses.fields(nc_constants.TestParameters)
-    }
-    test_parameters = nc_constants.TestParameters(
-        **{
-            key: val
-            for key, val in self.user_params.items()
-            if key in test_parameters_names
-        }
-    )
-
-    return test_parameters
-
-  def on_fail(self, record: records.TestResultRecord) -> None:
-    self.num_bug_reports = self.num_bug_reports + 1
-    if (self.num_bug_reports <= nc_constants.MAX_NUM_BUG_REPORT):
-      logging.info('take bug report for failure')
-      android_device.take_bug_reports(
-          self.ads,
-          destination=self.current_test_info.output_path,
-    )
-
-  def _stats_throughput_result(
-      self,
-      medium_name: str,
-      throughput_indicators: list[float],
-      success_rate_target: float,
-      median_benchmark_kbps: float,
-  ) -> nc_constants.ThroughputResultStats:
-    """Statistics the throughput test result of all iterations."""
-    n = self.performance_test_iterations
-    filtered = [
-        x
-        for x in throughput_indicators
-        if x != nc_constants.UNSET_THROUGHPUT_KBPS
-    ]
-    if not filtered:
-      # all test cases are failed
-      return nc_constants.ThroughputResultStats(
-          success_rate=0.0,
-          average_kbps=0.0,
-          percentile_50_kbps=0.0,
-          percentile_95_kbps=0.0,
-          success_count=0,
-          fail_targets=[
-              nc_constants.FailTargetSummary(
-                  f'{medium_name} transfer success rate',
-                  0.0,
-                  success_rate_target,
-                  '%',
-              )
-          ],
-      )
-    # use the descenting order of the throughput
-    filtered.sort(reverse=True)
-    success_count = len(filtered)
-    success_rate = round(
-        success_count * 100.0 / n, nc_constants.SUCCESS_RATE_PRECISION_DIGITS
-    )
-    average_kbps = round(sum(filtered) / len(filtered))
-    percentile_50_kbps = filtered[
-        int(len(filtered) * nc_constants.PERCENTILE_50_FACTOR)
-    ]
-    percentile_95_kbps = filtered[
-        int(len(filtered) * nc_constants.PERCENTILE_95_FACTOR)
-    ]
-    fail_targets: list[nc_constants.FailTargetSummary] = []
-    if success_rate < success_rate_target:
-      fail_targets.append(
-          nc_constants.FailTargetSummary(
-              f'{medium_name} transfer success rate',
-              success_rate,
-              success_rate_target,
-              '%',
-          )
-      )
-    if percentile_50_kbps < median_benchmark_kbps:
-      fail_targets.append(
-          nc_constants.FailTargetSummary(
-              f'{medium_name} median transfer speed (KBps)',
-              percentile_50_kbps,
-              median_benchmark_kbps,
-          )
-      )
-    return nc_constants.ThroughputResultStats(
-        success_rate,
-        average_kbps,
-        percentile_50_kbps,
-        percentile_95_kbps,
-        success_count,
-        fail_targets,
-    )
-
-  def _stats_latency_result(
-      self, latency_indicators: list[datetime.timedelta]
-  ) -> nc_constants.LatencyResultStats:
-    n = self.performance_test_iterations
-    filtered = [
-        latency.total_seconds()
-        for latency in latency_indicators
-        if latency != nc_constants.UNSET_LATENCY
-    ]
-    if not filtered:
-      # All test cases are failed.
-      return nc_constants.LatencyResultStats(
-          average_latency=0.0,
-          percentile_50=0.0,
-          percentile_95=0.0,
-          failure_count=n,
-      )
-
-    filtered.sort()
-    average = (
-        round(
-            sum(filtered) / len(filtered), nc_constants.LATENCY_PRECISION_DIGITS
-        )
-        / n
-    )
-    percentile_50 = round(
-        filtered[int(len(filtered) * nc_constants.PERCENTILE_50_FACTOR)],
-        nc_constants.LATENCY_PRECISION_DIGITS,
-    )
-    percentile_95 = round(
-        filtered[int(len(filtered) * nc_constants.PERCENTILE_95_FACTOR)],
-        nc_constants.LATENCY_PRECISION_DIGITS,
-    )
-
-    return nc_constants.LatencyResultStats(
-        average, percentile_50, percentile_95, n - len(filtered)
-    )
-
-  def _generate_target_fail_message(
-      self, fail_targets: list[nc_constants.FailTargetSummary]
-  ) -> str:
-    return ''.join(
-        f'{fail_target.title}: {fail_target.actual}{fail_target.unit}'
-        f' < {fail_target.goal}{fail_target.unit}\n'
-        for fail_target in fail_targets
-    )
diff --git a/tests/bettertogether/quickstart/performance_test/nc_constants.py b/tests/bettertogether/quickstart/performance_test/nc_constants.py
deleted file mode 100644
index e4173bfc8..000000000
--- a/tests/bettertogether/quickstart/performance_test/nc_constants.py
+++ /dev/null
@@ -1,249 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Constants for Nearby Connection."""
-
-import dataclasses
-import datetime
-import enum
-
-NEARBY_RESET_WAIT_TIME = datetime.timedelta(seconds=5)
-WIFI_DISCONNECTION_DELAY = datetime.timedelta(seconds=3)
-
-FIRST_DISCOVERY_TIMEOUT = datetime.timedelta(seconds=30)
-FIRST_CONNECTION_INIT_TIMEOUT = datetime.timedelta(seconds=30)
-FIRST_CONNECTION_RESULT_TIMEOUT = datetime.timedelta(seconds=35)
-FILE_1M_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=110)
-SECOND_DISCOVERY_TIMEOUT = datetime.timedelta(seconds=35)
-SECOND_CONNECTION_INIT_TIMEOUT = datetime.timedelta(seconds=10)
-SECOND_CONNECTION_RESULT_TIMEOUT = datetime.timedelta(seconds=25)
-CONNECTION_BANDWIDTH_CHANGED_TIMEOUT = datetime.timedelta(seconds=25)
-FILE_1G_PAYLOAD_TRANSFER_TIMEOUT = datetime.timedelta(seconds=400)
-WIFI_WLAN_CONNECTING_TIME_OUT = datetime.timedelta(seconds=25)
-DISCONNECTION_TIMEOUT = datetime.timedelta(seconds=15)
-
-BT_TRANSFER_THROUGHPUT_MEDIAN_BENCHMARK_KBPS = 20  # 20KBps
-WIFI_TRANSFER_THROUGHPUT_MEDIAN_BENCHMARK_KBPS = 10240  # 10MBps
-BT_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE = 95  # 95%
-WIFI_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE = 95  # 95%
-
-KEEP_ALIVE_TIMEOUT_BT_MS = 30000
-KEEP_ALIVE_INTERVAL_BT_MS = 5000
-
-KEEP_ALIVE_TIMEOUT_WIFI_MS = 10000
-KEEP_ALIVE_INTERVAL_WIFI_MS = 3000
-
-PERCENTILE_50_FACTOR = 0.5
-PERCENTILE_95_FACTOR = 0.95
-LATENCY_PRECISION_DIGITS = 1
-SUCCESS_RATE_PRECISION_DIGITS = 1
-
-UNSET_LATENCY = datetime.timedelta.max
-UNSET_THROUGHPUT_KBPS = -1.0
-MAX_NUM_BUG_REPORT = 5
-TARGET_POST_WIFI_CONNECTION_IDLE_TIME_SEC = 0
-
-
-@enum.unique
-class PayloadType(enum.IntEnum):
-  FILE = 2
-  STREAM = 3
-
-
-@enum.unique
-class NearbyMedium(enum.IntEnum):
-  """Medium options for discovery, advertising, connection and upgrade."""
-
-  AUTO = 0
-  BT_ONLY = 1
-  BLE_ONLY = 2
-  WIFILAN_ONLY = 3
-  WIFIAWARE_ONLY = 4
-  UPGRADE_TO_WEBRTC = 5
-  UPGRADE_TO_WIFIHOTSPOT = 6
-  UPGRADE_TO_WIFIDIRECT = 7
-  BLE_L2CAP_ONLY = 8
-  # including WIFI_WLAN, WIFI_HOTSPOT, WIFI_DIRECT
-  UPGRADE_TO_ALL_WIFI = 9
-
-
-@dataclasses.dataclass(frozen=False)
-class TestParameters:
-  """Test parameters to be customized for Nearby Connection."""
-
-  test_report_alias_name: str = 'unspecified'
-  fast_fail_on_any_error: bool = False
-  wifi_country_code: str = ''
-  wifi_ssid: str = ''
-  wifi_password: str = ''
-  toggle_airplane_mode_target_side: bool = True
-  reset_wifi_connection: bool = True
-  disconnect_bt_after_test: bool = False
-  disconnect_wifi_after_test: bool = False
-  bt_transfer_throughput_median_benchmark_kbps: float = (
-      BT_TRANSFER_THROUGHPUT_MEDIAN_BENCHMARK_KBPS
-  )
-  wifi_transfer_throughput_median_benchmark_kbps: float = (
-      WIFI_TRANSFER_THROUGHPUT_MEDIAN_BENCHMARK_KBPS
-  )
-  payload_type: PayloadType = PayloadType.FILE
-  advertising_discovery_medium: int = NearbyMedium.BLE_ONLY
-  connection_medium: int = NearbyMedium.BT_ONLY
-  upgrade_medium: int = NearbyMedium.UPGRADE_TO_ALL_WIFI
-  allow_unrooted_device: bool = False
-  keep_alive_timeout_ms: int = KEEP_ALIVE_TIMEOUT_WIFI_MS
-  keep_alive_interval_ms: int = KEEP_ALIVE_INTERVAL_WIFI_MS
-  target_post_wifi_connection_idle_time_sec: int = (
-      TARGET_POST_WIFI_CONNECTION_IDLE_TIME_SEC
-  )
-
-
-@enum.unique
-class NearbyConnectionMedium(enum.IntEnum):
-  """The final connection medium selected, see BandWidthInfo.Medium."""
-  UNKNOWN = 0
-  # reserved 1, it's Medium.MDNS, not used now
-  BLUETOOTH = 2
-  WIFI_HOTSPOT = 3
-  BLE = 4
-  WIFI_LAN = 5
-  WIFI_AWARE = 6
-  NFC = 7
-  WIFI_DIRECT = 8
-  WEB_RTC = 9
-  # 10 is reserved.
-  USB = 11
-
-
-def is_high_quality_medium(medium: NearbyMedium) -> bool:
-  return medium in {
-      NearbyMedium.WIFILAN_ONLY,
-      NearbyMedium.WIFIAWARE_ONLY,
-      NearbyMedium.UPGRADE_TO_WEBRTC,
-      NearbyMedium.UPGRADE_TO_WIFIHOTSPOT,
-      NearbyMedium.UPGRADE_TO_WIFIDIRECT,
-      NearbyMedium.UPGRADE_TO_ALL_WIFI,
-  }
-
-
-@enum.unique
-class MediumUpgradeType(enum.IntEnum):
-  DEFAULT = 0
-  DISRUPTIVE = 1
-  NON_DISRUPTIVE = 2
-
-
-@dataclasses.dataclass(frozen=True)
-class ConnectionSetupTimeouts:
-  """The timeouts of the nearby connection setup."""
-  discovery_timeout: datetime.timedelta | None = None
-  connection_init_timeout: datetime.timedelta | None = None
-  connection_result_timeout: datetime.timedelta | None = None
-
-
-@dataclasses.dataclass(frozen=False)
-class ConnectionSetupQualityInfo:
-  """The quality information of the nearby connection setup."""
-  discovery_latency: datetime.timedelta = UNSET_LATENCY
-  connection_latency: datetime.timedelta = UNSET_LATENCY
-  medium_upgrade_latency: datetime.timedelta = UNSET_LATENCY
-  medium_upgrade_expected: bool = False
-  upgrade_medium: NearbyConnectionMedium | None = None
-
-  def get_dict(self):
-    dict_repr = {
-        'discovery': f'{round(self.discovery_latency.total_seconds(), 1)}s',
-        'connection': f'{round(self.connection_latency.total_seconds(), 1)}s'
-    }
-    if self.medium_upgrade_expected:
-      dict_repr['upgrade'] = (
-          f'{round(self.medium_upgrade_latency.total_seconds(), 1)}s'
-      )
-    if self.upgrade_medium:
-      dict_repr['medium'] = self.upgrade_medium.name
-    return dict_repr
-
-
-@dataclasses.dataclass(frozen=False)
-class SingleTestResult:
-  """The test result of a single iteration."""
-
-  connection_setup_quality_info: ConnectionSetupQualityInfo = (
-      dataclasses.field(default_factory=ConnectionSetupQualityInfo)
-  )
-  bt_transfer_throughput_kbps: float = UNSET_THROUGHPUT_KBPS
-  discoverer_wifi_wlan_latency: datetime.timedelta = UNSET_LATENCY
-  second_connection_setup_quality_info: ConnectionSetupQualityInfo = (
-      dataclasses.field(default_factory=ConnectionSetupQualityInfo)
-  )
-  wifi_transfer_throughput_kbps: float = UNSET_THROUGHPUT_KBPS
-  advertiser_wifi_wlan_latency: datetime.timedelta = UNSET_LATENCY
-  discoverer_wifi_wlan_expected: bool = False
-  advertiser_wifi_wlan_expected: bool = False
-
-
-@dataclasses.dataclass(frozen=True)
-class LatencyResultStats:
-  average_latency: float
-  percentile_50: float
-  percentile_95: float
-  failure_count: int
-
-
-@dataclasses.dataclass(frozen=True)
-class FailTargetSummary:
-  title: str = ''
-  actual: float = 0.0
-  goal: float = 0.0
-  unit: str = ''
-
-
-@dataclasses.dataclass(frozen=True)
-class ThroughputResultStats:
-  success_rate: float
-  average_kbps: float
-  percentile_50_kbps: float
-  percentile_95_kbps: float
-  success_count: int
-  fail_targets: list[FailTargetSummary] = dataclasses.field(
-      default_factory=list)
-
-
-@dataclasses.dataclass(frozen=False)
-class QuickStartTestMetrics:
-  """Metrics data for quick start test."""
-  first_discovery_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta])
-  first_connection_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta])
-  discoverer_wifi_wlan_latencies: list[
-      datetime.timedelta] = dataclasses.field(
-          default_factory=list[datetime.timedelta])
-  bt_transfer_throughputs_kbps: list[float] = dataclasses.field(
-      default_factory=list[float])
-  second_discovery_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta]
-  )
-  second_connection_latencies: list[datetime.timedelta] = dataclasses.field(
-      default_factory=list[datetime.timedelta])
-  medium_upgrade_latencies: list[
-      datetime.timedelta] = dataclasses.field(
-          default_factory=list[datetime.timedelta])
-  advertiser_wifi_wlan_latencies: list[
-      datetime.timedelta] = dataclasses.field(
-          default_factory=list[datetime.timedelta])
-  wifi_transfer_throughputs_kbps: list[float] = dataclasses.field(
-      default_factory=list[float])
-  upgraded_wifi_transfer_mediums: list[NearbyConnectionMedium] = (
-      dataclasses.field(default_factory=list[NearbyConnectionMedium]))
diff --git a/tests/bettertogether/quickstart/performance_test/nearby_connection_wrapper.py b/tests/bettertogether/quickstart/performance_test/nearby_connection_wrapper.py
deleted file mode 100644
index d9453eb56..000000000
--- a/tests/bettertogether/quickstart/performance_test/nearby_connection_wrapper.py
+++ /dev/null
@@ -1,399 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Utils for handling Nearby Connection rpc."""
-
-import datetime
-import random
-import time
-
-from mobly import asserts
-from mobly import utils
-from mobly.controllers import android_device
-from mobly.controllers.android_device_lib import callback_handler_v2
-from mobly.controllers.android_device_lib import snippet_client_v2
-from mobly.snippet import callback_event
-
-from performance_test import nc_constants
-
-# This number should be large enough to cover advertising interval, firmware
-# scheduling timing interval and user action delay
-ADVERTISING_TO_DISCOVERY_MAX_DELAY_SEC = 4
-
-
-class NearbyConnectionWrapper:
-  """Wrapper for Nearby Connection Snippet Client Operations."""
-
-  def __init__(
-      self,
-      advertiser: android_device.AndroidDevice,
-      discoverer: android_device.AndroidDevice,
-      advertiser_nearby: snippet_client_v2.SnippetClientV2,
-      discoverer_nearby: snippet_client_v2.SnippetClientV2,
-      advertising_discovery_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BLE_ONLY
-      ),
-      connection_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BT_ONLY
-      ),
-      upgrade_medium: nc_constants.NearbyMedium = (
-          nc_constants.NearbyMedium.BT_ONLY
-      ),
-  ):
-    self.advertiser = advertiser
-    self.discoverer = discoverer
-    self.service_id = utils.rand_ascii_str(8)
-    self.advertising_discovery_medium = advertising_discovery_medium
-    self.connection_medium = connection_medium
-    self.upgrade_medium = upgrade_medium
-    self.discoverer_nearby = discoverer_nearby
-    self.advertiser_nearby = advertiser_nearby
-
-    self.connection_quality_info: nc_constants.ConnectionSetupQualityInfo = (
-        nc_constants.ConnectionSetupQualityInfo())
-
-    self._advertiser_connection_lifecycle_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_endpoint_discovery_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_connection_lifecycle_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._advertiser_payload_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._discoverer_payload_callback: (
-        callback_handler_v2.CallbackHandlerV2) = None
-    self._advertiser_endpoint_id: str = None
-    self._discoverer_endpoint_id: str = None
-
-  def start_advertising(self) -> None:
-    """Starts Nearby Connection advertising."""
-    advertiser_callback = self.advertiser_nearby.startAdvertising(
-        self.advertiser.serial,
-        self.service_id,
-        self.advertising_discovery_medium.value,
-        self.upgrade_medium.value,
-    )
-    self.advertiser.log.info(
-        f'Start advertising {self.advertising_discovery_medium.value}'
-    )
-    self._advertiser_connection_lifecycle_callback = advertiser_callback
-    self._advertiser_endpoint_id = self.advertiser_nearby.getLocalEndpointId()
-
-  def start_discovery(
-      self, timeout: datetime.timedelta
-  ) -> None:
-    """Starts Nearby Connection discovery."""
-    self.discoverer.log.info(
-        f'Start discovery {self.advertising_discovery_medium.value}'
-    )
-    self._discoverer_endpoint_discovery_callback = (
-        self.discoverer_nearby.startDiscovery(
-            self.service_id, self.advertising_discovery_medium.value
-        )
-    )
-
-    endpoint_found_event = (
-        self._discoverer_endpoint_discovery_callback.waitAndGet(
-            'onEndpointFound', timeout=timeout.total_seconds()
-        )
-    )
-    endpoint_info = endpoint_found_event.data['discoveredEndpointInfo']
-    self.connection_quality_info.discovery_latency = datetime.timedelta(
-        microseconds=endpoint_found_event.data['discoveryTimeNs'] / 1_000
-    )
-    asserts.assert_equal(
-        endpoint_info['endpointName'], self.advertiser.serial,
-        'Received an unexpected endpoint during discovery: '
-        f'{endpoint_found_event}')
-
-    asserts.assert_equal(
-        endpoint_info['serviceId'], self.service_id,
-        f'Received an unexpected service id during discovery: '
-        f'{endpoint_found_event}')
-
-  def stop_advertising(self) -> None:
-    """Stops Nearby Connection advertising."""
-    self.advertiser_nearby.stopAdvertising()
-    self.advertiser.log.info('Stop advertising')
-
-  def stop_discovery(self) -> None:
-    """Stops Nearby Connection discovery."""
-    self.discoverer_nearby.stopDiscovery()
-    self.discoverer.log.info('Stop discovery')
-
-  def request_connection(
-      self,
-      medium_upgrade_type: nc_constants.MediumUpgradeType,
-      timeout: datetime.timedelta,
-      keep_alive_timeout_ms: int = nc_constants.KEEP_ALIVE_TIMEOUT_BT_MS,
-      keep_alive_interval_ms: int = nc_constants.KEEP_ALIVE_INTERVAL_BT_MS,
-  ) -> None:
-    """Requests Nearby Connection."""
-
-    self.discoverer.log.info(
-        'Start connection request with keep_alive_timeout_ms'
-        f' {keep_alive_timeout_ms}'
-    )
-    self._discoverer_connection_lifecycle_callback = (
-        self.discoverer_nearby.requestConnection(
-            self.discoverer.serial,
-            self._advertiser_endpoint_id,
-            self.connection_medium.value,
-            self.upgrade_medium.value,
-            medium_upgrade_type.value,
-            keep_alive_timeout_ms,
-            keep_alive_interval_ms,
-        )
-    )
-
-
-    d_connection_init_event = (
-        self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onConnectionInitiated', timeout.total_seconds()
-        )
-    )
-    self.connection_quality_info.connection_latency = datetime.timedelta(
-        microseconds=d_connection_init_event.data['connectionTimeNs'] / 1_000
-    )
-
-    d_connection_info = d_connection_init_event.data['connectionInfo']
-    asserts.assert_false(
-        d_connection_info['isIncomingConnection'],
-        f'Received an incoming connection: {d_connection_init_event}'
-        'but expected an outgoing connection')
-
-    asserts.assert_equal(
-        d_connection_info['endpointName'],
-        self.advertiser.serial,
-        f'Received an unexpected endpoint: {d_connection_init_event}')
-
-    self._discoverer_endpoint_id = self.discoverer_nearby.getLocalEndpointId()
-
-    # wait for the advertiser connection initialized.
-    a_connection_init_event = (
-        self._advertiser_connection_lifecycle_callback.waitAndGet(
-            'onConnectionInitiated', timeout=timeout.total_seconds()
-        )
-    )
-    a_connection_info = a_connection_init_event.data['connectionInfo']
-    asserts.assert_true(
-        a_connection_info['isIncomingConnection'],
-        f'Received an outgoing connection: {d_connection_init_event}'
-        'but expected an incoming connection')
-
-    asserts.assert_equal(
-        a_connection_info['endpointName'],
-        self.discoverer.serial,
-        f'Received an unexpected endpoint: {a_connection_init_event}')
-
-  def accept_connection(
-      self, timeout: datetime.timedelta
-  ) -> None:
-    """Accepts Nearby Connection."""
-    self._advertiser_payload_callback = (
-        self.advertiser_nearby.acceptConnection(
-            self._discoverer_endpoint_id
-        )
-    )
-    self.advertiser.log.info('Start connection accept')
-    self._discoverer_payload_callback = (
-        self.discoverer_nearby.acceptConnection(
-            self._advertiser_endpoint_id
-        )
-    )
-    self.discoverer.log.info('Start connection accept')
-
-    advertiser_connection_event = (
-        self._advertiser_connection_lifecycle_callback.waitAndGet(
-            'onConnectionResult', timeout=timeout.total_seconds()
-        )
-    )
-
-    asserts.assert_true(
-        advertiser_connection_event.data['isSuccess'],
-        f'Received an unsuccessful event: {advertiser_connection_event}')
-
-    asserts.assert_equal(
-        advertiser_connection_event.data['endpointId'],
-        self._discoverer_endpoint_id,
-        f'Received an unexpected endpoint: {advertiser_connection_event}')
-
-    discoverer_connection_event = (
-        self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onConnectionResult', timeout=timeout.total_seconds()
-        )
-    )
-    asserts.assert_true(
-        discoverer_connection_event.data['isSuccess'],
-        f'Received an unsuccessful event: {discoverer_connection_event}')
-
-    asserts.assert_equal(
-        discoverer_connection_event.data['endpointId'],
-        self._advertiser_endpoint_id,
-        f'Received an unexpected endpoint: {discoverer_connection_event}')
-
-    if nc_constants.is_high_quality_medium(self.upgrade_medium):
-      upgrade_start_time = datetime.datetime.now()
-      wait_high_quality = True
-      while wait_high_quality:
-        discoverer_medium_upgrade_event = self._discoverer_connection_lifecycle_callback.waitAndGet(
-            'onBandwidthChanged',
-            nc_constants.CONNECTION_BANDWIDTH_CHANGED_TIMEOUT.total_seconds(),
-        )
-        self.discoverer.log.info(
-            f'medium upgrade to {discoverer_medium_upgrade_event.data}'
-        )
-        if discoverer_medium_upgrade_event.data['isHighBwQuality']:
-          wait_high_quality = False
-          self.connection_quality_info.medium_upgrade_latency = (
-              datetime.datetime.now() - upgrade_start_time)
-          self.connection_quality_info.upgrade_medium = (
-              nc_constants.NearbyConnectionMedium(
-                  discoverer_medium_upgrade_event.data['medium']))
-          self.discoverer.log.info(
-              f'upgraded to high quality medium: '
-              f'{self.connection_quality_info.upgrade_medium.name}')
-        else:
-          latency = datetime.datetime.now() - upgrade_start_time
-          if latency >= nc_constants.CONNECTION_BANDWIDTH_CHANGED_TIMEOUT:
-            raise TimeoutError('medium upgrade timeout')
-
-  def disconnect_endpoint(self) -> None:
-    """Disconnects Nearby Connection endpoint."""
-    if self:
-      self.discoverer_nearby.disconnectFromEndpoint(
-          self._advertiser_endpoint_id
-      )
-      self.discoverer.log.info(
-          f'Start disconnecting from endpoint: {self._advertiser_endpoint_id}'
-      )
-    else:
-      self.discoverer.log.info('no nearby connecty setup yet')
-      return nc_constants.OpResult(nc_constants.Result.SUCCESS)
-
-    if self._discoverer_connection_lifecycle_callback is not None:
-      disconnected_event = (
-          self._discoverer_connection_lifecycle_callback.waitAndGet(
-              'onDisconnected',
-              timeout=nc_constants.DISCONNECTION_TIMEOUT.total_seconds(),
-          )
-      )
-      asserts.assert_equal(
-          disconnected_event.data['endpointId'],
-          self._advertiser_endpoint_id,
-          f'Receive unexpected event on disconnect: {disconnected_event}')
-    self.discoverer.log.info(
-        f'disconnected with endpoint: {self._advertiser_endpoint_id}'
-    )
-
-  def start_nearby_connection(
-      self,
-      timeouts: nc_constants.ConnectionSetupTimeouts,
-      medium_upgrade_type: nc_constants.MediumUpgradeType = nc_constants.MediumUpgradeType.DEFAULT,
-      keep_alive_timeout_ms: int = nc_constants.KEEP_ALIVE_TIMEOUT_BT_MS,
-      keep_alive_interval_ms: int = nc_constants.KEEP_ALIVE_INTERVAL_BT_MS,
-  ) -> None:
-    """Starts Nearby Connection between two Android devices."""
-
-    # Start advertising.
-    self.start_advertising()
-
-    # Add a random delay between adversting and discovery
-    # to mimic the random delay between two devices' user action
-    time.sleep(ADVERTISING_TO_DISCOVERY_MAX_DELAY_SEC * random.random())
-
-    # Start discovery.
-    self.start_discovery(timeout=timeouts.discovery_timeout)
-
-    # Request connection.
-    self.request_connection(
-        medium_upgrade_type=medium_upgrade_type,
-        timeout=timeouts.connection_init_timeout,
-        keep_alive_timeout_ms=keep_alive_timeout_ms,
-        keep_alive_interval_ms=keep_alive_interval_ms)
-
-    # Stop discovery.
-    self.stop_discovery()
-
-    # Accept connection.
-    self.accept_connection(timeout=timeouts.connection_result_timeout)
-
-    # Stop advertising.
-    self.stop_advertising()
-
-  def transfer_file(
-      self, file_size_kb: int, timeout: datetime.timedelta,
-      payload_type: nc_constants.PayloadType) -> float:
-    """Sends payloads and returns the transfer speed in kBS."""
-    try:
-      transfer_speed_kbs = self._transfer_file(
-          file_size_kb, timeout, payload_type
-      )
-    finally:
-      # clean up
-      utils.concurrent_exec(
-          lambda nb: nb.transferFilesCleanup(),
-          param_list=[[self.discoverer_nearby], [self.advertiser_nearby]],
-          raise_on_exception=True)
-    return transfer_speed_kbs
-
-  def _transfer_file(
-      self, file_size_kb: int, timeout: datetime.timedelta,
-      payload_type: nc_constants.PayloadType
-  ) -> float:
-    """Sends payloads and returns the transfer speed in kBS."""
-    # Creates a file and send it to the advertiser.
-    file_name = utils.rand_ascii_str(8)
-    self.discoverer.log.info(
-        f'Start sending payloads with type: {payload_type.name}'
-    )
-    payload_id = self.discoverer_nearby.sendPayloadWithType(
-        self._advertiser_endpoint_id, file_name, file_size_kb, payload_type
-    )
-
-    # Waits for the advertiser received.
-    def on_receive(event: callback_event.CallbackEvent) -> bool:
-      return (
-          event.data['endpointId'] == self._discoverer_endpoint_id
-          and event.data['payload']['id'] == payload_id
-      )
-
-    asserts.assert_is_not_none(
-        self._advertiser_payload_callback,
-        'No nearby connection is set up, advertiser payload cb is none.')
-    asserts.assert_is_not_none(
-        self._discoverer_payload_callback,
-        'No nearby connection is set up, discoverer payload cb is none.')
-
-    self._advertiser_payload_callback.waitForEvent(
-        'onPayloadReceived',
-        predicate=on_receive,
-        timeout=timeout.total_seconds())
-
-    # Waits for complete transfer.
-    self._advertiser_payload_callback.waitForEvent(
-        'onPayloadTransferUpdate',
-        predicate=lambda event: event.data['update']['isSuccess'],
-        timeout=timeout.total_seconds())
-
-    payload_transfer_event = self._discoverer_payload_callback.waitForEvent(
-        'onPayloadTransferUpdate',
-        predicate=lambda event: event.data['update']['isSuccess'],
-        timeout=timeout.total_seconds(),
-    )
-    self.advertiser.log.info('payload received')
-
-    transfer_time = datetime.timedelta(
-        microseconds=payload_transfer_event.data['transferTimeNs'] / 1_000)
-    return round(file_size_kb/transfer_time.total_seconds())
diff --git a/tests/bettertogether/quickstart/performance_test/nearby_share_stress_test.py b/tests/bettertogether/quickstart/performance_test/nearby_share_stress_test.py
deleted file mode 100644
index 5d1062c55..000000000
--- a/tests/bettertogether/quickstart/performance_test/nearby_share_stress_test.py
+++ /dev/null
@@ -1,270 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Stress tests for Neaby Share/Nearby Connection flow."""
-
-import dataclasses
-import datetime
-import logging
-import os
-import sys
-import time
-
-# check the python version
-if sys.version_info < (3,10):
-  logging.error('The test only can run on python 3.10 and above')
-  exit()
-
-from mobly import asserts
-from mobly import base_test
-from mobly import test_runner
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_performance_test_dir = os.path.dirname(os.path.dirname(__file__))
-if _performance_test_dir not in sys.path:
-  sys.path.append(_performance_test_dir)
-
-from performance_test import nc_base_test
-from performance_test import nc_constants
-from performance_test import nearby_connection_wrapper
-from performance_test import setup_utils
-
-_TEST_SCRIPT_VERSION = '1.6'
-
-_DELAY_BETWEEN_EACH_TEST_CYCLE = datetime.timedelta(seconds=5)
-_TRANSFER_FILE_SIZE_1GB = 1024 * 1024
-
-_PERFORMANCE_TEST_REPEAT_COUNT = 100
-_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 5
-
-
-class NearbyShareStressTest(nc_base_test.NCBaseTestClass):
-  """Nearby Share stress test."""
-
-  @dataclasses.dataclass(frozen=False)
-  class NearbyShareTestMetrics:
-    """Metrics data for Nearby Share test."""
-
-    discovery_latencies: list[datetime.timedelta] = dataclasses.field(
-        default_factory=list[datetime.timedelta]
-    )
-    connection_latencies: list[datetime.timedelta] = dataclasses.field(
-        default_factory=list[datetime.timedelta]
-    )
-    medium_upgrade_latencies: list[datetime.timedelta] = dataclasses.field(
-        default_factory=list[datetime.timedelta]
-    )
-    wifi_transfer_throughputs_kbps: list[float] = dataclasses.field(
-        default_factory=list[float]
-    )
-
-  # @typing.override
-  def __init__(self, configs):
-    super().__init__(configs)
-    self._test_result = nc_constants.SingleTestResult()
-    self._nearby_share_test_metrics = self.NearbyShareTestMetrics()
-    self._test_script_version = _TEST_SCRIPT_VERSION
-
-  # @typing.override
-  def setup_class(self):
-    super().setup_class()
-    wifi_ssid = self.test_parameters.wifi_ssid
-    wifi_password = self.test_parameters.wifi_password
-    if wifi_ssid:
-      discoverer_wifi_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          self.discoverer, wifi_ssid, wifi_password
-      )
-      self.discoverer.log.info(
-          'connecting to wifi in '
-          f'{round(discoverer_wifi_latency.total_seconds())} s'
-      )
-      advertiser_wlan_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          self.advertiser, wifi_ssid, wifi_password)
-      self.advertiser.log.info(
-          'connecting to wifi in '
-          f'{round(advertiser_wlan_latency.total_seconds())} s')
-      self.advertiser.log.info(
-          self.advertiser.nearby.wifiGetConnectionInfo().get('mFrequency')
-      )
-
-    self.performance_test_iterations = getattr(
-        self.test_nearby_share_performance, base_test.ATTR_REPEAT_CNT)
-    logging.info('performance test iterations: %s',
-                 self.performance_test_iterations)
-
-  @base_test.repeat(
-      count=_PERFORMANCE_TEST_REPEAT_COUNT,
-      max_consecutive_error=_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR)
-  def test_nearby_share_performance(self):
-    """Nearby Share stress test, which only transfer data through WiFi."""
-    try:
-      self._mimic_nearby_share()
-    finally:
-      self._write_current_test_report()
-      self._collect_current_test_metrics()
-      time.sleep(_DELAY_BETWEEN_EACH_TEST_CYCLE.total_seconds())
-
-  def _mimic_nearby_share(self):
-    """Mimics Nearby Share stress test, which only transfer data through WiFi."""
-    self._test_result = nc_constants.SingleTestResult()
-
-    # 1. set up BT and WiFi connection
-    advertising_discovery_medium = nc_constants.NearbyMedium(
-        self.test_parameters.advertising_discovery_medium
-    )
-    nearby_snippet_1 = nearby_connection_wrapper.NearbyConnectionWrapper(
-        self.advertiser,
-        self.discoverer,
-        self.advertiser.nearby,
-        self.discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium(
-            self.test_parameters.connection_medium
-        ),
-        upgrade_medium=nc_constants.NearbyMedium(
-            self.test_parameters.upgrade_medium
-        ),
-    )
-    connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-
-    try:
-      nearby_snippet_1.start_nearby_connection(
-          timeouts=connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_result.connection_setup_quality_info = (
-          nearby_snippet_1.connection_quality_info
-      )
-      self._test_result.connection_setup_quality_info.medium_upgrade_expected = (
-          True
-      )
-
-    # 2. transfer file through WiFi
-    file_1_gb = _TRANSFER_FILE_SIZE_1GB
-    self._test_result.wifi_transfer_throughput_kbps = (
-        nearby_snippet_1.transfer_file(
-            file_1_gb, nc_constants.FILE_1G_PAYLOAD_TRANSFER_TIMEOUT,
-            nc_constants.PayloadType.FILE))
-    # 3. disconnect
-    nearby_snippet_1.disconnect_endpoint()
-
-  def _write_current_test_report(self):
-    """Writes test report for each iteration."""
-
-    quality_info = {
-        'Latency (sec)': (
-            self._test_result.connection_setup_quality_info.get_dict()),
-        'Speed (kByte/sec)': self._test_result.wifi_transfer_throughput_kbps,
-    }
-    test_report = {'quality_info': quality_info}
-
-    self.discoverer.log.info(test_report)
-    self.record_data({
-        'Test Class': self.TAG,
-        'Test Name': self.current_test_info.name,
-        'properties': test_report,
-    })
-
-  def _collect_current_test_metrics(self):
-    """Collects test result metrics for each iteration."""
-    self._nearby_share_test_metrics.discovery_latencies.append(
-        self._test_result.connection_setup_quality_info.discovery_latency
-    )
-    self._nearby_share_test_metrics.connection_latencies.append(
-        self._test_result.connection_setup_quality_info.connection_latency
-    )
-    self._nearby_share_test_metrics.medium_upgrade_latencies.append(
-        self._test_result.connection_setup_quality_info.medium_upgrade_latency
-    )
-    self._nearby_share_test_metrics.wifi_transfer_throughputs_kbps.append(
-        self._test_result.wifi_transfer_throughput_kbps
-    )
-
-  # @typing.override
-  def _summary_test_results(self):
-    """Summarizes test results of all iterations."""
-    wifi_transfer_stats = self._stats_throughput_result(
-        'WiFi',
-        self._nearby_share_test_metrics.wifi_transfer_throughputs_kbps,
-        nc_constants.WIFI_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE,
-        self.test_parameters.wifi_transfer_throughput_median_benchmark_kbps)
-
-    discovery_stats = self._stats_latency_result(
-        self._nearby_share_test_metrics.discovery_latencies)
-    connection_stats = self._stats_latency_result(
-        self._nearby_share_test_metrics.connection_latencies)
-    medium_upgrade_stats = self._stats_latency_result(
-        self._nearby_share_test_metrics.medium_upgrade_latencies
-    )
-
-    passed = True
-    result_message = 'Passed'
-    fail_message = ''
-    if wifi_transfer_stats.fail_targets:
-      fail_message += self._generate_target_fail_message(
-          wifi_transfer_stats.fail_targets)
-    if fail_message:
-      passed = False
-      result_message = 'Test Failed due to:\n' + fail_message
-
-    detailed_stats = {
-        '0 test iterations': self.performance_test_iterations,
-        '1 Completed WiFi transfer': f'{wifi_transfer_stats.success_count}',
-        '2 failure counts': {
-            '1 discovery': discovery_stats.failure_count,
-            '2 connection': connection_stats.failure_count,
-            '3 upgrade': medium_upgrade_stats.failure_count,
-            '4 transfer': self.performance_test_iterations - (
-                wifi_transfer_stats.success_count),
-        },
-        '3 50% and 95% of WiFi transfer speed (KBps)': (
-            f'{wifi_transfer_stats.percentile_50_kbps}'
-            f' / {wifi_transfer_stats.percentile_95_kbps}'),
-        '4 50% and 95% of discovery latency(sec)': (
-            f'{discovery_stats.percentile_50}'
-            f' / {discovery_stats.percentile_95}'),
-        '5 50% and 95% of connection latency(sec)': (
-            f'{connection_stats.percentile_50}'
-            f' / {connection_stats.percentile_95}'),
-        '6 50% and 95% of upgrade latency(sec)': (
-            f'{medium_upgrade_stats.percentile_50}'
-            f' / {medium_upgrade_stats.percentile_95}'),
-    }
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'properties': {
-            'test_script_version': self._test_script_version,
-            '00_test_report_alias_name': (
-                self.test_parameters.test_report_alias_name),
-            '01_test_result': result_message,
-            '02_source_device_serial': self.discoverer.serial,
-            '03_target_device_serial': self.advertiser.serial,
-            '04_source_GMS_version': setup_utils.dump_gms_version(
-                self.discoverer),
-            '05_target_GMS_version': setup_utils.dump_gms_version(
-                self.advertiser),
-            '06_detailed_stats': detailed_stats
-            }
-        })
-
-    asserts.assert_true(passed, result_message)
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/quickstart/performance_test/quick_start_stress_test.py b/tests/bettertogether/quickstart/performance_test/quick_start_stress_test.py
deleted file mode 100644
index d3405fbe6..000000000
--- a/tests/bettertogether/quickstart/performance_test/quick_start_stress_test.py
+++ /dev/null
@@ -1,419 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Stress tests for Neaby Connections used by the quick start flow."""
-
-import datetime
-import logging
-import os
-import sys
-import time
-
-# check the python version
-if sys.version_info < (3,10):
-  logging.error('The test only can run on python 3.10 and above')
-  exit()
-
-from mobly import asserts
-from mobly import base_test
-from mobly import test_runner
-from mobly.controllers import android_device
-
-# Allows local imports to be resolved via relative path, so the test can be run
-# without building.
-_performance_test_dir = os.path.dirname(os.path.dirname(__file__))
-if _performance_test_dir not in sys.path:
-  sys.path.append(_performance_test_dir)
-
-from performance_test import nc_base_test
-from performance_test import nc_constants
-from performance_test import nearby_connection_wrapper
-from performance_test import setup_utils
-
-_TEST_SCRIPT_VERSION = '1.6'
-
-_NEARBY_SNIPPET_2_PACKAGE_NAME = 'com.google.android.nearby.mobly.snippet.second'
-
-_PERFORMANCE_TEST_REPEAT_COUNT = 100
-_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR = 5
-
-_DELAY_BETWEEN_EACH_TEST_CYCLE = datetime.timedelta(seconds=5)
-_TRANSFER_FILE_SIZE_1MB = 1024
-_TRANSFER_FILE_SIZE_1GB = 1024 * 1024
-
-
-class QuickStartStressTest(nc_base_test.NCBaseTestClass):
-  """Nearby Connection E2E stress tests for quick start flow."""
-
-  performance_test_iterations: int
-
-  # @typing.override
-  def __init__(self, configs):
-    super().__init__(configs)
-    self._nearby_snippet_2_apk_path: str = None
-    self._test_result: nc_constants.SingleTestResult = (
-        nc_constants.SingleTestResult())
-    self._quick_start_test_metrics: nc_constants.QuickStartTestMetrics = (
-        nc_constants.QuickStartTestMetrics())
-    self._test_script_version = _TEST_SCRIPT_VERSION
-
-  # @typing.override
-  def setup_test(self):
-    self.discoverer.nearby2.stopDiscovery()
-    self.discoverer.nearby2.stopAllEndpoints()
-    self.advertiser.nearby2.stopAdvertising()
-    self.advertiser.nearby2.stopAllEndpoints()
-
-    super().setup_test()
-
-  # @typing.override
-  def setup_class(self):
-    self._nearby_snippet_2_apk_path = self.user_params.get('files', {}).get(
-        'nearby_snippet_2', [''])[0]
-    self.performance_test_iterations = getattr(
-        self.test_quick_start_performance, base_test.ATTR_REPEAT_CNT)
-    logging.info('performance test iterations: %s',
-                 self.performance_test_iterations)
-
-    super().setup_class()
-
-  # @typing.override
-  def _setup_android_device(self, ad: android_device.AndroidDevice) -> None:
-    super()._setup_android_device(ad)
-    ad.log.info('try to install nearby_snippet_2_apk')
-    if self._nearby_snippet_2_apk_path:
-      setup_utils.install_apk(ad, self._nearby_snippet_2_apk_path)
-    else:
-      ad.log.warning('nearby_snippet_2 apk is not specified, '
-                     'make sure it is installed in the device')
-    ad.load_snippet('nearby2', _NEARBY_SNIPPET_2_PACKAGE_NAME)
-    setup_utils.grant_manage_external_storage_permission(
-        ad, _NEARBY_SNIPPET_2_PACKAGE_NAME
-    )
-
-    setup_utils.enable_bluetooth_multiplex(ad)
-
-
-  # @typing.override
-  def _teardown_device(self, ad: android_device.AndroidDevice) -> None:
-    super()._teardown_device(ad)
-    ad.nearby2.transferFilesCleanup()
-    ad.unload_snippet('nearby2')
-
-  @base_test.repeat(
-      count=_PERFORMANCE_TEST_REPEAT_COUNT,
-      max_consecutive_error=_PERFORMANCE_TEST_MAX_CONSECUTIVE_ERROR)
-  def test_quick_start_performance(self) -> None:
-    """Stress test for quick start flow."""
-    try:
-      self._mimic_quick_start_test(
-          self.discoverer,
-          self.advertiser,
-          wifi_ssid=self.test_parameters.wifi_ssid,
-          wifi_password=self.test_parameters.wifi_password,
-      )
-    finally:
-      self._write_current_test_report()
-      self._collect_current_test_metrics()
-      time.sleep(_DELAY_BETWEEN_EACH_TEST_CYCLE.total_seconds())
-
-  def _mimic_quick_start_test(
-      self,
-      discoverer,
-      advertiser,
-      wifi_ssid: str = '',
-      wifi_password: str = '',
-  ) -> None:
-    """Mimics quick start flow test with 2 nearby connections."""
-    if self.test_parameters.toggle_airplane_mode_target_side:
-      setup_utils.toggle_airplane_mode(self.advertiser)
-    if self.test_parameters.reset_wifi_connection:
-      self._reset_wifi_connection()
-    # 1. discoverer connect to wifi wlan
-    self._test_result = nc_constants.SingleTestResult()
-    if wifi_ssid:
-      discoverer_wifi_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          discoverer, wifi_ssid, wifi_password
-      )
-      discoverer.log.info(
-          'connecting to wifi in '
-          f'{round(discoverer_wifi_latency.total_seconds())} s'
-      )
-      self._test_result.discoverer_wifi_wlan_expected = True
-      self._test_result.discoverer_wifi_wlan_latency = discoverer_wifi_latency
-
-    # 2. set up 1st connection
-    advertising_discovery_medium = nc_constants.NearbyMedium(
-        self.test_parameters.advertising_discovery_medium
-    )
-    nearby_snippet_1 = nearby_connection_wrapper.NearbyConnectionWrapper(
-        advertiser,
-        discoverer,
-        advertiser.nearby,
-        discoverer.nearby,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium.BT_ONLY,
-    )
-    first_connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.FIRST_DISCOVERY_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_INIT_TIMEOUT,
-        nc_constants.FIRST_CONNECTION_RESULT_TIMEOUT)
-
-    try:
-      nearby_snippet_1.start_nearby_connection(
-          timeouts=first_connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.NON_DISRUPTIVE)
-    finally:
-      self._test_result.connection_setup_quality_info = (
-          nearby_snippet_1.connection_quality_info
-      )
-
-    # 3. transfer file through bluetooth
-    file_1_mb = _TRANSFER_FILE_SIZE_1MB
-    self._test_result.bt_transfer_throughput_kbps = (
-        nearby_snippet_1.transfer_file(
-            file_1_mb, nc_constants.FILE_1M_PAYLOAD_TRANSFER_TIMEOUT,
-            nc_constants.PayloadType.FILE))
-
-    # second Wifi connection and transfer
-    # 4. advertiser connect to wifi wlan
-    if wifi_ssid:
-      advertiser_wlan_latency = setup_utils.connect_to_wifi_wlan_till_success(
-          advertiser, wifi_ssid, wifi_password)
-      advertiser.log.info('connecting to wifi in '
-                          f'{round(advertiser_wlan_latency.total_seconds())} s')
-      advertiser.log.info(
-          advertiser.nearby.wifiGetConnectionInfo().get('mFrequency')
-      )
-      self._test_result.advertiser_wifi_wlan_expected = True
-      self._test_result.advertiser_wifi_wlan_latency = advertiser_wlan_latency
-      time.sleep(
-          self.test_parameters.target_post_wifi_connection_idle_time_sec
-      )
-
-    # 5. set up 2nd connection
-    nearby_snippet_2 = nearby_connection_wrapper.NearbyConnectionWrapper(
-        advertiser,
-        discoverer,
-        advertiser.nearby2,
-        discoverer.nearby2,
-        advertising_discovery_medium=advertising_discovery_medium,
-        connection_medium=nc_constants.NearbyMedium.BT_ONLY,
-        upgrade_medium=nc_constants.NearbyMedium(
-            self.test_parameters.upgrade_medium
-        ),
-    )
-    second_connection_setup_timeouts = nc_constants.ConnectionSetupTimeouts(
-        nc_constants.SECOND_DISCOVERY_TIMEOUT,
-        nc_constants.SECOND_CONNECTION_INIT_TIMEOUT,
-        nc_constants.SECOND_CONNECTION_RESULT_TIMEOUT)
-    try:
-      nearby_snippet_2.start_nearby_connection(
-          timeouts=second_connection_setup_timeouts,
-          medium_upgrade_type=nc_constants.MediumUpgradeType.DISRUPTIVE,
-          keep_alive_timeout_ms=self.test_parameters.keep_alive_timeout_ms,
-          keep_alive_interval_ms=self.test_parameters.keep_alive_interval_ms,
-      )
-    finally:
-      self._test_result.second_connection_setup_quality_info = (
-          nearby_snippet_2.connection_quality_info
-      )
-      self._test_result.second_connection_setup_quality_info.medium_upgrade_expected = (
-          True
-      )
-
-    # 6. transfer file through wifi
-    file_1_gb = _TRANSFER_FILE_SIZE_1GB
-    self._test_result.wifi_transfer_throughput_kbps = (
-        nearby_snippet_2.transfer_file(
-            file_1_gb, nc_constants.FILE_1G_PAYLOAD_TRANSFER_TIMEOUT,
-            self.test_parameters.payload_type))
-
-    # 7. disconnect 1st connection
-    nearby_snippet_1.disconnect_endpoint()
-    # 8. disconnect 2nd connection
-    nearby_snippet_2.disconnect_endpoint()
-
-  def _write_current_test_report(self) -> None:
-    """Writes test report for each iteration."""
-
-    quality_info = {
-        '1st connection': (
-            self._test_result.connection_setup_quality_info.get_dict()),
-        'bt_kBps': self._test_result.bt_transfer_throughput_kbps,
-        '2nd connection': (
-            self._test_result.second_connection_setup_quality_info.get_dict()),
-        'wifi_kBps': self._test_result.wifi_transfer_throughput_kbps,
-    }
-
-    if self._test_result.discoverer_wifi_wlan_expected:
-      quality_info['src_wifi_connection'] = str(
-          round(self._test_result.discoverer_wifi_wlan_latency.total_seconds())
-      )
-    if self._test_result.advertiser_wifi_wlan_expected:
-      quality_info['tgt_wifi_connection'] = str(
-          round(self._test_result.advertiser_wifi_wlan_latency.total_seconds())
-      )
-    test_report = {'quality_info': quality_info}
-
-    self.discoverer.log.info(test_report)
-    self.record_data({
-        'Test Class': self.TAG,
-        'Test Name': self.current_test_info.name,
-        'properties': test_report,
-    })
-
-  def _collect_current_test_metrics(self) -> None:
-    """Collects test result metrics for each iteration."""
-    self._quick_start_test_metrics.first_discovery_latencies.append(
-        self._test_result.connection_setup_quality_info.discovery_latency
-    )
-    self._quick_start_test_metrics.first_connection_latencies.append(
-        self._test_result.connection_setup_quality_info.connection_latency
-    )
-    self._quick_start_test_metrics.bt_transfer_throughputs_kbps.append(
-        self._test_result.bt_transfer_throughput_kbps
-    )
-
-    self._quick_start_test_metrics.second_discovery_latencies.append(
-        self._test_result.second_connection_setup_quality_info.discovery_latency
-    )
-    self._quick_start_test_metrics.second_connection_latencies.append(
-        self._test_result.second_connection_setup_quality_info.connection_latency
-    )
-    self._quick_start_test_metrics.medium_upgrade_latencies.append(
-        self._test_result.second_connection_setup_quality_info.medium_upgrade_latency
-    )
-    self._quick_start_test_metrics.upgraded_wifi_transfer_mediums.append(
-        self._test_result.second_connection_setup_quality_info.upgrade_medium)
-    self._quick_start_test_metrics.wifi_transfer_throughputs_kbps.append(
-        self._test_result.wifi_transfer_throughput_kbps
-    )
-    self._quick_start_test_metrics.discoverer_wifi_wlan_latencies.append(
-        self._test_result.discoverer_wifi_wlan_latency)
-    self._quick_start_test_metrics.advertiser_wifi_wlan_latencies.append(
-        self._test_result.advertiser_wifi_wlan_latency)
-
-  def _summary_upgraded_wifi_transfer_mediums(self) -> dict[str, int]:
-    medium_counts = {}
-    for (upgraded_medium
-         ) in self._quick_start_test_metrics.upgraded_wifi_transfer_mediums:
-      if upgraded_medium:
-        medium_counts[upgraded_medium.name] = medium_counts.get(
-            upgraded_medium.name, 0) + 1
-    return medium_counts
-
-  # @typing.override
-  def _summary_test_results(self) -> None:
-    """Summarizes test results of all iterations."""
-    first_bt_transfer_stats = self._stats_throughput_result(
-        'BT',
-        self._quick_start_test_metrics.bt_transfer_throughputs_kbps,
-        nc_constants.BT_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE,
-        self.test_parameters.bt_transfer_throughput_median_benchmark_kbps)
-
-    second_wifi_transfer_stats = self._stats_throughput_result(
-        'Wi-Fi',
-        self._quick_start_test_metrics.wifi_transfer_throughputs_kbps,
-        nc_constants.WIFI_TRANSFER_SUCCESS_RATE_TARGET_PERCENTAGE,
-        self.test_parameters.wifi_transfer_throughput_median_benchmark_kbps)
-
-    first_discovery_stats = self._stats_latency_result(
-        self._quick_start_test_metrics.first_discovery_latencies)
-    first_connection_stats = self._stats_latency_result(
-        self._quick_start_test_metrics.first_connection_latencies)
-    second_discovery_stats = self._stats_latency_result(
-        self._quick_start_test_metrics.second_discovery_latencies)
-    second_connection_stats = self._stats_latency_result(
-        self._quick_start_test_metrics.second_connection_latencies)
-    medium_upgrade_stats = self._stats_latency_result(
-        self._quick_start_test_metrics.medium_upgrade_latencies)
-
-    passed = True
-    result_message = 'Passed'
-    fail_message = ''
-    if first_bt_transfer_stats.fail_targets:
-      fail_message += self._generate_target_fail_message(
-          first_bt_transfer_stats.fail_targets)
-    if second_wifi_transfer_stats.fail_targets:
-      fail_message += self._generate_target_fail_message(
-          second_wifi_transfer_stats.fail_targets)
-    if fail_message:
-      passed = False
-      result_message = 'Test Failed due to:\n' + fail_message
-
-    detailed_stats = {
-        '0 test iterations': self.performance_test_iterations,
-        '1 Completed BT/Wi-Fi transfer': (
-            f'{first_bt_transfer_stats.success_count}'
-            f' / {second_wifi_transfer_stats.success_count}'),
-        '2 BT transfer failures': {
-            '1 discovery': first_discovery_stats.failure_count,
-            '2 connection': first_connection_stats.failure_count,
-            '3 transfer': self.performance_test_iterations - (
-                first_bt_transfer_stats.success_count),
-        },
-        '3 Wi-Fi transfer failures': {
-            '1 discovery': second_discovery_stats.failure_count,
-            '2 connection': second_connection_stats.failure_count,
-            '3 upgrade': medium_upgrade_stats.failure_count,
-            '4 transfer': self.performance_test_iterations - (
-                second_wifi_transfer_stats.success_count),
-        },
-        '4 Medium upgrade count': (
-            self._summary_upgraded_wifi_transfer_mediums()),
-        '5 50% and 95% of BT transfer speed (KBps)': (
-            f'{first_bt_transfer_stats.percentile_50_kbps}'
-            f' / {first_bt_transfer_stats.percentile_95_kbps}'),
-        '6 50% and 95% of Wi-Fi transfer speed(KBps)': (
-            f'{second_wifi_transfer_stats.percentile_50_kbps}'
-            f' / {second_wifi_transfer_stats.percentile_95_kbps}'),
-        '7 50% and 95% of discovery latency(sec)': (
-            f'{first_discovery_stats.percentile_50}'
-            f' / {first_discovery_stats.percentile_95} (1st), '
-            f'{second_discovery_stats.percentile_50}'
-            f' / {second_discovery_stats.percentile_95} (2nd)'),
-        '8 50% and 95% of connection latency(sec)': (
-            f'{first_connection_stats.percentile_50}'
-            f' / {first_connection_stats.percentile_95} (1st), '
-            f'{second_connection_stats.percentile_50}'
-            f' / {second_connection_stats.percentile_95} (2nd)'),
-        '9 50% and 95% of medium upgrade latency(sec)': (
-            f'{medium_upgrade_stats.percentile_50}'
-            f' / {medium_upgrade_stats.percentile_95}'),
-    }
-
-    self.record_data({
-        'Test Class': self.TAG,
-        'properties': {
-            'test_script_version': _TEST_SCRIPT_VERSION,
-            '00_test_report_alias_name': (
-                self.test_parameters.test_report_alias_name),
-            '01_test_result': result_message,
-            '02_source_device_serial': self.discoverer.serial,
-            '03_target_device_serial': self.advertiser.serial,
-            '04_source_GMS_version': setup_utils.dump_gms_version(
-                self.discoverer),
-            '05_target_GMS_version': setup_utils.dump_gms_version(
-                self.advertiser),
-            '06_detailed_stats': detailed_stats
-            }
-        })
-
-    asserts.assert_true(passed, result_message)
-
-
-if __name__ == '__main__':
-  test_runner.main()
diff --git a/tests/bettertogether/quickstart/performance_test/setup_utils.py b/tests/bettertogether/quickstart/performance_test/setup_utils.py
deleted file mode 100644
index 3e530f506..000000000
--- a/tests/bettertogether/quickstart/performance_test/setup_utils.py
+++ /dev/null
@@ -1,332 +0,0 @@
-#  Copyright (C) 2023 The Android Open Source Project
-#
-#  Licensed under the Apache License, Version 2.0 (the "License");
-#  you may not use this file except in compliance with the License.
-#  You may obtain a copy of the License at
-#
-#       http://www.apache.org/licenses/LICENSE-2.0
-#
-#  Unless required by applicable law or agreed to in writing, software
-#  distributed under the License is distributed on an "AS IS" BASIS,
-#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-#  See the License for the specific language governing permissions and
-#  limitations under the License.
-
-"""Android Nearby device setup."""
-
-import datetime
-import time
-from typing import Mapping
-
-from mobly.controllers import android_device
-
-from performance_test import gms_auto_updates_util
-
-WIFI_COUNTRYCODE_CONFIG_TIME_SEC = 3
-TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC = 2
-PH_FLAG_WRITE_WAIT_TIME_SEC = 3
-
-_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC = 2
-
-LOG_TAGS = [
-    'Nearby',
-    'NearbyMessages',
-    'NearbyDiscovery',
-    'NearbyConnections',
-    'NearbyMediums',
-    'NearbySetup',
-]
-
-
-def set_country_code(
-    ad: android_device.AndroidDevice, country_code: str
-) -> None:
-  """Sets Wi-Fi and Telephony country code.
-
-  When you set the phone to EU or JP, the available 5GHz channels shrinks.
-  Some phones, like Pixel 2, can't use Wi-Fi Direct or Hotspot on 5GHz
-  in these countries. Pixel 3+ can, but only on some channels.
-  Not all of them. So, test Nearby Share or Nearby Connections without
-  Wi-Fi LAN to catch any bugs and make sure we don't break it later.
-
-  Args:
-    ad: AndroidDevice, Mobly Android Device.
-    country_code: WiFi and Telephony Country Code.
-  """
-  if (not ad.is_adb_root):
-    ad.log.info(f'Skipped setting wifi country code on device "{ad.serial}" '
-                'because we do not set country code on unrooted phone.')
-    return
-
-  ad.log.info(f'Set Wi-Fi and Telephony country code to {country_code}.')
-  ad.adb.shell('cmd wifi set-wifi-enabled disabled')
-  time.sleep(WIFI_COUNTRYCODE_CONFIG_TIME_SEC)
-  ad.adb.shell(
-      'am broadcast -a com.android.internal.telephony.action.COUNTRY_OVERRIDE'
-      f' --es country {country_code}'
-  )
-  ad.adb.shell(f'cmd wifi force-country-code enabled {country_code}')
-  enable_airplane_mode(ad)
-  time.sleep(WIFI_COUNTRYCODE_CONFIG_TIME_SEC)
-  disable_airplane_mode(ad)
-  ad.adb.shell('cmd wifi set-wifi-enabled enabled')
-  telephony_country_code = (
-      ad.adb.shell('dumpsys wifi | grep mTelephonyCountryCode')
-      .decode('utf-8')
-      .strip()
-  )
-  ad.log.info(f'Telephony country code: {telephony_country_code}')
-
-
-def enable_logs(ad: android_device.AndroidDevice) -> None:
-  """Enables Nearby related logs."""
-  ad.log.info('Enable Nearby loggings.')
-  for tag in LOG_TAGS:
-    ad.adb.shell(f'setprop log.tag.{tag} VERBOSE')
-
-
-def grant_manage_external_storage_permission(
-    ad: android_device.AndroidDevice, package_name: str
-) -> None:
-  """Grants MANAGE_EXTERNAL_STORAGE permission to Nearby snippet."""
-  build_version_sdk = int(ad.build_info['build_version_sdk'])
-  if (build_version_sdk < 30):
-    return
-  ad.log.info(
-      f'Grant MANAGE_EXTERNAL_STORAGE permission on device "{ad.serial}".'
-  )
-  _grant_manage_external_storage_permission(ad, package_name)
-
-
-def dump_gms_version(ad: android_device.AndroidDevice) -> Mapping[str, str]:
-  """Dumps GMS version from dumpsys to sponge properties."""
-  out = (
-      ad.adb.shell(
-          'dumpsys package com.google.android.gms | grep "versionCode="'
-      )
-      .decode('utf-8')
-      .strip()
-  )
-  return {f'GMS core version on {ad.serial}': out}
-
-
-def toggle_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Toggles airplane mode on the given device."""
-  ad.log.info('turn on airplane mode')
-  enable_airplane_mode(ad)
-  ad.log.info('turn off airplane mode')
-  disable_airplane_mode(ad)
-
-
-def connect_to_wifi_wlan_till_success(
-    ad: android_device.AndroidDevice, wifi_ssid: str, wifi_password: str
-) -> datetime.timedelta:
-  """Connecting to the specified wifi WLAN."""
-  ad.log.info('Start connecting to wifi WLAN')
-  wifi_connect_start = datetime.datetime.now()
-  if not wifi_password:
-    wifi_password = None
-  connect_to_wifi(ad, wifi_ssid, wifi_password)
-  return datetime.datetime.now() - wifi_connect_start
-
-
-def connect_to_wifi(
-    ad: android_device.AndroidDevice,
-    ssid: str,
-    password: str | None = None,
-) -> None:
-  if not ad.nearby.wifiIsEnabled():
-    ad.nearby.wifiEnable()
-  # return until the wifi is connected.
-  ad.nearby.wifiConnectSimple(ssid, password)
-
-
-def _grant_manage_external_storage_permission(
-    ad: android_device.AndroidDevice, package_name: str
-) -> None:
-  """Grants MANAGE_EXTERNAL_STORAGE permission to Nearby snippet.
-
-  This permission will not grant automatically by '-g' option of adb install,
-  you can check the all permission granted by:
-  am start -a android.settings.APPLICATION_DETAILS_SETTINGS
-           -d package:{YOUR_PACKAGE}
-
-  Reference for MANAGE_EXTERNAL_STORAGE:
-  https://developer.android.com/training/data-storage/manage-all-files
-
-  This permission will reset to default "Allow access to media only" after
-  reboot if you never grant "Allow management of all files" through system UI.
-  The appops command and MANAGE_EXTERNAL_STORAGE only available on API 30+.
-
-  Args:
-    ad: AndroidDevice, Mobly Android Device.
-    package_name: The nearbu snippet package name.
-  """
-  try:
-    ad.adb.shell(
-        f'appops set --uid {package_name} MANAGE_EXTERNAL_STORAGE allow'
-    )
-  except Exception:
-    ad.log.info('Failed to grant MANAGE_EXTERNAL_STORAGE permission.')
-
-
-def enable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Enables airplane mode on the given device."""
-  if (ad.is_adb_root):
-    ad.adb.shell(['settings', 'put', 'global', 'airplane_mode_on', '1'])
-    ad.adb.shell([
-        'am', 'broadcast', '-a', 'android.intent.action.AIRPLANE_MODE', '--ez',
-        'state', 'true'
-    ])
-  ad.adb.shell(['svc', 'wifi', 'disable'])
-  ad.adb.shell(['svc', 'bluetooth', 'disable'])
-  time.sleep(TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC)
-
-
-def disable_airplane_mode(ad: android_device.AndroidDevice) -> None:
-  """Disables airplane mode on the given device."""
-  if (ad.is_adb_root):
-    ad.adb.shell(['settings', 'put', 'global', 'airplane_mode_on', '0'])
-    ad.adb.shell([
-        'am', 'broadcast', '-a', 'android.intent.action.AIRPLANE_MODE', '--ez',
-        'state', 'false'
-    ])
-  ad.adb.shell(['svc', 'wifi', 'enable'])
-  ad.adb.shell(['svc', 'bluetooth', 'enable'])
-  time.sleep(TOGGLE_AIRPLANE_MODE_WAIT_TIME_SEC)
-
-
-def check_if_ph_flag_committed(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-) -> bool:
-  """Check if P/H flag is committed."""
-  sql_str = (
-      'sqlite3 /data/data/com.google.android.gms/databases/phenotype.db'
-      ' "select name, quote(coalesce(intVal, boolVal, floatVal, stringVal,'
-      ' extensionVal)) from FlagOverrides where committed=1 AND'
-      f' packageName=\'{pname}\';"'
-  )
-  flag_result = ad.adb.shell(sql_str).decode('utf-8').strip()
-  return flag_name in flag_result
-
-
-def write_ph_flag(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-    flag_type: str,
-    flag_value: str,
-) -> None:
-  """Write P/H flag."""
-  ad.adb.shell(
-      'am broadcast -a "com.google.android.gms.phenotype.FLAG_OVERRIDE" '
-      f'--es package "{pname}" --es user "*" '
-      f'--esa flags "{flag_name}" '
-      f'--esa types "{flag_type}" --esa values "{flag_value}" '
-      'com.google.android.gms'
-  )
-  time.sleep(PH_FLAG_WRITE_WAIT_TIME_SEC)
-
-
-def check_and_try_to_write_ph_flag(
-    ad: android_device.AndroidDevice,
-    pname: str,
-    flag_name: str,
-    flag_type: str,
-    flag_value: str,
-) -> None:
-  """Check and try to enable the given flag on the given device."""
-  if(not ad.is_adb_root):
-    ad.log.info(
-        "Can't read or write P/H flag value in non-rooted device. Use Mobile"
-        ' Utility app to config instead.'
-    )
-    return
-
-  if check_if_ph_flag_committed(ad, pname, flag_name):
-    ad.log.info(f'{flag_name} is already committed.')
-    return
-  ad.log.info(f'write {flag_name}.')
-  write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  if check_if_ph_flag_committed(ad, pname, flag_name):
-    ad.log.info(f'{flag_name} is configured successfully.')
-  else:
-    ad.log.info(f'failed to configure {flag_name}.')
-
-
-def enable_bluetooth_multiplex(ad: android_device.AndroidDevice) -> None:
-  """Enable bluetooth multiplex on the given device."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'mediums_supports_bluetooth_multiplex_socket'
-  flag_type = 'boolean'
-  flag_value = 'true'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def enable_wifi_aware(ad: android_device.AndroidDevice) -> None:
-  """Enable wifi aware on the given device."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'mediums_supports_wifi_aware'
-  flag_type = 'boolean'
-  flag_value = 'true'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def enable_auto_reconnect(ad: android_device.AndroidDevice) -> None:
-  """Enable auto reconnect on the given device."""
-  pname = 'com.google.android.gms.nearby'
-  flag_name = 'connection_safe_to_disconnect_auto_reconnect_enabled'
-  flag_type = 'boolean'
-  flag_value = 'true'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  flag_name = 'connection_safe_to_disconnect_auto_resume_enabled'
-  flag_type = 'boolean'
-  flag_value = 'true'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-  flag_name = 'connection_safe_to_disconnect_version'
-  flag_type = 'long'
-  flag_value = '4'
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def disable_redaction(ad: android_device.AndroidDevice) -> None:
-  """Disable info log redaction on the given device."""
-  pname = 'com.google.android.gms'
-  flag_name = 'ClientLogging__enable_info_log_redaction'
-  flag_type = 'boolean'
-  flag_value = 'false'
-
-  check_and_try_to_write_ph_flag(ad, pname, flag_name, flag_type, flag_value)
-
-
-def install_apk(ad: android_device.AndroidDevice, apk_path: str) -> None:
-  """Installs the apk on the given device."""
-  ad.adb.install(['-r', '-g', '-t', apk_path])
-
-
-def disable_gms_auto_updates(ad: android_device.AndroidDevice) -> None:
-  """Disable GMS auto updates on the given device."""
-  if not ad.is_adb_root:
-    ad.log.warning(
-        'You should disable the play store auto updates manually on a'
-        'unrooted device, otherwise the test may be broken unexpected')
-  ad.log.info('try to disable GMS Auto Updates.')
-  gms_auto_updates_util.GmsAutoUpdatesUtil(ad).disable_gms_auto_updates()
-  time.sleep(_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC)
-
-
-def enable_gms_auto_updates(ad: android_device.AndroidDevice) -> None:
-  """Enable GMS auto updates on the given device."""
-  if not ad.is_adb_root:
-    ad.log.warning(
-        'You may enable the play store auto updates manually on a'
-        'unrooted device after test.')
-  ad.log.info('try to enable GMS Auto Updates.')
-  gms_auto_updates_util.GmsAutoUpdatesUtil(ad).enable_gms_auto_updates()
-  time.sleep(_DISABLE_ENABLE_GMS_UPDATE_WAIT_TIME_SEC)
diff --git a/tests/bettertogether/quickstart/snippets/Android.bp b/tests/bettertogether/quickstart/snippets/Android.bp
deleted file mode 100644
index 8d83b3bdf..000000000
--- a/tests/bettertogether/quickstart/snippets/Android.bp
+++ /dev/null
@@ -1,40 +0,0 @@
-// Copyright 2023 Google, LLC
-
-package {
-    // See: http://go/android-license-faq
-    default_applicable_licenses: [
-        "Android-Apache-2.0",
-    ],
-}
-
-// setup nearby connection test
-android_test_import {
-    name: "nearby_snippet",
-    owner: "google",
-    apk: "nearby_snippet.apk",
-    preprocessed: true,
-    presigned: true,
-    test_suites: [],
-}
-
-// setup the 2nd nearby connection test, as
-// one client only allow to set up 1 connection.
-android_test_import {
-    name: "nearby_snippet_2",
-    owner: "google",
-    apk: "nearby_snippet_2.apk",
-    preprocessed: true,
-    presigned: true,
-    test_suites: [],
-}
-
-// setup the 3P API nearby connection test, as
-// the client will call nearby connections 3P APIs.
-android_test_import {
-    name: "nearby_snippet_3p",
-    owner: "google",
-    apk: "nearby_snippet_3p.apk",
-    preprocessed: true,
-    presigned: true,
-    test_suites: [],
-}
diff --git a/tests/bettertogether/quickstart/snippets/nearby_snippet.apk b/tests/bettertogether/quickstart/snippets/nearby_snippet.apk
deleted file mode 100755
index 8c4fad357..000000000
Binary files a/tests/bettertogether/quickstart/snippets/nearby_snippet.apk and /dev/null differ
diff --git a/tests/bettertogether/quickstart/snippets/nearby_snippet_2.apk b/tests/bettertogether/quickstart/snippets/nearby_snippet_2.apk
deleted file mode 100755
index 7d4be2e8f..000000000
Binary files a/tests/bettertogether/quickstart/snippets/nearby_snippet_2.apk and /dev/null differ
diff --git a/tests/bettertogether/quickstart/snippets/nearby_snippet_3p.apk b/tests/bettertogether/quickstart/snippets/nearby_snippet_3p.apk
deleted file mode 100644
index 3a4f5adf0..000000000
Binary files a/tests/bettertogether/quickstart/snippets/nearby_snippet_3p.apk and /dev/null differ
diff --git a/tests/functional/calculator/Android.bp b/tests/functional/calculator/Android.bp
index f0324bfcd..2f431bf80 100644
--- a/tests/functional/calculator/Android.bp
+++ b/tests/functional/calculator/Android.bp
@@ -26,7 +26,7 @@ android_test {
         "androidx.test.uiautomator_uiautomator",
     ],
 
-    libs: ["android.test.base"],
+    libs: ["android.test.base.stubs.system"],
 
     platform_apis: true,
 }
diff --git a/tests/jank/UbSystemUiJankTests/Android.bp b/tests/jank/UbSystemUiJankTests/Android.bp
index 9a05e9f19..eec83d36a 100644
--- a/tests/jank/UbSystemUiJankTests/Android.bp
+++ b/tests/jank/UbSystemUiJankTests/Android.bp
@@ -32,7 +32,7 @@ android_test {
         "launcher-aosp-tapl",
     ],
 
-    libs: ["android.test.base"],
+    libs: ["android.test.base.stubs.system"],
     optimize: {
         enabled: false,
     },
diff --git a/tests/jank/androidtvjanktests/Android.bp b/tests/jank/androidtvjanktests/Android.bp
index eb8082b3e..7de58eec3 100644
--- a/tests/jank/androidtvjanktests/Android.bp
+++ b/tests/jank/androidtvjanktests/Android.bp
@@ -28,8 +28,8 @@ android_test {
         "dpad-util",
     ],
     libs: [
-        "android.test.runner",
-        "android.test.base",
+        "sdk_public_30_android.test.runner",
+        "sdk_public_30_android.test.base",
     ],
 
     sdk_version: "30",
diff --git a/tests/microbenchmarks/accessibility/Android.bp b/tests/microbenchmarks/accessibility/Android.bp
index e15dc0e59..68293b640 100644
--- a/tests/microbenchmarks/accessibility/Android.bp
+++ b/tests/microbenchmarks/accessibility/Android.bp
@@ -43,8 +43,8 @@ android_test {
     ],
 
     libs: [
-        "android.test.runner",
-        "android.test.base",
+        "android.test.runner.stubs.test",
+        "android.test.base.stubs.test",
     ],
 
     sdk_version: "test_current",
diff --git a/utils/dpad/src/android/platform/test/utils/DPadUtil.java b/utils/dpad/src/android/platform/test/utils/DPadUtil.java
index 51a76e3cc..53a165a5f 100644
--- a/utils/dpad/src/android/platform/test/utils/DPadUtil.java
+++ b/utils/dpad/src/android/platform/test/utils/DPadUtil.java
@@ -16,6 +16,7 @@
 
 package android.platform.test.utils;
 
+import android.annotation.SuppressLint;
 import android.app.Instrumentation;
 import android.os.SystemClock;
 import android.support.test.uiautomator.Direction;
@@ -29,6 +30,7 @@ import java.io.IOException;
 /**
  * @deprecated , Use {@link DPadUtil2}, which uses latest androidx automator classes.
  */
+@Deprecated
 public class DPadUtil {
 
     private static final String TAG = DPadUtil.class.getSimpleName();
@@ -139,6 +141,7 @@ public class DPadUtil {
         return mDevice.pressBack();
     }
 
+    @SuppressLint("DefaultLocale")
     public boolean longPressKeyCode(int keyCode) {
         try {
             mDevice.executeShellCommand(String.format("input keyevent --longpress %d", keyCode));
diff --git a/utils/dpad/src/android/platform/test/utils/DPadUtil2.java b/utils/dpad/src/android/platform/test/utils/DPadUtil2.java
index 2ed0b1844..69b37414a 100644
--- a/utils/dpad/src/android/platform/test/utils/DPadUtil2.java
+++ b/utils/dpad/src/android/platform/test/utils/DPadUtil2.java
@@ -27,7 +27,6 @@ import androidx.test.uiautomator.UiDevice;
 
 import java.io.IOException;
 
-
 public class DPadUtil2 {
 
     private static final String TAG = DPadUtil2.class.getSimpleName();
@@ -138,6 +137,7 @@ public class DPadUtil2 {
         return mDevice.pressBack();
     }
 
+    @SuppressWarnings("DefaultLocale")
     public boolean longPressKeyCode(int keyCode) {
         try {
             mDevice.executeShellCommand(String.format("input keyevent --longpress %d", keyCode));
diff --git a/utils/permissions/Android.bp b/utils/permissions/Android.bp
index 270e7b855..1c8722caf 100644
--- a/utils/permissions/Android.bp
+++ b/utils/permissions/Android.bp
@@ -21,7 +21,7 @@ package {
 
 java_test {
     name: "permission-utils-lib",
-    libs: ["android.test.runner"],
+    libs: ["android.test.runner.stubs.system"],
     srcs: ["src/**/*.java"],
 }
 
```

