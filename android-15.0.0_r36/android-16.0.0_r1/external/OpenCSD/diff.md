```diff
diff --git a/HOWTO.md b/HOWTO.md
index 3d92e3b..26fdf4b 100644
--- a/HOWTO.md
+++ b/HOWTO.md
@@ -5,9 +5,39 @@ HOWTO - using the library with perf   {#howto_perf}
 
 This HOWTO explains how to use the perf cmd line tools and the openCSD
 library to collect and extract program flow traces generated by the
-CoreSight IP blocks on a Linux system.  The examples have been generated using
+CoreSight IP blocks on a Linux system. The examples have been generated using
 an aarch64 Juno-r0 platform.
 
+Note on building OpenCSD and Kernel/Perf Versions
+-------------------------------------------------
+
+OpenCSD is developed independently of the linux kernel and perf, though the ABI between
+the library and the perf tool generally remains stable. This ABI is formed of a stream of
+decoded packets from the library to the tool.
+
+The exception to this is when new ARM architecture results in significant changes to trace
+elements and therefore to the decoder. This can then change the interface between the OpenCSD
+library and client program i.e. `perf`, introducing new packet types. When this occurs, patches
+for perf are submitted to the kernel at the same time as the decoder is updated. 
+
+The general advice is to always use the latest versions of OpenCSD and kernel/perf.
+
+However the following points should be noted if this is not possible:
+
+- perf build enforces a minimum version of OpenCSD that it will compile against.
+
+- building perf from an older kernel against an OpenCSD version later than the minimum
+  version will generally work, unless the version of OpenCSD has packet types that are
+  not supported in the cs_etm_decoder handling code in perf. This may result in a build
+  error such as enum types not supported.
+
+- The minimum version of kernel recommended is 5.16. However there is some limited support
+  for older kernels at present in the form of backports at:-
+  
+  <https://gitlab.arm.com/linux-arm/linux-coresight-backports>
+
+  See the auto-fdo documentation (@ref older_kernels) for more information on older kernels.
+
 
 On Target Trace Acquisition - Perf Record
 -----------------------------------------
@@ -259,12 +289,13 @@ Information about libraries and executable is stored under `$HOME/.debug`:
 All this information needs to be collected in order to successfully decode
 traces off target:
 
-    linaro@linaro-nano:~/kernel$ tar czf uname.trace.tgz perf.data ~/.debug
+    linaro@linaro-nano:~/kernel$ tar czf results.trace.tgz perf.data ~/.debug
 
 
 Note that file `vmlinux` should also be added to the bundle if kernel traces
 have also been collected.
 
+This `results.trace.tgz` can then be transferred to the host for decoding.
 
 Off Target OpenCSD Compilation
 ------------------------------
@@ -283,45 +314,57 @@ required branch/tag version into a local directory.
     decoder LICENSE  README.md HOWTO.md TODO
 
 Once the source code has been acquired compilation of the openCSD library can
-take place.  For Linux two options are available, LINUX and LINUX64, based on
-the host's (which has nothing to do with the target) architecture:
+take place. By default this will build for the current host into the `./decoder/lib/builddir`
+directory.
 
-    linaro@t430:~/linaro/coresight/$ cd my-opencsd/decoder/build/linux/
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ ls
-    makefile  rctdl_c_api_lib  ref_trace_decode_lib
+    linaro@t430:~/linaro/coresight$ cd my-opencsd
+    linaro@t430:~/linaro/coresight/my-opencsd$ ls ./decoder/build/linux
+    makefile  makefile.dev rctdl_c_api_lib  ref_trace_decode_lib 
 
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ make LINUX64=1 DEBUG=1
+    linaro@t430:~/linaro/coresight/my-opencsd$ make -C decoder/build/linux
     ...
     ...
 
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ ls ../../lib/linux64/dbg/
-    libopencsd.a  libopencsd_c_api.a  libopencsd_c_api.so  libopencsd.so
+    linaro@t430:~/linaro/coresight/my-opencsd$ ls ./decoder/lib/builddir
+    libopencsd.a  libopencsd_c_api.so  libopencsd_c_api.so.1.5.5  libopencsd.so.1  libopencsd_c_api.a
+    libopencsd_c_api.so.1  libopencsd.so libopencsd.so.1.5.5
 
 From there the header file and libraries need to be installed on the system,
 something that requires root privileges.  The default installation path is
 /usr/include/opencsd for the header files and /usr/lib/ for the libraries:
 
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ sudo make install
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ ls -l /usr/include/opencsd
+    linaro@t430:~/linaro/coresight/my-opencsd$ sudo make -C decoder/build/linux  install
+    linaro@t430:~/linaro/coresight/my-opencsd$ ls -l /usr/include/opencsd
     total 60
-    drwxr-xr-x 2 root root  4096 Dec 12 10:19 c_api
-    drwxr-xr-x 2 root root  4096 Dec 12 10:19 etmv3
-    drwxr-xr-x 2 root root  4096 Dec 12 10:19 etmv4
-    -rw-r--r-- 1 root root 28049 Dec 12 10:19 ocsd_if_types.h
-    drwxr-xr-x 2 root root  4096 Dec 12 10:19 ptm
-    drwxr-xr-x 2 root root  4096 Dec 12 10:19 stm
-    -rw-r--r-- 1 root root  7264 Dec 12 10:19 trc_gen_elem_types.h
-    -rw-r--r-- 1 root root  3972 Dec 12 10:19 trc_pkt_types.h
-
-    linaro@t430:~/linaro/coresight/my-opencsd/decoder/build/linux$ ls -l /usr/lib/libopencsd*
-    -rw-r--r-- 1 root root  598720 Dec 12 10:19 /usr/lib/libopencsd_c_api.so
-    -rw-r--r-- 1 root root 4692200 Dec 12 10:19 /usr/lib/libopencsd.so
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 c_api
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 ete
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 etmv3
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 etmv4
+    -rw-r--r-- 1 root root 34668 Feb 25 13:51 ocsd_if_types.h
+    -rw-r--r-- 1 root root  2561 Feb 25 13:51 ocsd_if_version.h
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 ptm
+    drwxr-xr-x 2 root root  4096 Feb 25 13:51 stm
+    -rw-r--r-- 1 root root 10452 Feb 25 13:51 trc_gen_elem_types.h
+    -rw-r--r-- 1 root root  3972 Feb 25 13:51 trc_pkt_types.h
+
+    linaro@t430:~/linaro/coresight/my-opencsd$ ls -al /usr/lib/libopencsd*
+
+    -rw-r--r-- 1 root root 1709380 Feb 25 13:51 /usr/lib/libopencsd.a
+    -rw-r--r-- 1 root root  152314 Feb 25 13:51 /usr/lib/libopencsd_c_api.a
+    lrwxrwxrwx 1 root root      21 Feb 25 13:51 /usr/lib/libopencsd_c_api.so -> libopencsd_c_api.so.1
+    lrwxrwxrwx 1 root root      25 Feb 25 13:51 /usr/lib/libopencsd_c_api.so.1 -> libopencsd_c_api.so.1.5.5
+    -rw-r--r-- 1 root root   98816 Feb 25 13:51 /usr/lib/libopencsd_c_api.so.1.5.5
+    lrwxrwxrwx 1 root root      15 Feb 25 13:51 /usr/lib/libopencsd.so -> libopencsd.so.1
+    lrwxrwxrwx 1 root root      19 Feb 25 13:51 /usr/lib/libopencsd.so.1 -> libopencsd.so.1.5.5
+    -rw-r--r-- 1 root root  797680 Feb 25 13:51 /usr/lib/libopencsd.so.1.5.5
+
 
 A "clean_install" target is also available so that openCSD installed files can
 be removed from a system.  Going forward the goal is to have the openCSD library
 packaged as a Debian or RPM archive so that it can be installed from a
 distribution without having to be compiled.
 
+Complete information on building and installing the library can be found in build_libs.md (@ref build_lib)
 
 Off Target Perf Tools Compilation
 ---------------------------------
@@ -355,7 +398,11 @@ perf tools build script:
     ...                    libopencsd: [ on  ]  <-------
 
 
-At the end of the compilation a new perf binary is available in `tools/perf/`:
+If libopencsd is not installed, or the version is too old for correct compilation,
+then an error will be issued and compilation will fail.
+
+At the end of the compilation a new perf binary is available in `tools/perf/`,
+which we can verify is linked to `libopencsd`:
 
     linaro@t430:~/linaro/linux-kernel$ ldd tools/perf/perf
 	linux-vdso.so.1 =>  (0x00007fff135db000)
@@ -363,7 +410,7 @@ At the end of the compilation a new perf binary is available in `tools/perf/`:
 	librt.so.1 => /lib/x86_64-linux-gnu/librt.so.1 (0x00007f15f8f6e000)
 	libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f15f8c64000)
 	libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f15f8a60000)
-	libopencsd_c_api.so => /usr/lib/libopencsd_c_api.so (0x00007f15f884e000)   <-------
+    libopencsd_c_api.so.1 => /usr/lib/libopencsd_c_api.so.1 (0x00007f5645cfb000)   <-------
 	libelf.so.1 => /usr/lib/x86_64-linux-gnu/libelf.so.1 (0x00007f15f8635000)
 	libdw.so.1 => /usr/lib/x86_64-linux-gnu/libdw.so.1 (0x00007f15f83ec000)
 	libaudit.so.1 => /lib/x86_64-linux-gnu/libaudit.so.1 (0x00007f15f81c5000)
@@ -373,17 +420,9 @@ At the end of the compilation a new perf binary is available in `tools/perf/`:
 	libpython2.7.so.1.0 => /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0 (0x00007f15f7104000)
 	libz.so.1 => /lib/x86_64-linux-gnu/libz.so.1 (0x00007f15f6eea000)
 	/lib64/ld-linux-x86-64.so.2 (0x0000559b88038000)
-	libopencsd.so => /usr/lib/libopencsd.so (0x00007f15f6c62000)    <-------
-	libstdc++.so.6 => /usr/lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f15f68df000)
-	libgcc_s.so.1 => /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f15f66c9000)
-	liblzma.so.5 => /lib/x86_64-linux-gnu/liblzma.so.5 (0x00007f15f64a6000)
-	libbz2.so.1.0 => /lib/x86_64-linux-gnu/libbz2.so.1.0 (0x00007f15f6296000)
-	libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007f15f605e000)
-	libutil.so.1 => /lib/x86_64-linux-gnu/libutil.so.1 (0x00007f15f5e5a000)
-
 
 Additional debug output from the decoder can be compiled in by setting the
-`CSTRACE_RAW` environment variable. Setting this to `packed` gets trace frame
+`CSTRACE_RAW` environment variable at build time. Setting this to `packed` gets trace frame
 output as follows:-
 
     Frame Data; Index    576;    RAW_PACKED; d6 d6 d6 d6 d6 d6 d6 d6 fc fb d6 d6 d6 d6 e0 7f 
@@ -413,24 +452,20 @@ LD_LIBRARY_PATH environment variable needs to be set.
 
 Trace Decoding with Perf Report
 -------------------------------
-Before working with custom traces it is suggested to use a trace bundle that
-is known to be working properly.  A sample bundle has been made available
-here [2].  Trace bundles can be extracted anywhere and have no dependencies on
-where the perf tools and openCSD library have been compiled. 
-
-    linaro@t430:~/linaro/coresight$ mkdir sept20
-    linaro@t430:~/linaro/coresight$ cd sept20
-    linaro@t430:~/linaro/coresight/sept20$ wget http://people.linaro.org/~mathieu.poirier/openCSD/uname.v4.user.sept20.tgz
-    linaro@t430:~/linaro/coresight/sept20$ md5sum uname.v4.user.sept20.tgz
-    f53f11d687ce72bdbe9de2e67e960ec6  uname.v4.user.sept20.tgz
-    linaro@t430:~/linaro/coresight/sept20$ tar xf uname.v4.user.sept20.tgz
-    linaro@t430:~/linaro/coresight/sept20$ ls -la
+Trace bundles can be extracted anywhere and have no dependencies on where the perf tools and openCSD library have been compiled.
+Take the results file from the target and extract into a working directory (e.g. the `results.trace.tgz` file from above)
+
+    linaro@t430:~/linaro/coresight$ mkdir trace-results
+    linaro@t430:~/linaro/coresight$ cd trace-results
+    linaro@t430:~/linaro/coresight/trace-results$ scp <path/to/target>/~/kernel/results.trace.tgz .
+    linaro@t430:~/linaro/coresight/trace-results$ tar xf results.trace.tgz
+    linaro@t430:~/linaro/coresight/trace-results$ ls -la
     total 1312
     drwxrwxr-x 3 linaro linaro    4096 Mar  3 10:26 .
     drwxrwxr-x 5 linaro linaro    4096 Mar  3 10:13 ..
     drwxr-xr-x 7 linaro linaro    4096 Feb 24 12:21 .debug
     -rw------- 1 linaro linaro   78016 Feb 24 12:21 perf.data
-    -rw-rw-r-- 1 linaro linaro 1245881 Feb 24 12:25 uname.v4.user.sept20.tgz
+    -rw-rw-r-- 1 linaro linaro 1245881 Feb 24 12:25 results.trace.tgz
 
 Perf is expecting files related to the trace capture (`perf.data`) to be located in the `buildid` directory.
 By default this is under `~/.debug`.  Alternatively the default `buildid` directory can be changed 
@@ -440,9 +475,9 @@ using the command:
 
 This example will remove the current `~/.debug` directory to be sure everything is clean.  
 
-    linaro@t430:~/linaro/coresight/sept20$ rm -rf ~/.debug
-    linaro@t430:~/linaro/coresight/sept20$ cp -dpR .debug ~/
-    linaro@t430:~/linaro/coresight/sept20$ ../perf-opencsd-master/tools/perf/perf report --stdio
+    linaro@t430:~/linaro/coresight/trace-results$ rm -rf ~/.debug
+    linaro@t430:~/linaro/coresight/trace-results$ cp -dpR .debug ~/
+    linaro@t430:~/linaro/coresight/trace-results$ ../perf-opencsd-master/tools/perf/perf report --stdio
 
     # To display the perf.data header info, please use --header/--header-only options.
     #
@@ -535,10 +570,10 @@ Trace Decoding with Perf Script
 Working with perf scripts needs more command line options but yields
 interesting results.
 
-    linaro@t430:~/linaro/coresight/sept20$ export EXEC_PATH=/home/linaro/coresight/perf-opencsd-master/tools/perf/
-    linaro@t430:~/linaro/coresight/sept20$ export SCRIPT_PATH=$EXEC_PATH/scripts/python/
-    linaro@t430:~/linaro/coresight/sept20$ export XTOOL_PATH=/your/aarch64/toolchain/path/bin/
-    linaro@t430:~/linaro/coresight/sept20$ ../perf-opencsd-master/tools/perf/perf --exec-path=${EXEC_PATH} script --script=python:${SCRIPT_PATH}/arm-cs-trace-disasm.py -- -d ${XTOOL_PATH}/aarch64-linux-gnu-objdump
+    linaro@t430:~/linaro/coresight/trace-results$ export EXEC_PATH=/home/linaro/coresight/perf-opencsd-master/tools/perf/
+    linaro@t430:~/linaro/coresight/trace-results$ export SCRIPT_PATH=$EXEC_PATH/scripts/python/
+    linaro@t430:~/linaro/coresight/trace-results$ export XTOOL_PATH=/your/aarch64/toolchain/path/bin/
+    linaro@t430:~/linaro/coresight/trace-results$ ../perf-opencsd-master/tools/perf/perf --exec-path=${EXEC_PATH} script --script=python:${SCRIPT_PATH}/arm-cs-trace-disasm.py -- -d ${XTOOL_PATH}/aarch64-linux-gnu-objdump
 
               7f89f24d80:   910003e0        mov     x0, sp
               7f89f24d84:   94000d53        bl      7f89f282d0 <free@plt+0x3790>
@@ -570,18 +605,18 @@ Kernel Trace Decoding
 When dealing with kernel space traces the vmlinux file has to be communicated
 explicitely to perf using the "--vmlinux" command line option:
 
-    linaro@t430:~/linaro/coresight/sept20$ ../perf-opencsd-master/tools/perf/perf report --stdio --vmlinux=./vmlinux
+    linaro@t430:~/linaro/coresight/trace-results$ ../perf-opencsd-master/tools/perf/perf report --stdio --vmlinux=./vmlinux
     ...
     ...
-    linaro@t430:~/linaro/coresight/sept20$ ../perf-opencsd-master/tools/perf/perf script --vmlinux=./vmlinux
+    linaro@t430:~/linaro/coresight/trace-results$ ../perf-opencsd-master/tools/perf/perf script --vmlinux=./vmlinux
 
 When using scripts things get a little more convoluted.  Using the same example
 an above but for traces but for kernel traces, the command line becomes:
 
-    linaro@t430:~/linaro/coresight/sept20$ export EXEC_PATH=/home/linaro/coresight/perf-opencsd-master/tools/perf/
-    linaro@t430:~/linaro/coresight/sept20$ export SCRIPT_PATH=$EXEC_PATH/scripts/python/
-    linaro@t430:~/linaro/coresight/sept20$ export XTOOL_PATH=/your/aarch64/toolchain/path/bin/
-    linaro@t430:~/linaro/coresight/sept20$ ../perf-opencsd-master/tools/perf/perf --exec-path=${EXEC_PATH} script	\
+    linaro@t430:~/linaro/coresight/trace-results$ export EXEC_PATH=/home/linaro/coresight/perf-opencsd-master/tools/perf/
+    linaro@t430:~/linaro/coresight/trace-results$ export SCRIPT_PATH=$EXEC_PATH/scripts/python/
+    linaro@t430:~/linaro/coresight/trace-results$ export XTOOL_PATH=/your/aarch64/toolchain/path/bin/
+    linaro@t430:~/linaro/coresight/trace-results$ ../perf-opencsd-master/tools/perf/perf --exec-path=${EXEC_PATH} script	\
 							--vmlinux=./vmlinux					\
 							--script=python:${SCRIPT_PATH}/arm-cs-trace-disasm.py --	\
 							-d ${XTOOLS_PATH}/aarch64-linux-gnu-objdump		\
@@ -590,7 +625,7 @@ an above but for traces but for kernel traces, the command line becomes:
     ...
 
 The option "--vmlinux=./vmlinux" is interpreted by the "perf script" command
-the same way it if for "perf report".  The option "-k ./vmlinux" is dependant
+the same way it is for "perf report".  The option "-k ./vmlinux" is dependant
 on the script being executed and has no related to the "--vmlinux", though it
 is highly advised to keep them synchronized.
 
@@ -665,5 +700,3 @@ Best regards,
 
 --------------------------------------
 [1]: https://github.com/Linaro/OpenCSD
-
-[2]: http://people.linaro.org/~mathieu.poirier/openCSD/uname.v4.user.sept20.tgz
diff --git a/METADATA b/METADATA
index bc99348..20f9583 100644
--- a/METADATA
+++ b/METADATA
@@ -7,14 +7,14 @@ description: "This library provides an API suitable for the decode of ARM(r) Cor
 third_party {
   license_type: RESTRICTED
   last_upgrade_date {
-    year: 2024
-    month: 10
-    day: 2
+    year: 2025
+    month: 2
+    day: 27
   }
   homepage: "https://github.com/Linaro/OpenCSD"
   identifier {
     type: "Git"
     value: "https://github.com/Linaro/OpenCSD.git"
-    version: "v1.5.4"
+    version: "v1.5.6"
   }
 }
diff --git a/OWNERS b/OWNERS
index e5b5f6f..76ed7c6 100644
--- a/OWNERS
+++ b/OWNERS
@@ -1 +1,2 @@
 include toolchain/llvm_android:/OWNERS
+include platform/system/core:/janitors/OWNERS #{LAST_RESORT_SUGGESTION}
diff --git a/README.md b/README.md
index a26f1f3..6b63fab 100644
--- a/README.md
+++ b/README.md
@@ -27,7 +27,7 @@ Releases will appear on the master branch in the git repository with an appropri
 CoreSight Trace Component Support.
 ----------------------------------
 
-_Current Version 1.5.4_
+_Current Version 1.5.6_
 
 ### Current support:
 
@@ -339,7 +339,16 @@ Version and Modification Information
                     - `OCSD_OPFLG_N_UNCOND_DIR_BR_CHK` - check for N atom on unconditional direct branches.
                     - `OCSD_OPFLG_STRICT_N_UNCOND_BR_CHK` - check for N atom on all unconditional branches.
                     - `OCSD_OPFLG_CHK_RANGE_CONTINUE` - Inconsistent range continuity on not taken branches.
-    - __Update__: Add operational flag `ETM4_OPFLG_PKTDEC_AA64_OPCODE_CHK` to enable aa64 opcode checks. 
+    - __Update__: Add operational flag `ETM4_OPFLG_PKTDEC_AA64_OPCODE_CHK` to enable aa64 opcode checks.
+
+- _Version 1.5.5_:
+    - __Bugfix__: memacc: Fix for memacc objects created in decode tree not being released correctly.
+    - __Update__: build: Add support for MacOS build / clang.
+
+- _Version 1.5.6_:
+    - __Bugfix__: build: Fix issue with 'make -f <path to makefile>' no longer working for linux/macos build since 1.5.5.
+    - __Update__: build: later versions of clang require additional includes to compile correctly.
+    - __Update__: docs: Update autofdo docs to reflect latest requirements. Other minor docs updates.
 
 Licence Information
 ===================
diff --git a/decoder/build/linux/makefile b/decoder/build/linux/makefile
index c62a189..f5a7db7 100644
--- a/decoder/build/linux/makefile
+++ b/decoder/build/linux/makefile
@@ -1,219 +1,51 @@
 ########################################################
-# Copyright 2015 ARM Limited. All rights reserved.
-# 
-# Redistribution and use in source and binary forms, with or without modification, 
+# Copyright 2024 ARM Limited. All rights reserved.
+#
+# Redistribution and use in source and binary forms, with or without modification,
 # are permitted provided that the following conditions are met:
-# 
-# 1. Redistributions of source code must retain the above copyright notice, 
+#
+# 1. Redistributions of source code must retain the above copyright notice,
 # this list of conditions and the following disclaimer.
-# 
-# 2. Redistributions in binary form must reproduce the above copyright notice, 
-# this list of conditions and the following disclaimer in the documentation 
-# and/or other materials provided with the distribution. 
-# 
-# 3. Neither the name of the copyright holder nor the names of its contributors 
-# may be used to endorse or promote products derived from this software without 
-# specific prior written permission. 
-# 
-# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND 
-# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
-# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
-# IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
-# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES 
-# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
-# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND 
-# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
-# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
-# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
-# 
+#
+# 2. Redistributions in binary form must reproduce the above copyright notice,
+# this list of conditions and the following disclaimer in the documentation
+# and/or other materials provided with the distribution.
+#
+# 3. Neither the name of the copyright holder nor the names of its contributors
+# may be used to endorse or promote products derived from this software without
+# specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND
+# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+# IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+#
 #################################################################################
-# OpenCSD - master makefile for libraries and tests
+# OpenCSD - main Linux makefile for libraries and tests
 #
 # command line options
 # DEBUG=1 	    create a debug build
 #
 
-# Set project root - relative to build makefile
+# GCC flags
+export PLATFORM_CFLAGS := -Wlogical-op
+export PLATFORM_CXXFLAGS := -Wlogical-op
+export PLATFORM_LDFLAGS := -Wl,-z,defs
+
+export SONAME_FLAG := -soname
+export SHARED_LIB_SUFFIX := so
+
+# set OCSD_ROOT relative to the main linux makefile
 ifeq ($(OCSD_ROOT),)
 OCSD_ROOT := $(shell echo $(dir $(abspath $(lastword $(MAKEFILE_LIST)))) | sed 's,/build/linux.*,,')
 export OCSD_ROOT
 endif
 
-# library names
-LIB_BASE_NAME=opencsd
-export LIB_BASE_NAME
-LIB_CAPI_NAME=$(LIB_BASE_NAME)_c_api
-export LIB_CAPI_NAME
-
-# source root directories
-export OCSD_LIB_ROOT=$(OCSD_ROOT)/lib
-
-export OCSD_INCLUDE=$(OCSD_ROOT)/include
-export OCSD_SOURCE=$(OCSD_ROOT)/source
-
-export OCSD_TESTS=$(OCSD_ROOT)/tests
-export LIB_UAPI_INC_DIR=opencsd
-
-# tools
-export MASTER_CC=$(CROSS_COMPILE)gcc
-export MASTER_CXX=$(CROSS_COMPILE)g++
-export MASTER_LINKER=$(CROSS_COMPILE)g++
-export MASTER_LIB=$(CROSS_COMPILE)ar
-export INSTALL=install
-
-
-# installation directory
-PREFIX ?=/usr
-LIB_PATH ?= lib
-INSTALL_LIB_DIR=$(DESTDIR)$(PREFIX)/$(LIB_PATH)
-INSTALL_BIN_DIR=$(DESTDIR)$(PREFIX)/bin
-export INSTALL_INCLUDE_DIR=$(DESTDIR)$(PREFIX)/include/
-INSTALL_MAN_DIR=$(DESTDIR)$(PREFIX)/share/man/man1
-
-# compile flags
-CFLAGS += $(CPPFLAGS) -c -Wall -DLINUX -Wno-switch -Wlogical-op -fPIC
-CXXFLAGS += $(CPPFLAGS) -c -Wall -DLINUX -Wno-switch -Wlogical-op -fPIC -std=c++11
-LDFLAGS += -Wl,-z,defs
-ARFLAGS ?= rcs
-
-# debug variant
-ifdef DEBUG
-CFLAGS += -g -O0 -DDEBUG
-CXXFLAGS += -g -O0 -DDEBUG
-BUILD_VARIANT=dbg
-else
-CFLAGS += -O2 -DNDEBUG
-CXXFLAGS += -O2 -DNDEBUG
-BUILD_VARIANT=rel
-endif
-
-# export build flags
-export CFLAGS
-export CXXFLAGS
-export LDFLAGS
-export ARFLAGS
-
-# target directories - fixed for default packaging build
-PLAT_DIR ?= builddir
-export PLAT_DIR
-export LIB_TARGET_DIR=$(OCSD_LIB_ROOT)/$(PLAT_DIR)
-export LIB_TEST_TARGET_DIR=$(OCSD_TESTS)/lib/$(PLAT_DIR)
-export BIN_TEST_TARGET_DIR=$(OCSD_TESTS)/bin/$(PLAT_DIR)
-
-# Fish version out of header file (converting from hex)
-getver:=printf "%d" $$(awk '/\#define VARNAME/ { print $$3 }' $(OCSD_ROOT)/include/opencsd/ocsd_if_version.h)
-export SO_MAJOR_VER := $(shell $(subst VARNAME,OCSD_VER_MAJOR,$(getver)))
-SO_MINOR_VER := $(shell $(subst VARNAME,OCSD_VER_MINOR,$(getver)))
-SO_PATCH_VER := $(shell $(subst VARNAME,OCSD_VER_PATCH,$(getver)))
-export SO_VER := $(SO_MAJOR_VER).$(SO_MINOR_VER).$(SO_PATCH_VER)
-
-
-###########################################################
-# build targets
-
-all: libs tests
-
-libs: $(LIB_BASE_NAME)_lib  $(LIB_CAPI_NAME)_lib
-
-DEF_SO_PERM ?= 644
-
-install: libs tests
-	mkdir -p $(INSTALL_LIB_DIR) $(INSTALL_INCLUDE_DIR) $(INSTALL_BIN_DIR)
-	cp -d $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).so $(INSTALL_LIB_DIR)/
-	cp -d $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).so.$(SO_MAJOR_VER) $(INSTALL_LIB_DIR)/
-	$(INSTALL) --mode=$(DEF_SO_PERM) $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).so.$(SO_VER) $(INSTALL_LIB_DIR)/
-	cp -d $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).so $(INSTALL_LIB_DIR)/
-	cp -d $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).so.$(SO_MAJOR_VER) $(INSTALL_LIB_DIR)/
-	$(INSTALL) --mode=$(DEF_SO_PERM) $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).so.$(SO_VER) $(INSTALL_LIB_DIR)/
-ifndef DISABLE_STATIC
-	$(INSTALL) --mode=644 $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a $(INSTALL_LIB_DIR)/
-	$(INSTALL) --mode=644 $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a $(INSTALL_LIB_DIR)/
-endif
-	cd $(OCSD_ROOT)/build/linux/rctdl_c_api_lib && make install_inc
-	$(INSTALL) --mode=755 $(BIN_TEST_TARGET_DIR)/trc_pkt_lister $(INSTALL_BIN_DIR)/ 
-
-install_man:
-	mkdir -p $(INSTALL_MAN_DIR)
-	$(INSTALL) --mode=644 $(OCSD_ROOT)/docs/man/trc_pkt_lister.1 $(INSTALL_MAN_DIR)/
-
-
-################################
-# build  OpenCSD trace decode library
-#
-$(LIB_BASE_NAME)_lib: $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).so
-
-$(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).so: $(LIB_BASE_NAME)_all
-$(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a: $(LIB_BASE_NAME)_all
-
-# single command builds both .a and .so targets in sub-makefile
-$(LIB_BASE_NAME)_all:
-	mkdir -p $(LIB_TARGET_DIR)
-	cd $(OCSD_ROOT)/build/linux/ref_trace_decode_lib && $(MAKE)
-
-################################
-# build OpenCSD trace decode C API library 
-#
-$(LIB_CAPI_NAME)_lib: $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).so
-
-$(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).so: $(LIB_CAPI_NAME)_all
-$(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a:  $(LIB_CAPI_NAME)_all
-
-# single command builds both .a and .so targets in sub-makefile
-$(LIB_CAPI_NAME)_all:  $(LIB_BASE_NAME)_lib
-	mkdir -p $(LIB_TARGET_DIR)
-	cd $(OCSD_ROOT)/build/linux/rctdl_c_api_lib && $(MAKE)
-
-#################################
-# build tests
-
-.PHONY: tests
-tests: libs
-	cd $(OCSD_ROOT)/tests/build/linux/echo_test_dcd_lib && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/snapshot_parser_lib && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/trc_pkt_lister && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/c_api_pkt_print_test && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/mem_buffer_eg && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/frame_demux_test && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/perr && $(MAKE)
-	cd $(OCSD_ROOT)/tests/build/linux/mem_acc_test && $(MAKE)
-
-#
-# build docs
-.PHONY: docs
-docs:
-	(cd $(OCSD_ROOT)/docs; doxygen doxygen_config.dox)
-
-
-#############################################################
-# clean targets
-#
-clean: clean_libs clean_tests clean_docs
-
-.PHONY: clean_libs clean_tests clean_docs clean_install
-
-clean_libs:
-	cd $(OCSD_ROOT)/build/linux/ref_trace_decode_lib && $(MAKE) clean
-	cd $(OCSD_ROOT)/build/linux/rctdl_c_api_lib && $(MAKE) clean
-
-clean_tests:
-	cd $(OCSD_ROOT)/tests/build/linux/echo_test_dcd_lib && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/snapshot_parser_lib && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/trc_pkt_lister && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/c_api_pkt_print_test && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/mem_buffer_eg && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/frame_demux_test && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/perr && $(MAKE) clean
-	cd $(OCSD_ROOT)/tests/build/linux/mem_acc_test && $(MAKE) clean
-	-rmdir $(OCSD_TESTS)/lib
-
-clean_docs:
-	-rm -r $(OCSD_ROOT)/docs/html
-
-clean_install: clean_man
-	-rm    $(INSTALL_LIB_DIR)/lib$(LIB_BASE_NAME).*
-	-rm    $(INSTALL_LIB_DIR)/lib$(LIB_CAPI_NAME).*
-	-rm -r $(INSTALL_INCLUDE_DIR)/$(LIB_UAPI_INC_DIR)
-	-rm    $(INSTALL_BIN_DIR)/trc_pkt_lister
-
-clean_man:
-	-rm    $(INSTALL_MAN_DIR)/trc_pkt_lister.1
+# include the common unix makefile
+include $(OCSD_ROOT)/build/unix_common/makefile.common
diff --git a/decoder/build/linux/makefile.dev b/decoder/build/linux/makefile.dev
index 4b0b4b0..ecf7fc4 100644
--- a/decoder/build/linux/makefile.dev
+++ b/decoder/build/linux/makefile.dev
@@ -28,7 +28,7 @@
 # 
 #################################################################################
 
-## Set up some addtional parameters for development environment builds. ##
+## Set up some additional parameters for development environment builds. ##
 
 ## define arch/build sub-dirs for non installed dev builds
 ifndef ARCH
diff --git a/decoder/build/macos/makefile b/decoder/build/macos/makefile
new file mode 100644
index 0000000..95d0789
--- /dev/null
+++ b/decoder/build/macos/makefile
@@ -0,0 +1,50 @@
+########################################################
+# Copyright 2024 ARM Limited. All rights reserved.
+#
+# Redistribution and use in source and binary forms, with or without modification,
+# are permitted provided that the following conditions are met:
+#
+# 1. Redistributions of source code must retain the above copyright notice,
+# this list of conditions and the following disclaimer.
+#
+# 2. Redistributions in binary form must reproduce the above copyright notice,
+# this list of conditions and the following disclaimer in the documentation
+# and/or other materials provided with the distribution.
+#
+# 3. Neither the name of the copyright holder nor the names of its contributors
+# may be used to endorse or promote products derived from this software without
+# specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND
+# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+# IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+#
+#################################################################################
+# OpenCSD - main MacOS makefile for libraries and tests
+#
+# command line options
+# DEBUG=1 	    create a debug build
+#
+
+# Clang flags
+export PLATFORM_LDFLAGS := -Wl,-undefined,error
+
+export SONAME_FLAG := -install_name
+export SHARED_LIB_SUFFIX := dylib
+
+# set OCSD_ROOT relative to the main macos makefile
+ifeq ($(OCSD_ROOT),)
+OCSD_ROOT := $(shell echo $(dir $(abspath $(lastword $(MAKEFILE_LIST)))) | sed 's,/build/macos.*,,')
+export OCSD_ROOT
+endif
+
+# include the common unix makefile
+include $(OCSD_ROOT)/build/unix_common/makefile.common
+
diff --git a/decoder/build/macos/makefile.dev b/decoder/build/macos/makefile.dev
new file mode 100644
index 0000000..b636dc1
--- /dev/null
+++ b/decoder/build/macos/makefile.dev
@@ -0,0 +1,52 @@
+########################################################
+# Copyright 2024 ARM Limited. All rights reserved.
+#
+# Redistribution and use in source and binary forms, with or without modification,
+# are permitted provided that the following conditions are met:
+#
+# 1. Redistributions of source code must retain the above copyright notice,
+# this list of conditions and the following disclaimer.
+#
+# 2. Redistributions in binary form must reproduce the above copyright notice,
+# this list of conditions and the following disclaimer in the documentation
+# and/or other materials provided with the distribution.
+#
+# 3. Neither the name of the copyright holder nor the names of its contributors
+# may be used to endorse or promote products derived from this software without
+# specific prior written permission.
+#
+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND
+# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+# IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
+# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+#
+#################################################################################
+
+## Set up some additional parameters for development environment builds. ##
+
+## define arch/build sub-dirs for non installed dev builds
+ifndef ARCH
+ARCH := $(shell uname -m || echo not)
+endif
+
+CFLAGS := -arch $(ARCH)
+CXXFLAGS := -arch $(ARCH)
+LDFLAGS := -arch $(ARCH)
+
+# platform bit size variant
+ifeq ($(ARCH),x86_64)
+   BIT_VARIANT=-x86_64
+else ifeq ($(ARCH),arm64)
+   BIT_VARIANT=-arm64
+endif
+
+PLAT_DIR=darwin$(BIT_VARIANT)/$(BUILD_VARIANT)
+
+# include the main makefile
+include makefile
diff --git a/decoder/build/unix_common/makefile.common b/decoder/build/unix_common/makefile.common
new file mode 100644
index 0000000..201f59c
--- /dev/null
+++ b/decoder/build/unix_common/makefile.common
@@ -0,0 +1,216 @@
+########################################################
+# Copyright 2015 ARM Limited. All rights reserved.
+# 
+# Redistribution and use in source and binary forms, with or without modification, 
+# are permitted provided that the following conditions are met:
+# 
+# 1. Redistributions of source code must retain the above copyright notice, 
+# this list of conditions and the following disclaimer.
+# 
+# 2. Redistributions in binary form must reproduce the above copyright notice, 
+# this list of conditions and the following disclaimer in the documentation 
+# and/or other materials provided with the distribution. 
+# 
+# 3. Neither the name of the copyright holder nor the names of its contributors 
+# may be used to endorse or promote products derived from this software without 
+# specific prior written permission. 
+# 
+# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND 
+# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
+# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
+# IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
+# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES 
+# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
+# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND 
+# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
+# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
+# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
+# 
+#################################################################################
+# OpenCSD - common unix makefile-code for libraries and tests
+#
+
+# Set project root - relative to build makefile
+ifeq ($(OCSD_ROOT),)
+OCSD_ROOT := $(shell echo $(dir $(abspath $(lastword $(MAKEFILE_LIST)))) | sed 's,/build/unix_common.*,,')
+export OCSD_ROOT
+endif
+
+# library names
+LIB_BASE_NAME=opencsd
+export LIB_BASE_NAME
+LIB_CAPI_NAME=$(LIB_BASE_NAME)_c_api
+export LIB_CAPI_NAME
+
+# source root directories
+export OCSD_LIB_ROOT=$(OCSD_ROOT)/lib
+
+export OCSD_INCLUDE=$(OCSD_ROOT)/include
+export OCSD_SOURCE=$(OCSD_ROOT)/source
+
+export OCSD_TESTS=$(OCSD_ROOT)/tests
+export LIB_UAPI_INC_DIR=opencsd
+
+# tools
+export MASTER_CC=$(CROSS_COMPILE)gcc
+export MASTER_CXX=$(CROSS_COMPILE)g++
+export MASTER_LINKER=$(CROSS_COMPILE)g++
+export MASTER_LIB=$(CROSS_COMPILE)ar
+export INSTALL=install
+
+
+# installation directory
+PREFIX ?=/usr
+LIB_PATH ?= lib
+INSTALL_LIB_DIR=$(DESTDIR)$(PREFIX)/$(LIB_PATH)
+INSTALL_BIN_DIR=$(DESTDIR)$(PREFIX)/bin
+export INSTALL_INCLUDE_DIR=$(DESTDIR)$(PREFIX)/include/
+INSTALL_MAN_DIR=$(DESTDIR)$(PREFIX)/share/man/man1
+
+# compile flags
+CFLAGS += $(CPPFLAGS) -c -Wall -Wno-switch -fPIC $(PLATFORM_CFLAGS)
+CXXFLAGS += $(CPPFLAGS) -c -Wall -Wno-switch -fPIC -std=c++11 $(PLATFORM_CXXFLAGS)
+LDFLAGS += $(PLATFORM_LDFLAGS)
+ARFLAGS ?= rcs
+
+# debug variant
+ifdef DEBUG
+CFLAGS += -g -O0 -DDEBUG
+CXXFLAGS += -g -O0 -DDEBUG
+BUILD_VARIANT=dbg
+else
+CFLAGS += -O2 -DNDEBUG
+CXXFLAGS += -O2 -DNDEBUG
+BUILD_VARIANT=rel
+endif
+
+# export build flags
+export CFLAGS
+export CXXFLAGS
+export LDFLAGS
+export ARFLAGS
+
+# target directories - fixed for default packaging build
+PLAT_DIR ?= builddir
+export PLAT_DIR
+export LIB_TARGET_DIR=$(OCSD_LIB_ROOT)/$(PLAT_DIR)
+export LIB_TEST_TARGET_DIR=$(OCSD_TESTS)/lib/$(PLAT_DIR)
+export BIN_TEST_TARGET_DIR=$(OCSD_TESTS)/bin/$(PLAT_DIR)
+
+# Fish version out of header file (converting from hex)
+getver:=printf "%d" $$(awk '/\#define VARNAME/ { print $$3 }' $(OCSD_ROOT)/include/opencsd/ocsd_if_version.h)
+export SO_MAJOR_VER := $(shell $(subst VARNAME,OCSD_VER_MAJOR,$(getver)))
+SO_MINOR_VER := $(shell $(subst VARNAME,OCSD_VER_MINOR,$(getver)))
+SO_PATCH_VER := $(shell $(subst VARNAME,OCSD_VER_PATCH,$(getver)))
+export SO_VER := $(SO_MAJOR_VER).$(SO_MINOR_VER).$(SO_PATCH_VER)
+
+
+###########################################################
+# build targets
+
+all: libs tests
+
+libs: $(LIB_BASE_NAME)_lib  $(LIB_CAPI_NAME)_lib
+
+DEF_SO_PERM ?= 644
+
+install: libs tests
+	mkdir -p $(INSTALL_LIB_DIR) $(INSTALL_INCLUDE_DIR) $(INSTALL_BIN_DIR)
+	cp -d $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).$(SHARED_LIB_SUFFIX) $(INSTALL_LIB_DIR)/
+	cp -d $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(INSTALL_LIB_DIR)/
+	$(INSTALL) --mode=$(DEF_SO_PERM) $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) $(INSTALL_LIB_DIR)/
+	cp -d $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).$(SHARED_LIB_SUFFIX) $(INSTALL_LIB_DIR)/
+	cp -d $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(INSTALL_LIB_DIR)/
+	$(INSTALL) --mode=$(DEF_SO_PERM) $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) $(INSTALL_LIB_DIR)/
+ifndef DISABLE_STATIC
+	$(INSTALL) --mode=644 $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a $(INSTALL_LIB_DIR)/
+	$(INSTALL) --mode=644 $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a $(INSTALL_LIB_DIR)/
+endif
+	cd $(OCSD_ROOT)/build/unix_common/rctdl_c_api_lib && make install_inc
+	$(INSTALL) --mode=755 $(BIN_TEST_TARGET_DIR)/trc_pkt_lister $(INSTALL_BIN_DIR)/ 
+
+install_man:
+	mkdir -p $(INSTALL_MAN_DIR)
+	$(INSTALL) --mode=644 $(OCSD_ROOT)/docs/man/trc_pkt_lister.1 $(INSTALL_MAN_DIR)/
+
+
+################################
+# build  OpenCSD trace decode library
+#
+$(LIB_BASE_NAME)_lib: $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a $(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).$(SHARED_LIB_SUFFIX)
+
+$(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).$(SHARED_LIB_SUFFIX): $(LIB_BASE_NAME)_all
+$(LIB_TARGET_DIR)/lib$(LIB_BASE_NAME).a: $(LIB_BASE_NAME)_all
+
+# single command builds both .a and .$(SHARED_LIB_SUFFIX) targets in sub-makefile
+$(LIB_BASE_NAME)_all:
+	mkdir -p $(LIB_TARGET_DIR)
+	cd $(OCSD_ROOT)/build/unix_common/ref_trace_decode_lib && $(MAKE)
+
+################################
+# build OpenCSD trace decode C API library 
+#
+$(LIB_CAPI_NAME)_lib: $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a $(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).$(SHARED_LIB_SUFFIX)
+
+$(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).$(SHARED_LIB_SUFFIX): $(LIB_CAPI_NAME)_all
+$(LIB_TARGET_DIR)/lib$(LIB_CAPI_NAME).a:  $(LIB_CAPI_NAME)_all
+
+# single command builds both .a and .$(SHARED_LIB_SUFFIX) targets in sub-makefile
+$(LIB_CAPI_NAME)_all:  $(LIB_BASE_NAME)_lib
+	mkdir -p $(LIB_TARGET_DIR)
+	cd $(OCSD_ROOT)/build/unix_common/rctdl_c_api_lib && $(MAKE)
+
+#################################
+# build tests
+
+.PHONY: tests
+tests: libs
+	cd $(OCSD_ROOT)/tests/build/unix_common/echo_test_dcd_lib && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/snapshot_parser_lib && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/trc_pkt_lister && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/c_api_pkt_print_test && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/mem_buffer_eg && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/frame_demux_test && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/perr && $(MAKE)
+	cd $(OCSD_ROOT)/tests/build/unix_common/mem_acc_test && $(MAKE)
+
+#
+# build docs
+.PHONY: docs
+docs:
+	(cd $(OCSD_ROOT)/docs; doxygen doxygen_config.dox)
+
+
+#############################################################
+# clean targets
+#
+clean: clean_libs clean_tests clean_docs
+
+.PHONY: clean_libs clean_tests clean_docs clean_install
+
+clean_libs:
+	cd $(OCSD_ROOT)/build/unix_common/ref_trace_decode_lib && $(MAKE) clean
+	cd $(OCSD_ROOT)/build/unix_common/rctdl_c_api_lib && $(MAKE) clean
+
+clean_tests:
+	cd $(OCSD_ROOT)/tests/build/unix_common/echo_test_dcd_lib && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/snapshot_parser_lib && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/trc_pkt_lister && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/c_api_pkt_print_test && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/mem_buffer_eg && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/frame_demux_test && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/perr && $(MAKE) clean
+	cd $(OCSD_ROOT)/tests/build/unix_common/mem_acc_test && $(MAKE) clean
+	-rmdir $(OCSD_TESTS)/lib
+
+clean_docs:
+	-rm -r $(OCSD_ROOT)/docs/html
+
+clean_install: clean_man
+	-rm    $(INSTALL_LIB_DIR)/lib$(LIB_BASE_NAME).*
+	-rm    $(INSTALL_LIB_DIR)/lib$(LIB_CAPI_NAME).*
+	-rm -r $(INSTALL_INCLUDE_DIR)/$(LIB_UAPI_INC_DIR)
+	-rm    $(INSTALL_BIN_DIR)/trc_pkt_lister
+
+clean_man:
+	-rm    $(INSTALL_MAN_DIR)/trc_pkt_lister.1
diff --git a/decoder/build/linux/rctdl_c_api_lib/makefile b/decoder/build/unix_common/rctdl_c_api_lib/makefile
similarity index 81%
rename from decoder/build/linux/rctdl_c_api_lib/makefile
rename to decoder/build/unix_common/rctdl_c_api_lib/makefile
index 7b4055d..2a535f1 100644
--- a/decoder/build/linux/rctdl_c_api_lib/makefile
+++ b/decoder/build/unix_common/rctdl_c_api_lib/makefile
@@ -53,10 +53,10 @@ INST_INC_DST=$(INSTALL_INCLUDE_DIR)/$(LIB_UAPI_INC_DIR)
 
 all: links
 
-links: $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER) $(LIB_TARGET_DIR)/$(LIB_NAME).so
+links: $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX)
 .PHONY: links
 
-LIBS:= $(LIB_TARGET_DIR)/$(LIB_NAME).a $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER)
+LIBS:= $(LIB_TARGET_DIR)/$(LIB_NAME).a $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER)
 
 $(LIB_TARGET_DIR):
 	mkdir -p  $(LIB_TARGET_DIR)
@@ -67,14 +67,14 @@ $(BUILD_DIR):
 $(LIB_TARGET_DIR)/$(LIB_NAME).a: $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
 	$(LIB) $(ARFLAGS) $(LIB_TARGET_DIR)/$(LIB_NAME).a $(OBJECTS)
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER): $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
-	$(LINKER) $(LDFLAGS) -shared -o $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER) -Wl,-soname,$(LIB_NAME).so.$(SO_MAJOR_VER) $(OBJECTS) $(SO_LIB_DEPS)
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER): $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
+	$(LINKER) $(LDFLAGS) -shared -o $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) -Wl,$(SONAME_FLAG),$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(OBJECTS) $(SO_LIB_DEPS)
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER): $(LIBS) | $(LIB_TARGET_DIR)
-	( cd $(LIB_TARGET_DIR); ln -sf $(LIB_NAME).so.$(SO_VER) $(LIB_NAME).so.$(SO_MAJOR_VER) )
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER): $(LIBS) | $(LIB_TARGET_DIR)
+	( cd $(LIB_TARGET_DIR); ln -sf $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) )
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so: $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER) | $(LIB_TARGET_DIR)
-	( cd $(LIB_TARGET_DIR); ln -sf $(LIB_NAME).so.$(SO_MAJOR_VER) $(LIB_NAME).so )
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX): $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) | $(LIB_TARGET_DIR)
+	( cd $(LIB_TARGET_DIR); ln -sf $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(LIB_NAME).$(SHARED_LIB_SUFFIX) )
 
 
 ##### build rules
@@ -95,7 +95,7 @@ clean:
 	rm -f $(OBJECTS)
 	rm -f $(DEPS)
 	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).a
-	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).so*
+	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 #### install the necessary include files for the c-api library on linux 
diff --git a/decoder/build/linux/ref_trace_decode_lib/makefile b/decoder/build/unix_common/ref_trace_decode_lib/makefile
similarity index 82%
rename from decoder/build/linux/ref_trace_decode_lib/makefile
rename to decoder/build/unix_common/ref_trace_decode_lib/makefile
index 3cdfcfd..32597a7 100644
--- a/decoder/build/linux/ref_trace_decode_lib/makefile
+++ b/decoder/build/unix_common/ref_trace_decode_lib/makefile
@@ -115,10 +115,10 @@ OBJECTS=$(BUILD_DIR)/ocsd_code_follower.o \
 
 all: links
 
-links: $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER) $(LIB_TARGET_DIR)/$(LIB_NAME).so
+links: $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX)
 .PHONY: links
 
-LIBS:= $(LIB_TARGET_DIR)/$(LIB_NAME).a $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER)
+LIBS:= $(LIB_TARGET_DIR)/$(LIB_NAME).a $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER)
 
 $(LIB_TARGET_DIR):
 	mkdir -p $(LIB_TARGET_DIR)
@@ -129,14 +129,14 @@ $(BUILD_DIR):
 $(LIB_TARGET_DIR)/$(LIB_NAME).a: $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
 	$(LIB) $(ARFLAGS) $(LIB_TARGET_DIR)/$(LIB_NAME).a $(OBJECTS)
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER): $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
-	$(LINKER) $(LDFLAGS) -shared -o $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_VER) -Wl,-soname,$(LIB_NAME).so.$(SO_MAJOR_VER) $(OBJECTS)
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER): $(OBJECTS) | $(BUILD_DIR) $(LIB_TARGET_DIR)
+	$(LINKER) $(LDFLAGS) -shared -o $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) -Wl,$(SONAME_FLAG),$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(OBJECTS)
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER): $(LIBS) | $(LIB_TARGET_DIR)
-	( cd $(LIB_TARGET_DIR);  ln -sf $(LIB_NAME).so.$(SO_VER) $(LIB_NAME).so.$(SO_MAJOR_VER) )
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER): $(LIBS) | $(LIB_TARGET_DIR)
+	( cd $(LIB_TARGET_DIR);  ln -sf $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_VER) $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) )
 
-$(LIB_TARGET_DIR)/$(LIB_NAME).so: $(LIB_TARGET_DIR)/$(LIB_NAME).so.$(SO_MAJOR_VER) | $(LIB_TARGET_DIR)
-	( cd $(LIB_TARGET_DIR);  ln -sf $(LIB_NAME).so.$(SO_MAJOR_VER) $(LIB_NAME).so )
+$(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX): $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) | $(LIB_TARGET_DIR)
+	( cd $(LIB_TARGET_DIR);  ln -sf $(LIB_NAME).$(SHARED_LIB_SUFFIX).$(SO_MAJOR_VER) $(LIB_NAME).$(SHARED_LIB_SUFFIX) )
 
 
 ##### build rules
@@ -157,5 +157,5 @@ clean:
 	rm -f $(OBJECTS)
 	rm -f $(DEPS)
 	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).a
-	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).so*
+	rm -f $(LIB_TARGET_DIR)/$(LIB_NAME).$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
diff --git a/decoder/docs/build_libs.md b/decoder/docs/build_libs.md
index a289516..2817de9 100644
--- a/decoder/docs/build_libs.md
+++ b/decoder/docs/build_libs.md
@@ -10,6 +10,7 @@ The current makefiles and build projects support building the library on:
  - Linux and Windows, x86 or x64 hosts.
  - ARM linux - AArch32 and AArch64
  - ARM aarch32 and aarch64 libs, x-compiled on x86/64 hosts.
+ - MacOS - x64 and AArch64 (Apple Silicon)
 
 In addition to building the library from the project, the library may be installed into the standard
 `/usr/lib/` area in Linux, and will soon be available as a package from Linux Distros.
@@ -18,13 +19,15 @@ Building the Library
 --------------------
 
 The library and test programs are built from the library `./build/<platform>` directory, where
-<platform> is either 'linux' or 'win-vs2022'
+<platform> is either 'linux', 'macos', or 'win-vs2022'
 
 See [`./docs/test_progs.md`](@ref test_progs) for further information on use of the test 
 programs.
 
 ### Linux x86/x64/ARM ###
 
+GCC is assumed to be the default compiler.
+
 Libraries are built into a <tgt_dir>. This is used as the final output directory for the
 libraries in `decoder/lib/<tgt_dir>`, and also as a sub-directory of the build process for
 intermediate files - `decoder/build/linux/ref_trace_decode_lib/<tgt_dir>`.
@@ -107,6 +110,34 @@ Sufficient header files to build using the C-API library will be installed to `/
 The installation can be removed using `make clean_install`. No additional options are necessary. 
 
 
+### MacOS x64/AArch64 ###
+
+Clang is assumed to be the default compiler.
+
+Go to the `./decoder/build/macos/` directory and run `make`.
+
+Output libraries will be placed in the same folders as for the Linux build (`decoder/lib/builddir/`
+and `decoder/tests/lib/builddir/`).
+
+`DYLD_LIBRARY_PATH` will need to be specified to run an executable that depends on the libraries. For example,
+to run `trc_pkt_lister` from the base directory:
+
+         DYLD_LIBRARY_PATH=./decoder/lib/builddir ./decoder/tests/bin/builddir/trc_pkt_lister -h
+
+For development, alternatively use `make -f makefile.dev`
+
+Similar to the Linux makefile.dev, this will build libraries into the `decoder/lib/darwin<bit-variant>/<dbg|rel>`
+directories, allowing multiple variants of the library to be present during development.
+
+Options to pass to both makefiles are:-
+- `DEBUG=1`   : build the debug version of the library.
+
+Options to pass to makefile.dev are:-
+- ARCH=<arch> : Set this if needing to build for x86_64 from an arm64 host, or to build for arm64 from an x86_64 host.
+                Otherwise ARCH is auto-detected.
+                <arch> can be x86_64, arm64
+
+
 ### Windows (x86/x64)  ###
 
 Use the `.\build\win\ref_trace_decode_lib\ref_trace_decode_lib.sln` file to load a solution
@@ -163,6 +194,10 @@ application makefile.
 
 To use the static versions use appropriate linker options.
 
+### MacOS build ###
+
+The same applies as for the Linux build w.r.t the .dylib versions of the library.
+
 ### Windows build ###
 
 To link against the C-API DLL, include the .DLL name as a dependency in the application project options.
diff --git a/decoder/docs/doxygen_config.dox b/decoder/docs/doxygen_config.dox
index e8d7d4f..ab95eef 100644
--- a/decoder/docs/doxygen_config.dox
+++ b/decoder/docs/doxygen_config.dox
@@ -38,7 +38,7 @@ PROJECT_NAME           = "OpenCSD - CoreSight Trace Decode Library"
 # could be handy for archiving the generated documentation or if some version
 # control system is used.
 
-PROJECT_NUMBER         = 1.5.4
+PROJECT_NUMBER         = 1.5.6
 
 # Using the PROJECT_BRIEF tag one can provide an optional one line description
 # for a project that appears at the top of each page and should give viewer a
diff --git a/decoder/docs/man/trc_pkt_lister.1 b/decoder/docs/man/trc_pkt_lister.1
index d4d27db..acf3955 100644
--- a/decoder/docs/man/trc_pkt_lister.1
+++ b/decoder/docs/man/trc_pkt_lister.1
@@ -74,10 +74,13 @@ range into multiple ranges on N atoms.
 Output raw packed trace frames.
 .TP
 .B -o_raw_unpacked
-Output raw unpacked trace data per ID.-
+Output raw unpacked trace data per ID.
 .TP
 .B -stats
 Output packet processing statistics (if available).
+.TP
+.B -no_time_print
+Do not output elapsed time at end of decode.
 .SS Consistency checks
 .TP
 .B -aa64_opcode_chk
diff --git a/decoder/docs/test_progs.md b/decoder/docs/test_progs.md
index 8734440..54b13a2 100644
--- a/decoder/docs/test_progs.md
+++ b/decoder/docs/test_progs.md
@@ -192,6 +192,7 @@ __Command Line Options__
 - `-o_raw_packed`    : Output raw packed trace frames.
 - `-o_raw_unpacked`  : Output raw unpacked trace data per ID.
 - `-stats`           : Output packet processing statistics (if available).
+- `-no_time_print`   : Do not output elapsed time at end of decode.
 
 *Consistency Checks*
 
diff --git a/decoder/include/common/ocsd_dcd_tree.h b/decoder/include/common/ocsd_dcd_tree.h
index 1a3fdf6..2be7bc7 100644
--- a/decoder/include/common/ocsd_dcd_tree.h
+++ b/decoder/include/common/ocsd_dcd_tree.h
@@ -421,6 +421,12 @@ private:
         const ocsd_mem_space_acc_t mem_space, void *p_cb_func, bool IDfn, const void *p_context);
     TrcPktProcI *getPktProcI(const uint8_t CSID);
 
+    // keep internal list of memory accessors created by this object.
+    void addMemAccessorToList(TrcMemAccessorBase* p_accessor);
+
+    // destroy mem accessors in use by this object
+    void destroyMemAccessors();
+
     ocsd_dcd_tree_src_t m_dcd_tree_type;
 
     IInstrDecode *m_i_instr_decode;
@@ -452,6 +458,9 @@ private:
 
     /**! demux stats block */
     ocsd_demux_stats_t m_demux_stats;
+
+    /**! List of accessors created by the decode tree */
+    std::list<TrcMemAccessorBase*> m_mem_accessors;
 };
 
 /** @}*/
diff --git a/decoder/include/opencsd/ocsd_if_version.h b/decoder/include/opencsd/ocsd_if_version.h
index 0ae3600..6b6e222 100644
--- a/decoder/include/opencsd/ocsd_if_version.h
+++ b/decoder/include/opencsd/ocsd_if_version.h
@@ -44,7 +44,7 @@
 @{*/
 #define OCSD_VER_MAJOR 0x1 /**< Library Major Version */
 #define OCSD_VER_MINOR 0x5 /**< Library Minor Version */
-#define OCSD_VER_PATCH 0x4 /**< Library Patch Version */
+#define OCSD_VER_PATCH 0x6 /**< Library Patch Version */
 
 /** Library version number - MMMMnnpp format.
     MMMM = major version, 
@@ -53,7 +53,7 @@
 */
 #define OCSD_VER_NUM ((OCSD_VER_MAJOR << 16) | (OCSD_VER_MINOR << 8) | OCSD_VER_PATCH) 
 
-#define OCSD_VER_STRING "1.5.4"          /**< Library Version string */
+#define OCSD_VER_STRING "1.5.6"          /**< Library Version string */
 #define OCSD_LIB_NAME "OpenCSD Library"  /**< Library name string */
 #define OCSD_LIB_SHORT_NAME "OCSD"       /**< Library Short name string */
 /** @}*/
diff --git a/decoder/source/etmv4/trc_pkt_decode_etmv4i.cpp b/decoder/source/etmv4/trc_pkt_decode_etmv4i.cpp
index 3c786c6..c3bc050 100644
--- a/decoder/source/etmv4/trc_pkt_decode_etmv4i.cpp
+++ b/decoder/source/etmv4/trc_pkt_decode_etmv4i.cpp
@@ -32,6 +32,8 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
  */ 
 
+#include <cstdlib>
+
 #include "opencsd/etmv4/trc_pkt_decode_etmv4i.h"
 
 #include "common/trc_gen_elem.h"
diff --git a/decoder/source/ocsd_dcd_tree.cpp b/decoder/source/ocsd_dcd_tree.cpp
index 79aabbc..bd48afd 100644
--- a/decoder/source/ocsd_dcd_tree.cpp
+++ b/decoder/source/ocsd_dcd_tree.cpp
@@ -113,6 +113,7 @@ DecodeTree::DecodeTree() :
 
 DecodeTree::~DecodeTree()
 {
+    destroyMemAccessors();
     destroyMemAccMapper();
     for(uint8_t i = 0; i < 0x80; i++)
     {
@@ -229,6 +230,25 @@ void DecodeTree::destroyMemAccMapper()
     }
 }
 
+void DecodeTree::addMemAccessorToList(TrcMemAccessorBase* p_accessor)
+{
+    m_mem_accessors.push_back(p_accessor);
+}
+
+// destroy mem accessors in use by this object
+void DecodeTree::destroyMemAccessors()
+{
+    std::list<TrcMemAccessorBase*>::iterator it;
+
+    it = m_mem_accessors.begin();
+    while (it != m_mem_accessors.end())
+    {
+        TrcMemAccFactory::DestroyAccessor(*it);
+        it++;
+    }
+    m_mem_accessors.clear();
+}
+
 void DecodeTree::logMappedRanges()
 {
     if(m_default_mapper)
@@ -277,8 +297,10 @@ ocsd_err_t DecodeTree::addBufferMemAcc(const ocsd_vaddr_t address, const ocsd_me
         else
             err = OCSD_ERR_MEM;    // wrong type of object - treat as mem error
 
-        if(err != OCSD_OK)
+        if (err != OCSD_OK)
             TrcMemAccFactory::DestroyAccessor(p_accessor);
+        else
+            addMemAccessorToList(p_accessor);
     }
     return err;
 }
@@ -305,8 +327,10 @@ ocsd_err_t DecodeTree::addBinFileMemAcc(const ocsd_vaddr_t address, const ocsd_m
         else
             err = OCSD_ERR_MEM;    // wrong type of object - treat as mem error
 
-        if(err != OCSD_OK)
+        if (err != OCSD_OK)
             TrcMemAccFactory::DestroyAccessor(p_accessor);
+        else
+            addMemAccessorToList(p_accessor);
     }
     return err;
 
@@ -347,8 +371,10 @@ ocsd_err_t DecodeTree::addBinFileRegionMemAcc(const ocsd_file_mem_region_t *regi
         else
             err = OCSD_ERR_MEM;    // wrong type of object - treat as mem error
 
-        if(err != OCSD_OK)
+        if (err != OCSD_OK)
             TrcMemAccFactory::DestroyAccessor(p_accessor);
+        else
+            addMemAccessorToList(p_accessor);
     }
     return err;
 }
@@ -407,8 +433,10 @@ ocsd_err_t DecodeTree::initCallbackMemAcc(const ocsd_vaddr_t st_address, const o
         else
             err = OCSD_ERR_MEM;    // wrong type of object - treat as mem error
 
-        if(err != OCSD_OK)
+        if (err != OCSD_OK)
             TrcMemAccFactory::DestroyAccessor(p_accessor);
+        else
+            addMemAccessorToList(p_accessor);
     }
     return err;
 }
diff --git a/decoder/tests/auto-fdo/autofdo.md b/decoder/tests/auto-fdo/autofdo.md
index 5d55cd0..2ba6bee 100644
--- a/decoder/tests/auto-fdo/autofdo.md
+++ b/decoder/tests/auto-fdo/autofdo.md
@@ -56,7 +56,7 @@ components:
       recent data
     * ETR: A larger (several megabytes) buffer that uses system RAM to
       store data
-    * TPIU: Sends data to an off-chip capture device (e.g. Arm DSTREAM) 
+    * TPIU: Sends data to an off-chip capture device (e.g. Arm DSTREAM)
 
 Each Arm SoC design may have a different layout (topology) of components.
 This topology is described to the OS drivers by the platform's devicetree
@@ -75,16 +75,97 @@ execution, so we can avoid this problem by using the ETM's features to
 only record small slices of execution - e.g. collect ~5000 cycles of data
 every 50M cycles.  This reduces the data rate to a manageable level - a few
 megabytes per minute.  This technique is known as 'strobing'.
- 
+
 
 ## Enabling trace
 
 ### Driver support
 
-To collect ETM trace, the CoreSight drivers must be included in the
-kernel.  Some of the driver support is not yet included in the mainline
-kernel and many targets are using older kernels.  To enable CoreSight trace
-on these targets, Arm have provided backports of the latest CoreSight
+CoreSight drivers must be built into the kernel to collect the trace.
+
+Typically the CoreSight trace drivers are be enabled in the kernel
+configuration.  This can be done using the configuration menu (`make
+menuconfig`), selecting `Kernel hacking` / `arm64 Debugging`  /`CoreSight Tracing Support` and
+enabling all options, or by setting the following in the configuration
+file:
+
+```
+CONFIG_CORESIGHT=y
+CONFIG_CORESIGHT_LINK_AND_SINK_TMC=y
+CONFIG_CORESIGHT_LINKS_AND_SINKS=y
+CONFIG_CORESIGHT_SINK_TPIU=y
+CONFIG_CORESIGHT_SOURCE_ETM4X=y
+CONFIG_CORESIGHT_DYNAMIC_REPLICATOR=y
+CONFIG_CORESIGHT_STM=y
+CONFIG_CORESIGHT_CATU=y
+```
+
+Coresight support can also be built as modules.
+
+Compile the kernel for your target in the usual way, e.g.
+
+```
+make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
+```
+
+Each target may have a different layout of CoreSight components.  To
+collect trace into a sink, the kernel drivers need to know which other
+devices need to be configured to route data from the source to the sink.
+This is described in the devicetree (and in future, the ACPI tables).  The
+device tree will define which CoreSight devices are present in the system,
+where they are located and how they are connected together.  The devicetree
+for some platforms includes a description of the platform's CoreSight
+components, but in other cases you may have to ask the platform/SoC vendor
+to supply it or create it yourself (see Appendix: Describing CoreSight in
+Devicetree).
+
+Once the target has been booted with the devicetree describing the
+CoreSight devices, you should find the devices in sysfs:
+
+```
+# ls /sys/bus/coresight/devices/
+etm0  etm2  etm4  etm6  funnel0  funnel2  funnel4      stm0      tmc_etr0
+etm1  etm3  etm5  etm7  funnel1  funnel3  replicator0  tmc_etf0
+```
+
+If `/sys/bus/coresight/devices/` is empty, you may want to check out your Kernel configuration to make sure your .config file is including CoreSight dependencies, such as the clock.
+
+The naming convention for etm devices can be different according to the kernel version you're using.
+For more information about the naming scheme, please check out the [Linux Kernel Documentation](https://www.kernel.org/doc/html/latest/trace/coresight/coresight.html#device-naming-scheme)
+
+### Configuration support - enabling strobing.
+
+From kernel version 5.16 onwards, the CoreSight System Configuration
+Management infrastructure is added that allows more complex CoreSight
+programming to be loaded on demand in the form of configurations and
+features, managed by configfs.
+
+A named configuration is a set of features and default parameters and
+presets.
+
+A feature is a set of register programming for a particular CoreSight
+component, which may contain some variable parameters that can be set
+from configfs, or set be specifying a particular preset from the
+configuration.
+
+There is a built-in name configuration called `autofdo`.
+This will load a feature called `strobing` onto each ETMv4 used in a
+trace session. The strobing feature defines two parameters called
+`window` and `period`. These are set prior to trace capture to control
+the strobing feature.
+
+When a trace session uses a configuration, the feature programming is
+carried out on all devices used during that session, and only those devices that are used.
+This avoids the need to program up all devices individually before starting a session.
+
+For additional information on using CoreSight configurations see the [CoreSight System Configuration Manager](https://www.kernel.org/doc/html/latest/trace/coresight/coresight-config.html) in the Linux Kernel Documentation.
+
+### Older Kernels (before 5.16) {#older_kernels}
+
+For targets using kernels prior to 5.16, CoreSight trace with strobing
+is enabled differently.
+
+For these targets, Arm have provided backports of the deprecated CoreSight
 drivers and ETM strobing patch at:
 
   <https://gitlab.arm.com/linux-arm/linux-coresight-backports>
@@ -99,7 +180,7 @@ You can include these backports in your kernel by either merging the
 appropriate branch using git or generating patches (using `git
 format-patch`).
 
-For 5.x based kernel onwards, the only patch which needs to be applied is the one enabling strobing - etm4x: `Enable strobing of ETM`.
+For 5.0 to 5.15 based kernels, the only patch which needs to be applied is the one enabling strobing - etm4x: `Enable strobing of ETM`.
 
 For 4.9 based kernels, use the `coresight-4.9-etr-etm_strobe` branch:
 
@@ -129,54 +210,14 @@ cd my_kernel
 git am /output/dir/*.patch # or patch -p1 /output/dir/*.patch if not using git
 ```
 
-The CoreSight trace drivers must also be enabled in the kernel
-configuration.  This can be done using the configuration menu (`make
-menuconfig`), selecting `Kernel hacking` / `arm64 Debugging`  /`CoreSight Tracing Support` and
-enabling all options, or by setting the following in the configuration
-file:
-
-```
-CONFIG_CORESIGHT=y
-CONFIG_CORESIGHT_LINK_AND_SINK_TMC=y
-CONFIG_CORESIGHT_SINK_TPIU=y
-CONFIG_CORESIGHT_SOURCE_ETM4X=y
-CONFIG_CORESIGHT_DYNAMIC_REPLICATOR=y
-CONFIG_CORESIGHT_STM=y
-CONFIG_CORESIGHT_CATU=y
-```
-
-Compile the kernel for your target in the usual way, e.g.
+For these kernels, configuration management is not available, so strobing is built directly into the sysfs of the individual components.
+The scripts set_strobing.sh and show_strobing.sh must be used to program up each individual ETM prior to starting a trace session.
 
 ```
-make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- 
-```
-
-Each target may have a different layout of CoreSight components.  To
-collect trace into a sink, the kernel drivers need to know which other
-devices need to be configured to route data from the source to the sink.
-This is described in the devicetree (and in future, the ACPI tables).  The
-device tree will define which CoreSight devices are present in the system,
-where they are located and how they are connected together.  The devicetree
-for some platforms includes a description of the platform's CoreSight
-components, but in other cases you may have to ask the platform/SoC vendor
-to supply it or create it yourself (see Appendix: Describing CoreSight in
-Devicetree).
-  
-Once the target has been booted with the devicetree describing the
-CoreSight devices, you should find the devices in sysfs:
-
-```
-# ls /sys/bus/coresight/devices/
-etm0  etm2  etm4  etm6  funnel0  funnel2  funnel4      stm0      tmc_etr0
-etm1  etm3  etm5  etm7  funnel1  funnel3  replicator0  tmc_etf0
+sudo ./set_strobing.sh 5000 10000
 ```
 
-The naming convention for etm devices can be different according to the kernel version you're using.
-For more information about the naming scheme, please check out the [Linux Kernel Documentation](https://www.kernel.org/doc/html/latest/trace/coresight/coresight.html#device-naming-scheme)
-
-If `/sys/bus/coresight/devices/` is empty, you may want to check out your Kernel configuration to make sure your .config file is including CoreSight dependencies, such as the clock.
-
-### Perf tools
+## Perf tools
 
 The perf tool is used to capture execution trace, configuring the trace
 sources to generate trace, routing the data to the sink and collecting the
@@ -207,7 +248,15 @@ perf record -e cs_etm/@tmc_etr0/u --per-thread -- /bin/ls
 
 Will record the userspace execution of '/bin/ls' using tmc_etr0 as sink.
 
-## Capturing modes
+Alternatively, the sink can be omitted an the system will choose the most appropriate
+sink:
+
+```
+perf record -e cs_etm//u --per-thread -- /bin/ls
+```
+
+
+### Capturing modes
 
 You can trace a single-threaded program in two different ways:
 
@@ -228,14 +277,14 @@ Linux v4.17 or later, as the trace processing code isn't included in the
 driver backports.  Trace decode is provided by the OpenCSD library
 (<https://github.com/Linaro/OpenCSD>), v0.9.1 or later.  This is packaged
 for debian testing (install the libopencsd0, libopencsd-dev packages) or
-can be compiled from source and installed. 
+can be compiled from source and installed.
 
 The autoFDO tool <https://github.com/google/autofdo> is used to convert the
 instruction profiles to source profiles for the GCC and clang/llvm
 compilers.
 
 
-## Recording and profiling
+### Recording trace for the profile
 
 Once trace collection using perf is working, we can now use it to profile
 an application.
@@ -254,22 +303,27 @@ tool.  There are two parameters:
 
   * window size: A number of CPU cycles (W)
   * period: Trace is enabled for W cycle every _period_ * W cycles.
-  
-For example, a typical configuration is to use a window size of 5000 cycles
-and a period of 10000 - this will collect 5000 cycles of trace every 50M
-cycles.  With these proof-of-concept patches, the strobe parameters are
-configured via sysfs - each ETM will have `strobe_window` and
-`strobe_period` parameters in `/sys/bus/coresight/devices/<sink>` and
-these values will have to be written to each (In a future version, this
-will be integrated into the drivers and perf tool).
-The `set_strobing.sh` script in this directory [`<opencsd>/decoder/tests/auto-fdo`] automates this process.
 
-To collect trace from an application using ETM strobing, run:
+To collect trace from an application using ETM strobing with default parameters run:
 
 ```
-sudo ./set_strobing.sh 5000 10000
-perf record -e cs_etm/@tmc_etr0/u --per-thread -- <your app>"
+perf record -e cs_etm/autofdo/u --per-thread -- <your app>
+```
+
+To use specific strobing parameters, run:
+
 ```
+echo 5000 > /configfs/cs-syscfg/features/strobing/window/value
+echo 10000 > /configfs/cs-syscfg/features/strobing/period/value
+perf record -e cs_etm/autofdo/u --per-thread -- <your app>
+```
+
+or alternatively, use on of the built-in parameter presets:
+
+```
+perf record -e cs_etm/autofdo,preset=1/u --per-thread -- <your app>
+```
+
 
 The raw trace can be examined using the `perf report` command:
 
@@ -303,13 +357,13 @@ For example:
 . ... CoreSight ETM Trace data: size 2098112 bytes
         Idx:0; ID:12;   I_ASYNC : Alignment Synchronisation.
         Idx:12; ID:12;  I_TRACE_INFO : Trace Info.; INFO=0x0
-        Idx:17; ID:12;  I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C; 
+        Idx:17; ID:12;  I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C;
         Idx:48; ID:14;  I_ASYNC : Alignment Synchronisation.
         Idx:60; ID:14;  I_TRACE_INFO : Trace Info.; INFO=0x0
-        Idx:65; ID:14;  I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C; 
+        Idx:65; ID:14;  I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C;
         Idx:96; ID:14;  I_ASYNC : Alignment Synchronisation.
         Idx:108; ID:14; I_TRACE_INFO : Trace Info.; INFO=0x0
-        Idx:113; ID:14; I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C; 
+        Idx:113; ID:14; I_ADDR_L_64IS0 : Address, Long, 64 bit, IS0.; Addr=0xFFFF000008A4991C;
         Idx:122; ID:14; I_TRACE_ON : Trace On.
         Idx:123; ID:14; I_ADDR_CTXT_L_64IS0 : Address & Context, Long, 64 bit, IS0.; Addr=0x0000000000407B00; Ctxt: AArch64,EL0, NS; 
         Idx:134; ID:14; I_ATOM_F3 : Atom format 3.; ENN
@@ -322,6 +376,8 @@ For example:
 .....
 ```
 
+### Generating the profile from the trace
+
 The execution trace is then converted to an instruction profile using
 the perf build with trace decode support.  This may be done on a different
 machine than that which collected the trace (e.g. when cross compiling for
@@ -385,9 +441,12 @@ autofdo tool to generate source level profiles for the compiler.  For
 clang/LLVM:
 
 ```
-create_llvm_prof -binary=/path/to/binary -profile=inj.data -out=program.llvmprof
+create_llvm_prof -binary=/path/to/binary -format extbinary -profile=inj.data -out=program.llvmprof
 ```
 
+The optional `-format extbinary` creates an output suitable for FSAFDO sometimes used in the kernel, and give improved performance gains. See AFDO
+docs for more details.
+
 And for GCC:
 
 ```
@@ -406,7 +465,7 @@ Or, for GCC:
 dump_gcov -gcov_version=1 program.gcov
 ```
 
-## Using profile in the compiler
+### Using profile in the compiler
 
 The profile produced by the above steps can then be passed to the compiler
 to optimize the next build of the program.
@@ -424,15 +483,14 @@ clang -O2 -fprofile-sample-use=program.llvmprof -o program program.c
 ```
 
 
-## Summary
+### Summary
 
 The basic commands to run an application and create a compiler profile are:
 
 ```
-sudo ./set_strobing.sh 5000 10000
-perf record -e cs_etm/@tmc_etr0/u --per-thread -- <your app>"
+perf record -e cs_etm/autofdo/u --per-thread -- <your app>
 perf inject -i perf.data -o inj.data --itrace=i100000il
-create_llvm_prof -binary=/path/to/binary -profile=inj.data -out=program.llvmprof
+create_llvm_prof -binary=/path/to/binary -format extbinary -profile=inj.data -out=program.llvmprof
 clang -O2 -fprofile-sample-use=program.llvmprof -o program program.c
 ```
 
@@ -440,25 +498,33 @@ Use `create_gcov` for gcc.
 
 ## High Level Summary for recoding on Arm board and decoding on different host
 
-1. (on Arm board)
-
-        sudo ./set_strobing.sh 5000 10000
-        perf record -e cs_etm/@tmc_etr0/u --per-thread -- <your app>.
-	If you specify `-N, --no-buildid-cache`, perf will just take care of recording the target binary and nothing will be copied.<br>  If you don't specify it, any recorded dynamic library will be copied to ~/.debug in the board.
+1. (on Arm board) `perf record -e cs_etm/autofdo/u --per-thread -- <your app>.` <br>
+	If you specify `-N, --no-buildid-cache`, perf will just take care of recording the target binary and nothing will be copied.<br>  If you don't specify it, any recorded dynamic library will be copied to ~/.debug in the board.<br><br>
 
 2. (on Arm board) `perf archive` which saves all the found libraries in a tar (internally, it looks into perf.data file and performs a lookup using perf-buildid-list --with-hits)
-3. (on host) `scp` to copy perf.data and the .tar file generated from `perf archive`.
-4. (on host) Run `tar xvf perf_data.tar.bz2 -C ~/.debug` to populate the buildid-cache
+
+3. (on host) `scp` to copy perf.data and the .tar file generated from `perf archive`.<br><br>
+
+4. (on host) Run `tar xvf perf_data.tar.bz2 -C ~/.debug` to populate the buildid-cache<br><br>
+
 5. (on host) Double check the setup is correct:
 
-       a. `perf buildid-list -i perf.data` gives you the list of dynamic libraries buildids whose trace has been recorded and saved in perf.data.
-       b. `perf buildid-cache --list` lists the dynamic libraries in the buildid cache that will be used by `perf inject`.
-	Make sure the output of (a) and (b) overlaps as in buildid value for those binaries you are interested into optimizing with afdo.
+    (a) `perf buildid-list -i perf.data`
+       - gives you the list of dynamic libraries buildids whose trace has been recorded and saved in perf.data.<br><br>
+
+    (b) `perf buildid-cache --list` <br>
+       - lists the dynamic libraries in the buildid cache that will be used by `perf inject`.<br>
+	Make sure the output of (a) and (b) overlaps as in buildid value for those binaries you are interested into optimizing with afdo.<br><br>
 
-6. (on host) `perf inject -i perf.data -o inj.data --itrace=i100000il` will check for the dynamic libraries using the buildid inside the buildid-cache and post-process the trace.<br>  buildids have to be the same, otherwise it won't be possible to post-process the trace.
+6. (on host) `perf inject -i perf.data -o inj.data --itrace=i100000il` <br>
+    - will check for the dynamic libraries using the buildid inside the buildid-cache and post-process the trace.<br>
+    buildids have to be the same, otherwise it won't be possible to post-process the trace. <br><br>
 
-7. (on host) `create_llvm_prof -binary=/path/to/binary -profile=inj.data -out=program.llvmprof` takes the output from perf-inject and tranforms it into a format that the compiler can read.
-8. (on host) `clang -O2 -fprofile-sample-use=program.llvmprof -o program program.c` to make clang use the produced profile.<br>
+7. (on host) `create_llvm_prof -binary=/path/to/binary -format extbinary -profile=inj.data -out=program.llvmprof` <br>
+    - takes the output from perf-inject and tranforms it into a format that the compiler can read. <br><br>
+
+8. (on host) `clang -O2 -fprofile-sample-use=program.llvmprof -o program program.c` <br>
+    - to make clang use the produced profile.<br>
 	If you are confident enough that your profile is accurate, you can add the `-fprofile-sample-accurate` flag, which will penalize all the callsites without corresponding profile, marking them as cold.
 
 If you are using the same host for both building the binary to be traced and re-building it with afdo:
@@ -483,7 +549,7 @@ You can check the buildid of a given binary/dynamic library:
 * AutoFDO tool: <https://github.com/google/autofdo>
 * GCC's wiki on autofdo: <https://gcc.gnu.org/wiki/AutoFDO>, <https://gcc.gnu.org/wiki/AutoFDO/Tutorial>
 * Google paper: <https://ai.google/research/pubs/pub45290>
-* CoreSight kernel docs: Documentation/trace/coresight.txt
+* CoreSight kernel docs: <https://www.kernel.org/doc/html/latest/trace/coresight/index.html>
 
 
 ## Appendix: Describing CoreSight in Devicetree
@@ -504,7 +570,7 @@ To create the device tree, some information about the platform is required:
   the CPU's address space where the CPU can access each CoreSight
   component.
 * The connections between the components.
-  
+
 This information can be found in the SoC's reference manual or you may need
 to ask the platform/SoC vendor to supply it.
 
@@ -590,9 +656,9 @@ components with similar blocks until we reach the sink (an ETR):
 ```
 
 Full descriptions of the properties of each component can be found in the
-Linux source at Documentation/devicetree/bindings/arm/coresight.txt.
-The Arm Juno platform's devicetree (arch/arm64/boot/dts/arm) provides an example
-description of CoreSight description.
+Linux source at Documentation/devicetree/bindings/arm/ - files which start `arm,coresight-` are the component bindings.
+
+The Arm Juno platform's devicetree (arch/arm64/boot/dts/arm) provides an example description of CoreSight description.
 
 Many systems include a TPIU for off-chip trace.  While this isn't required
 for self-hosted trace, it should still be included in the devicetree.  This
diff --git a/decoder/tests/build/linux/c_api_pkt_print_test/makefile b/decoder/tests/build/unix_common/c_api_pkt_print_test/makefile
similarity index 95%
rename from decoder/tests/build/linux/c_api_pkt_print_test/makefile
rename to decoder/tests/build/unix_common/c_api_pkt_print_test/makefile
index 57fc9bb..f0de184 100644
--- a/decoder/tests/build/linux/c_api_pkt_print_test/makefile
+++ b/decoder/tests/build/unix_common/c_api_pkt_print_test/makefile
@@ -59,14 +59,14 @@ test_app: 	$(BIN_TEST_TARGET_DIR)/$(PROG)
  $(BIN_TEST_TARGET_DIR)/$(PROG): $(OBJECTS) | build_dir
 			mkdir -p  $(BIN_TEST_TARGET_DIR)
 			$(LINKER) $(LDFLAGS) $(OBJECTS) $(LIBS) -o $(BIN_TEST_TARGET_DIR)/$(PROG)
-			cp $(LIB_TARGET_DIR)/*.so .
+			cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX) .
 
 build_dir:
 	mkdir -p $(BUILD_DIR)
 
 .PHONY: copy_libs
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX) $(BIN_TEST_TARGET_DIR)/.
 
 
 #### build rules
@@ -85,7 +85,7 @@ $(BUILD_DIR)/%.o : %.c | build_dir
 clean :
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG) $(OBJECTS)
 	-rm $(DEPS)
-	-rm ./*.so
+	-rm ./*.$(SHARED_LIB_SUFFIX)
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/build/linux/echo_test_dcd_lib/makefile b/decoder/tests/build/unix_common/echo_test_dcd_lib/makefile
similarity index 100%
rename from decoder/tests/build/linux/echo_test_dcd_lib/makefile
rename to decoder/tests/build/unix_common/echo_test_dcd_lib/makefile
diff --git a/decoder/tests/build/linux/frame_demux_test/makefile b/decoder/tests/build/unix_common/frame_demux_test/makefile
similarity index 95%
rename from decoder/tests/build/linux/frame_demux_test/makefile
rename to decoder/tests/build/unix_common/frame_demux_test/makefile
index 36980ca..6a8724d 100644
--- a/decoder/tests/build/linux/frame_demux_test/makefile
+++ b/decoder/tests/build/unix_common/frame_demux_test/makefile
@@ -63,7 +63,7 @@ build_dir:
 
 .PHONY: copy_libs
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so* $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)* $(BIN_TEST_TARGET_DIR)/.
 
 
 
@@ -82,7 +82,7 @@ $(BUILD_DIR)/%.o : %.cpp | build_dir
 clean :
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG) $(OBJECTS)
 	-rm $(DEPS)
-	-rm $(BIN_TEST_TARGET_DIR)/*.so*
+	-rm $(BIN_TEST_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/build/linux/mem_acc_test/makefile b/decoder/tests/build/unix_common/mem_acc_test/makefile
similarity index 95%
rename from decoder/tests/build/linux/mem_acc_test/makefile
rename to decoder/tests/build/unix_common/mem_acc_test/makefile
index 3b968d9..afd1539 100644
--- a/decoder/tests/build/linux/mem_acc_test/makefile
+++ b/decoder/tests/build/unix_common/mem_acc_test/makefile
@@ -63,7 +63,7 @@ build_dir:
 
 .PHONY: copy_libs
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so* $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)* $(BIN_TEST_TARGET_DIR)/.
 
 
 
@@ -82,7 +82,7 @@ $(BUILD_DIR)/%.o : %.cpp | build_dir
 clean :
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG) $(OBJECTS)
 	-rm $(DEPS)
-	-rm $(BIN_TEST_TARGET_DIR)/*.so*
+	-rm $(BIN_TEST_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/build/linux/mem_buffer_eg/makefile b/decoder/tests/build/unix_common/mem_buffer_eg/makefile
similarity index 95%
rename from decoder/tests/build/linux/mem_buffer_eg/makefile
rename to decoder/tests/build/unix_common/mem_buffer_eg/makefile
index 81799b8..79925f0 100644
--- a/decoder/tests/build/linux/mem_buffer_eg/makefile
+++ b/decoder/tests/build/unix_common/mem_buffer_eg/makefile
@@ -65,7 +65,7 @@ build_dir:
 
 .PHONY: copy_libs
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so* $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)* $(BIN_TEST_TARGET_DIR)/.
 
 
 
@@ -84,7 +84,7 @@ $(BUILD_DIR)/%.o : %.cpp | build_dir
 clean :
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG) $(OBJECTS)
 	-rm $(DEPS)
-	-rm $(BIN_TEST_TARGET_DIR)/*.so*
+	-rm $(BIN_TEST_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/build/linux/perr/makefile b/decoder/tests/build/unix_common/perr/makefile
similarity index 95%
rename from decoder/tests/build/linux/perr/makefile
rename to decoder/tests/build/unix_common/perr/makefile
index b2d3601..1178a91 100644
--- a/decoder/tests/build/linux/perr/makefile
+++ b/decoder/tests/build/unix_common/perr/makefile
@@ -63,7 +63,7 @@ build_dir:
 
 .PHONY: copy_libs
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so* $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)* $(BIN_TEST_TARGET_DIR)/.
 
 
 
@@ -82,7 +82,7 @@ $(BUILD_DIR)/%.o : %.cpp | build_dir
 clean :
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG) $(OBJECTS)
 	-rm $(DEPS)
-	-rm $(BIN_TEST_TARGET_DIR)/*.so*
+	-rm $(BIN_TEST_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/build/linux/snapshot_parser_lib/makefile b/decoder/tests/build/unix_common/snapshot_parser_lib/makefile
similarity index 100%
rename from decoder/tests/build/linux/snapshot_parser_lib/makefile
rename to decoder/tests/build/unix_common/snapshot_parser_lib/makefile
diff --git a/decoder/tests/build/linux/trc_pkt_lister/makefile b/decoder/tests/build/unix_common/trc_pkt_lister/makefile
similarity index 96%
rename from decoder/tests/build/linux/trc_pkt_lister/makefile
rename to decoder/tests/build/unix_common/trc_pkt_lister/makefile
index 236d263..a020f24 100644
--- a/decoder/tests/build/linux/trc_pkt_lister/makefile
+++ b/decoder/tests/build/unix_common/trc_pkt_lister/makefile
@@ -75,7 +75,7 @@ ifdef TEST_STATIC_LINKING
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG_S) 
 endif
 copy_libs: $(BIN_TEST_TARGET_DIR)/$(PROG)
-	cp $(LIB_TARGET_DIR)/*.so* $(BIN_TEST_TARGET_DIR)/.
+	cp $(LIB_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)* $(BIN_TEST_TARGET_DIR)/.
 
 
 
@@ -97,7 +97,7 @@ ifdef TEST_STATIC_LINKING
 	-rm $(BIN_TEST_TARGET_DIR)/$(PROG_S)
 endif
 	-rm $(DEPS)
-	-rm $(BIN_TEST_TARGET_DIR)/*.so*
+	-rm $(BIN_TEST_TARGET_DIR)/*.$(SHARED_LIB_SUFFIX)*
 	-rmdir $(BUILD_DIR)
 
 # end of file makefile
diff --git a/decoder/tests/run_pkt_decode_tests-ete.bash b/decoder/tests/run_pkt_decode_tests-ete.bash
index a82cb68..4a9d35c 100755
--- a/decoder/tests/run_pkt_decode_tests-ete.bash
+++ b/decoder/tests/run_pkt_decode_tests-ete.bash
@@ -60,7 +60,7 @@ declare -a test_dirs_decode=( "001-ack_test"
                               "ete_spec_1"
                               "ete_spec_2"
                               "ete_spec_3"
-                              "ete_wfet"
+                              "ete-wfet"
                               "event_test"
                               "infrastructure"
                               "pauth_lr"
@@ -119,20 +119,20 @@ fi
 for test_dir in "${test_dirs_decode[@]}"
 do
     echo "Testing $test_dir..."
-    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir" $@ -decode -logfilename "${OUT_DIR}/$test_dir.ppl"
+    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir" $@ -decode -no_time_print -logfilename "${OUT_DIR}/$test_dir.ppl"
     echo "Done : Return $?"
 done
 
 for test_dir_n in "${test_dirs_decode_src_addr_opt[@]}"
 do
     echo "Testing with -src_addr_n  $test_dir_n..."
-    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir_n" $@ -decode -src_addr_n -logfilename "${OUT_DIR}/${test_dir_n}_src_addr_N.ppl"
+    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir_n" $@ -decode  -no_time_print -src_addr_n -logfilename "${OUT_DIR}/${test_dir_n}_src_addr_N.ppl"
     echo "Done : Return $?"
 done
 
 for test_dir_ms in "${test_dirs_decode_multi_sess[@]}"
 do
     echo "Testing with -multi_session  $test_dir_ms..."
-    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir_ms" $@ -decode -multi_session -logfilename "${OUT_DIR}/${test_dir_ms}_multi_sess.ppl"
+    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir_ms" $@ -decode -no_time_print -multi_session -logfilename "${OUT_DIR}/${test_dir_ms}_multi_sess.ppl"
     echo "Done : Return $?"
 done
diff --git a/decoder/tests/run_pkt_decode_tests.bash b/decoder/tests/run_pkt_decode_tests.bash
index 30b56f2..2f7c8da 100755
--- a/decoder/tests/run_pkt_decode_tests.bash
+++ b/decoder/tests/run_pkt_decode_tests.bash
@@ -93,7 +93,7 @@ fi
 for test_dir in "${test_dirs_decode[@]}"
 do
     echo "Testing $test_dir..."
-    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir" $@ -decode -logfilename "${OUT_DIR}/$test_dir.ppl"
+    ${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/$test_dir" $@ -decode -no_time_print -logfilename "${OUT_DIR}/$test_dir.ppl"
     echo "Done : Return $?"
 done
 
@@ -102,7 +102,7 @@ done
 echo "Test with run limit on..."
 export OPENCSD_INSTR_RANGE_LIMIT=100
 env | grep OPENCSD
-${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -logfilename "${OUT_DIR}/juno_r1_1_rangelimit.ppl"
+${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -no_time_print -logfilename "${OUT_DIR}/juno_r1_1_rangelimit.ppl"
 unset OPENCSD_INSTR_RANGE_LIMIT
 echo "Done : Return $?"
 env | grep OPENCSD
@@ -110,39 +110,50 @@ env | grep OPENCSD
 echo "Test with bad opcode detect on using env var..."
 export OPENCSD_ERR_ON_AA64_BAD_OPCODE=1
 env | grep OPENCSD
-${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -logfilename "${OUT_DIR}/juno_r1_1_badopcode.ppl"
+${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -no_time_print -logfilename "${OUT_DIR}/juno_r1_1_badopcode.ppl"
 unset OPENCSD_ERR_ON_AA64_BAD_OPCODE
 echo "Done : Return $?"
 env | grep OPENCSD
 
 echo "Test with bad opcode detect on using flag..."
-${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -aa64_opcode_chk -logfilename "${OUT_DIR}/juno_r1_1_badopcode_flag.ppl"
+${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/juno_r1_1" $@ -decode -no_time_print -aa64_opcode_chk -logfilename "${OUT_DIR}/juno_r1_1_badopcode_flag.ppl"
 echo "Done : Return $?"
 
 # === test a packet only example ===
 echo "Testing init-short-addr..."
-${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/init-short-addr" $@ -pkt_mon -logfilename "${OUT_DIR}/init-short-addr.ppl"
+${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/init-short-addr" $@ -pkt_mon -no_time_print -logfilename "${OUT_DIR}/init-short-addr.ppl"
 echo "Done : Return $?"
 
 # === test the TPIU deformatter ===
 echo "Testing a55-test-tpiu..."
-${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/a55-test-tpiu" $@ -dstream_format -o_raw_packed -o_raw_unpacked -logfilename "${OUT_DIR}/a55-test-tpiu.ppl"
+${BIN_DIR}trc_pkt_lister -ss_dir "${SNAPSHOT_DIR}/a55-test-tpiu" $@ -dstream_format -no_time_print -o_raw_packed -o_raw_unpacked -logfilename "${OUT_DIR}/a55-test-tpiu.ppl"
 echo "Done : Return $?"
 
-# === test the C-API lib - this test prog is not installed ===
+# === Run uninstalled test programs ===
 if [ "$1" != "use-installed" ]; then
+
+    # === test the C-API lib ===
     echo "Testing C-API library"
     ${BIN_DIR}c_api_pkt_print_test -ss_path ${SNAPSHOT_DIR} -decode > /dev/null
     echo "Done : Return $?"
     echo "moving result file."
     mv ./c_api_test.log ./${OUT_DIR}/c_api_test.ppl
-fi
 
-# === run the Frame decoder test - program not installed ===
-if [ "$1" != "use-installed" ]; then
+    # === run the Frame decoder test ===
     echo "Running Frame demux test"
     ${BIN_DIR}frame-demux-test > /dev/null
     echo "Done : Return $?"
     echo "moving result file."
     mv ./frame_demux_test.ppl ./${OUT_DIR}/.
+
+    echo "Running memacc tests"
+    echo "Using memory buffer"
+    ${BIN_DIR}mem-buffer-eg   -logfile  -ss_path  ./snapshots  -noprint
+    echo "Done : Return $?"
+    echo "Using callback function"
+    ${BIN_DIR}mem-buffer-eg   -logfile  -ss_path  ./snapshots  -noprint -callback
+    echo "Done : Return $?"
+    echo "moving result files."
+    mv ./mem_buff_demo*.ppl ./${OUT_DIR}/.
+    
 fi
diff --git a/decoder/tests/source/mem_buff_demo.cpp b/decoder/tests/source/mem_buff_demo.cpp
index 052870f..f10f662 100644
--- a/decoder/tests/source/mem_buff_demo.cpp
+++ b/decoder/tests/source/mem_buff_demo.cpp
@@ -46,9 +46,6 @@
 
 #include "opencsd.h"              // the library
 
-// uncomment below to use callback function for program memory image
-// #define EXAMPLE_USE_MEM_CALLBACK
-
 /* Input trace buffer */
 static uint8_t *input_trace_data = 0;  
 static uint32_t input_trace_data_size = 0;
@@ -61,16 +58,83 @@ static ocsd_vaddr_t program_image_address = 0;  // load address on target of pro
 /* a message logger to pass to the error logger / decoder. */
 static ocsdMsgLogger logger;
 
-/* logger callback function - print out error strings */
+static bool use_callback = false;
+static bool use_logfile = false;
+static bool no_print = false;
+
+    /* the file names to create the data buffers */
+#ifdef _WIN32
+static const char *default_base_snapshot_path = "..\\..\\..\\snapshots";
+static const char *juno_snapshot = "\\juno_r1_1\\";
+#else
+static const char *default_base_snapshot_path = "../../../snapshots";
+static const char *juno_snapshot = "/juno_r1_1/";
+#endif
+
+static const char *usr_snapshot_path = 0;
+#define MAX_TRACE_FILE_PATH_LEN 512
+
+/* logger callback class - print out error strings.
+ * Example of custom log printer callback 
+ */
 class logCallback : public ocsdMsgLogStrOutI
 {
 public:
-    logCallback() {};
-    virtual ~logCallback() {};
-    virtual void printOutStr(const std::string &outStr)
+    logCallback()
     {
-        std::cout << outStr.c_str();
+        out_console = true;
+        out_file = false;
     }
+
+    virtual ~logCallback()
+    {
+        closeOutFile();
+    }
+
+    virtual void printOutStr(const std::string& outStr)
+    {
+        if (out_console)
+            std::cout << outStr.c_str();
+        printOutFile(outStr);
+    }
+
+    void setOutConsole(const bool console_output)
+    {
+        out_console = console_output;
+    }
+
+    void setOutFile(const std::string &filename)
+    {
+        openOutFile(filename);
+    }
+
+private:
+    void openOutFile(const std::string &filename)
+    {
+        
+        m_out_file.open(filename.c_str(), std::fstream::out | std::fstream::app);
+        if (m_out_file.is_open())
+            out_file = true;
+    }
+
+    void printOutFile(const std::string& str)
+    {
+        if (out_file)
+        {
+            m_out_file << str;
+        }
+    }
+
+    void closeOutFile()
+    {
+        if (out_file) {
+            // close output file
+            m_out_file.close();
+        }
+    }
+    bool out_file;
+    bool out_console;
+    std::fstream m_out_file;
 };
 static logCallback logCB;
 
@@ -84,10 +148,9 @@ so that errors can be correctly attributed and printed if required
 static ocsdDefaultErrorLogger err_log;  
 
 /* callbacks used by the library */
-#ifdef EXAMPLE_USE_MEM_CALLBACK
+
 // program memory image callback definition
 uint32_t  mem_access_callback_fn(const void *p_context, const ocsd_vaddr_t address, const ocsd_mem_space_acc_t mem_space, const uint32_t reqBytes, uint8_t *byteBuffer);
-#endif
 
 // callback for the decoder output elements
 class DecoderOutputProcessor : public ITrcGenElemIn
@@ -128,22 +191,13 @@ static int initDataBuffers()
     long size;
     size_t bytes_read;
 
-    /* the file names to create the data buffers */
-#ifdef _WIN32
-    static const char *default_base_snapshot_path = "..\\..\\..\\snapshots";
-    static const char *juno_snapshot = "\\juno_r1_1\\";
-#else
-    static const char *default_base_snapshot_path = "../../../snapshots";
-    static const char *juno_snapshot = "/juno_r1_1/";
-#endif
-
     /* trace data and memory file dump names and values - taken from snapshot metadata */
     static const char *trace_data_filename = "cstrace.bin";
     static const char *memory_dump_filename = "kernel_dump.bin";
     static ocsd_vaddr_t mem_dump_address = 0xFFFFFFC000081000;
     
     /* load up the trace data */
-    filename = default_base_snapshot_path;
+    filename = (usr_snapshot_path ? usr_snapshot_path : default_base_snapshot_path);
     filename += (std::string)juno_snapshot;
     filename += (std::string)trace_data_filename;
 
@@ -165,7 +219,7 @@ static int initDataBuffers()
         return OCSD_ERR_FILE_ERROR;
 
     /* load up a memory image */
-    filename = default_base_snapshot_path;
+    filename = (usr_snapshot_path ? usr_snapshot_path : default_base_snapshot_path);
     filename += (std::string)juno_snapshot;
     filename += (std::string)memory_dump_filename;
 
@@ -270,42 +324,45 @@ static ocsd_err_t initialiseDecoder()
     if (ret != OCSD_OK)
         return ret;
 
-#ifdef EXAMPLE_USE_MEM_CALLBACK
-    // in this example we have a single buffer so we demonstrate how to use a callback.
-    // we are passing the buffer pointer as context as we only have one buffer, but this 
-    // could be a structure that is a list of memory image buffers. Context is entirely
-    // client defined.
-    // Always use OCSD_MEM_SPACE_ANY unless there is a reason to restrict the image to a specific
-    // memory space.
-    pDecoder->addCallbackMemAcc(program_image_address, program_image_address + program_image_size-1,
-        OCSD_MEM_SPACE_ANY,mem_access_callback_fn, program_image_buffer);
-#else
-    // or we can use the built in memory buffer interface - split our one buffer into two to 
-    // demonstrate the addition of multiple regions
-    ocsd_vaddr_t block1_st, block2_st;
-    uint32_t block1_sz, block2_sz;
-    uint8_t *p_block1, *p_block2;
-
-    // break our single buffer into 2 buffers for demo purposes
-    block1_sz = program_image_size / 2;
-    block1_sz &= ~0x3; // align
-    block2_sz = program_image_size - block1_sz;
-    block1_st = program_image_address;  // loaded program memory start address of program
-    block2_st = program_image_address + block1_sz;
-    p_block1 = program_image_buffer;
-    p_block2 = program_image_buffer + block1_sz;
-
-    /* how to add 2 "separate" buffers to the decoder */
-    // Always use OCSD_MEM_SPACE_ANY unless there is a reason to restrict the image to a specific
-    // memory space.
-    ret = pDecoder->addBufferMemAcc(block1_st, OCSD_MEM_SPACE_ANY, p_block1, block1_sz);
-    if (ret != OCSD_OK)
-        return ret;
-
-    ret = pDecoder->addBufferMemAcc(block2_st, OCSD_MEM_SPACE_ANY, p_block2, block2_sz);
-    if (ret != OCSD_OK)
-        return ret;
-#endif
+    if (use_callback)
+    {
+        // in this example we have a single buffer so we demonstrate how to use a callback.
+        // we are passing the buffer pointer as context as we only have one buffer, but this 
+        // could be a structure that is a list of memory image buffers. Context is entirely
+        // client defined.
+        // Always use OCSD_MEM_SPACE_ANY unless there is a reason to restrict the image to a specific
+        // memory space.
+        pDecoder->addCallbackMemAcc(program_image_address, program_image_address + program_image_size - 1,
+            OCSD_MEM_SPACE_ANY, mem_access_callback_fn, program_image_buffer);
+    }
+    else
+    {
+        // or we can use the built in memory buffer interface - split our one buffer into two to 
+        // demonstrate the addition of multiple regions
+        ocsd_vaddr_t block1_st, block2_st;
+        uint32_t block1_sz, block2_sz;
+        uint8_t* p_block1, * p_block2;
+
+        // break our single buffer into 2 buffers for demo purposes
+        block1_sz = program_image_size / 2;
+        block1_sz &= ~0x3; // align
+        block2_sz = program_image_size - block1_sz;
+        block1_st = program_image_address;  // loaded program memory start address of program
+        block2_st = program_image_address + block1_sz;
+        p_block1 = program_image_buffer;
+        p_block2 = program_image_buffer + block1_sz;
+
+        /* how to add 2 "separate" buffers to the decoder */
+        // Always use OCSD_MEM_SPACE_ANY unless there is a reason to restrict the image to a specific
+        // memory space.
+        ret = pDecoder->addBufferMemAcc(block1_st, OCSD_MEM_SPACE_ANY, p_block1, block1_sz);
+        if (ret != OCSD_OK)
+            return ret;
+
+        ret = pDecoder->addBufferMemAcc(block2_st, OCSD_MEM_SPACE_ANY, p_block2, block2_sz);
+        if (ret != OCSD_OK)
+            return ret;
+    }
 
     /* finally we need to provide an output callback to recieve the decoded information */
     pDecoder->setGenTraceElemOutI(&output);
@@ -320,7 +377,7 @@ static void destroyDecoder()
     delete [] program_image_buffer;
 }
 
-#ifdef EXAMPLE_USE_MEM_CALLBACK
+
 /* if we set up to use a callback to access memory image then this is what will be called. */
 /* In this case the client must do all the work in determining if the requested address is in the 
    memory area. */
@@ -347,7 +404,6 @@ uint32_t  mem_access_callback_fn(const void *p_context, const ocsd_vaddr_t addre
 
     return read_bytes;
 }
-#endif
 
 /* use the decoder to process the global trace data buffer */
 static ocsd_datapath_resp_t processTraceData(uint32_t *bytes_done)
@@ -386,6 +442,79 @@ static ocsd_datapath_resp_t processTraceData(uint32_t *bytes_done)
     return resp;
 }
 
+void printhelp()
+{
+    printf("mem_buff_demo memory accessor test program\n");
+    printf("==========================================\n\n");
+    printf("options:-\n");
+    printf("    -callback       : test callback mem acc functionality\n");
+    printf("    -logfile        : output test result to logfile\n");
+    printf("    -noprint        : no output to console\n");
+    printf("    -ss_path <path> : set path to snapshot directory\n");
+    printf("\n\n========================================\n\n");
+    
+}
+
+int process_cmd_line_opts(int argc, char* argv[])
+{
+    int options_to_process = argc - 1;
+    int opt_idx = 1;
+    std::string opt;
+
+    while(options_to_process)
+    { 
+        opt = argv[opt_idx];
+
+        if (opt == "-callback")
+            use_callback = true;
+        else if (opt == "-logfile")
+            use_logfile = true;
+        else if (opt == "-noprint")
+            no_print = true;
+        else if (opt == "-ss_path")
+        {
+            opt_idx++;
+            options_to_process--;
+            
+            if ((opt_idx >= argc) || (strlen(argv[opt_idx]) == 0))
+            {
+                printf("-ss_path: Missing path parameter or zero length\n");
+                return -1;
+            }
+            else
+            {
+                if (strlen(argv[opt_idx]) > (MAX_TRACE_FILE_PATH_LEN - 32))
+                {
+                    printf("-ss_path: path too long\n");
+                    return -1;
+                }
+                usr_snapshot_path = argv[opt_idx];
+            }
+        }
+        else
+        {
+            printhelp();
+            return -1;
+        }
+        opt_idx++;
+        options_to_process--;
+    }
+    return 0;
+}
+
+void log_cmd_line_opts(int argc, char* argv[])
+{
+    std::ostringstream oss;
+    oss << "Test Command Line:-\n";
+    oss << argv[0] << "   ";
+    for (int i = 1; i < argc; i++)
+    {
+        oss << argv[i] << "  ";
+    }
+    oss << "\n\n";
+    logCB.printOutStr(oss.str());
+}
+
 /* main routine - init input data, decode, finish ... */
 int main(int argc, char* argv[])
 {
@@ -394,6 +523,18 @@ int main(int argc, char* argv[])
     char msg[256];
     uint32_t bytes_done;
 
+    if (process_cmd_line_opts(argc, argv) != 0)
+        return -1;
+
+    if (use_logfile)
+        logCB.setOutFile(use_callback ? "mem_buff_demo_cb.ppl" : "mem_buff_demo.ppl");
+    if (no_print)
+        logCB.setOutConsole(false);
+
+    logCB.printOutStr("MemBuffDemo\n--------------\n\n");
+    log_cmd_line_opts(argc, argv);
+
+
     /* initialise all the data needed for decode */
     if ((ret = initDataBuffers()) != OCSD_OK)
     {
diff --git a/decoder/tests/source/trc_pkt_lister.cpp b/decoder/tests/source/trc_pkt_lister.cpp
index af421c6..45f0413 100644
--- a/decoder/tests/source/trc_pkt_lister.cpp
+++ b/decoder/tests/source/trc_pkt_lister.cpp
@@ -78,6 +78,7 @@ static bool has_hsync = false;
 static bool stats = false;
 static bool profile = false;
 static bool multi_session = false;  // decode all buffers in snapshot as same config.
+static bool no_time_print = false; // dont print test eleapsed time (easier for regression comparisons)
 
 static uint32_t add_create_flags = 0;
 
@@ -207,6 +208,7 @@ void print_help()
     oss << "-o_raw_unpacked     Output raw unpacked trace data per ID\n";
     oss << "-src_addr_n         ETE protocol: Split source address ranges on N atoms\n";
     oss << "-stats              Output packet processing statistics (if available).\n";
+    oss << "-no_time_print      Do not output the elapsed time for tests.\n";
     oss << "\nConsistency checks\n\n";
     oss << "-aa64_opcode_chk    Check for correct AA64 opcodes (MSW != 0x0000)\n";
     oss << "-direct_br_cond     Check for incorrect N atom on direct unconditional branches\n";
@@ -436,6 +438,10 @@ bool process_cmd_line_opts(int argc, char* argv[])
                 print_help();
                 bOptsOK = false;
             }
+            else if (strcmp(argv[optIdx],"-no_time_print") == 0)
+            {
+                no_time_print = true;
+            }
             else if((opt == "-logstdout") || (opt == "-logstderr") || 
                 (opt == "-logfile") || (opt == "-logfilename"))
             {
@@ -781,7 +787,11 @@ bool ProcessInputFile(DecodeTree *dcd_tree, std::string &in_filename,
         end = std::chrono::steady_clock::now();
         std::chrono::duration<double> sec_elapsed{end -start};
 
-        oss << "Trace Packet Lister : Trace buffer done, processed " << trace_index << " bytes in " << std::setprecision(8) << sec_elapsed.count() << " seconds.\n";
+        oss << "Trace Packet Lister : Trace buffer done, processed " << trace_index << " bytes";
+        if (no_time_print)
+            oss << ".\n";
+        else
+            oss << " in " << std::setprecision(8) << sec_elapsed.count() << " seconds.\n";
         logger.LogMsg(oss.str());
         if (stats)
             PrintDecodeStats(dcd_tree);
```

