```diff
diff --git a/Android.bp b/Android.bp
index cd0b9c99c..5ca551216 100644
--- a/Android.bp
+++ b/Android.bp
@@ -37,7 +37,7 @@ aconfig_declarations {
 java_aconfig_library {
     name: "docsui-flags-aconfig-java-lib",
     aconfig_declarations: "docsui-flags-aconfig",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
     sdk_version: "system_current",
 }
 
@@ -45,7 +45,7 @@ java_library {
     name: "docsui-change-ids",
     srcs: ["src/com/android/documentsui/ChangeIds.java"],
     libs: ["app-compat-annotations"],
-    min_sdk_version: "29",
+    min_sdk_version: "30",
     sdk_version: "system_current",
 }
 
@@ -77,7 +77,7 @@ java_defaults {
     },
 
     sdk_version: "system_current",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
 }
 
 platform_compat_config {
@@ -133,7 +133,7 @@ android_library {
 
     sdk_version: "system_current",
     target_sdk_version: "33",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
     lint: {
         baseline_filename: "lint-baseline.xml",
     },
@@ -144,13 +144,14 @@ android_library {
     defaults: ["documentsui_defaults"],
 
     manifest: "AndroidManifest.xml",
+    flags_packages: ["docsui-flags-aconfig"],
 
     resource_dirs: [],
     libs: ["DocumentsUI-lib"],
 
     sdk_version: "system_current",
     target_sdk_version: "33",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
 }
 
 android_app {
@@ -163,6 +164,8 @@ android_app {
     static_libs: ["DocumentsUI-lib"],
     resource_dirs: [],
 
+    flags_packages: ["docsui-flags-aconfig"],
+
     licenses: [
         "Android-Apache-2.0",
         "packages_apps_DocumentsUI_res_drawable_pd_license",
@@ -170,6 +173,6 @@ android_app {
 
     required: ["privapp_whitelist_com.android.documentsui"],
 
-    min_sdk_version: "29",
+    min_sdk_version: "30",
     updatable: true,
 }
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index d948b605c..944b27471 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -19,7 +19,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
         package="com.android.documentsui">
 
-    <uses-sdk android:minSdkVersion="29"/>
+    <uses-sdk android:minSdkVersion="30"/>
 
     <uses-permission android:name="android.permission.MANAGE_DOCUMENTS" />
     <uses-permission android:name="android.permission.REMOVE_TASKS" />
@@ -52,36 +52,75 @@
         android:allowBackup="true"
         android:backupAgent=".prefs.BackupAgent"
         android:fullBackupOnly="false"
+        android:enableOnBackInvokedCallback="false"
         android:crossProfile="true">
 
         <meta-data
             android:name="com.google.android.backup.api_key"
             android:value="AEdPqrEAAAAInBA8ued0O_ZyYUsVhwinUF-x50NIe9K0GzBW4A" />
 
+        <activity
+            android:name=".picker.TrampolineActivity"
+            android:exported="true"
+            android:theme="@android:style/Theme.NoDisplay"
+            android:featureFlag="com.android.documentsui.flags.redirect_get_content_ro"
+            android:visibleToInstantApps="true">
+            <intent-filter android:priority="120">
+                <action android:name="android.intent.action.OPEN_DOCUMENT" />
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.OPENABLE" />
+                <data android:mimeType="*/*" />
+            </intent-filter>
+            <intent-filter android:priority="120">
+                <action android:name="android.intent.action.CREATE_DOCUMENT" />
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.OPENABLE" />
+                <data android:mimeType="*/*" />
+            </intent-filter>
+            <intent-filter android:priority="120">
+                <action android:name="android.intent.action.GET_CONTENT" />
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.OPENABLE" />
+                <data android:mimeType="*/*" />
+            </intent-filter>
+            <intent-filter android:priority="120">
+                <action android:name="android.intent.action.OPEN_DOCUMENT_TREE" />
+                <category android:name="android.intent.category.DEFAULT" />
+            </intent-filter>
+        </activity>
+
         <activity
             android:name=".picker.PickActivity"
             android:exported="true"
             android:theme="@style/LauncherTheme"
             android:visibleToInstantApps="true">
-            <intent-filter android:priority="100">
+            <intent-filter
+                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
+                android:priority="100">
                 <action android:name="android.intent.action.OPEN_DOCUMENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter android:priority="100">
+            <intent-filter
+                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
+                android:priority="100">
                 <action android:name="android.intent.action.CREATE_DOCUMENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter android:priority="100">
+            <intent-filter
+                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
+                android:priority="100">
                 <action android:name="android.intent.action.GET_CONTENT" />
                 <category android:name="android.intent.category.DEFAULT" />
                 <category android:name="android.intent.category.OPENABLE" />
                 <data android:mimeType="*/*" />
             </intent-filter>
-            <intent-filter android:priority="100">
+            <intent-filter
+                android:featureFlag="!com.android.documentsui.flags.redirect_get_content_ro"
+                android:priority="100">
                 <action android:name="android.intent.action.OPEN_DOCUMENT_TREE" />
                 <category android:name="android.intent.category.DEFAULT" />
             </intent-filter>
diff --git a/AndroidManifestLib.xml b/AndroidManifestLib.xml
index 993d4409a..b7e54192b 100644
--- a/AndroidManifestLib.xml
+++ b/AndroidManifestLib.xml
@@ -18,7 +18,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
         package="com.android.documentsui">
 
-    <uses-sdk android:minSdkVersion="29" android:targetSdkVersion="29" />
+    <uses-sdk android:minSdkVersion="30" android:targetSdkVersion="30" />
 
     <uses-permission android:name="android.permission.MANAGE_DOCUMENTS" />
     <uses-permission android:name="android.permission.REMOVE_TASKS" />
diff --git a/OWNERS b/OWNERS
index 5b8cd52bf..70a483639 100644
--- a/OWNERS
+++ b/OWNERS
@@ -3,3 +3,4 @@
 include platform/frameworks/base:/core/java/android/os/storage/OWNERS
 
 benreich@google.com
+alexbn@google.com
diff --git a/PREUPLOAD.cfg b/PREUPLOAD.cfg
index ebc1264c7..edf1ee5a3 100644
--- a/PREUPLOAD.cfg
+++ b/PREUPLOAD.cfg
@@ -1,4 +1,4 @@
 [Hook Scripts]
 checkstyle_hook = ${REPO_ROOT}/prebuilts/checkstyle/checkstyle.py --sha ${PREUPLOAD_COMMIT}
-
 ktlint_hook = ${REPO_ROOT}/prebuilts/ktlint/ktlint.py -f ${PREUPLOAD_FILES}
+
diff --git a/TEST_MAPPING b/TEST_MAPPING
index 8036110a0..6de67146a 100644
--- a/TEST_MAPPING
+++ b/TEST_MAPPING
@@ -7,5 +7,13 @@
     {
       "name": "DocumentsUIUnitTests"
     }
+  ],
+  "desktop-postsubmit": [    {
+      "name": "DocumentsUIGoogleTests",
+      "keywords": ["primary-device"]
+    },
+    {
+      "name": "DocumentsUIUnitTests"
+    }
   ]
 }
diff --git a/compose/Android.bp b/compose/Android.bp
index f00bf4c20..385dac69e 100644
--- a/compose/Android.bp
+++ b/compose/Android.bp
@@ -46,7 +46,7 @@ android_library {
 
     sdk_version: "system_current",
     target_sdk_version: "33",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
 }
 
 android_app {
@@ -58,5 +58,5 @@ android_app {
     certificate: "platform",
 
     sdk_version: "system_current",
-    min_sdk_version: "29",
+    min_sdk_version: "30",
 }
diff --git a/compose/AndroidManifest.xml b/compose/AndroidManifest.xml
index dbed77310..9b943e086 100644
--- a/compose/AndroidManifest.xml
+++ b/compose/AndroidManifest.xml
@@ -19,7 +19,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
         package="com.android.documentsui.compose">
 
-    <uses-sdk android:minSdkVersion="29"/>
+    <uses-sdk android:minSdkVersion="30"/>
 
     <!-- Permissions copied from com.android.documentsui AndroidManifest.xml -->
     <uses-permission android:name="android.permission.MANAGE_DOCUMENTS" />
diff --git a/flags.aconfig b/flags.aconfig
index 6646e196b..1e31323a5 100644
--- a/flags.aconfig
+++ b/flags.aconfig
@@ -10,10 +10,57 @@ flag {
 }
 
 flag {
-    name: "use_search_v2"
+    name: "use_search_v2_read_only"
     namespace: "documentsui"
     description: "Enables the next generation search functionality."
-    bug: "378590312"
+    bug: "383412640"
     is_fixed_read_only: true
 }
 
+flag {
+    name: "zip_ng_ro"
+    namespace: "documentsui"
+    description: "Enables the next generation ZIP functionality."
+    bug: "382550591"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "desktop_file_handling_ro"
+    namespace: "documentsui"
+    description: "Enables desktop file handling."
+    bug: "381778967"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "visual_signals_ro"
+    namespace: "documentsui"
+    description: "Enables in-app progress display of file operations"
+    bug: "378011512"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "hide_roots_on_desktop_ro"
+    namespace: "documentsui"
+    description: "Enables the hiding of the Images/Videos/Audio/Documents roots on desktop."
+    bug: "381959330"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "redirect_get_content_ro"
+    namespace: "documentsui"
+    description: "Redirects GET_CONTENT requests to Photopicker when appropriate"
+    bug: "377771195"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "use_peek_preview_ro"
+    namespace: "documentsui"
+    description: "Enables the Peek previewing capability as a substitute for the Inspector."
+    bug: "373242058"
+    is_fixed_read_only: true
+}
diff --git a/proguard.flags b/proguard.flags
index a0f96ae09..34071fa6d 100644
--- a/proguard.flags
+++ b/proguard.flags
@@ -23,7 +23,10 @@
 }
 
 # To prevent class not found exception in org.brotli.dec.Dictionary
--keep final class org.brotli.dec.DictionaryData
+# TODO(b/373579455): Evaluate if <init> needs to be kept.
+-keep final class org.brotli.dec.DictionaryData {
+  void <init>();
+}
 
 # keep rule generated after running trace references on the test app against DocumentsUIGoogle.jar
 # TODO(b/339312616): Remove after a more permanent fix is available
@@ -84,11 +87,13 @@
   int cross_profile;
   int cross_profile_content;
   int cross_profile_progress;
+  int dir_menu_browse;
   int dir_menu_copy_to_clipboard;
   int dir_menu_create_dir;
   int dir_menu_cut_to_clipboard;
   int dir_menu_delete;
   int dir_menu_deselect_all;
+  int dir_menu_extract_here;
   int dir_menu_inspect;
   int dir_menu_open;
   int dir_menu_open_in_new_window;
@@ -101,8 +106,10 @@
   int dir_menu_view_in_owner;
   int drawer_layout;
   int inspector_details_view;
+  int job_progress_panel_title;
   int option_menu_create_dir;
   int option_menu_debug;
+  int option_menu_extract_all;
   int option_menu_inspect;
   int option_menu_launcher;
   int option_menu_new_window;
@@ -200,3 +207,8 @@
 
 # Keep Apache Commons Compress classes
 -keep class org.apache.commons.compress.** { *; }
+
+# This is used in the unit test
+-keep class com.google.android.material.chip.Chip {
+  public android.graphics.drawable.Drawable getChipIcon();
+}
\ No newline at end of file
diff --git a/res/menu/action_mode_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
similarity index 100%
rename from res/menu/action_mode_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
diff --git a/res/menu/activity.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/activity.xml
similarity index 92%
rename from res/menu/activity.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/activity.xml
index 39be106ca..9c3516aeb 100644
--- a/res/menu/activity.xml
+++ b/res/flag(!com.android.documentsui.flags.use_material3)/menu/activity.xml
@@ -66,6 +66,13 @@
             android:alphabeticShortcut="a"
             android:visible="false"
             app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_extract_all"
+            android:title="@string/menu_extract_all"
+            android:icon="@drawable/ic_menu_extract"
+            android:enabled="false"
+            android:visible="false"
+            app:showAsAction="always"/>
         <item
             android:id="@+id/option_menu_settings"
             android:title="@string/menu_settings"
diff --git a/res/menu/container_context_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
similarity index 100%
rename from res/menu/container_context_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
diff --git a/res/menu/dir_context_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
similarity index 100%
rename from res/menu/dir_context_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
diff --git a/res/menu/file_context_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
similarity index 100%
rename from res/menu/file_context_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
diff --git a/res/menu/mixed_context_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
similarity index 100%
rename from res/menu/mixed_context_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
diff --git a/res/menu/root_context_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
similarity index 100%
rename from res/menu/root_context_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
diff --git a/res/menu/sub_menu.xml b/res/flag(!com.android.documentsui.flags.use_material3)/menu/sub_menu.xml
similarity index 100%
rename from res/menu/sub_menu.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/menu/sub_menu.xml
diff --git a/res/values-sw720dp/config.xml b/res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/config.xml
similarity index 100%
rename from res/values-sw720dp/config.xml
rename to res/flag(!com.android.documentsui.flags.use_material3)/values-sw720dp/config.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_text_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/breadcrumb_item_ripple_color.xml
similarity index 68%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_text_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/breadcrumb_item_ripple_color.xml
index e4e1edc48..1ca24551e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_text_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/breadcrumb_item_ripple_color.xml
@@ -1,5 +1,6 @@
-<?xml version="1.0" encoding="utf-8"?><!--
-  Copyright 2018 The Android Open Source Project
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2025 The Android Open Source Project
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
@@ -15,6 +16,5 @@
   -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-  <item android:color="@color/fragment_pick_active_text_color" android:state_enabled="true" />
-  <item android:color="@color/fragment_pick_inactive_text_color" android:state_enabled="false" />
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurfaceVariant"/>
 </selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml
new file mode 100644
index 000000000..de2849840
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_badge_icon_color.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_selected="true" android:color="?attr/colorOnPrimary" />
+    <item android:color="?attr/colorSecondary" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_label_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_label_color.xml
new file mode 100644
index 000000000..909bbf05e
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_label_color.xml
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License.
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item
+        android:color="?attr/colorOnPrimaryContainer"
+        android:state_selected="true" />
+    <item android:color="?attr/colorOnSurface" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml
index d9f27e60a..c8843089f 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/doc_list_item_subtitle_color.xml
@@ -16,7 +16,8 @@
   -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_enabled="false"
-        android:color="@color/doc_list_item_subtitle_disabled" />
-    <item android:color="@color/doc_list_item_subtitle_enabled" />
+    <item
+        android:color="?attr/colorOnPrimaryContainer"
+        android:state_selected="true" />
+    <item android:color="?attr/colorOnSurfaceVariant" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/grid_item_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/grid_item_ripple_color.xml
new file mode 100644
index 000000000..85e5b46ce
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/grid_item_ripple_color.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2025 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_enabled="false" android:color="@android:color/transparent" />
+    <!-- By default <ripple> introduces a gray-ish layer for the focused state which we don't
+         want, hence explicitly setting focused ripple color to transparent to get rid of that.
+    -->
+    <item android:state_focused="true" android:color="@android:color/transparent" />
+    <item android:state_selected="true" android:alpha="@dimen/ripple_overlay_alpha"
+        android:color="?attr/colorOnPrimaryContainer" />
+    <item android:alpha="@dimen/ripple_overlay_alpha"
+        android:color="?attr/colorOnSurface" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml
index ab511326d..f615b257c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/horizontal_breadcrumb_color.xml
@@ -15,7 +15,7 @@
 -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_enabled="true"
-        android:color="?android:colorAccent" />
-    <item android:color="?android:attr/colorControlNormal" />
+    <item android:state_enabled="false"
+        android:color="?attr/colorOnSurface" />
+    <item android:color="?attr/colorOnSurfaceVariant" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
index 4487795c1..0ef672d95 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_action_icon.xml
@@ -14,6 +14,7 @@
      limitations under the License.
 -->
 
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_enabled="false"
         android:alpha="@dimen/root_icon_disabled_alpha"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml
index 142d85e6f..e30080679 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_icon.xml
@@ -15,10 +15,9 @@
 -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item
-        android:state_activated="false"
-        android:color="?android:colorControlNormal" />
     <item
         android:state_activated="true"
-        android:color="?android:colorControlActivated" />
+        android:color="?attr/colorOnSecondaryContainer" />
+    <item
+        android:color="?attr/colorOnSurfaceVariant" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml
index 337c1a2c1..c0175ca1b 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_primary_text.xml
@@ -15,8 +15,6 @@
 -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_focused="true" android:state_activated="true" android:color="?android:colorControlActivated" />
-    <item android:state_focused="false" android:state_activated="true" android:color="?android:colorControlActivated" />
-    <item android:state_enabled="false" android:alpha="0.5" android:color="?android:textColorPrimary" />
-    <item android:color="?android:textColorPrimary" />
+    <item android:state_activated="true" android:color="?attr/colorOnSecondaryContainer" />
+    <item android:color="?attr/colorOnSurfaceVariant" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_ripple_color.xml
new file mode 100644
index 000000000..8c974f1f0
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_ripple_color.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2024 The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License");
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+      https://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_activated="true"
+        android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSecondaryContainer"/>
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurface"/>
+</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml
index b6149ff13..50932a8c9 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/item_root_secondary_text.xml
@@ -16,10 +16,6 @@
   -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_focused="true" android:state_activated="true"
-        android:color="?android:colorControlActivated" />
-    <item android:state_focused="false" android:state_activated="true"
-        android:color="?android:colorControlActivated" />
-    <item android:state_enabled="false" android:alpha="0.5" android:color="?android:textColorSecondary" />
-    <item android:color="?android:textColorSecondary" />
+    <item android:state_activated="true" android:color="?attr/colorOnSecondaryContainer" />
+    <item android:color="?attr/colorOnSurfaceVariant" />
 </selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/list_item_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/list_item_ripple_color.xml
new file mode 100644
index 000000000..85e5b46ce
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/list_item_ripple_color.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2025 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_enabled="false" android:color="@android:color/transparent" />
+    <!-- By default <ripple> introduces a gray-ish layer for the focused state which we don't
+         want, hence explicitly setting focused ripple color to transparent to get rid of that.
+    -->
+    <item android:state_focused="true" android:color="@android:color/transparent" />
+    <item android:state_selected="true" android:alpha="@dimen/ripple_overlay_alpha"
+        android:color="?attr/colorOnPrimaryContainer" />
+    <item android:alpha="@dimen/ripple_overlay_alpha"
+        android:color="?attr/colorOnSurface" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_background_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/menu_item_ripple_color.xml
similarity index 68%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_background_color.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/color/menu_item_ripple_color.xml
index cf6d480ea..a5f5ad8b7 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/fragment_pick_button_background_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/menu_item_ripple_color.xml
@@ -1,5 +1,6 @@
-<?xml version="1.0" encoding="utf-8"?><!--
-  Copyright 2018 The Android Open Source Project
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2025 The Android Open Source Project
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
@@ -15,6 +16,5 @@
   -->
 
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
-  <item android:color="@color/fragment_pick_active_button_color" android:state_enabled="true" />
-  <item android:color="@color/fragment_pick_inactive_button_color" android:state_enabled="false" />
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurface" />
 </selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_burger_icon_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_burger_icon_ripple_color.xml
new file mode 100644
index 000000000..19c657b29
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_burger_icon_ripple_color.xml
@@ -0,0 +1,20 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2025 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurfaceVariant" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_item_text_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_item_text_color.xml
new file mode 100644
index 000000000..ec5aecb33
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/nav_rail_item_text_color.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2024 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_activated="true" android:color="?attr/colorSecondary" />
+    <item android:color="?attr/colorOnSurfaceVariant" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_ripple_color.xml
new file mode 100644
index 000000000..de985a40f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_ripple_color.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  Copyright 2024 The Android Open Source Project
+
+  Licensed under the Apache License, Version 2.0 (the "License");
+  you may not use this file except in compliance with the License.
+  You may obtain a copy of the License at
+
+      https://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_activated="true"
+        android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnPrimaryContainer"/>
+    <item android:alpha="@dimen/ripple_overlay_alpha" android:color="?attr/colorOnSurfaceVariant"/>
+</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml
index b4aa0b8a7..09677a81a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_ripple_color.xml
@@ -15,7 +15,7 @@
   limitations under the License.
   -->
 
-<!-- TODO(b/379776735): remove this file after M3 uplift -->
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <!-- Selected. -->
     <item android:state_pressed="true" android:state_selected="true"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
index be0cc404b..6935cef57 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/color/search_chip_text_color.xml
@@ -15,7 +15,7 @@
   limitations under the License.
   -->
 
-<!-- TODO(b/379776735): remove this file after M3 uplift -->
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_selected="true" android:color="@color/search_chip_text_selected_color"/>
     <item android:state_enabled="true" android:color="?android:textColorSecondary"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
index 53f969284..c75b36f21 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/band_select_overlay.xml
@@ -16,7 +16,7 @@
   -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
-        android:shape="rectangle">
-    <solid android:color="@color/band_select_background" />
+        android:shape="rectangle" android:tint="@color/band_select_background">
+    <solid android:color="#52000000" /> <!-- 32% alpha -->
     <stroke android:width="1dp" android:color="@color/band_select_border" />
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
index eba36783f..4574b96f4 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/bottom_sheet_dialog_background.xml
@@ -17,9 +17,10 @@
 
     <solid android:color="?android:attr/colorBackground" />
 
-    <corners android:topLeftRadius="@dimen/grid_item_radius"
-             android:topRightRadius="@dimen/grid_item_radius"
-             android:bottomLeftRadius="0dp"
-             android:bottomRightRadius="0dp"/>
+    <corners
+        android:topLeftRadius="@dimen/bottom_sheet_dialog_radius"
+        android:topRightRadius="@dimen/bottom_sheet_dialog_radius"
+        android:bottomLeftRadius="0dp"
+        android:bottomRightRadius="0dp"/>
 
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
index 8e6282199..3ca0191cd 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_background.xml
@@ -17,25 +17,37 @@
 <ripple
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:color="?attr/colorControlHighlight">
+    android:color="@color/breadcrumb_item_ripple_color">
     <item
         android:id="@android:id/mask"
-        android:drawable="@android:color/white"/>
+        android:drawable="@drawable/breadcrumb_item_mask"/>
 
     <item>
         <selector>
-            <item
-                app:state_highlighted="true"
-                android:drawable="@color/item_breadcrumb_background_hovered"/>
-            <item
-                app:state_highlighted="false"
-                android:drawable="@android:color/transparent">
-                <corners
-                    android:topLeftRadius="2dp"
-                    android:topRightRadius="2dp"
-                    android:bottomLeftRadius="2dp"
-                    android:bottomRightRadius="2dp"
-                />
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurfaceVariant">
+                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_focused="true">
+                <shape>
+                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurfaceVariant">
+                    <corners android:radius="@dimen/breadcrumb_item_height" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+
+            <!-- Default: use the container background. -->
+            <item>
+                <color android:color="@android:color/transparent"/>
             </item>
         </selector>
     </item>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml
new file mode 100644
index 000000000..c64be0765
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/breadcrumb_item_mask.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/breadcrumb_item_height" />
+    <!-- The color here doesn't matter, it's just being used as a mask. -->
+    <solid android:color="@android:color/white" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_file_counter_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_file_counter_background.xml
new file mode 100644
index 000000000..e7e02ee7d
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_file_counter_background.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="rectangle">
+    <solid android:color="@color/drag_file_counter_background" />
+    <corners android:radius="@dimen/drag_file_counter_height" />
+</shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
index eed005eca..0052f4609 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drag_shadow_background.xml
@@ -17,9 +17,5 @@
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
        android:shape="rectangle">
   <solid android:color="@color/item_drag_shadow_background" />
-  <corners
-      android:bottomRightRadius="2dp"
-      android:bottomLeftRadius="2dp"
-      android:topLeftRadius="2dp"
-      android:topRightRadius="2dp"/>
+  <corners android:radius="@dimen/drag_content_radius" />
 </shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_container_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_container_background.xml
new file mode 100644
index 000000000..7dff0ada8
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/drop_badge_container_background.xml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
+    <item
+        android:bottom="@dimen/drop_icon_offset"
+        android:left="0dp"
+        android:right="@dimen/drop_icon_offset"
+        android:top="0dp">
+        <shape android:shape="rectangle">
+            <corners android:radius="@dimen/drop_mime_icon_wrapper_radius" />
+            <solid android:color="@color/drag_mime_icon_wrapper_background" />
+        </shape>
+    </item>
+</layer-list>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_mask.xml
new file mode 100644
index 000000000..98473059c
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_item_mask.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/grid_item_nameplate_radius" />
+    <!-- The color here doesn't matter, it's just being used as a mask. -->
+    <solid android:color="@android:color/white" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml
new file mode 100644
index 000000000..087fc1c15
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_nameplate_background.xml
@@ -0,0 +1,150 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<ripple xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/grid_item_ripple_color">
+
+    <!-- The mask below only works for the ripple itself, doesn't work for other <item>s, we
+         need to explicitly apply the drawable if the other items also need this mask. -->
+    <item android:id="@android:id/mask" android:drawable="@drawable/grid_item_mask"/>
+
+    <item>
+        <selector>
+            <!-- selected -->
+            <item
+                android:state_focused="true"
+                android:state_hovered="true"
+                android:state_selected="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_inner_radius" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
+                        </shape>
+                    </item>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/grid_item_nameplate_inner_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true" android:state_focused="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_inner_radius" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item
+                android:state_hovered="true"
+                android:state_selected="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <solid android:color="?attr/colorPrimaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true">
+                <shape>
+                    <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                    <solid android:color="?attr/colorPrimaryContainer" />
+                </shape>
+            </item>
+
+            <!-- unselected -->
+            <item
+                android:state_focused="true"
+                android:state_hovered="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape android:tint="?attr/colorOnSurface">
+                            <corners android:radius="@dimen/grid_item_nameplate_inner_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_focused="true">
+                <shape>
+                    <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/grid_item_nameplate_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+        </selector>
+    </item>
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml
new file mode 100644
index 000000000..aad18471b
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/grid_thumbnail_background.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?><!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <!-- selected -->
+    <item android:state_selected="true">
+        <shape>
+            <corners android:radius="@dimen/grid_item_thumbnail_radius" />
+            <solid android:color="?attr/colorPrimaryContainer" />
+        </shape>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
index 96fa93ade..dbee1c363 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_arrow_upward.xml
@@ -15,14 +15,12 @@
     limitations under the License.
   -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-    android:width="24dp"
-    android:height="24dp"
-    android:viewportWidth="24"
-    android:viewportHeight="24">
+    android:width="28dp"
+    android:height="32dp"
+    android:viewportHeight="32"
+    android:viewportWidth="28">
 
     <path
-        android:pathData="M0 0h24v24H0V0z" />
-    <path
-        android:fillColor="?android:textColorSecondary"
-        android:pathData="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z" />
+        android:fillColor="?attr/colorOnSecondaryContainer"
+        android:pathData="M13.25 19.125V10.75c0-.208.07-.382.208-.52A.74.74 0 0 1 14 10c.208 0 .382.076.52.23.154.138.23.312.23.52v8.375l3.667-3.667a.718.718 0 0 1 .52-.229c.209 0 .39.077.542.23.153.152.23.333.23.541a.718.718 0 0 1-.23.52l-4.958 4.96a.786.786 0 0 1-.25.166.85.85 0 0 1-.271.041c-.097 0-.194-.013-.292-.041a.878.878 0 0 1-.229-.167l-4.958-4.958A.718.718 0 0 1 8.29 16a.822.822 0 0 1 .25-.542.718.718 0 0 1 .521-.229.74.74 0 0 1 .542.23l3.646 3.666Z" />
 </vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml
index 5305b4ae3..8a4aea8ac 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_breadcrumb_arrow.xml
@@ -15,12 +15,12 @@
 -->
 
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:autoMirrored="true"
-        android:viewportWidth="24"
-        android:viewportHeight="24">
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960"
+    android:autoMirrored="true">
     <path
-        android:fillColor="?android:attr/colorControlNormal"
-        android:pathData="M10,6L8.59,7.41 13.17,12l-4.58,4.59L10,18l6,-6 -6,-6z"/>
+        android:fillColor="?attr/colorSecondary"
+        android:pathData="M504,480L320,296L376,240L616,480L376,720L320,664L504,480Z"/>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml
new file mode 100644
index 000000000..f47cd4f6b
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_cancel.xml
@@ -0,0 +1,24 @@
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportHeight="960"
+    android:viewportWidth="960">
+    <path
+        android:fillColor="?attr/colorOnSurface"
+        android:pathData="M256,760L200,704L424,480L200,256L256,200L480,424L704,200L760,256L536,480L760,704L704,760L480,536L256,760Z" />
+</vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
index 88b784183..71ad135b1 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_check_circle.xml
@@ -14,11 +14,12 @@ Copyright (C) 2024 The Android Open Source Project
     limitations under the License.
 -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="24dp"
-        android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
+    android:width="20dp"
+    android:height="20dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
     <path
-        android:fillColor="?android:attr/colorAccent"
-        android:pathData="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10,-4.48 10,-10S17.52 2 12 2zm-2 15l-5,-5 1.41,-1.41L10 14.17l7.59,-7.59L19 8l-9 9z"/>
+        android:fillColor="?attr/colorOnPrimaryContainer"
+        android:pathData="M428.28,628.78L669.87,388.2L612.41,330.5L428.28,513.63L346.15,432.5L288.7,490.2L428.28,628.78ZM480,872.13Q399.09,872.13 327.66,841.51Q256.22,810.89 202.66,757.34Q149.11,703.78 118.49,632.34Q87.87,560.91 87.87,480Q87.87,398.09 118.49,327.16Q149.11,256.22 202.66,202.66Q256.22,149.11 327.66,118.49Q399.09,87.87 480,87.87Q561.91,87.87 632.84,118.49Q703.78,149.11 757.34,202.66Q810.89,256.22 841.51,327.16Q872.13,398.09 872.13,480Q872.13,560.91 841.51,632.34Q810.89,703.78 757.34,757.34Q703.78,810.89 632.84,841.51Q561.91,872.13 480,872.13Z"/>
 </vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_audio.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_audio.xml
new file mode 100644
index 000000000..ad9707b68
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_audio.xml
@@ -0,0 +1,24 @@
+<!--
+Copyright (C) 2025 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+  <path
+      android:fillColor="?attr/colorPrimary"
+      android:pathData="M400,840Q334,840 287,793Q240,746 240,680Q240,614 287,567Q334,520 400,520Q423,520 442.5,525.5Q462,531 480,542L480,120L720,120L720,280L560,280L560,680Q560,746 513,793Q466,840 400,840Z"/>
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_document.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_document.xml
new file mode 100644
index 000000000..45b8afe1f
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_document.xml
@@ -0,0 +1,25 @@
+<!--
+Copyright (C) 2025 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960"
+    android:autoMirrored="true">
+  <path
+      android:fillColor="?attr/colorPrimary"
+      android:pathData="M240,880Q207,880 183.5,856.5Q160,833 160,800L160,160Q160,127 183.5,103.5Q207,80 240,80L560,80L800,320L800,800Q800,833 776.5,856.5Q753,880 720,880L240,880ZM520,360L520,160L240,160Q240,160 240,160Q240,160 240,160L240,800Q240,800 240,800Q240,800 240,800L720,800Q720,800 720,800Q720,800 720,800L720,360L520,360ZM240,160L240,160L240,360L240,360L240,160L240,360L240,360L240,800Q240,800 240,800Q240,800 240,800L240,800Q240,800 240,800Q240,800 240,800L240,160Q240,160 240,160Q240,160 240,160Z"/>
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml
index dca3b19a0..269a2cab5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_from_this_week.xml
@@ -20,6 +20,6 @@
         android:viewportWidth="24"
         android:viewportHeight="24">
     <path
-        android:fillColor="#5F6368"
+        android:fillColor="?attr/colorPrimary"
         android:pathData="M13,3c-4.97,0 -9,4.03 -9,9L1,12l4,3.99L9,12L6,12c0,-3.87 3.13,-7 7,-7s7,3.13 7,7 -3.13,7 -7,7c-1.93,0 -3.68,-0.79 -4.94,-2.06l-1.42,1.42C8.27,19.99 10.51,21 13,21c4.97,0 9,-4.03 9,-9s-4.03,-9 -9,-9zM12,8v5l4.25,2.52 0.77,-1.28 -3.52,-2.09L13.5,8z"/>
 </vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_image.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_image.xml
new file mode 100644
index 000000000..8a85244b2
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_image.xml
@@ -0,0 +1,24 @@
+<!--
+Copyright (C) 2025 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+  <path
+      android:fillColor="?attr/colorPrimary"
+      android:pathData="M200,840Q167,840 143.5,816.5Q120,793 120,760L120,200Q120,167 143.5,143.5Q167,120 200,120L760,120Q793,120 816.5,143.5Q840,167 840,200L840,760Q840,793 816.5,816.5Q793,840 760,840L200,840ZM200,760L760,760Q760,760 760,760Q760,760 760,760L760,200Q760,200 760,200Q760,200 760,200L200,200Q200,200 200,200Q200,200 200,200L200,760Q200,760 200,760Q200,760 200,760ZM240,680L720,680L570,480L450,640L360,520L240,680ZM200,760Q200,760 200,760Q200,760 200,760L200,200Q200,200 200,200Q200,200 200,200L200,200Q200,200 200,200Q200,200 200,200L200,760Q200,760 200,760Q200,760 200,760Z"/>
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml
index d0fe55090..39c09c97a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_large_files.xml
@@ -20,6 +20,6 @@
         android:viewportWidth="24"
         android:viewportHeight="24">
     <path
-        android:fillColor="#5F6368"
+        android:fillColor="?attr/colorPrimary"
         android:pathData="M21.41,11.58l-9,-9C12.05,2.22 11.55,2 11,2H4c-1.1,0 -2,0.9 -2,2v7c0,0.55 0.22,1.05 0.59,1.42l9,9c0.36,0.36 0.86,0.58 1.41,0.58s1.05,-0.22 1.41,-0.59l7,-7c0.37,-0.36 0.59,-0.86 0.59,-1.41s-0.23,-1.06 -0.59,-1.42zM13,20.01L4,11V4h7v-0.01l9,9 -7,7.02zM8,6.5C8,7.33 7.33,8 6.5,8S5,7.33 5,6.5 5.67,5 6.5,5 8,5.67 8,6.5z"/>
 </vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_video.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_video.xml
new file mode 100644
index 000000000..e22e2fc8a
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_chip_video.xml
@@ -0,0 +1,24 @@
+<!--
+Copyright (C) 2025 The Android Open Source Project
+
+   Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+  <path
+      android:fillColor="?attr/colorPrimary"
+      android:pathData="M160,160L240,320L360,320L280,160L360,160L440,320L560,320L480,160L560,160L640,320L760,320L680,160L800,160Q833,160 856.5,183.5Q880,207 880,240L880,720Q880,753 856.5,776.5Q833,800 800,800L160,800Q127,800 103.5,776.5Q80,753 80,720L80,240Q80,207 103.5,183.5Q127,160 160,160ZM160,400L160,720Q160,720 160,720Q160,720 160,720L800,720Q800,720 800,720Q800,720 800,720L800,400L160,400ZM160,400L160,400L160,720Q160,720 160,720Q160,720 160,720L160,720Q160,720 160,720Q160,720 160,720L160,400Z"/>
+</vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
index 370c4fe70..c929806fe 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_drop_copy_badge.xml
@@ -14,24 +14,19 @@ Copyright (C) 2024 The Android Open Source Project
     limitations under the License.
 -->
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="14dp"
-        android:height="14dp"
-        android:viewportWidth="28.0"
-        android:viewportHeight="28.0">
-
-    <group
-         android:name="whiteBg">
+    android:width="14dp"
+    android:height="14dp"
+    android:viewportWidth="14"
+    android:viewportHeight="14">
     <path
-        android:fillColor="#FFFFFFFF"
-        android:pathData="M0,15a15,15 0 1,0 30,0a15,15 0 1,0 -30,0" />
-    </group>
-
-    <group
-         android:name="badge"
-         android:translateX="2"
-         android:translateY="2">
-    <path
-        android:fillColor="#FF0B8043"
-        android:pathData="M13,0 C5.824,0 0,5.824 0,13 C0,20.176 5.824,26 13,26 C20.176,26 26,20.176 26,13 C26,5.824 20.176,0 13,0 L13,0 Z M19,14 L14,14 L14,19 L12,19 L12,14 L7,14 L7,12 L12,12 L12,7 L14,7 L14,12 L19,12 L19,14 Z" />
+        android:pathData="M7,0L7,0A7,7 0,0 1,14 7L14,7A7,7 0,0 1,7 14L7,14A7,7 0,0 1,0 7L0,7A7,7 0,0 1,7 0z"
+        android:fillColor="@color/drop_icon_copy_container_background"/>
+    <group>
+        <clip-path
+            android:pathData="M1,1h12v12h-12z"/>
+        <path
+            android:pathData="M6.387,11.438V7.613H2.563V6.387H6.387V2.563H7.613V6.387H11.438V7.613H7.613V11.438H6.387Z"
+            android:fillColor="@color/drop_icon_symbol_color"/>
     </group>
 </vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml
index 1d3990887..5a3e42d5e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_hamburger.xml
@@ -20,6 +20,6 @@
         android:viewportWidth="24"
         android:viewportHeight="24">
     <path
-        android:fillColor="?android:attr/colorControlNormal"
+        android:fillColor="?attr/colorOnSurface"
         android:pathData="M3,18h18v-2H3V18zM3,13h18v-2H3V13zM3,6v2h18V6H3z"/>
 </vector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
index 06db34617..ea2c3950c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_reject_drop_badge.xml
@@ -15,24 +15,18 @@ Copyright (C) 2024 The Android Open Source Project
 -->
 
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
-        android:width="14dp"
-        android:height="14dp"
-        android:viewportWidth="28.0"
-        android:viewportHeight="28.0">
-
-    <group
-         android:name="whiteBg">
-        <path
-            android:fillColor="#FFFFFFFF"
-            android:pathData="M0,15a15,15 0 1,0 30,0a15,15 0 1,0 -30,0" />
-    </group>
-
-    <group
-         android:name="badge"
-         android:translateX="2"
-         android:translateY="2">
+    android:width="14dp"
+    android:height="14dp"
+    android:viewportWidth="14"
+    android:viewportHeight="14">
+    <path
+        android:pathData="M7,0L7,0A7,7 0,0 1,14 7L14,7A7,7 0,0 1,7 14L7,14A7,7 0,0 1,0 7L0,7A7,7 0,0 1,7 0z"
+        android:fillColor="@color/drop_icon_reject_container_background"/>
+    <group>
+        <clip-path
+            android:pathData="M1,1h12v12h-12z"/>
         <path
-            android:fillColor="#FFC53929"
-            android:pathData="M3.8056487,3.8056487 C-1.26854957,8.87984696 -1.26854957,17.1162267 3.8056487,22.190425 C8.87984696,27.2646233 17.1162267,27.2646233 22.190425,22.190425 C27.2646233,17.1162267 27.2646233,8.87984696 22.190425,3.8056487 C17.1162267,-1.26854957 8.87984696,-1.26854957 3.8056487,3.8056487 L3.8056487,3.8056487 Z M16.5335708,17.9477843 L12.9980369,14.4122504 L9.46250295,17.9477843 L8.04828938,16.5335708 L11.5838233,12.9980369 L8.04828938,9.46250295 L9.46250295,8.04828938 L12.9980369,11.5838233 L16.5335708,8.04828938 L17.9477843,9.46250295 L14.4122504,12.9980369 L17.9477843,16.5335708 L16.5335708,17.9477843 L16.5335708,17.9477843 Z" />
+            android:pathData="M7,12.038C6.308,12.038 5.654,11.908 5.037,11.65C4.429,11.383 3.896,11.021 3.438,10.563C2.979,10.096 2.617,9.558 2.35,8.95C2.092,8.333 1.962,7.679 1.962,6.988C1.962,6.287 2.092,5.637 2.35,5.037C2.617,4.429 2.979,3.896 3.438,3.438C3.896,2.979 4.429,2.621 5.037,2.362C5.654,2.096 6.308,1.962 7,1.962C7.7,1.962 8.354,2.096 8.962,2.362C9.571,2.621 10.104,2.979 10.563,3.438C11.021,3.896 11.379,4.429 11.637,5.037C11.904,5.637 12.038,6.287 12.038,6.988C12.038,7.679 11.904,8.333 11.637,8.95C11.379,9.558 11.021,10.096 10.563,10.563C10.104,11.021 9.571,11.383 8.962,11.65C8.354,11.908 7.7,12.038 7,12.038ZM7,10.813C7.417,10.813 7.817,10.75 8.2,10.625C8.583,10.5 8.925,10.317 9.225,10.075L3.912,4.762C3.679,5.079 3.5,5.425 3.375,5.8C3.25,6.175 3.188,6.571 3.188,6.988C3.188,8.046 3.558,8.95 4.3,9.7C5.042,10.442 5.942,10.813 7,10.813ZM10.087,9.212C10.321,8.896 10.5,8.55 10.625,8.175C10.75,7.8 10.813,7.404 10.813,6.988C10.813,5.929 10.442,5.033 9.7,4.3C8.958,3.558 8.058,3.188 7,3.188C6.583,3.188 6.188,3.25 5.813,3.375C5.446,3.492 5.104,3.662 4.787,3.888L10.087,9.212Z"
+            android:fillColor="@color/drop_icon_symbol_color"/>
     </group>
 </vector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
index e54ee3158..ec23152ab 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_arrow.xml
@@ -16,7 +16,7 @@
   -->
 
 <rotate xmlns:android="http://schemas.android.com/apk/res/android"
-        android:drawable="@drawable/ic_arrow_upward"
+        android:drawable="@drawable/ic_sort_icon"
         android:fromDegrees="0"
         android:toDegrees="180"
         android:pivotX="50%"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml
new file mode 100644
index 000000000..52a265729
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_sort_icon.xml
@@ -0,0 +1,98 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item
+        android:state_focused="true"
+        android:state_hovered="true">
+        <layer-list>
+            <item>
+                <shape
+                    android:background="?attr/colorSurfaceBright"
+                    android:shape="rectangle"
+                    android:tint="?attr/colorSecondaryContainer"
+                    android:tintMode="multiply">
+                    <corners android:radius="14dp" />
+                    <size
+                        android:width="28dp"
+                        android:height="32dp" />
+                    <solid android:color="?attr/colorSecondaryContainer" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:drawable="@drawable/ic_arrow_upward" />
+        </layer-list>
+    </item>
+    <item
+        android:state_focused="false"
+        android:state_hovered="true">
+        <layer-list>
+            <item>
+                <shape
+                    android:background="?attr/colorSurfaceBright"
+                    android:shape="rectangle"
+                    android:tint="?attr/colorSecondaryContainer"
+                    android:tintMode="multiply">
+                    <corners android:radius="14dp" />
+                    <size
+                        android:width="28dp"
+                        android:height="32dp" />
+                    <solid android:color="?attr/colorSecondaryContainer" />
+                </shape>
+            </item>
+            <item android:drawable="@drawable/ic_arrow_upward" />
+        </layer-list>
+    </item>
+    <item
+        android:state_focused="true"
+        android:state_hovered="false">
+        <layer-list>
+            <item>
+                <shape
+                    android:background="?attr/colorSurfaceBright"
+                    android:shape="rectangle">
+                    <corners android:radius="14dp" />
+                    <size
+                        android:width="28dp"
+                        android:height="32dp" />
+                    <solid android:color="?attr/colorSecondaryContainer" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:drawable="@drawable/ic_arrow_upward" />
+        </layer-list>
+    </item>
+    <item>
+        <layer-list>
+            <item>
+                <shape
+                    android:background="?attr/colorSurfaceBright"
+                    android:shape="rectangle">
+                    <corners android:radius="14dp" />
+                    <size
+                        android:width="28dp"
+                        android:height="32dp" />
+                    <solid android:color="?attr/colorSecondaryContainer" />
+                </shape>
+            </item>
+            <item android:drawable="@drawable/ic_arrow_upward" />
+        </layer-list>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
index c986d6579..9affe2bb9 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/ic_zoom_out.xml
@@ -16,9 +16,10 @@
 <vector xmlns:android="http://schemas.android.com/apk/res/android"
         android:width="24dp"
         android:height="24dp"
-        android:viewportWidth="24.0"
-        android:viewportHeight="24.0">
+        android:viewportWidth="960"
+        android:viewportHeight="960">
     <path
-        android:fillColor="@android:color/white"
-        android:pathData="M15,3l2.3,2.3 -2.89,2.87 1.42,1.42L18.7,6.7 21,9L21,3zM3,9l2.3,-2.3 2.87,2.89 1.42,-1.42L6.7,5.3 9,3L3,3zM9,21l-2.3,-2.3 2.89,-2.87 -1.42,-1.42L5.3,17.3 3,15v6zM21,15l-2.3,2.3 -2.87,-2.89 -1.42,1.42 2.89,2.87L15,21h6z"/>
+        android:fillColor="?attr/colorOnSurface"
+        android:pathData="M480,640Q555,640 607.5,587.5Q660,535 660,460Q660,385 607.5,332.5Q555,280 480,280Q405,280 352.5,332.5Q300,385 300,460Q300,535 352.5,587.5Q405,640 480,640ZM480,568Q435,568 403.5,536.5Q372,505 372,460Q372,415 403.5,383.5Q435,352 480,352Q525,352 556.5,383.5Q588,415 588,460Q588,505 556.5,536.5Q525,568 480,568ZM480,760Q334,760 214,678.5Q94,597 40,460Q94,323 214,241.5Q334,160 480,160Q626,160 746,241.5Q866,323 920,460Q866,597 746,678.5Q626,760 480,760ZM480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460Q480,460 480,460ZM480,680Q593,680 687.5,620.5Q782,561 832,460Q782,359 687.5,299.5Q593,240 480,240Q367,240 272.5,299.5Q178,359 128,460Q178,561 272.5,620.5Q367,680 480,680Z" />
 </vector>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
index 126788c6d..79c2eb1b7 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_background.xml
@@ -14,18 +14,184 @@
      limitations under the License.
 -->
 
-<selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item android:state_focused="true" >
-        <color android:color="@color/list_item_selected_background_color"/>
-    </item>
-    <item android:state_selected="true">
-        <color android:color="@color/list_item_selected_background_color"/>
-    </item>
-    <item android:state_drag_hovered="true">
-        <color android:color="?android:strokeColor"/>
-    </item>
-    <item android:state_selected="false"
-          android:state_focused="false">
-        <color android:color="?android:attr/colorBackground"/>
+<!-- Use @color/list_item_selected_background_color instead of the "?attr/colorPrimaryContainer"
+     because the variable is exposed in overlayable.xml. -->
+<ripple xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/list_item_ripple_color">
+
+    <!-- The mask below only works for the ripple itself, doesn't work for other <item>s, we
+         need to explicitly apply the drawable if the other items also need this mask. -->
+    <item android:id="@android:id/mask" android:drawable="@drawable/list_item_mask"/>
+
+    <item>
+        <selector>
+            <!-- Selected -->
+            <item
+                android:state_selected="true"
+                android:state_focused="true"
+                android:state_hovered="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/list_item_selected_background_color" />
+                        </shape>
+                    </item>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true" android:state_drag_hovered="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/list_item_selected_background_color" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true" android:state_pressed="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/list_item_selected_background_color" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true" android:state_focused="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/list_item_selected_background_color" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true" android:state_hovered="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/list_item_selected_background_color" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnPrimaryContainer">
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_selected="true">
+                <shape>
+                    <corners android:radius="@dimen/list_item_height" />
+                    <solid android:color="@color/list_item_selected_background_color" />
+                </shape>
+            </item>
+
+            <!-- Unselected -->
+            <item android:state_focused="true" android:state_hovered="true">
+                <layer-list>
+                    <item
+                        android:bottom="@dimen/focus_ring_gap"
+                        android:left="@dimen/focus_ring_gap"
+                        android:right="@dimen/focus_ring_gap"
+                        android:top="@dimen/focus_ring_gap">
+                        <shape android:tint="?attr/colorOnSurface">
+                            <corners android:radius="@dimen/list_item_height" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/list_item_height" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_drag_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/list_item_height" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/list_item_height" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_focused="true">
+                <shape>
+                    <corners android:radius="@dimen/list_item_height" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/list_item_height" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+
+            <!-- Default: use the container background. -->
+            <item>
+                <color android:color="@android:color/transparent"/>
+            </item>
+        </selector>
     </item>
-</selector>
\ No newline at end of file
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml
new file mode 100644
index 000000000..d1b7a3a94
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/list_item_mask.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/list_item_height" />
+    <!-- The color here doesn't matter, it's just being used as a mask. -->
+    <solid android:color="@android:color/white" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_bottom_section_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_bottom_section_background.xml
new file mode 100644
index 000000000..04f425e16
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_bottom_section_background.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="rectangle">
+    <solid android:color="?attr/colorSurfaceBright" />
+    <corners
+        android:topLeftRadius="@dimen/main_container_corner_radius_small"
+        android:topRightRadius="@dimen/main_container_corner_radius_small"
+        android:bottomLeftRadius="@dimen/main_container_corner_radius_large"
+        android:bottomRightRadius="@dimen/main_container_corner_radius_large" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_middle_section_background.xml
similarity index 91%
rename from res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_background.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_middle_section_background.xml
index 151a7ba77..8b0b42bee 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_middle_section_background.xml
@@ -16,5 +16,5 @@
 <shape xmlns:android="http://schemas.android.com/apk/res/android"
     android:shape="rectangle">
     <solid android:color="?attr/colorSurfaceBright" />
-    <corners android:radius="16dp" />
+    <corners android:radius="@dimen/main_container_corner_radius_small" />
 </shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_top_section_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_top_section_background.xml
new file mode 100644
index 000000000..b35ed4060
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/main_container_top_section_background.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="rectangle">
+    <solid android:color="?attr/colorSurfaceBright" />
+    <corners
+        android:topLeftRadius="@dimen/main_container_corner_radius_large"
+        android:topRightRadius="@dimen/main_container_corner_radius_large"
+        android:bottomLeftRadius="@dimen/main_container_corner_radius_small"
+        android:bottomRightRadius="@dimen/main_container_corner_radius_small" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
index 43dd62e2c..f1a72ad6e 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_dropdown_panel.xml
@@ -14,6 +14,7 @@
      limitations under the License.
 -->
 
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <layer-list xmlns:android="http://schemas.android.com/apk/res/android" >
     <!-- Panel shadow -->
     <item>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_item_background.xml
new file mode 100644
index 000000000..e1e59b900
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/menu_item_background.xml
@@ -0,0 +1,36 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<ripple
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/menu_item_ripple_color">
+
+    <item>
+        <selector>
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <solid android:color="@color/overlay_hover_color_percentage"/>
+                </shape>
+            </item>
+            <!-- This is the actually the focused state (with keyboard navigation). -->
+            <item android:state_selected="true">
+                <shape>
+                    <stroke android:width="@dimen/focus_ring_width" android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+        </selector>
+    </item>
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_burger_icon_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_burger_icon_background.xml
new file mode 100644
index 000000000..0957d36bb
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_burger_icon_background.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+  ~ Copyright (C) 2025 The Android Open Source Project
+  ~
+  ~ Licensed under the Apache License, Version 2.0 (the "License");
+  ~ you may not use this file except in compliance with the License.
+  ~ You may obtain a copy of the License at
+  ~
+  ~      http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing, software
+  ~ distributed under the License is distributed on an "AS IS" BASIS,
+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  ~ See the License for the specific language governing permissions and
+  ~ limitations under the License
+  -->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_pressed="true"
+        android:color="?attr/colorOnSurfaceVariant"
+        android:alpha="@dimen/hover_overlay_alpha" />
+    <item android:state_hovered="true"
+        android:color="?attr/colorOnSurfaceVariant"
+        android:alpha="@dimen/hover_overlay_alpha" />
+    <item android:color="@android:color/transparent" />
+</selector>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml
new file mode 100644
index 000000000..7809766cd
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_background.xml
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <!-- By default the nav rail item has a grey background when it's focused, but we need the
+     background to be put on the icon inside, so we override the focus background color to be
+     transparent here.
+     -->
+    <item android:state_focused="true" android:drawable="@android:color/transparent" />
+</selector>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_background.xml
new file mode 100644
index 000000000..1c7bc8c0b
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_background.xml
@@ -0,0 +1,145 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<ripple
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:color="@color/item_root_ripple_color">
+
+    <!-- The mask below only works for the ripple itself, doesn't work for other <item>s, we
+         need to explicitly apply the drawable if the other items also need this mask. -->
+    <item
+        android:id="@android:id/mask"
+        android:drawable="@drawable/nav_rail_item_icon_mask"/>
+
+    <item>
+        <selector>
+            <!-- Selected (activated). -->
+            <!-- Highlight: when dragging files over the item. -->
+            <item
+                android:state_activated="true"
+                app:state_highlighted="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="?attr/colorSecondaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item
+                android:state_activated="true"
+                android:state_pressed="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="?attr/colorSecondaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item
+                android:state_activated="true"
+                android:state_focused="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="?attr/colorSecondaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <stroke
+                                android:width="@dimen/focus_ring_width"
+                                android:color="?attr/colorSecondary" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item
+                android:state_activated="true"
+                android:state_hovered="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="?attr/colorSecondaryContainer" />
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                            <solid android:color="@color/overlay_hover_color_percentage" />
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_activated="true">
+                <shape>
+                    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                    <solid android:color="?attr/colorSecondaryContainer" />
+                </shape>
+            </item>
+
+            <!-- Unselected. -->
+            <item app:state_highlighted="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+            <item android:state_focused="true">
+                <shape>
+                    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                    <stroke
+                        android:width="@dimen/focus_ring_width"
+                        android:color="?attr/colorSecondary" />
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius" />
+                    <solid android:color="@color/overlay_hover_color_percentage" />
+                </shape>
+            </item>
+
+            <!-- Default: use the container background. -->
+            <item android:drawable="@android:color/transparent" />
+        </selector>
+    </item>
+</ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_mask.xml
new file mode 100644
index 000000000..fd2a14b8d
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/nav_rail_item_icon_mask.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/nav_rail_item_icon_bg_radius"/>
+    <!-- The color here doesn't matter, it's just being used as a mask. -->
+    <solid android:color="@android:color/white" />
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/profile_tab_mask.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/profile_tab_mask.xml
new file mode 100644
index 000000000..3c1e33b0e
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/profile_tab_mask.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/profile_tab_radius"/>
+    <!-- The color here doesn't matter, it's just being used as a mask in tab_border_rounded. -->
+    <solid android:color="@android:color/white"/>
+</shape>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
index 1200ab00b..7a0a5e555 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/progress_indeterminate_horizontal_material_trimmed.xml
@@ -14,6 +14,7 @@
      limitations under the License.
 -->
 
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <!-- Variant of progress_indeterminate_horizontal_material in frameworks/base/core/res, which
      draws the whole height of the progress bar instead having blank space above and below the
      bar. -->
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
index 544d23beb..236b92179 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_item_background.xml
@@ -17,27 +17,113 @@
 <ripple
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:color="?android:attr/colorControlHighlight">
+    android:color="@color/item_root_ripple_color">
+
+    <!-- The mask below only works for the ripple itself, doesn't work for other <item>s, we
+         need to explicitly apply the drawable if the other items also need this mask. -->
     <item
         android:id="@android:id/mask"
         android:drawable="@drawable/root_list_selector"/>
 
     <item>
         <selector>
+            <!-- Selected (activated). -->
+            <!-- Highlight: when dragging files over the item. -->
+            <item android:state_activated="true" app:state_highlighted="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="?attr/colorSecondaryContainer"/>
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="@color/overlay_hover_color_percentage"/>
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_activated="true" android:state_pressed="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="?attr/colorSecondaryContainer"/>
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="@color/overlay_hover_color_percentage"/>
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_activated="true" android:state_focused="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="?attr/colorSecondaryContainer"/>
+                        </shape>
+                    </item>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <stroke android:width="@dimen/focus_ring_width" android:color="?attr/colorSecondary"/>
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_activated="true" android:state_hovered="true">
+                <layer-list>
+                    <item>
+                        <shape>
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="?attr/colorSecondaryContainer"/>
+                        </shape>
+                    </item>
+                    <item>
+                        <shape android:tint="?attr/colorOnSecondaryContainer">
+                            <corners android:radius="@dimen/drawer_item_height"/>
+                            <solid android:color="@color/overlay_hover_color_percentage"/>
+                        </shape>
+                    </item>
+                </layer-list>
+            </item>
+            <item android:state_activated="true" android:drawable="@drawable/root_list_selector"/>
+
+            <!-- Unselected. -->
             <item app:state_highlighted="true">
-                <color android:color="?android:attr/colorControlHighlight"/>
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/drawer_item_height"/>
+                    <solid android:color="@color/overlay_hover_color_percentage"/>
+                </shape>
+            </item>
+            <item android:state_pressed="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/drawer_item_height"/>
+                    <solid android:color="@color/overlay_hover_color_percentage"/>
+                </shape>
+            </item>
+            <item android:state_focused="true">
+                <shape>
+                    <corners android:radius="@dimen/drawer_item_height"/>
+                    <stroke android:width="@dimen/focus_ring_width" android:color="?attr/colorSecondary"/>
+                </shape>
+            </item>
+            <item android:state_hovered="true">
+                <shape android:tint="?attr/colorOnSurface">
+                    <corners android:radius="@dimen/drawer_item_height"/>
+                    <solid android:color="@color/overlay_hover_color_percentage"/>
+                </shape>
             </item>
-            <item
-                app:state_highlighted="false"
-                android:drawable="@android:color/transparent"/>
-        </selector>
-    </item>
 
-    <item>
-        <selector>
+            <!-- Default: use the container background. -->
             <item
-                android:state_activated="true"
-                android:drawable="@drawable/root_list_selector"/>
+                android:drawable="@android:color/transparent"/>
         </selector>
     </item>
 </ripple>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
index 11d28a70f..5bb3d6afe 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/root_list_selector.xml
@@ -14,17 +14,8 @@
      limitations under the License.
 -->
 
-<inset xmlns:android="http://schemas.android.com/apk/res/android"
-       android:inset="8dp">
-    <shape
-        xmlns:android="http://schemas.android.com/apk/res/android"
-        android:shape="rectangle">
-        <corners
-            android:topLeftRadius="2dp"
-            android:topRightRadius="2dp"
-            android:bottomLeftRadius="2dp"
-            android:bottomRightRadius="2dp"/>
-        <solid
-            android:color="?android:attr/colorSecondary"/>
-    </shape>
-</inset>
\ No newline at end of file
+<shape xmlns:android="http://schemas.android.com/apk/res/android">
+    <corners android:radius="@dimen/drawer_item_height"/>
+    <!-- The color here is used as activated color in root_item_background.xml. -->
+    <solid android:color="?attr/colorSecondaryContainer"/>
+</shape>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml
index 212dab765..b18bc4eb3 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/sort_widget_background.xml
@@ -15,6 +15,7 @@
     limitations under the License.
   -->
 
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
     <item
         android:top="-1dp"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml b/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml
index 96b7e6d49..08d515301 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/drawable/tab_border_rounded.xml
@@ -14,10 +14,135 @@
      limitations under the License.
 -->
 
-<shape xmlns:android="http://schemas.android.com/apk/res/android"
-    android:shape="rectangle">
+<ripple
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:color="@color/profile_tab_ripple_color">
 
-   <solid
-       android:color="@color/profile_tab_selector"/>
-   <corners android:radius="12dp"/>
-</shape>
+   <!-- The mask below only works for the ripple itself, doesn't work for other <item>s, we
+        need to explicitly apply the drawable if the other items also need this mask. -->
+   <item
+       android:id="@android:id/mask"
+       android:drawable="@drawable/profile_tab_mask"/>
+
+   <item>
+      <selector>
+         <!-- Selected (activated). -->
+         <item android:state_activated="true" android:state_pressed="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorPrimaryContainer" />
+                  </shape>
+               </item>
+               <item>
+                  <shape android:tint="?attr/colorOnPrimaryContainer">
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="@color/overlay_hover_color_percentage" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+         <item android:state_activated="true" android:state_focused="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorPrimaryContainer" />
+                  </shape>
+               </item>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <stroke
+                         android:width="@dimen/focus_ring_width"
+                         android:color="?attr/colorSecondary" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+         <item android:state_activated="true" android:state_hovered="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorPrimaryContainer" />
+                  </shape>
+               </item>
+               <item>
+                  <shape android:tint="?attr/colorOnPrimaryContainer">
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="@color/overlay_hover_color_percentage" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+         <item android:state_activated="true">
+            <shape>
+               <corners android:radius="@dimen/profile_tab_radius" />
+               <solid android:color="?attr/colorPrimaryContainer" />
+            </shape>
+         </item>
+
+         <!-- Unselected. -->
+         <item android:state_pressed="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorSurfaceContainerHighest" />
+                  </shape>
+               </item>
+               <item>
+                  <shape android:tint="?attr/colorOnSurface">
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="@color/overlay_hover_color_percentage" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+         <item android:state_focused="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorSurfaceContainerHighest" />
+                  </shape>
+               </item>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <stroke
+                         android:width="@dimen/focus_ring_width"
+                         android:color="?attr/colorSecondary" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+         <item android:state_hovered="true">
+            <layer-list>
+               <item>
+                  <shape>
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="?attr/colorSurfaceContainerHighest" />
+                  </shape>
+               </item>
+               <item>
+                  <shape android:tint="?attr/colorOnSurface">
+                     <corners android:radius="@dimen/profile_tab_radius" />
+                     <solid android:color="@color/overlay_hover_color_percentage" />
+                  </shape>
+               </item>
+            </layer-list>
+         </item>
+
+         <!-- Default -->
+         <item>
+            <shape>
+               <corners android:radius="@dimen/profile_tab_radius" />
+               <solid android:color="?attr/colorSurfaceContainerHighest" />
+            </shape>
+         </item>
+      </selector>
+   </item>
+</ripple>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml
new file mode 100644
index 000000000..93245946c
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w600dp/fragment_save_cancel_button.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<com.google.android.material.button.MaterialButton
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:id="@android:id/button2"
+    style="@style/MaterialTonalButton"
+    app:cornerRadius="@dimen/button_corner_radius"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_marginStart="@dimen/picker_saver_button_gap"
+    android:layout_marginEnd="@dimen/picker_saver_button_gap"
+    android:text="@android:string/cancel"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/column_headers.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/column_headers.xml
deleted file mode 100644
index f24a28241..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/column_headers.xml
+++ /dev/null
@@ -1,122 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!--
-    Copyright (C) 2024 The Android Open Source Project
-
-    Licensed under the Apache License, Version 2.0 (the "License");
-    you may not use this file except in compliance with the License.
-    You may obtain a copy of the License at
-
-         http://www.apache.org/licenses/LICENSE-2.0
-
-    Unless required by applicable law or agreed to in writing, software
-    distributed under the License is distributed on an "AS IS" BASIS,
-    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-    See the License for the specific language governing permissions and
-    limitations under the License.
--->
-
-<LinearLayout
-    xmlns:android="http://schemas.android.com/apk/res/android"
-    android:id="@+id/table_header"
-    android:orientation="horizontal"
-    android:layout_width="match_parent"
-    android:layout_height="@dimen/doc_header_height"
-    android:background="@drawable/sort_widget_background"
-    android:visibility="gone">
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="match_parent"
-        android:baselineAligned="false"
-        android:gravity="center_vertical"
-        android:minHeight="@dimen/list_item_height"
-        android:paddingStart="@dimen/list_item_padding"
-        android:paddingEnd="@dimen/list_item_width"
-        android:orientation="horizontal">
-        <!-- Placeholder for icon -->
-        <View
-            android:layout_width="@dimen/list_item_thumbnail_size"
-            android:layout_height="@dimen/list_item_thumbnail_size"
-            android:layout_gravity="center_vertical"
-            android:layout_marginEnd="16dp"
-            android:layout_marginStart="0dp"/>
-
-        <!-- Column headers -->
-        <LinearLayout
-            android:layout_width="0dp"
-            android:layout_height="match_parent"
-            android:layout_weight="1"
-            android:orientation="horizontal">
-
-            <com.android.documentsui.sorting.HeaderCell
-                android:id="@android:id/title"
-                android:layout_width="0dp"
-                android:layout_height="match_parent"
-                android:layout_weight="0.4"
-                android:layout_marginEnd="12dp"
-                android:focusable="true"
-                android:gravity="center_vertical"
-                android:orientation="horizontal"
-                android:animateLayoutChanges="true">
-
-                <include layout="@layout/shared_cell_content" />
-            </com.android.documentsui.sorting.HeaderCell>
-
-            <com.android.documentsui.sorting.HeaderCell
-                android:id="@android:id/summary"
-                android:layout_width="0dp"
-                android:layout_height="match_parent"
-                android:layout_weight="0"
-                android:layout_marginEnd="0dp"
-                android:focusable="true"
-                android:gravity="center_vertical"
-                android:orientation="horizontal"
-                android:animateLayoutChanges="true">
-
-                <include layout="@layout/shared_cell_content" />
-            </com.android.documentsui.sorting.HeaderCell>
-
-            <com.android.documentsui.sorting.HeaderCell
-                android:id="@+id/file_type"
-                android:layout_width="0dp"
-                android:layout_height="match_parent"
-                android:layout_weight="0.2"
-                android:layout_marginEnd="12dp"
-                android:focusable="true"
-                android:gravity="center_vertical"
-                android:orientation="horizontal"
-                android:animateLayoutChanges="true">
-
-                <include layout="@layout/shared_cell_content" />
-            </com.android.documentsui.sorting.HeaderCell>
-
-            <com.android.documentsui.sorting.HeaderCell
-                android:id="@+id/size"
-                android:layout_width="0dp"
-                android:layout_height="match_parent"
-                android:layout_weight="0.2"
-                android:layout_marginEnd="12dp"
-                android:focusable="true"
-                android:gravity="center_vertical"
-                android:orientation="horizontal"
-                android:animateLayoutChanges="true">
-
-                <include layout="@layout/shared_cell_content" />
-            </com.android.documentsui.sorting.HeaderCell>
-
-            <com.android.documentsui.sorting.HeaderCell
-                android:id="@+id/date"
-                android:layout_width="0dp"
-                android:layout_height="match_parent"
-                android:layout_weight="0.2"
-                android:layout_marginEnd="12dp"
-                android:focusable="true"
-                android:gravity="center_vertical"
-                android:orientation="horizontal"
-                android:animateLayoutChanges="true">
-
-                <include layout="@layout/shared_cell_content" />
-            </com.android.documentsui.sorting.HeaderCell>
-        </LinearLayout>
-    </LinearLayout>
-</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/directory_app_bar.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/directory_app_bar.xml
deleted file mode 100644
index 177aeba4f..000000000
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/directory_app_bar.xml
+++ /dev/null
@@ -1,55 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<!-- Copyright (C) 2024 The Android Open Source Project
-
-     Licensed under the Apache License, Version 2.0 (the "License");
-     you may not use this file except in compliance with the License.
-     You may obtain a copy of the License at
-
-          http://www.apache.org/licenses/LICENSE-2.0
-
-     Unless required by applicable law or agreed to in writing, software
-     distributed under the License is distributed on an "AS IS" BASIS,
-     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-     See the License for the specific language governing permissions and
-     limitations under the License.
--->
-
-<com.google.android.material.appbar.AppBarLayout
-    xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
-    android:id="@+id/app_bar"
-    android:layout_width="match_parent"
-    android:layout_height="wrap_content"
-    android:background="?android:attr/colorBackground">
-
-    <androidx.appcompat.widget.Toolbar
-        android:id="@+id/toolbar"
-        android:layout_width="match_parent"
-        android:layout_height="?android:attr/actionBarSize"
-        android:layout_margin="@dimen/search_bar_margin"
-        android:background="?android:attr/colorBackground"
-        android:theme="?actionBarTheme"
-        android:popupTheme="?actionBarPopupTheme"
-        android:elevation="3dp"
-        app:collapseContentDescription="@string/button_back"
-        app:titleTextAppearance="@style/ToolbarTitle"
-        app:layout_collapseMode="pin">
-
-        <TextView
-            android:id="@+id/searchbar_title"
-            android:layout_width="match_parent"
-            android:layout_height="?android:attr/actionBarSize"
-            android:layout_marginStart="@dimen/search_bar_text_margin_start"
-            android:layout_marginEnd="@dimen/search_bar_text_margin_end"
-            android:paddingStart="@dimen/search_bar_icon_padding"
-            android:gravity="center_vertical"
-            android:text="@string/search_bar_hint"
-            android:textAppearance="@style/SearchBarTitle"
-            android:drawableStart="@drawable/ic_menu_search"
-            android:drawablePadding="@dimen/search_bar_icon_padding"/>
-
-    </androidx.appcompat.widget.Toolbar>
-
-    <include layout="@layout/directory_header"/>
-
-</com.google.android.material.appbar.AppBarLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml
new file mode 100644
index 000000000..dcd3283b4
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/column_headers.xml
@@ -0,0 +1,129 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+
+<!-- The 2 placeholder views here are for vertical alignment purpose, in the file row it uses
+     ratio-based layout for Name/Type/Size/Date columns but excluding the thumbnail icon and
+     the preview icon. In order to make the header and row are vertically aligned, we need to
+     use placeholder for thumbnail icon and preview icon and then do the ratio-based layout
+     for table headers.
+ -->
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/table_header"
+    android:orientation="horizontal"
+    android:layout_width="match_parent"
+    android:layout_height="@dimen/doc_header_height"
+    android:baselineAligned="false"
+    android:gravity="center_vertical"
+    android:paddingStart="@dimen/table_header_padding_start"
+    android:paddingEnd="@dimen/table_header_padding_end"
+    android:visibility="gone">
+    <!-- Placeholder for MIME/thumbnail icon -->
+    <View
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_gravity="center_vertical"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end"
+        android:layout_marginStart="0dp"/>
+
+    <!-- Column headers -->
+    <LinearLayout
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="1"
+        android:orientation="horizontal">
+
+        <com.android.documentsui.sorting.HeaderCell
+            android:id="@android:id/title"
+            android:layout_width="0dp"
+            android:layout_height="match_parent"
+            android:layout_weight="0.4"
+            android:layout_marginEnd="12dp"
+            android:clickable="true"
+            android:focusable="false"
+            android:gravity="center_vertical"
+            android:orientation="horizontal"
+            android:animateLayoutChanges="true">
+
+            <include layout="@layout/shared_cell_content" />
+        </com.android.documentsui.sorting.HeaderCell>
+
+        <com.android.documentsui.sorting.HeaderCell
+            android:id="@android:id/summary"
+            android:layout_width="0dp"
+            android:layout_height="match_parent"
+            android:layout_weight="0"
+            android:layout_marginEnd="0dp"
+            android:clickable="true"
+            android:focusable="false"
+            android:gravity="center_vertical"
+            android:orientation="horizontal"
+            android:animateLayoutChanges="true">
+
+            <include layout="@layout/shared_cell_content" />
+        </com.android.documentsui.sorting.HeaderCell>
+
+        <com.android.documentsui.sorting.HeaderCell
+            android:id="@+id/file_type"
+            android:layout_width="0dp"
+            android:layout_height="match_parent"
+            android:layout_weight="0.2"
+            android:clickable="true"
+            android:focusable="false"
+            android:gravity="center_vertical"
+            android:orientation="horizontal"
+            android:animateLayoutChanges="true">
+
+            <include layout="@layout/shared_cell_content" />
+        </com.android.documentsui.sorting.HeaderCell>
+
+        <com.android.documentsui.sorting.HeaderCell
+            android:id="@+id/size"
+            android:layout_width="0dp"
+            android:layout_height="match_parent"
+            android:layout_weight="0.2"
+            android:clickable="true"
+            android:focusable="false"
+            android:gravity="center_vertical"
+            android:orientation="horizontal"
+            android:animateLayoutChanges="true">
+
+            <include layout="@layout/shared_cell_content" />
+        </com.android.documentsui.sorting.HeaderCell>
+
+        <com.android.documentsui.sorting.HeaderCell
+            android:id="@+id/date"
+            android:layout_width="0dp"
+            android:layout_height="match_parent"
+            android:layout_weight="0.2"
+            android:clickable="true"
+            android:focusable="false"
+            android:gravity="center_vertical"
+            android:orientation="horizontal"
+            android:animateLayoutChanges="true">
+
+            <include layout="@layout/shared_cell_content" />
+        </com.android.documentsui.sorting.HeaderCell>
+    </LinearLayout>
+
+    <!-- Placeholder for preview icon in picker mode -->
+    <View
+        android:id="@+id/preview_icon_placeholder"
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end" />
+</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/item_doc_list.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml
similarity index 64%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/item_doc_list.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml
index d9b0ab6f4..09657d01a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/item_doc_list.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout-w900dp/item_doc_list.xml
@@ -20,7 +20,6 @@
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
     android:background="@drawable/list_item_background"
-    android:foreground="?android:attr/selectableItemBackground"
     android:clickable="true"
     android:focusable="true"
     android:orientation="horizontal" >
@@ -31,23 +30,27 @@
         android:baselineAligned="false"
         android:gravity="center_vertical"
         android:minHeight="@dimen/list_item_height"
-        android:orientation="horizontal" >
+        android:orientation="horizontal"
+        android:paddingStart="@dimen/list_item_padding_start"
+        android:paddingEnd="@dimen/list_item_padding_end"
+        android:paddingVertical="@dimen/list_item_padding_vertical">
 
         <FrameLayout
             android:id="@+id/icon"
             android:pointerIcon="hand"
-            android:layout_width="@dimen/list_item_width"
-            android:layout_height="@dimen/list_item_height"
-            android:paddingBottom="@dimen/list_item_icon_padding"
-            android:paddingTop="@dimen/list_item_icon_padding"
-            android:paddingEnd="16dp"
-            android:paddingStart="@dimen/list_item_padding" >
+            android:layout_width="@dimen/list_item_icon_size"
+            android:layout_height="@dimen/list_item_icon_size"
+            android:layout_marginEnd="@dimen/list_item_icon_margin_end">
 
+            <!-- stroke width will be controlled dynamically in the code. -->
             <com.google.android.material.card.MaterialCardView
+                android:id="@+id/icon_wrapper"
                 app:cardElevation="0dp"
-                app:cardBackgroundColor="@android:color/transparent"
                 android:layout_width="match_parent"
-                android:layout_height="match_parent">
+                android:layout_height="match_parent"
+                app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
+                app:strokeColor="?attr/colorSecondaryContainer"
+                app:strokeWidth="0dp">
 
                 <ImageView
                     android:id="@+id/icon_mime"
@@ -101,83 +104,58 @@
                     android:layout_marginEnd="@dimen/briefcase_icon_margin"
                     android:layout_gravity="center_vertical"
                     android:src="@drawable/ic_briefcase"
-                    android:tint="?android:attr/colorAccent"
+                    android:tint="@color/doc_list_item_badge_icon_color"
                     android:contentDescription="@string/a11y_work"/>
 
                 <TextView
                     android:id="@android:id/title"
                     android:layout_width="match_parent"
                     android:layout_height="wrap_content"
-                    android:ellipsize="middle"
+                    android:ellipsize="end"
                     android:singleLine="true"
                     android:textAlignment="viewStart"
-                    android:textAppearance="@style/Subhead"
-                    android:textColor="?android:attr/textColorPrimary"/>
+                    android:textAppearance="@style/FileItemLabelText"/>
             </LinearLayout>
 
             <TextView
                 android:id="@+id/file_type"
                 android:layout_width="0dp"
                 android:layout_height="wrap_content"
-                android:layout_marginEnd="12dp"
                 android:layout_weight="0.2"
-                android:ellipsize="end"
-                android:singleLine="true"
                 android:textAlignment="viewStart"
-                android:textAppearance="@style/Body1"
-                android:textColor="?android:attr/textColorSecondary" />
+                style="@style/FileItemLabelStyle"/>
 
             <TextView
                 android:id="@+id/size"
                 android:layout_width="0dp"
                 android:layout_height="wrap_content"
-                android:layout_marginEnd="12dp"
                 android:layout_weight="0.2"
-                android:ellipsize="end"
-                android:minWidth="70dp"
-                android:singleLine="true"
-                android:textAlignment="viewEnd"
-                android:textAppearance="@style/Body1"
-                android:textColor="?android:attr/textColorSecondary" />
+                android:textAlignment="viewStart"
+                style="@style/FileItemLabelStyle"/>
 
             <TextView
                 android:id="@+id/date"
                 android:layout_width="0dp"
                 android:layout_height="wrap_content"
-                android:layout_marginEnd="12dp"
                 android:layout_weight="0.2"
-                android:ellipsize="end"
-                android:minWidth="70dp"
-                android:singleLine="true"
-                android:textAlignment="viewEnd"
-                android:textAppearance="@style/Body1"
-                android:textColor="?android:attr/textColorSecondary" />
+                android:textAlignment="viewStart"
+                style="@style/FileItemLabelStyle"/>
         </LinearLayout>
 
         <FrameLayout
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content">
-
-            <FrameLayout
-                android:id="@+id/preview_icon"
-                android:layout_width="@dimen/list_item_width"
-                android:layout_height="@dimen/list_item_height"
-                android:padding="@dimen/list_item_icon_padding"
-                android:focusable="true">
-
-                <ImageView
-                    android:layout_width="@dimen/check_icon_size"
-                    android:layout_height="@dimen/check_icon_size"
-                    android:layout_gravity="center"
-                    android:scaleType="fitCenter"
-                    android:tint="?android:attr/textColorPrimary"
-                    android:src="@drawable/ic_zoom_out"/>
-
-            </FrameLayout>
-
-            <android.widget.Space
-                android:layout_width="@dimen/list_item_width"
-                android:layout_height="@dimen/list_item_height"/>
+            android:id="@+id/preview_icon"
+            android:layout_width="@dimen/list_item_icon_size"
+            android:layout_height="@dimen/list_item_icon_size"
+            android:layout_marginEnd="@dimen/list_item_icon_margin_end"
+            android:focusable="true">
+
+            <ImageView
+                android:layout_width="@dimen/check_icon_size"
+                android:layout_height="@dimen/check_icon_size"
+                android:layout_gravity="center"
+                android:scaleType="fitCenter"
+                android:tint="@color/doc_list_item_badge_icon_color"
+                android:src="@drawable/ic_zoom_out"/>
 
         </FrameLayout>
 
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml
new file mode 100644
index 000000000..e829baefd
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/additional_drag_shadow.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!-- Transparent container so shadow layer can be drawn -->
+<FrameLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="@dimen/drag_shadow_width"
+    android:layout_height="@dimen/drag_shadow_height"
+    android:background="@color/item_drag_shadow_container_background">
+
+    <View
+        android:layout_width="@dimen/drag_content_width"
+        android:layout_height="@dimen/drag_content_height"
+        android:layout_marginTop="@dimen/drag_additional_layer_margin_top"
+        android:layout_marginStart="@dimen/drag_shadow_radius"
+        android:background="@drawable/drag_shadow_background" />
+</FrameLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml
index 8b6471265..249a6d3f1 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/apps_row.xml
@@ -14,6 +14,9 @@
      limitations under the License.
 -->
 
+<!-- TODO(b/379776735): Remove this after use_material3 flag is launched.
+    Currently it's being referenced in AppsRowManager.
+-->
 <LinearLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
     android:id="@+id/apps_row"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml
index fde349b88..18a8dc8f7 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/column_headers.xml
@@ -15,6 +15,39 @@
     limitations under the License.
 -->
 
-<!-- A placeholder of table header on small screens. This won't inflate any view when it's included
-     into other layouts. -->
-<merge />
+<LinearLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/table_header"
+    android:orientation="horizontal"
+    android:layout_width="match_parent"
+    android:layout_height="@dimen/doc_header_height"
+    android:baselineAligned="false"
+    android:gravity="center_vertical"
+    android:paddingStart="@dimen/table_header_padding_start"
+    android:paddingEnd="@dimen/table_header_padding_end"
+    android:background="?attr/colorSurfaceBright"
+    android:visibility="gone">
+
+    <!-- Placeholder for MIME/thumbnail icon -->
+    <View
+        android:layout_width="@dimen/list_item_icon_size"
+        android:layout_height="@dimen/list_item_icon_size"
+        android:layout_gravity="center_vertical"
+        android:layout_marginEnd="@dimen/list_item_icon_margin_end"
+        android:layout_marginStart="0dp"/>
+
+    <!-- Column headers: Name only for compact/medium size screen -->
+    <com.android.documentsui.sorting.HeaderCell
+        android:id="@android:id/title"
+        android:layout_width="0dp"
+        android:layout_height="match_parent"
+        android:layout_weight="1"
+        android:clickable="true"
+        android:focusable="false"
+        android:gravity="center_vertical"
+        android:orientation="horizontal"
+        android:animateLayoutChanges="true">
+
+        <include layout="@layout/shared_cell_content" />
+    </com.android.documentsui.sorting.HeaderCell>
+</LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
index 1f8aa7b3c..94e4b953d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_app_bar.xml
@@ -14,41 +14,50 @@
      limitations under the License.
 -->
 
+<!-- This is only used in DrawerLayout (compact screen) right now. -->
 <com.google.android.material.appbar.AppBarLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@+id/app_bar"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:background="?android:attr/colorBackground">
+    android:touchscreenBlocksFocus="false">
 
+    <!-- Technically we don't need this CollapsingToolbarLayout wrapper when use_material3 flag
+         is ON, because we don't want to hide anything in the app header area when scrolling, but
+         some files (e.g. NavigationViewManager and others) uses the existence of this element to
+         do some specific logic, hence leaving it here with "noScroll" behavior.
+     -->
     <com.google.android.material.appbar.CollapsingToolbarLayout
         android:id="@+id/collapsing_toolbar"
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
         app:titleEnabled="false"
-        app:layout_scrollFlags="scroll|enterAlways|enterAlwaysCollapsed">
+        app:layout_scrollFlags="noScroll">
 
-        <androidx.core.widget.NestedScrollView
+        <LinearLayout
             android:layout_width="match_parent"
-            android:layout_height="wrap_content">
+            android:layout_height="wrap_content"
+            android:orientation="vertical"
+            android:background="?attr/colorSurfaceBright">
 
             <include layout="@layout/directory_header" />
 
-        </androidx.core.widget.NestedScrollView>
+            <com.google.android.material.divider.MaterialDivider
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                app:dividerColor="?attr/colorSurfaceContainer"
+                app:dividerThickness="@dimen/main_container_section_gap" />
+
+            <include layout="@layout/column_headers"/>
+
+        </LinearLayout>
 
-        <androidx.appcompat.widget.Toolbar
+        <com.google.android.material.appbar.MaterialToolbar
             android:id="@+id/toolbar"
             android:layout_width="match_parent"
-            android:layout_height="?android:attr/actionBarSize"
-            android:layout_margin="@dimen/search_bar_margin"
-            android:background="?android:attr/colorBackground"
-            android:theme="?actionBarTheme"
-            android:popupTheme="?actionBarPopupTheme"
-            android:elevation="@dimen/search_bar_elevation"
-            app:collapseContentDescription="@string/button_back"
-            app:titleTextAppearance="@style/ToolbarTitle"
-            app:layout_collapseMode="pin">
+            android:layout_height="?attr/actionBarSize"
+            android:touchscreenBlocksFocus="false">
 
             <TextView
                 android:id="@+id/searchbar_title"
@@ -58,8 +67,8 @@
                 android:text="@string/search_bar_hint"
                 android:textAppearance="@style/SearchBarTitle" />
 
-        </androidx.appcompat.widget.Toolbar>
+        </com.google.android.material.appbar.MaterialToolbar>
 
     </com.google.android.material.appbar.CollapsingToolbarLayout>
 
-</com.google.android.material.appbar.AppBarLayout>
\ No newline at end of file
+</com.google.android.material.appbar.AppBarLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml
index 8d8bd7f8a..171c5882a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/directory_header.xml
@@ -20,76 +20,36 @@
     android:layout_height="wrap_content"
     android:orientation="vertical">
 
-    <com.android.documentsui.HorizontalBreadcrumb
-        android:id="@+id/horizontal_breadcrumb"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content" />
-
     <!-- used for search chip. -->
     <include layout="@layout/search_chip_row"/>
 
     <LinearLayout
         android:id="@+id/tabs_container"
-        android:theme="@style/TabTheme"
         android:clipToPadding="true"
         android:clipChildren="true"
         android:layout_width="match_parent"
         android:layout_height="match_parent"
-        android:paddingLeft="@dimen/profile_tab_padding"
-        android:paddingRight="@dimen/profile_tab_padding"
+        android:paddingStart="@dimen/main_container_padding_start"
+        android:paddingEnd="@dimen/main_container_padding_end"
+        android:paddingBottom="@dimen/space_extra_small_6"
         android:orientation="vertical">
 
         <com.google.android.material.tabs.TabLayout
             android:id="@+id/tabs"
-            android:background="@android:color/transparent"
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
             app:tabMaxWidth="0dp"
             app:tabGravity="fill"
             app:tabMode="fixed"
-            app:tabIndicatorColor="?android:attr/colorAccent"
-            app:tabIndicatorHeight="@dimen/tab_selector_indicator_height"
-            app:tabSelectedTextColor="@color/tab_selected_text_color"
-            app:tabTextAppearance="@style/TabTextAppearance"
-            app:tabTextColor="@color/tab_unselected_text_color"/>
+            style="@style/ProfileTabStyle"/>
         <View
             android:id="@+id/tab_separator"
             android:layout_width="match_parent"
             android:layout_height="1dp"
-            android:background="?android:attr/listDivider"/>
+            android:background="?attr/colorOutlineVariant"/>
     </LinearLayout>
 
     <!-- used for apps row. -->
     <include layout="@layout/apps_row"/>
 
-    <LinearLayout
-        android:id="@+id/header_container"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:layout_marginStart="@dimen/root_info_header_horizontal_padding"
-        android:layout_marginEnd="@dimen/root_info_header_horizontal_padding"
-        android:minHeight="@dimen/root_info_header_height"
-        android:accessibilityHeading="true">
-
-        <TextView
-            android:id="@+id/header_title"
-            android:layout_width="match_parent"
-            android:layout_height="match_parent"
-            android:layout_weight="1"
-            android:textAppearance="@style/SectionHeader"
-            android:maxLines="1"
-            android:ellipsize="end"
-            android:gravity="start|center_vertical"/>
-
-        <androidx.appcompat.widget.ActionMenuView
-            android:id="@+id/sub_menu"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_gravity="end|center_vertical"/>
-
-    </LinearLayout>
-
-    <!-- column headers are empty on small screens, in portrait or in grid mode. -->
-    <include layout="@layout/column_headers"/>
-
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
index c3de2399c..8181cd403 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/drag_shadow_layout.xml
@@ -15,34 +15,53 @@
 -->
 
 <!-- Transparent container so shadow layer can be drawn -->
-<LinearLayout
+<FrameLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent"
-    android:padding="8dp"
+    android:layout_width="@dimen/drag_shadow_width"
+    android:layout_height="@dimen/drag_shadow_height"
     android:background="@color/item_drag_shadow_container_background">
 
     <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="match_parent"
-        android:paddingStart="12dp"
-        android:paddingEnd="12dp"
+        android:layout_width="@dimen/drag_content_width"
+        android:layout_height="@dimen/drag_content_height"
+        android:layout_marginTop="@dimen/drag_file_counter_offset"
+        android:layout_marginStart="@dimen/drag_content_margin_start"
+        android:paddingHorizontal="@dimen/space_extra_small_4"
         android:orientation="horizontal"
         android:gravity="center_vertical"
         android:background="@drawable/drag_shadow_background">
 
-        <include layout="@layout/drop_badge"/>
+        <LinearLayout
+            android:layout_width="@dimen/drop_badge_container_size"
+            android:layout_height="@dimen/drop_badge_container_size"
+            android:orientation="horizontal"
+            android:gravity="center_horizontal"
+            android:background="@drawable/drop_badge_container_background">
+
+            <include layout="@layout/drop_badge"/>
+
+        </LinearLayout>
+
 
         <TextView
             android:id="@android:id/title"
-            android:layout_width="match_parent"
+            android:layout_width="wrap_content"
             android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/space_extra_small_4"
             android:maxLines="1"
             android:ellipsize="end"
             android:textAlignment="viewStart"
-            android:textAppearance="@style/Subhead"
-            android:paddingStart="6dp"
-            android:paddingBottom="1dp"/>
+            android:textAppearance="@style/DragBadgeText" />
 
     </LinearLayout>
-</LinearLayout>
+
+    <TextView
+        android:id="@+id/drag_file_counter"
+        android:layout_width="wrap_content"
+        android:layout_height="@dimen/drag_file_counter_height"
+        android:paddingHorizontal="@dimen/space_extra_small_4"
+        android:layout_gravity="top|end"
+        android:background="@drawable/drag_file_counter_background"
+        android:textAppearance="@style/DragCounterText"
+        android:visibility="gone" />
+</FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
index 58ef57f58..0fe74fe64 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/drawer_layout.xml
@@ -28,11 +28,15 @@
         android:layout_width="match_parent"
         android:layout_height="match_parent">
 
+        <!-- Main container -->
         <androidx.coordinatorlayout.widget.CoordinatorLayout
             android:layout_width="match_parent"
             android:layout_height="match_parent"
-            android:orientation="vertical">
+            android:orientation="vertical"
+            android:paddingTop="@dimen/main_container_padding_top"
+            android:background="?attr/colorSurfaceBright">
 
+            <!-- Main list area (file list/grid or search results), full height -->
             <FrameLayout
                 android:layout_width="match_parent"
                 android:layout_height="match_parent"
@@ -60,35 +64,48 @@
                     android:layout_height="match_parent"/>
             </FrameLayout>
 
-            <androidx.coordinatorlayout.widget.CoordinatorLayout
-                android:id="@+id/container_save"
+            <!-- Footer of right hand side: Breadcrumbs and Picker footer. -->
+            <LinearLayout
+                android:id="@+id/bottom_container"
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:layout_gravity="bottom|center_horizontal"
-                android:background="?android:attr/colorBackgroundFloating"
-                android:elevation="8dp" />
+                android:orientation="vertical"
+                android:layout_gravity="bottom">
+
+                <com.google.android.material.divider.MaterialDivider
+                    android:id="@+id/breadcrumb_top_divider"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    app:dividerColor="?attr/colorSurfaceContainer"
+                    app:dividerThickness="@dimen/main_container_section_gap" />
+
+                <com.android.documentsui.HorizontalBreadcrumb
+                    android:id="@+id/horizontal_breadcrumb"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:background="?attr/colorSurfaceBright"
+                    android:paddingHorizontal="@dimen/breadcrumb_padding_horizontal" />
+
+                <androidx.coordinatorlayout.widget.CoordinatorLayout
+                    android:id="@+id/container_save"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:background="?attr/colorSurfaceContainer" />
 
+            </LinearLayout>
+
+            <!-- Top section: toolbar, search chips, profile tab -->
             <include layout="@layout/directory_app_bar"/>
 
         </androidx.coordinatorlayout.widget.CoordinatorLayout>
 
+        <!-- Drawer section -->
         <LinearLayout
             android:id="@+id/drawer_roots"
             android:layout_width="256dp"
             android:layout_height="match_parent"
             android:layout_gravity="start"
-            android:orientation="vertical"
-            android:elevation="0dp"
-            android:background="?android:attr/colorBackground">
-
-            <androidx.appcompat.widget.Toolbar
-                android:id="@+id/roots_toolbar"
-                android:layout_width="match_parent"
-                android:layout_height="?android:attr/actionBarSize"
-                android:background="?android:attr/colorBackground"
-                android:elevation="0dp"
-                app:titleTextAppearance="@style/DrawerMenuTitle"
-                app:titleTextColor="?android:colorAccent"/>
+            android:orientation="vertical">
 
             <FrameLayout
                 android:id="@+id/container_roots"
@@ -99,4 +116,12 @@
         </LinearLayout>
 
     </androidx.drawerlayout.widget.DrawerLayout>
+
+    <!-- Peek overlay -->
+    <FrameLayout
+        android:id="@+id/peek_overlay"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:visibility="gone" />
+
 </androidx.coordinatorlayout.widget.CoordinatorLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml
index e2f0d35cd..a4210d07c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/drop_badge.xml
@@ -17,8 +17,8 @@
 <com.android.documentsui.DropBadgeView
         xmlns:android="http://schemas.android.com/apk/res/android"
         android:id="@android:id/icon"
-        android:layout_width="26dp"
-        android:layout_height="26dp"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
         android:scaleType="centerInside"
         android:contentDescription="@null"
         android:duplicateParentState="true"/>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
index 682edcb7d..4445dd1a6 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fixed_layout.xml
@@ -18,7 +18,6 @@
      floating action buttons) to operate correctly. -->
 <androidx.coordinatorlayout.widget.CoordinatorLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
     android:id="@+id/coordinator_layout"
@@ -27,59 +26,65 @@
     <LinearLayout
         android:layout_width="match_parent"
         android:layout_height="match_parent"
+        android:orientation="horizontal"
+        android:baselineAligned="false"
         android:background="?attr/colorSurfaceContainer"
-        android:orientation="vertical">
-
+        android:paddingTop="@dimen/layout_padding_top"
+        android:paddingBottom="@dimen/layout_padding_bottom"
+        android:paddingEnd="@dimen/layout_padding_end">
+        <!-- Navigation: left hand side. -->
+        <FrameLayout
+            android:id="@+id/container_roots"
+            android:layout_width="256dp"
+            android:layout_height="match_parent"
+            />
+
+        <!-- Main container for the right hand side. -->
         <LinearLayout
             android:layout_width="match_parent"
-            android:layout_height="0dp"
-            android:layout_weight="1"
-            android:orientation="horizontal"
-            android:baselineAligned="false">
-
-            <FrameLayout
-                android:id="@+id/container_roots"
-                android:layout_width="256dp"
-                android:layout_height="match_parent"
-                android:layout_marginTop="@dimen/space_medium_1"
-                />
+            android:layout_height="match_parent"
+            android:orientation="vertical">
 
+            <!-- Top section: toolbar, search chips, profile tab -->
             <LinearLayout
                 android:layout_width="match_parent"
-                android:layout_height="match_parent"
+                android:layout_height="wrap_content"
                 android:orientation="vertical"
-                android:background="@drawable/main_container_background"
-                android:layout_margin="@dimen/space_small_1"
-                android:layout_marginStart="0dp">
+                android:paddingTop="@dimen/main_container_padding_top"
+                android:background="@drawable/main_container_top_section_background">
 
-                <androidx.appcompat.widget.Toolbar
+                <com.google.android.material.appbar.MaterialToolbar
                     android:id="@+id/toolbar"
                     android:layout_width="match_parent"
-                    android:layout_height="?android:attr/actionBarSize"
-                    android:layout_margin="@dimen/search_bar_margin"
-                    android:elevation="3dp"
-                    android:popupTheme="?actionBarPopupTheme"
-                    android:theme="?actionBarTheme"
-                    app:collapseContentDescription="@string/button_back"
-                    app:titleTextAppearance="@style/ToolbarTitle">
+                    android:layout_height="?attr/actionBarSize"
+                    android:layout_marginTop="@dimen/action_bar_margin"
+                    android:touchscreenBlocksFocus="false">
 
                     <TextView
                         android:id="@+id/searchbar_title"
                         android:layout_width="match_parent"
                         android:layout_height="?android:attr/actionBarSize"
-                        android:layout_marginEnd="@dimen/search_bar_text_margin_end"
-                        android:layout_marginStart="@dimen/search_bar_text_margin_start"
-                        android:drawablePadding="@dimen/search_bar_icon_padding"
-                        android:drawableStart="@drawable/ic_menu_search"
                         android:gravity="center_vertical"
-                        android:paddingStart="@dimen/search_bar_icon_padding"
                         android:text="@string/search_bar_hint"
                         android:textAppearance="@style/SearchBarTitle" />
 
-                </androidx.appcompat.widget.Toolbar>
+                </com.google.android.material.appbar.MaterialToolbar>
 
                 <include layout="@layout/directory_header" />
 
+            </LinearLayout>
+
+            <!-- Main list area (file list/grid or search results). -->
+            <LinearLayout
+                android:layout_width="match_parent"
+                android:layout_height="0dp"
+                android:layout_weight="1"
+                android:orientation="vertical"
+                android:layout_marginTop="@dimen/main_container_section_gap"
+                android:background="@drawable/main_container_middle_section_background">
+
+                <include layout="@layout/column_headers"/>
+
                 <FrameLayout
                     android:layout_width="match_parent"
                     android:layout_height="0dp"
@@ -98,18 +103,39 @@
                         android:layout_height="match_parent" />
 
                 </FrameLayout>
+            </LinearLayout>
 
-                <androidx.coordinatorlayout.widget.CoordinatorLayout
-                    android:id="@+id/container_save"
+            <!-- Footer of right hand side: Breadcrumbs and Picker footer. -->
+            <LinearLayout
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:layout_marginTop="@dimen/main_container_section_gap"
+                android:background="@drawable/main_container_bottom_section_background">
+
+                <com.android.documentsui.HorizontalBreadcrumb
+                    android:id="@+id/horizontal_breadcrumb"
                     android:layout_width="match_parent"
                     android:layout_height="wrap_content"
-                    android:background="?android:attr/colorBackgroundFloating"
-                    android:elevation="8dp" />
+                    android:paddingHorizontal="@dimen/breadcrumb_padding_horizontal" />
 
             </LinearLayout>
 
+            <androidx.coordinatorlayout.widget.CoordinatorLayout
+                android:id="@+id/container_save"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:background="?attr/colorSurfaceContainer"
+                android:elevation="8dp" />
+
         </LinearLayout>
 
     </LinearLayout>
 
+    <!-- Peek overlay -->
+    <FrameLayout
+        android:id="@+id/peek_overlay"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:visibility="gone" />
+
 </androidx.coordinatorlayout.widget.CoordinatorLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
index f424e407d..a7ee033f1 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_directory.xml
@@ -21,13 +21,13 @@
     android:layout_height="match_parent"
     android:orientation="vertical">
 
-    <ProgressBar
+    <com.google.android.material.progressindicator.LinearProgressIndicator
         android:id="@+id/progressbar"
         android:layout_width="match_parent"
-        android:layout_height="@dimen/progress_bar_height"
+        android:layout_height="wrap_content"
         android:indeterminate="true"
-        style="@style/TrimmedHorizontalProgressBar"
-        android:visibility="gone"/>
+        app:trackColor="?attr/colorSecondaryContainer"
+        android:visibility="gone" />
 
     <com.android.documentsui.dirlist.DocumentsSwipeRefreshLayout
         android:id="@+id/refresh_layout"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_nav_rail_roots.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_nav_rail_roots.xml
new file mode 100644
index 000000000..7848dea0b
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_nav_rail_roots.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<com.android.documentsui.sidebar.RootsList xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/roots_list"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:keyboardNavigationCluster="true"
+    android:divider="@null"
+    android:focusable="false"
+    android:descendantFocusability="afterDescendants"
+    style="@style/NavRailStyle"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
index 742861a3e..5923bf9eb 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_pick.xml
@@ -13,48 +13,58 @@
      limitations under the License.
 -->
 
-<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+<androidx.constraintlayout.widget.ConstraintLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:orientation="horizontal"
-    android:baselineAligned="false"
-    android:gravity="center_vertical|end"
-    android:paddingStart="@dimen/bottom_bar_padding"
-    android:paddingEnd="@dimen/bottom_bar_padding">
-
-    <com.google.android.material.button.MaterialButton
-        android:id="@android:id/button2"
-        style="?attr/materialButtonOutlinedStyle"
-        app:cornerRadius="@dimen/button_corner_radius"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        android:layout_marginStart="4dp"
-        android:layout_marginEnd="4dp"
-        android:text="@android:string/cancel" />
+    android:paddingTop="@dimen/picker_saver_container_padding_top"
+    android:paddingBottom="@dimen/picker_saver_container_padding_bottom">
 
-    <FrameLayout
+    <LinearLayout
         android:layout_width="match_parent"
-        android:layout_height="match_parent">
+        android:layout_height="wrap_content"
+        android:orientation="horizontal"
+        android:baselineAligned="false"
+        android:background="?attr/colorSurfaceContainer"
+        android:gravity="center_vertical|end"
+        android:paddingStart="@dimen/bottom_bar_padding"
+        android:paddingEnd="@dimen/bottom_bar_padding"
+        android:paddingTop="@dimen/picker_saver_padding_top"
+        android:paddingBottom="@dimen/picker_saver_padding_bottom">
+
+        <com.google.android.material.button.MaterialButton
+            android:id="@android:id/button2"
+            style="@style/MaterialTonalButton"
+            app:cornerRadius="@dimen/button_corner_radius"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginStart="@dimen/picker_saver_button_gap"
+            android:layout_marginEnd="@dimen/picker_saver_button_gap"
+            android:text="@android:string/cancel" />
 
         <com.google.android.material.button.MaterialButton
             android:id="@android:id/button1"
-            style="?attr/materialButtonStyle"
+            style="@style/MaterialButton"
             app:cornerRadius="@dimen/button_corner_radius"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
-            android:layout_marginStart="4dp"
-            android:backgroundTint="@color/fragment_pick_button_background_color"
-            android:textColor="@color/fragment_pick_button_text_color"
-            android:layout_marginEnd="4dp" />
+            android:layout_marginStart="@dimen/picker_saver_button_gap"
+            android:layout_marginEnd="@dimen/picker_saver_button_gap" />
 
-        <!-- Handles touch events when button1 is disabled. -->
-        <FrameLayout
-            android:id="@+id/pick_button_overlay"
-            android:importantForAccessibility="no"
-            android:layout_width="match_parent"
-            android:layout_height="match_parent" />
+    </LinearLayout>
 
-    </FrameLayout>
+    <!-- Handles touch events when button1 is disabled. -->
+    <View
+        android:id="@+id/pick_button_overlay"
+        android:layout_width="0dp"
+        android:layout_height="0dp"
+        android:background="@android:color/transparent"
+        android:visibility="gone"
+        android:importantForAccessibility="no"
+        app:layout_constraintTop_toTopOf="parent"
+        app:layout_constraintBottom_toBottomOf="parent"
+        app:layout_constraintStart_toStartOf="parent"
+        app:layout_constraintEnd_toEndOf="parent"/>
 
-</LinearLayout>
+</androidx.constraintlayout.widget.ConstraintLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml
index 97363208b..0728c6279 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_roots.xml
@@ -18,6 +18,8 @@
     android:id="@+id/roots_list"
     android:layout_width="match_parent"
     android:layout_height="match_parent"
-    android:paddingTop="8dp"
     android:keyboardNavigationCluster="true"
-    android:divider="@null"/>
+    android:divider="@null"
+    android:focusable="false"
+    android:descendantFocusability="afterDescendants"
+    style="@style/DrawerStyle"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
index 401eaec88..3270b183c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save.xml
@@ -18,50 +18,49 @@
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:paddingStart="@dimen/list_item_padding"
-    android:paddingEnd="@dimen/bottom_bar_padding"
-    android:orientation="horizontal"
-    android:baselineAligned="false"
-    android:gravity="center_vertical"
-    android:minHeight="?android:attr/listPreferredItemHeightSmall">
+    android:paddingTop="@dimen/picker_saver_container_padding_top"
+    android:paddingBottom="@dimen/picker_saver_container_padding_bottom">
 
-    <FrameLayout
-        android:layout_width="@dimen/icon_size"
-        android:layout_height="@dimen/icon_size"
-        android:layout_marginEnd="16dp">
-
-        <ImageView
-            android:id="@android:id/icon"
-            android:layout_width="@dimen/root_icon_size"
-            android:layout_height="match_parent"
-            android:scaleType="centerInside"
-            android:contentDescription="@null" />
-
-    </FrameLayout>
-
-    <EditText
-        android:id="@android:id/title"
-        android:layout_width="0dp"
+    <LinearLayout
+        android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:layout_weight="1"
-        android:singleLine="true"
-        android:selectAllOnFocus="true" />
+        android:paddingTop="@dimen/picker_saver_padding_top"
+        android:paddingBottom="@dimen/picker_saver_padding_bottom"
+        android:paddingEnd="@dimen/bottom_bar_padding"
+        android:orientation="horizontal"
+        android:baselineAligned="false"
+        android:gravity="center_vertical|end"
+        android:paddingStart="@dimen/list_item_padding">
+
+        <com.google.android.material.textfield.TextInputLayout
+            android:id="@+id/title_wrapper"
+            style="?attr/textInputFilledStyle"
+            android:layout_width="0dp"
+            android:layout_height="wrap_content"
+            android:layout_weight="1"
+            android:layout_marginEnd="@dimen/picker_saver_button_gap"
+            android:hint="@string/file_name_hint">
+            <com.google.android.material.textfield.TextInputEditText
+                android:id="@android:id/title"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:singleLine="true"
+                android:selectAllOnFocus="true" />
+        </com.google.android.material.textfield.TextInputLayout>
 
-    <FrameLayout
-        android:layout_width="wrap_content"
-        android:layout_height="match_parent">
+        <include layout="@layout/fragment_save_cancel_button" />
 
         <com.google.android.material.button.MaterialButton
             android:id="@android:id/button1"
-            style="@style/Widget.Material3.Button.UnelevatedButton"
+            style="@style/MaterialButton"
             app:cornerRadius="@dimen/button_corner_radius"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
-            android:layout_marginStart="4dp"
-            android:layout_marginEnd="4dp"
+            android:layout_marginStart="@dimen/picker_saver_button_gap"
+            android:layout_marginEnd="@dimen/picker_saver_button_gap"
             android:text="@string/menu_save"/>
 
-        <ProgressBar
+        <com.google.android.material.progressindicator.CircularProgressIndicator
             android:id="@android:id/progress"
             android:layout_width="wrap_content"
             android:layout_height="wrap_content"
@@ -69,8 +68,8 @@
             android:visibility="gone"
             android:indeterminate="true"
             android:padding="8dp"
-            style="?android:attr/progressBarStyle" />
+            app:trackColor="?attr/colorSecondaryContainer" />
 
-    </FrameLayout>
+    </LinearLayout>
 
 </LinearLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml
new file mode 100644
index 000000000..5179630c9
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/fragment_save_cancel_button.xml
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<!-- The "Cancel" button is default invisible. On form factors with FEATURE_PC set, it is
+     updated to be shown always. -->
+<com.google.android.material.button.MaterialButton
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:id="@android:id/button2"
+    style="@style/Widget.Material3.Button.TonalButton"
+    app:cornerRadius="@dimen/button_corner_radius"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_marginStart="4dp"
+    android:layout_marginEnd="4dp"
+    android:visibility="gone"
+    android:text="@android:string/cancel"/>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
index 32596f2f4..a8e3148b4 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_grid.xml
@@ -13,197 +13,170 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
-
-<!-- FYI: This layout has an extra top level container view that was previously used
-     to allow for the insertion of debug info. The debug info is now gone, but the
-     container remains because there is a high likelihood of UI regression relating
-     to focus and selection states, some of which are specific to keyboard
-     when touch mode is not enable. So, if you, heroic engineer of the future,
-     decide to rip these out, please be sure to check out focus and keyboards. -->
-<com.google.android.material.card.MaterialCardView
-    xmlns:android="http://schemas.android.com/apk/res/android"
+<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
     xmlns:app="http://schemas.android.com/apk/res-auto"
     android:id="@+id/item_root"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:layout_margin="4dp"
-    android:foreground="?android:attr/selectableItemBackground"
     android:clickable="true"
-    android:focusable="true"
-    app:cardElevation="0dp">
-
-    <com.google.android.material.card.MaterialCardView
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:elevation="0dp"
-        android:duplicateParentState="true"
-        app:cardElevation="0dp"
-        app:strokeWidth="1dp"
-        app:strokeColor="?android:strokeColor">
-
-        <RelativeLayout
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:duplicateParentState="true">
-
-            <!-- Main item thumbnail.  Comprised of two overlapping images, the
-                 visibility of which is controlled by code in
-                 DirectoryFragment.java. -->
-
-            <FrameLayout
-                android:id="@+id/thumbnail"
-                android:background="?attr/gridItemTint"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content">
+    android:defaultFocusHighlightEnabled="false"
+    android:focusable="true">
+
+    <RelativeLayout
+        android:layout_width="@dimen/grid_width"
+        android:layout_height="@dimen/grid_height"
+        android:layout_margin="@dimen/grid_item_margin"
+        android:layout_gravity="center_horizontal"
+        android:paddingEnd="@dimen/grid_item_padding_end"
+        android:paddingStart="@dimen/grid_item_padding_start"
+        android:paddingTop="@dimen/grid_item_padding_top"
+        android:duplicateParentState="true">
+
+    <!-- Main item thumbnail.  Comprised of two overlapping images, the
+             visibility of which is controlled by code in
+             DirectoryFragment.java. -->
+
+        <FrameLayout
+            android:id="@+id/thumbnail"
+            android:layout_width="@dimen/grid_item_thumbnail_width"
+            android:layout_height="@dimen/grid_item_thumbnail_height"
+            android:layout_centerHorizontal="true"
+            android:background="@drawable/grid_thumbnail_background">
+
+            <!-- stroke width will be controlled dynamically in the code. -->
+            <com.google.android.material.card.MaterialCardView
+                android:id="@+id/icon_wrapper"
+                android:layout_width="@dimen/grid_item_icon_width"
+                android:layout_height="@dimen/grid_item_icon_height"
+                android:layout_gravity="center"
+                app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
+                app:cardElevation="0dp"
+                app:strokeColor="?attr/colorSecondaryContainer"
+                app:strokeWidth="0dp">
 
                 <com.android.documentsui.GridItemThumbnail
                     android:id="@+id/icon_thumb"
                     android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:scaleType="centerCrop"
+                    android:layout_height="match_parent"
                     android:contentDescription="@null"
+                    android:scaleType="centerCrop"
                     android:tint="?attr/gridItemTint"
-                    android:tintMode="src_over"/>
+                    android:tintMode="src_over" />
 
                 <com.android.documentsui.GridItemThumbnail
                     android:id="@+id/icon_mime_lg"
                     android:layout_width="@dimen/icon_size"
                     android:layout_height="@dimen/icon_size"
                     android:layout_gravity="center"
-                    android:scaleType="fitCenter"
-                    android:contentDescription="@null"/>
-
-            </FrameLayout>
-
-            <FrameLayout
-                android:id="@+id/preview_icon"
-                android:layout_width="@dimen/button_touch_size"
-                android:layout_height="@dimen/button_touch_size"
-                android:layout_alignParentTop="true"
-                android:layout_alignParentEnd="true"
-                android:pointerIcon="hand"
-                android:focusable="true"
-                android:clickable="true">
+                    android:contentDescription="@null"
+                    android:scaleType="fitCenter" />
+
+            </com.google.android.material.card.MaterialCardView>
+
+        </FrameLayout>
+
+        <FrameLayout
+            android:id="@+id/preview_icon"
+            android:layout_width="@dimen/button_touch_size"
+            android:layout_height="@dimen/button_touch_size"
+            android:layout_alignParentEnd="true"
+            android:layout_alignParentTop="true"
+            android:clickable="true"
+            android:focusable="true"
+            android:pointerIcon="hand">
+
+            <ImageView
+                android:layout_width="@dimen/zoom_icon_size"
+                android:layout_height="@dimen/zoom_icon_size"
+                android:layout_gravity="center"
+                android:background="@drawable/circle_button_background"
+                android:padding="2dp"
+                android:scaleType="fitCenter"
+                android:src="@drawable/ic_zoom_out" />
+
+        </FrameLayout>
+
+        <!-- Item nameplate. Has some text fields (title, size, mod-time, etc). -->
+
+        <LinearLayout
+            android:id="@+id/nameplate"
+            android:layout_width="@dimen/grid_item_nameplate_width"
+            android:layout_height="@dimen/grid_item_nameplate_height"
+            android:layout_below="@id/thumbnail"
+            android:layout_marginTop="@dimen/grid_item_nameplate_marginTop"
+            android:background="@drawable/grid_nameplate_background"
+            android:orientation="vertical"
+            android:duplicateParentState="true"
+            android:padding="@dimen/grid_item_nameplate_padding">
+
+            <!-- Top row. -->
+            <LinearLayout
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:gravity="center"
+                android:orientation="horizontal">
 
                 <ImageView
-                    android:layout_width="@dimen/zoom_icon_size"
-                    android:layout_height="@dimen/zoom_icon_size"
-                    android:padding="2dp"
-                    android:layout_gravity="center"
-                    android:background="@drawable/circle_button_background"
-                    android:scaleType="fitCenter"
-                    android:src="@drawable/ic_zoom_out"/>
-
-            </FrameLayout>
+                    android:id="@+id/icon_profile_badge"
+                    android:layout_width="@dimen/briefcase_icon_size"
+                    android:layout_height="@dimen/briefcase_icon_size"
+                    android:layout_marginEnd="@dimen/briefcase_icon_margin"
+                    android:contentDescription="@string/a11y_work"
+                    android:gravity="center_vertical"
+                    android:src="@drawable/ic_briefcase"
+                    android:tint="?android:attr/colorAccent" />
+
+                <TextView
+                    android:id="@android:id/title"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:ellipsize="end"
+                    android:singleLine="true"
+                    android:textAlignment="center"
+                    android:textAppearance="@style/FileItemLabelText" />
 
-            <!-- Item nameplate.  Has a mime-type icon and some text fields (title,
-                 size, mod-time, etc). -->
+            </LinearLayout>
 
+            <!-- Bottom row. -->
             <LinearLayout
-                android:id="@+id/nameplate"
-                android:background="?android:attr/colorBackground"
-                android:orientation="horizontal"
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:layout_below="@id/thumbnail">
+                android:gravity="center"
+                android:orientation="horizontal">
 
-                <FrameLayout
-                    android:id="@+id/icon"
+                <TextView
+                    android:id="@+id/details"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_marginEnd="4dp"
+                    android:ellipsize="end"
+                    android:singleLine="true"
+                    android:textAlignment="viewStart"
+                    android:textAppearance="@style/ItemCaptionText" />
+
+                <TextView
+                    android:id="@+id/bullet"
                     android:layout_width="wrap_content"
-                    android:layout_height="match_parent"
-                    android:layout_centerVertical="true"
-                    android:pointerIcon="hand"
-                    android:paddingTop="8dp"
-                    android:paddingBottom="8dp"
-                    android:paddingStart="12dp"
-                    android:paddingEnd="8dp">
-
-                    <ImageView
-                        android:id="@+id/icon_mime_sm"
-                        android:layout_width="@dimen/grid_item_icon_size"
-                        android:layout_height="@dimen/grid_item_icon_size"
-                        android:layout_gravity="center"
-                        android:scaleType="center"
-                        android:contentDescription="@null"/>
-
-                    <ImageView
-                        android:id="@+id/icon_check"
-                        android:src="@drawable/ic_check_circle"
-                        android:alpha="0"
-                        android:layout_width="@dimen/check_icon_size"
-                        android:layout_height="@dimen/check_icon_size"
-                        android:layout_gravity="center"
-                        android:scaleType="fitCenter"
-                        android:contentDescription="@null"/>
-
-                </FrameLayout>
-
-                <RelativeLayout
-                    android:layout_width="match_parent"
                     android:layout_height="wrap_content"
-                    android:paddingBottom="8dp"
-                    android:paddingTop="8dp"
-                    android:paddingEnd="12dp">
-
-                    <ImageView
-                        android:id="@+id/icon_profile_badge"
-                        android:layout_height="@dimen/briefcase_icon_size"
-                        android:layout_width="@dimen/briefcase_icon_size"
-                        android:layout_marginEnd="@dimen/briefcase_icon_margin"
-                        android:layout_alignTop="@android:id/title"
-                        android:layout_alignBottom="@android:id/title"
-                        android:gravity="center_vertical"
-                        android:src="@drawable/ic_briefcase"
-                        android:tint="?android:attr/colorAccent"
-                        android:contentDescription="@string/a11y_work"/>
-
-                    <TextView
-                        android:id="@android:id/title"
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:layout_alignParentTop="true"
-                        android:layout_toEndOf="@+id/icon_profile_badge"
-                        android:singleLine="true"
-                        android:ellipsize="end"
-                        android:textAlignment="viewStart"
-                        android:textAppearance="@style/CardPrimaryText"/>
-
-                    <TextView
-                        android:id="@+id/details"
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:layout_below="@android:id/title"
-                        android:layout_marginEnd="4dp"
-                        android:singleLine="true"
-                        android:ellipsize="end"
-                        android:textAlignment="viewStart"
-                        android:textAppearance="@style/ItemCaptionText" />
-
-                    <TextView
-                        android:id="@+id/date"
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:layout_below="@android:id/title"
-                        android:layout_toEndOf="@id/details"
-                        android:singleLine="true"
-                        android:ellipsize="end"
-                        android:textAlignment="viewStart"
-                        android:textAppearance="@style/ItemCaptionText" />
-
-                </RelativeLayout>
+                    android:layout_marginEnd="4dp"
+                    android:singleLine="true"
+                    android:text="@string/bullet"
+                    android:textAlignment="viewStart"
+                    android:textAppearance="@style/ItemCaptionText" />
+
+                <TextView
+                    android:id="@+id/date"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:ellipsize="end"
+                    android:singleLine="true"
+                    android:textAlignment="viewStart"
+                    android:textAppearance="@style/ItemCaptionText" />
 
             </LinearLayout>
 
-        </RelativeLayout>
-
-    </com.google.android.material.card.MaterialCardView>
+        </LinearLayout>
 
-    <!-- An overlay that draws the item border when it is focused. -->
-    <View
-        android:layout_width="match_parent"
-        android:layout_height="match_parent"
-        android:background="@drawable/item_doc_grid_border_rounded"
-        android:contentDescription="@null"
-        android:duplicateParentState="true"/>
+    </RelativeLayout>
 
-</com.google.android.material.card.MaterialCardView>
+</FrameLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
index 26f5a8ee7..9cf92940c 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_inflated_message.xml
@@ -19,7 +19,7 @@
     android:id="@android:id/empty"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:background="?android:attr/colorBackground"
+    android:background="?attr/colorSurfaceBright"
     android:focusable="true">
 
     <include android:id="@+id/content" layout="@layout/item_doc_inflated_message_content"/>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
index 055c1b203..b3ab315c5 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_doc_list.xml
@@ -20,7 +20,6 @@
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
     android:background="@drawable/list_item_background"
-    android:foreground="?android:attr/selectableItemBackground"
     android:clickable="true"
     android:focusable="true"
     android:orientation="vertical">
@@ -31,23 +30,27 @@
         android:baselineAligned="false"
         android:gravity="center_vertical"
         android:minHeight="@dimen/list_item_height"
-        android:orientation="horizontal">
+        android:orientation="horizontal"
+        android:paddingStart="@dimen/list_item_padding_start"
+        android:paddingEnd="@dimen/list_item_padding_end"
+        android:paddingVertical="@dimen/list_item_padding_vertical">
 
       <FrameLayout
           android:id="@+id/icon"
           android:pointerIcon="hand"
-          android:layout_width="@dimen/list_item_width"
-          android:layout_height="@dimen/list_item_height"
-          android:paddingBottom="@dimen/list_item_icon_padding"
-          android:paddingTop="@dimen/list_item_icon_padding"
-          android:paddingEnd="16dp"
-          android:paddingStart="@dimen/list_item_padding">
+          android:layout_width="@dimen/list_item_icon_size"
+          android:layout_height="@dimen/list_item_icon_size"
+          android:layout_marginEnd="@dimen/list_item_icon_margin_end">
 
+        <!-- stroke width will be controlled dynamically in the code. -->
         <com.google.android.material.card.MaterialCardView
+            android:id="@+id/icon_wrapper"
             android:layout_width="match_parent"
             android:layout_height="match_parent"
-            app:cardBackgroundColor="@android:color/transparent"
-            app:cardElevation="0dp">
+            app:cardElevation="0dp"
+            app:cardBackgroundColor="?attr/colorSurfaceContainerLowest"
+            app:strokeColor="?attr/colorSecondaryContainer"
+            app:strokeWidth="0dp">
 
           <ImageView
               android:id="@+id/icon_mime"
@@ -84,7 +87,7 @@
           android:layout_weight="1"
           android:orientation="vertical"
           android:layout_gravity="center_vertical"
-          android:layout_marginEnd="@dimen/list_item_padding">
+          android:layout_marginEnd="@dimen/list_item_icon_size">
 
         <LinearLayout
             android:layout_width="wrap_content"
@@ -98,7 +101,7 @@
               android:layout_marginEnd="@dimen/briefcase_icon_margin"
               android:layout_gravity="center_vertical"
               android:src="@drawable/ic_briefcase"
-              android:tint="?android:attr/colorAccent"
+              android:tint="@color/doc_list_item_badge_icon_color"
               android:contentDescription="@string/a11y_work" />
 
           <TextView
@@ -108,7 +111,7 @@
               android:ellipsize="end"
               android:singleLine="true"
               android:textAlignment="viewStart"
-              android:textAppearance="?android:attr/textAppearanceListItem" />
+              android:textAppearance="@style/FileItemLabelText" />
 
         </LinearLayout>
 
@@ -117,7 +120,6 @@
             android:layout_width="match_parent"
             android:layout_height="wrap_content"
             android:baselineAligned="false"
-            android:layout_marginTop="4dp"
             android:gravity="center_vertical"
             android:orientation="horizontal">
 
@@ -135,9 +137,8 @@
 
       <FrameLayout
           android:id="@+id/preview_icon"
-          android:layout_width="@dimen/list_item_width"
-          android:layout_height="@dimen/list_item_height"
-          android:padding="@dimen/list_item_icon_padding"
+          android:layout_width="@dimen/list_item_icon_size"
+          android:layout_height="@dimen/list_item_icon_size"
           android:focusable="true"
           android:clickable="true">
 
@@ -146,18 +147,11 @@
             android:layout_height="@dimen/check_icon_size"
             android:layout_gravity="center"
             android:scaleType="fitCenter"
-            android:tint="?android:attr/colorControlNormal"
+            android:tint="@color/doc_list_item_badge_icon_color"
             android:src="@drawable/ic_zoom_out" />
 
       </FrameLayout>
 
     </LinearLayout>
 
-  <View
-      android:layout_width="match_parent"
-      android:layout_height="1dp"
-      android:layout_marginStart="72dp"
-      android:layout_marginEnd="8dp"
-      android:background="?android:strokeColor" />
-
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml
index 14751c014..599fab108 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root.xml
@@ -16,14 +16,16 @@
 
 <com.android.documentsui.sidebar.RootItemView
     xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:minHeight="52dp"
-    android:paddingStart="24dp"
+    android:minHeight="@dimen/drawer_item_height"
     android:gravity="center_vertical"
     android:orientation="horizontal"
     android:baselineAligned="false"
-    android:background="@drawable/root_item_background">
+    android:clickable="true"
+    android:focusable="true"
+    style="@style/DrawerItemStyle">
 
     <FrameLayout
         android:layout_width="wrap_content"
@@ -43,9 +45,7 @@
     <LinearLayout
         android:layout_width="match_parent"
         android:layout_height="wrap_content"
-        android:paddingStart="16dp"
-        android:paddingTop="8dp"
-        android:paddingBottom="8dp"
+        android:layout_marginStart="@dimen/drawer_item_text_margin_start"
         android:orientation="vertical"
         android:layout_weight="1">
 
@@ -69,24 +69,11 @@
 
     </LinearLayout>
 
-    <include layout="@layout/root_vertical_divider" />
-
-    <FrameLayout
-        android:id="@+id/action_icon_area"
-        android:layout_width="@dimen/button_touch_size"
-        android:layout_height="@dimen/button_touch_size"
-        android:paddingEnd="@dimen/grid_padding_horiz"
-        android:duplicateParentState="true"
-        android:visibility="gone">
-
-        <ImageView
-            android:id="@+id/action_icon"
-            android:focusable="false"
-            android:layout_width="@dimen/root_action_icon_size"
-            android:layout_height="match_parent"
-            android:layout_gravity="center"
-            android:scaleType="centerInside"/>
-
-    </FrameLayout>
+    <com.google.android.material.button.MaterialButton
+        android:id="@+id/action_icon"
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        style="@style/DrawerItemActionIconStyle"
+        android:visibility="gone"/>
 
 </com.android.documentsui.sidebar.RootItemView>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml
index 83dcd818c..dab92dbf0 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/item_root_spacer.xml
@@ -17,13 +17,12 @@
 <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
     android:layout_width="match_parent"
     android:layout_height="wrap_content"
-    android:paddingStart="@dimen/root_spacer_padding"
-    android:paddingTop="12dp"
-    android:paddingBottom="12dp">
+    android:focusable="false"
+    android:paddingHorizontal="@dimen/drawer_divider_padding_horizontal">
 
     <View
         android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:background="?android:attr/listDivider" />
+        android:layout_height="1dp"
+        android:background="?attr/colorOutlineVariant" />
 
 </FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml
new file mode 100644
index 000000000..17f6aa6fc
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_panel.xml
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+
+<FrameLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content">
+    <com.google.android.material.card.MaterialCardView
+        style="@style/JobProgressPanelStyle"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content">
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:orientation="vertical">
+            <TextView
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:id="@+id/job_progress_panel_title"
+                android:text="@string/job_progress_panel_title"
+                android:textAppearance="@style/JobProgressPanelHeaderText"
+                android:layout_margin="@dimen/job_progress_panel_header_margin" />
+            <androidx.recyclerview.widget.RecyclerView
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:id="@+id/job_progress_list" />
+        </LinearLayout>
+    </com.google.android.material.card.MaterialCardView>
+</FrameLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml
new file mode 100644
index 000000000..222c8d43e
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/job_progress_toolbar_item.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2025 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+
+<com.google.android.material.progressindicator.CircularProgressIndicator
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    style="@style/JobProgressToolbarIndicatorStyle"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:clickable="true"
+    android:focusable="true" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml
new file mode 100644
index 000000000..461027c73
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_item_root.xml
@@ -0,0 +1,55 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<com.android.documentsui.sidebar.RootItemView
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:minHeight="@dimen/nav_rail_item_height"
+    android:gravity="center_horizontal"
+    android:orientation="vertical"
+    android:baselineAligned="false"
+    android:clickable="true"
+    android:focusable="true"
+    style="@style/NavRailItemStyle">
+
+    <LinearLayout
+        android:layout_width="@dimen/nav_rail_item_icon_bg_width"
+        android:layout_height="@dimen/nav_rail_item_icon_bg_height"
+        android:gravity="center"
+        android:duplicateParentState="true"
+        android:background="@drawable/nav_rail_item_icon_background">
+
+        <ImageView
+            android:id="@android:id/icon"
+            android:layout_width="@dimen/root_icon_size"
+            android:layout_height="@dimen/root_icon_size"
+            android:scaleType="centerInside"
+            android:contentDescription="@null" />
+
+    </LinearLayout>
+
+    <TextView
+        android:id="@android:id/title"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:singleLine="true"
+        android:ellipsize="end"
+        android:textAlignment="center"
+        android:duplicateParentState="true"
+        style="@style/NavRailItemTextStyle" />
+
+</com.android.documentsui.sidebar.RootItemView>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml
new file mode 100644
index 000000000..091444155
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/nav_rail_layout.xml
@@ -0,0 +1,190 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!-- CoordinatorLayout is necessary for various components (e.g. Snackbars, and
+     floating action buttons) to operate correctly. -->
+<androidx.coordinatorlayout.widget.CoordinatorLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:id="@+id/coordinator_layout">
+
+    <androidx.drawerlayout.widget.DrawerLayout
+        android:id="@+id/drawer_layout"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent">
+
+        <!-- Main section -->
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="match_parent"
+            android:orientation="horizontal"
+            android:baselineAligned="false"
+            android:paddingTop="@dimen/layout_padding_top"
+            android:paddingEnd="@dimen/layout_padding_end"
+            android:paddingBottom="@dimen/layout_padding_bottom"
+            android:background="?attr/colorSurfaceContainer">
+
+            <!-- Navigation rail: left hand side. -->
+            <LinearLayout
+                android:id="@+id/nav_rail_container"
+                android:layout_width="144dp"
+                android:layout_height="match_parent"
+                android:orientation="vertical"
+                android:gravity="center_horizontal">
+
+                <com.google.android.material.button.MaterialButton
+                    style="?attr/materialIconButtonStyle"
+                    android:id="@+id/nav_rail_burger_menu"
+                    android:layout_width="@dimen/nav_rail_burger_icon_size"
+                    android:layout_height="@dimen/nav_rail_burger_icon_size"
+                    android:layout_marginBottom="24dp"
+                    app:iconPadding="0dp"
+                    app:iconGravity="textStart"
+                    app:iconTint="?attr/colorOnSurfaceVariant"
+                    app:backgroundTint="@drawable/nav_rail_burger_icon_background"
+                    app:rippleColor="@color/nav_rail_burger_icon_ripple_color"
+                    app:strokeColor="?attr/colorPrimary"
+                    android:contentDescription="@string/drawer_open"
+                    app:icon="@drawable/ic_hamburger" />
+
+                <FrameLayout
+                    android:id="@+id/nav_rail_container_roots"
+                    android:layout_width="match_parent"
+                    android:layout_height="0dp"
+                    android:layout_weight="1" />
+
+            </LinearLayout>
+
+            <!-- Main container for the right hand side. -->
+            <LinearLayout
+                android:layout_width="match_parent"
+                android:layout_height="match_parent"
+                android:orientation="vertical">
+
+                <!-- Top section: toolbar, search chips, profile tab -->
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:orientation="vertical"
+                    android:paddingTop="@dimen/main_container_padding_top"
+                    android:background="@drawable/main_container_top_section_background">
+
+                    <com.google.android.material.appbar.MaterialToolbar
+                        android:id="@+id/toolbar"
+                        android:layout_width="match_parent"
+                        android:layout_height="?attr/actionBarSize"
+                        android:layout_marginTop="@dimen/action_bar_margin"
+                        android:touchscreenBlocksFocus="false">
+
+                        <TextView
+                            android:id="@+id/searchbar_title"
+                            android:layout_width="match_parent"
+                            android:layout_height="?android:attr/actionBarSize"
+                            android:gravity="center_vertical"
+                            android:text="@string/search_bar_hint"
+                            android:textAppearance="@style/SearchBarTitle" />
+
+                    </com.google.android.material.appbar.MaterialToolbar>
+
+                    <include layout="@layout/directory_header" />
+
+                </LinearLayout>
+
+                <!-- Main list area (file list/grid or search results). -->
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="0dp"
+                    android:layout_weight="1"
+                    android:orientation="vertical"
+                    android:layout_marginTop="@dimen/main_container_section_gap"
+                    android:background="@drawable/main_container_middle_section_background">
+
+                    <include layout="@layout/column_headers"/>
+
+                    <FrameLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="0dp"
+                        android:layout_weight="1">
+
+                        <FrameLayout
+                            android:id="@+id/container_directory"
+                            android:clipToPadding="false"
+                            android:layout_width="match_parent"
+                            android:layout_height="match_parent" />
+
+                        <FrameLayout
+                            android:id="@+id/container_search_fragment"
+                            android:clipToPadding="false"
+                            android:layout_width="match_parent"
+                            android:layout_height="match_parent" />
+
+                    </FrameLayout>
+
+                </LinearLayout>
+
+                <!-- Footer of right hand side: Breadcrumbs and Picker footer. -->
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_marginTop="@dimen/main_container_section_gap"
+                    android:background="@drawable/main_container_bottom_section_background">
+
+                    <com.android.documentsui.HorizontalBreadcrumb
+                        android:id="@+id/horizontal_breadcrumb"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:paddingHorizontal="@dimen/breadcrumb_padding_horizontal" />
+                </LinearLayout>
+
+                <androidx.coordinatorlayout.widget.CoordinatorLayout
+                    android:id="@+id/container_save"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:background="?attr/colorSurfaceContainer"
+                    android:elevation="8dp" />
+
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <!-- Drawer section -->
+        <LinearLayout
+            android:id="@+id/drawer_roots"
+            android:layout_width="256dp"
+            android:layout_height="match_parent"
+            android:layout_gravity="start"
+            android:orientation="vertical">
+
+            <FrameLayout
+                android:id="@+id/container_roots"
+                android:layout_width="match_parent"
+                android:layout_height="0dp"
+                android:layout_weight="1" />
+
+        </LinearLayout>
+
+    </androidx.drawerlayout.widget.DrawerLayout>
+
+    <!-- Peek overlay -->
+    <FrameLayout
+        android:id="@+id/peek_overlay"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:visibility="gone" />
+
+</androidx.coordinatorlayout.widget.CoordinatorLayout>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
index 672343795..ba99ac35d 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/navigation_breadcrumb_item.xml
@@ -15,29 +15,20 @@
      limitations under the License.
 -->
 
-
-<!--
-     CoordinatorLayout is necessary for various components (e.g. Snackbars, and
-     floating action buttons) to operate correctly.
--->
-<!--
-     focusableInTouchMode is set in order to force key events to go to the activity's global key
-     callback, which is necessary for proper event routing. See BaseActivity.onKeyDown.
--->
-
 <LinearLayout
-  xmlns:android="http://schemas.android.com/apk/res/android"
-  android:layout_width="wrap_content"
-  android:layout_height="wrap_content"
-  android:minHeight="48dp"
-  android:focusable="true"
-  android:gravity="center_vertical"
-  android:orientation="horizontal">
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:minHeight="@dimen/breadcrumb_height"
+    android:gravity="center_vertical"
+    android:orientation="horizontal">
 
     <TextView
         android:id="@+id/breadcrumb_text"
         android:layout_width="wrap_content"
-        android:layout_height="match_parent"
+        android:layout_height="@dimen/breadcrumb_item_height"
+        android:focusable="true"
+        android:clickable="true"
         android:maxWidth="275dp"
         android:gravity="center_vertical"
         android:maxLines="1"
@@ -47,8 +38,8 @@
 
     <ImageView
         android:id="@+id/breadcrumb_arrow"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
+        android:layout_width="@dimen/breadcrumb_item_arrow_size"
+        android:layout_height="@dimen/breadcrumb_item_arrow_size"
         android:src="@drawable/ic_breadcrumb_arrow"/>
 
 </LinearLayout>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml
new file mode 100644
index 000000000..50102d622
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/peek_layout.xml
@@ -0,0 +1,22 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<androidx.coordinatorlayout.widget.CoordinatorLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:id="@+id/peek_container"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:background="@color/peek_overlay_background"
+    android:focusable="false" />
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
index 74316598d..3197d9dce 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/root_vertical_divider.xml
@@ -15,6 +15,7 @@
   limitations under the License.
   -->
 
+<!-- TODO(b/379776735): remove this file after use_material3 flag is launched. -->
 <LinearLayout
     xmlns:android="http://schemas.android.com/apk/res/android"
     android:id="@+id/vertical_divider"
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml
index ef14bcdb2..62a36f3e8 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/search_chip_row.xml
@@ -20,10 +20,21 @@
     android:layout_height="wrap_content"
     android:scrollbars="none">
 
-    <com.google.android.material.chip.ChipGroup
-        android:id="@+id/search_chip_group"
+    <!-- This additional FrameLayout layer is essential to make HorizontalScrollView work with the
+         marginHorizontal on the ChipGroup below, without this the scroll behavior is weird.
+         Alternatively we could use paddingHorizontal on the ChipGroup below to make it work with
+         HorizontalScrollView, but that cause a weird padding issue in RTL.
+    -->
+    <FrameLayout
         android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:paddingHorizontal="@dimen/search_chip_group_margin_horizontal"
-        android:paddingVertical="@dimen/search_chip_group_margin_vertical"/>
-</HorizontalScrollView>
\ No newline at end of file
+        android:layout_height="wrap_content">
+
+        <com.google.android.material.chip.ChipGroup
+            android:id="@+id/search_chip_group"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:layout_marginHorizontal="@dimen/main_container_padding_start"
+            android:paddingVertical="@dimen/search_chip_group_padding_vertical" />
+
+    </FrameLayout>
+</HorizontalScrollView>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/shared_cell_content.xml b/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml
similarity index 85%
rename from res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/shared_cell_content.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml
index 4702eada3..f269afdbe 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/layout-w720dp/shared_cell_content.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/layout/shared_cell_content.xml
@@ -23,8 +23,8 @@
         android:ellipsize="end"
         android:singleLine="true"
         android:textAlignment="viewStart"
-        android:textAppearance="@style/Subhead"
-        android:textColor="?android:attr/textColorSecondary"/>
+        android:textAppearance="@style/ListTableHeaderText"
+        android:textColor="?attr/colorOnSurface"/>
 
     <ImageView
         android:id="@+id/sort_arrow"
@@ -32,6 +32,9 @@
         android:layout_width="@dimen/doc_header_sort_icon_size"
         android:layout_marginStart="3dp"
         android:visibility="gone"
+        android:focusable="true"
+        android:clickable="true"
+        android:background="?attr/colorSurfaceBright"
         android:src="@drawable/ic_sort_arrow"
         android:contentDescription="@null"/>
 </merge>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
new file mode 100644
index 000000000..c9c139cc9
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/action_mode_menu.xml
@@ -0,0 +1,101 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<menu
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto">
+    <item
+        android:id="@+id/action_menu_open_with"
+        android:title="@string/menu_open_with"
+        android:showAsAction="never"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_share"
+        android:icon="@drawable/ic_menu_share"
+        android:title="@string/menu_share"
+        android:showAsAction="always"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/action_menu_delete"
+        android:icon="@drawable/ic_menu_delete"
+        android:title="@string/menu_delete"
+        android:showAsAction="always"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/action_menu_sort"
+        android:icon="@drawable/ic_sort"
+        android:title="@string/menu_sort"
+        android:showAsAction="never"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_select"
+        android:title="@string/menu_select"
+        android:showAsAction="always"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/action_menu_select_all"
+        android:title="@string/menu_select_all"
+        android:showAsAction="never"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_deselect_all"
+        android:title="@string/menu_deselect_all"
+        android:showAsAction="never"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_copy_to"
+        android:title="@string/menu_copy"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_extract_to"
+        android:title="@string/menu_extract"
+        android:icon="@drawable/ic_menu_extract"
+        android:showAsAction="always"
+        android:visible="false"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/action_menu_move_to"
+        android:title="@string/menu_move"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_compress"
+        android:title="@string/menu_compress"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_rename"
+        android:title="@string/menu_rename"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_inspect"
+        android:title="@string/menu_inspect"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+    <item
+        android:id="@+id/action_menu_view_in_owner"
+        android:title="@string/menu_view_in_owner"
+        android:showAsAction="never"
+        android:visible="false"
+        app:showAsAction="never" />
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml
new file mode 100644
index 000000000..809a1386a
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/activity.xml
@@ -0,0 +1,112 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<menu
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto">
+<!-- showAsAction flag impacts the behavior of SearchView.
+     When set to collapseActionView, collapsing SearchView to icon is the
+     default behavior. It would fit UX, however after expanding SearchView is
+     shown on the left site of the toolbar (replacing title). Since no way to
+     prevent this behavior was found, the flag is set to always. SearchView is
+     always visible by default and it is being collapse manually by calling
+     setIconified() method
+-->
+    <item
+        android:id="@+id/option_menu_search"
+        android:title="@string/menu_search"
+        android:icon="@drawable/ic_menu_search"
+        android:imeOptions="actionSearch"
+        android:visible="false"
+        app:showAsAction="always|collapseActionView"
+        app:actionViewClass="androidx.appcompat.widget.SearchView"/>
+    <item
+        android:id="@+id/option_menu_job_progress"
+        android:enabled="false"
+        android:visible="false"
+        app:actionLayout="@layout/job_progress_toolbar_item"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/sub_menu_grid"
+        android:title="@string/menu_grid"
+        android:icon="@drawable/ic_menu_view_grid"
+        app:showAsAction="always" />
+    <item
+        android:id="@+id/sub_menu_list"
+        android:title="@string/menu_list"
+        android:icon="@drawable/ic_menu_view_list"
+        app:showAsAction="always" />
+<!-- This group is being hidden when searching is in full bar mode-->
+    <group android:id="@+id/group_hide_when_searching">
+        <item
+            android:id="@+id/option_menu_debug"
+            android:title="Debug"
+            android:icon="@drawable/ic_debug_menu"
+            android:visible="false"
+            app:showAsAction="always"/>
+        <item
+            android:id="@+id/option_menu_new_window"
+            android:title="@string/menu_new_window"
+            android:alphabeticShortcut="n"
+            android:visible="false"
+            app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_create_dir"
+            android:title="@string/menu_create_dir"
+            android:icon="@drawable/ic_create_new_folder"
+            android:alphabeticShortcut="e"
+            android:visible="false"
+            app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_sort"
+            android:title="@string/menu_sort"
+            android:icon="@drawable/ic_sort"
+            android:showAsAction="never"
+            android:visible="false" />
+        <item
+            android:id="@+id/option_menu_select_all"
+            android:title="@string/menu_select_all"
+            android:alphabeticShortcut="a"
+            android:visible="false"
+            app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_extract_all"
+            android:title="@string/menu_extract_all"
+            android:icon="@drawable/ic_menu_extract"
+            android:enabled="false"
+            android:visible="false"
+            app:showAsAction="always"/>
+        <item
+            android:id="@+id/option_menu_settings"
+            android:title="@string/menu_settings"
+            android:visible="false"
+            app:showAsAction="never"/>
+       <item
+           android:id="@+id/option_menu_inspect"
+           android:title="@string/menu_inspect"
+           android:visible="false"
+           app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_show_hidden_files"
+            android:title="@string/menu_show_hidden_files"
+            android:visible="false"
+            app:showAsAction="never"/>
+        <item
+            android:id="@+id/option_menu_launcher"
+            android:visible="false"
+            app:showAsAction="never"/>
+    </group>
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
new file mode 100644
index 000000000..b004edeb1
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/container_context_menu.xml
@@ -0,0 +1,48 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+
+<!-- Context menu used when right clicks on empty area of recycler view or empty view. -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+
+    <group
+        android:id="@+id/menu_clipboard_group">
+        <item
+            android:id="@+id/dir_menu_paste_from_clipboard"
+            android:title="@string/menu_paste_from_clipboard" />
+    </group>
+
+    <group
+        android:id="@+id/menu_modifier_group">
+        <item
+            android:id="@+id/dir_menu_create_dir"
+            android:title="@string/menu_create_dir" />
+
+        <item
+            android:id="@+id/dir_menu_select_all"
+            android:title="@string/menu_select_all" />
+
+        <item
+            android:id="@+id/dir_menu_deselect_all"
+            android:title="@string/menu_deselect_all" />
+    </group>
+    <group
+        android:id="@+id/menu_extras_group">
+        <item
+            android:id="@+id/dir_menu_inspect"
+            android:title="@string/menu_inspect" />
+    </group>
+</menu>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
new file mode 100644
index 000000000..1364b9ec7
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/dir_context_menu.xml
@@ -0,0 +1,60 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+
+<!-- Context menu used when user right clicks on a folder with a selection that doesn't have files.
+    Selection may be empty. -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <group
+        android:id="@+id/menu_open_group">
+        <item
+            android:id="@+id/dir_menu_open_in_new_window"
+            android:title="@string/menu_open_in_new_window" />
+    </group>
+
+    <group
+        android:id="@+id/menu_clipboard_group">
+        <item
+            android:id="@+id/dir_menu_cut_to_clipboard"
+            android:title="@string/menu_cut_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_copy_to_clipboard"
+            android:title="@string/menu_copy_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_compress"
+            android:title="@string/menu_compress" />
+        <item
+            android:id="@+id/dir_menu_paste_into_folder"
+            android:title="@string/menu_paste_into_folder" />
+    </group>
+
+    <group
+        android:id="@+id/menu_modifier_group">
+        <item
+            android:id="@+id/dir_menu_rename"
+            android:title="@string/menu_rename" />
+        <item
+            android:id="@+id/dir_menu_delete"
+            android:title="@string/menu_delete" />
+    </group>
+
+    <group
+        android:id="@+id/menu_extras_group">
+        <item
+            android:id="@+id/dir_menu_inspect"
+            android:title="@string/menu_inspect" />
+    </group>
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
new file mode 100644
index 000000000..70d6fd1bf
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/file_context_menu.xml
@@ -0,0 +1,74 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<!-- Context menu used when user right clicks on a file with a selection that doesn't have folders.
+    The selection may be empty. -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <item
+        android:id="@+id/dir_menu_extract_here"
+        android:title="@string/menu_extract_here"
+        android:visible="false" />
+    <item
+        android:id="@+id/dir_menu_browse"
+        android:title="@string/menu_browse"
+        android:visible="false" />
+
+    <group
+        android:id="@+id/menu_open_group">
+        <item
+            android:id="@+id/dir_menu_share"
+            android:title="@string/menu_share" />
+        <item
+            android:id="@+id/dir_menu_open"
+            android:title="@string/menu_open" />
+        <item
+            android:id="@+id/dir_menu_open_with"
+            android:title="@string/menu_open_with" />
+    </group>
+
+    <group
+        android:id="@+id/menu_clipboard_group">
+        <item
+            android:id="@+id/dir_menu_cut_to_clipboard"
+            android:title="@string/menu_cut_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_copy_to_clipboard"
+            android:title="@string/menu_copy_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_compress"
+            android:title="@string/menu_compress" />
+    </group>
+
+    <group
+        android:id="@+id/menu_modifier_group">
+        <item
+            android:id="@+id/dir_menu_rename"
+            android:title="@string/menu_rename" />
+        <item
+            android:id="@+id/dir_menu_delete"
+            android:title="@string/menu_delete" />
+    </group>
+
+    <group
+        android:id="@+id/menu_extras_group">
+        <item
+            android:id="@+id/dir_menu_inspect"
+            android:title="@string/menu_inspect" />
+        <item
+            android:id="@+id/dir_menu_view_in_owner"
+            android:title="@string/menu_view_in_owner" />
+    </group>
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
new file mode 100644
index 000000000..076aeda0d
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/mixed_context_menu.xml
@@ -0,0 +1,47 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2024 The Android Open Source Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+  -->
+
+<!-- Context menu used when user right clicks with a selection mixed with both folders and docs. -->
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+
+    <group
+        android:id="@+id/menu_clipboard_group">
+        <item
+            android:id="@+id/dir_menu_cut_to_clipboard"
+            android:title="@string/menu_cut_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_copy_to_clipboard"
+            android:title="@string/menu_copy_to_clipboard" />
+        <item
+            android:id="@+id/dir_menu_compress"
+            android:title="@string/menu_compress" />
+    </group>
+
+    <group
+        android:id="@+id/menu_modifier_group">
+        <item
+            android:id="@+id/dir_menu_delete"
+            android:title="@string/menu_delete" />
+    </group>
+
+    <group
+        android:id="@+id/menu_extras_group">
+        <item
+            android:id="@+id/dir_menu_inspect"
+            android:title="@string/menu_inspect" />
+    </group>
+</menu>
\ No newline at end of file
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml b/res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
new file mode 100644
index 000000000..20b8a6914
--- /dev/null
+++ b/res/flag(com.android.documentsui.flags.use_material3)/menu/root_context_menu.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2024 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<menu xmlns:android="http://schemas.android.com/apk/res/android">
+    <item
+        android:id="@+id/root_menu_eject_root"
+        android:title="@string/menu_eject_root" />
+    <item
+        android:id="@+id/root_menu_open_in_new_window"
+        android:title="@string/menu_open_in_new_window" />
+    <item
+        android:id="@+id/root_menu_paste_into_folder"
+        android:title="@string/menu_paste_into_folder" />
+    <item
+        android:id="@+id/root_menu_settings"
+        android:title="@string/menu_settings" />
+</menu>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
index ab154150b..72dd819bb 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night-v31/colors.xml
@@ -14,7 +14,8 @@
 -->
 
 <resources>
-  <color name="tab_selected_text_color">@android:color/black</color>
+  <!-- ?attr/colorPrimary -->
+  <color name="primary">@android:color/system_accent1_200</color>
   <color name="work_profile_button_stroke_color">
     @*android:color/system_accent1_200
   </color> <!-- accent 200 -->
@@ -24,15 +25,6 @@
   <color name="empty_state_message_text_color">
     @*android:color/system_neutral2_200
   </color>
-  <!-- neutral variant 200 -->
-  <color name="tab_unselected_text_color">@*android:color/system_neutral2_200
-  </color>
-  <!-- neutral variant 200 -->
-  <color name="profile_tab_default_color">@*android:color/system_neutral1_800
-  </color>
-  <!-- neutral 800 -->
-  <color name="profile_tab_selected_color">@*android:color/system_neutral2_100
-  </color>
   <!-- neutral variant 100 -->
   <color name="fragment_pick_inactive_button_color">
     @*android:color/system_neutral1_800
@@ -47,4 +39,24 @@
   </color>
   <!-- neutral variant 100 -->
   <color name="fragment_pick_active_text_color">@android:color/black</color>
+
+  <!-- All drag drop badge colors, we can only use system color tokens because there's no theme
+       context inside the view.
+  -->
+  <!-- ?attr/colorTertiary -->
+  <color name="drag_file_counter_background">@android:color/system_accent3_200</color>
+  <!-- ?attr/colorOnTertiary -->
+  <color name="drag_file_counter_text_color">@android:color/system_accent3_800</color>
+  <!-- ?attr/colorSurfaceDim -->
+  <color name="item_drag_shadow_background">@color/m3_ref_palette_dynamic_neutral_variant6</color>
+  <!-- ?attr/colorSurfaceContainerLowest -->
+  <color name="drag_mime_icon_wrapper_background">
+    @color/m3_ref_palette_dynamic_neutral_variant4
+  </color>
+  <!-- ?attr/colorOnSurface -->
+  <color name="drag_content_text_color">@android:color/system_neutral1_100</color>
+  <!-- ?attr/colorOnError -->
+  <color name="drop_icon_symbol_color">@color/m3_ref_palette_error20</color>
+  <!-- ?attr/colorError -->
+  <color name="drop_icon_reject_container_background">@color/m3_ref_palette_error80</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml
index f9c58172a..b3cd1dae3 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night/colors.xml
@@ -18,7 +18,8 @@
     <color name="background_floating">#3C4043</color>
     <color name="nav_bar_translucent">#52000000</color>
 
-    <color name="primary">#8AB4F8</color>
+    <!-- ?attr/colorPrimary -->
+    <color name="primary">#D0BCFF</color>
     <color name="secondary">#3D8AB4F8</color>
     <color name="hairline">#5F6368</color>
 
@@ -27,15 +28,12 @@
 
     <color name="edge_effect">@android:color/white</color>
 
-    <!-- AppCompat.textColorSecondary -->
-    <color name="doc_list_item_subtitle_enabled">#b3ffffff</color>
-    <color name="doc_list_item_subtitle_disabled">#36ffffff</color>
-
     <color name="list_divider_color">#9aa0a6</color>
-    <color name="list_item_selected_background_color">?android:colorSecondary</color>
+
+    <color name="color_surface_header">@color/m3_ref_palette_dynamic_neutral_variant17</color>
 
     <color name="fragment_pick_active_text_color">#202124</color> <!-- Grey 900 -->
 
-    <!-- TODO(b/379776735): remove this after M3 uplift -->
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
     <color name="search_chip_text_selected_color">@android:color/black</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml
index 12b9577c6..e8e801793 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-night/themes.xml
@@ -22,7 +22,6 @@
 
         <!-- Toolbar -->
         <item name="android:actionModeBackground">?android:attr/colorBackground</item>
-        <item name="android:actionBarSize">@dimen/action_bar_size</item>
 
         <!-- Color section -->
         <item name="android:colorAccent">@color/primary</item>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml
index 44feff32a..27b636fe1 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/colors.xml
@@ -14,11 +14,8 @@
 -->
 
 <resources>
-  <color name="tab_selected_text_color">@*android:color/system_neutral1_900
-  </color>
-  <!-- neutral 900 -->
-  <color name="tab_unselected_text_color">@*android:color/system_neutral2_700
-  </color>
+  <!-- ?attr/colorPrimary -->
+  <color name="primary">@android:color/system_accent1_600</color>
   <!-- neutral variant 700-->
   <color name="work_profile_button_stroke_color">
     @*android:color/system_accent1_600
@@ -29,12 +26,6 @@
   <color name="empty_state_message_text_color">
     @*android:color/system_neutral2_700
   </color>
-  <!-- neutral variant 700 -->
-  <color name="profile_tab_selected_color">@*android:color/system_accent1_100
-  </color>
-  <!-- accent 100 -->
-  <color name="profile_tab_default_color">@*android:color/system_neutral1_10
-  </color>
   <!-- neutral 10 -->
   <color name="fragment_pick_inactive_button_color">
     @*android:color/system_neutral1_100
@@ -48,4 +39,22 @@
   </color>
   <!-- accent 600 -->
   <color name="fragment_pick_active_text_color">@android:color/white</color>
+
+  <!-- All drag drop badge colors, we can only use system color tokens because there's no theme
+       context inside the view.
+  -->
+  <!-- ?attr/colorTertiary -->
+  <color name="drag_file_counter_background">@android:color/system_accent3_600</color>
+  <!-- ?attr/colorOnTertiary -->
+  <color name="drag_file_counter_text_color">@android:color/system_accent3_0</color>
+  <!-- ?attr/colorSurfaceDim -->
+  <color name="item_drag_shadow_background">@color/m3_ref_palette_dynamic_neutral_variant87</color>
+  <!-- ?attr/colorSurfaceContainerLowest -->
+  <color name="drag_mime_icon_wrapper_background">@android:color/system_neutral2_0</color>
+  <!-- ?attr/colorOnSurface -->
+  <color name="drag_content_text_color">@android:color/system_neutral1_900</color>
+  <!-- ?attr/colorOnError -->
+  <color name="drop_icon_symbol_color">@android:color/white</color>
+  <!-- ?attr/colorError -->
+  <color name="drop_icon_reject_container_background">@color/m3_ref_palette_error40</color>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
index 006b99173..07630714f 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/dimens.xml
@@ -18,11 +18,10 @@
     <dimen name="action_bar_margin">0dp</dimen>
     <dimen name="button_corner_radius">20dp</dimen>
     <dimen name="tab_selector_indicator_height">0dp</dimen>
-    <dimen name="tab_height">48dp</dimen>
+    <dimen name="tab_height">36dp</dimen>
     <dimen name="tab_container_height">48dp</dimen>
-    <dimen name="profile_tab_padding">20dp</dimen>
-    <dimen name="profile_tab_margin_top">16dp</dimen>
-    <dimen name="profile_tab_margin_side">4dp</dimen>
+    <dimen name="profile_tab_margin_top">0dp</dimen>
+    <dimen name="profile_tab_margin_side">@dimen/space_extra_small_4</dimen>
     <dimen name="cross_profile_button_corner_radius">30dp</dimen>
     <dimen name="cross_profile_button_stroke_width">1dp</dimen>
     <dimen name="cross_profile_button_message_margin_top">16dp</dimen>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml
index 5be3cd9dc..4f459253a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-v31/styles.xml
@@ -42,11 +42,4 @@
     <item name="android:textAppearance">@style/EmptyStateButtonTextAppearance
     </item>
   </style>
-
-  <style name="DialogTextButton" parent="@style/Widget.Material3.Button.TextButton.Dialog">
-    <item name="android:textAppearance">@style/MaterialButtonTextAppearance
-    </item>
-    <item name="android:textColor">?android:attr/colorAccent</item>
-    <item name="android:backgroundTint">@android:color/transparent</item>
-  </style>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml
index 9884577cf..00c9a662a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/dimens.xml
@@ -13,8 +13,25 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
-
+<!-- Dimensions/sizes for size Medium (>=600dp && <900dp). -->
 <resources>
-    <dimen name="search_chip_group_margin_horizontal">@dimen/space_medium_1</dimen>
-    <dimen name="search_chip_group_margin_vertical">@dimen/space_small_1</dimen>
+    <dimen name="main_container_padding_start">@dimen/space_medium_1</dimen>
+    <dimen name="main_container_padding_end">@dimen/space_medium_1</dimen>
+    <dimen name="main_container_padding_top">@dimen/space_extra_small_4</dimen>
+    <!-- Main margin is set by main_container_padding_start for the menu button, here is for
+    the space between the button the text/title, but since on this layout we don't have the button,
+    we zero here, to avoid pushing the title further. -->
+    <dimen name="search_bar_text_margin_start">0dp</dimen>
+
+    <dimen name="toolbar_padding_start">@dimen/main_container_padding_start</dimen>
+
+    <dimen name="list_container_padding">@dimen/space_extra_small_6</dimen>
+
+    <!-- list_container_padding + list_item_padding_start -->
+    <dimen name="table_header_padding_start">28dp</dimen>
+    <!-- list_container_padding + list_item_padding_end -->
+    <dimen name="table_header_padding_end">20dp</dimen>
+
+    <dimen name="picker_saver_container_padding_bottom">0dp</dimen>
 </resources>
+
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_selector.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml
similarity index 72%
rename from res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_selector.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml
index a163185af..4b0634d54 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/color/profile_tab_selector.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w600dp/layouts.xml
@@ -14,10 +14,7 @@
      limitations under the License.
 -->
 
-<selector xmlns:android="http://schemas.android.com/apk/res/android">
-    <item
-        android:state_selected="true"
-        android:color="@color/profile_tab_selected_color"/>
-    <item
-        android:color="@color/profile_tab_default_color"/>
-</selector>
+<resources>
+    <item name="documents_activity" type="layout">@layout/nav_rail_layout</item>
+    <item name="files_activity" type="layout">@layout/nav_rail_layout</item>
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/colors.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/colors.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/colors.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml
similarity index 55%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/dimens.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml
index a3232c9c2..21ce0acff 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/config.xml
@@ -15,17 +15,8 @@
 -->
 
 <resources>
-    <dimen name="grid_padding_horiz">16dp</dimen>
-    <dimen name="grid_padding_vert">16dp</dimen>
+    <!-- Indicates if search view is taking the whole toolbar space -->
+    <bool name="full_bar_search_view">false</bool>
 
-    <dimen name="list_item_padding">24dp</dimen>
-    <dimen name="list_item_width">80dp</dimen>
-
-    <dimen name="max_drawer_width">320dp</dimen>
-
-    <dimen name="search_bar_background_margin_start">120dp</dimen>
-    <dimen name="search_bar_background_margin_end">120dp</dimen>
-    <dimen name="search_bar_text_margin_start">55dp</dimen>
-    <dimen name="search_bar_text_margin_end">24dp</dimen>
-    <dimen name="search_bar_icon_padding">16dp</dimen>
+    <string name="scrolling_behavior" translatable="false">@string/appbar_scrolling_view_behavior</string>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml
index 30c551c21..24ff2b17b 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/dimens.xml
@@ -13,8 +13,32 @@
      See the License for the specific language governing permissions and
      limitations under the License.
 -->
-
+<!-- Dimensions/sizes for size Expanded (>=900dp). -->
 <resources>
-    <dimen name="search_chip_group_margin_horizontal">@dimen/space_medium_5</dimen>
-    <dimen name="search_chip_group_margin_vertical">@dimen/space_small_1</dimen>
+    <dimen name="grid_padding_horiz">16dp</dimen>
+    <dimen name="grid_padding_vert">16dp</dimen>
+
+    <dimen name="list_item_height">48dp</dimen>
+    <dimen name="list_item_padding_start">20dp</dimen>
+    <dimen name="list_item_padding_end">0dp</dimen>
+    <dimen name="list_item_icon_margin_end">@dimen/space_extra_small_4</dimen>
+
+    <dimen name="max_drawer_width">320dp</dimen>
+
+    <dimen name="search_bar_background_margin_start">120dp</dimen>
+    <dimen name="search_bar_background_margin_end">120dp</dimen>
+    <dimen name="search_bar_text_margin_end">24dp</dimen>
+    <dimen name="search_bar_icon_padding">16dp</dimen>
+
+    <dimen name="main_container_padding_top">@dimen/space_extra_small_6</dimen>
+
+    <dimen name="toolbar_padding_start">@dimen/main_container_padding_start</dimen>
+    <dimen name="toolbar_padding_end">@dimen/space_small_3</dimen>
+
+    <dimen name="drawer_padding_top">@dimen/space_small_1</dimen>
+
+    <!-- list_container_padding + list_item_padding_start -->
+    <dimen name="table_header_padding_start">32dp</dimen>
+    <!-- list_container_padding + list_item_padding_end -->
+    <dimen name="table_header_padding_end">12dp</dimen>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/layouts.xml b/res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/layouts.xml
similarity index 100%
rename from res/flag(com.android.documentsui.flags.use_material3)/values-w720dp/layouts.xml
rename to res/flag(com.android.documentsui.flags.use_material3)/values-w900dp/layouts.xml
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml
index 76bd5dc18..fed5a018a 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/colors.xml
@@ -22,22 +22,38 @@
   <color name="background_floating">@android:color/white</color>
   <color name="nav_bar_translucent">#99FFFFFF</color>
 
-  <color name="primary">#1E88E5</color> <!-- Blue 600 -->
+  <!-- ?attr/colorPrimary -->
+  <color name="primary">#6750A4</color>
   <color name="secondary">#E3F2FD</color> <!-- Blue 50 -->
   <color name="hairline">#E0E0E0</color> <!-- Gray 300 -->
 
-  <!-- TODO(b/379776735): remove this after M3 uplift -->
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
   <color name="chip_background_disable_color">#fff1f3f4</color>
   <color name="menu_search_background">@android:color/transparent</color>
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
   <color name="item_breadcrumb_background_hovered">#1affffff</color>
-  <color name="item_drag_shadow_background">@android:color/white</color>
+
+  <!-- All the colors used inside the drag drop badge don't support Material color attributes
+       because the drag view and shadow are isolated views rendered without theme context, so
+       we need to use static colors for SDK <= 30, and use system color tokens for SDK >= 31.
+       Check the variables with the same name defined in the v31 version of colors.xml.
+  -->
+  <color name="item_drag_shadow_background">#E3D7DD</color>
   <color name="item_drag_shadow_container_background">
     @android:color/transparent
   </color>
+  <color name="drag_file_counter_background">#825344</color>
+  <color name="drag_file_counter_text_color">@android:color/white</color>
+  <color name="drag_mime_icon_wrapper_background">@android:color/white</color>
+  <color name="drag_content_text_color">#201A1E</color>
+  <color name="drop_icon_symbol_color">@android:color/white</color>
+  <color name="drop_icon_copy_container_background">#1EA446</color>
+  <color name="drop_icon_reject_container_background">#BA1A1A</color>
+
   <color name="tool_bar_gradient_max">#7f000000</color>
 
-  <color name="band_select_background">#88ffffff</color>
-  <color name="band_select_border">#44000000</color>
+  <color name="band_select_background">?attr/colorPrimaryInverse</color>
+  <color name="band_select_border">?attr/colorPrimaryContainer</color>
 
   <color name="downloads_icon_background">#ff4688f2</color>
   <color name="app_icon_background">#ff4688f2</color>
@@ -49,26 +65,35 @@
 
   <color name="edge_effect">@android:color/black</color>
 
-  <color name="doc_list_item_subtitle_enabled">#5F6368</color> <!-- Gray 700 -->
-  <color name="doc_list_item_subtitle_disabled">#613c4043
-  </color> <!-- 38% Grey800 -->
-
   <color name="list_divider_color">#1f000000</color>
-  <color name="list_item_selected_background_color">?android:colorSecondary
-  </color>
-  <color name="color_surface_header">@color/app_background_color</color>
+  <color name="list_item_selected_background_color">?attr/colorPrimaryContainer</color>
+  <!-- This is used when the app bar is in pinned mode inside the CollapsingToolbarLayout.
+       The code in NavigationViewManager assume the value should be a plain color value so we can't
+       use the theme attribute "?attr/colorSurfaceContainerHigh" (which is a reference) here, hence
+       using the mapped system color in both here and dark mode.
+  -->
+  <color name="color_surface_header">@color/m3_ref_palette_dynamic_neutral_variant92</color>
 
-  <color name="tab_selected_text_color">@color/primary</color>
   <color name="work_profile_button_stroke_color">@color/primary</color>
-  <color name="profile_tab_selected_color">?android:attr/colorAccent</color>
-  <color name="profile_tab_default_color">#E0E0E0</color>
-  <color name="tab_unselected_text_color">#5F6368</color> <!-- Gray 700 -->
 
   <color name="fragment_pick_inactive_button_color">#E0E0E0</color>
   <color name="fragment_pick_inactive_text_color">#5F6368</color>
   <color name="fragment_pick_active_button_color">@color/primary</color>
   <color name="fragment_pick_active_text_color">@android:color/white</color>
 
-  <!-- TODO(b/379776735): remove this after M3 uplift -->
+  <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
   <color name="search_chip_text_selected_color">@android:color/white</color>
+
+  <!-- Use this when we need to set alpha channel on top of a theme attribute color in the
+       color selector list, e.g. to set colorOnSecondaryContainer with a hover overlay alpha, use:
+
+       <shape android:tint="?attr/colorOnSecondaryContainer">
+          <solid android:color="@color/overlay_hover_color_percentage"/>
+       </shape>
+   -->
+  <color name="overlay_hover_color_percentage">#14000000</color> <!-- 8% -->
+
+  <!-- Peek overlay static color. Makes the background dimmer with an 80% opacity. This color is not
+  intended to be dynamic, and is defined specifically for Peek. -->
+  <color name="peek_overlay_background">#CC000000</color> <!-- 80% -->
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml
index 681de06f4..fa9e436ab 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/dimens.xml
@@ -14,6 +14,7 @@
      limitations under the License.
 -->
 
+<!-- Dimensions/sizes for size Compact (<600dp). -->
 <resources>
     <!-- Material design rounded radius -->
     <dimen name="material_round_radius">2dp</dimen>
@@ -21,60 +22,140 @@
     <dimen name="tab_selector_indicator_height">2dp</dimen>
     <dimen name="profile_tab_padding">0dp</dimen>
     <dimen name="grid_container_padding">20dp</dimen>
-    <dimen name="list_container_padding">20dp</dimen>
+    <dimen name="list_container_padding">@dimen/space_extra_small_4</dimen>
     <dimen name="icon_size">40dp</dimen>
     <dimen name="button_touch_size">48dp</dimen>
     <dimen name="root_icon_size">24dp</dimen>
+    <dimen name="thumbnail_clip_corner_radius">6dp</dimen>
+    <dimen name="thumbnail_border_width">1dp</dimen>
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
     <dimen name="root_icon_margin">0dp</dimen>
     <dimen name="root_spacer_padding">0dp</dimen>
-    <dimen name="root_action_icon_size">18dp</dimen>
+    <!-- block end -->
+    <dimen name="root_action_icon_size">24dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
     <dimen name="root_icon_disabled_alpha">?android:attr/disabledAlpha</dimen>
-    <dimen name="check_icon_size">30dp</dimen>
+    <dimen name="check_icon_size">20dp</dimen>
     <dimen name="zoom_icon_size">24dp</dimen>
     <dimen name="list_item_thumbnail_size">40dp</dimen>
     <dimen name="grid_item_icon_size">30dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
     <dimen name="progress_bar_height">4dp</dimen>
     <fraction name="grid_scale_min">85%</fraction>
     <fraction name="grid_scale_max">200%</fraction>
-    <dimen name="grid_width">152dp</dimen>
+    <dimen name="grid_width">150dp</dimen>
+    <dimen name="grid_height">132dp</dimen>
     <dimen name="grid_section_separator_height">0dp</dimen>
-    <dimen name="grid_item_margin">6dp</dimen>
+    <dimen name="grid_item_margin">@dimen/space_small_1</dimen>
     <dimen name="grid_padding_horiz">4dp</dimen>
     <dimen name="grid_padding_vert">4dp</dimen>
+    <dimen name="list_item_height">56dp</dimen>
+    <dimen name="list_item_padding_start">16dp</dimen>
+    <dimen name="list_item_padding_end">8dp</dimen>
+    <dimen name="list_item_padding_vertical">4dp</dimen>
+    <dimen name="list_item_icon_margin_end">16dp</dimen>
+    <dimen name="list_item_icon_size">32dp</dimen>
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
     <dimen name="list_item_width">72dp</dimen>
-    <dimen name="list_item_height">72dp</dimen>
     <dimen name="list_item_padding">16dp</dimen>
     <dimen name="list_item_icon_padding">16dp</dimen>
-    <dimen name="breadcrumb_item_padding">8dp</dimen>
-    <dimen name="breadcrumb_item_height">36dp</dimen>
     <dimen name="list_divider_inset">72dp</dimen>
+    <!-- block end -->
+    <dimen name="breadcrumb_padding_horizontal">@dimen/space_small_3</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
+    <dimen name="breadcrumb_item_padding">8dp</dimen>
+    <dimen name="breadcrumb_item_padding_horizontal">12dp</dimen>
+    <dimen name="breadcrumb_item_padding_vertical">6dp</dimen>
+    <dimen name="breadcrumb_item_arrow_padding">@dimen/space_extra_small_2</dimen>
+    <dimen name="breadcrumb_item_height">32dp</dimen>
+    <dimen name="breadcrumb_height">48dp</dimen>
+    <dimen name="breadcrumb_item_arrow_size">16dp</dimen>
     <dimen name="dir_elevation">8dp</dimen>
     <dimen name="drag_shadow_size">120dp</dimen>
+    <dimen name="grid_item_padding_start">@dimen/space_extra_small_2</dimen>
+    <dimen name="grid_item_padding_end">@dimen/space_extra_small_2</dimen>
+    <dimen name="grid_item_padding_top">@dimen/space_extra_small_2</dimen>
+    <dimen name="grid_item_thumbnail_width">80dp</dimen>
+    <dimen name="grid_item_thumbnail_height">80dp</dimen>
+    <dimen name="grid_item_thumbnail_radius">12dp</dimen>
+    <dimen name="grid_item_icon_width">64dp</dimen>
+    <dimen name="grid_item_icon_height">64dp</dimen>
+    <dimen name="grid_item_nameplate_width">142dp</dimen>
+    <dimen name="grid_item_nameplate_height">44dp</dimen>
+    <dimen name="grid_item_nameplate_padding">4dp</dimen>
+    <dimen name="grid_item_nameplate_marginTop">@dimen/space_extra_small_2</dimen>
+    <dimen name="grid_item_nameplate_radius">8dp</dimen>
+    <dimen name="grid_item_nameplate_inner_radius">4dp</dimen>
     <dimen name="grid_item_elevation">2dp</dimen>
-    <dimen name="grid_item_radius">2dp</dimen>
+    <dimen name="grid_item_radius">12dp</dimen>
     <dimen name="max_drawer_width">280dp</dimen>
     <dimen name="briefcase_icon_margin">8dp</dimen>
     <dimen name="briefcase_icon_size">14dp</dimen>
     <dimen name="briefcase_icon_size_photo">24dp</dimen>
     <dimen name="button_corner_radius">2dp</dimen>
 
-    <dimen name="drawer_edge_width">12dp</dimen>
+    <!-- list_container_padding + list_item_padding_start -->
+    <dimen name="table_header_padding_start">24dp</dimen>
+    <!-- list_container_padding + list_item_padding_end -->
+    <dimen name="table_header_padding_end">16dp</dimen>
+
+    <dimen name="bottom_sheet_dialog_radius">28dp</dimen>
 
-    <dimen name="drag_shadow_width">176dp</dimen>
-    <dimen name="drag_shadow_height">64dp</dimen>
-    <dimen name="drag_shadow_radius">4dp</dimen>
+    <dimen name="drawer_edge_width">12dp</dimen>
+    <dimen name="drawer_padding_horizontal">@dimen/space_extra_small_6</dimen>
+    <dimen name="drawer_padding_top">@dimen/space_small_3</dimen>
+    <dimen name="drawer_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="drawer_divider_padding_horizontal">16dp</dimen>
+    <dimen name="drawer_divider_padding_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="drawer_item_height">56dp</dimen>
+    <dimen name="drawer_item_vertical_margin">10dp</dimen>
+    <dimen name="drawer_item_text_margin_start">12dp</dimen>
+    <dimen name="drawer_item_action_icon_margin_start">4dp</dimen>
+
+    <dimen name="nav_rail_item_height">64dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_radius">16dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_width">56dp</dimen>
+    <dimen name="nav_rail_item_icon_bg_height">32dp</dimen>
+    <dimen name="nav_rail_burger_icon_size">56dp</dimen>
+
+    <dimen name="drag_content_width">160dp</dimen>
+    <dimen name="drag_content_height">40dp</dimen>
+    <!-- drag_additional_layer_offset + drag_shadow_radius -->
+    <dimen name="drag_content_margin_start">7dp</dimen>
+    <dimen name="drag_content_radius">12dp</dimen>
+    <dimen name="drag_additional_layer_offset">4dp</dimen>
+    <!-- drag_additional_layer_offset + drag_file_counter_offset -->
+    <dimen name="drag_additional_layer_margin_top">12dp</dimen>
+    <dimen name="drag_file_counter_offset">8dp</dimen>
+    <dimen name="drag_file_counter_height">20dp</dimen>
+    <!-- drag shadow width/height need to cater all the elements drawing inside it, including
+         drag content, offset, shadow and drag file counter, so:
+         * width = drag_content_width + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
+         * width = drag_content_height + drag_file_counter_offset + drag_additional_layer_offset + drag_shadow_radius
+     -->
+    <dimen name="drag_shadow_width">175dp</dimen>
+    <dimen name="drag_shadow_height">55dp</dimen>
+    <dimen name="drag_shadow_radius">3dp</dimen>
+    <dimen name="drag_shadow_2_radius">2dp</dimen>
+    <dimen name="drag_shadow_y_offset">1dp</dimen>
+    <!-- TODO(b/379776735): remove this after use_material3 flag is launched. -->
     <dimen name="drag_shadow_padding">8dp</dimen>
 
-    <dimen name="doc_header_sort_icon_size">16dp</dimen>
-    <dimen name="doc_header_height">60dp</dimen>
+    <dimen name="drop_mime_icon_wrapper_size">24dp</dimen>
+    <dimen name="drop_mime_icon_wrapper_radius">4dp</dimen>
+    <dimen name="drop_icon_height">14dp</dimen>
+    <dimen name="drop_icon_width">14dp</dimen>
+    <dimen name="drop_icon_offset">3dp</dimen>
+    <!-- drag_mime_icon_wrapper_size + drop_icon_offset -->
+    <dimen name="drop_badge_container_size">27dp</dimen>
+
+    <dimen name="doc_header_sort_icon_size">32dp</dimen>
+    <dimen name="doc_header_height">48dp</dimen>
 
     <dimen name="dropdown_sort_widget_margin">12dp</dimen>
     <dimen name="dropdown_sort_widget_size">54dp</dimen>
     <dimen name="dropdown_sort_text_size">18sp</dimen>
 
-    <dimen name="drop_icon_height">14dp</dimen>
-    <dimen name="drop_icon_width">14dp</dimen>
-
     <dimen name="header_message_horizontal_padding">8dp</dimen>
 
     <dimen name="fastscroll_default_thickness">8dp</dimen>
@@ -92,15 +173,30 @@
     <dimen name="root_info_header_height">60dp</dimen>
     <dimen name="root_info_header_horizontal_padding">24dp</dimen>
 
-    <!-- TODO(b/379776735): remove this block after M3 uplift -->
+    <!-- TODO(b/379776735): remove this block after use_material3 flag is launched. -->
     <dimen name="search_chip_group_margin">20dp</dimen>
     <dimen name="search_chip_spacing">8dp</dimen>
     <dimen name="search_chip_half_spacing">4dp</dimen>
     <dimen name="search_chip_icon_padding">4dp</dimen>
     <!-- block end -->
+
     <dimen name="search_chip_radius">8dp</dimen>
-    <dimen name="search_chip_group_margin_horizontal">@dimen/space_small_4</dimen>
-    <dimen name="search_chip_group_margin_vertical">@dimen/space_small_1</dimen>
+    <dimen name="search_chip_group_padding_vertical">@dimen/space_extra_small_4</dimen>
+    <dimen name="search_chip_inactive_stroke_width">1dp</dimen>
+    <dimen name="main_container_padding_start">@dimen/space_small_4</dimen>
+    <dimen name="main_container_padding_end">@dimen/space_small_4</dimen>
+    <dimen name="main_container_padding_top">0dp</dimen>
+    <dimen name="main_container_section_gap">2dp</dimen>
+    <dimen name="main_container_corner_radius_large">16dp</dimen>
+    <dimen name="main_container_corner_radius_small">4dp</dimen>
+    <dimen name="picker_saver_padding_top">@dimen/space_extra_small_1</dimen>
+    <dimen name="picker_saver_padding_bottom">@dimen/space_extra_small_1</dimen>
+    <dimen name="picker_saver_button_gap">@dimen/space_extra_small_2</dimen>
+    <dimen name="picker_saver_container_padding_top">@dimen/space_small_1</dimen>
+    <dimen name="picker_saver_container_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="layout_padding_top">@dimen/space_small_1</dimen>
+    <dimen name="layout_padding_bottom">@dimen/space_small_1</dimen>
+    <dimen name="layout_padding_end">@dimen/space_small_1</dimen>
 
     <dimen name="dialog_content_padding_top">18dp</dimen>
     <dimen name="dialog_content_padding_bottom">24dp</dimen>
@@ -118,16 +214,26 @@
     <dimen name="apps_row_exit_icon_margin_bottom">6dp</dimen>
     <dimen name="apps_row_item_text_margin_horizontal">8dp</dimen>
 
-    <dimen name="search_bar_elevation">3dp</dimen>
+    <dimen name="profile_tab_radius">12dp</dimen>
+
+    <dimen name="search_bar_elevation">0dp</dimen>
     <dimen name="search_bar_radius">8dp</dimen>
     <dimen name="search_bar_background_margin_start">0dp</dimen>
     <dimen name="search_bar_background_margin_end">0dp</dimen>
-    <dimen name="search_bar_margin">@dimen/space_extra_small_6</dimen>
+    <dimen name="search_bar_margin">0dp</dimen>
     <dimen name="search_bar_text_size">16dp</dimen>
 
-    <dimen name="action_bar_elevation">3dp</dimen>
-    <dimen name="action_bar_margin">1dp</dimen>
-    <dimen name="action_bar_size">48dp</dimen>
+    <!-- Main margin is set by main_container_padding_start for the menu button, here is for
+    the space between the button the text/title. -->
+    <dimen name="search_bar_text_margin_start">@dimen/space_extra_small_6</dimen>
+    <dimen name="job_progress_toolbar_indicator_size">24dp</dimen>
+    <!-- The main margin is controlled above on paddingStart, zeroing toolbar_content_insets to
+         avoid pushing the title or button further. -->
+    <dimen name="toolbar_content_inset_start">0dp</dimen>
+    <dimen name="toolbar_padding_start">@dimen/space_extra_small_6</dimen>
+    <dimen name="toolbar_padding_end">@dimen/space_extra_small_6</dimen>
+    <dimen name="action_bar_elevation">0dp</dimen>
+    <dimen name="action_bar_margin">0dp</dimen>
     <dimen name="action_mode_text_size">18sp</dimen>
 
     <dimen name="refresh_icon_range">64dp</dimen>
@@ -138,4 +244,12 @@
     <dimen name="cross_profile_button_message_margin_top">4dp</dimen>
 
     <dimen name="focus_ring_width">3dp</dimen>
+    <!-- 3dp focus ring width + 2dp gap between the ring and the content -->
+    <dimen name="focus_ring_gap">5dp</dimen>
+    <dimen name="hover_overlay_alpha">0.08</dimen>
+    <dimen name="ripple_overlay_alpha">0.10</dimen>
+
+    <dimen name="job_progress_panel_width">360dp</dimen>
+    <dimen name="job_progress_panel_margin">@dimen/space_small_1</dimen>
+    <dimen name="job_progress_panel_header_margin">@dimen/space_small_1</dimen>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml
index 8aba2dfa3..481cd0be8 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/styles.xml
@@ -29,9 +29,26 @@
     <!-- This gets overridden for specific platform versions and/or configs -->
     <style name="ActionBarTheme" parent="@style/ActionBarThemeCommon"/>
 
+    <style name="HamburgerMenuButtonStyle" parent="@style/Widget.Material3.Search.Toolbar.Button.Navigation">
+        <item name="android:maxWidth">@dimen/icon_size_headline_large</item>
+        <item name="android:maxHeight">@dimen/icon_size_headline_large</item>
+    </style>
+
+    <style name="JobProgressToolbarIndicatorStyle" parent="@style/Widget.Material3.CircularProgressIndicator.ExtraSmall">
+        <item name="indicatorSize">@dimen/job_progress_toolbar_indicator_size</item>
+        <item name="indicatorInset">@dimen/space_extra_small_6</item>
+    </style>
+
+    <style name="ToolbarStyles" parent="@style/Widget.Material3.Toolbar">
+        <item name="android:paddingStart">@dimen/toolbar_padding_start</item>
+        <item name="android:paddingEnd">@dimen/toolbar_padding_end</item>
+        <item name="contentInsetStart">@dimen/toolbar_content_inset_start</item>
+        <item name="contentInsetStartWithNavigation">@dimen/toolbar_content_inset_start</item>
+        <item name="titleMarginStart">@dimen/search_bar_text_margin_start</item>
+        <item name="titleTextAppearance">@style/ToolbarTitle</item>
+    </style>
+
     <style name="ActionModeStyle" parent="Widget.AppCompat.ActionMode">
-        <!-- attr "height" was used by support lib should not in overlay scope -->
-        <item name="height">@dimen/action_bar_size</item>
         <item name="titleTextStyle">@style/ActionModeTitle</item>
         <item name="android:layout_margin">@dimen/search_bar_margin</item>
     </style>
@@ -43,12 +60,6 @@
         <item name="cardElevation">@dimen/grid_item_elevation</item>
     </style>
 
-    <style name="TrimmedHorizontalProgressBar" parent="android:Widget.Material.ProgressBar.Horizontal">
-        <item name="android:indeterminateDrawable">@drawable/progress_indeterminate_horizontal_material_trimmed</item>
-        <item name="android:minHeight">3dp</item>
-        <item name="android:maxHeight">3dp</item>
-    </style>
-
     <style name="SnackbarButtonStyle" parent="@style/Widget.AppCompat.Button.Borderless">
         <item name="android:textColor">?android:colorPrimary</item>
     </style>
@@ -68,20 +79,15 @@
         <item name="android:background">@drawable/bottom_sheet_dialog_background</item>
     </style>
 
-    <style name="OverflowButtonStyle" parent="@style/Widget.AppCompat.ActionButton.Overflow">
-        <item name="android:tint">?android:colorControlNormal</item>
+    <style name="OverflowButtonStyle" parent="@style/Widget.Material3.Search.ActionButton.Overflow">
         <item name="android:minWidth">@dimen/button_touch_size</item>
     </style>
 
-    <style name="OverflowMenuStyle" parent="@style/Widget.AppCompat.PopupMenu.Overflow">
-        <item name="android:popupBackground">@drawable/menu_dropdown_panel</item>
-        <item name="android:dropDownWidth">wrap_content</item>
+    <style name="OverflowMenuStyle" parent="@style/Widget.Material3.PopupMenu.Overflow">
         <item name="android:overlapAnchor">false</item>
     </style>
 
     <style name="MaterialAlertDialogTitleStyle" parent="@style/MaterialAlertDialog.Material3.Title.Text.CenterStacked">
-        <item name="android:textColor">?attr/colorOnSurface</item>
-        <item name="android:textSize">20sp</item>
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
@@ -89,13 +95,16 @@
         <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
     </style>
 
+    <style name="MaterialTonalButton" parent="@style/Widget.Material3.Button.TonalButton">
+        <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
+    </style>
+
     <style name="MaterialOutlinedButton" parent="@style/Widget.Material3.Button.OutlinedButton">
         <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
     </style>
 
     <style name="DialogTextButton" parent="@style/Widget.Material3.Button.TextButton.Dialog">
         <item name="android:textAppearance">@style/MaterialButtonTextAppearance</item>
-        <item name="android:textColor">?android:attr/colorAccent</item>
     </style>
 
     <style name="EmptyStateButton" parent="@style/Widget.Material3.Button.TextButton">
@@ -107,14 +116,7 @@
         <item name="buttonBarNegativeButtonStyle">@style/DialogTextButton</item>
     </style>
 
-    <style name="MaterialAlertDialogStyle" parent="@style/MaterialAlertDialog.Material3">
-        <item name="backgroundInsetTop">12dp</item>
-        <item name="backgroundInsetBottom">12dp</item>
-    </style>
-
     <style name="MaterialAlertDialogTheme" parent="@style/ThemeOverlay.Material3.MaterialAlertDialog.Centered">
-        <item name="android:dialogCornerRadius">@dimen/grid_item_radius</item>
-        <item name="alertDialogStyle">@style/MaterialAlertDialogStyle</item>
         <item name="buttonBarPositiveButtonStyle">@style/DialogTextButton</item>
         <item name="buttonBarNegativeButtonStyle">@style/DialogTextButton</item>
         <item name="materialAlertDialogTitleTextStyle">@style/MaterialAlertDialogTitleStyle</item>
@@ -126,4 +128,73 @@
         <item name="chipStrokeColor">@color/search_chip_stroke_color</item>
         <item name="chipCornerRadius">@dimen/search_chip_radius</item>
     </style>
+
+    <style name="DrawerStyle" parent="">
+        <item name="android:background">?attr/colorSurfaceContainer</item>
+        <!-- Use padding together with the "outsideOverlay" scrollbar style to to make sure the
+            scrollbar appears on the edge of the container, and scrollbar trigger area doesn't
+            affect the hover effect of the views (e.g. action icon) on the edge.
+         -->
+        <item name="android:paddingHorizontal">@dimen/drawer_padding_horizontal</item>
+        <item name="android:paddingTop">@dimen/drawer_padding_top</item>
+        <item name="android:paddingBottom">@dimen/drawer_padding_bottom</item>
+        <item name="android:dividerHeight">@dimen/drawer_item_vertical_margin</item>
+        <item name="android:scrollbarStyle">outsideOverlay</item>
+        <item name="android:clipToPadding">false</item>
+    </style>
+
+    <style name="DrawerItemStyle" parent="">
+        <item name="android:paddingStart">16dp</item>
+        <item name="android:paddingEnd">4dp</item>
+        <item name="android:background">@drawable/root_item_background</item>
+    </style>
+
+    <style name="DrawerItemActionIconStyle" parent="@style/Widget.Material3.Button.IconButton">
+        <item name="android:layout_marginStart">@dimen/drawer_item_action_icon_margin_start</item>
+        <item name="strokeColor">?attr/colorSecondary</item>
+    </style>
+
+    <style name="ProfileTabStyle" parent="@style/Widget.Material3.TabLayout">
+        <!-- Use transparent bg color to hide the underline for tab layout. -->
+        <item name="android:background">@android:color/transparent</item>
+        <item name="tabIndicatorColor">?attr/colorPrimary</item>
+        <item name="tabIndicatorHeight">@dimen/tab_selector_indicator_height</item>
+        <item name="tabTextColor">?attr/colorOnSurfaceVariant</item>
+        <item name="tabSelectedTextColor">?attr/colorOnPrimaryContainer</item>
+        <item name="tabTextAppearance">@style/TabTextAppearance</item>
+    </style>
+
+    <style name="FileItemLabelStyle" parent="">
+        <item name="android:ellipsize">end</item>
+        <item name="android:minWidth">70dp</item>
+        <item name="android:singleLine">true</item>
+        <item name="android:textAppearance">@style/FileItemLabelText</item>
+    </style>
+
+    <style name="NavRailStyle" parent="">
+        <item name="android:background">?attr/colorSurfaceContainer</item>
+        <item name="android:paddingHorizontal">@dimen/space_small_3</item>
+        <item name="android:paddingTop">@dimen/space_extra_small_6</item>
+        <item name="android:paddingBottom">@dimen/space_small_1</item>
+        <item name="android:scrollbarStyle">outsideOverlay</item>
+        <item name="android:clipToPadding">false</item>
+    </style>
+
+    <style name="NavRailItemStyle" parent="">
+        <item name="android:background">@drawable/nav_rail_item_background</item>
+        <item name="android:paddingVertical">6dp</item>
+    </style>
+
+    <style name="NavRailItemTextStyle" parent="">
+        <item name="android:layout_marginTop">4dp</item>
+        <item name="android:textColor">@color/nav_rail_item_text_color</item>
+        <item name="android:textAppearance">@style/NavRailItemTextAppearance</item>
+    </style>
+
+    <style name="JobProgressPanelStyle" parent="@style/Widget.Material3.CardView.Elevated">
+        <item name="android:layout_marginStart">@dimen/job_progress_panel_margin</item>
+        <item name="android:layout_marginBottom">@dimen/job_progress_panel_margin</item>
+        <item name="cardElevation">1dp</item>
+        <item name="cardBackgroundColor">?attr/colorSurfaceDim</item>
+    </style>
 </resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml
index c8cf16cbf..57dbb1212 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/styles_text.xml
@@ -70,11 +70,6 @@
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="DrawerMenuTitle" parent="@style/TextAppearance.Material3.TitleLarge">
-        <item name="android:textSize">24sp</item>
-        <item name="fontFamily">@string/config_fontFamilyMedium</item>
-    </style>
-
     <style name="DrawerMenuHeader" parent="@style/TextAppearance.Material3.BodyLarge">
         <item name="android:textColor">?android:attr/textColorSecondary</item>
         <item name="android:textAllCaps">true</item>
@@ -82,14 +77,12 @@
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="DrawerMenuPrimary" parent="@style/TextAppearance.Material3.BodyMedium">
-        <item name="android:textSize">14sp</item>
+    <style name="DrawerMenuPrimary" parent="@style/TextAppearance.Material3.LabelLarge">
         <item name="android:textColor">@color/item_root_primary_text</item>
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="DrawerMenuSecondary" parent="@style/TextAppearance.Material3.BodyMedium">
-        <item name="android:textSize">12sp</item>
+    <style name="DrawerMenuSecondary" parent="@style/TextAppearance.Material3.BodySmall">
         <item name="android:textColor">@color/item_root_secondary_text</item>
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
@@ -103,9 +96,8 @@
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="BreadcrumbText" parent="@style/TextAppearance.Widget.AppCompat.Toolbar.Subtitle">
+    <style name="BreadcrumbText" parent="@style/TextAppearance.Material3.TitleSmall">
         <item name="android:textColor">@color/horizontal_breadcrumb_color</item>
-        <item name="android:textSize">14sp</item>
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
@@ -126,18 +118,22 @@
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="TabTextAppearance" parent="@style/TextAppearance.Material3.TitleMedium">
-        <item name="android:textSize">14sp</item>
+    <style name="TabTextAppearance" parent="@style/TextAppearance.Material3.TitleSmall">
         <item name="fontFamily">@string/config_fontFamilyMedium</item>
     </style>
 
-    <style name="ItemCaptionText" parent="@style/TextAppearance.Material3.BodySmall">
+    <style name="FileItemLabelText" parent="@style/TextAppearance.Material3.TitleSmall">
+        <item name="android:textColor">@color/doc_list_item_label_color</item>
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="ItemCaptionText" parent="@style/TextAppearance.Material3.LabelSmall">
         <item name="android:textColor">@color/doc_list_item_subtitle_color</item>
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
 
-    <style name="MenuItemTextAppearance" parent="@style/TextAppearance.Material3.BodyMedium">
-        <item name="android:textSize">14sp</item>
+    <style name="MenuItemTextAppearance" parent="@style/TextAppearance.Material3.LabelLarge">
+        <item name="android:textColor">?attr/colorOnSurface</item>
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
 
@@ -145,8 +141,26 @@
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
 
-    <style name="Body1" parent="@style/TextAppearance.Material3.BodyMedium">
+    <style name="NavRailItemTextAppearance" parent="@style/TextAppearance.Material3.LabelMedium">
         <item name="fontFamily">@string/config_fontFamily</item>
     </style>
 
-</resources>
\ No newline at end of file
+    <style name="ListTableHeaderText" parent="@style/TextAppearance.Material3.TitleSmall.Emphasized">
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="DragBadgeText" parent="@style/TextAppearance.Material3.TitleSmall">
+        <item name="android:textColor">@color/drag_content_text_color</item>
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="DragCounterText" parent="@style/TextAppearance.Material3.LabelMedium">
+        <item name="android:textColor">@color/drag_file_counter_text_color</item>
+        <item name="fontFamily">@string/config_fontFamily</item>
+    </style>
+
+    <style name="JobProgressPanelHeaderText" parent="@style/TextAppearance.Material3.TitleMedium">
+        <item name="fontFamily">@string/config_fontFamilyMedium</item>
+    </style>
+
+</resources>
diff --git a/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml b/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml
index 8f145fd38..114d14c88 100644
--- a/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml
+++ b/res/flag(com.android.documentsui.flags.use_material3)/values/themes.xml
@@ -21,7 +21,6 @@
     <!-- DocumentsTheme is allow customize by run time overlay -->
     <style name="DocumentsTheme" parent="@android:style/Theme.DeviceDefault.DocumentsUI">
 
-        <item name="android:actionBarSize">@dimen/action_bar_size</item>
         <item name="android:actionModeBackground">?android:attr/colorBackground</item>
 
         <!-- Color section -->
@@ -62,22 +61,27 @@
         <item name="gridItemTint">@color/item_doc_grid_tint</item>
 
         <item name="actionBarTheme">@style/ActionBarTheme</item>
+        <item name="toolbarStyle">@style/ToolbarStyles</item>
+        <item name="toolbarNavigationButtonStyle">@style/HamburgerMenuButtonStyle</item>
         <item name="actionModeStyle">@style/ActionModeStyle</item>
         <item name="actionOverflowButtonStyle">@style/OverflowButtonStyle</item>
-        <item name="actionOverflowMenuStyle">@style/OverflowMenuStyle</item>
         <item name="alertDialogTheme">@style/AlertDialogTheme</item>
         <item name="autoCompleteTextViewStyle">@style/AutoCompleteTextViewStyle</item>
         <item name="bottomSheetDialogTheme">@style/BottomSheetDialogStyle</item>
-        <item name="materialButtonStyle">@style/MaterialButton</item>
-        <item name="materialButtonOutlinedStyle">@style/MaterialOutlinedButton</item>
         <item name="materialCardViewStyle">@style/CardViewStyle</item>
         <item name="materialAlertDialogTheme">@style/MaterialAlertDialogTheme</item>
         <item name="queryBackground">@color/menu_search_background</item>
         <item name="snackbarButtonStyle">@style/SnackbarButtonStyle</item>
+
+        <!-- Menus -->
+        <item name="actionOverflowMenuStyle">@style/OverflowMenuStyle</item>
+        <item name="android:itemBackground">@drawable/menu_item_background</item>
+
+        <!-- Menu text appearance -->
         <item name="android:itemTextAppearance">@style/MenuItemTextAppearance</item>
-    </style>
 
-    <style name="TabTheme" parent="@android:style/Theme.DeviceDefault.DayNight">
-        <item name="colorPrimary">@color/edge_effect</item>
+        <!-- System bar colors. -->
+        <item name="android:statusBarColor">?attr/colorSurfaceContainer</item>
+        <item name="android:navigationBarColor">?attr/colorSurfaceContainer</item>
     </style>
 </resources>
diff --git a/res/values-af/strings.xml b/res/values-af/strings.xml
index 74f2c90eb..f3dc33788 100644
--- a/res/values-af/strings.xml
+++ b/res/values-af/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Skuif na "</string>
     <string name="menu_compress" msgid="37539111904724188">"Pers saam"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Onttrek na "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Uittreksel van alles"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Onttrek hier"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Blaai"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Hernoem"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Kry inligting"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Wys versteekte lers"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Jy kan nie lers uit \'n ander app skuif nie."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Wys tans in roostermodus."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Wys tans in lysmodus."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Lernaam"</string>
 </resources>
diff --git a/res/values-am/strings.xml b/res/values-am/strings.xml
index 428783c41..4267bd1de 100644
--- a/res/values-am/strings.xml
+++ b/res/values-am/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"    "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ar/strings.xml b/res/values-ar/strings.xml
index 84917168f..6b193c223 100644
--- a/res/values-ar/strings.xml
+++ b/res/values-ar/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -377,4 +380,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-as/strings.xml b/res/values-as/strings.xml
index 285cd0bfe..1d830ebad 100644
--- a/res/values-as/strings.xml
+++ b/res/values-as/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"  "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">"  "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">"  "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"   "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"        "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-az/strings.xml b/res/values-az/strings.xml
index dfba630de..789d477c1 100644
--- a/res/values-az/strings.xml
+++ b/res/values-az/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Dayn..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Sxdrn"</string>
     <string name="menu_extract" msgid="8171946945982532262">"xarn"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Hamsn xarn"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Buraya xarn"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Axtarn"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Adn dyidirin"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Mlumat ld edin"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Gizli fayllar gstrin"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Baqa ttbiqdn fayllar kr bilmzsiniz."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Tor rejimind gstrilir."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Siyah rejimind gstrilir."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Fayl ad"</string>
 </resources>
diff --git a/res/values-b+sr+Latn/strings.xml b/res/values-b+sr+Latn/strings.xml
index fca11a776..af9c3d506 100644
--- a/res/values-b+sr+Latn/strings.xml
+++ b/res/values-b+sr+Latn/strings.xml
@@ -18,7 +18,7 @@
     xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
     <string name="missing_rename_error" msgid="9098952207447981103">"Morate da preimenujete ovo"</string>
     <string name="add_folder_name_error" msgid="6014615052491406810">"Morate da dodate naziv foldera"</string>
-    <string name="files_label" msgid="771781190045103748">"Datoteke"</string>
+    <string name="files_label" msgid="771781190045103748">"Fajlovi"</string>
     <string name="downloads_label" msgid="5462789470049501103">"Preuzimanja"</string>
     <!-- no translation found for app_label (8089292432455111409) -->
     <skip />
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Premesti u"</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimuj"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Izdvoj u"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Izdvoji sve"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Izdvoj ovde"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Pregledaj"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Preimenuj"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Prikai informacije"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Prikazuj skrivene datoteke"</string>
@@ -271,7 +274,7 @@
       <item quantity="other">Izabrano je <xliff:g id="COUNT_1">%1$d</xliff:g> stavki</item>
     </plurals>
     <string name="root_info_header_recent" msgid="5654901877295332262">"Nedavne datoteke"</string>
-    <string name="root_info_header_global_search" msgid="4904078222280496152">"Datoteke"</string>
+    <string name="root_info_header_global_search" msgid="4904078222280496152">"Fajlovi"</string>
     <string name="root_info_header_downloads" msgid="8848161246921154115">"Datoteke u Preuzimanjima"</string>
     <string name="root_info_header_storage" msgid="2989014130584927442">"Datoteke na ureaju <xliff:g id="DEVICE">%1$s</xliff:g>"</string>
     <string name="root_info_header_folder" msgid="5851172222368049864">"Datoteke u folderu <xliff:g id="FOLDER">%1$s</xliff:g>"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Ne moete da premetate datoteke iz druge aplikacije."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Prikazuje se u reimu mree."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazuje se u reimu liste."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Naziv fajla"</string>
 </resources>
diff --git a/res/values-be/strings.xml b/res/values-be/strings.xml
index 4c2a98cec..b20f4ec6b 100644
--- a/res/values-be/strings.xml
+++ b/res/values-be/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-bg/strings.xml b/res/values-bg/strings.xml
index e1444b40b..eb6c137dc 100644
--- a/res/values-bg/strings.xml
+++ b/res/values-bg/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" /"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"   "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
 </resources>
diff --git a/res/values-bn/strings.xml b/res/values-bn/strings.xml
index f51afc50f..5815a476c 100644
--- a/res/values-bn/strings.xml
+++ b/res/values-bn/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-bs/strings.xml b/res/values-bs/strings.xml
index bb5627dbe..73a4b502a 100644
--- a/res/values-bs/strings.xml
+++ b/res/values-bs/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Premjesti u"</string>
     <string name="menu_compress" msgid="37539111904724188">"Kompresiraj"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Izdvoji u"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Izdvajanje svega"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Izdvoji ovdje"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Pregledaj"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Promijeni naziv"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Prikai informacije"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Prikai skrivene fajlove"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Ne moete premjestiti fajlove iz druge aplikacije."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Prikazivanje u vidu mree."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazivanje u vidu liste."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Naziv fajla"</string>
 </resources>
diff --git a/res/values-ca/strings.xml b/res/values-ca/strings.xml
index 76d717243..f78ec3811 100644
--- a/res/values-ca/strings.xml
+++ b/res/values-ca/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mou a"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimeix"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extreu a"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extreu-ho tot"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extreu aqu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Navega"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Canvia el nom"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obtn informaci"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostra els fitxers amagats"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No pots moure fitxers des d\'una altra aplicaci."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Es mostra en mode de quadrcula."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Es mostra en mode de llista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nom del fitxer"</string>
 </resources>
diff --git a/res/values-cs/strings.xml b/res/values-cs/strings.xml
index 44ee41907..28b167244 100644
--- a/res/values-cs/strings.xml
+++ b/res/values-cs/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Pesunout do"</string>
     <string name="menu_compress" msgid="37539111904724188">"Zkomprimovat"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Rozbalit do"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrahovat ve"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrahovat sem"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Prochzet"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Pejmenovat"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Zobrazit informace"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Zobrazit skryt soubory"</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nen mon pesouvat soubory zjin aplikace."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Zobrazuje se mka spolokami."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Zobrazuje se seznam poloek."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nzev souboru"</string>
 </resources>
diff --git a/res/values-da/strings.xml b/res/values-da/strings.xml
index c0d5cf0c8..bfc2386f2 100644
--- a/res/values-da/strings.xml
+++ b/res/values-da/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Flyt til"</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimer"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Pak ud i"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Pak alle ud"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Udtrk herfra"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Gennemse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Omdb"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"F oplysninger"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Vis skjulte filer"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Du kan ikke flytte filer fra en anden app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Vises i gittervisning."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Vises i listevisning."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Filnavn"</string>
 </resources>
diff --git a/res/values-de/strings.xml b/res/values-de/strings.xml
index 381f3b696..ee5604973 100644
--- a/res/values-de/strings.xml
+++ b/res/values-de/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Verschieben nach"</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimieren"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrahieren nach"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Alle extrahieren"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Hier extrahieren"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Durchsuchen"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Umbenennen"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Weitere Informationen"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Ausgeblendete Dateien anzeigen"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Du kannst keine Dateien aus einer anderen App verschieben."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Wird im Rastermodus angezeigt."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Wird im Listenmodus angezeigt."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Dateiname"</string>
 </resources>
diff --git a/res/values-el/strings.xml b/res/values-el/strings.xml
index 9233d5d20..7b403cbe4 100644
--- a/res/values-el/strings.xml
+++ b/res/values-el/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"        ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-en-rAU/strings.xml b/res/values-en-rAU/strings.xml
index 5523ed3f1..f35f46c0c 100644
--- a/res/values-en-rAU/strings.xml
+++ b/res/values-en-rAU/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Move to"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compress"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extract to"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extract all"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extract here"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Browse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Rename"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Get info"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Show hidden files"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"You cant move files from another app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Showing in grid mode."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
 </resources>
diff --git a/res/values-en-rCA/strings.xml b/res/values-en-rCA/strings.xml
index 0dcc1f5c1..adfdf6111 100644
--- a/res/values-en-rCA/strings.xml
+++ b/res/values-en-rCA/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Move to"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compress"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extract to"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extract all"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extract here"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Browse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Rename"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Get info"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Show hidden files"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"You cant move files from another app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Showing in grid mode."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
 </resources>
diff --git a/res/values-en-rGB/strings.xml b/res/values-en-rGB/strings.xml
index 5523ed3f1..f35f46c0c 100644
--- a/res/values-en-rGB/strings.xml
+++ b/res/values-en-rGB/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Move to"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compress"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extract to"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extract all"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extract here"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Browse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Rename"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Get info"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Show hidden files"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"You cant move files from another app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Showing in grid mode."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
 </resources>
diff --git a/res/values-en-rIN/strings.xml b/res/values-en-rIN/strings.xml
index 5523ed3f1..f35f46c0c 100644
--- a/res/values-en-rIN/strings.xml
+++ b/res/values-en-rIN/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Move to"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compress"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extract to"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extract all"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extract here"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Browse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Rename"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Get info"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Show hidden files"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"You cant move files from another app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Showing in grid mode."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Showing in list mode."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"File name"</string>
 </resources>
diff --git a/res/values-es-rUS/strings.xml b/res/values-es-rUS/strings.xml
index c7f1e717e..68a382f45 100644
--- a/res/values-es-rUS/strings.xml
+++ b/res/values-es-rUS/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover a"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimir"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extraer en"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extraer todo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extraer aqu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Explorar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Cambiar nombre"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obtener informacin"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostrar archivos ocultos"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No puedes transferir archivos de otra app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Se muestra en modo de cuadrcula."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Se muestra en modo de lista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nombre del archivo"</string>
 </resources>
diff --git a/res/values-es/strings.xml b/res/values-es/strings.xml
index 573a6768b..737500313 100644
--- a/res/values-es/strings.xml
+++ b/res/values-es/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover a"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimir"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extraer a"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extraer todo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extraer aqu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Explorar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Cambiar nombre"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obtener informacin"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostrar archivos ocultos"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No puedes mover archivos de otra aplicacin."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Mostrando modo de cuadrcula."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Mostrando modo de lista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nombre del archivo"</string>
 </resources>
diff --git a/res/values-et/strings.xml b/res/values-et/strings.xml
index e7dbe750b..15b81449a 100644
--- a/res/values-et/strings.xml
+++ b/res/values-et/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Teisalda asukohta "</string>
     <string name="menu_compress" msgid="37539111904724188">"Tihenda"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Ekstrakti "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Ekstrakti kik "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Ekstrakti siia"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Sirvimine"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Nimeta mber"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Hangi teavet"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Kuva peidetud failid"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Te ei saa faile teisest rakendusest teisaldada."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Kuvatud ruudustikuvaates."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Kuvatud loendivaates."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Faili nimi"</string>
 </resources>
diff --git a/res/values-eu/strings.xml b/res/values-eu/strings.xml
index c8dbc0577..94305a6d7 100644
--- a/res/values-eu/strings.xml
+++ b/res/values-eu/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Eraman hona"</string>
     <string name="menu_compress" msgid="37539111904724188">"Konprimatu"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Atera hona"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Atera guztia"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Erauzi hona"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Arakatu"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Aldatu izena"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Lortu informazioa"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Erakutsi fitxategi ezkutuak"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Ezin dituzu mugitu beste aplikazio batzuetako fitxategiak."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Sareta moduan ikusgai."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Zerrenda moduan ikusgai."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Fitxategiaren izena"</string>
 </resources>
diff --git a/res/values-fa/strings.xml b/res/values-fa/strings.xml
index f5a469861..c108d9f07 100644
--- a/res/values-fa/strings.xml
+++ b/res/values-fa/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"    "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-fi/strings.xml b/res/values-fi/strings.xml
index 6fa10bf1a..7b888bfd4 100644
--- a/res/values-fi/strings.xml
+++ b/res/values-fi/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Siirr kohteeseen"</string>
     <string name="menu_compress" msgid="37539111904724188">"Pakkaa"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Pura kohteeseen"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Pura kaikki"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Pura thn"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Selaa"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Nime uudelleen"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Nyt tiedot"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Nyt piilotetut tiedostot"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Et voi siirt tiedostoja toisesta sovelluksesta."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Nytetn ruudukkotilassa."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Nytetn luettelotilassa."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Tiedostonimi"</string>
 </resources>
diff --git a/res/values-fr-rCA/strings.xml b/res/values-fr-rCA/strings.xml
index c61478375..62d18393d 100644
--- a/res/values-fr-rCA/strings.xml
+++ b/res/values-fr-rCA/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Dplacer dans"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compresser"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extraire vers"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Tout extraire"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extraire ici"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Parcourir"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Renommer"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"En savoir plus"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Afficher les fichiers masqus"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Vous ne pouvez pas dplacer de fichiers d\'une autre appli."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Affichage en mode grille."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Affichage en mode liste."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nom de fichier"</string>
 </resources>
diff --git a/res/values-fr/strings.xml b/res/values-fr/strings.xml
index 85bdeb0fd..3c1475290 100644
--- a/res/values-fr/strings.xml
+++ b/res/values-fr/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Dplacer vers"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compresser"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extraire sur"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Tout extraire"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extraire ici"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Parcourir"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Renommer"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obtenir les informations"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Afficher les fichiers masqus"</string>
@@ -303,7 +306,7 @@
     <string name="directory_blocked_header_title" msgid="1164584889578740066">"Impossible d\'utiliser ce dossier"</string>
     <string name="directory_blocked_header_subtitle" msgid="2829150911849033408">"Pour protger votre vie prive, choisissez un autre dossier"</string>
     <string name="create_new_folder_button" msgid="8859613309559794890">"Crer un dossier"</string>
-    <string name="search_bar_hint" msgid="146031513183888721">"Rechercher cet appareil"</string>
+    <string name="search_bar_hint" msgid="146031513183888721">"Rechercher sur cet appareil"</string>
     <string name="delete_search_history" msgid="2202015025607694515">"Supprimer l\'historique des recherches <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">"Personnel"</string>
     <string name="work_tab" msgid="7265359366883747413">"Professionnel"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Vous ne pouvez pas dplacer de fichiers depuis une autre application."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Affichage en mode grille."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Affichage en mode liste."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nom du fichier"</string>
 </resources>
diff --git a/res/values-gl/strings.xml b/res/values-gl/strings.xml
index 1b9fe1d2f..d45dbc211 100644
--- a/res/values-gl/strings.xml
+++ b/res/values-gl/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover a"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimir"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extraer en..."</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extraer todo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extraer aqu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Explorar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Cambiar nome"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obter informacin"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Amosar ficheiros ocultos"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Non se poden mover ficheiros desde outra aplicacin."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Mostrando modo de grade."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Mostrando modo de lista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nome do ficheiro"</string>
 </resources>
diff --git a/res/values-gu/strings.xml b/res/values-gu/strings.xml
index 766540c51..7f5ffa3e0 100644
--- a/res/values-gu/strings.xml
+++ b/res/values-gu/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">"  "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-hi/strings.xml b/res/values-hi/strings.xml
index 3183bd297..7fc004024 100644
--- a/res/values-hi/strings.xml
+++ b/res/values-hi/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"  "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"   "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"   "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"         ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"      ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"      ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
 </resources>
diff --git a/res/values-hr/strings.xml b/res/values-hr/strings.xml
index e6cfbf934..e12bc50f0 100644
--- a/res/values-hr/strings.xml
+++ b/res/values-hr/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Premjesti u"</string>
     <string name="menu_compress" msgid="37539111904724188">"Sami"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Izdvoji u"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Izdvoji sve"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Izdvoji ovdje"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Pregledaj"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Promijeni naziv"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Informacije"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Prikai skrivene datoteke"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Ne moete premjestiti datoteke iz druge aplikacije."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Prikazivanje u nainu reetke."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazivanje u nainu popisa."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Naziv datoteke"</string>
 </resources>
diff --git a/res/values-hu/strings.xml b/res/values-hu/strings.xml
index 9d7a2a675..7119be420 100644
--- a/res/values-hu/strings.xml
+++ b/res/values-hu/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"thelyezs"</string>
     <string name="menu_compress" msgid="37539111904724188">"Tmrts"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Kicsomagols ide"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"sszes kibontsa"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Kibonts ide"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Bngszs"</string>
     <string name="menu_rename" msgid="1883113442688817554">"tnevezs"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Informci megjelentse"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Rejtett fjlok megjelentse"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nem lehet thelyezni fjlokat ms alkalmazsbl."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Megjelents rcsnzetben."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Megjelents listanzetben."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Fjlnv"</string>
 </resources>
diff --git a/res/values-hy/strings.xml b/res/values-hy/strings.xml
index fb55c8bee..bf75c96c1 100644
--- a/res/values-hy/strings.xml
+++ b/res/values-hy/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-in/strings.xml b/res/values-in/strings.xml
index f89f539c3..5ac5aa336 100644
--- a/res/values-in/strings.xml
+++ b/res/values-in/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Pindahkan ke..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Kompresi"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Ekstrak ke"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Ekstrak semua"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Ekstrak di sini"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Cari"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Ganti nama"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Dapatkan info"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Tampilkan file tersembunyi"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Anda tidak dapat memindahkan file ke aplikasi lain."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Menampilkan dalam mode petak."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Menampilkan dalam mode daftar."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nama file"</string>
 </resources>
diff --git a/res/values-is/strings.xml b/res/values-is/strings.xml
index 676c483d4..f78a5fc63 100644
--- a/res/values-is/strings.xml
+++ b/res/values-is/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Fra "</string>
     <string name="menu_compress" msgid="37539111904724188">"jappa"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Flytja t "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Draga allt t "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Draga t hinga"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Skoa"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Endurnefna"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Skja upplsingar"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Sna faldar skrr"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Ekki er hgt a fra skrr r ru forriti."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Snir tfluyfirlit."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Snir listayfirlit."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Skrarheiti"</string>
 </resources>
diff --git a/res/values-it/strings.xml b/res/values-it/strings.xml
index 905815c87..a289cd8b2 100644
--- a/res/values-it/strings.xml
+++ b/res/values-it/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Sposta in"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimi"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Estrai in"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Estrai tutto"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Estrai qui"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Sfoglia"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Rinomina"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Informazioni"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostra file nascosti"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Impossibile spostare file da un\'altra app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Visualizzazione in modalit griglia."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Visualizzazione in modalit elenco."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nome file"</string>
 </resources>
diff --git a/res/values-iw/strings.xml b/res/values-iw/strings.xml
index 822177a1e..e4beae2ac 100644
--- a/res/values-iw/strings.xml
+++ b/res/values-iw/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"     ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ja/strings.xml b/res/values-ja/strings.xml
index 35685ca9a..2f3c14114 100644
--- a/res/values-ja/strings.xml
+++ b/res/values-ja/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-ka/strings.xml b/res/values-ka/strings.xml
index 1a698668f..ddf8bfcd4 100644
--- a/res/values-ka/strings.xml
+++ b/res/values-ka/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"    ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-kk/strings.xml b/res/values-kk/strings.xml
index 7d1f402e1..2d6645340 100644
--- a/res/values-kk/strings.xml
+++ b/res/values-kk/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"    ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-km/strings.xml b/res/values-km/strings.xml
index 365efd1fe..dbe6f87e1 100644
--- a/res/values-km/strings.xml
+++ b/res/values-km/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-kn/strings.xml b/res/values-kn/strings.xml
index 1cf89f41f..ab92d4130 100644
--- a/res/values-kn/strings.xml
+++ b/res/values-kn/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -221,19 +224,19 @@
       <item quantity="one"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
-    <string name="delete_filename_confirmation_message" msgid="8338069763240613258">"\"<xliff:g id="NAME">%1$s</xliff:g>\" ?"</string>
-    <string name="delete_foldername_confirmation_message" msgid="9084085260877704140">"\"<xliff:g id="NAME">%1$s</xliff:g>\"     ?"</string>
+    <string name="delete_filename_confirmation_message" msgid="8338069763240613258">"\"<xliff:g id="NAME">%1$s</xliff:g>\" ?"</string>
+    <string name="delete_foldername_confirmation_message" msgid="9084085260877704140">"\"<xliff:g id="NAME">%1$s</xliff:g>\"     ?"</string>
     <plurals name="delete_files_confirmation_message" formatted="false" msgid="4866664063250034142">
-      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
-      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
+      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
+      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
     </plurals>
     <plurals name="delete_folders_confirmation_message" formatted="false" msgid="1028946402799686388">
-      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>     ?</item>
-      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>     ?</item>
+      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>     ?</item>
+      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>     ?</item>
     </plurals>
     <plurals name="delete_items_confirmation_message" formatted="false" msgid="7285090426511028179">
-      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
-      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
+      <item quantity="one"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
+      <item quantity="other"> <xliff:g id="COUNT_1">%1$d</xliff:g>  ?</item>
     </plurals>
     <string name="images_shortcut_label" msgid="2545168016070493574">""</string>
     <string name="archive_loading_failed" msgid="7243436722828766996">"    .     ."</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"     ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ko/strings.xml b/res/values-ko/strings.xml
index bb313e892..a852f9df8 100644
--- a/res/values-ko/strings.xml
+++ b/res/values-ko/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" :"</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">"  ..."</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"     ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ky/strings.xml b/res/values-ky/strings.xml
index 83ac3fead..1e9a3dcf3 100644
--- a/res/values-ky/strings.xml
+++ b/res/values-ky/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -109,7 +112,7 @@
     <string name="cant_save_to_cross_profile_error_title" msgid="5158984057654779022">"<xliff:g id="PROFILE">%1$s</xliff:g>   "</string>
     <string name="cant_save_to_cross_profile_error_message" msgid="5845240315510422749">"IT  <xliff:g id="PROFILE_0">%1$s</xliff:g>  <xliff:g id="PROFILE_1">%2$s</xliff:g>    "</string>
     <string name="cross_profile_action_not_allowed_title" msgid="6611281348716476478">"   "</string>
-    <string name="cross_profile_action_not_allowed_message" msgid="7331275433061690947">"  , IT  "</string>
+    <string name="cross_profile_action_not_allowed_message" msgid="7331275433061690947">"   , IT  "</string>
     <string name="root_recent" msgid="1080156975424341623">""</string>
     <string name="root_available_bytes" msgid="8269870862691408864">"<xliff:g id="SIZE">%1$s</xliff:g> "</string>
     <string name="root_type_service" msgid="6521366147466512289">" "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"    ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-lo/strings.xml b/res/values-lo/strings.xml
index 8794da0e8..46370f5c0 100644
--- a/res/values-lo/strings.xml
+++ b/res/values-lo/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-lt/strings.xml b/res/values-lt/strings.xml
index 88420bf91..1398ebe85 100644
--- a/res/values-lt/strings.xml
+++ b/res/values-lt/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Perkelti "</string>
     <string name="menu_compress" msgid="37539111904724188">"Suglaudinti"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Iskleisti ..."</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Iskleisti visk"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Iskleisti ia"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Naryti"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Pervardyti"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Gauti informacijos"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Rodyti paslptus failus"</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Negalite perkelti fail i kitos programos."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Rodoma tinklelio reimu."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Rodoma srao reimu."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Failo pavadinimas"</string>
 </resources>
diff --git a/res/values-lv/strings.xml b/res/values-lv/strings.xml
index 384395b89..8879c27de 100644
--- a/res/values-lv/strings.xml
+++ b/res/values-lv/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Prvietot uz"</string>
     <string name="menu_compress" msgid="37539111904724188">"Saspiest"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Izvilkt..."</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Izgt visu"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Izvilkt eit"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Prlkot"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Prdvt"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Iegt informciju"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Rdt paslptos failus"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Js nevarat prvietot failus no citas lietotnes."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Tiek attlots rea rems."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Tiek attlots saraksta rems."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Faila nosaukums"</string>
 </resources>
diff --git a/res/values-mk/strings.xml b/res/values-mk/strings.xml
index 92d58f55a..d61524719 100644
--- a/res/values-mk/strings.xml
+++ b/res/values-mk/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"     ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"     ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
 </resources>
diff --git a/res/values-ml/strings.xml b/res/values-ml/strings.xml
index 5de00993a..116ae0291 100644
--- a/res/values-ml/strings.xml
+++ b/res/values-ml/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-mn/strings.xml b/res/values-mn/strings.xml
index cfbd53e1e..28c3f1670 100644
--- a/res/values-mn/strings.xml
+++ b/res/values-mn/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"     ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-mr/strings.xml b/res/values-mr/strings.xml
index a98a5c279..60b72c986 100644
--- a/res/values-mr/strings.xml
+++ b/res/values-mr/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" ..."</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ms/strings.xml b/res/values-ms/strings.xml
index f72d99f10..fe02922e9 100644
--- a/res/values-ms/strings.xml
+++ b/res/values-ms/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Alihkan ke"</string>
     <string name="menu_compress" msgid="37539111904724188">"Mampatkan"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Ekstrak ke"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Ekstrak semua"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Ekstrak di sini"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Semak imbas"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Namakan semula"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Dapatkan maklumat"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Tunjukkan fail tersembunyi"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Anda tidak boleh mengalihkan fail daripada apl lain."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Ditunjukkan dalam mod grid."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Ditunjukkan dalam mod senarai."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nama fail"</string>
 </resources>
diff --git a/res/values-my/strings.xml b/res/values-my/strings.xml
index e9c9f40ba..573d0bf48 100644
--- a/res/values-my/strings.xml
+++ b/res/values-my/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">" "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">" "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">" "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">" "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-nb/strings.xml b/res/values-nb/strings.xml
index 4fb2e0e36..d1a9661ee 100644
--- a/res/values-nb/strings.xml
+++ b/res/values-nb/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Flytt til"</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimer"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Pakk ut til "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Pakk ut alt"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Pakk ut her"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Bla gjennom"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Gi nytt navn"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Hent informasjon"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Vis skjulte filer"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Du kan ikke flytte filer fra en annen app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Viser i rutenettmodus."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Viser i listemodus."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Filnavn"</string>
 </resources>
diff --git a/res/values-ne/strings.xml b/res/values-ne/strings.xml
index 550ae21e0..cb267f0ca 100644
--- a/res/values-ne/strings.xml
+++ b/res/values-ne/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">"  "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-nl/strings.xml b/res/values-nl/strings.xml
index fc266ef30..4f7add78d 100644
--- a/res/values-nl/strings.xml
+++ b/res/values-nl/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Verplaatsen naar"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimeren"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Uitpakken naar"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Alles uitpakken"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Hier uitpakken"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Browsen"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Naam wijzigen"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Informatie bekijken"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Verborgen bestanden tonen"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Je kunt geen bestanden verplaatsen vanuit een andere app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Tonen in rastermodus."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Tonen in lijstmodus."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Bestandsnaam"</string>
 </resources>
diff --git a/res/values-or/strings.xml b/res/values-or/strings.xml
index 4d3d59831..ef985fcbc 100644
--- a/res/values-or/strings.xml
+++ b/res/values-or/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">"  "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -150,7 +153,7 @@
       <item quantity="other"><xliff:g id="COUNT_1">%1$d</xliff:g>   </item>
       <item quantity="one"><xliff:g id="COUNT_0">%1$d</xliff:g>   </item>
     </plurals>
-    <string name="undo" msgid="2902438994196400565">" "</string>
+    <string name="undo" msgid="2902438994196400565">" "</string>
     <string name="copy_preparing" msgid="4759516490222449324">" "</string>
     <string name="compress_preparing" msgid="7401605598969019696">" "</string>
     <string name="extract_preparing" msgid="4796626960061745796">" "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-pa/strings.xml b/res/values-pa/strings.xml
index f1390ce6e..ac450d395 100644
--- a/res/values-pa/strings.xml
+++ b/res/values-pa/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"  "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">"   "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"   "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"        "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"      "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"      "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
 </resources>
diff --git a/res/values-pl/strings.xml b/res/values-pl/strings.xml
index 4a76fafb5..3e592bc4a 100644
--- a/res/values-pl/strings.xml
+++ b/res/values-pl/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Przenie do"</string>
     <string name="menu_compress" msgid="37539111904724188">"Skompresuj"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Rozpakuj do"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Wyodrbnij wszystko"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Rozpakuj tutaj"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Przegldaj"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Zmie nazw"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Zobacz informacje"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Poka ukryte pliki"</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nie mona przenosi plikw zinnej aplikacji."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Wywietlanie wtrybie siatki."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Wywietlanie wtrybie listy."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nazwa pliku"</string>
 </resources>
diff --git a/res/values-pt-rBR/strings.xml b/res/values-pt-rBR/strings.xml
index 8dd6249e8..72b72aa1c 100644
--- a/res/values-pt-rBR/strings.xml
+++ b/res/values-pt-rBR/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover para"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compactar"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrair para"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrair tudo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrair aqui"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Procurar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Renomear"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Ver informaes"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostrar arquivos ocultos"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No  possvel mover arquivos de outro app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Exibindo modo de grade."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Exibindo modo de lista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nome do arquivo"</string>
 </resources>
diff --git a/res/values-pt-rPT/strings.xml b/res/values-pt-rPT/strings.xml
index 03a36e95c..88466b258 100644
--- a/res/values-pt-rPT/strings.xml
+++ b/res/values-pt-rPT/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover para..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprimir"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrair para"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrair tudo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrair para aqui"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Procurar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Mudar o nome"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Obter informaes"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostrar ficheiros ocultos"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No pode mover ficheiros de outra app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"A mostrar no modo de grelha"</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"A mostrar no modo de lista"</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nome do ficheiro"</string>
 </resources>
diff --git a/res/values-pt/strings.xml b/res/values-pt/strings.xml
index 8dd6249e8..72b72aa1c 100644
--- a/res/values-pt/strings.xml
+++ b/res/values-pt/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mover para"</string>
     <string name="menu_compress" msgid="37539111904724188">"Compactar"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrair para"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrair tudo"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrair aqui"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Procurar"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Renomear"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Ver informaes"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Mostrar arquivos ocultos"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"No  possvel mover arquivos de outro app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Exibindo modo de grade."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Exibindo modo de lista."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nome do arquivo"</string>
 </resources>
diff --git a/res/values-ro/strings.xml b/res/values-ro/strings.xml
index b3bb84146..82f43949e 100644
--- a/res/values-ro/strings.xml
+++ b/res/values-ro/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Mut n"</string>
     <string name="menu_compress" msgid="37539111904724188">"Comprim"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrage n"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrage tot"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrage aici"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Rsfoiete"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Redenumete"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Vezi informaiile"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Afieaz fiierele ascunse"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nu poi muta fiiere din alt aplicaie."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Se afieaz n modul gril."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Se afieaz n modul list."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Numele fiierului"</string>
 </resources>
diff --git a/res/values-ru/strings.xml b/res/values-ru/strings.xml
index cedb653d5..931934b27 100644
--- a/res/values-ru/strings.xml
+++ b/res/values-ru/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"   "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -328,9 +331,11 @@
     <string name="search_bar_hint" msgid="146031513183888721">"  "</string>
     <string name="delete_search_history" msgid="2202015025607694515">"  : <xliff:g id="TEXT">%1$s</xliff:g>"</string>
     <string name="personal_tab" msgid="3878576287868528503">""</string>
-    <string name="work_tab" msgid="7265359366883747413">""</string>
+    <string name="work_tab" msgid="7265359366883747413">""</string>
     <string name="a11y_work" msgid="7504431382825242153">""</string>
     <string name="drag_from_another_app" msgid="8310249276199969905">"     ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-si/strings.xml b/res/values-si/strings.xml
index 3c2b2429e..9dbe949c9 100644
--- a/res/values-si/strings.xml
+++ b/res/values-si/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"  "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">"  "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-sk/strings.xml b/res/values-sk/strings.xml
index 8b5e87fbb..353cfa113 100644
--- a/res/values-sk/strings.xml
+++ b/res/values-sk/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Presun do"</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimova"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Rozbali do"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrahova vetko"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrahova tu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Prehliada"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Premenova"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Zobrazi informcie"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Zobrazi skryt sbory"</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nemete presva sbory zinej aplikcie."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Zobrazovan vreime mrieky."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Zobrazovan vreime zoznamu."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Nzov sboru"</string>
 </resources>
diff --git a/res/values-sl/strings.xml b/res/values-sl/strings.xml
index e2faad032..f6d15591f 100644
--- a/res/values-sl/strings.xml
+++ b/res/values-sl/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Premakni v ..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Stisni"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Raziri v "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Raziri vse "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Ekstrahiraj sem"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Prebrskaj"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Preimenuj"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Prikai informacije"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Prikai skrite datoteke"</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Datotek iz druge aplikacije ni mogoe premakniti."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Prikazano v nainu mree"</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Prikazano v nainu seznama"</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Ime datoteke"</string>
 </resources>
diff --git a/res/values-sq/strings.xml b/res/values-sq/strings.xml
index 5de2e9d3b..c8cd908ae 100644
--- a/res/values-sq/strings.xml
+++ b/res/values-sq/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Zhvendos te..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Ngjish"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Nxirre te"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Nxirri t gjitha"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Nxirr ktu"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Shfleto"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Riemrto"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Merr informacione"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Shfaq skedart e fshehur"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Nuk mund t\'i zhvendossh skedart nga nj aplikacion tjetr."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Po shfaq n modalitetin \"rrjet\"."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Po shfaq n modalitetin \"list\"."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Emri i skedarit"</string>
 </resources>
diff --git a/res/values-sr/strings.xml b/res/values-sr/strings.xml
index 2dcc91983..627e35356 100644
--- a/res/values-sr/strings.xml
+++ b/res/values-sr/strings.xml
@@ -18,7 +18,7 @@
     xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
     <string name="missing_rename_error" msgid="9098952207447981103">"   "</string>
     <string name="add_folder_name_error" msgid="6014615052491406810">"    "</string>
-    <string name="files_label" msgid="771781190045103748">""</string>
+    <string name="files_label" msgid="771781190045103748">""</string>
     <string name="downloads_label" msgid="5462789470049501103">""</string>
     <!-- no translation found for app_label (8089292432455111409) -->
     <skip />
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -271,7 +274,7 @@
       <item quantity="other">  <xliff:g id="COUNT_1">%1$d</xliff:g> </item>
     </plurals>
     <string name="root_info_header_recent" msgid="5654901877295332262">" "</string>
-    <string name="root_info_header_global_search" msgid="4904078222280496152">""</string>
+    <string name="root_info_header_global_search" msgid="4904078222280496152">""</string>
     <string name="root_info_header_downloads" msgid="8848161246921154115">"  "</string>
     <string name="root_info_header_storage" msgid="2989014130584927442">"   <xliff:g id="DEVICE">%1$s</xliff:g>"</string>
     <string name="root_info_header_folder" msgid="5851172222368049864">"   <xliff:g id="FOLDER">%1$s</xliff:g>"</string>
@@ -311,4 +314,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"       ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"    ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"    ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-sv/strings.xml b/res/values-sv/strings.xml
index 281612761..dab4bfbe2 100644
--- a/res/values-sv/strings.xml
+++ b/res/values-sv/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Flytta till ..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Komprimera"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Extrahera till "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Extrahera alla"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Extrahera hit"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Blddra"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Byt namn"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Hmta information"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Visa dolda filer"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Du kan inte flytta filer frn en annan app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Visas i rutntslge."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Visas i listlge."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Filnamn"</string>
 </resources>
diff --git a/res/values-sw/strings.xml b/res/values-sw/strings.xml
index c09e09ff5..7ec3309cf 100644
--- a/res/values-sw/strings.xml
+++ b/res/values-sw/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Hamishia kwenye..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Bana"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Weka kwenye"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Dondoa zote"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Dondoa hapa"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Vinjari"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Badilisha jina"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Pata maelezo zaidi"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Onyesha faili zilizofichwa"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Huwezi kuhamisha faili kutoka programu nyingine."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Kuonyesha katika hali ya gridi."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Kuonyesha katika hali ya orodha."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Jina la faili"</string>
 </resources>
diff --git a/res/values-ta/strings.xml b/res/values-ta/strings.xml
index 1e8b754d7..35a856f23 100644
--- a/res/values-ta/strings.xml
+++ b/res/values-ta/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"    ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-te/strings.xml b/res/values-te/strings.xml
index aff5a7337..ba463359d 100644
--- a/res/values-te/strings.xml
+++ b/res/values-te/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" ..."</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">" "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"  "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">" "</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"  ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"  ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-th/strings.xml b/res/values-th/strings.xml
index b33809db7..10181068d 100644
--- a/res/values-th/strings.xml
+++ b/res/values-th/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-tl/strings.xml b/res/values-tl/strings.xml
index dc7719470..3befbf583 100644
--- a/res/values-tl/strings.xml
+++ b/res/values-tl/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Ilipat sa"</string>
     <string name="menu_compress" msgid="37539111904724188">"I-compress"</string>
     <string name="menu_extract" msgid="8171946945982532262">"I-extract sa"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"I-extract lahat"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"I-extract dito"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Mag-browse"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Palitan ang pangalan"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Kumuha ng impormasyon"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Ipakita ang hidden files"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Hindi ka makakapaglipat ng mga file mula sa ibang app."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Ipinapakita sa grid mode."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Ipinapakita sa list mode."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Pangalan ng file"</string>
 </resources>
diff --git a/res/values-tr/strings.xml b/res/values-tr/strings.xml
index f8bbc893b..490f9ca29 100644
--- a/res/values-tr/strings.xml
+++ b/res/values-tr/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Klasre ta..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Sktr"</string>
     <string name="menu_extract" msgid="8171946945982532262">"uraya kar:"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Tmn kar"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Buraya kar"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Gz at"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Yeniden adlandr"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Bilgi al"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Gizli dosyalar gster"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Baka bir uygulamadan dosya tayamazsnz."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Tablo modunda gsteriliyor."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Liste modunda gsteriliyor."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Dosya ad"</string>
 </resources>
diff --git a/res/values-uk/strings.xml b/res/values-uk/strings.xml
index 170e4fc11..52f36ec44 100644
--- a/res/values-uk/strings.xml
+++ b/res/values-uk/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">" "</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">" "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -333,4 +336,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"      ."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"   ."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"   ."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">" "</string>
 </resources>
diff --git a/res/values-ur/strings.xml b/res/values-ur/strings.xml
index b0ee0558b..9f20a9957 100644
--- a/res/values-ur/strings.xml
+++ b/res/values-ur/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"   "</string>
     <string name="menu_compress" msgid="37539111904724188">" "</string>
     <string name="menu_extract" msgid="8171946945982532262">"  "</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">" "</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">" "</string>
+    <string name="menu_browse" msgid="6007716414766674967">" "</string>
     <string name="menu_rename" msgid="1883113442688817554">"  "</string>
     <string name="menu_inspect" msgid="7279855349299446224">"  "</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"  "</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"          "</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"      "</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"      "</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"  "</string>
 </resources>
diff --git a/res/values-uz/strings.xml b/res/values-uz/strings.xml
index 02bdfb3a2..8e7c154f9 100644
--- a/res/values-uz/strings.xml
+++ b/res/values-uz/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Boshqa joyga olish"</string>
     <string name="menu_compress" msgid="37539111904724188">"Arxivlash"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Arxivdan chiqarish"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Barchasini ajratish"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Shu yerga chiqarish"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Kezish"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Qayta nomlash"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Axborot olish"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Yashirin fayllarni chiqarish"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Fayllarni boshqa ilovadan kochirish imkonsiz."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Jadval shaklida chiqarilmoqda."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Royxat shaklida chiqarilmoqda."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Fayl nomi"</string>
 </resources>
diff --git a/res/values-vi/strings.xml b/res/values-vi/strings.xml
index 7f922d0fc..9d3fe1683 100644
--- a/res/values-vi/strings.xml
+++ b/res/values-vi/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Chuyn ti..."</string>
     <string name="menu_compress" msgid="37539111904724188">"Nn"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Trch xut sang"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Trch xut tt c"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Trch xut  y"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Duyt xem"</string>
     <string name="menu_rename" msgid="1883113442688817554">"i tn"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Xem thng tin"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Hin cc tp b n"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Bn khng th di chuyn cc tp t mt ng dng khc."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"ang hin th  ch  li."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"ang hin th  ch  danh sch."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Tn tp"</string>
 </resources>
diff --git a/res/values-zh-rCN/strings.xml b/res/values-zh-rCN/strings.xml
index 992c57151..939830937 100644
--- a/res/values-zh-rCN/strings.xml
+++ b/res/values-zh-rCN/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-zh-rHK/strings.xml b/res/values-zh-rHK/strings.xml
index eec2956d0..aa923d75b 100644
--- a/res/values-zh-rHK/strings.xml
+++ b/res/values-zh-rHK/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-zh-rTW/strings.xml b/res/values-zh-rTW/strings.xml
index 16d0a7305..9c99307b2 100644
--- a/res/values-zh-rTW/strings.xml
+++ b/res/values-zh-rTW/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">""</string>
     <string name="menu_compress" msgid="37539111904724188">""</string>
     <string name="menu_extract" msgid="8171946945982532262">""</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">""</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">""</string>
+    <string name="menu_browse" msgid="6007716414766674967">""</string>
     <string name="menu_rename" msgid="1883113442688817554">""</string>
     <string name="menu_inspect" msgid="7279855349299446224">""</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">""</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">""</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">""</string>
     <string name="list_mode_showing" msgid="1225413902295895166">""</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">""</string>
 </resources>
diff --git a/res/values-zu/strings.xml b/res/values-zu/strings.xml
index 83a654282..80c39b98f 100644
--- a/res/values-zu/strings.xml
+++ b/res/values-zu/strings.xml
@@ -45,6 +45,9 @@
     <string name="menu_move" msgid="2310760789561129882">"Hambisa ku"</string>
     <string name="menu_compress" msgid="37539111904724188">"Cindezela"</string>
     <string name="menu_extract" msgid="8171946945982532262">"Khiphela ku"</string>
+    <string name="menu_extract_all" msgid="7335680068521252718">"Khipha konke"</string>
+    <string name="menu_extract_here" msgid="8725302045721604762">"Khipha lapha"</string>
+    <string name="menu_browse" msgid="6007716414766674967">"Bhrawuza"</string>
     <string name="menu_rename" msgid="1883113442688817554">"Qamba kabusha"</string>
     <string name="menu_inspect" msgid="7279855349299446224">"Thola ulwazi"</string>
     <string name="menu_show_hidden_files" msgid="5140676344684492769">"Bonisa amafayela afihliwe"</string>
@@ -289,4 +292,6 @@
     <string name="drag_from_another_app" msgid="8310249276199969905">"Awukwazi ukuhambisa amafayela kusuka kolunye uhlelo lokusebenza."</string>
     <string name="grid_mode_showing" msgid="2803166871485028508">"Ibonisa kumodi yegridi."</string>
     <string name="list_mode_showing" msgid="1225413902295895166">"Ibonisa kumodi yohlu."</string>
+    <string name="bullet" msgid="5606740650312122766">""</string>
+    <string name="file_name_hint" msgid="7843637320487415838">"Igama lefayela"</string>
 </resources>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 89e40ac4c..c3f11bab4 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -78,6 +78,12 @@
     <string name="menu_compress">Compress</string>
     <!-- Menu item title that extracts the selected documents [CHAR LIMIT=28] -->
     <string name="menu_extract">Extract to\u2026</string>
+    <!-- Menu item title that extracts all the documents in the current directory [CHAR LIMIT=28] -->
+    <string name="menu_extract_all">Extract all\u2026</string>
+    <!-- Menu item title that extracts the contents of the selected archive [CHAR LIMIT=28] -->
+    <string name="menu_extract_here">Extract here</string>
+    <!-- Menu item title that browses the contents of the selected archive [CHAR LIMIT=28] -->
+    <string name="menu_browse">Browse</string>
     <!-- Menu item that renames the selected document [CHAR LIMIT=28] -->
     <string name="menu_rename">Rename</string>
     <!-- Menu item that displays properties about the selected document [CHAR LIMIT=28] -->
@@ -407,6 +413,24 @@
          during a copy. [CHAR LIMIT=48] -->
     <string name="notification_copy_files_converted_title">Some files were converted</string>
 
+    <string name="copy_in_progress" translatable="false">{count, plural,
+        =1 {Copying <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g> to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
+        other {Copying # files to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
+    }</string>
+    <string name="move_in_progress" translatable="false">{count, plural,
+        =1 {Moving <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g> to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
+        other {Moving # files to <xliff:g id="directory" example="example folder">{directory}</xliff:g>}
+    }</string>
+    <string name="delete_in_progress" translatable="false">{count, plural,
+        =1 {Deleting <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g>}
+        other {Deleting # files}
+    }</string>
+    <string name="compress_in_progress" translatable="false">{count, plural,
+        =1 {Zipping <xliff:g id="filename" example="foobar.txt">{filename}</xliff:g>}
+        other {Zipping # files}
+    }</string>
+    <string name="job_progress_panel_title" translatable="false">File Progress</string>
+
     <!-- Text in an alert dialog asking user to grant app access to a given directory in an external storage volume -->
     <string name="open_external_dialog_request">Grant <xliff:g id="appName" example="System Settings"><b>^1</b></xliff:g>
         access to <xliff:g id="directory" example="Pictures"><i>^2</i></xliff:g> directory on
@@ -585,4 +609,9 @@
     <!-- Accessibility announcement when switching to list mode of files and directories shown. [CHAR_LIMIT=100] -->
     <string name="list_mode_showing">Showing in list mode.</string>
 
+    <!-- Unicode Character  (U+2022). -->
+    <string name="bullet">\u2022</string>
+
+    <!-- Text used at the top of the text field when saving a document. [CHAR_LIMIT=100] -->
+    <string name="file_name_hint">File name</string>
 </resources>
diff --git a/src/com/android/documentsui/AbstractActionHandler.java b/src/com/android/documentsui/AbstractActionHandler.java
index 2f64ebf64..89e9bc2d6 100644
--- a/src/com/android/documentsui/AbstractActionHandler.java
+++ b/src/com/android/documentsui/AbstractActionHandler.java
@@ -19,6 +19,9 @@ package com.android.documentsui;
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUseSearchV2FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import android.app.PendingIntent;
 import android.content.ActivityNotFoundException;
@@ -37,6 +40,7 @@ import android.util.Log;
 import android.util.Pair;
 import android.view.DragEvent;
 
+import androidx.annotation.NonNull;
 import androidx.annotation.VisibleForTesting;
 import androidx.fragment.app.FragmentActivity;
 import androidx.loader.app.LoaderManager.LoaderCallbacks;
@@ -62,6 +66,9 @@ import com.android.documentsui.dirlist.AnimationView.AnimationType;
 import com.android.documentsui.dirlist.FocusHandler;
 import com.android.documentsui.files.LauncherActivity;
 import com.android.documentsui.files.QuickViewIntentBuilder;
+import com.android.documentsui.loaders.FolderLoader;
+import com.android.documentsui.loaders.QueryOptions;
+import com.android.documentsui.loaders.SearchLoader;
 import com.android.documentsui.queries.SearchViewManager;
 import com.android.documentsui.roots.GetRootDocumentTask;
 import com.android.documentsui.roots.LoadFirstRootTask;
@@ -72,10 +79,14 @@ import com.android.documentsui.sorting.SortListFragment;
 import com.android.documentsui.ui.DialogController;
 import com.android.documentsui.ui.Snackbars;
 
+import java.time.Duration;
 import java.util.ArrayList;
+import java.util.Collection;
 import java.util.List;
 import java.util.Objects;
 import java.util.concurrent.Executor;
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
 import java.util.concurrent.Semaphore;
 import java.util.function.Consumer;
 
@@ -251,7 +262,12 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
     }
 
     @Override
-    public void showInspector(DocumentInfo doc) {
+    public void openDocumentViewOnly(DocumentInfo doc) {
+        throw new UnsupportedOperationException("Open doc not supported!");
+    }
+
+    @Override
+    public void showPreview(DocumentInfo doc) {
         throw new UnsupportedOperationException("Can't open properties.");
     }
 
@@ -443,17 +459,17 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
 
     private boolean viewDocument(DocumentInfo doc) {
         if (doc.isPartial()) {
-            Log.w(TAG, "Can't view partial file.");
+            Log.w(TAG, "Cannot view partial file");
             return false;
         }
 
-        if (doc.isInArchive()) {
-            Log.w(TAG, "Can't view files in archives.");
+        if (!isZipNgFlagEnabled() && doc.isInArchive()) {
+            Log.w(TAG, "Cannot view file in archive");
             return false;
         }
 
         if (doc.isDirectory()) {
-            Log.w(TAG, "Can't view directories.");
+            Log.w(TAG, "Cannot view directory");
             return true;
         }
 
@@ -560,6 +576,15 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
         if (doc.isWriteSupported()) {
             flags |= Intent.FLAG_GRANT_WRITE_URI_PERMISSION;
         }
+        // On desktop users expect files to open in a new window.
+        if (isDesktopFileHandlingFlagEnabled()) {
+            // The combination of NEW_DOCUMENT and MULTIPLE_TASK allows multiple instances of the
+            // same activity to open in separate windows.
+            flags |= Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK;
+            // If the activity has documentLaunchMode="never", NEW_TASK forces the activity to still
+            // open in a new window.
+            flags |= Intent.FLAG_ACTIVITY_NEW_TASK;
+        }
         intent.setFlags(flags);
 
         return intent;
@@ -879,16 +904,28 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
 
     private final class LoaderBindings implements LoaderCallbacks<DirectoryResult> {
 
+        private ExecutorService mExecutorService = null;
+        private static final long MAX_SEARCH_TIME_MS = 3000;
+        private static final int MAX_RESULTS = 500;
+
+        @NonNull
         @Override
         public Loader<DirectoryResult> onCreateLoader(int id, Bundle args) {
-            Context context = mActivity;
-
             // If document stack is not initialized, i.e. if the root is null, create "Recents" root
             // with the selected user.
             if (!mState.stack.isInitialized()) {
                 mState.stack.changeRoot(mActivity.getCurrentRoot());
             }
 
+            if (isUseSearchV2FlagEnabled()) {
+                return onCreateLoaderV2(id, args);
+            }
+            return onCreateLoaderV1(id, args);
+        }
+
+        private Loader<DirectoryResult> onCreateLoaderV1(int id, Bundle args) {
+            Context context = mActivity;
+
             if (mState.stack.isRecents()) {
                 final LockingContentObserver observer = new LockingContentObserver(
                         mContentLock, AbstractActionHandler.this::loadDocumentsForCurrentStack);
@@ -965,6 +1002,69 @@ public abstract class AbstractActionHandler<T extends FragmentActivity & CommonA
             }
         }
 
+        private Loader<DirectoryResult> onCreateLoaderV2(int id, Bundle args) {
+            if (mExecutorService == null) {
+                // TODO(b:388130971): Fine tune the size of the thread pool.
+                mExecutorService = Executors.newFixedThreadPool(
+                        GlobalSearchLoader.MAX_OUTSTANDING_TASK);
+            }
+            DocumentStack stack = mState.stack;
+            RootInfo root = stack.getRoot();
+            List<UserId> userIdList = DocumentsApplication.getUserIdManager(mActivity).getUserIds();
+
+            Duration lastModifiedDelta = stack.isRecents()
+                    ? Duration.ofMillis(RecentsLoader.REJECT_OLDER_THAN)
+                    : null;
+            int maxResults = (root == null || root.isRecents())
+                    ? RecentsLoader.MAX_DOCS_FROM_ROOT : MAX_RESULTS;
+            QueryOptions options = new QueryOptions(
+                    maxResults, lastModifiedDelta, Duration.ofMillis(MAX_SEARCH_TIME_MS),
+                    mState.showHiddenFiles, mState.acceptMimes, mSearchMgr.buildQueryArgs());
+
+            if (stack.isRecents() || mSearchMgr.isSearching()) {
+                Log.d(TAG, "Creating search loader V2");
+                // For search and recent we create an observer that restart the loader every time
+                // one of the searched content providers reports a change.
+                final LockingContentObserver observer = new LockingContentObserver(
+                        mContentLock, AbstractActionHandler.this::loadDocumentsForCurrentStack);
+                Collection<RootInfo> rootList = new ArrayList<>();
+                if (stack.isRecents()) {
+                    // TODO(b:381346575): Pass roots based on user selection.
+                    rootList.addAll(mProviders.getMatchingRootsBlocking(mState).stream().filter(
+                            r -> r.supportsSearch() && r.authority != null
+                                    && r.rootId != null).toList());
+                } else {
+                    rootList.add(root);
+                }
+                return new SearchLoader(
+                        mActivity,
+                        userIdList,
+                        mInjector.fileTypeLookup,
+                        observer,
+                        rootList,
+                        mSearchMgr.getCurrentSearch(),
+                        options,
+                        mState.sortModel,
+                        mExecutorService
+                );
+            }
+            Log.d(TAG, "Creating folder loader V2");
+            // For folder scan we pass the content lock to the loader so that it can register
+            // an a callback to its internal method that forces a reload of the folder, every
+            // time the content provider reports a change.
+            return new FolderLoader(
+                    mActivity,
+                    userIdList,
+                    mInjector.fileTypeLookup,
+                    mContentLock,
+                    root,
+                    stack.peek(),
+                    options,
+                    mState.sortModel
+            );
+
+        }
+
         @Override
         public void onLoadFinished(Loader<DirectoryResult> loader, DirectoryResult result) {
             if (DEBUG) {
diff --git a/src/com/android/documentsui/ActionHandler.java b/src/com/android/documentsui/ActionHandler.java
index 15124eb33..190f5d960 100644
--- a/src/com/android/documentsui/ActionHandler.java
+++ b/src/com/android/documentsui/ActionHandler.java
@@ -118,7 +118,7 @@ public interface ActionHandler {
 
     void showCreateDirectoryDialog();
 
-    void showInspector(DocumentInfo doc);
+    void showPreview(DocumentInfo doc);
 
     @Nullable DocumentInfo renameDocument(String name, DocumentInfo document);
 
@@ -128,6 +128,12 @@ public interface ActionHandler {
      */
     boolean openItem(ItemDetails<String> doc, @ViewType int type, @ViewType int fallback);
 
+    /**
+     * Similar to openItem but takes DocumentInfo instead of DocumentItemDetails and uses
+     * VIEW_TYPE_VIEW with no fallback.
+     */
+    void openDocumentViewOnly(DocumentInfo doc);
+
     /**
      * This is called when user hovers over a doc for enough time during a drag n' drop, to open a
      * folder that accepts drop. We should only open a container that's not an archive, since archives
diff --git a/src/com/android/documentsui/ActionModeController.java b/src/com/android/documentsui/ActionModeController.java
index 1bd4eea3c..931942fca 100644
--- a/src/com/android/documentsui/ActionModeController.java
+++ b/src/com/android/documentsui/ActionModeController.java
@@ -17,6 +17,7 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.Activity;
 import android.util.Log;
@@ -38,6 +39,8 @@ import com.android.documentsui.ui.MessageBuilder;
 
 /**
  * A controller that listens to selection changes and manages life cycles of action modes.
+ * TODO(b/379776735): This class (and action mode in general) is no longer in use when the
+ * use_material3 flag is enabled. Remove the class once the flag is rolled out.
  */
 public class ActionModeController extends SelectionObserver<String>
         implements ActionMode.Callback, ActionModeAddons {
@@ -134,8 +137,12 @@ public class ActionModeController extends SelectionObserver<String>
         mActivity.getWindow().setTitle(mActivity.getTitle());
 
         // Re-enable TalkBack for the toolbars, as they are no longer covered by action mode.
+        int[] toolbarIds =
+                isUseMaterial3FlagEnabled()
+                        ? new int[] {R.id.toolbar}
+                        : new int[] {R.id.toolbar, R.id.roots_toolbar};
         mScope.accessibilityImportanceSetter.setAccessibilityImportance(
-                View.IMPORTANT_FOR_ACCESSIBILITY_AUTO, R.id.toolbar, R.id.roots_toolbar);
+                View.IMPORTANT_FOR_ACCESSIBILITY_AUTO, toolbarIds);
 
         mNavigator.setActionModeActivated(false);
     }
@@ -151,10 +158,13 @@ public class ActionModeController extends SelectionObserver<String>
 
             // Hide the toolbars if action mode is enabled, so TalkBack doesn't navigate to
             // these controls when using linear navigation.
+            int[] toolbarIds =
+                    isUseMaterial3FlagEnabled()
+                            ? new int[] {R.id.toolbar}
+                            : new int[] {R.id.toolbar, R.id.roots_toolbar};
             mScope.accessibilityImportanceSetter.setAccessibilityImportance(
                     View.IMPORTANT_FOR_ACCESSIBILITY_NO_HIDE_DESCENDANTS,
-                    R.id.toolbar,
-                    R.id.roots_toolbar);
+                    toolbarIds);
             return true;
         }
 
diff --git a/src/com/android/documentsui/BaseActivity.java b/src/com/android/documentsui/BaseActivity.java
index b3439d585..8a5779a69 100644
--- a/src/com/android/documentsui/BaseActivity.java
+++ b/src/com/android/documentsui/BaseActivity.java
@@ -19,7 +19,8 @@ package com.android.documentsui;
 import static com.android.documentsui.base.Shared.EXTRA_BENCHMARK;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.State.MODE_GRID;
-import static com.android.documentsui.flags.Flags.useMaterial3;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUsePeekPreviewFlagEnabled;
 
 import android.content.Context;
 import android.content.Intent;
@@ -65,6 +66,7 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.dirlist.AnimationView;
 import com.android.documentsui.dirlist.AppsRowManager;
 import com.android.documentsui.dirlist.DirectoryFragment;
+import com.android.documentsui.peek.PeekViewManager;
 import com.android.documentsui.prefs.LocalPreferences;
 import com.android.documentsui.prefs.PreferencesMonitor;
 import com.android.documentsui.queries.CommandInterceptor;
@@ -79,6 +81,7 @@ import com.android.documentsui.sorting.SortModel;
 import com.android.modules.utils.build.SdkLevel;
 
 import com.google.android.material.appbar.AppBarLayout;
+import com.google.android.material.button.MaterialButton;
 import com.google.android.material.color.DynamicColors;
 
 import java.util.ArrayList;
@@ -95,6 +98,7 @@ public abstract class BaseActivity
 
     protected SearchViewManager mSearchManager;
     protected AppsRowManager mAppsRowManager;
+    protected @Nullable PeekViewManager mPeekViewManager;
     protected UserIdManager mUserIdManager;
     protected UserManagerState mUserManagerState;
     protected State mState;
@@ -183,7 +187,7 @@ public abstract class BaseActivity
         // in case Activity continuously encounter resource not found exception.
         getTheme().applyStyle(R.style.DocumentsDefaultTheme, false);
 
-        if (useMaterial3() && SdkLevel.isAtLeastS()) {
+        if (isUseMaterial3FlagEnabled() && SdkLevel.isAtLeastS()) {
             DynamicColors.applyToActivityIfAvailable(this);
         }
 
@@ -204,6 +208,16 @@ public abstract class BaseActivity
         mDrawer = DrawerController.create(this, mInjector.config);
         Metrics.logActivityLaunch(mState, intent);
 
+        if (isUseMaterial3FlagEnabled()) {
+            View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+            if (navRailRoots != null) {
+                // Bind event listener for the burger menu on nav rail.
+                MaterialButton burgerMenu = findViewById(R.id.nav_rail_burger_menu);
+                burgerMenu.setOnClickListener(v -> mDrawer.setOpen(true));
+                burgerMenu.setOnFocusChangeListener(this::onBurgerMenuFocusChange);
+            }
+        }
+
         mProviders = DocumentsApplication.getProvidersCache(this);
         mDocs = DocumentsAccess.create(this, mState);
 
@@ -358,6 +372,14 @@ public abstract class BaseActivity
             if (roots != null) {
                 roots.onSelectedUserChanged();
             }
+            if (isUseMaterial3FlagEnabled()) {
+                final RootsFragment navRailRoots =
+                        RootsFragment.getNavRail(getSupportFragmentManager());
+                if (navRailRoots != null) {
+                    navRailRoots.onSelectedUserChanged();
+                }
+            }
+
 
             if (mState.stack.size() <= 1) {
                 // We do not load cross-profile root if the stack contains two documents. The
@@ -378,6 +400,13 @@ public abstract class BaseActivity
         });
 
         mSortController = SortController.create(this, mState.derivedMode, mState.sortModel);
+        if (isUseMaterial3FlagEnabled()) {
+            View previewIconPlaceholder = findViewById(R.id.preview_icon_placeholder);
+            if (previewIconPlaceholder != null) {
+                previewIconPlaceholder.setVisibility(
+                        mState.shouldShowPreview() ? View.VISIBLE : View.GONE);
+            }
+        }
 
         mPreferencesMonitor = new PreferencesMonitor(
                 getApplicationContext().getPackageName(),
@@ -388,18 +417,37 @@ public abstract class BaseActivity
         // Base classes must update result in their onCreate.
         setResult(AppCompatActivity.RESULT_CANCELED);
         updateRecentsSetting();
+
+        if (isUsePeekPreviewFlagEnabled()) {
+            mPeekViewManager = new PeekViewManager(this);
+            mPeekViewManager.initFragment(getSupportFragmentManager());
+        }
     }
 
     private NavigationViewManager getNavigationViewManager(Breadcrumb breadcrumb,
             View profileTabsContainer) {
         if (mConfigStore.isPrivateSpaceInDocsUIEnabled()) {
-            return new NavigationViewManager(this, mDrawer, mState, this, breadcrumb,
-                    profileTabsContainer, DocumentsApplication.getUserManagerState(this),
-                    mConfigStore);
+            return new NavigationViewManager(
+                    this,
+                    mDrawer,
+                    mState,
+                    this,
+                    breadcrumb,
+                    profileTabsContainer,
+                    DocumentsApplication.getUserManagerState(this),
+                    mConfigStore,
+                    mInjector);
         }
-        return new NavigationViewManager(this, mDrawer, mState, this, breadcrumb,
-                profileTabsContainer, DocumentsApplication.getUserIdManager(this),
-                mConfigStore);
+        return new NavigationViewManager(
+                this,
+                mDrawer,
+                mState,
+                this,
+                breadcrumb,
+                profileTabsContainer,
+                DocumentsApplication.getUserIdManager(this),
+                mConfigStore,
+                mInjector);
     }
 
     public void onPreferenceChanged(String pref) {
@@ -413,14 +461,21 @@ public abstract class BaseActivity
     protected void onPostCreate(Bundle savedInstanceState) {
         super.onPostCreate(savedInstanceState);
 
-        mRootsMonitor = new RootsMonitor<>(
-                this,
-                mInjector.actions,
-                mProviders,
-                mDocs,
-                mState,
-                mSearchManager,
-                mInjector.actionModeController::finishActionMode);
+        Runnable finishActionMode =
+                (isUseMaterial3FlagEnabled())
+                        ? mNavigator::closeSelectionBar
+                        : mInjector.actionModeController::finishActionMode;
+
+        mRootsMonitor =
+                new RootsMonitor<>(
+                        this,
+                        mInjector.actions,
+                        mProviders,
+                        mDocs,
+                        mState,
+                        mSearchManager,
+                        finishActionMode);
+
         mRootsMonitor.start();
     }
 
@@ -432,6 +487,13 @@ public abstract class BaseActivity
 
     @Override
     public boolean onCreateOptionsMenu(Menu menu) {
+        if (isUseMaterial3FlagEnabled()) {
+            // In Material3 the menu is now inflated in the `NavigationViewMenu`. This is currently
+            // to allow for us to inflate between the action_menu and the activity menu. Once the
+            // Material 3 flag is removed, the menus will be merged and we can rely on this single
+            // inflation point.
+            return super.onCreateOptionsMenu(menu);
+        }
         boolean showMenu = super.onCreateOptionsMenu(menu);
 
         getMenuInflater().inflate(R.menu.activity, menu);
@@ -440,9 +502,10 @@ public abstract class BaseActivity
         boolean showSearchBar = getResources().getBoolean(R.bool.show_search_bar);
         mSearchManager.install(menu, fullBarSearch, showSearchBar);
 
+        // Remove the subMenu when material3 is launched b/379776735.
         final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
         // If size is 0, it means the menu has not inflated and it should only do once.
-        if (subMenuView.getMenu().size() == 0) {
+        if (subMenuView != null && subMenuView.getMenu().size() == 0) {
             subMenuView.setOnMenuItemClickListener(this::onOptionsItemSelected);
             getMenuInflater().inflate(R.menu.sub_menu, subMenuView.getMenu());
         }
@@ -454,9 +517,17 @@ public abstract class BaseActivity
     @CallSuper
     public boolean onPrepareOptionsMenu(Menu menu) {
         super.onPrepareOptionsMenu(menu);
-        mSearchManager.showMenu(mState.stack);
-        final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
-        mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
+        // Remove the subMenu when material3 is launched b/379776735.
+        if (isUseMaterial3FlagEnabled()) {
+            if (mNavigator != null) {
+                mNavigator.updateActionMenu();
+            }
+        } else {
+            mSearchManager.showMenu(mState.stack);
+            final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
+            mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
+        }
+
         return true;
     }
 
@@ -506,18 +577,32 @@ public abstract class BaseActivity
         View root = findViewById(R.id.coordinator_layout);
         root.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                 | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
-        root.setOnApplyWindowInsetsListener((v, insets) -> {
-            root.setPadding(insets.getSystemWindowInsetLeft(),
-                    insets.getSystemWindowInsetTop(), insets.getSystemWindowInsetRight(), 0);
-
-            View saveContainer = findViewById(R.id.container_save);
-            saveContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
-
-            View rootsContainer = findViewById(R.id.container_roots);
-            rootsContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
+        root.setOnApplyWindowInsetsListener(
+                (v, insets) -> {
+                    root.setPadding(
+                            insets.getSystemWindowInsetLeft(),
+                            insets.getSystemWindowInsetTop(),
+                            insets.getSystemWindowInsetRight(),
+                            0);
+
+                    // When use_material3 flag is ON and FEATURE_FREEFORM_WINDOW_MANAGEMENT is
+                    // enabled, then there should not be any additional bottom gap in full screen
+                    // mode. Otherwise need to take into account the system window insets such as
+                    // the bottom swipe up navigation gesture.
+                    if (!isUseMaterial3FlagEnabled()
+                            || !getApplicationContext()
+                            .getPackageManager()
+                            .hasSystemFeature(
+                                    PackageManager.FEATURE_FREEFORM_WINDOW_MANAGEMENT)) {
+                        View saveContainer = findViewById(R.id.container_save);
+                        saveContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
+
+                        View rootsContainer = findViewById(R.id.container_roots);
+                        rootsContainer.setPadding(0, 0, 0, insets.getSystemWindowInsetBottom());
+                    }
 
-            return insets.consumeSystemWindowInsets();
-        });
+                    return insets.consumeSystemWindowInsets();
+                });
 
         getWindow().setNavigationBarDividerColor(Color.TRANSPARENT);
         if (Build.VERSION.SDK_INT >= 29) {
@@ -549,7 +634,11 @@ public abstract class BaseActivity
             return;
         }
 
-        mInjector.actionModeController.finishActionMode();
+        if (isUseMaterial3FlagEnabled()) {
+            mNavigator.closeSelectionBar();
+        } else {
+            mInjector.actionModeController.finishActionMode();
+        }
         mSortController.onViewModeChanged(mState.derivedMode);
 
         // Set summary header's visibility. Only recents and downloads root may have summary in
@@ -648,6 +737,10 @@ public abstract class BaseActivity
         mNavigator.update();
     }
 
+    public final NavigationViewManager getNavigator() {
+        return mNavigator;
+    }
+
     @Override
     public void restoreRootAndDirectory() {
         // We're trying to restore stuff in document stack from saved instance. If we didn't have a
@@ -683,6 +776,13 @@ public abstract class BaseActivity
         if (roots != null) {
             roots.onCurrentRootChanged();
         }
+        if (isUseMaterial3FlagEnabled()) {
+            final RootsFragment navRailRoots =
+                    RootsFragment.getNavRail(getSupportFragmentManager());
+            if (navRailRoots != null) {
+                navRailRoots.onCurrentRootChanged();
+            }
+        }
 
         String appName = getString(R.string.files_label);
         String currentTitle = getTitle() != null ? getTitle().toString() : "";
@@ -759,8 +859,13 @@ public abstract class BaseActivity
         LocalPreferences.setViewMode(this, getCurrentRoot(), mode);
         mState.derivedMode = mode;
 
-        final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
-        mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
+        // Remove the subMenu when material3 is launched b/379776735.
+        if (isUseMaterial3FlagEnabled()) {
+            mInjector.menuManager.updateSubMenu(null);
+        } else {
+            final ActionMenuView subMenuView = findViewById(R.id.sub_menu);
+            mInjector.menuManager.updateSubMenu(subMenuView.getMenu());
+        }
 
         DirectoryFragment dir = getDirectoryFragment();
         if (dir != null) {
@@ -793,6 +898,7 @@ public abstract class BaseActivity
      * @param shouldHideHeader whether to hide header container or not
      */
     public void updateHeader(boolean shouldHideHeader) {
+        // Remove headContainer when material3 is launched. b/379776735.
         View headerContainer = findViewById(R.id.header_container);
         if (headerContainer == null) {
             updateHeaderTitle();
@@ -840,8 +946,11 @@ public abstract class BaseActivity
                 break;
         }
 
+        // Remove the headerTitle when material3 is launched b/379776735.
         TextView headerTitle = findViewById(R.id.header_title);
-        headerTitle.setText(result);
+        if (headerTitle != null) {
+            headerTitle.setText(result);
+        }
     }
 
     private String getHeaderRecentTitle() {
@@ -1081,4 +1190,19 @@ public abstract class BaseActivity
         }
         setRecentsScreenshotEnabled(!mUserManagerState.areHiddenInQuietModeProfilesPresent());
     }
+
+    /**
+     * When the burger menu is focused, adding a focus ring indicator using Stroke.
+     * TODO(b/381957932): Remove this once Material Button supports focus ring.
+     */
+    private void onBurgerMenuFocusChange(View v, boolean hasFocus) {
+        MaterialButton burgerMenu = (MaterialButton) v;
+        if (hasFocus) {
+            final int focusRingWidth = getResources()
+                    .getDimensionPixelSize(R.dimen.focus_ring_width);
+            burgerMenu.setStrokeWidth(focusRingWidth);
+        } else {
+            burgerMenu.setStrokeWidth(0);
+        }
+    }
 }
diff --git a/src/com/android/documentsui/DragAndDropManager.java b/src/com/android/documentsui/DragAndDropManager.java
index bed8764ae..158d43c95 100644
--- a/src/com/android/documentsui/DragAndDropManager.java
+++ b/src/com/android/documentsui/DragAndDropManager.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.ClipData;
 import android.content.Context;
 import android.graphics.drawable.Drawable;
@@ -277,7 +279,9 @@ public interface DragAndDropManager {
             final Drawable icon;
 
             final int size = srcs.size();
-            if (size == 1) {
+            // If use_material3 flag is ON, we always show the icon/title for the first file even
+            // when we have multiple files.
+            if (size == 1 || isUseMaterial3FlagEnabled()) {
                 DocumentInfo doc = srcs.get(0);
                 title = doc.displayName;
                 icon = iconHelper.getDocumentIcon(mContext, doc);
@@ -287,6 +291,10 @@ public interface DragAndDropManager {
                 icon = mDefaultShadowIcon;
             }
 
+            if (isUseMaterial3FlagEnabled()) {
+                mShadowBuilder.updateDragFileCount(size);
+            }
+
             mShadowBuilder.updateTitle(title);
             mShadowBuilder.updateIcon(icon);
 
diff --git a/src/com/android/documentsui/DragShadowBuilder.java b/src/com/android/documentsui/DragShadowBuilder.java
index 10a0106d5..be76302e8 100644
--- a/src/com/android/documentsui/DragShadowBuilder.java
+++ b/src/com/android/documentsui/DragShadowBuilder.java
@@ -16,7 +16,7 @@
 
 package com.android.documentsui;
 
-import com.android.documentsui.DragAndDropManager.State;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.content.Context;
 import android.graphics.Canvas;
@@ -29,6 +29,12 @@ import android.view.LayoutInflater;
 import android.view.View;
 import android.widget.TextView;
 
+import androidx.annotation.Nullable;
+
+import com.android.documentsui.DragAndDropManager.State;
+
+import java.text.NumberFormat;
+
 class DragShadowBuilder extends View.DragShadowBuilder {
 
     private final View mShadowView;
@@ -37,8 +43,18 @@ class DragShadowBuilder extends View.DragShadowBuilder {
     private final int mWidth;
     private final int mHeight;
     private final int mShadowRadius;
-    private int mPadding;
+    private final int mPadding;
     private Paint paint;
+    // This will be null if use_material3 flag is OFF.
+    private final @Nullable View mAdditionalShadowView;
+    // This will always be 0 if the use_material3 flag is OFF.
+    private int mDragFileCount = 0;
+    // The following 5 dimensions will be 0 if the use_material3 flag is OFF.
+    private final int mDragContentRadius;
+    private final int mAdditionalLayerOffset;
+    private final int mDragFileCounterOffset;
+    private final int mShadow2Radius;
+    private final int mShadowYOffset;
 
     DragShadowBuilder(Context context) {
         mWidth = context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_width);
@@ -49,6 +65,28 @@ class DragShadowBuilder extends View.DragShadowBuilder {
         mShadowView = LayoutInflater.from(context).inflate(R.layout.drag_shadow_layout, null);
         mTitle = (TextView) mShadowView.findViewById(android.R.id.title);
         mIcon = (DropBadgeView) mShadowView.findViewById(android.R.id.icon);
+        if (isUseMaterial3FlagEnabled()) {
+            mAdditionalShadowView =
+                    LayoutInflater.from(context).inflate(R.layout.additional_drag_shadow, null);
+            mDragContentRadius =
+                    context.getResources().getDimensionPixelSize(R.dimen.drag_content_radius);
+            mAdditionalLayerOffset =
+                    context.getResources()
+                            .getDimensionPixelSize(R.dimen.drag_additional_layer_offset);
+            mDragFileCounterOffset =
+                    context.getResources().getDimensionPixelSize(R.dimen.drag_file_counter_offset);
+            mShadow2Radius =
+                    context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_2_radius);
+            mShadowYOffset =
+                    context.getResources().getDimensionPixelSize(R.dimen.drag_shadow_y_offset);
+        } else {
+            mAdditionalShadowView = null;
+            mDragContentRadius = 0;
+            mAdditionalLayerOffset = 0;
+            mDragFileCounterOffset = 0;
+            mShadow2Radius = 0;
+            mShadowYOffset = 0;
+        }
 
         // Important for certain APIs
         mShadowView.setLayerType(View.LAYER_TYPE_SOFTWARE, paint);
@@ -67,23 +105,86 @@ class DragShadowBuilder extends View.DragShadowBuilder {
         Rect r = canvas.getClipBounds();
         // Calling measure is necessary in order for all child views to get correctly laid out.
         mShadowView.measure(
-                View.MeasureSpec.makeMeasureSpec(r.right- r.left, View.MeasureSpec.EXACTLY),
+                View.MeasureSpec.makeMeasureSpec(r.right - r.left, View.MeasureSpec.EXACTLY),
                 View.MeasureSpec.makeMeasureSpec(r.bottom - r.top , View.MeasureSpec.EXACTLY));
         mShadowView.layout(r.left, r.top, r.right, r.bottom);
 
         // Since DragShadow is not an actual view drawn in hardware-accelerated window,
         // android:elevation does not work; we need to draw the shadow ourselves manually.
         paint.setColor(Color.TRANSPARENT);
-        // Shadow 1
-        int opacity = (int) (255 * 0.1);
-        paint.setShadowLayer(mShadowRadius, 0, 0, Color.argb(opacity, 0, 0, 0));
-        canvas.drawRect(r.left + mPadding, r.top + mPadding, r.right - mPadding,
-                r.bottom - mPadding, paint);
-        // Shadow 2
-        opacity = (int) (255 * 0.24);
-        paint.setShadowLayer(mShadowRadius, 0, mShadowRadius, Color.argb(opacity, 0, 0, 0));
-        canvas.drawRect(r.left + mPadding, r.top + mPadding, r.right - mPadding,
-                r.bottom - mPadding, paint);
+
+        // Layers on the canvas (from bottom to top):
+        // 1. Two shadows for the additional drag layer (if drag file count > 1)
+        // 2. The additional layer view itself (if drag file count > 1)
+        // 3. Two shadows for the drag content layer (icon, title)
+        // 4. The drag content layer itself
+        final int shadowOneOpacity = (int) (255 * 0.15);
+        final int shadowTwoOpacity = (int) (255 * 0.30);
+        if (mAdditionalShadowView != null && mDragFileCount > 1) {
+            mAdditionalShadowView.measure(
+                    View.MeasureSpec.makeMeasureSpec(r.right - r.left, View.MeasureSpec.EXACTLY),
+                    View.MeasureSpec.makeMeasureSpec(r.bottom - r.top , View.MeasureSpec.EXACTLY));
+            mAdditionalShadowView.layout(r.left, r.top, r.right, r.bottom);
+            // Shadow 1
+            paint.setShadowLayer(
+                    mShadowRadius, 0, mShadowYOffset, Color.argb(shadowOneOpacity, 0, 0, 0));
+            canvas.drawRoundRect(
+                    r.left + mShadowRadius,
+                    r.top + mDragFileCounterOffset + mAdditionalLayerOffset,
+                    r.right - mDragFileCounterOffset - mAdditionalLayerOffset,
+                    r.bottom - mShadowRadius,
+                    mDragContentRadius,
+                    mDragContentRadius,
+                    paint);
+            // Shadow 2
+            paint.setShadowLayer(
+                    mShadow2Radius, 0, mShadowYOffset, Color.argb(shadowTwoOpacity, 0, 0, 0));
+            canvas.drawRoundRect(
+                    r.left + mShadowRadius,
+                    r.top + mDragFileCounterOffset + mAdditionalLayerOffset,
+                    r.right - mDragFileCounterOffset - mAdditionalLayerOffset,
+                    r.bottom - mShadowRadius,
+                    mDragContentRadius,
+                    mDragContentRadius,
+                    paint);
+            mAdditionalShadowView.draw(canvas);
+        }
+
+        if (isUseMaterial3FlagEnabled()) {
+            // Shadow 1
+            paint.setShadowLayer(
+                    mShadowRadius, 0, mShadowYOffset, Color.argb(shadowOneOpacity, 0, 0, 0));
+            canvas.drawRoundRect(
+                    r.left + mShadowRadius + mAdditionalLayerOffset,
+                    r.top + mDragFileCounterOffset,
+                    r.right - mDragFileCounterOffset,
+                    r.bottom - mShadowRadius - mAdditionalLayerOffset,
+                    mDragContentRadius,
+                    mDragContentRadius,
+                    paint);
+            // Shadow 2
+            paint.setShadowLayer(
+                    mShadow2Radius, 0, mShadowYOffset, Color.argb(shadowTwoOpacity, 0, 0, 0));
+            canvas.drawRoundRect(
+                    r.left + mShadowRadius + mAdditionalLayerOffset,
+                    r.top + mDragFileCounterOffset,
+                    r.right - mDragFileCounterOffset,
+                    r.bottom - mShadowRadius - mAdditionalLayerOffset,
+                    mDragContentRadius,
+                    mDragContentRadius,
+                    paint);
+        } else {
+            // Shadow 1
+            int opacity = (int) (255 * 0.1);
+            paint.setShadowLayer(mShadowRadius, 0, 0, Color.argb(opacity, 0, 0, 0));
+            canvas.drawRect(r.left + mPadding, r.top + mPadding, r.right - mPadding,
+                    r.bottom - mPadding, paint);
+            // Shadow 2
+            opacity = (int) (255 * 0.24);
+            paint.setShadowLayer(mShadowRadius, 0, mShadowRadius, Color.argb(opacity, 0, 0, 0));
+            canvas.drawRect(r.left + mPadding, r.top + mPadding, r.right - mPadding,
+                    r.bottom - mPadding, paint);
+        }
         mShadowView.draw(canvas);
     }
 
@@ -98,4 +199,19 @@ class DragShadowBuilder extends View.DragShadowBuilder {
     void onStateUpdated(@State int state) {
         mIcon.updateState(state);
     }
+
+    void updateDragFileCount(int count) {
+        if (!isUseMaterial3FlagEnabled()) {
+            return;
+        }
+        mDragFileCount = count;
+        TextView dragFileCountView = mShadowView.findViewById(R.id.drag_file_counter);
+        if (dragFileCountView != null) {
+            dragFileCountView.setVisibility(count > 1 ? View.VISIBLE : View.GONE);
+            if (count > 1) {
+                NumberFormat numberFormat = NumberFormat.getInstance();
+                dragFileCountView.setText(numberFormat.format(count));
+            }
+        }
+    }
 }
diff --git a/src/com/android/documentsui/DrawerController.java b/src/com/android/documentsui/DrawerController.java
index 56b3a879f..cc90c9869 100644
--- a/src/com/android/documentsui/DrawerController.java
+++ b/src/com/android/documentsui/DrawerController.java
@@ -17,6 +17,7 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.Activity;
 import android.util.Log;
@@ -59,6 +60,8 @@ public abstract class DrawerController implements DrawerListener {
         }
 
         View drawer = activity.findViewById(R.id.drawer_roots);
+        // This will be null when use_material3 flag is ON, we will check the flag when it's used in
+        // RuntimeDrawerController.
         Toolbar toolbar = (Toolbar) activity.findViewById(R.id.roots_toolbar);
         drawer.getLayoutParams().width = calculateDrawerWidth(activity);
 
@@ -124,7 +127,10 @@ public abstract class DrawerController implements DrawerListener {
 
             if (activityConfig.dragAndDropEnabled()) {
                 View edge = layout.findViewById(R.id.drawer_edge);
-                edge.setOnDragListener(new ItemDragListener<>(this, SPRING_TIMEOUT));
+                // nav_rail_layout also uses DrawerLayout, but it doesn't have drawer edge.
+                if (edge != null) {
+                    edge.setOnDragListener(new ItemDragListener<>(this, SPRING_TIMEOUT));
+                }
             }
         }
 
@@ -202,7 +208,9 @@ public abstract class DrawerController implements DrawerListener {
 
         @Override
         void setTitle(String title) {
-            mToolbar.setTitle(title);
+            if (!isUseMaterial3FlagEnabled()) {
+                mToolbar.setTitle(title);
+            }
         }
 
         @Override
diff --git a/src/com/android/documentsui/HorizontalBreadcrumb.java b/src/com/android/documentsui/HorizontalBreadcrumb.java
index 94f0e13f9..9d2fc723e 100644
--- a/src/com/android/documentsui/HorizontalBreadcrumb.java
+++ b/src/com/android/documentsui/HorizontalBreadcrumb.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
 import android.util.AttributeSet;
 import android.view.GestureDetector;
@@ -25,6 +27,7 @@ import android.view.MotionEvent;
 import android.view.View;
 import android.view.ViewGroup;
 
+import androidx.annotation.Nullable;
 import androidx.recyclerview.widget.LinearLayoutManager;
 import androidx.recyclerview.widget.RecyclerView;
 
@@ -45,6 +48,9 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
     private LinearLayoutManager mLayoutManager;
     private BreadcrumbAdapter mAdapter;
     private IntConsumer mClickListener;
+    // Represents the top divider (border) of the breadcrumb on the compact size screen.
+    // It will be null on other screen sizes, or when the use_material3 flag is OFF.
+    private @Nullable View mTopDividerView;
 
     public HorizontalBreadcrumb(Context context, AttributeSet attrs, int defStyleAttr) {
         super(context, attrs, defStyleAttr);
@@ -61,12 +67,14 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
     @Override
     public void setup(Environment env,
             com.android.documentsui.base.State state,
-            IntConsumer listener) {
+            IntConsumer listener,
+            @Nullable View topDivider) {
 
         mClickListener = listener;
         mLayoutManager = new HorizontalBreadcrumbLinearLayoutManager(
                 getContext(), LinearLayoutManager.HORIZONTAL, false);
         mAdapter = new BreadcrumbAdapter(state, env, this::onKey);
+        mTopDividerView = topDivider;
         // Since we are using GestureDetector to detect click events, a11y services don't know which
         // views are clickable because we aren't using View.OnClickListener. Thus, we need to use a
         // custom accessibility delegate to route click events correctly.
@@ -109,6 +117,9 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
             setVisibility(GONE);
             setAdapter(null);
         }
+        if (mTopDividerView != null) {
+            mTopDividerView.setVisibility(visibility ? VISIBLE : GONE);
+        }
         mAdapter.updateLastItemSize();
     }
 
@@ -174,8 +185,6 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
 
         @Override
         public void onBindViewHolder(BreadcrumbHolder holder, int position) {
-            final int padding = (int) holder.itemView.getResources()
-                    .getDimension(R.dimen.breadcrumb_item_padding);
             final boolean isFirst = position == 0;
             // Note that when isFirst is true, there might not be a DocumentInfo on the stack as it
             // could be an error state screen accessible from the root info.
@@ -183,9 +192,45 @@ public final class HorizontalBreadcrumb extends RecyclerView implements Breadcru
 
             holder.mTitle.setText(
                     isFirst ? mEnv.getCurrentRoot().title : mState.stack.get(position).displayName);
-            holder.mTitle.setEnabled(isLast);
-            holder.mTitle.setPadding(isFirst ? padding * 3 : padding,
-                    padding, isLast ? padding * 2 : padding, padding);
+            if (isUseMaterial3FlagEnabled()) {
+                // The last path part in the breadcrumb is not clickable.
+                holder.mTitle.setEnabled(!isLast);
+            } else {
+                holder.mTitle.setEnabled(isLast);
+            }
+            if (isUseMaterial3FlagEnabled()) {
+                final int paddingHorizontal =
+                        (int)
+                                holder.itemView
+                                        .getResources()
+                                        .getDimension(R.dimen.breadcrumb_item_padding_horizontal);
+                final int paddingVertical =
+                        (int)
+                                holder.itemView
+                                        .getResources()
+                                        .getDimension(R.dimen.breadcrumb_item_padding_vertical);
+                final int arrowPadding =
+                        (int)
+                                holder.itemView
+                                        .getResources()
+                                        .getDimension(R.dimen.breadcrumb_item_arrow_padding);
+                holder.mTitle.setPadding(
+                        paddingHorizontal, paddingVertical, paddingHorizontal, paddingVertical);
+
+                ViewGroup.MarginLayoutParams params =
+                        (ViewGroup.MarginLayoutParams) holder.mArrow.getLayoutParams();
+                params.setMarginStart(arrowPadding);
+                params.setMarginEnd(arrowPadding);
+                holder.mArrow.setLayoutParams(params);
+            } else {
+                final int padding = (int) holder.itemView.getResources()
+                        .getDimension(R.dimen.breadcrumb_item_padding);
+                holder.mTitle.setPadding(
+                        isFirst ? padding * 3 : padding,
+                        padding,
+                        isLast ? padding * 2 : padding,
+                        padding);
+            }
             holder.mArrow.setVisibility(isLast ? View.GONE : View.VISIBLE);
 
             holder.itemView.setOnKeyListener(mClickListener);
diff --git a/src/com/android/documentsui/IconUtils.java b/src/com/android/documentsui/IconUtils.java
index 1763fd2a3..477209150 100644
--- a/src/com/android/documentsui/IconUtils.java
+++ b/src/com/android/documentsui/IconUtils.java
@@ -16,15 +16,56 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
 import android.content.pm.PackageManager;
 import android.content.pm.ProviderInfo;
+import android.content.res.Resources;
+import android.graphics.Outline;
 import android.graphics.drawable.Drawable;
+import android.graphics.drawable.Icon;
 import android.util.TypedValue;
+import android.view.View;
+import android.view.ViewOutlineProvider;
+import android.widget.ImageView;
 
 import com.android.documentsui.base.UserId;
+import com.android.documentsui.util.ColorUtils;
+
+import java.util.HashMap;
+import java.util.Map;
 
 public class IconUtils {
+    // key: drawable resource id, value: color attribute id
+    private static final Map<Integer, Integer> sCustomIconColorMap = new HashMap<>();
+
+    static {
+        if (isUseMaterial3FlagEnabled()) {
+            // Use Resources.getSystem().getIdentifier() here instead of R.drawable.ic_doc_folder
+            // because com.android.internal.R is not public.
+            sCustomIconColorMap.put(
+                    Resources.getSystem().getIdentifier("ic_doc_folder", "drawable", "android"),
+                    com.google.android.material.R.attr.colorPrimaryFixedDim);
+            sCustomIconColorMap.put(
+                    Resources.getSystem().getIdentifier("ic_doc_generic", "drawable", "android"),
+                    com.google.android.material.R.attr.colorOutline);
+            sCustomIconColorMap.put(
+                    Resources.getSystem()
+                            .getIdentifier("ic_doc_certificate", "drawable", "android"),
+                    com.google.android.material.R.attr.colorOutline);
+            sCustomIconColorMap.put(
+                    Resources.getSystem().getIdentifier("ic_doc_codes", "drawable", "android"),
+                    com.google.android.material.R.attr.colorOutline);
+            sCustomIconColorMap.put(
+                    Resources.getSystem().getIdentifier("ic_doc_contact", "drawable", "android"),
+                    com.google.android.material.R.attr.colorOutline);
+            sCustomIconColorMap.put(
+                    Resources.getSystem().getIdentifier("ic_doc_font", "drawable", "android"),
+                    com.google.android.material.R.attr.colorOutline);
+        }
+    }
+
     public static Drawable loadPackageIcon(Context context, UserId userId, String authority,
             int icon, boolean maybeShowBadge) {
         if (icon != 0) {
@@ -61,7 +102,17 @@ public class IconUtils {
      */
     public static Drawable loadMimeIcon(Context context, String mimeType) {
         if (mimeType == null) return null;
-        return context.getContentResolver().getTypeInfo(mimeType).getIcon().loadDrawable(context);
+        Icon icon = context.getContentResolver().getTypeInfo(mimeType).getIcon();
+        Drawable drawable = icon.loadDrawable(context);
+        // TODO(b/400263417): Remove this once RRO mime icons support dynamic colors.
+        if (isUseMaterial3FlagEnabled()
+                && drawable != null
+                && sCustomIconColorMap.containsKey(icon.getResId())) {
+            drawable.setTint(
+                    ColorUtils.resolveMaterialColorAttribute(
+                            context, sCustomIconColorMap.get(icon.getResId())));
+        }
+        return drawable;
     }
 
     public static Drawable applyTintColor(Context context, int drawableId, int tintColorId) {
@@ -80,4 +131,32 @@ public class IconUtils {
         context.getTheme().resolveAttribute(tintAttrId, outValue, true);
         return applyTintColor(context, drawableId, outValue.resourceId);
     }
+
+    /**
+     * When a ImageView loads a thumbnail from a bitmap, we usually uses a CardView to wrap it to
+     * apply CardView's corner radius to the ImageView. This causes the corner pixelation of the
+     * thumbnail especially when there's a border (stroke) around the CardView. This method creates
+     * a custom clip outline with the correct shape to fix this issue.
+     *
+     * @param imageView ImageView to apply clip outline.
+     * @param strokeWidth stroke width of the thumbnail.
+     * @param cornerRadius corner radius of the thumbnail.
+     */
+    public static void applyThumbnailClipOutline(
+            ImageView imageView, int strokeWidth, int cornerRadius) {
+        ViewOutlineProvider outlineProvider =
+                new ViewOutlineProvider() {
+                    @Override
+                    public void getOutline(View view, Outline outline) {
+                        outline.setRoundRect(
+                                strokeWidth,
+                                strokeWidth,
+                                view.getWidth() - strokeWidth,
+                                view.getHeight() - strokeWidth,
+                                cornerRadius);
+                    }
+                };
+        imageView.setOutlineProvider(outlineProvider);
+        imageView.setClipToOutline(true);
+    }
 }
diff --git a/src/com/android/documentsui/Injector.java b/src/com/android/documentsui/Injector.java
index 82cbfcccb..6b68ba1f1 100644
--- a/src/com/android/documentsui/Injector.java
+++ b/src/com/android/documentsui/Injector.java
@@ -15,6 +15,8 @@
  */
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import static java.lang.annotation.ElementType.FIELD;
 import static java.lang.annotation.RetentionPolicy.SOURCE;
 
@@ -127,6 +129,9 @@ public class Injector<T extends ActionHandler> {
 
     public final ActionModeController getActionModeController(
             SelectionDetails selectionDetails, EventHandler<MenuItem> menuItemClicker) {
+        if (isUseMaterial3FlagEnabled()) {
+            return null;
+        }
         return actionModeController.reset(selectionDetails, menuItemClicker);
     }
 
diff --git a/src/com/android/documentsui/JobPanelController.kt b/src/com/android/documentsui/JobPanelController.kt
new file mode 100644
index 000000000..a8ab8b0a4
--- /dev/null
+++ b/src/com/android/documentsui/JobPanelController.kt
@@ -0,0 +1,150 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.content.BroadcastReceiver
+import android.content.Context
+import android.content.Intent
+import android.content.IntentFilter
+import android.util.Log
+import android.view.LayoutInflater
+import android.view.MenuItem
+import android.view.ViewGroup
+import android.widget.PopupWindow
+import android.widget.ProgressBar
+import com.android.documentsui.base.Menus
+import com.android.documentsui.services.FileOperationService
+import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
+import com.android.documentsui.services.Job
+import com.android.documentsui.services.JobProgress
+
+/**
+ * JobPanelController is responsible for receiving broadcast updates from the [FileOperationService]
+ * and updating a given menu item to reflect the current progress.
+ */
+class JobPanelController(private val mContext: Context) : BroadcastReceiver() {
+    companion object {
+        private const val TAG = "JobPanelController"
+        private const val MAX_PROGRESS = 100
+    }
+
+    private enum class State {
+        INVISIBLE, INDETERMINATE, VISIBLE
+    }
+
+    /** The current state of the menu progress item. */
+    private var mState = State.INVISIBLE
+
+    /** The total progress from 0 to MAX_PROGRESS. */
+    private var mTotalProgress = 0
+
+    /** List of jobs currently tracked by this class. */
+    private val mCurrentJobs = LinkedHashMap<String, JobProgress>()
+
+    /** Current menu item being controlled by this class. */
+    private var mMenuItem: MenuItem? = null
+
+    init {
+        val filter = IntentFilter(FileOperationService.ACTION_PROGRESS)
+        mContext.registerReceiver(this, filter, Context.RECEIVER_NOT_EXPORTED)
+    }
+
+    private fun updateMenuItem(animate: Boolean) {
+        mMenuItem?.let {
+            Menus.setEnabledAndVisible(it, mState != State.INVISIBLE)
+            val icon = it.actionView as ProgressBar
+            when (mState) {
+                State.INDETERMINATE -> icon.isIndeterminate = true
+                State.VISIBLE -> icon.apply {
+                    isIndeterminate = false
+                    setProgress(mTotalProgress, animate)
+                }
+                State.INVISIBLE -> {}
+            }
+        }
+    }
+
+    /**
+     * Sets the menu item controlled by this class. The item's actionView must be a [ProgressBar].
+     */
+    @Suppress("ktlint:standard:comment-wrapping")
+    fun setMenuItem(menuItem: MenuItem) {
+        val progressIcon = menuItem.actionView as ProgressBar
+        progressIcon.max = MAX_PROGRESS
+        progressIcon.setOnClickListener { view ->
+            val panel = LayoutInflater.from(mContext).inflate(
+                R.layout.job_progress_panel,
+                /* root= */ null
+            )
+            val popupWidth = mContext.resources.getDimension(R.dimen.job_progress_panel_width) +
+                    mContext.resources.getDimension(R.dimen.job_progress_panel_margin)
+            val popup = PopupWindow(
+                /* contentView= */ panel,
+                /* width= */ popupWidth.toInt(),
+                /* height= */ ViewGroup.LayoutParams.WRAP_CONTENT,
+                /* focusable= */ true
+            )
+            popup.showAsDropDown(
+                /* anchor= */ view,
+                /* xoff= */ view.width - popupWidth.toInt(),
+                /* yoff= */ 0
+            )
+        }
+        mMenuItem = menuItem
+        updateMenuItem(animate = false)
+    }
+
+    override fun onReceive(context: Context?, intent: Intent) {
+        val progresses = intent.getParcelableArrayListExtra<JobProgress>(
+            EXTRA_PROGRESS,
+            JobProgress::class.java
+        )
+        updateProgress(progresses!!)
+    }
+
+    private fun updateProgress(progresses: List<JobProgress>) {
+        var requiredBytes = 0L
+        var currentBytes = 0L
+        var allFinished = true
+
+        for (jobProgress in progresses) {
+            Log.d(TAG, "Received $jobProgress")
+            mCurrentJobs.put(jobProgress.id, jobProgress)
+        }
+        for (jobProgress in mCurrentJobs.values) {
+            if (jobProgress.state != Job.STATE_COMPLETED) {
+                allFinished = false
+            }
+            if (jobProgress.requiredBytes != -1L && jobProgress.currentBytes != -1L) {
+                requiredBytes += jobProgress.requiredBytes
+                currentBytes += jobProgress.currentBytes
+            }
+        }
+
+        if (mCurrentJobs.isEmpty()) {
+            mState = State.INVISIBLE
+        } else if (requiredBytes != 0L) {
+            mState = State.VISIBLE
+            mTotalProgress = (MAX_PROGRESS * currentBytes / requiredBytes).toInt()
+        } else if (allFinished) {
+            mState = State.VISIBLE
+            mTotalProgress = MAX_PROGRESS
+        } else {
+            mState = State.INDETERMINATE
+        }
+        updateMenuItem(animate = true)
+    }
+}
diff --git a/src/com/android/documentsui/MenuManager.java b/src/com/android/documentsui/MenuManager.java
index f46ffe482..a46659c77 100644
--- a/src/com/android/documentsui/MenuManager.java
+++ b/src/com/android/documentsui/MenuManager.java
@@ -16,15 +16,20 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+
 import android.view.KeyboardShortcutGroup;
 import android.view.Menu;
 import android.view.MenuInflater;
 import android.view.MenuItem;
 import android.view.View;
 
+import androidx.annotation.NonNull;
 import androidx.annotation.VisibleForTesting;
 import androidx.fragment.app.Fragment;
 
+import com.android.documentsui.archives.ArchivesProvider;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Menus;
 import com.android.documentsui.base.RootInfo;
@@ -89,6 +94,9 @@ public abstract class MenuManager {
             return;
         }
         updateCreateDir(mOptionMenu.findItem(R.id.option_menu_create_dir));
+        if (isZipNgFlagEnabled()) {
+            updateExtractAll(mOptionMenu.findItem(R.id.option_menu_extract_all));
+        }
         updateSettings(mOptionMenu.findItem(R.id.option_menu_settings));
         updateSelectAll(mOptionMenu.findItem(R.id.option_menu_select_all));
         updateNewWindow(mOptionMenu.findItem(R.id.option_menu_new_window));
@@ -98,12 +106,25 @@ public abstract class MenuManager {
         updateLauncher(mOptionMenu.findItem(R.id.option_menu_launcher));
         updateShowHiddenFiles(mOptionMenu.findItem(R.id.option_menu_show_hidden_files));
 
+        if (isUseMaterial3FlagEnabled()) {
+            updateModePicker(mOptionMenu.findItem(R.id.sub_menu_grid),
+                    mOptionMenu.findItem(R.id.sub_menu_list));
+        }
+
         Menus.disableHiddenItems(mOptionMenu);
         mSearchManager.updateMenu();
     }
 
     public void updateSubMenu(Menu menu) {
+        // Remove the subMenu when material3 is launched b/379776735.
+        if (isUseMaterial3FlagEnabled()) {
+            menu = mOptionMenu;
+            if (menu == null) {
+                return;
+            }
+        }
         updateModePicker(menu.findItem(R.id.sub_menu_grid), menu.findItem(R.id.sub_menu_list));
+
     }
 
     public void updateModel(Model model) {}
@@ -138,11 +159,11 @@ public abstract class MenuManager {
     }
 
     /**
-     * @see DirectoryFragment#onCreateContextMenu
-     *
      * Called when user tries to generate a context menu anchored to a file when the selection
      * doesn't contain any folder.
      *
+     * @see DirectoryFragment#onCreateContextMenu
+     *
      * @param selectionDetails
      *      containsFiles may return false because this may be called when user right clicks on an
      *      unselectable item in pickers
@@ -163,15 +184,20 @@ public abstract class MenuManager {
         updateRename(rename, selectionDetails);
         updateViewInOwner(viewInOwner, selectionDetails);
 
+        if (isZipNgFlagEnabled()) {
+            updateExtractHere(menu.findItem(R.id.dir_menu_extract_here), selectionDetails);
+            updateBrowse(menu.findItem(R.id.dir_menu_browse), selectionDetails);
+        }
+
         updateContextMenu(menu, selectionDetails);
     }
 
     /**
-     * @see DirectoryFragment#onCreateContextMenu
-     *
      * Called when user tries to generate a context menu anchored to a folder when the selection
      * doesn't contain any file.
      *
+     * @see DirectoryFragment#onCreateContextMenu
+     *
      * @param selectionDetails
      *      containDirectories may return false because this may be called when user right clicks on
      *      an unselectable item in pickers
@@ -214,10 +240,7 @@ public abstract class MenuManager {
 
         Menus.setEnabledAndVisible(inspect, selectionDetails.size() == 1);
 
-        final MenuItem compress = menu.findItem(R.id.dir_menu_compress);
-        if (compress != null) {
-            updateCompress(compress, selectionDetails);
-        }
+        updateCompress(menu.findItem(R.id.dir_menu_compress), selectionDetails);
     }
 
     /**
@@ -259,6 +282,15 @@ public abstract class MenuManager {
     public abstract void updateKeyboardShortcutsMenu(
             List<KeyboardShortcutGroup> data, IntFunction<String> stringSupplier);
 
+    /**
+     * Called on option menu creation to instantiate the job progress item if applicable.
+     *
+     * @param menu The option menu created.
+     */
+    public void instantiateJobProgress(Menu menu) {
+        // This icon is not shown in the picker.
+    }
+
     protected void updateModePicker(MenuItem grid, MenuItem list) {
         // The order of enabling disabling menu item in wrong order removed accessibility focus.
         if (mState.derivedMode != State.MODE_LIST) {
@@ -366,6 +398,14 @@ public abstract class MenuManager {
         Menus.setEnabledAndVisible(extractTo, false);
     }
 
+    protected void updateExtractHere(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
+        Menus.setEnabledAndVisible(it, false);
+    }
+
+    protected void updateBrowse(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
+        Menus.setEnabledAndVisible(it, false);
+    }
+
     protected void updatePasteInto(MenuItem pasteInto, SelectionDetails selectionDetails) {
         Menus.setEnabledAndVisible(pasteInto, false);
     }
@@ -382,26 +422,47 @@ public abstract class MenuManager {
         Menus.setEnabledAndVisible(launcher, false);
     }
 
+    protected void updateExtractAll(MenuItem it) {
+        Menus.setEnabledAndVisible(it, false);
+    }
+
     protected abstract void updateSelectAll(MenuItem selectAll);
+
     protected abstract void updateSelectAll(MenuItem selectAll, SelectionDetails selectionDetails);
+
     protected abstract void updateDeselectAll(
             MenuItem deselectAll, SelectionDetails selectionDetails);
+
     protected abstract void updateCreateDir(MenuItem createDir);
 
     /**
      * Access to meta data about the selection.
      */
     public interface SelectionDetails {
+        /** Gets the total number of items (files and directories) in the selection. */
+        int size();
+
+        /** Returns whether the selection contains at least a directory. */
         boolean containsDirectories();
 
+        /** Returns whether the selection contains at least a file. */
         boolean containsFiles();
 
-        int size();
-
+        /**
+         * Returns whether the selection contains at least a file that has not been fully downloaded
+         * yet.
+         */
         boolean containsPartialFiles();
 
+        /** Returns whether the selection contains at least a file located in a mounted archive. */
         boolean containsFilesInArchive();
 
+        /**
+         * Returns whether the selection contains exactly one file which is also a supported archive
+         * type.
+         */
+        boolean isArchive();
+
         // TODO: Update these to express characteristics instead of answering concrete questions,
         // since the answer to those questions is (or can be) activity specific.
         boolean canDelete();
@@ -412,7 +473,7 @@ public abstract class MenuManager {
 
         boolean canExtract();
 
-        boolean canOpenWith();
+        boolean canOpen();
 
         boolean canViewInOwner();
     }
@@ -440,6 +501,12 @@ public abstract class MenuManager {
             return mActivity.isInRecents();
         }
 
+        /** Is the current directory showing the contents of an archive? */
+        public boolean isInArchive() {
+            final DocumentInfo dir = mActivity.getCurrentDirectory();
+            return dir != null && ArchivesProvider.AUTHORITY.equals(dir.authority);
+        }
+
         public boolean canCreateDirectory() {
             return mActivity.canCreateDirectory();
         }
diff --git a/src/com/android/documentsui/MultiRootDocumentsLoader.java b/src/com/android/documentsui/MultiRootDocumentsLoader.java
index db78daa48..1213a6711 100644
--- a/src/com/android/documentsui/MultiRootDocumentsLoader.java
+++ b/src/com/android/documentsui/MultiRootDocumentsLoader.java
@@ -71,7 +71,7 @@ public abstract class MultiRootDocumentsLoader extends AsyncTaskLoader<Directory
     // previously returned cursors for filtering/sorting; this currently races
     // with the UI thread.
 
-    private static final int MAX_OUTSTANDING_TASK = 4;
+    public static final int MAX_OUTSTANDING_TASK = 4;
     private static final int MAX_OUTSTANDING_TASK_SVELTE = 2;
 
     /**
diff --git a/src/com/android/documentsui/NavigationViewManager.java b/src/com/android/documentsui/NavigationViewManager.java
index c376c86db..bbae22d42 100644
--- a/src/com/android/documentsui/NavigationViewManager.java
+++ b/src/com/android/documentsui/NavigationViewManager.java
@@ -17,6 +17,8 @@
 package com.android.documentsui;
 
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
 
 import android.content.res.Resources;
 import android.content.res.TypedArray;
@@ -24,17 +26,21 @@ import android.graphics.Outline;
 import android.graphics.drawable.ColorDrawable;
 import android.graphics.drawable.Drawable;
 import android.util.Log;
+import android.view.MenuItem;
 import android.view.View;
+import android.view.ViewGroup;
 import android.view.ViewOutlineProvider;
 import android.view.Window;
 import android.view.WindowManager;
-import android.widget.FrameLayout;
 
 import androidx.annotation.ColorRes;
 import androidx.annotation.Nullable;
 import androidx.appcompat.widget.Toolbar;
 import androidx.core.content.ContextCompat;
+import androidx.recyclerview.selection.SelectionTracker;
 
+import com.android.documentsui.Injector.Injected;
+import com.android.documentsui.base.EventHandler;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
@@ -47,10 +53,9 @@ import com.google.android.material.appbar.CollapsingToolbarLayout;
 
 import java.util.function.IntConsumer;
 
-/**
- * A facade over the portions of the app and drawer toolbars.
- */
-public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListener {
+/** A facade over the portions of the app and drawer toolbars. */
+public class NavigationViewManager extends SelectionTracker.SelectionObserver<String>
+        implements AppBarLayout.OnOffsetChangedListener {
 
     private static final String TAG = "NavigationViewManager";
 
@@ -69,10 +74,11 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
     private final ViewOutlineProvider mSearchBarOutlineProvider;
     private final boolean mShowSearchBar;
     private final ConfigStore mConfigStore;
-
+    @Injected private final Injector<?> mInjector;
     private boolean mIsActionModeActivated = false;
-    @ColorRes
-    private int mDefaultStatusBarColorResId;
+    @ColorRes private int mDefaultStatusBarColorResId;
+    private MenuManager.SelectionDetails mSelectionDetails;
+    private EventHandler<MenuItem> mActionMenuItemClicker;
 
     public NavigationViewManager(
             BaseActivity activity,
@@ -82,9 +88,19 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
             Breadcrumb breadcrumb,
             View tabLayoutContainer,
             UserIdManager userIdManager,
-            ConfigStore configStore) {
-        this(activity, drawer, state, env, breadcrumb, tabLayoutContainer, userIdManager, null,
-                configStore);
+            ConfigStore configStore,
+            Injector injector) {
+        this(
+                activity,
+                drawer,
+                state,
+                env,
+                breadcrumb,
+                tabLayoutContainer,
+                userIdManager,
+                null,
+                configStore,
+                injector);
     }
 
     public NavigationViewManager(
@@ -95,9 +111,19 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
             Breadcrumb breadcrumb,
             View tabLayoutContainer,
             UserManagerState userManagerState,
-            ConfigStore configStore) {
-        this(activity, drawer, state, env, breadcrumb, tabLayoutContainer, null, userManagerState,
-                configStore);
+            ConfigStore configStore,
+            Injector injector) {
+        this(
+                activity,
+                drawer,
+                state,
+                env,
+                breadcrumb,
+                tabLayoutContainer,
+                null,
+                userManagerState,
+                configStore,
+                injector);
     }
 
     public NavigationViewManager(
@@ -109,7 +135,8 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
             View tabLayoutContainer,
             UserIdManager userIdManager,
             UserManagerState userManagerState,
-            ConfigStore configStore) {
+            ConfigStore configStore,
+            Injector injector) {
 
         mActivity = activity;
         mToolbar = activity.findViewById(R.id.toolbar);
@@ -118,8 +145,15 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
         mState = state;
         mEnv = env;
         mBreadcrumb = breadcrumb;
-        mBreadcrumb.setup(env, state, this::onNavigationItemSelected);
+        mBreadcrumb.setup(
+                env,
+                state,
+                this::onNavigationItemSelected,
+                isUseMaterial3FlagEnabled()
+                        ? activity.findViewById(R.id.breadcrumb_top_divider)
+                        : null);
         mConfigStore = configStore;
+        mInjector = injector;
         mProfileTabs =
                 getProfileTabs(tabLayoutContainer, userIdManager, userManagerState, activity);
 
@@ -130,6 +164,15 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
                         onNavigationIconClicked();
                     }
                 });
+        if (isUseMaterial3FlagEnabled()) {
+            mToolbar.setOnMenuItemClickListener(
+                    new Toolbar.OnMenuItemClickListener() {
+                        @Override
+                        public boolean onMenuItemClick(MenuItem menuItem) {
+                            return onToolbarMenuItemClicked(menuItem);
+                        }
+                    });
+        }
         mSearchBarView = activity.findViewById(R.id.searchbar_title);
         mCollapsingBarLayout = activity.findViewById(R.id.collapsing_toolbar);
         mDefaultActionBarBackground = mToolbar.getBackground();
@@ -225,11 +268,21 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
     }
 
     private void onNavigationIconClicked() {
-        if (mDrawer.isPresent()) {
+        if (isUseMaterial3FlagEnabled() && inSelectionMode()) {
+            closeSelectionBar();
+        } else if (mDrawer.isPresent()) {
             mDrawer.setOpen(true);
         }
     }
 
+    private boolean onToolbarMenuItemClicked(MenuItem menuItem) {
+        if (inSelectionMode()) {
+            mActionMenuItemClicker.accept(menuItem);
+            return true;
+        }
+        return mActivity.onOptionsItemSelected(menuItem);
+    }
+
     void onNavigationItemSelected(int position) {
         boolean changed = false;
         while (mState.stack.size() > position + 1) {
@@ -251,7 +304,10 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
     }
 
     public void update() {
-        updateScrollFlag();
+        // If use_material3 flag is ON, we don't want any scroll behavior, thus skipping this logic.
+        if (!isUseMaterial3FlagEnabled()) {
+            updateScrollFlag();
+        }
         updateToolbar();
         mProfileTabs.updateView();
 
@@ -264,22 +320,110 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
 
         mDrawer.setTitle(mEnv.getDrawerTitle());
 
-        mToolbar.setNavigationIcon(getActionBarIcon());
-        mToolbar.setNavigationContentDescription(R.string.drawer_open);
+        boolean showBurgerMenuOnToolbar = true;
+        if (isUseMaterial3FlagEnabled()) {
+            View navRailRoots = mActivity.findViewById(R.id.nav_rail_container_roots);
+            if (navRailRoots != null) {
+                // If nav rail exists, burger menu will show on the nav rail instead.
+                showBurgerMenuOnToolbar = false;
+            }
+        }
+
+        if (showBurgerMenuOnToolbar) {
+            mToolbar.setNavigationIcon(getActionBarIcon());
+            mToolbar.setNavigationContentDescription(R.string.drawer_open);
+        } else {
+            mToolbar.setNavigationIcon(null);
+            mToolbar.setNavigationContentDescription(null);
+        }
 
         if (shouldShowSearchBar()) {
             mBreadcrumb.show(false);
             mToolbar.setTitle(null);
             mSearchBarView.setVisibility(View.VISIBLE);
-        } else {
-            mSearchBarView.setVisibility(View.GONE);
-            String title = mState.stack.size() <= 1
-                    ? mEnv.getCurrentRoot().title : mState.stack.getTitle();
-            if (VERBOSE) Log.v(TAG, "New toolbar title is: " + title);
-            mToolbar.setTitle(title);
-            mBreadcrumb.show(true);
-            mBreadcrumb.postUpdate();
+            return;
         }
+
+        mSearchBarView.setVisibility(View.GONE);
+
+        if (isUseMaterial3FlagEnabled()) {
+            updateActionMenu();
+            if (inSelectionMode()) {
+                final int quantity = mInjector.selectionMgr.getSelection().size();
+                final String title =
+                        mToolbar.getContext()
+                                .getResources()
+                                .getQuantityString(R.plurals.elements_selected, quantity, quantity);
+                mToolbar.setTitle(title);
+                mActivity.getWindow().setTitle(title);
+                mToolbar.setNavigationIcon(R.drawable.ic_cancel);
+                mToolbar.setNavigationContentDescription(android.R.string.cancel);
+                return;
+            }
+        }
+
+        String title =
+                mState.stack.size() <= 1 ? mEnv.getCurrentRoot().title : mState.stack.getTitle();
+        if (VERBOSE) Log.v(TAG, "New toolbar title is: " + title);
+        mToolbar.setTitle(title);
+        mBreadcrumb.show(true);
+        mBreadcrumb.postUpdate();
+    }
+
+    @Override
+    public void onSelectionChanged() {
+        update();
+    }
+
+    /** Identifies if the `NavigationViewManager` is in selection mode or not. */
+    public boolean inSelectionMode() {
+        return mInjector != null
+                && mInjector.selectionMgr != null
+                && mInjector.selectionMgr.hasSelection();
+    }
+
+    private boolean hasActionMenu() {
+        return mToolbar.getMenu().findItem(R.id.action_menu_open_with) != null;
+    }
+
+    /** Updates the action menu based on whether a selection is currently being made or not. */
+    public void updateActionMenu() {
+        // For the first start up of the application, the menu might not exist at all but we also
+        // don't want to inflate the menu multiple times. So along with checking if the expected
+        // menu is already inflated, validate that a menu exists at all as well.
+        boolean isMenuInflated = mToolbar.getMenu() != null && mToolbar.getMenu().size() > 0;
+        if (inSelectionMode()) {
+            if (!isMenuInflated || !hasActionMenu()) {
+                mToolbar.getMenu().clear();
+                mToolbar.inflateMenu(R.menu.action_mode_menu);
+                mToolbar.invalidateMenu();
+            }
+            mInjector.menuManager.updateActionMenu(mToolbar.getMenu(), mSelectionDetails);
+            return;
+        }
+
+        if (!isMenuInflated || hasActionMenu()) {
+            mToolbar.getMenu().clear();
+            mToolbar.inflateMenu(R.menu.activity);
+            mToolbar.invalidateMenu();
+            boolean fullBarSearch =
+                    mActivity.getResources().getBoolean(R.bool.full_bar_search_view);
+            boolean showSearchBar = mActivity.getResources().getBoolean(R.bool.show_search_bar);
+            mInjector.searchManager.install(mToolbar.getMenu(), fullBarSearch, showSearchBar);
+            if (isVisualSignalsFlagEnabled()) {
+                mInjector.menuManager.instantiateJobProgress(mToolbar.getMenu());
+            }
+        }
+        mInjector.menuManager.updateOptionMenu(mToolbar.getMenu());
+        mInjector.searchManager.showMenu(mState.stack);
+    }
+
+    /** Everytime a selection is made, update the selection. */
+    public void updateSelection(
+            MenuManager.SelectionDetails selectionDetails,
+            EventHandler<MenuItem> actionMenuItemClicker) {
+        mSelectionDetails = selectionDetails;
+        mActionMenuItemClicker = actionMenuItemClicker;
     }
 
     private void updateScrollFlag() {
@@ -336,8 +480,11 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
         }
 
         if (!mIsActionModeActivated) {
-            FrameLayout.LayoutParams headerLayoutParams =
-                    (FrameLayout.LayoutParams) mHeader.getLayoutParams();
+            // This could be either FrameLayout.LayoutParams (when use_material3 flag is OFF) or
+            // LinearLayout.LayoutParams (when use_material3 flag is ON), so use the common parent
+            // class instead to make it work for both scenarios.
+            ViewGroup.MarginLayoutParams headerLayoutParams =
+                    (ViewGroup.MarginLayoutParams) mHeader.getLayoutParams();
             headerLayoutParams.setMargins(0, /* top= */ headerTopOffset, 0, 0);
             mHeader.setLayoutParams(headerLayoutParams);
         }
@@ -361,8 +508,13 @@ public class NavigationViewManager implements AppBarLayout.OnOffsetChangedListen
         mDrawer.setOpen(open);
     }
 
+    /** Helper method to close the selection bar. */
+    public void closeSelectionBar() {
+        mInjector.selectionMgr.clearSelection();
+    }
+
     interface Breadcrumb {
-        void setup(Environment env, State state, IntConsumer listener);
+        void setup(Environment env, State state, IntConsumer listener, @Nullable View topDivider);
 
         void show(boolean visibility);
 
diff --git a/src/com/android/documentsui/ProfileTabs.java b/src/com/android/documentsui/ProfileTabs.java
index df525d527..74db6f4bd 100644
--- a/src/com/android/documentsui/ProfileTabs.java
+++ b/src/com/android/documentsui/ProfileTabs.java
@@ -20,6 +20,7 @@ import static androidx.core.util.Preconditions.checkNotNull;
 
 import static com.android.documentsui.DevicePolicyResources.Strings.PERSONAL_TAB;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.admin.DevicePolicyManager;
 import android.os.Build;
@@ -155,7 +156,17 @@ public class ProfileTabs implements ProfileTabsAddons {
                         (ViewGroup.MarginLayoutParams) tab.getLayoutParams();
                 int tabMarginSide = (int) mTabsContainer.getContext().getResources()
                         .getDimension(R.dimen.profile_tab_margin_side);
-                marginLayoutParams.setMargins(tabMarginSide, 0, tabMarginSide, 0);
+                if (isUseMaterial3FlagEnabled()) {
+                    final boolean isRtl = mTabs.getLayoutDirection() == View.LAYOUT_DIRECTION_RTL;
+                    // if use_material3 flag is ON, we uses the margin value as the right margin
+                    // (left margin for RTL),  except for the last child.
+                    if (i != mTabs.getTabCount() - 1) {
+                        marginLayoutParams.setMargins(
+                                isRtl ? tabMarginSide : 0, 0, isRtl ? 0 : tabMarginSide, 0);
+                    }
+                } else {
+                    marginLayoutParams.setMargins(tabMarginSide, 0, tabMarginSide, 0);
+                }
                 int tabHeightInDp = (int) mTabsContainer.getContext().getResources()
                         .getDimension(R.dimen.tab_height);
                 tab.getLayoutParams().height = tabHeightInDp;
diff --git a/src/com/android/documentsui/RecentsLoader.java b/src/com/android/documentsui/RecentsLoader.java
index b3cfa0180..9a3e06fba 100644
--- a/src/com/android/documentsui/RecentsLoader.java
+++ b/src/com/android/documentsui/RecentsLoader.java
@@ -37,13 +37,13 @@ public class RecentsLoader extends MultiRootDocumentsLoader {
 
     private static final String TAG = "RecentsLoader";
     /** Ignore documents older than this age. */
-    private static final long REJECT_OLDER_THAN = 45 * DateUtils.DAY_IN_MILLIS;
+    public static final long REJECT_OLDER_THAN = 45 * DateUtils.DAY_IN_MILLIS;
 
-    /** MIME types that should always be excluded from recents. */
+    /** MIME types that should always be excluded from the Recents view. */
     private static final String[] REJECT_MIMES = new String[]{Document.MIME_TYPE_DIR};
 
     /** Maximum documents from a single root. */
-    private static final int MAX_DOCS_FROM_ROOT = 64;
+    public static final int MAX_DOCS_FROM_ROOT = 64;
 
     private final UserId mUserId;
 
diff --git a/src/com/android/documentsui/UserManagerState.java b/src/com/android/documentsui/UserManagerState.java
index b1c1a0d59..1023c8c1d 100644
--- a/src/com/android/documentsui/UserManagerState.java
+++ b/src/com/android/documentsui/UserManagerState.java
@@ -22,7 +22,6 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.Style.SOLI
 import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFILE_ICON;
 import static com.android.documentsui.DevicePolicyResources.Strings.PERSONAL_TAB;
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
-import static com.android.documentsui.base.SharedMinimal.DEBUG;
 
 import android.Manifest;
 import android.annotation.SuppressLint;
@@ -33,6 +32,7 @@ import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
 import android.content.pm.PackageManager;
+import android.content.pm.ResolveInfo;
 import android.content.pm.UserProperties;
 import android.graphics.drawable.Drawable;
 import android.os.Build;
@@ -42,16 +42,17 @@ import android.util.Log;
 
 import androidx.annotation.GuardedBy;
 import androidx.annotation.RequiresApi;
+import androidx.annotation.RequiresPermission;
 import androidx.annotation.VisibleForTesting;
 
 import com.android.documentsui.base.Features;
 import com.android.documentsui.base.UserId;
-import com.android.documentsui.util.CrossProfileUtils;
 import com.android.documentsui.util.VersionUtils;
 import com.android.modules.utils.build.SdkLevel;
 
 import com.google.common.base.Objects;
 
+import java.lang.reflect.Field;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
@@ -62,26 +63,23 @@ public interface UserManagerState {
 
     /**
      * Returns the {@link UserId} of each profile which should be queried for documents. This will
-     * always
-     * include {@link UserId#CURRENT_USER}.
+     * always include {@link UserId#CURRENT_USER}.
      */
     List<UserId> getUserIds();
 
-    /**
-     * Returns mapping between the {@link UserId} and the label for the profile
-     */
+    /** Returns mapping between the {@link UserId} and the label for the profile */
     Map<UserId, String> getUserIdToLabelMap();
 
     /**
      * Returns mapping between the {@link UserId} and the drawable badge for the profile
      *
-     * returns {@code null} for non-profile userId
+     * <p>returns {@code null} for non-profile userId
      */
     Map<UserId, Drawable> getUserIdToBadgeMap();
 
     /**
-     * Returns a map of {@link UserId} to boolean value indicating whether
-     * the {@link UserId}.CURRENT_USER can forward {@link Intent} to that {@link UserId}
+     * Returns a map of {@link UserId} to boolean value indicating whether the {@link
+     * UserId}.CURRENT_USER can forward {@link Intent} to that {@link UserId}
      */
     Map<UserId, Boolean> getCanForwardToProfileIdMap(Intent intent);
 
@@ -96,25 +94,19 @@ public interface UserManagerState {
      */
     void onProfileActionStatusChange(String action, UserId userId);
 
-    /**
-     * Sets the intent that triggered the launch of the DocsUI
-     */
+    /** Sets the intent that triggered the launch of the DocsUI */
     void setCurrentStateIntent(Intent intent);
 
     /** Returns true if there are hidden profiles */
     boolean areHiddenInQuietModeProfilesPresent();
 
-    /**
-     * Creates an implementation of {@link UserManagerState}.
-     */
+    /** Creates an implementation of {@link UserManagerState}. */
     // TODO: b/314746383 Make this class a singleton
     static UserManagerState create(Context context) {
         return new RuntimeUserManagerState(context);
     }
 
-    /**
-     * Implementation of {@link UserManagerState}
-     */
+    /** Implementation of {@link UserManagerState} */
     final class RuntimeUserManagerState implements UserManagerState {
 
         private static final String TAG = "UserManagerState";
@@ -123,58 +115,63 @@ public interface UserManagerState {
         private final boolean mIsDeviceSupported;
         private final UserManager mUserManager;
         private final ConfigStore mConfigStore;
+
         /**
          * List of all the {@link UserId} that have the {@link UserProperties.ShowInSharingSurfaces}
          * set as `SHOW_IN_SHARING_SURFACES_SEPARATE` OR it is a system/personal user
          */
         @GuardedBy("mUserIds")
         private final List<UserId> mUserIds = new ArrayList<>();
-        /**
-         * Mapping between the {@link UserId} to the corresponding profile label
-         */
+
+        /** Mapping between the {@link UserId} to the corresponding profile label */
         @GuardedBy("mUserIdToLabelMap")
         private final Map<UserId, String> mUserIdToLabelMap = new HashMap<>();
-        /**
-         * Mapping between the {@link UserId} to the corresponding profile badge
-         */
+
+        /** Mapping between the {@link UserId} to the corresponding profile badge */
         @GuardedBy("mUserIdToBadgeMap")
         private final Map<UserId, Drawable> mUserIdToBadgeMap = new HashMap<>();
+
         /**
          * Map containing {@link UserId}, other than that of the current user, as key and boolean
          * denoting whether it is accessible by the current user or not as value
          */
-        @GuardedBy("mCanFrowardToProfileIdMap")
-        private final Map<UserId, Boolean> mCanFrowardToProfileIdMap = new HashMap<>();
+        @GuardedBy("mCanForwardToProfileIdMap")
+        private final Map<UserId, Boolean> mCanForwardToProfileIdMap = new HashMap<>();
 
         private Intent mCurrentStateIntent;
 
-        private final BroadcastReceiver mIntentReceiver = new BroadcastReceiver() {
-            @Override
-            public void onReceive(Context context, Intent intent) {
-                synchronized (mUserIds) {
-                    mUserIds.clear();
-                }
-                synchronized (mUserIdToLabelMap) {
-                    mUserIdToLabelMap.clear();
-                }
-                synchronized (mUserIdToBadgeMap) {
-                    mUserIdToBadgeMap.clear();
-                }
-                synchronized (mCanFrowardToProfileIdMap) {
-                    mCanFrowardToProfileIdMap.clear();
-                }
-            }
-        };
-
+        private final BroadcastReceiver mIntentReceiver =
+                new BroadcastReceiver() {
+                    @Override
+                    public void onReceive(Context context, Intent intent) {
+                        synchronized (mUserIds) {
+                            mUserIds.clear();
+                        }
+                        synchronized (mUserIdToLabelMap) {
+                            mUserIdToLabelMap.clear();
+                        }
+                        synchronized (mUserIdToBadgeMap) {
+                            mUserIdToBadgeMap.clear();
+                        }
+                        synchronized (mCanForwardToProfileIdMap) {
+                            mCanForwardToProfileIdMap.clear();
+                        }
+                    }
+                };
 
         private RuntimeUserManagerState(Context context) {
-            this(context, UserId.CURRENT_USER,
+            this(
+                    context,
+                    UserId.CURRENT_USER,
                     Features.CROSS_PROFILE_TABS && isDeviceSupported(context),
                     DocumentsApplication.getConfigStore());
         }
 
         @VisibleForTesting
-        RuntimeUserManagerState(Context context, UserId currentUser, boolean isDeviceSupported,
+        RuntimeUserManagerState(
+                Context context,
+                UserId currentUser,
+                boolean isDeviceSupported,
                 ConfigStore configStore) {
             mContext = context.getApplicationContext();
             mCurrentUser = checkNotNull(currentUser);
@@ -224,11 +221,11 @@ public interface UserManagerState {
 
         @Override
         public Map<UserId, Boolean> getCanForwardToProfileIdMap(Intent intent) {
-            synchronized (mCanFrowardToProfileIdMap) {
-                if (mCanFrowardToProfileIdMap.isEmpty()) {
+            synchronized (mCanForwardToProfileIdMap) {
+                if (mCanForwardToProfileIdMap.isEmpty()) {
                     getCanForwardToProfileIdMapInternal(intent);
                 }
-                return mCanFrowardToProfileIdMap;
+                return mCanForwardToProfileIdMap;
             }
         }
 
@@ -236,8 +233,8 @@ public interface UserManagerState {
         @SuppressLint("NewApi")
         public void onProfileActionStatusChange(String action, UserId userId) {
             if (!SdkLevel.isAtLeastV()) return;
-            UserProperties userProperties = mUserManager.getUserProperties(
-                    UserHandle.of(userId.getIdentifier()));
+            UserProperties userProperties =
+                    mUserManager.getUserProperties(UserHandle.of(userId.getIdentifier()));
             if (userProperties.getShowInQuietMode() != UserProperties.SHOW_IN_QUIET_MODE_HIDDEN) {
                 return;
             }
@@ -263,19 +260,15 @@ public interface UserManagerState {
                         mUserIdToBadgeMap.put(userId, getProfileBadge(userId));
                     }
                 }
-                synchronized (mCanFrowardToProfileIdMap) {
-                    if (!mCanFrowardToProfileIdMap.containsKey(userId)) {
-                        if (userId.getIdentifier() == ActivityManager.getCurrentUser()
-                                || isCrossProfileContentSharingStrategyDelegatedFromParent(
-                                UserHandle.of(userId.getIdentifier()))
-                                || CrossProfileUtils.getCrossProfileResolveInfo(mCurrentUser,
-                                mContext.getPackageManager(), mCurrentStateIntent, mContext,
-                                mConfigStore.isPrivateSpaceInDocsUIEnabled()) != null) {
-                            mCanFrowardToProfileIdMap.put(userId, true);
-                        } else {
-                            mCanFrowardToProfileIdMap.put(userId, false);
-                        }
-
+                synchronized (mCanForwardToProfileIdMap) {
+                    if (!mCanForwardToProfileIdMap.containsKey(userId)) {
+                        mCanForwardToProfileIdMap.put(
+                                userId,
+                                isCrossProfileAllowedToUser(
+                                        mContext,
+                                        mCurrentStateIntent,
+                                        UserId.CURRENT_USER,
+                                        userId));
                     }
                 }
             } else {
@@ -315,80 +308,111 @@ public interface UserManagerState {
 
             if (mUserManager == null) {
                 Log.e(TAG, "cannot obtain user manager");
-                result.add(mCurrentUser);
                 return result;
             }
 
             final List<UserHandle> userProfiles = mUserManager.getUserProfiles();
-            if (userProfiles.size() < 2) {
-                result.add(mCurrentUser);
-                return result;
-            }
 
-            if (SdkLevel.isAtLeastV()) {
-                getUserIdsInternalPostV(userProfiles, result);
-            } else {
-                getUserIdsInternalPreV(userProfiles, result);
-            }
-            return result;
-        }
+            result.add(mCurrentUser);
+            boolean currentUserIsManaged =
+                    mUserManager.isManagedProfile(mCurrentUser.getIdentifier());
 
-        @SuppressLint("NewApi")
-        private void getUserIdsInternalPostV(List<UserHandle> userProfiles, List<UserId> result) {
-            for (UserHandle userHandle : userProfiles) {
-                if (userHandle.getIdentifier() == ActivityManager.getCurrentUser()) {
-                    result.add(UserId.of(userHandle));
+            for (UserHandle handle : userProfiles) {
+                if (SdkLevel.isAtLeastV()) {
+                    if (!isProfileAllowed(handle)) {
+                        continue;
+                    }
                 } else {
-                    // Out of all the profiles returned by user manager the profiles that are
-                    // returned should satisfy both the following conditions:
-                    // 1. It has user property SHOW_IN_SHARING_SURFACES_SEPARATE
-                    // 2. Quite mode is not enabled, if it is enabled then the profile's user
-                    //    property is not SHOW_IN_QUIET_MODE_HIDDEN
-                    if (isProfileAllowed(userHandle)) {
-                        result.add(UserId.of(userHandle));
+                    // Only allow managed profiles + the parent user on lower than V.
+                    if (currentUserIsManaged
+                            && mUserManager.getProfileParent(mCurrentUser.getUserHandle())
+                                    == handle) {
+                        // Intentionally empty so that this profile gets added.
+                    } else if (!mUserManager.isManagedProfile(handle.getIdentifier())) {
+                        continue;
                     }
                 }
+
+                // Ensure the system user doesn't get added twice.
+                if (result.contains(UserId.of(handle))) continue;
+                result.add(UserId.of(handle));
             }
-            if (result.isEmpty()) {
-                result.add(mCurrentUser);
+
+            return result;
+        }
+
+        /**
+         * Checks if a package is installed for a given user.
+         *
+         * @param userHandle The ID of the user.
+         * @return {@code true} if the package is installed for the user, {@code false} otherwise.
+         */
+        @RequiresPermission(
+                anyOf = {
+                    "android.permission.MANAGE_USERS",
+                    "android.permission.INTERACT_ACROSS_USERS"
+                })
+        private boolean isPackageInstalledForUser(UserHandle userHandle) {
+            String packageName = mContext.getPackageName();
+            try {
+                Context userPackageContext =
+                        mContext.createPackageContextAsUser(
+                                mContext.getPackageName(), 0 /* flags */, userHandle);
+                return userPackageContext != null;
+            } catch (PackageManager.NameNotFoundException e) {
+                Log.w(TAG, "Package " + packageName + " not found for user " + userHandle);
+                return false;
             }
         }
 
+        /**
+         * Checks if quiet mode is enabled for a given user.
+         *
+         * @param userHandle The UserHandle of the profile to check.
+         * @return {@code true} if quiet mode is enabled, {@code false} otherwise.
+         */
+        private boolean isQuietModeEnabledForUser(UserHandle userHandle) {
+            return UserId.of(userHandle.getIdentifier()).isQuietModeEnabled(mContext);
+        }
+
+        /**
+         * Checks if a profile should be allowed, taking into account quiet mode and package
+         * installation.
+         *
+         * @param userHandle The UserHandle of the profile to check.
+         * @return {@code true} if the profile should be allowed, {@code false} otherwise.
+         */
         @SuppressLint("NewApi")
+        @RequiresPermission(
+                anyOf = {
+                    "android.permission.MANAGE_USERS",
+                    "android.permission.INTERACT_ACROSS_USERS"
+                })
         private boolean isProfileAllowed(UserHandle userHandle) {
-            final UserProperties userProperties =
-                    mUserManager.getUserProperties(userHandle);
+            final UserProperties userProperties = mUserManager.getUserProperties(userHandle);
+
+            // 1. Check if the package is installed for the user
+            if (!isPackageInstalledForUser(userHandle)) {
+                Log.w(
+                        TAG,
+                        "Package "
+                                + mContext.getPackageName()
+                                + " is not installed for user "
+                                + userHandle);
+                return false;
+            }
+
+            // 2. Check user properties and quiet mode
             if (userProperties.getShowInSharingSurfaces()
                     == UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE) {
-                return !UserId.of(userHandle).isQuietModeEnabled(mContext)
+                // Return true if profile is not in quiet mode or if it is in quiet mode
+                // then its user properties do not require it to be hidden
+                return !isQuietModeEnabledForUser(userHandle)
                         || userProperties.getShowInQuietMode()
-                        != UserProperties.SHOW_IN_QUIET_MODE_HIDDEN;
+                                != UserProperties.SHOW_IN_QUIET_MODE_HIDDEN;
             }
-            return false;
-        }
 
-        private void getUserIdsInternalPreV(List<UserHandle> userProfiles, List<UserId> result) {
-            result.add(mCurrentUser);
-            UserId systemUser = null;
-            UserId managedUser = null;
-            for (UserHandle userHandle : userProfiles) {
-                if (userHandle.isSystem()) {
-                    systemUser = UserId.of(userHandle);
-                } else if (mUserManager.isManagedProfile(userHandle.getIdentifier())) {
-                    managedUser = UserId.of(userHandle);
-                }
-            }
-            if (mCurrentUser.isSystem() && managedUser != null) {
-                result.add(managedUser);
-            } else if (mCurrentUser.isManagedProfile(mUserManager) && systemUser != null) {
-                result.add(0, systemUser);
-            } else {
-                if (DEBUG) {
-                    Log.w(TAG, "The current user " + UserId.CURRENT_USER
-                            + " is neither system nor managed user. has system user: "
-                            + (systemUser != null));
-                }
-            }
+            return false;
         }
 
         private void getUserIdToLabelMapInternal() {
@@ -422,13 +446,13 @@ public interface UserManagerState {
             for (UserId userId : userIds) {
                 if (mUserManager.isManagedProfile(userId.getIdentifier())) {
                     synchronized (mUserIdToLabelMap) {
-                        mUserIdToLabelMap.put(userId,
-                                getEnterpriseString(WORK_TAB, R.string.work_tab));
+                        mUserIdToLabelMap.put(
+                                userId, getEnterpriseString(WORK_TAB, R.string.work_tab));
                     }
                 } else {
                     synchronized (mUserIdToLabelMap) {
-                        mUserIdToLabelMap.put(userId,
-                                getEnterpriseString(PERSONAL_TAB, R.string.personal_tab));
+                        mUserIdToLabelMap.put(
+                                userId, getEnterpriseString(PERSONAL_TAB, R.string.personal_tab));
                     }
                 }
             }
@@ -440,8 +464,9 @@ public interface UserManagerState {
                 return getEnterpriseString(PERSONAL_TAB, R.string.personal_tab);
             }
             try {
-                Context userContext = mContext.createContextAsUser(
-                        UserHandle.of(userId.getIdentifier()), 0 /* flags */);
+                Context userContext =
+                        mContext.createContextAsUser(
+                                UserHandle.of(userId.getIdentifier()), 0 /* flags */);
                 UserManager userManagerAsUser = userContext.getSystemService(UserManager.class);
                 if (userManagerAsUser == null) {
                     Log.e(TAG, "cannot obtain user manager");
@@ -469,9 +494,8 @@ public interface UserManagerState {
                 Log.e(TAG, "can not get device policy manager");
                 return mContext.getString(defaultStringId);
             }
-            return dpm.getResources().getString(
-                    updatableStringId,
-                    () -> mContext.getString(defaultStringId));
+            return dpm.getResources()
+                    .getString(updatableStringId, () -> mContext.getString(defaultStringId));
         }
 
         private void getUserIdToBadgeMapInternal() {
@@ -506,8 +530,10 @@ public interface UserManagerState {
             for (UserId userId : userIds) {
                 if (mUserManager.isManagedProfile(userId.getIdentifier())) {
                     synchronized (mUserIdToBadgeMap) {
-                        mUserIdToBadgeMap.put(userId,
-                                SdkLevel.isAtLeastT() ? getWorkProfileBadge()
+                        mUserIdToBadgeMap.put(
+                                userId,
+                                SdkLevel.isAtLeastT()
+                                        ? getWorkProfileBadge()
                                         : mContext.getDrawable(R.drawable.ic_briefcase));
                     }
                 }
@@ -520,8 +546,9 @@ public interface UserManagerState {
                 return null;
             }
             try {
-                Context userContext = mContext.createContextAsUser(
-                        UserHandle.of(userId.getIdentifier()), 0 /* flags */);
+                Context userContext =
+                        mContext.createContextAsUser(
+                                UserHandle.of(userId.getIdentifier()), 0 /* flags */);
                 UserManager userManagerAsUser = userContext.getSystemService(UserManager.class);
                 if (userManagerAsUser == null) {
                     Log.e(TAG, "cannot obtain user manager");
@@ -537,86 +564,218 @@ public interface UserManagerState {
         @RequiresApi(Build.VERSION_CODES.TIRAMISU)
         private Drawable getWorkProfileBadge() {
             DevicePolicyManager dpm = mContext.getSystemService(DevicePolicyManager.class);
-            Drawable drawable = dpm.getResources().getDrawable(WORK_PROFILE_ICON, SOLID_COLORED,
-                    () ->
-                            mContext.getDrawable(R.drawable.ic_briefcase));
+            Drawable drawable =
+                    dpm.getResources()
+                            .getDrawable(
+                                    WORK_PROFILE_ICON,
+                                    SOLID_COLORED,
+                                    () -> mContext.getDrawable(R.drawable.ic_briefcase));
             return drawable;
         }
 
+        /**
+         * Updates Cross Profile access for all UserProfiles in {@code getUserIds()}
+         *
+         * <p>This method looks at a variety of situations for each Profile and decides if the
+         * profile's content is accessible by the current process owner user id.
+         *
+         * <ol>
+         *   <li>UserProperties attributes for CrossProfileDelegation are checked first. When the
+         *       profile delegates to the parent profile, the parent's access is used.
+         *   <li>{@link CrossProfileIntentForwardingActivity}s are resolved via the process owner's
+         *       PackageManager, and are considered when evaluating cross profile to the target
+         *       profile.
+         * </ol>
+         *
+         * <p>In the event none of the above checks succeeds, the profile is considered to be
+         * inaccessible to the current process user.
+         *
+         * @param intent The intent Photopicker is currently running under, for
+         *     CrossProfileForwardActivity checking.
+         */
         private void getCanForwardToProfileIdMapInternal(Intent intent) {
-            // Versions less than V will not have the user properties required to determine whether
-            // cross profile check is delegated from parent or not
-            if (!SdkLevel.isAtLeastV()) {
-                getCanForwardToProfileIdMapPreV(intent);
-                return;
+
+            synchronized (mCanForwardToProfileIdMap) {
+                mCanForwardToProfileIdMap.clear();
+                for (UserId userId : getUserIds()) {
+                    mCanForwardToProfileIdMap.put(
+                            userId,
+                            isCrossProfileAllowedToUser(
+                                    mContext, intent, mCurrentUser, userId));
+                }
             }
-            if (mUserManager == null) {
-                Log.e(TAG, "can not get user manager");
-                return;
+        }
+
+        /**
+         * Determines if the provided UserIds support CrossProfile content sharing.
+         *
+         * <p>This method accepts a pair of user handles (from/to) and determines if CrossProfile
+         * access is permitted between those two profiles.
+         *
+         * <p>There are differences is on how the access is determined based on the platform SDK:
+         *
+         * <p>For Platform SDK < V:
+         *
+         * <p>A check for CrossProfileIntentForwarders in the origin (from) profile that target the
+         * destination (to) profile. If such a forwarder exists, then access is allowed, and denied
+         * otherwise.
+         *
+         * <p>For Platform SDK >= V:
+         *
+         * <p>The method now takes into account access delegation, which was first added in Android
+         * V.
+         *
+         * <p>For profiles that set the [CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT]
+         * property in its [UserProperties], its parent profile will be substituted in for its side
+         * of the check.
+         *
+         * <p>ex. For access checks between a Managed (from) and Private (to) profile, where: -
+         * Managed does not delegate to its parent - Private delegates to its parent
+         *
+         * <p>The following logic is performed: Managed -> parent(Private)
+         *
+         * <p>The same check in the other direction would yield: parent(Private) -> Managed
+         *
+         * <p>Note how the private profile is never actually used for either side of the check,
+         * since it is delegating its access check to the parent. And thus, if Managed can access
+         * the parent, it can also access the private.
+         *
+         * @param context Current context object, for switching user contexts.
+         * @param intent The current intent the Photopicker is running under.
+         * @param fromUser The Origin profile, where the user is coming from
+         * @param toUser The destination profile, where the user is attempting to go to.
+         * @return Whether CrossProfile content sharing is supported in this handle.
+         */
+        private boolean isCrossProfileAllowedToUser(
+                Context context, Intent intent, UserId fromUser, UserId toUser) {
+
+            // Early exit conditions, accessing self.
+            // NOTE: It is also possible to reach this state if this method is recursively checking
+            // from: parent(A) to:parent(B) where A and B are both children of the same parent.
+            if (fromUser.getIdentifier() == toUser.getIdentifier()) {
+                return true;
             }
 
-            List<UserId> parentOrDelegatedFromParent = new ArrayList<>();
-            List<UserId> canForwardToProfileIds = new ArrayList<>();
-            List<UserId> noDelegation = new ArrayList<>();
+            // Decide if we should use actual from or parent(from)
+            UserHandle currentFromUser =
+                    getProfileToCheckCrossProfileAccess(fromUser.getUserHandle());
 
-            List<UserId> userIds = getUserIds();
-            for (UserId userId : userIds) {
-                final UserHandle userHandle = UserHandle.of(userId.getIdentifier());
-                // Parent (personal) profile and all the child profiles that delegate cross profile
-                // content sharing check to parent can share among each other
-                if (userId.getIdentifier() == ActivityManager.getCurrentUser()
-                        || isCrossProfileContentSharingStrategyDelegatedFromParent(userHandle)) {
-                    parentOrDelegatedFromParent.add(userId);
-                } else {
-                    noDelegation.add(userId);
-                }
+            // Decide if we should use actual to or parent(to)
+            UserHandle currentToUser = getProfileToCheckCrossProfileAccess(toUser.getUserHandle());
+
+            // When the from/to has changed from the original parameters, recursively restart the
+            // checks with the new from/to handles.
+            if (fromUser.getIdentifier() != currentFromUser.getIdentifier()
+                    || toUser.getIdentifier() != currentToUser.getIdentifier()) {
+                return isCrossProfileAllowedToUser(
+                        context, intent, UserId.of(currentFromUser), UserId.of(currentToUser));
             }
 
-            if (noDelegation.size() > 1) {
-                Log.e(TAG, "There cannot be more than one profile delegating cross profile "
-                        + "content sharing check from self.");
-            }
-
-            /*
-             * Cross profile resolve info need to be checked in the following 2 cases:
-             * 1. current user is either parent or delegates check to parent and the target user
-             *    does not delegate to parent
-             * 2. current user does not delegate check to the parent and the target user is the
-             *    parent profile
-             */
-            UserId needToCheck = null;
-            if (parentOrDelegatedFromParent.contains(mCurrentUser)
-                    && !noDelegation.isEmpty()) {
-                needToCheck = noDelegation.get(0);
-            } else if (mCurrentUser.getIdentifier() != ActivityManager.getCurrentUser()) {
-                final UserHandle parentProfile = mUserManager.getProfileParent(
-                        UserHandle.of(mCurrentUser.getIdentifier()));
-                needToCheck = UserId.of(parentProfile);
-            }
-
-            if (needToCheck != null && CrossProfileUtils.getCrossProfileResolveInfo(mCurrentUser,
-                    mContext.getPackageManager(), intent, mContext,
-                    mConfigStore.isPrivateSpaceInDocsUIEnabled()) != null) {
-                if (parentOrDelegatedFromParent.contains(needToCheck)) {
-                    canForwardToProfileIds.addAll(parentOrDelegatedFromParent);
-                } else {
-                    canForwardToProfileIds.add(needToCheck);
+            PackageManager pm = context.getPackageManager();
+            return doesCrossProfileIntentForwarderExist(intent, pm, fromUser, toUser);
+        }
+
+        /**
+         * Determines if the target UserHandle delegates its content sharing to its parent.
+         *
+         * @param userHandle The target handle to check delegation for.
+         * @return TRUE if V+ and the handle delegates to parent. False otherwise.
+         */
+        private boolean isCrossProfileStrategyDelegatedToParent(UserHandle userHandle) {
+            if (SdkLevel.isAtLeastV()) {
+                if (mUserManager == null) {
+                    Log.e(TAG, "Cannot obtain user manager");
+                    return false;
+                }
+                UserProperties userProperties = mUserManager.getUserProperties(userHandle);
+                if (userProperties.getCrossProfileContentSharingStrategy()
+                        == userProperties.CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT) {
+                    return true;
                 }
             }
+            return false;
+        }
 
-            if (parentOrDelegatedFromParent.contains(mCurrentUser)) {
-                canForwardToProfileIds.addAll(parentOrDelegatedFromParent);
+        /**
+         * Acquires the correct {@link UserHandle} which should be used for CrossProfile access
+         * checks.
+         *
+         * @param userHandle the origin handle.
+         * @return The UserHandle that should be used for cross profile access checks. In the event
+         *     the origin handle delegates its access, this may not be the same handle as the origin
+         *     handle.
+         */
+        private UserHandle getProfileToCheckCrossProfileAccess(UserHandle userHandle) {
+            if (mUserManager == null) {
+                Log.e(TAG, "Cannot obtain user manager");
+                return null;
             }
+            return isCrossProfileStrategyDelegatedToParent(userHandle)
+                    ? mUserManager.getProfileParent(userHandle)
+                    : userHandle;
+        }
 
-            for (UserId userId : userIds) {
-                synchronized (mCanFrowardToProfileIdMap) {
-                    if (userId.equals(mCurrentUser)) {
-                        mCanFrowardToProfileIdMap.put(userId, true);
-                        continue;
+        /**
+         * Looks for a matching CrossProfileIntentForwardingActivity in the targetUserId for the
+         * given intent.
+         *
+         * @param intent The intent the forwarding activity needs to match.
+         * @param targetUserId The target user to check for.
+         * @return whether a CrossProfileIntentForwardingActivity could be found for the given
+         *     intent, and user.
+         */
+        private boolean doesCrossProfileIntentForwarderExist(
+                Intent intent, PackageManager pm, UserId fromUser, UserId targetUserId) {
+
+            final Intent intentToCheck = (Intent) intent.clone();
+            intentToCheck.setComponent(null);
+            intentToCheck.setPackage(null);
+
+            for (ResolveInfo resolveInfo :
+                    pm.queryIntentActivitiesAsUser(
+                            intentToCheck,
+                            PackageManager.MATCH_DEFAULT_ONLY,
+                            fromUser.getUserHandle())) {
+
+                if (resolveInfo.isCrossProfileIntentForwarderActivity()) {
+                    /*
+                     * IMPORTANT: This is a reflection based hack to ensure the profile is
+                     * actually the installer of the CrossProfileIntentForwardingActivity.
+                     *
+                     * ResolveInfo.targetUserId exists, but is a hidden API not available to
+                     * mainline modules, and no such API exists, so it is accessed via
+                     * reflection below. All exceptions are caught to protect against
+                     * reflection related issues such as:
+                     * NoSuchFieldException / IllegalAccessException / SecurityException.
+                     *
+                     * In the event of an exception, the code fails "closed" for the current
+                     * profile to avoid showing content that should not be visible.
+                     */
+                    try {
+                        Field targetUserIdField =
+                                resolveInfo.getClass().getDeclaredField("targetUserId");
+                        targetUserIdField.setAccessible(true);
+                        int activityTargetUserId = (int) targetUserIdField.get(resolveInfo);
+
+                        if (activityTargetUserId == targetUserId.getIdentifier()) {
+
+                            // Found a match for this profile
+                            return true;
+                        }
+
+                    } catch (NoSuchFieldException | IllegalAccessException | SecurityException ex) {
+                        // Couldn't check the targetUserId via reflection, so fail without
+                        // further iterations.
+                        Log.e(TAG, "Could not access targetUserId via reflection.", ex);
+                        return false;
+                    } catch (Exception ex) {
+                        Log.e(TAG, "Exception occurred during cross profile checks", ex);
                     }
-                    mCanFrowardToProfileIdMap.put(userId, canForwardToProfileIds.contains(userId));
                 }
             }
+
+            // No match found, so return false.
+            return false;
         }
 
         @SuppressLint("NewApi")
@@ -636,30 +795,12 @@ public interface UserManagerState {
                     == UserProperties.CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT;
         }
 
-        private void getCanForwardToProfileIdMapPreV(Intent intent) {
-            // There only two profiles pre V
-            List<UserId> userIds = getUserIds();
-            for (UserId userId : userIds) {
-                synchronized (mCanFrowardToProfileIdMap) {
-                    if (mCurrentUser.equals(userId)) {
-                        mCanFrowardToProfileIdMap.put(userId, true);
-                    } else {
-                        mCanFrowardToProfileIdMap.put(userId,
-                                CrossProfileUtils.getCrossProfileResolveInfo(
-                                        mCurrentUser, mContext.getPackageManager(), intent,
-                                        mContext, mConfigStore.isPrivateSpaceInDocsUIEnabled())
-                                        != null);
-                    }
-                }
-            }
-        }
-
         private static boolean isDeviceSupported(Context context) {
-            // The feature requires Android R DocumentsContract APIs and INTERACT_ACROSS_USERS_FULL
-            // permission.
+            // The feature requires Android R DocumentsContract APIs and
+            // INTERACT_ACROSS_USERS_FULL permission.
             return VersionUtils.isAtLeastR()
                     && context.checkSelfPermission(Manifest.permission.INTERACT_ACROSS_USERS)
-                    == PackageManager.PERMISSION_GRANTED;
+                            == PackageManager.PERMISSION_GRANTED;
         }
     }
 }
diff --git a/src/com/android/documentsui/archives/Archive.java b/src/com/android/documentsui/archives/Archive.java
index 7c0f47147..9889631ea 100644
--- a/src/com/android/documentsui/archives/Archive.java
+++ b/src/com/android/documentsui/archives/Archive.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.archives;
 
+import static com.android.documentsui.base.SharedMinimal.DEBUG;
+
 import android.content.Context;
 import android.content.res.AssetFileDescriptor;
 import android.database.Cursor;
@@ -29,23 +31,23 @@ import android.system.ErrnoException;
 import android.system.Os;
 import android.system.OsConstants;
 import android.text.TextUtils;
+import android.util.Log;
 import android.webkit.MimeTypeMap;
 
 import androidx.annotation.GuardedBy;
 import androidx.annotation.Nullable;
-import androidx.core.util.Preconditions;
+
+import org.apache.commons.compress.archivers.ArchiveEntry;
 
 import java.io.Closeable;
 import java.io.File;
 import java.io.FileNotFoundException;
+import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
 import java.util.Locale;
 import java.util.Map;
 
-import org.apache.commons.compress.archivers.ArchiveEntry;
-import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
-
 /**
  * Provides basic implementation for creating, extracting and accessing
  * files within archives exposed by a document provider.
@@ -55,7 +57,7 @@ import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
 public abstract class Archive implements Closeable {
     private static final String TAG = "Archive";
 
-    public static final String[] DEFAULT_PROJECTION = new String[] {
+    public static final String[] DEFAULT_PROJECTION = new String[]{
             Document.COLUMN_DOCUMENT_ID,
             Document.COLUMN_DISPLAY_NAME,
             Document.COLUMN_MIME_TYPE,
@@ -90,28 +92,85 @@ public abstract class Archive implements Closeable {
         mEntries = new HashMap<>();
     }
 
-    /**
-     * Returns a valid, normalized path for an entry.
-     */
+    /** Returns a valid, normalized path for an entry. */
     public static String getEntryPath(ArchiveEntry entry) {
-        if (entry instanceof ZipArchiveEntry) {
-            /**
-             * Some of archive entry doesn't have the same naming rule.
-             * For example: The name of 7 zip directory entry doesn't end with '/'.
-             * Only check for Zip archive.
-             */
-            Preconditions.checkArgument(entry.isDirectory() == entry.getName().endsWith("/"),
-                    "Ill-formated ZIP-file.");
+        final List<String> parts = new ArrayList<String>();
+        boolean isDir = true;
+
+        // Get the path that will be decomposed and normalized
+        final String in = entry.getName();
+
+        decompose:
+        for (int i = 0; i < in.length(); ) {
+            // Skip separators
+            if (in.charAt(i) == '/') {
+                isDir = true;
+                do {
+                    if (++i == in.length()) break decompose;
+                } while (in.charAt(i) == '/');
+            }
+
+            // Found the beginning of a part
+            final int b = i;
+            assert (b < in.length());
+            assert (in.charAt(b) != '/');
+
+            // Find the end of the part
+            do {
+                ++i;
+            } while (i < in.length() && in.charAt(i) != '/');
+
+            // Extract part
+            final String part = in.substring(b, i);
+            assert (!part.isEmpty());
+
+            // Special case if part is "."
+            if (part.equals(".")) {
+                isDir = true;
+                continue;
+            }
+
+            // Special case if part is ".."
+            if (part.equals("..")) {
+                isDir = true;
+                if (!parts.isEmpty()) parts.remove(parts.size() - 1);
+                continue;
+            }
+
+            // The part is either a directory or a file name
+            isDir = false;
+            parts.add(part);
         }
-        if (entry.getName().startsWith("/")) {
-            return entry.getName();
-        } else {
-            return "/" + entry.getName();
+
+        // If the decomposed path looks like a directory but the archive entry says that it is not
+        // a directory entry, append "?" for the file name
+        if (isDir && !entry.isDirectory()) {
+            isDir = false;
+            parts.add("?");
         }
+
+        if (parts.isEmpty()) return "/";
+
+        // Construct the normalized path
+        final StringBuilder sb = new StringBuilder(in.length() + 3);
+
+        for (final String part : parts) {
+            sb.append('/');
+            sb.append(part);
+        }
+
+        if (entry.isDirectory()) {
+            sb.append('/');
+        }
+
+        final String out = sb.toString();
+        if (DEBUG) Log.d(TAG, "getEntryPath(" + in + ") -> " + out);
+        return out;
     }
 
     /**
      * Returns true if the file descriptor is seekable.
+     *
      * @param descriptor File descriptor to check.
      */
     public static boolean canSeek(ParcelFileDescriptor descriptor) {
diff --git a/src/com/android/documentsui/archives/ArchiveRegistry.java b/src/com/android/documentsui/archives/ArchiveRegistry.java
index 91e0e20f5..3417e45ad 100644
--- a/src/com/android/documentsui/archives/ArchiveRegistry.java
+++ b/src/com/android/documentsui/archives/ArchiveRegistry.java
@@ -24,13 +24,12 @@ import static org.apache.commons.compress.compressors.CompressorStreamFactory.XZ
 
 import androidx.annotation.Nullable;
 
-import java.util.HashMap;
-import java.util.Map;
-import java.util.Set;
-
 import org.apache.commons.compress.compressors.brotli.BrotliUtils;
 import org.apache.commons.compress.compressors.xz.XZUtils;
 
+import java.util.HashMap;
+import java.util.Map;
+
 /**
  * To query how to generate ArchiveHandle, how to create CompressInputStream and how to create
  * ArchiveInputStream by using MIME type in ArchiveRegistry.
@@ -136,8 +135,4 @@ final class ArchiveRegistry {
     static Integer getArchiveType(String mimeType) {
         return sHandleArchiveMap.get(mimeType);
     }
-
-    static Set<String> getSupportList() {
-        return sHandleArchiveMap.keySet();
-    }
 }
diff --git a/src/com/android/documentsui/archives/ArchivesProvider.java b/src/com/android/documentsui/archives/ArchivesProvider.java
index 3406cd708..dd221f416 100644
--- a/src/com/android/documentsui/archives/ArchivesProvider.java
+++ b/src/com/android/documentsui/archives/ArchivesProvider.java
@@ -44,7 +44,6 @@ import java.io.InputStream;
 import java.util.HashMap;
 import java.util.Map;
 import java.util.Objects;
-import java.util.Set;
 
 /**
  * Provides basic implementation for creating, extracting and accessing
@@ -62,7 +61,6 @@ public class ArchivesProvider extends DocumentsProvider {
     private static final String TAG = "ArchivesProvider";
     private static final String METHOD_ACQUIRE_ARCHIVE = "acquireArchive";
     private static final String METHOD_RELEASE_ARCHIVE = "releaseArchive";
-    private static final Set<String> ZIP_MIME_TYPES = ArchiveRegistry.getSupportList();
 
     @GuardedBy("mArchives")
     private final Map<Key, Loader> mArchives = new HashMap<>();
@@ -235,16 +233,9 @@ public class ArchivesProvider extends DocumentsProvider {
         return loader.get().openDocumentThumbnail(documentId, sizeHint, signal);
     }
 
-    /**
-     * Returns true if the passed mime type is supported by the helper.
-     */
+    /** Returns whether the given mime type is a supported archive type. */
     public static boolean isSupportedArchiveType(String mimeType) {
-        for (final String zipMimeType : ZIP_MIME_TYPES) {
-            if (zipMimeType.equals(mimeType)) {
-                return true;
-            }
-        }
-        return false;
+        return ArchiveRegistry.getArchiveType(mimeType) != null;
     }
 
     /**
diff --git a/src/com/android/documentsui/archives/ReadableArchive.java b/src/com/android/documentsui/archives/ReadableArchive.java
index 302f582f5..ad9c8242e 100644
--- a/src/com/android/documentsui/archives/ReadableArchive.java
+++ b/src/com/android/documentsui/archives/ReadableArchive.java
@@ -105,10 +105,10 @@ public class ReadableArchive extends Archive {
                 continue;
             }
             entryPath = getEntryPath(entry);
-            if (mEntries.containsKey(entryPath)) {
-                throw new IOException("Multiple entries with the same name are not supported.");
+            if (mEntries.putIfAbsent(entryPath, entry) != null) {
+                if (DEBUG) Log.d(TAG, "Ignored conflicting entry for '" + entryPath + "'");
+                continue;
             }
-            mEntries.put(entryPath, entry);
             if (entry.isDirectory()) {
                 mTree.put(entryPath, new ArrayList<ArchiveEntry>());
             }
diff --git a/src/com/android/documentsui/base/DocumentInfo.java b/src/com/android/documentsui/base/DocumentInfo.java
index ad09c45cf..6306f14f1 100644
--- a/src/com/android/documentsui/base/DocumentInfo.java
+++ b/src/com/android/documentsui/base/DocumentInfo.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.base;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import android.content.ContentProviderClient;
 import android.content.ContentResolver;
@@ -319,7 +320,8 @@ public class DocumentInfo implements Durable, Parcelable {
 
     // Containers are documents which can be opened in DocumentsUI as folders.
     public boolean isContainer() {
-        return isDirectory() || (isArchive() && !isInArchive() && !isPartial());
+        return isDirectory() || (isArchive() && !isPartial() && (isZipNgFlagEnabled()
+                || !isInArchive()));
     }
 
     public boolean isVirtual() {
@@ -342,7 +344,6 @@ public class DocumentInfo implements Durable, Parcelable {
         return userId.buildDocumentUriAsUser(authority, documentId);
     }
 
-
     /**
      * Returns a tree document uri representing this {@link DocumentInfo}. The URI may contain user
      * information. Use this when uri is needed externally.
diff --git a/src/com/android/documentsui/base/Menus.java b/src/com/android/documentsui/base/Menus.java
index eba240c83..6ceea3269 100644
--- a/src/com/android/documentsui/base/Menus.java
+++ b/src/com/android/documentsui/base/Menus.java
@@ -19,6 +19,8 @@ package com.android.documentsui.base;
 import android.view.Menu;
 import android.view.MenuItem;
 
+import androidx.annotation.NonNull;
+
 public final class Menus {
 
     private Menus() {}
@@ -41,7 +43,7 @@ public final class Menus {
     }
 
     /** Set enabled/disabled state of a menuItem, and updates its visibility. */
-    public static void setEnabledAndVisible(MenuItem item, boolean enabled) {
+    public static void setEnabledAndVisible(@NonNull MenuItem item, boolean enabled) {
         item.setEnabled(enabled);
         item.setVisible(enabled);
     }
diff --git a/src/com/android/documentsui/base/UserId.java b/src/com/android/documentsui/base/UserId.java
index 21842917a..7aff61e9b 100644
--- a/src/com/android/documentsui/base/UserId.java
+++ b/src/com/android/documentsui/base/UserId.java
@@ -94,6 +94,13 @@ public final class UserId {
 
     }
 
+    /**
+     * Return this User's {@link UserHandle}.
+     */
+    public UserHandle getUserHandle() {
+        return mUserHandle;
+    }
+
     /**
      * Return a package manager instance of this user.
      */
diff --git a/src/com/android/documentsui/dirlist/AnimationView.java b/src/com/android/documentsui/dirlist/AnimationView.java
index d17bddf98..5813085b3 100644
--- a/src/com/android/documentsui/dirlist/AnimationView.java
+++ b/src/com/android/documentsui/dirlist/AnimationView.java
@@ -16,19 +16,22 @@
 
 package com.android.documentsui.dirlist;
 
-import androidx.annotation.IntDef;
-import androidx.fragment.app.FragmentTransaction;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.content.Context;
 import android.os.Bundle;
 import android.util.AttributeSet;
 import android.widget.LinearLayout;
 
+import androidx.annotation.IntDef;
+import androidx.fragment.app.FragmentTransaction;
+
 import com.android.documentsui.R;
 import com.android.documentsui.base.Shared;
 
 import java.lang.annotation.Retention;
 import java.lang.annotation.RetentionPolicy;
+import java.util.ArrayList;
 
 /**
  * This class exists solely to support animated transition of our directory fragment.
@@ -51,6 +54,8 @@ public class AnimationView extends LinearLayout {
     public static final int ANIM_LEAVE = 3;
     public static final int ANIM_ENTER = 4;
 
+    private final ArrayList<OnSizeChangedListener> mOnSizeChangedListeners = new ArrayList<>();
+
     private float mPosition = 0f;
 
     // The distance the animation will cover...currently matches the height of the
@@ -65,11 +70,45 @@ public class AnimationView extends LinearLayout {
         super(context, attrs);
     }
 
+    /**
+     * A listener of the onSizeChanged method.
+     */
+    public interface OnSizeChangedListener {
+        /**
+         * Called on the View's onSizeChanged.
+         */
+        void onSizeChanged();
+    }
+
+    /**
+     * Adds a listener of the onSizeChanged method.
+     */
+    public void addOnSizeChangedListener(OnSizeChangedListener listener) {
+        if (isUseMaterial3FlagEnabled()) {
+            mOnSizeChangedListeners.add(listener);
+        }
+    }
+
+    /**
+     * Removes a listener of the onSizeChanged method.
+     */
+    public void removeOnSizeChangedListener(OnSizeChangedListener listener) {
+        if (isUseMaterial3FlagEnabled()) {
+            mOnSizeChangedListeners.remove(listener);
+        }
+    }
+
+
     @Override
     protected void onSizeChanged(int w, int h, int oldw, int oldh) {
         super.onSizeChanged(w, h, oldw, oldh);
         mSpan = h;
         setPosition(mPosition);
+        if (isUseMaterial3FlagEnabled()) {
+            for (int i = mOnSizeChangedListeners.size() - 1; i >= 0; --i) {
+                mOnSizeChangedListeners.get(i).onSizeChanged();
+            }
+        }
     }
 
     public float getPosition() {
diff --git a/src/com/android/documentsui/dirlist/AppsRowManager.java b/src/com/android/documentsui/dirlist/AppsRowManager.java
index 297d1b2e3..eb0d8bf2e 100644
--- a/src/com/android/documentsui/dirlist/AppsRowManager.java
+++ b/src/com/android/documentsui/dirlist/AppsRowManager.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.text.TextUtils;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -45,6 +47,7 @@ import java.util.Map;
 
 /**
  * A manager class stored apps row chip data list. Data will be synced by RootsFragment.
+ * TODO(b/379776735): Remove this after use_material3 flag is launched.
  */
 public class AppsRowManager {
 
@@ -102,6 +105,10 @@ public class AppsRowManager {
     }
 
     private boolean shouldShow(State state, boolean isSearchExpanded) {
+        if (isUseMaterial3FlagEnabled()) {
+            return false;
+        }
+
         boolean isHiddenAction = state.action == State.ACTION_CREATE
                 || state.action == State.ACTION_OPEN_TREE
                 || state.action == State.ACTION_PICK_COPY_DESTINATION;
diff --git a/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java b/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
index 8989853a0..8be400924 100644
--- a/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
+++ b/src/com/android/documentsui/dirlist/DirectoryAddonsAdapter.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.os.UserManager;
 import android.view.ViewGroup;
 
@@ -207,6 +209,11 @@ final class DirectoryAddonsAdapter extends DocumentsAdapter {
             return;
         }
 
+        if (isUseMaterial3FlagEnabled()) {
+            // Do not add a visual break between folders and documents in Material3.
+            return;
+        }
+
         // Walk down the list of IDs till we encounter something that's not a directory, and
         // insert a whitespace element - this introduces a visual break in the grid between
         // folders and documents.
diff --git a/src/com/android/documentsui/dirlist/DirectoryFragment.java b/src/com/android/documentsui/dirlist/DirectoryFragment.java
index e099ca734..2911d04e9 100644
--- a/src/com/android/documentsui/dirlist/DirectoryFragment.java
+++ b/src/com/android/documentsui/dirlist/DirectoryFragment.java
@@ -21,6 +21,9 @@ import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
 import static com.android.documentsui.base.State.MODE_GRID;
 import static com.android.documentsui.base.State.MODE_LIST;
+import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import android.app.ActivityManager;
 import android.content.BroadcastReceiver;
@@ -105,6 +108,7 @@ import com.android.documentsui.clipping.ClipStore;
 import com.android.documentsui.clipping.DocumentClipper;
 import com.android.documentsui.clipping.UrisSupplier;
 import com.android.documentsui.dirlist.AnimationView.AnimationType;
+import com.android.documentsui.dirlist.AnimationView.OnSizeChangedListener;
 import com.android.documentsui.picker.PickActivity;
 import com.android.documentsui.services.FileOperation;
 import com.android.documentsui.services.FileOperationService;
@@ -185,7 +189,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     private SelectionMetadata mSelectionMetadata;
     private KeyInputHandler mKeyListener;
     private @Nullable DragHoverListener mDragHoverListener;
-    private View mRootView;
+    private AnimationView mRootView;
     private IconHelper mIconHelper;
     private SwipeRefreshLayout mRefreshLayout;
     private RecyclerView mRecView;
@@ -413,13 +417,27 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                 || Intent.ACTION_MANAGED_PROFILE_UNAVAILABLE.equals(action);
     }
 
+    private OnSizeChangedListener mOnSizeChangedListener =
+            new AnimationView.OnSizeChangedListener() {
+                @Override
+                public void onSizeChanged() {
+                    if (isUseMaterial3FlagEnabled() && mState.derivedMode != MODE_LIST) {
+                        // Update the grid layout when the window size changes.
+                        updateLayout(mState.derivedMode);
+                    }
+                }
+            };
+
     @Override
     public View onCreateView(
             LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 
         mHandler = new Handler(Looper.getMainLooper());
         mActivity = (BaseActivity) getActivity();
-        mRootView = inflater.inflate(R.layout.fragment_directory, container, false);
+        mRootView = (AnimationView) inflater.inflate(R.layout.fragment_directory, container, false);
+        if (isUseMaterial3FlagEnabled()) {
+            mRootView.addOnSizeChangedListener(mOnSizeChangedListener);
+        }
 
         mProgressBar = mRootView.findViewById(R.id.progressbar);
         assert mProgressBar != null;
@@ -494,6 +512,10 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         mModel.removeUpdateListener(mAdapter.getModelUpdateListener());
         setPreDrawListenerEnabled(false);
 
+        if (isUseMaterial3FlagEnabled()) {
+            mRootView.removeOnSizeChangedListener(mOnSizeChangedListener);
+        }
+
         super.onDestroyView();
     }
 
@@ -609,11 +631,16 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         new RefreshHelper(mRefreshLayout::setEnabled)
                 .attach(mRecView);
 
-        mActionModeController = mInjector.getActionModeController(
-                mSelectionMetadata,
-                this::handleMenuItemClick);
-
-        mSelectionMgr.addObserver(mActionModeController);
+        if (isUseMaterial3FlagEnabled()) {
+            mSelectionMgr.addObserver(mActivity.getNavigator());
+            mActivity.getNavigator().updateSelection(mSelectionMetadata, this::handleMenuItemClick);
+        } else {
+            mActionModeController =
+                    mInjector.getActionModeController(
+                            mSelectionMetadata, this::handleMenuItemClick);
+            assert (mActionModeController != null);
+            mSelectionMgr.addObserver(mActionModeController);
+        }
 
         mProfileTabsController = mInjector.profileTabsController;
         mSelectionMgr.addObserver(mProfileTabsController);
@@ -801,7 +828,6 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         if (mLayout != null) {
             mLayout.setSpanCount(mColumnCount);
         }
-
         int pad = getDirectoryPadding(mode);
         mAppBarHeight = getAppBarLayoutHeight();
         mSaveLayoutHeight = getSaveLayoutHeight();
@@ -820,6 +846,13 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
     }
 
     private int getSaveLayoutHeight() {
+        // When use_material3 flag is on, the bottom section not only includes the container_save,
+        // but also includes the breadcrumb and the divider, so we need to use the total height
+        // for their parent container.
+        if (isUseMaterial3FlagEnabled()) {
+            View bottomSection = getActivity().findViewById(R.id.bottom_container);
+            return bottomSection == null ? 0 : bottomSection.getHeight();
+        }
         View containerSave = getActivity().findViewById(R.id.container_save);
         return containerSave == null ? 0 : containerSave.getHeight();
     }
@@ -916,6 +949,14 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         }
     }
 
+    private void closeSelectionBar() {
+        if (isUseMaterial3FlagEnabled()) {
+            mActivity.getNavigator().closeSelectionBar();
+        } else {
+            mActionModeController.finishActionMode();
+        }
+    }
+
     private boolean handleMenuItemClick(MenuItem item) {
         if (mInjector.pickResult != null) {
             mInjector.pickResult.increaseActionCount();
@@ -924,9 +965,21 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         mSelectionMgr.copySelection(selection);
 
         final int id = item.getItemId();
-        if (id == R.id.action_menu_select || id == R.id.dir_menu_open) {
+        if ((isDesktopFileHandlingFlagEnabled() && id == R.id.dir_menu_open)
+                || (isZipNgFlagEnabled() && id == R.id.dir_menu_browse)) {
+            // The "Open" menu item is displayed in desktop mode.
+            // The "Browse" menu item is displayed for supported archives in advanced ZIP mode.
+            // These menu items behave the same as a double click on the matching document which
+            // is handled by onItemActivated but since onItemActivated requires a RecyclerView
+            // ItemDetails, we're using viewDocument that takes a Selection.
+            viewDocument(selection);
+            return true;
+        } else if (id == R.id.action_menu_select || id == R.id.dir_menu_open) {
+            // Note: this code path is never executed for `dir_menu_open`. The menu item is always
+            // hidden unless the desktopFileHandling flag is enabled, in which case the menu item
+            // will be handled by the condition above.
             openDocuments(selection);
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             return true;
         } else if (id == R.id.action_menu_open_with || id == R.id.dir_menu_open_with) {
             showChooserForDoc(selection);
@@ -946,22 +999,22 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             transferDocuments(selection, null, FileOperationService.OPERATION_COPY);
             // TODO: Only finish selection mode if copy-to is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             return true;
         } else if (id == R.id.action_menu_compress || id == R.id.dir_menu_compress) {
             transferDocuments(selection, mState.stack,
                     FileOperationService.OPERATION_COMPRESS);
             // TODO: Only finish selection mode if compress is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             return true;
 
             // TODO: Implement extract (to the current directory).
-        } else if (id == R.id.action_menu_extract_to) {
+        } else if (id == R.id.action_menu_extract_to || id == R.id.option_menu_extract_all) {
             transferDocuments(selection, null, FileOperationService.OPERATION_EXTRACT);
             // TODO: Only finish selection mode if compress-to is not canceled.
             // Need to plum down into handling the way we do with deleteDocuments.
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             return true;
         } else if (id == R.id.action_menu_move_to) {
             if (mModel.hasDocuments(selection, DocumentFilters.NOT_MOVABLE)) {
@@ -969,17 +1022,17 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                 return true;
             }
             // Exit selection mode first, so we avoid deselecting deleted documents.
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             transferDocuments(selection, null, FileOperationService.OPERATION_MOVE);
             return true;
         } else if (id == R.id.action_menu_inspect || id == R.id.dir_menu_inspect) {
-            mActionModeController.finishActionMode();
+            closeSelectionBar();
             assert selection.size() <= 1;
             DocumentInfo doc = selection.isEmpty()
                     ? mActivity.getCurrentDirectory()
                     : mModel.getDocuments(selection).get(0);
 
-            mActions.showInspector(doc);
+            mActions.showPreview(doc);
             return true;
         } else if (id == R.id.dir_menu_cut_to_clipboard) {
             mActions.cutToClipboard();
@@ -1012,9 +1065,11 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
             mActions.showSortDialog();
             return true;
         }
+
         if (DEBUG) {
-            Log.d(TAG, "Unhandled menu item selected: " + item);
+            Log.d(TAG, "Cannot handle unexpected menu item " + id);
         }
+
         return false;
     }
 
@@ -1080,6 +1135,20 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         mActions.showChooserForDoc(doc);
     }
 
+    private void viewDocument(final Selection<String> selected) {
+        Metrics.logUserAction(MetricConsts.USER_ACTION_OPEN);
+
+        if (selected.isEmpty()) {
+            return;
+        }
+
+        assert selected.size() == 1;
+        DocumentInfo doc =
+                DocumentInfo.fromDirectoryCursor(mModel.getItem(selected.iterator().next()));
+
+        mActions.openDocumentViewOnly(doc);
+    }
+
     private void transferDocuments(
             final Selection<String> selected, @Nullable DocumentStack destination,
             final @OpType int mode) {
@@ -1171,7 +1240,7 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
         intent.putExtra(FileOperationService.EXTRA_OPERATION_TYPE, mode);
 
         // This just identifies the type of request...we'll check it
-        // when we reveive a response.
+        // when we receive a response.
         startActivityForResult(intent, REQUEST_COPY_DESTINATION);
     }
 
@@ -1494,7 +1563,11 @@ public class DirectoryFragment extends Fragment implements SwipeRefreshLayout.On
                 // For orientation changed case, sometimes the docs loading comes after the menu
                 // update. We need to update the menu here to ensure the status is correct.
                 mInjector.menuManager.updateModel(mModel);
-                mInjector.menuManager.updateOptionMenu();
+                if (isUseMaterial3FlagEnabled()) {
+                    mActivity.getNavigator().updateActionMenu();
+                } else {
+                    mInjector.menuManager.updateOptionMenu();
+                }
                 if (VersionUtils.isAtLeastS()) {
                     mActivity.updateHeader(update.hasCrossProfileException());
                 } else {
diff --git a/src/com/android/documentsui/dirlist/DocumentHolder.java b/src/com/android/documentsui/dirlist/DocumentHolder.java
index 26f527896..957975c4b 100644
--- a/src/com/android/documentsui/dirlist/DocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/DocumentHolder.java
@@ -18,6 +18,7 @@ package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.DevicePolicyResources.Strings.PREVIEW_WORK_FILE_ACCESSIBILITY;
 import static com.android.documentsui.DevicePolicyResources.Strings.UNDEFINED;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -55,7 +56,7 @@ import javax.annotation.Nullable;
 public abstract class DocumentHolder
         extends RecyclerView.ViewHolder implements View.OnKeyListener {
 
-    static final float DISABLED_ALPHA = 0.3f;
+    static final float DISABLED_ALPHA = isUseMaterial3FlagEnabled() ? 0.6f : 0.3f;
 
     protected final Context mContext;
 
diff --git a/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java b/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
index 4b66b857f..64409673e 100644
--- a/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
+++ b/src/com/android/documentsui/dirlist/DocumentsSwipeRefreshLayout.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.dirlist;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
 import android.content.res.TypedArray;
 import android.util.AttributeSet;
@@ -26,6 +28,7 @@ import androidx.annotation.ColorRes;
 import androidx.swiperefreshlayout.widget.SwipeRefreshLayout;
 
 import com.android.documentsui.R;
+import com.android.documentsui.util.ColorUtils;
 
 /**
  * A {@link SwipeRefreshLayout} that does not intercept any touch events. This relies on its nested
@@ -42,20 +45,29 @@ public class DocumentsSwipeRefreshLayout extends SwipeRefreshLayout {
     public DocumentsSwipeRefreshLayout(Context context, AttributeSet attrs) {
         super(context, attrs);
 
-        final int[] styledAttrs = {android.R.attr.colorAccent};
+        if (isUseMaterial3FlagEnabled()) {
+            setColorSchemeColors(
+                    ColorUtils.resolveMaterialColorAttribute(
+                            context, com.google.android.material.R.attr.colorOnPrimaryContainer));
+            setProgressBackgroundColorSchemeColor(
+                    ColorUtils.resolveMaterialColorAttribute(
+                            context, com.google.android.material.R.attr.colorPrimaryContainer));
+        } else {
+            final int[] styledAttrs = {android.R.attr.colorAccent};
 
-        TypedArray a = context.obtainStyledAttributes(styledAttrs);
-        @ColorRes int colorId = a.getResourceId(0, -1);
-        if (colorId == -1) {
-            Log.w(TAG, "Retrieve colorAccent colorId from theme fail, assign R.color.primary");
-            colorId = R.color.primary;
+            TypedArray a = context.obtainStyledAttributes(styledAttrs);
+            @ColorRes int colorId = a.getResourceId(0, -1);
+            if (colorId == -1) {
+                Log.w(TAG, "Retrieve colorAccent colorId from theme fail, assign R.color.primary");
+                colorId = R.color.primary;
+            }
+            a.recycle();
+            setColorSchemeResources(colorId);
         }
-        a.recycle();
-        setColorSchemeResources(colorId);
     }
 
     @Override
     public boolean onInterceptTouchEvent(MotionEvent e) {
         return false;
     }
-}
\ No newline at end of file
+}
diff --git a/src/com/android/documentsui/dirlist/GridDirectoryHolder.java b/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
index 7e9a32df2..b7a8b6d05 100644
--- a/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
+++ b/src/com/android/documentsui/dirlist/GridDirectoryHolder.java
@@ -46,6 +46,7 @@ import com.android.modules.utils.build.SdkLevel;
 
 import java.util.Map;
 
+// TODO(b/379776735): remove this file after use_material3 flag is launched.
 final class GridDirectoryHolder extends DocumentHolder {
     final TextView mTitle;
 
diff --git a/src/com/android/documentsui/dirlist/GridDocumentHolder.java b/src/com/android/documentsui/dirlist/GridDocumentHolder.java
index eb35b1a5f..703f870e2 100644
--- a/src/com/android/documentsui/dirlist/GridDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/GridDocumentHolder.java
@@ -21,6 +21,7 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFI
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorLong;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -35,18 +36,23 @@ import android.view.ViewGroup;
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import androidx.annotation.Nullable;
 import androidx.annotation.RequiresApi;
 
 import com.android.documentsui.ConfigStore;
 import com.android.documentsui.DocumentsApplication;
+import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
+import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.roots.RootCursorWrapper;
 import com.android.documentsui.ui.Views;
 import com.android.modules.utils.build.SdkLevel;
 
+import com.google.android.material.card.MaterialCardView;
+
 import java.util.Map;
 import java.util.function.Function;
 
@@ -55,33 +61,65 @@ final class GridDocumentHolder extends DocumentHolder {
     final TextView mTitle;
     final TextView mDate;
     final TextView mDetails;
+    // Non-null only when useMaterial3 flag is ON.
+    final @Nullable TextView mBullet;
     final ImageView mIconMimeLg;
-    final ImageView mIconMimeSm;
+    // Null when useMaterial3 flag is ON.
+    final @Nullable ImageView mIconMimeSm;
     final ImageView mIconThumb;
-    final ImageView mIconCheck;
+    // Null when useMaterial3 flag is ON.
+    final @Nullable ImageView mIconCheck;
     final ImageView mIconBadge;
     final IconHelper mIconHelper;
-    final View mIconLayout;
+    // Null when useMaterial3 flag is ON.
+    final @Nullable View mIconLayout;
     final View mPreviewIcon;
 
     // This is used in as a convenience in our bind method.
     private final DocumentInfo mDoc = new DocumentInfo();
 
+    // Non-null only when useMaterial3 flag is ON.
+    private final @Nullable MaterialCardView mIconWrapper;
+    // It will be 0 when use_material flag is OFF.
+    private final int mThumbnailStrokeWidth;
+
     GridDocumentHolder(Context context, ViewGroup parent, IconHelper iconHelper,
             ConfigStore configStore) {
         super(context, parent, R.layout.item_doc_grid, configStore);
 
-        mIconLayout = itemView.findViewById(R.id.icon);
+        if (isUseMaterial3FlagEnabled()) {
+            mBullet = itemView.findViewById(R.id.bullet);
+            mIconWrapper = itemView.findViewById(R.id.icon_wrapper);
+            mIconLayout = null;
+            mIconMimeSm = null;
+            mIconCheck = null;
+            mThumbnailStrokeWidth =
+                    context.getResources()
+                            .getDimensionPixelSize(R.dimen.thumbnail_border_width);
+        } else {
+            mBullet = null;
+            mIconWrapper = null;
+            mIconLayout = itemView.findViewById(R.id.icon);
+            mIconMimeSm = (ImageView) itemView.findViewById(R.id.icon_mime_sm);
+            mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
+            mThumbnailStrokeWidth = 0;
+        }
+
         mTitle = (TextView) itemView.findViewById(android.R.id.title);
         mDate = (TextView) itemView.findViewById(R.id.date);
         mDetails = (TextView) itemView.findViewById(R.id.details);
         mIconMimeLg = (ImageView) itemView.findViewById(R.id.icon_mime_lg);
-        mIconMimeSm = (ImageView) itemView.findViewById(R.id.icon_mime_sm);
         mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);
-        mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
         mIconBadge = (ImageView) itemView.findViewById(R.id.icon_profile_badge);
         mPreviewIcon = itemView.findViewById(R.id.preview_icon);
 
+        if (isUseMaterial3FlagEnabled()) {
+            int clipCornerRadius = context.getResources()
+                    .getDimensionPixelSize(R.dimen.thumbnail_clip_corner_radius);
+            IconUtils.applyThumbnailClipOutline(
+                    mIconThumb, mThumbnailStrokeWidth, clipCornerRadius);
+        }
+
         mIconHelper = iconHelper;
 
         if (SdkLevel.isAtLeastT() && !mConfigStore.isPrivateSpaceInDocsUIEnabled()) {
@@ -99,17 +137,20 @@ final class GridDocumentHolder extends DocumentHolder {
 
     @Override
     public void setSelected(boolean selected, boolean animate) {
-        // We always want to make sure our check box disappears if we're not selected,
-        // even if the item is disabled. This is because this object can be reused
-        // and this method will be called to setup initial state.
         float checkAlpha = selected ? 1f : 0f;
-        if (animate) {
-            fade(mIconMimeSm, checkAlpha).start();
-            fade(mIconCheck, checkAlpha).start();
-        } else {
-            mIconCheck.setAlpha(checkAlpha);
+        if (!isUseMaterial3FlagEnabled()) {
+            // We always want to make sure our check box disappears if we're not selected,
+            // even if the item is disabled. This is because this object can be reused
+            // and this method will be called to setup initial state.
+            if (animate) {
+                fade(mIconMimeSm, checkAlpha).start();
+                fade(mIconCheck, checkAlpha).start();
+            } else {
+                mIconCheck.setAlpha(checkAlpha);
+            }
         }
 
+
         // But it should be an error to be set to selected && be disabled.
         if (!itemView.isEnabled()) {
             assert (!selected);
@@ -117,10 +158,21 @@ final class GridDocumentHolder extends DocumentHolder {
 
         super.setSelected(selected, animate);
 
-        if (animate) {
-            fade(mIconMimeSm, 1f - checkAlpha).start();
-        } else {
-            mIconMimeSm.setAlpha(1f - checkAlpha);
+        if (!isUseMaterial3FlagEnabled()) {
+            if (animate) {
+                fade(mIconMimeSm, 1f - checkAlpha).start();
+            } else {
+                mIconMimeSm.setAlpha(1f - checkAlpha);
+            }
+        }
+
+        // Do not show stroke when selected, only show stroke when not selected if it has thumbnail.
+        if (mIconWrapper != null) {
+            if (selected) {
+                mIconWrapper.setStrokeWidth(0);
+            } else if (mIconThumb.getDrawable() != null) {
+                mIconWrapper.setStrokeWidth(mThumbnailStrokeWidth);
+            }
         }
     }
 
@@ -131,19 +183,26 @@ final class GridDocumentHolder extends DocumentHolder {
         float imgAlpha = enabled ? 1f : DISABLED_ALPHA;
 
         mIconMimeLg.setAlpha(imgAlpha);
-        mIconMimeSm.setAlpha(imgAlpha);
+        if (!isUseMaterial3FlagEnabled()) {
+            mIconMimeSm.setAlpha(imgAlpha);
+        }
         mIconThumb.setAlpha(imgAlpha);
     }
 
     @Override
     public void bindPreviewIcon(boolean show, Function<View, Boolean> clickCallback) {
+        if (isUseMaterial3FlagEnabled() && mDoc.isDirectory()) {
+            mPreviewIcon.setVisibility(View.GONE);
+            return;
+        }
         mPreviewIcon.setVisibility(show ? View.VISIBLE : View.GONE);
         if (show) {
             mPreviewIcon.setContentDescription(
                     getPreviewIconContentDescription(
                             mIconHelper.shouldShowBadge(mDoc.userId.getIdentifier()),
                             mDoc.displayName, mDoc.userId));
-            mPreviewIcon.setAccessibilityDelegate(new PreviewAccessibilityDelegate(clickCallback));
+            mPreviewIcon.setAccessibilityDelegate(
+                    new PreviewAccessibilityDelegate(clickCallback));
         }
     }
 
@@ -171,6 +230,10 @@ final class GridDocumentHolder extends DocumentHolder {
 
     @Override
     public boolean inSelectRegion(MotionEvent event) {
+        if (isUseMaterial3FlagEnabled()) {
+            return (mDoc.isDirectory() && !(mAction == State.ACTION_BROWSE)) ? false
+                    : Views.isEventOver(event, itemView.getParent(), mIconWrapper);
+        }
         return Views.isEventOver(event, itemView.getParent(), mIconLayout);
     }
 
@@ -202,7 +265,21 @@ final class GridDocumentHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
-        mIconHelper.load(mDoc, mIconThumb, mIconMimeLg, mIconMimeSm);
+        if (isUseMaterial3FlagEnabled()) {
+            mIconHelper.load(
+                    mDoc, mIconThumb, mIconMimeLg, /* subIconMime= */ null,
+                    thumbnailLoaded -> {
+                        // Show stroke when thumbnail is loaded.
+                        if (mIconWrapper != null) {
+                            mIconWrapper.setStrokeWidth(
+                                    thumbnailLoaded ? mThumbnailStrokeWidth : 0);
+                        }
+                    });
+        } else {
+            mIconHelper.load(
+                    mDoc, mIconThumb, mIconMimeLg, mIconMimeSm, /* thumbnailLoadedCallback= */
+                    null);
+        }
 
         mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
         mTitle.setVisibility(View.VISIBLE);
@@ -229,5 +306,11 @@ final class GridDocumentHolder extends DocumentHolder {
                 mDetails.setText(Formatter.formatFileSize(mContext, docSize));
             }
         }
+
+        if (mBullet != null && (mDetails.getText() == null || mDetails.getText().length() == 0
+                || mDate.getText() == null || mDate.getText().length() == 0)) {
+            // There is no need for the bullet separating the details and date.
+            mBullet.setVisibility(View.GONE);
+        }
     }
 }
diff --git a/src/com/android/documentsui/dirlist/GridPhotoHolder.java b/src/com/android/documentsui/dirlist/GridPhotoHolder.java
index e86d3131f..70c8a6ffc 100644
--- a/src/com/android/documentsui/dirlist/GridPhotoHolder.java
+++ b/src/com/android/documentsui/dirlist/GridPhotoHolder.java
@@ -189,7 +189,12 @@ final class GridPhotoHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
-        mIconHelper.load(mDoc, mIconThumb, mIconMimeLg, null);
+        mIconHelper.load(
+                mDoc,
+                mIconThumb,
+                mIconMimeLg,
+                /* subIconMime= */ null,
+                /* thumbnailLoadedCallback= */ null);
 
         final String docSize =
                 Formatter.formatFileSize(mContext, getCursorLong(cursor, Document.COLUMN_SIZE));
diff --git a/src/com/android/documentsui/dirlist/IconHelper.java b/src/com/android/documentsui/dirlist/IconHelper.java
index 44d1d95d3..6d53bbee1 100644
--- a/src/com/android/documentsui/dirlist/IconHelper.java
+++ b/src/com/android/documentsui/dirlist/IconHelper.java
@@ -52,6 +52,7 @@ import com.android.documentsui.base.UserId;
 import com.android.modules.utils.build.SdkLevel;
 
 import java.util.function.BiConsumer;
+import java.util.function.Consumer;
 
 /**
  * A class to assist with loading and managing the Images (i.e. thumbnails and icons) associated
@@ -151,14 +152,18 @@ public class IconHelper {
      * @param iconThumb   The itemview's thumbnail icon.
      * @param iconMime    The itemview's mime icon. Hidden when iconThumb is shown.
      * @param subIconMime The second itemview's mime icon. Always visible.
+     * @param thumbnailLoadedCallback The callback function which will be invoked after the
+     *                                thumbnail is loaded, with a boolean parameter to indicate
+     *                                if it's loaded or not.
      */
     public void load(
             DocumentInfo doc,
             ImageView iconThumb,
             ImageView iconMime,
-            @Nullable ImageView subIconMime) {
+            @Nullable ImageView subIconMime,
+            @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
         load(doc.derivedUri, doc.userId, doc.mimeType, doc.flags, doc.icon, doc.lastModified,
-                iconThumb, iconMime, subIconMime);
+                iconThumb, iconMime, subIconMime, thumbnailLoadedCallback);
     }
 
     /**
@@ -172,10 +177,13 @@ public class IconHelper {
      * @param iconThumb       The itemview's thumbnail icon.
      * @param iconMime        The itemview's mime icon. Hidden when iconThumb is shown.
      * @param subIconMime     The second itemview's mime icon. Always visible.
+     * @param thumbnailLoadedCallback The callback function which will be invoked after the
+     *                                thumbnail is loaded, with a boolean parameter to indicate
+     *                                if it's loaded or not.
      */
     public void load(Uri uri, UserId userId, String mimeType, int docFlags, int docIcon,
             long docLastModified, ImageView iconThumb, ImageView iconMime,
-            @Nullable ImageView subIconMime) {
+            @Nullable ImageView subIconMime, @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
         boolean loadedThumbnail = false;
 
         final String docAuthority = uri.getAuthority();
@@ -186,7 +194,14 @@ public class IconHelper {
         final boolean showThumbnail = supportsThumbnail && allowThumbnail && mThumbnailsEnabled;
         if (showThumbnail) {
             loadedThumbnail =
-                    loadThumbnail(uri, userId, docAuthority, docLastModified, iconThumb, iconMime);
+                    loadThumbnail(
+                            uri,
+                            userId,
+                            docAuthority,
+                            docLastModified,
+                            iconThumb,
+                            iconMime,
+                            thumbnailLoadedCallback);
         }
 
         final Drawable mimeIcon = getDocumentIcon(mContext, userId, docAuthority,
@@ -202,15 +217,22 @@ public class IconHelper {
             setMimeIcon(iconMime, mimeIcon);
             hideImageView(iconThumb);
         }
+        if (thumbnailLoadedCallback != null) {
+            thumbnailLoadedCallback.accept(loadedThumbnail);
+        }
     }
 
     private boolean loadThumbnail(Uri uri, UserId userId, String docAuthority, long docLastModified,
-            ImageView iconThumb, ImageView iconMime) {
+            ImageView iconThumb, ImageView iconMime,
+            @Nullable Consumer<Boolean> thumbnailLoadedCallback) {
         final Result result = mThumbnailCache.getThumbnail(uri, userId, mCurrentSize);
 
         try {
             final Bitmap cachedThumbnail = result.getThumbnail();
             iconThumb.setImageBitmap(cachedThumbnail);
+            if (thumbnailLoadedCallback != null) {
+                thumbnailLoadedCallback.accept(cachedThumbnail != null);
+            }
 
             boolean stale = (docLastModified > result.getLastModified());
             if (VERBOSE) {
@@ -230,6 +252,9 @@ public class IconHelper {
                                 iconThumb.setImageBitmap(bitmap);
                                 animator.accept(iconMime, iconThumb);
                             }
+                            if (thumbnailLoadedCallback != null) {
+                                thumbnailLoadedCallback.accept(bitmap != null);
+                            }
                         }, true /* addToCache */);
 
                 ProviderExecutor.forAuthority(docAuthority).execute(task);
diff --git a/src/com/android/documentsui/dirlist/ListDocumentHolder.java b/src/com/android/documentsui/dirlist/ListDocumentHolder.java
index 2c09d3aec..a0db097d0 100644
--- a/src/com/android/documentsui/dirlist/ListDocumentHolder.java
+++ b/src/com/android/documentsui/dirlist/ListDocumentHolder.java
@@ -20,6 +20,7 @@ import static com.android.documentsui.DevicePolicyResources.Drawables.Style.SOLI
 import static com.android.documentsui.DevicePolicyResources.Drawables.WORK_PROFILE_ICON;
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -42,6 +43,7 @@ import androidx.annotation.RequiresApi;
 
 import com.android.documentsui.ConfigStore;
 import com.android.documentsui.DocumentsApplication;
+import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Lookup;
@@ -52,6 +54,8 @@ import com.android.documentsui.roots.RootCursorWrapper;
 import com.android.documentsui.ui.Views;
 import com.android.modules.utils.build.SdkLevel;
 
+import com.google.android.material.card.MaterialCardView;
+
 import java.util.ArrayList;
 import java.util.Map;
 import java.util.function.Function;
@@ -67,12 +71,16 @@ final class ListDocumentHolder extends DocumentHolder {
     private final @Nullable LinearLayout mDetails;
     // TextView for date + size + summary, null only for tablets/sw720dp
     private final @Nullable TextView mMetadataView;
+    // Non-null only when use_material3 flag is ON.
+    private final @Nullable MaterialCardView mIconWrapper;
     private final ImageView mIconMime;
     private final ImageView mIconThumb;
     private final ImageView mIconCheck;
     private final ImageView mIconBadge;
     private final View mIconLayout;
     final View mPreviewIcon;
+    // It will be 0 when use_material flag is OFF.
+    private final int mThumbnailStrokeWidth;
 
     private final IconHelper mIconHelper;
     private final Lookup<String, String> mFileTypeLookup;
@@ -84,6 +92,8 @@ final class ListDocumentHolder extends DocumentHolder {
         super(context, parent, R.layout.item_doc_list, configStore);
 
         mIconLayout = itemView.findViewById(R.id.icon);
+        mIconWrapper =
+                isUseMaterial3FlagEnabled() ? itemView.findViewById(R.id.icon_wrapper) : null;
         mIconMime = (ImageView) itemView.findViewById(R.id.icon_mime);
         mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);
         mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);
@@ -96,6 +106,17 @@ final class ListDocumentHolder extends DocumentHolder {
         // Warning: mDetails view doesn't exists in layout-sw720dp-land layout
         mDetails = (LinearLayout) itemView.findViewById(R.id.line2);
         mPreviewIcon = itemView.findViewById(R.id.preview_icon);
+        if (isUseMaterial3FlagEnabled()) {
+            mThumbnailStrokeWidth =
+                    context.getResources()
+                            .getDimensionPixelSize(R.dimen.thumbnail_border_width);
+            int clipCornerRadius = context.getResources()
+                    .getDimensionPixelSize(R.dimen.thumbnail_clip_corner_radius);
+            IconUtils.applyThumbnailClipOutline(
+                    mIconThumb, mThumbnailStrokeWidth, clipCornerRadius);
+        } else {
+            mThumbnailStrokeWidth = 0;
+        }
 
         mIconHelper = iconHelper;
         mFileTypeLookup = fileTypeLookup;
@@ -139,16 +160,29 @@ final class ListDocumentHolder extends DocumentHolder {
             mIconMime.setAlpha(1f - checkAlpha);
             mIconThumb.setAlpha(1f - checkAlpha);
         }
+
+        // Do not show stroke when selected, only show stroke when not selected if it has thumbnail.
+        if (isUseMaterial3FlagEnabled() && mIconWrapper != null) {
+            if (selected) {
+                mIconWrapper.setStrokeWidth(0);
+            } else if (mIconThumb.getDrawable() != null) {
+                mIconWrapper.setStrokeWidth(mThumbnailStrokeWidth);
+            }
+        }
     }
 
     @Override
     public void setEnabled(boolean enabled) {
         super.setEnabled(enabled);
 
-        // Text colors enabled/disabled is handle via a color set.
-        final float imgAlpha = enabled ? 1f : DISABLED_ALPHA;
-        mIconMime.setAlpha(imgAlpha);
-        mIconThumb.setAlpha(imgAlpha);
+        if (isUseMaterial3FlagEnabled()) {
+            itemView.setAlpha(enabled ? 1f : DISABLED_ALPHA);
+        } else {
+            // Text colors enabled/disabled is handle via a color set.
+            final float imgAlpha = enabled ? 1f : DISABLED_ALPHA;
+            mIconMime.setAlpha(imgAlpha);
+            mIconThumb.setAlpha(imgAlpha);
+        }
     }
 
     @Override
@@ -243,7 +277,18 @@ final class ListDocumentHolder extends DocumentHolder {
         mIconThumb.animate().cancel();
         mIconThumb.setAlpha(0f);
 
-        mIconHelper.load(mDoc, mIconThumb, mIconMime, null);
+        mIconHelper.load(
+                mDoc,
+                mIconThumb,
+                mIconMime,
+                /* subIconMime= */ null,
+                thumbnailLoaded -> {
+                    // Show stroke when thumbnail is loaded.
+                    if (isUseMaterial3FlagEnabled() && mIconWrapper != null) {
+                        mIconWrapper.setStrokeWidth(
+                                thumbnailLoaded ? mThumbnailStrokeWidth : 0);
+                    }
+                });
 
         mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);
         mTitle.setVisibility(View.VISIBLE);
diff --git a/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java b/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
index fc60d07a3..112b70da8 100644
--- a/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
+++ b/src/com/android/documentsui/dirlist/ModelBackedDocumentsAdapter.java
@@ -20,6 +20,7 @@ import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
 import static com.android.documentsui.base.State.MODE_GRID;
 import static com.android.documentsui.base.State.MODE_LIST;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.database.Cursor;
 import android.provider.DocumentsContract.Document;
@@ -95,8 +96,12 @@ final class ModelBackedDocumentsAdapter extends DocumentsAdapter {
             case MODE_GRID:
                 switch (viewType) {
                     case ITEM_TYPE_DIRECTORY:
-                        holder =
-                                new GridDirectoryHolder(
+                        // Under the Material3 flag, the GridDocumentHolder is the holder for all
+                        // grid items.
+                        holder = isUseMaterial3FlagEnabled()
+                                ? new GridDocumentHolder(
+                                mEnv.getContext(), parent, mIconHelper, mConfigStore)
+                                : new GridDirectoryHolder(
                                         mEnv.getContext(), parent, mIconHelper, mConfigStore);
                         break;
                     case ITEM_TYPE_DOCUMENT:
diff --git a/src/com/android/documentsui/dirlist/SelectionMetadata.java b/src/com/android/documentsui/dirlist/SelectionMetadata.java
index 3abc3e190..0d0644502 100644
--- a/src/com/android/documentsui/dirlist/SelectionMetadata.java
+++ b/src/com/android/documentsui/dirlist/SelectionMetadata.java
@@ -18,6 +18,7 @@ package com.android.documentsui.dirlist;
 
 import static com.android.documentsui.base.DocumentInfo.getCursorInt;
 import static com.android.documentsui.base.DocumentInfo.getCursorString;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import android.database.Cursor;
 import android.provider.DocumentsContract.Document;
@@ -56,7 +57,13 @@ public class SelectionMetadata extends SelectionObserver<String>
     private int mWritableDirectoryCount = 0;
     private int mNoDeleteCount = 0;
     private int mNoRenameCount = 0;
+
+    /** Number of files that are located in mounted archives. */
     private int mInArchiveCount = 0;
+
+    /** Number of archives. */
+    private int mArchiveCount = 0;
+
     private boolean mSupportsSettings = false;
 
     public SelectionMetadata(Function<String, Cursor> docFinder) {
@@ -79,6 +86,9 @@ public class SelectionMetadata extends SelectionObserver<String>
             mDirectoryCount += delta;
         } else {
             mFileCount += delta;
+            if (ArchivesProvider.isSupportedArchiveType(mimeType)) {
+                mArchiveCount += delta;
+            }
         }
 
         final int docFlags = getCursorInt(cursor, Document.COLUMN_FLAGS);
@@ -97,9 +107,8 @@ public class SelectionMetadata extends SelectionObserver<String>
         if ((docFlags & Document.FLAG_PARTIAL) != 0) {
             mPartialCount += delta;
         }
-        mSupportsSettings = (docFlags & Document.FLAG_SUPPORTS_SETTINGS) != 0 &&
-                (mFileCount + mDirectoryCount) == 1;
 
+        mSupportsSettings = (docFlags & Document.FLAG_SUPPORTS_SETTINGS) != 0 && size() == 1;
 
         final String authority = getCursorString(cursor, RootCursorWrapper.COLUMN_AUTHORITY);
         if (ArchivesProvider.AUTHORITY.equals(authority)) {
@@ -115,6 +124,8 @@ public class SelectionMetadata extends SelectionObserver<String>
         mWritableDirectoryCount = 0;
         mNoDeleteCount = 0;
         mNoRenameCount = 0;
+        mInArchiveCount = 0;
+        mArchiveCount = 0;
     }
 
     @Override
@@ -142,6 +153,11 @@ public class SelectionMetadata extends SelectionObserver<String>
         return mInArchiveCount > 0;
     }
 
+    @Override
+    public boolean isArchive() {
+        return mDirectoryCount == 0 && mFileCount == 1 && mArchiveCount == 1;
+    }
+
     @Override
     public boolean canDelete() {
         return size() > 0 && mNoDeleteCount == 0;
@@ -168,7 +184,8 @@ public class SelectionMetadata extends SelectionObserver<String>
     }
 
     @Override
-    public boolean canOpenWith() {
-        return size() == 1 && mDirectoryCount == 0 && mInArchiveCount == 0 && mPartialCount == 0;
+    public boolean canOpen() {
+        return mFileCount == 1 && mDirectoryCount == 0 && mPartialCount == 0 && (
+                isZipNgFlagEnabled() || mInArchiveCount == 0);
     }
 }
diff --git a/src/com/android/documentsui/files/ActionHandler.java b/src/com/android/documentsui/files/ActionHandler.java
index 20b831856..cbe02dc25 100644
--- a/src/com/android/documentsui/files/ActionHandler.java
+++ b/src/com/android/documentsui/files/ActionHandler.java
@@ -19,10 +19,14 @@ package com.android.documentsui.files;
 import static android.content.ContentResolver.wrap;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUsePeekPreviewFlagEnabled;
 
 import android.app.DownloadManager;
 import android.content.ActivityNotFoundException;
 import android.content.ClipData;
+import android.content.ComponentName;
 import android.content.ContentProviderClient;
 import android.content.ContentResolver;
 import android.content.Intent;
@@ -67,6 +71,7 @@ import com.android.documentsui.clipping.DocumentClipper;
 import com.android.documentsui.clipping.UrisSupplier;
 import com.android.documentsui.dirlist.AnimationView;
 import com.android.documentsui.inspector.InspectorActivity;
+import com.android.documentsui.peek.PeekViewManager;
 import com.android.documentsui.queries.SearchViewManager;
 import com.android.documentsui.roots.ProvidersAccess;
 import com.android.documentsui.services.FileOperation;
@@ -96,6 +101,8 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
     private final DocumentClipper mClipper;
     private final ClipStore mClipStore;
     private final DragAndDropManager mDragAndDropManager;
+    private final Runnable mCloseSelectionBar;
+    private final @Nullable PeekViewManager mPeekViewManager;
 
     ActionHandler(
             T activity,
@@ -104,20 +111,24 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
             DocumentsAccess docs,
             SearchViewManager searchMgr,
             Lookup<String, Executor> executors,
-            ActionModeAddons actionModeAddons,
+            @Nullable ActionModeAddons actionModeAddons,
+            Runnable closeSelectionBar,
             DocumentClipper clipper,
             ClipStore clipStore,
             DragAndDropManager dragAndDropManager,
+            @Nullable PeekViewManager peekViewManager,
             Injector injector) {
 
         super(activity, state, providers, docs, searchMgr, executors, injector);
 
         mActionModeAddons = actionModeAddons;
+        mCloseSelectionBar = closeSelectionBar;
         mFeatures = injector.features;
         mConfig = injector.config;
         mClipper = clipper;
         mClipStore = clipStore;
         mDragAndDropManager = dragAndDropManager;
+        mPeekViewManager = peekViewManager;
     }
 
     @Override
@@ -220,10 +231,20 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
         return false;
     }
 
+    @Override
+    public void openDocumentViewOnly(DocumentInfo doc) {
+        mInjector.searchManager.recordHistory();
+        openDocument(doc, VIEW_TYPE_REGULAR, VIEW_TYPE_NONE);
+    }
+
     @Override
     public void springOpenDirectory(DocumentInfo doc) {
-        assert(doc.isDirectory());
-        mActionModeAddons.finishActionMode();
+        assert (doc.isDirectory());
+        if (isUseMaterial3FlagEnabled()) {
+            mCloseSelectionBar.run();
+        } else {
+            mActionModeAddons.finishActionMode();
+        }
         openContainerDocument(doc);
     }
 
@@ -315,7 +336,11 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
             return;
         }
 
-        mActionModeAddons.finishActionMode();
+        if (isUseMaterial3FlagEnabled()) {
+            mCloseSelectionBar.run();
+        } else {
+            mActionModeAddons.finishActionMode();
+        }
 
         List<Uri> uris = new ArrayList<>(docs.size());
         for (DocumentInfo doc : docs) {
@@ -543,17 +568,27 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
             return;
         }
 
-        Intent intent = Intent.createChooser(buildViewIntent(doc), null);
-        intent.putExtra(Intent.EXTRA_AUTO_LAUNCH_SINGLE_CHOICE, false);
-        try {
-            doc.userId.startActivityAsUser(mActivity, intent);
-        } catch (ActivityNotFoundException e) {
-            mDialogs.showNoApplicationFound();
+        if (isDesktopFileHandlingFlagEnabled()) {
+            Intent intent = buildViewIntent(doc);
+            intent.setComponent(
+                    new ComponentName("android", "com.android.internal.app.ResolverActivity"));
+            try {
+                doc.userId.startActivityAsUser(mActivity, intent);
+            } catch (ActivityNotFoundException e) {
+                mDialogs.showNoApplicationFound();
+            }
+        } else {
+            Intent intent = Intent.createChooser(buildViewIntent(doc), null);
+            intent.putExtra(Intent.EXTRA_AUTO_LAUNCH_SINGLE_CHOICE, false);
+            try {
+                doc.userId.startActivityAsUser(mActivity, intent);
+            } catch (ActivityNotFoundException e) {
+                mDialogs.showNoApplicationFound();
+            }
         }
     }
 
-    @Override
-    public void showInspector(DocumentInfo doc) {
+    private void showInspector(DocumentInfo doc) {
         Metrics.logUserAction(MetricConsts.USER_ACTION_INSPECTOR);
         Intent intent = InspectorActivity.createIntent(mActivity, doc.derivedUri, doc.userId);
 
@@ -577,4 +612,19 @@ public class ActionHandler<T extends FragmentActivity & AbstractActionHandler.Co
         }
         mActivity.startActivity(intent);
     }
+
+    private void showPeek(DocumentInfo doc) {
+        if (mPeekViewManager != null) {
+            mPeekViewManager.peekDocument(doc);
+        }
+    }
+
+    @Override
+    public void showPreview(DocumentInfo doc) {
+        if (isUsePeekPreviewFlagEnabled()) {
+            showPeek(doc);
+        } else {
+            showInspector(doc);
+        }
+    }
 }
diff --git a/src/com/android/documentsui/files/FilesActivity.java b/src/com/android/documentsui/files/FilesActivity.java
index 1ebe2374f..b254ce525 100644
--- a/src/com/android/documentsui/files/FilesActivity.java
+++ b/src/com/android/documentsui/files/FilesActivity.java
@@ -17,12 +17,17 @@
 package com.android.documentsui.files;
 
 import static com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_UNKNOWN;
+import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
 
 import android.app.ActivityManager.TaskDescription;
 import android.content.Intent;
 import android.graphics.Color;
 import android.net.Uri;
 import android.os.Bundle;
+import android.util.Log;
 import android.view.KeyEvent;
 import android.view.KeyboardShortcutGroup;
 import android.view.Menu;
@@ -130,31 +135,37 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
                         return clipper.hasItemsToPaste();
                     }
                 },
-                getApplicationContext(),
+                isVisualSignalsFlagEnabled() ? this : getApplicationContext(),
                 mInjector.selectionMgr,
                 mProviders::getApplicationName,
                 mInjector.getModel()::getItemUri,
                 mInjector.getModel()::getItemCount);
 
-        mInjector.actionModeController = new ActionModeController(
-                this,
-                mInjector.selectionMgr,
-                mNavigator,
-                mInjector.menuManager,
-                mInjector.messages);
+        if (!isUseMaterial3FlagEnabled()) {
+            mInjector.actionModeController =
+                    new ActionModeController(
+                            this,
+                            mInjector.selectionMgr,
+                            mNavigator,
+                            mInjector.menuManager,
+                            mInjector.messages);
+        }
 
-        mInjector.actions = new ActionHandler<>(
-                this,
-                mState,
-                mProviders,
-                mDocs,
-                mSearchManager,
-                ProviderExecutor::forAuthority,
-                mInjector.actionModeController,
-                clipper,
-                DocumentsApplication.getClipStore(this),
-                DocumentsApplication.getDragAndDropManager(this),
-                mInjector);
+        mInjector.actions =
+                new ActionHandler<>(
+                        this,
+                        mState,
+                        mProviders,
+                        mDocs,
+                        mSearchManager,
+                        ProviderExecutor::forAuthority,
+                        mInjector.actionModeController,
+                        getNavigator()::closeSelectionBar,
+                        clipper,
+                        DocumentsApplication.getClipStore(this),
+                        DocumentsApplication.getDragAndDropManager(this),
+                        mPeekViewManager,
+                        mInjector);
 
         mInjector.searchManager = mSearchManager;
 
@@ -181,6 +192,14 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
 
         RootsFragment.show(getSupportFragmentManager(), /* includeApps= */ false,
                 /* intent= */ null);
+        if (isUseMaterial3FlagEnabled()) {
+            View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+            if (navRailRoots != null) {
+                // Medium layout, populate navigation rail layout.
+                RootsFragment.showNavRail(getSupportFragmentManager(), /* includeApps= */ false,
+                        /* intent= */ null);
+            }
+        }
 
         final Intent intent = getIntent();
 
@@ -193,9 +212,13 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
             updateTaskDescription(intent);
         }
 
-        // Set save container background to transparent for edge to edge nav bar.
-        View saveContainer = findViewById(R.id.container_save);
-        saveContainer.setBackgroundColor(Color.TRANSPARENT);
+        // When the use_material3 flag is on, the file path bar is at the bottom of the layout and
+        // hence the edge to edge nav bar is no longer required.
+        if (!isUseMaterial3FlagEnabled()) {
+            // Set save container background to transparent for edge to edge nav bar.
+            View saveContainer = findViewById(R.id.container_save);
+            saveContainer.setBackgroundColor(Color.TRANSPARENT);
+        }
 
         presentFileErrors(icicle, intent);
     }
@@ -315,7 +338,9 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
     @Override
     public boolean onPrepareOptionsMenu(Menu menu) {
         super.onPrepareOptionsMenu(menu);
-        mInjector.menuManager.updateOptionMenu(menu);
+        if (!isUseMaterial3FlagEnabled()) {
+            mInjector.menuManager.updateOptionMenu(menu);
+        }
         return true;
     }
 
@@ -329,12 +354,22 @@ public class FilesActivity extends BaseActivity implements AbstractActionHandler
             mInjector.actions.openInNewWindow(mState.stack);
         } else if (id == R.id.option_menu_settings) {
             mInjector.actions.openSettings(getCurrentRoot());
+        } else if (id == R.id.option_menu_extract_all) {
+            if (!isZipNgFlagEnabled()) return false;
+            final DirectoryFragment dir = getDirectoryFragment();
+            if (dir == null) return false;
+            mInjector.actions.selectAllFiles();
+            return dir.onContextItemSelected(item);
         } else if (id == R.id.option_menu_select_all) {
             mInjector.actions.selectAllFiles();
         } else if (id == R.id.option_menu_inspect) {
-            mInjector.actions.showInspector(getCurrentDirectory());
+            mInjector.actions.showPreview(getCurrentDirectory());
         } else {
-            return super.onOptionsItemSelected(item);
+            final boolean ok = super.onOptionsItemSelected(item);
+            if (DEBUG && !ok) {
+                Log.d(TAG, "Unhandled option item " + id);
+            }
+            return ok;
         }
         return true;
     }
diff --git a/src/com/android/documentsui/files/MenuManager.java b/src/com/android/documentsui/files/MenuManager.java
index 742bc9739..2c85dcb01 100644
--- a/src/com/android/documentsui/files/MenuManager.java
+++ b/src/com/android/documentsui/files/MenuManager.java
@@ -16,6 +16,9 @@
 
 package com.android.documentsui.files;
 
+import static com.android.documentsui.util.FlagUtils.isDesktopFileHandlingFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
+
 import android.content.Context;
 import android.content.res.Resources;
 import android.net.Uri;
@@ -27,9 +30,12 @@ import android.view.MenuInflater;
 import android.view.MenuItem;
 import android.view.View;
 
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
 import androidx.fragment.app.Fragment;
 import androidx.recyclerview.selection.SelectionTracker;
 
+import com.android.documentsui.JobPanelController;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Features;
@@ -53,6 +59,7 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
     private final SelectionTracker<String> mSelectionManager;
     private final Lookup<String, Uri> mUriLookup;
     private final LookupApplicationName mAppNameLookup;
+    @Nullable private final JobPanelController mJobPanelController;
 
     public MenuManager(
             Features features,
@@ -72,6 +79,12 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         mSelectionManager = selectionManager;
         mAppNameLookup = appNameLookup;
         mUriLookup = uriLookup;
+
+        if (isVisualSignalsFlagEnabled()) {
+            mJobPanelController = new JobPanelController(context);
+        } else {
+            mJobPanelController = null;
+        }
     }
 
     @Override
@@ -138,6 +151,14 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         updateContextMenu(menu, selectionDetails);
     }
 
+    @Override
+    public void instantiateJobProgress(Menu menu) {
+        if (mJobPanelController == null) {
+            return;
+        }
+        mJobPanelController.setMenuItem(menu.findItem(R.id.option_menu_job_progress));
+    }
+
     @Override
     protected void updateSettings(MenuItem settings, RootInfo root) {
         Menus.setEnabledAndVisible(settings, root.hasSettings());
@@ -161,7 +182,13 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
 
     @Override
     protected void updateOpenWith(MenuItem openWith, SelectionDetails selectionDetails) {
-        Menus.setEnabledAndVisible(openWith, selectionDetails.canOpenWith());
+        Menus.setEnabledAndVisible(openWith, selectionDetails.canOpen());
+    }
+
+    @Override
+    protected void updateOpenInContextMenu(MenuItem open, SelectionDetails selectionDetails) {
+        Menus.setEnabledAndVisible(
+                open, isDesktopFileHandlingFlagEnabled() && selectionDetails.canOpen());
     }
 
     @Override
@@ -203,6 +230,16 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
         Menus.setEnabledAndVisible(extractTo, enabled);
     }
 
+    @Override
+    protected void updateExtractHere(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
+        Menus.setEnabledAndVisible(it, selection.isArchive());
+    }
+
+    @Override
+    protected void updateBrowse(@NonNull MenuItem it, @NonNull SelectionDetails selection) {
+        Menus.setEnabledAndVisible(it, selection.isArchive());
+    }
+
     @Override
     protected void updatePasteInto(MenuItem pasteInto, SelectionDetails selectionDetails) {
         Menus.setEnabledAndVisible(pasteInto,
@@ -217,6 +254,11 @@ public final class MenuManager extends com.android.documentsui.MenuManager {
                 && mDirDetails.hasItemsToPaste());
     }
 
+    @Override
+    protected void updateExtractAll(MenuItem it) {
+        Menus.setEnabledAndVisible(it, mDirDetails.isInArchive());
+    }
+
     @Override
     protected void updateSelectAll(MenuItem selectAll) {
         Menus.setEnabledAndVisible(selectAll, true);
diff --git a/src/com/android/documentsui/loaders/BaseFileLoader.kt b/src/com/android/documentsui/loaders/BaseFileLoader.kt
new file mode 100644
index 000000000..fcb1d4cb0
--- /dev/null
+++ b/src/com/android/documentsui/loaders/BaseFileLoader.kt
@@ -0,0 +1,208 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.content.Context
+import android.database.Cursor
+import android.database.MatrixCursor
+import android.database.MergeCursor
+import android.net.Uri
+import android.os.Bundle
+import android.os.CancellationSignal
+import android.os.RemoteException
+import android.provider.DocumentsContract.Document
+import android.util.Log
+import androidx.loader.content.AsyncTaskLoader
+import com.android.documentsui.DirectoryResult
+import com.android.documentsui.base.Lookup
+import com.android.documentsui.base.UserId
+import com.android.documentsui.roots.RootCursorWrapper
+
+const val TAG = "SearchV2"
+
+val FILE_ENTRY_COLUMNS = arrayOf(
+    Document.COLUMN_DOCUMENT_ID,
+    Document.COLUMN_MIME_TYPE,
+    Document.COLUMN_DISPLAY_NAME,
+    Document.COLUMN_LAST_MODIFIED,
+    Document.COLUMN_FLAGS,
+    Document.COLUMN_SUMMARY,
+    Document.COLUMN_SIZE,
+    Document.COLUMN_ICON,
+)
+
+fun emptyCursor(): Cursor {
+    return MatrixCursor(FILE_ENTRY_COLUMNS)
+}
+
+/**
+ * Helper function that returns a single, non-null cursor constructed from the given list of
+ * cursors.
+ */
+fun toSingleCursor(cursorList: List<Cursor>): Cursor {
+    if (cursorList.isEmpty()) {
+        return emptyCursor()
+    }
+    if (cursorList.size == 1) {
+        return cursorList[0]
+    }
+    return MergeCursor(cursorList.toTypedArray())
+}
+
+/**
+ * The base class for search and directory loaders. This class implements common functionality
+ * shared by these loaders. The extending classes should implement loadInBackground, which
+ * should call the queryLocation method.
+ */
+abstract class BaseFileLoader(
+    context: Context,
+    private val mUserIdList: List<UserId>,
+    protected val mMimeTypeLookup: Lookup<String, String>,
+) : AsyncTaskLoader<DirectoryResult>(context) {
+
+    private var mSignal: CancellationSignal? = null
+    private var mResult: DirectoryResult? = null
+
+    override fun cancelLoadInBackground() {
+        Log.d(TAG, "${this::class.simpleName}.cancelLoadInBackground")
+        super.cancelLoadInBackground()
+
+        synchronized(this) {
+            mSignal?.cancel()
+        }
+    }
+
+    override fun deliverResult(result: DirectoryResult?) {
+        Log.d(TAG, "${this::class.simpleName}.deliverResult")
+        if (isReset) {
+            closeResult(result)
+            return
+        }
+        val oldResult: DirectoryResult? = mResult
+        mResult = result
+
+        if (isStarted) {
+            super.deliverResult(result)
+        }
+
+        if (oldResult != null && oldResult !== result) {
+            closeResult(oldResult)
+        }
+    }
+
+    override fun onStartLoading() {
+        Log.d(TAG, "${this::class.simpleName}.onStartLoading")
+        val isCursorStale: Boolean = checkIfCursorStale(mResult)
+        if (mResult != null && !isCursorStale) {
+            deliverResult(mResult)
+        }
+        if (takeContentChanged() || mResult == null || isCursorStale) {
+            forceLoad()
+        }
+    }
+
+    override fun onStopLoading() {
+        Log.d(TAG, "${this::class.simpleName}.onStopLoading")
+        cancelLoad()
+    }
+
+    override fun onCanceled(result: DirectoryResult?) {
+        Log.d(TAG, "${this::class.simpleName}.onCanceled")
+        closeResult(result)
+    }
+
+    override fun onReset() {
+        Log.d(TAG, "${this::class.simpleName}.onReset")
+        super.onReset()
+
+        // Ensure the loader is stopped
+        onStopLoading()
+
+        closeResult(mResult)
+        mResult = null
+    }
+
+    /**
+     * Quietly closes the result cursor, if results are still available.
+     */
+    fun closeResult(result: DirectoryResult?) {
+        try {
+            result?.close()
+        } catch (e: Exception) {
+            Log.d(TAG, "Failed to close result", e)
+        }
+    }
+
+    private fun checkIfCursorStale(result: DirectoryResult?): Boolean {
+        if (result == null) {
+            return true
+        }
+        val cursor = result.cursor ?: return true
+        if (cursor.isClosed) {
+            return true
+        }
+        Log.d(TAG, "Long check of cursor staleness")
+        val count = cursor.count
+        if (!cursor.moveToPosition(-1)) {
+            return true
+        }
+        for (i in 1..count) {
+            if (!cursor.moveToNext()) {
+                return true
+            }
+        }
+        return false
+    }
+
+    /**
+     * A function that, for the specified location rooted in the root with the given rootId
+     * attempts to obtain a non-null cursor from the content provider client obtained for the
+     * given locationUri. It returns the first non-null cursor, if one can be found, or null,
+     * if it fails to query the given location for all known users.
+     */
+    fun queryLocation(
+        rootId: String,
+        locationUri: Uri,
+        queryArgs: Bundle?,
+        maxResults: Int,
+    ): Cursor? {
+        val authority = locationUri.authority ?: return null
+        for (userId in mUserIdList) {
+            Log.d(TAG, "BaseFileLoader.queryLocation for $userId at $locationUri")
+            val resolver = userId.getContentResolver(context)
+            try {
+                resolver.acquireUnstableContentProviderClient(
+                    authority
+                ).use { client ->
+                    if (client == null) {
+                        return null
+                    }
+                    try {
+                        val cursor =
+                            client.query(locationUri, null, queryArgs, mSignal) ?: return null
+                        return RootCursorWrapper(userId, authority, rootId, cursor, maxResults)
+                    } catch (e: RemoteException) {
+                        Log.d(TAG, "Failed to get cursor for $locationUri", e)
+                    }
+                }
+            } catch (e: Exception) {
+                Log.d(TAG, "Failed to get a content provider client for $locationUri", e)
+            }
+        }
+
+        return null
+    }
+}
diff --git a/src/com/android/documentsui/loaders/FolderLoader.kt b/src/com/android/documentsui/loaders/FolderLoader.kt
new file mode 100644
index 000000000..40c15dfe1
--- /dev/null
+++ b/src/com/android/documentsui/loaders/FolderLoader.kt
@@ -0,0 +1,82 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.content.Context
+import android.provider.DocumentsContract
+import com.android.documentsui.ContentLock
+import com.android.documentsui.DirectoryResult
+import com.android.documentsui.LockingContentObserver
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.base.FilteringCursorWrapper
+import com.android.documentsui.base.Lookup
+import com.android.documentsui.base.RootInfo
+import com.android.documentsui.base.UserId
+import com.android.documentsui.sorting.SortModel
+
+/**
+ * A specialization of the BaseFileLoader that loads the children of a single folder. To list
+ * a directory you need to provide:
+ *
+ *  - The current application context
+ *  - A content lock for which a locking content observer is built
+ *  - A list of user IDs on behalf of which the search is conducted
+ *  - The root info of the listed directory
+ *  - The document info of the listed directory
+ *  - a lookup from file extension to file type
+ *  - The model capable of sorting results
+ */
+class FolderLoader(
+    context: Context,
+    userIdList: List<UserId>,
+    mimeTypeLookup: Lookup<String, String>,
+    contentLock: ContentLock,
+    private val mRoot: RootInfo,
+    private val mListedDir: DocumentInfo,
+    private val mOptions: QueryOptions,
+    private val mSortModel: SortModel,
+) : BaseFileLoader(context, userIdList, mimeTypeLookup) {
+
+    // An observer registered on the cursor to force a reload if the cursor reports a change.
+    private val mObserver = LockingContentObserver(contentLock, this::onContentChanged)
+
+    // Creates a directory result object corresponding to the current parameters of the loader.
+    override fun loadInBackground(): DirectoryResult? {
+        val rejectBeforeTimestamp = mOptions.getRejectBeforeTimestamp()
+        val folderChildrenUri = DocumentsContract.buildChildDocumentsUri(
+            mListedDir.authority,
+            mListedDir.documentId
+        )
+        val cursor =
+            queryLocation(mRoot.rootId, folderChildrenUri, mOptions.otherQueryArgs, ALL_RESULTS)
+                ?: emptyCursor()
+        cursor.registerContentObserver(mObserver)
+
+        val filteredCursor = FilteringCursorWrapper(cursor)
+        filteredCursor.filterHiddenFiles(mOptions.showHidden)
+        filteredCursor.filterMimes(mOptions.acceptableMimeTypes, null)
+        if (rejectBeforeTimestamp > 0L) {
+            filteredCursor.filterLastModified(rejectBeforeTimestamp)
+        }
+        // TODO(b:380945065): Add filtering by category, such as images, audio, video.
+        val sortedCursor = mSortModel.sortCursor(filteredCursor, mMimeTypeLookup)
+
+        val result = DirectoryResult()
+        result.doc = mListedDir
+        result.cursor = sortedCursor
+        return result
+    }
+}
diff --git a/src/com/android/documentsui/loaders/QueryOptions.kt b/src/com/android/documentsui/loaders/QueryOptions.kt
new file mode 100644
index 000000000..385815e99
--- /dev/null
+++ b/src/com/android/documentsui/loaders/QueryOptions.kt
@@ -0,0 +1,90 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.os.Bundle
+import java.time.Duration
+
+/**
+ * The constant to be used for the maxResults parameter, if we wish to get all (unlimited) results.
+ */
+const val ALL_RESULTS: Int = -1
+
+/**
+ * Common query options. These are:
+ *  - maximum number to return; pass ALL_RESULTS to impose no limits.
+ *  - maximum lastModified delta in milliseconds: the delta from now used to reject files that were
+ *    not modified in the specified milliseconds; pass null for no limits.
+ *  - maximum time the query should return, including empty, results; pass null for no limits.
+ *  - whether or not to show hidden files.
+ *  - A list of MIME types used to filter returned files.
+ *  - "Other" query arguments not covered by the above.
+ *
+ *  The "other" query arguments are added as due to existing code communicating information such
+ *  as acceptable file kind (images, videos, etc.) is done via Bundle arguments. This could be
+ *  and should be changed if this code ever is rewritten.
+ *  TODO(b:397095797): Merge otherQueryArgs with acceptableMimeTypes and maxLastModifiedDelta.
+ */
+data class QueryOptions(
+    val maxResults: Int,
+    val maxLastModifiedDelta: Duration?,
+    val maxQueryTime: Duration?,
+    val showHidden: Boolean,
+    val acceptableMimeTypes: Array<String>,
+    val otherQueryArgs: Bundle,
+) {
+
+    override fun equals(other: Any?): Boolean {
+        if (this === other) return true
+        if (javaClass != other?.javaClass) return false
+
+        other as QueryOptions
+
+        return maxResults == other.maxResults &&
+                maxLastModifiedDelta == other.maxLastModifiedDelta &&
+                maxQueryTime == other.maxQueryTime &&
+                showHidden == other.showHidden &&
+                acceptableMimeTypes.contentEquals(other.acceptableMimeTypes)
+    }
+
+    /**
+     * Helper method that computes the earliest valid last modified timestamp. Converts last
+     * modified duration to milliseconds past now. If the maxLastModifiedDelta is negative
+     * this method returns 0L.
+     */
+    fun getRejectBeforeTimestamp() =
+        if (maxLastModifiedDelta == null) {
+            0L
+        } else {
+            System.currentTimeMillis() - maxLastModifiedDelta.toMillis()
+        }
+
+    /**
+     * Helper function that indicates if query time is unlimited. Due to internal reliance on
+     * Java's Duration class it assumes anything larger than 60 seconds has unlimited waiting
+     * time.
+     */
+    fun isQueryTimeUnlimited() = maxQueryTime == null
+
+    override fun hashCode(): Int {
+        var result = maxResults
+        result = 31 * result + maxLastModifiedDelta.hashCode()
+        result = 31 * result + maxQueryTime.hashCode()
+        result = 31 * result + showHidden.hashCode()
+        result = 31 * result + acceptableMimeTypes.contentHashCode()
+        return result
+    }
+}
diff --git a/src/com/android/documentsui/loaders/SearchLoader.kt b/src/com/android/documentsui/loaders/SearchLoader.kt
new file mode 100644
index 000000000..f0da924e2
--- /dev/null
+++ b/src/com/android/documentsui/loaders/SearchLoader.kt
@@ -0,0 +1,257 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.content.Context
+import android.database.Cursor
+import android.net.Uri
+import android.os.Bundle
+import android.provider.DocumentsContract
+import android.provider.DocumentsContract.Document
+import android.text.TextUtils
+import android.util.Log
+import com.android.documentsui.DirectoryResult
+import com.android.documentsui.LockingContentObserver
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.base.FilteringCursorWrapper
+import com.android.documentsui.base.Lookup
+import com.android.documentsui.base.RootInfo
+import com.android.documentsui.base.UserId
+import com.android.documentsui.sorting.SortModel
+import com.google.common.util.concurrent.AbstractFuture
+import java.io.Closeable
+import java.util.concurrent.CountDownLatch
+import java.util.concurrent.ExecutorService
+import java.util.concurrent.TimeUnit
+import kotlin.time.measureTime
+
+/**
+ * A specialization of the BaseFileLoader that searches the set of specified roots. To search
+ * the roots you must provider:
+ *
+ *  - The current application context
+ *  - A content lock for which a locking content observer is built
+ *  - A list of user IDs, on whose behalf we query content provider clients.
+ *  - A list of RootInfo objects representing searched roots
+ *  - A query used to search for matching files.
+ *  - Query options such as maximum number of results, last modified time delta, etc.
+ *  - a lookup from file extension to file type
+ *  - The model capable of sorting results
+ *  - An executor for running searches across multiple roots in parallel
+ *
+ *  SearchLoader requires that either a query is not null and not empty or that QueryOptions
+ *  specify a last modified time restriction. This is to prevent searching for every file
+ *  across every specified root.
+ */
+class SearchLoader(
+    context: Context,
+    userIdList: List<UserId>,
+    mimeTypeLookup: Lookup<String, String>,
+    private val mObserver: LockingContentObserver,
+    private val mRootList: Collection<RootInfo>,
+    private val mQuery: String?,
+    private val mOptions: QueryOptions,
+    private val mSortModel: SortModel,
+    private val mExecutorService: ExecutorService,
+) : BaseFileLoader(context, userIdList, mimeTypeLookup) {
+
+    /**
+     * Helper class that runs query on a single user for the given parameter. This class implements
+     * an abstract future so that if the task is completed, we can retrieve the cursor via the get
+     * method.
+     */
+    inner class SearchTask(
+        private val mRootId: String,
+        private val mSearchUri: Uri,
+        private val mQueryArgs: Bundle,
+        private val mLatch: CountDownLatch,
+    ) : Closeable, Runnable, AbstractFuture<Cursor>() {
+        private var mCursor: Cursor? = null
+        val cursor: Cursor? get() = mCursor
+        val taskId: String get() = mSearchUri.toString()
+
+        override fun close() {
+            mCursor = null
+        }
+
+        override fun run() {
+            val queryDuration = measureTime {
+                try {
+                    mCursor = queryLocation(mRootId, mSearchUri, mQueryArgs, mOptions.maxResults)
+                    set(mCursor)
+                } finally {
+                    mLatch.countDown()
+                }
+            }
+            Log.d(TAG, "Query on $mSearchUri took $queryDuration")
+        }
+    }
+
+    @Volatile
+    private var mSearchTaskList: List<SearchTask> = listOf()
+
+    // Creates a directory result object corresponding to the current parameters of the loader.
+    override fun loadInBackground(): DirectoryResult? {
+        val result = DirectoryResult()
+        // TODO(b:378590632): If root list has one root use it to construct result.doc
+        result.doc = DocumentInfo()
+        result.cursor = emptyCursor()
+
+        val searchedRoots = mRootList
+        val countDownLatch = CountDownLatch(searchedRoots.size)
+        val rejectBeforeTimestamp = mOptions.getRejectBeforeTimestamp()
+
+        // Step 1: Build a list of search tasks.
+        val searchTaskList =
+            createSearchTaskList(rejectBeforeTimestamp, countDownLatch, mRootList)
+        Log.d(TAG, "${searchTaskList.size} tasks have been created")
+
+        // Check if we are cancelled; if not copy the task list.
+        if (isLoadInBackgroundCanceled) {
+            return result
+        }
+        mSearchTaskList = searchTaskList
+
+        // Step 2: Enqueue tasks and wait for them to complete or time out.
+        for (task in mSearchTaskList) {
+            mExecutorService.execute(task)
+        }
+        Log.d(TAG, "${mSearchTaskList.size} tasks have been enqueued")
+
+        // Step 3: Wait for the results.
+        try {
+            if (mOptions.isQueryTimeUnlimited()) {
+                Log.d(TAG, "Waiting for results with no time limit")
+                countDownLatch.await()
+            } else {
+                Log.d(TAG, "Waiting ${mOptions.maxQueryTime!!.toMillis()}ms for results")
+                countDownLatch.await(
+                    mOptions.maxQueryTime.toMillis(),
+                    TimeUnit.MILLISECONDS
+                )
+            }
+            Log.d(TAG, "Waiting for results is done")
+        } catch (e: InterruptedException) {
+            Log.d(TAG, "Failed to complete all searches within ${mOptions.maxQueryTime}")
+            // TODO(b:388336095): Record a metrics indicating incomplete search.
+            throw RuntimeException(e)
+        }
+
+        // Step 4: Collect cursors from done tasks.
+        val cursorList = mutableListOf<Cursor>()
+        for (task in mSearchTaskList) {
+            Log.d(TAG, "Processing task ${task.taskId}")
+            if (isLoadInBackgroundCanceled) {
+                break
+            }
+            // TODO(b:388336095): Record a metric for each done and not done task.
+            val cursor = task.cursor
+            if (task.isDone && cursor != null) {
+                // TODO(b:388336095): Record a metric for null and not null cursor.
+                Log.d(TAG, "Task ${task.taskId} has ${cursor.count} results")
+                cursorList.add(cursor)
+            }
+        }
+        Log.d(TAG, "Search complete with ${cursorList.size} cursors collected")
+
+        // Step 5: Assign the cursor, after adding filtering and sorting, to the results.
+        val mergedCursor = toSingleCursor(cursorList)
+        mergedCursor.registerContentObserver(mObserver)
+        val filteringCursor = FilteringCursorWrapper(mergedCursor)
+        filteringCursor.filterHiddenFiles(mOptions.showHidden)
+        filteringCursor.filterMimes(
+            mOptions.acceptableMimeTypes,
+            if (TextUtils.isEmpty(mQuery)) arrayOf<String>(Document.MIME_TYPE_DIR) else null
+        )
+        if (rejectBeforeTimestamp > 0L) {
+            filteringCursor.filterLastModified(rejectBeforeTimestamp)
+        }
+        result.cursor = mSortModel.sortCursor(filteringCursor, mMimeTypeLookup)
+
+        // TODO(b:388336095): Record the total time it took to complete search.
+        return result
+    }
+
+    private fun createContentProviderQuery(root: RootInfo) =
+        if (TextUtils.isEmpty(mQuery) && mOptions.otherQueryArgs.isEmpty) {
+            // NOTE: recent document URI does not respect query-arg-mime-types restrictions. Thus
+            // we only create the recents URI if both the query and other args are empty.
+            DocumentsContract.buildRecentDocumentsUri(
+                root.authority,
+                root.rootId
+            )
+        } else {
+            // NOTE: We pass empty query, as the name matching query is placed in queryArgs.
+            DocumentsContract.buildSearchDocumentsUri(
+                root.authority,
+                root.rootId,
+                ""
+            )
+        }
+
+    private fun createQueryArgs(rejectBeforeTimestamp: Long): Bundle {
+        val queryArgs = Bundle()
+        mSortModel.addQuerySortArgs(queryArgs)
+        if (rejectBeforeTimestamp > 0L) {
+            queryArgs.putLong(
+                DocumentsContract.QUERY_ARG_LAST_MODIFIED_AFTER,
+                rejectBeforeTimestamp
+            )
+        }
+        if (!TextUtils.isEmpty(mQuery)) {
+            queryArgs.putString(DocumentsContract.QUERY_ARG_DISPLAY_NAME, mQuery)
+        }
+        queryArgs.putAll(mOptions.otherQueryArgs)
+        return queryArgs
+    }
+
+    /**
+     * Helper function that creates a list of search tasks for the given countdown latch.
+     */
+    private fun createSearchTaskList(
+        rejectBeforeTimestamp: Long,
+        countDownLatch: CountDownLatch,
+        rootList: Collection<RootInfo>
+    ): List<SearchTask> {
+        val searchTaskList = mutableListOf<SearchTask>()
+        for (root in rootList) {
+            if (isLoadInBackgroundCanceled) {
+                break
+            }
+            val rootSearchUri = createContentProviderQuery(root)
+            // TODO(b:385789236): Correctly pass sort order information.
+            val queryArgs = createQueryArgs(rejectBeforeTimestamp)
+            mSortModel.addQuerySortArgs(queryArgs)
+            Log.d(TAG, "Query $rootSearchUri and queryArgs $queryArgs")
+            val task = SearchTask(
+                root.rootId,
+                rootSearchUri,
+                queryArgs,
+                countDownLatch
+            )
+            searchTaskList.add(task)
+        }
+        return searchTaskList
+    }
+
+    override fun onReset() {
+        for (task in mSearchTaskList) {
+            task.close()
+        }
+        Log.d(TAG, "Resetting search loader; search task list emptied.")
+        super.onReset()
+    }
+}
diff --git a/src/com/android/documentsui/peek/PeekFragment.kt b/src/com/android/documentsui/peek/PeekFragment.kt
new file mode 100644
index 000000000..50ee64efc
--- /dev/null
+++ b/src/com/android/documentsui/peek/PeekFragment.kt
@@ -0,0 +1,32 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import android.os.Bundle
+import android.view.LayoutInflater
+import android.view.View
+import android.view.ViewGroup
+import androidx.fragment.app.Fragment
+
+import com.android.documentsui.R
+
+class PeekFragment : Fragment() {
+    override fun onCreateView(
+        inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?
+    ): View? {
+        return inflater.inflate(R.layout.peek_layout, container, /* attachToRoot= */ false)
+    }
+}
diff --git a/src/com/android/documentsui/peek/PeekViewManager.kt b/src/com/android/documentsui/peek/PeekViewManager.kt
new file mode 100644
index 000000000..9bbeba3bf
--- /dev/null
+++ b/src/com/android/documentsui/peek/PeekViewManager.kt
@@ -0,0 +1,83 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import android.app.Activity
+import android.os.Bundle
+import android.util.Log
+import android.view.View
+import android.widget.FrameLayout
+import androidx.annotation.IdRes
+import androidx.fragment.app.FragmentManager
+import com.android.documentsui.R
+import androidx.fragment.app.FragmentTransaction
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.util.FlagUtils.Companion.isUsePeekPreviewFlagEnabled
+
+/**
+ * Manager that controls the Peek UI.
+ */
+open class PeekViewManager(
+    private val mActivity: Activity
+) {
+    companion object {
+        const val TAG = "PeekViewManager"
+    }
+
+    private var mPeekFragment: PeekFragment? = null
+
+    open fun initFragment(
+        fm: FragmentManager
+    ) {
+        if (!isUsePeekPreviewFlagEnabled()) {
+            Log.e(TAG, "Attempting to create PeekViewManager while Peek disabled")
+            return
+        }
+
+        if (getOverlayContainer() == null) {
+            Log.e(TAG, "Unable to find Peek container")
+            return
+        }
+
+        // Load the Peek fragment into its container.
+        val peekFragment = PeekFragment()
+        mPeekFragment = peekFragment
+        val ft: FragmentTransaction = fm.beginTransaction()
+        ft.replace(getOverlayId(), peekFragment)
+        ft.commitAllowingStateLoss()
+    }
+
+    open fun peekDocument(doc: DocumentInfo) {
+        if (mPeekFragment == null) {
+            Log.e(TAG, "Peek fragment not initialized")
+            return
+        }
+        show()
+    }
+
+    @IdRes
+    private fun getOverlayId(): Int {
+        return R.id.peek_overlay
+    }
+
+    private fun getOverlayContainer(): FrameLayout? {
+        return mActivity.findViewById(getOverlayId())
+    }
+
+    private fun show() {
+        getOverlayContainer()?.visibility = View.VISIBLE
+    }
+}
\ No newline at end of file
diff --git a/src/com/android/documentsui/picker/PickActivity.java b/src/com/android/documentsui/picker/PickActivity.java
index e9b91b1a0..4f875072e 100644
--- a/src/com/android/documentsui/picker/PickActivity.java
+++ b/src/com/android/documentsui/picker/PickActivity.java
@@ -21,6 +21,7 @@ import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ACTION_OPEN_TREE;
 import static com.android.documentsui.base.State.ACTION_PICK_COPY_DESTINATION;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.content.Intent;
 import android.content.res.Resources;
@@ -127,12 +128,15 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
                 new DirectoryDetails(this),
                 mInjector.getModel()::getItemCount);
 
-        mInjector.actionModeController = new ActionModeController(
-                this,
-                mInjector.selectionMgr,
-                mNavigator,
-                mInjector.menuManager,
-                mInjector.messages);
+        if (!isUseMaterial3FlagEnabled()) {
+            mInjector.actionModeController =
+                    new ActionModeController(
+                            this,
+                            mInjector.selectionMgr,
+                            mNavigator,
+                            mInjector.menuManager,
+                            mInjector.messages);
+        }
 
         mInjector.profileTabsController = new ProfileTabsController(
                 mInjector.selectionMgr,
@@ -220,9 +224,11 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
         } else if (mState.action == ACTION_OPEN_TREE ||
                 mState.action == ACTION_PICK_COPY_DESTINATION) {
             PickFragment.show(getSupportFragmentManager());
-        } else {
+        } else if (!isUseMaterial3FlagEnabled()) {
             // If PickFragment or SaveFragment does not show,
             // Set save container background to transparent for edge to edge nav bar.
+            // However when the use_material3 flag is on, the file path bar is at the bottom of the
+            // layout and hence the edge to edge nav bar is no longer required.
             View saveContainer = findViewById(R.id.container_save);
             saveContainer.setBackgroundColor(Color.TRANSPARENT);
         }
@@ -249,6 +255,15 @@ public class PickActivity extends BaseActivity implements ActionHandler.Addons {
             RootsFragment.show(getSupportFragmentManager(),
                     /* includeApps= */ mState.action == ACTION_GET_CONTENT,
                     /* intent= */ moreApps);
+            if (isUseMaterial3FlagEnabled()) {
+                View navRailRoots = findViewById(R.id.nav_rail_container_roots);
+                if (navRailRoots != null) {
+                    // Medium layout, populate navigation rail layout.
+                    RootsFragment.showNavRail(getSupportFragmentManager(),
+                            /* includeApps= */ mState.action == ACTION_GET_CONTENT,
+                            /* intent= */ moreApps);
+                }
+            }
         }
     }
 
diff --git a/src/com/android/documentsui/picker/PickFragment.java b/src/com/android/documentsui/picker/PickFragment.java
index e9610a510..0d20083a8 100644
--- a/src/com/android/documentsui/picker/PickFragment.java
+++ b/src/com/android/documentsui/picker/PickFragment.java
@@ -22,7 +22,9 @@ import static com.android.documentsui.services.FileOperationService.OPERATION_DE
 import static com.android.documentsui.services.FileOperationService.OPERATION_EXTRACT;
 import static com.android.documentsui.services.FileOperationService.OPERATION_MOVE;
 import static com.android.documentsui.services.FileOperationService.OPERATION_UNKNOWN;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
+import android.content.pm.PackageManager;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -179,13 +181,28 @@ public class PickFragment extends Fragment {
         switch (mAction) {
             case State.ACTION_OPEN_TREE:
                 mPick.setText(getString(R.string.open_tree_button));
-                mPick.setWidth(Integer.MAX_VALUE);
-                mCancel.setVisibility(View.GONE);
+                // When use_material3 flag is enabled, all form factors should have the pick button
+                // wrap the text content instead of taking up the full width.
+                if (!isUseMaterial3FlagEnabled()) {
+                    mCancel.setVisibility(View.GONE);
+                    mPick.setWidth(Integer.MAX_VALUE);
+                    mPickOverlay.setVisibility(
+                            mPickTarget.isBlockedFromTree() && mRestrictScopeStorage
+                                    ? View.VISIBLE
+                                    : View.GONE);
+                } else if (!getActivity()
+                        .getPackageManager()
+                        .hasSystemFeature(PackageManager.FEATURE_PC)) {
+                    // On non-desktop devices the back gesture is used to cancel the picker, so
+                    // don't show the "Cancel" button on these devices and instead enable the pick
+                    // overlay which enables showing a toast when the disabled button is pressed.
+                    mCancel.setVisibility(View.GONE);
+                    mPickOverlay.setVisibility(
+                            mPickTarget.isBlockedFromTree() && mRestrictScopeStorage
+                                    ? View.VISIBLE
+                                    : View.GONE);
+                }
                 mPick.setEnabled(!(mPickTarget.isBlockedFromTree() && mRestrictScopeStorage));
-                mPickOverlay.setVisibility(
-                        mPickTarget.isBlockedFromTree() && mRestrictScopeStorage
-                                ? View.VISIBLE
-                                : View.GONE);
                 break;
             case State.ACTION_PICK_COPY_DESTINATION:
                 int titleId;
diff --git a/src/com/android/documentsui/picker/SaveFragment.java b/src/com/android/documentsui/picker/SaveFragment.java
index f881768b9..8316688e7 100644
--- a/src/com/android/documentsui/picker/SaveFragment.java
+++ b/src/com/android/documentsui/picker/SaveFragment.java
@@ -16,7 +16,11 @@
 
 package com.android.documentsui.picker;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
+import android.content.pm.PackageManager;
+import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.text.Editable;
 import android.text.TextUtils;
@@ -42,6 +46,9 @@ import com.android.documentsui.base.BooleanConsumer;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.Shared;
 
+import com.google.android.material.button.MaterialButton;
+import com.google.android.material.textfield.TextInputLayout;
+
 /**
  * Display document title editor and save button.
  */
@@ -54,6 +61,7 @@ public class SaveFragment extends Fragment {
     private DocumentInfo mReplaceTarget;
     private EditText mDisplayName;
     private TextView mSave;
+    private MaterialButton mCancel;
     private ProgressBar mProgress;
     private boolean mIgnoreNextEdit;
 
@@ -84,9 +92,16 @@ public class SaveFragment extends Fragment {
 
         final View view = inflater.inflate(R.layout.fragment_save, container, false);
 
-        final ImageView icon = (ImageView) view.findViewById(android.R.id.icon);
-        icon.setImageDrawable(
-                IconUtils.loadMimeIcon(context, getArguments().getString(EXTRA_MIME_TYPE)));
+        final Drawable icon =
+                IconUtils.loadMimeIcon(context, getArguments().getString(EXTRA_MIME_TYPE));
+        if (isUseMaterial3FlagEnabled()) {
+            final TextInputLayout titleWrapper =
+                    (TextInputLayout) view.findViewById(R.id.title_wrapper);
+            titleWrapper.setStartIconDrawable(icon);
+        } else {
+            final ImageView iconHolder = view.findViewById(android.R.id.icon);
+            iconHolder.setImageDrawable(icon);
+        }
 
         mDisplayName = (EditText) view.findViewById(android.R.id.title);
         mDisplayName.addTextChangedListener(mDisplayNameWatcher);
@@ -122,6 +137,19 @@ public class SaveFragment extends Fragment {
         mSave.setOnClickListener(mSaveListener);
         mSave.setEnabled(false);
 
+        mCancel = (MaterialButton) view.findViewById(android.R.id.button2);
+        // For >600dp, this button is always available (via the values-600dp layout override).
+        // However on smaller layouts, the button is default GONE to save on space (the back gesture
+        // can cancel the saver) and when FEATURE_PC is set a cancel button is required due to the
+        // lack of a back gesture (mainly mouse support).
+        if (isUseMaterial3FlagEnabled()
+                && mCancel != null
+                && context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_PC)) {
+            mCancel.setOnClickListener(mCancelListener);
+            mCancel.setVisibility(View.VISIBLE);
+            mCancel.setEnabled(true);
+        }
+
         mProgress = (ProgressBar) view.findViewById(android.R.id.progress);
 
         return view;
@@ -173,6 +201,13 @@ public class SaveFragment extends Fragment {
 
     };
 
+    private View.OnClickListener mCancelListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View v) {
+            mInjector.actions.finishPicking();
+        }
+    };
+
     private void performSave() {
         if (mReplaceTarget != null) {
             mInjector.actions.saveDocument(getChildFragmentManager(), mReplaceTarget);
diff --git a/src/com/android/documentsui/picker/TrampolineActivity.kt b/src/com/android/documentsui/picker/TrampolineActivity.kt
new file mode 100644
index 000000000..dba09f2f3
--- /dev/null
+++ b/src/com/android/documentsui/picker/TrampolineActivity.kt
@@ -0,0 +1,181 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.picker
+
+import android.content.ComponentName
+import android.content.Intent
+import android.content.Intent.ACTION_GET_CONTENT
+import android.content.pm.PackageInfo
+import android.content.pm.PackageManager
+import android.os.Build
+import android.os.Bundle
+import android.os.ext.SdkExtensions
+import android.provider.MediaStore.ACTION_PICK_IMAGES
+import android.util.Log
+import androidx.appcompat.app.AppCompatActivity
+import com.android.documentsui.base.SharedMinimal.DEBUG
+
+/**
+ * DocumentsUI PickActivity currently defers picking of media mime types to the Photopicker. This
+ * activity trampolines the intent to either Photopicker or to the PickActivity depending on whether
+ * there are non-media mime types to handle.
+ */
+class TrampolineActivity : AppCompatActivity() {
+    companion object {
+        const val TAG = "TrampolineActivity"
+    }
+
+    override fun onCreate(savedInstanceBundle: Bundle?) {
+        super.onCreate(savedInstanceBundle)
+
+        // This activity should not be present in the back stack nor should handle any of the
+        // corresponding results when picking items.
+        intent?.apply {
+            addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT)
+            addFlags(Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP)
+        }
+
+        // In the event there is no photopicker returned, just refer to DocumentsUI.
+        val photopickerComponentName = getPhotopickerComponentName(intent.type)
+        if (photopickerComponentName == null) {
+            forwardIntentToDocumentsUI()
+            return
+        }
+
+        // The Photopicker has an entry point to take them back to DocumentsUI. In the event the
+        // user originated from Photopicker, we don't want to send them back.
+        val referredFromPhotopicker = referrer?.host == photopickerComponentName.packageName
+        if (referredFromPhotopicker || !shouldForwardIntentToPhotopicker(intent)) {
+            forwardIntentToDocumentsUI()
+            return
+        }
+
+        // Forward intent to Photopicker.
+        intent.setComponent(photopickerComponentName)
+        startActivity(intent)
+        finish()
+    }
+
+    private fun forwardIntentToDocumentsUI() {
+        intent.setClass(applicationContext, PickActivity::class.java)
+        startActivity(intent)
+        finish()
+    }
+
+    private fun getPhotopickerComponentName(type: String?): ComponentName? {
+        // Intent.ACTION_PICK_IMAGES is only available from SdkExtensions v2 onwards. Prior to that
+        // the Photopicker was not available, so in those cases should always send to DocumentsUI.
+        if (SdkExtensions.getExtensionVersion(Build.VERSION_CODES.R) < 2) {
+            return null
+        }
+
+        // Attempt to resolve the `ACTION_PICK_IMAGES` intent to get the Photopicker package.
+        // On T+ devices this is is a standalone package, whilst prior to T it is part of the
+        // MediaProvider module.
+        val pickImagesIntent = Intent(
+            ACTION_PICK_IMAGES
+        ).apply { addCategory(Intent.CATEGORY_DEFAULT) }
+        val photopickerComponentName: ComponentName? = pickImagesIntent.resolveActivity(
+            packageManager
+        )
+
+        // For certain devices the activity that handles ACTION_GET_CONTENT can be disabled (when
+        // the ACTION_PICK_IMAGES is enabled) so double check by explicitly checking the
+        // ACTION_GET_CONTENT activity on the same activity that handles ACTION_PICK_IMAGES.
+        val photopickerGetContentIntent = Intent(ACTION_GET_CONTENT).apply {
+            setType(type)
+            setPackage(photopickerComponentName?.packageName)
+        }
+        val photopickerGetContentComponent: ComponentName? =
+            photopickerGetContentIntent.resolveActivity(packageManager)
+
+        // Ensure the `ACTION_GET_CONTENT` activity is enabled.
+        if (!isComponentEnabled(photopickerGetContentComponent)) {
+            if (DEBUG) {
+                Log.d(TAG, "Photopicker PICK_IMAGES component has no enabled GET_CONTENT handler")
+            }
+            return null
+        }
+
+        return photopickerGetContentComponent
+    }
+
+    private fun isComponentEnabled(componentName: ComponentName?): Boolean {
+        if (componentName == null) {
+            return false
+        }
+
+        return when (packageManager.getComponentEnabledSetting(componentName)) {
+            PackageManager.COMPONENT_ENABLED_STATE_ENABLED -> true
+            PackageManager.COMPONENT_ENABLED_STATE_DEFAULT -> {
+                // DEFAULT is a state that essentially defers to the state defined in the
+                // AndroidManifest which can be either enabled or disabled.
+                packageManager.getPackageInfo(
+                    componentName.packageName,
+                    PackageManager.GET_ACTIVITIES
+                )?.let { packageInfo: PackageInfo ->
+                    if (packageInfo.activities == null) {
+                        return false
+                    }
+                    for (val info in packageInfo.activities) {
+                        if (info.name == componentName.className) {
+                            return info.enabled
+                        }
+                    }
+                }
+                return false
+            }
+
+            // Everything else is considered disabled.
+            else -> false
+        }
+    }
+}
+
+fun shouldForwardIntentToPhotopicker(intent: Intent): Boolean {
+    // Photopicker can only handle `ACTION_GET_CONTENT` intents.
+    if (intent.action != ACTION_GET_CONTENT) {
+        return false
+    }
+
+    // Photopicker only handles media mime types (i.e. image/* or video/*), however, it also handles
+    // requests that have type */* with EXTRA_MIME_TYPES that are media mime types. In that scenario
+    // it provides an escape hatch to the user to go back to DocumentsUI.
+    val intentTypeIsMedia = isMediaMimeType(intent.type)
+    if (!intentTypeIsMedia && intent.type != "*/*") {
+        return false
+    }
+
+    val extraMimeTypes = intent.getStringArrayExtra(Intent.EXTRA_MIME_TYPES)
+
+    // In the event there were no `EXTRA_MIME_TYPES` this should exclusively be handled by
+    // DocumentsUI and not Photopicker.
+    if (intent.type == "*/*" && extraMimeTypes == null) {
+        return false
+    }
+
+    if (extraMimeTypes == null) {
+        return intentTypeIsMedia
+    }
+
+    return extraMimeTypes.isNotEmpty() && extraMimeTypes.none { !isMediaMimeType(it) }
+}
+
+fun isMediaMimeType(mimeType: String?): Boolean {
+    return mimeType?.let { mimeType ->
+        mimeType.startsWith("image/") || mimeType.startsWith("video/")
+    } == true
+}
diff --git a/src/com/android/documentsui/queries/SearchChipViewManager.java b/src/com/android/documentsui/queries/SearchChipViewManager.java
index 3dbc6ff74..bf3d1e865 100644
--- a/src/com/android/documentsui/queries/SearchChipViewManager.java
+++ b/src/com/android/documentsui/queries/SearchChipViewManager.java
@@ -16,7 +16,7 @@
 
 package com.android.documentsui.queries;
 
-import static com.android.documentsui.flags.Flags.useMaterial3;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.animation.ObjectAnimator;
 import android.content.Context;
@@ -377,6 +377,7 @@ public class SearchChipViewManager {
 
     /**
      * When the chip is focused, adding a focus ring indicator using Stroke.
+     * TODO(b/381957932): Remove this once Material Chip supports focus ring.
      */
     private void onChipFocusChange(View v, boolean hasFocus) {
         Chip chip = (Chip) v;
@@ -386,7 +387,10 @@ public class SearchChipViewManager {
                     .getDimensionPixelSize(R.dimen.focus_ring_width);
             chip.setChipStrokeWidth(focusRingWidth);
         } else {
-            chip.setChipStrokeWidth(1f);
+            final int strokeWidth = mChipGroup
+                    .getResources()
+                    .getDimensionPixelSize(R.dimen.search_chip_inactive_stroke_width);
+            chip.setChipStrokeWidth(strokeWidth);
         }
     }
 
@@ -394,21 +398,11 @@ public class SearchChipViewManager {
         final Context context = mChipGroup.getContext();
         chip.setTag(chipData);
         chip.setText(context.getString(chipData.getTitleRes()));
-        Drawable chipIcon;
-        if (chipData.getChipType() == TYPE_LARGE_FILES) {
-            chipIcon = context.getDrawable(R.drawable.ic_chip_large_files);
-        } else if (chipData.getChipType() == TYPE_FROM_THIS_WEEK) {
-            chipIcon = context.getDrawable(R.drawable.ic_chip_from_this_week);
-        } else if (chipData.getChipType() == TYPE_DOCUMENTS) {
-            chipIcon = IconUtils.loadMimeIcon(context, MimeTypes.GENERIC_TYPE);
-        } else {
-            // get the icon drawable with the first mimeType in chipData
-            chipIcon = IconUtils.loadMimeIcon(context, chipData.getMimeTypes()[0]);
-        }
+        Drawable chipIcon = getChipIcon(chipData);
         chip.setChipIcon(chipIcon);
         chip.setOnClickListener(this::onChipClick);
 
-        if (useMaterial3()) {
+        if (isUseMaterial3FlagEnabled()) {
             chip.setOnFocusChangeListener(this::onChipFocusChange);
         }
 
@@ -417,6 +411,35 @@ public class SearchChipViewManager {
         }
     }
 
+    private Drawable getChipIcon(SearchChipData chipData) {
+        final Context context = mChipGroup.getContext();
+        int chipType = chipData.getChipType();
+        if (chipType == TYPE_LARGE_FILES) {
+            return context.getDrawable(R.drawable.ic_chip_large_files);
+        }
+        if (chipType == TYPE_FROM_THIS_WEEK) {
+            return context.getDrawable(R.drawable.ic_chip_from_this_week);
+        }
+
+        // When use_material3 flag is ON, we don't want to use MIME type icons for
+        // image/audio/video/document from the system.
+        if (isUseMaterial3FlagEnabled()) {
+            return switch (chipType) {
+                case TYPE_IMAGES -> context.getDrawable(R.drawable.ic_chip_image);
+                case TYPE_AUDIO -> context.getDrawable(R.drawable.ic_chip_audio);
+                case TYPE_VIDEOS -> context.getDrawable(R.drawable.ic_chip_video);
+                case TYPE_DOCUMENTS -> context.getDrawable(R.drawable.ic_chip_document);
+                default -> null;
+            };
+        }
+
+        if (chipType == TYPE_DOCUMENTS) {
+            return IconUtils.loadMimeIcon(context, MimeTypes.GENERIC_TYPE);
+        }
+        // get the icon drawable with the first mimeType in chipData
+        return IconUtils.loadMimeIcon(context, chipData.getMimeTypes()[0]);
+    }
+
     /**
      * Reorder the chips in chip group. The checked chip has higher order.
      *
@@ -448,19 +471,19 @@ public class SearchChipViewManager {
         }
 
         final int chipSpacing =
-                useMaterial3()
+                isUseMaterial3FlagEnabled()
                         ? ((ChipGroup) mChipGroup).getChipSpacingHorizontal()
                         : mChipGroup
                                 .getResources()
                                 .getDimensionPixelSize(R.dimen.search_chip_spacing);
         final boolean isRtl = mChipGroup.getLayoutDirection() == View.LAYOUT_DIRECTION_RTL;
-        final float chipMarginStartEnd =
-                useMaterial3()
-                        ? 0
+        final float chipGroupPaddingStart =
+                isUseMaterial3FlagEnabled()
+                        ? mChipGroup.getPaddingStart()
                         : mChipGroup
                                 .getResources()
                                 .getDimensionPixelSize(R.dimen.search_chip_half_spacing);
-        float lastX = isRtl ? mChipGroup.getWidth() - chipMarginStartEnd : chipMarginStartEnd;
+        float lastX = isRtl ? mChipGroup.getWidth() - chipGroupPaddingStart : chipGroupPaddingStart;
 
         // remove all chips except current clicked chip to avoid losing
         // accessibility focus.
@@ -498,7 +521,7 @@ public class SearchChipViewManager {
             }
 
             // Let the first checked chip can be shown.
-            View parent = (View) mChipGroup.getParent();
+            View parent = (View) mChipGroup.getParent().getParent();
             if (parent instanceof HorizontalScrollView) {
                 final int scrollToX = isRtl ? parent.getWidth() : 0;
                 ((HorizontalScrollView) parent).smoothScrollTo(scrollToX, 0);
diff --git a/src/com/android/documentsui/queries/SearchViewManager.java b/src/com/android/documentsui/queries/SearchViewManager.java
index 053dc93c8..ca132a187 100644
--- a/src/com/android/documentsui/queries/SearchViewManager.java
+++ b/src/com/android/documentsui/queries/SearchViewManager.java
@@ -20,6 +20,7 @@ import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.State.ACTION_GET_CONTENT;
 import static com.android.documentsui.base.State.ACTION_OPEN;
 import static com.android.documentsui.base.State.ActionType;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.content.Intent;
 import android.os.Bundle;
@@ -332,7 +333,14 @@ public class SearchViewManager implements
         }
 
         // Recent root show open search bar, do not show duplicate search icon.
-        mMenuItem.setVisible(supportsSearch && (!stack.isRecents() || !mShowSearchBar));
+        boolean enabled = supportsSearch && (!stack.isRecents() || !mShowSearchBar);
+        mMenuItem.setVisible(enabled);
+        if (isUseMaterial3FlagEnabled()) {
+            // When the use_material3 flag is enabled, we inflate and deflate the menu.
+            // This causes the search button to be disabled on inflation, toggle it in
+            // this scenario.
+            mMenuItem.setEnabled(enabled);
+        }
 
         mChipViewManager.setChipsRowVisible(supportsSearch && root.supportsMimeTypesSearch());
     }
diff --git a/src/com/android/documentsui/services/CompressJob.java b/src/com/android/documentsui/services/CompressJob.java
index e9ba6e4c8..ccb3ee835 100644
--- a/src/com/android/documentsui/services/CompressJob.java
+++ b/src/com/android/documentsui/services/CompressJob.java
@@ -24,11 +24,13 @@ import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.ContentResolver;
 import android.content.Context;
+import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.Messenger;
 import android.os.ParcelFileDescriptor;
 import android.os.RemoteException;
 import android.provider.DocumentsContract;
+import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.R;
@@ -40,6 +42,9 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
+import java.util.HashMap;
+import java.util.Locale;
+import java.util.Map;
 
 // TODO: Stop extending CopyJob.
 final class CompressJob extends CopyJob {
@@ -86,6 +91,26 @@ final class CompressJob extends CopyJob {
                 R.plurals.compress_error_notification_title, R.drawable.ic_menu_compress);
     }
 
+    @Override
+    protected String getProgressMessage() {
+        switch (getState()) {
+            case Job.STATE_SET_UP:
+            case Job.STATE_COMPLETED:
+            case Job.STATE_CANCELED:
+                Map<String, Object> formatArgs = new HashMap<>();
+                formatArgs.put("count", mResolvedDocs.size());
+                if (mResolvedDocs.size() == 1) {
+                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
+                            mResolvedDocs.get(0).displayName));
+                }
+                return (new MessageFormat(
+                        service.getString(R.string.compress_in_progress), Locale.getDefault()))
+                        .format(formatArgs);
+            default:
+                return "";
+        }
+    }
+
     @Override
     public boolean setUp() {
         if (!super.setUp()) {
@@ -115,11 +140,11 @@ final class CompressJob extends CopyJob {
                     mArchiveUri, ParcelFileDescriptor.MODE_WRITE_ONLY), UserId.DEFAULT_USER);
             ArchivesProvider.acquireArchive(getClient(mDstInfo), mDstInfo.derivedUri);
         } catch (FileNotFoundException e) {
-            Log.e(TAG, "Failed to create dstInfo.", e);
+            Log.e(TAG, "Cannot create document info", e);
             failureCount = mResourceUris.getItemCount();
             return false;
         } catch (RemoteException e) {
-            Log.e(TAG, "Failed to acquire the archive.", e);
+            Log.e(TAG, "Cannot acquire archive", e);
             failureCount = mResourceUris.getItemCount();
             return false;
         }
@@ -132,7 +157,7 @@ final class CompressJob extends CopyJob {
         try {
             ArchivesProvider.releaseArchive(getClient(mDstInfo), mDstInfo.derivedUri);
         } catch (RemoteException e) {
-            Log.e(TAG, "Failed to release the archive.");
+            Log.e(TAG, "Cannot release archive", e);
         }
 
         // Remove the archive file in case of an error.
@@ -141,7 +166,7 @@ final class CompressJob extends CopyJob {
                 DocumentsContract.deleteDocument(wrap(getClient(mArchiveUri)), mArchiveUri);
             }
         } catch (RemoteException | FileNotFoundException e) {
-            Log.w(TAG, "Failed to cleanup after compress error: " + mDstInfo.toString(), e);
+            Log.w(TAG, "Cannot clean up after compress error: " + mDstInfo.toString(), e);
         }
 
         super.finish();
diff --git a/src/com/android/documentsui/services/CopyJob.java b/src/com/android/documentsui/services/CopyJob.java
index c972c33ef..9fb3f5d09 100644
--- a/src/com/android/documentsui/services/CopyJob.java
+++ b/src/com/android/documentsui/services/CopyJob.java
@@ -46,6 +46,7 @@ import android.content.Intent;
 import android.content.res.AssetFileDescriptor;
 import android.database.ContentObserver;
 import android.database.Cursor;
+import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.DeadObjectException;
 import android.os.FileUtils;
@@ -66,6 +67,7 @@ import android.system.Int64Ref;
 import android.system.Os;
 import android.system.OsConstants;
 import android.system.StructStat;
+import android.text.BidiFormatter;
 import android.util.ArrayMap;
 import android.util.Log;
 import android.webkit.MimeTypeMap;
@@ -93,6 +95,8 @@ import java.io.InputStream;
 import java.io.SyncFailedException;
 import java.text.NumberFormat;
 import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.Locale;
 import java.util.Map;
 import java.util.concurrent.atomic.AtomicLong;
 import java.util.function.Function;
@@ -195,6 +199,49 @@ class CopyJob extends ResolvedResourcesJob {
         return warningBuilder.build();
     }
 
+    protected String getProgressMessage() {
+        switch (getState()) {
+            case Job.STATE_SET_UP:
+            case Job.STATE_COMPLETED:
+            case Job.STATE_CANCELED:
+                Map<String, Object> formatArgs = new HashMap<>();
+                formatArgs.put("count", mResolvedDocs.size());
+                formatArgs.put("directory",
+                        BidiFormatter.getInstance().unicodeWrap(mDstInfo.displayName));
+                if (mResolvedDocs.size() == 1) {
+                    formatArgs.put("filename",
+                            BidiFormatter.getInstance().unicodeWrap(
+                                    mResolvedDocs.get(0).displayName));
+                }
+                return (new MessageFormat(
+                        service.getString(R.string.copy_in_progress), Locale.getDefault()))
+                        .format(formatArgs);
+
+            default:
+                return "";
+        }
+    }
+
+    @Override
+    JobProgress getJobProgress() {
+        if (mProgressTracker == null) {
+            return new JobProgress(
+                    id,
+                    getState(),
+                    getProgressMessage(),
+                    hasFailures());
+        }
+        mProgressTracker.updateEstimateRemainingTime();
+        return new JobProgress(
+                id,
+                getState(),
+                getProgressMessage(),
+                hasFailures(),
+                mProgressTracker.getCurrentBytes(),
+                mProgressTracker.getRequiredBytes(),
+                mProgressTracker.getRemainingTimeEstimate());
+    }
+
     @Override
     boolean setUp() {
         if (!super.setUp()) {
@@ -986,6 +1033,10 @@ class CopyJob extends ResolvedResourcesJob {
             return -1;
         }
 
+        protected long getCurrentBytes() {
+            return -1;
+        }
+
         protected void start() {
             mStartTime = mElapsedRealTimeSupplier.getAsLong();
         }
@@ -1057,6 +1108,16 @@ class CopyJob extends ResolvedResourcesJob {
             return mBytesRequired > 0;
         }
 
+        @Override
+        protected long getRequiredBytes() {
+            return mBytesRequired;
+        }
+
+        @Override
+        protected long getCurrentBytes() {
+            return mBytesCopied.get();
+        }
+
         @Override
         public void onBytesCopied(long numBytes) {
             mBytesCopied.getAndAdd(numBytes);
diff --git a/src/com/android/documentsui/services/DeleteJob.java b/src/com/android/documentsui/services/DeleteJob.java
index ede46a937..801cc6dd3 100644
--- a/src/com/android/documentsui/services/DeleteJob.java
+++ b/src/com/android/documentsui/services/DeleteJob.java
@@ -23,7 +23,9 @@ import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.ContentResolver;
 import android.content.Context;
+import android.icu.text.MessageFormat;
 import android.net.Uri;
+import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.MetricConsts;
@@ -36,6 +38,9 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
+import java.util.HashMap;
+import java.util.Locale;
+import java.util.Map;
 
 import javax.annotation.Nullable;
 
@@ -97,6 +102,34 @@ final class DeleteJob extends ResolvedResourcesJob {
         throw new UnsupportedOperationException();
     }
 
+    private String getProgressMessage() {
+        switch (getState()) {
+            case Job.STATE_SET_UP:
+            case Job.STATE_COMPLETED:
+            case Job.STATE_CANCELED:
+                Map<String, Object> formatArgs = new HashMap<>();
+                formatArgs.put("count", mResolvedDocs.size());
+                if (mResolvedDocs.size() == 1) {
+                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
+                            mResolvedDocs.get(0).displayName));
+                }
+                return (new MessageFormat(
+                        service.getString(R.string.delete_in_progress), Locale.getDefault()))
+                        .format(formatArgs);
+            default:
+                return "";
+        }
+    }
+
+    @Override
+    JobProgress getJobProgress() {
+        return new JobProgress(
+                id,
+                getState(),
+                getProgressMessage(),
+                hasFailures());
+    }
+
     @Override
     void start() {
         ContentResolver resolver = appContext.getContentResolver();
diff --git a/src/com/android/documentsui/services/FileOperationService.java b/src/com/android/documentsui/services/FileOperationService.java
index c7be5f4fc..14b87ef5b 100644
--- a/src/com/android/documentsui/services/FileOperationService.java
+++ b/src/com/android/documentsui/services/FileOperationService.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.services;
 
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
+import static com.android.documentsui.util.FlagUtils.isVisualSignalsFlagEnabled;
 
 import android.app.Notification;
 import android.app.NotificationChannel;
@@ -67,6 +68,9 @@ public class FileOperationService extends Service implements Job.Listener {
     public static final String EXTRA_OPERATION = "com.android.documentsui.OPERATION";
     public static final String EXTRA_CANCEL = "com.android.documentsui.CANCEL";
 
+    public static final String ACTION_PROGRESS = "com.android.documentsui.action.PROGRESS";
+    public static final String EXTRA_PROGRESS = "com.android.documentsui.PROGRESS";
+
     @IntDef({
             OPERATION_UNKNOWN,
             OPERATION_COPY,
@@ -126,9 +130,15 @@ public class FileOperationService extends Service implements Job.Listener {
     // Use a features to determine if notification channel is enabled.
     @VisibleForTesting Features features;
 
+    // Used so tests can force the state of visual signals.
+    @VisibleForTesting Boolean mVisualSignalsEnabled = isVisualSignalsFlagEnabled();
+
     @GuardedBy("mJobs")
     private final Map<String, JobRecord> mJobs = new LinkedHashMap<>();
 
+    // Used to send periodic broadcasts for job progress.
+    private GlobalJobMonitor mJobMonitor;
+
     // The job whose notification is used to keep the service in foreground mode.
     @GuardedBy("mJobs")
     private Job mForegroundJob;
@@ -162,6 +172,10 @@ public class FileOperationService extends Service implements Job.Listener {
             notificationManager = getSystemService(NotificationManager.class);
         }
 
+        if (mVisualSignalsEnabled && mJobMonitor == null) {
+            mJobMonitor = new GlobalJobMonitor();
+        }
+
         UserManager userManager = (UserManager) getSystemService(Context.USER_SERVICE);
         features = new Features.RuntimeFeatures(getResources(), userManager);
         setUpNotificationChannel();
@@ -188,6 +202,10 @@ public class FileOperationService extends Service implements Job.Listener {
             Log.d(TAG, "Shutting down executor.");
         }
 
+        if (mJobMonitor != null) {
+            mJobMonitor.stop();
+        }
+
         List<Runnable> unfinishedCopies = executor.shutdownNow();
         List<Runnable> unfinishedDeletions = deletionExecutor.shutdownNow();
         List<Runnable> unfinished =
@@ -330,6 +348,10 @@ public class FileOperationService extends Service implements Job.Listener {
         assert(record != null);
         record.job.cleanup();
 
+        if (mVisualSignalsEnabled && mJobs.isEmpty()) {
+            mJobMonitor.stop();
+        }
+
         // Delay the shutdown until we've cleaned up all notifications. shutdown() is now posted in
         // onFinished(Job job) to main thread.
     }
@@ -389,8 +411,12 @@ public class FileOperationService extends Service implements Job.Listener {
         }
 
         // Set up related monitor
-        JobMonitor monitor = new JobMonitor(job);
-        monitor.start();
+        if (mVisualSignalsEnabled) {
+            mJobMonitor.start();
+        } else {
+            JobMonitor monitor = new JobMonitor(job);
+            monitor.start();
+        }
     }
 
     @Override
@@ -399,6 +425,9 @@ public class FileOperationService extends Service implements Job.Listener {
         if (DEBUG) {
             Log.d(TAG, "onFinished: " + job.id);
         }
+        if (mVisualSignalsEnabled) {
+            mJobMonitor.sendProgress();
+        }
 
         synchronized (mJobs) {
             // Delete the job from mJobs first to avoid this job being selected as the foreground
@@ -545,6 +574,53 @@ public class FileOperationService extends Service implements Job.Listener {
         }
     }
 
+    /**
+     * A class used to periodically poll the state of every running job.
+     *
+     * We need to be sending the progress of every job, so rather than having a single monitor per
+     * job, have one for the whole service.
+     */
+    private final class GlobalJobMonitor implements Runnable {
+        private static final long PROGRESS_INTERVAL_MILLIS = 500L;
+        private boolean mRunning = false;
+        private long mLastId = 0;
+
+        private void start() {
+            if (!mRunning) {
+                handler.post(this);
+            }
+            mRunning = true;
+        }
+
+        private void stop() {
+            mRunning = false;
+            handler.removeCallbacks(this);
+        }
+
+        private void sendProgress() {
+            var progress = new ArrayList<JobProgress>();
+            synchronized (mJobs) {
+                for (JobRecord rec : mJobs.values()) {
+                    progress.add(rec.job.getJobProgress());
+                }
+            }
+            Intent intent = new Intent();
+            intent.setPackage(getPackageName());
+            intent.setAction(ACTION_PROGRESS);
+            intent.putExtra("id", mLastId++);
+            intent.putParcelableArrayListExtra(EXTRA_PROGRESS, progress);
+            sendBroadcast(intent);
+        }
+
+        @Override
+        public void run() {
+            sendProgress();
+            if (mRunning) {
+                handler.postDelayed(this, PROGRESS_INTERVAL_MILLIS);
+            }
+        }
+    }
+
     @Override
     public IBinder onBind(Intent intent) {
         return null;  // Boilerplate. See super#onBind
diff --git a/src/com/android/documentsui/services/Job.java b/src/com/android/documentsui/services/Job.java
index 71f0ae861..95ad8b335 100644
--- a/src/com/android/documentsui/services/Job.java
+++ b/src/com/android/documentsui/services/Job.java
@@ -76,11 +76,11 @@ abstract public class Job implements Runnable {
 
     @Retention(RetentionPolicy.SOURCE)
     @IntDef({STATE_CREATED, STATE_STARTED, STATE_SET_UP, STATE_COMPLETED, STATE_CANCELED})
-    @interface State {}
-    static final int STATE_CREATED = 0;
-    static final int STATE_STARTED = 1;
-    static final int STATE_SET_UP = 2;
-    static final int STATE_COMPLETED = 3;
+    public @interface State {}
+    public static final int STATE_CREATED = 0;
+    public static final int STATE_STARTED = 1;
+    public static final int STATE_SET_UP = 2;
+    public static final int STATE_COMPLETED = 3;
     /**
      * A job is in canceled state as long as {@link #cancel()} is called on it, even after it is
      * completed.
@@ -190,6 +190,8 @@ abstract public class Job implements Runnable {
 
     abstract Notification getWarningNotification();
 
+    abstract JobProgress getJobProgress();
+
     Uri getDataUriForIntent(String tag) {
         return Uri.parse(String.format("data,%s-%s", tag, id));
     }
diff --git a/src/com/android/documentsui/services/JobProgress.kt b/src/com/android/documentsui/services/JobProgress.kt
new file mode 100644
index 000000000..98be92f6a
--- /dev/null
+++ b/src/com/android/documentsui/services/JobProgress.kt
@@ -0,0 +1,69 @@
+/*
+ * Copyright 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.services
+
+import android.os.Parcel
+import android.os.Parcelable
+
+/**
+ * Represents the current progress on an individual job owned by the FileOperationService.
+ * JobProgress objects are broadcast from the service to activities in order to update the UI.
+ */
+data class JobProgress @JvmOverloads constructor(
+    @JvmField val id: String,
+    @JvmField @Job.State val state: Int,
+    @JvmField val msg: String?,
+    @JvmField val hasFailures: Boolean,
+    @JvmField val currentBytes: Long = -1,
+    @JvmField val requiredBytes: Long = -1,
+    @JvmField val msRemaining: Long = -1,
+) : Parcelable {
+
+    override fun describeContents(): Int {
+        return 0
+    }
+
+    override fun writeToParcel(dest: Parcel, flags: Int) {
+        dest.apply {
+            writeString(id)
+            writeInt(state)
+            writeString(msg)
+            writeBoolean(hasFailures)
+            writeLong(currentBytes)
+            writeLong(requiredBytes)
+            writeLong(msRemaining)
+        }
+    }
+
+    companion object CREATOR : Parcelable.Creator<JobProgress?> {
+        override fun createFromParcel(parcel: Parcel): JobProgress? {
+            return JobProgress(
+                parcel.readString()!!,
+                parcel.readInt(),
+                parcel.readString(),
+                parcel.readBoolean(),
+                parcel.readLong(),
+                parcel.readLong(),
+                parcel.readLong(),
+            )
+        }
+
+        override fun newArray(size: Int): Array<JobProgress?> {
+            return arrayOfNulls(size)
+        }
+    }
+}
diff --git a/src/com/android/documentsui/services/MoveJob.java b/src/com/android/documentsui/services/MoveJob.java
index ddbe727ac..b2974c5e7 100644
--- a/src/com/android/documentsui/services/MoveJob.java
+++ b/src/com/android/documentsui/services/MoveJob.java
@@ -24,12 +24,14 @@ import static com.android.documentsui.services.FileOperationService.OPERATION_MO
 import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.Context;
+import android.icu.text.MessageFormat;
 import android.net.Uri;
 import android.os.DeadObjectException;
 import android.os.Messenger;
 import android.os.RemoteException;
 import android.provider.DocumentsContract;
 import android.provider.DocumentsContract.Document;
+import android.text.BidiFormatter;
 import android.util.Log;
 
 import com.android.documentsui.MetricConsts;
@@ -42,6 +44,9 @@ import com.android.documentsui.base.UserId;
 import com.android.documentsui.clipping.UrisSupplier;
 
 import java.io.FileNotFoundException;
+import java.util.HashMap;
+import java.util.Locale;
+import java.util.Map;
 
 import javax.annotation.Nullable;
 
@@ -93,6 +98,28 @@ final class MoveJob extends CopyJob {
                 R.plurals.move_error_notification_title, R.drawable.ic_menu_copy);
     }
 
+    @Override
+    protected String getProgressMessage() {
+        switch (getState()) {
+            case Job.STATE_SET_UP:
+            case Job.STATE_COMPLETED:
+            case Job.STATE_CANCELED:
+                Map<String, Object> formatArgs = new HashMap<>();
+                formatArgs.put("count", mResolvedDocs.size());
+                formatArgs.put("directory",
+                        BidiFormatter.getInstance().unicodeWrap(mDstInfo.displayName));
+                if (mResolvedDocs.size() == 1) {
+                    formatArgs.put("filename", BidiFormatter.getInstance().unicodeWrap(
+                            mResolvedDocs.get(0).displayName));
+                }
+                return (new MessageFormat(
+                        service.getString(R.string.move_in_progress), Locale.getDefault()))
+                        .format(formatArgs);
+            default:
+                return "";
+        }
+    }
+
     @Override
     public boolean setUp() {
         if (mSrcParentUri != null) {
diff --git a/src/com/android/documentsui/services/ResolvedResourcesJob.java b/src/com/android/documentsui/services/ResolvedResourcesJob.java
index 500958978..a6001d5f8 100644
--- a/src/com/android/documentsui/services/ResolvedResourcesJob.java
+++ b/src/com/android/documentsui/services/ResolvedResourcesJob.java
@@ -16,6 +16,10 @@
 
 package com.android.documentsui.services;
 
+import static android.os.SystemClock.uptimeMillis;
+
+import static com.android.documentsui.base.SharedMinimal.DEBUG;
+
 import android.content.ContentResolver;
 import android.content.Context;
 import android.net.Uri;
@@ -44,6 +48,9 @@ import java.util.List;
 public abstract class ResolvedResourcesJob extends Job {
     private static final String TAG = "ResolvedResourcesJob";
 
+    // Used in logs.
+    protected final long mStartTime = uptimeMillis();
+
     final List<DocumentInfo> mResolvedDocs;
     final List<Uri> mAcquiredArchivedUris = new ArrayList<>();
 
@@ -72,22 +79,22 @@ public abstract class ResolvedResourcesJob extends Job {
                         mAcquiredArchivedUris.add(uri);
                     }
                 } catch (RemoteException e) {
-                    Log.e(TAG, "Failed to acquire an archive.");
+                    Log.e(TAG, "Cannot acquire an archive", e);
                     return false;
                 }
             }
         } catch (IOException e) {
-            Log.e(TAG, "Failed to read list of target resource Uris. Cannot continue.", e);
+            Log.e(TAG, "Cannot read list of target resource URIs", e);
             return false;
         }
 
         int docsResolved = buildDocumentList();
         if (!isCanceled() && docsResolved < mResourceUris.getItemCount()) {
             if (docsResolved == 0) {
-                Log.e(TAG, "Failed to load any documents. Aborting.");
+                Log.e(TAG, "Cannot load any documents. Aborting.");
                 return false;
             } else {
-                Log.e(TAG, "Failed to load some documents. Processing loaded documents only.");
+                Log.e(TAG, "Cannot load some documents");
             }
         }
 
@@ -101,9 +108,14 @@ public abstract class ResolvedResourcesJob extends Job {
             try {
                 ArchivesProvider.releaseArchive(getClient(uri), uri);
             } catch (RemoteException e) {
-                Log.e(TAG, "Failed to release an archived document.");
+                Log.e(TAG, "Cannot release an archived document", e);
             }
         }
+
+        if (DEBUG) {
+            Log.d(TAG, String.format("%s %s finished after %d ms", getClass().getSimpleName(), id,
+                    uptimeMillis() - mStartTime));
+        }
     }
 
     /**
@@ -123,7 +135,7 @@ public abstract class ResolvedResourcesJob extends Job {
         try {
             uris = mResourceUris.getUris(appContext);
         } catch (IOException e) {
-            Log.e(TAG, "Failed to read list of target resource Uris. Cannot continue.", e);
+            Log.e(TAG, "Cannot read list of target resource URIs", e);
             failureCount = this.mResourceUris.getItemCount();
             return 0;
         }
@@ -135,8 +147,7 @@ public abstract class ResolvedResourcesJob extends Job {
             try {
                 doc = DocumentInfo.fromUri(resolver, uri, UserId.DEFAULT_USER);
             } catch (FileNotFoundException e) {
-                Log.e(TAG, "Failed to resolve content from Uri: " + uri
-                        + ". Skipping to next resource.", e);
+                Log.e(TAG, "Cannot resolve content from URI " + uri, e);
                 onResolveFailed(uri);
                 continue;
             }
diff --git a/src/com/android/documentsui/sidebar/AppItem.java b/src/com/android/documentsui/sidebar/AppItem.java
index 4bb7257b6..b72e4041c 100644
--- a/src/com/android/documentsui/sidebar/AppItem.java
+++ b/src/com/android/documentsui/sidebar/AppItem.java
@@ -16,21 +16,22 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Intent;
 import android.content.pm.ActivityInfo;
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
-import android.os.UserManager;
-import android.text.TextUtils;
 import android.view.View;
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import androidx.annotation.LayoutRes;
+
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.UserId;
-import com.android.documentsui.dirlist.AppsRowItemData;
 
 /**
  * An {@link Item} for apps that supports some picking actions like
@@ -44,7 +45,16 @@ public class AppItem extends Item {
     private final ActionHandler mActionHandler;
 
     public AppItem(ResolveInfo info, String title, UserId userId, ActionHandler actionHandler) {
-        super(R.layout.item_root, title, getStringId(info), userId);
+        this(R.layout.item_root, info, title, userId, actionHandler);
+    }
+
+    public AppItem(
+            @LayoutRes int layoutId,
+            ResolveInfo info,
+            String title,
+            UserId userId,
+            ActionHandler actionHandler) {
+        super(layoutId, title, getStringId(info), userId);
         this.info = info;
         mActionHandler = actionHandler;
     }
@@ -84,14 +94,19 @@ public class AppItem extends Item {
         final ImageView icon = (ImageView) convertView.findViewById(android.R.id.icon);
         final TextView titleView = (TextView) convertView.findViewById(android.R.id.title);
         final TextView summary = (TextView) convertView.findViewById(android.R.id.summary);
-        final View actionIconArea = convertView.findViewById(R.id.action_icon_area);
-        final ImageView actionIcon = (ImageView) convertView.findViewById(R.id.action_icon);
 
         titleView.setText(title);
         titleView.setContentDescription(userId.getUserBadgedLabel(convertView.getContext(), title));
 
         bindIcon(icon);
-        bindActionIcon(actionIconArea, actionIcon);
+
+        // When use_material3 flag is ON, we don't show action icon for the app items, do nothing
+        // here because the icons are hidden by default.
+        if (!isUseMaterial3FlagEnabled()) {
+            final View actionIconArea = convertView.findViewById(R.id.action_icon_area);
+            final ImageView actionIcon = (ImageView) convertView.findViewById(R.id.action_icon);
+            bindActionIcon(actionIconArea, actionIcon);
+        }
 
         // TODO: match existing summary behavior from disambig dialog
         summary.setVisibility(View.GONE);
diff --git a/src/com/android/documentsui/sidebar/NavRailAppItem.java b/src/com/android/documentsui/sidebar/NavRailAppItem.java
new file mode 100644
index 000000000..befddf0aa
--- /dev/null
+++ b/src/com/android/documentsui/sidebar/NavRailAppItem.java
@@ -0,0 +1,48 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.sidebar;
+
+import android.content.pm.ResolveInfo;
+import android.view.View;
+import android.widget.ImageView;
+import android.widget.TextView;
+
+import com.android.documentsui.ActionHandler;
+import com.android.documentsui.R;
+import com.android.documentsui.base.UserId;
+
+/**
+ * Similar to {@link AppItem} but only used in the navigation rail.
+ */
+public class NavRailAppItem extends AppItem {
+
+    public NavRailAppItem(
+            ResolveInfo info, String title, UserId userId, ActionHandler actionHandler) {
+        super(R.layout.nav_rail_item_root, info, title, userId, actionHandler);
+    }
+
+    @Override
+    public void bindView(View convertView) {
+        final ImageView icon = convertView.findViewById(android.R.id.icon);
+        final TextView titleView = convertView.findViewById(android.R.id.title);
+
+        titleView.setText(title);
+        titleView.setContentDescription(userId.getUserBadgedLabel(convertView.getContext(), title));
+
+        bindIcon(icon);
+    }
+}
diff --git a/src/com/android/documentsui/sidebar/NavRailProfileItem.java b/src/com/android/documentsui/sidebar/NavRailProfileItem.java
new file mode 100644
index 000000000..fe69c286f
--- /dev/null
+++ b/src/com/android/documentsui/sidebar/NavRailProfileItem.java
@@ -0,0 +1,47 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.sidebar;
+
+import android.content.pm.ResolveInfo;
+import android.view.View;
+import android.widget.ImageView;
+import android.widget.TextView;
+
+import com.android.documentsui.ActionHandler;
+import com.android.documentsui.R;
+
+
+/**
+ * Similar to {@link ProfileItem} but only used in the navigation rail.
+ */
+public class NavRailProfileItem extends ProfileItem {
+
+    public NavRailProfileItem(ResolveInfo info, String title, ActionHandler actionHandler) {
+        super(R.layout.nav_rail_item_root, info, title, actionHandler);
+    }
+
+    @Override
+    public void bindView(View convertView) {
+        final ImageView icon = convertView.findViewById(android.R.id.icon);
+        final TextView titleView = convertView.findViewById(android.R.id.title);
+
+        titleView.setText(title);
+        titleView.setContentDescription(userId.getUserBadgedLabel(convertView.getContext(), title));
+
+        bindIcon(icon);
+    }
+}
diff --git a/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java b/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java
new file mode 100644
index 000000000..1bcc42f5c
--- /dev/null
+++ b/src/com/android/documentsui/sidebar/NavRailRootAndAppItem.java
@@ -0,0 +1,40 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.sidebar;
+
+import android.content.pm.ResolveInfo;
+import android.view.View;
+
+import com.android.documentsui.ActionHandler;
+import com.android.documentsui.R;
+import com.android.documentsui.base.RootInfo;
+
+/**
+ * Similar to {@link RootAndAppItem} but only used in the navigation rail.
+ */
+public class NavRailRootAndAppItem extends RootAndAppItem {
+
+    public NavRailRootAndAppItem(
+            RootInfo root, ResolveInfo info, ActionHandler actionHandler, boolean maybeShowBadge) {
+        super(R.layout.nav_rail_item_root, root, info, actionHandler, maybeShowBadge);
+    }
+
+    @Override
+    public void bindView(View convertView) {
+        bindIconAndTitle(convertView);
+    }
+}
diff --git a/src/com/android/documentsui/sidebar/NavRailRootItem.java b/src/com/android/documentsui/sidebar/NavRailRootItem.java
new file mode 100644
index 000000000..3d4042f22
--- /dev/null
+++ b/src/com/android/documentsui/sidebar/NavRailRootItem.java
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.sidebar;
+
+
+import android.view.View;
+
+import com.android.documentsui.ActionHandler;
+import com.android.documentsui.R;
+import com.android.documentsui.base.RootInfo;
+
+/**
+ * Similar to {@link RootItem} but only used in the navigation rail.
+ */
+public class NavRailRootItem extends RootItem {
+
+    public NavRailRootItem(RootInfo root, ActionHandler actionHandler, boolean maybeShowBadge) {
+        super(
+                R.layout.nav_rail_item_root,
+                root,
+                actionHandler,
+                "" /* packageName */,
+                maybeShowBadge);
+    }
+
+    public NavRailRootItem(
+            RootInfo root,
+            ActionHandler actionHandler,
+            String packageName,
+            boolean maybeShowBadge) {
+        super(R.layout.nav_rail_item_root, root, actionHandler, packageName, maybeShowBadge);
+    }
+
+    @Override
+    public void bindView(View convertView) {
+        bindIconAndTitle(convertView);
+    }
+}
diff --git a/src/com/android/documentsui/sidebar/ProfileItem.java b/src/com/android/documentsui/sidebar/ProfileItem.java
index 15068ad4b..779f54445 100644
--- a/src/com/android/documentsui/sidebar/ProfileItem.java
+++ b/src/com/android/documentsui/sidebar/ProfileItem.java
@@ -20,6 +20,8 @@ import android.content.pm.ResolveInfo;
 import android.view.View;
 import android.widget.ImageView;
 
+import androidx.annotation.LayoutRes;
+
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.base.UserId;
 
@@ -32,6 +34,11 @@ class ProfileItem extends AppItem {
         super(info, title, UserId.CURRENT_USER, actionHandler);
     }
 
+    ProfileItem(
+            @LayoutRes int layoutId, ResolveInfo info, String title, ActionHandler actionHandler) {
+        super(layoutId, info, title, UserId.CURRENT_USER, actionHandler);
+    }
+
     @Override
     protected void bindIcon(ImageView icon) {
         icon.setImageResource(com.android.documentsui.R.drawable.ic_user_profile);
diff --git a/src/com/android/documentsui/sidebar/RootAndAppItem.java b/src/com/android/documentsui/sidebar/RootAndAppItem.java
index b893878f3..8861f6058 100644
--- a/src/com/android/documentsui/sidebar/RootAndAppItem.java
+++ b/src/com/android/documentsui/sidebar/RootAndAppItem.java
@@ -18,11 +18,11 @@ package com.android.documentsui.sidebar;
 
 import android.content.Context;
 import android.content.pm.ResolveInfo;
-import android.os.UserManager;
 import android.provider.DocumentsProvider;
-import android.text.TextUtils;
 import android.view.View;
 
+import androidx.annotation.LayoutRes;
+
 import com.android.documentsui.ActionHandler;
 import com.android.documentsui.R;
 import com.android.documentsui.base.RootInfo;
@@ -36,9 +36,18 @@ class RootAndAppItem extends RootItem {
 
     public final ResolveInfo resolveInfo;
 
-    public RootAndAppItem(RootInfo root, ResolveInfo info, ActionHandler actionHandler,
+    RootAndAppItem(
+            RootInfo root, ResolveInfo info, ActionHandler actionHandler, boolean maybeShowBadge) {
+        this(R.layout.item_root, root, info, actionHandler, maybeShowBadge);
+    }
+
+    RootAndAppItem(
+            @LayoutRes int layoutId,
+            RootInfo root,
+            ResolveInfo info,
+            ActionHandler actionHandler,
             boolean maybeShowBadge) {
-        super(root, actionHandler, info.activityInfo.packageName, maybeShowBadge);
+        super(layoutId, root, actionHandler, info.activityInfo.packageName, maybeShowBadge);
         this.resolveInfo = info;
     }
 
diff --git a/src/com/android/documentsui/sidebar/RootItem.java b/src/com/android/documentsui/sidebar/RootItem.java
index a0a3210f8..af72a5239 100644
--- a/src/com/android/documentsui/sidebar/RootItem.java
+++ b/src/com/android/documentsui/sidebar/RootItem.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.content.Context;
 import android.graphics.drawable.Drawable;
 import android.provider.DocumentsProvider;
@@ -28,6 +30,7 @@ import android.view.View;
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import androidx.annotation.LayoutRes;
 import androidx.annotation.Nullable;
 
 import com.android.documentsui.ActionHandler;
@@ -38,6 +41,8 @@ import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.UserId;
 
+import com.google.android.material.button.MaterialButton;
+
 import java.util.Objects;
 
 /**
@@ -60,7 +65,16 @@ public class RootItem extends Item {
 
     public RootItem(RootInfo root, ActionHandler actionHandler, String packageName,
             boolean maybeShowBadge) {
-        super(R.layout.item_root, root.title, getStringId(root), root.userId);
+        this(R.layout.item_root, root, actionHandler, packageName, maybeShowBadge);
+    }
+
+    public RootItem(
+            @LayoutRes int layoutId,
+            RootInfo root,
+            ActionHandler actionHandler,
+            String packageName,
+            boolean maybeShowBadge) {
+        super(layoutId, root.title, getStringId(root), root.userId);
         this.root = root;
         mActionHandler = actionHandler;
         mPackageName = packageName;
@@ -96,19 +110,36 @@ public class RootItem extends Item {
     }
 
     protected final void bindAction(View view, int visibility, int iconId, String description) {
-        final ImageView actionIcon = (ImageView) view.findViewById(R.id.action_icon);
-        final View verticalDivider = view.findViewById(R.id.vertical_divider);
-        final View actionIconArea = view.findViewById(R.id.action_icon_area);
-
-        verticalDivider.setVisibility(visibility);
-        actionIconArea.setVisibility(visibility);
-        actionIconArea.setOnClickListener(visibility == View.VISIBLE ? this::onActionClick : null);
-        if (description != null) {
-            actionIconArea.setContentDescription(description);
-        }
-        if (iconId > 0) {
-            actionIcon.setImageDrawable(IconUtils.applyTintColor(view.getContext(), iconId,
-                    R.color.item_action_icon));
+        if (isUseMaterial3FlagEnabled()) {
+            final MaterialButton actionIcon = view.findViewById(R.id.action_icon);
+
+            actionIcon.setVisibility(visibility);
+            actionIcon.setOnClickListener(visibility == View.VISIBLE ? this::onActionClick : null);
+            actionIcon.setOnFocusChangeListener(
+                    visibility == View.VISIBLE ? this::onActionIconFocusChange : null);
+            if (description != null) {
+                actionIcon.setContentDescription(description);
+            }
+            if (iconId > 0) {
+                actionIcon.setIconResource(iconId);
+            }
+        } else {
+            final ImageView actionIcon = (ImageView) view.findViewById(R.id.action_icon);
+            final View verticalDivider = view.findViewById(R.id.vertical_divider);
+            final View actionIconArea = view.findViewById(R.id.action_icon_area);
+
+            verticalDivider.setVisibility(visibility);
+            actionIconArea.setVisibility(visibility);
+            actionIconArea.setOnClickListener(
+                    visibility == View.VISIBLE ? this::onActionClick : null);
+            if (description != null) {
+                actionIconArea.setContentDescription(description);
+            }
+            if (iconId > 0) {
+                actionIcon.setImageDrawable(
+                        IconUtils.applyTintColor(
+                                view.getContext(), iconId, R.color.item_action_icon));
+            }
         }
     }
 
@@ -116,6 +147,21 @@ public class RootItem extends Item {
         RootsFragment.ejectClicked(view, root, mActionHandler);
     }
 
+    /**
+     * When the action icon is focused, adding a focus ring indicator using Stroke.
+     * TODO(b/381957932): Remove this once Material Button supports focus ring.
+     */
+    protected void onActionIconFocusChange(View view, boolean hasFocus) {
+        MaterialButton actionIcon = (MaterialButton) view;
+        if (hasFocus) {
+            final int focusRingWidth =
+                    actionIcon.getResources().getDimensionPixelSize(R.dimen.focus_ring_width);
+            actionIcon.setStrokeWidth(focusRingWidth);
+        } else {
+            actionIcon.setStrokeWidth(0);
+        }
+    }
+
     protected final void bindIconAndTitle(View view) {
         bindIcon(view, root.loadDrawerIcon(view.getContext(), mMaybeShowBadge));
         bindTitle(view);
diff --git a/src/com/android/documentsui/sidebar/RootsAdapter.java b/src/com/android/documentsui/sidebar/RootsAdapter.java
index a08637c9d..d689705be 100644
--- a/src/com/android/documentsui/sidebar/RootsAdapter.java
+++ b/src/com/android/documentsui/sidebar/RootsAdapter.java
@@ -16,12 +16,15 @@
 
 package com.android.documentsui.sidebar;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.app.Activity;
 import android.os.Looper;
 import android.view.View;
 import android.view.View.OnDragListener;
 import android.view.ViewGroup;
 import android.widget.ArrayAdapter;
+import android.widget.ListView;
 
 import com.android.documentsui.R;
 
@@ -83,6 +86,16 @@ class RootsAdapter extends ArrayAdapter<Item> {
         final Item item = getItem(position);
         final View view = item.getView(convertView, parent);
 
+        if (isUseMaterial3FlagEnabled()) {
+            // In order to have hover showing on the list item, we need to have
+            // "android:clickable=true" on the list item level, which will break the click handler
+            // because it's set at the list level, so here we "bubble up" the item level click
+            // event to the list level by explicitly calling the "performItemClick" on the list
+            // level.
+            view.setOnClickListener(
+                    v -> ((ListView) parent).performItemClick(v, position, getItemId(position)));
+        }
+
         if (item.isRoot()) {
             view.setTag(R.id.item_position_tag, position);
             view.setOnDragListener(mDragListener);
diff --git a/src/com/android/documentsui/sidebar/RootsFragment.java b/src/com/android/documentsui/sidebar/RootsFragment.java
index 76df696ab..1735f9a29 100644
--- a/src/com/android/documentsui/sidebar/RootsFragment.java
+++ b/src/com/android/documentsui/sidebar/RootsFragment.java
@@ -19,6 +19,8 @@ package com.android.documentsui.sidebar;
 import static com.android.documentsui.base.Shared.compareToIgnoreCaseNullable;
 import static com.android.documentsui.base.SharedMinimal.DEBUG;
 import static com.android.documentsui.base.SharedMinimal.VERBOSE;
+import static com.android.documentsui.util.FlagUtils.isHideRootsOnDesktopFlagEnabled;
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
@@ -49,6 +51,7 @@ import android.widget.AdapterView.OnItemClickListener;
 import android.widget.AdapterView.OnItemLongClickListener;
 import android.widget.ListView;
 
+import androidx.annotation.IdRes;
 import androidx.annotation.Nullable;
 import androidx.annotation.RequiresApi;
 import androidx.annotation.VisibleForTesting;
@@ -96,12 +99,23 @@ import java.util.stream.Collectors;
 
 /**
  * Display list of known storage backend roots.
+ * This fragment will be used in:
+ * * fixed_layout: as navigation tree (sidebar)
+ * * drawer_layout: as navigation drawer
+ * * nav_rail_layout: as navigation drawer and navigation rail.
  */
 public class RootsFragment extends Fragment {
 
     private static final String TAG = "RootsFragment";
     private static final String EXTRA_INCLUDE_APPS = "includeApps";
     private static final String EXTRA_INCLUDE_APPS_INTENT = "includeAppsIntent";
+    /**
+     * A key used to store the container id in the RootFragment.
+     * RootFragment is used in both navigation drawer and navigation rail, there are 2 instances
+     * of the fragment rendered on the page, we need to know which one is which to render different
+     * nav items inside.
+     */
+    private static final String EXTRA_CONTAINER_ID = "containerId";
     private static final int CONTEXT_MENU_ITEM_TIMEOUT = 500;
 
     private final OnItemClickListener mItemListener = new OnItemClickListener() {
@@ -135,41 +149,88 @@ public class RootsFragment extends Fragment {
 
     private List<Item> mApplicationItemList;
 
+    // Weather the fragment is using nav_rail_container_roots as its container (in nav_rail_layout).
+    // This will always be false if isUseMaterial3FlagEnabled() flag is off.
+    private boolean mUseRailAsContainer = false;
+
+    /**
+     * Show the RootsFragment inside the navigation drawer container.
+     */
+    public static RootsFragment show(FragmentManager fm, boolean includeApps, Intent intent) {
+        return showWithLayout(R.id.container_roots, fm, includeApps, intent);
+    }
+
+    /**
+     * Show the RootsFragment inside the navigation rail container.
+     */
+    public static RootsFragment showNavRail(FragmentManager fm, boolean includeApps,
+            Intent intent) {
+        return showWithLayout(R.id.nav_rail_container_roots, fm, includeApps, intent);
+    }
+
     /**
      * Shows the {@link RootsFragment}.
      *
+     * @param containerId the container id where the {@link RootsFragment} will be rendered into
      * @param fm          the FragmentManager for interacting with fragments associated with this
      *                    fragment's activity
      * @param includeApps if {@code true}, query the intent from the system and include apps in
      *                    the {@RootsFragment}.
      * @param intent      the intent to query for package manager
      */
-    public static RootsFragment show(FragmentManager fm, boolean includeApps, Intent intent) {
+    private static RootsFragment showWithLayout(
+            @IdRes int containerId, FragmentManager fm, boolean includeApps, Intent intent) {
         final Bundle args = new Bundle();
         args.putBoolean(EXTRA_INCLUDE_APPS, includeApps);
         args.putParcelable(EXTRA_INCLUDE_APPS_INTENT, intent);
+        if (isUseMaterial3FlagEnabled()) {
+            args.putInt(EXTRA_CONTAINER_ID, containerId);
+        }
 
         final RootsFragment fragment = new RootsFragment();
         fragment.setArguments(args);
 
         final FragmentTransaction ft = fm.beginTransaction();
-        ft.replace(R.id.container_roots, fragment);
+        ft.replace(containerId, fragment);
         ft.commitAllowingStateLoss();
 
         return fragment;
     }
 
+    /**
+     * Get the RootsFragment instance for the navigation drawer.
+     */
     public static RootsFragment get(FragmentManager fm) {
         return (RootsFragment) fm.findFragmentById(R.id.container_roots);
     }
 
+    /**
+     * Get the RootsFragment instance for the navigation drawer.
+     */
+    public static RootsFragment getNavRail(FragmentManager fm) {
+        return (RootsFragment) fm.findFragmentById(R.id.nav_rail_container_roots);
+    }
+
     @Override
     public View onCreateView(
             LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 
+        if (isUseMaterial3FlagEnabled()) {
+            mUseRailAsContainer =
+                    getArguments() != null
+                            && getArguments().getInt(EXTRA_CONTAINER_ID)
+                                    == R.id.nav_rail_container_roots;
+        }
+
         mInjector = getBaseActivity().getInjector();
 
-        final View view = inflater.inflate(R.layout.fragment_roots, container, false);
+        final View view =
+                inflater.inflate(
+                        mUseRailAsContainer
+                                ? R.layout.fragment_nav_rail_roots
+                                : R.layout.fragment_roots,
+                        container,
+                        false);
         mList = (ListView) view.findViewById(R.id.roots_list);
         mList.setOnItemClickListener(mItemListener);
         // ListView does not have right-click specific listeners, so we will have a
@@ -312,10 +373,17 @@ public class RootsFragment extends Fragment {
                 if (crossProfileResolveInfo != null && !Features.CROSS_PROFILE_TABS) {
                     // Add profile item if we don't support cross-profile tab.
                     sortedItems.add(new SpacerItem());
-                    sortedItems.add(new ProfileItem(crossProfileResolveInfo,
-                            crossProfileResolveInfo.loadLabel(
-                                    getContext().getPackageManager()).toString(),
-                            mActionHandler));
+                    if (mUseRailAsContainer) {
+                        sortedItems.add(new NavRailProfileItem(crossProfileResolveInfo,
+                                crossProfileResolveInfo.loadLabel(
+                                        getContext().getPackageManager()).toString(),
+                                mActionHandler));
+                    } else {
+                        sortedItems.add(new ProfileItem(crossProfileResolveInfo,
+                                crossProfileResolveInfo.loadLabel(
+                                        getContext().getPackageManager()).toString(),
+                                mActionHandler));
+                    }
                 }
 
                 // Disable drawer if only one root
@@ -413,16 +481,39 @@ public class RootsFragment extends Fragment {
 
             if (root.isExternalStorageHome()) {
                 continue;
+            } else if (isHideRootsOnDesktopFlagEnabled()
+                    && context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_PC)
+                    && (root.isImages() || root.isVideos()
+                    || root.isDocuments()
+                    || root.isAudio())) {
+                // Hide Images/Videos/Documents/Audio roots on desktop.
+                Log.d(TAG, "Hiding " + root);
+                continue;
             } else if (root.isLibrary() || root.isDownloads()) {
-                item = new RootItem(root, mActionHandler, maybeShowBadge);
+                item =
+                        mUseRailAsContainer
+                                ? new NavRailRootItem(root, mActionHandler, maybeShowBadge)
+                                : new RootItem(root, mActionHandler, maybeShowBadge);
                 librariesBuilder.add(item);
             } else if (root.isStorage()) {
-                item = new RootItem(root, mActionHandler, maybeShowBadge);
+                item =
+                        mUseRailAsContainer
+                                ? new NavRailRootItem(root, mActionHandler, maybeShowBadge)
+                                : new RootItem(root, mActionHandler, maybeShowBadge);
                 storageProvidersBuilder.add(item);
             } else {
-                item = new RootItem(root, mActionHandler,
-                        providersAccess.getPackageName(root.userId, root.authority),
-                        maybeShowBadge);
+                item =
+                        mUseRailAsContainer
+                                ? new NavRailRootItem(
+                                        root,
+                                        mActionHandler,
+                                        providersAccess.getPackageName(root.userId, root.authority),
+                                        maybeShowBadge)
+                                : new RootItem(
+                                        root,
+                                        mActionHandler,
+                                        providersAccess.getPackageName(root.userId, root.authority),
+                                        maybeShowBadge);
                 otherProviders.add(item);
             }
         }
@@ -566,8 +657,18 @@ public class RootsFragment extends Fragment {
                     appsMapping.put(userPackage, info);
 
                     if (!CrossProfileUtils.isCrossProfileIntentForwarderActivity(info)) {
-                        final Item item = new AppItem(info, info.loadLabel(pm).toString(), userId,
-                                mActionHandler);
+                        final Item item =
+                                mUseRailAsContainer
+                                        ? new NavRailAppItem(
+                                                info,
+                                                info.loadLabel(pm).toString(),
+                                                userId,
+                                                mActionHandler)
+                                        : new AppItem(
+                                                info,
+                                                info.loadLabel(pm).toString(),
+                                                userId,
+                                                mActionHandler);
                         appItems.put(userPackage, item);
                         if (VERBOSE) Log.v(TAG, "Adding handler app: " + item);
                     }
@@ -583,8 +684,12 @@ public class RootsFragment extends Fragment {
 
             final Item item;
             if (resolveInfo != null) {
-                item = new RootAndAppItem(rootItem.root, resolveInfo, mActionHandler,
-                        maybeShowBadge);
+                item =
+                        mUseRailAsContainer
+                                ? new NavRailRootAndAppItem(
+                                        rootItem.root, resolveInfo, mActionHandler, maybeShowBadge)
+                                : new RootAndAppItem(
+                                        rootItem.root, resolveInfo, mActionHandler, maybeShowBadge);
                 appItems.remove(userPackage);
             } else {
                 item = rootItem;
diff --git a/src/com/android/documentsui/sorting/HeaderCell.java b/src/com/android/documentsui/sorting/HeaderCell.java
index 43e254e39..7f72f13da 100644
--- a/src/com/android/documentsui/sorting/HeaderCell.java
+++ b/src/com/android/documentsui/sorting/HeaderCell.java
@@ -16,11 +16,11 @@
 
 package com.android.documentsui.sorting;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.animation.AnimatorInflater;
 import android.animation.LayoutTransition;
 import android.animation.ObjectAnimator;
-import androidx.annotation.AnimatorRes;
-import androidx.annotation.StringRes;
 import android.content.Context;
 import android.util.AttributeSet;
 import android.view.Gravity;
@@ -29,14 +29,14 @@ import android.widget.ImageView;
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import androidx.annotation.AnimatorRes;
+import androidx.annotation.StringRes;
+
 import com.android.documentsui.R;
-import com.android.documentsui.sorting.SortDimension;
 
 /**
- * A clickable, sortable table header cell layout.
- *
- * It updates its display when it binds to {@link SortDimension} and changes the status of sorting
- * when it's clicked.
+ * A clickable, sortable table header cell layout. It updates its display when it binds to {@link
+ * SortDimension} and changes the status of sorting when it's clicked.
  */
 public class HeaderCell extends LinearLayout {
 
@@ -62,7 +62,7 @@ public class HeaderCell extends LinearLayout {
         setVisibility(dimension.getVisibility());
 
         if (dimension.getVisibility() == View.VISIBLE) {
-            TextView label = (TextView) findViewById(R.id.label);
+            TextView label = findViewById(R.id.label);
             label.setText(dimension.getLabelId());
             switch (dimension.getDataType()) {
                 case SortDimension.DATA_TYPE_NUMBER:
@@ -77,17 +77,21 @@ public class HeaderCell extends LinearLayout {
             }
 
             if (mCurDirection != dimension.getSortDirection()) {
-                ImageView arrow = (ImageView) findViewById(R.id.sort_arrow);
+                ImageView arrow = findViewById(R.id.sort_arrow);
                 switch (dimension.getSortDirection()) {
                     case SortDimension.SORT_DIRECTION_NONE:
                         arrow.setVisibility(View.GONE);
                         break;
                     case SortDimension.SORT_DIRECTION_ASCENDING:
-                        showArrow(arrow, R.animator.arrow_rotate_up,
+                        showArrow(
+                                arrow,
+                                R.animator.arrow_rotate_up,
                                 R.string.sort_direction_ascending);
                         break;
                     case SortDimension.SORT_DIRECTION_DESCENDING:
-                        showArrow(arrow, R.animator.arrow_rotate_down,
+                        showArrow(
+                                arrow,
+                                R.animator.arrow_rotate_down,
                                 R.string.sort_direction_descending);
                         break;
                     default:
@@ -100,6 +104,22 @@ public class HeaderCell extends LinearLayout {
         }
     }
 
+    /**
+     * Sets a listener on the sort arrow image. When Material 3 is enabled, the Sort Arrow has
+     * "android:clickable" set to true (to enable a hover state). This stops the click listener from
+     * falling through to the cell click listener and thus the sort arrow will need to handle clicks
+     * itself.
+     */
+    public void setSortArrowListeners(
+            View.OnClickListener clickListener,
+            View.OnKeyListener keyListener,
+            SortDimension dimension) {
+        ImageView arrow = findViewById(R.id.sort_arrow);
+        arrow.setTag(dimension);
+        arrow.setOnKeyListener(keyListener);
+        arrow.setOnClickListener(clickListener);
+    }
+
     private void showArrow(
             ImageView arrow, @AnimatorRes int anim, @StringRes int contentDescriptionId) {
         arrow.setVisibility(View.VISIBLE);
@@ -114,8 +134,13 @@ public class HeaderCell extends LinearLayout {
     }
 
     private void setDataTypeNumber(View label) {
-        label.setTextAlignment(View.TEXT_ALIGNMENT_VIEW_END);
-        setGravity(Gravity.CENTER_VERTICAL | Gravity.END);
+        if (isUseMaterial3FlagEnabled()) {
+            label.setTextAlignment(View.TEXT_ALIGNMENT_VIEW_START);
+            setGravity(Gravity.CENTER_VERTICAL | Gravity.START);
+        } else {
+            label.setTextAlignment(View.TEXT_ALIGNMENT_VIEW_END);
+            setGravity(Gravity.CENTER_VERTICAL | Gravity.END);
+        }
     }
 
     private void setDataTypeString(View label) {
diff --git a/src/com/android/documentsui/sorting/TableHeaderController.java b/src/com/android/documentsui/sorting/TableHeaderController.java
index 549478cfc..fda7b2713 100644
--- a/src/com/android/documentsui/sorting/TableHeaderController.java
+++ b/src/com/android/documentsui/sorting/TableHeaderController.java
@@ -16,55 +16,69 @@
 
 package com.android.documentsui.sorting;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
+import android.view.KeyEvent;
 import android.view.View;
 
 import com.android.documentsui.R;
 
 import javax.annotation.Nullable;
 
-/**
- * View controller for table header that associates header cells in table header and columns.
- */
+/** View controller for table header that associates header cells in table header and columns. */
 public final class TableHeaderController implements SortController.WidgetController {
-    private View mTableHeader;
-
     private final HeaderCell mTitleCell;
-    private final HeaderCell mSummaryCell;
-    private final HeaderCell mSizeCell;
-    private final HeaderCell mFileTypeCell;
-    private final HeaderCell mDateCell;
-
+    // The 4 cells below will be null in compact/medium screen sizes when use_material3 flag is ON.
+    private final @Nullable HeaderCell mSummaryCell;
+    private final @Nullable HeaderCell mSizeCell;
+    private final @Nullable HeaderCell mFileTypeCell;
+    private final @Nullable HeaderCell mDateCell;
+    private final SortModel mModel;
     // We assign this here porque each method reference creates a new object
     // instance (which is wasteful).
     private final View.OnClickListener mOnCellClickListener = this::onCellClicked;
+    private final View.OnKeyListener mOnCellKeyListener = this::onCellKeyEvent;
     private final SortModel.UpdateListener mModelListener = this::onModelUpdate;
-
-    private final SortModel mModel;
+    private final View mTableHeader;
 
     private TableHeaderController(SortModel sortModel, View tableHeader) {
-        assert(sortModel != null);
-        assert(tableHeader != null);
+        assert (sortModel != null);
+        assert (tableHeader != null);
 
         mModel = sortModel;
         mTableHeader = tableHeader;
 
-        mTitleCell = (HeaderCell) tableHeader.findViewById(android.R.id.title);
-        mSummaryCell = (HeaderCell) tableHeader.findViewById(android.R.id.summary);
-        mSizeCell = (HeaderCell) tableHeader.findViewById(R.id.size);
-        mFileTypeCell = (HeaderCell) tableHeader.findViewById(R.id.file_type);
-        mDateCell = (HeaderCell) tableHeader.findViewById(R.id.date);
+        mTitleCell = tableHeader.findViewById(android.R.id.title);
+        mSummaryCell = tableHeader.findViewById(android.R.id.summary);
+        mSizeCell = tableHeader.findViewById(R.id.size);
+        mFileTypeCell = tableHeader.findViewById(R.id.file_type);
+        mDateCell = tableHeader.findViewById(R.id.date);
 
         onModelUpdate(mModel, SortModel.UPDATE_TYPE_UNSPECIFIED);
 
         mModel.addListener(mModelListener);
     }
 
+    /** Creates a TableHeaderController. */
+    public static @Nullable TableHeaderController create(
+            SortModel sortModel, @Nullable View tableHeader) {
+        return (tableHeader == null) ? null : new TableHeaderController(sortModel, tableHeader);
+    }
+
     private void onModelUpdate(SortModel model, int updateTypeUnspecified) {
         bindCell(mTitleCell, SortModel.SORT_DIMENSION_ID_TITLE);
-        bindCell(mSummaryCell, SortModel.SORT_DIMENSION_ID_SUMMARY);
-        bindCell(mSizeCell, SortModel.SORT_DIMENSION_ID_SIZE);
-        bindCell(mFileTypeCell, SortModel.SORT_DIMENSION_ID_FILE_TYPE);
-        bindCell(mDateCell, SortModel.SORT_DIMENSION_ID_DATE);
+        if (mSummaryCell != null) {
+            bindCell(mSummaryCell, SortModel.SORT_DIMENSION_ID_SUMMARY);
+        }
+        if (mSizeCell != null) {
+            bindCell(mSizeCell, SortModel.SORT_DIMENSION_ID_SIZE);
+        }
+        if (mFileTypeCell != null) {
+            bindCell(mFileTypeCell, SortModel.SORT_DIMENSION_ID_FILE_TYPE);
+        }
+        if (mDateCell != null) {
+            bindCell(mDateCell, SortModel.SORT_DIMENSION_ID_DATE);
+        }
     }
 
     @Override
@@ -78,7 +92,7 @@ public final class TableHeaderController implements SortController.WidgetControl
     }
 
     private void bindCell(HeaderCell cell, int id) {
-        assert(cell != null);
+        assert (cell != null);
         SortDimension dimension = mModel.getDimensionById(id);
 
         cell.setTag(dimension);
@@ -87,8 +101,12 @@ public final class TableHeaderController implements SortController.WidgetControl
         if (dimension.getVisibility() == View.VISIBLE
                 && dimension.getSortCapability() != SortDimension.SORT_CAPABILITY_NONE) {
             cell.setOnClickListener(mOnCellClickListener);
+            if (isUseMaterial3FlagEnabled()) {
+                cell.setSortArrowListeners(mOnCellClickListener, mOnCellKeyListener, dimension);
+            }
         } else {
             cell.setOnClickListener(null);
+            if (isUseMaterial3FlagEnabled()) cell.setSortArrowListeners(null, null, null);
         }
     }
 
@@ -98,8 +116,17 @@ public final class TableHeaderController implements SortController.WidgetControl
         mModel.sortByUser(dimension.getId(), dimension.getNextDirection());
     }
 
-    public static @Nullable TableHeaderController create(
-            SortModel sortModel, @Nullable View tableHeader) {
-        return (tableHeader == null) ? null : new TableHeaderController(sortModel, tableHeader);
+    /** Sorts the column if the key pressed was Enter or Space. */
+    private boolean onCellKeyEvent(View v, int keyCode, KeyEvent event) {
+        if (!isUseMaterial3FlagEnabled()) {
+            return false;
+        }
+        // Only the enter and space bar should trigger the sort header to engage.
+        if (event.getAction() == KeyEvent.ACTION_UP
+                && (keyCode == KeyEvent.KEYCODE_ENTER || keyCode == KeyEvent.KEYCODE_SPACE)) {
+            onCellClicked(v);
+            return true;
+        }
+        return false;
     }
 }
diff --git a/src/com/android/documentsui/ui/DocumentDebugInfo.java b/src/com/android/documentsui/ui/DocumentDebugInfo.java
deleted file mode 100644
index b7712c60a..000000000
--- a/src/com/android/documentsui/ui/DocumentDebugInfo.java
+++ /dev/null
@@ -1,59 +0,0 @@
-/*
- * Copyright (C) 2015 The Android Open Source Project
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package com.android.documentsui.ui;
-
-import androidx.annotation.Nullable;
-import android.content.Context;
-import android.util.AttributeSet;
-import android.widget.TextView;
-
-import com.android.documentsui.base.DocumentInfo;
-
-/**
- * Document debug info view.
- */
-public class DocumentDebugInfo extends TextView {
-    public DocumentDebugInfo(Context context) {
-        super(context);
-
-    }
-
-    public DocumentDebugInfo(Context context, @Nullable AttributeSet attrs) {
-        super(context, attrs);
-    }
-
-    public void update(DocumentInfo doc) {
-
-        String dbgInfo = new StringBuilder()
-                .append("** PROPERTIES **\n\n")
-                .append("docid: " + doc.documentId).append("\n")
-                .append("name: " + doc.displayName).append("\n")
-                .append("mimetype: " + doc.mimeType).append("\n")
-                .append("container: " + doc.isContainer()).append("\n")
-                .append("virtual: " + doc.isVirtual()).append("\n")
-                .append("\n")
-                .append("** OPERATIONS **\n\n")
-                .append("create: " + doc.isCreateSupported()).append("\n")
-                .append("delete: " + doc.isDeleteSupported()).append("\n")
-                .append("rename: " + doc.isRenameSupported()).append("\n\n")
-                .append("** URI **\n\n")
-                .append(doc.derivedUri).append("\n")
-                .toString();
-
-        setText(dbgInfo);
-    }
-}
diff --git a/src/com/android/documentsui/ui/Snackbars.java b/src/com/android/documentsui/ui/Snackbars.java
index b45c247b5..795b6248b 100644
--- a/src/com/android/documentsui/ui/Snackbars.java
+++ b/src/com/android/documentsui/ui/Snackbars.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.ui;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import android.app.Activity;
 import android.view.Gravity;
 import android.view.View;
@@ -110,7 +112,10 @@ public final class Snackbars {
 
     public static final Snackbar makeSnackbar(
             Activity activity, CharSequence message, int duration) {
-        final View view = activity.findViewById(R.id.container_save);
+        final View view = activity.findViewById(isUseMaterial3FlagEnabled()
+                ? R.id.coordinator_layout
+                : R.id.container_save
+        );
         return Snackbar.make(view, message, duration);
     }
 }
diff --git a/src/com/android/documentsui/util/ColorUtils.kt b/src/com/android/documentsui/util/ColorUtils.kt
new file mode 100644
index 000000000..ee67b7832
--- /dev/null
+++ b/src/com/android/documentsui/util/ColorUtils.kt
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.util
+
+import android.content.Context
+import android.util.TypedValue
+import androidx.annotation.AttrRes
+
+class ColorUtils {
+    companion object {
+        /**
+         * Resolve a color attribute from the Material3 theme, example usage.
+         * resolveMaterialColorAttribute(context, com.google.android.material.R.attr.XXX).
+         */
+        @JvmStatic
+        fun resolveMaterialColorAttribute(context: Context, @AttrRes colorAttrId: Int): Int {
+            val typedValue = TypedValue()
+            context.theme.resolveAttribute(colorAttrId, typedValue, true)
+            return typedValue.data
+        }
+    }
+}
diff --git a/src/com/android/documentsui/util/FlagUtils.kt b/src/com/android/documentsui/util/FlagUtils.kt
new file mode 100644
index 000000000..cf81d5966
--- /dev/null
+++ b/src/com/android/documentsui/util/FlagUtils.kt
@@ -0,0 +1,62 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.documentsui.util
+
+import com.android.documentsui.flags.Flags
+
+/**
+ * Wraps the static flags classes to enable a single place to refactor flag usage
+ * (or combine usage when required).
+ */
+class FlagUtils {
+    companion object {
+        @JvmStatic
+        fun isUseMaterial3FlagEnabled(): Boolean {
+            return Flags.useMaterial3()
+        }
+
+        @JvmStatic
+        fun isZipNgFlagEnabled(): Boolean {
+            return Flags.zipNgRo() && Flags.useMaterial3()
+        }
+
+        @JvmStatic
+        fun isUseSearchV2FlagEnabled(): Boolean {
+            return Flags.useSearchV2ReadOnly()
+        }
+
+        @JvmStatic
+        fun isDesktopFileHandlingFlagEnabled(): Boolean {
+            return Flags.desktopFileHandlingRo()
+        }
+
+        @JvmStatic
+        fun isVisualSignalsFlagEnabled(): Boolean {
+            return Flags.visualSignalsRo() && isUseMaterial3FlagEnabled()
+        }
+
+        @JvmStatic
+        fun isHideRootsOnDesktopFlagEnabled(): Boolean {
+            return Flags.hideRootsOnDesktopRo()
+        }
+
+        @JvmStatic
+        fun isUsePeekPreviewFlagEnabled(): Boolean {
+            return Flags.usePeekPreviewRo() && isUseMaterial3FlagEnabled()
+        }
+    }
+}
diff --git a/tests/Android.bp b/tests/Android.bp
index e412919bd..65e3f259f 100644
--- a/tests/Android.bp
+++ b/tests/Android.bp
@@ -25,12 +25,16 @@ java_defaults {
     ],
 
     static_libs: [
-        "androidx.test.rules",
+        "androidx.test.core",
         "androidx.test.espresso.core",
         "androidx.test.ext.truth",
+        "androidx.test.rules",
+        "androidx.test.ext.junit",
+        "androidx.test.uiautomator_uiautomator",
+        "docsui-flags-aconfig-java-lib",
+        "flag-junit",
         "guava",
         "mockito-target",
-        "androidx.test.uiautomator_uiautomator",
     ],
 }
 
@@ -38,6 +42,7 @@ android_library {
     name: "DocumentsUIPerfTests-lib",
     srcs: [
         "common/com/android/documentsui/**/*.java",
+        "common/com/android/documentsui/**/*.kt",
         "functional/com/android/documentsui/ActivityTest.java",
     ],
     resource_dirs: [],
@@ -50,11 +55,11 @@ android_library {
 
     static_libs: [
         "androidx.legacy_legacy-support-v4",
-        "androidx.test.rules",
         "androidx.test.espresso.core",
+        "androidx.test.rules",
+        "androidx.test.uiautomator_uiautomator",
         "mockito-target",
         "ub-janktesthelper",
-        "androidx.test.uiautomator_uiautomator",
     ],
 }
 
@@ -66,7 +71,9 @@ android_library {
 
     srcs: [
         "common/**/*.java",
+        "common/**/*.kt",
         "unit/**/*.java",
+        "unit/**/*.kt",
     ],
 
     libs: [
@@ -77,8 +84,8 @@ android_library {
         "res",
     ],
 
-    min_sdk_version: "29",
-    target_sdk_version: "29",
+    min_sdk_version: "30",
+    target_sdk_version: "30",
 }
 
 android_library {
@@ -89,8 +96,11 @@ android_library {
 
     srcs: [
         "common/**/*.java",
+        "common/**/*.kt",
         "functional/**/*.java",
+        "functional/**/*.kt",
         "unit/**/*.java",
+        "unit/**/*.kt",
     ],
 
     libs: [
@@ -110,8 +120,8 @@ android_library {
         "-0 .zip",
     ],
 
-    min_sdk_version: "29",
-    target_sdk_version: "29",
+    min_sdk_version: "30",
+    target_sdk_version: "30",
     lint: {
         baseline_filename: "lint-baseline.xml",
     },
@@ -141,6 +151,6 @@ android_test {
     certificate: "platform",
 
     instrumentation_for: "DocumentsUI",
-    min_sdk_version: "29",
-    target_sdk_version: "29",
+    min_sdk_version: "30",
+    target_sdk_version: "30",
 }
diff --git a/tests/AndroidManifest.xml b/tests/AndroidManifest.xml
index d5e9a6045..c64b7aedd 100644
--- a/tests/AndroidManifest.xml
+++ b/tests/AndroidManifest.xml
@@ -2,7 +2,7 @@
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
     package="com.android.documentsui.tests">
 
-  <uses-sdk android:minSdkVersion="29" android:targetSdkVersion="29"/>
+  <uses-sdk android:minSdkVersion="30" android:targetSdkVersion="30"/>
 
   <uses-permission android:name="android.permission.INTERNET" />
 
diff --git a/tests/common/com/android/documentsui/bots/Bots.java b/tests/common/com/android/documentsui/bots/Bots.java
index 8cc00ac7a..f0f69b9cf 100644
--- a/tests/common/com/android/documentsui/bots/Bots.java
+++ b/tests/common/com/android/documentsui/bots/Bots.java
@@ -48,6 +48,7 @@ public final class Bots {
     public final UiBot main;
     public final InspectorBot inspector;
     public final NotificationsBot notifications;
+    public final PeekBot peek;
 
     public Bots(UiDevice device, UiAutomation automation, Context context, int timeout) {
         main = new UiBot(device, context, TIMEOUT);
@@ -61,13 +62,14 @@ public final class Bots {
         menu = new MenuBot(device, context, TIMEOUT);
         inspector = new InspectorBot(device, context, TIMEOUT);
         notifications = new NotificationsBot(device, context, TIMEOUT);
+        peek = new PeekBot(device, context, TIMEOUT);
     }
 
     /**
      * A test helper class that provides support for controlling directory list
      * and making assertions against the state of it.
      */
-    static abstract class BaseBot {
+    public static abstract class BaseBot {
         public final UiDevice mDevice;
         final Context mContext;
         final int mTimeout;
diff --git a/tests/common/com/android/documentsui/bots/DirectoryListBot.java b/tests/common/com/android/documentsui/bots/DirectoryListBot.java
index 3e9fa30b8..8884bf0f2 100644
--- a/tests/common/com/android/documentsui/bots/DirectoryListBot.java
+++ b/tests/common/com/android/documentsui/bots/DirectoryListBot.java
@@ -16,6 +16,8 @@
 
 package com.android.documentsui.bots;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import static junit.framework.Assert.assertEquals;
 import static junit.framework.Assert.assertFalse;
 import static junit.framework.Assert.assertNotNull;
@@ -46,7 +48,6 @@ import androidx.test.uiautomator.Until;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
-import java.util.regex.Pattern;
 
 /**
  * A test helper class that provides support for controlling directory list
@@ -56,16 +57,13 @@ public class DirectoryListBot extends Bots.BaseBot {
 
     private static final int MAX_LAYOUT_LEVEL = 10;
 
-    private static final BySelector SNACK_DELETE =
-            By.text(Pattern.compile("^Deleting [0-9]+ item.+"));
-
     private final String mDirContainerId;
     private final String mDirListId;
     private final String mItemRootId;
     private final String mPreviewId;
     private final String mIconId;
 
-    private UiAutomation mAutomation;
+    private final UiAutomation mAutomation;
 
     public DirectoryListBot(
             UiDevice device, UiAutomation automation, Context context, int timeout) {
@@ -75,7 +73,7 @@ public class DirectoryListBot extends Bots.BaseBot {
         mDirListId = mTargetPackage + ":id/dir_list";
         mItemRootId = mTargetPackage + ":id/item_root";
         mPreviewId = mTargetPackage + ":id/preview_icon";
-        mIconId = mTargetPackage + ":id/icon";
+        mIconId = mTargetPackage + (isUseMaterial3FlagEnabled() ? ":id/icon_wrapper" : ":id/icon");
     }
 
     public void assertDocumentsCount(int count) throws UiObjectNotFoundException {
@@ -178,10 +176,6 @@ public class DirectoryListBot extends Bots.BaseBot {
         findPlaceholderMessageTextView().waitForExists(mTimeout);
     }
 
-    public void assertSnackbar(int id) {
-        assertNotNull(getSnackbar(mContext.getString(id)));
-    }
-
     public void openDocument(String label) throws UiObjectNotFoundException {
         int toolType = Configurator.getInstance().getToolType();
         Configurator.getInstance().setToolType(MotionEvent.TOOL_TYPE_FINGER);
@@ -208,13 +202,6 @@ public class DirectoryListBot extends Bots.BaseBot {
         assertSelection(number);
     }
 
-    public boolean isDocumentSelected(String label) throws UiObjectNotFoundException {
-        waitForDocument(label);
-        UiObject2 selectionHotspot = findSelectionHotspot(label);
-        return selectionHotspot.getResourceName()
-                .equals(mTargetPackage + ":id/icon_check");
-    }
-
     public UiObject2 findSelectionHotspot(String label) throws UiObjectNotFoundException {
         final BySelector list = By.res(mDirListId);
 
@@ -224,20 +211,15 @@ public class DirectoryListBot extends Bots.BaseBot {
         new UiScrollable(docList).scrollIntoView(new UiSelector().text(label));
 
         UiObject2 parent = mDevice.findObject(list).findObject(selector);
+        UiObject2 selectionHotspot = null;
         for (int i = 1; i <= MAX_LAYOUT_LEVEL; i++) {
             parent = parent.getParent();
-            if (mItemRootId.equals(parent.getResourceName())) {
+            selectionHotspot = parent.findObject(By.res(mIconId));
+            if (selectionHotspot != null) {
                 break;
             }
         }
-        return parent.findObject(By.res(mIconId));
-    }
-
-    public void copyFilesToClipboard(String...labels) throws UiObjectNotFoundException {
-        for (String label: labels) {
-            selectDocument(label);
-        }
-        mDevice.pressKeyCode(KeyEvent.KEYCODE_C, KeyEvent.META_CTRL_ON);
+        return selectionHotspot;
     }
 
     public void pasteFilesFromClipboard() {
@@ -248,21 +230,6 @@ public class DirectoryListBot extends Bots.BaseBot {
         return mDevice.wait(Until.findObject(By.text(message)), mTimeout);
     }
 
-    public void clickSnackbarAction() throws UiObjectNotFoundException {
-        UiObject snackbarAction =
-                findObject(mTargetPackage + ":id/snackbar_action");
-        snackbarAction.click();
-    }
-
-    public void waitForDeleteSnackbar() {
-        mDevice.wait(Until.findObject(SNACK_DELETE), mTimeout);
-    }
-
-    public void waitForDeleteSnackbarGone() {
-        // wait a little longer for snackbar to go away, as it disappears after a timeout.
-        mDevice.wait(Until.gone(SNACK_DELETE), mTimeout * 2);
-    }
-
     public void waitForDocument(String label) throws UiObjectNotFoundException {
         findDocument(label).waitForExists(mTimeout);
     }
@@ -295,9 +262,8 @@ public class DirectoryListBot extends Bots.BaseBot {
 
     public boolean hasDocumentPreview(String label) {
         final BySelector list = By.res(mDirListId);
-        final UiObject2 text = mDevice.findObject(list).findObject(By.text(label));
 
-        UiObject2 parent = text;
+        UiObject2 parent = mDevice.findObject(list).findObject(By.text(label));
         for (int i = 1; i <= MAX_LAYOUT_LEVEL; i++) {
             parent = parent.getParent();
             if (mItemRootId.equals(parent.getResourceName())) {
@@ -338,7 +304,7 @@ public class DirectoryListBot extends Bots.BaseBot {
         String assertSelectionText = numSelected + " selected";
         UiObject2 selectionText = mDevice.wait(
                 Until.findObject(By.text(assertSelectionText)), mTimeout);
-        assertTrue(selectionText != null);
+        assertNotNull(selectionText);
     }
 
     public void assertOrder(String[] dirs, String[] files) throws UiObjectNotFoundException {
diff --git a/tests/common/com/android/documentsui/bots/PeekBot.kt b/tests/common/com/android/documentsui/bots/PeekBot.kt
new file mode 100644
index 000000000..6906d5a1a
--- /dev/null
+++ b/tests/common/com/android/documentsui/bots/PeekBot.kt
@@ -0,0 +1,50 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.bots
+
+import android.content.Context
+import androidx.test.uiautomator.UiDevice
+import androidx.test.uiautomator.UiObject
+import junit.framework.Assert.assertFalse
+import junit.framework.Assert.assertTrue
+
+/**
+ * A test helper class that provides support for controlling the peek overlay
+ * and making assertions against the state of it.
+ */
+class PeekBot(
+    device: UiDevice,
+    context: Context,
+    timeout: Int
+) : Bots.BaseBot(device, context, timeout) {
+
+    private val mOverlayId: String = "$mTargetPackage:id/peek_overlay"
+    private val mContainerId: String = "$mTargetPackage:id/peek_container"
+
+    fun assertPeekActive() {
+        val peekContainer = findPeekContainer()
+        assertTrue(peekContainer.exists())
+    }
+
+    fun assertPeekHidden() {
+        val peekContainer = findPeekContainer()
+        assertFalse(peekContainer.exists())
+    }
+
+    fun findPeekContainer(): UiObject {
+        return findObject(mOverlayId, mContainerId)
+    }
+}
diff --git a/tests/common/com/android/documentsui/bots/SortBot.java b/tests/common/com/android/documentsui/bots/SortBot.java
index 0a77de4ee..f72f16f86 100644
--- a/tests/common/com/android/documentsui/bots/SortBot.java
+++ b/tests/common/com/android/documentsui/bots/SortBot.java
@@ -49,10 +49,11 @@ import com.android.documentsui.sorting.SortModel;
 import org.hamcrest.Matcher;
 
 /**
- * A test helper class that provides support for controlling the UI Breadcrumb
- * programmatically, and making assertions against the state of the UI.
- * <p>
- * Support for working directly with Roots and Directory view can be found in the respective bots.
+ * A test helper class that provides support for controlling the UI Breadcrumb programmatically, and
+ * making assertions against the state of the UI.
+ *
+ * <p>Support for working directly with Roots and Directory view can be found in the respective
+ * bots.
  */
 public class SortBot extends Bots.BaseBot {
 
@@ -67,7 +68,7 @@ public class SortBot extends Bots.BaseBot {
     }
 
     public void sortBy(int id, @SortDirection int direction) {
-        assert(direction != SortDimension.SORT_DIRECTION_NONE);
+        assert (direction != SortDimension.SORT_DIRECTION_NONE);
 
         final @StringRes int labelId = mSortModel.getDimensionById(id).getLabelId();
         final String label = mContext.getString(labelId);
@@ -78,16 +79,15 @@ public class SortBot extends Bots.BaseBot {
             result = sortByMenu(id, direction);
         }
 
-        assertTrue("Sorting by id: " + id + " in direction: " + direction + " failed.",
-                result);
+        assertTrue("Sorting by id: " + id + " in direction: " + direction + " failed.", result);
     }
 
     public boolean isHeaderShow() {
-        return Matchers.present(mColumnBot.MATCHER);
+        return Matchers.present(ColumnSortBot.MATCHER);
     }
 
     public void assertHeaderHide() {
-        assertFalse(Matchers.present(mColumnBot.MATCHER));
+        assertFalse(Matchers.present(ColumnSortBot.MATCHER));
     }
 
     public void assertHeaderShow() {
@@ -98,11 +98,21 @@ public class SortBot extends Bots.BaseBot {
         // or with espresso. It's sad that I'm leaving you
         // with this little gremlin, but we all have to
         // move on and get stuff done :)
-        assertTrue(Matchers.present(mColumnBot.MATCHER));
+        assertTrue(Matchers.present(ColumnSortBot.MATCHER));
+    }
+
+    /**
+     * Identify if the sort arrow in list mode is focused.
+     *
+     * @return True if the sort arrow in the file list is found.
+     */
+    public boolean isSortIconFocused() {
+        UiObject2 sortArrow = mDevice.findObject(By.res(mTargetPackage + ":id/sort_arrow"));
+        return sortArrow.isFocused();
     }
 
     private boolean sortByMenu(int id, @SortDirection int direction) {
-        assert(direction != SortDimension.SORT_DIRECTION_NONE);
+        assert (direction != SortDimension.SORT_DIRECTION_NONE);
 
         clickMenuSort();
         mDevice.waitForIdle();
@@ -131,9 +141,8 @@ public class SortBot extends Bots.BaseBot {
         private static final Matcher<View> MATCHER = withId(R.id.table_header);
 
         private boolean sortBy(String label, @SortDirection int direction) {
-            final Matcher<View> cellMatcher = allOf(
-                    withChild(withText(label)),
-                    isDescendantOfA(MATCHER));
+            final Matcher<View> cellMatcher =
+                    allOf(withChild(withText(label)), isDescendantOfA(MATCHER));
             onView(cellMatcher).perform(click());
 
             final @SortDirection int viewDirection = getDirection(cellMatcher);
diff --git a/tests/common/com/android/documentsui/bots/UiBot.java b/tests/common/com/android/documentsui/bots/UiBot.java
index f30cb93b8..47e0acd5a 100644
--- a/tests/common/com/android/documentsui/bots/UiBot.java
+++ b/tests/common/com/android/documentsui/bots/UiBot.java
@@ -25,6 +25,8 @@ import static androidx.test.espresso.matcher.ViewMatchers.withClassName;
 import static androidx.test.espresso.matcher.ViewMatchers.withId;
 import static androidx.test.espresso.matcher.ViewMatchers.withText;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
+
 import static junit.framework.Assert.assertEquals;
 import static junit.framework.Assert.assertNotNull;
 import static junit.framework.Assert.assertNull;
@@ -68,37 +70,48 @@ import java.util.List;
  */
 public class UiBot extends Bots.BaseBot {
 
-    public static String targetPackageName;
-
     @SuppressWarnings("unchecked")
     private static final Matcher<View> TOOLBAR = allOf(
             isAssignableFrom(Toolbar.class),
             withId(R.id.toolbar));
-
     @SuppressWarnings("unchecked")
     private static final Matcher<View> ACTIONBAR = allOf(
             withClassName(endsWith("ActionBarContextView")));
-
     @SuppressWarnings("unchecked")
     private static final Matcher<View> TEXT_ENTRY = allOf(
             withClassName(endsWith("EditText")));
-
     @SuppressWarnings("unchecked")
     private static final Matcher<View> TOOLBAR_OVERFLOW = allOf(
             withClassName(endsWith("OverflowMenuButton")),
             ViewMatchers.isDescendantOfA(TOOLBAR));
-
     @SuppressWarnings("unchecked")
     private static final Matcher<View> ACTIONBAR_OVERFLOW = allOf(
             withClassName(endsWith("OverflowMenuButton")),
             ViewMatchers.isDescendantOfA(ACTIONBAR));
 
+    public static String targetPackageName;
+
     public UiBot(UiDevice device, Context context, int timeout) {
         super(device, context, timeout);
         targetPackageName =
                 InstrumentationRegistry.getInstrumentation().getTargetContext().getPackageName();
     }
 
+    private static Matcher<Object> withToolbarTitle(final Matcher<CharSequence> textMatcher) {
+        return new BoundedMatcher<Object, Toolbar>(Toolbar.class) {
+            @Override
+            public boolean matchesSafely(Toolbar toolbar) {
+                return textMatcher.matches(toolbar.getTitle());
+            }
+
+            @Override
+            public void describeTo(Description description) {
+                description.appendText("with toolbar title: ");
+                textMatcher.describeTo(description);
+            }
+        };
+    }
+
     public void assertWindowTitle(String expected) {
         onView(TOOLBAR)
                 .check(matches(withToolbarTitle(is(expected))));
@@ -198,7 +211,11 @@ public class UiBot extends Bots.BaseBot {
     }
 
     public void clickActionbarOverflowItem(String label) {
-        onView(ACTIONBAR_OVERFLOW).perform(click());
+        if (isUseMaterial3FlagEnabled()) {
+            onView(TOOLBAR_OVERFLOW).perform(click());
+        } else {
+            onView(ACTIONBAR_OVERFLOW).perform(click());
+        }
         // Click the item by label, since Espresso doesn't support lookup by id on overflow.
         onView(withText(label)).perform(click());
     }
@@ -214,9 +231,10 @@ public class UiBot extends Bots.BaseBot {
     }
 
     public boolean waitForActionModeBarToAppear() {
+        String actionModeId = isUseMaterial3FlagEnabled() ? "toolbar" : "action_mode_bar";
         UiObject2 bar =
-                mDevice.wait(Until.findObject(
-                        By.res(mTargetPackage + ":id/action_mode_bar")), mTimeout);
+                mDevice.wait(
+                        Until.findObject(By.res(mTargetPackage + ":id/" + actionModeId)), mTimeout);
         return (bar != null);
     }
 
@@ -266,14 +284,16 @@ public class UiBot extends Bots.BaseBot {
         // Espresso has flaky results when keyboard shows up, so hiding it for now
         // before trying to click on any dialog button
         Espresso.closeSoftKeyboard();
-        onView(withId(android.R.id.button1)).perform(click());
+        UiObject2 okButton = mDevice.findObject(By.res("android:id/button1"));
+        okButton.click();
     }
 
     public void clickDialogCancelButton() throws UiObjectNotFoundException {
         // Espresso has flaky results when keyboard shows up, so hiding it for now
         // before trying to click on any dialog button
         Espresso.closeSoftKeyboard();
-        onView(withId(android.R.id.button2)).perform(click());
+        UiObject2 okButton = mDevice.findObject(By.res("android:id/button2"));
+        okButton.click();
     }
 
     public UiObject findMenuLabelWithName(String label) {
@@ -307,20 +327,4 @@ public class UiBot extends Bots.BaseBot {
         // TODO: use the system string ? android.R.string.action_menu_overflow_description
         return mDevice.findObject(selector);
     }
-
-    private static Matcher<Object> withToolbarTitle(
-            final Matcher<CharSequence> textMatcher) {
-        return new BoundedMatcher<Object, Toolbar>(Toolbar.class) {
-            @Override
-            public boolean matchesSafely(Toolbar toolbar) {
-                return textMatcher.matches(toolbar.getTitle());
-            }
-
-            @Override
-            public void describeTo(Description description) {
-                description.appendText("with toolbar title: ");
-                textMatcher.describeTo(description);
-            }
-        };
-    }
 }
diff --git a/tests/common/com/android/documentsui/services/TestJob.java b/tests/common/com/android/documentsui/services/TestJob.java
index 10addebd9..426cb9575 100644
--- a/tests/common/com/android/documentsui/services/TestJob.java
+++ b/tests/common/com/android/documentsui/services/TestJob.java
@@ -23,11 +23,11 @@ import android.app.Notification;
 import android.app.Notification.Builder;
 import android.content.Context;
 
-import com.android.documentsui.base.Features;
-import com.android.documentsui.clipping.UrisSupplier;
 import com.android.documentsui.R;
 import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.DocumentStack;
+import com.android.documentsui.base.Features;
+import com.android.documentsui.clipping.UrisSupplier;
 import com.android.documentsui.services.FileOperationService.OpType;
 
 import java.text.NumberFormat;
@@ -97,6 +97,10 @@ public class TestJob extends Job {
         throw new UnsupportedOperationException();
     }
 
+    JobProgress getJobProgress() {
+        return new JobProgress(id, getState(), "test job", false);
+    }
+
     @Override
     Builder createProgressBuilder() {
         ++mNumOfNotifications;
diff --git a/tests/common/com/android/documentsui/testing/MutableJobProgress.kt b/tests/common/com/android/documentsui/testing/MutableJobProgress.kt
new file mode 100644
index 000000000..b2dd595f9
--- /dev/null
+++ b/tests/common/com/android/documentsui/testing/MutableJobProgress.kt
@@ -0,0 +1,32 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.testing
+
+import com.android.documentsui.services.Job
+import com.android.documentsui.services.JobProgress
+
+data class MutableJobProgress(
+    var id: String,
+    @Job.State var state: Int,
+    var msg: String?,
+    var hasFailures: Boolean,
+    var currentBytes: Long = -1,
+    var requiredBytes: Long = -1,
+    var msRemaining: Long = -1,
+) {
+    fun toJobProgress() =
+        JobProgress(id, state, msg, hasFailures, currentBytes, requiredBytes, msRemaining)
+}
diff --git a/tests/common/com/android/documentsui/testing/TestDirectoryDetails.java b/tests/common/com/android/documentsui/testing/TestDirectoryDetails.java
index 28416775a..fb1a7b6db 100644
--- a/tests/common/com/android/documentsui/testing/TestDirectoryDetails.java
+++ b/tests/common/com/android/documentsui/testing/TestDirectoryDetails.java
@@ -24,6 +24,7 @@ import com.android.documentsui.MenuManager.DirectoryDetails;
 public class TestDirectoryDetails extends DirectoryDetails {
 
     public boolean isInRecents;
+    public boolean isInArchive;
     public boolean hasRootSettings;
     public boolean hasItemsToPaste;
     public boolean canCreateDoc;
@@ -49,6 +50,11 @@ public class TestDirectoryDetails extends DirectoryDetails {
         return isInRecents;
     }
 
+    @Override
+    public boolean isInArchive() {
+        return isInArchive;
+    }
+
     @Override
     public boolean canCreateDoc() {
         return canCreateDoc;
diff --git a/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java b/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
index 5c5ed856f..c7e884fde 100644
--- a/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
+++ b/tests/common/com/android/documentsui/testing/TestDocumentsProvider.java
@@ -17,6 +17,7 @@
 package com.android.documentsui.testing;
 
 import android.annotation.NonNull;
+import android.annotation.Nullable;
 import android.content.Context;
 import android.content.pm.ProviderInfo;
 import android.database.Cursor;
@@ -25,6 +26,7 @@ import android.net.Uri;
 import android.os.Bundle;
 import android.os.CancellationSignal;
 import android.os.ParcelFileDescriptor;
+import android.provider.DocumentsContract;
 import android.provider.DocumentsContract.Document;
 import android.provider.DocumentsProvider;
 
@@ -91,13 +93,59 @@ public class TestDocumentsProvider extends DocumentsProvider {
         return mNextRecentDocuments;
     }
 
+    private String getStringColumn(Cursor cursor, String name) {
+        return cursor.getString(cursor.getColumnIndexOrThrow(name));
+    }
+
+    private long getLongColumn(Cursor cursor, String name) {
+        return cursor.getLong(cursor.getColumnIndexOrThrow(name));
+    }
+
+    @Override
+    public Cursor querySearchDocuments(@NonNull String rootId, @Nullable String[] projection,
+            @NonNull Bundle queryArgs) {
+        TestCursor cursor = new TestCursor(DOCUMENTS_PROJECTION);
+        if (mNextChildDocuments == null) {
+            return cursor;
+        }
+        for (boolean hasNext = mNextChildDocuments.moveToFirst(); hasNext;
+                hasNext = mNextChildDocuments.moveToNext()) {
+            String displayName = getStringColumn(mNextChildDocuments, Document.COLUMN_DISPLAY_NAME);
+            String mimeType = getStringColumn(mNextChildDocuments, Document.COLUMN_MIME_TYPE);
+            long lastModified = getLongColumn(mNextChildDocuments, Document.COLUMN_LAST_MODIFIED);
+            long size = getLongColumn(mNextChildDocuments, Document.COLUMN_SIZE);
+
+            if (DocumentsContract.matchSearchQueryArguments(queryArgs, displayName, mimeType,
+                    lastModified, size)) {
+                cursor.newRow()
+                        .add(Document.COLUMN_DOCUMENT_ID,
+                                getStringColumn(mNextChildDocuments, Document.COLUMN_DOCUMENT_ID))
+                        .add(Document.COLUMN_MIME_TYPE,
+                                getStringColumn(mNextChildDocuments, Document.COLUMN_MIME_TYPE))
+                        .add(Document.COLUMN_DISPLAY_NAME,
+                                getStringColumn(mNextChildDocuments, Document.COLUMN_DISPLAY_NAME))
+                        .add(Document.COLUMN_LAST_MODIFIED,
+                                getLongColumn(mNextChildDocuments, Document.COLUMN_LAST_MODIFIED))
+                        .add(Document.COLUMN_FLAGS,
+                                getLongColumn(mNextChildDocuments, Document.COLUMN_FLAGS))
+                        .add(Document.COLUMN_SUMMARY,
+                                getStringColumn(mNextChildDocuments, Document.COLUMN_SUMMARY))
+                        .add(Document.COLUMN_SIZE,
+                                getLongColumn(mNextChildDocuments, Document.COLUMN_SIZE))
+                        .add(Document.COLUMN_ICON,
+                                getLongColumn(mNextChildDocuments, Document.COLUMN_ICON));
+            }
+        }
+        return cursor;
+    }
+
     @Override
     public Cursor querySearchDocuments(String rootId, String query, String[] projection) {
-        if (mNextChildDocuments != null) {
-            return filterCursorByString(mNextChildDocuments, query);
+        if (mNextChildDocuments == null) {
+            return null;
         }
 
-        return mNextChildDocuments;
+        return filterCursorByString(mNextChildDocuments, query);
     }
 
     @Override
diff --git a/tests/common/com/android/documentsui/testing/TestMenu.java b/tests/common/com/android/documentsui/testing/TestMenu.java
index 10e0ea493..a97e46e5d 100644
--- a/tests/common/com/android/documentsui/testing/TestMenu.java
+++ b/tests/common/com/android/documentsui/testing/TestMenu.java
@@ -26,7 +26,6 @@ import com.android.documentsui.R;
 import org.mockito.Mockito;
 
 /**
- *
  * Test copy of {@link android.view.Menu}.
  *
  * We use abstract so we don't have to implement all the necessary methods from the interface,
@@ -55,6 +54,8 @@ public abstract class TestMenu implements Menu {
                 R.id.dir_menu_paste_into_folder,
                 R.id.dir_menu_inspect,
                 R.id.dir_menu_open_in_new_window,
+                R.id.dir_menu_extract_here,
+                R.id.dir_menu_browse,
                 R.id.root_menu_eject_root,
                 R.id.root_menu_open_in_new_window,
                 R.id.root_menu_paste_into_folder,
@@ -77,6 +78,7 @@ public abstract class TestMenu implements Menu {
                 R.id.option_menu_debug,
                 R.id.option_menu_new_window,
                 R.id.option_menu_create_dir,
+                R.id.option_menu_extract_all,
                 R.id.option_menu_select_all,
                 R.id.option_menu_settings,
                 R.id.option_menu_inspect,
@@ -88,7 +90,6 @@ public abstract class TestMenu implements Menu {
     }
 
 
-
     public static TestMenu create(int... ids) {
         final TestMenu menu = Mockito.mock(TestMenu.class,
                 Mockito.withSettings().defaultAnswer(Mockito.CALLS_REAL_METHODS));
@@ -101,6 +102,12 @@ public abstract class TestMenu implements Menu {
             if (id == R.id.option_menu_search) {
                 item.setActionView(Mockito.mock(SearchView.class));
             }
+
+            if (id == R.id.option_menu_extract_all || id == R.id.dir_menu_extract_here
+                    || id == R.id.dir_menu_browse) {
+                item.setEnabled(false);
+                item.setVisible(false);
+            }
         }
         return menu;
     }
diff --git a/tests/common/com/android/documentsui/testing/TestMenuItem.java b/tests/common/com/android/documentsui/testing/TestMenuItem.java
index 97ac602db..5463237b2 100644
--- a/tests/common/com/android/documentsui/testing/TestMenuItem.java
+++ b/tests/common/com/android/documentsui/testing/TestMenuItem.java
@@ -27,14 +27,12 @@ import androidx.annotation.StringRes;
 import org.mockito.Mockito;
 
 /**
-*
-* Test copy of {@link android.view.MenuItem}.
-*
-* We use abstract so we don't have to implement all the necessary methods from the interface,
-* and we use Mockito to just mock out the methods we need.
-* To get an instance, use {@link #create(int)}.
-*/
-
+ * Test copy of {@link android.view.MenuItem}.
+ *
+ * We use abstract so we don't have to implement all the necessary methods from the interface,
+ * and we use Mockito to just mock out the methods we need.
+ * To get an instance, use {@link #create(int)}.
+ */
 public abstract class TestMenuItem implements MenuItem {
 
     boolean enabled;
diff --git a/tests/common/com/android/documentsui/testing/TestModel.java b/tests/common/com/android/documentsui/testing/TestModel.java
index 452238189..83ece2ebb 100644
--- a/tests/common/com/android/documentsui/testing/TestModel.java
+++ b/tests/common/com/android/documentsui/testing/TestModel.java
@@ -40,7 +40,8 @@ public class TestModel extends Model {
         Document.COLUMN_FLAGS,
         Document.COLUMN_DISPLAY_NAME,
         Document.COLUMN_SIZE,
-        Document.COLUMN_MIME_TYPE
+        Document.COLUMN_MIME_TYPE,
+        Document.COLUMN_LAST_MODIFIED
     };
 
     public final UserId mUserId;
@@ -104,7 +105,7 @@ public class TestModel extends Model {
     }
 
     public DocumentInfo createDocumentForUser(String name, String mimeType, int flags,
-            UserId userId) {
+            long lastModified, UserId userId) {
         DocumentInfo doc = new DocumentInfo();
         doc.userId = userId;
         doc.authority = mAuthority;
@@ -114,6 +115,7 @@ public class TestModel extends Model {
         doc.mimeType = mimeType;
         doc.flags = flags;
         doc.size = mRand.nextInt();
+        doc.lastModified = lastModified;
 
         addToCursor(doc);
 
@@ -121,7 +123,7 @@ public class TestModel extends Model {
     }
 
     public DocumentInfo createDocument(String name, String mimeType, int flags) {
-        return createDocumentForUser(name, mimeType, flags, mUserId);
+        return createDocumentForUser(name, mimeType, flags, System.currentTimeMillis(), mUserId);
     }
 
     private void addToCursor(DocumentInfo doc) {
@@ -133,9 +135,17 @@ public class TestModel extends Model {
         row.add(Document.COLUMN_MIME_TYPE, doc.mimeType);
         row.add(Document.COLUMN_FLAGS, doc.flags);
         row.add(Document.COLUMN_SIZE, doc.size);
+        row.add(Document.COLUMN_LAST_MODIFIED, doc.lastModified);
     }
 
-    private static String guessMimeType(String name) {
+    /**
+     * Attempts to guess the MIME type of the file based on its name. If unable to guess, returns
+     * "text/plain".
+     *
+     * @param name The name of the file whose MIME type is guessed.
+     * @return A guessed MIME type of "text/plain".
+     */
+    public static String guessMimeType(String name) {
         int i = name.indexOf('.');
 
         while(i != -1) {
diff --git a/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt b/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt
new file mode 100644
index 000000000..e3ad6033c
--- /dev/null
+++ b/tests/common/com/android/documentsui/testing/TestPeekViewManager.kt
@@ -0,0 +1,34 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.testing
+
+import android.app.Activity
+import androidx.fragment.app.FragmentManager
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.peek.PeekViewManager
+
+class TestPeekViewManager(mActivity: Activity) : PeekViewManager(mActivity) {
+
+    val peekDocument = TestEventListener<DocumentInfo>()
+
+    override fun initFragment(fm: FragmentManager) {
+        throw UnsupportedOperationException()
+    }
+
+    override fun peekDocument(doc: DocumentInfo) {
+        peekDocument.accept(doc)
+    }
+}
\ No newline at end of file
diff --git a/tests/common/com/android/documentsui/testing/TestSelectionDetails.java b/tests/common/com/android/documentsui/testing/TestSelectionDetails.java
index c63fdee59..4411209d1 100644
--- a/tests/common/com/android/documentsui/testing/TestSelectionDetails.java
+++ b/tests/common/com/android/documentsui/testing/TestSelectionDetails.java
@@ -30,9 +30,10 @@ public class TestSelectionDetails implements SelectionDetails {
     public boolean containsFilesInArchive;
     public boolean containDirectories;
     public boolean containFiles;
+    public boolean isArchive;
     public boolean canPasteInto;
     public boolean canExtract;
-    public boolean canOpenWith;
+    public boolean canOpen;
     public boolean canViewInOwner;
 
     @Override
@@ -55,6 +56,11 @@ public class TestSelectionDetails implements SelectionDetails {
         return containsFilesInArchive;
     }
 
+    @Override
+    public boolean isArchive() {
+        return isArchive;
+    }
+
     @Override
     public boolean canRename() {
         return canRename;
@@ -76,8 +82,8 @@ public class TestSelectionDetails implements SelectionDetails {
     }
 
     @Override
-    public boolean canOpenWith() {
-        return canOpenWith;
+    public boolean canOpen() {
+        return canOpen;
     }
 
     @Override
@@ -89,4 +95,4 @@ public class TestSelectionDetails implements SelectionDetails {
     public int size() {
         return size;
     }
- }
+}
diff --git a/tests/functional/com/android/documentsui/ActivityTestJunit4.kt b/tests/functional/com/android/documentsui/ActivityTestJunit4.kt
new file mode 100644
index 000000000..8f1d4f860
--- /dev/null
+++ b/tests/functional/com/android/documentsui/ActivityTestJunit4.kt
@@ -0,0 +1,223 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.app.Activity
+import android.app.UiAutomation
+import android.content.ContentResolver
+import android.content.Context
+import android.content.Intent
+import android.os.Bundle
+import android.os.RemoteException
+import android.provider.DocumentsContract
+import android.view.KeyEvent
+import android.view.MotionEvent
+import androidx.test.core.app.ActivityScenario
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.Configurator
+import androidx.test.uiautomator.UiDevice
+import com.android.documentsui.base.Features
+import com.android.documentsui.base.Features.RuntimeFeatures
+import com.android.documentsui.base.RootInfo
+import com.android.documentsui.base.UserId
+import com.android.documentsui.bots.Bots
+import com.android.documentsui.files.FilesActivity
+import java.io.IOException
+import java.util.Objects
+
+/**
+ * Provides basic test environment for UI tests:
+ * - Launches activity
+ * - Creates and gives access to test root directories and test files
+ * - Cleans up the test environment
+ */
+abstract class ActivityTestJunit4<T : Activity?> {
+    @JvmField
+    var bots: Bots? = null
+
+    @JvmField
+    var device: UiDevice? = null
+
+    @JvmField
+    var context: Context? = null
+    var userId: UserId? = null
+    var automation: UiAutomation? = null
+
+    @JvmField
+    var features: Features? = null
+
+    /**
+     * Returns the root that will be opened within the activity.
+     * By default tests are started with one of the test roots.
+     * Override the method if you want to open different root on start.
+     * @return Root that will be opened. Return null if you want to open activity's default root.
+     */
+    protected open var initialRoot: RootInfo? = null
+
+    @JvmField
+    var rootDir0: RootInfo? = null
+
+    @JvmField
+    var rootDir1: RootInfo? = null
+    protected var mResolver: ContentResolver? = null
+
+    @JvmField
+    protected var mDocsHelper: DocumentsProviderHelper? = null
+    protected var mActivityScenario: ActivityScenario<T?>? = null
+    private var initialScreenOffTimeoutValue: String? = null
+    private var initialSleepTimeoutValue: String? = null
+
+    protected val testingProviderAuthority: String
+        /**
+         * Returns the authority of the testing provider begin used.
+         * By default it's StubProvider's authority.
+         * @return Authority of the provider.
+         */
+        get() = StubProvider.DEFAULT_AUTHORITY
+
+    /**
+     * Resolves testing roots.
+     */
+    @Throws(RemoteException::class)
+    protected fun setupTestingRoots() {
+        rootDir0 = mDocsHelper!!.getRoot(StubProvider.ROOT_0_ID)
+        rootDir1 = mDocsHelper!!.getRoot(StubProvider.ROOT_1_ID)
+        this.initialRoot = rootDir0
+    }
+
+    @Throws(Exception::class)
+    open fun setUp() {
+        device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
+        // NOTE: Must be the "target" context, else security checks in content provider will fail.
+        context = InstrumentationRegistry.getInstrumentation().getTargetContext()
+        userId = UserId.DEFAULT_USER
+        automation = InstrumentationRegistry.getInstrumentation().getUiAutomation()
+        features = RuntimeFeatures(context!!.getResources(), null)
+
+        bots = Bots(device, automation, context, TIMEOUT)
+
+        Configurator.getInstance().setToolType(MotionEvent.TOOL_TYPE_MOUSE)
+
+        mResolver = context!!.getContentResolver()
+        mDocsHelper = DocumentsProviderHelper(
+            userId, this.testingProviderAuthority, context,
+            this.testingProviderAuthority
+        )
+
+        device!!.setOrientationNatural()
+        device!!.pressKeyCode(KeyEvent.KEYCODE_WAKEUP)
+
+        disableScreenOffAndSleepTimeouts()
+
+        setupTestingRoots()
+
+        launchActivity()
+        resetStorage()
+
+        // Since at the launch of activity, ROOT_0 and ROOT_1 have no files, drawer will
+        // automatically open for phone devices. Espresso register click() as (x, y) MotionEvents,
+        // so if a drawer is on top of a file we want to select, it will actually click the drawer.
+        // Thus to start a clean state, we always try to close first.
+        bots!!.roots!!.closeDrawer()
+
+        // Configure the provider back to default.
+        mDocsHelper!!.configure(null, Bundle.EMPTY)
+    }
+
+    @Throws(Exception::class)
+    open fun tearDown() {
+        device!!.unfreezeRotation()
+        mDocsHelper!!.cleanUp()
+        restoreScreenOffAndSleepTimeouts()
+        mActivityScenario!!.close()
+    }
+
+    protected fun launchActivity() {
+        val intent = Intent(context, FilesActivity::class.java)
+        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK)
+        if (this.initialRoot != null) {
+            intent.setAction(Intent.ACTION_VIEW)
+            intent.setDataAndType(
+                this.initialRoot!!.uri,
+                DocumentsContract.Root.MIME_TYPE_ITEM
+            )
+        }
+        mActivityScenario = ActivityScenario.launch(intent)
+    }
+
+    @Throws(RemoteException::class)
+    protected fun resetStorage() {
+        mDocsHelper!!.clear(null, null)
+        device!!.waitForIdle()
+    }
+
+    @Throws(RemoteException::class)
+    protected open fun initTestFiles() {
+        mDocsHelper!!.createFolder(this.initialRoot, dirName1)
+        mDocsHelper!!.createDocument(this.initialRoot, "text/plain", fileName1)
+        mDocsHelper!!.createDocument(this.initialRoot, "image/png", fileName2)
+        mDocsHelper!!.createDocumentWithFlags(
+            initialRoot!!.documentId,
+            "text/plain",
+            fileNameNoRename,
+            DocumentsContract.Document.FLAG_SUPPORTS_WRITE
+        )
+
+        mDocsHelper!!.createDocument(rootDir1, "text/plain", fileName3)
+        mDocsHelper!!.createDocument(rootDir1, "text/plain", fileName4)
+    }
+
+    @Throws(IOException::class)
+    private fun disableScreenOffAndSleepTimeouts() {
+        initialScreenOffTimeoutValue = device!!.executeShellCommand(
+            "settings get system screen_off_timeout"
+        )
+        initialSleepTimeoutValue = device!!.executeShellCommand(
+            "settings get secure sleep_timeout"
+        )
+        device!!.executeShellCommand("settings put system screen_off_timeout -1")
+        device!!.executeShellCommand("settings put secure sleep_timeout -1")
+    }
+
+    @Throws(IOException::class)
+    private fun restoreScreenOffAndSleepTimeouts() {
+        Objects.requireNonNull<String?>(initialScreenOffTimeoutValue)
+        Objects.requireNonNull<String?>(initialSleepTimeoutValue)
+        try {
+            device!!.executeShellCommand(
+                "settings put system screen_off_timeout $initialScreenOffTimeoutValue"
+            )
+            device!!.executeShellCommand(
+                "settings put secure sleep_timeout $initialSleepTimeoutValue"
+            )
+        } finally {
+            initialScreenOffTimeoutValue = null
+            initialSleepTimeoutValue = null
+        }
+    }
+
+    companion object {
+        // Testing files. For custom ones, override initTestFiles().
+        const val dirName1 = "Dir1"
+        const val childDir1 = "ChildDir1"
+        const val fileName1 = "file1.log"
+        const val fileName2 = "file12.png"
+        const val fileName3 = "anotherFile0.log"
+        const val fileName4 = "poodles.text"
+        const val fileNameNoRename = "NO_RENAMEfile.txt"
+        const val TIMEOUT = 5000
+    }
+}
diff --git a/tests/functional/com/android/documentsui/FileCopyUiTest.java b/tests/functional/com/android/documentsui/FileCopyUiTest.java
index 65a5d257f..42681ee82 100644
--- a/tests/functional/com/android/documentsui/FileCopyUiTest.java
+++ b/tests/functional/com/android/documentsui/FileCopyUiTest.java
@@ -489,7 +489,7 @@ public class FileCopyUiTest extends ActivityTest<FilesActivity> {
     }
 
     @HugeLongTest
-    public void ignored_testRecursiveCopyDocuments_InternalStorageToDownloadsProvider()
+    public void testRecursiveCopyDocuments_InternalStorageToDownloadsProvider()
             throws Exception {
         // Create Download folder if it doesn't exist.
         DocumentInfo info = mStorageDocsHelper.findFile(mPrimaryRoot.documentId, "Download");
diff --git a/tests/functional/com/android/documentsui/FileManagementUiTest.java b/tests/functional/com/android/documentsui/FileManagementUiTest.java
index 4bbd8c6eb..43b74bd33 100644
--- a/tests/functional/com/android/documentsui/FileManagementUiTest.java
+++ b/tests/functional/com/android/documentsui/FileManagementUiTest.java
@@ -124,6 +124,21 @@ public class FileManagementUiTest extends ActivityTest<FilesActivity> {
         bots.directory.waitForDocument("file1.png");
     }
 
+    @HugeLongTest
+    public void testKeyboard_PasteDocumentWhileSelectionActive() throws Exception {
+        bots.directory.selectDocument("file1.png", 1);
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_C, KeyEvent.META_CTRL_ON);
+
+        device.waitForIdle();
+        bots.directory.openDocument("Dir1");
+        bots.directory.selectDocument("ChildDir1", 1);
+
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_V, KeyEvent.META_CTRL_ON);
+        device.waitForIdle();
+
+        bots.directory.assertDocumentsPresent("file1.png");
+    }
+
     public void testDeleteDocument_Cancel() throws Exception {
         bots.directory.selectDocument("file1.png", 1);
         device.waitForIdle();
diff --git a/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java b/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
index a33cca37a..e6538966f 100644
--- a/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
+++ b/tests/functional/com/android/documentsui/FilesActivityDefaultsUiTest.java
@@ -18,24 +18,46 @@ package com.android.documentsui;
 
 import static com.android.documentsui.StubProvider.ROOT_0_ID;
 import static com.android.documentsui.StubProvider.ROOT_1_ID;
+import static com.android.documentsui.flags.Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO;
 
-import android.os.RemoteException;
+import android.content.pm.PackageManager;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
 
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
 @LargeTest
-public class FilesActivityDefaultsUiTest extends ActivityTest<FilesActivity> {
+@RunWith(AndroidJUnit4.class)
+public class FilesActivityDefaultsUiTest extends ActivityTestJunit4<FilesActivity> {
+
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
+    @Before
+    public void setUp() throws Exception {
+        super.setUp();
+    }
 
-    public FilesActivityDefaultsUiTest() {
-        super(FilesActivity.class);
+    @After
+    public void tearDown() throws Exception {
+        super.tearDown();
     }
 
     @Override
-    protected void initTestFiles() throws RemoteException {
+    protected void initTestFiles() {
         // Overriding to init with no items in test roots
     }
 
@@ -44,6 +66,7 @@ public class FilesActivityDefaultsUiTest extends ActivityTest<FilesActivity> {
         return null;  // test the default, unaffected state of the app.
     }
 
+    @Test
     @HugeLongTest
     public void testNavigate_FromEmptyDirectory() throws Exception {
         device.waitForIdle();
@@ -57,8 +80,10 @@ public class FilesActivityDefaultsUiTest extends ActivityTest<FilesActivity> {
         device.pressBack();
     }
 
+    @Test
     @HugeLongTest
-    public void testDefaultRoots() throws Exception {
+    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
+    public void testDefaultRoots_hideRootsOnDesktopFlagDisabled() throws Exception {
         device.waitForIdle();
 
         // Should also have Drive, but that requires pre-configuration of devices
@@ -71,4 +96,29 @@ public class FilesActivityDefaultsUiTest extends ActivityTest<FilesActivity> {
                 ROOT_0_ID,
                 ROOT_1_ID);
     }
+
+    @Test
+    @HugeLongTest
+    @RequiresFlagsEnabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
+    public void testDefaultRoots_hideRootsOnDesktopFlagEnabled() throws Exception {
+        device.waitForIdle();
+
+        String[] expectedRoots;
+        if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_PC)) {
+            expectedRoots = new String[]{"Downloads",
+                    ROOT_0_ID,
+                    ROOT_1_ID};
+        } else {
+            expectedRoots = new String[]{
+                    "Images",
+                    "Videos",
+                    "Audio",
+                    "Downloads",
+                    ROOT_0_ID,
+                    ROOT_1_ID};
+        }
+        // Should also have Drive, but that requires pre-configuration of devices
+        // We omit for now.
+        bots.roots.assertRootsPresent(expectedRoots);
+    }
 }
diff --git a/tests/functional/com/android/documentsui/FilesActivityUiTest.java b/tests/functional/com/android/documentsui/FilesActivityUiTest.java
index 697dee6df..6c2397068 100644
--- a/tests/functional/com/android/documentsui/FilesActivityUiTest.java
+++ b/tests/functional/com/android/documentsui/FilesActivityUiTest.java
@@ -16,29 +16,49 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.flags.Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO;
+import static com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY;
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+
 import android.app.Instrumentation;
 import android.net.Uri;
 import android.os.RemoteException;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.filters.HugeLongTest;
 import com.android.documentsui.inspector.InspectorActivity;
 
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
 @LargeTest
-public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
+@RunWith(AndroidJUnit4.class)
+public class FilesActivityUiTest extends ActivityTestJunit4<FilesActivity> {
 
-    public FilesActivityUiTest() {
-        super(FilesActivity.class);
-    }
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
 
-    @Override
+    @Before
     public void setUp() throws Exception {
         super.setUp();
         initTestFiles();
     }
 
+    @After
+    public void tearDown() throws Exception {
+        super.tearDown();
+    }
+
     @Override
     public void initTestFiles() throws RemoteException {
         Uri uri = mDocsHelper.createFolder(rootDir0, dirName1);
@@ -55,6 +75,7 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
     // Recents is a strange meta root that gathers entries from other providers.
     // It is special cased in a variety of ways, which is why we just want
     // to be able to click on it.
+    @Test
     public void testClickRecent() throws Exception {
         bots.roots.openRoot("Recent");
 
@@ -67,16 +88,30 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
         }
     }
 
+    @Test
+    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
     public void testRootClick_SetsWindowTitle() throws Exception {
         bots.roots.openRoot("Images");
         bots.main.assertWindowTitle("Images");
     }
 
-    public void testFilesListed() throws Exception {
+    private void filesListed() throws Exception {
         bots.directory.assertDocumentsPresent("file0.log", "file1.png", "file2.csv");
     }
 
-    public void testFilesList_LiveUpdate() throws Exception {
+    @Test
+    @RequiresFlagsDisabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    public void testFilesListed() throws Exception {
+        filesListed();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testFilesListed_searchV2() throws Exception {
+        filesListed();
+    }
+
+    private void filesListed_LiveUpdates() throws Exception {
         mDocsHelper.createDocument(rootDir0, "yummers/sandwich", "Ham & Cheese.sandwich");
 
         bots.directory.waitForDocument("Ham & Cheese.sandwich");
@@ -84,6 +119,19 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
                 "file0.log", "file1.png", "file2.csv", "Ham & Cheese.sandwich");
     }
 
+    @Test
+    @RequiresFlagsDisabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    public void testFilesList_LiveUpdate() throws Exception {
+        filesListed_LiveUpdates();
+    }
+
+    @Test
+    @RequiresFlagsEnabled({FLAG_USE_SEARCH_V2_READ_ONLY, FLAG_USE_MATERIAL3})
+    public void testFilesList_LiveUpdate_searchV2() throws Exception {
+        filesListed_LiveUpdates();
+    }
+
+    @Test
     public void testNavigate_byBreadcrumb() throws Exception {
         bots.directory.openDocument(dirName1);
         bots.directory.waitForDocument(childDir1);  // wait for known content
@@ -96,6 +144,7 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
         bots.directory.waitForDocument(dirName1);
     }
 
+    @Test
     public void testNavigate_inFixedLayout_whileHasSelection() throws Exception {
         if (bots.main.inFixedLayout()) {
             bots.roots.openRoot(rootDir0.title);
@@ -107,6 +156,7 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
         }
     }
 
+    @Test
     public void testNavigationToInspector() throws Exception {
         if(!features.isInspectorEnabled()) {
             return;
@@ -118,7 +168,9 @@ public class FilesActivityUiTest extends ActivityTest<FilesActivity> {
         monitor.waitForActivityWithTimeout(TIMEOUT);
     }
 
+    @Test
     @HugeLongTest
+    @RequiresFlagsDisabled(FLAG_HIDE_ROOTS_ON_DESKTOP_RO)
     public void testRootChange_UpdatesSortHeader() throws Exception {
 
         // switch to separate display modes for two separate roots. Each
diff --git a/tests/functional/com/android/documentsui/JobPanelUiTest.kt b/tests/functional/com/android/documentsui/JobPanelUiTest.kt
new file mode 100644
index 000000000..5b28b1f5d
--- /dev/null
+++ b/tests/functional/com/android/documentsui/JobPanelUiTest.kt
@@ -0,0 +1,93 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.content.Intent
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import androidx.test.espresso.Espresso.onView
+import androidx.test.espresso.action.ViewActions.click
+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist
+import androidx.test.espresso.assertion.ViewAssertions.matches
+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed
+import androidx.test.espresso.matcher.ViewMatchers.withId
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.platform.app.InstrumentationRegistry
+import com.android.documentsui.files.FilesActivity
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO
+import com.android.documentsui.services.FileOperationService.ACTION_PROGRESS
+import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
+import com.android.documentsui.services.Job
+import com.android.documentsui.services.JobProgress
+import com.android.documentsui.testing.MutableJobProgress
+import org.junit.After
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO)
+@RunWith(AndroidJUnit4::class)
+class JobPanelUiTest : ActivityTestJunit4<FilesActivity>() {
+    @get:Rule
+    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+    private var mLastId = 0L
+
+    private fun sendProgress(progresses: ArrayList<JobProgress>, id: Long = mLastId++) {
+        val context = InstrumentationRegistry.getInstrumentation().targetContext
+        var intent = Intent(ACTION_PROGRESS).apply {
+            `package` = context.packageName
+            putExtra("id", id)
+            putParcelableArrayListExtra(EXTRA_PROGRESS, progresses)
+        }
+        context.sendBroadcast(intent)
+    }
+
+    @Before
+    override fun setUp() {
+        super.setUp()
+    }
+
+    @After
+    override fun tearDown() {
+        super.tearDown()
+    }
+
+    @Test
+    fun testJobPanelAppearsOnClick() {
+        onView(withId(R.id.option_menu_job_progress)).check(doesNotExist())
+        onView(withId(R.id.job_progress_panel_title)).check(doesNotExist())
+
+        val progress = MutableJobProgress(
+            id = "jobId1",
+            state = Job.STATE_SET_UP,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 4,
+            requiredBytes = 10,
+            msRemaining = -1
+        )
+        sendProgress(arrayListOf(progress.toJobProgress()))
+
+        onView(withId(R.id.option_menu_job_progress))
+            .check(matches(isDisplayed()))
+            .perform(click())
+        onView(withId(R.id.job_progress_panel_title)).check(matches(isDisplayed()))
+    }
+}
diff --git a/tests/functional/com/android/documentsui/SortDocumentUiTest.java b/tests/functional/com/android/documentsui/SortDocumentUiTest.java
index 05878bbe7..b277884e3 100644
--- a/tests/functional/com/android/documentsui/SortDocumentUiTest.java
+++ b/tests/functional/com/android/documentsui/SortDocumentUiTest.java
@@ -16,16 +16,30 @@
 
 package com.android.documentsui;
 
+import static com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3;
+
 import android.net.Uri;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
+import android.view.KeyEvent;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.LargeTest;
 
 import com.android.documentsui.files.FilesActivity;
 import com.android.documentsui.sorting.SortDimension;
 import com.android.documentsui.sorting.SortModel;
 
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+
 @LargeTest
-public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
+@RunWith(AndroidJUnit4.class)
+public class SortDocumentUiTest extends ActivityTestJunit4<FilesActivity> {
 
     private static final String DIR_1 = "folder_1";
     private static final String DIR_2 = "dir_2";
@@ -38,63 +52,76 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
     private static final String MIME_2 = "text/html"; // HTML document
     private static final String MIME_3 = "image/jpeg"; // JPG image
 
-    private static final String[] FILES = { FILE_1, FILE_3, FILE_2 };
-    private static final String[] MIMES = { MIME_1, MIME_3, MIME_2 };
-    private static final String[] DIRS = { DIR_1, DIR_2 };
-
-    private static final String[] DIRS_IN_NAME_ASC = { DIR_2, DIR_1 };
+    private static final String[] FILES = {FILE_1, FILE_3, FILE_2};
+    private static final String[] FILES_IN_MODIFIED_DESC = reverse(FILES);
+    private static final String[] MIMES = {MIME_1, MIME_3, MIME_2};
+    private static final String[] DIRS = {DIR_1, DIR_2};
+    private static final String[] DIRS_IN_MODIFIED_DESC = reverse(DIRS);
+    private static final String[] DIRS_IN_NAME_ASC = {DIR_2, DIR_1};
     private static final String[] DIRS_IN_NAME_DESC = reverse(DIRS_IN_NAME_ASC);
-    private static final String[] FILES_IN_NAME_ASC = { FILE_2, FILE_1, FILE_3 };
+    private static final String[] FILES_IN_NAME_ASC = {FILE_2, FILE_1, FILE_3};
     private static final String[] FILES_IN_NAME_DESC = reverse(FILES_IN_NAME_ASC);
-
-    private static final String[] FILES_IN_SIZE_ASC = { FILE_2, FILE_1, FILE_3 };
+    private static final String[] FILES_IN_SIZE_ASC = {FILE_2, FILE_1, FILE_3};
     private static final String[] FILES_IN_SIZE_DESC = reverse(FILES_IN_SIZE_ASC);
+    private static final String[] FILES_IN_TYPE_ASC = {FILE_2, FILE_3, FILE_1};
+    private static final String[] FILES_IN_TYPE_DESC = reverse(FILES_IN_TYPE_ASC);
 
-    private static final String[] DIRS_IN_MODIFIED_DESC = reverse(DIRS);
-    private static final String[] FILES_IN_MODIFIED_DESC = reverse(FILES);
+    private static String[] reverse(String[] array) {
+        String[] ret = new String[array.length];
 
-    private static final String[] FILES_IN_TYPE_ASC = { FILE_2, FILE_3, FILE_1 };
-    private static final String[] FILES_IN_TYPE_DESC = reverse(FILES_IN_TYPE_ASC);
+        for (int i = 0; i < array.length; ++i) {
+            ret[ret.length - i - 1] = array[i];
+        }
 
-    public SortDocumentUiTest() {
-        super(FilesActivity.class);
+        return ret;
     }
 
-    @Override
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
+    @Before
     public void setUp() throws Exception {
         super.setUp();
         bots.roots.closeDrawer();
     }
 
+    @After
+    public void tearDown() throws Exception {
+        super.tearDown();
+    }
+
     private void initFiles() throws Exception {
         initFiles(0);
     }
 
     /**
-     * Initiate test files. It allows waiting between creations of files, so that we can assure
-     * the modified date of each document is different.
+     * Initiate test files. It allows waiting between creations of files, so that we can assure the
+     * modified date of each document is different.
+     *
      * @param sleep time to sleep in ms
      */
     private void initFiles(long sleep) throws Exception {
         for (int i = 0; i < FILES.length; ++i) {
-            Uri uri = mDocsHelper.createDocument(rootDir0, MIMES[i], FILES[i]);
+            Uri uri = mDocsHelper.createDocument(getInitialRoot(), MIMES[i], FILES[i]);
             mDocsHelper.writeDocument(uri, FILES[i].getBytes());
 
             Thread.sleep(sleep);
         }
 
         for (String dir : DIRS) {
-            mDocsHelper.createFolder(rootDir0, dir);
+            mDocsHelper.createFolder(getInitialRoot(), dir);
 
             Thread.sleep(sleep);
         }
     }
 
+    @Test
     public void testDefaultSortByNameAscending() throws Exception {
         initFiles();
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_NAME_ASC);
     }
 
+    @Test
     public void testSortByName_Descending_listMode() throws Exception {
         initFiles();
 
@@ -105,46 +132,47 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_DESC, FILES_IN_NAME_DESC);
     }
 
+    @Test
     public void testSortBySize_Ascending_listMode() throws Exception {
         initFiles();
 
         bots.main.switchToListMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_ASCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_ASCENDING);
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_SIZE_ASC);
     }
 
+    @Test
     public void testSortBySize_Descending_listMode() throws Exception {
         initFiles();
 
         bots.main.switchToListMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_DESCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_DESCENDING);
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_SIZE_DESC);
     }
 
+    @Test
     public void testSortByModified_Ascending_listMode() throws Exception {
         initFiles(1000);
 
         bots.main.switchToListMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_ASCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_ASCENDING);
         bots.directory.assertOrder(DIRS, FILES);
     }
 
+    @Test
     public void testSortByModified_Descending_listMode() throws Exception {
         initFiles(1000);
 
         bots.main.switchToListMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_DESCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_DESCENDING);
         bots.directory.assertOrder(DIRS_IN_MODIFIED_DESC, FILES_IN_MODIFIED_DESC);
     }
 
+    @Test
     public void testSortByType_Ascending_listMode() throws Exception {
         initFiles();
 
@@ -155,6 +183,7 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_TYPE_ASC);
     }
 
+    @Test
     public void testSortByType_Descending_listMode() throws Exception {
         initFiles();
 
@@ -165,6 +194,7 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_TYPE_DESC);
     }
 
+    @Test
     public void testSortByName_Descending_gridMode() throws Exception {
         initFiles();
 
@@ -175,46 +205,47 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_DESC, FILES_IN_NAME_DESC);
     }
 
+    @Test
     public void testSortBySize_Ascending_gridMode() throws Exception {
         initFiles();
 
         bots.main.switchToGridMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_ASCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_ASCENDING);
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_SIZE_ASC);
     }
 
+    @Test
     public void testSortBySize_Descending_gridMode() throws Exception {
         initFiles();
 
         bots.main.switchToGridMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_DESCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_SIZE, SortDimension.SORT_DIRECTION_DESCENDING);
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_SIZE_DESC);
     }
 
+    @Test
     public void testSortByModified_Ascending_gridMode() throws Exception {
         initFiles(1000);
 
         bots.main.switchToGridMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_ASCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_ASCENDING);
         bots.directory.assertOrder(DIRS, FILES);
     }
 
+    @Test
     public void testSortByModified_Descending_gridMode() throws Exception {
         initFiles(1000);
 
         bots.main.switchToGridMode();
 
-        bots.sort.sortBy(
-                SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_DESCENDING);
+        bots.sort.sortBy(SortModel.SORT_DIMENSION_ID_DATE, SortDimension.SORT_DIRECTION_DESCENDING);
         bots.directory.assertOrder(DIRS_IN_MODIFIED_DESC, FILES_IN_MODIFIED_DESC);
     }
 
+    @Test
     public void testSortByType_Ascending_gridMode() throws Exception {
         initFiles();
 
@@ -225,6 +256,7 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_TYPE_ASC);
     }
 
+    @Test
     public void testSortByType_Descending_gridMode() throws Exception {
         initFiles();
 
@@ -235,13 +267,31 @@ public class SortDocumentUiTest extends ActivityTest<FilesActivity> {
         bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_TYPE_DESC);
     }
 
-    private static String[] reverse(String[] array) {
-        String[] ret = new String[array.length];
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_MATERIAL3)
+    public void testSortByArrowIcon() throws Exception {
+        initFiles();
 
-        for (int i = 0; i < array.length; ++i) {
-            ret[ret.length - i - 1] = array[i];
+        bots.main.switchToListMode();
+
+        // Set up the sort in descending direction to allow deterministic behaviour of the sort
+        // icon.
+        bots.sort.sortBy(
+                SortModel.SORT_DIMENSION_ID_TITLE, SortDimension.SORT_DIRECTION_DESCENDING);
+        bots.directory.assertOrder(DIRS_IN_NAME_DESC, FILES_IN_NAME_DESC);
+
+        // Tab in reverse order until the sort icon is the focus (this avoids tabbing through the
+        // roots list which is quite long in tests).
+        while (!bots.sort.isSortIconFocused()) {
+            bots.keyboard.pressKey(KeyEvent.KEYCODE_TAB, KeyEvent.META_SHIFT_LEFT_ON);
         }
 
-        return ret;
+        // Press enter on the sort icon and ensure the sort direction is changed.
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_ENTER);
+        bots.directory.assertOrder(DIRS_IN_NAME_ASC, FILES_IN_NAME_ASC);
+
+        // Space should also work in the same way as the ENTER key.
+        bots.keyboard.pressKey(KeyEvent.KEYCODE_SPACE);
+        bots.directory.assertOrder(DIRS_IN_NAME_DESC, FILES_IN_NAME_DESC);
     }
 }
diff --git a/tests/functional/com/android/documentsui/TrampolineActivityTest.kt b/tests/functional/com/android/documentsui/TrampolineActivityTest.kt
new file mode 100644
index 000000000..10b31d1eb
--- /dev/null
+++ b/tests/functional/com/android/documentsui/TrampolineActivityTest.kt
@@ -0,0 +1,261 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.content.Intent
+import android.content.Intent.ACTION_GET_CONTENT
+import android.os.Build.VERSION_CODES
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SdkSuppress
+import androidx.test.filters.SmallTest
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.By
+import androidx.test.uiautomator.UiDevice
+import androidx.test.uiautomator.Until
+import com.android.documentsui.flags.Flags.FLAG_REDIRECT_GET_CONTENT_RO
+import com.android.documentsui.picker.TrampolineActivity
+import java.util.Optional
+import java.util.regex.Pattern
+import org.junit.Assert.assertNotNull
+import org.junit.Before
+import org.junit.BeforeClass
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.junit.runners.Parameterized
+import org.junit.runners.Suite
+import org.junit.runners.Suite.SuiteClasses
+
+@SmallTest
+@RunWith(Suite::class)
+@SuiteClasses(
+    TrampolineActivityTest.ShouldLaunchCorrectPackageTest::class,
+    TrampolineActivityTest.RedirectTest::class
+)
+class TrampolineActivityTest() {
+    companion object {
+        const val UI_TIMEOUT = 5000L
+        val PHOTOPICKER_PACKAGE_REGEX: Pattern = Pattern.compile(".*(photopicker|media\\.module).*")
+        val DOCUMENTSUI_PACKAGE_REGEX: Pattern = Pattern.compile(".*documentsui.*")
+        val STACK_LIST_REGEX: Pattern = Pattern.compile(
+            "taskId=(?<taskId>[0-9]+):(.+?)(photopicker|media\\.module|documentsui)",
+            Pattern.MULTILINE
+        )
+
+        private lateinit var device: UiDevice
+
+        fun removePhotopickerAndDocumentsUITasks() {
+            // Get the current list of tasks that are visible.
+            val result = device.executeShellCommand("am stack list")
+
+            // Identify any that are from DocumentsUI or Photopicker and close them.
+            val matcher = STACK_LIST_REGEX.matcher(result)
+            while (matcher.find()) {
+                device.executeShellCommand("am stack remove ${matcher.group("taskId")}")
+            }
+        }
+
+        @BeforeClass
+        @JvmStatic
+        fun setUp() {
+            device = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
+        }
+    }
+
+    @RunWith(Parameterized::class)
+    @RequiresFlagsEnabled(FLAG_REDIRECT_GET_CONTENT_RO)
+    class ShouldLaunchCorrectPackageTest {
+        enum class AppType {
+            PHOTOPICKER,
+            DOCUMENTSUI,
+        }
+
+        data class GetContentIntentData(
+            val mimeType: String,
+            val expectedApp: AppType,
+            val extraMimeTypes: Optional<Array<String>> = Optional.empty(),
+        ) {
+            override fun toString(): String {
+                if (extraMimeTypes.isPresent) {
+                    return "${mimeType}_${extraMimeTypes.get().joinToString("_")}"
+                }
+                return mimeType
+            }
+        }
+
+        companion object {
+            @Parameterized.Parameters(name = "{0}")
+            @JvmStatic
+            fun parameters() =
+                listOf(
+                    GetContentIntentData(
+                        mimeType = "*/*",
+                        expectedApp = AppType.DOCUMENTSUI,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "image/*",
+                        expectedApp = AppType.PHOTOPICKER,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "video/*",
+                        expectedApp = AppType.PHOTOPICKER,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "image/*",
+                        extraMimeTypes = Optional.of(arrayOf("video/*")),
+                        expectedApp = AppType.PHOTOPICKER,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "video/*",
+                        extraMimeTypes = Optional.of(arrayOf("image/*")),
+                        expectedApp = AppType.PHOTOPICKER,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "video/*",
+                        extraMimeTypes = Optional.of(arrayOf("text/*")),
+                        expectedApp = AppType.DOCUMENTSUI,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "video/*",
+                        extraMimeTypes = Optional.of(arrayOf("image/*", "text/*")),
+                        expectedApp = AppType.DOCUMENTSUI,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "*/*",
+                        extraMimeTypes = Optional.of(arrayOf("image/*", "video/*")),
+                        expectedApp = AppType.PHOTOPICKER,
+                    ),
+                    GetContentIntentData(
+                        mimeType = "image/*",
+                        extraMimeTypes = Optional.of(arrayOf()),
+                        expectedApp = AppType.DOCUMENTSUI,
+                    )
+                )
+        }
+
+        @Parameterized.Parameter(0)
+        lateinit var testData: GetContentIntentData
+
+        @get:Rule
+        val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+        @Before
+        fun setUp() {
+            removePhotopickerAndDocumentsUITasks()
+
+            val context = InstrumentationRegistry.getInstrumentation().targetContext
+            val intent = Intent(ACTION_GET_CONTENT)
+            intent.setClass(context, TrampolineActivity::class.java)
+            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
+            intent.setType(testData.mimeType)
+            if (testData.extraMimeTypes.isPresent) {
+                intent.putExtra(Intent.EXTRA_MIME_TYPES, testData.extraMimeTypes.get())
+            }
+
+            context.startActivity(intent)
+        }
+
+        @Test
+        fun testCorrectAppIsLaunched() {
+            val bySelector = when (testData.expectedApp) {
+                AppType.PHOTOPICKER -> By.pkg(PHOTOPICKER_PACKAGE_REGEX)
+                else -> By.pkg(DOCUMENTSUI_PACKAGE_REGEX)
+            }
+
+            val builder = StringBuilder()
+            builder.append("Intent with mimetype ${testData.mimeType}")
+            if (testData.extraMimeTypes.isPresent) {
+                builder.append(
+                    " and EXTRA_MIME_TYPES of ${
+                        testData.extraMimeTypes.get().joinToString(", ")
+                    }"
+                )
+            }
+            builder.append(
+                " didn't cause ${testData.expectedApp.name} to appear after ${UI_TIMEOUT}ms"
+            )
+
+            assertNotNull(
+                builder.toString(),
+                device.wait(Until.findObject(bySelector), UI_TIMEOUT)
+            )
+        }
+    }
+
+    @RunWith(AndroidJUnit4::class)
+    @RequiresFlagsEnabled(FLAG_REDIRECT_GET_CONTENT_RO)
+    class RedirectTest {
+        @get:Rule
+        val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+        @Before
+        fun setUp() {
+            removePhotopickerAndDocumentsUITasks()
+        }
+
+        @Test
+        fun testReferredGetContentFromPhotopickerShouldNotRedirectBack() {
+            val context = InstrumentationRegistry.getInstrumentation().targetContext
+            val intent = Intent(ACTION_GET_CONTENT)
+            intent.setClass(context, TrampolineActivity::class.java)
+            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
+            intent.setType("*/*")
+            intent.putExtra(Intent.EXTRA_MIME_TYPES, arrayOf("image/*"))
+
+            context.startActivity(intent)
+            val moreButton = device.wait(Until.findObject(By.descContains("More")), UI_TIMEOUT)
+            moreButton?.click()
+
+            val browseButton = device.wait(Until.findObject(By.textContains("Browse")), UI_TIMEOUT)
+            browseButton?.click()
+
+            assertNotNull(
+                "DocumentsUI has not launched",
+                device.wait(Until.findObject(By.pkg(DOCUMENTSUI_PACKAGE_REGEX)), UI_TIMEOUT)
+            )
+        }
+
+        @Test
+        @SdkSuppress(minSdkVersion = VERSION_CODES.S, maxSdkVersion = VERSION_CODES.S_V2)
+        fun testAndroidSWithTakeoverGetContentDisabledShouldNotReferToDocumentsUI() {
+            val context = InstrumentationRegistry.getInstrumentation().targetContext
+            val intent = Intent(ACTION_GET_CONTENT)
+            intent.setClass(context, TrampolineActivity::class.java)
+            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
+            intent.setType("image/*")
+
+            try {
+                // Disable Photopicker from taking over `ACTION_GET_CONTENT`. In this situation, it
+                // should ALWAYS defer to DocumentsUI regardless if the mimetype satisfies the
+                // conditions.
+                device.executeShellCommand(
+                    "device_config put mediaprovider take_over_get_content false"
+                )
+                context.startActivity(intent)
+                assertNotNull(
+                    device.wait(Until.findObject(By.pkg(DOCUMENTSUI_PACKAGE_REGEX)), UI_TIMEOUT)
+                )
+            } finally {
+                device.executeShellCommand(
+                    "device_config delete mediaprovider take_over_get_content"
+                )
+            }
+        }
+    }
+}
diff --git a/tests/functional/com/android/documentsui/archives/ArchiveHandleTest.java b/tests/functional/com/android/documentsui/archives/ArchiveHandleTest.java
index 29ed8e431..d8a1f4225 100644
--- a/tests/functional/com/android/documentsui/archives/ArchiveHandleTest.java
+++ b/tests/functional/com/android/documentsui/archives/ArchiveHandleTest.java
@@ -142,6 +142,45 @@ public class ArchiveHandleTest {
             new ArchiveEntryRecord("hello/inside_folder/hello_insside.txt", 14, false),
             new ArchiveEntryRecord("hello/hello2.txt", 48, false));
 
+    private static String getNormalizedPath(String in, boolean isDir) {
+        return Archive.getEntryPath(new ArchiveEntryRecord(in, -1, isDir));
+    }
+
+    @Test
+    public void normalizePath() {
+        assertThat(getNormalizedPath("", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("/", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("/", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("///", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("///", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath(".", true)).isEqualTo("/");
+        assertThat(getNormalizedPath(".", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("./", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("./", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("./foo", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("./foo", false)).isEqualTo("/foo");
+        assertThat(getNormalizedPath("./foo/", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("./foo/", false)).isEqualTo("/foo/?");
+        assertThat(getNormalizedPath("..", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("..", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("../", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("../", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("foo", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("foo", false)).isEqualTo("/foo");
+        assertThat(getNormalizedPath("foo/", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("foo/", false)).isEqualTo("/foo/?");
+        assertThat(getNormalizedPath("foo/.", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("foo/.", false)).isEqualTo("/foo/?");
+        assertThat(getNormalizedPath("foo/..", true)).isEqualTo("/");
+        assertThat(getNormalizedPath("foo/..", false)).isEqualTo("/?");
+        assertThat(getNormalizedPath("/foo", true)).isEqualTo("/foo/");
+        assertThat(getNormalizedPath("/foo", false)).isEqualTo("/foo");
+        assertThat(getNormalizedPath("//./../a//b///../c.ext", true)).isEqualTo("/a/c.ext/");
+        assertThat(getNormalizedPath("//./../a//b///../c.ext", false)).isEqualTo("/a/c.ext");
+        assertThat(getNormalizedPath("//./../a//b///../c.ext/", true)).isEqualTo("/a/c.ext/");
+        assertThat(getNormalizedPath("//./../a//b///../c.ext/", false)).isEqualTo("/a/c.ext/?");
+    }
 
     @Test
     public void buildArchiveHandle_withoutFileDescriptor_shouldBeIllegal() throws Exception {
@@ -241,7 +280,7 @@ public class ArchiveHandleTest {
     public void buildArchiveHandle_tarBrFile_shouldNotNull() throws Exception {
         ArchiveHandle archiveHandle =
                 prepareArchiveHandle("archives/brotli/hello.tar.br", ".tar.br",
-                "application/x-brotli-compressed-tar");
+                        "application/x-brotli-compressed-tar");
 
         assertThat(archiveHandle).isNotNull();
     }
@@ -346,7 +385,7 @@ public class ArchiveHandleTest {
 
     @Test
     public void close_zipFile_shouldNotOpen() throws Exception {
-        ParcelFileDescriptor parcelFileDescriptor =  mArchiveFileTestRule
+        ParcelFileDescriptor parcelFileDescriptor = mArchiveFileTestRule
                 .openAssetFile("archives/zip/hello.zip", ".zip");
 
         ArchiveHandle archiveHandle = ArchiveHandle.create(parcelFileDescriptor,
@@ -557,7 +596,7 @@ public class ArchiveHandleTest {
     public void getEntries_tarFile_shouldTheSameWithList() throws Exception {
         ArchiveHandle archiveHandle =
                 prepareArchiveHandle("archives/tar/hello.tar", ".tar",
-                "application/x-gtar");
+                        "application/x-gtar");
 
         assertThat(transformToIterable(archiveHandle.getEntries()))
                 .containsAtLeastElementsIn(sExpectEntries);
diff --git a/tests/functional/com/android/documentsui/peek/PeekUiTest.kt b/tests/functional/com/android/documentsui/peek/PeekUiTest.kt
new file mode 100644
index 000000000..a7624df2f
--- /dev/null
+++ b/tests/functional/com/android/documentsui/peek/PeekUiTest.kt
@@ -0,0 +1,68 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.peek
+
+import android.os.RemoteException
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.LargeTest
+import com.android.documentsui.ActivityTestJunit4
+import com.android.documentsui.files.FilesActivity
+import com.android.documentsui.flags.Flags
+import org.junit.After
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@LargeTest
+@RunWith(AndroidJUnit4::class)
+@RequiresFlagsEnabled(Flags.FLAG_USE_MATERIAL3, Flags.FLAG_USE_PEEK_PREVIEW_RO)
+class PeekUiTest : ActivityTestJunit4<FilesActivity?>() {
+    @get:Rule
+    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+    @Before
+    @Throws(Exception::class)
+    override fun setUp() {
+        super.setUp()
+        initTestFiles()
+    }
+
+    @After
+    @Throws(Exception::class)
+    override fun tearDown() {
+        super.tearDown()
+    }
+
+    @Throws(RemoteException::class)
+    override fun initTestFiles() {
+        mDocsHelper!!.createDocument(rootDir0, "image/png", "image.png")
+    }
+
+    @Test
+    @Throws(
+        Exception::class
+    )
+    fun testShowPeek() {
+        bots!!.peek.assertPeekHidden()
+        bots!!.directory.selectDocument("image.png")
+        bots!!.main.clickActionItem("Get info")
+        bots!!.peek.assertPeekActive()
+    }
+}
diff --git a/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java b/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
index 525397bc0..b20942473 100644
--- a/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
+++ b/tests/functional/com/android/documentsui/services/AbstractCopyJobTest.java
@@ -44,6 +44,23 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mOpType = opType;
     }
 
+    private String getVerb() {
+        switch(mOpType) {
+            case FileOperationService.OPERATION_COPY:
+            case FileOperationService.OPERATION_EXTRACT:
+                return "Copying";
+            case FileOperationService.OPERATION_COMPRESS:
+                return "Zipping";
+            case FileOperationService.OPERATION_MOVE:
+                return "Moving";
+            case FileOperationService.OPERATION_DELETE:
+                // DeleteJob does not inherit from CopyJob
+            case FileOperationService.OPERATION_UNKNOWN:
+            default:
+                return "";
+        }
+    }
+
     public void runCopyFilesTest() throws Exception {
         Uri testFile1 = mDocs.createDocument(mSrcRoot, "text/plain", "test1.txt");
         mDocs.writeDocument(testFile1, HAM_BYTES);
@@ -51,7 +68,11 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
         mDocs.writeDocument(testFile2, FRUITY_BYTES);
 
-        createJob(newArrayList(testFile1, testFile2)).run();
+        CopyJob job = createJob(newArrayList(testFile1, testFile2));
+        JobProgress progress = job.getJobProgress();
+        assertEquals(Job.STATE_CREATED, progress.state);
+
+        job.run();
         mJobListener.waitForFinished();
 
         mDocs.assertChildCount(mDestRoot, 2);
@@ -59,6 +80,13 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
         mDocs.assertHasFile(mDestRoot, "test2.txt");
         mDocs.assertFileContents(mDestRoot.documentId, "test1.txt", HAM_BYTES);
         mDocs.assertFileContents(mDestRoot.documentId, "test2.txt", FRUITY_BYTES);
+
+        progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals(getVerb() + " 2 files to " + mDestRoot.title, progress.msg);
+        assertEquals(HAM_BYTES.length + FRUITY_BYTES.length, progress.currentBytes);
+        assertEquals(HAM_BYTES.length + FRUITY_BYTES.length, progress.requiredBytes);
     }
 
     public void runCopyVirtualTypedFileTest() throws Exception {
@@ -66,13 +94,20 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
                 mSrcRoot, "/virtual.sth", "virtual/mime-type",
                 FRUITY_BYTES, "application/pdf", "text/html");
 
-        createJob(newArrayList(testFile)).run();
-
+        CopyJob job = createJob(newArrayList(testFile));
+        job.run();
         waitForJobFinished();
 
         mDocs.assertChildCount(mDestRoot, 1);
         mDocs.assertHasFile(mDestRoot, "virtual.sth.pdf");  // copy should convert file to PDF.
         mDocs.assertFileContents(mDestRoot.documentId, "virtual.sth.pdf", FRUITY_BYTES);
+
+        JobProgress progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals("Copying virtual.sth to " + mDestRoot.title, progress.msg);
+        assertEquals(FRUITY_BYTES.length, progress.currentBytes);
+        assertEquals(FRUITY_BYTES.length, progress.requiredBytes);
     }
 
     public void runCopyVirtualNonTypedFileTest() throws Exception {
@@ -80,13 +115,21 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
                 mSrcRoot, "/virtual.sth", "virtual/mime-type",
                 FRUITY_BYTES);
 
-        createJob(newArrayList(testFile)).run();
-
+        CopyJob job = createJob(newArrayList(testFile));
+        job.run();
         waitForJobFinished();
+
         mJobListener.assertFailed();
         mJobListener.assertFilesFailed(newArrayList("virtual.sth"));
 
         mDocs.assertChildCount(mDestRoot, 0);
+
+        JobProgress progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertTrue(progress.hasFailures);
+        assertEquals(getVerb() + " virtual.sth to " + mDestRoot.title, progress.msg);
+        assertEquals(0, progress.currentBytes);
+        assertEquals(FRUITY_BYTES.length, progress.requiredBytes);
     }
 
     public void runCopyEmptyDirTest() throws Exception {
@@ -105,6 +148,13 @@ public abstract class AbstractCopyJobTest<T extends CopyJob> extends AbstractJob
 
         mDocs.assertChildCount(mDestRoot, 1);
         mDocs.assertHasDirectory(mDestRoot, "emptyDir");
+
+        JobProgress progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals(getVerb() + " emptyDir to " + mDestRoot.title, progress.msg);
+        assertEquals(-1, progress.currentBytes);
+        assertEquals(-1, progress.requiredBytes);
     }
 
     public void runCopyDirRecursivelyTest() throws Exception {
diff --git a/tests/functional/com/android/documentsui/services/CopyJobTest.java b/tests/functional/com/android/documentsui/services/CopyJobTest.java
index fd552d1c0..9074ef4c3 100644
--- a/tests/functional/com/android/documentsui/services/CopyJobTest.java
+++ b/tests/functional/com/android/documentsui/services/CopyJobTest.java
@@ -52,11 +52,19 @@ public class CopyJobTest extends AbstractCopyJobTest<CopyJob> {
                 Document.FLAG_VIRTUAL_DOCUMENT | Document.FLAG_SUPPORTS_COPY
                         | Document.FLAG_SUPPORTS_MOVE, "application/pdf");
 
-        createJob(newArrayList(testFile)).run();
+        CopyJob job = createJob(newArrayList(testFile));
+        job.run();
 
         waitForJobFinished();
         mDocs.assertChildCount(mDestRoot, 1);
         mDocs.assertHasFile(mDestRoot, "tokyo.sth.pdf");  // Copy should convert file to PDF.
+
+        JobProgress progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals("Copying tokyo.sth to " + mDestRoot.title, progress.msg);
+        assertEquals(-1, progress.currentBytes);
+        assertEquals(-1, progress.requiredBytes);
     }
 
     public void testCopyEmptyDir() throws Exception {
diff --git a/tests/functional/com/android/documentsui/services/DeleteJobTest.java b/tests/functional/com/android/documentsui/services/DeleteJobTest.java
index 55e804484..86d9930a2 100644
--- a/tests/functional/com/android/documentsui/services/DeleteJobTest.java
+++ b/tests/functional/com/android/documentsui/services/DeleteJobTest.java
@@ -37,11 +37,17 @@ public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
         Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
         mDocs.writeDocument(testFile2, FRUITY_BYTES);
 
-        createJob(newArrayList(testFile1, testFile2),
-                DocumentsContract.buildDocumentUri(AUTHORITY, mSrcRoot.documentId)).run();
+        DeleteJob job = createJob(newArrayList(testFile1, testFile2),
+                DocumentsContract.buildDocumentUri(AUTHORITY, mSrcRoot.documentId));
+        job.run();
         mJobListener.waitForFinished();
 
         mDocs.assertChildCount(mSrcRoot, 0);
+
+        var progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals("Deleting 2 files", progress.msg);
     }
 
     public void testDeleteFiles_NoSrcParent() throws Exception {
@@ -51,10 +57,15 @@ public class DeleteJobTest extends AbstractJobTest<DeleteJob> {
         Uri testFile2 = mDocs.createDocument(mSrcRoot, "text/plain", "test2.txt");
         mDocs.writeDocument(testFile2, FRUITY_BYTES);
 
-        createJob(newArrayList(testFile1, testFile2), null).run();
+        DeleteJob job = createJob(newArrayList(testFile1, testFile2), null);
+        job.run();
         mJobListener.waitForFinished();
 
         mDocs.assertChildCount(mSrcRoot, 0);
+        var progress = job.getJobProgress();
+        assertEquals(Job.STATE_COMPLETED, progress.state);
+        assertFalse(progress.hasFailures);
+        assertEquals("Deleting 2 files", progress.msg);
     }
 
     /**
diff --git a/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java b/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
index 1816ed540..5820f460f 100644
--- a/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
+++ b/tests/functional/com/android/documentsui/services/FileOperationServiceTest.java
@@ -109,6 +109,8 @@ public class FileOperationServiceTest extends ServiceTestCase<FileOperationServi
 
         assertNull(mService.features);
         mService.features = features;
+
+        mService.mVisualSignalsEnabled = false;
     }
 
     @Override
diff --git a/tests/unit/com/android/documentsui/DragAndDropManagerTests.java b/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
index d7a701f75..27b4074fd 100644
--- a/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
+++ b/tests/unit/com/android/documentsui/DragAndDropManagerTests.java
@@ -26,17 +26,22 @@ import android.content.ClipData;
 import android.content.ClipDescription;
 import android.graphics.drawable.Drawable;
 import android.os.PersistableBundle;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.util.Pair;
 import android.view.KeyEvent;
 import android.view.View;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.SmallTest;
-import androidx.test.runner.AndroidJUnit4;
 
 import com.android.documentsui.DragAndDropManager.RuntimeDragAndDropManager;
 import com.android.documentsui.DragAndDropManager.State;
 import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.RootInfo;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.services.FileOperationService;
 import com.android.documentsui.services.FileOperations;
 import com.android.documentsui.testing.ClipDatas;
@@ -52,6 +57,7 @@ import com.android.documentsui.testing.TestSelectionDetails;
 import com.android.documentsui.testing.Views;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.mockito.Mockito;
@@ -93,6 +99,9 @@ public class DragAndDropManagerTests {
 
     private DragAndDropManager mManager;
 
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
     @Before
     public void setUp() {
         mEnv = TestEnv.create();
@@ -191,7 +200,8 @@ public class DragAndDropManagerTests {
     }
 
     @Test
-    public void testStartDrag_BuildsCorrectShadow_MultipleDocs() {
+    @RequiresFlagsDisabled({Flags.FLAG_USE_MATERIAL3})
+    public void testStartDrag_BuildsCorrectShadow_MultipleDocs_M3Disabled() {
         mManager.startDrag(
                 mStartDragView,
                 Arrays.asList(TestEnv.FILE_APK, TestEnv.FILE_JPG),
@@ -207,6 +217,24 @@ public class DragAndDropManagerTests {
         mShadowBuilder.icon.assertLastArgument(mDefaultIcon);
     }
 
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testStartDrag_BuildsCorrectShadow_MultipleDocs() {
+        mManager.startDrag(
+                mStartDragView,
+                Arrays.asList(TestEnv.FILE_APK, TestEnv.FILE_JPG),
+                TestProvidersAccess.HOME,
+                Arrays.asList(TestEnv.FOLDER_0.derivedUri, TestEnv.FILE_APK.derivedUri,
+                        TestEnv.FILE_JPG.derivedUri),
+                mDetails,
+                mIconHelper,
+                TestEnv.FOLDER_0);
+
+        mShadowBuilder.title.assertLastArgument(TestEnv.FILE_APK.displayName);
+        mShadowBuilder.icon.assertLastArgument(mIconHelper.nextDocumentIcon);
+        mShadowBuilder.count.assertLastArgument(2);
+    }
+
     @Test
     public void testCanSpringOpen_ReturnsFalse_RootNotSupportCreate() {
         mManager.startDrag(
@@ -860,6 +888,7 @@ public class DragAndDropManagerTests {
         public TestEventListener<String> title;
         public TestEventListener<Drawable> icon;
         public TestEventListener<Integer> state;
+        public TestEventListener<Integer> count;
 
         private TestDragShadowBuilder() {
             super(null);
@@ -880,6 +909,11 @@ public class DragAndDropManagerTests {
             this.state.accept(state);
         }
 
+        @Override
+        void updateDragFileCount(int count) {
+            this.count.accept(count);
+        }
+
         public static TestDragShadowBuilder create() {
             TestDragShadowBuilder builder =
                     Mockito.mock(TestDragShadowBuilder.class, Mockito.CALLS_REAL_METHODS);
@@ -887,6 +921,7 @@ public class DragAndDropManagerTests {
             builder.title = new TestEventListener<>();
             builder.icon = new TestEventListener<>();
             builder.state = new TestEventListener<>();
+            builder.count = new TestEventListener<>();
 
             return builder;
         }
diff --git a/tests/unit/com/android/documentsui/JobPanelControllerTest.kt b/tests/unit/com/android/documentsui/JobPanelControllerTest.kt
new file mode 100644
index 000000000..3e510edd9
--- /dev/null
+++ b/tests/unit/com/android/documentsui/JobPanelControllerTest.kt
@@ -0,0 +1,195 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui
+
+import android.content.Intent
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import android.widget.ActionMenuView
+import android.widget.ProgressBar
+import androidx.test.ext.junit.runners.AndroidJUnit4
+import androidx.test.filters.SmallTest
+import androidx.test.platform.app.InstrumentationRegistry
+import com.android.documentsui.flags.Flags.FLAG_USE_MATERIAL3
+import com.android.documentsui.flags.Flags.FLAG_VISUAL_SIGNALS_RO
+import com.android.documentsui.services.FileOperationService.ACTION_PROGRESS
+import com.android.documentsui.services.FileOperationService.EXTRA_PROGRESS
+import com.android.documentsui.services.Job
+import com.android.documentsui.services.JobProgress
+import com.android.documentsui.testing.MutableJobProgress
+import junit.framework.Assert.assertEquals
+import junit.framework.Assert.assertFalse
+import junit.framework.Assert.assertTrue
+import org.junit.Before
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+
+@SmallTest
+@RequiresFlagsEnabled(FLAG_USE_MATERIAL3, FLAG_VISUAL_SIGNALS_RO)
+@RunWith(AndroidJUnit4::class)
+class JobPanelControllerTest {
+    @get:Rule
+    val mCheckFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+    private val mContext = InstrumentationRegistry.getInstrumentation().targetContext
+
+    // The default progress bar only has an indeterminate state, so we need to style it to allow
+    // determinate progress.
+    private val mProgressBar = ProgressBar(
+        mContext,
+        null,
+        android.R.attr.progressBarStyleHorizontal
+    )
+    private val mMenuItem = ActionMenuView(mContext).menu.add("job_panel").apply {
+        actionView = mProgressBar
+    }
+    private lateinit var mController: JobPanelController
+    private var mLastId = 0L
+
+    private fun sendProgress(progress: ArrayList<JobProgress>, id: Long = mLastId++) {
+        var intent = Intent(ACTION_PROGRESS).apply {
+            `package` = mContext.packageName
+            putExtra("id", id)
+            putParcelableArrayListExtra(EXTRA_PROGRESS, progress)
+        }
+        mController.onReceive(mContext, intent)
+    }
+
+    @Before
+    fun setUp() {
+        mController = JobPanelController(mContext)
+        mController.setMenuItem(mMenuItem)
+    }
+
+    @Test
+    fun testSingleJob() {
+        assertFalse(mMenuItem.isVisible())
+        assertFalse(mMenuItem.isEnabled())
+
+        val progress = MutableJobProgress(
+            id = "jobId1",
+            state = Job.STATE_STARTED,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 0,
+            requiredBytes = 10,
+            msRemaining = -1
+        )
+        sendProgress(arrayListOf(progress.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(0, mProgressBar.progress)
+
+        progress.apply {
+            state = Job.STATE_SET_UP
+            msg = "Job in progress"
+            currentBytes = 4
+        }
+        sendProgress(arrayListOf(progress.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(40, mProgressBar.progress)
+
+        progress.apply {
+            state = Job.STATE_COMPLETED
+            msg = "Job completed"
+            currentBytes = 10
+        }
+        sendProgress(arrayListOf(progress.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(100, mProgressBar.progress)
+    }
+
+    @Test
+    fun testMultipleJobs() {
+        assertFalse(mMenuItem.isVisible())
+        assertFalse(mMenuItem.isEnabled())
+
+        val progress1 = MutableJobProgress(
+            id = "jobId1",
+            state = Job.STATE_STARTED,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 0,
+            requiredBytes = 10,
+            msRemaining = -1
+        )
+        val progress2 = MutableJobProgress(
+            id = "jobId2",
+            state = Job.STATE_STARTED,
+            msg = "Job started",
+            hasFailures = false,
+            currentBytes = 0,
+            requiredBytes = 40,
+            msRemaining = -1
+        )
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(0, mProgressBar.progress)
+
+        progress1.apply {
+            state = Job.STATE_SET_UP
+            msg = "Job in progress"
+            currentBytes = 4
+        }
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(8, mProgressBar.progress)
+
+        progress1.apply {
+            state = Job.STATE_COMPLETED
+            msg = "Job completed"
+            currentBytes = 10
+        }
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(20, mProgressBar.progress)
+
+        progress2.apply {
+            state = Job.STATE_SET_UP
+            msg = "Job in progress"
+            currentBytes = 30
+        }
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(80, mProgressBar.progress)
+
+        progress2.apply {
+            state = Job.STATE_COMPLETED
+            msg = "Job completed"
+            currentBytes = 40
+        }
+        sendProgress(arrayListOf(progress1.toJobProgress(), progress2.toJobProgress()))
+
+        assertTrue(mMenuItem.isVisible())
+        assertTrue(mMenuItem.isEnabled())
+        assertEquals(100, mProgressBar.progress)
+    }
+}
diff --git a/tests/unit/com/android/documentsui/ProfileTabsTest.java b/tests/unit/com/android/documentsui/ProfileTabsTest.java
index 054cdd006..ad674656a 100644
--- a/tests/unit/com/android/documentsui/ProfileTabsTest.java
+++ b/tests/unit/com/android/documentsui/ProfileTabsTest.java
@@ -50,7 +50,7 @@ import java.util.Map;
 @RunWith(Parameterized.class)
 public class ProfileTabsTest {
 
-    private final UserId mSystemUser = UserId.of(UserHandle.SYSTEM);
+    private final UserId mPrimaryUser = UserId.of(UserHandle.myUserId());
     private final UserId mManagedUser = UserId.of(100);
     private final UserId mPrivateUser = UserId.of(101);
 
@@ -111,7 +111,7 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_singleUser_shouldHide() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser);
 
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.GONE);
         assertThat(mTabLayout.getTabCount()).isEqualTo(0);
@@ -119,13 +119,13 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_twoUsers_shouldShow() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.VISIBLE);
         assertThat(mTabLayout.getTabCount()).isEqualTo(2);
 
         TabLayout.Tab tab1 = mTabLayout.getTabAt(0);
-        assertThat(tab1.getTag()).isEqualTo(mSystemUser);
+        assertThat(tab1.getTag()).isEqualTo(mPrimaryUser);
         assertThat(tab1.getText()).isEqualTo(mContext.getString(R.string.personal_tab));
 
         TabLayout.Tab tab2 = mTabLayout.getTabAt(1);
@@ -136,7 +136,7 @@ public class ProfileTabsTest {
     @Test
     public void testUpdateView_multiUsers_shouldShow() {
         if (!SdkLevel.isAtLeastV() || !isPrivateSpaceEnabled) return;
-        initializeWithUsers(true, mSystemUser, mManagedUser, mPrivateUser);
+        initializeWithUsers(true, mPrimaryUser, mManagedUser, mPrivateUser);
 
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.VISIBLE);
         assertThat(mTabLayout.getTabCount()).isEqualTo(3);
@@ -152,7 +152,7 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_twoUsers_doesNotSupportCrossProfile_shouldHide() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         mState.supportsCrossProfile = false;
         mProfileTabs.updateView();
@@ -162,7 +162,7 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_twoUsers_subFolder_shouldHide() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         // Push 1 more folder. Now the stack has size of 2.
         mState.stack.push(TestEnv.FOLDER_1);
@@ -174,7 +174,7 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_twoUsers_recents_subFolder_shouldHide() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         mState.stack.changeRoot(TestProvidersAccess.RECENTS);
         // This(stack of size 2 in Recents) may not happen in real world.
@@ -187,7 +187,7 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_twoUsers_thirdParty_shouldHide() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         mState.stack.changeRoot(TestProvidersAccess.PICKLES);
         mState.stack.push((TestEnv.FOLDER_0));
@@ -200,7 +200,7 @@ public class ProfileTabsTest {
     @Test
     public void testUpdateView_twoUsers_isSearching_shouldHide() {
         mTestEnv.isSearchExpanded = true;
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.GONE);
         assertThat(mTabLayout.getTabCount()).isEqualTo(2);
@@ -208,28 +208,28 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_getSelectedUser_afterUsersChanged() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
         mProfileTabs.updateView();
         mTabLayout.selectTab(mTabLayout.getTabAt(1));
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.VISIBLE);
         assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mManagedUser);
 
         if (SdkLevel.isAtLeastS() && isPrivateSpaceEnabled) {
-            mTestUserManagerState.userIds = Lists.newArrayList(mSystemUser);
+            mTestUserManagerState.userIds = Lists.newArrayList(mPrimaryUser);
         } else {
-            mTestUserIdManager.userIds = Lists.newArrayList(mSystemUser);
+            mTestUserIdManager.userIds = Lists.newArrayList(mPrimaryUser);
         }
         mProfileTabs.updateView();
         assertThat(mTabLayoutContainer.getVisibility()).isEqualTo(View.GONE);
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
     }
 
     @Test
     public void testUpdateView_afterCurrentRootChanged_shouldChangeSelectedUser() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
         mProfileTabs.updateView();
 
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
 
         RootInfo newRoot = RootInfo.copyRootInfo(mTestCommonAddons.mCurrentRoot);
         newRoot.userId = mManagedUser;
@@ -244,10 +244,10 @@ public class ProfileTabsTest {
     @Test
     public void testUpdateView_afterCurrentRootChangedMultiUser_shouldChangeSelectedUser() {
         if (!SdkLevel.isAtLeastV() || !isPrivateSpaceEnabled) return;
-        initializeWithUsers(true, mSystemUser, mManagedUser, mPrivateUser);
+        initializeWithUsers(true, mPrimaryUser, mManagedUser, mPrivateUser);
         mProfileTabs.updateView();
 
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
 
         for (UserId userId : Lists.newArrayList(mManagedUser, mPrivateUser)) {
             RootInfo newRoot = RootInfo.copyRootInfo(mTestCommonAddons.mCurrentRoot);
@@ -263,9 +263,9 @@ public class ProfileTabsTest {
 
     @Test
     public void testUpdateView_afterSelectedUserBecomesUnavailable_shouldSwitchToCurrentUser() {
-        // here current user refers to UserId.CURRENT_USER, which in this case will be mSystemUser
+        // here current user refers to UserId.CURRENT_USER, which in this case will be mPrimaryUser
         if (!SdkLevel.isAtLeastS() || !isPrivateSpaceEnabled) return;
-        initializeWithUsers(true, mSystemUser, mManagedUser, mPrivateUser);
+        initializeWithUsers(true, mPrimaryUser, mManagedUser, mPrivateUser);
 
         mTabLayout.selectTab(mTabLayout.getTabAt(2));
         assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrivateUser);
@@ -274,15 +274,15 @@ public class ProfileTabsTest {
         mTestUserManagerState.userIdToLabelMap.remove(mPrivateUser);
         mProfileTabs.updateView();
 
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
     }
 
     @Test
     public void testGetSelectedUser_twoUsers() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         mTabLayout.selectTab(mTabLayout.getTabAt(0));
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
 
         mTabLayout.selectTab(mTabLayout.getTabAt(1));
         assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mManagedUser);
@@ -292,9 +292,10 @@ public class ProfileTabsTest {
     @Test
     public void testGetSelectedUser_multiUsers() {
         if (!SdkLevel.isAtLeastV() || !isPrivateSpaceEnabled) return;
-        initializeWithUsers(true, mSystemUser, mManagedUser, mPrivateUser);
+        initializeWithUsers(true, mPrimaryUser, mManagedUser, mPrivateUser);
 
-        List<UserId> expectedProfiles = Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser);
+        List<UserId> expectedProfiles = Lists.newArrayList(mPrimaryUser, mManagedUser,
+            mPrivateUser);
 
         for (int i = 0; i < 3; ++i) {
             mTabLayout.selectTab(mTabLayout.getTabAt(i));
@@ -306,21 +307,21 @@ public class ProfileTabsTest {
 
     @Test
     public void testReselectedUser_doesNotInvokeListener() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser, mManagedUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser, mManagedUser);
 
         assertThat(mTabLayout.getSelectedTabPosition()).isAtLeast(0);
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
 
         mTabLayout.selectTab(mTabLayout.getTabAt(0));
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
         assertThat(mIsListenerInvoked).isFalse();
     }
 
     @Test
     public void testGetSelectedUser_singleUsers() {
-        initializeWithUsers(isPrivateSpaceEnabled, mSystemUser);
+        initializeWithUsers(isPrivateSpaceEnabled, mPrimaryUser);
 
-        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mSystemUser);
+        assertThat(mProfileTabs.getSelectedUser()).isEqualTo(mPrimaryUser);
     }
 
     private void initializeWithUsers(boolean isPrivateSpaceEnabled, UserId... userIds) {
@@ -328,7 +329,7 @@ public class ProfileTabsTest {
             mTestConfigStore.enablePrivateSpaceInPhotoPicker();
             mTestUserManagerState.userIds = Lists.newArrayList(userIds);
             for (UserId userId : userIds) {
-                if (userId.isSystem()) {
+                if (userId.equals(UserId.of(UserHandle.myUserId()))) {
                     mTestUserManagerState.userIdToLabelMap.put(userId, "Personal");
                 } else if (userId.getIdentifier() == 100) {
                     mTestUserManagerState.userIdToLabelMap.put(userId, "Work");
@@ -342,7 +343,7 @@ public class ProfileTabsTest {
             mTestConfigStore.disablePrivateSpaceInPhotoPicker();
             mTestUserIdManager.userIds = Lists.newArrayList(userIds);
             for (UserId userId : userIds) {
-                if (userId.isSystem()) {
+                if (userId.equals(UserId.of(UserHandle.myUserId()))) {
                     mTestUserIdManager.systemUser = userId;
                 } else {
                     mTestUserIdManager.managedUser = userId;
diff --git a/tests/unit/com/android/documentsui/UserIdManagerTest.java b/tests/unit/com/android/documentsui/UserIdManagerTest.java
index 31fe7d166..36ff8ac68 100644
--- a/tests/unit/com/android/documentsui/UserIdManagerTest.java
+++ b/tests/unit/com/android/documentsui/UserIdManagerTest.java
@@ -131,10 +131,12 @@ public class UserIdManagerTest {
     @Test
     public void testGetUserIds_deviceNotSupported() {
         // we should return the current user when device is not supported.
-        UserId currentUser = UserId.of(systemUser);
-        when(mockUserManager.getUserProfiles()).thenReturn(Arrays.asList(systemUser, managedUser1));
-        mUserIdManager = new UserIdManager.RuntimeUserIdManager(mockContext, currentUser, false);
-        assertThat(mUserIdManager.getUserIds()).containsExactly(UserId.of(systemUser));
+        UserHandle currentUser = UserHandle.of(UserHandle.myUserId());
+        when(mockUserManager.getUserProfiles()).thenReturn(
+                Arrays.asList(currentUser, managedUser1));
+        mUserIdManager = new UserIdManager.RuntimeUserIdManager(mockContext, UserId.of(currentUser),
+                false);
+        assertThat(mUserIdManager.getUserIds()).containsExactly(UserId.of(currentUser));
     }
 
     @Test
@@ -142,13 +144,14 @@ public class UserIdManagerTest {
         // This test only tests for Android R or later. This test case always passes before R.
         if (VersionUtils.isAtLeastR()) {
             // When permission is denied, only returns the current user.
-            when(mockContext.checkSelfPermission(Manifest.permission.INTERACT_ACROSS_USERS))
-                    .thenReturn(PackageManager.PERMISSION_DENIED);
-            UserId currentUser = UserId.of(systemUser);
+            when(mockContext.checkSelfPermission(
+                    Manifest.permission.INTERACT_ACROSS_USERS)).thenReturn(
+                    PackageManager.PERMISSION_DENIED);
+            UserHandle currentUser = UserHandle.of(UserHandle.myUserId());
             when(mockUserManager.getUserProfiles()).thenReturn(
-                    Arrays.asList(systemUser, managedUser1));
+                    Arrays.asList(currentUser, managedUser1));
             mUserIdManager = UserIdManager.create(mockContext);
-            assertThat(mUserIdManager.getUserIds()).containsExactly(UserId.of(systemUser));
+            assertThat(mUserIdManager.getUserIds()).containsExactly(UserId.of(currentUser));
         }
     }
 
diff --git a/tests/unit/com/android/documentsui/UserManagerStateTest.java b/tests/unit/com/android/documentsui/UserManagerStateTest.java
index 42822d8e2..04102a429 100644
--- a/tests/unit/com/android/documentsui/UserManagerStateTest.java
+++ b/tests/unit/com/android/documentsui/UserManagerStateTest.java
@@ -23,8 +23,12 @@ import static com.android.documentsui.DevicePolicyResources.Strings.WORK_TAB;
 
 import static com.google.common.truth.Truth.assertWithMessage;
 
+import static org.junit.Assume.assumeFalse;
+import static org.junit.Assume.assumeTrue;
 import static org.mockito.ArgumentMatchers.any;
 import static org.mockito.ArgumentMatchers.eq;
+import static org.mockito.Mockito.any;
+import static org.mockito.Mockito.anyInt;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.when;
 
@@ -64,22 +68,53 @@ import java.util.Map;
 @SdkSuppress(minSdkVersion = 31, codeName = "S")
 public class UserManagerStateTest {
 
+    /**
+     * Class that exposes the @hide api [targetUserId] in order to supply proper values for
+     * reflection based code that is inspecting this field.
+     *
+     * @property targetUserId
+     */
+    private static class ReflectedResolveInfo extends ResolveInfo {
+
+        public int targetUserId;
+
+        ReflectedResolveInfo(int targetUserId) {
+            this.targetUserId = targetUserId;
+        }
+
+        @Override
+        public boolean isCrossProfileIntentForwarderActivity() {
+            return true;
+        }
+    }
+
     private static final String PERSONAL = "Personal";
     private static final String WORK = "Work";
     private static final String PRIVATE = "Private";
-
-    private final UserHandle mSystemUser = UserHandle.SYSTEM;
-    private final UserHandle mManagedUser = UserHandle.of(100);
-    private final UserHandle mPrivateUser = UserHandle.of(101);
-    private final UserHandle mOtherUser = UserHandle.of(102);
-    private final UserHandle mNormalUser = UserHandle.of(103);
-
-    private final ResolveInfo mMockInfo1 = mock(ResolveInfo.class);
-    private final ResolveInfo mMockInfo2 = mock(ResolveInfo.class);
-    private final ResolveInfo mMockInfo3 = mock(ResolveInfo.class);
+    private static final String PACKAGE_NAME = "com.android.documentsui";
+
+    /**
+     * Assume that the current user is SYSTEM_USER. For HSUM targets, the primary user is set as the
+     * system user.
+     */
+    private final int mCurrentUserId = UserHandle.myUserId();
+
+    private final UserHandle mPrimaryUser = UserHandle.of(mCurrentUserId);
+    private final UserHandle mSystemUser = mPrimaryUser == null ? UserHandle.SYSTEM : mPrimaryUser;
+    private final UserHandle mManagedUser = UserHandle.of(mCurrentUserId + 10);
+    private final UserHandle mPrivateUser = UserHandle.of(mCurrentUserId + 20);
+    private final UserHandle mOtherUser = UserHandle.of(mCurrentUserId + 30);
+    private final UserHandle mNormalUser = UserHandle.of(mCurrentUserId + 40);
+
+    private final ResolveInfo mMockInfoPrimaryUser =
+            new ReflectedResolveInfo(mPrimaryUser.getIdentifier());
+    private final ResolveInfo mMockInfoManagedUser =
+            new ReflectedResolveInfo(mManagedUser.getIdentifier());
+    private final ResolveInfo mMockInfoPrivateUser =
+            new ReflectedResolveInfo(mPrivateUser.getIdentifier());
 
     private final Context mMockContext = mock(Context.class);
-    private final Intent mMockIntent = mock(Intent.class);
+    private final Intent mMockIntent = new Intent();
     private final UserManager mMockUserManager = UserManagers.create();
     private final PackageManager mMockPackageManager = mock(PackageManager.class);
     private final DevicePolicyManager mDevicePolicyManager = mock(DevicePolicyManager.class);
@@ -88,6 +123,8 @@ public class UserManagerStateTest {
     @Before
     public void setup() throws Exception {
         when(mMockContext.getApplicationContext()).thenReturn(mMockContext);
+        when(mMockContext.createContextAsUser(any(UserHandle.class), anyInt()))
+                .thenReturn(mMockContext);
 
         when(mMockUserManager.isManagedProfile(mManagedUser.getIdentifier())).thenReturn(true);
         when(mMockUserManager.isManagedProfile(mSystemUser.getIdentifier())).thenReturn(false);
@@ -95,54 +132,60 @@ public class UserManagerStateTest {
         when(mMockUserManager.isManagedProfile(mOtherUser.getIdentifier())).thenReturn(false);
 
         if (SdkLevel.isAtLeastV()) {
-            UserProperties systemUserProperties = new UserProperties.Builder()
-                    .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
-                    .setCrossProfileContentSharingStrategy(
-                            UserProperties.CROSS_PROFILE_CONTENT_SHARING_NO_DELEGATION)
-                    .build();
-            UserProperties managedUserProperties = new UserProperties.Builder()
-                    .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
-                    .setCrossProfileContentSharingStrategy(
-                            UserProperties.CROSS_PROFILE_CONTENT_SHARING_NO_DELEGATION)
-                    .setShowInQuietMode(UserProperties.SHOW_IN_QUIET_MODE_PAUSED)
-                    .build();
-            UserProperties privateUserProperties = new UserProperties.Builder()
-                    .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
-                    .setCrossProfileContentSharingStrategy(
-                            UserProperties.CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
-                    .setShowInQuietMode(UserProperties.SHOW_IN_QUIET_MODE_HIDDEN)
-                    .build();
-            UserProperties otherUserProperties = new UserProperties.Builder()
-                    .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_WITH_PARENT)
-                    .setCrossProfileContentSharingStrategy(
-                            UserProperties.CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
-                    .build();
-            UserProperties normalUserProperties = new UserProperties.Builder()
-                    .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_NO)
-                    .setCrossProfileContentSharingStrategy(
-                            UserProperties.CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
-                    .build();
+            UserProperties systemUserProperties =
+                    new UserProperties.Builder()
+                            .setShowInSharingSurfaces(
+                                    UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
+                            .setCrossProfileContentSharingStrategy(
+                                    UserProperties.CROSS_PROFILE_CONTENT_SHARING_NO_DELEGATION)
+                            .build();
+            UserProperties managedUserProperties =
+                    new UserProperties.Builder()
+                            .setShowInSharingSurfaces(
+                                    UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
+                            .setCrossProfileContentSharingStrategy(
+                                    UserProperties.CROSS_PROFILE_CONTENT_SHARING_NO_DELEGATION)
+                            .setShowInQuietMode(UserProperties.SHOW_IN_QUIET_MODE_PAUSED)
+                            .build();
+            UserProperties privateUserProperties =
+                    new UserProperties.Builder()
+                            .setShowInSharingSurfaces(
+                                    UserProperties.SHOW_IN_SHARING_SURFACES_SEPARATE)
+                            .setCrossProfileContentSharingStrategy(
+                                    UserProperties
+                                            .CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
+                            .setShowInQuietMode(UserProperties.SHOW_IN_QUIET_MODE_HIDDEN)
+                            .build();
+            UserProperties otherUserProperties =
+                    new UserProperties.Builder()
+                            .setShowInSharingSurfaces(
+                                    UserProperties.SHOW_IN_SHARING_SURFACES_WITH_PARENT)
+                            .setCrossProfileContentSharingStrategy(
+                                    UserProperties
+                                            .CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
+                            .build();
+            UserProperties normalUserProperties =
+                    new UserProperties.Builder()
+                            .setShowInSharingSurfaces(UserProperties.SHOW_IN_SHARING_SURFACES_NO)
+                            .setCrossProfileContentSharingStrategy(
+                                    UserProperties
+                                            .CROSS_PROFILE_CONTENT_SHARING_DELEGATE_FROM_PARENT)
+                            .build();
             when(mMockUserManager.getUserProperties(mSystemUser)).thenReturn(systemUserProperties);
-            when(mMockUserManager.getUserProperties(mManagedUser)).thenReturn(
-                    managedUserProperties);
-            when(mMockUserManager.getUserProperties(mPrivateUser)).thenReturn(
-                    privateUserProperties);
+            when(mMockUserManager.getUserProperties(mManagedUser))
+                    .thenReturn(managedUserProperties);
+            when(mMockUserManager.getUserProperties(mPrivateUser))
+                    .thenReturn(privateUserProperties);
             when(mMockUserManager.getUserProperties(mOtherUser)).thenReturn(otherUserProperties);
             when(mMockUserManager.getUserProperties(mNormalUser)).thenReturn(normalUserProperties);
         }
 
         when(mMockUserManager.getProfileParent(mSystemUser)).thenReturn(null);
-        when(mMockUserManager.getProfileParent(mManagedUser)).thenReturn(mSystemUser);
-        when(mMockUserManager.getProfileParent(mPrivateUser)).thenReturn(mSystemUser);
-        when(mMockUserManager.getProfileParent(mOtherUser)).thenReturn(mSystemUser);
+        when(mMockUserManager.getProfileParent(mManagedUser)).thenReturn(mPrimaryUser);
+        when(mMockUserManager.getProfileParent(mPrivateUser)).thenReturn(mPrimaryUser);
+        when(mMockUserManager.getProfileParent(mOtherUser)).thenReturn(mPrimaryUser);
         when(mMockUserManager.getProfileParent(mNormalUser)).thenReturn(null);
 
-        if (SdkLevel.isAtLeastR()) {
-            when(mMockInfo1.isCrossProfileIntentForwarderActivity()).thenReturn(true);
-            when(mMockInfo2.isCrossProfileIntentForwarderActivity()).thenReturn(false);
-            when(mMockInfo3.isCrossProfileIntentForwarderActivity()).thenReturn(false);
-        }
-
         when(mMockContext.getPackageManager()).thenReturn(mMockPackageManager);
         when(mMockContext.getSystemServiceName(UserManager.class)).thenReturn("mMockUserManager");
         when(mMockContext.getSystemService(UserManager.class)).thenReturn(mMockUserManager);
@@ -150,8 +193,25 @@ public class UserManagerStateTest {
                 .thenReturn(Context.DEVICE_POLICY_SERVICE);
         when(mMockContext.getSystemService(Context.DEVICE_POLICY_SERVICE))
                 .thenReturn(mDevicePolicyManager);
-        when(mMockContext.getResources()).thenReturn(
-                InstrumentationRegistry.getInstrumentation().getTargetContext().getResources());
+        when(mMockContext.getResources())
+                .thenReturn(
+                        InstrumentationRegistry.getInstrumentation()
+                                .getTargetContext()
+                                .getResources());
+
+        when(mMockContext.getPackageName()).thenReturn(PACKAGE_NAME);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mSystemUser))
+                .thenReturn(mMockContext);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mManagedUser))
+                .thenReturn(mMockContext);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mPrivateUser))
+                .thenReturn(mMockContext);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mOtherUser))
+                .thenReturn(mMockContext);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mNormalUser))
+                .thenReturn(mMockContext);
+        when(mMockContext.createPackageContextAsUser(PACKAGE_NAME, 0, mPrimaryUser))
+                .thenReturn(mMockContext);
     }
 
     @Test
@@ -160,48 +220,52 @@ public class UserManagerStateTest {
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser));
 
         assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds()).containsExactly(UserId.of(mSystemUser));
+                .that(mUserManagerState.getUserIds())
+                .containsExactly(UserId.of(mSystemUser));
     }
 
     @Test
     public void testGetUserIds_allProfilesCurrentUserSystem_allShowInSharingSurfacesSeparate() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser, mOtherUser,
-                        mNormalUser));
+        initializeUserManagerState(
+                currentUser,
+                Lists.newArrayList(
+                        mSystemUser, mManagedUser, mPrivateUser, mOtherUser, mNormalUser));
 
         assertWithMessage("getUserIds returns unexpected list of user ids")
                 .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser),
-                        UserId.of(mPrivateUser));
+                .containsExactly(
+                        UserId.of(mSystemUser), UserId.of(mManagedUser), UserId.of(mPrivateUser));
     }
 
     @Test
     public void testGetUserIds_allProfilesCurrentUserManaged_allShowInSharingSurfacesSeparate() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mManagedUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser, mOtherUser,
-                        mNormalUser));
+        initializeUserManagerState(
+                currentUser,
+                Lists.newArrayList(
+                        mSystemUser, mManagedUser, mPrivateUser, mOtherUser, mNormalUser));
 
         assertWithMessage("getUserIds returns unexpected list of user ids")
                 .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser),
-                        UserId.of(mPrivateUser));
+                .containsExactly(
+                        UserId.of(mSystemUser), UserId.of(mManagedUser), UserId.of(mPrivateUser));
     }
 
     @Test
     public void testGetUserIds_allProfilesCurrentUserPrivate_allShowInSharingSurfacesSeparate() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mPrivateUser);
-        initializeUserManagerState(currentUser,
+        initializeUserManagerState(
+                currentUser,
                 Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser, mOtherUser));
 
         assertWithMessage("getUserIds returns unexpected list of user ids")
                 .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser),
-                        UserId.of(mPrivateUser));
+                .containsExactly(
+                        UserId.of(mSystemUser), UserId.of(mManagedUser), UserId.of(mPrivateUser));
     }
 
     @Test
@@ -226,7 +290,7 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetUserIds_systemAndPrivateUserCurrentUserSystem_returnsBoth() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mPrivateUser));
 
@@ -237,7 +301,7 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetUserIds_systemAndPrivateUserCurrentUserPrivate_returnsBoth() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mPrivateUser);
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mPrivateUser));
 
@@ -246,118 +310,23 @@ public class UserManagerStateTest {
                 .containsExactly(UserId.of(mSystemUser), UserId.of(mPrivateUser));
     }
 
-    @Test
-    public void testGetUserIds_systemAndOtherUserCurrentUserOtherPreV_returnsCurrentUser() {
-        if (SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mOtherUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mOtherUser));
-
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(currentUser);
-    }
-
-    @Test
-    public void testGetUserIds_systemAndOtherUserCurrentUserOtherPostV_returnsSystemUser() {
-        if (!SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mOtherUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mOtherUser));
-
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser));
-    }
-
-    @Test
-    public void testGetUserIds_normalAndOtherUserCurrentUserNormal_returnsCurrentUser() {
-        // since both users do not have show in sharing surfaces separate, returns current user
-        UserId currentUser = UserId.of(mNormalUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mOtherUser, mNormalUser));
-
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mNormalUser));
-    }
-
-    @Test
-    public void testGetUserIds_systemAndManagedUserCurrentUserSystem_returnsBothInOrder() {
-        // Returns the both if there are system and managed users.
-        if (SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser)).inOrder();
-    }
-
-    @Test
-    public void testGetUserIds_systemAndManagedUserCurrentUserManaged_returnsBothInOrder() {
-        // Returns the both if there are system and managed users.
-        if (SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mManagedUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser)).inOrder();
-    }
-
-    @Test
-    public void testGetUserIds_managedAndSystemUserCurrentUserSystem_returnsBothInOrder() {
-        // Returns the both if there are system and managed users, regardless of input list order.
-        if (SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mManagedUser, mSystemUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds())
-                .containsExactly(UserId.of(mSystemUser), UserId.of(mManagedUser)).inOrder();
-    }
-
-    @Test
-    public void testGetUserIds_otherAndManagedUserCurrentUserOtherPreV_returnsCurrentUser() {
-        // When there is no system user, returns the current user.
-        // This is a case theoretically can happen but we don't expect. So we return the current
-        // user only.
-        if (SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mOtherUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mOtherUser, mManagedUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds()).containsExactly(currentUser);
-    }
-
-    @Test
-    public void testGetUserIds_otherAndManagedUserCurrentUserOtherPostV_returnsManagedUser() {
-        // Only the users with show in sharing surfaces separate are eligible to be returned
-        if (!SdkLevel.isAtLeastV()) return;
-        UserId currentUser = UserId.of(mOtherUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mOtherUser, mManagedUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds()).containsExactly(UserId.of(mManagedUser));
-    }
-
-    @Test
-    public void testGetUserIds_otherAndManagedUserCurrentUserManaged_returnsCurrentUser() {
-        // When there is no system user, returns the current user.
-        // This is a case theoretically can happen, but we don't expect. So we return the current
-        // user only.
-        UserId currentUser = UserId.of(mManagedUser);
-        initializeUserManagerState(currentUser, Lists.newArrayList(mOtherUser, mManagedUser));
-        assertWithMessage("getUserIds returns unexpected list of user ids")
-                .that(mUserManagerState.getUserIds()).containsExactly(currentUser);
-    }
-
     @Test
     public void testGetUserIds_unsupportedDeviceCurrent_returnsCurrentUser() {
-        // This test only tests for Android R or later. This test case always passes before R.
+        // This test only tests for Android R or later. This test case always passes
+        // before R.
         if (VersionUtils.isAtLeastR()) {
             // When permission is denied, only returns the current user.
             when(mMockContext.checkSelfPermission(Manifest.permission.INTERACT_ACROSS_USERS))
                     .thenReturn(PackageManager.PERMISSION_DENIED);
             UserId currentUser = UserId.of(mSystemUser);
-            when(mMockUserManager.getUserProfiles()).thenReturn(
-                    Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser, mOtherUser));
+            when(mMockUserManager.getUserProfiles())
+                    .thenReturn(
+                            Lists.newArrayList(
+                                    mSystemUser, mManagedUser, mPrivateUser, mOtherUser));
             mUserManagerState = UserManagerState.create(mMockContext);
             assertWithMessage("Unsupported device should have returned only the current user")
-                    .that(mUserManagerState.getUserIds()).containsExactly(currentUser);
+                    .that(mUserManagerState.getUserIds())
+                    .containsExactly(currentUser);
         }
     }
 
@@ -365,55 +334,23 @@ public class UserManagerStateTest {
     public void testGetUserIds_returnCachedList() {
         // Returns all three if there are system, managed and private users.
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
+        initializeUserManagerState(
+                currentUser,
                 Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser, mOtherUser));
         assertWithMessage("getUserIds does not return cached instance")
                 .that(mUserManagerState.getUserIds())
                 .isSameInstanceAs(mUserManagerState.getUserIds());
     }
 
-    @Test
-    public void testGetCanForwardToProfileIdMap_systemUserCanForwardToAll() {
-        UserId currentUser = UserId.of(mSystemUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        if (SdkLevel.isAtLeastV()) {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-            when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                    mMockResolveInfoList);
-        } else {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser));
-            when(mMockPackageManager.queryIntentActivities(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY)).thenReturn(mMockResolveInfoList);
-        }
-
-        Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
-        expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
-        expectedCanForwardToProfileIdMap.put(UserId.of(mManagedUser), true);
-        if (SdkLevel.isAtLeastV()) {
-            expectedCanForwardToProfileIdMap.put(UserId.of(mPrivateUser), true);
-        }
-
-        assertWithMessage("getCanForwardToProfileIdMap returns incorrect mappings")
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
-                .isEqualTo(expectedCanForwardToProfileIdMap);
-    }
-
     @Test
     public void testGetCanForwardToProfileIdMap_systemUserCanForwardToManaged() {
         UserId currentUser = UserId.of(mSystemUser);
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        if (SdkLevel.isAtLeastV()) {
-            when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                    mMockResolveInfoList);
-        } else {
-            when(mMockPackageManager.queryIntentActivities(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY)).thenReturn(mMockResolveInfoList);
-        }
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoManagedUser);
+
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mSystemUser)))
+                .thenReturn(mMockResolveInfoList);
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
         expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
@@ -426,7 +363,7 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetCanForwardToProfileIdMap_systemUserCanAlwaysForwardToPrivate() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mPrivateUser));
 
@@ -442,18 +379,19 @@ public class UserManagerStateTest {
     @Test
     public void testGetCanForwardToProfileIdMap_systemUserCanNotForwardToManagedUser() {
         UserId currentUser = UserId.of(mSystemUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo2, mMockInfo3);
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoPrivateUser, mMockInfoPrimaryUser);
         if (SdkLevel.isAtLeastV()) {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-            when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                    mMockResolveInfoList);
+            initializeUserManagerState(
+                    currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+            when(mMockPackageManager.queryIntentActivitiesAsUser(
+                            mMockIntent, PackageManager.MATCH_DEFAULT_ONLY, mSystemUser))
+                    .thenReturn(mMockResolveInfoList);
         } else {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser));
-            when(mMockPackageManager.queryIntentActivities(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY)).thenReturn(mMockResolveInfoList);
+            initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
+            when(mMockPackageManager.queryIntentActivitiesAsUser(
+                            mMockIntent, PackageManager.MATCH_DEFAULT_ONLY, mSystemUser))
+                    .thenReturn(mMockResolveInfoList);
         }
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
@@ -469,28 +407,44 @@ public class UserManagerStateTest {
     }
 
     @Test
-    public void testGetCanForwardToProfileIdMap_managedCanForwardToAll() {
+    public void testGetCanForwardToProfileIdMap_managedCanForwardToAllVPlus() {
+        assumeTrue(SdkLevel.isAtLeastV());
+
         UserId currentUser = UserId.of(mManagedUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        if (SdkLevel.isAtLeastV()) {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-            when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY, mManagedUser)).thenReturn(
-                    mMockResolveInfoList);
-        } else {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser));
-            when(mMockPackageManager.queryIntentActivities(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY)).thenReturn(mMockResolveInfoList);
-        }
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoPrimaryUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mManagedUser)))
+                .thenReturn(mMockResolveInfoList);
+
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+
+        Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
+        expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
+        expectedCanForwardToProfileIdMap.put(UserId.of(mManagedUser), true);
+        expectedCanForwardToProfileIdMap.put(UserId.of(mPrivateUser), true);
+
+        assertWithMessage("getCanForwardToProfileIdMap returns incorrect mappings")
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(expectedCanForwardToProfileIdMap);
+    }
+
+    @Test
+    public void testGetCanForwardToProfileIdMap_managedCanForwardToAllUMinus() {
+        assumeFalse(SdkLevel.isAtLeastV());
+
+        UserId currentUser = UserId.of(mManagedUser);
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoPrimaryUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mManagedUser)))
+                .thenReturn(mMockResolveInfoList);
+
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
         expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
         expectedCanForwardToProfileIdMap.put(UserId.of(mManagedUser), true);
-        if (SdkLevel.isAtLeastV()) {
-            expectedCanForwardToProfileIdMap.put(UserId.of(mPrivateUser), true);
-        }
 
         assertWithMessage("getCanForwardToProfileIdMap returns incorrect mappings")
                 .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
@@ -500,19 +454,19 @@ public class UserManagerStateTest {
     @Test
     public void testGetCanForwardToProfileIdMap_managedCanNotForwardToAll() {
         UserId currentUser = UserId.of(mManagedUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo2, mMockInfo3);
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoPrimaryUser);
 
         if (SdkLevel.isAtLeastV()) {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-            when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                    mMockResolveInfoList);
+            initializeUserManagerState(
+                    currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+            when(mMockPackageManager.queryIntentActivitiesAsUser(
+                            mMockIntent, PackageManager.MATCH_DEFAULT_ONLY, mSystemUser))
+                    .thenReturn(mMockResolveInfoList);
         } else {
-            initializeUserManagerState(currentUser,
-                    Lists.newArrayList(mSystemUser, mManagedUser));
-            when(mMockPackageManager.queryIntentActivities(mMockIntent,
-                    PackageManager.MATCH_DEFAULT_ONLY)).thenReturn(mMockResolveInfoList);
+            initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
+            when(mMockPackageManager.queryIntentActivities(
+                            mMockIntent, PackageManager.MATCH_DEFAULT_ONLY))
+                    .thenReturn(mMockResolveInfoList);
         }
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
@@ -529,13 +483,15 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetCanForwardToProfileIdMap_privateCanForwardToAll() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mPrivateUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(mMockResolveInfoList);
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoPrimaryUser, mMockInfoManagedUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mSystemUser)))
+                .thenReturn(mMockResolveInfoList);
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
         expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
@@ -549,13 +505,14 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetCanForwardToProfileIdMap_privateCanNotForwardToManagedUser() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mPrivateUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo2, mMockInfo3);
-        when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(mMockResolveInfoList);
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoPrivateUser, mMockInfoPrimaryUser);
+        when(mMockPackageManager.queryIntentActivities(any(Intent.class), anyInt()))
+                .thenReturn(mMockResolveInfoList);
 
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
         expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
@@ -569,10 +526,14 @@ public class UserManagerStateTest {
 
     @Test
     public void testGetCanForwardToProfileIdMap_privateCanAlwaysForwardToSystemUser() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mPrivateUser);
         initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mPrivateUser));
 
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoPrimaryUser);
+        when(mMockPackageManager.queryIntentActivities(any(Intent.class), anyInt()))
+                .thenReturn(mMockResolveInfoList);
+
         Map<UserId, Boolean> expectedCanForwardToProfileIdMap = new HashMap<>();
         expectedCanForwardToProfileIdMap.put(UserId.of(mSystemUser), true);
         expectedCanForwardToProfileIdMap.put(UserId.of(mPrivateUser), true);
@@ -584,46 +545,50 @@ public class UserManagerStateTest {
 
     @Test
     public void testOnProfileStatusChange_anyIntentActionForManagedProfile() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
 
-        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will empty
+        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will
+        // empty
         // by default if the getters of these member variables have not been called
         List<UserId> userIdsBeforeIntent = new ArrayList<>(mUserManagerState.getUserIds());
-        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent = new HashMap<>(
-                mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
+        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent =
+                new HashMap<>(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
 
         String action = "any_intent";
         mUserManagerState.onProfileActionStatusChange(action, UserId.of(mManagedUser));
 
         assertWithMessage("Unexpected changes to user id list on receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isEqualTo(userIdsBeforeIntent);
+                .that(mUserManagerState.getUserIds())
+                .isEqualTo(userIdsBeforeIntent);
         assertWithMessage(
-                "Unexpected changes to canForwardToProfileIdMap on receiving intent: " + action)
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent)).isEqualTo(
-                        canForwardToProfileIdMapBeforeIntent);
+                        "Unexpected changes to canForwardToProfileIdMap on receiving intent: "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(canForwardToProfileIdMapBeforeIntent);
     }
 
     @Test
     public void testOnProfileStatusChange_actionProfileUnavailableForPrivateProfile() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
         UserId managedUser = UserId.of(mManagedUser);
         UserId privateUser = UserId.of(mPrivateUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                mMockResolveInfoList);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-
-        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will empty
-        // by default if the getters of these member variables have not been called
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoManagedUser, mMockInfoPrivateUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        mMockIntent, PackageManager.MATCH_DEFAULT_ONLY, mSystemUser))
+                .thenReturn(mMockResolveInfoList);
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+
+        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will
+        // empty by default if the getters of these member variables have not been called
         List<UserId> userIdsBeforeIntent = new ArrayList<>(mUserManagerState.getUserIds());
-        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent = new HashMap<>(
-                mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
+        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent =
+                new HashMap<>(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
 
         List<UserId> expectedUserIdsAfterIntent = Lists.newArrayList(currentUser, managedUser);
 
@@ -631,82 +596,135 @@ public class UserManagerStateTest {
         mUserManagerState.onProfileActionStatusChange(action, privateUser);
 
         assertWithMessage(
-                "UserIds list should not be same before and after receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isNotEqualTo(userIdsBeforeIntent);
+                        "UserIds list should not be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getUserIds())
+                .isNotEqualTo(userIdsBeforeIntent);
         assertWithMessage("Unexpected changes to user id list on receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isEqualTo(expectedUserIdsAfterIntent);
-        assertWithMessage("CanForwardToLabelMap should be same before and after receiving intent: "
-                + action)
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent)).isEqualTo(
-                        canForwardToProfileIdMapBeforeIntent);
+                .that(mUserManagerState.getUserIds())
+                .isEqualTo(expectedUserIdsAfterIntent);
+        assertWithMessage(
+                        "CanForwardToLabelMap should be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(canForwardToProfileIdMapBeforeIntent);
     }
 
     @Test
     public void testOnProfileStatusChange_actionProfileAvailable_profileInitialised() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
         UserId managedUser = UserId.of(mManagedUser);
         UserId privateUser = UserId.of(mPrivateUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                mMockResolveInfoList);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoManagedUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        mMockIntent, PackageManager.MATCH_DEFAULT_ONLY, mSystemUser))
+                .thenReturn(mMockResolveInfoList);
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
 
         // initialising the userIds list and canForwardToProfileIdMap
         mUserManagerState.getUserIds();
         mUserManagerState.getCanForwardToProfileIdMap(mMockIntent);
 
         // Making the private profile unavailable after it has been initialised
-        mUserManagerState.onProfileActionStatusChange(Intent.ACTION_PROFILE_UNAVAILABLE,
-                privateUser);
+        mUserManagerState.onProfileActionStatusChange(
+                Intent.ACTION_PROFILE_UNAVAILABLE, privateUser);
 
         List<UserId> userIdsBeforeIntent = new ArrayList<>(mUserManagerState.getUserIds());
-        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent = new HashMap<>(
-                mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
+        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent =
+                new HashMap<>(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
 
-        List<UserId> expectedUserIdsAfterIntent = Lists.newArrayList(currentUser, managedUser,
-                privateUser);
+        List<UserId> expectedUserIdsAfterIntent =
+                Lists.newArrayList(currentUser, managedUser, privateUser);
 
         String action = Intent.ACTION_PROFILE_AVAILABLE;
         mUserManagerState.onProfileActionStatusChange(action, privateUser);
 
         assertWithMessage(
-                "UserIds list should not be same before and after receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isNotEqualTo(userIdsBeforeIntent);
+                        "UserIds list should not be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getUserIds())
+                .isNotEqualTo(userIdsBeforeIntent);
         assertWithMessage("Unexpected changes to user id list on receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isEqualTo(expectedUserIdsAfterIntent);
-        assertWithMessage("CanForwardToLabelMap should be same before and after receiving intent: "
-                + action)
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent)).isEqualTo(
-                        canForwardToProfileIdMapBeforeIntent);
+                .that(mUserManagerState.getUserIds())
+                .isEqualTo(expectedUserIdsAfterIntent);
+        assertWithMessage(
+                        "CanForwardToLabelMap should be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(canForwardToProfileIdMapBeforeIntent);
+    }
+
+    @Test
+    public void testOnProfileStatusChange_actionProfileAdded() {
+        assumeTrue(SdkLevel.isAtLeastV());
+        UserId currentUser = UserId.of(mSystemUser);
+        UserId managedUser = UserId.of(mManagedUser);
+        UserId privateUser = UserId.of(mPrivateUser);
+
+        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfoManagedUser);
+
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mSystemUser)))
+                .thenReturn(mMockResolveInfoList);
+
+        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
+
+        mUserManagerState.setCurrentStateIntent(new Intent());
+
+        // initialising the userIds list and canForwardToProfileIdMap
+        mUserManagerState.getUserIds();
+        mUserManagerState.getCanForwardToProfileIdMap(mMockIntent);
+
+        String action = Intent.ACTION_PROFILE_ADDED;
+        mUserManagerState.onProfileActionStatusChange(action, privateUser);
+
+        assertWithMessage(
+                        "UserIds list should not be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getUserIds())
+                .containsExactly(currentUser, managedUser, privateUser);
+        assertWithMessage(
+                        "CanForwardToLabelMap should be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(
+                        Map.ofEntries(
+                                Map.entry(currentUser, true),
+                                Map.entry(managedUser, true),
+                                Map.entry(privateUser, true)));
     }
 
     @Test
     public void testOnProfileStatusChange_actionProfileAvailable_profileNotInitialised() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
         UserId managedUser = UserId.of(mManagedUser);
         UserId privateUser = UserId.of(mPrivateUser);
-        final List<ResolveInfo> mMockResolveInfoList = Lists.newArrayList(mMockInfo1, mMockInfo2);
-        when(mMockPackageManager.queryIntentActivitiesAsUser(mMockIntent,
-                PackageManager.MATCH_DEFAULT_ONLY, mSystemUser)).thenReturn(
-                mMockResolveInfoList);
+        final List<ResolveInfo> mMockResolveInfoList =
+                Lists.newArrayList(mMockInfoManagedUser, mMockInfoPrivateUser);
+        when(mMockPackageManager.queryIntentActivitiesAsUser(
+                        any(Intent.class), anyInt(), eq(mSystemUser)))
+                .thenReturn(mMockResolveInfoList);
+
+        when(mMockUserManager.getProfileParent(UserHandle.of(privateUser.getIdentifier())))
+                .thenReturn(mPrimaryUser);
 
         // Private user will not be initialised if it is in quiet mode
         when(mMockUserManager.isQuietModeEnabled(mPrivateUser)).thenReturn(true);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
-
-        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will be empty
-        // by default if the getters of these member variables have not been called
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        mUserManagerState.setCurrentStateIntent(new Intent());
+        // UserManagerState#mUserId and UserManagerState#mCanForwardToProfileIdMap will
+        // be empty by default if the getters of these member variables have not been called
         List<UserId> userIdsBeforeIntent = new ArrayList<>(mUserManagerState.getUserIds());
-        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent = new HashMap<>(
-                mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
+        Map<UserId, Boolean> canForwardToProfileIdMapBeforeIntent =
+                new HashMap<>(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent));
 
-        List<UserId> expectedUserIdsAfterIntent = Lists.newArrayList(currentUser, managedUser,
-                privateUser);
+        List<UserId> expectedUserIdsAfterIntent =
+                Lists.newArrayList(currentUser, managedUser, privateUser);
         Map<UserId, Boolean> expectedCanForwardToProfileIdMapAfterIntent = new HashMap<>();
         expectedCanForwardToProfileIdMapAfterIntent.put(currentUser, true);
         expectedCanForwardToProfileIdMapAfterIntent.put(managedUser, true);
@@ -716,56 +734,62 @@ public class UserManagerStateTest {
         mUserManagerState.onProfileActionStatusChange(action, privateUser);
 
         assertWithMessage(
-                "UserIds list should not be same before and after receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isNotEqualTo(userIdsBeforeIntent);
+                        "UserIds list should not be same before and after receiving intent: "
+                                + action)
+                .that(mUserManagerState.getUserIds())
+                .isNotEqualTo(userIdsBeforeIntent);
         assertWithMessage("Unexpected changes to user id list on receiving intent: " + action)
-                .that(mUserManagerState.getUserIds()).isEqualTo(expectedUserIdsAfterIntent);
+                .that(mUserManagerState.getUserIds())
+                .isEqualTo(expectedUserIdsAfterIntent);
         assertWithMessage(
-                "CanForwardToLabelMap should not be same before and after receiving intent: "
-                        + action)
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent)).isNotEqualTo(
-                        canForwardToProfileIdMapBeforeIntent);
+                        "CanForwardToLabelMap should not be same before and after receiving intent:"
+                                + " "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isNotEqualTo(canForwardToProfileIdMapBeforeIntent);
         assertWithMessage(
-                "Unexpected changes to canForwardToProfileIdMap on receiving intent: " + action)
-                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent)).isEqualTo(
-                        expectedCanForwardToProfileIdMapAfterIntent);
+                        "Unexpected changes to canForwardToProfileIdMap on receiving intent: "
+                                + action)
+                .that(mUserManagerState.getCanForwardToProfileIdMap(mMockIntent))
+                .isEqualTo(expectedCanForwardToProfileIdMapAfterIntent);
     }
 
     @Test
     public void testGetUserIdToLabelMap_systemUserAndManagedUser_PreV() {
-        if (SdkLevel.isAtLeastV()) return;
+        assumeFalse(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser));
+        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
         if (SdkLevel.isAtLeastT()) {
-            DevicePolicyResourcesManager devicePolicyResourcesManager = mock(
-                    DevicePolicyResourcesManager.class);
+            DevicePolicyResourcesManager devicePolicyResourcesManager =
+                    mock(DevicePolicyResourcesManager.class);
             when(mDevicePolicyManager.getResources()).thenReturn(devicePolicyResourcesManager);
-            when(devicePolicyResourcesManager.getString(eq(PERSONAL_TAB), any())).thenReturn(
-                    PERSONAL);
+            when(devicePolicyResourcesManager.getString(eq(PERSONAL_TAB), any()))
+                    .thenReturn(PERSONAL);
             when(devicePolicyResourcesManager.getString(eq(WORK_TAB), any())).thenReturn(WORK);
         }
 
         Map<UserId, String> userIdToLabelMap = mUserManagerState.getUserIdToLabelMap();
 
         assertWithMessage("Incorrect label returned for user id " + mSystemUser)
-                .that(userIdToLabelMap.get(UserId.of(mSystemUser))).isEqualTo(PERSONAL);
+                .that(userIdToLabelMap.get(UserId.of(mSystemUser)))
+                .isEqualTo(PERSONAL);
         assertWithMessage("Incorrect label returned for user id " + mManagedUser)
-                .that(userIdToLabelMap.get(UserId.of(mManagedUser))).isEqualTo(WORK);
+                .that(userIdToLabelMap.get(UserId.of(mManagedUser)))
+                .isEqualTo(WORK);
     }
 
     @Test
     public void testGetUserIdToLabelMap_systemUserManagedUserPrivateUser_PostV() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
         if (SdkLevel.isAtLeastT()) {
-            DevicePolicyResourcesManager devicePolicyResourcesManager = mock(
-                    DevicePolicyResourcesManager.class);
+            DevicePolicyResourcesManager devicePolicyResourcesManager =
+                    mock(DevicePolicyResourcesManager.class);
             when(mDevicePolicyManager.getResources()).thenReturn(devicePolicyResourcesManager);
-            when(devicePolicyResourcesManager.getString(eq(PERSONAL_TAB), any())).thenReturn(
-                    PERSONAL);
+            when(devicePolicyResourcesManager.getString(eq(PERSONAL_TAB), any()))
+                    .thenReturn(PERSONAL);
         }
         UserManager managedUserManager = getUserManagerForManagedUser();
         UserManager privateUserManager = getUserManagerForPrivateUser();
@@ -775,45 +799,50 @@ public class UserManagerStateTest {
         Map<UserId, String> userIdToLabelMap = mUserManagerState.getUserIdToLabelMap();
 
         assertWithMessage("Incorrect label returned for user id " + mSystemUser)
-                .that(userIdToLabelMap.get(UserId.of(mSystemUser))).isEqualTo(PERSONAL);
+                .that(userIdToLabelMap.get(UserId.of(mSystemUser)))
+                .isEqualTo(PERSONAL);
         assertWithMessage("Incorrect label returned for user id " + mManagedUser)
-                .that(userIdToLabelMap.get(UserId.of(mManagedUser))).isEqualTo(WORK);
+                .that(userIdToLabelMap.get(UserId.of(mManagedUser)))
+                .isEqualTo(WORK);
         assertWithMessage("Incorrect label returned for user id " + mPrivateUser)
-                .that(userIdToLabelMap.get(UserId.of(mPrivateUser))).isEqualTo(PRIVATE);
+                .that(userIdToLabelMap.get(UserId.of(mPrivateUser)))
+                .isEqualTo(PRIVATE);
     }
 
     @Test
     public void testGetUserIdToBadgeMap_systemUserManagedUser_PreV() {
-        if (SdkLevel.isAtLeastV()) return;
+        assumeFalse(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser));
+        initializeUserManagerState(currentUser, Lists.newArrayList(mSystemUser, mManagedUser));
         Drawable workBadge = mock(Drawable.class);
         Resources resources = mock(Resources.class);
         when(mMockContext.getResources()).thenReturn(resources);
         when(mMockContext.getDrawable(R.drawable.ic_briefcase)).thenReturn(workBadge);
         if (SdkLevel.isAtLeastT()) {
-            DevicePolicyResourcesManager devicePolicyResourcesManager = mock(
-                    DevicePolicyResourcesManager.class);
+            DevicePolicyResourcesManager devicePolicyResourcesManager =
+                    mock(DevicePolicyResourcesManager.class);
             when(mDevicePolicyManager.getResources()).thenReturn(devicePolicyResourcesManager);
-            when(devicePolicyResourcesManager.getDrawable(eq(WORK_PROFILE_ICON), eq(SOLID_COLORED),
-                    any())).thenReturn(workBadge);
+            when(devicePolicyResourcesManager.getDrawable(
+                            eq(WORK_PROFILE_ICON), eq(SOLID_COLORED), any()))
+                    .thenReturn(workBadge);
         }
 
         Map<UserId, Drawable> userIdToBadgeMap = mUserManagerState.getUserIdToBadgeMap();
 
         assertWithMessage("There should be no badge present for personal user")
-                .that(userIdToBadgeMap.containsKey(UserId.of(mSystemUser))).isFalse();
+                .that(userIdToBadgeMap.containsKey(UserId.of(mSystemUser)))
+                .isFalse();
         assertWithMessage("Incorrect badge returned for user id " + mManagedUser)
-                .that(userIdToBadgeMap.get(UserId.of(mManagedUser))).isEqualTo(workBadge);
+                .that(userIdToBadgeMap.get(UserId.of(mManagedUser)))
+                .isEqualTo(workBadge);
     }
 
     @Test
     public void testGetUserIdToBadgeMap_systemUserManagedUserPrivateUser_PostV() {
-        if (!SdkLevel.isAtLeastV()) return;
+        assumeTrue(SdkLevel.isAtLeastV());
         UserId currentUser = UserId.of(mSystemUser);
-        initializeUserManagerState(currentUser,
-                Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
+        initializeUserManagerState(
+                currentUser, Lists.newArrayList(mSystemUser, mManagedUser, mPrivateUser));
         Drawable workBadge = mock(Drawable.class);
         Drawable privateBadge = mock(Drawable.class);
         UserManager managedUserManager = getUserManagerForManagedUser();
@@ -824,19 +853,23 @@ public class UserManagerStateTest {
         Map<UserId, Drawable> userIdToBadgeMap = mUserManagerState.getUserIdToBadgeMap();
 
         assertWithMessage("There should be no badge present for personal user")
-                .that(userIdToBadgeMap.get(UserId.of(mSystemUser))).isNull();
+                .that(userIdToBadgeMap.get(UserId.of(mSystemUser)))
+                .isNull();
         assertWithMessage("Incorrect badge returned for user id " + mManagedUser)
-                .that(userIdToBadgeMap.get(UserId.of(mManagedUser))).isEqualTo(workBadge);
+                .that(userIdToBadgeMap.get(UserId.of(mManagedUser)))
+                .isEqualTo(workBadge);
         assertWithMessage("Incorrect badge returned for user id " + mPrivateUser)
-                .that(userIdToBadgeMap.get(UserId.of(mPrivateUser))).isEqualTo(privateBadge);
+                .that(userIdToBadgeMap.get(UserId.of(mPrivateUser)))
+                .isEqualTo(privateBadge);
     }
 
     private void initializeUserManagerState(UserId current, List<UserHandle> usersOnDevice) {
         when(mMockUserManager.getUserProfiles()).thenReturn(usersOnDevice);
         TestConfigStore testConfigStore = new TestConfigStore();
         testConfigStore.enablePrivateSpaceInPhotoPicker();
-        mUserManagerState = new UserManagerState.RuntimeUserManagerState(mMockContext, current,
-                true, testConfigStore);
+        mUserManagerState =
+                new UserManagerState.RuntimeUserManagerState(
+                        mMockContext, current, true, testConfigStore);
     }
 
     private UserManager getUserManagerForManagedUser() {
diff --git a/tests/unit/com/android/documentsui/dirlist/MessageTest.java b/tests/unit/com/android/documentsui/dirlist/MessageTest.java
index f7f8fe0e6..17ca61eeb 100644
--- a/tests/unit/com/android/documentsui/dirlist/MessageTest.java
+++ b/tests/unit/com/android/documentsui/dirlist/MessageTest.java
@@ -24,6 +24,7 @@ import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE
 import static com.android.documentsui.DevicePolicyResources.Strings.WORK_PROFILE_OFF_ERROR_TITLE;
 
 import static com.google.common.truth.Truth.assertThat;
+import static com.google.common.truth.TruthJUnit.assume;
 
 import static org.mockito.ArgumentMatchers.any;
 import static org.mockito.ArgumentMatchers.eq;
@@ -139,6 +140,7 @@ public final class MessageTest {
     @Test
     public void testInflateMessage_updateToCrossProfileNoPermission() {
         // Make sure this test is running on system user.
+        assume().that(UserId.CURRENT_USER.isSystem()).isTrue();
         Preconditions.checkArgument(UserId.CURRENT_USER.isSystem());
         Model.Update error = new Model.Update(
                 new CrossProfileNoPermissionException(),
diff --git a/tests/unit/com/android/documentsui/files/ActionHandlerTest.java b/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
index 68bb18867..5b19fcdc2 100644
--- a/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
+++ b/tests/unit/com/android/documentsui/files/ActionHandlerTest.java
@@ -16,6 +16,7 @@
 
 package com.android.documentsui.files;
 
+import static com.android.documentsui.util.FlagUtils.isUseMaterial3FlagEnabled;
 import static com.android.documentsui.testing.IntentAsserts.assertHasAction;
 import static com.android.documentsui.testing.IntentAsserts.assertHasData;
 import static com.android.documentsui.testing.IntentAsserts.assertHasExtra;
@@ -31,6 +32,8 @@ import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertSame;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeTrue;
+import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.verify;
 
 import android.app.Activity;
 import android.app.DownloadManager;
@@ -39,6 +42,10 @@ import android.content.ClipData;
 import android.content.Intent;
 import android.net.Uri;
 import android.os.Parcelable;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 import android.provider.DocumentsContract.Path;
 import android.util.Pair;
@@ -59,6 +66,7 @@ import com.android.documentsui.base.DocumentInfo;
 import com.android.documentsui.base.DocumentStack;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.Shared;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.inspector.InspectorActivity;
 import com.android.documentsui.testing.ClipDatas;
 import com.android.documentsui.testing.DocumentStackAsserts;
@@ -68,6 +76,7 @@ import com.android.documentsui.testing.TestDocumentClipper;
 import com.android.documentsui.testing.TestDragAndDropManager;
 import com.android.documentsui.testing.TestEnv;
 import com.android.documentsui.testing.TestFeatures;
+import com.android.documentsui.testing.TestPeekViewManager;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.testing.UserManagers;
 import com.android.documentsui.ui.TestDialogController;
@@ -78,11 +87,14 @@ import com.google.common.collect.Lists;
 
 import org.junit.Before;
 import org.junit.Ignore;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.Parameterized;
 import org.junit.runners.Parameterized.Parameter;
 import org.junit.runners.Parameterized.Parameters;
+import org.mockito.Mock;
+import org.mockito.MockitoAnnotations;
 
 import java.util.ArrayList;
 import java.util.Arrays;
@@ -99,9 +111,14 @@ public class ActionHandlerTest {
     private ActionHandler<TestActivity> mHandler;
     private TestDocumentClipper mClipper;
     private TestDragAndDropManager mDragAndDropManager;
+    private TestPeekViewManager mPeekViewManager;
     private TestFeatures mFeatures;
     private TestConfigStore mTestConfigStore;
     private boolean refreshAnswer = false;
+    @Mock private Runnable mMockCloseSelectionBar;
+
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
 
     @Parameter(0)
     public boolean isPrivateSpaceEnabled;
@@ -117,6 +134,7 @@ public class ActionHandlerTest {
 
     @Before
     public void setUp() {
+        MockitoAnnotations.initMocks(this);
         mFeatures = new TestFeatures();
         mEnv = TestEnv.create(mFeatures);
         mActivity = TestActivity.create(mEnv);
@@ -125,6 +143,7 @@ public class ActionHandlerTest {
         mDialogs = new TestDialogController();
         mClipper = new TestDocumentClipper();
         mDragAndDropManager = new TestDragAndDropManager();
+        mPeekViewManager = new TestPeekViewManager(mActivity);
         mTestConfigStore = new TestConfigStore();
         mEnv.state.configStore = mTestConfigStore;
 
@@ -143,6 +162,14 @@ public class ActionHandlerTest {
         mEnv.selectDocument(TestEnv.FILE_GIF);
     }
 
+    private void assertSelectionContainerClosed() {
+        if (isUseMaterial3FlagEnabled()) {
+            verify(mMockCloseSelectionBar, times(1)).run();
+        } else {
+            assertTrue(mActionModeAddons.finishActionModeCalled);
+        }
+    }
+
     @Test
     public void testOpenSelectedInNewWindow() {
         mHandler.openSelectedInNewWindow();
@@ -156,10 +183,37 @@ public class ActionHandlerTest {
         assertEquals(expected.toString(), actual.toString());
     }
 
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testOpenFileFlags() {
+        mHandler.onDocumentOpened(TestEnv.FILE_GIF,
+                com.android.documentsui.files.ActionHandler.VIEW_TYPE_PREVIEW,
+                com.android.documentsui.files.ActionHandler.VIEW_TYPE_REGULAR, false);
+
+        int expectedFlags = Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_ACTIVITY_SINGLE_TOP
+                | Intent.FLAG_GRANT_WRITE_URI_PERMISSION;
+        Intent actual = mActivity.startActivity.getLastValue();
+        assertEquals(expectedFlags, actual.getFlags());
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testOpenFileFlagsDesktop() {
+        mHandler.onDocumentOpened(TestEnv.FILE_GIF,
+                com.android.documentsui.files.ActionHandler.VIEW_TYPE_PREVIEW,
+                com.android.documentsui.files.ActionHandler.VIEW_TYPE_REGULAR, false);
+
+        int expectedFlags = Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_ACTIVITY_SINGLE_TOP
+                | Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_ACTIVITY_NEW_DOCUMENT
+                | Intent.FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NEW_TASK;
+        Intent actual = mActivity.startActivity.getLastValue();
+        assertEquals(expectedFlags, actual.getFlags());
+    }
+
     @Test
     public void testSpringOpenDirectory() {
         mHandler.springOpenDirectory(TestEnv.FOLDER_0);
-        assertTrue(mActionModeAddons.finishActionModeCalled);
+        assertSelectionContainerClosed();
         assertEquals(TestEnv.FOLDER_0, mEnv.state.stack.peek());
     }
 
@@ -214,7 +268,7 @@ public class ActionHandlerTest {
         mHandler.deleteSelectedDocuments(docs, mEnv.state.stack.peek());
 
         mActivity.startService.assertCalled();
-        assertTrue(mActionModeAddons.finishActionModeCalled);
+        assertSelectionContainerClosed();
     }
 
     @Test
@@ -424,7 +478,26 @@ public class ActionHandlerTest {
         assertEquals(false, result);
     }
 
+    // Require desktop file handling flag because when it's disabled proguard strips the
+    // openDocumentViewOnly function because it's not used anywhere reachable by production code.
     @Test
+    @RequiresFlagsEnabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testDocumentContextMenuOpen() throws Exception {
+        mActivity.resources.setQuickViewerPackage("corptropolis.viewer");
+        mActivity.currentRoot = TestProvidersAccess.HOME;
+
+        // Test normal picking (i.e. double click) behaviour will quick view
+        mHandler.openDocument(TestEnv.FILE_GIF, ActionHandler.VIEW_TYPE_PREVIEW,
+                ActionHandler.VIEW_TYPE_REGULAR);
+        mActivity.assertActivityStarted(Intent.ACTION_QUICK_VIEW);
+
+        // And verify open via context menu will view instead
+        mHandler.openDocumentViewOnly(TestEnv.FILE_GIF);
+        mActivity.assertActivityStarted(Intent.ACTION_VIEW);
+    }
+
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
     public void testShowChooser() throws Exception {
         mActivity.currentRoot = TestProvidersAccess.DOWNLOADS;
 
@@ -432,6 +505,18 @@ public class ActionHandlerTest {
         mActivity.assertActivityStarted(Intent.ACTION_CHOOSER);
     }
 
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testShowChooserDesktop() throws Exception {
+        mActivity.currentRoot = TestProvidersAccess.DOWNLOADS;
+
+        mHandler.showChooserForDoc(TestEnv.FILE_PDF);
+        Intent actual = mActivity.startActivity.getLastValue();
+        assertEquals(Intent.ACTION_VIEW, actual.getAction());
+        assertEquals("ComponentInfo{android/com.android.internal.app.ResolverActivity}",
+                actual.getComponent().toString());
+    }
+
     @Test
     public void testInitLocation_LaunchToStackLocation() {
         DocumentStack path = new DocumentStack(Roots.create("123"), mEnv.model.getDocument("1"));
@@ -546,8 +631,8 @@ public class ActionHandlerTest {
     public void testDragAndDrop_OnReadOnlyRoot() throws Exception {
         assumeTrue(VersionUtils.isAtLeastS());
         RootInfo root = new RootInfo(); // root by default has no SUPPORT_CREATE flag
-        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, null, null, null,
-                null, null, true);
+        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, 0, null, null,
+                null, null, null, true);
         assertFalse(mHandler.dropOn(event, root));
     }
 
@@ -558,8 +643,8 @@ public class ActionHandlerTest {
     @Test
     public void testDragAndDrop_OnLibraryRoot() throws Exception {
         assumeTrue(VersionUtils.isAtLeastS());
-        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, null, null, null,
-                null, null, true);
+        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, 0, null, null,
+                null, null, null, true);
         assertFalse(mHandler.dropOn(event, TestProvidersAccess.RECENTS));
     }
 
@@ -575,8 +660,8 @@ public class ActionHandlerTest {
         // our Clipper is getting the original CipData passed in.
         Object localState = new Object();
         ClipData clipData = ClipDatas.createTestClipData();
-        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, localState, null,
-                clipData, null, null, true);
+        DragEvent event = DragEvent.obtain(DragEvent.ACTION_DROP, 1, 1, 0, 0, 0, 0, localState,
+                null, clipData, null, null, true);
 
         mHandler.dropOn(event, TestProvidersAccess.DOWNLOADS);
         event.recycle();
@@ -657,9 +742,21 @@ public class ActionHandlerTest {
     }
 
     @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3, Flags.FLAG_USE_PEEK_PREVIEW_RO})
+    public void testShowPeek() throws Exception {
+        mHandler.showPreview(TestEnv.FILE_GIF);
+        // The inspector activity is not called.
+        mActivity.startActivity.assertNotCalled();
+        mPeekViewManager.getPeekDocument().assertCalled();
+        mPeekViewManager.getPeekDocument().assertLastArgument(TestEnv.FILE_GIF);
+    }
+
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_PEEK_PREVIEW_RO})
     public void testShowInspector() throws Exception {
-        mHandler.showInspector(TestEnv.FILE_GIF);
+        mHandler.showPreview(TestEnv.FILE_GIF);
 
+        mPeekViewManager.getPeekDocument().assertNotCalled();
         mActivity.startActivity.assertCalled();
         Intent intent = mActivity.startActivity.getLastValue();
         assertTargetsComponent(intent, InspectorActivity.class);
@@ -670,10 +767,11 @@ public class ActionHandlerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_PEEK_PREVIEW_RO})
     public void testShowInspector_DebugDisabled() throws Exception {
         mFeatures.debugSupport = false;
 
-        mHandler.showInspector(TestEnv.FILE_GIF);
+        mHandler.showPreview(TestEnv.FILE_GIF);
         Intent intent = mActivity.startActivity.getLastValue();
 
         assertHasExtra(intent, Shared.EXTRA_SHOW_DEBUG);
@@ -681,11 +779,12 @@ public class ActionHandlerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_PEEK_PREVIEW_RO})
     public void testShowInspector_DebugEnabled() throws Exception {
         mFeatures.debugSupport = true;
         DebugFlags.setDocumentDetailsEnabled(true);
 
-        mHandler.showInspector(TestEnv.FILE_GIF);
+        mHandler.showPreview(TestEnv.FILE_GIF);
         Intent intent = mActivity.startActivity.getLastValue();
 
         assertHasExtra(intent, Shared.EXTRA_SHOW_DEBUG);
@@ -694,6 +793,7 @@ public class ActionHandlerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_PEEK_PREVIEW_RO})
     public void testShowInspector_OverridesRootDocumentName() throws Exception {
         mActivity.currentRoot = TestProvidersAccess.PICKLES;
         mEnv.populateStack();
@@ -705,7 +805,7 @@ public class ActionHandlerTest {
         DocumentInfo rootDoc = mEnv.state.stack.peek();
         rootDoc.displayName = "poodles";
 
-        mHandler.showInspector(rootDoc);
+        mHandler.showPreview(rootDoc);
         Intent intent = mActivity.startActivity.getLastValue();
         assertEquals(
                 TestProvidersAccess.PICKLES.title,
@@ -713,6 +813,7 @@ public class ActionHandlerTest {
     }
 
     @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_PEEK_PREVIEW_RO})
     public void testShowInspector_OverridesRootDocumentNameX() throws Exception {
         mActivity.currentRoot = TestProvidersAccess.PICKLES;
         mEnv.populateStack();
@@ -725,11 +826,28 @@ public class ActionHandlerTest {
         DocumentInfo rootDoc = mEnv.state.stack.peek();
         rootDoc.displayName = "poodles";
 
-        mHandler.showInspector(rootDoc);
+        mHandler.showPreview(rootDoc);
         Intent intent = mActivity.startActivity.getLastValue();
         assertFalse(intent.getExtras().containsKey(Intent.EXTRA_TITLE));
     }
 
+    @Test
+    public void testViewInOwner() {
+        mEnv.populateStack();
+
+        mEnv.selectionMgr.clearSelection();
+        mEnv.selectDocument(TestEnv.FILE_PNG);
+
+        mHandler.viewInOwner();
+        mActivity.assertActivityStarted(DocumentsContract.ACTION_DOCUMENT_SETTINGS);
+    }
+
+    @Test
+    public void testOpenSettings() {
+        mHandler.openSettings(TestProvidersAccess.HAMMY);
+        mActivity.assertActivityStarted(DocumentsContract.ACTION_DOCUMENT_ROOT_SETTINGS);
+    }
+
     private void assertRootPicked(Uri expectedUri) throws Exception {
         mEnv.beforeAsserts();
 
@@ -748,10 +866,11 @@ public class ActionHandlerTest {
                 mEnv.searchViewManager,
                 mEnv::lookupExecutor,
                 mActionModeAddons,
+                mMockCloseSelectionBar,
                 mClipper,
-                null,  // clip storage, not utilized unless we venture into *jumbo* clip territory.
+                null, // clip storage, not utilized unless we venture into *jumbo* clip territory.
                 mDragAndDropManager,
-                mEnv.injector
-        );
+                mPeekViewManager,
+                mEnv.injector);
     }
 }
diff --git a/tests/unit/com/android/documentsui/files/MenuManagerTest.java b/tests/unit/com/android/documentsui/files/MenuManagerTest.java
index 02988d62f..8bc5ad707 100644
--- a/tests/unit/com/android/documentsui/files/MenuManagerTest.java
+++ b/tests/unit/com/android/documentsui/files/MenuManagerTest.java
@@ -16,11 +16,18 @@
 
 package com.android.documentsui.files;
 
+import static com.android.documentsui.util.FlagUtils.isZipNgFlagEnabled;
+
 import static junit.framework.Assert.assertEquals;
 
 import static org.junit.Assert.assertTrue;
 
+import android.annotation.SuppressLint;
 import android.net.Uri;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract.Document;
 import android.provider.DocumentsContract.Root;
 
@@ -35,6 +42,7 @@ import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.State;
 import com.android.documentsui.base.UserId;
 import com.android.documentsui.dirlist.TestData;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.testing.TestDirectoryDetails;
 import com.android.documentsui.testing.TestEnv;
 import com.android.documentsui.testing.TestFeatures;
@@ -45,6 +53,7 @@ import com.android.documentsui.testing.TestSearchViewManager;
 import com.android.documentsui.testing.TestSelectionDetails;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -71,6 +80,8 @@ public final class MenuManagerTest {
     private TestMenuItem dirPasteIntoFolder;
     private TestMenuItem dirInspect;
     private TestMenuItem dirOpenInNewWindow;
+    private TestMenuItem mDirExtractHere;
+    private TestMenuItem mDirBrowse;
 
     /* Root List Context Menu items */
     private TestMenuItem rootEjectRoot;
@@ -105,6 +116,7 @@ public final class MenuManagerTest {
     private TestMenuItem optionSort;
     private TestMenuItem mOptionLauncher;
     private TestMenuItem mOptionShowHiddenFiles;
+    private TestMenuItem mOptionExtractAll;
 
     /* Sub Option Menu items */
     private TestMenuItem subOptionGrid;
@@ -123,6 +135,9 @@ public final class MenuManagerTest {
 
     private int mFilesCount;
 
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
     @Before
     public void setUp() {
         testMenu = TestMenu.create();
@@ -144,6 +159,8 @@ public final class MenuManagerTest {
         dirPasteIntoFolder = testMenu.findItem(R.id.dir_menu_paste_into_folder);
         dirInspect = testMenu.findItem(R.id.dir_menu_inspect);
         dirOpenInNewWindow = testMenu.findItem(R.id.dir_menu_open_in_new_window);
+        mDirExtractHere = testMenu.findItem(R.id.dir_menu_extract_here);
+        mDirBrowse = testMenu.findItem(R.id.dir_menu_browse);
 
         rootEjectRoot = testMenu.findItem(R.id.root_menu_eject_root);
         rootOpenInNewWindow = testMenu.findItem(R.id.root_menu_open_in_new_window);
@@ -176,6 +193,7 @@ public final class MenuManagerTest {
         optionSort = testMenu.findItem(R.id.option_menu_sort);
         mOptionLauncher = testMenu.findItem(R.id.option_menu_launcher);
         mOptionShowHiddenFiles = testMenu.findItem(R.id.option_menu_show_hidden_files);
+        mOptionExtractAll = testMenu.findItem(R.id.option_menu_extract_all);
 
         // Menu actions on root title row.
         subOptionGrid = testMenu.findItem(R.id.sub_menu_grid);
@@ -244,6 +262,7 @@ public final class MenuManagerTest {
         actionModeSort.assertEnabledAndVisible();
         actionModeSelectAll.assertEnabledAndVisible();
         mActionModeDeselectAll.assertDisabledAndInvisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
     }
 
     @Test
@@ -259,6 +278,7 @@ public final class MenuManagerTest {
         actionModeExtractTo.assertDisabledAndInvisible();
         actionModeMoveTo.assertDisabledAndInvisible();
         actionModeViewInOwner.assertDisabledAndInvisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
     }
 
     @Test
@@ -388,7 +408,7 @@ public final class MenuManagerTest {
 
     @Test
     public void testActionMenu_CanOpenWith() {
-        selectionDetails.canOpenWith = true;
+        selectionDetails.canOpen = true;
         mgr.updateActionMenu(testMenu, selectionDetails);
 
         actionModeOpenWith.assertEnabledAndVisible();
@@ -396,7 +416,7 @@ public final class MenuManagerTest {
 
     @Test
     public void testActionMenu_NoOpenWith() {
-        selectionDetails.canOpenWith = false;
+        selectionDetails.canOpen = false;
         mgr.updateActionMenu(testMenu, selectionDetails);
 
         actionModeOpenWith.assertDisabledAndInvisible();
@@ -475,6 +495,20 @@ public final class MenuManagerTest {
         optionInspector.assertDisabledAndInvisible();
     }
 
+    @Test
+    public void testOptionMenu_ExtractAll() {
+        dirDetails.isInArchive = true;
+        mgr.updateOptionMenu(testMenu);
+        if (isZipNgFlagEnabled()) {
+            mOptionExtractAll.assertEnabledAndVisible();
+        } else {
+            mOptionExtractAll.assertDisabledAndInvisible();
+        }
+        dirDetails.isInArchive = false;
+        mgr.updateOptionMenu(testMenu);
+        mOptionExtractAll.assertDisabledAndInvisible();
+    }
+
     @Test
     public void testInflateContextMenu_Files() {
         TestMenuInflater inflater = new TestMenuInflater();
@@ -508,6 +542,7 @@ public final class MenuManagerTest {
         assertEquals(R.menu.mixed_context_menu, inflater.lastInflatedMenuId);
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea() {
         mgr.updateContextMenuForContainer(testMenu, selectionDetails);
@@ -516,8 +551,11 @@ public final class MenuManagerTest {
         mDirDeselectAll.assertDisabledAndInvisible();
         dirPasteFromClipboard.assertDisabledAndInvisible();
         dirCreateDir.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CanDeselectAll() {
         selectionDetails.size = 1;
@@ -529,6 +567,7 @@ public final class MenuManagerTest {
         mDirDeselectAll.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_NoItemToPaste() {
         dirDetails.hasItemsToPaste = false;
@@ -541,6 +580,7 @@ public final class MenuManagerTest {
         dirCreateDir.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CantCreateDoc() {
         dirDetails.hasItemsToPaste = true;
@@ -553,6 +593,7 @@ public final class MenuManagerTest {
         dirCreateDir.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CanPaste() {
         dirDetails.hasItemsToPaste = true;
@@ -565,6 +606,7 @@ public final class MenuManagerTest {
         dirCreateDir.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CanCreateDirectory() {
         dirDetails.canCreateDirectory = true;
@@ -576,6 +618,7 @@ public final class MenuManagerTest {
         dirCreateDir.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnFile() {
         selectionDetails.size = 1;
@@ -587,22 +630,40 @@ public final class MenuManagerTest {
         dirRename.assertDisabledAndInvisible();
         dirCreateDir.assertEnabledAndVisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
+    }
+
+    @SuppressLint("VisibleForTests")
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testContextMenu_OnFile_CanOpen() {
+        selectionDetails.canOpen = true;
+        mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        dirOpen.assertDisabledAndInvisible();
+        dirOpenWith.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
-    public void testContextMenu_OnFile_CanOpenWith() {
-        selectionDetails.canOpenWith = true;
+    @RequiresFlagsEnabled({Flags.FLAG_DESKTOP_FILE_HANDLING_RO})
+    public void testContextMenu_OnFile_CanOpenDesktop() {
+        selectionDetails.canOpen = true;
         mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        dirOpen.assertEnabledAndVisible();
         dirOpenWith.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
-    public void testContextMenu_OnFile_NoOpenWith() {
-        selectionDetails.canOpenWith = false;
+    public void testContextMenu_OnFile_NoOpen() {
+        selectionDetails.canOpen = false;
         mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        dirOpen.assertDisabledAndInvisible();
         dirOpenWith.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMultipleFiles() {
         selectionDetails.size = 3;
@@ -611,6 +672,7 @@ public final class MenuManagerTest {
         mDirCompress.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnWritableDirectory() {
         selectionDetails.size = 1;
@@ -624,8 +686,11 @@ public final class MenuManagerTest {
         dirPasteIntoFolder.assertEnabledAndVisible();
         dirRename.assertDisabledAndInvisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnNonWritableDirectory() {
         selectionDetails.size = 1;
@@ -638,8 +703,11 @@ public final class MenuManagerTest {
         dirPasteIntoFolder.assertDisabledAndInvisible();
         dirRename.assertDisabledAndInvisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_CanInspectContainer() {
         features.inspector = true;
@@ -648,6 +716,7 @@ public final class MenuManagerTest {
         dirInspect.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnWritableDirectory_NothingToPaste() {
         selectionDetails.canPasteInto = true;
@@ -657,6 +726,7 @@ public final class MenuManagerTest {
         dirPasteIntoFolder.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMultipleDirectories() {
         selectionDetails.size = 3;
@@ -665,6 +735,7 @@ public final class MenuManagerTest {
         mDirCompress.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs() {
         selectionDetails.containDirectories = true;
@@ -676,8 +747,11 @@ public final class MenuManagerTest {
         dirCopyToClipboard.assertEnabledAndVisible();
         mDirCompress.assertDisabledAndInvisible();
         dirDelete.assertEnabledAndVisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs_hasPartialFile() {
         selectionDetails.containDirectories = true;
@@ -692,6 +766,7 @@ public final class MenuManagerTest {
         dirDelete.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs_hasUndeletableFile() {
         selectionDetails.containDirectories = true;
@@ -705,6 +780,7 @@ public final class MenuManagerTest {
         dirDelete.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_CanInspectSingleSelection() {
         selectionDetails.size = 1;
@@ -712,6 +788,22 @@ public final class MenuManagerTest {
         dirInspect.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
+    @Test
+    public void testContextMenu_OnArchive() {
+        selectionDetails.size = 1;
+        selectionDetails.containFiles = true;
+        selectionDetails.isArchive = true;
+        mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        if (isZipNgFlagEnabled()) {
+            mDirExtractHere.assertEnabledAndVisible();
+            mDirBrowse.assertEnabledAndVisible();
+        } else {
+            mDirExtractHere.assertDisabledAndInvisible();
+            mDirBrowse.assertDisabledAndInvisible();
+        }
+    }
+
     @Test
     public void testRootContextMenu() {
         testRootInfo.flags = Root.FLAG_SUPPORTS_CREATE;
diff --git a/tests/unit/com/android/documentsui/files/QuickViewIntentBuilderTest.java b/tests/unit/com/android/documentsui/files/QuickViewIntentBuilderTest.java
index 14c86e69f..5adaa4d65 100644
--- a/tests/unit/com/android/documentsui/files/QuickViewIntentBuilderTest.java
+++ b/tests/unit/com/android/documentsui/files/QuickViewIntentBuilderTest.java
@@ -142,7 +142,7 @@ public class QuickViewIntentBuilderTest {
     public void testBuild_twoProfiles_containsOnlyPreviewDocument() {
         mEnv.model.reset();
         mEnv.model.createDocumentForUser("a.txt", "text/plain", 0,
-                TestProvidersAccess.OtherUser.USER_ID);
+                System.currentTimeMillis(), TestProvidersAccess.OtherUser.USER_ID);
         DocumentInfo previewDoc = mEnv.model.createFile("b.png", 0);
         mEnv.model.createFile("c.png", 0);
         mEnv.model.update();
diff --git a/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt
new file mode 100644
index 000000000..55f83bfea
--- /dev/null
+++ b/tests/unit/com/android/documentsui/loaders/BaseLoaderTest.kt
@@ -0,0 +1,101 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.os.Bundle
+import android.os.Parcel
+import android.provider.DocumentsContract
+import com.android.documentsui.DirectoryResult
+import com.android.documentsui.TestActivity
+import com.android.documentsui.TestConfigStore
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.base.UserId
+import com.android.documentsui.sorting.SortModel
+import com.android.documentsui.testing.ActivityManagers
+import com.android.documentsui.testing.TestEnv
+import com.android.documentsui.testing.TestModel
+import com.android.documentsui.testing.UserManagers
+import java.time.Duration
+import java.util.Locale
+import kotlin.time.Duration.Companion.hours
+import org.junit.Before
+
+/**
+ * Returns the number of matched files, or -1.
+ */
+fun getFileCount(result: DirectoryResult?) = result?.cursor?.count ?: -1
+
+/**
+ * A data class that holds parameters that can be varied for the loader test. The last
+ * value, expectedCount, can be used for simple tests that check that the number of
+ * returned files matches the expectations.
+ */
+data class LoaderTestParams(
+    // A query, matched against file names. May be empty.
+    val query: String,
+    // The delta from now that indicates maximum age of matched files.
+    val lastModifiedDelta: Duration?,
+    // The extra arguments typically supplied by search view manager.
+    val otherArgs: Bundle,
+    // The number of files that are expected, for the above parameters, to be found by a loader.
+    val expectedCount: Int,
+)
+
+/**
+ * Common base class for search and folder loaders.
+ */
+open class BaseLoaderTest {
+    lateinit var mEnv: TestEnv
+    lateinit var mActivity: TestActivity
+    lateinit var mTestConfigStore: TestConfigStore
+
+    @Before
+    open fun setUp() {
+        mEnv = TestEnv.create()
+        mTestConfigStore = TestConfigStore()
+        mEnv.state.configStore = mTestConfigStore
+        mEnv.state.showHiddenFiles = false
+        val parcel = Parcel.obtain()
+        mEnv.state.sortModel = SortModel.CREATOR.createFromParcel(parcel)
+
+        mActivity = TestActivity.create(mEnv)
+        mActivity.activityManager = ActivityManagers.create(false)
+        mActivity.userManager = UserManagers.create()
+    }
+
+    /**
+     * Creates a text, PNG, MP4 and MPG files named sample-000x, for x in 0 .. count - 1.
+     * Each file gets a matching extension. The 0th file is modified 1h, 1st 2 hours, .. etc., ago.
+     */
+    fun createDocuments(count: Int): Array<DocumentInfo> {
+        val extensionList = arrayOf("txt", "png", "mp4", "mpg")
+        val now = System.currentTimeMillis()
+        val flags = (DocumentsContract.Document.FLAG_SUPPORTS_WRITE
+                or DocumentsContract.Document.FLAG_SUPPORTS_DELETE
+                or DocumentsContract.Document.FLAG_SUPPORTS_RENAME)
+        return Array<DocumentInfo>(count) { i ->
+            val id = String.format(Locale.US, "%05d", i)
+            val name = "sample-$id.${extensionList[i % extensionList.size]}"
+            mEnv.model.createDocumentForUser(
+                name,
+                TestModel.guessMimeType(name),
+                flags,
+                now - 1.hours.inWholeMilliseconds * i,
+                UserId.DEFAULT_USER
+            )
+        }
+    }
+}
diff --git a/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt
new file mode 100644
index 000000000..0193ea77d
--- /dev/null
+++ b/tests/unit/com/android/documentsui/loaders/FolderLoaderTest.kt
@@ -0,0 +1,97 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.os.Bundle
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import androidx.test.filters.SmallTest
+import com.android.documentsui.ContentLock
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.testing.TestFileTypeLookup
+import com.android.documentsui.testing.TestProvidersAccess
+import java.time.Duration
+import junit.framework.Assert.assertEquals
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.junit.runners.Parameterized
+import org.junit.runners.Parameterized.Parameters
+
+private const val TOTAL_FILE_COUNT = 10
+
+@RunWith(Parameterized::class)
+@SmallTest
+class FolderLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTest() {
+    companion object {
+        @JvmStatic
+        @Parameters(name = "with parameters {0}")
+        fun data() = listOf(
+            LoaderTestParams("", null, Bundle(), TOTAL_FILE_COUNT),
+            // The first file is at NOW, the second at NOW - 1h, etc.
+            LoaderTestParams("", Duration.ofMinutes(1L), Bundle(), 1),
+            LoaderTestParams("", Duration.ofMinutes(60L + 1), Bundle(), 2),
+            LoaderTestParams(
+                "",
+                Duration.ofMinutes(TOTAL_FILE_COUNT * 60L + 1),
+                Bundle(),
+                TOTAL_FILE_COUNT
+            ),
+        )
+    }
+
+    @get:Rule
+    val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    fun testLoadInBackground() {
+        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
+        val docs = createDocuments(TOTAL_FILE_COUNT)
+        mockProvider!!.setNextChildDocumentsReturns(*docs)
+        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
+        val queryOptions =
+            QueryOptions(
+                TOTAL_FILE_COUNT,
+                testParams.lastModifiedDelta,
+                null,
+                true,
+                arrayOf<String>("*/*"),
+                testParams.otherArgs,
+            )
+        val contentLock = ContentLock()
+        // TODO(majewski): Is there a better way to create Downloads root folder DocumentInfo?
+        val rootFolderInfo = DocumentInfo()
+        rootFolderInfo.authority = TestProvidersAccess.DOWNLOADS.authority
+        rootFolderInfo.userId = userIds[0]
+
+        val loader =
+            FolderLoader(
+                mActivity,
+                userIds,
+                TestFileTypeLookup(),
+                contentLock,
+                TestProvidersAccess.DOWNLOADS,
+                rootFolderInfo,
+                queryOptions,
+                mEnv.state.sortModel
+            )
+        val directoryResult = loader.loadInBackground()
+        assertEquals(testParams.expectedCount, getFileCount(directoryResult))
+    }
+}
diff --git a/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt b/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt
new file mode 100644
index 000000000..7265af34b
--- /dev/null
+++ b/tests/unit/com/android/documentsui/loaders/SearchLoaderTest.kt
@@ -0,0 +1,160 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.loaders
+
+import android.os.Bundle
+import android.platform.test.annotations.RequiresFlagsEnabled
+import android.platform.test.flag.junit.CheckFlagsRule
+import android.platform.test.flag.junit.DeviceFlagsValueProvider
+import android.provider.DocumentsContract
+import androidx.test.filters.SmallTest
+import com.android.documentsui.ContentLock
+import com.android.documentsui.LockingContentObserver
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.flags.Flags.FLAG_USE_SEARCH_V2_READ_ONLY
+import com.android.documentsui.testing.TestFileTypeLookup
+import com.android.documentsui.testing.TestProvidersAccess
+import java.time.Duration
+import java.util.concurrent.ExecutorService
+import java.util.concurrent.Executors
+import junit.framework.Assert.assertEquals
+import org.junit.Assert.assertThrows
+import org.junit.Before
+import org.junit.Ignore
+import org.junit.Rule
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.junit.runners.Parameterized
+import org.junit.runners.Parameterized.Parameters
+
+private const val TOTAL_FILE_COUNT = 8
+
+fun createQueryArgs(vararg mimeTypes: String): Bundle {
+    val args = Bundle()
+    args.putStringArray(DocumentsContract.QUERY_ARG_MIME_TYPES, arrayOf<String>(*mimeTypes))
+    return args
+}
+
+@RunWith(Parameterized::class)
+@SmallTest
+class SearchLoaderTest(private val testParams: LoaderTestParams) : BaseLoaderTest() {
+    lateinit var mExecutor: ExecutorService
+    val mContentLock = ContentLock()
+    val mContentObserver = LockingContentObserver(mContentLock) {}
+
+    companion object {
+        @JvmStatic
+        @Parameters(name = "with parameters {0}")
+        fun data() = listOf(
+            LoaderTestParams("sample", null, Bundle(), TOTAL_FILE_COUNT),
+            LoaderTestParams("txt", null, Bundle(), 2),
+            LoaderTestParams("foozig", null, Bundle(), 0),
+            // The first file is at NOW, the second at NOW - 1h; expect 2.
+            LoaderTestParams("sample", Duration.ofMinutes(60 + 1), Bundle(), 2),
+            LoaderTestParams("sample", null, createQueryArgs("image/*"), 2),
+            LoaderTestParams("sample", null, createQueryArgs("image/*", "video/*"), 6),
+            LoaderTestParams("sample", null, createQueryArgs("application/pdf"), 0),
+        )
+    }
+
+    @get:Rule
+    val checkFlagsRule: CheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule()
+
+    @Before
+    override fun setUp() {
+        super.setUp()
+        mExecutor = Executors.newSingleThreadExecutor()
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    fun testLoadInBackground() {
+        val mockProvider = mEnv.mockProviders[TestProvidersAccess.DOWNLOADS.authority]
+        val docs = createDocuments(TOTAL_FILE_COUNT)
+        mockProvider!!.setNextChildDocumentsReturns(*docs)
+        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
+        val queryOptions =
+            QueryOptions(
+                TOTAL_FILE_COUNT + 1,
+                testParams.lastModifiedDelta,
+                null,
+                true,
+                arrayOf("*/*"),
+                testParams.otherArgs,
+            )
+        val rootIds = listOf(TestProvidersAccess.DOWNLOADS)
+
+        // TODO(majewski): Is there a better way to create Downloads root folder DocumentInfo?
+        val rootFolderInfo = DocumentInfo()
+        rootFolderInfo.authority = TestProvidersAccess.DOWNLOADS.authority
+        rootFolderInfo.userId = userIds[0]
+
+        val loader =
+            SearchLoader(
+                mActivity,
+                userIds,
+                TestFileTypeLookup(),
+                mContentObserver,
+                rootIds,
+                testParams.query,
+                queryOptions,
+                mEnv.state.sortModel,
+                mExecutor,
+            )
+        val directoryResult = loader.loadInBackground()
+        assertEquals(testParams.expectedCount, getFileCount(directoryResult))
+    }
+
+    @Test
+    @RequiresFlagsEnabled(FLAG_USE_SEARCH_V2_READ_ONLY)
+    @Ignore("b/397095797")
+    fun testBlankQueryAndRecency() {
+        val userIds = listOf(TestProvidersAccess.DOWNLOADS.userId)
+        val rootIds = listOf(TestProvidersAccess.DOWNLOADS)
+        val noLastModifiedQueryOptions =
+            QueryOptions(10, null, null, true, arrayOf("*/*"), Bundle())
+
+        // Blank query and no last modified duration is invalid.
+        assertThrows(IllegalArgumentException::class.java) {
+            SearchLoader(
+                mActivity,
+                userIds,
+                TestFileTypeLookup(),
+                mContentObserver,
+                rootIds,
+                "",
+                noLastModifiedQueryOptions,
+                mEnv.state.sortModel,
+                mExecutor,
+            )
+        }
+
+        // Null query and no last modified duration is invalid.
+        assertThrows(IllegalArgumentException::class.java) {
+            SearchLoader(
+                mActivity,
+                userIds,
+                TestFileTypeLookup(),
+                mContentObserver,
+                rootIds,
+                null,
+                noLastModifiedQueryOptions,
+                mEnv.state.sortModel,
+                mExecutor,
+            )
+        }
+    }
+}
diff --git a/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java b/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
index 166e48e7e..d3e6e90d0 100644
--- a/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
+++ b/tests/unit/com/android/documentsui/picker/ActionHandlerTest.java
@@ -223,6 +223,7 @@ public class ActionHandlerTest {
 
     @Test
     public void testInitLocation_RestoresLastAccessedStack() throws Exception {
+        if (!SdkLevel.isAtLeastS()) return;
         final DocumentStack stack =
                 new DocumentStack(TestProvidersAccess.HAMMY, TestEnv.FOLDER_0, TestEnv.FOLDER_1);
         mLastAccessed.setLastAccessed(mActivity, stack);
@@ -644,7 +645,8 @@ public class ActionHandlerTest {
             mActivity.currentRoot = TestProvidersAccess.OtherUser.DOWNLOADS;
             mEnv.model.reset();
             DocumentInfo otherUserDoc = mEnv.model.createDocumentForUser("a.png",
-                    "image/png", /* flags= */ 0, TestProvidersAccess.OtherUser.USER_ID);
+                    "image/png", /* flags= */ 0, System.currentTimeMillis(),
+                    TestProvidersAccess.OtherUser.USER_ID);
             mEnv.model.update();
 
             mHandler.onDocumentOpened(otherUserDoc, ActionHandler.VIEW_TYPE_PREVIEW,
diff --git a/tests/unit/com/android/documentsui/picker/MenuManagerTest.java b/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
index cf9699a3b..27ffcbdaa 100644
--- a/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
+++ b/tests/unit/com/android/documentsui/picker/MenuManagerTest.java
@@ -23,6 +23,7 @@ import static com.android.documentsui.base.State.ACTION_OPEN;
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertTrue;
 
+import android.annotation.SuppressLint;
 import android.database.MatrixCursor;
 import android.provider.DocumentsContract.Document;
 import android.provider.DocumentsContract.Root;
@@ -61,6 +62,7 @@ public final class MenuManagerTest {
     private TestMenuItem dirCutToClipboard;
     private TestMenuItem dirCopyToClipboard;
     private TestMenuItem dirPasteFromClipboard;
+    private TestMenuItem mDirCompress;
     private TestMenuItem dirCreateDir;
     private TestMenuItem dirSelectAll;
     private TestMenuItem mDirDeselectAll;
@@ -69,6 +71,8 @@ public final class MenuManagerTest {
     private TestMenuItem dirViewInOwner;
     private TestMenuItem dirOpenInNewWindow;
     private TestMenuItem dirPasteIntoFolder;
+    private TestMenuItem mDirExtractHere;
+    private TestMenuItem mDirBrowse;
 
     /* Root List Context Menu items */
     private TestMenuItem rootEjectRoot;
@@ -102,6 +106,7 @@ public final class MenuManagerTest {
     private TestMenuItem optionSort;
     private TestMenuItem mOptionLauncher;
     private TestMenuItem mOptionShowHiddenFiles;
+    private TestMenuItem mOptionExtractAll;
 
     private TestMenuItem subOptionGrid;
     private TestMenuItem subOptionList;
@@ -124,6 +129,7 @@ public final class MenuManagerTest {
         dirOpenWith = testMenu.findItem(R.id.dir_menu_open_with);
         dirCutToClipboard = testMenu.findItem(R.id.dir_menu_cut_to_clipboard);
         dirCopyToClipboard = testMenu.findItem(R.id.dir_menu_copy_to_clipboard);
+        mDirCompress = testMenu.findItem(R.id.dir_menu_compress);
         dirPasteFromClipboard = testMenu.findItem(R.id.dir_menu_paste_from_clipboard);
         dirCreateDir = testMenu.findItem(R.id.dir_menu_create_dir);
         dirSelectAll = testMenu.findItem(R.id.dir_menu_select_all);
@@ -133,6 +139,8 @@ public final class MenuManagerTest {
         dirViewInOwner = testMenu.findItem(R.id.dir_menu_view_in_owner);
         dirOpenInNewWindow = testMenu.findItem(R.id.dir_menu_open_in_new_window);
         dirPasteIntoFolder = testMenu.findItem(R.id.dir_menu_paste_into_folder);
+        mDirExtractHere = testMenu.findItem(R.id.dir_menu_extract_here);
+        mDirBrowse = testMenu.findItem(R.id.dir_menu_browse);
 
         rootEjectRoot = testMenu.findItem(R.id.root_menu_eject_root);
         rootOpenInNewWindow = testMenu.findItem(R.id.root_menu_open_in_new_window);
@@ -162,6 +170,7 @@ public final class MenuManagerTest {
         optionSort = testMenu.findItem(R.id.option_menu_sort);
         mOptionLauncher = testMenu.findItem(R.id.option_menu_launcher);
         mOptionShowHiddenFiles = testMenu.findItem(R.id.option_menu_show_hidden_files);
+        mOptionExtractAll = testMenu.findItem(R.id.option_menu_extract_all);
 
         // Menu actions on root title row.
         subOptionGrid = testMenu.findItem(R.id.sub_menu_grid);
@@ -195,6 +204,7 @@ public final class MenuManagerTest {
         mActionModeDeselectAll.assertDisabledAndInvisible();
         actionModeViewInOwner.assertDisabledAndInvisible();
         actionModeSort.assertEnabledAndVisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
     }
 
     @Test
@@ -268,9 +278,20 @@ public final class MenuManagerTest {
         optionSort.assertEnabledAndVisible();
         mOptionLauncher.assertDisabledAndInvisible();
         mOptionShowHiddenFiles.assertEnabledAndVisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
         assertTrue(testSearchManager.showMenuCalled());
     }
 
+    @Test
+    public void testOptionMenu_ExtractAll() {
+        dirDetails.isInArchive = true;
+        mgr.updateOptionMenu(testMenu);
+        mOptionExtractAll.assertDisabledAndInvisible();
+        dirDetails.isInArchive = false;
+        mgr.updateOptionMenu(testMenu);
+        mOptionExtractAll.assertDisabledAndInvisible();
+    }
+
     @Test
     public void testOptionMenu_notPicking() {
         state.action = ACTION_OPEN;
@@ -281,6 +302,7 @@ public final class MenuManagerTest {
         optionCreateDir.assertDisabledAndInvisible();
         subOptionGrid.assertEnabledAndVisible();
         subOptionList.assertDisabledAndInvisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
         assertFalse(testSearchManager.showMenuCalled());
     }
 
@@ -300,6 +322,7 @@ public final class MenuManagerTest {
 
         subOptionGrid.assertDisabledAndInvisible();
         subOptionList.assertDisabledAndInvisible();
+        mOptionExtractAll.assertDisabledAndInvisible();
     }
 
 
@@ -321,6 +344,7 @@ public final class MenuManagerTest {
         optionSelectAll.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea() {
         dirDetails.hasItemsToPaste = false;
@@ -333,8 +357,11 @@ public final class MenuManagerTest {
         mDirDeselectAll.assertDisabledAndInvisible();
         dirPasteFromClipboard.assertDisabledAndInvisible();
         dirCreateDir.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_NoItemToPaste() {
         dirDetails.hasItemsToPaste = false;
@@ -345,8 +372,11 @@ public final class MenuManagerTest {
         dirSelectAll.assertEnabledAndVisible();
         dirPasteFromClipboard.assertDisabledAndInvisible();
         dirCreateDir.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CantCreateDoc() {
         dirDetails.hasItemsToPaste = true;
@@ -357,8 +387,11 @@ public final class MenuManagerTest {
         dirSelectAll.assertEnabledAndVisible();
         dirPasteFromClipboard.assertDisabledAndInvisible();
         dirCreateDir.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_canPaste() {
         dirDetails.hasItemsToPaste = true;
@@ -369,8 +402,11 @@ public final class MenuManagerTest {
         dirSelectAll.assertEnabledAndVisible();
         dirPasteFromClipboard.assertEnabledAndVisible();
         dirCreateDir.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CanCreateDirectory() {
         dirDetails.canCreateDirectory = true;
@@ -380,8 +416,11 @@ public final class MenuManagerTest {
         dirSelectAll.assertEnabledAndVisible();
         dirPasteFromClipboard.assertDisabledAndInvisible();
         dirCreateDir.assertEnabledAndVisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_EmptyArea_CanDeselectAll() {
         selectionDetails.size = 1;
@@ -393,6 +432,7 @@ public final class MenuManagerTest {
         mDirDeselectAll.assertEnabledAndVisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnFile() {
         mgr.updateContextMenuForFiles(testMenu, selectionDetails);
@@ -402,10 +442,14 @@ public final class MenuManagerTest {
         dirOpenWith.assertDisabledAndInvisible();
         dirCutToClipboard.assertDisabledAndInvisible();
         dirCopyToClipboard.assertEnabledAndVisible();
+        mDirCompress.assertDisabledAndInvisible();
         dirRename.assertDisabledAndInvisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnDirectory() {
         selectionDetails.canPasteInto = true;
@@ -414,12 +458,16 @@ public final class MenuManagerTest {
         dirOpenInNewWindow.assertDisabledAndInvisible();
         dirCutToClipboard.assertDisabledAndInvisible();
         dirCopyToClipboard.assertEnabledAndVisible();
+        mDirCompress.assertDisabledAndInvisible();
         // Doesn't matter if directory is selected, we don't want pasteInto for PickerActivity
         dirPasteIntoFolder.assertDisabledAndInvisible();
         dirRename.assertDisabledAndInvisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs() {
         selectionDetails.containDirectories = true;
@@ -429,9 +477,13 @@ public final class MenuManagerTest {
         mgr.updateContextMenu(testMenu, selectionDetails);
         dirCutToClipboard.assertEnabledAndVisible();
         dirCopyToClipboard.assertEnabledAndVisible();
+        mDirCompress.assertDisabledAndInvisible();
         dirDelete.assertEnabledAndVisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs_hasPartialFile() {
         selectionDetails.containDirectories = true;
@@ -442,9 +494,13 @@ public final class MenuManagerTest {
         mgr.updateContextMenu(testMenu, selectionDetails);
         dirCutToClipboard.assertDisabledAndInvisible();
         dirCopyToClipboard.assertDisabledAndInvisible();
+        mDirCompress.assertDisabledAndInvisible();
         dirDelete.assertEnabledAndVisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     @Test
     public void testContextMenu_OnMixedDocs_hasUndeletableFile() {
         selectionDetails.containDirectories = true;
@@ -454,7 +510,21 @@ public final class MenuManagerTest {
         mgr.updateContextMenu(testMenu, selectionDetails);
         dirCutToClipboard.assertDisabledAndInvisible();
         dirCopyToClipboard.assertEnabledAndVisible();
+        mDirCompress.assertDisabledAndInvisible();
         dirDelete.assertDisabledAndInvisible();
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
+    }
+
+    @SuppressLint("VisibleForTests")
+    @Test
+    public void testContextMenu_OnArchive() {
+        selectionDetails.size = 1;
+        selectionDetails.containFiles = true;
+        selectionDetails.isArchive = true;
+        mgr.updateContextMenuForFiles(testMenu, selectionDetails);
+        mDirExtractHere.assertDisabledAndInvisible();
+        mDirBrowse.assertDisabledAndInvisible();
     }
 
     @Test
@@ -500,6 +570,7 @@ public final class MenuManagerTest {
         rootEjectRoot.assertDisabledAndInvisible();
     }
 
+    @SuppressLint("VisibleForTests")
     private Model getTestModel(boolean onlyDirectory) {
         String[] COLUMNS = new String[]{
                 RootCursorWrapper.COLUMN_AUTHORITY,
diff --git a/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java b/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
index da83c38fa..02e24a329 100644
--- a/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
+++ b/tests/unit/com/android/documentsui/queries/SearchChipViewManagerTest.java
@@ -18,25 +18,44 @@ package com.android.documentsui.queries;
 
 import static com.google.common.truth.Truth.assertThat;
 
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertTrue;
 import static org.mockito.Mockito.spy;
 
+import static java.util.Objects.requireNonNull;
+
 import android.content.Context;
+import android.graphics.Bitmap;
+import android.graphics.Canvas;
+import android.graphics.drawable.Drawable;
 import android.os.Bundle;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 import android.provider.DocumentsContract;
 import android.view.View;
 import android.view.ViewGroup;
+import android.view.ViewParent;
+import android.widget.FrameLayout;
+import android.widget.HorizontalScrollView;
 import android.widget.LinearLayout;
 
+import androidx.test.ext.junit.runners.AndroidJUnit4;
 import androidx.test.filters.SmallTest;
 import androidx.test.platform.app.InstrumentationRegistry;
-import androidx.test.runner.AndroidJUnit4;
 
+import com.android.documentsui.IconUtils;
 import com.android.documentsui.R;
 import com.android.documentsui.base.MimeTypes;
 import com.android.documentsui.base.Shared;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.util.VersionUtils;
 
+import com.google.android.material.chip.Chip;
+
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
@@ -62,6 +81,9 @@ public final class SearchChipViewManagerTest {
     private SearchChipViewManager mSearchChipViewManager;
     private LinearLayout mChipGroup;
 
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
     @Before
     public void setUp() {
         mContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
@@ -82,6 +104,56 @@ public final class SearchChipViewManagerTest {
         assertThat(mChipGroup.getChildCount()).isEqualTo(totalChipLength);
     }
 
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_USE_MATERIAL3})
+    public void testChipIcon() {
+        mSearchChipViewManager.initChipSets(
+                new String[] {"image/*", "audio/*", "video/*", "text/*"});
+        mSearchChipViewManager.updateChips(new String[] {"*/*"});
+
+        Chip imageChip = (Chip) mChipGroup.getChildAt(0);
+        assertDrawablesEqual(
+                requireNonNull(imageChip.getChipIcon()),
+                requireNonNull(mContext.getDrawable(R.drawable.ic_chip_image)));
+        Chip audioChip = (Chip) mChipGroup.getChildAt(1);
+        assertDrawablesEqual(
+                requireNonNull(audioChip.getChipIcon()),
+                requireNonNull(mContext.getDrawable(R.drawable.ic_chip_audio)));
+        Chip videoChip = (Chip) mChipGroup.getChildAt(2);
+        assertDrawablesEqual(
+                requireNonNull(videoChip.getChipIcon()),
+                requireNonNull(mContext.getDrawable(R.drawable.ic_chip_video)));
+        Chip documentChip = (Chip) mChipGroup.getChildAt(3);
+        assertDrawablesEqual(
+                requireNonNull(documentChip.getChipIcon()),
+                requireNonNull(mContext.getDrawable(R.drawable.ic_chip_document)));
+    }
+
+    @Test
+    @RequiresFlagsDisabled({Flags.FLAG_USE_MATERIAL3})
+    public void testChipIcon_M3Disabled() {
+        mSearchChipViewManager.initChipSets(
+                new String[] {"image/*", "audio/*", "video/*", "text/*"});
+        mSearchChipViewManager.updateChips(new String[] {"*/*"});
+
+        Chip imageChip = (Chip) mChipGroup.getChildAt(0);
+        assertDrawablesEqual(
+                requireNonNull(imageChip.getChipIcon()),
+                requireNonNull(IconUtils.loadMimeIcon(mContext, "image/*")));
+        Chip audioChip = (Chip) mChipGroup.getChildAt(1);
+        assertDrawablesEqual(
+                requireNonNull(audioChip.getChipIcon()),
+                requireNonNull(IconUtils.loadMimeIcon(mContext, "audio/*")));
+        Chip videoChip = (Chip) mChipGroup.getChildAt(2);
+        assertDrawablesEqual(
+                requireNonNull(videoChip.getChipIcon()),
+                requireNonNull(IconUtils.loadMimeIcon(mContext, "video/*")));
+        Chip documentChip = (Chip) mChipGroup.getChildAt(3);
+        assertDrawablesEqual(
+                requireNonNull(documentChip.getChipIcon()),
+                requireNonNull(IconUtils.loadMimeIcon(mContext, MimeTypes.GENERIC_TYPE)));
+    }
+
     @Test
     public void testUpdateChips_hasCorrectChipCount() throws Exception {
         mSearchChipViewManager.updateChips(TEST_MIME_TYPES);
@@ -167,9 +239,62 @@ public final class SearchChipViewManagerTest {
         assertThat(View.VISIBLE).isEqualTo(mirror.getVisibility());
     }
 
+    @Test
+    public void testChipChecked_resetScroll() {
+        // Mock chip group's parent chain according to search_chip_row.xml.
+        FrameLayout parent = spy(new FrameLayout(mContext));
+        HorizontalScrollView grandparent = spy(new HorizontalScrollView(mContext));
+        parent.addView(mChipGroup);
+        grandparent.addView(parent);
+        // Verify that getParent().getParent() returns the HorizontalScrollView mock.
+        ViewParent result = mChipGroup.getParent().getParent();
+        assertEquals(grandparent, result);
+
+        mSearchChipViewManager.initChipSets(
+                new String[] {"image/*", "audio/*", "video/*", "text/*"});
+        mSearchChipViewManager.updateChips(new String[] {"*/*"});
+
+        // Manually set HorizontalScrollView's scrollX to something larger than 0.
+        grandparent.scrollTo(100, 0);
+        assertTrue(grandparent.getScaleX() > 0);
+
+        assertEquals(6, mChipGroup.getChildCount());
+        Chip lastChip = (Chip) mChipGroup.getChildAt(5);
+
+        // chip.setChecked will trigger reorder animation, which needs to be run inside
+        // the looper thread.
+        InstrumentationRegistry.getInstrumentation().runOnMainSync(() -> {
+            // Check last chip will move it to the first child and reset scroll view.
+            lastChip.setChecked(true);
+            assertEquals(0, grandparent.getScrollX());
+        });
+    }
+
     private static Set<SearchChipData> getFakeSearchChipDataList() {
         final Set<SearchChipData> chipDataList = new HashSet<>();
         chipDataList.add(new SearchChipData(CHIP_TYPE, 0 /* titleRes */, TEST_MIME_TYPES));
         return chipDataList;
     }
+
+    private void assertDrawablesEqual(Drawable actual, Drawable expected) {
+        Bitmap bitmap1 =
+                Bitmap.createBitmap(
+                        actual.getIntrinsicWidth(),
+                        actual.getIntrinsicHeight(),
+                        Bitmap.Config.ARGB_8888);
+        Canvas canvas1 = new Canvas(bitmap1);
+        actual.setBounds(0, 0, actual.getIntrinsicWidth(), actual.getIntrinsicHeight());
+        actual.draw(canvas1);
+
+        Bitmap bitmap2 =
+                Bitmap.createBitmap(
+                        expected.getIntrinsicWidth(),
+                        expected.getIntrinsicHeight(),
+                        Bitmap.Config.ARGB_8888);
+        Canvas canvas2 = new Canvas(bitmap2);
+        expected.setBounds(0, 0, expected.getIntrinsicWidth(), expected.getIntrinsicHeight());
+        expected.draw(canvas2);
+
+        assertTrue("Drawables are not equal", bitmap1.sameAs(bitmap2));
+    }
 }
diff --git a/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java b/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
index 6a7b86415..26512cc22 100644
--- a/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
+++ b/tests/unit/com/android/documentsui/sidebar/RootsFragmentTest.java
@@ -24,7 +24,12 @@ import static org.mockito.Mockito.when;
 
 import android.app.admin.DevicePolicyManager;
 import android.content.Context;
+import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
+import android.platform.test.annotations.RequiresFlagsDisabled;
+import android.platform.test.annotations.RequiresFlagsEnabled;
+import android.platform.test.flag.junit.CheckFlagsRule;
+import android.platform.test.flag.junit.DeviceFlagsValueProvider;
 
 import androidx.test.filters.MediumTest;
 import androidx.test.platform.app.InstrumentationRegistry;
@@ -33,6 +38,7 @@ import com.android.documentsui.TestConfigStore;
 import com.android.documentsui.TestUserManagerState;
 import com.android.documentsui.base.RootInfo;
 import com.android.documentsui.base.UserId;
+import com.android.documentsui.flags.Flags;
 import com.android.documentsui.testing.TestEnv;
 import com.android.documentsui.testing.TestProvidersAccess;
 import com.android.documentsui.testing.TestResolveInfo;
@@ -41,6 +47,7 @@ import com.android.modules.utils.build.SdkLevel;
 import com.google.android.collect.Lists;
 
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.Parameterized;
@@ -59,13 +66,14 @@ import java.util.List;
 public class RootsFragmentTest {
 
     private Context mContext;
+    private PackageManager mPackageManager;
     private DevicePolicyManager mDevicePolicyManager;
     private RootsFragment mRootsFragment;
     private TestEnv mEnv;
     private final TestConfigStore mTestConfigStore = new TestConfigStore();
     private TestUserManagerState mTestUserManagerState;
 
-    private static final String[] EXPECTED_SORTED_RESULT = {
+    private static final String[] EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP = {
             TestProvidersAccess.RECENTS.title,
             TestProvidersAccess.IMAGE.title,
             TestProvidersAccess.VIDEO.title,
@@ -79,6 +87,19 @@ public class RootsFragmentTest {
             TestProvidersAccess.INSPECTOR.title,
             TestProvidersAccess.PICKLES.title};
 
+    private static final String[] EXPECTED_SORTED_RESULT_FOR_DESKTOP = {
+            TestProvidersAccess.RECENTS.title,
+            TestProvidersAccess.DOWNLOADS.title,
+            "" /* SpacerItem */,
+            TestProvidersAccess.EXTERNALSTORAGE.title,
+            TestProvidersAccess.HAMMY.title,
+            "" /* SpacerItem */,
+            TestProvidersAccess.INSPECTOR.title,
+            TestProvidersAccess.PICKLES.title};
+
+    @Rule
+    public final CheckFlagsRule mCheckFlagsRule = DeviceFlagsValueProvider.createCheckFlagsRule();
+
     @Parameter(0)
     public boolean isPrivateSpaceEnabled;
 
@@ -98,12 +119,14 @@ public class RootsFragmentTest {
 
         mContext = mock(Context.class);
         mDevicePolicyManager = mock(DevicePolicyManager.class);
+        mPackageManager = mock(PackageManager.class);
         when(mContext.getResources()).thenReturn(
                 InstrumentationRegistry.getInstrumentation().getTargetContext().getResources());
         when(mContext.getSystemService(Context.DEVICE_POLICY_SERVICE))
                 .thenReturn(mDevicePolicyManager);
         when(mContext.getApplicationContext()).thenReturn(
                 InstrumentationRegistry.getInstrumentation().getTargetContext());
+        when(mContext.getPackageManager()).thenReturn(mPackageManager);
 
         if (SdkLevel.isAtLeastS() && isPrivateSpaceEnabled) {
             mTestConfigStore.enablePrivateSpaceInPhotoPicker();
@@ -115,7 +138,38 @@ public class RootsFragmentTest {
     }
 
     @Test
-    public void testSortLoadResult_WithCorrectOrder() {
+    @RequiresFlagsDisabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
+    public void testSortLoadResult_WithCorrectOrder_hideRootsOnDesktopFlagDisable() {
+        List<Item> items = mRootsFragment.sortLoadResult(
+                mContext,
+                mEnv.state,
+                createFakeRootInfoList(),
+                null /* excludePackage */, null /* handlerAppIntent */, new TestProvidersAccess(),
+                UserId.DEFAULT_USER,
+                Collections.singletonList(UserId.DEFAULT_USER),
+                /* maybeShowBadge */ false, mTestUserManagerState);
+        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP));
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
+    public void testSortLoadResult_WithCorrectOrder_onNonDesktop() {
+        when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_PC)).thenReturn(false);
+        List<Item> items = mRootsFragment.sortLoadResult(
+                mContext,
+                mEnv.state,
+                createFakeRootInfoList(),
+                null /* excludePackage */, null /* handlerAppIntent */, new TestProvidersAccess(),
+                UserId.DEFAULT_USER,
+                Collections.singletonList(UserId.DEFAULT_USER),
+                /* maybeShowBadge */ false, mTestUserManagerState);
+        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_NON_DESKTOP));
+    }
+
+    @Test
+    @RequiresFlagsEnabled({Flags.FLAG_HIDE_ROOTS_ON_DESKTOP_RO})
+    public void testSortLoadResult_WithCorrectOrder_onDesktop() {
+        when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_PC)).thenReturn(true);
         List<Item> items = mRootsFragment.sortLoadResult(
                 mContext,
                 mEnv.state,
@@ -124,7 +178,7 @@ public class RootsFragmentTest {
                 UserId.DEFAULT_USER,
                 Collections.singletonList(UserId.DEFAULT_USER),
                 /* maybeShowBadge */ false, mTestUserManagerState);
-        assertTrue(assertSortedResult(items));
+        assertTrue(assertSortedResult(items, EXPECTED_SORTED_RESULT_FOR_DESKTOP));
     }
 
     @Test
@@ -169,13 +223,13 @@ public class RootsFragmentTest {
         assertEquals(rootList.get(2).title, TestProvidersAccess.PICKLES.title);
     }
 
-    private boolean assertSortedResult(List<Item> items) {
+    private boolean assertSortedResult(List<Item> items, String[] expectedSortedResult) {
         for (int i = 0; i < items.size(); i++) {
             Item item = items.get(i);
             if (item instanceof RootItem) {
-                assertEquals(EXPECTED_SORTED_RESULT[i], ((RootItem) item).root.title);
+                assertEquals(expectedSortedResult[i], ((RootItem) item).root.title);
             } else if (item instanceof SpacerItem) {
-                assertTrue(EXPECTED_SORTED_RESULT[i].isEmpty());
+                assertTrue(expectedSortedResult[i].isEmpty());
             } else {
                 return false;
             }
diff --git a/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt b/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt
new file mode 100644
index 000000000..63ff80dad
--- /dev/null
+++ b/tests/unit/com/android/documentsui/ui/MessageBuilderTest.kt
@@ -0,0 +1,234 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.documentsui.ui
+
+import android.content.Context
+import android.content.res.Resources
+import android.net.Uri
+import android.provider.DocumentsContract.Document.MIME_TYPE_DIR
+import androidx.test.filters.SmallTest
+import com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_CONVERTED
+import com.android.documentsui.OperationDialogFragment.DIALOG_TYPE_FAILURE
+import com.android.documentsui.R
+import com.android.documentsui.base.DocumentInfo
+import com.android.documentsui.services.FileOperationService.OPERATION_COMPRESS
+import com.android.documentsui.services.FileOperationService.OPERATION_COPY
+import com.android.documentsui.services.FileOperationService.OPERATION_DELETE
+import com.android.documentsui.services.FileOperationService.OPERATION_EXTRACT
+import com.android.documentsui.services.FileOperationService.OPERATION_MOVE
+import com.android.documentsui.services.FileOperationService.OPERATION_UNKNOWN
+import org.junit.Assert.assertEquals
+import org.junit.Before
+import org.junit.Test
+import org.junit.runner.RunWith
+import org.junit.runners.Parameterized
+import org.junit.runners.Suite
+import org.junit.runners.Suite.SuiteClasses
+import org.mockito.ArgumentMatchers.anyString
+import org.mockito.Mock
+import org.mockito.Mockito.eq
+import org.mockito.Mockito.`when` as whenever
+import org.mockito.MockitoAnnotations
+
+@SmallTest
+@RunWith(Suite::class)
+@SuiteClasses(
+    MessageBuilderTest.GenerateDeleteMessage::class,
+    MessageBuilderTest.GenerateListMessage::class
+)
+open class MessageBuilderTest() {
+    companion object {
+        const val EXPECTED_MESSAGE = "Delete message"
+    }
+
+    class GenerateDeleteMessage() {
+        private lateinit var messageBuilder: MessageBuilder
+
+        @Mock
+        private lateinit var resources: Resources
+
+        @Mock
+        private lateinit var context: Context
+
+        @Before
+        fun setUp() {
+            MockitoAnnotations.openMocks(this)
+            whenever(context.resources).thenReturn(resources)
+            messageBuilder = MessageBuilder(context)
+        }
+
+        private fun assertDeleteMessage(docInfo: DocumentInfo, resId: Int) {
+            whenever(
+                resources.getString(
+                    eq(resId),
+                    eq(docInfo.displayName)
+                )
+            ).thenReturn(EXPECTED_MESSAGE)
+            assertEquals(messageBuilder.generateDeleteMessage(listOf(docInfo)), EXPECTED_MESSAGE)
+        }
+
+        private fun assertQuantityDeleteMessage(docInfos: List<DocumentInfo>, resId: Int) {
+            whenever(
+                resources.getQuantityString(
+                    eq(resId),
+                    eq(docInfos.size),
+                    eq(docInfos.size)
+                )
+            ).thenReturn(EXPECTED_MESSAGE)
+            assertEquals(messageBuilder.generateDeleteMessage(docInfos), EXPECTED_MESSAGE)
+        }
+
+        @Test
+        fun testGenerateDeleteMessage_singleFile() {
+            assertDeleteMessage(
+                createFile("Test doc"),
+                R.string.delete_filename_confirmation_message
+            )
+        }
+
+        @Test
+        fun testGenerateDeleteMessage_singleDirectory() {
+            assertDeleteMessage(
+                createDirectory("Test doc"),
+                R.string.delete_foldername_confirmation_message
+            )
+        }
+
+        @Test
+        fun testGenerateDeleteMessage_multipleFiles() {
+            assertQuantityDeleteMessage(
+                listOf(createFile("File 1"), createFile("File 2")),
+                R.plurals.delete_files_confirmation_message
+            )
+        }
+
+        @Test
+        fun testGenerateDeleteMessage_multipleDirectories() {
+            assertQuantityDeleteMessage(
+                listOf(
+                    createDirectory("Directory 1"),
+                    createDirectory("Directory 2")
+                ),
+                R.plurals.delete_folders_confirmation_message
+            )
+        }
+
+        @Test
+        fun testGenerateDeleteMessage_mixedFilesAndDirectories() {
+            assertQuantityDeleteMessage(
+                listOf(createFile("File 1"), createDirectory("Directory 1")),
+                R.plurals.delete_items_confirmation_message
+            )
+        }
+    }
+
+    @RunWith(Parameterized::class)
+    class GenerateListMessage() {
+        private lateinit var messageBuilder: MessageBuilder
+
+        @Mock
+        private lateinit var resources: Resources
+
+        @Mock
+        private lateinit var context: Context
+
+        @Before
+        fun setUp() {
+            MockitoAnnotations.openMocks(this)
+            whenever(context.resources).thenReturn(resources)
+            messageBuilder = MessageBuilder(context)
+        }
+
+        data class ListMessageData(
+            val dialogType: Int,
+            val opType: Int = OPERATION_UNKNOWN,
+            val resId: Int
+        )
+
+        companion object {
+            @Parameterized.Parameters(name = "{0}")
+            @JvmStatic
+            fun parameters() =
+                listOf(
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_CONVERTED,
+                        resId = R.plurals.copy_converted_warning_content,
+                    ),
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_FAILURE,
+                        opType = OPERATION_COPY,
+                        resId = R.plurals.copy_failure_alert_content,
+                    ),
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_FAILURE,
+                        opType = OPERATION_COMPRESS,
+                        resId = R.plurals.compress_failure_alert_content,
+                    ),
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_FAILURE,
+                        opType = OPERATION_EXTRACT,
+                        resId = R.plurals.extract_failure_alert_content,
+                    ),
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_FAILURE,
+                        opType = OPERATION_DELETE,
+                        resId = R.plurals.delete_failure_alert_content,
+                    ),
+                    ListMessageData(
+                        dialogType = DIALOG_TYPE_FAILURE,
+                        opType = OPERATION_MOVE,
+                        resId = R.plurals.move_failure_alert_content,
+                    ),
+                )
+        }
+
+        @Parameterized.Parameter(0)
+        lateinit var testData: ListMessageData
+
+        @Test
+        fun testGenerateListMessage() {
+            whenever(
+                resources.getQuantityString(
+                    eq(testData.resId),
+                    eq(2),
+                    anyString(),
+                )
+            ).thenReturn(EXPECTED_MESSAGE)
+            assertEquals(
+                messageBuilder.generateListMessage(
+                    testData.dialogType,
+                    testData.opType,
+                    listOf(createFile("File 1")),
+                    listOf(Uri.parse("content://random-uri")),
+                ),
+                EXPECTED_MESSAGE
+            )
+        }
+    }
+}
+
+fun createFile(displayName: String): DocumentInfo {
+    val doc = DocumentInfo()
+    doc.displayName = displayName
+    return doc
+}
+
+fun createDirectory(displayName: String): DocumentInfo {
+    val doc = DocumentInfo()
+    doc.displayName = displayName
+    doc.mimeType = MIME_TYPE_DIR
+    return doc
+}
```

