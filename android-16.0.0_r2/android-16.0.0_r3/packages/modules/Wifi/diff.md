```diff
diff --git a/WifiDialog/Android.bp b/WifiDialog/Android.bp
index 10d2aba473..b1c54ed4f2 100644
--- a/WifiDialog/Android.bp
+++ b/WifiDialog/Android.bp
@@ -27,6 +27,7 @@ android_app {
     ],
     static_libs: [
         "androidx.appcompat_appcompat",
+        "androidx-constraintlayout_constraintlayout",
     ],
     srcs: ["src/**/*.java"],
     sdk_version: "module_current",
diff --git a/WifiDialog/src/com/android/wifi/dialog/WifiDialogActivity.java b/WifiDialog/src/com/android/wifi/dialog/WifiDialogActivity.java
index cf1b4cc884..bdff18d180 100644
--- a/WifiDialog/src/com/android/wifi/dialog/WifiDialogActivity.java
+++ b/WifiDialog/src/com/android/wifi/dialog/WifiDialogActivity.java
@@ -41,7 +41,9 @@ import android.text.TextUtils;
 import android.text.TextWatcher;
 import android.text.method.LinkMovementMethod;
 import android.text.style.URLSpan;
+import android.util.ArrayMap;
 import android.util.ArraySet;
+import android.util.DisplayMetrics;
 import android.util.Log;
 import android.util.SparseArray;
 import android.view.ContextThemeWrapper;
@@ -53,6 +55,9 @@ import android.view.ViewGroup;
 import android.view.Window;
 import android.view.WindowManager;
 import android.widget.EditText;
+import android.widget.LinearLayout;
+import android.widget.ListView;
+import android.widget.SimpleAdapter;
 import android.widget.TextView;
 
 import androidx.annotation.NonNull;
@@ -63,6 +68,7 @@ import com.android.wifi.x.com.android.wifi.flags.Flags;
 
 import java.util.ArrayList;
 import java.util.HashMap;
+import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
@@ -75,6 +81,8 @@ public class WifiDialogActivity extends Activity  {
     private static final String KEY_DIALOG_INTENTS = "KEY_DIALOG_INTENTS";
     private static final String EXTRA_DIALOG_P2P_PIN_INPUT =
             "com.android.wifi.dialog.DIALOG_P2P_PIN_INPUT";
+    private static final String LIST_ADAPTER_LABEL_NAME = "label";
+    private static final String LIST_ADAPTER_CONTENT_NAME = "content";
 
     private @Nullable WifiContext mWifiContext;
     private @Nullable WifiManager mWifiManager;
@@ -341,6 +349,8 @@ public class WifiDialogActivity extends Activity  {
                         intent.getStringExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL),
                         intent.getIntExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_START, 0),
                         intent.getIntExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_END, 0),
+                        intent.getStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_LABELS),
+                        intent.getStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_CONTENTS),
                         intent.getStringExtra(WifiManager.EXTRA_DIALOG_POSITIVE_BUTTON_TEXT),
                         intent.getStringExtra(WifiManager.EXTRA_DIALOG_NEGATIVE_BUTTON_TEXT),
                         intent.getStringExtra(WifiManager.EXTRA_DIALOG_NEUTRAL_BUTTON_TEXT));
@@ -423,6 +433,8 @@ public class WifiDialogActivity extends Activity  {
             @Nullable String messageUrl,
             int messageUrlStart,
             int messageUrlEnd,
+            @Nullable List<String> listLabels,
+            @Nullable List<String> listContents,
             @Nullable String positiveButtonText,
             @Nullable String negativeButtonText,
             @Nullable String neutralButtonText) {
@@ -443,7 +455,7 @@ public class WifiDialogActivity extends Activity  {
                 }
             }
         }
-        AlertDialog dialog = getWifiAlertDialogBuilder("wifi_dialog")
+        AlertDialog.Builder dialogBuilder = getWifiAlertDialogBuilder("wifi_dialog")
                 .setTitle(title)
                 .setMessage(spannableMessage)
                 .setPositiveButton(positiveButtonText, (dialogPositive, which) -> {
@@ -477,21 +489,96 @@ public class WifiDialogActivity extends Activity  {
                     }
                     getWifiManager().replyToSimpleDialog(dialogId,
                             WifiManager.DIALOG_REPLY_CANCELLED);
-                })
-                .create();
+                });
+        final View listView;
+        if (listLabels != null && listContents != null
+                && listLabels.size() == listContents.size()) {
+            listView = createListView(dialogBuilder.getContext(), listLabels, listContents);
+            dialogBuilder.setView(listView);
+        } else {
+            listView = null;
+        }
+
         if (mIsVerboseLoggingEnabled) {
             Log.v(TAG, "Created a simple dialog."
                     + " id=" + dialogId
                     + " title=" + title
                     + " message=" + message
+                    + " listLabels=" + listLabels
+                    + " listContents=" + listContents
                     + " url=[" + messageUrl + "," + messageUrlStart + "," + messageUrlEnd + "]"
+                    + " listLabels="  + listLabels
+                    + " listContents=" + listContents
                     + " positiveButtonText=" + positiveButtonText
                     + " negativeButtonText=" + negativeButtonText
                     + " neutralButtonText=" + neutralButtonText);
         }
+
+        AlertDialog dialog = dialogBuilder.create();
+
+        // Trim the list view to 45% of the screen height so that it doesn't push the button bar out
+        // of view.
+        dialog.setOnShowListener(dlg -> {
+            if (listView == null) return;
+            trimCustomView((AlertDialog) dlg, getWifiViewId("wifi_dialog_list_data"), 0.45f);
+        });
         return dialog;
     }
 
+    private void trimCustomView(AlertDialog dialog, int viewId, float percentageOfScreen) {
+        DisplayMetrics displayMetrics = getResources().getDisplayMetrics();
+        int maxHeightPx = (int) (displayMetrics.heightPixels * percentageOfScreen);
+
+        View customView = dialog.findViewById(viewId);
+        LinearLayout.LayoutParams params =
+                (LinearLayout.LayoutParams) customView.getLayoutParams();
+        if (params.height < maxHeightPx) {
+            params.height = maxHeightPx;
+        }
+        customView.setLayoutParams(params);
+    }
+
+    private static class UnclickableSimpleAdapter extends SimpleAdapter {
+        UnclickableSimpleAdapter(
+                Context context,
+                List<? extends Map<String, ?>> data,
+                int resource,
+                String[] from, int[] to) {
+            super(context, data, resource, from, to);
+        }
+
+        @Override
+        public boolean isEnabled(int position) {
+            return false;
+        }
+    }
+
+    private View createListView(
+            @NonNull Context context,
+            @NonNull List<String> labels,
+            @NonNull List<String> contents) {
+        List<Map<String, String>> data = new ArrayList<>();
+        Iterator<String> labelIter = labels.iterator();
+        Iterator<String> contentIter = contents.iterator();
+        while (labelIter.hasNext()) {
+            Map<String, String> listItemData = new ArrayMap<>();
+            listItemData.put(LIST_ADAPTER_LABEL_NAME, labelIter.next());
+            listItemData.put(LIST_ADAPTER_CONTENT_NAME, contentIter.next());
+            data.add(listItemData);
+        }
+        SimpleAdapter listAdapter = new UnclickableSimpleAdapter(context, data,
+                getWifiLayoutId("wifi_dialog_list_item"),
+                new String[] {LIST_ADAPTER_LABEL_NAME,  LIST_ADAPTER_CONTENT_NAME},
+                new int[] {
+                        getWifiViewId("wifi_dialog_list_item_label"),
+                        getWifiViewId("wifi_dialog_list_item_content")});
+        View listView = getWifiLayoutInflater()
+                .inflate(getWifiLayoutId("wifi_dialog_list"), null);
+        ListView dataView = listView.findViewById(getWifiViewId("wifi_dialog_list_data"));
+        dataView.setAdapter(listAdapter);
+        return listView;
+    }
+
     /**
      * Returns a P2P Invitation Sent Dialog for the given Intent.
      */
@@ -662,7 +749,8 @@ public class WifiDialogActivity extends Activity  {
                 .create();
         if (pinEditText != null) {
             dialog.getWindow().setSoftInputMode(
-                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE);
+                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE
+                        | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_PAN);
             dialog.setOnShowListener(dialogShow -> {
                 Intent intent = mLaunchIntentsPerId.get(dialogId);
                 if (intent != null) {
@@ -867,7 +955,8 @@ public class WifiDialogActivity extends Activity  {
         AlertDialog dialog = builder.create();
         if (isPinRequested) {
             dialog.getWindow().setSoftInputMode(
-                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE);
+                    WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE
+                        | WindowManager.LayoutParams.SOFT_INPUT_ADJUST_PAN);
             dialog.setOnShowListener(dialogShow -> {
                 Intent intent = mLaunchIntentsPerId.get(dialogId);
                 if (intent != null) {
diff --git a/aidl/mainline_supplicant/android/system/wifi/mainline_supplicant/IMainlineSupplicant.aidl b/aidl/mainline_supplicant/android/system/wifi/mainline_supplicant/IMainlineSupplicant.aidl
index 40ed698b7d..606d8323cd 100644
--- a/aidl/mainline_supplicant/android/system/wifi/mainline_supplicant/IMainlineSupplicant.aidl
+++ b/aidl/mainline_supplicant/android/system/wifi/mainline_supplicant/IMainlineSupplicant.aidl
@@ -48,4 +48,29 @@ interface IMainlineSupplicant {
      * Terminate the service.
      */
     oneway void terminate();
+
+    /**
+     * Debug log levels for the supplicant. Only log messages with a level greater than
+     * or equal to the one set via |setDebugParams| will be logged.
+     */
+    @Backing(type="byte")
+    enum DebugLevel {
+        EXCESSIVE = 0,
+        MSGDUMP = 1,
+        DEBUG = 2,
+        INFO = 3,
+        WARNING = 4,
+        ERROR = 5,
+    }
+
+    /**
+     * Set debug parameters for the supplicant.
+     *
+     * @param level Debug logging level for the supplicant.
+     * @param showKeys Determines whether to show keys in the logs.
+     *        CAUTION: Do not enable this param in production code!
+     * @throws ServiceSpecificException with one of the following values:
+     *         |SupplicantStatusCode.FAILURE_UNKNOWN|
+     */
+    void setDebugParams(DebugLevel level, boolean showKeys);
 }
diff --git a/apex/Android.bp b/apex/Android.bp
index 614777e5dd..7601701857 100644
--- a/apex/Android.bp
+++ b/apex/Android.bp
@@ -60,6 +60,10 @@ apex {
     name: "com.android.wifi",
     defaults: ["com.android.wifi-defaults"],
     manifest: "apex_manifest.json",
+    licenses: [
+        "Android-Apache-2.0",
+        "opensourcerequest",
+    ],
 }
 
 apex_key {
diff --git a/flags/wifi_flags.aconfig b/flags/wifi_flags.aconfig
index edaf96cd37..eb87d00157 100644
--- a/flags/wifi_flags.aconfig
+++ b/flags/wifi_flags.aconfig
@@ -282,3 +282,69 @@ flag {
     bug: "390257834"
     is_fixed_read_only: true
 }
+
+flag {
+    name: "wifi_lock_activated_by_p2p_or_aware"
+    namespace: "wifi"
+    description: "Allow some apps to activate a WifiLock if a P2P or Aware connection is active"
+    bug: "404950833"
+}
+
+flag {
+    name: "updated_tofu_dialog"
+    namespace: "wifi"
+    description: "Update the TOFU dialog with more information"
+    bug: "276778134"
+}
+
+flag {
+    name: "un_deprecated_wificonfiguration"
+    is_exported: true
+    namespace: "wifi"
+    description: "un-deprecated wifi configurations."
+    bug: "412519144"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "multi_user_wifi_enhancement"
+    is_exported: true
+    namespace: "wifi"
+    description: "Giving each user control over their own Wi-Fi settings and configurations."
+    bug: "394417020"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "public_ssid_bssid_passphrase_for_do_carrier_tethering"
+    is_exported: true
+    namespace: "wifi"
+    description: "Public setSsid, setPassphrase, and setBssid for DO/Carrier app tethering"
+    bug: "399543884"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "icm_dialog_timeout"
+    namespace: "wifi"
+    description: "Timeout for InterfaceConflictManager dialogs."
+    bug: "416621831"
+}
+
+flag {
+    name: "band_optimization_control"
+    is_exported: true
+    namespace: "wifi"
+    description: "Caller can force softap ap band to bypass the frameworks auto appends bands feature."
+    bug: "403649308"
+    is_fixed_read_only: true
+}
+
+flag {
+    name: "get_config_empty_reason"
+    is_exported: true
+    namespace: "wifi"
+    description: "provide a detail when getting configs, not just empty list in error case"
+    bug: "404558943"
+    is_fixed_read_only: true
+}
diff --git a/framework/api/current.txt b/framework/api/current.txt
index c8d8685bf8..74462c3e25 100644
--- a/framework/api/current.txt
+++ b/framework/api/current.txt
@@ -147,7 +147,10 @@ package android.net.wifi {
   @FlaggedApi("com.android.wifi.flags.public_bands_for_lohs") public static final class SoftApConfiguration.Builder {
     ctor public SoftApConfiguration.Builder();
     method @NonNull public android.net.wifi.SoftApConfiguration build();
+    method @FlaggedApi("com.android.wifi.flags.public_ssid_bssid_passphrase_for_do_carrier_tethering") @NonNull @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_STACK, android.Manifest.permission.TETHER_PRIVILEGED, android.net.NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK}, conditional=true) public android.net.wifi.SoftApConfiguration.Builder setBssid(@Nullable android.net.MacAddress);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setChannels(@NonNull android.util.SparseIntArray);
+    method @FlaggedApi("com.android.wifi.flags.public_ssid_bssid_passphrase_for_do_carrier_tethering") @NonNull public android.net.wifi.SoftApConfiguration.Builder setPassphrase(@Nullable String, int);
+    method @FlaggedApi("com.android.wifi.flags.public_ssid_bssid_passphrase_for_do_carrier_tethering") @NonNull public android.net.wifi.SoftApConfiguration.Builder setWifiSsid(@Nullable android.net.wifi.WifiSsid);
   }
 
   public enum SupplicantState implements android.os.Parcelable {
@@ -185,134 +188,136 @@ package android.net.wifi {
     field public static final int OP_MODE_WIFI_DIRECT_GO = 8; // 0x8
   }
 
-  @Deprecated public class WifiConfiguration implements android.os.Parcelable {
-    ctor @Deprecated public WifiConfiguration();
-    ctor @Deprecated public WifiConfiguration(@NonNull android.net.wifi.WifiConfiguration);
-    method @Deprecated public int describeContents();
-    method @Deprecated public android.net.ProxyInfo getHttpProxy();
-    method @Deprecated @NonNull public String getKey();
-    method @Deprecated public int getMacRandomizationSetting();
-    method @Deprecated @NonNull public android.net.MacAddress getRandomizedMacAddress();
-    method @Deprecated public boolean isDppConfigurator();
-    method @Deprecated public boolean isPasspoint();
-    method @Deprecated public void setHttpProxy(android.net.ProxyInfo);
-    method @Deprecated public void setIpConfiguration(@Nullable android.net.IpConfiguration);
-    method @Deprecated public void setMacRandomizationSetting(int);
-    method @Deprecated public void setSecurityParams(int);
-    method @Deprecated public void writeToParcel(android.os.Parcel, int);
-    field @Deprecated public String BSSID;
-    field @Deprecated public String FQDN;
-    field @Deprecated public static final int RANDOMIZATION_AUTO = 3; // 0x3
-    field @Deprecated public static final int RANDOMIZATION_NONE = 0; // 0x0
-    field @Deprecated public static final int RANDOMIZATION_NON_PERSISTENT = 2; // 0x2
-    field @Deprecated public static final int RANDOMIZATION_PERSISTENT = 1; // 0x1
-    field @Deprecated public static final int SECURITY_TYPE_DPP = 13; // 0xd
-    field @Deprecated public static final int SECURITY_TYPE_EAP = 3; // 0x3
+  @FlaggedApi("com.android.wifi.flags.un_deprecated_wificonfiguration") public class WifiConfiguration implements android.os.Parcelable {
+    ctor public WifiConfiguration();
+    ctor public WifiConfiguration(@NonNull android.net.wifi.WifiConfiguration);
+    method public int describeContents();
+    method public android.net.ProxyInfo getHttpProxy();
+    method @NonNull public String getKey();
+    method public int getMacRandomizationSetting();
+    method @NonNull public android.net.MacAddress getRandomizedMacAddress();
+    method @FlaggedApi("com.android.wifi.flags.multi_user_wifi_enhancement") public boolean isAllowedToUpdateByOtherUsers();
+    method public boolean isDppConfigurator();
+    method public boolean isPasspoint();
+    method @FlaggedApi("com.android.wifi.flags.multi_user_wifi_enhancement") public void setAllowedToUpdateByOtherUsers(boolean);
+    method public void setHttpProxy(android.net.ProxyInfo);
+    method public void setIpConfiguration(@Nullable android.net.IpConfiguration);
+    method public void setMacRandomizationSetting(int);
+    method public void setSecurityParams(int);
+    method public void writeToParcel(android.os.Parcel, int);
+    field public String BSSID;
+    field public String FQDN;
+    field public static final int RANDOMIZATION_AUTO = 3; // 0x3
+    field public static final int RANDOMIZATION_NONE = 0; // 0x0
+    field public static final int RANDOMIZATION_NON_PERSISTENT = 2; // 0x2
+    field public static final int RANDOMIZATION_PERSISTENT = 1; // 0x1
+    field public static final int SECURITY_TYPE_DPP = 13; // 0xd
+    field public static final int SECURITY_TYPE_EAP = 3; // 0x3
     field @Deprecated public static final int SECURITY_TYPE_EAP_SUITE_B = 5; // 0x5
-    field @Deprecated public static final int SECURITY_TYPE_EAP_WPA3_ENTERPRISE = 9; // 0x9
-    field @Deprecated public static final int SECURITY_TYPE_EAP_WPA3_ENTERPRISE_192_BIT = 5; // 0x5
-    field @Deprecated public static final int SECURITY_TYPE_OPEN = 0; // 0x0
-    field @Deprecated public static final int SECURITY_TYPE_OWE = 6; // 0x6
-    field @Deprecated public static final int SECURITY_TYPE_PSK = 2; // 0x2
-    field @Deprecated public static final int SECURITY_TYPE_SAE = 4; // 0x4
-    field @Deprecated public static final int SECURITY_TYPE_WAPI_CERT = 8; // 0x8
-    field @Deprecated public static final int SECURITY_TYPE_WAPI_PSK = 7; // 0x7
-    field @Deprecated public static final int SECURITY_TYPE_WEP = 1; // 0x1
-    field @Deprecated public String SSID;
-    field @Deprecated @NonNull public java.util.BitSet allowedAuthAlgorithms;
-    field @Deprecated @NonNull public java.util.BitSet allowedGroupCiphers;
-    field @Deprecated @NonNull public java.util.BitSet allowedGroupManagementCiphers;
-    field @Deprecated @NonNull public java.util.BitSet allowedKeyManagement;
-    field @Deprecated @NonNull public java.util.BitSet allowedPairwiseCiphers;
-    field @Deprecated @NonNull public java.util.BitSet allowedProtocols;
-    field @Deprecated @NonNull public java.util.BitSet allowedSuiteBCiphers;
-    field @Deprecated public android.net.wifi.WifiEnterpriseConfig enterpriseConfig;
-    field @Deprecated public boolean hiddenSSID;
-    field @Deprecated public boolean isHomeProviderNetwork;
-    field @Deprecated public int networkId;
-    field @Deprecated public String preSharedKey;
+    field public static final int SECURITY_TYPE_EAP_WPA3_ENTERPRISE = 9; // 0x9
+    field public static final int SECURITY_TYPE_EAP_WPA3_ENTERPRISE_192_BIT = 5; // 0x5
+    field public static final int SECURITY_TYPE_OPEN = 0; // 0x0
+    field public static final int SECURITY_TYPE_OWE = 6; // 0x6
+    field public static final int SECURITY_TYPE_PSK = 2; // 0x2
+    field public static final int SECURITY_TYPE_SAE = 4; // 0x4
+    field public static final int SECURITY_TYPE_WAPI_CERT = 8; // 0x8
+    field public static final int SECURITY_TYPE_WAPI_PSK = 7; // 0x7
+    field public static final int SECURITY_TYPE_WEP = 1; // 0x1
+    field public String SSID;
+    field @NonNull public java.util.BitSet allowedAuthAlgorithms;
+    field @NonNull public java.util.BitSet allowedGroupCiphers;
+    field @NonNull public java.util.BitSet allowedGroupManagementCiphers;
+    field @NonNull public java.util.BitSet allowedKeyManagement;
+    field @NonNull public java.util.BitSet allowedPairwiseCiphers;
+    field @NonNull public java.util.BitSet allowedProtocols;
+    field @NonNull public java.util.BitSet allowedSuiteBCiphers;
+    field public android.net.wifi.WifiEnterpriseConfig enterpriseConfig;
+    field public boolean hiddenSSID;
+    field public boolean isHomeProviderNetwork;
+    field public int networkId;
+    field public String preSharedKey;
     field @Deprecated public int priority;
-    field @Deprecated public String providerFriendlyName;
-    field @Deprecated public long[] roamingConsortiumIds;
-    field @Deprecated public int status;
+    field public String providerFriendlyName;
+    field public long[] roamingConsortiumIds;
+    field public int status;
     field @Deprecated public String[] wepKeys;
     field @Deprecated public int wepTxKeyIndex;
   }
 
-  @Deprecated public static class WifiConfiguration.AuthAlgorithm {
-    field @Deprecated public static final int LEAP = 2; // 0x2
-    field @Deprecated public static final int OPEN = 0; // 0x0
-    field @Deprecated public static final int SAE = 3; // 0x3
+  public static class WifiConfiguration.AuthAlgorithm {
+    field public static final int LEAP = 2; // 0x2
+    field public static final int OPEN = 0; // 0x0
+    field public static final int SAE = 3; // 0x3
     field @Deprecated public static final int SHARED = 1; // 0x1
-    field @Deprecated public static final String[] strings;
-    field @Deprecated public static final String varName = "auth_alg";
+    field public static final String[] strings;
+    field public static final String varName = "auth_alg";
   }
 
-  @Deprecated public static class WifiConfiguration.GroupCipher {
-    field @Deprecated public static final int CCMP = 3; // 0x3
-    field @Deprecated public static final int GCMP_128 = 7; // 0x7
-    field @Deprecated public static final int GCMP_256 = 5; // 0x5
-    field @Deprecated public static final int SMS4 = 6; // 0x6
-    field @Deprecated public static final int TKIP = 2; // 0x2
+  public static class WifiConfiguration.GroupCipher {
+    field public static final int CCMP = 3; // 0x3
+    field public static final int GCMP_128 = 7; // 0x7
+    field public static final int GCMP_256 = 5; // 0x5
+    field public static final int SMS4 = 6; // 0x6
+    field public static final int TKIP = 2; // 0x2
     field @Deprecated public static final int WEP104 = 1; // 0x1
     field @Deprecated public static final int WEP40 = 0; // 0x0
-    field @Deprecated public static final String[] strings;
-    field @Deprecated public static final String varName = "group";
-  }
-
-  @Deprecated public static class WifiConfiguration.GroupMgmtCipher {
-    field @Deprecated public static final int BIP_CMAC_256 = 0; // 0x0
-    field @Deprecated public static final int BIP_GMAC_128 = 1; // 0x1
-    field @Deprecated public static final int BIP_GMAC_256 = 2; // 0x2
-  }
-
-  @Deprecated public static class WifiConfiguration.KeyMgmt {
-    field @Deprecated public static final int DPP = 17; // 0x11
-    field @Deprecated public static final int FILS_SHA256 = 15; // 0xf
-    field @Deprecated public static final int FILS_SHA384 = 16; // 0x10
-    field @Deprecated public static final int FT_EAP = 7; // 0x7
-    field @Deprecated public static final int FT_PSK = 6; // 0x6
-    field @Deprecated public static final int IEEE8021X = 3; // 0x3
-    field @Deprecated public static final int NONE = 0; // 0x0
-    field @Deprecated public static final int OSEN = 5; // 0x5
-    field @Deprecated public static final int OWE = 9; // 0x9
-    field @Deprecated public static final int SAE = 8; // 0x8
-    field @Deprecated public static final int SUITE_B_192 = 10; // 0xa
-    field @Deprecated public static final int WAPI_CERT = 14; // 0xe
-    field @Deprecated public static final int WAPI_PSK = 13; // 0xd
-    field @Deprecated public static final int WPA2_PSK = 4; // 0x4
-    field @Deprecated public static final int WPA_EAP = 2; // 0x2
-    field @Deprecated public static final int WPA_EAP_SHA256 = 12; // 0xc
-    field @Deprecated public static final int WPA_PSK = 1; // 0x1
-    field @Deprecated public static final int WPA_PSK_SHA256 = 11; // 0xb
-    field @Deprecated public static final String[] strings;
-    field @Deprecated public static final String varName = "key_mgmt";
-  }
-
-  @Deprecated public static class WifiConfiguration.PairwiseCipher {
-    field @Deprecated public static final int CCMP = 2; // 0x2
-    field @Deprecated public static final int GCMP_128 = 5; // 0x5
-    field @Deprecated public static final int GCMP_256 = 3; // 0x3
-    field @Deprecated public static final int NONE = 0; // 0x0
-    field @Deprecated public static final int SMS4 = 4; // 0x4
+    field public static final String[] strings;
+    field public static final String varName = "group";
+  }
+
+  public static class WifiConfiguration.GroupMgmtCipher {
+    field public static final int BIP_CMAC_256 = 0; // 0x0
+    field public static final int BIP_GMAC_128 = 1; // 0x1
+    field public static final int BIP_GMAC_256 = 2; // 0x2
+  }
+
+  public static class WifiConfiguration.KeyMgmt {
+    field public static final int DPP = 17; // 0x11
+    field public static final int FILS_SHA256 = 15; // 0xf
+    field public static final int FILS_SHA384 = 16; // 0x10
+    field public static final int FT_EAP = 7; // 0x7
+    field public static final int FT_PSK = 6; // 0x6
+    field public static final int IEEE8021X = 3; // 0x3
+    field public static final int NONE = 0; // 0x0
+    field public static final int OSEN = 5; // 0x5
+    field public static final int OWE = 9; // 0x9
+    field public static final int SAE = 8; // 0x8
+    field public static final int SUITE_B_192 = 10; // 0xa
+    field public static final int WAPI_CERT = 14; // 0xe
+    field public static final int WAPI_PSK = 13; // 0xd
+    field public static final int WPA2_PSK = 4; // 0x4
+    field public static final int WPA_EAP = 2; // 0x2
+    field public static final int WPA_EAP_SHA256 = 12; // 0xc
+    field public static final int WPA_PSK = 1; // 0x1
+    field public static final int WPA_PSK_SHA256 = 11; // 0xb
+    field public static final String[] strings;
+    field public static final String varName = "key_mgmt";
+  }
+
+  public static class WifiConfiguration.PairwiseCipher {
+    field public static final int CCMP = 2; // 0x2
+    field public static final int GCMP_128 = 5; // 0x5
+    field public static final int GCMP_256 = 3; // 0x3
+    field public static final int NONE = 0; // 0x0
+    field public static final int SMS4 = 4; // 0x4
     field @Deprecated public static final int TKIP = 1; // 0x1
-    field @Deprecated public static final String[] strings;
-    field @Deprecated public static final String varName = "pairwise";
+    field public static final String[] strings;
+    field public static final String varName = "pairwise";
   }
 
-  @Deprecated public static class WifiConfiguration.Protocol {
-    field @Deprecated public static final int RSN = 1; // 0x1
-    field @Deprecated public static final int WAPI = 3; // 0x3
+  public static class WifiConfiguration.Protocol {
+    field public static final int RSN = 1; // 0x1
+    field public static final int WAPI = 3; // 0x3
     field @Deprecated public static final int WPA = 0; // 0x0
-    field @Deprecated public static final String[] strings;
-    field @Deprecated public static final String varName = "proto";
+    field public static final String[] strings;
+    field public static final String varName = "proto";
   }
 
-  @Deprecated public static class WifiConfiguration.Status {
-    field @Deprecated public static final int CURRENT = 0; // 0x0
-    field @Deprecated public static final int DISABLED = 1; // 0x1
-    field @Deprecated public static final int ENABLED = 2; // 0x2
-    field @Deprecated public static final String[] strings;
+  public static class WifiConfiguration.Status {
+    field public static final int CURRENT = 0; // 0x0
+    field public static final int DISABLED = 1; // 0x1
+    field public static final int ENABLED = 2; // 0x2
+    field public static final String[] strings;
   }
 
   public class WifiEnterpriseConfig implements android.os.Parcelable {
@@ -578,7 +583,7 @@ package android.net.wifi {
     method @RequiresPermission(android.Manifest.permission.ACCESS_WIFI_STATE) public void unregisterScanResultsCallback(@NonNull android.net.wifi.WifiManager.ScanResultsCallback);
     method @RequiresPermission(android.Manifest.permission.ACCESS_WIFI_STATE) public void unregisterSubsystemRestartTrackingCallback(@NonNull android.net.wifi.WifiManager.SubsystemRestartTrackingCallback);
     method @Deprecated public int updateNetwork(android.net.wifi.WifiConfiguration);
-    method public boolean validateSoftApConfiguration(@NonNull android.net.wifi.SoftApConfiguration);
+    method @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_STACK, android.net.NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK}, conditional=true) public boolean validateSoftApConfiguration(@NonNull android.net.wifi.SoftApConfiguration);
     field public static final String ACTION_PICK_WIFI_NETWORK = "android.net.wifi.PICK_WIFI_NETWORK";
     field public static final int ACTION_REMOVE_SUGGESTION_DISCONNECT = 2; // 0x2
     field public static final int ACTION_REMOVE_SUGGESTION_LINGER = 1; // 0x1
diff --git a/framework/api/system-current.txt b/framework/api/system-current.txt
index 937fbe95bc..1c59193ba1 100644
--- a/framework/api/system-current.txt
+++ b/framework/api/system-current.txt
@@ -497,6 +497,7 @@ package android.net.wifi {
     method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @NonNull public java.util.List<android.net.wifi.OuiKeyedData> getVendorData();
     method @NonNull public java.util.List<android.net.wifi.ScanResult.InformationElement> getVendorElements();
     method public boolean isAutoShutdownEnabled();
+    method @FlaggedApi("com.android.wifi.flags.band_optimization_control") public boolean isBandOptimizationEnabled();
     method public boolean isBridgedModeOpportunisticShutdownEnabled();
     method public boolean isClientControlByUserEnabled();
     method @FlaggedApi("com.android.wifi.flags.ap_isolate") public boolean isClientIsolationEnabled();
@@ -517,11 +518,11 @@ package android.net.wifi {
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setAllowedClientList(@NonNull java.util.List<android.net.MacAddress>);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setAutoShutdownEnabled(boolean);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBand(int);
+    method @FlaggedApi("com.android.wifi.flags.band_optimization_control") @NonNull public android.net.wifi.SoftApConfiguration.Builder setBandOptimizationEnabled(boolean);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBands(@NonNull int[]);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBlockedClientList(@NonNull java.util.List<android.net.MacAddress>);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBridgedModeOpportunisticShutdownEnabled(boolean);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBridgedModeOpportunisticShutdownTimeoutMillis(@IntRange(from=0xffffffff) long);
-    method @NonNull public android.net.wifi.SoftApConfiguration.Builder setBssid(@Nullable android.net.MacAddress);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setChannel(int, int);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setClientControlByUserEnabled(boolean);
     method @FlaggedApi("com.android.wifi.flags.ap_isolate") @NonNull public android.net.wifi.SoftApConfiguration.Builder setClientIsolationEnabled(boolean);
@@ -531,12 +532,10 @@ package android.net.wifi {
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setMacRandomizationSetting(int);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setMaxChannelBandwidth(int);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setMaxNumberOfClients(@IntRange(from=0) int);
-    method @NonNull public android.net.wifi.SoftApConfiguration.Builder setPassphrase(@Nullable String, int);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setShutdownTimeoutMillis(@IntRange(from=0xffffffff) long);
     method @Deprecated @NonNull public android.net.wifi.SoftApConfiguration.Builder setSsid(@Nullable String);
     method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @NonNull public android.net.wifi.SoftApConfiguration.Builder setVendorData(@NonNull java.util.List<android.net.wifi.OuiKeyedData>);
     method @NonNull public android.net.wifi.SoftApConfiguration.Builder setVendorElements(@NonNull java.util.List<android.net.wifi.ScanResult.InformationElement>);
-    method @NonNull public android.net.wifi.SoftApConfiguration.Builder setWifiSsid(@Nullable android.net.wifi.WifiSsid);
   }
 
   public final class SoftApInfo implements android.os.Parcelable {
@@ -596,110 +595,110 @@ package android.net.wifi {
     field @NonNull public static final android.os.Parcelable.Creator<android.net.wifi.WifiClient> CREATOR;
   }
 
-  @Deprecated public class WifiConfiguration implements android.os.Parcelable {
-    method @Deprecated @NonNull public java.util.Set<java.lang.String> getAllNetworkKeys();
-    method @Deprecated public int getAuthType();
-    method @Deprecated @Nullable public java.util.List<android.net.MacAddress> getBssidAllowlist();
-    method @Deprecated public int getDeletionPriority();
-    method @Deprecated @NonNull public byte[] getDppCSignKey();
-    method @Deprecated @NonNull public byte[] getDppConnector();
-    method @Deprecated @NonNull public byte[] getDppNetAccessKey();
-    method @Deprecated @NonNull public byte[] getDppPrivateEcKey();
-    method @Deprecated @NonNull public android.net.IpConfiguration getIpConfiguration();
-    method @Deprecated @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus getNetworkSelectionStatus();
-    method @Deprecated @NonNull public String getPrintableSsid();
-    method @Deprecated @NonNull public String getProfileKey();
-    method @Deprecated public int getRecentFailureReason();
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @NonNull public java.util.List<android.net.wifi.OuiKeyedData> getVendorData();
-    method @Deprecated public boolean hasNoInternetAccess();
-    method @Deprecated public boolean isEphemeral();
-    method @Deprecated public static boolean isMetered(@Nullable android.net.wifi.WifiConfiguration, @Nullable android.net.wifi.WifiInfo);
-    method @Deprecated public boolean isNoInternetAccessExpected();
-    method @Deprecated public boolean isRepeaterEnabled();
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public boolean isSendDhcpHostnameEnabled();
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public boolean isWifi7Enabled();
-    method @Deprecated public void setBssidAllowlist(@Nullable java.util.List<android.net.MacAddress>);
-    method @Deprecated public void setDeletionPriority(int) throws java.lang.IllegalArgumentException;
-    method @Deprecated public void setNetworkSelectionStatus(@NonNull android.net.wifi.WifiConfiguration.NetworkSelectionStatus);
-    method @Deprecated @RequiresPermission(android.Manifest.permission.NETWORK_SETTINGS) public void setRepeaterEnabled(boolean);
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD}) public void setSendDhcpHostnameEnabled(boolean);
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public void setVendorData(@NonNull java.util.List<android.net.wifi.OuiKeyedData>);
-    method @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public void setWifi7Enabled(boolean);
-    field @Deprecated @NonNull public static final android.os.Parcelable.Creator<android.net.wifi.WifiConfiguration> CREATOR;
-    field @Deprecated public static final int INVALID_NETWORK_ID = -1; // 0xffffffff
-    field @Deprecated public static final int METERED_OVERRIDE_METERED = 1; // 0x1
-    field @Deprecated public static final int METERED_OVERRIDE_NONE = 0; // 0x0
-    field @Deprecated public static final int METERED_OVERRIDE_NOT_METERED = 2; // 0x2
-    field @Deprecated public static final int RECENT_FAILURE_AP_UNABLE_TO_HANDLE_NEW_STA = 17; // 0x11
-    field @Deprecated public static final int RECENT_FAILURE_DISCONNECTION_AP_BUSY = 1004; // 0x3ec
-    field @Deprecated public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_AIR_INTERFACE_OVERLOADED = 1007; // 0x3ef
-    field @Deprecated public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_AUTH_SERVER_OVERLOADED = 1008; // 0x3f0
-    field @Deprecated public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_INSUFFICIENT_RSSI = 1009; // 0x3f1
-    field @Deprecated public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_MAX_NUM_STA_ASSOCIATED = 1006; // 0x3ee
-    field @Deprecated public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_UNSPECIFIED = 1005; // 0x3ed
-    field @Deprecated public static final int RECENT_FAILURE_NETWORK_NOT_FOUND = 1011; // 0x3f3
-    field @Deprecated public static final int RECENT_FAILURE_NONE = 0; // 0x0
-    field @Deprecated public static final int RECENT_FAILURE_OCE_RSSI_BASED_ASSOCIATION_REJECTION = 1010; // 0x3f2
-    field @Deprecated public static final int RECENT_FAILURE_POOR_CHANNEL_CONDITIONS = 1003; // 0x3eb
-    field @Deprecated public static final int RECENT_FAILURE_REFUSED_TEMPORARILY = 1002; // 0x3ea
-    field @Deprecated public boolean allowAutojoin;
-    field @Deprecated public int carrierId;
-    field @Deprecated public boolean carrierMerged;
-    field @Deprecated public String creatorName;
-    field @Deprecated public int creatorUid;
-    field @Deprecated public boolean fromWifiNetworkSpecifier;
-    field @Deprecated public boolean fromWifiNetworkSuggestion;
-    field @Deprecated public int lastConnectUid;
-    field @Deprecated public long lastConnected;
-    field @Deprecated public String lastUpdateName;
-    field @Deprecated public int lastUpdateUid;
-    field @Deprecated public int macRandomizationSetting;
-    field @Deprecated public boolean meteredHint;
-    field @Deprecated public int meteredOverride;
-    field @Deprecated public int numAssociation;
-    field @Deprecated public int numRebootsSinceLastUse;
-    field @Deprecated public int numScorerOverride;
-    field @Deprecated public int numScorerOverrideAndSwitchedNetwork;
-    field @Deprecated public boolean requirePmf;
-    field @Deprecated public boolean shared;
-    field @Deprecated public int subscriptionId;
-    field @Deprecated public boolean useExternalScores;
-  }
-
-  @Deprecated public static class WifiConfiguration.NetworkSelectionStatus {
-    method @Deprecated public int getDisableReasonCounter(int);
-    method @Deprecated public long getDisableTime();
-    method @Deprecated public static int getMaxNetworkSelectionDisableReason();
-    method @Deprecated public int getNetworkSelectionDisableReason();
-    method @Deprecated @Nullable public static String getNetworkSelectionDisableReasonString(int);
-    method @Deprecated public int getNetworkSelectionStatus();
-    method @Deprecated @NonNull public String getNetworkStatusString();
-    method @Deprecated public boolean hasEverConnected();
-    field @Deprecated public static final int DISABLED_ASSOCIATION_REJECTION = 1; // 0x1
-    field @Deprecated public static final int DISABLED_AUTHENTICATION_FAILURE = 2; // 0x2
-    field @Deprecated public static final int DISABLED_AUTHENTICATION_NO_CREDENTIALS = 5; // 0x5
-    field @Deprecated public static final int DISABLED_AUTHENTICATION_NO_SUBSCRIPTION = 9; // 0x9
-    field @Deprecated public static final int DISABLED_AUTHENTICATION_PRIVATE_EAP_ERROR = 10; // 0xa
-    field @Deprecated public static final int DISABLED_BY_WIFI_MANAGER = 7; // 0x7
-    field @Deprecated public static final int DISABLED_BY_WRONG_PASSWORD = 8; // 0x8
-    field @Deprecated public static final int DISABLED_CONSECUTIVE_FAILURES = 12; // 0xc
-    field @Deprecated public static final int DISABLED_DHCP_FAILURE = 3; // 0x3
-    field @Deprecated public static final int DISABLED_NETWORK_NOT_FOUND = 11; // 0xb
-    field @Deprecated public static final int DISABLED_NONE = 0; // 0x0
-    field @Deprecated public static final int DISABLED_NO_INTERNET_PERMANENT = 6; // 0x6
-    field @Deprecated public static final int DISABLED_NO_INTERNET_TEMPORARY = 4; // 0x4
-    field @Deprecated public static final int DISABLED_TRANSITION_DISABLE_INDICATION = 13; // 0xd
-    field @Deprecated @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public static final int DISABLED_UNWANTED_LOW_RSSI = 14; // 0xe
-    field @Deprecated public static final int NETWORK_SELECTION_ENABLED = 0; // 0x0
-    field @Deprecated public static final int NETWORK_SELECTION_PERMANENTLY_DISABLED = 2; // 0x2
-    field @Deprecated public static final int NETWORK_SELECTION_TEMPORARY_DISABLED = 1; // 0x1
-  }
-
-  @Deprecated public static final class WifiConfiguration.NetworkSelectionStatus.Builder {
-    ctor @Deprecated public WifiConfiguration.NetworkSelectionStatus.Builder();
-    method @Deprecated @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus build();
-    method @Deprecated @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus.Builder setNetworkSelectionDisableReason(int);
-    method @Deprecated @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus.Builder setNetworkSelectionStatus(int);
+  @FlaggedApi("com.android.wifi.flags.un_deprecated_wificonfiguration") public class WifiConfiguration implements android.os.Parcelable {
+    method @NonNull public java.util.Set<java.lang.String> getAllNetworkKeys();
+    method public int getAuthType();
+    method @Nullable public java.util.List<android.net.MacAddress> getBssidAllowlist();
+    method public int getDeletionPriority();
+    method @NonNull public byte[] getDppCSignKey();
+    method @NonNull public byte[] getDppConnector();
+    method @NonNull public byte[] getDppNetAccessKey();
+    method @NonNull public byte[] getDppPrivateEcKey();
+    method @NonNull public android.net.IpConfiguration getIpConfiguration();
+    method @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus getNetworkSelectionStatus();
+    method @NonNull public String getPrintableSsid();
+    method @NonNull public String getProfileKey();
+    method public int getRecentFailureReason();
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @NonNull public java.util.List<android.net.wifi.OuiKeyedData> getVendorData();
+    method public boolean hasNoInternetAccess();
+    method public boolean isEphemeral();
+    method public static boolean isMetered(@Nullable android.net.wifi.WifiConfiguration, @Nullable android.net.wifi.WifiInfo);
+    method public boolean isNoInternetAccessExpected();
+    method public boolean isRepeaterEnabled();
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public boolean isSendDhcpHostnameEnabled();
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public boolean isWifi7Enabled();
+    method public void setBssidAllowlist(@Nullable java.util.List<android.net.MacAddress>);
+    method public void setDeletionPriority(int) throws java.lang.IllegalArgumentException;
+    method public void setNetworkSelectionStatus(@NonNull android.net.wifi.WifiConfiguration.NetworkSelectionStatus);
+    method @RequiresPermission(android.Manifest.permission.NETWORK_SETTINGS) public void setRepeaterEnabled(boolean);
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD}) public void setSendDhcpHostnameEnabled(boolean);
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public void setVendorData(@NonNull java.util.List<android.net.wifi.OuiKeyedData>);
+    method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public void setWifi7Enabled(boolean);
+    field @NonNull public static final android.os.Parcelable.Creator<android.net.wifi.WifiConfiguration> CREATOR;
+    field public static final int INVALID_NETWORK_ID = -1; // 0xffffffff
+    field public static final int METERED_OVERRIDE_METERED = 1; // 0x1
+    field public static final int METERED_OVERRIDE_NONE = 0; // 0x0
+    field public static final int METERED_OVERRIDE_NOT_METERED = 2; // 0x2
+    field public static final int RECENT_FAILURE_AP_UNABLE_TO_HANDLE_NEW_STA = 17; // 0x11
+    field public static final int RECENT_FAILURE_DISCONNECTION_AP_BUSY = 1004; // 0x3ec
+    field public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_AIR_INTERFACE_OVERLOADED = 1007; // 0x3ef
+    field public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_AUTH_SERVER_OVERLOADED = 1008; // 0x3f0
+    field public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_INSUFFICIENT_RSSI = 1009; // 0x3f1
+    field public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_MAX_NUM_STA_ASSOCIATED = 1006; // 0x3ee
+    field public static final int RECENT_FAILURE_MBO_ASSOC_DISALLOWED_UNSPECIFIED = 1005; // 0x3ed
+    field public static final int RECENT_FAILURE_NETWORK_NOT_FOUND = 1011; // 0x3f3
+    field public static final int RECENT_FAILURE_NONE = 0; // 0x0
+    field public static final int RECENT_FAILURE_OCE_RSSI_BASED_ASSOCIATION_REJECTION = 1010; // 0x3f2
+    field public static final int RECENT_FAILURE_POOR_CHANNEL_CONDITIONS = 1003; // 0x3eb
+    field public static final int RECENT_FAILURE_REFUSED_TEMPORARILY = 1002; // 0x3ea
+    field public boolean allowAutojoin;
+    field public int carrierId;
+    field public boolean carrierMerged;
+    field public String creatorName;
+    field public int creatorUid;
+    field public boolean fromWifiNetworkSpecifier;
+    field public boolean fromWifiNetworkSuggestion;
+    field public int lastConnectUid;
+    field public long lastConnected;
+    field public String lastUpdateName;
+    field public int lastUpdateUid;
+    field public int macRandomizationSetting;
+    field public boolean meteredHint;
+    field public int meteredOverride;
+    field public int numAssociation;
+    field public int numRebootsSinceLastUse;
+    field public int numScorerOverride;
+    field public int numScorerOverrideAndSwitchedNetwork;
+    field public boolean requirePmf;
+    field public boolean shared;
+    field public int subscriptionId;
+    field public boolean useExternalScores;
+  }
+
+  public static class WifiConfiguration.NetworkSelectionStatus {
+    method public int getDisableReasonCounter(int);
+    method public long getDisableTime();
+    method public static int getMaxNetworkSelectionDisableReason();
+    method public int getNetworkSelectionDisableReason();
+    method @Nullable public static String getNetworkSelectionDisableReasonString(int);
+    method public int getNetworkSelectionStatus();
+    method @NonNull public String getNetworkStatusString();
+    method public boolean hasEverConnected();
+    field public static final int DISABLED_ASSOCIATION_REJECTION = 1; // 0x1
+    field public static final int DISABLED_AUTHENTICATION_FAILURE = 2; // 0x2
+    field public static final int DISABLED_AUTHENTICATION_NO_CREDENTIALS = 5; // 0x5
+    field public static final int DISABLED_AUTHENTICATION_NO_SUBSCRIPTION = 9; // 0x9
+    field public static final int DISABLED_AUTHENTICATION_PRIVATE_EAP_ERROR = 10; // 0xa
+    field public static final int DISABLED_BY_WIFI_MANAGER = 7; // 0x7
+    field public static final int DISABLED_BY_WRONG_PASSWORD = 8; // 0x8
+    field public static final int DISABLED_CONSECUTIVE_FAILURES = 12; // 0xc
+    field public static final int DISABLED_DHCP_FAILURE = 3; // 0x3
+    field public static final int DISABLED_NETWORK_NOT_FOUND = 11; // 0xb
+    field public static final int DISABLED_NONE = 0; // 0x0
+    field public static final int DISABLED_NO_INTERNET_PERMANENT = 6; // 0x6
+    field public static final int DISABLED_NO_INTERNET_TEMPORARY = 4; // 0x4
+    field public static final int DISABLED_TRANSITION_DISABLE_INDICATION = 13; // 0xd
+    field @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public static final int DISABLED_UNWANTED_LOW_RSSI = 14; // 0xe
+    field public static final int NETWORK_SELECTION_ENABLED = 0; // 0x0
+    field public static final int NETWORK_SELECTION_PERMANENTLY_DISABLED = 2; // 0x2
+    field public static final int NETWORK_SELECTION_TEMPORARY_DISABLED = 1; // 0x1
+  }
+
+  public static final class WifiConfiguration.NetworkSelectionStatus.Builder {
+    ctor public WifiConfiguration.NetworkSelectionStatus.Builder();
+    method @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus build();
+    method @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus.Builder setNetworkSelectionDisableReason(int);
+    method @NonNull public android.net.wifi.WifiConfiguration.NetworkSelectionStatus.Builder setNetworkSelectionStatus(int);
   }
 
   public final class WifiConnectedSessionInfo implements android.os.Parcelable {
@@ -826,6 +825,7 @@ package android.net.wifi {
     method @RequiresPermission(android.Manifest.permission.MANAGE_DEVICE_ADMINS) public void notifyWifiSsidPolicyChanged(@NonNull android.app.admin.WifiSsidPolicy);
     method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") public void queryD2dAllowedWhenInfraStaDisabled(@NonNull java.util.concurrent.Executor, @NonNull java.util.function.Consumer<java.lang.Boolean>);
     method @Nullable @RequiresPermission(android.Manifest.permission.NETWORK_SETTINGS) public void queryLastConfiguredTetheredApPassphraseSinceBoot(@NonNull java.util.concurrent.Executor, @NonNull java.util.function.Consumer<java.lang.String>);
+    method @FlaggedApi("com.android.wifi.flags.get_config_empty_reason") @RequiresPermission(allOf={android.Manifest.permission.NEARBY_WIFI_DEVICES, android.Manifest.permission.READ_WIFI_CREDENTIAL}) public void queryPrivilegedConfiguredNetworks(@NonNull java.util.concurrent.Executor, @NonNull android.os.OutcomeReceiver<java.util.List<android.net.wifi.WifiConfiguration>,java.lang.Error>);
     method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD}) public void queryWepAllowed(@NonNull java.util.concurrent.Executor, @NonNull java.util.function.Consumer<java.lang.Boolean>);
     method @RequiresPermission(android.Manifest.permission.ACCESS_COARSE_LOCATION) public void registerActiveCountryCodeChangedCallback(@NonNull java.util.concurrent.Executor, @NonNull android.net.wifi.WifiManager.ActiveCountryCodeChangedCallback);
     method @RequiresPermission(android.Manifest.permission.WIFI_ACCESS_COEX_UNSAFE_CHANNELS) public void registerCoexCallback(@NonNull java.util.concurrent.Executor, @NonNull android.net.wifi.WifiManager.CoexCallback);
@@ -851,7 +851,7 @@ package android.net.wifi {
     method @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD, android.Manifest.permission.NETWORK_STACK}) public void save(@NonNull android.net.wifi.WifiConfiguration, @Nullable android.net.wifi.WifiManager.ActionListener);
     method @RequiresPermission(android.Manifest.permission.NETWORK_SETTINGS) public void setAutoWakeupEnabled(boolean);
     method @FlaggedApi("com.android.wifi.flags.autojoin_restriction_security_types_api") @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.MANAGE_WIFI_NETWORK_SELECTION}) public void setAutojoinDisallowedSecurityTypes(@NonNull int[]);
-    method @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD}) public void setCarrierNetworkOffloadEnabled(int, boolean, boolean);
+    method @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD, android.Manifest.permission.NETWORK_CARRIER_PROVISIONING}) public void setCarrierNetworkOffloadEnabled(int, boolean, boolean);
     method @RequiresPermission(android.Manifest.permission.WIFI_UPDATE_COEX_UNSAFE_CHANNELS) public void setCoexUnsafeChannels(@NonNull java.util.List<android.net.wifi.CoexUnsafeChannel>, int);
     method @FlaggedApi("com.android.wifi.flags.android_v_wifi_api") @RequiresPermission(anyOf={android.Manifest.permission.NETWORK_SETTINGS, android.Manifest.permission.NETWORK_SETUP_WIZARD}) public void setD2dAllowedWhenInfraStaDisabled(boolean);
     method @RequiresPermission(android.Manifest.permission.MANAGE_WIFI_COUNTRY_CODE) public void setDefaultCountryCode(@NonNull String);
diff --git a/framework/java/android/net/wifi/BatchedScanResult.java b/framework/java/android/net/wifi/BatchedScanResult.java
index ed8845dd2a..c965e940d3 100644
--- a/framework/java/android/net/wifi/BatchedScanResult.java
+++ b/framework/java/android/net/wifi/BatchedScanResult.java
@@ -16,9 +16,9 @@
 
 package android.net.wifi;
 
-import android.os.Parcelable;
 import android.annotation.SystemApi;
 import android.os.Parcel;
+import android.os.Parcelable;
 
 import java.util.ArrayList;
 import java.util.List;
diff --git a/framework/java/android/net/wifi/IPrivilegedConfiguredNetworksListener.aidl b/framework/java/android/net/wifi/IPrivilegedConfiguredNetworksListener.aidl
new file mode 100644
index 0000000000..4c60a6c18e
--- /dev/null
+++ b/framework/java/android/net/wifi/IPrivilegedConfiguredNetworksListener.aidl
@@ -0,0 +1,26 @@
+/*
+ * Copyright (C) 2025 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.net.wifi;
+
+import android.net.wifi.WifiConfiguration;
+import com.android.modules.utils.ParceledListSlice;
+
+/**
+ * @hide
+ */
+oneway interface IPrivilegedConfiguredNetworksListener {
+    void onResult(in ParceledListSlice<WifiConfiguration> configs, String errorMsg);
+}
diff --git a/framework/java/android/net/wifi/IWifiManager.aidl b/framework/java/android/net/wifi/IWifiManager.aidl
index 9e126e3c95..45b3753884 100644
--- a/framework/java/android/net/wifi/IWifiManager.aidl
+++ b/framework/java/android/net/wifi/IWifiManager.aidl
@@ -40,6 +40,7 @@ import android.net.wifi.IOnWifiActivityEnergyInfoListener;
 import android.net.wifi.IOnWifiDriverCountryCodeChangedListener;
 import android.net.wifi.IOnWifiUsabilityStatsListener;
 import android.net.wifi.IPnoScanResultsCallback;
+import android.net.wifi.IPrivilegedConfiguredNetworksListener;
 import android.net.wifi.IScanResultsCallback;
 import android.net.wifi.ISoftApCallback;
 import android.net.wifi.IStringListener;
@@ -556,6 +557,11 @@ interface IWifiManager {
 
     void storeCapturedData(int triggerType, boolean isFullCapture, long triggerStartTimeMillis,
             long triggerStopTimeMillis, in IIntegerListener listener);
+
     boolean isUsdSubscriberSupported();
+
     boolean isUsdPublisherSupported();
+
+    void queryPrivilegedConfiguredNetworks(
+            in IPrivilegedConfiguredNetworksListener listener, in Bundle extras);
 }
diff --git a/framework/java/android/net/wifi/SoftApConfiguration.java b/framework/java/android/net/wifi/SoftApConfiguration.java
index 086c816b71..cd0fe176e9 100644
--- a/framework/java/android/net/wifi/SoftApConfiguration.java
+++ b/framework/java/android/net/wifi/SoftApConfiguration.java
@@ -21,11 +21,14 @@ import android.annotation.IntDef;
 import android.annotation.IntRange;
 import android.annotation.NonNull;
 import android.annotation.Nullable;
+import android.annotation.RequiresPermission;
 import android.annotation.SystemApi;
 import android.app.compat.CompatChanges;
 import android.compat.annotation.ChangeId;
 import android.compat.annotation.EnabledAfter;
 import android.net.MacAddress;
+import android.net.NetworkStack;
+import android.net.TetheringManager;
 import android.net.wifi.util.Environment;
 import android.net.wifi.util.HexEncoding;
 import android.os.Build;
@@ -408,6 +411,12 @@ public final class SoftApConfiguration implements Parcelable {
      */
     private boolean mIsClientIsolationEnabled;
 
+    /**
+     * Whether the frameworks should do band settings optimization.
+     * (i.e. Auto appending 2.4G band to cover co-existence / country code restriction).
+     */
+    private boolean mIsBandOptimizationEnabled;
+
     /**
      * THe definition of security type OPEN.
      */
@@ -477,7 +486,8 @@ public final class SoftApConfiguration implements Parcelable {
             @NonNull Set<Integer> allowedAcsChannels6g,
             @WifiAnnotations.Bandwidth int maxChannelBandwidth,
             @Nullable List<OuiKeyedData> vendorData,
-            boolean isClientIsolationEnabled) {
+            boolean isClientIsolationEnabled,
+            boolean isBandOptimizationEnabled) {
         mWifiSsid = ssid;
         mBssid = bssid;
         mPassphrase = passphrase;
@@ -510,6 +520,7 @@ public final class SoftApConfiguration implements Parcelable {
         mMaxChannelBandwidth = maxChannelBandwidth;
         mVendorData = new ArrayList<>(vendorData);
         mIsClientIsolationEnabled = isClientIsolationEnabled;
+        mIsBandOptimizationEnabled = isBandOptimizationEnabled;
     }
 
     @Override
@@ -549,7 +560,8 @@ public final class SoftApConfiguration implements Parcelable {
                 && Objects.equals(mAllowedAcsChannels6g, other.mAllowedAcsChannels6g)
                 && mMaxChannelBandwidth == other.mMaxChannelBandwidth
                 && Objects.equals(mVendorData, other.mVendorData)
-                && mIsClientIsolationEnabled == other.mIsClientIsolationEnabled;
+                && mIsClientIsolationEnabled == other.mIsClientIsolationEnabled
+                && mIsBandOptimizationEnabled == other.mIsBandOptimizationEnabled;
     }
 
     @Override
@@ -580,7 +592,8 @@ public final class SoftApConfiguration implements Parcelable {
                 mAllowedAcsChannels6g,
                 mMaxChannelBandwidth,
                 mVendorData,
-                mIsClientIsolationEnabled);
+                mIsClientIsolationEnabled,
+                mIsBandOptimizationEnabled);
     }
 
     @Override
@@ -616,6 +629,7 @@ public final class SoftApConfiguration implements Parcelable {
         sbuf.append(" \n mMaxChannelBandwidth = ").append(mMaxChannelBandwidth);
         sbuf.append(" \n mVendorData = ").append(mVendorData);
         sbuf.append(" \n mIsClientIsolationEnabled = ").append(mIsClientIsolationEnabled);
+        sbuf.append(" \n mIsBandOptimizationEnabled = ").append(mIsBandOptimizationEnabled);
         return sbuf.toString();
     }
 
@@ -647,6 +661,7 @@ public final class SoftApConfiguration implements Parcelable {
         dest.writeInt(mMaxChannelBandwidth);
         dest.writeList(mVendorData);
         dest.writeBoolean(mIsClientIsolationEnabled);
+        dest.writeBoolean(mIsBandOptimizationEnabled);
     }
 
     /* Reference from frameworks/base/core/java/android/os/Parcel.java */
@@ -759,6 +774,7 @@ public final class SoftApConfiguration implements Parcelable {
                             readHashSetInt(in),
                             in.readInt(),
                             readOuiKeyedDataList(in),
+                            in.readBoolean(),
                             in.readBoolean());
                 }
 
@@ -1246,6 +1262,18 @@ public final class SoftApConfiguration implements Parcelable {
         return mIsClientIsolationEnabled;
     }
 
+    /**
+     * Returns whether the frameworks should do band settings optimization.
+     * (i.e. Auto appending 2.4G band to cover co-existence / country code restriction).
+     *
+     * @hide
+     */
+    @FlaggedApi(Flags.FLAG_BAND_OPTIMIZATION_CONTROL)
+    @SystemApi
+    public boolean isBandOptimizationEnabled() {
+        return mIsBandOptimizationEnabled;
+    }
+
     /**
      * Returns a {@link WifiConfiguration} representation of this {@link SoftApConfiguration}.
      * Note that SoftApConfiguration may contain configuration which is cannot be represented
@@ -1340,6 +1368,7 @@ public final class SoftApConfiguration implements Parcelable {
         private @WifiAnnotations.Bandwidth int mMaxChannelBandwidth;
         private @Nullable List<OuiKeyedData> mVendorData;
         private boolean mIsClientIsolationEnabled;
+        private boolean mIsBandOptimizationEnabled;
 
         /**
          * Constructs a Builder with default values (see {@link Builder}).
@@ -1376,6 +1405,7 @@ public final class SoftApConfiguration implements Parcelable {
             mMaxChannelBandwidth = SoftApInfo.CHANNEL_WIDTH_AUTO;
             mVendorData = new ArrayList<>();
             mIsClientIsolationEnabled = false;
+            mIsBandOptimizationEnabled = true; // enabled by default.
         }
 
         /**
@@ -1424,6 +1454,7 @@ public final class SoftApConfiguration implements Parcelable {
             }
             mVendorData = new ArrayList<>(other.mVendorData);
             mIsClientIsolationEnabled = other.mIsClientIsolationEnabled;
+            mIsBandOptimizationEnabled = other.mIsBandOptimizationEnabled;
         }
 
        /**
@@ -1462,7 +1493,8 @@ public final class SoftApConfiguration implements Parcelable {
                     mAllowedAcsChannels6g,
                     mMaxChannelBandwidth,
                     mVendorData,
-                    mIsClientIsolationEnabled);
+                    mIsClientIsolationEnabled,
+                    mIsBandOptimizationEnabled);
         }
 
         /**
@@ -1521,7 +1553,8 @@ public final class SoftApConfiguration implements Parcelable {
                     mAllowedAcsChannels6g,
                     mMaxChannelBandwidth,
                     mVendorData,
-                    mIsClientIsolationEnabled);
+                    mIsClientIsolationEnabled,
+                    mIsBandOptimizationEnabled);
         }
 
         /**
@@ -1565,12 +1598,10 @@ public final class SoftApConfiguration implements Parcelable {
          *
          * @param wifiSsid SSID, or null ot have the SSID automatically chosen by the framework.
          * @return Builder for chaining.
-         *
-         * @hide
          */
         @NonNull
         @RequiresApi(Build.VERSION_CODES.TIRAMISU)
-        @SystemApi
+        @FlaggedApi(Flags.FLAG_PUBLIC_SSID_BSSID_PASSPHRASE_FOR_DO_CARRIER_TETHERING)
         public Builder setWifiSsid(@Nullable WifiSsid wifiSsid) {
             if (!SdkLevel.isAtLeastT()) {
                 throw new UnsupportedOperationException();
@@ -1643,16 +1674,25 @@ public final class SoftApConfiguration implements Parcelable {
          * with {@link SoftApCapability.SOFTAP_FEATURE_MAC_ADDRESS_CUSTOMIZATION} to determine
          * whether or not this feature is supported.
          *
+         * <p>
+         * Callers without the listed permissions will not be able to start SoftAP with a non-null
+         * BSSID. DO and Carrier apps starting SoftAp with {@link TetheringManager#startTethering}
+         * are exempted from this permission restriction.
+         *
          * @param bssid BSSID, or null to have the BSSID chosen by the framework. The caller is
          *              responsible for avoiding collisions.
          * @return Builder for chaining.
-         * @throws IllegalArgumentException when the given BSSID is the all-zero
-         *                                  , multicast or broadcast MAC address.
-         *
-         * @hide
+         * @throws IllegalArgumentException when the given BSSID is the all-zero, multicast or
+         *                                  broadcast MAC address.
          */
         @NonNull
-        @SystemApi
+        @RequiresPermission(anyOf = {
+                android.Manifest.permission.NETWORK_SETTINGS,
+                android.Manifest.permission.NETWORK_STACK,
+                android.Manifest.permission.TETHER_PRIVILEGED,
+                NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK,
+        }, conditional = true)
+        @FlaggedApi(Flags.FLAG_PUBLIC_SSID_BSSID_PASSPHRASE_FOR_DO_CARRIER_TETHERING)
         public Builder setBssid(@Nullable MacAddress bssid) {
             if (bssid != null) {
                 Preconditions.checkArgument(!bssid.equals(WifiManager.ALL_ZEROS_MAC_ADDRESS));
@@ -1692,11 +1732,9 @@ public final class SoftApConfiguration implements Parcelable {
          *         when the passphrase is not between 8 and 63 bytes (inclusive) for
          *             - {@link #SECURITY_TYPE_WPA2_PSK}
          *             - {@link #SECURITY_TYPE_WPA3_SAE_TRANSITION}
-         *
-         * @hide
          */
         @NonNull
-        @SystemApi
+        @FlaggedApi(Flags.FLAG_PUBLIC_SSID_BSSID_PASSPHRASE_FOR_DO_CARRIER_TETHERING)
         public Builder setPassphrase(@Nullable String passphrase, @SecurityType int securityType) {
             if (!SdkLevel.isAtLeastT()
                     && (securityType == SECURITY_TYPE_WPA3_OWE_TRANSITION
@@ -2472,5 +2510,22 @@ public final class SoftApConfiguration implements Parcelable {
             mIsClientIsolationEnabled = isClientIsolationEnabled;
             return this;
         }
+
+        /**
+         * Specifies whether the frameworks should do band settings optimization.
+         * (i.e. Auto appending 2.4G band to cover co-existence / country code restriction)..
+         *
+         * @param isBandOptimizationEnabled true when enabling band settings optimization.
+         * @return Builder for chaining.
+         *
+         * @hide
+         */
+        @FlaggedApi(Flags.FLAG_BAND_OPTIMIZATION_CONTROL)
+        @NonNull
+        @SystemApi
+        public Builder setBandOptimizationEnabled(boolean isBandOptimizationEnabled) {
+            mIsBandOptimizationEnabled = isBandOptimizationEnabled;
+            return this;
+        }
     }
 }
diff --git a/framework/java/android/net/wifi/WifiConfiguration.java b/framework/java/android/net/wifi/WifiConfiguration.java
index 028756862c..8f058efbb0 100644
--- a/framework/java/android/net/wifi/WifiConfiguration.java
+++ b/framework/java/android/net/wifi/WifiConfiguration.java
@@ -32,6 +32,7 @@ import android.net.NetworkSpecifier;
 import android.net.ProxyInfo;
 import android.net.StaticIpConfiguration;
 import android.net.Uri;
+import android.net.wifi.util.Environment;
 import android.os.Build;
 import android.os.Parcel;
 import android.os.ParcelUuid;
@@ -73,12 +74,13 @@ import java.util.Set;
  * A class representing a configured Wi-Fi network, including the
  * security configuration.
  *
- * @deprecated Use {@link WifiNetworkSpecifier.Builder} to create {@link NetworkSpecifier} and
- * {@link WifiNetworkSuggestion.Builder} to create {@link WifiNetworkSuggestion}. This class can
- * still be used with privileged APIs such as
+ * Non privileged caller should use {@link WifiNetworkSpecifier.Builder}
+ * to create {@link NetworkSpecifier} and {@link WifiNetworkSuggestion.Builder}
+ * to create {@link WifiNetworkSuggestion}.
+ * This class can still be used with privileged APIs only such as
  * {@link WifiManager#addNetwork(WifiConfiguration)}.
  */
-@Deprecated
+@FlaggedApi(Flags.FLAG_UN_DEPRECATED_WIFICONFIGURATION)
 public class WifiConfiguration implements Parcelable {
     private static final String TAG = "WifiConfiguration";
     /**
@@ -1374,6 +1376,12 @@ public class WifiConfiguration implements Parcelable {
     @SystemApi
     public boolean shared;
 
+    /**
+     * True if this network configuration is allowed to be updated by other users
+     * on the same device, false otherwise.
+     */
+    private boolean mIsAllowedToUpdateByOtherUsers;
+
     /**
      * @hide
      */
@@ -3389,6 +3397,7 @@ public class WifiConfiguration implements Parcelable {
         mEncryptedPreSharedKeyIv = new byte[0];
         mIpProvisioningTimedOut = false;
         mVendorData = Collections.emptyList();
+        mIsAllowedToUpdateByOtherUsers = true;
     }
 
     /**
@@ -3724,7 +3733,9 @@ public class WifiConfiguration implements Parcelable {
         sbuf.append("\n");
         sbuf.append("IsDppConfigurator: ").append(this.mIsDppConfigurator).append("\n");
         sbuf.append("HasEncryptedPreSharedKey: ").append(hasEncryptedPreSharedKey()).append("\n");
-        sbuf.append(" setWifi7Enabled=").append(mWifi7Enabled);
+        sbuf.append(" setWifi7Enabled=").append(mWifi7Enabled).append("\n");
+        sbuf.append(" mIsAllowedToUpdateByOtherUsers=")
+                .append(mIsAllowedToUpdateByOtherUsers).append("\n");
         return sbuf.toString();
     }
 
@@ -4177,6 +4188,7 @@ public class WifiConfiguration implements Parcelable {
             mIpProvisioningTimedOut = source.mIpProvisioningTimedOut;
             mVendorData = new ArrayList<>(source.mVendorData);
             mWifi7Enabled = source.mWifi7Enabled;
+            mIsAllowedToUpdateByOtherUsers = source.mIsAllowedToUpdateByOtherUsers;
         }
     }
 
@@ -4277,6 +4289,7 @@ public class WifiConfiguration implements Parcelable {
         dest.writeBoolean(mIpProvisioningTimedOut);
         dest.writeList(mVendorData);
         dest.writeBoolean(mWifi7Enabled);
+        dest.writeBoolean(mIsAllowedToUpdateByOtherUsers);
     }
 
     /** Implement the Parcelable interface {@hide} */
@@ -4403,6 +4416,7 @@ public class WifiConfiguration implements Parcelable {
                     config.mIpProvisioningTimedOut = in.readBoolean();
                     config.mVendorData = ParcelUtil.readOuiKeyedDataList(in);
                     config.mWifi7Enabled = in.readBoolean();
+                    config.mIsAllowedToUpdateByOtherUsers = in.readBoolean();
                     return config;
                 }
 
@@ -4778,4 +4792,39 @@ public class WifiConfiguration implements Parcelable {
     public void setWifi7Enabled(boolean enabled) {
         mWifi7Enabled = enabled;
     }
+
+    /**
+     * Allows this network configuration to be updated by other users.
+     *
+     * @throws IllegalArgumentException when attempting to set a private ({@code shared} = false)
+     *                                  configuration to true
+     */
+    // TODO: b/394417020 - add @RequiresApi version as 2026 Q2 version
+    @RequiresApi(37)
+    @FlaggedApi(Flags.FLAG_MULTI_USER_WIFI_ENHANCEMENT)
+    public void setAllowedToUpdateByOtherUsers(boolean isAllowed) {
+        if (!Environment.isSdkNewerThanB()) {
+            throw new UnsupportedOperationException();
+        }
+        if (!shared && isAllowed) {
+            throw new IllegalArgumentException("private network can't update by other user");
+        }
+        mIsAllowedToUpdateByOtherUsers = isAllowed;
+    }
+
+    /**
+     * Whether this wifi configuration is allowed to be updated by other users.
+     * Returns false for private ({@code shared} = false) configurations.
+     *
+     * Note: The admin user still can remove this configuration even if the network is not allowed
+     * to be updated by other users.
+     */
+    @RequiresApi(37)
+    @FlaggedApi(Flags.FLAG_MULTI_USER_WIFI_ENHANCEMENT)
+    public boolean isAllowedToUpdateByOtherUsers() {
+        if (!Environment.isSdkNewerThanB()) {
+            throw new UnsupportedOperationException();
+        }
+        return shared && mIsAllowedToUpdateByOtherUsers;
+    }
 }
diff --git a/framework/java/android/net/wifi/WifiManager.java b/framework/java/android/net/wifi/WifiManager.java
index c642e04dc8..96d6002ddc 100644
--- a/framework/java/android/net/wifi/WifiManager.java
+++ b/framework/java/android/net/wifi/WifiManager.java
@@ -76,6 +76,7 @@ import android.os.Bundle;
 import android.os.Handler;
 import android.os.IBinder;
 import android.os.Looper;
+import android.os.OutcomeReceiver;
 import android.os.Parcel;
 import android.os.Parcelable;
 import android.os.RemoteException;
@@ -5919,10 +5920,21 @@ public class WifiManager {
 
     /**
      * Check if input configuration is valid.
-     *
+     * <p>
+     * This will return {@code false} if a non-null BSSID is set but the caller does not have any of
+     * <ul>
+     *     <li>{@link android.Manifest.permission.NETWORK_SETTINGS}</li>
+     *     <li>{@link android.Manifest.permission.NETWORK_STACK}</li>
+     *     <li>{@link NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK}</li>
+     * </ul>
      * @param config a configuration would like to be checked.
      * @return true if config is valid, otherwise false.
      */
+    @RequiresPermission(anyOf = {
+            android.Manifest.permission.NETWORK_SETTINGS,
+            android.Manifest.permission.NETWORK_STACK,
+            NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK
+    }, conditional = true)
     public boolean validateSoftApConfiguration(@NonNull SoftApConfiguration config) {
         if (config == null) {
             throw new IllegalArgumentException(TAG + ": config can not be null");
@@ -11159,7 +11171,8 @@ public class WifiManager {
     @SystemApi
     @RequiresPermission(anyOf = {
             android.Manifest.permission.NETWORK_SETTINGS,
-            android.Manifest.permission.NETWORK_SETUP_WIZARD})
+            android.Manifest.permission.NETWORK_SETUP_WIZARD,
+            android.Manifest.permission.NETWORK_CARRIER_PROVISIONING})
     public void setCarrierNetworkOffloadEnabled(int subscriptionId, boolean merged,
             boolean enabled) {
         try {
@@ -11622,21 +11635,21 @@ public class WifiManager {
 
     /**
      * DialogType for a simple dialog.
-     * @see {@link com.android.server.wifi.WifiDialogManager#createSimpleDialog}
+     * @see com.android.server.wifi.WifiDialogManager#createSimpleDialogBuilder
      * @hide
      */
     public static final int DIALOG_TYPE_SIMPLE = 1;
 
     /**
      * DialogType for a P2P Invitation Sent dialog.
-     * @see {@link com.android.server.wifi.WifiDialogManager#createP2pInvitationSentDialog}
+     * @see com.android.server.wifi.WifiDialogManager#createP2pInvitationSentDialog
      * @hide
      */
     public static final int DIALOG_TYPE_P2P_INVITATION_SENT = 2;
 
     /**
      * DialogType for a P2P Invitation Received dialog.
-     * @see {@link com.android.server.wifi.WifiDialogManager#createP2pInvitationReceivedDialog}
+     * @see com.android.server.wifi.WifiDialogManager#createP2pInvitationReceivedDialog
      * @hide
      */
     public static final int DIALOG_TYPE_P2P_INVITATION_RECEIVED = 3;
@@ -11740,6 +11753,20 @@ public class WifiManager {
     public static final String EXTRA_DIALOG_MESSAGE_URL_END =
             "android.net.wifi.extra.DIALOG_MESSAGE_URL_END";
 
+    /**
+     * Extra String indicating the labels for the list items of a simple dialog.
+     * @hide
+     */
+    public static final String EXTRA_DIALOG_LIST_LABELS =
+            "android.net.wifi.extra.EXTRA_DIALOG_LIST_LABELS";
+
+    /**
+     * Extra String indicating the contents for the list items of a simple dialog.
+     * @hide
+     */
+    public static final String EXTRA_DIALOG_LIST_CONTENTS =
+            "android.net.wifi.extra.EXTRA_DIALOG_LIST_CONTENTS";
+
     /**
      * Extra String indicating the positive button text of a simple dialog.
      * @hide
@@ -13305,4 +13332,55 @@ public class WifiManager {
             throw e.rethrowFromSystemServer();
         }
     }
+
+    /**
+     * Query the list of {@link WifiConfiguration} with credentials.
+     *
+     * <p> This API is similar to {@link #getPrivilegedConfiguredNetworks()}, but this new API
+     * is the async version of it.
+     *
+     * @param executor The executor on which callback will be invoked.
+     * @param resultsCallback An asynchronous callback that will return
+     *                        {@link OutcomeReceiver}
+     *
+     * @throws UnsupportedOperationException if the API is not supported on this SDK version.
+     * @throws SecurityException if the caller does not have permission.
+     *
+     * @hide
+     */
+    @FlaggedApi(Flags.FLAG_GET_CONFIG_EMPTY_REASON)
+    @RequiresApi(Build.VERSION_CODES.S)
+    @SystemApi
+    @RequiresPermission(allOf = {NEARBY_WIFI_DEVICES, READ_WIFI_CREDENTIAL})
+    public void queryPrivilegedConfiguredNetworks(@NonNull @CallbackExecutor Executor executor,
+            @NonNull OutcomeReceiver<List<WifiConfiguration>, Error> resultsCallback) {
+        if (!SdkLevel.isAtLeastS()) {
+            throw new UnsupportedOperationException();
+        }
+        Objects.requireNonNull(executor, "executor cannot be null");
+        Objects.requireNonNull(resultsCallback, "resultsCallback cannot be null");
+        Bundle extras = new Bundle();
+        extras.putParcelable(EXTRA_PARAM_KEY_ATTRIBUTION_SOURCE,
+                mContext.getAttributionSource());
+        try {
+            mService.queryPrivilegedConfiguredNetworks(
+                    new IPrivilegedConfiguredNetworksListener.Stub() {
+                        @Override
+                        public void onResult(ParceledListSlice<WifiConfiguration> result,
+                                String errorMsg) {
+                            Binder.clearCallingIdentity();
+                            executor.execute(
+                                    () -> {
+                                        if (result != null) {
+                                            resultsCallback.onResult(result.getList());
+                                        } else {
+                                            resultsCallback.onError(new Error(errorMsg));
+                                        }
+                                    });
+                        }
+                    }, extras);
+        } catch (RemoteException e) {
+            throw e.rethrowFromSystemServer();
+        }
+    }
 }
diff --git a/framework/java/android/net/wifi/WifiNetworkSuggestion.java b/framework/java/android/net/wifi/WifiNetworkSuggestion.java
index eb7405f36c..a2a76335ae 100644
--- a/framework/java/android/net/wifi/WifiNetworkSuggestion.java
+++ b/framework/java/android/net/wifi/WifiNetworkSuggestion.java
@@ -29,6 +29,7 @@ import android.net.MacAddress;
 import android.net.NetworkCapabilities;
 import android.net.NetworkRequest;
 import android.net.wifi.hotspot2.PasspointConfiguration;
+import android.net.wifi.util.BuildProperties;
 import android.os.Build;
 import android.os.Parcel;
 import android.os.ParcelUuid;
@@ -1276,10 +1277,12 @@ public final class WifiNetworkSuggestion implements Parcelable {
                 mIsSharedWithUser = false;
             }
             if (mIsCarrierMerged) {
+                BuildProperties buildProperties = BuildProperties.getInstance();
                 if ((mSubscriptionId == SubscriptionManager.INVALID_SUBSCRIPTION_ID
                         && mSubscriptionGroup == null)
                         || mMeteredOverride != WifiConfiguration.METERED_OVERRIDE_METERED
-                        || !isEnterpriseSuggestion()) {
+                        || (!isEnterpriseSuggestion()
+                        && !(buildProperties.isEngBuild() || buildProperties.isUserdebugBuild()))) {
                     throw new IllegalStateException("A carrier merged network must be a metered, "
                             + "enterprise network with valid subscription Id");
                 }
@@ -1305,8 +1308,6 @@ public final class WifiNetworkSuggestion implements Parcelable {
         }
     }
 
-
-
     /**
      * Network configuration for the provided network.
      * @hide
diff --git a/framework/java/android/net/wifi/hotspot2/omadm/XMLParser.java b/framework/java/android/net/wifi/hotspot2/omadm/XMLParser.java
index 948052c9bf..f2768307e0 100644
--- a/framework/java/android/net/wifi/hotspot2/omadm/XMLParser.java
+++ b/framework/java/android/net/wifi/hotspot2/omadm/XMLParser.java
@@ -16,13 +16,13 @@
 
 package android.net.wifi.hotspot2.omadm;
 
+import android.text.TextUtils;
+
 import org.xml.sax.Attributes;
 import org.xml.sax.InputSource;
 import org.xml.sax.SAXException;
 import org.xml.sax.helpers.DefaultHandler;
 
-import android.text.TextUtils;
-
 import java.io.IOException;
 import java.io.StringReader;
 
diff --git a/framework/java/android/net/wifi/hotspot2/pps/Credential.java b/framework/java/android/net/wifi/hotspot2/pps/Credential.java
index 25d20f14ae..45fe5a2948 100644
--- a/framework/java/android/net/wifi/hotspot2/pps/Credential.java
+++ b/framework/java/android/net/wifi/hotspot2/pps/Credential.java
@@ -381,12 +381,12 @@ public final class Credential implements Parcelable {
         @Override
         public String toString() {
             StringBuilder builder = new StringBuilder();
-            builder.append("Username: ").append(mUsername).append("\n");
-            builder.append("MachineManaged: ").append(mMachineManaged).append("\n");
-            builder.append("SoftTokenApp: ").append(mSoftTokenApp).append("\n");
-            builder.append("AbleToShare: ").append(mAbleToShare).append("\n");
-            builder.append("EAPType: ").append(mEapType).append("\n");
-            builder.append("AuthMethod: ").append(mNonEapInnerMethod).append("\n");
+            builder.append("Username=").append(mUsername).append(", ");
+            builder.append("MachineManaged=").append(mMachineManaged).append(", ");
+            builder.append("SoftTokenApp=").append(mSoftTokenApp).append(", ");
+            builder.append("AbleToShare=").append(mAbleToShare).append(", ");
+            builder.append("EAPType=").append(mEapType).append(", ");
+            builder.append("AuthMethod=").append(mNonEapInnerMethod);
             return builder.toString();
         }
 
@@ -597,7 +597,7 @@ public final class Credential implements Parcelable {
 
         @Override
         public String toString() {
-            return "CertificateType: " + mCertType + "\n";
+            return "CertificateType=" + mCertType;
         }
 
         /**
@@ -766,9 +766,9 @@ public final class Credential implements Parcelable {
                 } else {
                     imsi = mImsi;
                 }
-                builder.append("IMSI: ").append(imsi).append("\n");
+                builder.append("IMSI=").append(imsi).append(", ");
             }
-            builder.append("EAPType: ").append(mEapType).append("\n");
+            builder.append("EAPType=").append(mEapType);
             return builder.toString();
         }
 
diff --git a/framework/java/android/net/wifi/p2p/WifiP2pConfig.java b/framework/java/android/net/wifi/p2p/WifiP2pConfig.java
index 8e0805797f..aa69542ed1 100644
--- a/framework/java/android/net/wifi/p2p/WifiP2pConfig.java
+++ b/framework/java/android/net/wifi/p2p/WifiP2pConfig.java
@@ -487,19 +487,19 @@ public class WifiP2pConfig implements Parcelable {
         sbuf.append("\n networkName: ").append(networkName);
         sbuf.append("\n passphrase: ").append(
                 TextUtils.isEmpty(passphrase) ? "<empty>" : "<non-empty>");
-        sbuf.append("\n pccModeConnectionType: ").append(mPccModeConnectionType);
         sbuf.append("\n groupOwnerBand: ").append(groupOwnerBand);
         sbuf.append("\n groupClientIpProvisioningMode: ").append(mGroupClientIpProvisioningMode);
         sbuf.append("\n joinExistingGroup: ").append(mJoinExistingGroup);
         sbuf.append("\n vendorData: ").append(mVendorData);
         sbuf.append("\n Group Owner Version: ").append(mGroupOwnerVersion);
+        sbuf.append("\n authorizeConnectionFromPeerEnabled: ")
+                .append(mIsAuthorizeConnectionFromPeerEnabled);
+        sbuf.append("\n pccModeConnectionType: ").append(mPccModeConnectionType);
         if (Environment.isSdkAtLeastB() && Flags.wifiDirectR2()) {
             sbuf.append("\n Pairing bootstrapping config : ")
                     .append((mPairingBootstrappingConfig == null)
                             ? "<null>" : mPairingBootstrappingConfig.toString());
         }
-        sbuf.append("\n authorizeConnectionFromPeerEnabled: ")
-                .append(mIsAuthorizeConnectionFromPeerEnabled);
         return sbuf.toString();
     }
 
@@ -517,14 +517,14 @@ public class WifiP2pConfig implements Parcelable {
             netId = source.netId;
             networkName = source.networkName;
             passphrase = source.passphrase;
-            mPccModeConnectionType = source.mPccModeConnectionType;
             groupOwnerBand = source.groupOwnerBand;
             mGroupClientIpProvisioningMode = source.mGroupClientIpProvisioningMode;
             mJoinExistingGroup = source.mJoinExistingGroup;
             mVendorData = new ArrayList<>(source.mVendorData);
             mGroupOwnerVersion = source.mGroupOwnerVersion;
-            mPairingBootstrappingConfig = source.mPairingBootstrappingConfig;
             mIsAuthorizeConnectionFromPeerEnabled = source.mIsAuthorizeConnectionFromPeerEnabled;
+            mPccModeConnectionType = source.mPccModeConnectionType;
+            mPairingBootstrappingConfig = source.mPairingBootstrappingConfig;
         }
     }
 
@@ -536,16 +536,16 @@ public class WifiP2pConfig implements Parcelable {
         dest.writeInt(netId);
         dest.writeString(networkName);
         dest.writeString(passphrase);
-        dest.writeInt(mPccModeConnectionType);
         dest.writeInt(groupOwnerBand);
         dest.writeInt(mGroupClientIpProvisioningMode);
         dest.writeBoolean(mJoinExistingGroup);
         dest.writeList(mVendorData);
         dest.writeInt(mGroupOwnerVersion);
+        dest.writeBoolean(mIsAuthorizeConnectionFromPeerEnabled);
+        dest.writeInt(mPccModeConnectionType);
         if (Environment.isSdkAtLeastB() && Flags.wifiDirectR2()) {
             dest.writeParcelable(mPairingBootstrappingConfig, flags);
         }
-        dest.writeBoolean(mIsAuthorizeConnectionFromPeerEnabled);
     }
 
     /** Implement the Parcelable interface */
@@ -560,17 +560,17 @@ public class WifiP2pConfig implements Parcelable {
                     config.netId = in.readInt();
                     config.networkName = in.readString();
                     config.passphrase = in.readString();
-                    config.mPccModeConnectionType = in.readInt();
                     config.groupOwnerBand = in.readInt();
                     config.mGroupClientIpProvisioningMode = in.readInt();
                     config.mJoinExistingGroup = in.readBoolean();
                     config.mVendorData = ParcelUtil.readOuiKeyedDataList(in);
                     config.mGroupOwnerVersion = in.readInt();
+                    config.mIsAuthorizeConnectionFromPeerEnabled = in.readBoolean();
+                    config.mPccModeConnectionType = in.readInt();
                     if (Environment.isSdkAtLeastB() && Flags.wifiDirectR2()) {
                         config.mPairingBootstrappingConfig = in.readParcelable(
-                                WifiP2pPairingBootstrappingConfig.class.getClassLoader());
+                            WifiP2pPairingBootstrappingConfig.class.getClassLoader());
                     }
-                    config.mIsAuthorizeConnectionFromPeerEnabled = in.readBoolean();
                     return config;
             }
 
@@ -1007,7 +1007,6 @@ public class WifiP2pConfig implements Parcelable {
             config.deviceAddress = mDeviceAddress.toString();
             config.networkName = mNetworkName;
             config.passphrase = mPassphrase;
-            config.mPccModeConnectionType = mPccModeConnectionType;
             config.groupOwnerBand = GROUP_OWNER_BAND_AUTO;
             if (mGroupOperatingFrequency > 0) {
                 config.groupOwnerBand = mGroupOperatingFrequency;
@@ -1017,13 +1016,14 @@ public class WifiP2pConfig implements Parcelable {
             config.netId = mNetId;
             config.mGroupClientIpProvisioningMode = mGroupClientIpProvisioningMode;
             config.mJoinExistingGroup = mJoinExistingGroup;
+            config.mIsAuthorizeConnectionFromPeerEnabled = mIsAuthorizeConnectionFromPeerEnabled;
+            config.mPccModeConnectionType = mPccModeConnectionType;
             if (mPairingBootstrappingConfig != null) {
                 config.mPairingBootstrappingConfig = mPairingBootstrappingConfig;
                 config.mGroupClientIpProvisioningMode =
                         GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL;
                 config.wps.setup = WpsInfo.INVALID;
             }
-            config.mIsAuthorizeConnectionFromPeerEnabled = mIsAuthorizeConnectionFromPeerEnabled;
             return config;
         }
     }
diff --git a/framework/java/android/net/wifi/rtt/CivicLocation.java b/framework/java/android/net/wifi/rtt/CivicLocation.java
index 60b745ddfd..489d5716f3 100644
--- a/framework/java/android/net/wifi/rtt/CivicLocation.java
+++ b/framework/java/android/net/wifi/rtt/CivicLocation.java
@@ -21,7 +21,6 @@ import android.location.Address;
 import android.net.wifi.rtt.CivicLocationKeys.CivicLocationKeysType;
 import android.os.Parcel;
 import android.os.Parcelable;
-import android.os.Parcelable.Creator;
 import android.util.SparseArray;
 
 import java.nio.charset.StandardCharsets;
diff --git a/framework/java/android/net/wifi/rtt/ResponderConfig.java b/framework/java/android/net/wifi/rtt/ResponderConfig.java
index 7d950eeabd..e3dc24c66c 100644
--- a/framework/java/android/net/wifi/rtt/ResponderConfig.java
+++ b/framework/java/android/net/wifi/rtt/ResponderConfig.java
@@ -463,7 +463,11 @@ public final class ResponderConfig implements Parcelable {
 
             if (ehtCapabilitiesPresent && isHeOrEhtAllowed) {
                 preamble = ScanResult.PREAMBLE_EHT;
-            } else if (heCapabilitiesPresent && isHeOrEhtAllowed) {
+            } else if (supports80211azNtbRanging || (heCapabilitiesPresent && isHeOrEhtAllowed)) {
+                // In IEEE 802.11az, ranging uses the HE preamble. An AP advertising 11az support
+                // must therefore implement HE preamble handling for ranging, even if it is not
+                // advertising HE capabilities for normal network association. Also EHT support
+                // implies HE support.
                 preamble = ScanResult.PREAMBLE_HE;
             } else if (vhtCapabilitiesPresent) {
                 preamble = ScanResult.PREAMBLE_VHT;
@@ -993,6 +997,10 @@ public final class ResponderConfig implements Parcelable {
                         "Invalid ResponderConfig - must specify a MAC address or peer handle but "
                                 + "not both");
             }
+            if (mSupports80211azNtb && !isHeSupported(mPreamble)) {
+                throw new IllegalArgumentException(
+                        "IEEE 802.11az responder must support HE preamble");
+            }
             // For Aware, use supported default values
             if (mResponderType == RESPONDER_AWARE) {
                 mSupports80211Mc = true;
@@ -1004,6 +1012,10 @@ public final class ResponderConfig implements Parcelable {
         }
     }
 
+    private static boolean isHeSupported(int preamble) {
+        // EHT support implies HE support.
+        return preamble != PREAMBLE_LEGACY && preamble != PREAMBLE_HT && preamble != PREAMBLE_VHT;
+    }
     @Override
     public int describeContents() {
         return 0;
diff --git a/framework/java/android/net/wifi/util/BuildProperties.java b/framework/java/android/net/wifi/util/BuildProperties.java
new file mode 100644
index 0000000000..f06b1716fc
--- /dev/null
+++ b/framework/java/android/net/wifi/util/BuildProperties.java
@@ -0,0 +1,47 @@
+/*
+ * Copyright (C) 2016 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.net.wifi.util;
+
+import android.os.Build;
+
+/**
+ * A proxy of android.os.Build for easy testing.
+ * @hide
+ */
+public final class BuildProperties {
+    /** Returns true iff this is an eng build. */
+    public boolean isEngBuild() {
+        return Build.TYPE.equals("eng");
+    }
+
+    /** Returns true iff this is a userdebug build. */
+    public boolean isUserdebugBuild() {
+        return Build.TYPE.equals("userdebug");
+    }
+
+    /** Returns true iff this a normal user build (not userdebug). */
+    public boolean isUserBuild() {
+        return Build.TYPE.equals("user");
+    }
+
+    private static final BuildProperties INSTANCE = new BuildProperties();
+
+    // Get an instance of this class.
+    public static BuildProperties getInstance() {
+        return INSTANCE;
+    }
+}
diff --git a/framework/java/android/net/wifi/util/Environment.java b/framework/java/android/net/wifi/util/Environment.java
index a20b24744d..0ebe763cfa 100644
--- a/framework/java/android/net/wifi/util/Environment.java
+++ b/framework/java/android/net/wifi/util/Environment.java
@@ -112,4 +112,12 @@ public class Environment {
         return Build.VERSION.CODENAME.equals("Baklava")
                 || Build.VERSION.SDK_INT >= Build.VERSION_CODES.BAKLAVA;
     }
+
+    /**
+     * Check if the device has a SDK > 36
+     * @return True if the SDK > 36
+     */
+    public static boolean isSdkNewerThanB() {
+        return Build.VERSION.SDK_INT > Build.VERSION_CODES.BAKLAVA;
+    }
 }
diff --git a/framework/tests/Android.bp b/framework/tests/Android.bp
index 0959110209..a154a62588 100644
--- a/framework/tests/Android.bp
+++ b/framework/tests/Android.bp
@@ -68,4 +68,8 @@ android_test {
     // static libs used by both framework-wifi & FrameworksWifiApiTests. Need to rename test usage
     // to a different package name to prevent conflict with the copy in production code.
     jarjar_rules: "test-jarjar-rules.txt",
+
+    visibility: [
+        "//platform_testing:__subpackages__",
+    ],
 }
diff --git a/framework/tests/src/android/net/wifi/SoftApConfigurationTest.java b/framework/tests/src/android/net/wifi/SoftApConfigurationTest.java
index 9938a6a990..45b5c68837 100644
--- a/framework/tests/src/android/net/wifi/SoftApConfigurationTest.java
+++ b/framework/tests/src/android/net/wifi/SoftApConfigurationTest.java
@@ -136,6 +136,7 @@ public class SoftApConfigurationTest {
         if (Environment.isSdkAtLeastB()) {
             assertFalse(original.isClientIsolationEnabled());
         }
+        assertTrue(original.isBandOptimizationEnabled());
 
         SoftApConfiguration unparceled = parcelUnparcel(original);
         assertThat(unparceled).isNotSameInstanceAs(original);
@@ -237,6 +238,7 @@ public class SoftApConfigurationTest {
         if (Environment.isSdkAtLeastB()) {
             originalBuilder.setClientIsolationEnabled(true);
         }
+        originalBuilder.setBandOptimizationEnabled(false);
         SoftApConfiguration original = originalBuilder.build();
         assertThat(original.getPassphrase()).isEqualTo("secretsecret");
         assertThat(original.getSecurityType()).isEqualTo(
@@ -271,7 +273,7 @@ public class SoftApConfigurationTest {
         if (Environment.isSdkAtLeastB()) {
             assertTrue(original.isClientIsolationEnabled());
         }
-
+        assertFalse(original.isBandOptimizationEnabled());
         SoftApConfiguration unparceled = parcelUnparcel(original);
         assertThat(unparceled).isNotSameInstanceAs(original);
         assertThat(unparceled).isEqualTo(original);
diff --git a/framework/tests/src/android/net/wifi/WifiConfigurationTest.java b/framework/tests/src/android/net/wifi/WifiConfigurationTest.java
index 240f2d1373..72d9c5b32a 100644
--- a/framework/tests/src/android/net/wifi/WifiConfigurationTest.java
+++ b/framework/tests/src/android/net/wifi/WifiConfigurationTest.java
@@ -38,6 +38,7 @@ import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertNotNull;
 import static org.junit.Assert.assertNotSame;
+import static org.junit.Assert.assertThrows;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeFalse;
 import static org.junit.Assume.assumeTrue;
@@ -50,14 +51,17 @@ import android.net.wifi.WifiConfiguration.KeyMgmt;
 import android.net.wifi.WifiConfiguration.NetworkSelectionStatus;
 import android.net.wifi.WifiConfiguration.PairwiseCipher;
 import android.net.wifi.WifiConfiguration.Protocol;
+import android.net.wifi.util.Environment;
 import android.os.Parcel;
 import android.os.ParcelUuid;
+import android.platform.test.annotations.RequiresFlagsEnabled;
 import android.util.Pair;
 
 import androidx.test.filters.SmallTest;
 
 import com.android.modules.utils.build.SdkLevel;
 import com.android.net.module.util.MacAddressUtils;
+import com.android.wifi.flags.Flags;
 
 import org.junit.Before;
 import org.junit.Test;
@@ -1434,4 +1438,38 @@ public class WifiConfigurationTest {
         config.setVendorData(vendorData);
         assertTrue(vendorData.equals(config.getVendorData()));
     }
+
+    /**
+     * Verifies that mIsAllowedToUpdateByOtherUser can be set and retrieved successfully.
+     */
+    @RequiresFlagsEnabled(Flags.FLAG_MULTI_USER_WIFI_ENHANCEMENT)
+    @Test
+    public void testSetAndGetAllowedToUpdateByOtherUser() {
+        assumeTrue(Environment.isSdkNewerThanB());
+        WifiConfiguration config = new WifiConfiguration();
+        // Default should be allowed
+        assertTrue(config.isAllowedToUpdateByOtherUsers());
+
+        // Test set to false
+        config.setAllowedToUpdateByOtherUsers(false);
+        assertFalse(config.isAllowedToUpdateByOtherUsers());
+
+        // Also test parcel
+        Parcel parcelW = Parcel.obtain();
+        config.writeToParcel(parcelW, 0);
+        byte[] bytes = parcelW.marshall();
+        parcelW.recycle();
+
+        Parcel parcelR = Parcel.obtain();
+        parcelR.unmarshall(bytes, 0, bytes.length);
+        parcelR.setDataPosition(0);
+        WifiConfiguration reconfig = WifiConfiguration.CREATOR.createFromParcel(parcelR);
+        assertFalse(reconfig.isAllowedToUpdateByOtherUsers());
+
+        // Test can't set to true for a shared configuration.
+        config.shared = false;
+        // IllegalArgumentException when setting true to a private configuration.
+        assertThrows(IllegalArgumentException.class,
+                () -> config.setAllowedToUpdateByOtherUsers(true));
+    }
 }
diff --git a/framework/tests/src/android/net/wifi/WifiManagerTest.java b/framework/tests/src/android/net/wifi/WifiManagerTest.java
index 497bc3dc33..07644cf12f 100644
--- a/framework/tests/src/android/net/wifi/WifiManagerTest.java
+++ b/framework/tests/src/android/net/wifi/WifiManagerTest.java
@@ -128,6 +128,7 @@ import android.os.Build;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.IBinder;
+import android.os.OutcomeReceiver;
 import android.os.RemoteException;
 import android.os.connectivity.WifiActivityEnergyInfo;
 import android.os.test.TestLooper;
@@ -4569,4 +4570,43 @@ public class WifiManagerTest {
         mWifiManager.disallowCurrentSuggestedNetwork(option);
         verify(mWifiService).disallowCurrentSuggestedNetwork(eq(option), eq(TEST_PACKAGE_NAME));
     }
+
+    @Test
+    public void testAyncGetPrivilegedConfiguredNetworks() throws Exception {
+        assumeTrue(SdkLevel.isAtLeastS());
+        OutcomeReceiver<List<WifiConfiguration>, Error> resultsSetCallback =
+                new OutcomeReceiver<>() {
+                    @Override
+                    public void onResult(List<WifiConfiguration> configs) {
+                    }
+
+                    @Override
+                    public void onError(Error error) {
+                    }
+                };
+        SynchronousExecutor executor = mock(SynchronousExecutor.class);
+        // Null executor/callback exception.
+        try {
+            mWifiManager.queryPrivilegedConfiguredNetworks(null, resultsSetCallback);
+            fail("expected NullPointerException");
+        } catch (NullPointerException expected) {
+        }
+
+        try {
+            mWifiManager.queryPrivilegedConfiguredNetworks(executor, null);
+            fail("expected NullPointerException");
+        } catch (NullPointerException expectedNPE) {
+        }
+
+        ArgumentCaptor<Bundle> bundleCaptor = ArgumentCaptor.forClass(Bundle.class);
+        // Set and verify.
+        mWifiManager.queryPrivilegedConfiguredNetworks(executor, resultsSetCallback);
+        verify(mWifiService).queryPrivilegedConfiguredNetworks(
+                any(IPrivilegedConfiguredNetworksListener.Stub.class),
+                bundleCaptor.capture());
+        // The attributionSource is supported from S, currently it has been mocked in setUp from S.
+        // Thus we just use "mContext.getAttributionSource" to verify it.
+        assertEquals(mContext.getAttributionSource(),
+                bundleCaptor.getValue().getParcelable(EXTRA_PARAM_KEY_ATTRIBUTION_SOURCE));
+    }
 }
diff --git a/framework/tests/src/android/net/wifi/WifiNetworkSuggestionTest.java b/framework/tests/src/android/net/wifi/WifiNetworkSuggestionTest.java
index 5d61ca7f0d..df8638f2b1 100644
--- a/framework/tests/src/android/net/wifi/WifiNetworkSuggestionTest.java
+++ b/framework/tests/src/android/net/wifi/WifiNetworkSuggestionTest.java
@@ -16,6 +16,8 @@
 
 package android.net.wifi;
 
+import static com.android.dx.mockito.inline.extended.ExtendedMockito.mockitoSession;
+
 import static org.junit.Assert.assertArrayEquals;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
@@ -24,19 +26,27 @@ import static org.junit.Assert.assertNotNull;
 import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeTrue;
+import static org.mockito.Mockito.lenient;
+import static org.mockito.Mockito.when;
 
 import android.net.MacAddress;
 import android.net.wifi.hotspot2.PasspointConfiguration;
 import android.net.wifi.hotspot2.PasspointTestUtils;
+import android.net.wifi.util.BuildProperties;
 import android.os.Parcel;
 import android.os.ParcelUuid;
 import android.telephony.SubscriptionManager;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.StaticMockitoSession;
 import com.android.modules.utils.build.SdkLevel;
 
+import org.junit.After;
+import org.junit.Before;
 import org.junit.Test;
+import org.mockito.Mock;
+import org.mockito.MockitoAnnotations;
 
 import java.nio.charset.Charset;
 import java.security.cert.X509Certificate;
@@ -58,6 +68,28 @@ public class WifiNetworkSuggestionTest {
     private static final int TEST_CARRIER_ID = 1998;
     private static final ParcelUuid GROUP_UUID = ParcelUuid
             .fromString("0000110B-0000-1000-8000-00805F9B34FB");
+    private StaticMockitoSession mStaticMockSession;
+    @Mock
+    private BuildProperties mBuildProperties;
+
+    @Before
+    public void setUp() throws Exception {
+        MockitoAnnotations.initMocks(this);
+
+        // static mocking
+        mStaticMockSession = mockitoSession()
+                .mockStatic(BuildProperties.class)
+                .startMocking();
+        lenient().when(BuildProperties.getInstance())
+                .thenReturn(mBuildProperties);
+        when(mBuildProperties.isUserdebugBuild()).thenReturn(false);
+        when(mBuildProperties.isEngBuild()).thenReturn(false);
+    }
+
+    @After
+    public void tearDown() throws Exception {
+        mStaticMockSession.finishMocking();
+    }
 
     /**
      * Validate correctness of WifiNetworkSuggestion object created by
@@ -1551,6 +1583,25 @@ public class WifiNetworkSuggestionTest {
         assertTrue(suggestion.isCarrierMerged());
     }
 
+    /**
+     * Ensure {@link WifiNetworkSuggestion.Builder#build()} allows carrier merged behavior
+     * on a non enterprise networks when running a debug build.
+     */
+    @Test
+    public void testSetCarrierMergedNetworkWithNonEnterpriseNetworkDebugBuilds() {
+        assumeTrue(SdkLevel.isAtLeastS());
+        when(mBuildProperties.isUserdebugBuild()).thenReturn(true);
+
+        WifiNetworkSuggestion suggestion = new WifiNetworkSuggestion.Builder()
+                .setSsid(TEST_SSID)
+                .setSubscriptionId(1)
+                .setWpa2Passphrase(TEST_PRESHARED_KEY)
+                .setCarrierMerged(true)
+                .setIsMetered(true)
+                .build();
+        assertTrue(suggestion.isCarrierMerged());
+    }
+
     /**
      * Ensure {@link WifiNetworkSuggestion.Builder#build()} throws an exception
      * when set both {@link WifiNetworkSuggestion.Builder#setCarrierMerged(boolean)} (boolean)}
@@ -1567,7 +1618,6 @@ public class WifiNetworkSuggestionTest {
                 .setCarrierMerged(true)
                 .setIsMetered(true)
                 .build();
-        assertTrue(suggestion.isCarrierMerged());
     }
 
     /**
diff --git a/framework/tests/src/android/net/wifi/aware/WifiAwareManagerTest.java b/framework/tests/src/android/net/wifi/aware/WifiAwareManagerTest.java
index 3c891ff949..36c8a12d32 100644
--- a/framework/tests/src/android/net/wifi/aware/WifiAwareManagerTest.java
+++ b/framework/tests/src/android/net/wifi/aware/WifiAwareManagerTest.java
@@ -850,6 +850,8 @@ public class WifiAwareManagerTest {
         collector.checkThat("mMinDistanceMm", subscribeConfig.mMinDistanceMm, equalTo(0));
         collector.checkThat("mMaxDistanceMmSet", subscribeConfig.mMaxDistanceMmSet, equalTo(false));
         collector.checkThat("mMaxDistanceMm", subscribeConfig.mMaxDistanceMm, equalTo(0));
+        collector.checkThat("mPeriodicRangingEnabled", subscribeConfig.mPeriodicRangingEnabled,
+                equalTo(false));
         if (SdkLevel.isAtLeastV()) {
             collector.checkThat("mVendorData", subscribeConfig.getVendorData(),
                     equalTo(Collections.emptyList()));
@@ -866,6 +868,7 @@ public class WifiAwareManagerTest {
         final boolean enableTerminateNotification = false;
         final int minDistance = 10;
         final int maxDistance = 50;
+        final int periodicRangingInterval = SubscribeConfig.PERIODIC_RANGING_INTERVAL_512TU;
         final List<OuiKeyedData> vendorData = OuiKeyedDataUtil.createTestOuiKeyedDataList(5);
 
         SubscribeConfig.Builder subscribeConfigBuilder =
@@ -876,7 +879,9 @@ public class WifiAwareManagerTest {
                         .setTtlSec(subscribeTtl)
                         .setTerminateNotificationEnabled(enableTerminateNotification)
                         .setMinDistanceMm(minDistance)
-                        .setMaxDistanceMm(maxDistance);
+                        .setMaxDistanceMm(maxDistance)
+                        .setPeriodicRangingEnabled(true)
+                        .setPeriodicRangingInterval(periodicRangingInterval);
         if (SdkLevel.isAtLeastV()) {
             subscribeConfigBuilder.setVendorData(vendorData);
         }
@@ -896,6 +901,10 @@ public class WifiAwareManagerTest {
         collector.checkThat("mMinDistanceMm", minDistance, equalTo(subscribeConfig.mMinDistanceMm));
         collector.checkThat("mMaxDistanceMmSet", true, equalTo(subscribeConfig.mMaxDistanceMmSet));
         collector.checkThat("mMaxDistanceMm", maxDistance, equalTo(subscribeConfig.mMaxDistanceMm));
+        collector.checkThat("mPeriodicRangingEnabled", true,
+                equalTo(subscribeConfig.mPeriodicRangingEnabled));
+        collector.checkThat("mPeriodicRangingInterval", periodicRangingInterval,
+                             equalTo(subscribeConfig.mPeriodicRangingInterval));
         if (SdkLevel.isAtLeastV()) {
             collector.checkThat("mVendorData", vendorData,
                     equalTo(subscribeConfig.getVendorData()));
diff --git a/framework/tests/src/android/net/wifi/hotspot2/omadm/XMLParserTest.java b/framework/tests/src/android/net/wifi/hotspot2/omadm/XMLParserTest.java
index 85d0a909a2..a758084be4 100644
--- a/framework/tests/src/android/net/wifi/hotspot2/omadm/XMLParserTest.java
+++ b/framework/tests/src/android/net/wifi/hotspot2/omadm/XMLParserTest.java
@@ -18,9 +18,6 @@ package android.net.wifi.hotspot2.omadm;
 
 import static org.junit.Assert.assertTrue;
 
-import android.net.wifi.hotspot2.omadm.XMLNode;
-import android.net.wifi.hotspot2.omadm.XMLParser;
-
 import androidx.test.filters.SmallTest;
 
 import org.junit.Before;
diff --git a/framework/tests/src/android/net/wifi/rtt/WifiRttManagerTest.java b/framework/tests/src/android/net/wifi/rtt/WifiRttManagerTest.java
index 08d5f40385..56c79fd0a7 100644
--- a/framework/tests/src/android/net/wifi/rtt/WifiRttManagerTest.java
+++ b/framework/tests/src/android/net/wifi/rtt/WifiRttManagerTest.java
@@ -21,6 +21,7 @@ import static junit.framework.Assert.fail;
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertNull;
+import static org.junit.Assert.assertThrows;
 import static org.junit.Assert.assertTrue;
 import static org.mockito.ArgumentMatchers.any;
 import static org.mockito.ArgumentMatchers.eq;
@@ -648,7 +649,7 @@ public class WifiRttManagerTest {
                 .setFrequencyMhz(2134)
                 .setCenterFreq0Mhz(2345)
                 .setCenterFreq1Mhz(2555)
-                .setPreamble(ScanResult.PREAMBLE_LEGACY)
+                .setPreamble(ScanResult.PREAMBLE_HE)
                 .set80211azNtbSupported(true)
                 .setNtbMaxTimeBetweenMeasurementsMicros(10000)
                 .setNtbMinTimeBetweenMeasurementsMicros(100)
@@ -820,6 +821,21 @@ public class WifiRttManagerTest {
         scan.informationElements = ie;
         config = ResponderConfig.fromScanResult(scan);
         assertEquals(ResponderConfig.PREAMBLE_EHT, config.preamble);
+
+        // Validate preamble type if HE even if HE/EHT capability is not present.
+        scan = builder.setFrequency(5935).setIs80211azNtbRTTResponder(true)
+                .setIs80211McRTTResponder(true).build();
+        ie[1] = null;
+        ie[2] = null;
+        scan.informationElements = ie;
+        assertEquals(ResponderConfig.PREAMBLE_EHT, config.preamble);
+
+        // Assert the ResponderConfig.Builder().build() method throws an exception if preamble type
+        // is HT and responder supports IEEE 802.11az.
+        assertThrows(IllegalArgumentException.class, () -> {
+            new ResponderConfig.Builder().set80211azNtbSupported(true).setPreamble(
+                    ResponderConfig.PREAMBLE_HT).build();
+        });
     }
 
     @Test
diff --git a/service/ServiceWifiResources/res/layout/wifi_dialog_list.xml b/service/ServiceWifiResources/res/layout/wifi_dialog_list.xml
new file mode 100644
index 0000000000..e001ba712d
--- /dev/null
+++ b/service/ServiceWifiResources/res/layout/wifi_dialog_list.xml
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:orientation="vertical">
+    <View
+        android:id="@+id/wifi_dialog_list_div_top"
+        style="@style/wifi_dialog_list_divider" />
+
+    <ListView
+        android:id="@+id/wifi_dialog_list_data"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:layout_marginBottom="0dp"
+        android:layout_marginLeft="0dp"
+        android:layout_marginRight="0dp"
+        android:layout_marginTop="0dp"
+        android:paddingTop="8dp"
+        android:paddingBottom="8dp"
+        android:clipToPadding="false"
+        android:divider="@null"
+        android:fadeScrollbars="false"
+        android:enabled="false"/>
+
+    <View
+        android:id="@+id/wifi_dialog_list_div_bottom"
+        style="@style/wifi_dialog_list_divider" />
+</LinearLayout>
diff --git a/service/ServiceWifiResources/res/layout/wifi_dialog_list_item.xml b/service/ServiceWifiResources/res/layout/wifi_dialog_list_item.xml
new file mode 100644
index 0000000000..fe9936c483
--- /dev/null
+++ b/service/ServiceWifiResources/res/layout/wifi_dialog_list_item.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2025 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:orientation="vertical">
+    <TextView
+        android:id="@+id/wifi_dialog_list_item_label"
+        style="@style/wifi_dialog_list_item_label" />
+
+    <TextView
+        android:id="@+id/wifi_dialog_list_item_content"
+        style="@style/wifi_dialog_list_item_content" />
+</LinearLayout>
diff --git a/service/ServiceWifiResources/res/values-af/strings.xml b/service/ServiceWifiResources/res/values-af/strings.xml
index 0d2f519a23..42549f5b9b 100644
--- a/service/ServiceWifiResources/res/values-af/strings.xml
+++ b/service/ServiceWifiResources/res/values-af/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Kan nie aan <xliff:g id="VALUE">%1$s</xliff:g> koppel nie"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Die bedienersertifikaatketting is ongeldig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sekuriteitsertifikaat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Gaan net voort as jy hierdie netwerk vertrou en die inligting hier onder korrek lyk."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Kanselleer"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Vertrou"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Bediener"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Uitreiker"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Geldigheid"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Van <xliff:g id="STARTDATE">%1$s</xliff:g> tot <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-vingerafdruk"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-vingerafdruk"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subjeknaambesonderhede"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Uitreikernaambesonderhede"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Weergawe"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Reeksnommer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Publieke sleutel se algoritme"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Publieke sleutel se grootte"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bis"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Publieke sleutel"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Handtekeningalgoritme"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Handtekening"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Kan nie hierdie netwerk verifieer nie"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Bly gekoppel"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Ontkoppel nou"</string>
diff --git a/service/ServiceWifiResources/res/values-am/strings.xml b/service/ServiceWifiResources/res/values-am/strings.xml
index 89130795a8..5b72bd2a2e 100644
--- a/service/ServiceWifiResources/res/values-am/strings.xml
+++ b/service/ServiceWifiResources/res/values-am/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"     "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-ar/strings.xml b/service/ServiceWifiResources/res/values-ar/strings.xml
index 8d3ffa6fd7..b2464cc4ed 100644
--- a/service/ServiceWifiResources/res/values-ar/strings.xml
+++ b/service/ServiceWifiResources/res/values-ar/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"   \"<xliff:g id="VALUE">%1$s</xliff:g>\"."</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"  SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"  SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    ."</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-as/strings.xml b/service/ServiceWifiResources/res/values-as/strings.xml
index d1a79b9d11..dc3dbc9c9d 100644
--- a/service/ServiceWifiResources/res/values-as/strings.xml
+++ b/service/ServiceWifiResources/res/values-as/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"   "</string>
diff --git a/service/ServiceWifiResources/res/values-az/strings.xml b/service/ServiceWifiResources/res/values-az/strings.xml
index c74b17abc0..6aa43a0bbb 100644
--- a/service/ServiceWifiResources/res/values-az/strings.xml
+++ b/service/ServiceWifiResources/res/values-az/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g> bksin qoulmaq mmkn deyil"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Server sertifikat znciri etibarszdr."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Gvnlik sertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Yalnz bu bky etibar edirsinizs v aadak mlumat dzgn grnrs, davam edin."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Lv edin"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Etibar edin"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emitent"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Etibarllq"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> - <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 barmaq izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 barmaq izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Mvzu ad tfrratlar"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Emitent ad tfrrtlar"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versiya"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Seriya nmrsi"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"ctimai aar alqoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"ctimai aar ls"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"ctimai aar"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"mza alqoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"mza"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Bu bkni dorulamaq olmur"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Qoulu qaln"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"ndi balantn ksin"</string>
diff --git a/service/ServiceWifiResources/res/values-b+sr+Latn/strings.xml b/service/ServiceWifiResources/res/values-b+sr+Latn/strings.xml
index 7c182356d2..460a094d04 100644
--- a/service/ServiceWifiResources/res/values-b+sr+Latn/strings.xml
+++ b/service/ServiceWifiResources/res/values-b+sr+Latn/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Povezivanje na mreu <xliff:g id="VALUE">%1$s</xliff:g> nije uspelo"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Lanac sertifikata za server je nevaei."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Potvrdi"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Bezbednosni sertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Nastavite samo ako smatrate da je ova mrea pouzdana i ako informacije u nastavku deluju tano."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Otkai"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Pouzdano"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Izdava"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Period vaenja"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 digitalni otisak"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 digitalni otisak"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalji o nazivu subjekta"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalji o nazivu izdavaa"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verzija"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serijski broj"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritam javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Veliina javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"Bitova: <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Javni klju"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritam potpisa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Potpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ne moemo da verifikujemo ovu mreu"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Ne prekidaj vezu"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Prekini vezu odmah"</string>
diff --git a/service/ServiceWifiResources/res/values-be/strings.xml b/service/ServiceWifiResources/res/values-be/strings.xml
index a99e0bc8f6..c6a324a11c 100644
--- a/service/ServiceWifiResources/res/values-be/strings.xml
+++ b/service/ServiceWifiResources/res/values-be/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"     \"<xliff:g id="VALUE">%1$s</xliff:g>\""</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"    ,         ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"  SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"  SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">": <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-bg/strings.xml b/service/ServiceWifiResources/res/values-bg/strings.xml
index cd257229e0..325e25acf4 100644
--- a/service/ServiceWifiResources/res/values-bg/strings.xml
+++ b/service/ServiceWifiResources/res/values-bg/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"      () <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"      ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"          -  ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"      "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"   "</string>
diff --git a/service/ServiceWifiResources/res/values-bn/strings.xml b/service/ServiceWifiResources/res/values-bn/strings.xml
index a00451e1e3..ff386eb410 100644
--- a/service/ServiceWifiResources/res/values-bn/strings.xml
+++ b/service/ServiceWifiResources/res/values-bn/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>-    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">" - "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-bs/strings.xml b/service/ServiceWifiResources/res/values-bs/strings.xml
index 79cddaaff4..8f04f34a1d 100644
--- a/service/ServiceWifiResources/res/values-bs/strings.xml
+++ b/service/ServiceWifiResources/res/values-bs/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nije se mogue povezati s mreom <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Lanac potvrda servera je nevaei."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Uredu"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sigurnosni certifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Nastavite samo ako vjerujete ovoj mrei te ako informacije u nastavku izgledaju ispravno."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Otkai"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Vjerujem mrei"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Izdava"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Vaenje"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 otisak prsta"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 otisak prsta"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalji o nazivu subjekta"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalji o nazivu izdavaa"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verzija"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serijski broj"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritam javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Veliina javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"Broj bitova: <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Javni klju"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritam potpisa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Potpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Nije mogue potvrditi ovu mreu"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Ostanite povezani"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Prekini vezu odmah"</string>
diff --git a/service/ServiceWifiResources/res/values-ca/strings.xml b/service/ServiceWifiResources/res/values-ca/strings.xml
index b3c39a3304..42949a9c57 100644
--- a/service/ServiceWifiResources/res/values-ca/strings.xml
+++ b/service/ServiceWifiResources/res/values-ca/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No es pot connectar a <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La cadena de certificats del servidor no s vlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"D\'acord"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificat de seguretat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continua noms si confies en aquesta xarxa i la informaci que hi ha a sota sembla correcta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancella"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confia-hi"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validesa"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Del dia <xliff:g id="STARTDATE">%1$s</xliff:g> al dia <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Empremta digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Empremta digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalls del nom del subjecte"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalls del nom de l\'emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versi"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritme de la clau pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Mida de la clau pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Clau pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritme de signatura"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signatura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"No es pot verificar aquesta xarxa"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Continua connectat"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconnecta ara"</string>
diff --git a/service/ServiceWifiResources/res/values-cs/strings.xml b/service/ServiceWifiResources/res/values-cs/strings.xml
index bcaa30db32..13eb7309c4 100644
--- a/service/ServiceWifiResources/res/values-cs/strings.xml
+++ b/service/ServiceWifiResources/res/values-cs/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ksti <xliff:g id="VALUE">%1$s</xliff:g> se nelze pipojit"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"etzec certifikt serveru je neplatn."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Bezpenostn certifikt"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Pokraujte jen vppad, e tto sti dvujete ane uveden informace vypadaj sprvn."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Zruit"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Dvovat"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Vydavatel"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Platnost"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Digitln otisk SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Digitln otisk SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Podrobnosti onzvu subjektu"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"daje onzvu vydavatele"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verze"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Sriov slo"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmus veejnho kle"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Velikost veejnho kle"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Veejn kl"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmus podpisu"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Podpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Tuto s nelze ovit"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Zachovat pipojen"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Odpojit"</string>
diff --git a/service/ServiceWifiResources/res/values-da/strings.xml b/service/ServiceWifiResources/res/values-da/strings.xml
index aba3b75ca2..afbb710242 100644
--- a/service/ServiceWifiResources/res/values-da/strings.xml
+++ b/service/ServiceWifiResources/res/values-da/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Der kan ikke oprettes forbindelse til <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Servercertifikatkden er ugyldig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sikkerhedscertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Fortst kun, hvis du har tillid til dette netvrk, og oplysningerne nedenfor ser korrekte ud."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Annuller"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Fortst"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Udsteder"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Gyldighed"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Fra <xliff:g id="STARTDATE">%1$s</xliff:g> til <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-fingeraftryk"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-fingeraftryk"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Oplysninger om emnenavn"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Oplysninger om udstedernavn"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serienummer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritme for offentlig ngle"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Strrelse p offentlig ngle"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Offentlig ngle"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritme for signatur"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signatur"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Dette netvrk kan ikke verificeres"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Oprethold forbindelsen"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Afbryd forbindelsen nu"</string>
diff --git a/service/ServiceWifiResources/res/values-de/strings.xml b/service/ServiceWifiResources/res/values-de/strings.xml
index 3db2c4042f..1f6e342224 100644
--- a/service/ServiceWifiResources/res/values-de/strings.xml
+++ b/service/ServiceWifiResources/res/values-de/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Verbindung zu <xliff:g id="VALUE">%1$s</xliff:g> nicht mglich"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Die Serverzertifikatkette ist ungltig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Ok"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sicherheitszertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Fahre nur fort, wenn du diesem Netzwerk vertraust und die Informationen unten deiner Meinung nach korrekt sind."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Abbrechen"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Vertrauen"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Aussteller"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Gltigkeit"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Von <xliff:g id="STARTDATE">%1$s</xliff:g> bis <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-Fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-Fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Details zum Eigentmernamen"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Details zum Ausstellernamen"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Seriennummer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algorithmus fr ffentlichen Schlssel"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Gre des ffentlichen Schlssels"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>Bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"ffentlicher Schlssel"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signaturalgorithmus"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signatur"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Dieses Netzwerk kann nicht verifiziert werden"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Verbindung beibehalten"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Verbindung jetzt trennen"</string>
diff --git a/service/ServiceWifiResources/res/values-el/strings.xml b/service/ServiceWifiResources/res/values-el/strings.xml
index e3cbfc2ddb..7ed58160f6 100644
--- a/service/ServiceWifiResources/res/values-el/strings.xml
+++ b/service/ServiceWifiResources/res/values-el/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"      <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"      ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"            ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"   SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"   SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"       ."</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-en-rAU/strings.xml b/service/ServiceWifiResources/res/values-en-rAU/strings.xml
index 377f775449..275ce68b8f 100644
--- a/service/ServiceWifiResources/res/values-en-rAU/strings.xml
+++ b/service/ServiceWifiResources/res/values-en-rAU/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Can\'t connect to <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"The server certificate chain is invalid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Security certificate"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Only continue if you trust this network and the info below looks correct."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancel"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Trust"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Issuer"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validity"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"From <xliff:g id="STARTDATE">%1$s</xliff:g> to <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subject name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Issuer name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serial number"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Public key algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Public key size"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Public key"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signature algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Can\'t verify this network"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Stay connected"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Disconnect now"</string>
diff --git a/service/ServiceWifiResources/res/values-en-rCA/strings.xml b/service/ServiceWifiResources/res/values-en-rCA/strings.xml
index c2b91ef1da..dea6e488c7 100644
--- a/service/ServiceWifiResources/res/values-en-rCA/strings.xml
+++ b/service/ServiceWifiResources/res/values-en-rCA/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Can\'t connect to <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"The server certificate chain is invalid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Security certificate"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Only continue if you trust this network and the info below looks correct."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancel"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Trust"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Issuer"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validity"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"From <xliff:g id="STARTDATE">%1$s</xliff:g> to <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subject name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Issuer name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serial number"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Public key algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Public key size"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Public key"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signature algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Can\'t verify this network"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Stay connected"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Disconnect now"</string>
diff --git a/service/ServiceWifiResources/res/values-en-rGB/strings.xml b/service/ServiceWifiResources/res/values-en-rGB/strings.xml
index 377f775449..275ce68b8f 100644
--- a/service/ServiceWifiResources/res/values-en-rGB/strings.xml
+++ b/service/ServiceWifiResources/res/values-en-rGB/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Can\'t connect to <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"The server certificate chain is invalid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Security certificate"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Only continue if you trust this network and the info below looks correct."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancel"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Trust"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Issuer"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validity"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"From <xliff:g id="STARTDATE">%1$s</xliff:g> to <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subject name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Issuer name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serial number"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Public key algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Public key size"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Public key"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signature algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Can\'t verify this network"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Stay connected"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Disconnect now"</string>
diff --git a/service/ServiceWifiResources/res/values-en-rIN/strings.xml b/service/ServiceWifiResources/res/values-en-rIN/strings.xml
index 377f775449..275ce68b8f 100644
--- a/service/ServiceWifiResources/res/values-en-rIN/strings.xml
+++ b/service/ServiceWifiResources/res/values-en-rIN/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Can\'t connect to <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"The server certificate chain is invalid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Security certificate"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Only continue if you trust this network and the info below looks correct."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancel"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Trust"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Issuer"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validity"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"From <xliff:g id="STARTDATE">%1$s</xliff:g> to <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subject name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Issuer name details"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serial number"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Public key algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Public key size"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Public key"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signature algorithm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Can\'t verify this network"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Stay connected"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Disconnect now"</string>
diff --git a/service/ServiceWifiResources/res/values-es-rUS/strings.xml b/service/ServiceWifiResources/res/values-es-rUS/strings.xml
index b1137fbb87..c54354c549 100644
--- a/service/ServiceWifiResources/res/values-es-rUS/strings.xml
+++ b/service/ServiceWifiResources/res/values-es-rUS/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No se puede conectar con <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La cadena de certificados del servidor no es vlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Aceptar"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de seguridad"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Contina solo si confas en esta red y la informacin que se muestra a continuacin es correcta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiar"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validez"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De <xliff:g id="STARTDATE">%1$s</xliff:g> a <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Huella digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Huella digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalles del nombre del sujeto"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalles del nombre del emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versin"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de serie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo de clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamao de la clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de firma"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Firma"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"No se pudo verificar esta red"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Mantener la conexin"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconectar ahora"</string>
diff --git a/service/ServiceWifiResources/res/values-es/strings.xml b/service/ServiceWifiResources/res/values-es/strings.xml
index debb7040f9..5d2b4ef2ca 100644
--- a/service/ServiceWifiResources/res/values-es/strings.xml
+++ b/service/ServiceWifiResources/res/values-es/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No se puede conectar a <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La cadena de certificados del servidor no es vlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Aceptar"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de seguridad"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Contina solo si confas en esta red y la informacin que se muestra a continuacin parece correcta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiar"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validez"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Del <xliff:g id="STARTDATE">%1$s</xliff:g> al <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Huella digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Huella digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalles del nombre del asunto"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalles del nombre del emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versin"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de serie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo de la clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamao de clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de firma"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Firma"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"No se puede verificar esta red"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Mantener conexin"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconectar ahora"</string>
diff --git a/service/ServiceWifiResources/res/values-et/strings.xml b/service/ServiceWifiResources/res/values-et/strings.xml
index c31121dc0b..ac8cd6cbf5 100644
--- a/service/ServiceWifiResources/res/values-et/strings.xml
+++ b/service/ServiceWifiResources/res/values-et/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Vrguga <xliff:g id="VALUE">%1$s</xliff:g> ei nnestu hendada"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Serveri sertifikaadiahel on sobimatu."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Turvasertifikaat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Jtkake ainult juhul, kui usaldate seda vrku ja allolev teave tundub ige."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Thista"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Usalda"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Vljaandja"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Kehtivus"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> kuni <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 srmejlg"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 srmejlg"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subjekti nime ksikasjad"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Vljaandja nime ksikasjad"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versioon"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Seerianumber"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Avaliku vtme algoritm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Avaliku vtme pikkus"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bitti"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Avalik vti"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Allkirja algoritm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Allkiri"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Seda vrku ei nnestu kinnitada"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Silita hendus"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Katkesta kohe hendus"</string>
diff --git a/service/ServiceWifiResources/res/values-eu/strings.xml b/service/ServiceWifiResources/res/values-eu/strings.xml
index 68c97c3d42..e7a86e1f48 100644
--- a/service/ServiceWifiResources/res/values-eu/strings.xml
+++ b/service/ServiceWifiResources/res/values-eu/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ezin da konektatu <xliff:g id="VALUE">%1$s</xliff:g> sarera"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Zerbitzari-ziurtagiriaren kateak ez du balio."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Ados"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Segurtasun-ziurtagiria"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Egin aurrera sareaz fidatzen bazara eta beheko informazioak zuzena badirudi soilik."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Utzi"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Fidagarria da"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Zerbitzaria"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Jaulkitzailea"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Balio-aldia"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> eta <xliff:g id="ENDDATE">%2$s</xliff:g> artean"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 aztarna digitala"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 aztarna digitala"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Gaiaren izenaren xehetasunak"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Jaulkitzailearen izenaren xehetasunak"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Bertsioa"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serie-zenbakia"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Gako publikoaren algoritmoa"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Gako publikoaren tamaina"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Gako publikoa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Sinaduraren algoritmoa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Sinadura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ezin da egiaztatu sarea"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Egon konektatuta"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Deskonektatu"</string>
diff --git a/service/ServiceWifiResources/res/values-fa/strings.xml b/service/ServiceWifiResources/res/values-fa/strings.xml
index a1c788103d..6e433e452b 100644
--- a/service/ServiceWifiResources/res/values-fa/strings.xml
+++ b/service/ServiceWifiResources/res/values-fa/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"  <xliff:g id="VALUE">%1$s</xliff:g>  "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"  -"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"  -"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-fi/strings.xml b/service/ServiceWifiResources/res/values-fi/strings.xml
index 4fe27267d3..df11d7125b 100644
--- a/service/ServiceWifiResources/res/values-fi/strings.xml
+++ b/service/ServiceWifiResources/res/values-fi/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ei saada yhteytt: <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Palvelimen varmenneketju on virheellinen."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Suojausvarmenne"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Jatka vain, jos luotat thn verkkoon ja alla olevat tiedot nyttvt oikeilta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Peru"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Luota"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Palvelin"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Myntj"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Voimassaoloaika"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-tunnistetiedosto"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-tunnistetiedosto"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Aiheen nimitiedot"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Myntjn nimitiedot"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versio"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Sarjanumero"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Julkisen avaimen algoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Julkisen avaimen koko"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bitti"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Julkinen avain"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Allekirjoitusalgoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Allekirjoitus"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Verkkoa ei voi todentaa"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Pysy yhteydess"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Katkaise yhteys nyt"</string>
diff --git a/service/ServiceWifiResources/res/values-fr-rCA/strings.xml b/service/ServiceWifiResources/res/values-fr-rCA/strings.xml
index 7ecfb0fb0b..efe4d6d357 100644
--- a/service/ServiceWifiResources/res/values-fr-rCA/strings.xml
+++ b/service/ServiceWifiResources/res/values-fr-rCA/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Impossible de se connecter  <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La chane de certificats du serveur est incorrecte."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificat de scurit"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continuez seulement si vous faites confiance  ce rseau, et si les informations ci-dessous semblent correctes."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Annuler"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Faire confiance"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serveur"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"metteur"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Priode de validit"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Du <xliff:g id="STARTDATE">%1$s</xliff:g> au <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Empreinte digitaleSHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Empreinte digitaleSHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Dtails du nom du sujet"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Dtails du nom de l\'metteur"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numro de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algorithme  cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Taille de la cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algorithme de signature"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Impossible de vrifier ce rseau"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Rester connect"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Se dconnecter maintenant"</string>
diff --git a/service/ServiceWifiResources/res/values-fr/strings.xml b/service/ServiceWifiResources/res/values-fr/strings.xml
index 17cdb908bf..bc82587fdf 100644
--- a/service/ServiceWifiResources/res/values-fr/strings.xml
+++ b/service/ServiceWifiResources/res/values-fr/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Impossible de se connecter  <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La chane de certificats du serveur n\'est pas valide."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificat de scurit"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Ne continuez que si vous faites confiance  ce rseau et si les informations ci-dessous semblent correctes."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Annuler"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiance"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serveur"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"metteur"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validit"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"EmpreinteSHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"EmpreinteSHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Dtails du nom de l\'objet"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Dtails du nom de l\'metteur"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numro de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algorithme de cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Taille de cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Cl publique"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algorithme de signature"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Impossible de valider ce rseau"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Rester connect"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Se dconnecter maintenant"</string>
diff --git a/service/ServiceWifiResources/res/values-gl/strings.xml b/service/ServiceWifiResources/res/values-gl/strings.xml
index 41aa779eef..b9b61a60ba 100644
--- a/service/ServiceWifiResources/res/values-gl/strings.xml
+++ b/service/ServiceWifiResources/res/values-gl/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Non se puido establecer conexin con <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"A cadea de certificados do servidor non  vlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Vale"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de seguranza"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Contina unicamente se confas nesta rede e a informacin que se mostra abaixo parece correcta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiar"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validez"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Horario: <xliff:g id="STARTDATE">%1$s</xliff:g>-<xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Impresin dixital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Impresin dixital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalles do nome da entidade"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalles do nome do emisor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versin"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de serie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo da clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamao da clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Clave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de sinatura"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Sinatura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Non se puido verificar esta rede"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Manter conexin"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconectar agora"</string>
diff --git a/service/ServiceWifiResources/res/values-gu/strings.xml b/service/ServiceWifiResources/res/values-gu/strings.xml
index 90e0c4dcf3..23909b7321 100644
--- a/service/ServiceWifiResources/res/values-gu/strings.xml
+++ b/service/ServiceWifiResources/res/values-gu/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>     "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"                 ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-hi/strings.xml b/service/ServiceWifiResources/res/values-hi/strings.xml
index 732d4ddf66..ff7ecb04fe 100644
--- a/service/ServiceWifiResources/res/values-hi/strings.xml
+++ b/service/ServiceWifiResources/res/values-hi/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>      "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"   "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"                 ,       ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"      "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"         "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"       "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-hr/strings.xml b/service/ServiceWifiResources/res/values-hr/strings.xml
index 044d6f082a..33e2231d3f 100644
--- a/service/ServiceWifiResources/res/values-hr/strings.xml
+++ b/service/ServiceWifiResources/res/values-hr/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Povezivanje s mreom <xliff:g id="VALUE">%1$s</xliff:g> nije uspjelo"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Lanac certifikata posluitelja nije vaei."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"U redu"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sigurnosni certifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Nastavite samo ako smatrate da je ta mrea pouzdana i ako podaci u nastavku izgledaju tono."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Odustani"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Smatraj pouzdanim"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Posluitelj"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Izdavatelj"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Valjanost"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 otisak prsta"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 otisak prsta"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Pojedinosti o nazivu entiteta"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Pojedinosti o nazivu izdavatelja"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verzija"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serijski broj"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritam javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Veliina javnog kljua"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Javni klju"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritam potpisa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Potpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ta se mrea ne moe potvrditi"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Ostanite povezani"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Prekini vezu odmah"</string>
diff --git a/service/ServiceWifiResources/res/values-hu/strings.xml b/service/ServiceWifiResources/res/values-hu/strings.xml
index e12768bf79..5c46dbf0e7 100644
--- a/service/ServiceWifiResources/res/values-hu/strings.xml
+++ b/service/ServiceWifiResources/res/values-hu/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nem lehet csatlakozni a kvetkezhz: <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"A szerver tanstvnylnca rvnytelen."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Biztonsgi tanstvny"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Csak akkor lpjen tovbb, ha megbzik ebben a hlzatban, s helyesnek tnnek az albbi informcik."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Mgse"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Megbzom benne"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Szerver"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Kibocst"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"rvnyessg"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-ujjlenyomat"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-ujjlenyomat"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Trgy nevnek rszletei"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Kibocst nevnek rszletei"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verzi"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Sorozatszm"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Nyilvnos kulcs algoritmusa"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Nyilvnos kulcs mrete"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Nyilvnos kulcs"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Alrsi algoritmus"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Alrs"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ez a hlzat nem igazolhat"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Kapcsolat fenntartsa"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Levlaszts most"</string>
diff --git a/service/ServiceWifiResources/res/values-hy/strings.xml b/service/ServiceWifiResources/res/values-hy/strings.xml
index 70400c50dd..89ac6d82e0 100644
--- a/service/ServiceWifiResources/res/values-hy/strings.xml
+++ b/service/ServiceWifiResources/res/values-hy/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"  <xliff:g id="VALUE">%1$s</xliff:g> "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">",      ,       "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"   "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-in/strings.xml b/service/ServiceWifiResources/res/values-in/strings.xml
index ccab0c8598..75bf00be8d 100644
--- a/service/ServiceWifiResources/res/values-in/strings.xml
+++ b/service/ServiceWifiResources/res/values-in/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Tidak dapat terhubung ke <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Rantai sertifikat server tidak valid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Oke"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sertifikat keamanan"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Hanya lanjutkan jika Anda memercayai jaringan ini dan info di bawah terlihat benar."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Batal"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Percayai"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Penerbit"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validitas"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Dari <xliff:g id="STARTDATE">%1$s</xliff:g> sampai <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Sidik jari SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Sidik jari SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detail nama subjek"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detail nama penerbit"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versi"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nomor seri"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritma kunci publik"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Ukuran kunci publik"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Kunci publik"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritma tanda tangan"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Tanda tangan"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Tidak dapat memverifikasi jaringan ini"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Tetap terhubung"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Putuskan koneksi sekarang"</string>
diff --git a/service/ServiceWifiResources/res/values-is/strings.xml b/service/ServiceWifiResources/res/values-is/strings.xml
index 47b4188dd8..d4ea62accd 100644
--- a/service/ServiceWifiResources/res/values-is/strings.xml
+++ b/service/ServiceWifiResources/res/values-is/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ekki hgt a tengjast <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Vottorakeja jns er gild."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" lagi"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"ryggisvottor"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Haltu aeins fram ef  treystir netkerfinu og upplsingarnar hr a nean virast rttar."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Htta vi"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Treysta"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Netjnn"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"tgefandi"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Gildistmi"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Fr <xliff:g id="STARTDATE">%1$s</xliff:g> til <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingrafar"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingrafar"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"taratrii efnisheitis"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"taratrii tgefandaheitis"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"tgfa"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Ranmer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Reiknirit opinbers lykils"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Str opinbers lykils"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bitar"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Opinber lykill"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Reiknirit undirritunar"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Undirskrift"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ekki er hgt a stafesta etta net"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Haltu sambandi"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Aftengja nna"</string>
diff --git a/service/ServiceWifiResources/res/values-it/strings.xml b/service/ServiceWifiResources/res/values-it/strings.xml
index 3c9a6acb36..6c4e7817b5 100644
--- a/service/ServiceWifiResources/res/values-it/strings.xml
+++ b/service/ServiceWifiResources/res/values-it/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Impossibile connettersi a <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"La catena di certificati del server non  valida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Ok"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificato di sicurezza"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continua soltanto se ritieni attendibile questa rete e le informazioni di seguito ti sembrano corrette."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Annulla"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Attendibile"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emittente"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validit"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Dal giorno <xliff:g id="STARTDATE">%1$s</xliff:g> al giorno <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Impronta SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Impronta SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Dettagli del nome del soggetto"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Dettagli del nome dell\'emittente"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versione"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numero di serie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo della chiave pubblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Dimensioni della chiave pubblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Chiave pubblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo di firma"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Firma"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Impossibile verificare questa rete"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Mantieni la connessione"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Disconnettiti ora"</string>
diff --git a/service/ServiceWifiResources/res/values-iw/strings.xml b/service/ServiceWifiResources/res/values-iw/strings.xml
index 03edc4dec7..e6c682dcf8 100644
--- a/service/ServiceWifiResources/res/values-iw/strings.xml
+++ b/service/ServiceWifiResources/res/values-iw/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"    <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"     ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"            ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"-<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"  SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"  SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"     "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-ja/strings.xml b/service/ServiceWifiResources/res/values-ja/strings.xml
index 10b78e35b6..9956268c86 100644
--- a/service/ServiceWifiResources/res/values-ja/strings.xml
+++ b/service/ServiceWifiResources/res/values-ja/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g> "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">""</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g><xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-ka/strings.xml b/service/ServiceWifiResources/res/values-ka/strings.xml
index 8cc59fdb0b..f0aa2320b2 100644
--- a/service/ServiceWifiResources/res/values-ka/strings.xml
+++ b/service/ServiceWifiResources/res/values-ka/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>-   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"   ,          ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>- <xliff:g id="ENDDATE">%2$s</xliff:g>-"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"   "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-kk/strings.xml b/service/ServiceWifiResources/res/values-kk/strings.xml
index 53c2950f27..5aae24ef1a 100644
--- a/service/ServiceWifiResources/res/values-kk/strings.xml
+++ b/service/ServiceWifiResources/res/values-kk/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>  ."</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"         ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g><xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-km/strings.xml b/service/ServiceWifiResources/res/values-km/strings.xml
index 9a33bbd2d6..61931476be 100644
--- a/service/ServiceWifiResources/res/values-km/strings.xml
+++ b/service/ServiceWifiResources/res/values-km/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">" <xliff:g id="VALUE">%1$s</xliff:g> "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"  "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-kn/strings.xml b/service/ServiceWifiResources/res/values-kn/strings.xml
index 5ced65b008..db83ac11c6 100644
--- a/service/ServiceWifiResources/res/values-kn/strings.xml
+++ b/service/ServiceWifiResources/res/values-kn/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"          ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-ko/strings.xml b/service/ServiceWifiResources/res/values-ko/strings.xml
index 9dc1307c70..c7f87cf346 100644
--- a/service/ServiceWifiResources/res/values-ko/strings.xml
+++ b/service/ServiceWifiResources/res/values-ko/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"        ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>~<xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-ky/strings.xml b/service/ServiceWifiResources/res/values-ky/strings.xml
index 59b886cd40..f99bdfd321 100644
--- a/service/ServiceWifiResources/res/values-ky/strings.xml
+++ b/service/ServiceWifiResources/res/values-ky/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"         ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  -"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  -"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"   "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-lo/strings.xml b/service/ServiceWifiResources/res/values-lo/strings.xml
index 3bcd4899e6..8273b6880b 100644
--- a/service/ServiceWifiResources/res/values-lo/strings.xml
+++ b/service/ServiceWifiResources/res/values-lo/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">" <xliff:g id="VALUE">%1$s</xliff:g> "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"  ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-lt/strings.xml b/service/ServiceWifiResources/res/values-lt/strings.xml
index 5efb0107a9..28561a0ef2 100644
--- a/service/ServiceWifiResources/res/values-lt/strings.xml
+++ b/service/ServiceWifiResources/res/values-lt/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nepavyksta prisijungti prie <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Netinkama serverio sertifikato grandin."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Gerai"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Saugos sertifikatas"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Tskite, tik jei pasitikite iuo tinklu ir toliau pateikta informacija atrodo teisinga."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Ataukti"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Pasitikti"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serveris"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Sertifikato idavjas"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Galiojimas"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Nuo <xliff:g id="STARTDATE">%1$s</xliff:g> iki <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 skaitmeninis pdsakas"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 skaitmeninis pdsakas"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Isami subjekto pavadinimo informacija"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Isami sertifikato idavjo pavadinimo informacija"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versija"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serijos numeris"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Vieojo rakto algoritmas"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Vieojo rakto dydis"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit."</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Vieasis raktas"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Parao algoritmas"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Paraas"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Nepavyko patvirtinti io tinklo"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Palikti susiet"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Atjungti dabar"</string>
diff --git a/service/ServiceWifiResources/res/values-lv/strings.xml b/service/ServiceWifiResources/res/values-lv/strings.xml
index 360569fd00..790e8fede6 100644
--- a/service/ServiceWifiResources/res/values-lv/strings.xml
+++ b/service/ServiceWifiResources/res/values-lv/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nevar izveidot savienojumu ar tklu <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Servera sertifiktu de ir nederga."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Labi"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Drobas sertifikts"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Turpiniet tikai tad, ja uzticaties im tklam un tlk nordt informcija iet pareiza."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Atcelt"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Uzticties"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serveris"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Izdevjs"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Dergums"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g><xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256ciparnospiedums"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1ciparnospiedums"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalizta informcija par tmas nosaukumu"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalizta informcija par izdevju"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versija"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Srijas numurs"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Publisks atslgas algoritms"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Publisks atslgas izmrs"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bitu"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Publisk atslga"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Paraksta algoritms"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Paraksts"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Nevar verifict o tklu"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Neprtraukt savienojumu"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Prtraukt savienojumu tlt"</string>
diff --git a/service/ServiceWifiResources/res/values-mk/strings.xml b/service/ServiceWifiResources/res/values-mk/strings.xml
index 98a8689a0a..ea407728ec 100644
--- a/service/ServiceWifiResources/res/values-mk/strings.xml
+++ b/service/ServiceWifiResources/res/values-mk/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"      <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"      ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"            ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"     "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"   "</string>
diff --git a/service/ServiceWifiResources/res/values-ml/strings.xml b/service/ServiceWifiResources/res/values-ml/strings.xml
index 1455f32e9c..5304ffea55 100644
--- a/service/ServiceWifiResources/res/values-ml/strings.xml
+++ b/service/ServiceWifiResources/res/values-ml/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"    (    ) ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"   "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-mn/strings.xml b/service/ServiceWifiResources/res/values-mn/strings.xml
index d036fa8f42..f47961f644 100644
--- a/service/ServiceWifiResources/res/values-mn/strings.xml
+++ b/service/ServiceWifiResources/res/values-mn/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>-  "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"             ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>- <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">" "</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-mr/strings.xml b/service/ServiceWifiResources/res/values-mr/strings.xml
index 35a0c9a5f0..e1e8be4775 100644
--- a/service/ServiceWifiResources/res/values-mr/strings.xml
+++ b/service/ServiceWifiResources/res/values-mr/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>     "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"            ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"     "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-ms/strings.xml b/service/ServiceWifiResources/res/values-ms/strings.xml
index c4e459d444..2026e2a70a 100644
--- a/service/ServiceWifiResources/res/values-ms/strings.xml
+++ b/service/ServiceWifiResources/res/values-ms/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Tidak dapat menyambung kepada <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Rantaian sijil pelayan tidak sah."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sijil keselamatan"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Hanya teruskan jika anda mempercayai rangkaian ini dan maklumat di bawah kelihatan betul."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Batal"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Amanah"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Pelayan"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Pengeluar"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Kesahan"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Dari <xliff:g id="STARTDATE">%1$s</xliff:g> hingga <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Cap jari SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Cap jari SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Butiran nama subjek"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Butiran nama pengeluar"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versi"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nombor siri"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritma kunci awam"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Saiz kunci awam"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Kunci awam"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritma tandatangan"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Tandatangan"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Tidak dapat mengesahkan rangkaian ini"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Sentiasa disambungkan"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Putuskan sambungan sekarang"</string>
diff --git a/service/ServiceWifiResources/res/values-my/strings.xml b/service/ServiceWifiResources/res/values-my/strings.xml
index 5ae53cd313..00e823fed1 100644
--- a/service/ServiceWifiResources/res/values-my/strings.xml
+++ b/service/ServiceWifiResources/res/values-my/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>  "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">" "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"    "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">" "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-nb/strings.xml b/service/ServiceWifiResources/res/values-nb/strings.xml
index 36a08e500a..9e8aaf904f 100644
--- a/service/ServiceWifiResources/res/values-nb/strings.xml
+++ b/service/ServiceWifiResources/res/values-nb/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Kan ikke koble til <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Tjenerens sertifikatkjede er ugyldig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Sikkerhetssertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Fortsett bare hvis du stoler p dette nettverket og informasjonen nedenfor ser riktig ut."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Avbryt"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Tillit"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Tjener"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Utsteder"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Gyldighet"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Fra <xliff:g id="STARTDATE">%1$s</xliff:g> til <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-fingeravtrykk"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-fingeravtrykk"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detaljer om emnenavn"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detaljer om utstedernavn"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versjon"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serienummer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritme for offentlig nkkel"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Strrelse p offentlig nkkel"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Offentlig nkkel"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signaturalgoritme"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signatur"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Kan ikke bekrefte dette nettverket"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Behold tilkoblingen"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Koble fra n"</string>
diff --git a/service/ServiceWifiResources/res/values-ne/strings.xml b/service/ServiceWifiResources/res/values-ne/strings.xml
index daeffdf6cc..ac4677b4d5 100644
--- a/service/ServiceWifiResources/res/values-ne/strings.xml
+++ b/service/ServiceWifiResources/res/values-ne/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"              "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"   "</string>
diff --git a/service/ServiceWifiResources/res/values-night/styles.xml b/service/ServiceWifiResources/res/values-night/styles.xml
index a97049517e..325ef71b77 100644
--- a/service/ServiceWifiResources/res/values-night/styles.xml
+++ b/service/ServiceWifiResources/res/values-night/styles.xml
@@ -21,7 +21,6 @@
         <item name="android:singleLine">true</item>
         <item name="android:maxLength">8</item>
         <item name="android:inputType">number</item>
-        <item name="android:textColor">@android:color/primary_text_dark</item>
     </style>
 
     <style name="wifi_p2p_dialog2" parent="@android:style/Theme.DeviceDefault.Dialog.Alert" />
@@ -37,4 +36,30 @@
         <item name="android:textSize">18sp</item>
         <item name="android:textColor">@android:color/primary_text_dark</item>
     </style>
+
+    <style name="wifi_dialog_list_divider">
+        <item name="android:layout_width">match_parent</item>
+        <item name="android:layout_height">1dp</item>
+        <item name="android:background">@android:drawable/divider_horizontal_dark</item>
+    </style>
+
+    <style name="wifi_dialog_list_item_label">
+        <item name="android:layout_width">wrap_content</item>
+        <item name="android:layout_height">wrap_content</item>
+        <item name="android:layout_marginLeft">24dp</item>
+        <item name="android:layout_marginRight">24dp</item>
+        <item name="android:layout_marginTop">14dp</item>
+        <item name="android:textSize">18sp</item>
+        <item name="android:textColor">@android:color/primary_text_dark</item>
+    </style>
+
+    <style name="wifi_dialog_list_item_content">
+        <item name="android:layout_width">wrap_content</item>
+        <item name="android:layout_height">wrap_content</item>
+        <item name="android:layout_marginBottom">14dp</item>
+        <item name="android:layout_marginLeft">24dp</item>
+        <item name="android:layout_marginRight">24dp</item>
+        <item name="android:textSize">14sp</item>
+        <item name="android:textColor">@android:color/secondary_text_dark</item>
+    </style>
 </resources>
diff --git a/service/ServiceWifiResources/res/values-nl/strings.xml b/service/ServiceWifiResources/res/values-nl/strings.xml
index 353139452a..2d06010ded 100644
--- a/service/ServiceWifiResources/res/values-nl/strings.xml
+++ b/service/ServiceWifiResources/res/values-nl/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Kan niet verbinden met <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"De servercertificaatketen is ongeldig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Beveiligingscertificaat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Ga alleen door als je dit netwerk vertrouwt en de onderstaande informatie klopt."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Annuleren"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Vertrouwen"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Kaartuitgever"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Geldigheid"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Van <xliff:g id="STARTDATE">%1$s</xliff:g> tot <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-vingerafdruk"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-vingerafdruk"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Details van onderwerpnaam"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Gegevens naamveld voor kaartuitgever"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versie"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serienummer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritme voor openbare sleutel"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Grootte openbare sleutel"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Openbare sleutel"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritme voor handtekening"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Handtekening"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Kan dit netwerk niet verifiren"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Verbonden blijven"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Verbinding nu verbreken"</string>
diff --git a/service/ServiceWifiResources/res/values-or/strings.xml b/service/ServiceWifiResources/res/values-or/strings.xml
index 0860d7958b..4bca9fc029 100644
--- a/service/ServiceWifiResources/res/values-or/strings.xml
+++ b/service/ServiceWifiResources/res/values-or/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"           ,    "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-pa/strings.xml b/service/ServiceWifiResources/res/values-pa/strings.xml
index 4c64a5215d..fec6f65adb 100644
--- a/service/ServiceWifiResources/res/values-pa/strings.xml
+++ b/service/ServiceWifiResources/res/values-pa/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>      "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">" -   "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"  -"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"         \'          "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"       "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-pl/strings.xml b/service/ServiceWifiResources/res/values-pl/strings.xml
index 85c9402f20..4302299877 100644
--- a/service/ServiceWifiResources/res/values-pl/strings.xml
+++ b/service/ServiceWifiResources/res/values-pl/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nie mona poczy si zsieci <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"acuch certyfikatw serwera jest nieprawidowy."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certyfikat zabezpiecze"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Przejd dalej tylko wtedy, gdy ufasz tej sieci, aponisze informacje wygldaj na prawidowe."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Anuluj"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Ufaj"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serwer"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Wystawca"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Wano"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Odcisk cyfrowy SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Odcisk cyfrowy SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Szczegy nazwy podmiotu"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Szczegy nazwy wystawcy"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Wersja"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numer seryjny"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algorytm klucza publicznego"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Rozmiar klucza publicznego"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"Liczba bitw: <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Klucz publiczny"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algorytm podpisu"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Podpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Nie mona zweryfikowa tej sieci"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Nie odczaj"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Odcz teraz"</string>
diff --git a/service/ServiceWifiResources/res/values-pt-rBR/strings.xml b/service/ServiceWifiResources/res/values-pt-rBR/strings.xml
index f545a10bef..85cafcee44 100644
--- a/service/ServiceWifiResources/res/values-pt-rBR/strings.xml
+++ b/service/ServiceWifiResources/res/values-pt-rBR/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No foi possvel se conectar  rede <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"A cadeia de certificados do servidor  invlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de segurana"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continue apenas se confiar nesta rede e as informaes abaixo estiverem corretas."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiana"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validade"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De <xliff:g id="STARTDATE">%1$s</xliff:g> a <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Impresso digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Impresso digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalhes do nome do assunto"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalhes do nome do emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verso"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo de chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamanho da chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de assinatura"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Assinatura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Falha ao verificar esta rede"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Manter conexo"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconectar agora"</string>
diff --git a/service/ServiceWifiResources/res/values-pt-rPT/strings.xml b/service/ServiceWifiResources/res/values-pt-rPT/strings.xml
index 086254b4cf..95a21e6136 100644
--- a/service/ServiceWifiResources/res/values-pt-rPT/strings.xml
+++ b/service/ServiceWifiResources/res/values-pt-rPT/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No  possvel ligar a <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"A cadeia de certificados do servidor  invlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de segurana"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continue apenas se confiar nesta rede e as informaes abaixo estiverem corretas."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiar"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validade"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De <xliff:g id="STARTDATE">%1$s</xliff:g> a <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Impresso digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Impresso digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalhes do nome da entidade"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalhes do nome do emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verso"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo da chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamanho da chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de assinatura"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Assinatura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"No  possvel validar esta rede"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Mantenha-se a par de tudo"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desligar agora"</string>
diff --git a/service/ServiceWifiResources/res/values-pt/strings.xml b/service/ServiceWifiResources/res/values-pt/strings.xml
index f545a10bef..85cafcee44 100644
--- a/service/ServiceWifiResources/res/values-pt/strings.xml
+++ b/service/ServiceWifiResources/res/values-pt/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"No foi possvel se conectar  rede <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"A cadeia de certificados do servidor  invlida."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificado de segurana"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continue apenas se confiar nesta rede e as informaes abaixo estiverem corretas."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Cancelar"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Confiana"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Servidor"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validade"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De <xliff:g id="STARTDATE">%1$s</xliff:g> a <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Impresso digital SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Impresso digital SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detalhes do nome do assunto"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detalhes do nome do emissor"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verso"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Nmero de srie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmo de chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Tamanho da chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Chave pblica"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmo de assinatura"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Assinatura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Falha ao verificar esta rede"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Manter conexo"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Desconectar agora"</string>
diff --git a/service/ServiceWifiResources/res/values-ro/strings.xml b/service/ServiceWifiResources/res/values-ro/strings.xml
index 80291ea853..10df401671 100644
--- a/service/ServiceWifiResources/res/values-ro/strings.xml
+++ b/service/ServiceWifiResources/res/values-ro/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nu se poate conecta la <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Lanul de certificate al serverului este nevalid."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificat de securitate"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Continu numai dac ai ncredere n aceast reea i informaiile de mai jos sunt corecte."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Anuleaz"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"ncredere"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emitent"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Valabilitate"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"De pe <xliff:g id="STARTDATE">%1$s</xliff:g> pn pe <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Amprenta SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Amprenta SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detaliile numelui subiectului"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detaliile numelui emitentului"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versiune"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numr de serie"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmul cheii publice"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Dimensiunea cheii publice"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bii"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Cheie public"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritm de semnare"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Semntura"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Reeaua nu poate fi verificat"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Rmi conectat()"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Deconecteaz acum"</string>
diff --git a/service/ServiceWifiResources/res/values-ru/strings.xml b/service/ServiceWifiResources/res/values-ru/strings.xml
index e83fadbdfd..b986b526bf 100644
--- a/service/ServiceWifiResources/res/values-ru/strings.xml
+++ b/service/ServiceWifiResources/res/values-ru/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"     \"<xliff:g id="VALUE">%1$s</xliff:g>\""</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"    ,    ,      ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">": <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    ."</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-si/strings.xml b/service/ServiceWifiResources/res/values-si/strings.xml
index 4e3c1cd984..f10c4f5aa7 100644
--- a/service/ServiceWifiResources/res/values-si/strings.xml
+++ b/service/ServiceWifiResources/res/values-si/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>    "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"               ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">" <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-sk/strings.xml b/service/ServiceWifiResources/res/values-sk/strings.xml
index 84521b65ce..cfc0078877 100644
--- a/service/ServiceWifiResources/res/values-sk/strings.xml
+++ b/service/ServiceWifiResources/res/values-sk/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ksieti <xliff:g id="VALUE">%1$s</xliff:g> sa ned pripoji"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Reazec certifiktu servera je neplatn."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certifikt zabezpeenia"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Pokraujte iba vprpade, e tejto sieti dverujete ainformcie niie sa vm zdaj sprvne."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Zrui"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Dverova"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Vydavate"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Platnos"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Odtlaok algoritmu SHA256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Odtlaok algoritmu SHA1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Podrobnosti onzve subjektu"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Podrobnosti onzve vydavatea"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Verzia"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Sriov slo"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmus verejnho ka"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Vekos verejnho ka"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>bitov"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Verejn k"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmus podpisu"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Podpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Tto sie sa ned overi"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Zachovajte si pripojenie"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Odpoji"</string>
diff --git a/service/ServiceWifiResources/res/values-sl/strings.xml b/service/ServiceWifiResources/res/values-sl/strings.xml
index 8cdff4827e..23594dd673 100644
--- a/service/ServiceWifiResources/res/values-sl/strings.xml
+++ b/service/ServiceWifiResources/res/values-sl/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Povezava z omrejem <xliff:g id="VALUE">%1$s</xliff:g> ni mogoa."</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Veriga potrdil strenika ni veljavna."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"V redu"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Varnostno potrdilo"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Nadaljujte samo, e temu omreju zaupate in e so spodnji podatki videti pravilni."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Preklii"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Zaupaj"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Strenik"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Izdajatelj"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Veljavnost"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Od <xliff:g id="STARTDATE">%1$s</xliff:g> do <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Prstni odtis SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Prstni odtis SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Podrobnosti o imenu subjekta"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Podrobnosti o imenu izdajatelja"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Razliica"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serijska tevilka"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritem javnega kljua"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Velikost javnega kljua"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"t. bitov: <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Javni klju"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritem podpisa"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Podpis"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Tega omreja ni mogoe preveriti."</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Ohrani povezavo"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Prekini povezavo"</string>
diff --git a/service/ServiceWifiResources/res/values-sq/strings.xml b/service/ServiceWifiResources/res/values-sq/strings.xml
index 18b379e7ca..abd5ede6a6 100644
--- a/service/ServiceWifiResources/res/values-sq/strings.xml
+++ b/service/ServiceWifiResources/res/values-sq/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Nuk mund t lidhet me <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Zinxhiri i certifikatave t serverit nuk sht i vlefshm."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"N rregull"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certifikata e siguris"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Vazhdo vetm nse i beson ktij rrjeti dhe informacionet e mposhtme duken t sakta."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Anulo"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Beso"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Serveri"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Lshuesi"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Vlefshmria"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Nga <xliff:g id="STARTDATE">%1$s</xliff:g> deri m <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Gjurma e gishtit SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Gjurma e gishtit SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Detajet e emrit t subjektit"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Detajet e emrit t lshuesit"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versioni"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Numri i seris"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritmi i elsit publik"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Madhsia e elsit publik"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bite"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"elsi publik"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoritmi i nnshkrimit"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Nnshkrimi"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ky rrjet nuk mund t verifikohet"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Qndro i lidhur"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Shkputu tani"</string>
diff --git a/service/ServiceWifiResources/res/values-sr/strings.xml b/service/ServiceWifiResources/res/values-sr/strings.xml
index bc40eec20b..a2e47c8ed6 100644
--- a/service/ServiceWifiResources/res/values-sr/strings.xml
+++ b/service/ServiceWifiResources/res/values-sr/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"   <xliff:g id="VALUE">%1$s</xliff:g>  "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"     ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"               ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">": <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"     "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-sv/strings.xml b/service/ServiceWifiResources/res/values-sv/strings.xml
index d67dacd8a8..dce54409c8 100644
--- a/service/ServiceWifiResources/res/values-sv/strings.xml
+++ b/service/ServiceWifiResources/res/values-sv/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Det gick inte att ansluta till <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Certifikatkedjan fr servern r ogiltig."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Skerhetscertifikat"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Fortstt bara om du litar p ntverket och informationen nedan verkar stmma."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Avbryt"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Plitlighet"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Utfrdare"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Giltighet"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Frn <xliff:g id="STARTDATE">%1$s</xliff:g> till <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256-fingeravtryck"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1-fingeravtryck"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Information om mnesnamn"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Utfrdarens namnuppgifter"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Version"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serienummer"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoritm fr offentlig nyckel"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Storlek p offentlig nyckel"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bitar"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Offentlig nyckel"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Signaturalgoritm"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signatur"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Det gick inte att verifiera ntverket"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Hll dig ansluten"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Koppla frn nu"</string>
diff --git a/service/ServiceWifiResources/res/values-sw/strings.xml b/service/ServiceWifiResources/res/values-sw/strings.xml
index b30efb19d2..06aedf1176 100644
--- a/service/ServiceWifiResources/res/values-sw/strings.xml
+++ b/service/ServiceWifiResources/res/values-sw/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Imeshindwa kuunganisha kwenye <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Mfumo wa cheti cha seva si sahihi."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Sawa"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Cheti cha usalama"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Endelea tu ikiwa unaamini mtandao huu na maelezo yafuatayo yanaonekana kuwa sahihi."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Acha"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Ninaamini"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Seva"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Mtoaji"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Muda wa kutumia"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Kuanzia <xliff:g id="STARTDATE">%1$s</xliff:g> hadi <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Aalama bainifu ya SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Alama bainifu ya SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Maelezo ya jina"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Maelezo ya jina la mtoaji"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Toleo"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Namba ya ufuatiliaji"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algoriti ya ufunguo wa umma"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Ukubwa wa ufunguo wa umma"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"Biti <xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Ufunguo wa umma"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algoriti ya sahihi"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Sahihi"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Imeshindwa kuthibitisha mtandao huu"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Iendelee kuunganishwa"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Ondoa sasa"</string>
diff --git a/service/ServiceWifiResources/res/values-ta/strings.xml b/service/ServiceWifiResources/res/values-ta/strings.xml
index ac64422a2c..78037325aa 100644
--- a/service/ServiceWifiResources/res/values-ta/strings.xml
+++ b/service/ServiceWifiResources/res/values-ta/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"   ,      ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"   "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-te/strings.xml b/service/ServiceWifiResources/res/values-te/strings.xml
index baa41465aa..752e14d940 100644
--- a/service/ServiceWifiResources/res/values-te/strings.xml
+++ b/service/ServiceWifiResources/res/values-te/strings.xml
@@ -78,7 +78,7 @@
     <string name="wifi_p2p_dialog2_received_negative_button" msgid="4762549789911681138">" "</string>
     <string name="wifi_p2p_dialog2_enter_pin_label" msgid="7410100924400114335">"PIN"</string>
     <string name="wifi_p2p_dialog2_display_pin_label" msgid="3929561425167093538">"PIN"</string>
-    <string name="wifi_p2p_frequency_conflict_message" msgid="8535404941723941766">"  <xliff:g id="DEVICE_NAME">%1$s</xliff:g>     Wi-Fi   "</string>
+    <string name="wifi_p2p_frequency_conflict_message" msgid="8535404941723941766">"  <xliff:g id="DEVICE_NAME">%1$s</xliff:g>     Wi-Fi   "</string>
     <string name="dlg_ok" msgid="254496739491689405">""</string>
     <string name="wifi_cannot_connect_with_randomized_mac_title" msgid="2344570489693915253">"<xliff:g id="SSID">%1$s</xliff:g>   "</string>
     <string name="wifi_cannot_connect_with_randomized_mac_message" msgid="4834133226521813352">"    ,   "</string>
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>   "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"   ,     ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"     "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"  "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"  "</string>
diff --git a/service/ServiceWifiResources/res/values-th/strings.xml b/service/ServiceWifiResources/res/values-th/strings.xml
index 69965b0f29..fd2b7df9ba 100644
--- a/service/ServiceWifiResources/res/values-th/strings.xml
+++ b/service/ServiceWifiResources/res/values-th/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">" <xliff:g id="VALUE">%1$s</xliff:g> "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">""</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-tl/strings.xml b/service/ServiceWifiResources/res/values-tl/strings.xml
index cff9e6499e..aea4ea8a9e 100644
--- a/service/ServiceWifiResources/res/values-tl/strings.xml
+++ b/service/ServiceWifiResources/res/values-tl/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Hindi makakonekta sa <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Invalid ang chain ng certificate ng server."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Certificate ng seguridad"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Magpatuloy lang kung pinagkakatiwalaan mo ang network na ito at mukhang tama ang impormasyon sa ibaba."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Kanselahin"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Pagkatiwalaan"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Nag-isyu"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Validity"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Mula <xliff:g id="STARTDATE">%1$s</xliff:g> hanggang <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 fingerprint"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Mga detalye ng pangalan ng paksa"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Mga detalye ng pangalan ng nag-isyu"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Bersyon"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Serial number"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Algorithm ng pampublikong key"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Laki ng pampublikong key"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Pampublikong key"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Algorithm ng signature"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Signature"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Hindi ma-verify ang network na ito"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Manatiling nakakonekta"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Idiskonekta na"</string>
diff --git a/service/ServiceWifiResources/res/values-tr/strings.xml b/service/ServiceWifiResources/res/values-tr/strings.xml
index 917f23c0c1..f2239bcc95 100644
--- a/service/ServiceWifiResources/res/values-tr/strings.xml
+++ b/service/ServiceWifiResources/res/values-tr/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g> ana balanlamyor"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Sunucu sertifikas zinciri geersiz."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"Tamam"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Gvenlik sertifikas"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Yalnzca bu aa gveniyorsanz ve aadaki bilgiler doru grnyorsa devam edin."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"ptal"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Gven"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Sunucu"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Dzenleyen"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Geerlilik"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>-<xliff:g id="ENDDATE">%2$s</xliff:g> aras"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 parmak izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 parmak izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Konusu ad ayrntlar"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Dzenleyen ad ayrntlar"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Srm"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Seri numaras"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Ortak anahtar algoritmas"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Ortak anahtar boyutu"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bits"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Ortak anahtar"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"mza algoritmas"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"mza"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Bu a dorulanamyor"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Bal kal"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Balanty imdi kes"</string>
diff --git a/service/ServiceWifiResources/res/values-uk/strings.xml b/service/ServiceWifiResources/res/values-uk/strings.xml
index e73df0aaf0..415dfcff77 100644
--- a/service/ServiceWifiResources/res/values-uk/strings.xml
+++ b/service/ServiceWifiResources/res/values-uk/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"     \"<xliff:g id="VALUE">%1$s</xliff:g>\""</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"   ."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">",          ."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">" "</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">" SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">" SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"  "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> ."</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"    "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">" "</string>
diff --git a/service/ServiceWifiResources/res/values-ur/strings.xml b/service/ServiceWifiResources/res/values-ur/strings.xml
index 25f2a7a54a..4132825af2 100644
--- a/service/ServiceWifiResources/res/values-ur/strings.xml
+++ b/service/ServiceWifiResources/res/values-ur/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>     "</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"    "</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">" "</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">" "</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"                     "</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">" "</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256  "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1  "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"    "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"     "</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"   "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"   "</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">" "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"  "</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"       "</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">" "</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"   "</string>
diff --git a/service/ServiceWifiResources/res/values-uz/strings.xml b/service/ServiceWifiResources/res/values-uz/strings.xml
index 0d705fb7ff..f0b4a97975 100644
--- a/service/ServiceWifiResources/res/values-uz/strings.xml
+++ b/service/ServiceWifiResources/res/values-uz/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g> bilan aloqa ornatilmadi"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Server sertifikatlari zanjiri yaroqsiz."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Xavfsizlik sertifikati"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Bu tarmoqqa ishonsangiz va quyidagi axborot togri korinsagina davom eting."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Bekor qilish"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Ishonch bildirish"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Server"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Emitent"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Muddati"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 barmoq izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 barmoq izi"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Subyekt nomi tafsilotlari"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Emitent nomi tafsilotlari"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Versiya"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Seriya raqami"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Ochiq kalit algoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Ochiq kalit hajmi"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Ochiq kalit"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Imzo algoritmi"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Imzo"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Bu tarmoq tasdiqlanmadi"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Uzilmasin"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Uzish"</string>
diff --git a/service/ServiceWifiResources/res/values-vi/strings.xml b/service/ServiceWifiResources/res/values-vi/strings.xml
index 511890b0e4..cf066d8aa0 100644
--- a/service/ServiceWifiResources/res/values-vi/strings.xml
+++ b/service/ServiceWifiResources/res/values-vi/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Khng th kt ni vi <xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Chui chng ch my ch khng hp l."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"OK"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Chng ch bo mt"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Bn ch nn tip tc nu tin tng mng ny v thng tin bn di l chnh xc."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Hu"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Tin cy"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"My ch"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"T chc pht hnh"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Hiu lc"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"T <xliff:g id="STARTDATE">%1$s</xliff:g> n <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Vn tay SHA-256"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Vn tay SHA-1"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Thng tin v tn ch "</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Thng tin v tn nh pht hnh"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Phin bn"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"S s-ri"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"Thut ton kho cng khai"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Kch thc kho cng khai"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> bit"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Kho cng khai"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"Thut ton ch k"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Ch k"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Khng xc minh c mng ny"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Duy tr kt ni"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Ngt kt ni ngay"</string>
diff --git a/service/ServiceWifiResources/res/values-zh-rCN/strings.xml b/service/ServiceWifiResources/res/values-zh-rCN/strings.xml
index 397a5cd95f..9989e36ac1 100644
--- a/service/ServiceWifiResources/res/values-zh-rCN/strings.xml
+++ b/service/ServiceWifiResources/res/values-zh-rCN/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">""</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"<xliff:g id="STARTDATE">%1$s</xliff:g> <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-zh-rHK/strings.xml b/service/ServiceWifiResources/res/values-zh-rHK/strings.xml
index 743108aeb1..8cb1af41c3 100644
--- a/service/ServiceWifiResources/res/values-zh-rHK/strings.xml
+++ b/service/ServiceWifiResources/res/values-zh-rHK/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">""</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g> <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-zh-rTW/strings.xml b/service/ServiceWifiResources/res/values-zh-rTW/strings.xml
index ca5f2df04e..51e7d4eaf3 100644
--- a/service/ServiceWifiResources/res/values-zh-rTW/strings.xml
+++ b/service/ServiceWifiResources/res/values-zh-rTW/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"<xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">""</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">""</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">""</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">""</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">""</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">""</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">""</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">""</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">" <xliff:g id="STARTDATE">%1$s</xliff:g>  <xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"SHA-256 "</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"SHA-1 "</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">""</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">""</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">""</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">""</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">""</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"<xliff:g id="NUMBEROFBITS">%1$s</xliff:g> "</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">""</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">""</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">""</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">""</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">""</string>
diff --git a/service/ServiceWifiResources/res/values-zu/strings.xml b/service/ServiceWifiResources/res/values-zu/strings.xml
index 14a732dccc..57a3fb0e83 100644
--- a/service/ServiceWifiResources/res/values-zu/strings.xml
+++ b/service/ServiceWifiResources/res/values-zu/strings.xml
@@ -164,6 +164,26 @@
     <string name="wifi_tofu_invalid_cert_chain_title" msgid="332710627417595752">"Ayikwazi ukuxhumeka ku-<xliff:g id="VALUE">%1$s</xliff:g>"</string>
     <string name="wifi_tofu_invalid_cert_chain_message" msgid="7047987920029432392">"Uchungechunge lwesitifiketi seseva aluvumelekile."</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text" msgid="9098567577510279854">"KULUNGILE"</string>
+    <string name="wifi_tofu_dialog2_title" msgid="1053868315289884596">"Isitifiketi sokuvikeleka"</string>
+    <string name="wifi_tofu_dialog2_message" msgid="7838488246818419952">"Qhubeka kuphela uma uyithemba le nethiwekhi futhi ulwazi olungezansi lubukeka lulungile."</string>
+    <string name="wifi_tofu_dialog2_negative_button" msgid="4366875989711122647">"Khansela"</string>
+    <string name="wifi_tofu_dialog2_positive_button" msgid="2560667815737369161">"Themba"</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name" msgid="2272963470093665866">"Iseva"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name" msgid="3110294717897513111">"Okhiphayo"</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period" msgid="2250478984584839877">"Ukuqinisekiswa"</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period" msgid="1499391361985522630">"Kusuka ngomhla ka-<xliff:g id="STARTDATE">%1$s</xliff:g> kuye ngomhla ka-<xliff:g id="ENDDATE">%2$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint" msgid="3119787225230287863">"Isigxivizo se-SHA-256 somunwe"</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint" msgid="4026450834454201502">"Isigxivizo se-SHA-1 somunwe"</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details" msgid="982538669999578332">"Imininingwane yegama lesihloko"</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details" msgid="4112857365971740060">"Imininingwane yegama lomgunyazi"</string>
+    <string name="wifi_tofu_dialog2_list_label_version" msgid="3336410982988123576">"Uhlobo"</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number" msgid="9175755251956389857">"Inombolo yomkhiqizo"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm" msgid="6563451612133895163">"I-algorithm yokhiye wasesidlangalaleni"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size" msgid="1068488437146260684">"Ubungako bukakhiye osesidlangalaleni"</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size" msgid="6293936401636648626">"Ama-bit angu-<xliff:g id="NUMBEROFBITS">%1$s</xliff:g>"</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key" msgid="7780723253531507500">"Ukhiye wasesidlangalaleni"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm" msgid="8152015614684323566">"I-algorithm yesiginesha"</string>
+    <string name="wifi_tofu_dialog2_list_label_signature" msgid="8718183896498603583">"Isiginesha"</string>
     <string name="wifi_ca_cert_dialog_preT_title" msgid="6916320484037009061">"Ayikwazi ukuqinisekisa le nethiwekhi"</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text" msgid="9118713368838029797">"Hlala uxhunyiwe"</string>
     <string name="wifi_ca_cert_dialog_preT_abort_text" msgid="1331309662999405224">"Nqamula manje"</string>
diff --git a/service/ServiceWifiResources/res/values/config.xml b/service/ServiceWifiResources/res/values/config.xml
index 92aac8ffc4..a86f3da83a 100644
--- a/service/ServiceWifiResources/res/values/config.xml
+++ b/service/ServiceWifiResources/res/values/config.xml
@@ -1090,6 +1090,9 @@
          decisions (note: packages included in
          `config_excludedFromUserApprovalForD2dInterfacePriority` are excluded). -->
     <bool translatable="false" name="config_wifiUserApprovalRequiredForD2dInterfacePriority">false</bool>
+    <!-- Indicates the timeout in seconds to cancel the user approval dialog for device-to-device
+         interface priority decisions if no reply was received. -->
+    <integer translatable="false" name="config_wifiUserApprovalForD2dTimeoutSeconds">300</integer>
     <!-- list of package names that are excluded from the user approval flag
          `config_wifiUserApprovalRequiredForD2dInterfacePriority`. I.e. any priority conflicts from
           requests by these packages will be handled by the default resolution of the framework. -->
@@ -1420,4 +1423,6 @@
          has longer off-channel dwell time (500 milliseconds to 1 sec) and a much longer pause
          timeout (60 sec) once it finds a subscriber. -->
     <bool translatable="false" name="config_wifiUsdPublisherSupported">false</bool>
+    <!-- Boolean indicating whether the mainline supplicant service should be enabled -->
+    <bool translatable="false" name="config_wifiMainlineSupplicantEnabled">false</bool>
 </resources>
diff --git a/service/ServiceWifiResources/res/values/overlayable.xml b/service/ServiceWifiResources/res/values/overlayable.xml
index dcca1a6b0b..38a76f5ee7 100644
--- a/service/ServiceWifiResources/res/values/overlayable.xml
+++ b/service/ServiceWifiResources/res/values/overlayable.xml
@@ -304,6 +304,7 @@
           <item type="bool" name="config_wifiDppAkmSupported" />
           <item type="array" name="config_wifiInterfacePriorityTreatAsForegroundList"/>
           <item type="bool" name="config_wifiUserApprovalRequiredForD2dInterfacePriority" />
+          <item type="integer" name="config_wifiUserApprovalForD2dTimeoutSeconds" />
           <item type="array" name="config_wifiExcludedFromUserApprovalForD2dInterfacePriority" />
           <item type="bool" name="config_wifiUserApprovalNotRequireForDisconnectedP2p" />
           <item type="integer" name="config_disconnectedP2pIfaceLowPriorityTimeoutMs" />
@@ -357,6 +358,7 @@
           <item type="bool" name="config_wifi_subsystem_restart_bugreport_enabled" />
           <item type="bool" name="config_wifiVoipDetectionEnabled" />
           <item type="bool" name="config_wifiUsdPublisherSupported" />
+          <item type="bool" name="config_wifiMainlineSupplicantEnabled" />
 
           <!-- Params from config.xml that can be overlayed -->
 
@@ -484,6 +486,26 @@
           <item type="string" name="wifi_ca_cert_notification_preT_message" />
           <item type="string" name="wifi_ca_cert_notification_preT_continue_text" />
           <item type="string" name="wifi_ca_cert_notification_preT_abort_text" />
+          <item type="string" name="wifi_tofu_dialog2_title" />
+          <item type="string" name="wifi_tofu_dialog2_message" />
+          <item type="string" name="wifi_tofu_dialog2_negative_button" />
+          <item type="string" name="wifi_tofu_dialog2_positive_button" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_server_name" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_issuer_name" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_validity_period" />
+          <item type="string" name="wifi_tofu_dialog2_list_content_validity_period" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_sha256_fingerprint" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_sha1_fingerprint" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_subject_name_details" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_issuer_name_details" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_version" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_serial_number" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_public_key_algorithm" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_public_key_size" />
+          <item type="string" name="wifi_tofu_dialog2_list_content_public_key_size" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_public_key" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_signature_algorithm" />
+          <item type="string" name="wifi_tofu_dialog2_list_label_signature" />
           <item type="string" name="wifi_tofu_invalid_cert_chain_title" />
           <item type="string" name="wifi_tofu_invalid_cert_chain_message" />
           <item type="string" name="wifi_tofu_invalid_cert_chain_ok_text" />
@@ -501,11 +523,13 @@
           <!-- Params from strings.xml that can be overlayed -->
 
           <!-- Params from styles.xml that can be overlayed -->
+          <item type="style" name="wifi_section" />
+          <item type="style" name="wifi_dialog" />
           <item type="style" name="wifi_item" />
           <item type="style" name="wifi_item_label" />
           <item type="style" name="wifi_item_content" />
-          <item type="style" name="wifi_section" />
-          <item type="style" name="wifi_dialog" />
+          <item type="style" name="wifi_dialog_list_divider" />
+
           <item type="style" name="wifi_p2p_invitation_received_dialog" />
           <item type="style" name="wifi_p2p_dialog_timeout" />
           <item type="style" name="wifi_p2p_dialog_row_label" />
@@ -531,6 +555,8 @@
           <!-- Params from drawable/ that can be overlayed -->
 
           <!-- Params from layout/ that can be overlayed -->
+          <item type="layout" name="wifi_dialog_list" />
+          <item type="layout" name="wifi_dialog_list_item" />
           <item type="layout" name="wifi_p2p_dialog" />
           <item type="layout" name="wifi_p2p_dialog_row" />
           <!-- Params from layout/ that can be overlayed -->
diff --git a/service/ServiceWifiResources/res/values/strings.xml b/service/ServiceWifiResources/res/values/strings.xml
index 3660d752b8..757226d497 100644
--- a/service/ServiceWifiResources/res/values/strings.xml
+++ b/service/ServiceWifiResources/res/values/strings.xml
@@ -266,6 +266,27 @@
     <string name="wifi_tofu_invalid_cert_chain_message">The server certificate chain is invalid.</string>
     <string name="wifi_tofu_invalid_cert_chain_ok_text">OK</string>
 
+    <string name="wifi_tofu_dialog2_title">Security certificate</string>
+    <string name="wifi_tofu_dialog2_message">Only continue if you trust this network and the info below looks correct.</string>
+    <string name="wifi_tofu_dialog2_negative_button">Cancel</string>
+    <string name="wifi_tofu_dialog2_positive_button">Trust</string>
+    <string name="wifi_tofu_dialog2_list_label_server_name">Server</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name">Issuer</string>
+    <string name="wifi_tofu_dialog2_list_label_validity_period">Validity</string>
+    <string name="wifi_tofu_dialog2_list_content_validity_period">From <xliff:g id="startDate">%1$s</xliff:g> to <xliff:g id="endDate">%2$s</xliff:g></string>
+    <string name="wifi_tofu_dialog2_list_label_sha256_fingerprint">SHA-256 fingerprint</string>
+    <string name="wifi_tofu_dialog2_list_label_sha1_fingerprint">SHA-1 fingerprint</string>
+    <string name="wifi_tofu_dialog2_list_label_subject_name_details">Subject name details</string>
+    <string name="wifi_tofu_dialog2_list_label_issuer_name_details">Issuer name details</string>
+    <string name="wifi_tofu_dialog2_list_label_version">Version</string>
+    <string name="wifi_tofu_dialog2_list_label_serial_number">Serial number</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_algorithm">Public key algorithm</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key_size">Public key size</string>
+    <string name="wifi_tofu_dialog2_list_content_public_key_size"><xliff:g id="numberOfBits">%1$s</xliff:g> bits</string>
+    <string name="wifi_tofu_dialog2_list_label_public_key">Public key</string>
+    <string name="wifi_tofu_dialog2_list_label_signature_algorithm">Signature algorithm</string>
+    <string name="wifi_tofu_dialog2_list_label_signature">Signature</string>
+
     <!-- Legacy EAP network dialog and notification text on Pre-T devices. -->
     <string name="wifi_ca_cert_dialog_preT_title">Can\'t verify this network</string>
     <string name="wifi_ca_cert_dialog_preT_continue_text">Stay connected</string>
diff --git a/service/ServiceWifiResources/res/values/styles.xml b/service/ServiceWifiResources/res/values/styles.xml
index e86aee8417..dd3e9609a2 100644
--- a/service/ServiceWifiResources/res/values/styles.xml
+++ b/service/ServiceWifiResources/res/values/styles.xml
@@ -97,4 +97,30 @@
     <style name="wifi_p2p_dialog2_display_pin_section" parent="@style/wifi_p2p_dialog2_pin_section" />
     <style name="wifi_p2p_dialog2_display_pin_label" parent="@style/wifi_p2p_dialog2_pin_label" />
     <style name="wifi_p2p_dialog2_display_pin" parent="@style/wifi_p2p_dialog2_pin" />
+
+    <style name="wifi_dialog_list_divider">
+        <item name="android:layout_width">match_parent</item>
+        <item name="android:layout_height">1dp</item>
+        <item name="android:background">@android:drawable/divider_horizontal_bright</item>
+    </style>
+
+    <style name="wifi_dialog_list_item_label">
+        <item name="android:layout_width">wrap_content</item>
+        <item name="android:layout_height">wrap_content</item>
+        <item name="android:layout_marginLeft">24dp</item>
+        <item name="android:layout_marginRight">24dp</item>
+        <item name="android:layout_marginTop">14dp</item>
+        <item name="android:textSize">18sp</item>
+        <item name="android:textColor">@android:color/primary_text_light</item>
+    </style>
+
+    <style name="wifi_dialog_list_item_content">
+        <item name="android:layout_width">wrap_content</item>
+        <item name="android:layout_height">wrap_content</item>
+        <item name="android:layout_marginBottom">14dp</item>
+        <item name="android:layout_marginLeft">24dp</item>
+        <item name="android:layout_marginRight">24dp</item>
+        <item name="android:textSize">14sp</item>
+        <item name="android:textColor">@android:color/secondary_text_light</item>
+    </style>
 </resources>
diff --git a/service/art-profile b/service/art-profile
index 0d857bedd7..65b89771d9 100644
--- a/service/art-profile
+++ b/service/art-profile
@@ -14,16 +14,31 @@
 # limitations under the License.
 #
 HSPLcom/android/server/wifi/ActiveModeWarden;->getClientModeManagerInRole(Lcom/android/server/wifi/ActiveModeManager$ClientRole;)Lcom/android/server/wifi/ConcreteClientModeManager;+]Lcom/android/server/wifi/ConcreteClientModeManager;Lcom/android/server/wifi/ConcreteClientModeManager;]Ljava/util/Iterator;Landroid/util/MapCollections$ArrayIterator;]Ljava/util/Set;Landroid/util/ArraySet;
+HSPLcom/android/server/wifi/ActiveModeWarden;->getPrimaryClientModeManager()Lcom/android/server/wifi/ClientModeManager;+]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;
+HSPLcom/android/server/wifi/ActiveModeWarden;->updateCurrentConnectionInfo()V+]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/ClientMode;Lcom/android/server/wifi/ConcreteClientModeManager;
+HSPLcom/android/server/wifi/ClientModeImpl$ConnectableState;->getMessageLogRec(I)Ljava/lang/String;+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
+HSPLcom/android/server/wifi/ClientModeImpl$ConnectableState;->processMessageImpl(Landroid/os/Message;)Z+]Landroid/content/res/Resources;Landroid/content/res/Resources;]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Landroid/net/wifi/WifiContext;Landroid/net/wifi/WifiContext;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/ConcreteClientModeManager;Lcom/android/server/wifi/ConcreteClientModeManager;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/InsecureEapNetworkHandler;Lcom/android/server/wifi/InsecureEapNetworkHandler;]Lcom/android/server/wifi/NetworkUpdateResult;Lcom/android/server/wifi/NetworkUpdateResult;]Lcom/android/server/wifi/WifiBlocklistMonitor;Lcom/android/server/wifi/WifiBlocklistMonitor;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;]Lcom/android/server/wifi/WifiConnectivityManager;Lcom/android/server/wifi/WifiConnectivityManager;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiHealthMonitor;Lcom/android/server/wifi/WifiHealthMonitor;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;]Lcom/android/server/wifi/hotspot2/PasspointManager;Lcom/android/server/wifi/hotspot2/PasspointManager;]Lcom/android/server/wifi/util/ActionListenerWrapper;Lcom/android/server/wifi/util/ActionListenerWrapper;]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;]Lcom/android/wifi/x/android/net/ip/IpClientManager;Lcom/android/wifi/x/android/net/ip/IpClientManager;]Lcom/android/wifi/x/com/android/internal/util/IState;Lcom/android/server/wifi/ClientModeImpl$DisconnectedState;,Lcom/android/server/wifi/ClientModeImpl$L2ConnectingState;,Lcom/android/server/wifi/ClientModeImpl$L3ConnectedState;
+HPLcom/android/server/wifi/ClientModeImpl$ConnectingOrConnectedState;->getMessageLogRec(I)Ljava/lang/String;+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
 HPLcom/android/server/wifi/ClientModeImpl$L2ConnectedState;->getMessageLogRec(I)Ljava/lang/String;+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
+HPLcom/android/server/wifi/ClientModeImpl$L2ConnectedState;->processMessageImpl(Landroid/os/Message;)Z+]Landroid/net/wifi/WifiEnterpriseConfig;Landroid/net/wifi/WifiEnterpriseConfig;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/ApplicationQosPolicyRequestHandler;Lcom/android/server/wifi/ApplicationQosPolicyRequestHandler;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/MultiInternetManager;Lcom/android/server/wifi/MultiInternetManager;]Lcom/android/server/wifi/RssiMonitor;Lcom/android/server/wifi/RssiMonitor;]Lcom/android/server/wifi/ScanDetailCache;Lcom/android/server/wifi/ScanDetailCache;]Lcom/android/server/wifi/WifiCarrierInfoManager;Lcom/android/server/wifi/WifiCarrierInfoManager;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;]Lcom/android/server/wifi/WifiDiagnostics;Lcom/android/server/wifi/WifiDiagnostics;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiInjector;Lcom/android/server/wifi/WifiInjector;]Lcom/android/server/wifi/WifiLastResortWatchdog;Lcom/android/server/wifi/WifiLastResortWatchdog;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;]Lcom/android/server/wifi/WifiTrafficPoller;Lcom/android/server/wifi/WifiTrafficPoller;]Lcom/android/wifi/x/android/net/ip/IpClientManager;Lcom/android/wifi/x/android/net/ip/IpClientManager;]Lcom/android/wifi/x/com/android/internal/util/StateMachine;Lcom/android/server/wifi/ClientModeImpl;
 HPLcom/android/server/wifi/ClientModeImpl$L2ConnectedState;->updateLinkLayerStatsRssiDataStallScoreReport(Z)Lcom/android/server/wifi/WifiLinkLayerStats;+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/WifiCarrierInfoManager;Lcom/android/server/wifi/WifiCarrierInfoManager;]Lcom/android/server/wifi/WifiDataStall;Lcom/android/server/wifi/WifiDataStall;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiInjector;Lcom/android/server/wifi/WifiInjector;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiScoreReport;Lcom/android/server/wifi/WifiScoreReport;]Lcom/android/wifi/x/android/net/ip/IpClientManager;Lcom/android/wifi/x/android/net/ip/IpClientManager;
 HPLcom/android/server/wifi/ClientModeImpl$L3ConnectedState;->getMessageLogRec(I)Ljava/lang/String;+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
-HPLcom/android/server/wifi/ClientModeImpl;->getLogRecString(Landroid/os/Message;)Ljava/lang/String;+]Landroid/net/NetworkInfo;Landroid/net/NetworkInfo;]Landroid/net/wifi/WifiConfiguration$NetworkSelectionStatus;Landroid/net/wifi/WifiConfiguration$NetworkSelectionStatus;]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/MboOceController$BtmFrameData;Lcom/android/server/wifi/MboOceController$BtmFrameData;]Lcom/android/server/wifi/NetworkUpdateResult;Lcom/android/server/wifi/NetworkUpdateResult;]Lcom/android/server/wifi/StateChangeResult;Lcom/android/server/wifi/StateChangeResult;]Lcom/android/server/wifi/SupplicantEventInfo;Lcom/android/server/wifi/SupplicantEventInfo;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;
+HSPLcom/android/server/wifi/ClientModeImpl;->getConnectionInfo()Landroid/net/wifi/WifiInfo;
+HSPLcom/android/server/wifi/ClientModeImpl;->getLogRecString(Landroid/os/Message;)Ljava/lang/String;+]Landroid/net/NetworkInfo;Landroid/net/NetworkInfo;]Landroid/net/wifi/WifiConfiguration$NetworkSelectionStatus;Landroid/net/wifi/WifiConfiguration$NetworkSelectionStatus;]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/MboOceController$BtmFrameData;Lcom/android/server/wifi/MboOceController$BtmFrameData;]Lcom/android/server/wifi/NetworkUpdateResult;Lcom/android/server/wifi/NetworkUpdateResult;]Lcom/android/server/wifi/StateChangeResult;Lcom/android/server/wifi/StateChangeResult;]Lcom/android/server/wifi/SupplicantEventInfo;Lcom/android/server/wifi/SupplicantEventInfo;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;
 HSPLcom/android/server/wifi/ClientModeImpl;->getTag()Ljava/lang/String;
-HPLcom/android/server/wifi/ClientModeImpl;->getWifiLinkLayerStats()Lcom/android/server/wifi/WifiLinkLayerStats;+]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;
-HPLcom/android/server/wifi/ClientModeImpl;->logStateAndMessage(Landroid/os/Message;Lcom/android/wifi/x/com/android/internal/util/State;)V+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
+HSPLcom/android/server/wifi/ClientModeImpl;->getWifiLinkLayerStats()Lcom/android/server/wifi/WifiLinkLayerStats;+]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;
+HSPLcom/android/server/wifi/ClientModeImpl;->logStateAndMessage(Landroid/os/Message;Lcom/android/wifi/x/com/android/internal/util/State;)V+]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;
+HSPLcom/android/server/wifi/ClientModeImpl;->logd(Ljava/lang/String;)V
+HPLcom/android/server/wifi/ClientModeImpl;->reportOnTime()Ljava/lang/String;+]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;
 HSPLcom/android/server/wifi/ClientModeImpl;->updateCurrentConnectionInfo()V+]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/WifiInjector;Lcom/android/server/wifi/WifiInjector;
-HPLcom/android/server/wifi/ExtendedWifiInfo;->updatePacketRates(Lcom/android/server/wifi/WifiLinkLayerStats;J)V
-HPLcom/android/server/wifi/ExtendedWifiInfo;->updateWifiInfoRates(IJJJJJ)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;
+HPLcom/android/server/wifi/ClientModeImpl;->updateLinkBandwidthAndCapabilities(Lcom/android/server/wifi/WifiLinkLayerStats;ZJJ)V+]Landroid/content/res/Resources;Landroid/content/res/Resources;]Landroid/net/wifi/WifiContext;Landroid/net/wifi/WifiContext;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/WifiDataStall;Lcom/android/server/wifi/WifiDataStall;]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;
+HPLcom/android/server/wifi/ClientModeImpl;->updateLinkLayerStatsRssiSpeedFrequencyCapabilities(JJ)Lcom/android/server/wifi/WifiLinkLayerStats;+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ClientModeImpl;Lcom/android/server/wifi/ClientModeImpl;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;]Lcom/android/server/wifi/WifiSignalPollResults;Lcom/android/server/wifi/WifiSignalPollResults;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;]Ljava/util/List;Ljava/util/ArrayList;
+HSPLcom/android/server/wifi/Clock;->getElapsedSinceBootMillis()J
+HSPLcom/android/server/wifi/Clock;->getWallClockMillis()J
+HSPLcom/android/server/wifi/ConcreteClientModeManager;->getConnectionInfo()Landroid/net/wifi/WifiInfo;+]Lcom/android/server/wifi/ClientMode;Lcom/android/server/wifi/ClientModeImpl;,Lcom/android/server/wifi/DefaultClientModeManager;,Lcom/android/server/wifi/ScanOnlyModeImpl;
+HSPLcom/android/server/wifi/ConfigurationMap;->getForCurrentUser(I)Landroid/net/wifi/WifiConfiguration;+]Ljava/util/Map;Ljava/util/HashMap;
+HSPLcom/android/server/wifi/ExtendedWifiInfo;->updatePacketRates(Lcom/android/server/wifi/WifiLinkLayerStats;J)V
+HSPLcom/android/server/wifi/ExtendedWifiInfo;->updateWifiInfoRates(IJJJJJ)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;
 HSPLcom/android/server/wifi/LogcatLog$RealLogMessage;-><init>(ILjava/lang/String;Ljava/lang/String;Ljava/lang/String;)V
 HSPLcom/android/server/wifi/LogcatLog$RealLogMessage;->c(J)Lcom/android/server/wifi/WifiLog$LogMessage;
 HSPLcom/android/server/wifi/LogcatLog$RealLogMessage;->copyUntilPlaceholder()V
@@ -34,63 +49,125 @@ HSPLcom/android/server/wifi/RunnerHandler;->getSignature([Ljava/lang/StackTraceE
 HSPLcom/android/server/wifi/RunnerHandler;->sendMessageAtTime(Landroid/os/Message;J)Z
 HSPLcom/android/server/wifi/RunnerState;->processMessage(Landroid/os/Message;)Z+]Lcom/android/server/wifi/RunnerState;megamorphic_types
 HPLcom/android/server/wifi/ScanDetail;-><init>(Lcom/android/server/wifi/hotspot2/NetworkDetail;Landroid/net/wifi/WifiSsid;Ljava/lang/String;Ljava/lang/String;IIJ[Landroid/net/wifi/ScanResult$InformationElement;Ljava/util/List;[B)V+]Lcom/android/server/wifi/hotspot2/NetworkDetail;Lcom/android/server/wifi/hotspot2/NetworkDetail;
+HPLcom/android/server/wifi/ScanResultMatchInfo;->fromScanResult(Landroid/net/wifi/ScanResult;)Lcom/android/server/wifi/ScanResultMatchInfo;
+HPLcom/android/server/wifi/ScoringParams;->getRssiArray(I)[I
+HPLcom/android/server/wifi/SupplicantStaIfaceHalAidlImpl;->getSignalPollResults(Ljava/lang/String;)Lcom/android/server/wifi/WifiSignalPollResults;+]Lcom/android/server/wifi/SupplicantStaIfaceHalAidlImpl;Lcom/android/server/wifi/SupplicantStaIfaceHalAidlImpl;]Lcom/android/server/wifi/WifiInjector;Lcom/android/server/wifi/WifiInjector;]Lcom/android/wifi/x/android/hardware/wifi/supplicant/ISupplicantStaIface;Lcom/android/wifi/x/android/hardware/wifi/supplicant/ISupplicantStaIface$Stub$Proxy;
+HPLcom/android/server/wifi/ThroughputPredictor;->getValidChannelUtilization(IIZ)I
 HPLcom/android/server/wifi/ThroughputPredictor;->predictThroughputInternal(IZIIIII[B)I+]Landroid/content/Context;Landroid/net/wifi/WifiContext;]Landroid/content/res/Resources;Landroid/content/res/Resources;
+HPLcom/android/server/wifi/VelocityBasedConnectedScore;->generateScore()I+]Lcom/android/server/wifi/ConnectedScore;Lcom/android/server/wifi/VelocityBasedConnectedScore;]Lcom/android/server/wifi/ScoringParams;Lcom/android/server/wifi/ScoringParams;]Lcom/android/server/wifi/VelocityBasedConnectedScore;Lcom/android/server/wifi/VelocityBasedConnectedScore;]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
+HPLcom/android/server/wifi/VelocityBasedConnectedScore;->setDeltaTimeSeconds(D)V+]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
+HPLcom/android/server/wifi/VelocityBasedConnectedScore;->updateUsingRssi(IJD)V+]Lcom/android/server/wifi/util/KalmanFilter;Lcom/android/server/wifi/util/KalmanFilter;]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
 HPLcom/android/server/wifi/WifiChannelUtilization;->calculateChannelUtilization(Lcom/android/server/wifi/WifiLinkLayerStats$ChannelStats;)V+]Landroid/util/SparseIntArray;Landroid/util/SparseIntArray;
+HPLcom/android/server/wifi/WifiChannelUtilization;->findChanStatsReference(II)Lcom/android/server/wifi/WifiLinkLayerStats$ChannelStats;+]Landroid/util/SparseArray;Landroid/util/SparseArray;]Ljava/util/ArrayDeque;Ljava/util/ArrayDeque;]Ljava/util/Iterator;Ljava/util/ArrayDeque$DeqIterator;
+HPLcom/android/server/wifi/WifiChannelUtilization;->refreshChannelStatsAndChannelUtilization(Lcom/android/server/wifi/WifiLinkLayerStats;I)V+]Landroid/content/Context;Landroid/net/wifi/WifiContext;]Landroid/content/res/Resources;Landroid/content/res/Resources;]Landroid/util/SparseArray;Landroid/util/SparseArray;
+HSPLcom/android/server/wifi/WifiConfigManager;->createExternalWifiConfiguration(Landroid/net/wifi/WifiConfiguration;ZI)Landroid/net/wifi/WifiConfiguration;
 HSPLcom/android/server/wifi/WifiConfigManager;->maskPasswordsInWifiConfiguration(Landroid/net/wifi/WifiConfiguration;)V+]Landroid/net/wifi/WifiEnterpriseConfig;Landroid/net/wifi/WifiEnterpriseConfig;
+HPLcom/android/server/wifi/WifiConfigManager;->updateScanDetailCacheFromWifiInfo(Landroid/net/wifi/WifiInfo;)V+]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ScanDetail;Lcom/android/server/wifi/ScanDetail;]Lcom/android/server/wifi/ScanDetailCache;Lcom/android/server/wifi/ScanDetailCache;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;
 HPLcom/android/server/wifi/WifiDataStall;->checkDataStallAndThroughputSufficiency(Ljava/lang/String;Lcom/android/server/wifi/WifiNative$ConnectionCapabilities;Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/server/wifi/WifiLinkLayerStats;Landroid/net/wifi/WifiInfo;JJ)I+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/DeviceConfigFacade;Lcom/android/server/wifi/DeviceConfigFacade;]Lcom/android/server/wifi/ThroughputPredictor;Lcom/android/server/wifi/ThroughputPredictor;]Lcom/android/server/wifi/WifiChannelUtilization;Lcom/android/server/wifi/WifiChannelUtilization;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;
+HPLcom/android/server/wifi/WifiDataStall;->isThroughputSufficientInternal(IIZZIJJ)Z
+HPLcom/android/server/wifi/WifiLinkLayerStats$ChannelStats;-><init>()V
 HPLcom/android/server/wifi/WifiLinkLayerStats;->aggregateLinkLayerStats()V
-HPLcom/android/server/wifi/WifiLinkLayerStats;->aggregatePacketStats()V
 HPLcom/android/server/wifi/WifiLinkLayerStats;->aggregatePeerStats()V
-HPLcom/android/server/wifi/WifiLinkLayerStats;->clearAggregatedPacketStats()V
+HPLcom/android/server/wifi/WifiMetrics;->convertContentionTimeStats(Lcom/android/server/wifi/WifiLinkLayerStats$LinkSpecificStats;)[Landroid/net/wifi/WifiUsabilityStatsEntry$ContentionTimeStats;
+HPLcom/android/server/wifi/WifiMetrics;->convertLinkStats(Lcom/android/server/wifi/WifiLinkLayerStats;Landroid/net/wifi/WifiInfo;)Landroid/util/SparseArray;+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Landroid/util/SparseArray;Landroid/util/SparseArray;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;]Ljava/util/List;Ljava/util/ArrayList;
+HPLcom/android/server/wifi/WifiMetrics;->convertPacketStats(Lcom/android/server/wifi/WifiLinkLayerStats$LinkSpecificStats;)[Landroid/net/wifi/WifiUsabilityStatsEntry$PacketStats;
+HPLcom/android/server/wifi/WifiMetrics;->convertPeerInfo(Lcom/android/server/wifi/WifiLinkLayerStats$LinkSpecificStats;)[Landroid/net/wifi/WifiUsabilityStatsEntry$PeerInfo;
+HPLcom/android/server/wifi/WifiMetrics;->createNewWifiUsabilityStatsEntryParcelable(Lcom/android/server/wifi/proto/nano/WifiMetricsProto$WifiUsabilityStatsEntry;Lcom/android/server/wifi/WifiLinkLayerStats;Landroid/net/wifi/WifiInfo;)Landroid/net/wifi/WifiUsabilityStatsEntry;
+HPLcom/android/server/wifi/WifiMetrics;->handlePollResult(Ljava/lang/String;Landroid/net/wifi/WifiInfo;)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/WifiMetrics$WifiStatusBuilder;Lcom/android/server/wifi/WifiMetrics$WifiStatusBuilder;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;
+HPLcom/android/server/wifi/WifiMetrics;->incrementAvailableNetworksHistograms(Ljava/util/List;Z)V+]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Lcom/android/server/wifi/ScanDetail;Lcom/android/server/wifi/ScanDetail;]Lcom/android/server/wifi/WifiConfigManager;Lcom/android/server/wifi/WifiConfigManager;]Lcom/android/server/wifi/WifiNetworkSelector;Lcom/android/server/wifi/WifiNetworkSelector;]Lcom/android/server/wifi/hotspot2/NetworkDetail;Lcom/android/server/wifi/hotspot2/NetworkDetail;]Lcom/android/server/wifi/hotspot2/PasspointManager;Lcom/android/server/wifi/hotspot2/PasspointManager;]Ljava/util/Collection;Ljava/util/HashMap$Values;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;,Ljava/util/HashMap$ValueIterator;]Ljava/util/List;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/WifiMetrics;->incrementPerRadioUsageStats(Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/server/wifi/WifiLinkLayerStats;)V+]Landroid/util/SparseArray;Landroid/util/SparseArray;
-HPLcom/android/server/wifi/WifiMetrics;->incrementWifiLinkLayerUsageStats(Ljava/lang/String;Lcom/android/server/wifi/WifiLinkLayerStats;)V
-HPLcom/android/server/wifi/WifiMetrics;->newLinkLayerStatsIsValid(Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/server/wifi/WifiLinkLayerStats;)Z
+HPLcom/android/server/wifi/WifiMetrics;->incrementRssiPollRssiCount(II)V+]Landroid/util/SparseIntArray;Landroid/util/SparseIntArray;]Ljava/util/Map;Ljava/util/HashMap;
+HSPLcom/android/server/wifi/WifiMetrics;->incrementWifiLinkLayerUsageStats(Ljava/lang/String;Lcom/android/server/wifi/WifiLinkLayerStats;)V
 HPLcom/android/server/wifi/WifiMetrics;->updateWifiUsabilityStatsEntries(Ljava/lang/String;Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/WifiLinkLayerStats;ZI)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Landroid/util/SparseArray;Landroid/util/SparseArray;]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;]Lcom/android/server/wifi/WifiChannelUtilization;Lcom/android/server/wifi/WifiChannelUtilization;]Lcom/android/server/wifi/WifiDataStall;Lcom/android/server/wifi/WifiDataStall;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiSettingsStore;Lcom/android/server/wifi/WifiSettingsStore;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;]Ljava/util/LinkedList;Ljava/util/LinkedList;]Ljava/util/List;Ljava/util/ArrayList;]Ljava/util/Map;Landroid/util/ArrayMap;
 HSPLcom/android/server/wifi/WifiMulticastLockManager;->uidIsLockOwner(I)Z+]Ljava/util/Map;Ljava/util/HashMap;
 HSPLcom/android/server/wifi/WifiNative$IfaceManager;->getIface(Ljava/lang/String;)Lcom/android/server/wifi/WifiNative$Iface;+]Ljava/util/Collection;Ljava/util/HashMap$Values;]Ljava/util/HashMap;Ljava/util/HashMap;]Ljava/util/Iterator;Ljava/util/HashMap$ValueIterator;
 HPLcom/android/server/wifi/WifiNative;->convertNativeScanResults(Ljava/lang/String;Ljava/util/List;)Ljava/util/ArrayList;+]Lcom/android/server/wifi/SsidTranslator;Lcom/android/server/wifi/SsidTranslator;]Lcom/android/server/wifi/WifiInjector;Lcom/android/server/wifi/WifiInjector;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;,Ljava/util/Arrays$ArrayItr;]Ljava/util/List;Ljava/util/ArrayList;,Ljava/util/Arrays$ArrayList;
+HSPLcom/android/server/wifi/WifiNative;->getCachedScanResults(Ljava/lang/String;)Landroid/net/wifi/WifiScanner$ScanData;+]Landroid/net/wifi/WifiScanner$ScanData;Landroid/net/wifi/WifiScanner$ScanData;]Lcom/android/server/wifi/WifiVendorHal;Lcom/android/server/wifi/WifiVendorHal;
 HSPLcom/android/server/wifi/WifiNative;->getSupportedFeatureSet(Ljava/lang/String;)Ljava/util/BitSet;+]Ljava/util/BitSet;Ljava/util/BitSet;
-HPLcom/android/server/wifi/WifiNative;->getWifiLinkLayerStats(Ljava/lang/String;)Lcom/android/server/wifi/WifiLinkLayerStats;+]Landroid/net/wifi/WifiScanner$ScanData;Landroid/net/wifi/WifiScanner$ScanData;]Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/server/wifi/WifiLinkLayerStats;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;]Lcom/android/server/wifi/WifiVendorHal;Lcom/android/server/wifi/WifiVendorHal;
+HSPLcom/android/server/wifi/WifiNative;->getWifiLinkLayerStats(Ljava/lang/String;)Lcom/android/server/wifi/WifiLinkLayerStats;+]Landroid/net/wifi/WifiScanner$ScanData;Landroid/net/wifi/WifiScanner$ScanData;]Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/server/wifi/WifiLinkLayerStats;]Lcom/android/server/wifi/WifiNative;Lcom/android/server/wifi/WifiNative;]Lcom/android/server/wifi/WifiVendorHal;Lcom/android/server/wifi/WifiVendorHal;
+HPLcom/android/server/wifi/WifiNetworkFactory;->acceptRequest(Landroid/net/NetworkRequest;)Z+]Landroid/net/NetworkRequest;Landroid/net/NetworkRequest;]Lcom/android/server/wifi/FrameworkFacade;Lcom/android/server/wifi/FrameworkFacade;]Lcom/android/server/wifi/MultiInternetManager;Lcom/android/server/wifi/MultiInternetManager;]Lcom/android/server/wifi/WifiNetworkFactory;Lcom/android/server/wifi/WifiNetworkFactory;]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;
+HPLcom/android/server/wifi/WifiScoreCard$PerNetwork;->getByteDeltaAccThr(I)I+]Lcom/android/server/wifi/DeviceConfigFacade;Lcom/android/server/wifi/DeviceConfigFacade;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;
+HPLcom/android/server/wifi/WifiScoreCard$PerNetwork;->updateBandwidthWithFilterApplied(ILcom/android/server/wifi/ExtendedWifiInfo;)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;]Lcom/android/server/wifi/DeviceConfigFacade;Lcom/android/server/wifi/DeviceConfigFacade;
 HPLcom/android/server/wifi/WifiScoreCard$PerUnivariateStatistic;->toUnivariateStatistic()Lcom/android/server/wifi/proto/WifiScoreCardProto$UnivariateStatistic;+]Lcom/android/server/wifi/util/IntHistogram;Lcom/android/server/wifi/util/IntHistogram;]Ljava/util/Iterator;Lcom/android/server/wifi/util/IntHistogram$1;
-HSPLcom/android/server/wifi/WifiServiceImpl;->getConnectionInfo(Ljava/lang/String;Ljava/lang/String;)Landroid/net/wifi/WifiInfo;+]Landroid/net/wifi/WifiInfo;Landroid/net/wifi/WifiInfo;]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/WifiLog$LogMessage;Lcom/android/server/wifi/LogcatLog$RealLogMessage;]Lcom/android/server/wifi/WifiLog;Lcom/android/server/wifi/LogcatLog;]Lcom/android/server/wifi/WifiThreadRunner;Lcom/android/server/wifi/WifiThreadRunner;]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;
+HPLcom/android/server/wifi/WifiScoreCard;->geTxLinkSpeedWithSufficientTxRate(Lcom/android/server/wifi/ExtendedWifiInfo;)I+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;
+HPLcom/android/server/wifi/WifiScoreCard;->lookupBssid(Ljava/lang/String;Ljava/lang/String;)Lcom/android/server/wifi/WifiScoreCard$PerBssid;+]Ljava/util/Map;Landroid/util/ArrayMap;
+HPLcom/android/server/wifi/WifiScoreCard;->lookupNetwork(Ljava/lang/String;)Lcom/android/server/wifi/WifiScoreCard$PerNetwork;+]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;]Ljava/util/Map;Landroid/util/ArrayMap;
+HPLcom/android/server/wifi/WifiScoreCard;->noteSignalPoll(Lcom/android/server/wifi/ExtendedWifiInfo;)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;
+HPLcom/android/server/wifi/WifiScoreCard;->updatePerBssid(Lcom/android/server/wifi/proto/WifiScoreCardProto$Event;Lcom/android/server/wifi/ExtendedWifiInfo;)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ExtendedWifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;
+HPLcom/android/server/wifi/WifiScoreCard;->updatePerNetwork(Lcom/android/server/wifi/proto/WifiScoreCardProto$Event;Ljava/lang/String;IIILcom/android/server/wifi/WifiScoreCard$IfaceInfo;)V+]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;
+HPLcom/android/server/wifi/WifiScoreReport;->calculateAndReportScore()V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;]Lcom/android/server/wifi/ScoringParams;Lcom/android/server/wifi/ScoringParams;]Lcom/android/server/wifi/VelocityBasedConnectedScore;Lcom/android/server/wifi/VelocityBasedConnectedScore;]Lcom/android/server/wifi/WifiConnectivityManager;Lcom/android/server/wifi/WifiConnectivityManager;]Lcom/android/server/wifi/WifiGlobals;Lcom/android/server/wifi/WifiGlobals;
+HPLcom/android/server/wifi/WifiScoreReport;->logLinkMetrics(JIIII)V+]Landroid/net/wifi/WifiInfo;Lcom/android/server/wifi/ExtendedWifiInfo;]Lcom/android/server/wifi/VelocityBasedConnectedScore;Lcom/android/server/wifi/VelocityBasedConnectedScore;]Lcom/android/server/wifi/WifiMetrics;Lcom/android/server/wifi/WifiMetrics;]Lcom/android/server/wifi/WifiScoreCard;Lcom/android/server/wifi/WifiScoreCard;]Ljava/util/Calendar;Ljava/util/GregorianCalendar;]Ljava/util/Iterator;Ljava/util/ArrayList$Itr;]Ljava/util/LinkedList;Ljava/util/LinkedList;]Ljava/util/List;Ljava/util/ArrayList;
+HSPLcom/android/server/wifi/WifiServiceImpl;->enforceAccessPermission()V
+HPLcom/android/server/wifi/WifiServiceImpl;->getConnectionInfo(Ljava/lang/String;Ljava/lang/String;)Landroid/net/wifi/WifiInfo;+]Landroid/net/wifi/WifiInfo;Landroid/net/wifi/WifiInfo;]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/WifiLog$LogMessage;Lcom/android/server/wifi/LogcatLog$RealLogMessage;]Lcom/android/server/wifi/WifiLog;Lcom/android/server/wifi/LogcatLog;]Lcom/android/server/wifi/WifiThreadRunner;Lcom/android/server/wifi/WifiThreadRunner;]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;
 HSPLcom/android/server/wifi/WifiServiceImpl;->getWifiActivityEnergyInfo()Landroid/os/connectivity/WifiActivityEnergyInfo;+]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/ClientMode;Lcom/android/server/wifi/ConcreteClientModeManager;,Lcom/android/server/wifi/DefaultClientModeManager;]Lcom/android/server/wifi/Clock;Lcom/android/server/wifi/Clock;
 HSPLcom/android/server/wifi/WifiServiceImpl;->getWifiActivityEnergyInfoAsync(Landroid/net/wifi/IOnWifiActivityEnergyInfoListener;)V+]Lcom/android/server/wifi/WifiLog$LogMessage;Lcom/android/server/wifi/LogcatLog$RealLogMessage;]Lcom/android/server/wifi/WifiLog;Lcom/android/server/wifi/LogcatLog;]Lcom/android/server/wifi/WifiServiceImpl;Lcom/android/server/wifi/WifiServiceImpl;]Lcom/android/server/wifi/WifiThreadRunner;Lcom/android/server/wifi/WifiThreadRunner;
 HSPLcom/android/server/wifi/WifiServiceImpl;->getWifiEnabledState()I+]Lcom/android/server/wifi/ActiveModeWarden;Lcom/android/server/wifi/ActiveModeWarden;]Lcom/android/server/wifi/WifiLog$LogMessage;Lcom/android/server/wifi/LogcatLog$RealLogMessage;]Lcom/android/server/wifi/WifiLog;Lcom/android/server/wifi/LogcatLog;
 HSPLcom/android/server/wifi/WifiServiceImpl;->isFeatureSupported(I)Z+]Lcom/android/server/wifi/WifiLog$LogMessage;Lcom/android/server/wifi/LogcatLog$RealLogMessage;]Lcom/android/server/wifi/WifiLog;Lcom/android/server/wifi/LogcatLog;]Ljava/util/BitSet;Ljava/util/BitSet;
 HSPLcom/android/server/wifi/WifiThreadRunner;->post(Ljava/lang/Runnable;Ljava/lang/String;)Z
+HPLcom/android/server/wifi/WifiTrafficPoller;->notifyOnDataActivity(JJ)V+]Landroid/content/Context;Landroid/net/wifi/WifiContext;]Landroid/content/res/Resources;Landroid/content/res/Resources;]Landroid/net/wifi/ITrafficStateCallback;Landroid/net/wifi/ITrafficStateCallback$Stub$Proxy;]Landroid/os/RemoteCallbackList;Landroid/os/RemoteCallbackList;]Landroid/util/SparseBooleanArray;Landroid/util/SparseBooleanArray;]Ljava/lang/Object;Landroid/net/wifi/ITrafficStateCallback$Stub$Proxy;
 HSPLcom/android/server/wifi/WifiVendorHal;->getStaIface(Ljava/lang/String;)Lcom/android/server/wifi/hal/WifiStaIface;+]Ljava/util/HashMap;Ljava/util/HashMap;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->aggregateFrameworkRadioStatsFromAidl(ILcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V+]Landroid/util/SparseArray;Landroid/util/SparseArray;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->getCachedScanData()Landroid/net/wifi/WifiScanner$ScanData;+]Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface;Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->getLinkLayerStats()Lcom/android/server/wifi/WifiLinkLayerStats;+]Lcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;Lcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;]Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface;Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->halToFrameworkLinkLayerStats(Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;)Lcom/android/server/wifi/WifiLinkLayerStats;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setFrameworkPerRadioStatsFromAidl(Lcom/android/server/wifi/WifiLinkLayerStats$RadioStat;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V+]Landroid/util/SparseArray;Landroid/util/SparseArray;
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setIfaceStatsPerLinkFromAidl(Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats;I)V
-HPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setRadioStats(Lcom/android/server/wifi/WifiLinkLayerStats;[Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V
+HSPLcom/android/server/wifi/hal/WifiStaIface;->getCachedScanData()Landroid/net/wifi/WifiScanner$ScanData;
+HSPLcom/android/server/wifi/hal/WifiStaIface;->getLinkLayerStats()Lcom/android/server/wifi/WifiLinkLayerStats;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->aggregateFrameworkRadioStatsFromAidl(ILcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V+]Landroid/util/SparseArray;Landroid/util/SparseArray;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->getCachedScanData()Landroid/net/wifi/WifiScanner$ScanData;+]Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface;Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->getLinkLayerStats()Lcom/android/server/wifi/WifiLinkLayerStats;+]Lcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;Lcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;]Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface;Lcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->halToFrameworkLinkLayerStats(Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;)Lcom/android/server/wifi/WifiLinkLayerStats;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setFrameworkPerRadioStatsFromAidl(Lcom/android/server/wifi/WifiLinkLayerStats$RadioStat;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V+]Landroid/util/SparseArray;Landroid/util/SparseArray;
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setIfaceStats(Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceStats;)V
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setIfaceStatsPerLinkFromAidl(Lcom/android/server/wifi/WifiLinkLayerStats;Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats;I)V
+HSPLcom/android/server/wifi/hal/WifiStaIfaceAidlImpl;->setRadioStats(Lcom/android/server/wifi/WifiLinkLayerStats;[Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;)V
 HPLcom/android/server/wifi/hotspot2/NetworkDetail;-><init>(Ljava/lang/String;[Landroid/net/wifi/ScanResult$InformationElement;Ljava/util/List;I)V+]Ljava/nio/CharBuffer;Ljava/nio/HeapCharBuffer;]Ljava/nio/charset/Charset;Lcom/android/icu/charset/CharsetICU;]Ljava/util/ArrayList;Ljava/util/ArrayList;]Ljava/util/List;Ljava/util/ArrayList;,Ljava/util/Collections$EmptyList;
+HPLcom/android/server/wifi/hotspot2/Utils;->parseMac(Ljava/lang/String;)J
+HPLcom/android/server/wifi/proto/WifiScoreCardProto$HistogramBucket;->dynamicMethod(Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite$MethodToInvoke;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
+HPLcom/android/server/wifi/proto/WifiScoreCardProto$UnivariateStatistic$Builder;->addBuckets(Lcom/android/server/wifi/proto/WifiScoreCardProto$HistogramBucket$Builder;)Lcom/android/server/wifi/proto/WifiScoreCardProto$UnivariateStatistic$Builder;
+HSPLcom/android/server/wifi/proto/WifiStatsLog;->write(IIILjava/lang/String;)V
+HPLcom/android/server/wifi/proto/WifiStatsLog;->write(IIZZIIIIIZIIII)V
+HPLcom/android/server/wifi/proto/WifiStatsLog;->write(I[I[Ljava/lang/String;IIZIIIIIII)V
+HPLcom/android/server/wifi/proto/nano/WifiMetricsProto$ContentionTimeStats;->clear()Lcom/android/server/wifi/proto/nano/WifiMetricsProto$ContentionTimeStats;
 HPLcom/android/server/wifi/proto/nano/WifiMetricsProto$RateStats;->clear()Lcom/android/server/wifi/proto/nano/WifiMetricsProto$RateStats;
-HPLcom/android/server/wifi/proto/nano/WifiMetricsProto$WifiUsabilityStatsEntry;->clear()Lcom/android/server/wifi/proto/nano/WifiMetricsProto$WifiUsabilityStatsEntry;
 HSPLcom/android/server/wifi/util/FeatureBitsetUtils;->formatSupportedFeatures(Ljava/util/BitSet;)Ljava/lang/String;+]Landroid/util/SparseArray;Lcom/android/server/wifi/util/FeatureBitsetUtils$1;]Ljava/util/BitSet;Ljava/util/BitSet;
 HPLcom/android/server/wifi/util/InformationElementUtil$Capabilities;->from([Landroid/net/wifi/ScanResult$InformationElement;IZZILandroid/util/SparseIntArray;)V+]Ljava/util/List;Ljava/util/ArrayList;
+HPLcom/android/server/wifi/util/InformationElementUtil$Capabilities;->generateCapabilitiesString()Ljava/lang/String;+]Ljava/util/List;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/util/InformationElementUtil$Capabilities;->generateCapabilitiesStringPerProtocol(I)Ljava/lang/String;+]Ljava/util/List;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/util/InformationElementUtil$Capabilities;->generateWPA2CapabilitiesString(Ljava/lang/String;I)Ljava/lang/String;+]Ljava/util/List;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/util/InformationElementUtil$Capabilities;->parseRsnElement(Ljava/nio/ByteBuffer;Landroid/util/SparseIntArray;)V+]Ljava/nio/ByteBuffer;Ljava/nio/HeapByteBuffer;]Ljava/util/List;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/util/InformationElementUtil$Country;->from(Landroid/net/wifi/ScanResult$InformationElement;)V+]Ljava/nio/ByteBuffer;Ljava/nio/HeapByteBuffer;
 HPLcom/android/server/wifi/util/InformationElementUtil$SupportedRates;->from(Landroid/net/wifi/ScanResult$InformationElement;)V+]Ljava/nio/ByteBuffer;Ljava/nio/HeapByteBuffer;]Ljava/util/ArrayList;Ljava/util/ArrayList;
 HPLcom/android/server/wifi/util/InformationElementUtil;->parseInformationElements([B)[Landroid/net/wifi/ScanResult$InformationElement;+]Ljava/nio/ByteBuffer;Ljava/nio/HeapByteBuffer;
+HPLcom/android/server/wifi/util/KalmanFilter;->update(Lcom/android/server/wifi/util/Matrix;)V+]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
+HPLcom/android/server/wifi/util/Matrix;->dot(Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;)Lcom/android/server/wifi/util/Matrix;+]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
+HPLcom/android/server/wifi/util/Matrix;->get(II)D
+HPLcom/android/server/wifi/util/Matrix;->inverse(Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;)Lcom/android/server/wifi/util/Matrix;+]Lcom/android/server/wifi/util/Matrix;Lcom/android/server/wifi/util/Matrix;
+HPLcom/android/server/wifi/util/StringUtil;->calendarToString(Ljava/util/Calendar;)Ljava/lang/String;+]Ljava/util/Calendar;Ljava/util/GregorianCalendar;
+HPLcom/android/server/wifi/util/StringUtil;->doubleToString(DI)Ljava/lang/String;
+HPLcom/android/server/wifi/util/WifiPermissionsUtil;->checkCallersLocationPermission(Ljava/lang/String;Ljava/lang/String;IZLjava/lang/String;)Z+]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;]Lcom/android/server/wifi/util/WifiPermissionsWrapper;Lcom/android/server/wifi/util/WifiPermissionsWrapper;
+HPLcom/android/server/wifi/util/WifiPermissionsUtil;->enforceCanAccessScanResults(Ljava/lang/String;Ljava/lang/String;ILjava/lang/String;)V+]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;]Lcom/android/server/wifi/util/WifiPermissionsWrapper;Lcom/android/server/wifi/util/WifiPermissionsWrapper;
+HSPLcom/android/server/wifi/util/WifiPermissionsUtil;->enforceNearbyDevicesPermission(Landroid/content/AttributionSource;ZLjava/lang/String;)V+]Landroid/content/Context;Landroid/net/wifi/WifiContext;]Landroid/content/pm/PackageManager;Landroid/app/ApplicationPackageManager;]Lcom/android/server/wifi/util/WifiPermissionsUtil;Lcom/android/server/wifi/util/WifiPermissionsUtil;]Lcom/android/server/wifi/util/WifiPermissionsWrapper;Lcom/android/server/wifi/util/WifiPermissionsWrapper;]Ljava/util/Set;Landroid/util/ArraySet;
+HSPLcom/android/server/wifi/util/XmlUtil$WifiConfigurationXmlUtil;->parseFromXml(Lorg/xmlpull/v1/XmlPullParser;IZLcom/android/server/wifi/util/WifiConfigStoreEncryptionUtil;Z)Landroid/util/Pair;+]Lorg/xmlpull/v1/XmlPullParser;Lcom/android/org/kxml2/io/KXmlParser;
+HPLcom/android/server/wifi/util/XmlUtil$WifiConfigurationXmlUtil;->writeCommonElementsToXml(Lorg/xmlpull/v1/XmlSerializer;Landroid/net/wifi/WifiConfiguration;Lcom/android/server/wifi/util/WifiConfigStoreEncryptionUtil;)V+]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;]Ljava/util/BitSet;Ljava/util/BitSet;
+HPLcom/android/server/wifi/util/XmlUtil$WifiConfigurationXmlUtil;->writeToXmlForConfigStore(Lorg/xmlpull/v1/XmlSerializer;Landroid/net/wifi/WifiConfiguration;Lcom/android/server/wifi/util/WifiConfigStoreEncryptionUtil;)V+]Landroid/net/wifi/WifiConfiguration;Landroid/net/wifi/WifiConfiguration;
+HSPLcom/android/server/wifi/util/XmlUtilHelper;->readThisPrimitiveValueXml(Lorg/xmlpull/v1/XmlPullParser;Ljava/lang/String;)Ljava/lang/Object;+]Lorg/xmlpull/v1/XmlPullParser;Lcom/android/org/kxml2/io/KXmlParser;
 HSPLcom/android/server/wifi/util/XmlUtilHelper;->readThisValueXml(Lorg/xmlpull/v1/XmlPullParser;[Ljava/lang/String;Lcom/android/server/wifi/util/XmlUtilHelper$ReadMapCallback;Z)Ljava/lang/Object;+]Lorg/xmlpull/v1/XmlPullParser;Lcom/android/org/kxml2/io/KXmlParser;
+HPLcom/android/server/wifi/util/XmlUtilHelper;->writeByteArrayXml([BLjava/lang/String;Lorg/xmlpull/v1/XmlSerializer;)V+]Lorg/xmlpull/v1/XmlSerializer;Lcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;
 HPLcom/android/server/wifi/util/XmlUtilHelper;->writeValueXml(Ljava/lang/Object;Ljava/lang/String;Lorg/xmlpull/v1/XmlSerializer;Lcom/android/server/wifi/util/XmlUtilHelper$WriteMapCallback;)V+]Ljava/lang/Object;Ljava/lang/Boolean;,Ljava/lang/Float;,Ljava/lang/Integer;,Ljava/lang/Long;]Lorg/xmlpull/v1/XmlSerializer;Lcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;
-HPLcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;->getCachedScanData()Lcom/android/wifi/x/android/hardware/wifi/CachedScanData;+]Landroid/os/IBinder;Landroid/os/BinderProxy;
-HPLcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;->getLinkLayerStats()Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;+]Landroid/os/IBinder;Landroid/os/BinderProxy;
+HSPLcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;->getCachedScanData()Lcom/android/wifi/x/android/hardware/wifi/CachedScanData;+]Landroid/os/IBinder;Landroid/os/BinderProxy;
+HSPLcom/android/wifi/x/android/hardware/wifi/IWifiStaIface$Stub$Proxy;->getLinkLayerStats()Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;+]Landroid/os/IBinder;Landroid/os/BinderProxy;
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceContentionTimeStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceContentionTimeStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceContentionTimeStats;->readFromParcel(Landroid/os/Parcel;)V
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfacePacketStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfacePacketStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfacePacketStats;->readFromParcel(Landroid/os/Parcel;)V
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerIfaceStats;->readFromParcel(Landroid/os/Parcel;)V
-HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats;-><init>()V
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerLinkStats;->readFromParcel(Landroid/os/Parcel;)V
-HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;-><init>()V
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerRadioStats;->readFromParcel(Landroid/os/Parcel;)V
+HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;
 HPLcom/android/wifi/x/android/hardware/wifi/StaLinkLayerStats;->readFromParcel(Landroid/os/Parcel;)V
+HPLcom/android/wifi/x/android/hardware/wifi/StaPeerInfo$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaPeerInfo;
 HPLcom/android/wifi/x/android/hardware/wifi/StaPeerInfo;->readFromParcel(Landroid/os/Parcel;)V
-HPLcom/android/wifi/x/android/hardware/wifi/StaRateStat;-><init>()V
+HPLcom/android/wifi/x/android/hardware/wifi/StaRateStat$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/StaRateStat;
+HPLcom/android/wifi/x/android/hardware/wifi/StaRateStat$1;->createFromParcel(Landroid/os/Parcel;)Ljava/lang/Object;+]Lcom/android/wifi/x/android/hardware/wifi/StaRateStat$1;Lcom/android/wifi/x/android/hardware/wifi/StaRateStat$1;
 HPLcom/android/wifi/x/android/hardware/wifi/StaRateStat;->readFromParcel(Landroid/os/Parcel;)V
 HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo;
 HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo$1;->createFromParcel(Landroid/os/Parcel;)Ljava/lang/Object;+]Lcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo$1;Lcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo$1;
@@ -98,16 +175,25 @@ HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelInfo;->readFromParcel(Lan
 HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelStats$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/WifiChannelStats;
 HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelStats$1;->createFromParcel(Landroid/os/Parcel;)Ljava/lang/Object;+]Lcom/android/wifi/x/android/hardware/wifi/WifiChannelStats$1;Lcom/android/wifi/x/android/hardware/wifi/WifiChannelStats$1;
 HPLcom/android/wifi/x/android/hardware/wifi/WifiChannelStats;->readFromParcel(Landroid/os/Parcel;)V
-HPLcom/android/wifi/x/android/hardware/wifi/WifiRateInfo;-><init>()V
+HPLcom/android/wifi/x/android/hardware/wifi/WifiRateInfo$1;->createFromParcel(Landroid/os/Parcel;)Lcom/android/wifi/x/android/hardware/wifi/WifiRateInfo;
+HPLcom/android/wifi/x/android/hardware/wifi/WifiRateInfo$1;->createFromParcel(Landroid/os/Parcel;)Ljava/lang/Object;+]Lcom/android/wifi/x/android/hardware/wifi/WifiRateInfo$1;Lcom/android/wifi/x/android/hardware/wifi/WifiRateInfo$1;
 HPLcom/android/wifi/x/android/hardware/wifi/WifiRateInfo;->readFromParcel(Landroid/os/Parcel;)V
+HPLcom/android/wifi/x/android/hardware/wifi/supplicant/ISupplicantStaIface$Stub$Proxy;->getSignalPollResults()[Lcom/android/wifi/x/android/hardware/wifi/supplicant/SignalPollResult;+]Landroid/os/IBinder;Landroid/os/BinderProxy;
+HPLcom/android/wifi/x/android/hardware/wifi/supplicant/SignalPollResult;->readFromParcel(Landroid/os/Parcel;)V
 HSPLcom/android/wifi/x/android/net/INetdUnsolicitedEventListener$Stub;->onTransact(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z+]Lcom/android/wifi/x/android/net/INetdUnsolicitedEventListener;Lcom/android/server/wifi/util/NetdWrapper$NetdUnsolicitedEventListener;
 HPLcom/android/wifi/x/android/net/NetworkFactoryImpl;->handleAddRequest(Landroid/net/NetworkRequest;)V+]Lcom/android/wifi/x/android/net/NetworkFactory;megamorphic_types]Ljava/util/Map;Ljava/util/LinkedHashMap;
 HSPLcom/android/wifi/x/android/util/LocalLog;->append(Ljava/lang/String;)V+]Ljava/util/Deque;Ljava/util/ArrayDeque;
 HSPLcom/android/wifi/x/android/util/LocalLog;->log(Ljava/lang/String;)V
+HPLcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;->append(Ljava/lang/String;)V
 HPLcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;->append(Ljava/lang/String;II)V+]Lcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;Lcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;
 HPLcom/android/wifi/x/com/android/internal/util/FastXmlSerializer;->escapeAndAppendString(Ljava/lang/String;)V
+HPLcom/android/wifi/x/com/google/protobuf/CodedOutputStream$ArrayEncoder;->writeTag(II)V
+HPLcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;->dynamicMethod(Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite$MethodToInvoke;)Ljava/lang/Object;+]Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;megamorphic_types
+HPLcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;->getSerializedSize(Lcom/android/wifi/x/com/google/protobuf/Schema;)I+]Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;megamorphic_types
 HPLcom/android/wifi/x/com/google/protobuf/MessageSchema;->getSerializedSizeProto2(Ljava/lang/Object;)I
+HPLcom/android/wifi/x/com/google/protobuf/MessageSchema;->isMutable(Ljava/lang/Object;)Z+]Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;megamorphic_types
 HPLcom/android/wifi/x/com/google/protobuf/MessageSchema;->makeImmutable(Ljava/lang/Object;)V+]Lcom/android/wifi/x/com/google/protobuf/GeneratedMessageLite;megamorphic_types]Lcom/android/wifi/x/com/google/protobuf/ListFieldSchema;Lcom/android/wifi/x/com/google/protobuf/ListFieldSchema$ListFieldSchemaLite;]Lcom/android/wifi/x/com/google/protobuf/Schema;Lcom/android/wifi/x/com/google/protobuf/MessageSchema;]Lcom/android/wifi/x/com/google/protobuf/UnknownFieldSchema;Lcom/android/wifi/x/com/google/protobuf/UnknownFieldSetLiteSchema;
+HPLcom/android/wifi/x/com/google/protobuf/MessageSchema;->parseProto2Message(Ljava/lang/Object;[BIIILcom/android/wifi/x/com/google/protobuf/ArrayDecoders$Registers;)I+]Lcom/android/wifi/x/com/google/protobuf/Internal$EnumVerifier;Lcom/android/server/wifi/proto/WifiScoreCardProto$Event$EventVerifier;,Lcom/android/server/wifi/proto/WifiScoreCardProto$SecurityType$SecurityTypeVerifier;]Lcom/android/wifi/x/com/google/protobuf/Internal$ProtobufList;Lcom/android/wifi/x/com/google/protobuf/ProtobufArrayList;]Ljava/util/List;Lcom/android/wifi/x/com/google/protobuf/ProtobufArrayList;
 HPLcom/android/wifi/x/com/google/protobuf/MessageSchema;->writeFieldsInAscendingOrderProto2(Ljava/lang/Object;Lcom/android/wifi/x/com/google/protobuf/Writer;)V+]Lcom/android/wifi/x/com/google/protobuf/Writer;Lcom/android/wifi/x/com/google/protobuf/CodedOutputStreamWriter;
 HPLcom/android/wifi/x/com/google/protobuf/ProtobufArrayList;->add(Ljava/lang/Object;)Z
 HSPLcom/android/wifi/x/com/google/protobuf/nano/MessageNano;-><init>()V
@@ -117,7 +203,6 @@ Landroid/net/wifi/IOnWifiUsabilityStatsListener$Stub$Proxy;
 Landroid/net/wifi/ITrafficStateCallback$Stub$Proxy;
 Landroid/net/wifi/WifiManager$OnDriverCountryCodeChangedProxy;
 Landroid/net/wifi/WifiManager$OnWifiActivityEnergyInfoProxy;
-Landroid/net/wifi/WifiScanner$ServiceListener;
 Landroid/os/BinderProxy;
 Landroid/util/MapCollections$ArrayIterator;
 Landroid/util/MapCollections$EntrySet;
@@ -148,7 +233,6 @@ Ljava/util/HashMap$KeySet;
 Ljava/util/HashMap$Node;
 Ljava/util/HashMap$ValueIterator;
 Ljava/util/HashMap$Values;
-Ljava/util/ImmutableCollections$Set12;
 Ljava/util/LinkedHashMap$LinkedKeyIterator;
 Ljava/util/LinkedList$ListItr;
 Ljava/util/TreeMap$KeyIterator;
@@ -156,7 +240,6 @@ Ljava/util/TreeMap$NavigableSubMap$SubMapKeyIterator;
 Ljava/util/stream/ReferencePipeline$2;
 Ljava/util/stream/ReferencePipeline$3;
 Ljava/util/stream/ReferencePipeline$4;
-Ljava/util/stream/ReferencePipeline$7;
 Ljava/util/stream/ReferencePipeline$Head;
 Ljava/util/stream/SortedOps$OfRef;
 Ljava/util/stream/Streams$StreamBuilderImpl;
diff --git a/service/java/com/android/server/wifi/ActiveModeWarden.java b/service/java/com/android/server/wifi/ActiveModeWarden.java
index 4636099d20..5bb0270030 100644
--- a/service/java/com/android/server/wifi/ActiveModeWarden.java
+++ b/service/java/com/android/server/wifi/ActiveModeWarden.java
@@ -2054,7 +2054,8 @@ public class ActiveModeWarden {
             mWifiMetrics.noteWifiEnabledDuringBoot(mSettingsStore.isWifiToggleEnabled());
             if (mSettingsStore.isWifiToggleEnabled()) {
                 boolean isWifiWakeOn = mWifiInjector.getWakeupController().isUsable();
-                mWifiMetrics.reportWifiStateChanged(true, isWifiWakeOn, false);
+                mWifiMetrics.reportWifiStateChanged(true, isWifiWakeOn, false,
+                        Process.WIFI_UID);
                 if (mVerboseLoggingEnabled) {
                     Log.d(TAG, "logging wifi is on after boot. wifi wake state=" + isWifiWakeOn);
                 }
@@ -2508,6 +2509,28 @@ public class ActiveModeWarden {
                 return null;
             }
 
+            private boolean isCallerCarApp(@NonNull AdditionalClientModeManagerRequestInfo
+                    requestInfo) {
+                WorkSource workSource = requestInfo.requestorWs;
+                if (workSource == null) {
+                    return false;
+                }
+                for (int i = 0; i < workSource.size(); i++) {
+                    int curUid = workSource.getUid(i);
+                    if (mAllowRootToGetLocalOnlyCmm && curUid == 0) { // 0 is root UID.
+                        continue;
+                    }
+                    if (curUid != Process.SYSTEM_UID
+                            && mWifiPermissionsUtil.checkEnterCarModePrioritized(curUid)) {
+                        if (mVerboseLoggingEnabled) {
+                            Log.w(TAG, "Uid " + curUid + " has car mode permission");
+                        }
+                        return true;
+                    }
+                }
+                return false;
+            }
+
             private void handleAdditionalClientModeManagerRequest(
                     @NonNull AdditionalClientModeManagerRequestInfo requestInfo) {
                 if (mWifiState.get() == WIFI_STATE_DISABLING
@@ -2525,21 +2548,12 @@ public class ActiveModeWarden {
                 if (!requestInfo.preferSecondarySta
                         && requestInfo.clientRole == ROLE_CLIENT_LOCAL_ONLY
                         && requestInfo.requestorWs != null) {
-                    WorkSource workSource = requestInfo.requestorWs;
-                    for (int i = 0; i < workSource.size(); i++) {
-                        int curUid = workSource.getUid(i);
-                        if (mAllowRootToGetLocalOnlyCmm && curUid == 0) { // 0 is root UID.
-                            continue;
-                        }
-                        if (curUid != Process.SYSTEM_UID
-                                && mWifiPermissionsUtil.checkEnterCarModePrioritized(curUid)) {
-                            requestInfo.listener.onAnswer(primaryManager);
-                            if (mVerboseLoggingEnabled) {
-                                Log.w(TAG, "Uid " + curUid
-                                        + " has car mode permission - disabling STA+STA");
-                            }
-                            return;
+                    if (isCallerCarApp(requestInfo)) {
+                        requestInfo.listener.onAnswer(primaryManager);
+                        if (mVerboseLoggingEnabled) {
+                            Log.w(TAG, "Use primary STA for app with car mode permission");
                         }
+                        return;
                     }
                 }
                 if (requestInfo.clientRole == ROLE_CLIENT_SECONDARY_TRANSIENT
@@ -2623,7 +2637,8 @@ public class ActiveModeWarden {
                         && isStaStaConcurrencySupportedForLocalOnlyConnections()
                         && !mWifiPermissionsUtil.isTargetSdkLessThan(
                         requestInfo.requestorWs.getPackageName(0), Build.VERSION_CODES.S,
-                        requestInfo.requestorWs.getUid(0))) {
+                        requestInfo.requestorWs.getUid(0))
+                        && !isCallerCarApp(requestInfo)) {
                     Log.d(TAG, "Will not fall back to single STA for a local-only connection when "
                             + "STA+STA is supported (unless for a pre-S legacy app). "
                             + " Priority inversion.");
diff --git a/service/java/com/android/server/wifi/ApplicationQosPolicyRequestHandler.java b/service/java/com/android/server/wifi/ApplicationQosPolicyRequestHandler.java
index f5893d5817..0972d59ac0 100644
--- a/service/java/com/android/server/wifi/ApplicationQosPolicyRequestHandler.java
+++ b/service/java/com/android/server/wifi/ApplicationQosPolicyRequestHandler.java
@@ -67,7 +67,6 @@ public class ApplicationQosPolicyRequestHandler {
     private final ApCallback mApCallback;
     private final ApplicationQosPolicyTrackingTable mPolicyTrackingTable;
     private final ApplicationDeathRecipient mApplicationDeathRecipient;
-    private final DeviceConfigFacade mDeviceConfigFacade;
     private final Context mContext;
     private boolean mVerboseLoggingEnabled;
 
@@ -247,7 +246,7 @@ public class ApplicationQosPolicyRequestHandler {
 
     public ApplicationQosPolicyRequestHandler(@NonNull ActiveModeWarden activeModeWarden,
             @NonNull WifiNative wifiNative, @NonNull HandlerThread handlerThread,
-            @NonNull DeviceConfigFacade deviceConfigFacade, @NonNull Context context) {
+            @NonNull Context context) {
         mActiveModeWarden = activeModeWarden;
         mWifiNative = wifiNative;
         mHandler = new Handler(handlerThread.getLooper());
@@ -257,7 +256,6 @@ public class ApplicationQosPolicyRequestHandler {
         mApplicationUidToBinderMap = new HashMap<>();
         mApCallback = new ApCallback();
         mApplicationDeathRecipient = new ApplicationDeathRecipient();
-        mDeviceConfigFacade = deviceConfigFacade;
         mContext = context;
         mVerboseLoggingEnabled = false;
         mPolicyTrackingTable =
@@ -285,18 +283,22 @@ public class ApplicationQosPolicyRequestHandler {
         }
     }
 
+    private boolean isEnabledInOverlay() {
+        return mContext.getResources().getBoolean(
+                R.bool.config_wifiApplicationCentricQosPolicyFeatureEnabled);
+    }
+
+    private boolean isSupportedInHal() {
+        return mWifiNative.isSupplicantAidlServiceVersionAtLeast(2);
+    }
+
     /**
      * Check whether the Application QoS policy feature is enabled.
      *
      * @return true if the feature is enabled, false otherwise.
      */
     public boolean isFeatureEnabled() {
-        // Both the experiment flag and overlay value must be enabled,
-        // and the HAL must support this feature.
-        return mDeviceConfigFacade.isApplicationQosPolicyApiEnabled()
-                && mContext.getResources().getBoolean(
-                R.bool.config_wifiApplicationCentricQosPolicyFeatureEnabled)
-                && mWifiNative.isSupplicantAidlServiceVersionAtLeast(2);
+        return isEnabledInOverlay() && isSupportedInHal();
     }
 
     /**
@@ -752,6 +754,8 @@ public class ApplicationQosPolicyRequestHandler {
      */
     public void dump(PrintWriter pw) {
         pw.println("Dump of ApplicationQosPolicyRequestHandler");
+        pw.println("Overlay enabled: " + isEnabledInOverlay());
+        pw.println("HAL support: " + isSupportedInHal());
         pw.println("mPerIfaceRequestQueue: " + mPerIfaceRequestQueue);
         pw.println("mPendingCallbacks: " + mPendingCallbacks);
         pw.println();
diff --git a/service/java/com/android/server/wifi/BuildProperties.java b/service/java/com/android/server/wifi/BuildProperties.java
index 9b9204bbea..c5019f919f 100644
--- a/service/java/com/android/server/wifi/BuildProperties.java
+++ b/service/java/com/android/server/wifi/BuildProperties.java
@@ -16,9 +16,12 @@
 
 package com.android.server.wifi;
 
+import androidx.annotation.Keep;
+
 import com.android.internal.annotations.VisibleForTesting;
 
 /** Abstraction of android.os.Build, to enable mocking statics for testing. */
+@Keep
 @VisibleForTesting
 public interface BuildProperties {
     /** Returns true iff this is an eng build. */
diff --git a/service/java/com/android/server/wifi/ClientModeImpl.java b/service/java/com/android/server/wifi/ClientModeImpl.java
index 08e93bdf7f..9a1c8277d7 100644
--- a/service/java/com/android/server/wifi/ClientModeImpl.java
+++ b/service/java/com/android/server/wifi/ClientModeImpl.java
@@ -910,6 +910,7 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                 mFacade,
                 mNotificationManager,
                 mWifiInjector.getWifiDialogManager(),
+                mWifiInjector.getDeviceConfigFacade().getFeatureFlags(),
                 isTrustOnFirstUseSupported(),
                 mWifiGlobals.isInsecureEnterpriseConfigurationAllowed(),
                 mInsecureEapNetworkHandlerCallbacksImpl,
@@ -1047,6 +1048,13 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
         removeMessages(WifiMonitor.QOS_POLICY_REQUEST_EVENT);
     }
 
+    private void handleP2pConnectionStateChanged(Message msg) {
+        if (msg != null && msg.obj != null) {
+            NetworkInfo info = (NetworkInfo) msg.obj;
+            mWifiLockManager.updateP2pConnected(info.isConnected());
+        }
+    }
+
     /**
      * Class to implement the MulticastLockManager.FilterController callback.
      */
@@ -3266,6 +3274,9 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                 setMultiLinkInfoFromScanCache(stateChangeResult.bssid);
             }
             if (state == SupplicantState.ASSOCIATED) {
+                long txBytes = mFacade.getTotalTxBytes() - mFacade.getMobileTxBytes();
+                long rxBytes = mFacade.getTotalRxBytes() - mFacade.getMobileRxBytes();
+                updateLinkLayerStatsRssiSpeedFrequencyCapabilities(txBytes, rxBytes);
                 updateWifiInfoLinkParamsAfterAssociation();
             }
             mWifiInfo.setInformationElements(findMatchingInfoElements(stateChangeResult.bssid));
@@ -5112,7 +5123,11 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                     }
                     break;
                 }
-                case WifiP2pServiceImpl.P2P_CONNECTION_CHANGED:
+                case WifiP2pServiceImpl.P2P_CONNECTION_CHANGED: {
+                    // Handle in the base state so that this applies to all states.
+                    handleP2pConnectionStateChanged(message);
+                    break;
+                }
                 case CMD_RESET_SIM_NETWORKS:
                 case WifiMonitor.NETWORK_CONNECTION_EVENT:
                 case WifiMonitor.NETWORK_DISCONNECTION_EVENT:
@@ -5450,6 +5465,13 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
         mNetworkAgent.sendNetworkCapabilitiesAndCache(networkCapabilities);
     }
 
+    private void removeCurrentNetworkAndNativeData(int networkId) {
+        // remove local PMKSA cache in framework
+        mWifiNative.removeNetworkCachedData(networkId);
+        // remove network so that supplicant's PMKSA cache & other cached data are cleared.
+        mWifiNative.removeAllNetworks(mInterfaceName);
+    }
+
     private void handleEapAuthFailure(int networkId, int errorCode) {
         WifiConfiguration targetedNetwork =
                 mWifiConfigManager.getConfiguredNetwork(mTargetNetworkId);
@@ -5460,6 +5482,7 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                 case WifiEnterpriseConfig.Eap.AKA_PRIME:
                     if (errorCode == WifiNative.EAP_SIM_VENDOR_SPECIFIC_CERT_EXPIRED) {
                         mWifiCarrierInfoManager.resetCarrierKeysForImsiEncryption(targetedNetwork);
+                        removeCurrentNetworkAndNativeData(networkId);
                     } else {
                         int carrierId = targetedNetwork.carrierId;
                         if (mWifiCarrierInfoManager.isOobPseudonymFeatureEnabled(carrierId)) {
@@ -5500,6 +5523,8 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
         public void onValidationStatus(int status, @Nullable Uri redirectUri) {
             if (!isThisCallbackActive()) return;
             if (status == mLastNetworkStatus) return;
+
+            long validationTimestamp = mClock.getElapsedSinceBootMillis();
             mLastNetworkStatus = status;
             if (status == NetworkAgent.VALIDATION_STATUS_NOT_VALID) {
                 if (mVerboseLoggingEnabled) {
@@ -5525,6 +5550,14 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                 mCmiMonitor.onCaptivePortalDetected(mClientModeManager);
                 mCurrentConnectionDetectedCaptivePortal = true;
             }
+
+            mWifiMetrics.setLastValidationInfo(
+                    mInterfaceName, status, mL3ConnectedStateTimestamp, validationTimestamp,
+                    captivePortalDetected);
+            if (status == NetworkAgent.VALIDATION_STATUS_VALID) {
+                // Log vaidation success for each connection session
+                mWifiMetrics.reportWifiValidationResult(mInterfaceName, status);
+            }
         }
 
         @Override
@@ -6423,13 +6456,10 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                 case CMD_CONNECTING_WATCHDOG_TIMER: {
                     if (mConnectingWatchdogCount == message.arg1) {
                         if (mVerboseLoggingEnabled) log("Connecting watchdog! -> disconnect");
-                        reportConnectionAttemptEnd(
-                                WifiMetrics.ConnectionEvent.FAILURE_NO_RESPONSE,
-                                WifiMetricsProto.ConnectionEvent.HLF_NONE,
-                                WifiMetricsProto.ConnectionEvent.FAILURE_REASON_UNKNOWN, 0);
-                        handleNetworkDisconnect(false,
-                                WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__CONNECTING_WATCHDOG_TIMER);
-                        transitionTo(mDisconnectedState);
+                        mFrameworkDisconnectReasonOverride =
+                                WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__CONNECTING_WATCHDOG_TIMER;
+                        sendMessageAtFrontOfQueue(CMD_DISCONNECT,
+                                StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER);
                     }
                     break;
                 }
@@ -6679,7 +6709,7 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                     NetworkConnectionEventInfo connectionInfo =
                             (NetworkConnectionEventInfo) message.obj;
                     mLastNetworkId = connectionInfo.networkId;
-                    mWifiMetrics.onRoamComplete();
+                    mWifiMetrics.onRoamComplete(mInterfaceName);
                     handleNetworkConnectionEventInfo(
                             getConnectedWifiConfigurationInternal(), connectionInfo);
                     mWifiInfo.setMacAddress(mWifiNative.getMacAddress(mInterfaceName));
@@ -6839,10 +6869,7 @@ public class ClientModeImpl extends StateMachine implements ClientMode {
                             mWifiMetrics.logStaEvent(mInterfaceName,
                                     StaEvent.TYPE_FRAMEWORK_DISCONNECT,
                                     StaEvent.DISCONNECT_RESET_SIM_NETWORKS);
-                            // remove local PMKSA cache in framework
-                            mWifiNative.removeNetworkCachedData(mLastNetworkId);
-                            // remove network so that supplicant's PMKSA cache is cleared
-                            mWifiNative.removeAllNetworks(mInterfaceName);
+                            removeCurrentNetworkAndNativeData(mLastNetworkId);
                             if (isPrimary() && isSimBasedNetwork && !isLastSubReady) {
                                 mSimRequiredNotifier.showSimRequiredNotification(
                                         config, mLastSimBasedConnectionCarrierName);
diff --git a/service/java/com/android/server/wifi/ConnectionFailureNotifier.java b/service/java/com/android/server/wifi/ConnectionFailureNotifier.java
index 9131144315..918ef27618 100644
--- a/service/java/com/android/server/wifi/ConnectionFailureNotifier.java
+++ b/service/java/com/android/server/wifi/ConnectionFailureNotifier.java
@@ -122,12 +122,7 @@ public class ConnectionFailureNotifier {
             return;
         }
 
-        mWifiDialogManager.createSimpleDialog(
-                res.getString(R.string.wifi_disable_mac_randomization_dialog_title),
-                res.getString(R.string.wifi_disable_mac_randomization_dialog_message, config.SSID),
-                res.getString(R.string.wifi_disable_mac_randomization_dialog_confirm_text),
-                res.getString(android.R.string.cancel),
-                null /* neutralButtonText */,
+        WifiDialogManager.SimpleDialogCallback callback =
                 new WifiDialogManager.SimpleDialogCallback() {
                     @Override
                     public void onPositiveButtonClicked() {
@@ -168,7 +163,16 @@ public class ConnectionFailureNotifier {
                     public void onCancelled() {
                         // Do nothing.
                     }
-                },
-                new WifiThreadRunner(mHandler)).launchDialog();
+                };
+        mWifiDialogManager.createSimpleDialogBuilder()
+                .setTitle(res.getString(R.string.wifi_disable_mac_randomization_dialog_title))
+                .setMessage(res.getString(R.string.wifi_disable_mac_randomization_dialog_message,
+                        config.SSID))
+                .setPositiveButtonText(
+                        res.getString(R.string.wifi_disable_mac_randomization_dialog_confirm_text))
+                .setNegativeButtonText(res.getString(android.R.string.cancel))
+                .setCallback(callback, new WifiThreadRunner(mHandler))
+                .build()
+                .launchDialog();
     }
 }
diff --git a/service/java/com/android/server/wifi/FrameworkFacade.java b/service/java/com/android/server/wifi/FrameworkFacade.java
index 086bff6db1..b56e93004f 100644
--- a/service/java/com/android/server/wifi/FrameworkFacade.java
+++ b/service/java/com/android/server/wifi/FrameworkFacade.java
@@ -301,8 +301,8 @@ public class FrameworkFacade {
      * Create a new instance of {@link AlertDialog.Builder}.
      * @param context reference to a Context
      * @return an instance of AlertDialog.Builder
-     * @deprecated Use {@link WifiDialogManager#createSimpleDialog} instead, or create another
-     *             dialog type in WifiDialogManager.
+     * @deprecated Use {@link WifiDialogManager#createSimpleDialogBuilder} instead, or create
+     *             another dialog type in WifiDialogManager.
      */
     public AlertDialog.Builder makeAlertDialogBuilder(Context context) {
         boolean isDarkTheme = (context.getResources().getConfiguration().uiMode
diff --git a/service/java/com/android/server/wifi/HalDeviceManager.java b/service/java/com/android/server/wifi/HalDeviceManager.java
index 9a0bf0ae64..79b872226a 100644
--- a/service/java/com/android/server/wifi/HalDeviceManager.java
+++ b/service/java/com/android/server/wifi/HalDeviceManager.java
@@ -163,18 +163,26 @@ public class HalDeviceManager {
         // Monitor P2P connection to treat disconnected P2P as low priority.
         IntentFilter intentFilter = new IntentFilter();
         intentFilter.addAction(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION);
-        mContext.registerReceiver(new BroadcastReceiver() {
-            @Override
-            public void onReceive(Context context, Intent intent) {
-                if (!intent.getAction().equals(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION)) {
-                    return;
-                }
-                NetworkInfo networkInfo =
-                        intent.getParcelableExtra(WifiP2pManager.EXTRA_NETWORK_INFO);
-                mIsP2pConnected = networkInfo != null
-                        && networkInfo.getDetailedState() == NetworkInfo.DetailedState.CONNECTED;
-            }
-        }, intentFilter, null, mEventHandler);
+        BroadcastReceiver p2pConnectionChangedReceiver = new BroadcastReceiver() {
+                @Override
+                public void onReceive(Context context, Intent intent) {
+                    if (!intent.getAction().equals(
+                                WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION)) {
+                        return;
+                    }
+                    NetworkInfo networkInfo =
+                            intent.getParcelableExtra(WifiP2pManager.EXTRA_NETWORK_INFO);
+                    mIsP2pConnected = networkInfo != null
+                            && networkInfo.getDetailedState()
+                                    == NetworkInfo.DetailedState.CONNECTED;
+                }};
+        if (mFeatureFlags.monitorIntentForAllUsers()) {
+            mContext.registerReceiverForAllUsers(
+                    p2pConnectionChangedReceiver, intentFilter, null, mEventHandler);
+        } else {
+            mContext.registerReceiver(p2pConnectionChangedReceiver, intentFilter,
+                    null, mEventHandler);
+        }
     }
 
     @VisibleForTesting
diff --git a/service/java/com/android/server/wifi/HostapdHalAidlImp.java b/service/java/com/android/server/wifi/HostapdHalAidlImp.java
index d73880f973..3107b85ff0 100644
--- a/service/java/com/android/server/wifi/HostapdHalAidlImp.java
+++ b/service/java/com/android/server/wifi/HostapdHalAidlImp.java
@@ -66,9 +66,7 @@ import java.io.PrintWriter;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.HashMap;
-import java.util.HashSet;
 import java.util.List;
-import java.util.Set;
 import java.util.concurrent.CountDownLatch;
 import java.util.concurrent.TimeUnit;
 
@@ -96,7 +94,6 @@ public class HostapdHalAidlImp implements IHostapdHal {
     private IHostapd mIHostapd;
     private HashMap<String, Runnable> mSoftApFailureListeners = new HashMap<>();
     private HashMap<String, SoftApHalCallback> mSoftApHalCallbacks = new HashMap<>();
-    private Set<String> mActiveInstances = new HashSet<>();
     private HostapdDeathEventHandler mDeathEventHandler;
     private boolean mServiceDeclared = false;
     private int mServiceVersion;
@@ -395,17 +392,11 @@ public class HostapdHalAidlImp implements IHostapdHal {
                     onFailureListener.run();
                 } else {
                     // Bridged AP
-                    if (mActiveInstances.contains(instanceName)) {
-                        SoftApHalCallback callback = mSoftApHalCallbacks.get(ifaceName);
-                        if (callback != null) {
-                            callback.onInstanceFailure(instanceName);
-                        }
-                    } else {
-                        Log.w(TAG, "Ignore error for inactive instances");
-
+                    SoftApHalCallback callback = mSoftApHalCallbacks.get(ifaceName);
+                    if (callback != null) {
+                        callback.onInstanceFailure(instanceName);
                     }
                 }
-                mActiveInstances.remove(instanceName);
             }
         }
 
@@ -427,7 +418,6 @@ public class HostapdHalAidlImp implements IHostapdHal {
                                     ? MacAddress.fromBytes(info.mldMacAddress) : null,
                             vendorData);
                 }
-                mActiveInstances.add(info.apIfaceInstance);
             } catch (IllegalArgumentException iae) {
                 Log.e(TAG, " Invalid apIfaceInstanceMacAddress, " + iae);
             }
diff --git a/service/java/com/android/server/wifi/InsecureEapNetworkHandler.java b/service/java/com/android/server/wifi/InsecureEapNetworkHandler.java
index f80f0ae186..c4356cd7d2 100644
--- a/service/java/com/android/server/wifi/InsecureEapNetworkHandler.java
+++ b/service/java/com/android/server/wifi/InsecureEapNetworkHandler.java
@@ -34,17 +34,20 @@ import android.os.Handler;
 import android.text.TextUtils;
 import android.text.format.DateFormat;
 import android.util.Log;
+import android.util.Pair;
 
 import com.android.internal.annotations.VisibleForTesting;
 import com.android.internal.messages.nano.SystemMessageProto.SystemMessage;
 import com.android.internal.util.HexDump;
 import com.android.server.wifi.util.CertificateSubjectInfo;
+import com.android.wifi.flags.FeatureFlags;
 import com.android.wifi.resources.R;
 
 import java.security.InvalidAlgorithmParameterException;
 import java.security.KeyStore;
 import java.security.MessageDigest;
 import java.security.NoSuchAlgorithmException;
+import java.security.PublicKey;
 import java.security.cert.CertPath;
 import java.security.cert.CertPathValidator;
 import java.security.cert.CertPathValidatorException;
@@ -54,9 +57,11 @@ import java.security.cert.CertificateFactory;
 import java.security.cert.PKIXParameters;
 import java.security.cert.TrustAnchor;
 import java.security.cert.X509Certificate;
+import java.util.ArrayList;
 import java.util.Date;
 import java.util.Enumeration;
 import java.util.LinkedList;
+import java.util.List;
 import java.util.Set;
 import java.util.StringJoiner;
 
@@ -85,6 +90,7 @@ public class InsecureEapNetworkHandler {
     private final FrameworkFacade mFacade;
     private final WifiNotificationManager mNotificationManager;
     private final WifiDialogManager mWifiDialogManager;
+    private final FeatureFlags mFeatureFlags;
     private final boolean mIsTrustOnFirstUseSupported;
     private final boolean mIsInsecureEnterpriseConfigurationAllowed;
     private final InsecureEapNetworkHandlerCallbacks mCallbacks;
@@ -148,6 +154,7 @@ public class InsecureEapNetworkHandler {
             @NonNull FrameworkFacade facade,
             @NonNull WifiNotificationManager notificationManager,
             @NonNull WifiDialogManager wifiDialogManager,
+            @NonNull FeatureFlags featureFlags,
             boolean isTrustOnFirstUseSupported,
             boolean isInsecureEnterpriseConfigurationAllowed,
             @NonNull InsecureEapNetworkHandlerCallbacks callbacks,
@@ -159,12 +166,12 @@ public class InsecureEapNetworkHandler {
         mFacade = facade;
         mNotificationManager = notificationManager;
         mWifiDialogManager = wifiDialogManager;
+        mFeatureFlags = featureFlags;
         mIsTrustOnFirstUseSupported = isTrustOnFirstUseSupported;
         mIsInsecureEnterpriseConfigurationAllowed = isInsecureEnterpriseConfigurationAllowed;
         mCallbacks = callbacks;
         mInterfaceName = interfaceName;
         mHandler = handler;
-
         mOnNetworkUpdateListener = new OnNetworkUpdateListener();
         mWifiConfigManager.addOnNetworkUpdateListener(mOnNetworkUpdateListener);
 
@@ -675,6 +682,45 @@ public class InsecureEapNetworkHandler {
         if (null != mCallbacks) mCallbacks.onError(ssid);
     }
 
+    class TofuDialogCallback implements WifiDialogManager.SimpleDialogCallback {
+        @Override
+        public void onPositiveButtonClicked() {
+            if (mCurrentTofuConfig == null) {
+                return;
+            }
+            Log.d(TAG, "User accepted the server certificate");
+            handleAccept(mCurrentTofuConfig.SSID);
+        }
+
+        @Override
+        public void onNegativeButtonClicked() {
+            if (mCurrentTofuConfig == null) {
+                return;
+            }
+            Log.d(TAG, "User rejected the server certificate");
+            handleReject(mCurrentTofuConfig.SSID);
+        }
+
+        @Override
+        public void onNeutralButtonClicked() {
+            // Not used.
+            if (mCurrentTofuConfig == null) {
+                return;
+            }
+            Log.d(TAG, "User input neutral");
+            handleReject(mCurrentTofuConfig.SSID);
+        }
+
+        @Override
+        public void onCancelled() {
+            if (mCurrentTofuConfig == null) {
+                return;
+            }
+            Log.d(TAG, "User input canceled");
+            handleReject(mCurrentTofuConfig.SSID);
+        }
+    }
+
     private void askForUserApprovalForCaCertificate() {
         if (mCurrentTofuConfig == null || TextUtils.isEmpty(mCurrentTofuConfig.SSID)) return;
         if (useTrustOnFirstUse()) {
@@ -701,6 +747,10 @@ public class InsecureEapNetworkHandler {
         int messageUrlStart = 0;
         int messageUrlEnd = 0;
         if (useTrustOnFirstUse()) {
+            if (mFeatureFlags.updatedTofuDialog()) {
+                showUpdatedTofuDialog();
+                return;
+            }
             StringBuilder contentBuilder = new StringBuilder()
                     .append(mContext.getString(R.string.wifi_ca_cert_dialog_message_hint))
                     .append(mContext.getString(
@@ -745,48 +795,141 @@ public class InsecureEapNetworkHandler {
                 positiveButtonText,
                 negativeButtonText,
                 null /* neutralButtonText */,
-                new WifiDialogManager.SimpleDialogCallback() {
-                    @Override
-                    public void onPositiveButtonClicked() {
-                        if (mCurrentTofuConfig == null) {
-                            return;
-                        }
-                        Log.d(TAG, "User accepted the server certificate");
-                        handleAccept(mCurrentTofuConfig.SSID);
-                    }
-
-                    @Override
-                    public void onNegativeButtonClicked() {
-                        if (mCurrentTofuConfig == null) {
-                            return;
-                        }
-                        Log.d(TAG, "User rejected the server certificate");
-                        handleReject(mCurrentTofuConfig.SSID);
-                    }
-
-                    @Override
-                    public void onNeutralButtonClicked() {
-                        // Not used.
-                        if (mCurrentTofuConfig == null) {
-                            return;
-                        }
-                        Log.d(TAG, "User input neutral");
-                        handleReject(mCurrentTofuConfig.SSID);
-                    }
-
-                    @Override
-                    public void onCancelled() {
-                        if (mCurrentTofuConfig == null) {
-                            return;
-                        }
-                        Log.d(TAG, "User input canceled");
-                        handleReject(mCurrentTofuConfig.SSID);
-                    }
-                },
+                new TofuDialogCallback(),
                 new WifiThreadRunner(mHandler));
         mTofuAlertDialog.launchDialog();
     }
 
+    private static String getAttributesOnDifferentLines(@NonNull CertificateSubjectInfo info) {
+        StringJoiner sj = new StringJoiner("\n");
+        String[] attributes = info.rawData.split("(?<!\\\\),");
+        for (String attribute : attributes) {
+            sj.add(attribute);
+        }
+        return sj.toString();
+    }
+
+    @VisibleForTesting
+    static List<Pair<String, String>> createTofuDialogCertInfoList(
+            @NonNull Context context, @NonNull X509Certificate serverCert) {
+        CertificateSubjectInfo serverCertSubjectInfo =
+                CertificateSubjectInfo.parse(serverCert.getSubjectX500Principal().getName());
+        CertificateSubjectInfo serverCertIssuerInfo =
+                CertificateSubjectInfo.parse(serverCert.getIssuerX500Principal().getName());
+
+        List<Pair<String, String>> listItems = new ArrayList<>();
+
+        // Server and issuer name
+        if (serverCertSubjectInfo != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_server_name),
+                    serverCertSubjectInfo.commonName));
+        }
+        if (serverCertIssuerInfo != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_issuer_name),
+                    serverCertIssuerInfo.commonName));
+        }
+
+        // Validity
+        final Date validityStart = serverCert.getNotBefore();
+        final Date validityEnd = serverCert.getNotAfter();
+        if (validityStart != null && validityEnd != null) {
+            listItems.add(
+                    new Pair<>(
+                            context.getString(
+                                    R.string.wifi_tofu_dialog2_list_label_validity_period),
+                            context.getString(
+                                    R.string.wifi_tofu_dialog2_list_content_validity_period,
+                                    DateFormat.getMediumDateFormat(context).format(validityStart),
+                                    DateFormat.getMediumDateFormat(context).format(validityEnd))
+                    )
+            );
+        }
+
+        // SHA fingerprints
+        final String sha256fingerprint = getDigest(serverCert, "SHA256");
+        if (!TextUtils.isEmpty(sha256fingerprint)) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_sha256_fingerprint),
+                    sha256fingerprint));
+        }
+        final String sha1fingerprint = getDigest(serverCert, "SHA1");
+        if (!TextUtils.isEmpty(sha1fingerprint)) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_sha1_fingerprint),
+                    sha1fingerprint));
+        }
+
+        // Name details
+        if (serverCertSubjectInfo != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_subject_name_details),
+                    getAttributesOnDifferentLines(serverCertSubjectInfo)));
+        }
+        if (serverCertIssuerInfo != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_issuer_name_details),
+                    getAttributesOnDifferentLines(serverCertIssuerInfo)));
+        }
+
+        // Serial number
+        if (serverCert.getSerialNumber() != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_serial_number),
+                    serverCert.getSerialNumber().toString(16)));
+        }
+
+        // Public key
+        PublicKey publicKey = serverCert.getPublicKey();
+        if (publicKey != null) {
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_public_key_algorithm),
+                    publicKey.getAlgorithm()));
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_public_key_size),
+                    context.getString(
+                            R.string.wifi_tofu_dialog2_list_content_public_key_size,
+                            publicKey.getEncoded().length * 8)));
+            listItems.add(new Pair<>(
+                    context.getString(R.string.wifi_tofu_dialog2_list_label_public_key),
+                    fingerprint(publicKey.getEncoded())));
+        }
+
+        // Signature
+        listItems.add(new Pair<>(
+                context.getString(R.string.wifi_tofu_dialog2_list_label_signature_algorithm),
+                serverCert.getSigAlgName()));
+        listItems.add(new Pair<>(
+                context.getString(R.string.wifi_tofu_dialog2_list_label_signature),
+                fingerprint(serverCert.getSignature())));
+
+        // Version
+        listItems.add(new Pair<>(
+                context.getString(R.string.wifi_tofu_dialog2_list_label_version),
+                String.valueOf(serverCert.getVersion())));
+
+        return listItems;
+    }
+
+    private void showUpdatedTofuDialog() {
+        if (mPendingServerCert == null) {
+            Log.e(TAG, "Tried to show tofu dialog but mPendingServerCert is null!");
+            return;
+        }
+        mTofuAlertDialog = mWifiDialogManager.createSimpleDialogBuilder()
+                .setTitle(mContext.getString(R.string.wifi_tofu_dialog2_title))
+                .setMessage(mContext.getString(R.string.wifi_tofu_dialog2_message))
+                .setListItems(createTofuDialogCertInfoList(mContext, mPendingServerCert))
+                .setPositiveButtonText(
+                        mContext.getString(R.string.wifi_tofu_dialog2_positive_button))
+                .setNegativeButtonText(
+                        mContext.getString(R.string.wifi_tofu_dialog2_negative_button))
+                .setCallback(new TofuDialogCallback(), new WifiThreadRunner(mHandler))
+                .build();
+        mTofuAlertDialog.launchDialog();
+    }
+
     private PendingIntent genCaCertNotifIntent(
             @NonNull String action, @NonNull String ssid) {
         Intent intent = new Intent(action)
diff --git a/service/java/com/android/server/wifi/InterfaceConflictManager.java b/service/java/com/android/server/wifi/InterfaceConflictManager.java
index 21c0463d02..434ecce846 100644
--- a/service/java/com/android/server/wifi/InterfaceConflictManager.java
+++ b/service/java/com/android/server/wifi/InterfaceConflictManager.java
@@ -47,6 +47,7 @@ import com.android.internal.util.State;
 import com.android.internal.util.StateMachine;
 import com.android.server.wifi.util.WaitingState;
 import com.android.server.wifi.util.WorkSourceHelper;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import java.io.FileDescriptor;
@@ -89,6 +90,10 @@ public class InterfaceConflictManager {
     private WaitingState mCurrentWaitingState;
     private State mCurrentTargetState;
     private WifiDialogManager.DialogHandle mCurrentDialogHandle;
+    private Runnable mDialogTimeoutRunnable = () -> {
+        localLog("Dialog timed out.");
+        reset();
+    };
 
     private static final String MESSAGE_BUNDLE_KEY_PENDING_USER = "pending_user_decision";
 
@@ -379,6 +384,7 @@ public class InterfaceConflictManager {
                     (result) -> {
                         localLog(tag + ": User response to creating " + getInterfaceName(
                                 createIfaceType) + ": " + result);
+                        mThreadRunner.removeCallbacks(mDialogTimeoutRunnable);
                         mUserJustApproved = result;
                         mCurrentWaitingState = null;
                         mCurrentTargetState = null;
@@ -387,6 +393,17 @@ public class InterfaceConflictManager {
                     });
             mCurrentDialogHandle.launchDialog();
 
+            if (Flags.icmDialogTimeout()) {
+                int timeoutSeconds = mContext.getResources()
+                        .getInteger(R.integer.config_wifiUserApprovalForD2dTimeoutSeconds);
+                if (timeoutSeconds > 0) {
+                    localLog(tag + ": Timing out dialog after " + timeoutSeconds + " seconds");
+                    mThreadRunner.postDelayed(mDialogTimeoutRunnable, (long) timeoutSeconds * 1000,
+                            TAG + "#mDialogTimeoutRunnable",
+                            mDialogTimeoutRunnable);
+                }
+            }
+
             return ICM_SKIP_COMMAND_WAIT_FOR_USER;
         }
     }
@@ -425,18 +442,7 @@ public class InterfaceConflictManager {
         String impactedInterfaces = TextUtils.join(", ", impactedInterfacesSet);
 
         Resources res = mContext.getResources();
-        return mWifiDialogManager.createSimpleDialog(
-                res.getString(R.string.wifi_interface_priority_title,
-                        requestorAppName, requestedInterface, impactedPackages, impactedInterfaces),
-                impactedPackagesSet.size() == 1 ? res.getString(
-                        R.string.wifi_interface_priority_message, requestorAppName,
-                        requestedInterface, impactedPackages, impactedInterfaces)
-                        : res.getString(R.string.wifi_interface_priority_message_plural,
-                                requestorAppName, requestedInterface, impactedPackages,
-                                impactedInterfaces),
-                res.getString(R.string.wifi_interface_priority_approve),
-                res.getString(R.string.wifi_interface_priority_reject),
-                null,
+        WifiDialogManager.SimpleDialogCallback callback =
                 new WifiDialogManager.SimpleDialogCallback() {
                     @Override
                     public void onPositiveButtonClicked() {
@@ -461,7 +467,20 @@ public class InterfaceConflictManager {
                     public void onCancelled() {
                         onNegativeButtonClicked();
                     }
-                }, mThreadRunner);
+                };
+        return mWifiDialogManager.createSimpleDialogBuilder()
+                .setTitle(res.getString(R.string.wifi_interface_priority_title,
+                        requestorAppName, requestedInterface, impactedPackages, impactedInterfaces))
+                .setMessage(impactedPackagesSet.size() == 1 ? res.getString(
+                        R.string.wifi_interface_priority_message, requestorAppName,
+                        requestedInterface, impactedPackages, impactedInterfaces)
+                        : res.getString(R.string.wifi_interface_priority_message_plural,
+                                requestorAppName, requestedInterface, impactedPackages,
+                                impactedInterfaces))
+                .setPositiveButtonText(res.getString(R.string.wifi_interface_priority_approve))
+                .setNegativeButtonText(res.getString(R.string.wifi_interface_priority_reject))
+                .setCallback(callback, mThreadRunner)
+                .build();
     }
 
     private String getInterfaceName(@HalDeviceManager.HdmIfaceTypeForCreation int createIfaceType) {
@@ -487,6 +506,7 @@ public class InterfaceConflictManager {
      * any waiting StateMachines back to their target state.
      */
     public void reset() {
+        localLog("Resetting.");
         synchronized (mLock) {
             if (mCurrentWaitingState != null && mCurrentTargetState != null) {
                 mCurrentWaitingState.sendTransitionStateCommand(mCurrentTargetState);
@@ -499,6 +519,7 @@ public class InterfaceConflictManager {
             mUserApprovalPending = false;
             mUserApprovalPendingTag = null;
             mUserJustApproved = false;
+            mThreadRunner.removeCallbacks(mDialogTimeoutRunnable);
         }
     }
 
diff --git a/service/java/com/android/server/wifi/LastMileLogger.java b/service/java/com/android/server/wifi/LastMileLogger.java
index 49c506ed62..f648ce71f2 100644
--- a/service/java/com/android/server/wifi/LastMileLogger.java
+++ b/service/java/com/android/server/wifi/LastMileLogger.java
@@ -21,6 +21,7 @@ import android.os.Handler;
 import android.util.ArrayMap;
 
 import com.android.internal.annotations.VisibleForTesting;
+import com.android.modules.utils.BackgroundThread;
 import com.android.server.wifi.util.FileUtils;
 
 import java.io.File;
@@ -36,8 +37,8 @@ import java.util.Map;
  */
 public class LastMileLogger {
     private final Handler mBackgroundHandler;
-    public LastMileLogger(WifiInjector injector, Handler handler) {
-        mBackgroundHandler = handler;
+    public LastMileLogger(WifiInjector injector) {
+        mBackgroundHandler = BackgroundThread.getHandler();
         File tracefsEnablePath = new File(WIFI_EVENT_ENABLE_PATH);
         if (tracefsEnablePath.exists()) {
             initLastMileLogger(injector, WIFI_EVENT_BUFFER_PATH, WIFI_EVENT_ENABLE_PATH,
diff --git a/service/java/com/android/server/wifi/SarManager.java b/service/java/com/android/server/wifi/SarManager.java
index 9d6a992f57..09c2b6f902 100644
--- a/service/java/com/android/server/wifi/SarManager.java
+++ b/service/java/com/android/server/wifi/SarManager.java
@@ -35,7 +35,9 @@ import android.telephony.PhoneStateListener;
 import android.telephony.TelephonyManager;
 import android.util.Log;
 
+import com.android.internal.annotations.VisibleForTesting;
 import com.android.modules.utils.HandlerExecutor;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import java.io.FileDescriptor;
@@ -59,7 +61,8 @@ public class SarManager {
      * @hide constants copied over from {@link AudioManager}
      * TODO(b/144250387): Migrate to public API
      */
-    private static final String STREAM_DEVICES_CHANGED_ACTION =
+    @VisibleForTesting
+    public static final String STREAM_DEVICES_CHANGED_ACTION =
             "android.media.STREAM_DEVICES_CHANGED_ACTION";
     private static final String EXTRA_VOLUME_STREAM_TYPE = "android.media.EXTRA_VOLUME_STREAM_TYPE";
     private static final String EXTRA_VOLUME_STREAM_DEVICES =
@@ -248,45 +251,49 @@ public class SarManager {
         IntentFilter filter = new IntentFilter();
         filter.addAction(STREAM_DEVICES_CHANGED_ACTION);
 
-        mContext.registerReceiver(
-                new BroadcastReceiver() {
-                    @Override
-                    public void onReceive(Context context, Intent intent) {
-                        boolean voiceStreamActive = isVoiceCallStreamActive();
-                        if (!voiceStreamActive) {
-                            // No need to proceed, there is no voice call ongoing
-                            return;
-                        }
+        BroadcastReceiver streamDeviceChangedReceiver = new BroadcastReceiver() {
+                @Override
+                public void onReceive(Context context, Intent intent) {
+                    boolean voiceStreamActive = isVoiceCallStreamActive();
+                    if (!voiceStreamActive) {
+                        // No need to proceed, there is no voice call ongoing
+                        return;
+                    }
 
-                        String action = intent.getAction();
-                        int streamType =
-                                intent.getIntExtra(EXTRA_VOLUME_STREAM_TYPE, -1);
-                        int device = intent.getIntExtra(EXTRA_VOLUME_STREAM_DEVICES, -1);
-                        int oldDevice = intent.getIntExtra(EXTRA_PREV_VOLUME_STREAM_DEVICES, -1);
-
-                        if (streamType == AudioManager.STREAM_VOICE_CALL) {
-                            boolean earPieceActive = mSarInfo.isEarPieceActive;
-                            if (device == DEVICE_OUT_EARPIECE) {
-                                if (mVerboseLoggingEnabled) {
-                                    Log.d(TAG, "Switching to earpiece : HEAD ON");
-                                    Log.d(TAG, "Old device = " + oldDevice);
-                                }
-                                earPieceActive = true;
-                            } else if (oldDevice == DEVICE_OUT_EARPIECE) {
-                                if (mVerboseLoggingEnabled) {
-                                    Log.d(TAG, "Switching from earpiece : HEAD OFF");
-                                    Log.d(TAG, "New device = " + device);
-                                }
-                                earPieceActive = false;
+                    String action = intent.getAction();
+                    int streamType =
+                            intent.getIntExtra(EXTRA_VOLUME_STREAM_TYPE, -1);
+                    int device = intent.getIntExtra(EXTRA_VOLUME_STREAM_DEVICES, -1);
+                    int oldDevice = intent.getIntExtra(EXTRA_PREV_VOLUME_STREAM_DEVICES, -1);
+
+                    if (streamType == AudioManager.STREAM_VOICE_CALL) {
+                        boolean earPieceActive = mSarInfo.isEarPieceActive;
+                        if (device == DEVICE_OUT_EARPIECE) {
+                            if (mVerboseLoggingEnabled) {
+                                Log.d(TAG, "Switching to earpiece : HEAD ON");
+                                Log.d(TAG, "Old device = " + oldDevice);
                             }
-
-                            if (earPieceActive != mSarInfo.isEarPieceActive) {
-                                mSarInfo.isEarPieceActive = earPieceActive;
-                                updateSarScenario();
+                            earPieceActive = true;
+                        } else if (oldDevice == DEVICE_OUT_EARPIECE) {
+                            if (mVerboseLoggingEnabled) {
+                                Log.d(TAG, "Switching from earpiece : HEAD OFF");
+                                Log.d(TAG, "New device = " + device);
                             }
+                            earPieceActive = false;
+                        }
+
+                        if (earPieceActive != mSarInfo.isEarPieceActive) {
+                            mSarInfo.isEarPieceActive = earPieceActive;
+                            updateSarScenario();
                         }
                     }
-                }, filter, null, mHandler);
+                }};
+        if (Flags.monitorIntentForAllUsers()) {
+            mContext.registerReceiverForAllUsers(streamDeviceChangedReceiver, filter,
+                    null, mHandler);
+        } else {
+            mContext.registerReceiver(streamDeviceChangedReceiver, filter, null, mHandler);
+        }
     }
 
     /**
diff --git a/service/java/com/android/server/wifi/SelfRecovery.java b/service/java/com/android/server/wifi/SelfRecovery.java
index e7a182e49d..ae7072603a 100644
--- a/service/java/com/android/server/wifi/SelfRecovery.java
+++ b/service/java/com/android/server/wifi/SelfRecovery.java
@@ -151,6 +151,8 @@ public class SelfRecovery {
 
         @Override
         public void onSubsystemRestart() {
+            WifiStatsLog.write(WifiStatsLog.WIFI_SETUP_FAILURE_CRASH_REPORTED,
+                    WifiStatsLog.WIFI_SETUP_FAILURE_CRASH_REPORTED__TYPE__SSR_CRASH);
             long timeElapsedFromLastTrigger = getTimeElapsedFromLastTrigger();
             mLastSelfRecoveryTimeStampMillis = mClock.getWallClockMillis();
             if (mRecoveryState == STATE_RESTART_WIFI) {
diff --git a/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackAidlImpl.java b/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackAidlImpl.java
index 3b499c2173..e106c83d89 100644
--- a/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackAidlImpl.java
+++ b/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackAidlImpl.java
@@ -223,7 +223,8 @@ class SupplicantStaIfaceCallbackAidlImpl extends ISupplicantStaIfaceCallback.Stu
                 mWifiMonitor.broadcastNetworkConnectionEvent(
                         mIfaceName, mStaIfaceHal.getCurrentNetworkId(mIfaceName), filsHlpSent,
                         wifiSsid, bssidStr, keyMgmtMask);
-            } else if (newState == StaIfaceCallbackState.ASSOCIATING) {
+            } else if (newState == StaIfaceCallbackState.AUTHENTICATING
+                    || newState == StaIfaceCallbackState.ASSOCIATING) {
                 mCurrentSsid = wifiSsid.toString();
             }
             mWifiMonitor.broadcastSupplicantStateChangeEvent(
@@ -346,7 +347,8 @@ class SupplicantStaIfaceCallbackAidlImpl extends ISupplicantStaIfaceCallback.Stu
                             mIfaceName, WifiManager.ERROR_AUTH_FAILURE_WRONG_PSWD, -1,
                             mCurrentSsid, MacAddress.fromBytes(bssid));
                 } else if (mStateBeforeDisconnect == StaIfaceCallbackState.ASSOCIATED
-                        && WifiConfigurationUtil.isConfigForEnterpriseNetwork(curConfiguration)) {
+                        && WifiConfigurationUtil.isConfigForEnterpriseNetwork(curConfiguration)
+                        && !curConfiguration.enterpriseConfig.isTrustOnFirstUseEnabled()) {
                     mWifiMonitor.broadcastAuthenticationFailureEvent(
                             mIfaceName, WifiManager.ERROR_AUTH_FAILURE_EAP_FAILURE, -1,
                             mCurrentSsid, MacAddress.fromBytes(bssid));
diff --git a/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackHidlImpl.java b/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackHidlImpl.java
index 7727a96732..7dcac1f538 100644
--- a/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackHidlImpl.java
+++ b/service/java/com/android/server/wifi/SupplicantStaIfaceCallbackHidlImpl.java
@@ -194,7 +194,7 @@ abstract class SupplicantStaIfaceCallbackHidlImpl extends ISupplicantStaIfaceCal
                 mWifiMonitor.broadcastNetworkConnectionEvent(
                         mIfaceName, mStaIfaceHal.getCurrentNetworkId(mIfaceName), filsHlpSent,
                         wifiSsid, bssidStr);
-            } else if (newState == State.ASSOCIATING) {
+            } else if (newState == State.AUTHENTICATING || newState == State.ASSOCIATING) {
                 mCurrentSsid = wifiSsid.toString();
             }
             mWifiMonitor.broadcastSupplicantStateChangeEvent(
diff --git a/service/java/com/android/server/wifi/SupplicantStateTracker.java b/service/java/com/android/server/wifi/SupplicantStateTracker.java
index 7a4c95a35e..ba53b37185 100644
--- a/service/java/com/android/server/wifi/SupplicantStateTracker.java
+++ b/service/java/com/android/server/wifi/SupplicantStateTracker.java
@@ -294,7 +294,11 @@ public class SupplicantStateTracker extends StateMachine {
             switch (message.what) {
                 case WifiMonitor.AUTHENTICATION_FAILURE_EVENT:
                     mAuthFailureInSupplicantBroadcast = true;
-                    mAuthFailureReason = message.arg1;
+                    AuthenticationFailureEventInfo authenticationFailureEventInfo =
+                            (AuthenticationFailureEventInfo) message.obj;
+                    if (authenticationFailureEventInfo != null) {
+                        mAuthFailureReason = authenticationFailureEventInfo.reasonCode;
+                    }
                     break;
                 case WifiMonitor.SUPPLICANT_STATE_CHANGE_EVENT:
                     StateChangeResult stateChangeResult = (StateChangeResult) message.obj;
diff --git a/service/java/com/android/server/wifi/SystemBuildProperties.java b/service/java/com/android/server/wifi/SystemBuildProperties.java
index a04257b28e..dcf0283ff9 100644
--- a/service/java/com/android/server/wifi/SystemBuildProperties.java
+++ b/service/java/com/android/server/wifi/SystemBuildProperties.java
@@ -13,14 +13,16 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
 package com.android.server.wifi;
 
 import android.os.Build;
 
+import androidx.annotation.Keep;
+
 /**
  * Implementation of BuildProperties.
  */
+@Keep
 public class SystemBuildProperties implements BuildProperties {
     @Override
     public boolean isEngBuild() {
diff --git a/service/java/com/android/server/wifi/ThroughputScorer.java b/service/java/com/android/server/wifi/ThroughputScorer.java
index 9be9d64215..d1a8917224 100644
--- a/service/java/com/android/server/wifi/ThroughputScorer.java
+++ b/service/java/com/android/server/wifi/ThroughputScorer.java
@@ -182,9 +182,13 @@ final class ThroughputScorer implements WifiCandidates.CandidateScorer {
             score = 0;
         }
 
-        if (candidate.getLastSelectionWeight() > 0.0 && (mWifiContext.getResources().getBoolean(
-                R.bool.config_wifiThroughputScorerBoostForRecentlyUserSelectedNetwork)
-                        || !candidate.isUserSelected())) {
+        boolean candidateIsDisconnectedCarrierNetwork =
+                !candidate.isCurrentNetwork() && candidate.isCarrierOrPrivileged();
+        if (!candidateIsDisconnectedCarrierNetwork
+                && candidate.getLastSelectionWeight() > 0.0
+                && (mWifiContext.getResources().getBoolean(
+                        R.bool.config_wifiThroughputScorerBoostForRecentlyUserSelectedNetwork)
+                || !candidate.isUserSelected())) {
             // Put a recently-selected network in a tier above everything else,
             // but include rssi and throughput contributions for BSSID selection.
             score = TOP_TIER_BASE_SCORE + rssiBaseScore + throughputBonusScore;
@@ -193,16 +197,17 @@ final class ThroughputScorer implements WifiCandidates.CandidateScorer {
         if (mVerboseLoggingEnabled) {
             Log.d(TAG, "Score for candidate: SSID: " + candidate.getKey().matchInfo.networkSsid
                     + " BSSID: " + candidate.getKey().bssid
-                    + " rssiScore: " + rssiBaseScore
-                    + " throughputScore: " + throughputBonusScore
+                    + " rssiBoost: " + rssiBoost
+                    + " throughputBoost: " + throughputBoost
                     + " currentNetworkBoost: " + currentNetworkBoost
+                    + " bandSpecificBonus: " + bandSpecificBonus
+                    + " frequencyScore: " + frequencyScore
                     + " securityAward: " + securityAward
                     + " unmeteredAward: " + unmeteredAward
                     + " savedNetworkAward: " + savedNetworkAward
                     + " trustedAward: " + trustedAward
                     + " notOemPaidAward: " + notOemPaidAward
                     + " notOemPrivateAward: " + notOemPrivateAward
-                    + " frequencyScore: " + frequencyScore
                     + " final score: " + score);
         }
 
diff --git a/service/java/com/android/server/wifi/WakeupController.java b/service/java/com/android/server/wifi/WakeupController.java
index 8b0a698eb9..28832c80d8 100644
--- a/service/java/com/android/server/wifi/WakeupController.java
+++ b/service/java/com/android/server/wifi/WakeupController.java
@@ -478,7 +478,8 @@ public class WakeupController {
                         // Assumes user toggled it on from settings before.
                         mFrameworkFacade.getSettingsWorkSource(mContext));
                 mWifiWakeMetrics.recordWakeupEvent(mNumScansHandled);
-                mWifiMetrics.reportWifiStateChanged(true, isUsable(), true);
+                mWifiMetrics.reportWifiStateChanged(true, isUsable(), true,
+                        Process.WIFI_UID);
                 mLastCallerInfoManager.put(WifiManager.API_WIFI_ENABLED, Process.myTid(),
                         Process.WIFI_UID, -1, "android_wifi_wake", true);
             }
diff --git a/service/java/com/android/server/wifi/WifiApConfigStore.java b/service/java/com/android/server/wifi/WifiApConfigStore.java
index efe527a016..17fe9ce152 100644
--- a/service/java/com/android/server/wifi/WifiApConfigStore.java
+++ b/service/java/com/android/server/wifi/WifiApConfigStore.java
@@ -45,6 +45,7 @@ import com.android.internal.annotations.VisibleForTesting;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.net.module.util.MacAddressUtils;
 import com.android.server.wifi.util.ApConfigUtil;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import java.nio.charset.CharsetEncoder;
@@ -387,7 +388,12 @@ public class WifiApConfigStore {
                 // some countries are unable to support 5GHz only operation, always allow for 2GHz
                 // when config doesn't force channel
                 if ((newBand & SoftApConfiguration.BAND_2GHZ) == 0) {
-                    newBand = ApConfigUtil.append24GToBandIf24GSupported(newBand, mContext);
+                    if (Flags.bandOptimizationControl()
+                            && !config.isBandOptimizationEnabled()) {
+                        Log.i(TAG, "Band optimization is disabled, skip appending 2.4Ghz");
+                    } else {
+                        newBand = ApConfigUtil.append24GToBandIf24GSupported(newBand, mContext);
+                    }
                 }
                 // If the 6G configuration doesn't includes 5G band (2.4G have appended because
                 // countries reason), it will cause that driver can't switch channel from 6G to
@@ -396,7 +402,12 @@ public class WifiApConfigStore {
                 // 6G.
                 if ((newBand & SoftApConfiguration.BAND_6GHZ) != 0
                         && (newBand & SoftApConfiguration.BAND_5GHZ) == 0) {
-                    newBand = ApConfigUtil.append5GToBandIf5GSupported(newBand, mContext);
+                    if (Flags.bandOptimizationControl()
+                            && !config.isBandOptimizationEnabled()) {
+                        Log.i(TAG, "Band optimization is disabled, skip appending 5Ghz");
+                    } else {
+                        newBand = ApConfigUtil.append5GToBandIf5GSupported(newBand, mContext);
+                    }
                 }
             }
             newChannels.put(newBand, channel);
@@ -507,7 +518,11 @@ public class WifiApConfigStore {
             // Make sure that we use available band on old build.
             if (!SdkLevel.isAtLeastT()
                     && !isBandsSupported(customConfig.getBands(), context)) {
-                configBuilder.setBand(generateDefaultBand(context));
+                if (Flags.bandOptimizationControl() && !customConfig.isBandOptimizationEnabled()) {
+                    Log.i(TAG, "Band optimization is disabled, skip appending default band");
+                } else {
+                    configBuilder.setBand(generateDefaultBand(context));
+                }
             }
         } else {
             configBuilder = new SoftApConfiguration.Builder();
@@ -554,16 +569,22 @@ public class WifiApConfigStore {
 
         // Automotive mode can force the LOHS to specific bands
         if (hasAutomotiveFeature(context)) {
-            int desiredBand = SoftApConfiguration.BAND_2GHZ;
-            if (context.getResourceCache().getBoolean(R.bool.config_wifiLocalOnlyHotspot6ghz)
-                    && ApConfigUtil.isBandSupported(SoftApConfiguration.BAND_6GHZ, mContext)) {
-                desiredBand |= SoftApConfiguration.BAND_6GHZ;
-            }
-            if (context.getResourceCache().getBoolean(R.bool.config_wifi_local_only_hotspot_5ghz)
-                    && ApConfigUtil.isBandSupported(SoftApConfiguration.BAND_5GHZ, mContext)) {
-                desiredBand |= SoftApConfiguration.BAND_5GHZ;
+            if (Flags.bandOptimizationControl()
+                    && customConfig != null && !customConfig.isBandOptimizationEnabled()) {
+                Log.i(TAG, "Skipped band optimization for auto platform");
+            } else {
+                int desiredBand = SoftApConfiguration.BAND_2GHZ;
+                if (context.getResourceCache().getBoolean(R.bool.config_wifiLocalOnlyHotspot6ghz)
+                        && ApConfigUtil.isBandSupported(SoftApConfiguration.BAND_6GHZ, mContext)) {
+                    desiredBand |= SoftApConfiguration.BAND_6GHZ;
+                }
+                if (context.getResourceCache().getBoolean(
+                        R.bool.config_wifi_local_only_hotspot_5ghz)
+                        && ApConfigUtil.isBandSupported(SoftApConfiguration.BAND_5GHZ, mContext)) {
+                    desiredBand |= SoftApConfiguration.BAND_5GHZ;
+                }
+                configBuilder.setBand(desiredBand);
             }
-            configBuilder.setBand(desiredBand);
         }
 
         if (!wasSsidAssigned) {
diff --git a/service/java/com/android/server/wifi/WifiBackupDataV1Parser.java b/service/java/com/android/server/wifi/WifiBackupDataV1Parser.java
index 0eb585fc96..093c66cb8f 100644
--- a/service/java/com/android/server/wifi/WifiBackupDataV1Parser.java
+++ b/service/java/com/android/server/wifi/WifiBackupDataV1Parser.java
@@ -17,6 +17,7 @@
 package com.android.server.wifi;
 
 import android.annotation.Nullable;
+import android.annotation.SuppressLint;
 import android.net.InetAddresses;
 import android.net.IpConfiguration;
 import android.net.IpConfiguration.IpAssignment;
@@ -28,12 +29,14 @@ import android.net.StaticIpConfiguration;
 import android.net.Uri;
 import android.net.wifi.SecurityParams;
 import android.net.wifi.WifiConfiguration;
+import android.net.wifi.util.Environment;
 import android.util.Log;
 import android.util.Pair;
 
 import com.android.server.wifi.util.XmlUtil;
 import com.android.server.wifi.util.XmlUtil.IpConfigurationXmlUtil;
 import com.android.server.wifi.util.XmlUtil.WifiConfigurationXmlUtil;
+import com.android.wifi.flags.Flags;
 
 import org.xmlpull.v1.XmlPullParser;
 import org.xmlpull.v1.XmlPullParserException;
@@ -93,7 +96,8 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
 
     private static final String TAG = "WifiBackupDataV1Parser";
 
-    private static final int HIGHEST_SUPPORTED_MINOR_VERSION = 4;
+    private static final int HIGHEST_SUPPORTED_MINOR_VERSION =
+            Environment.isSdkNewerThanB() ? 5 : 4;
 
     // List of tags supported for <WifiConfiguration> section in minor version 0
     private static final Set<String> WIFI_CONFIGURATION_MINOR_V0_SUPPORTED_TAGS = Set.of(
@@ -169,6 +173,16 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
                 WifiConfigurationXmlUtil.XML_TAG_SEND_DHCP_HOSTNAME);
     }
 
+    // List of tags supported for <WifiConfiguration> section in minor version 5
+    private static final Set<String> WIFI_CONFIGURATION_MINOR_V5_SUPPORTED_TAGS =
+            new HashSet<String>();
+    static {
+        WIFI_CONFIGURATION_MINOR_V5_SUPPORTED_TAGS.addAll(
+                WIFI_CONFIGURATION_MINOR_V4_SUPPORTED_TAGS);
+        WIFI_CONFIGURATION_MINOR_V5_SUPPORTED_TAGS.add(
+                WifiConfigurationXmlUtil.XML_TAG_ALLOW_UPDATE_BY_OTHER_USERS);
+    }
+
     // List of tags supported for <IpConfiguration> section in last minor version, i.e. version: 4
     // Note: Update the getSupportedIpConfigurationTags when the minor version is increased.
     private static final Set<String> IP_CONFIGURATION_LAST_MINOR_SUPPORTED_TAGS = Set.of(
@@ -324,6 +338,7 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
      * @param minorVersion  minor version number parsed from incoming data.
      * @return Pair<Config key, WifiConfiguration object> if parsing is successful, null otherwise.
      */
+    @SuppressLint("NewApi")
     private static Pair<String, WifiConfiguration> parseWifiConfigurationFromXmlInternal(
             XmlPullParser in, int outerTagDepth, int minorVersion)
             throws XmlPullParserException, IOException {
@@ -429,6 +444,13 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
                     configuration.setSendDhcpHostnameEnabled((boolean) value);
                     sendDhcpHostnameExists = true;
                     break;
+                // V5
+                case WifiConfigurationXmlUtil.XML_TAG_ALLOW_UPDATE_BY_OTHER_USERS:
+                    if (Flags.multiUserWifiEnhancement() && Environment.isSdkNewerThanB()
+                            && configuration.shared) {
+                        configuration.setAllowedToUpdateByOtherUsers((boolean) value);
+                    }
+                    break;
                 default:
                     // should never happen, since other tags are filtered out earlier
                     throw new XmlPullParserException(
@@ -465,6 +487,8 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
                 return WIFI_CONFIGURATION_MINOR_V3_SUPPORTED_TAGS;
             case 4:
                 return WIFI_CONFIGURATION_MINOR_V4_SUPPORTED_TAGS;
+            case 5:
+                return WIFI_CONFIGURATION_MINOR_V5_SUPPORTED_TAGS;
             default:
                 Log.e(TAG, "Invalid minorVersion: " + minorVersion);
                 return Collections.<String>emptySet();
@@ -751,6 +775,7 @@ class WifiBackupDataV1Parser implements WifiBackupDataParser {
             case 2:
             case 3:
             case 4:
+            case 5:
                 return IP_CONFIGURATION_LAST_MINOR_SUPPORTED_TAGS;
             default:
                 Log.e(TAG, "Invalid minorVersion: " + minorVersion);
diff --git a/service/java/com/android/server/wifi/WifiBlocklistMonitor.java b/service/java/com/android/server/wifi/WifiBlocklistMonitor.java
index 063b57cc6d..0e5c69a090 100644
--- a/service/java/com/android/server/wifi/WifiBlocklistMonitor.java
+++ b/service/java/com/android/server/wifi/WifiBlocklistMonitor.java
@@ -314,6 +314,7 @@ public class WifiBlocklistMonitor {
             @FailureReason int reason, int rssi) {
         entry.setAsBlocked(durationMs, reason, rssi);
         localLog(TAG + " addToBlocklist: bssid=" + entry.bssid + ", ssid=" + entry.ssid
+                + ", networkId=" + entry.networkId
                 + ", durationMs=" + durationMs + ", reason=" + getFailureReasonString(reason)
                 + ", rssi=" + rssi);
     }
@@ -324,8 +325,8 @@ public class WifiBlocklistMonitor {
      * @return the BssidStatus for the BSSID
      */
     private @NonNull BssidStatus incrementFailureCountForBssid(
-            @NonNull String bssid, @NonNull String ssid, int reasonCode) {
-        BssidStatus status = getOrCreateBssidStatus(bssid, ssid);
+            @NonNull String bssid, @NonNull WifiConfiguration config, int reasonCode) {
+        BssidStatus status = getOrCreateBssidStatus(bssid, config.SSID, config.networkId);
         status.incrementFailureCount(reasonCode);
         return status;
     }
@@ -334,14 +335,14 @@ public class WifiBlocklistMonitor {
      * Get the BssidStatus representing the BSSID or create a new one if it doesn't exist.
      */
     private @NonNull BssidStatus getOrCreateBssidStatus(@NonNull String bssid,
-            @NonNull String ssid) {
+            @NonNull String ssid, int networkId) {
         BssidStatus status = mBssidStatusMap.get(bssid);
         if (status == null || !ssid.equals(status.ssid)) {
             if (status != null) {
                 localLog("getOrCreateBssidStatus: BSSID=" + bssid + ", SSID changed from "
                         + status.ssid + " to " + ssid);
             }
-            status = new BssidStatus(bssid, ssid);
+            status = new BssidStatus(bssid, ssid, networkId);
             mBssidStatusMap.put(bssid, status);
         }
         return status;
@@ -413,7 +414,7 @@ public class WifiBlocklistMonitor {
                     + ", rssi=" + rssi);
             return;
         }
-        BssidStatus status = getOrCreateBssidStatus(bssid, config.SSID);
+        BssidStatus status = getOrCreateBssidStatus(bssid, config.SSID, config.networkId);
         if (status.isInBlocklist
                 && status.blocklistEndTimeMs - mClock.getWallClockMillis() > durationMs) {
             // Return because this BSSID is already being blocked for a longer time.
@@ -425,7 +426,7 @@ public class WifiBlocklistMonitor {
          * BSSID.
          */
         for (String affiliatedBssid : getAffiliatedBssids(bssid)) {
-            status = getOrCreateBssidStatus(affiliatedBssid, config.SSID);
+            status = getOrCreateBssidStatus(affiliatedBssid, config.SSID, config.networkId);
             addToBlocklist(status, durationMs, blockReason, rssi);
         }
     }
@@ -490,11 +491,11 @@ public class WifiBlocklistMonitor {
         return FAILURE_COUNT_DISABLE_THRESHOLD[reasonCode];
     }
 
-    private boolean handleBssidConnectionFailureInternal(String bssid, String ssid,
+    private boolean handleBssidConnectionFailureInternal(String bssid, WifiConfiguration config,
             @FailureReason int reasonCode, int rssi) {
-        BssidStatus entry = incrementFailureCountForBssid(bssid, ssid, reasonCode);
+        BssidStatus entry = incrementFailureCountForBssid(bssid, config, reasonCode);
         int failureThreshold = getFailureThresholdForReason(reasonCode);
-        int currentStreak = mWifiScoreCard.getBssidBlocklistStreak(ssid, bssid, reasonCode);
+        int currentStreak = mWifiScoreCard.getBssidBlocklistStreak(config.SSID, bssid, reasonCode);
         if (currentStreak > 0 || entry.failureCount[reasonCode] >= failureThreshold) {
             // To rule out potential device side issues, don't add to blocklist if
             // WifiLastResortWatchdog is still not triggered
@@ -520,17 +521,19 @@ public class WifiBlocklistMonitor {
             long expBackoff = getBlocklistDurationWithExponentialBackoff(currentStreak,
                     baseBlockDurationMs);
             addToBlocklist(entry, expBackoff, reasonCode, rssi);
-            mWifiScoreCard.incrementBssidBlocklistStreak(ssid, bssid, reasonCode);
+            mWifiScoreCard.incrementBssidBlocklistStreak(config.SSID, bssid, reasonCode);
 
             /**
              * Block list affiliated BSSID with same parameters, e.g. reason code, rssi ..etc.
              * as connected BSSID.
              */
             for (String affiliatedBssid : getAffiliatedBssids(bssid)) {
-                BssidStatus affEntry = getOrCreateBssidStatus(affiliatedBssid, ssid);
+                BssidStatus affEntry = getOrCreateBssidStatus(affiliatedBssid, config.SSID,
+                        config.networkId);
                 affEntry.failureCount[reasonCode] = entry.failureCount[reasonCode];
                 addToBlocklist(affEntry, expBackoff, reasonCode, rssi);
-                mWifiScoreCard.incrementBssidBlocklistStreak(ssid, affiliatedBssid, reasonCode);
+                mWifiScoreCard.incrementBssidBlocklistStreak(config.SSID, affiliatedBssid,
+                        reasonCode);
             }
 
             return true;
@@ -581,7 +584,7 @@ public class WifiBlocklistMonitor {
                 return false;
             }
         }
-        return handleBssidConnectionFailureInternal(bssid, ssid, reasonCode, rssi);
+        return handleBssidConnectionFailureInternal(bssid, config, reasonCode, rssi);
     }
 
     /**
@@ -842,13 +845,13 @@ public class WifiBlocklistMonitor {
     /**
      * Attempts to re-enable BSSIDs that likely experienced failures due to low RSSI.
      * @param scanDetails
-     * @return the list of ScanDetails for which BSSIDs were re-enabled.
+     * @return the list of networkId for which BSSIDs were re-enabled.
      */
-    public @NonNull List<ScanDetail> tryEnablingBlockedBssids(List<ScanDetail> scanDetails) {
+    public @NonNull List<Integer> tryEnablingBlockedBssids(List<ScanDetail> scanDetails) {
         if (scanDetails == null) {
             return Collections.EMPTY_LIST;
         }
-        List<ScanDetail> results = new ArrayList<>();
+        Set<Integer> networkEnabled = new ArraySet<>();
         for (ScanDetail scanDetail : scanDetails) {
             ScanResult scanResult = scanDetail.getScanResult();
             if (scanResult == null) {
@@ -871,10 +874,10 @@ public class WifiBlocklistMonitor {
                 for (String affiliatedBssid : getAffiliatedBssids(status.bssid)) {
                     removeFromBlocklist(affiliatedBssid, "rssi significantly improved");
                 }
-                results.add(scanDetail);
+                networkEnabled.add(status.networkId);
             }
         }
-        return results;
+        return new ArrayList<>(networkEnabled);
     }
 
     private boolean isLowRssiSensitiveFailure(int blockReason) {
@@ -1058,6 +1061,7 @@ public class WifiBlocklistMonitor {
     private class BssidStatus {
         public final String bssid;
         public final String ssid;
+        public final int networkId;
         public final int[] failureCount = new int[NUMBER_REASON_CODES];
         public int blockReason = INVALID_REASON; // reason of blocking this BSSID
         // The latest RSSI that's seen before this BSSID is added to blocklist.
@@ -1068,9 +1072,10 @@ public class WifiBlocklistMonitor {
         public long blocklistEndTimeMs;
         public long blocklistStartTimeMs;
 
-        BssidStatus(String bssid, String ssid) {
+        BssidStatus(String bssid, String ssid, int networkId) {
             this.bssid = bssid;
             this.ssid = ssid;
+            this.networkId = networkId;
         }
 
         /**
@@ -1101,6 +1106,7 @@ public class WifiBlocklistMonitor {
             StringBuilder sb = new StringBuilder();
             sb.append("BSSID=" + bssid);
             sb.append(", SSID=" + ssid);
+            sb.append(", networkId=" + networkId);
             sb.append(", isInBlocklist=" + isInBlocklist);
             if (isInBlocklist) {
                 sb.append(", blockReason=" + getFailureReasonString(blockReason));
diff --git a/service/java/com/android/server/wifi/WifiCarrierInfoManager.java b/service/java/com/android/server/wifi/WifiCarrierInfoManager.java
index 1cafbecff1..0d26933ca3 100644
--- a/service/java/com/android/server/wifi/WifiCarrierInfoManager.java
+++ b/service/java/com/android/server/wifi/WifiCarrierInfoManager.java
@@ -1811,12 +1811,19 @@ public class WifiCarrierInfoManager {
         Log.d(TAG, msg, null);
     }
 
+    /**
+     * Tag to be used in dumpsys request
+     */
+    public static final String DUMP_ARG = "WifiCarrierInfoManager";
     /** Dump state. */
     public void dump(FileDescriptor fd, PrintWriter pw, String[] args) {
         pw.println(TAG + ": ");
         pw.println("mImsiEncryptionInfoAvailable=" + mImsiEncryptionInfoAvailable);
         pw.println("mImsiPrivacyProtectionExemptionMap=" + mImsiPrivacyProtectionExemptionMap);
-        pw.println("mMergedCarrierNetworkOffloadMap=" + mMergedCarrierNetworkOffloadMap);
+        pw.println("mMergedCarrierNetworkOffloadMap<subId, enabled>="
+                + mMergedCarrierNetworkOffloadMap);
+        pw.println("mUnmergedCarrierNetworkOffloadMap<subId, enabled>="
+                + mUnmergedCarrierNetworkOffloadMap);
         pw.println("mSubIdToSimInfoSparseArray=" + mSubIdToSimInfoSparseArray);
         pw.println("mActiveSubInfos=" + mActiveSubInfos);
         pw.println("mCachedCarrierConfigPerSubId=" + mCachedCarrierConfigPerSubId);
@@ -2021,17 +2028,7 @@ public class WifiCarrierInfoManager {
     private void sendImsiPrivacyConfirmationDialog(@NonNull String carrierName, int carrierId) {
         mWifiMetrics.addUserApprovalCarrierUiReaction(ACTION_USER_ALLOWED_CARRIER,
                 mIsLastUserApprovalUiDialog);
-        mWifiInjector.getWifiDialogManager().createSimpleDialog(
-                mContext.getResources().getString(
-                        R.string.wifi_suggestion_imsi_privacy_exemption_confirmation_title),
-                mContext.getResources().getString(
-                        R.string.wifi_suggestion_imsi_privacy_exemption_confirmation_content,
-                        carrierName),
-                mContext.getResources().getString(
-                        R.string.wifi_suggestion_action_allow_imsi_privacy_exemption_confirmation),
-                mContext.getResources().getString(R.string
-                        .wifi_suggestion_action_disallow_imsi_privacy_exemption_confirmation),
-                null /* neutralButtonText */,
+        WifiDialogManager.SimpleDialogCallback callback =
                 new WifiDialogManager.SimpleDialogCallback() {
                     @Override
                     public void onPositiveButtonClicked() {
@@ -2053,8 +2050,20 @@ public class WifiCarrierInfoManager {
                     public void onCancelled() {
                         handleUserDismissAction();
                     }
-                },
-                new WifiThreadRunner(mHandler)).launchDialog();
+                };
+        mWifiInjector.getWifiDialogManager().createSimpleDialogBuilder()
+                .setTitle(mContext.getResources().getString(
+                        R.string.wifi_suggestion_imsi_privacy_exemption_confirmation_title))
+                .setMessage(mContext.getResources().getString(
+                        R.string.wifi_suggestion_imsi_privacy_exemption_confirmation_content,
+                        carrierName))
+                .setPositiveButtonText(mContext.getResources().getString(
+                        R.string.wifi_suggestion_action_allow_imsi_privacy_exemption_confirmation))
+                .setNegativeButtonText(mContext.getResources().getString(R.string
+                        .wifi_suggestion_action_disallow_imsi_privacy_exemption_confirmation))
+                .setCallback(callback, new WifiThreadRunner(mHandler))
+                .build()
+                .launchDialog();
         mIsLastUserApprovalUiDialog = true;
     }
 
diff --git a/service/java/com/android/server/wifi/WifiConfigManager.java b/service/java/com/android/server/wifi/WifiConfigManager.java
index c996782c11..3ee0d15b0a 100644
--- a/service/java/com/android/server/wifi/WifiConfigManager.java
+++ b/service/java/com/android/server/wifi/WifiConfigManager.java
@@ -30,6 +30,7 @@ import static com.android.server.wifi.WifiConfigurationUtil.validatePassword;
 import android.Manifest;
 import android.annotation.NonNull;
 import android.annotation.Nullable;
+import android.annotation.SuppressLint;
 import android.app.ActivityManager;
 import android.app.AlarmManager;
 import android.content.ContentResolver;
@@ -50,6 +51,7 @@ import android.net.wifi.WifiInfo;
 import android.net.wifi.WifiManager;
 import android.net.wifi.WifiScanner;
 import android.net.wifi.WifiSsid;
+import android.net.wifi.util.Environment;
 import android.os.Handler;
 import android.os.Process;
 import android.os.UserHandle;
@@ -366,6 +368,11 @@ public class WifiConfigManager {
      * Current logged in user ID.
      */
     private int mCurrentUserId = UserHandle.SYSTEM.getIdentifier();
+
+    /**
+     * Whether the forground user is an admin user.
+     */
+    private boolean mIsForegroundUserAdmin = false;
     /**
      * Flag to indicate that the new user's store has not yet been read since user switch.
      * Initialize this flag to |true| to trigger a read on the first user unlock after
@@ -1073,9 +1080,11 @@ public class WifiConfigManager {
      * @param config         WifiConfiguration object corresponding to the network to be modified.
      * @param uid            UID of the app requesting the modification.
      * @param packageName    Package name of the app requesting the modification.
+     * @param requireUserCheck requires to check if calling uid and creator uid from the same user.
      */
+    @SuppressLint("NewApi")
     private boolean canModifyNetwork(WifiConfiguration config, int uid,
-            @Nullable String packageName) {
+            @Nullable String packageName, boolean requireUserCheck) {
         // Passpoint configurations are generated and managed by PasspointManager. They can be
         // added by either PasspointNetworkNominator (for auto connection) or Settings app
         // (for manual connection), and need to be removed once the connection is completed.
@@ -1093,6 +1102,14 @@ public class WifiConfigManager {
             return true;
         }
 
+        // The configuration is disallowed to be updated by other user.
+        if (Environment.isSdkNewerThanB()
+                && mFeatureFlags.multiUserWifiEnhancement()
+                && requireUserCheck && !config.isAllowedToUpdateByOtherUsers()
+                && !mWifiPermissionsUtil.areTwoAppsFromSameUser(config.creatorUid, uid)) {
+            return false;
+        }
+
         // TODO: ideally package should not be null here (and hence we wouldn't need the
         // isDeviceOwner(uid) method), but it would require changing  many methods to pass the
         // package name around (for example, all methods called by
@@ -1222,6 +1239,7 @@ public class WifiConfigManager {
      * @param internalConfig WifiConfiguration object in our internal map.
      * @param externalConfig WifiConfiguration object provided from the external API.
      */
+    @SuppressLint("NewApi")
     private void mergeWithInternalWifiConfiguration(
             WifiConfiguration internalConfig, WifiConfiguration externalConfig) {
         if (externalConfig.SSID != null) {
@@ -1337,6 +1355,12 @@ public class WifiConfigManager {
         internalConfig.setRepeaterEnabled(externalConfig.isRepeaterEnabled());
         internalConfig.setSendDhcpHostnameEnabled(externalConfig.isSendDhcpHostnameEnabled());
         internalConfig.setWifi7Enabled(externalConfig.isWifi7Enabled());
+        if (Environment.isSdkNewerThanB()
+                && mFeatureFlags.multiUserWifiEnhancement()
+                && externalConfig.shared) {
+            internalConfig.setAllowedToUpdateByOtherUsers(
+                    externalConfig.isAllowedToUpdateByOtherUsers());
+        }
     }
 
     /**
@@ -1366,6 +1390,7 @@ public class WifiConfigManager {
      * @return New WifiConfiguration object with parameters merged from the provided external
      * configuration.
      */
+    @SuppressLint("NewApi")
     private WifiConfiguration createNewInternalWifiConfigurationFromExternal(
             WifiConfiguration externalConfig, int uid, @Nullable String packageName) {
         WifiConfiguration newInternalConfig = new WifiConfiguration();
@@ -1394,6 +1419,12 @@ public class WifiConfigManager {
         newInternalConfig.shared = externalConfig.shared;
         newInternalConfig.updateIdentifier = externalConfig.updateIdentifier;
         newInternalConfig.setPasspointUniqueId(externalConfig.getPasspointUniqueId());
+        if (Environment.isSdkNewerThanB()
+                && mFeatureFlags.multiUserWifiEnhancement()
+                && externalConfig.shared) {
+            newInternalConfig.setAllowedToUpdateByOtherUsers(
+                    externalConfig.isAllowedToUpdateByOtherUsers());
+        }
 
         // Add debug information for network addition.
         newInternalConfig.creatorUid = newInternalConfig.lastUpdateUid = uid;
@@ -1511,8 +1542,10 @@ public class WifiConfigManager {
                                 STATUS_INVALID_CONFIGURATION),
                         existingInternalConfig);
             }
+
             // Check for the app's permission before we let it update this network.
-            if (!canModifyNetwork(existingInternalConfig, uid, packageName)) {
+            if (!canModifyNetwork(existingInternalConfig, uid,
+                    packageName, true /* requireUserCheck */)) {
                 Log.e(TAG, "UID " + uid + " does not have permission to update configuration "
                         + config.getProfileKey());
                 return new Pair<>(
@@ -2014,7 +2047,9 @@ public class WifiConfigManager {
         if (config == null) {
             return false;
         }
-        if (!canModifyNetwork(config, uid, packageName)) {
+
+        if (!canModifyNetwork(config, uid, packageName,
+                !mIsForegroundUserAdmin /* requireUserCheck */)) {
             Log.e(TAG, "UID " + uid + " does not have permission to delete configuration "
                     + config.getProfileKey());
             return false;
@@ -2348,7 +2383,8 @@ public class WifiConfigManager {
         if (disableOthers) {
             setLastSelectedNetwork(networkId);
         }
-        if (!canModifyNetwork(config, uid, packageName)) {
+
+        if (!canModifyNetwork(config, uid, packageName, true /* requireUserCheck */)) {
             Log.e(TAG, "UID " + uid +  " package " + packageName
                     + " does not have permission to update configuration "
                     + config.getProfileKey());
@@ -2388,7 +2424,7 @@ public class WifiConfigManager {
         if (networkId == mLastSelectedNetworkId) {
             clearLastSelectedNetwork();
         }
-        if (!canModifyNetwork(config, uid, packageName)) {
+        if (!canModifyNetwork(config, uid, packageName, true /* requireUserCheck */)) {
             Log.e(TAG, "UID " + uid + " package " + packageName
                     + " does not have permission to update configuration "
                     + config.getProfileKey());
@@ -3475,6 +3511,8 @@ public class WifiConfigManager {
         Set<Integer> removedNetworkIds = clearInternalDataForUser(mCurrentUserId);
         mConfiguredNetworks.setNewUser(userId);
         mCurrentUserId = userId;
+        // New API in Android V
+        mIsForegroundUserAdmin = SdkLevel.isAtLeastV() && mUserManager.isForegroundUserAdmin();
 
         if (mUserManager.isUserUnlockingOrUnlocked(UserHandle.of(mCurrentUserId))) {
             handleUserUnlockOrSwitch(mCurrentUserId);
@@ -3504,6 +3542,8 @@ public class WifiConfigManager {
             Log.e(TAG, "Ignore user unlock for non current user " + userId);
             return;
         }
+        // New API in Android V
+        mIsForegroundUserAdmin = SdkLevel.isAtLeastV() && mUserManager.isForegroundUserAdmin();
         if (mPendingStoreRead) {
             Log.w(TAG, "Ignore user unlock until store is read!");
             mDeferredUserUnlockRead = true;
@@ -3946,6 +3986,7 @@ public class WifiConfigManager {
         pw.println("WifiConfigManager - Log Begin ----");
         mLocalLog.dump(fd, pw, args);
         pw.println("WifiConfigManager - Log End ----");
+        pw.println("WifiConfigManager - mIsForegroundUserAdmin:" + mIsForegroundUserAdmin);
         pw.println("WifiConfigManager - Configured networks Begin ----");
         for (WifiConfiguration network : getInternalConfiguredNetworks()) {
             pw.println(network);
diff --git a/service/java/com/android/server/wifi/WifiConnectivityManager.java b/service/java/com/android/server/wifi/WifiConnectivityManager.java
index 03e0ac007c..43bed6427b 100644
--- a/service/java/com/android/server/wifi/WifiConnectivityManager.java
+++ b/service/java/com/android/server/wifi/WifiConnectivityManager.java
@@ -525,12 +525,6 @@ public class WifiConnectivityManager {
         // For secondary STA of multi internet connection, when ROLE_CLIENT_SECONDARY_LONG_LIVED
         // is used, specify the target BSSID explicitly to avoid firmware choosing same BSSID
         // as primary STA.
-        // TODO: Use new STA+STA user case DUAL_STA_NON_TRANSIENT_SECONDARY and remove the BSSID
-        // if roaming is supported on secondary.
-        String bssidToConnect = null;
-        if (!mConnectivityHelper.isFirmwareRoamingSupported()) {
-            bssidToConnect = targetBssid2;
-        }
         // Request for a new client mode manager to spin up concurrent connection
         mActiveModeWarden.requestSecondaryLongLivedClientModeManager(
                 (cm) -> {
@@ -573,7 +567,7 @@ public class WifiConnectivityManager {
                             targetNetwork.isPasspoint());
                 }, secondaryRequestorWs,
                 secondaryCmmCandidate.SSID,
-                bssidToConnect);
+                targetBssid2);
         return true;
     }
 
@@ -671,10 +665,10 @@ public class WifiConnectivityManager {
         }
 
         // Check if any blocklisted BSSIDs can be freed.
-        List<ScanDetail> enabledDetails =
+        List<Integer> enabledNetworks =
                 mWifiBlocklistMonitor.tryEnablingBlockedBssids(scanDetails);
-        for (ScanDetail scanDetail : enabledDetails) {
-            WifiConfiguration config = mConfigManager.getSavedNetworkForScanDetail(scanDetail);
+        for (int networkId : enabledNetworks) {
+            WifiConfiguration config = mConfigManager.getConfiguredNetwork(networkId);
             if (config != null && config.getNetworkSelectionStatus().isNetworkTemporaryDisabled()) {
                 mConfigManager.updateNetworkSelectionStatus(config.networkId,
                         WifiConfiguration.NetworkSelectionStatus.DISABLED_NONE);
@@ -1808,31 +1802,33 @@ public class WifiConnectivityManager {
         Log.i(TAG, "Need user approval for connecting to candidate "
                 + candidate.getProfileKey());
         resetNetworkSwitchDialog();
-        mNetworkSwitchDialog = mWifiDialogManager.createSimpleDialog(
-                mContext.getString(connectedConfig.hasNoInternetAccess()
+        Runnable onSwitchApproved = () -> {
+            resetNetworkSwitchDialog();
+            continueConnectionRunnable.run();
+            primaryManager.onNetworkSwitchAccepted(candidate.networkId,
+                    candidate.getNetworkSelectionStatus().getNetworkSelectionBSSID());
+        };
+        Runnable onSwitchRejected = () -> {
+            Log.i(TAG, "User rejected network switch to "
+                    + candidate.getProfileKey());
+            mNetworkSwitchDialogRejected = true;
+            primaryManager.onNetworkSwitchRejected(candidate.networkId,
+                    candidate.getNetworkSelectionStatus().getNetworkSelectionBSSID());
+        };
+        NetworkSwitchDialogCallback callback = new NetworkSwitchDialogCallback(
+                onSwitchApproved, onSwitchRejected);
+        mNetworkSwitchDialog = mWifiDialogManager.createSimpleDialogBuilder()
+                .setTitle(mContext.getString(connectedConfig.hasNoInternetAccess()
                                 ? R.string.wifi_network_switch_dialog_title_no_internet
                                 : R.string.wifi_network_switch_dialog_title_bad_internet,
                         WifiInfo.removeDoubleQuotes(connectedConfig.SSID),
-                        WifiInfo.removeDoubleQuotes(candidate.SSID)),
-                /* message */ null,
-                mContext.getString(R.string.wifi_network_switch_dialog_positive_button),
-                mContext.getString(R.string.wifi_network_switch_dialog_negative_button),
-                /* neutralButtonText */ null,
-                new NetworkSwitchDialogCallback(
-                /* onSwitchApprovedRunnable */ () -> {
-                    resetNetworkSwitchDialog();
-                    continueConnectionRunnable.run();
-                    primaryManager.onNetworkSwitchAccepted(candidate.networkId,
-                            candidate.getNetworkSelectionStatus().getNetworkSelectionBSSID());
-                },
-                /* onSwitchRejectedRunnable */ () -> {
-                    Log.i(TAG, "User rejected network switch to "
-                            + candidate.getProfileKey());
-                    mNetworkSwitchDialogRejected = true;
-                    primaryManager.onNetworkSwitchRejected(candidate.networkId,
-                            candidate.getNetworkSelectionStatus().getNetworkSelectionBSSID());
-                }),
-                mWifiThreadRunner);
+                        WifiInfo.removeDoubleQuotes(candidate.SSID)))
+                .setPositiveButtonText(
+                        mContext.getString(R.string.wifi_network_switch_dialog_positive_button))
+                .setNegativeButtonText(
+                        mContext.getString(R.string.wifi_network_switch_dialog_negative_button))
+                .setCallback(callback, mWifiThreadRunner)
+                .build();
         mNetworkSwitchDialog.launchDialog();
         mDialogCandidateNetId = candidate.networkId;
     }
diff --git a/service/java/com/android/server/wifi/WifiCountryCode.java b/service/java/com/android/server/wifi/WifiCountryCode.java
index 3b041cd25f..ef31c13b17 100644
--- a/service/java/com/android/server/wifi/WifiCountryCode.java
+++ b/service/java/com/android/server/wifi/WifiCountryCode.java
@@ -134,6 +134,7 @@ public class WifiCountryCode {
             }
             if (mAmmToReadyForChangeMap.size() == 0) {
                 handleCountryCodeChanged(null);
+                resetFrameworkCountryCode();
                 Log.i(TAG, "No active mode, call onDriverCountryCodeChanged with Null");
             }
         }
@@ -667,6 +668,12 @@ public class WifiCountryCode {
         return mSettingsConfigStore.get(WIFI_DEFAULT_COUNTRY_CODE);
     }
 
+    private void resetFrameworkCountryCode() {
+        mFrameworkCountryCode = null;
+        mFrameworkCountryCodeUpdatedTimestamp = 0;
+        mDisconnectWifiToForceUpdateCount = 0;
+    }
+
     private boolean setCountryCodeNative(String country, boolean isClientModeOnly) {
         Set<ActiveModeManager> amms = mAmmToReadyForChangeMap.keySet();
         boolean isConcreteClientModeManagerUpdated = false;
diff --git a/service/java/com/android/server/wifi/WifiDeviceStateChangeManager.java b/service/java/com/android/server/wifi/WifiDeviceStateChangeManager.java
index 0b6ffc68d1..d2c2e5653b 100644
--- a/service/java/com/android/server/wifi/WifiDeviceStateChangeManager.java
+++ b/service/java/com/android/server/wifi/WifiDeviceStateChangeManager.java
@@ -22,7 +22,6 @@ import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
 import android.net.wifi.util.Environment;
-import android.os.Handler;
 import android.os.PowerManager;
 import android.security.Flags;
 import android.security.advancedprotection.AdvancedProtectionManager;
@@ -37,7 +36,8 @@ import java.util.Set;
 
 /** A centralized manager to handle all the device state changes */
 public class WifiDeviceStateChangeManager {
-    private final Handler mHandler;
+    private static final String TAG = "WifiDeviceStateChangeManager";
+    private final WifiThreadRunner mWifiThreadRunner;
     private final Context mContext;
 
     private final PowerManager mPowerManager;
@@ -69,9 +69,9 @@ public class WifiDeviceStateChangeManager {
     }
 
     /** Create the instance of WifiDeviceStateChangeManager. */
-    public WifiDeviceStateChangeManager(Context context, Handler handler,
+    public WifiDeviceStateChangeManager(Context context, WifiThreadRunner threadRunner,
             WifiInjector wifiInjector) {
-        mHandler = handler;
+        mWifiThreadRunner = threadRunner;
         mContext = context;
         mWifiInjector = wifiInjector;
         mPowerManager = mContext.getSystemService(PowerManager.class);
@@ -91,9 +91,9 @@ public class WifiDeviceStateChangeManager {
                         String action = intent.getAction();
                         if (TextUtils.equals(action, Intent.ACTION_SCREEN_ON)
                                 || TextUtils.equals(action, Intent.ACTION_SCREEN_OFF)) {
-                            mHandler.post(() ->
+                            mWifiThreadRunner.post(() ->
                                     handleScreenStateChanged(TextUtils.equals(action,
-                                            Intent.ACTION_SCREEN_ON)));
+                                            Intent.ACTION_SCREEN_ON)), TAG + "SCREEN_CHANGE");
                         }
                     }
                 },
@@ -105,7 +105,7 @@ public class WifiDeviceStateChangeManager {
                     mContext.getSystemService(AdvancedProtectionManager.class);
             if (mAdvancedProtectionManager != null) {
                 mAdvancedProtectionManager.registerAdvancedProtectionCallback(
-                        new HandlerExecutor(mHandler),
+                        new HandlerExecutor(mWifiThreadRunner.getHandler()),
                         state -> {
                             handleAdvancedProtectionModeStateChanged(state);
                         });
diff --git a/service/java/com/android/server/wifi/WifiDialogManager.java b/service/java/com/android/server/wifi/WifiDialogManager.java
index 15485e9c80..2af1deabcb 100644
--- a/service/java/com/android/server/wifi/WifiDialogManager.java
+++ b/service/java/com/android/server/wifi/WifiDialogManager.java
@@ -34,6 +34,7 @@ import android.text.method.LinkMovementMethod;
 import android.text.style.URLSpan;
 import android.util.ArraySet;
 import android.util.Log;
+import android.util.Pair;
 import android.util.SparseArray;
 import android.view.ContextThemeWrapper;
 import android.view.Display;
@@ -52,6 +53,8 @@ import androidx.annotation.VisibleForTesting;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.wifi.resources.R;
 
+import java.util.ArrayList;
+import java.util.List;
 import java.util.Set;
 
 import javax.annotation.concurrent.ThreadSafe;
@@ -379,34 +382,180 @@ public class WifiDialogManager {
         }
     }
 
+    /**
+     * Builder for a simple dialog.
+     */
+    public class SimpleDialogBuilder {
+        @Nullable
+        private String mTitle;
+        @Nullable
+        private String mMessage;
+        @Nullable
+        private String mMessageUrl;
+        private int mMessageUrlStart;
+        private int mMessageUrlEnd;
+        @Nullable
+        private List<Pair<String, String>> mListItems;
+        @Nullable
+        private String mPositiveButtonText;
+        @Nullable
+        private String mNegativeButtonText;
+        @Nullable
+        private String mNeutralButtonText;
+        @Nullable
+        private SimpleDialogCallback mSimpleDialogCallback;
+        @Nullable
+        private WifiThreadRunner mCallbackThreadRunner;
+
+        /**
+         * Sets the title of the dialog.
+         */
+        public SimpleDialogBuilder setTitle(String title) {
+            mTitle = title;
+            return this;
+        }
+
+        /**
+         * Sets the message of the dialog.
+         */
+        public SimpleDialogBuilder setMessage(String message) {
+            mMessage = message;
+            return this;
+        }
+
+        /**
+         * Sets a clickable URL in the dialog message.
+         * @param messageUrl URL to point to
+         * @param messageUrlStart Starting index of the dialog message to apply the URL to.
+         * @param messageUrlEnd Ending index of the dialog message to apply the URL to.
+         */
+        public SimpleDialogBuilder setMessageUrl(
+                String messageUrl, int messageUrlStart, int messageUrlEnd) {
+            mMessageUrl = messageUrl;
+            mMessageUrlStart = messageUrlStart;
+            mMessageUrlEnd = messageUrlEnd;
+            return this;
+        }
+
+        /**
+         * Sets a list to display beneath the message. The list will be composed of two-line items
+         * containing a label and content beneath it.
+         * @param items List of items represented as pairs of label and content.
+         */
+        public SimpleDialogBuilder setListItems(List<Pair<String, String>> items) {
+            mListItems = items;
+            return this;
+        }
+
+        /**
+         * Sets the positive button text. If left unset, the positive button will not appear.
+         */
+        public SimpleDialogBuilder setPositiveButtonText(String positiveButtonText) {
+            mPositiveButtonText = positiveButtonText;
+            return this;
+        }
+
+        /**
+         * Sets the negative button text. If left unset, the negative button will not appear.
+         */
+        public SimpleDialogBuilder setNegativeButtonText(String negativeButtonText) {
+            mNegativeButtonText = negativeButtonText;
+            return this;
+        }
+
+        /**
+         * Sets the neutral button text. If left unset, the neutral button will not appear.
+         */
+        public SimpleDialogBuilder setNeutralButtonText(String neutralButtonText) {
+            mNeutralButtonText = neutralButtonText;
+            return this;
+        }
+
+        /**
+         * Sets a callback to listen to the dialog response. The callback must be accompanied with a
+         * WifiThreadRunner to run the response callbacks on.
+         */
+        public SimpleDialogBuilder setCallback(@NonNull SimpleDialogCallback simpleDialogCallback,
+                @NonNull WifiThreadRunner wifiThreadRunner) {
+            mSimpleDialogCallback = simpleDialogCallback;
+            mCallbackThreadRunner = wifiThreadRunner;
+            return this;
+        }
+
+        /**
+         * Builds a DialogHandle that will launch a simple dialog.
+         */
+        public DialogHandle build() {
+            if (!SdkLevel.isAtLeastT()) {
+                // WifiDialogs do not display correctly on Pre-T platform (b/238353074), so use the
+                // legacy dialog in this case.
+                return createLegacySimpleDialogWithUrl(mTitle, mMessage, mMessageUrl,
+                        mMessageUrlStart, mMessageUrlEnd, mPositiveButtonText, mNegativeButtonText,
+                        mNeutralButtonText, mSimpleDialogCallback, mCallbackThreadRunner);
+            }
+
+            Intent intent = getBaseLaunchIntent(WifiManager.DIALOG_TYPE_SIMPLE);
+            if (intent != null) {
+                if (mTitle != null) intent.putExtra(WifiManager.EXTRA_DIALOG_TITLE, mTitle);
+                if (mMessage != null) intent.putExtra(WifiManager.EXTRA_DIALOG_MESSAGE, mMessage);
+                if (mMessageUrl != null) {
+                    intent.putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL, mMessageUrl);
+                    intent.putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_START, mMessageUrlStart);
+                    intent.putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_END, mMessageUrlEnd);
+                }
+                if (mListItems != null) {
+                    ArrayList<String> labels = new ArrayList<>();
+                    ArrayList<String> contents = new ArrayList<>();
+                    for (Pair<String, String> pair : mListItems) {
+                        labels.add(pair.first);
+                        contents.add(pair.second);
+                    }
+                    intent.putStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_LABELS, labels);
+                    intent.putStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_CONTENTS,
+                            contents);
+                }
+                if (mPositiveButtonText != null) {
+                    intent.putExtra(
+                            WifiManager.EXTRA_DIALOG_POSITIVE_BUTTON_TEXT, mPositiveButtonText);
+                }
+                if (mNegativeButtonText != null) {
+                    intent.putExtra(
+                            WifiManager.EXTRA_DIALOG_NEGATIVE_BUTTON_TEXT, mNegativeButtonText);
+                }
+                if (mNeutralButtonText != null) {
+                    intent.putExtra(
+                            WifiManager.EXTRA_DIALOG_NEUTRAL_BUTTON_TEXT, mNeutralButtonText);
+                }
+            }
+            return new DialogHandle(
+                    new SimpleDialogHandle(
+                            intent,
+                            mSimpleDialogCallback,
+                            mCallbackThreadRunner));
+        }
+    }
+
+    /**
+     * Creates a SimpleDialogBuilder.
+     */
+    public SimpleDialogBuilder createSimpleDialogBuilder() {
+        return new SimpleDialogBuilder();
+    }
+
     private class SimpleDialogHandle extends DialogHandleInternal {
         @Nullable private final SimpleDialogCallback mCallback;
         @Nullable private final WifiThreadRunner mCallbackThreadRunner;
         private final String mTitle;
 
         SimpleDialogHandle(
-                final String title,
-                final String message,
-                final String messageUrl,
-                final int messageUrlStart,
-                final int messageUrlEnd,
-                final String positiveButtonText,
-                final String negativeButtonText,
-                final String neutralButtonText,
+                @Nullable final Intent intent,
                 @Nullable final SimpleDialogCallback callback,
                 @Nullable final WifiThreadRunner callbackThreadRunner) {
-            mTitle = title;
-            Intent intent = getBaseLaunchIntent(WifiManager.DIALOG_TYPE_SIMPLE);
             if (intent != null) {
-                intent.putExtra(WifiManager.EXTRA_DIALOG_TITLE, title)
-                        .putExtra(WifiManager.EXTRA_DIALOG_MESSAGE, message)
-                        .putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL, messageUrl)
-                        .putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_START, messageUrlStart)
-                        .putExtra(WifiManager.EXTRA_DIALOG_MESSAGE_URL_END, messageUrlEnd)
-                        .putExtra(WifiManager.EXTRA_DIALOG_POSITIVE_BUTTON_TEXT, positiveButtonText)
-                        .putExtra(WifiManager.EXTRA_DIALOG_NEGATIVE_BUTTON_TEXT, negativeButtonText)
-                        .putExtra(WifiManager.EXTRA_DIALOG_NEUTRAL_BUTTON_TEXT, neutralButtonText);
+                mTitle = intent.getStringExtra(WifiManager.EXTRA_DIALOG_TITLE);
                 setIntent(intent);
+            } else {
+                mTitle = "<null_intent>";
             }
             setDisplayId(Display.DEFAULT_DISPLAY);
             mCallback = callback;
@@ -628,107 +777,6 @@ public class WifiDialogManager {
         void onCancelled();
     }
 
-    /**
-     * Creates a simple dialog with optional title, message, and positive/negative/neutral buttons.
-     *
-     * @param title                Title of the dialog.
-     * @param message              Message of the dialog.
-     * @param positiveButtonText   Text of the positive button or {@code null} for no button.
-     * @param negativeButtonText   Text of the negative button or {@code null} for no button.
-     * @param neutralButtonText    Text of the neutral button or {@code null} for no button.
-     * @param callback             Callback to receive the dialog response.
-     * @param callbackThreadRunner WifiThreadRunner to run the callback on.
-     * @return DialogHandle        Handle for the dialog, or {@code null} if no dialog could
-     *                             be created.
-     */
-    @AnyThread
-    @NonNull
-    public DialogHandle createSimpleDialog(
-            @Nullable String title,
-            @Nullable String message,
-            @Nullable String positiveButtonText,
-            @Nullable String negativeButtonText,
-            @Nullable String neutralButtonText,
-            @NonNull SimpleDialogCallback callback,
-            @NonNull WifiThreadRunner callbackThreadRunner) {
-        return createSimpleDialogWithUrl(
-                title,
-                message,
-                null /* messageUrl */,
-                0 /* messageUrlStart */,
-                0 /* messageUrlEnd */,
-                positiveButtonText,
-                negativeButtonText,
-                neutralButtonText,
-                callback,
-                callbackThreadRunner);
-    }
-
-    /**
-     * Creates a simple dialog with a URL embedded in the message.
-     *
-     * @param title                Title of the dialog.
-     * @param message              Message of the dialog.
-     * @param messageUrl           URL to embed in the message. If non-null, then message must also
-     *                             be non-null.
-     * @param messageUrlStart      Start index (inclusive) of the URL in the message. Must be
-     *                             non-negative.
-     * @param messageUrlEnd        End index (exclusive) of the URL in the message. Must be less
-     *                             than the length of message.
-     * @param positiveButtonText   Text of the positive button or {@code null} for no button.
-     * @param negativeButtonText   Text of the negative button or {@code null} for no button.
-     * @param neutralButtonText    Text of the neutral button or {@code null} for no button.
-     * @param callback             Callback to receive the dialog response.
-     * @param callbackThreadRunner WifiThreadRunner to run the callback on.
-     * @return DialogHandle        Handle for the dialog, or {@code null} if no dialog could
-     *                             be created.
-     */
-    @AnyThread
-    @NonNull
-    public DialogHandle createSimpleDialogWithUrl(
-            @Nullable String title,
-            @Nullable String message,
-            @Nullable String messageUrl,
-            int messageUrlStart,
-            int messageUrlEnd,
-            @Nullable String positiveButtonText,
-            @Nullable String negativeButtonText,
-            @Nullable String neutralButtonText,
-            @NonNull SimpleDialogCallback callback,
-            @NonNull WifiThreadRunner callbackThreadRunner) {
-        if (SdkLevel.isAtLeastT()) {
-            return new DialogHandle(
-                    new SimpleDialogHandle(
-                            title,
-                            message,
-                            messageUrl,
-                            messageUrlStart,
-                            messageUrlEnd,
-                            positiveButtonText,
-                            negativeButtonText,
-                            neutralButtonText,
-                            callback,
-                            callbackThreadRunner)
-            );
-        } else {
-            // TODO(b/238353074): Remove this fallback to the legacy implementation once the
-            //                    AlertDialog style on pre-T platform is fixed.
-            return new DialogHandle(
-                    new LegacySimpleDialogHandle(
-                            title,
-                            message,
-                            messageUrl,
-                            messageUrlStart,
-                            messageUrlEnd,
-                            positiveButtonText,
-                            negativeButtonText,
-                            neutralButtonText,
-                            callback,
-                            callbackThreadRunner)
-            );
-        }
-    }
-
     /**
      * Creates a legacy simple dialog on the system process with optional title, message, and
      * positive/negative/neutral buttons.
diff --git a/service/java/com/android/server/wifi/WifiInjector.java b/service/java/com/android/server/wifi/WifiInjector.java
index 7bc2604102..cf266576bc 100644
--- a/service/java/com/android/server/wifi/WifiInjector.java
+++ b/service/java/com/android/server/wifi/WifiInjector.java
@@ -309,7 +309,8 @@ public class WifiInjector {
         mWifiHandler = new RunnerHandler(wifiLooper, context.getResources().getInteger(
                 R.integer.config_wifiConfigurationWifiRunnerThresholdInMs),
                 mWifiHandlerLocalLog);
-        mWifiDeviceStateChangeManager = new WifiDeviceStateChangeManager(context, mWifiHandler,
+        mWifiThreadRunner = new WifiThreadRunner(mWifiHandler);
+        mWifiDeviceStateChangeManager = new WifiDeviceStateChangeManager(context, mWifiThreadRunner,
                 this);
         mWifiGlobals = new WifiGlobals(mContext);
         mWifiMetrics = new WifiMetrics(mContext, mFrameworkFacade, mClock, wifiLooper,
@@ -334,7 +335,6 @@ public class WifiInjector {
         mWifiBackupRestore = new WifiBackupRestore(mWifiPermissionsUtil);
         mSoftApBackupRestore = new SoftApBackupRestore(mContext, mSettingsMigrationDataHolder);
         mWifiStateTracker = new WifiStateTracker(mBatteryStats);
-        mWifiThreadRunner = new WifiThreadRunner(mWifiHandler);
         mWifiDialogManager = new WifiDialogManager(mContext, mWifiThreadRunner, mFrameworkFacade,
                 this);
         mSsidTranslator = new SsidTranslator(mContext, mWifiHandler);
@@ -356,7 +356,7 @@ public class WifiInjector {
         mSupplicantStaIfaceHal = new SupplicantStaIfaceHal(
                 mContext, mWifiMonitor, mFrameworkFacade, mWifiHandler, mClock, mWifiMetrics,
                 mWifiGlobals, mSsidTranslator, this);
-        mMainlineSupplicant = new MainlineSupplicant(mWifiThreadRunner);
+        mMainlineSupplicant = new MainlineSupplicant(mWifiThreadRunner, mContext, mWifiGlobals);
         mHostapdHal = new HostapdHal(mContext, mWifiHandler);
         mWifiCondManager = (WifiNl80211Manager) mContext.getSystemService(
                 Context.WIFI_NL80211_SERVICE);
@@ -418,7 +418,7 @@ public class WifiInjector {
                         : maxLinesHighRam);
         mWifiDiagnostics = new WifiDiagnostics(
                 mContext, this, mWifiNative, mBuildProperties,
-                new LastMileLogger(this, BackgroundThread.getHandler()), mClock,
+                new LastMileLogger(this), mClock,
                 mWifiDiagnosticsHandlerThread.getLooper());
         mWifiLastResortWatchdog = new WifiLastResortWatchdog(this, mContext, mClock,
                 mWifiMetrics, mWifiDiagnostics, wifiLooper,
@@ -603,14 +603,14 @@ public class WifiInjector {
                 mWifiConfigStore, mWifiNetworkSuggestionsManager, mWifiMetrics.getWakeupMetrics(),
                 this, mFrameworkFacade, mClock, mActiveModeWarden);
         mLockManager = new WifiLockManager(mContext, mBatteryStats, mActiveModeWarden,
-                mFrameworkFacade, mWifiHandler, mClock, mWifiMetrics, mDeviceConfigFacade,
+                mFrameworkFacade, mWifiThreadRunner, mClock, mWifiMetrics, mDeviceConfigFacade,
                 mWifiPermissionsUtil, mWifiDeviceStateChangeManager);
         mSelfRecovery = new SelfRecovery(mContext, mActiveModeWarden, mClock, mWifiNative,
                 mWifiGlobals);
         mWifiMulticastLockManager = new WifiMulticastLockManager(mActiveModeWarden, mBatteryStats,
                 wifiLooper, mContext, mClock, mWifiMetrics, mWifiPermissionsUtil);
         mApplicationQosPolicyRequestHandler = new ApplicationQosPolicyRequestHandler(
-                mActiveModeWarden, mWifiNative, mWifiHandlerThread, mDeviceConfigFacade, mContext);
+                mActiveModeWarden, mWifiNative, mWifiHandlerThread, mContext);
 
         // Register the various network Nominators with the network selector.
         mWifiNetworkSelector.registerNetworkNominator(mSavedNetworkNominator);
diff --git a/service/java/com/android/server/wifi/WifiLinkLayerStats.java b/service/java/com/android/server/wifi/WifiLinkLayerStats.java
index 0276514a63..be4c23e7ad 100644
--- a/service/java/com/android/server/wifi/WifiLinkLayerStats.java
+++ b/service/java/com/android/server/wifi/WifiLinkLayerStats.java
@@ -21,6 +21,8 @@ import android.net.wifi.WifiUsabilityStatsEntry.LinkState;
 import android.net.wifi.WifiUsabilityStatsEntry.WifiChannelBandwidth;
 import android.util.SparseArray;
 
+import com.android.server.wifi.util.ArrayUtils;
+
 import java.util.Arrays;
 import java.util.List;
 
@@ -835,7 +837,7 @@ public class WifiLinkLayerStats {
      * - Squash all peer stat lists to a single list of peers.
      */
     public void aggregateLinkLayerStats() {
-        if (links == null) return;
+        if (ArrayUtils.isEmpty(links)) return;
         int i = getBestLinkIndex();
         rssi_mgmt = links[i].rssi_mgmt;
         beacon_rx = links[i].beacon_rx;
diff --git a/service/java/com/android/server/wifi/WifiLockManager.java b/service/java/com/android/server/wifi/WifiLockManager.java
index 040aca88bc..cbed2a76e1 100644
--- a/service/java/com/android/server/wifi/WifiLockManager.java
+++ b/service/java/com/android/server/wifi/WifiLockManager.java
@@ -23,7 +23,6 @@ import android.net.wifi.IWifiLowLatencyLockListener;
 import android.net.wifi.WifiManager;
 import android.os.BatteryStatsManager;
 import android.os.Binder;
-import android.os.Handler;
 import android.os.IBinder;
 import android.os.RemoteCallbackList;
 import android.os.RemoteException;
@@ -38,6 +37,7 @@ import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.proto.WifiStatsLog;
 import com.android.server.wifi.util.WifiPermissionsUtil;
 import com.android.server.wifi.util.WorkSourceUtil;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import java.io.PrintWriter;
@@ -73,7 +73,7 @@ public class WifiLockManager {
     private final FrameworkFacade mFrameworkFacade;
     private final ActiveModeWarden mActiveModeWarden;
     private final ActivityManager mActivityManager;
-    private final Handler mHandler;
+    private final WifiThreadRunner mThreadRunner;
     private final WifiMetrics mWifiMetrics;
 
     private final List<WifiLock> mWifiLocks = new ArrayList<>();
@@ -82,8 +82,9 @@ public class WifiLockManager {
     /** the current op mode of the primary ClientModeManager */
     private int mCurrentOpMode = WifiManager.WIFI_MODE_NO_LOCKS_HELD;
     private boolean mScreenOn = false;
-    /** whether Wifi is connected on the primary ClientModeManager */
-    private boolean mWifiConnected = false;
+    private boolean mStaConnected = false;
+    private boolean mP2pConnected = false;
+    private boolean mAwareConnected = false;
 
     // For shell command support
     private boolean mForceHiPerfMode = false;
@@ -102,10 +103,6 @@ public class WifiLockManager {
     private boolean mIsLowLatencyActivated = false;
     private WorkSource mLowLatencyBlamedWorkSource = new WorkSource();
     private WorkSource mHighPerfBlamedWorkSource = new WorkSource();
-    private enum BlameReason {
-        WIFI_CONNECTION_STATE_CHANGED,
-        SCREEN_STATE_CHANGED,
-    };
     private final Object mLock = new Object();
 
     WifiLockManager(
@@ -113,7 +110,7 @@ public class WifiLockManager {
             BatteryStatsManager batteryStats,
             ActiveModeWarden activeModeWarden,
             FrameworkFacade frameworkFacade,
-            Handler handler,
+            WifiThreadRunner threadRunner,
             Clock clock,
             WifiMetrics wifiMetrics,
             DeviceConfigFacade deviceConfigFacade,
@@ -124,7 +121,7 @@ public class WifiLockManager {
         mActiveModeWarden = activeModeWarden;
         mFrameworkFacade = frameworkFacade;
         mActivityManager = (ActivityManager) mContext.getSystemService(Context.ACTIVITY_SERVICE);
-        mHandler = handler;
+        mThreadRunner = threadRunner;
         mClock = clock;
         mWifiMetrics = wifiMetrics;
         mDeviceConfigFacade = deviceConfigFacade;
@@ -148,48 +145,19 @@ public class WifiLockManager {
     }
 
     // Check for conditions to activate high-perf lock
-    private boolean canActivateHighPerfLock(int ignoreMask) {
-        boolean check = true;
-
-        // Only condition is when Wifi is connected
-        if ((ignoreMask & IGNORE_WIFI_STATE_MASK) == 0) {
-            check = check && mWifiConnected;
-        }
-
-        return check;
-    }
-
     private boolean canActivateHighPerfLock() {
-        return canActivateHighPerfLock(0);
+        // Only condition is when Wifi is connected
+        return mStaConnected;
     }
 
     // Check for conditions to activate low-latency lock
-    private boolean canActivateLowLatencyLock(int ignoreMask, UidRec uidRec) {
-        boolean check = true;
-
-        if ((ignoreMask & IGNORE_WIFI_STATE_MASK) == 0) {
-            check = check && mWifiConnected;
-        }
-        if ((ignoreMask & IGNORE_SCREEN_STATE_MASK) == 0) {
-            check = check && mScreenOn;
-        }
-        if (uidRec != null) {
-            check = check && uidRec.mIsFg;
-        }
-
-        return check;
-    }
-
-    private boolean canActivateLowLatencyLock(int ignoreMask) {
-        return canActivateLowLatencyLock(ignoreMask, null);
-    }
-
-    private boolean canActivateLowLatencyLock() {
-        return canActivateLowLatencyLock(0, null);
+    private boolean canAppActivateLowLatencyLock(UidRec uidRec) {
+        return uidRec.mIsFg && isScreenStateValidForApp(uidRec)
+                && isConnectionRequirementSatisfiedForApp(uidRec);
     }
 
     private void onAppForeground(final int uid, final int importance) {
-        mHandler.post(() -> {
+        mThreadRunner.post(() -> {
             UidRec uidRec = mLowLatencyUidWatchList.get(uid);
             if (uidRec == null) {
                 // Not a uid in the watch list
@@ -204,15 +172,15 @@ public class WifiLockManager {
             uidRec.mIsFg = newModeIsFg;
             updateOpMode();
 
-            // If conditions for lock activation are met,
-            // then UID either share the blame, or removed from sharing
-            // whether to start or stop the blame based on UID fg/bg state
-            if (canActivateLowLatencyLock(
-                    uidRec.mIsScreenOnExempted ? IGNORE_SCREEN_STATE_MASK : 0)) {
+            // If the connection and screen conditions are met,
+            // then the foreground state change will affect blaming.
+            boolean hasValidConnection = isConnectionRequirementSatisfiedForApp(uidRec);
+            boolean hasValidScreenState = isScreenStateValidForApp(uidRec);
+            if (hasValidConnection && hasValidScreenState) {
                 setBlameLowLatencyUid(uid, uidRec.mIsFg);
                 notifyLowLatencyActiveUsersChanged();
             }
-        });
+        }, TAG + "#onAppForeground");
     }
 
     // Detect UIDs going,
@@ -268,6 +236,34 @@ public class WifiLockManager {
         return releaseLock(binder);
     }
 
+    private int getNumActiveConnectionTypes(boolean countD2dConnections) {
+        int numConnectionTypes = 0;
+        if (mStaConnected) numConnectionTypes++;
+        if (countD2dConnections) {
+            if (mP2pConnected) numConnectionTypes++;
+            if (mAwareConnected) numConnectionTypes++;
+        }
+        return numConnectionTypes;
+    }
+
+    private boolean isWifiConnectionActive() {
+        if (doesD2dSatisfyConnectionRequirementForAnyApp()) {
+            return mStaConnected || mP2pConnected || mAwareConnected;
+        }
+        return mStaConnected;
+    }
+
+    private boolean isConnectionRequirementSatisfiedForApp(UidRec uidRec) {
+        if (uidRec.mD2dSatisfiesConnectionRequirement) {
+            return mStaConnected || mP2pConnected || mAwareConnected;
+        }
+        return mStaConnected;
+    }
+
+    private boolean isScreenStateValidForApp(UidRec uidRec) {
+        return uidRec.mIsScreenOnExempted ? true : mScreenOn;
+    }
+
     /**
      * Method used to get the strongest lock type currently held by the WifiLockManager.
      *
@@ -277,8 +273,8 @@ public class WifiLockManager {
      */
     @VisibleForTesting
     synchronized int getStrongestLockMode() {
-        // If Wifi Client is not connected, then all locks are not effective
-        if (!mWifiConnected) {
+        // If the connection requirement is not met, then WifiLocks are not effective
+        if (!isWifiConnectionActive()) {
             return WifiManager.WIFI_MODE_NO_LOCKS_HELD;
         }
 
@@ -411,12 +407,45 @@ public class WifiLockManager {
 
         mScreenOn = screenOn;
 
-        if (canActivateLowLatencyLock(IGNORE_SCREEN_STATE_MASK)) {
+        // If the connection requirement is met, then the screen state change may affect blaming.
+        if (isWifiConnectionActive()) {
             // Update the running mode
             updateOpMode();
             // Adjust blaming for UIDs in foreground
-            setBlameLowLatencyWatchList(BlameReason.SCREEN_STATE_CHANGED, screenOn);
+            updateBlameForScreenStateChange();
+        }
+    }
+
+    /**
+     * Handler for any connection state change.
+     *
+     * @param isStaConnection true if a STA connection was changed, or false otherwise.
+     * @param connectionWasStarted true if the connection was started,
+     *                             or false if it was stopped.
+     */
+    private void handleConnectionChanged(boolean isStaConnection, boolean connectionWasStarted) {
+        boolean shouldConsiderD2dConnections = doesD2dSatisfyConnectionRequirementForAnyApp();
+        if (!isStaConnection && !shouldConsiderD2dConnections) return;
+
+        boolean shouldBlameD2dAllowedApps = false;
+        if (shouldConsiderD2dConnections) {
+            // When multiple connection types are valid, only update blaming if the last valid
+            // connection was ended, or the first valid connection was just started.
+            int numConnectionTypes = getNumActiveConnectionTypes(true);
+            shouldBlameD2dAllowedApps = numConnectionTypes == 0
+                    || (connectionWasStarted && numConnectionTypes == 1);
+        }
+        if (!isStaConnection && !shouldBlameD2dAllowedApps) {
+            // No apps are affected by this connection state change.
+            return;
+        }
+
+        // If the screen condition is met, then the connection state change may affect blaming.
+        boolean screenExemptedAppExists = countFgLowLatencyUids(/* isScreenOnExempted */ true) > 0;
+        if (screenExemptedAppExists || mScreenOn) {
+            updateBlameForConnectionStateChange(shouldBlameD2dAllowedApps, isStaConnection);
         }
+        updateOpMode();
     }
 
     /**
@@ -431,27 +460,45 @@ public class WifiLockManager {
             Log.d(TAG, "updateWifiClientConnected hasAtLeastOneConnection="
                     + hasAtLeastOneConnection);
         }
-        if (mWifiConnected == hasAtLeastOneConnection) {
+        if (mStaConnected == hasAtLeastOneConnection) {
             // No need to take action
             return;
         }
-        mWifiConnected = hasAtLeastOneConnection;
-
-        // Adjust blaming for UIDs in foreground carrying low latency locks
-        if (canActivateLowLatencyLock(countFgLowLatencyUids(/*isScreenOnExempted*/ true) > 0
-                ? IGNORE_SCREEN_STATE_MASK | IGNORE_WIFI_STATE_MASK
-                : IGNORE_WIFI_STATE_MASK)) {
-            setBlameLowLatencyWatchList(BlameReason.WIFI_CONNECTION_STATE_CHANGED, mWifiConnected);
-        }
+        mStaConnected = hasAtLeastOneConnection;
 
         // Adjust blaming for UIDs carrying high perf locks
         // Note that blaming is adjusted only if needed,
         // since calling this API is reference counted
-        if (canActivateHighPerfLock(IGNORE_WIFI_STATE_MASK)) {
-            setBlameHiPerfLocks(mWifiConnected);
+        setBlameHiPerfLocks(mStaConnected);
+        handleConnectionChanged(true, mStaConnected);
+    }
+
+    /**
+     * Handler for P2P connection state changes.
+     */
+    public void updateP2pConnected(boolean isConnected) {
+        if (mP2pConnected == isConnected) {
+            return;
+        }
+        if (mVerboseLoggingEnabled) {
+            Log.i(TAG, "Updating P2P connected state to " + isConnected);
         }
+        mP2pConnected = isConnected;
+        handleConnectionChanged(false, mP2pConnected);
+    }
 
-        updateOpMode();
+    /**
+     * Handler for Aware connection state changes.
+     */
+    public void updateAwareConnected(boolean isConnected) {
+        if (mAwareConnected == isConnected) {
+            return;
+        }
+        if (mVerboseLoggingEnabled) {
+            Log.i(TAG, "Updating Aware connected state to " + isConnected);
+        }
+        mAwareConnected = isConnected;
+        handleConnectionChanged(false, mAwareConnected);
     }
 
     private synchronized void setBlameHiPerfLocks(boolean shouldBlame) {
@@ -496,6 +543,12 @@ public class WifiLockManager {
                 <= ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND_SERVICE)) {
             return true;
         }
+        // Exemption for applications that can project to a nearby device.
+        if (mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(uid)
+                && (importance
+                <= ActivityManager.RunningAppProcessInfo.IMPORTANCE_SERVICE)) {
+            return true;
+        }
         // Add any exemption cases for applications regarding restricting Low latency locks to
         // running in the foreground.
         return false;
@@ -524,10 +577,35 @@ public class WifiLockManager {
         if (mWifiPermissionsUtil.checkRequestCompanionProfileAutomotiveProjectionPermission(uid)) {
             return true;
         }
+        // Exemption for applications that can project to a nearby device.
+        if (mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(uid)) {
+            return true;
+        }
         // Add more exemptions here
         return false;
     }
 
+    private boolean doesD2dSatisfyConnectionRequirementForApp(int uid) {
+        if (!Flags.wifiLockActivatedByP2pOrAware()) {
+            return false;
+        }
+        if (mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(uid)) {
+            return true;
+        }
+        return false;
+    }
+
+    private boolean doesD2dSatisfyConnectionRequirementForAnyApp() {
+        if (!Flags.wifiLockActivatedByP2pOrAware()) return false;
+        for (int i = 0; i < mLowLatencyUidWatchList.size(); i++) {
+            UidRec uidRec = mLowLatencyUidWatchList.valueAt(i);
+            if (uidRec.mD2dSatisfiesConnectionRequirement) {
+                return true;
+            }
+        }
+        return false;
+    }
+
     private void addUidToLlWatchList(int uid) {
         UidRec uidRec = mLowLatencyUidWatchList.get(uid);
         if (uidRec != null) {
@@ -544,10 +622,10 @@ public class WifiLockManager {
             uidRec.mIsFgExempted = isAppExemptedFromImportance(uid,
                     ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND);
             uidRec.mIsScreenOnExempted = isAppExemptedFromScreenOn(uid);
+            uidRec.mD2dSatisfiesConnectionRequirement =
+                    doesD2dSatisfyConnectionRequirementForApp(uid);
 
-            if (canActivateLowLatencyLock(
-                    uidRec.mIsScreenOnExempted ? IGNORE_SCREEN_STATE_MASK : 0,
-                    uidRec)) {
+            if (canAppActivateLowLatencyLock(uidRec)) {
                 // Share the blame for this uid
                 setBlameLowLatencyUid(uid, true);
                 notifyLowLatencyActiveUsersChanged();
@@ -574,8 +652,7 @@ public class WifiLockManager {
             // Remove blame for this UID if it was already set
             // Note that blame needs to be stopped only if it was started before
             // to avoid calling the API unnecessarily, since it is reference counted
-            if (canActivateLowLatencyLock(uidRec.mIsScreenOnExempted ? IGNORE_SCREEN_STATE_MASK : 0,
-                    uidRec)) {
+            if (canAppActivateLowLatencyLock(uidRec)) {
                 setBlameLowLatencyUid(uid, false);
                 notifyLowLatencyActiveUsersChanged();
             }
@@ -649,7 +726,7 @@ public class WifiLockManager {
 
         // Recalculate the operating mode
         updateOpMode();
-        mHandler.removeCallbacksAndMessages(mLock);
+        mThreadRunner.removeCallbacks(mLock);
         return true;
     }
 
@@ -713,7 +790,8 @@ public class WifiLockManager {
                 break;
         }
         // Delay 1s to release the lock to avoid stress the HAL.
-        mHandler.postDelayed(this::updateOpMode, mLock, DELAY_LOCK_RELEASE_MS);
+        mThreadRunner.postDelayed(this::updateOpMode, DELAY_LOCK_RELEASE_MS,
+                TAG + "#updateOpMode", mLock);
         return true;
     }
 
@@ -1076,39 +1154,74 @@ public class WifiLockManager {
         }
     }
 
-    private void setBlameLowLatencyWatchList(BlameReason reason, boolean shouldBlame) {
-        boolean notify = false;
-        for (int idx = 0; idx < mLowLatencyUidWatchList.size(); idx++) {
-            UidRec uidRec = mLowLatencyUidWatchList.valueAt(idx);
-            // The blame state of the UIDs should not be changed if the app is exempted from
-            // screen-on and the reason for blaming is screen state change.
-            if (uidRec.mIsScreenOnExempted && reason == BlameReason.SCREEN_STATE_CHANGED) {
-                continue;
+    private void updateBlameForConnectionStateChange(boolean shouldBlameD2dAllowedApps,
+            boolean shouldBlameNonD2dAllowedApps) {
+        boolean activeUsersChanged = false;
+        for (int i = 0; i < mLowLatencyUidWatchList.size(); i++) {
+            UidRec uidRec = mLowLatencyUidWatchList.valueAt(i);
+            boolean shouldBlame = uidRec.mD2dSatisfiesConnectionRequirement
+                    ? shouldBlameD2dAllowedApps : shouldBlameNonD2dAllowedApps;
+            if (!shouldBlame) continue;
+
+            // If the screen and foreground conditions are met,
+            // then the connection state change will affect blaming.
+            boolean hasValidScreenState = isScreenStateValidForApp(uidRec);
+            if (hasValidScreenState && uidRec.mIsFg) {
+                boolean hasValidConnection = isConnectionRequirementSatisfiedForApp(uidRec);
+                setBlameLowLatencyUid(uidRec.mUid, hasValidConnection);
+                activeUsersChanged = true;
             }
-            // Affect the blame for only UIDs running in foreground
-            // UIDs running in the background are already not blamed,
-            // and they should remain in that state.
-            if (uidRec.mIsFg) {
-                setBlameLowLatencyUid(uidRec.mUid, shouldBlame);
-                notify = true;
+        }
+        if (activeUsersChanged) {
+            notifyLowLatencyActiveUsersChanged();
+        }
+    }
+
+    private void updateBlameForScreenStateChange() {
+        boolean activeUsersChanged = false;
+        for (int i = 0; i < mLowLatencyUidWatchList.size(); i++) {
+            // Only blame apps without the screen state exemption.
+            UidRec uidRec = mLowLatencyUidWatchList.valueAt(i);
+            if (uidRec.mIsScreenOnExempted) continue;
+
+            // If the connection and foreground conditions are met,
+            // then the screen state change will affect blaming.
+            boolean hasValidConnection = isConnectionRequirementSatisfiedForApp(uidRec);
+            if (hasValidConnection && uidRec.mIsFg) {
+                setBlameLowLatencyUid(uidRec.mUid, mScreenOn);
+                activeUsersChanged = true;
             }
         }
-        if (notify) notifyLowLatencyActiveUsersChanged();
+        if (activeUsersChanged) {
+            notifyLowLatencyActiveUsersChanged();
+        }
     }
 
     protected synchronized void dump(PrintWriter pw) {
+        pw.println("Dump of WifiLockManager");
         pw.println("Locks acquired: "
                 + mFullHighPerfLocksAcquired + " full high perf, "
                 + mFullLowLatencyLocksAcquired + " full low latency");
         pw.println("Locks released: "
                 + mFullHighPerfLocksReleased + " full high perf, "
                 + mFullLowLatencyLocksReleased + " full low latency");
+        pw.println("Connection state: STA=" + mStaConnected + ", P2P=" + mP2pConnected
+                + ", Aware=" + mAwareConnected);
+        pw.println("Screen state: " + mScreenOn);
+        pw.println("Current operation mode: " + mCurrentOpMode);
 
         pw.println();
         pw.println("Locks held:");
         for (WifiLock lock : mWifiLocks) {
-            pw.print("    ");
-            pw.println(lock);
+            // Indent each record in the formatted output
+            pw.println("    " + lock);
+        }
+
+        pw.println();
+        pw.println("Low-latency uid watchlist:");
+        for (int i = 0; i < mLowLatencyUidWatchList.size(); i++) {
+            UidRec uidRec = mLowLatencyUidWatchList.valueAt(i);
+            pw.println("    " + uidRec);
         }
     }
 
@@ -1156,7 +1269,7 @@ public class WifiLockManager {
         }
 
         public void binderDied() {
-            mHandler.post(() -> releaseLock(mBinder));
+            mThreadRunner.post(() -> releaseLock(mBinder), TAG + "#binderDied");
         }
 
         public void unlinkDeathRecipient() {
@@ -1181,9 +1294,16 @@ public class WifiLockManager {
         boolean mIsFg;
         boolean mIsFgExempted = false;
         boolean mIsScreenOnExempted = false;
+        boolean mD2dSatisfiesConnectionRequirement = false;
 
         UidRec(int uid) {
             mUid = uid;
         }
+
+        public String toString() {
+            return "UidRec{uid=" + mUid + ", lockCount=" + mLockCount + ", isFg=" + mIsFg
+                    + ", isFgExempt=" + mIsFgExempted + ", isScreenExempt=" + mIsScreenOnExempted
+                    + ", d2dSatisfiesConnection=" + mD2dSatisfiesConnectionRequirement + "}";
+        }
     }
 }
diff --git a/service/java/com/android/server/wifi/WifiMetrics.java b/service/java/com/android/server/wifi/WifiMetrics.java
index 52eac0d037..39a3892fe5 100644
--- a/service/java/com/android/server/wifi/WifiMetrics.java
+++ b/service/java/com/android/server/wifi/WifiMetrics.java
@@ -19,31 +19,30 @@ package com.android.server.wifi;
 import static android.net.wifi.WifiConfiguration.MeteredOverride;
 
 import static com.android.server.wifi.ActiveModeManager.ROLE_CLIENT_PRIMARY;
-import static com.android.server.wifi.proto.WifiStatsLog.WIFI_CONFIG_SAVED;
-import static com.android.server.wifi.proto.WifiStatsLog.WIFI_IS_UNUSABLE_REPORTED;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_NO_CELLULAR_MODEM;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_NO_SIM_INSERTED;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_SCORING_DISABLED;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_CELLULAR_OFF;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_CELLULAR_UNAVAILABLE;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_NO_CELLULAR_MODEM;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_NO_SIM_INSERTED;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_OTHERS;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_DS__TRUE;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__DEVICE_STATE__STATE_SCORING_DISABLED;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_DS__FALSE;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_US__TRUE;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_DS__TRUE;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_US__FALSE;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_DS__TRUE;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_NETWORK_CAPABILITIES_US__TRUE;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_DS__FALSE;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_US__TRUE;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_DS__TRUE;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_US__FALSE;
-import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__UNUSABLE_EVENT__EVENT_FRAMEWORK_DATA_STALL;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__SPEED_SUFFICIENT_THROUGHPUT_PREDICTOR_US__TRUE;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__UNUSABLE_EVENT__EVENT_FIRMWARE_ALERT;
+import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__UNUSABLE_EVENT__EVENT_FRAMEWORK_DATA_STALL;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__UNUSABLE_EVENT__EVENT_IP_REACHABILITY_LOST;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__UNUSABLE_EVENT__EVENT_NONE;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__WIFI_FRAMEWORK_STATE__FRAMEWORK_STATE_AWAKENING;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__WIFI_FRAMEWORK_STATE__FRAMEWORK_STATE_CONNECTED;
 import static com.android.server.wifi.proto.WifiStatsLog.SCORER_PREDICTION_RESULT_REPORTED__WIFI_FRAMEWORK_STATE__FRAMEWORK_STATE_LINGERING;
-
+import static com.android.server.wifi.proto.WifiStatsLog.WIFI_CONFIG_SAVED;
+import static com.android.server.wifi.proto.WifiStatsLog.WIFI_IS_UNUSABLE_REPORTED;
 
 import static java.lang.StrictMath.toIntExact;
 
@@ -301,9 +300,6 @@ public class WifiMetrics {
     private WifiLinkLayerStats mLastLinkLayerStats;
     private WifiHealthMonitor mWifiHealthMonitor;
     private WifiScoreCard mWifiScoreCard;
-    private SessionData mPreviousSession;
-    @VisibleForTesting
-    public SessionData mCurrentSession;
     private Map<String, String> mLastBssidPerIfaceMap = new ArrayMap<>();
     private Map<String, Integer> mLastFrequencyPerIfaceMap = new ArrayMap<>();
     private int mSeqNumInsideFramework = 0;
@@ -369,6 +365,8 @@ public class WifiMetrics {
      * The latest started (but un-ended) connection attempt per interface.
      */
     private final Map<String, ConnectionEvent> mCurrentConnectionEventPerIface = new ArrayMap<>();
+    private final Map<String, SessionData> mPreviousConnectionSessionPerIface = new ArrayMap<>();
+    private final Map<String, SessionData> mCurrentConnectionSessionPerIface = new ArrayMap<>();
     /**
      * Count of number of times each scan return code, indexed by WifiLog.ScanReturnCode
      */
@@ -730,6 +728,8 @@ public class WifiMetrics {
         private int mAuthType;
         public ConnectionEvent mConnectionEvent;
         private long mLastRoamCompleteMillis;
+        public WifiValidationInfo mValidationInfo;
+        public int mDisconnectReason;
 
         SessionData(ConnectionEvent connectionEvent, String ssid, long sessionStartTimeMillis,
                 int band, int authType) {
@@ -739,15 +739,74 @@ public class WifiMetrics {
             mBand = band;
             mAuthType = authType;
             mLastRoamCompleteMillis = sessionStartTimeMillis;
+            mValidationInfo = new WifiValidationInfo();
         }
     }
 
     /**
      * Sets the timestamp after roaming is complete.
      */
-    public void onRoamComplete() {
-        if (mCurrentSession != null) {
-            mCurrentSession.mLastRoamCompleteMillis = mClock.getElapsedSinceBootMillis();
+    public void onRoamComplete(String ifaceName) {
+        SessionData currentSession = mCurrentConnectionSessionPerIface.get(ifaceName);
+        if (currentSession != null) {
+            currentSession.mLastRoamCompleteMillis = mClock.getElapsedSinceBootMillis();
+        }
+    }
+
+    static class WifiValidationInfo {
+        public int mStatus;
+        public long mL3ConnectedStateTimestamp;
+        public long mLastValidationTimestamp;
+        private boolean mCaptivePortalDetected;
+
+        private int mValidationCount = 0;
+        private boolean mHasReportedValidationResult = false;
+    }
+
+    /**
+     *  Sets last Wifi validation status
+     */
+    public void setLastValidationInfo(
+            String ifaceName,
+            int status,
+            long l3ConnectedStateTimestamp,
+            long lastValidationTimestamp,
+            boolean captivePortalDetected) {
+        SessionData currentSession = mCurrentConnectionSessionPerIface.get(ifaceName);
+        if (currentSession != null) {
+            currentSession.mValidationInfo.mStatus = status;
+            currentSession.mValidationInfo.mL3ConnectedStateTimestamp = l3ConnectedStateTimestamp;
+            currentSession.mValidationInfo.mLastValidationTimestamp = lastValidationTimestamp;
+            currentSession.mValidationInfo.mValidationCount += 1;
+            currentSession.mValidationInfo.mCaptivePortalDetected = captivePortalDetected;
+        }
+    }
+
+    /**
+     * Call when wifi network validation success. Log wifi network validation result and time
+     * duration for the connected network.
+     *
+     * <p>Only log for the following conditions: 1. The first validation success in current session.
+     * 2. If never success, log the last validation info when disconnect.
+     * @param ifaceName interface name for this validation result.
+     * @param status Network validation result, a value from NetworkAgent.ValidationStatus.
+     */
+    public void reportWifiValidationResult(
+            String ifaceName, int status) {
+        SessionData currentSession = mCurrentConnectionSessionPerIface.get(ifaceName);
+        if (currentSession != null
+                && !currentSession.mValidationInfo.mHasReportedValidationResult) {
+            currentSession.mValidationInfo.mHasReportedValidationResult = true;
+            long wifiNetworkValidationDurationMillis =
+                    currentSession.mValidationInfo.mLastValidationTimestamp
+                    - currentSession.mValidationInfo.mL3ConnectedStateTimestamp;
+            // Write metrics to statsd
+            WifiStatsLog.write(
+                    WifiStatsLog.WIFI_NETWORK_VALIDATION_REPORT,
+                    status,
+                    wifiNetworkValidationDurationMillis,
+                    currentSession.mValidationInfo.mValidationCount,
+                    currentSession.mValidationInfo.mCaptivePortalDetected);
         }
     }
 
@@ -2039,7 +2098,6 @@ public class WifiMetrics {
                     mNetworkSelectorExperimentId;
             currentConnectionEvent.updateFromWifiConfiguration(config);
             currentConnectionEvent.mIsOobPseudonymEnabled = isOobPseudonymEnabled;
-            currentConnectionEvent.mConfigBssid = "any";
             currentConnectionEvent.mWifiState = mWifiState;
             currentConnectionEvent.mScreenOn = mScreenOn;
             currentConnectionEvent.mConnectionEvent.isFirstConnectionAfterBoot =
@@ -2147,11 +2205,12 @@ public class WifiMetrics {
                 int nominator = currentConnectionEvent.mConnectionEvent.connectionNominator;
                 int trigger = WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__UNKNOWN;
 
+                SessionData previousSession = mPreviousConnectionSessionPerIface.get(ifaceName);
                 if (nominator == WifiMetricsProto.ConnectionEvent.NOMINATOR_MANUAL) {
                     trigger = WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__MANUAL;
-                } else if (mPreviousSession == null) {
+                } else if (previousSession == null) {
                     trigger = WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__AUTOCONNECT_BOOT;
-                } else if (ssid != null && ssid.equals(mPreviousSession.mSsid)) {
+                } else if (ssid != null && ssid.equals(previousSession.mSsid)) {
                     trigger = WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__RECONNECT_SAME_NETWORK;
                 } else if (nominator != WifiMetricsProto.ConnectionEvent.NOMINATOR_UNKNOWN) {
                     trigger = WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__AUTOCONNECT_CONFIGURED_NETWORK;
@@ -2314,10 +2373,11 @@ public class WifiMetrics {
                                 - currentConnectionEvent.mConnectionEvent.startTimeSinceBootMillis);
 
                 if (connectionSucceeded) {
-                    mCurrentSession = new SessionData(currentConnectionEvent,
+                    SessionData currentSession = new SessionData(currentConnectionEvent,
                             currentConnectionEvent.mConfigSsid,
                             mClock.getElapsedSinceBootMillis(),
                             band, currentConnectionEvent.mAuthType);
+                    mCurrentConnectionSessionPerIface.put(ifaceName, currentSession);
                     if (currentConnectionEvent.mRole == WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_PRIMARY) {
                         WifiStatsLog.write(WifiStatsLog.WIFI_CONNECTION_STATE_CHANGED,
                                 true, band, currentConnectionEvent.mAuthType);
@@ -2336,10 +2396,15 @@ public class WifiMetrics {
                 // Write metrics to statsd
                 int wwFailureCode = getConnectionResultFailureCode(level2FailureCode,
                         level2FailureReason);
-                int timeSinceConnectedSeconds = (int) ((mPreviousSession != null
+                SessionData previousSession = mPreviousConnectionSessionPerIface.get(ifaceName);
+                int timeSinceConnectedSeconds = (int) ((previousSession != null
                         ? (mClock.getElapsedSinceBootMillis()
-                                - mPreviousSession.mSessionEndTimeMillis) :
+                                - previousSession.mSessionEndTimeMillis) :
                         mClock.getElapsedSinceBootMillis()) / 1000);
+                int lastDisconnectReason = (previousSession != null
+                        ? previousSession.mDisconnectReason :
+                        WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__UNKNOWN);
+
                 WifiStatsLog.write(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED,
                         connectionSucceeded,
                         wwFailureCode, currentConnectionEvent.mConnectionEvent.signalStrength,
@@ -2359,7 +2424,8 @@ public class WifiMetrics {
                         currentConnectionEvent.mUid,
                         frequency,
                         currentConnectionEvent.mL2ConnectingDuration,
-                        currentConnectionEvent.mL3ConnectingDuration);
+                        currentConnectionEvent.mL3ConnectingDuration,
+                        lastDisconnectReason);
 
                 if (connectionSucceeded) {
                     reportRouterCapabilities(currentConnectionEvent.mRouterFingerPrint);
@@ -2802,42 +2868,46 @@ public class WifiMetrics {
     public void reportNetworkDisconnect(String ifaceName, int disconnectReason, int rssi,
             int linkSpeed, long lastRssiUpdateMillis) {
         synchronized (mLock) {
-            if (!isPrimary(ifaceName)) {
-                return;
-            }
-            if (mCurrentSession != null) {
-                if (mCurrentSession.mConnectionEvent.mRole == WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_PRIMARY) {
+            SessionData currentSession = mCurrentConnectionSessionPerIface.get(ifaceName);
+            if (currentSession != null) {
+                if (currentSession.mConnectionEvent.mRole == WifiStatsLog
+                        .WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_PRIMARY) {
                     WifiStatsLog.write(WifiStatsLog.WIFI_CONNECTION_STATE_CHANGED,
                             false,
-                            mCurrentSession.mBand,
-                            mCurrentSession.mAuthType);
+                            currentSession.mBand,
+                            currentSession.mAuthType);
                 }
-                mCurrentSession.mSessionEndTimeMillis = mClock.getElapsedSinceBootMillis();
-                int durationSeconds = (int) (mCurrentSession.mSessionEndTimeMillis
-                        - mCurrentSession.mSessionStartTimeMillis) / 1000;
-                int connectedSinceLastRoamSeconds = (int) (mCurrentSession.mSessionEndTimeMillis
-                        - mCurrentSession.mLastRoamCompleteMillis) / 1000;
+                currentSession.mSessionEndTimeMillis = mClock.getElapsedSinceBootMillis();
+                int durationSeconds = (int) (currentSession.mSessionEndTimeMillis
+                        - currentSession.mSessionStartTimeMillis) / 1000;
+                int connectedSinceLastRoamSeconds = (int) (currentSession.mSessionEndTimeMillis
+                        - currentSession.mLastRoamCompleteMillis) / 1000;
                 int timeSinceLastRssiUpdateSeconds = (int) (mClock.getElapsedSinceBootMillis()
                         - lastRssiUpdateMillis) / 1000;
+                currentSession.mDisconnectReason = disconnectReason;
 
                 WifiStatsLog.write(WifiStatsLog.WIFI_DISCONNECT_REPORTED,
                         durationSeconds,
                         disconnectReason,
-                        mCurrentSession.mBand,
-                        mCurrentSession.mAuthType,
+                        currentSession.mBand,
+                        currentSession.mAuthType,
                         rssi,
                         linkSpeed,
                         timeSinceLastRssiUpdateSeconds,
                         connectedSinceLastRoamSeconds,
-                        mCurrentSession.mConnectionEvent.mRole,
-                        toMetricEapType(mCurrentSession.mConnectionEvent.mEapType),
-                        toMetricPhase2Method(mCurrentSession.mConnectionEvent.mPhase2Method),
-                        mCurrentSession.mConnectionEvent.mPasspointRoamingType,
-                        mCurrentSession.mConnectionEvent.mCarrierId,
-                        mCurrentSession.mConnectionEvent.mUid);
-
-                mPreviousSession = mCurrentSession;
-                mCurrentSession = null;
+                        currentSession.mConnectionEvent.mRole,
+                        toMetricEapType(currentSession.mConnectionEvent.mEapType),
+                        toMetricPhase2Method(currentSession.mConnectionEvent.mPhase2Method),
+                        currentSession.mConnectionEvent.mPasspointRoamingType,
+                        currentSession.mConnectionEvent.mCarrierId,
+                        currentSession.mConnectionEvent.mUid);
+                /* Log validation never succeed */
+                WifiValidationInfo validationInfo = currentSession.mValidationInfo;
+                if (validationInfo != null && validationInfo.mValidationCount > 0) {
+                    reportWifiValidationResult(ifaceName, validationInfo.mStatus);
+                }
+                mPreviousConnectionSessionPerIface.put(ifaceName, currentSession);
+                mCurrentConnectionSessionPerIface.remove(ifaceName);
             }
         }
     }
@@ -2874,9 +2944,9 @@ public class WifiMetrics {
      * @param enabledByWifiWake Whether Wi-Fi was enabled by Wi-Fi Wake
      */
     public void reportWifiStateChanged(boolean wifiState, boolean wifiWakeState,
-            boolean enabledByWifiWake) {
+            boolean enabledByWifiWake, int uid) {
         WifiStatsLog.write(WifiStatsLog.WIFI_STATE_CHANGED, wifiState, wifiWakeState,
-                enabledByWifiWake);
+                enabledByWifiWake, uid);
     }
 
     private int getConnectionResultFailureCode(int level2FailureCode, int level2FailureReason) {
@@ -6727,6 +6797,8 @@ public class WifiMetrics {
                 return "DISCONNECT_UNWANTED";
             case StaEvent.DISCONNECT_ROAM_WATCHDOG_TIMER:
                 return "DISCONNECT_ROAM_WATCHDOG_TIMER";
+            case StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER:
+                return "DISCONNECT_CONNECT_WATCHDOG_TIMER";
             case StaEvent.DISCONNECT_P2P_DISCONNECT_WIFI_REQUEST:
                 return "DISCONNECT_P2P_DISCONNECT_WIFI_REQUEST";
             case StaEvent.DISCONNECT_RESET_SIM_NETWORKS:
diff --git a/service/java/com/android/server/wifi/WifiMulticastLockManager.java b/service/java/com/android/server/wifi/WifiMulticastLockManager.java
index 598bf5716d..6b8179beff 100644
--- a/service/java/com/android/server/wifi/WifiMulticastLockManager.java
+++ b/service/java/com/android/server/wifi/WifiMulticastLockManager.java
@@ -60,6 +60,7 @@ public class WifiMulticastLockManager {
     private final Clock mClock;
     private final WifiMetrics mWifiMetrics;
     private final WifiPermissionsUtil mWifiPermissionsUtil;
+    private ConcreteClientModeManager mPrimaryClientModeManager;
 
     /** Delegate for handling state change events for multicast filtering. */
     public interface FilterController {
@@ -243,9 +244,11 @@ public class WifiMulticastLockManager {
                     mWifiMetrics.addMulticastLockManagerActiveSession(
                             mClock.getElapsedSinceBootMillis() - mFilterDisableSessionStartTime);
                 }
-                mActiveModeWarden.getPrimaryClientModeManager()
-                        .getMcastLockManagerFilterController()
-                        .startFilteringMulticastPackets();
+                if (mPrimaryClientModeManager != null) {
+                    mPrimaryClientModeManager
+                            .getMcastLockManagerFilterController()
+                            .startFilteringMulticastPackets();
+                }
                 mIsFilterDisableSessionActive = false;
             }
         }
@@ -258,9 +261,11 @@ public class WifiMulticastLockManager {
                 // since we're about to disable multicast packet filtering
                 mFilterDisableSessionStartTime = mClock.getElapsedSinceBootMillis();
             }
-            mActiveModeWarden.getPrimaryClientModeManager()
-                    .getMcastLockManagerFilterController()
-                    .stopFilteringMulticastPackets();
+            if (mPrimaryClientModeManager != null) {
+                mPrimaryClientModeManager
+                        .getMcastLockManagerFilterController()
+                        .stopFilteringMulticastPackets();
+            }
             mIsFilterDisableSessionActive = true;
         }
     }
@@ -380,6 +385,7 @@ public class WifiMulticastLockManager {
                 newPrimaryClientModeManager.getMcastLockManagerFilterController()
                         .stopFilteringMulticastPackets();
             }
+            mPrimaryClientModeManager = newPrimaryClientModeManager;
         }
     }
 }
diff --git a/service/java/com/android/server/wifi/WifiNative.java b/service/java/com/android/server/wifi/WifiNative.java
index 3694dfd0a1..a71f7f4786 100644
--- a/service/java/com/android/server/wifi/WifiNative.java
+++ b/service/java/com/android/server/wifi/WifiNative.java
@@ -268,6 +268,7 @@ public class WifiNative {
         mHostapdHal.enableVerboseLogging(verboseEnabled, halVerboseEnabled);
         mWifiVendorHal.enableVerboseLogging(verboseEnabled, halVerboseEnabled);
         mIfaceMgr.enableVerboseLogging(verboseEnabled);
+        mMainlineSupplicant.enableVerboseLogging(verboseEnabled, halVerboseEnabled);
     }
 
     /**
@@ -4680,6 +4681,7 @@ public class WifiNative {
         pw.println("mIsLocationModeEnabled: " + mIsLocationModeEnabled);
         pw.println("mLastLocationModeEnabledTimeMs: " + mLastLocationModeEnabledTimeMs);
         mHostapdHal.dump(pw);
+        mMainlineSupplicant.dump(pw);
     }
 
     //---------------------------------------------------------------------------------
diff --git a/service/java/com/android/server/wifi/WifiNetworkSelector.java b/service/java/com/android/server/wifi/WifiNetworkSelector.java
index f1ba972ddd..4b2610b9a4 100644
--- a/service/java/com/android/server/wifi/WifiNetworkSelector.java
+++ b/service/java/com/android/server/wifi/WifiNetworkSelector.java
@@ -104,6 +104,7 @@ public class WifiNetworkSelector {
      * Experiment ID for the legacy scorer.
      */
     public static final int LEGACY_CANDIDATE_SCORER_EXP_ID = 0;
+    public static final int MINIMUM_CONNECT_CHOICE_RSSI = -70;
 
     private final Context mContext;
     private final WifiConfigManager mWifiConfigManager;
@@ -828,7 +829,8 @@ public class WifiNetworkSelector {
 
         while (tempConfig.getNetworkSelectionStatus().getConnectChoice() != null) {
             String key = tempConfig.getNetworkSelectionStatus().getConnectChoice();
-            int userSelectedRssi = tempConfig.getNetworkSelectionStatus().getConnectChoiceRssi();
+            int userSelectedRssi = Math.max(MINIMUM_CONNECT_CHOICE_RSSI,
+                    tempConfig.getNetworkSelectionStatus().getConnectChoiceRssi());
             tempConfig = mWifiConfigManager.getConfiguredNetwork(key);
 
             if (tempConfig != null) {
diff --git a/service/java/com/android/server/wifi/WifiNetworkSuggestionsManager.java b/service/java/com/android/server/wifi/WifiNetworkSuggestionsManager.java
index be384213a3..6a65930d01 100644
--- a/service/java/com/android/server/wifi/WifiNetworkSuggestionsManager.java
+++ b/service/java/com/android/server/wifi/WifiNetworkSuggestionsManager.java
@@ -175,6 +175,7 @@ public class WifiNetworkSuggestionsManager {
     private final Clock mClock;
     // Keep order of network connection.
     private final LruConnectionTracker mLruConnectionTracker;
+    private final BuildProperties mBuildProperties;
 
     private class OnNetworkUpdateListener implements
             WifiConfigManager.OnNetworkUpdateListener {
@@ -681,7 +682,7 @@ public class WifiNetworkSuggestionsManager {
         mWifiKeyStore = keyStore;
         mNotificationManager = mWifiInjector.getWifiNotificationManager();
         mClock = clock;
-
+        mBuildProperties = mWifiInjector.getBuildProperties();
         // register the data store for serializing/deserializing data.
         wifiConfigStore.registerStoreData(
                 wifiInjector.makeNetworkSuggestionStoreData(new NetworkSuggestionDataSource()));
@@ -1212,7 +1213,8 @@ public class WifiNetworkSuggestionsManager {
             // Not carrier merged.
             return true;
         }
-        if (!wns.wifiConfiguration.isEnterprise() && wns.passpointConfiguration == null) {
+        if (!wns.wifiConfiguration.isEnterprise() && wns.passpointConfiguration == null
+                && mBuildProperties.isUserBuild()) {
             // Carrier merged network must be a enterprise network.
             return false;
         }
@@ -1684,12 +1686,7 @@ public class WifiNetworkSuggestionsManager {
 
     private void sendUserApprovalDialog(@NonNull String packageName, int uid) {
         CharSequence appName = mFrameworkFacade.getAppName(mContext, packageName, uid);
-        mWifiInjector.getWifiDialogManager().createSimpleDialog(
-                mResources.getString(R.string.wifi_suggestion_title),
-                mResources.getString(R.string.wifi_suggestion_content, appName),
-                mResources.getString(R.string.wifi_suggestion_action_allow_app),
-                mResources.getString(R.string.wifi_suggestion_action_disallow_app),
-                null /* neutralButtonText */,
+        WifiDialogManager.SimpleDialogCallback callback =
                 new WifiDialogManager.SimpleDialogCallback() {
                     @Override
                     public void onPositiveButtonClicked() {
@@ -1711,8 +1708,17 @@ public class WifiNetworkSuggestionsManager {
                     public void onCancelled() {
                         handleUserDismissAction();
                     }
-                },
-                new WifiThreadRunner(mHandler)).launchDialog();
+                };
+        mWifiInjector.getWifiDialogManager().createSimpleDialogBuilder()
+                .setTitle(mResources.getString(R.string.wifi_suggestion_title))
+                .setMessage(mResources.getString(R.string.wifi_suggestion_content, appName))
+                .setPositiveButtonText(
+                        mResources.getString(R.string.wifi_suggestion_action_allow_app))
+                .setNegativeButtonText(
+                        mResources.getString(R.string.wifi_suggestion_action_disallow_app))
+                .setCallback(callback, new WifiThreadRunner(mHandler))
+                .build()
+                .launchDialog();
         mNotificationUpdateTime = mClock.getElapsedSinceBootMillis()
                 + NOTIFICATION_UPDATE_DELAY_MILLS;
         mIsLastUserApprovalUiDialog = true;
@@ -2830,6 +2836,10 @@ public class WifiNetworkSuggestionsManager {
         return mWifiCarrierInfoManager.areMergedCarrierWifiNetworksAllowed(subId);
     }
 
+    /**
+     * Tag to be used in dumpsys request
+     */
+    public static final String DUMP_ARG = "WifiNetworkSuggestionsManager";
     /**
      * Dump of {@link WifiNetworkSuggestionsManager}.
      */
@@ -2845,8 +2855,9 @@ public class WifiNetworkSuggestionsManager {
                     + (appInfo.carrierId != TelephonyManager.UNKNOWN_CARRIER_ID));
             for (ExtendedWifiNetworkSuggestion extNetworkSuggestion
                     : appInfo.extNetworkSuggestions.values()) {
-                pw.println("Network: " + extNetworkSuggestion);
+                pw.println(extNetworkSuggestion);
             }
+            pw.println();
         }
         pw.println("WifiNetworkSuggestionsManager - Networks End ----");
     }
diff --git a/service/java/com/android/server/wifi/WifiServiceImpl.java b/service/java/com/android/server/wifi/WifiServiceImpl.java
index 9055d857be..3fd769c26e 100644
--- a/service/java/com/android/server/wifi/WifiServiceImpl.java
+++ b/service/java/com/android/server/wifi/WifiServiceImpl.java
@@ -125,6 +125,7 @@ import android.net.wifi.IOnWifiActivityEnergyInfoListener;
 import android.net.wifi.IOnWifiDriverCountryCodeChangedListener;
 import android.net.wifi.IOnWifiUsabilityStatsListener;
 import android.net.wifi.IPnoScanResultsCallback;
+import android.net.wifi.IPrivilegedConfiguredNetworksListener;
 import android.net.wifi.IScanResultsCallback;
 import android.net.wifi.ISoftApCallback;
 import android.net.wifi.IStringListener;
@@ -1024,7 +1025,6 @@ public class WifiServiceImpl extends IWifiManager.Stub {
             intentFilter.addAction(BluetoothAdapter.ACTION_CONNECTION_STATE_CHANGED);
             intentFilter.addAction(BluetoothAdapter.ACTION_STATE_CHANGED);
             intentFilter.addAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED);
-            intentFilter.addAction(Intent.ACTION_SHUTDOWN);
             mContext.registerReceiver(
                     new BroadcastReceiver() {
                         @Override
@@ -1064,14 +1064,21 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                             } else if (PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED
                                     .equals(action)) {
                                 handleIdleModeChanged();
-                            } else if (Intent.ACTION_SHUTDOWN.equals(action)) {
-                                handleShutDown();
                             }
                         }
                     },
                     intentFilter,
                     null,
                     new Handler(mWifiHandlerThread.getLooper()));
+            mContext.registerReceiver(
+                    new BroadcastReceiver() {
+                        @Override
+                        public void onReceive(Context context, Intent intent) {
+                            if (Intent.ACTION_SHUTDOWN.equals(intent.getAction())) {
+                                handleShutDown();
+                            }
+                        }},
+                    new IntentFilter(Intent.ACTION_SHUTDOWN));
             mMemoryStoreImpl.start();
             mPasspointManager.initializeProvisioner(
                     mWifiInjector.getPasspointProvisionerHandlerThread().getLooper());
@@ -1284,6 +1291,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         if (mVerboseLoggingEnabled) {
             Log.v(TAG, "handleShutDown");
         }
+        mWifiConfigManager.writeDataToStorage();
         // Direct call to notify ActiveModeWarden as soon as possible with the assumption that
         // notifyShuttingDown() doesn't have codes that may cause concurrentModificationException,
         // e.g., access to a collection.
@@ -1292,9 +1300,10 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         // There is no explicit disconnection event in clientModeImpl during shutdown.
         // Call resetConnectionState() so that connection duration is calculated
         // before memory store write triggered by mMemoryStoreImpl.stop().
-        mWifiScoreCard.resetAllConnectionStates();
-        mMemoryStoreImpl.stop();
-        mWifiConfigManager.writeDataToStorage();
+        mWifiThreadRunner.post(() -> {
+            mWifiScoreCard.resetAllConnectionStates();
+            mMemoryStoreImpl.stop();
+        }, TAG + "#handleShutDown");
         mWifiNetworkSuggestionsManager.handleShutDown();
     }
 
@@ -1308,6 +1317,11 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                 == PackageManager.PERMISSION_GRANTED;
     }
 
+    private boolean checkNetworkCarrierProvisioningPermission(int pid, int uid) {
+        return mContext.checkPermission(android.Manifest.permission.NETWORK_CARRIER_PROVISIONING,
+                pid, uid) == PackageManager.PERMISSION_GRANTED;
+    }
+
     private boolean checkMainlineNetworkStackPermission(int pid, int uid) {
         return mContext.checkPermission(NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK, pid, uid)
                 == PackageManager.PERMISSION_GRANTED;
@@ -1350,6 +1364,16 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                 || checkNetworkSetupWizardPermission(pid, uid);
     }
 
+    /**
+     * Helper method to check if the entity initiating the binder call has setup wizard, settings or
+     * carrier provisioning permissions.
+     */
+    private boolean isSettingsOrSuwOrCarrierProvisioner(int pid, int uid) {
+        return checkNetworkSettingsPermission(pid, uid)
+                || checkNetworkSetupWizardPermission(pid, uid)
+                || checkNetworkCarrierProvisioningPermission(pid, uid);
+    }
+
     /** Helper method to check if the entity initiating the binder call is a DO/PO app. */
     private boolean isDeviceOrProfileOwner(int uid, String packageName) {
         return mWifiPermissionsUtil.isDeviceOwner(uid, packageName)
@@ -1680,7 +1704,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         }
         mWifiMetrics.incrementNumWifiToggles(isPrivileged, enable);
         mWifiMetrics.reportWifiStateChanged(enable, mWifiInjector.getWakeupController().isUsable(),
-                false);
+                false, callingUid);
         mActiveModeWarden.wifiToggled(new WorkSource(callingUid, packageName));
         mLastCallerInfoManager.put(WifiManager.API_WIFI_ENABLED, Process.myTid(),
                 callingUid, callingPid, packageName, enable);
@@ -1730,14 +1754,15 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                     .c(uid).flush();
             return;
         }
-        WifiDialogManager.DialogHandle dialogHandle = mWifiDialogManager.createSimpleDialog(
-                res.getString(R.string.wifi_enable_request_dialog_title, appName),
-                res.getString(R.string.wifi_enable_request_dialog_message),
-                res.getString(R.string.wifi_enable_request_dialog_positive_button),
-                res.getString(R.string.wifi_enable_request_dialog_negative_button),
-                null /* neutralButtonText */,
-                dialogCallback,
-                mWifiThreadRunner);
+        WifiDialogManager.DialogHandle dialogHandle = mWifiDialogManager.createSimpleDialogBuilder()
+                .setTitle(res.getString(R.string.wifi_enable_request_dialog_title, appName))
+                .setMessage(res.getString(R.string.wifi_enable_request_dialog_message))
+                .setPositiveButtonText(
+                        res.getString(R.string.wifi_enable_request_dialog_positive_button))
+                .setNegativeButtonText(
+                        res.getString(R.string.wifi_enable_request_dialog_negative_button))
+                .setCallback(dialogCallback, mWifiThreadRunner)
+                .build();
         mWifiEnableRequestDialogHandles.put(uid, dialogHandle);
         dialogHandle.launchDialog();
         mLog.info("setWifiEnabled dialog launched for package=% uid=%").c(packageName)
@@ -2005,8 +2030,11 @@ public class WifiServiceImpl extends IWifiManager.Stub {
      */
     @Override
     public boolean validateSoftApConfiguration(SoftApConfiguration config) {
+        int pid = Binder.getCallingPid();
         int uid = Binder.getCallingUid();
-        boolean privileged = isSettingsOrSuw(Binder.getCallingPid(), uid);
+        boolean privileged = isSettingsOrSuw(pid, uid)
+                || checkNetworkStackPermission(pid, uid)
+                || checkMainlineNetworkStackPermission(pid, uid);
         return WifiApConfigStore.validateApWifiConfiguration(
                 config, privileged, mContext, mWifiNative);
     }
@@ -2202,16 +2230,13 @@ public class WifiServiceImpl extends IWifiManager.Stub {
     private boolean startSoftApInternal(SoftApModeConfiguration apConfig, WorkSource requestorWs,
             @Nullable ISoftApCallback callback) {
         int uid = Binder.getCallingUid();
-        boolean privileged = isSettingsOrSuw(Binder.getCallingPid(), uid);
         mLog.trace("startSoftApInternal uid=% mode=%")
                 .c(uid).c(apConfig.getTargetMode()).flush();
 
         // null wifiConfig is a meaningful input for CMD_SET_AP; it means to use the persistent
         // AP config.
         SoftApConfiguration softApConfig = apConfig.getSoftApConfiguration();
-        if (softApConfig != null
-                && (!WifiApConfigStore.validateApWifiConfiguration(
-                    softApConfig, privileged, mContext, mWifiNative))) {
+        if (softApConfig != null && !validateSoftApConfiguration(softApConfig)) {
             Log.e(TAG, "Invalid SoftApConfiguration");
             if (callback != null) {
                 try {
@@ -2517,19 +2542,52 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         }
 
         public void notifyNewCountryCodeChangePending(@NonNull String countryCode) {
-            // If country code not changed, no need to update.
-            if (mSoftApCapability != null && !TextUtils.equals(mSoftApCapability.getCountryCode(),
+            if (mSoftApCapability == null) return;
+
+            SoftApCapability newSoftApCapability = new SoftApCapability(
+                    mSoftApCapability);
+
+            // If the country code changed back to the original country code, restore the
+            // original channels.
+            if (TextUtils.equals(
+                    mSettingsConfigStore.get(WifiSettingsConfigStore.WIFI_SOFT_AP_COUNTRY_CODE),
                     countryCode)) {
-                // Country code changed when we can't update channels from HAL, invalidate the soft
-                // ap capability for supported channels.
-                SoftApCapability newSoftApCapability = new SoftApCapability(
-                        mSoftApCapability);
+                Log.i(TAG, "BaseSoftApTracker: Using stored SoftAP channels for SoftApCapability"
+                        + " since pending country code matches.");
+                SparseArray<List<Integer>> bandChannels = new SparseArray<>();
+                for (int b : SoftApConfiguration.BAND_TYPES) {
+                    bandChannels.put(b, new ArrayList<>());
+                }
+
+                for (int freq : getStoredSoftApAvailableFreqs()) {
+                    int band = ApConfigUtil.convertFrequencyToBand(freq);
+                    if (!bandChannels.contains(band)) continue;
+
+                    int channel = ScanResult.convertFrequencyMhzToChannelIfSupported(freq);
+                    if (channel == ScanResult.UNSPECIFIED) continue;
+
+                    bandChannels.get(band).add(channel);
+                }
+
+                for (int b : SoftApConfiguration.BAND_TYPES) {
+                    List<Integer> chanList = bandChannels.get(b);
+                    int[] chanArray = new int[chanList.size()];
+                    for (int i = 0; i < chanList.size(); i++) {
+                        chanArray[i] = chanList.get(i);
+                    }
+                    newSoftApCapability.setSupportedChannelList(b, chanArray);
+                }
+            } else if (!TextUtils.equals(mSoftApCapability.getCountryCode(), countryCode)) {
+                Log.i(TAG, "BaseSoftApTracker: Invalidating SoftApCapability channels due to"
+                        + " pending country code change.");
+                // Invalidate the current available channels if a country code is pending.
                 for (int b : SoftApConfiguration.BAND_TYPES) {
                     newSoftApCapability.setSupportedChannelList(b, new int[0]);
                 }
-                // Notify the capability change
-                onCapabilityChanged(newSoftApCapability);
             }
+
+            // Notify the capability change
+            onCapabilityChanged(newSoftApCapability);
         }
 
         public SoftApCapability getSoftApCapability() {
@@ -4580,18 +4638,26 @@ public class WifiServiceImpl extends IWifiManager.Stub {
             mLog.info("enableNetwork not allowed for uid=%").c(callingUid).flush();
             return false;
         }
-        WifiConfiguration configuration = mWifiConfigManager.getConfiguredNetwork(netId);
-        if (mWifiPermissionsUtil.isAdminRestrictedNetwork(configuration)) {
-            mLog.info("enableNetwork not allowed for admin restricted network Id=%")
-                    .c(netId).flush();
-            return false;
-        }
-        if (mWifiGlobals.isDeprecatedSecurityTypeNetwork(configuration)) {
-            mLog.info("enableNetwork not allowed for deprecated security type network Id=%")
-                    .c(netId).flush();
+        Boolean canEnableNetwork = mWifiThreadRunner.call(
+                () -> {
+                    WifiConfiguration configuration =
+                            mWifiConfigManager.getConfiguredNetwork(netId);
+                    if (mWifiPermissionsUtil.isAdminRestrictedNetwork(configuration)) {
+                        mLog.info("enableNetwork not allowed for admin restricted"
+                                        + " network Id=%").c(netId).flush();
+                        return false;
+                    }
+                    if (mWifiGlobals.isDeprecatedSecurityTypeNetwork(configuration)) {
+                        mLog.info("enableNetwork not allowed for deprecated security type"
+                                        + " network Id=%")
+                                .c(netId).flush();
+                        return false;
+                    }
+                    return true;
+                }, false, TAG + "#enableNetwork");
+        if (canEnableNetwork == null || !canEnableNetwork) {
             return false;
         }
-
         mLastCallerInfoManager.put(WifiManager.API_ENABLE_NETWORK, Process.myTid(),
                 callingUid, Binder.getCallingPid(), packageName, disableOthers);
         // TODO b/33807876 Log netId
@@ -6009,6 +6075,12 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                 WifiScoreCard wifiScoreCard = mWifiInjector.getWifiScoreCard();
                 String networkListBase64 = wifiScoreCard.getNetworkListBase64(true);
                 pw.println(networkListBase64);
+            } else if (WifiNetworkSuggestionsManager.DUMP_ARG.equals(arg0)) {
+                mWifiNetworkSuggestionsManager.dump(fd, pw, args);
+            } else if (WifiCarrierInfoManager.DUMP_ARG.equals(arg0)) {
+                mWifiCarrierInfoManager.dump(fd, pw, args);
+            } else if (PasspointManager.DUMP_ARG.equals(arg0)) {
+                mPasspointManager.dump(pw, true);
             } else {
                 pw.println("Verbose logging is " + (mVerboseLoggingEnabled ? "on" : "off"));
                 pw.println("mVerboseLoggingLevel " + mVerboseLoggingLevel);
@@ -6063,7 +6135,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
                 pw.println();
                 pw.println("WifiApConfigStore config: " + mWifiApConfigStore.getApConfiguration());
                 pw.println();
-                mPasspointManager.dump(pw);
+                mPasspointManager.dump(pw, false);
                 mWifiInjector.getPasspointNetworkNominateHelper().dump(pw);
                 pw.println();
                 mWifiInjector.getWifiDiagnostics().captureBugReportData(
@@ -6258,7 +6330,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         if (WifiManager.VERBOSE_LOGGING_LEVEL_ENABLED_SHOW_KEY == mVerboseLoggingLevel) {
             mWifiThreadRunner.postDelayed(mAutoDisableShowKeyVerboseLoggingModeRunnable,
                     AUTO_DISABLE_SHOW_KEY_COUNTDOWN_MILLIS,
-                    TAG + "#AutoDisableShowKeyVerboseLoggingMode");
+                    TAG + "#AutoDisableShowKeyVerboseLoggingMode", null);
         }
         updateVerboseLoggingEnabled();
         final boolean halVerboseEnabled =
@@ -7867,7 +7939,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
     @Override
     public void setCarrierNetworkOffloadEnabled(int subscriptionId, boolean merged,
             boolean enabled) {
-        if (!isSettingsOrSuw(Binder.getCallingPid(), Binder.getCallingUid())) {
+        if (!isSettingsOrSuwOrCarrierProvisioner(Binder.getCallingPid(), Binder.getCallingUid())) {
             throw new SecurityException(TAG + ": Permission denied");
         }
         if (mVerboseLoggingEnabled) {
@@ -8037,6 +8109,20 @@ public class WifiServiceImpl extends IWifiManager.Stub {
 
     private List<WifiAvailableChannel> getStoredSoftApAvailableChannels(
             @WifiScanner.WifiBand int band) {
+        List<WifiAvailableChannel> channels = new ArrayList<>();
+        for (int freq : getStoredSoftApAvailableFreqs()) {
+            if ((band & ScanResult.toBand(freq)) == 0) {
+                continue;
+            }
+            // TODO b/340956906: Save and retrieve channel width in config store along with
+            //  frequency.
+            channels.add(new WifiAvailableChannel(freq, WifiAvailableChannel.OP_MODE_SAP,
+                    ScanResult.CHANNEL_WIDTH_20MHZ));
+        }
+        return channels;
+    }
+
+    private List<Integer> getStoredSoftApAvailableFreqs() {
         List<Integer> freqs = new ArrayList<>();
         try {
             JSONArray json =
@@ -8049,17 +8135,7 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         } catch (JSONException e) {
             Log.i(TAG, "Failed to read stored JSON for available Soft AP channels: " + e);
         }
-        List<WifiAvailableChannel> channels = new ArrayList<>();
-        for (int freq : freqs) {
-            if ((band & ScanResult.toBand(freq)) == 0) {
-                continue;
-            }
-            // TODO b/340956906: Save and retrieve channel width in config store along with
-            //  frequency.
-            channels.add(new WifiAvailableChannel(freq, WifiAvailableChannel.OP_MODE_SAP,
-                    ScanResult.CHANNEL_WIDTH_20MHZ));
-        }
-        return channels;
+        return freqs;
     }
 
     /**
@@ -9460,4 +9536,41 @@ public class WifiServiceImpl extends IWifiManager.Stub {
         }
         return mWifiNative.isUsdPublisherSupported();
     }
+
+    /**
+     * See {@link WifiManager#queryPrivilegedConfiguredNetworks()}
+     *
+     * @param listener listener to get the list of configured networks with real preSharedKey
+     * @param extras - Bundle of extra information
+     */
+    @RequiresApi(Build.VERSION_CODES.S)
+    @Override
+    public void queryPrivilegedConfiguredNetworks(
+            @NonNull IPrivilegedConfiguredNetworksListener listener, Bundle extras) {
+        if (!SdkLevel.isAtLeastS()) {
+            throw new UnsupportedOperationException();
+        }
+        Objects.requireNonNull(listener, "listener cannot be null");
+        Objects.requireNonNull(extras, "extras cannot be null");
+        enforceReadCredentialPermission();
+        mWifiPermissionsUtil.enforceNearbyDevicesPermission(
+                extras.getParcelable(WifiManager.EXTRA_PARAM_KEY_ATTRIBUTION_SOURCE),
+                false, TAG + " queryPrivilegedConfiguredNetworks");
+        mWifiThreadRunner.post(() -> {
+            try {
+                List<WifiConfiguration> configs =
+                        mWifiConfigManager.getConfiguredNetworksWithPasswords();
+                if (configs != null) {
+                    listener.onResult(
+                            new ParceledListSlice<>(
+                                    WifiConfigurationUtil.convertMultiTypeConfigsToLegacyConfigs(
+                                            configs, false)), "");
+                } else {
+                    listener.onResult(null, "get null when querying networks");
+                }
+            } catch (RemoteException e) {
+                Log.e(TAG, e.getMessage(), e);
+            }
+        }, TAG + "#queryPrivilegedConfiguredNetworks");
+    }
 }
diff --git a/service/java/com/android/server/wifi/WifiShellCommand.java b/service/java/com/android/server/wifi/WifiShellCommand.java
index bd49b590ab..ab8840892f 100644
--- a/service/java/com/android/server/wifi/WifiShellCommand.java
+++ b/service/java/com/android/server/wifi/WifiShellCommand.java
@@ -21,6 +21,7 @@ import static android.net.NetworkCapabilities.NET_CAPABILITY_OEM_PAID;
 import static android.net.NetworkCapabilities.NET_CAPABILITY_OEM_PRIVATE;
 import static android.net.NetworkCapabilities.NET_CAPABILITY_TRUSTED;
 import static android.net.NetworkCapabilities.TRANSPORT_WIFI;
+import static android.net.TetheringManager.TETHERING_WIFI;
 import static android.net.wifi.WifiConfiguration.METERED_OVERRIDE_METERED;
 import static android.net.wifi.WifiManager.ACTION_REMOVE_SUGGESTION_DISCONNECT;
 import static android.net.wifi.WifiManager.ACTION_REMOVE_SUGGESTION_LINGER;
@@ -32,6 +33,10 @@ import static android.net.wifi.WifiManager.VERBOSE_LOGGING_LEVEL_DISABLED;
 import static android.net.wifi.WifiManager.VERBOSE_LOGGING_LEVEL_WIFI_AWARE_ENABLED_ONLY;
 import static android.net.wifi.WifiManager.WIFI_STATE_DISABLED;
 import static android.net.wifi.WifiManager.WIFI_STATE_ENABLED;
+import static android.net.wifi.aware.Characteristics.WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_128;
+import static android.net.wifi.aware.Characteristics.WIFI_AWARE_CIPHER_SUITE_NCS_SK_128;
+import static android.net.wifi.aware.PublishConfig.PUBLISH_TYPE_SOLICITED;
+import static android.net.wifi.aware.SubscribeConfig.SUBSCRIBE_TYPE_ACTIVE;
 
 import static com.android.server.wifi.HalDeviceManager.HDM_CREATE_IFACE_AP;
 import static com.android.server.wifi.HalDeviceManager.HDM_CREATE_IFACE_AP_BRIDGE;
@@ -52,6 +57,9 @@ import android.net.MacAddress;
 import android.net.Network;
 import android.net.NetworkCapabilities;
 import android.net.NetworkRequest;
+import android.net.TetheringManager;
+import android.net.TetheringManager.StartTetheringCallback;
+import android.net.TetheringManager.TetheringRequest;
 import android.net.wifi.IActionListener;
 import android.net.wifi.IDppCallback;
 import android.net.wifi.ILastCallerListener;
@@ -78,6 +86,19 @@ import android.net.wifi.WifiNetworkSpecifier;
 import android.net.wifi.WifiNetworkSuggestion;
 import android.net.wifi.WifiScanner;
 import android.net.wifi.WifiSsid;
+import android.net.wifi.aware.AttachCallback;
+import android.net.wifi.aware.AwarePairingConfig;
+import android.net.wifi.aware.DiscoverySession;
+import android.net.wifi.aware.DiscoverySessionCallback;
+import android.net.wifi.aware.PeerHandle;
+import android.net.wifi.aware.PublishConfig;
+import android.net.wifi.aware.PublishDiscoverySession;
+import android.net.wifi.aware.SubscribeConfig;
+import android.net.wifi.aware.SubscribeDiscoverySession;
+import android.net.wifi.aware.WifiAwareDataPathSecurityConfig;
+import android.net.wifi.aware.WifiAwareManager;
+import android.net.wifi.aware.WifiAwareNetworkSpecifier;
+import android.net.wifi.aware.WifiAwareSession;
 import android.net.wifi.util.ScanResultUtil;
 import android.net.wifi.util.WifiResourceCache;
 import android.os.Binder;
@@ -108,6 +129,9 @@ import com.android.modules.utils.BasicShellCommandHandler;
 import com.android.modules.utils.ParceledListSlice;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.ClientMode.LinkProbeCallback;
+import com.android.server.wifi.WifiDialogManager.DialogHandle;
+import com.android.server.wifi.WifiDialogManager.SimpleDialogBuilder;
+import com.android.server.wifi.WifiDialogManager.SimpleDialogCallback;
 import com.android.server.wifi.coex.CoexManager;
 import com.android.server.wifi.coex.CoexUtils;
 import com.android.server.wifi.hal.WifiChip;
@@ -140,7 +164,7 @@ import java.util.stream.Collectors;
  *
  * To add new commands:
  * - onCommand: Add a case "<command>" execute. Return a 0
- *   if command executed successfully.
+ * if command executed successfully.
  * - onHelp: add a description string.
  *
  * Permissions: currently root permission is required for some commands. Others will
@@ -189,7 +213,8 @@ public class WifiShellCommand extends BasicShellCommandHandler {
             "force-overlay-config-value",
             "get-softap-supported-features",
             "get-wifi-supported-features",
-            "get-overlay-config-values"
+            "get-overlay-config-values",
+            "get-carrier-network-offload",
     };
 
     private static final Map<String, Pair<NetworkRequest, ConnectivityManager.NetworkCallback>>
@@ -212,6 +237,7 @@ public class WifiShellCommand extends BasicShellCommandHandler {
     private final SelfRecovery mSelfRecovery;
     private final WifiThreadRunner mWifiThreadRunner;
     private final WifiApConfigStore mWifiApConfigStore;
+    private final WifiAwareManager mWifiAwareManager;
     private int mSapState = WifiManager.WIFI_STATE_UNKNOWN;
     private final ScanRequestProxy mScanRequestProxy;
     private final @NonNull WifiDialogManager mWifiDialogManager;
@@ -230,6 +256,9 @@ public class WifiShellCommand extends BasicShellCommandHandler {
             WifiAvailableChannel.OP_MODE_WIFI_AWARE,
             WifiAvailableChannel.OP_MODE_TDLS,
     };
+    private static WifiAwareSession sWifiAwareSession;
+    private static PeerHandle sPeerHandle;
+    private static DiscoverySession sDiscoverySession;
 
     private class SoftApCallbackProxy extends ISoftApCallback.Stub {
         private final PrintWriter mPrintWriter;
@@ -477,6 +506,7 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         mWifiDiagnostics = wifiInjector.getWifiDiagnostics();
         mDeviceConfig = wifiInjector.getDeviceConfigFacade();
         mAfcManager = wifiInjector.getAfcManager();
+        mWifiAwareManager = context.getSystemService(WifiAwareManager.class);
     }
 
     private String getOpModeName(@WifiAvailableChannel.OpMode int mode) {
@@ -923,9 +953,35 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                     SoftApCallbackProxy softApCallback =
                             new SoftApCallbackProxy(pw, countDownLatch);
                     mWifiService.registerSoftApCallback(softApCallback);
-                    if (!mWifiService.startTetheredHotspot(config, SHELL_PACKAGE_NAME)) {
-                        pw.println("Soft AP failed to start. Please check config parameters");
+                    // Starting in B, a DHCP server will not be started for AP ifaces that weren't
+                    // requested by TetheringManager#startTethering.
+                    // TODO: This provides internet access on the AP iface if there is a suitable
+                    //       upstream available. This matches historical behavior, but consider
+                    //       starting the IpServer in local-only mode since the current clients of
+                    //       this command don't need to verify internet connection.
+                    if (SdkLevel.isAtLeastB()) {
+                        mContext.getSystemService(TetheringManager.class).startTethering(
+                                new TetheringRequest.Builder(TETHERING_WIFI)
+                                        .setSoftApConfiguration(config)
+                                        .build(),
+                                mContext.getMainExecutor(),
+                                new StartTetheringCallback() {
+                                    @Override
+                                    public void onTetheringStarted() {
+                                        Log.i(TAG, "Tethering started successfully");
+                                    }
+
+                                    @Override
+                                    public void onTetheringFailed(int errorCode) {
+                                        Log.i(TAG, "Tethering failed with error: " + errorCode);
+                                    }
+                                });
+                    } else {
+                        if (!mWifiService.startTetheredHotspot(config, SHELL_PACKAGE_NAME)) {
+                            pw.println("Soft AP failed to start. Please check config parameters");
+                        }
                     }
+
                     // Wait for softap to start and complete callback
                     countDownLatch.await(10000, TimeUnit.MILLISECONDS);
                     mWifiService.unregisterSoftApCallback(softApCallback);
@@ -1512,46 +1568,38 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                     return 0;
                 }
                 case "launch-dialog-simple":
-                    String title = null;
-                    String message = null;
-                    String messageUrl = null;
-                    int messageUrlStart = 0;
-                    int messageUrlEnd = 0;
-                    String positiveButtonText = null;
-                    String negativeButtonText = null;
-                    String neutralButtonText = null;
+                    SimpleDialogBuilder dialogBuilder =
+                            mWifiDialogManager.createSimpleDialogBuilder();
                     String dialogOption = getNextOption();
-                    boolean simpleTimeoutSpecified = false;
                     long simpleTimeoutMs = 15 * 1000;
-                    boolean useLegacy = false;
                     while (dialogOption != null) {
                         switch (dialogOption) {
                             case "-t":
-                                title = getNextArgRequired();
+                                dialogBuilder.setTitle(getNextArgRequired());
                                 break;
                             case "-m":
-                                message = getNextArgRequired();
+                                dialogBuilder.setMessage(getNextArgRequired());
                                 break;
                             case "-l":
-                                messageUrl = getNextArgRequired();
-                                messageUrlStart = Integer.valueOf(getNextArgRequired());
-                                messageUrlEnd = Integer.valueOf(getNextArgRequired());
+                                dialogBuilder.setMessageUrl(
+                                        getNextArgRequired() /* messageUrl */,
+                                        Integer.valueOf(getNextArgRequired()) /* messageUrlStart */,
+                                        Integer.valueOf(getNextArgRequired()) /* messageUrlEnd */);
+                                break;
+                            case "-i":
+                                dialogBuilder.setListItems(buildDialogList());
                                 break;
                             case "-y":
-                                positiveButtonText = getNextArgRequired();
+                                dialogBuilder.setPositiveButtonText(getNextArgRequired());
                                 break;
                             case "-n":
-                                negativeButtonText = getNextArgRequired();
+                                dialogBuilder.setNegativeButtonText(getNextArgRequired());
                                 break;
                             case "-x":
-                                neutralButtonText = getNextArgRequired();
+                                dialogBuilder.setNeutralButtonText(getNextArgRequired());
                                 break;
                             case "-c":
                                 simpleTimeoutMs = Integer.parseInt(getNextArgRequired());
-                                simpleTimeoutSpecified = true;
-                                break;
-                            case "-s":
-                                useLegacy = true;
                                 break;
                             default:
                                 pw.println("Ignoring unknown option " + dialogOption);
@@ -1560,8 +1608,8 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                         dialogOption = getNextOption();
                     }
                     ArrayBlockingQueue<String> simpleQueue = new ArrayBlockingQueue<>(1);
-                    WifiDialogManager.SimpleDialogCallback wifiEnableRequestCallback =
-                            new WifiDialogManager.SimpleDialogCallback() {
+                    SimpleDialogCallback dialogCallback =
+                            new SimpleDialogCallback() {
                                 @Override
                                 public void onPositiveButtonClicked() {
                                     simpleQueue.offer("Positive button was clicked.");
@@ -1582,32 +1630,8 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                                     simpleQueue.offer("Dialog was cancelled.");
                                 }
                             };
-                    WifiDialogManager.DialogHandle simpleDialogHandle;
-                    if (useLegacy) {
-                        simpleDialogHandle = mWifiDialogManager.createLegacySimpleDialogWithUrl(
-                                title,
-                                message,
-                                messageUrl,
-                                messageUrlStart,
-                                messageUrlEnd,
-                                positiveButtonText,
-                                negativeButtonText,
-                                neutralButtonText,
-                                wifiEnableRequestCallback,
-                                mWifiThreadRunner);
-                    } else {
-                        simpleDialogHandle = mWifiDialogManager.createSimpleDialogWithUrl(
-                                title,
-                                message,
-                                messageUrl,
-                                messageUrlStart,
-                                messageUrlEnd,
-                                positiveButtonText,
-                                negativeButtonText,
-                                neutralButtonText,
-                                wifiEnableRequestCallback,
-                                mWifiThreadRunner);
-                    }
+                    dialogBuilder.setCallback(dialogCallback, mWifiThreadRunner);
+                    DialogHandle simpleDialogHandle = dialogBuilder.build();
                     simpleDialogHandle.launchDialog();
                     pw.println("Launched dialog. Waiting up to " + simpleTimeoutMs + " ms for"
                             + " user response before dismissing...");
@@ -1620,6 +1644,95 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                         pw.println(simpleDialogResponse);
                     }
                     return 0;
+                case "launch-dialog-simple-legacy":
+                    String title = null;
+                    String message = null;
+                    String messageUrl = null;
+                    int messageUrlStart = 0;
+                    int messageUrlEnd = 0;
+                    String positiveButtonText = null;
+                    String negativeButtonText = null;
+                    String neutralButtonText = null;
+                    String legacyDialogOption = getNextOption();
+                    long legacyTimeoutMs = 15 * 1000;
+                    while (legacyDialogOption != null) {
+                        switch (legacyDialogOption) {
+                            case "-t":
+                                title = getNextArgRequired();
+                                break;
+                            case "-m":
+                                message = getNextArgRequired();
+                                break;
+                            case "-l":
+                                messageUrl = getNextArgRequired();
+                                messageUrlStart = Integer.valueOf(getNextArgRequired());
+                                messageUrlEnd = Integer.valueOf(getNextArgRequired());
+                                break;
+                            case "-y":
+                                positiveButtonText = getNextArgRequired();
+                                break;
+                            case "-n":
+                                negativeButtonText = getNextArgRequired();
+                                break;
+                            case "-x":
+                                neutralButtonText = getNextArgRequired();
+                                break;
+                            case "-c":
+                                legacyTimeoutMs = Integer.parseInt(getNextArgRequired());
+                                break;
+                            default:
+                                pw.println("Ignoring unknown option " + legacyDialogOption);
+                                break;
+                        }
+                        legacyDialogOption = getNextOption();
+                    }
+                    ArrayBlockingQueue<String> legacyDialogQueue = new ArrayBlockingQueue<>(1);
+                    SimpleDialogCallback wifiEnableRequestCallback =
+                            new SimpleDialogCallback() {
+                                @Override
+                                public void onPositiveButtonClicked() {
+                                    legacyDialogQueue.offer("Positive button was clicked.");
+                                }
+
+                                @Override
+                                public void onNegativeButtonClicked() {
+                                    legacyDialogQueue.offer("Negative button was clicked.");
+                                }
+
+                                @Override
+                                public void onNeutralButtonClicked() {
+                                    legacyDialogQueue.offer("Neutral button was clicked.");
+                                }
+
+                                @Override
+                                public void onCancelled() {
+                                    legacyDialogQueue.offer("Dialog was cancelled.");
+                                }
+                            };
+                    DialogHandle legacyDialogHandle =
+                            mWifiDialogManager.createLegacySimpleDialogWithUrl(
+                                    title,
+                                    message,
+                                    messageUrl,
+                                    messageUrlStart,
+                                    messageUrlEnd,
+                                    positiveButtonText,
+                                    negativeButtonText,
+                                    neutralButtonText,
+                                    wifiEnableRequestCallback,
+                                    mWifiThreadRunner);
+                    legacyDialogHandle.launchDialog();
+                    pw.println("Launched legacy dialog. Waiting up to " + legacyTimeoutMs
+                            + " ms for user response before dismissing...");
+                    String legacyDialogResponse = legacyDialogQueue.poll(legacyTimeoutMs,
+                            TimeUnit.MILLISECONDS);
+                    if (legacyDialogResponse == null) {
+                        pw.println("No response received. Dismissing dialog.");
+                        legacyDialogHandle.dismissDialog();
+                    } else {
+                        pw.println(legacyDialogResponse);
+                    }
+                    return 0;
                 case "launch-dialog-p2p-invitation-sent": {
                     int displayId = Display.DEFAULT_DISPLAY;
                     String deviceName = getNextArgRequired();
@@ -1707,7 +1820,7 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                             p2pInvRecQueue.offer("Invitation declined");
                         }
                     };
-                    WifiDialogManager.DialogHandle p2pInvitationReceivedDialogHandle =
+                    DialogHandle p2pInvitationReceivedDialogHandle =
                             mWifiDialogManager.createP2pInvitationReceivedDialog(
                                     deviceName,
                                     isPinRequested,
@@ -2325,6 +2438,262 @@ public class WifiShellCommand extends BasicShellCommandHandler {
                     mWifiService.setScanThrottleEnabled(
                             getNextArgRequiredTrueOrFalse("enabled", "disabled"));
                     return 0;
+                case "aware-attach": {
+                    if (sWifiAwareSession != null) {
+                        return 0;
+                    }
+                    if (mWifiAwareManager == null) {
+                        pw.println("aware not support");
+                        return -1;
+                    }
+                    mWifiThreadRunner.post(() -> {
+                        mWifiAwareManager.attach(new AttachCallback() {
+                            @Override
+                            public void onAttached(WifiAwareSession session) {
+                                Log.d(TAG, "onAttached");
+                                sWifiAwareSession = session;
+                            }
+                        }, mWifiThreadRunner.getHandler());
+                    });
+                    return 0;
+                }
+                case "aware-publish": {
+                    if (sWifiAwareSession == null) {
+                        pw.println("null aware session");
+                        return -1;
+                    }
+                    String awareServiceName = getNextArgRequired();
+                    boolean securityEnabled = getNextArgRequiredTrueOrFalse("yes", "no");
+                    boolean pairingEnabled = getNextArgRequiredTrueOrFalse("yes", "no");
+                    String bootMethods = getNextArgRequired();
+                    String pairingPw = getNextArgRequired();
+                    boolean success = mWifiThreadRunner.call(() -> {
+                        try {
+                            AwarePairingConfig pairingConfig = new AwarePairingConfig.Builder()
+                                    .setPairingCacheEnabled(true)
+                                    .setPairingSetupEnabled(true)
+                                    .setPairingVerificationEnabled(true)
+                                    .setBootstrappingMethods(Integer.parseInt(bootMethods))
+                                    .build();
+                            WifiAwareDataPathSecurityConfig securityConfig =
+                                    new WifiAwareDataPathSecurityConfig
+                                            .Builder(WIFI_AWARE_CIPHER_SUITE_NCS_SK_128)
+                                            .setPskPassphrase(pairingPw)
+                                            .build();
+                            PublishConfig.Builder builder = new PublishConfig.Builder()
+                                    .setServiceName(awareServiceName)
+                                    .setPublishType(PUBLISH_TYPE_SOLICITED);
+                            if (securityEnabled) {
+                                builder.setDataPathSecurityConfig(securityConfig);
+                            }
+
+                            if (pairingEnabled && SdkLevel.isAtLeastU()) {
+                                builder.setPairingConfig(pairingConfig);
+                            }
+                            sWifiAwareSession.publish(builder.build(),
+                                    new DiscoverySessionCallback() {
+                                        @Override
+                                        public void onPublishStarted(
+                                                PublishDiscoverySession session) {
+                                            Log.d(TAG, "onPublishStarted");
+                                            sDiscoverySession = session;
+                                        }
+
+                                        public void onPairingSetupRequestReceived(
+                                                PeerHandle peerHandle, int requestId) {
+                                            Log.d(TAG, "onPairingSetupRequestReceived");
+                                            sPeerHandle = peerHandle;
+                                            if (SdkLevel.isAtLeastU()) {
+                                                sDiscoverySession.acceptPairingRequest(requestId,
+                                                        peerHandle,
+                                                        "test",
+                                                        WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_128,
+                                                        pairingPw);
+                                            }
+                                        }
+
+                                        public void onPairingSetupSucceeded(
+                                                PeerHandle peerHandle, String alias) {
+                                            Log.d(TAG, "onPairingSetupSucceeded");
+                                        }
+
+                                        public void onPairingVerificationSucceed(
+                                                PeerHandle peerHandle, String alias) {
+                                            Log.d(TAG, "onPairingVerificationSucceed");
+                                        }
+
+                                        public void onBootstrappingSucceeded(PeerHandle peerHandle,
+                                                int method) {
+                                            sPeerHandle = peerHandle;
+                                            Log.d(TAG, "onBootstrappingSucceeded");
+                                        }
+                                    }, mWifiThreadRunner.getHandler());
+                        } catch (Exception e) {
+                            pw.println(e.getLocalizedMessage());
+                            return false;
+                        }
+                        return true;
+                    }, false);
+                    return success ? 0 : -1;
+                }
+                case "aware-subscribe": {
+                    if (sWifiAwareSession == null) {
+                        pw.println("null aware session");
+                        return -1;
+                    }
+                    String awareServiceName = getNextArgRequired();
+                    boolean enabled = getNextArgRequiredTrueOrFalse("yes", "no");
+                    String bootMethods = getNextArgRequired();
+                    boolean success = mWifiThreadRunner.call(() -> {
+                        try {
+                            AwarePairingConfig pairingConfig = new AwarePairingConfig.Builder()
+                                    .setPairingCacheEnabled(true)
+                                    .setPairingSetupEnabled(true)
+                                    .setPairingVerificationEnabled(true)
+                                    .setBootstrappingMethods(Integer.parseInt(bootMethods))
+                                    .build();
+                            SubscribeConfig.Builder builder = new SubscribeConfig.Builder()
+                                    .setServiceName(awareServiceName)
+                                    .setSubscribeType(SUBSCRIBE_TYPE_ACTIVE);
+                            if (SdkLevel.isAtLeastU()) {
+                                builder.setPairingConfig(pairingConfig);
+                            }
+                            sWifiAwareSession.subscribe(builder.build(),
+                                    new DiscoverySessionCallback() {
+                                        public void onSubscribeStarted(
+                                                SubscribeDiscoverySession session) {
+                                            Log.d(TAG, "onSubscribeStarted");
+                                            sDiscoverySession = session;
+                                        }
+
+                                        public void onServiceDiscovered(PeerHandle peerHandle,
+                                                byte[] serviceSpecificInfo,
+                                                List<byte[]> matchFilter) {
+                                            Log.d(TAG, "onServiceDiscovered " + peerHandle.peerId);
+                                            sPeerHandle = peerHandle;
+                                            if (SdkLevel.isAtLeastU()) {
+                                                sDiscoverySession.initiateBootstrappingRequest(
+                                                        peerHandle,
+                                                        Integer.parseInt(bootMethods));
+                                            }
+                                        }
+
+                                        public void onPairingSetupSucceeded(
+                                                PeerHandle peerHandle, String alias) {
+                                            Log.d(TAG, "onPairingSetupSucceeded");
+                                        }
+
+                                        public void onPairingVerificationSucceed(
+                                                PeerHandle peerHandle,
+                                                String alias) {
+                                            Log.d(TAG, "onPairingVerificationSucceed");
+                                        }
+
+                                        public void onBootstrappingSucceeded(PeerHandle peerHandle,
+                                                int method) {
+                                            Log.d(TAG, peerHandle.peerId
+                                                    + " onBootstrappingSucceeded: " + method);
+                                        }
+                                    }, mWifiThreadRunner.getHandler());
+                        } catch (Exception e) {
+                            pw.println(e.getLocalizedMessage());
+                            return false;
+                        }
+                        return true;
+                    }, false);
+                    return success ? 0 : -1;
+                }
+                case "aware-stop-publish-subscribe": {
+                    if (sDiscoverySession == null) {
+                        pw.println("null publish/subscribe session");
+                        return -1;
+                    }
+                    mWifiThreadRunner.post(() -> {
+                        sDiscoverySession.close();
+                        sDiscoverySession = null;
+                    });
+                    return 0;
+                }
+                case "aware-initiate-pairing-request": {
+                    if (sDiscoverySession == null) {
+                        pw.println("null subscribe session");
+                        return -1;
+                    }
+                    String pairingPw = getNextArgRequired();
+                    if (SdkLevel.isAtLeastU()) {
+                        mWifiThreadRunner.post(() -> sDiscoverySession.initiatePairingRequest(
+                                sPeerHandle, "test",
+                                WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_128, pairingPw));
+                    }
+                    return 0;
+                }
+                case "aware-request-network":
+                    if (sDiscoverySession == null) {
+                        pw.println("null publish/subscribe session");
+                        return -1;
+                    }
+                    String pathPw = getNextArgRequired();
+                    mWifiThreadRunner.post(() -> {
+                        WifiAwareNetworkSpecifier networkSpecifier;
+                        if (sPeerHandle != null) {
+                            networkSpecifier =
+                                    new WifiAwareNetworkSpecifier.Builder(sDiscoverySession,
+                                            sPeerHandle).setPskPassphrase(pathPw).build();
+                        } else {
+                            networkSpecifier =
+                                    new WifiAwareNetworkSpecifier.Builder(
+                                            (PublishDiscoverySession) sDiscoverySession)
+                                            .setPskPassphrase(pathPw).build();
+                        }
+                        NetworkRequest networkRequest = new NetworkRequest.Builder()
+                                .addTransportType(NetworkCapabilities.TRANSPORT_WIFI_AWARE)
+                                .setNetworkSpecifier(networkSpecifier)
+                                .build();
+                        mConnectivityManager.requestNetwork(networkRequest,
+                                new ConnectivityManager.NetworkCallback() {
+                                    public void onCapabilitiesChanged(Network arg1,
+                                            NetworkCapabilities arg2) {
+                                        Log.d(TAG, "onCapabilitiesChanged: "
+                                                + arg2.getTransportInfo().toString());
+                                    }
+                                });
+                    });
+                    return 0;
+                case "aware-teardown":
+                    if (sWifiAwareSession == null) {
+                        pw.println("null aware session");
+                        return -1;
+                    }
+                    mWifiThreadRunner.post(() -> {
+                        sWifiAwareSession.close();
+                        sWifiAwareSession = null;
+                        sPeerHandle = null;
+                        sDiscoverySession = null;
+                    });
+                    return 0;
+                case "aware-clean-paired-device":
+                    if (mWifiAwareManager == null) {
+                        pw.println("aware not support");
+                        return -1;
+                    }
+                    mWifiThreadRunner.post(mWifiAwareManager::resetPairedDevices);
+                    return 0;
+                case "get-carrier-network-offload":
+                    String arg1 = getNextArgRequired();
+                    int subId = -1;
+                    try {
+                        subId = Integer.parseInt(arg1);
+                    } catch (NumberFormatException e) {
+                        pw.println("Invalid argument to 'get-carrier-network-offload' "
+                                + "- 'subId' must be an Integer");
+                        return -1;
+                    }
+                    boolean enabled = mWifiCarrierInfoManager.isCarrierNetworkOffloadEnabled(subId,
+                            true);
+                    pw.println("merged network offload:" + (enabled ? "enabled" : "disabled"));
+                    enabled = mWifiCarrierInfoManager.isCarrierNetworkOffloadEnabled(subId, false);
+                    pw.println("not merged network offload:" + (enabled ? "enabled" : "disabled"));
+                    return 0;
                 default:
                     return handleDefaultCommands(cmd);
             }
@@ -2772,6 +3141,16 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         return cellChannels;
     }
 
+    private List<Pair<String, String>> buildDialogList() {
+        List<Pair<String, String>> list = new ArrayList<>();
+        String nextArg = peekNextArg();
+        while (nextArg != null && !nextArg.startsWith("-")) {
+            list.add(new Pair<>(getNextArgRequired(), getNextArgRequired()));
+            nextArg = peekNextArg();
+        }
+        return list;
+    }
+
     private int sendLinkProbe(PrintWriter pw) throws InterruptedException {
         // Note: should match WifiNl80211Manager#SEND_MGMT_FRAME_TIMEOUT_MS
         final int sendMgmtFrameTimeoutMs = 1000;
@@ -3053,9 +3432,15 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         pw.println(
                 "    Reset the WiFi resources cache which will cause them to be reloaded next "
                         + "time they are accessed. Necessary if overlays are manually modified.");
-        pw.println("  launch-dialog-simple [-t <title>] [-m <message>]"
-                + " [-l <url> <url_start> <url_end>] [-y <positive_button_text>]"
-                + " [-n <negative_button_text>] [-x <neutral_button_text>] [-c <timeout_millis>]");
+        pw.println("  launch-dialog-simple"
+                + " [-t <title>]"
+                + " [-m <message>]"
+                + " [-l <url> <url_start> <url_end>]"
+                + " [-i <label1> <content1> ... <labelN> <contentN>]"
+                + " [-y <positive_button_text>]"
+                + " [-n <negative_button_text>]"
+                + " [-x <neutral_button_text>]"
+                + " [-c <timeout_millis>]");
         pw.println("    Launches a simple dialog and waits up to 15 seconds to"
                 + " print the response.");
         pw.println("    -t - Title");
@@ -3065,7 +3450,18 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         pw.println("    -n - Negative Button Text");
         pw.println("    -x - Neutral Button Text");
         pw.println("    -c - Optional timeout in milliseconds");
-        pw.println("    -s - Use the legacy dialog implementation on the system process");
+        pw.println("  launch-dialog-simple-legacy [-t <title>] [-m <message>]"
+                + " [-l <url> <url_start> <url_end>] [-y <positive_button_text>]"
+                + " [-n <negative_button_text>] [-x <neutral_button_text>] [-c <timeout_millis>]");
+        pw.println("    Launches a legacy dialog (i.e. on the system process) and waits up to 15"
+                + " seconds to print the response.");
+        pw.println("    -t - Title");
+        pw.println("    -m - Message");
+        pw.println("    -l - URL of the message, with the start and end index inside the message");
+        pw.println("    -y - Positive Button Text");
+        pw.println("    -n - Negative Button Text");
+        pw.println("    -x - Neutral Button Text");
+        pw.println("    -c - Optional timeout in milliseconds");
         pw.println("  launch-dialog-p2p-invitation-sent <device_name> [-d <pin>]"
                 + " [-i <display_id>]");
         pw.println("    Launches a P2P Invitation Sent dialog.");
@@ -3142,6 +3538,8 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         pw.println("    each on a separate line.");
         pw.println("  get-wifi-supported-features");
         pw.println("    Gets the features supported by WifiManager");
+        pw.println("  get-carrier-network-offload <subId>");
+        pw.println("    Gets whether the carrier network offload is enabled or not for this subId");
     }
 
     private void onHelpPrivileged(PrintWriter pw) {
@@ -3428,6 +3826,34 @@ public class WifiShellCommand extends BasicShellCommandHandler {
         pw.println("    Example: set-ssid-roaming-mode test_ssid aggressive");
         pw.println("  set-scan-throttling-enabled enabled|disabled");
         pw.println("    Set wifi scan throttling for 3P apps enabled or disabled.");
+        pw.println("  aware-attach");
+        pw.println("    enable Wi-Fi Aware");
+        pw.println("  aware-publish <service name> <security enabled=yes|no>"
+                + "<pairing enabled=yes|no> <bootstrapping methods> <pairing password>");
+        pw.println("    Start Aware publish ");
+        pw.println("    <service name> - Name of the service, should be the same as subscribe");
+        pw.println("    <security enabled> - enable security or not");
+        pw.println("    <pairing enabled> - enable security or not");
+        pw.println("    <bootstrapping methods> - bootstrapping method for pairing");
+        pw.println("    <pairing password> - password used for pairing");
+        pw.println("  aware-subscribe <service name> <pairing enabled=yes|no> "
+                + "<bootstrapping methods>");
+        pw.println("    Start Aware subscribe ");
+        pw.println("    <service name> - Name of the service, should be the same as subscribe");
+        pw.println("    <pairing enabled> - enable security or not");
+        pw.println("    <bootstrapping methods> - bootstrapping method for pairing");
+        pw.println("  aware-stop-publish-subscribe");
+        pw.println("    stop current publish/subscribe session");
+        pw.println("  aware-initiate-pairing-request <pairing password>");
+        pw.println("    initiate pairing request to publisher, should be called from subscriber");
+        pw.println("    <pairing password> - password used for pairing");
+        pw.println("  aware-request-network <datapath password>");
+        pw.println("    request a datapath to the discovered peer");
+        pw.println("    <datapath password> - password used for datapath");
+        pw.println("  aware-teardown");
+        pw.println("    disable the Wi-Fi Aware");
+        pw.println("  aware-clean-paired-device");
+        pw.println("    Cleared all paired devices");
     }
 
     @Override
diff --git a/service/java/com/android/server/wifi/WifiThreadRunner.java b/service/java/com/android/server/wifi/WifiThreadRunner.java
index 08ebe3868e..38bff992af 100644
--- a/service/java/com/android/server/wifi/WifiThreadRunner.java
+++ b/service/java/com/android/server/wifi/WifiThreadRunner.java
@@ -228,12 +228,17 @@ public class WifiThreadRunner {
      * @param runnable    The Runnable that will be executed.
      * @param delayMillis The delay (in milliseconds) until the Runnable
      *                    will be executed.
+     * @param taskName    The task name for performance logging
+     * @param token An instance which can be used to cancel {@code runnable} via
+     *         {@link #removeCallbacks(Object)}.
      * @return true if the runnable was successfully posted <b>(not executed)</b> to the main Wifi
      * thread, false otherwise
      */
-    public boolean postDelayed(@NonNull Runnable runnable, long delayMillis, String taskName) {
+    public boolean postDelayed(@NonNull Runnable runnable, long delayMillis, String taskName,
+            Object token) {
         Message m = Message.obtain(mHandler, runnable);
         m.getData().putString(KEY_SIGNATURE, taskName);
+        m.obj = token;
         return mHandler.sendMessageDelayed(m, delayMillis);
     }
 
@@ -256,6 +261,16 @@ public class WifiThreadRunner {
         return mHandler.hasCallbacks(r);
     }
 
+
+    /**
+     * Remove any pending posts of callbacks whose <var>obj</var> is <var>token</var>.
+     *
+     * @param token The object that will be used to query.
+     */
+    public final void removeCallbacks(@NonNull Object token) {
+        mHandler.removeCallbacksAndMessages(token);
+    }
+
     /**
      * Package private
      * @return Scissors timeout threshold
diff --git a/service/java/com/android/server/wifi/aware/WifiAwareDataPathStateManager.java b/service/java/com/android/server/wifi/aware/WifiAwareDataPathStateManager.java
index 0bf8e13542..3860b369ec 100644
--- a/service/java/com/android/server/wifi/aware/WifiAwareDataPathStateManager.java
+++ b/service/java/com/android/server/wifi/aware/WifiAwareDataPathStateManager.java
@@ -53,6 +53,7 @@ import android.util.SparseArray;
 import com.android.internal.annotations.VisibleForTesting;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.Clock;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.hal.WifiNanIface.NanDataPathChannelCfg;
 import com.android.server.wifi.hal.WifiNanIface.NanStatusCode;
 import com.android.server.wifi.util.NetdWrapper;
@@ -117,6 +118,7 @@ public class WifiAwareDataPathStateManager {
     private WifiAwareMetrics mAwareMetrics;
     private WifiPermissionsUtil mWifiPermissionsUtil;
     private WifiPermissionsWrapper mPermissionsWrapper;
+    private WifiLockManager mWifiLockManager;
     private Looper mLooper;
     private Handler mHandler;
     private WifiAwareNetworkFactory mNetworkFactory;
@@ -157,18 +159,18 @@ public class WifiAwareDataPathStateManager {
      */
     public void start(Context context, Looper looper, WifiAwareMetrics awareMetrics,
             WifiPermissionsUtil wifiPermissionsUtil, WifiPermissionsWrapper permissionsWrapper,
-            NetdWrapper netdWrapper) {
+            NetdWrapper netdWrapper, WifiLockManager wifiLockManager) {
         if (sVdbg) Log.v(TAG, "start");
 
         mContext = context;
         mAwareMetrics = awareMetrics;
         mWifiPermissionsUtil = wifiPermissionsUtil;
         mPermissionsWrapper = permissionsWrapper;
+        mWifiLockManager = wifiLockManager;
         mNetdWrapper = netdWrapper;
         mLooper = looper;
         mHandler = new Handler(mLooper);
 
-
         mNetworkFactory = new WifiAwareNetworkFactory(looper, context, sNetworkCapabilitiesFilter);
         mNetworkFactory.setScoreFilter(NETWORK_FACTORY_SCORE_AVAIL);
         mNetworkFactory.register();
@@ -760,6 +762,7 @@ public class WifiAwareDataPathStateManager {
                 nnri.networkSpecifier.role, ndpInfo.startTimestamp, nnri.networkSpecifier.sessionId,
                 channelFreqMHz);
         mAwareMetrics.recordNdpCreation(nnri.uid, nnri.packageName, mNetworkRequestsCache);
+        mWifiLockManager.updateAwareConnected(true);
     }
 
     private boolean isAddressValidationExpired(AwareNetworkRequestInformation nnri, int ndpId) {
@@ -818,6 +821,8 @@ public class WifiAwareDataPathStateManager {
             mNetworkRequestsCache.remove(nnriE.getKey());
             mNetworkFactory.tickleConnectivityIfWaiting();
         }
+        boolean isAnyDataPathEstablished = getNumOfNdps() > 0;
+        mWifiLockManager.updateAwareConnected(isAnyDataPathEstablished);
     }
 
     /**
diff --git a/service/java/com/android/server/wifi/aware/WifiAwareService.java b/service/java/com/android/server/wifi/aware/WifiAwareService.java
index 5a2f65ce48..7d90d3ea3c 100644
--- a/service/java/com/android/server/wifi/aware/WifiAwareService.java
+++ b/service/java/com/android/server/wifi/aware/WifiAwareService.java
@@ -79,10 +79,10 @@ public final class WifiAwareService extends SystemService {
                     wifiInjector.getWifiPermissionsUtil(),
                     wifiInjector.getWifiPermissionsWrapper(), wifiInjector.getSettingsConfigStore(),
                     wifiAwareNativeManager, wifiAwareNativeApi, wifiAwareNativeCallback,
-                    wifiInjector.makeNetdWrapper(), wifiInjector.getInterfaceConflictManager());
+                    wifiInjector.makeNetdWrapper(), wifiInjector.getInterfaceConflictManager(),
+                    wifiInjector.getWifiLockManager());
         } else if (phase == SystemService.PHASE_BOOT_COMPLETED) {
             mImpl.startLate();
         }
     }
 }
-
diff --git a/service/java/com/android/server/wifi/aware/WifiAwareServiceImpl.java b/service/java/com/android/server/wifi/aware/WifiAwareServiceImpl.java
index a44d90a76e..b988cd6a1f 100644
--- a/service/java/com/android/server/wifi/aware/WifiAwareServiceImpl.java
+++ b/service/java/com/android/server/wifi/aware/WifiAwareServiceImpl.java
@@ -60,6 +60,7 @@ import com.android.server.wifi.InterfaceConflictManager;
 import com.android.server.wifi.RunnerHandler;
 import com.android.server.wifi.SystemBuildProperties;
 import com.android.server.wifi.WifiInjector;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.WifiThreadRunner;
 import com.android.server.wifi.hal.WifiNanIface.NanStatusCode;
@@ -123,7 +124,7 @@ public class WifiAwareServiceImpl extends IWifiAwareManager.Stub {
             WifiSettingsConfigStore settingsConfigStore,
             WifiAwareNativeManager wifiAwareNativeManager, WifiAwareNativeApi wifiAwareNativeApi,
             WifiAwareNativeCallback wifiAwareNativeCallback, NetdWrapper netdWrapper,
-            InterfaceConflictManager interfaceConflictManager) {
+            InterfaceConflictManager interfaceConflictManager, WifiLockManager wifiLockManager) {
         Log.i(TAG, "Starting Wi-Fi Aware service");
 
         mWifiPermissionsUtil = wifiPermissionsUtil;
@@ -139,7 +140,7 @@ public class WifiAwareServiceImpl extends IWifiAwareManager.Stub {
         mHandler.post(() -> {
             mStateManager.start(mContext, handlerThread.getLooper(), awareMetrics,
                     wifiPermissionsUtil, permissionsWrapper, new Clock(), netdWrapper,
-                    interfaceConflictManager);
+                    interfaceConflictManager, wifiLockManager);
 
             settingsConfigStore.registerChangeListener(
                     WIFI_AWARE_VERBOSE_LOGGING_ENABLED,
diff --git a/service/java/com/android/server/wifi/aware/WifiAwareStateManager.java b/service/java/com/android/server/wifi/aware/WifiAwareStateManager.java
index 3f4460ed8b..7bab82ff4b 100644
--- a/service/java/com/android/server/wifi/aware/WifiAwareStateManager.java
+++ b/service/java/com/android/server/wifi/aware/WifiAwareStateManager.java
@@ -121,6 +121,7 @@ import com.android.server.wifi.InterfaceConflictManager;
 import com.android.server.wifi.RunnerState;
 import com.android.server.wifi.WifiGlobals;
 import com.android.server.wifi.WifiInjector;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.aware.PairingConfigManager.PairingSecurityAssociationInfo;
 import com.android.server.wifi.hal.WifiNanIface.NanStatusCode;
@@ -237,6 +238,7 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
     private static final int COMMAND_TYPE_SUSPEND_SESSION = 129;
     private static final int COMMAND_TYPE_RESUME_SESSION = 130;
     private static final int COMMAND_TYPE_END_PAIRING = 131;
+    private static final int COMMAND_TYPE_CREATE_ALL_DATA_PATH_INTERFACES = 132;
 
     private static final int RESPONSE_TYPE_ON_CONFIG_SUCCESS = 200;
     private static final int RESPONSE_TYPE_ON_CONFIG_FAIL = 201;
@@ -680,7 +682,8 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
      */
     public void start(Context context, Looper looper, WifiAwareMetrics awareMetrics,
             WifiPermissionsUtil wifiPermissionsUtil, WifiPermissionsWrapper permissionsWrapper,
-            Clock clock, NetdWrapper netdWrapper, InterfaceConflictManager interfaceConflictMgr) {
+            Clock clock, NetdWrapper netdWrapper, InterfaceConflictManager interfaceConflictMgr,
+            WifiLockManager wifiLockManager) {
         Log.i(TAG, "start()");
 
         mContext = context;
@@ -694,7 +697,7 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
 
         mDataPathMgr = new WifiAwareDataPathStateManager(this, clock);
         mDataPathMgr.start(mContext, mSm.getHandler().getLooper(), awareMetrics,
-                wifiPermissionsUtil, permissionsWrapper, netdWrapper);
+                wifiPermissionsUtil, permissionsWrapper, netdWrapper, wifiLockManager);
 
         mPowerManager = mContext.getSystemService(PowerManager.class);
         mWifiManager = (WifiManager) mContext.getSystemService(Context.WIFI_SERVICE);
@@ -1495,6 +1498,12 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
         mSm.sendMessage(msg);
     }
 
+    private void createAllDataInterfaces() {
+        Message msg = mSm.obtainMessage(MESSAGE_TYPE_COMMAND);
+        msg.arg1 = COMMAND_TYPE_CREATE_ALL_DATA_PATH_INTERFACES;
+        mSm.sendMessage(msg);
+    }
+
     /**
      * delete all Aware data path interfaces.
      */
@@ -2296,6 +2305,8 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
                 case COMMAND_TYPE_SUSPEND_SESSION -> "COMMAND_TYPE_SUSPEND_SESSION";
                 case COMMAND_TYPE_RESUME_SESSION -> "COMMAND_TYPE_RESUME_SESSION";
                 case COMMAND_TYPE_END_PAIRING -> "COMMAND_TYPE_END_PAIRING";
+                case COMMAND_TYPE_CREATE_ALL_DATA_PATH_INTERFACES
+                        -> "COMMAND_TYPE_CREATE_ALL_DATA_PATH_INTERFACES";
 
                 case RESPONSE_TYPE_ON_CONFIG_SUCCESS -> "RESPONSE_TYPE_ON_CONFIG_SUCCESS";
                 case RESPONSE_TYPE_ON_CONFIG_FAIL -> "RESPONSE_TYPE_ON_CONFIG_FAIL";
@@ -3235,6 +3246,11 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
                         sessionId);
                     break;
                 }
+                case COMMAND_TYPE_CREATE_ALL_DATA_PATH_INTERFACES: {
+                    createAllDataPathInterfaces();
+                    waitForResponse = false;
+                    break;
+                }
                 default:
                     waitForResponse = false;
                     Log.wtf(TAG, "processCommand: this isn't a COMMAND -- msg=" + msg);
@@ -3928,11 +3944,16 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
         mClients.delete(clientId);
         mAwareMetrics.recordAttachSessionDuration(client.getCreationTime());
         SparseArray<WifiAwareDiscoverySessionState> sessions = client.getSessions();
+        int size = sessions.size();
         for (int i = 0; i < sessions.size(); ++i) {
             mAwareMetrics.recordDiscoverySessionDuration(sessions.valueAt(i).getCreationTime(),
                     sessions.valueAt(i).isPublishSession(), sessions.valueAt(i).getSessionId());
         }
         client.destroy();
+        if (size > 0) {
+            // Has publish/subscribe session destroyed, send Aware resources changed broadcast.
+            sendAwareResourcesChangedBroadcast();
+        }
 
         if (mClients.size() == 0) {
             mCurrentAwareConfiguration = null;
@@ -4243,7 +4264,8 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
         String methodString = "respondToBootstrappingRequestLocal";
         if (mVdbg) {
             Log.v(TAG, methodString + ": transactionId=" + transactionId
-                    + ", clientId=" + clientId + ", sessionId=" + sessionId + ", peerId=" + peerId);
+                    + ", clientId=" + clientId + ", sessionId=" + sessionId + ", peerId=" + peerId
+                    + ", accept=" + accept + ", method" + method);
         }
         WifiAwareDiscoverySessionState session = getClientSession(clientId, sessionId,
                 methodString);
@@ -4412,8 +4434,12 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
 
         if (completedCommand.arg1 == COMMAND_TYPE_CONNECT) {
             if (mCurrentAwareConfiguration == null) { // enabled (as opposed to re-configured)
-                queryCapabilities();
-                mDataPathMgr.createAllInterfaces();
+                if (mCapabilities == null) {
+                    queryCapabilities();
+                    createAllDataInterfaces();
+                } else {
+                    mDataPathMgr.createAllInterfaces();
+                }
                 recordHalApiCall(COMMAND_TYPE_CONNECT, NanStatusCode.SUCCESS, mStartTime);
             } else {
                 recordHalApiCall(COMMAND_TYPE_RECONFIGURE, NanStatusCode.SUCCESS, mStartTime);
@@ -4572,7 +4598,8 @@ public class WifiAwareStateManager implements WifiAwareShellCommand.DelegatedShe
             SubscribeConfig subscribeConfig = completedCommand.getData().getParcelable(
                     MESSAGE_BUNDLE_KEY_CONFIG);
             isRangingEnabled =
-                    subscribeConfig.mMinDistanceMmSet || subscribeConfig.mMaxDistanceMmSet;
+                    subscribeConfig.mMinDistanceMmSet || subscribeConfig.mMaxDistanceMmSet
+                            || subscribeConfig.mPeriodicRangingEnabled;
             isSuspendable = SdkLevel.isAtLeastU() && subscribeConfig.isSuspendable();
             if (subscribeConfig.mMinDistanceMmSet) {
                 minRange = subscribeConfig.mMinDistanceMm;
diff --git a/service/java/com/android/server/wifi/coex/CoexManager.java b/service/java/com/android/server/wifi/coex/CoexManager.java
index f8e7b901ac..4987a285e8 100644
--- a/service/java/com/android/server/wifi/coex/CoexManager.java
+++ b/service/java/com/android/server/wifi/coex/CoexManager.java
@@ -72,6 +72,7 @@ import com.android.internal.annotations.GuardedBy;
 import com.android.internal.annotations.VisibleForTesting;
 import com.android.modules.utils.HandlerExecutor;
 import com.android.server.wifi.WifiNative;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import java.io.BufferedInputStream;
@@ -179,9 +180,11 @@ public class CoexManager {
     }
 
     @VisibleForTesting
-    /* package */ class CoexTelephonyCallback extends TelephonyCallback
-            implements TelephonyCallback.PhysicalChannelConfigListener {
+    /* package */ class CoexTelephonyCallback extends TelephonyCallback implements
+            TelephonyCallback.PhysicalChannelConfigListener,
+            TelephonyCallback.RadioPowerStateListener {
         private final int mSubId;
+        private boolean mIsRadioOn = true;
         private boolean mIsEmpty = true;
         private boolean mIsPendingEmpty = false;
         private final Runnable mClearCellChannelsRunnable = () -> {
@@ -198,9 +201,14 @@ public class CoexManager {
         public void onPhysicalChannelConfigChanged(
                 @NonNull List<PhysicalChannelConfig> configs) {
             if (mVerboseLoggingEnabled) {
-                Log.v(TAG, "onPhysicalChannelConfigChanged for subId: " + mSubId
-                        + " called with configs: " + configs);
+                Log.v(TAG, "onPhysicalChannelConfigChanged: subId=" + mSubId
+                        + ", isRadioOn=" + mIsRadioOn
+                        + ", configs=" + configs);
             }
+            // Ignore onPhysicalChannelConfigChanged if the radio isn't on, since it may still be
+            // called with non-empty values.
+            if (!mIsRadioOn) return;
+
             List<CoexUtils.CoexCellChannel> cellChannels = new ArrayList<>();
             for (PhysicalChannelConfig config : configs) {
                 cellChannels.add(new CoexUtils.CoexCellChannel(config, mSubId));
@@ -234,6 +242,17 @@ public class CoexManager {
             }
             updateCoexUnsafeChannels(getCellChannelsForAllSubIds());
         }
+
+        @java.lang.Override
+        public void onRadioPowerStateChanged(int state) {
+            if (mVerboseLoggingEnabled) {
+                Log.v(TAG, "onRadioPowerStateChanged[" + mSubId + "]: " + state);
+            }
+            mIsRadioOn = state == TelephonyManager.RADIO_POWER_ON;
+            // onPhysicalChannelConfigChanged isn't called if the radio turns off, so manually clear
+            // the cell channels if that happens.
+            if (!mIsRadioOn) updateCellChannels(Collections.emptyList());
+        }
     }
 
     private final SparseBooleanArray mAvoid5gSoftApForLaaPerSubId = new SparseBooleanArray();
@@ -294,7 +313,13 @@ public class CoexManager {
         readTableFromXml();
         IntentFilter filter = new IntentFilter();
         filter.addAction(CarrierConfigManager.ACTION_CARRIER_CONFIG_CHANGED);
-        mContext.registerReceiver(mCarrierConfigChangedReceiver, filter, null, mCallbackHandler);
+        if (Flags.monitorIntentForAllUsers()) {
+            mContext.registerReceiverForAllUsers(
+                    mCarrierConfigChangedReceiver, filter, null, mCallbackHandler);
+        } else {
+            mContext.registerReceiver(mCarrierConfigChangedReceiver, filter,
+                    null, mCallbackHandler);
+        }
         mSubscriptionManager.addOnSubscriptionsChangedListener(
                 new HandlerExecutor(mCallbackHandler), new CoexOnSubscriptionsChangedListener());
     }
diff --git a/service/java/com/android/server/wifi/hal/WifiNanIfaceAidlImpl.java b/service/java/com/android/server/wifi/hal/WifiNanIfaceAidlImpl.java
index 4b329f2f18..3f2811fa96 100644
--- a/service/java/com/android/server/wifi/hal/WifiNanIfaceAidlImpl.java
+++ b/service/java/com/android/server/wifi/hal/WifiNanIfaceAidlImpl.java
@@ -842,7 +842,7 @@ public class WifiNanIfaceAidlImpl implements IWifiNanIface {
 
         req.baseConfigs.securityConfig = new NanDataPathSecurityConfig();
         req.baseConfigs.securityConfig.pmk = new byte[32];
-        req.baseConfigs.securityConfig.passphrase = new byte[0];
+        req.baseConfigs.securityConfig.passphrase = new byte[32];
         req.baseConfigs.securityConfig.scid = new byte[16];
         req.baseConfigs.securityConfig.securityType = NanDataPathSecurityType.OPEN;
         WifiAwareDataPathSecurityConfig securityConfig = publishConfig.getSecurityConfig();
@@ -872,7 +872,8 @@ public class WifiNanIfaceAidlImpl implements IWifiNanIface {
         req.txType = NanTxType.BROADCAST;
         req.pairingConfig = createAidlPairingConfig(publishConfig.getPairingConfig());
         if (publishConfig.getPairingConfig() != null) {
-            req.baseConfigs.securityConfig.cipherType |= getHalCipherSuites(
+            req.baseConfigs.securityConfig.securityType = NanDataPathSecurityType.PASSPHRASE;
+            req.baseConfigs.securityConfig.cipherType = getHalCipherSuites(
                     publishConfig.getPairingConfig().getSupportedCipherSuites());
         }
         req.identityKey = copyArray(nik, 16);
@@ -918,7 +919,8 @@ public class WifiNanIfaceAidlImpl implements IWifiNanIface {
         req.baseConfigs.disableFollowupReceivedIndication = false;
 
         req.baseConfigs.rangingRequired =
-                subscribeConfig.mMinDistanceMmSet || subscribeConfig.mMaxDistanceMmSet;
+                subscribeConfig.mMinDistanceMmSet || subscribeConfig.mMaxDistanceMmSet
+                        || subscribeConfig.mPeriodicRangingEnabled;
         req.baseConfigs.configRangingIndications = 0;
         if (subscribeConfig.mMinDistanceMmSet) {
             req.baseConfigs.distanceEgressCm = (char) Math.min(
diff --git a/service/java/com/android/server/wifi/hotspot2/PasspointManager.java b/service/java/com/android/server/wifi/hotspot2/PasspointManager.java
index d588e02a72..1bef45a058 100644
--- a/service/java/com/android/server/wifi/hotspot2/PasspointManager.java
+++ b/service/java/com/android/server/wifi/hotspot2/PasspointManager.java
@@ -36,6 +36,9 @@ import android.net.wifi.WifiSsid;
 import android.net.wifi.hotspot2.IProvisioningCallback;
 import android.net.wifi.hotspot2.OsuProvider;
 import android.net.wifi.hotspot2.PasspointConfiguration;
+import android.net.wifi.hotspot2.pps.Credential.CertificateCredential;
+import android.net.wifi.hotspot2.pps.Credential.SimCredential;
+import android.net.wifi.hotspot2.pps.Credential.UserCredential;
 import android.os.Looper;
 import android.os.Process;
 import android.text.TextUtils;
@@ -1324,12 +1327,45 @@ public class PasspointManager {
         mWifiMetrics.updateSavedPasspointProfiles(numProviders, numConnectedProviders);
     }
 
+    /**
+     * Tag to be used in dumpsys request
+     */
+    public static final String DUMP_ARG = "PasspointManager";
     /**
      * Dump the current state of PasspointManager to the provided output stream.
      *
      * @param pw The output stream to write to
+     * @param importantParametersOnly true to dump important parameters only
      */
-    public void dump(PrintWriter pw) {
+    public void dump(PrintWriter pw, boolean importantParametersOnly) {
+        if (importantParametersOnly) {
+            pw.println("PasspointManager - Providers Begin ---");
+            for (PasspointProvider passpointProvider : mProviders.values()) {
+                pw.println("ProviderId:" + passpointProvider.getProviderId());
+                pw.println("PackageName:" + passpointProvider.getPackageName());
+                PasspointConfiguration passpointConfiguration = passpointProvider.getConfig();
+                pw.println("FQDN:" + passpointConfiguration.getHomeSp().getFqdn());
+                pw.println("Realm:" + passpointConfiguration.getCredential().getRealm());
+                SimCredential simCredential =
+                        passpointConfiguration.getCredential().getSimCredential();
+                if (simCredential != null) {
+                    pw.println("SimCredential:" + simCredential.toString());
+                }
+                UserCredential userCredential =
+                        passpointConfiguration.getCredential().getUserCredential();
+                if (userCredential != null) {
+                    pw.println("UserCredential:" + userCredential.toString());
+                }
+                CertificateCredential certificateCredential =
+                        passpointConfiguration.getCredential().getCertCredential();
+                if (certificateCredential != null) {
+                    pw.println("CertificateCredential:" + certificateCredential.toString());
+                }
+                pw.println();
+            }
+            pw.println("PasspointManager - Providers End ---");
+            return;
+        }
         pw.println("Dump of PasspointManager");
         pw.println("mEnabled: " + mEnabled);
         pw.println("PasspointManager - Providers Begin ---");
diff --git a/service/java/com/android/server/wifi/mainline_supplicant/MainlineSupplicant.java b/service/java/com/android/server/wifi/mainline_supplicant/MainlineSupplicant.java
index 1ac2ad8f64..30694a8bea 100644
--- a/service/java/com/android/server/wifi/mainline_supplicant/MainlineSupplicant.java
+++ b/service/java/com/android/server/wifi/mainline_supplicant/MainlineSupplicant.java
@@ -18,11 +18,15 @@ package com.android.server.wifi.mainline_supplicant;
 
 import android.annotation.NonNull;
 import android.annotation.Nullable;
+import android.content.pm.PackageManager;
 import android.net.MacAddress;
+import android.net.wifi.WifiContext;
 import android.net.wifi.usd.Config;
 import android.net.wifi.usd.PublishConfig;
 import android.net.wifi.usd.SubscribeConfig;
+import android.net.wifi.util.BuildProperties;
 import android.net.wifi.util.Environment;
+import android.net.wifi.util.WifiResourceCache;
 import android.os.IBinder;
 import android.os.RemoteException;
 import android.os.ServiceSpecificException;
@@ -35,11 +39,14 @@ import android.util.Log;
 
 import com.android.internal.annotations.VisibleForTesting;
 import com.android.server.wifi.SupplicantStaIfaceHal;
+import com.android.server.wifi.WifiGlobals;
 import com.android.server.wifi.WifiNative;
 import com.android.server.wifi.WifiThreadRunner;
 import com.android.server.wifi.usd.UsdNativeManager;
 import com.android.wifi.flags.Flags;
+import com.android.wifi.resources.R;
 
+import java.io.PrintWriter;
 import java.util.Arrays;
 import java.util.HashMap;
 import java.util.Map;
@@ -61,6 +68,8 @@ public class MainlineSupplicant {
     private IMainlineSupplicant mIMainlineSupplicant;
     private final Object mLock = new Object();
     private final WifiThreadRunner mWifiThreadRunner;
+    private final WifiContext mContext;
+    private final WifiResourceCache mResourceCache;
     private SupplicantDeathRecipient mServiceDeathRecipient;
     private WifiNative.SupplicantDeathEventHandler mFrameworkDeathHandler;
     private CountDownLatch mWaitForDeathLatch;
@@ -68,9 +77,16 @@ public class MainlineSupplicant {
     private Map<String, IStaInterface> mActiveStaIfaces = new HashMap<>();
     private Map<String, IStaInterfaceCallback> mStaIfaceCallbacks = new HashMap<>();
     private UsdNativeManager.UsdEventsCallback mUsdEventsCallback = null;
+    private boolean mVerboseLoggingEnabled = false;
+    private boolean mVerboseHalLoggingEnabled = false;
+    private final WifiGlobals mWifiGlobals;
 
-    public MainlineSupplicant(@NonNull WifiThreadRunner wifiThreadRunner) {
+    public MainlineSupplicant(@NonNull WifiThreadRunner wifiThreadRunner,
+            @NonNull WifiContext context, @NonNull WifiGlobals wifiGlobals) {
         mWifiThreadRunner = wifiThreadRunner;
+        mContext = context;
+        mResourceCache = mContext.getResourceCache();
+        mWifiGlobals = wifiGlobals;
         mServiceDeathRecipient = new SupplicantDeathRecipient();
         mIsServiceAvailable = canServiceBeAccessed();
     }
@@ -118,13 +134,28 @@ public class MainlineSupplicant {
         }
     }
 
+    private boolean isUnsupportedDevice() {
+        // Avoid starting the process on resource-constrained devices.
+        PackageManager packageManager = mContext.getPackageManager();
+        return packageManager.hasSystemFeature(PackageManager.FEATURE_WATCH)
+                        || packageManager.hasSystemFeature(PackageManager.FEATURE_EMBEDDED)
+                        || packageManager.hasSystemFeature(PackageManager.FEATURE_LEANBACK)
+                        || packageManager.hasSystemFeature(PackageManager.FEATURE_AUTOMOTIVE);
+    }
+
+    private boolean isOverlayEnabled() {
+        return mResourceCache.getBoolean(R.bool.config_wifiMainlineSupplicantEnabled);
+    }
+
     /**
      * Check whether the mainline supplicant service can be accessed.
      */
     private boolean canServiceBeAccessed() {
-        // Requires an Android B+ Selinux policy and a copy of the binary.
+        // Requires an Android B+ Selinux policy, a copy of the binary, and device support.
+        BuildProperties buildProperties = BuildProperties.getInstance();
         return Environment.isSdkAtLeastB() && Flags.mainlineSupplicant()
-                && Environment.isMainlineSupplicantBinaryInWifiApex();
+                && Environment.isMainlineSupplicantBinaryInWifiApex()
+                && isOverlayEnabled() && !isUnsupportedDevice() && !buildProperties.isUserBuild();
     }
 
     /**
@@ -171,6 +202,7 @@ public class MainlineSupplicant {
                 mWaitForDeathLatch = null;
                 mIMainlineSupplicant.asBinder()
                         .linkToDeath(mServiceDeathRecipient, /* flags= */  0);
+                setDebugParams(mVerboseHalLoggingEnabled);
             } catch (RemoteException e) {
                 handleRemoteException(e, "startService");
                 return false;
@@ -190,6 +222,41 @@ public class MainlineSupplicant {
         }
     }
 
+    /**
+     * Configure verbose logging for this class.
+     *
+     * @param fwVerboseEnabled Whether verbose logging should be enabled in the framework.
+     * @param halVerboseEnabled Whether verbose logging should be enabled in the HAL.
+     */
+    public void enableVerboseLogging(boolean fwVerboseEnabled, boolean halVerboseEnabled) {
+        synchronized (mLock) {
+            mVerboseLoggingEnabled = fwVerboseEnabled;
+            mVerboseHalLoggingEnabled = halVerboseEnabled;
+            setDebugParams(halVerboseEnabled);
+            Log.i(TAG, "Set verbose logging. Framework=" + mVerboseLoggingEnabled
+                    + ", HAL=" + mVerboseHalLoggingEnabled);
+        }
+    }
+
+    private void setDebugParams(boolean halVerboseEnabled) {
+        synchronized (mLock) {
+            final String methodName = "setDebugParams";
+            if (!checkIsActiveAndLogError(methodName)) {
+                return;
+            }
+            try {
+                byte debugLevel = IMainlineSupplicant.DebugLevel.INFO;
+                boolean showKeys = halVerboseEnabled
+                        && mWifiGlobals.getShowKeyVerboseLoggingModeEnabled();
+                mIMainlineSupplicant.setDebugParams(debugLevel, showKeys);
+            } catch (ServiceSpecificException e) {
+                handleServiceSpecificException(e, methodName);
+            } catch (RemoteException e) {
+                handleRemoteException(e, methodName);
+            }
+        }
+    }
+
     /**
      * Set up a STA interface with the specified iface name.
      *
@@ -211,6 +278,10 @@ public class MainlineSupplicant {
             }
 
             try {
+                // Expect a warning about FLAG_ONEWAY when we add the STA interface, since
+                // we are not allowed to call Binder#allowBlocking from the mainline module.
+                // The functionality will not be affected.
+                Log.i(TAG, "Expecting a warning when the STA interface is added");
                 IStaInterface staIface = mIMainlineSupplicant.addStaInterface(ifaceName);
                 IStaInterfaceCallback callback = new MainlineSupplicantStaIfaceCallback(
                         this, ifaceName, mWifiThreadRunner);
@@ -687,6 +758,20 @@ public class MainlineSupplicant {
         }
     }
 
+    /**
+     * Dump information about the internal state.
+     *
+     * @param pw PrintWriter to write the dump to
+     */
+    public void dump(@NonNull PrintWriter pw) {
+        synchronized (mLock) {
+            pw.println("Dump of MainlineSupplicant");
+            pw.println("isAvailable: " + isAvailable());
+            pw.println("isActive: " + isActive());
+            pw.println("activeStaIfaces: " + mActiveStaIfaces.keySet());
+        }
+    }
+
     private void handleServiceSpecificException(ServiceSpecificException e, String methodName) {
         Log.e(TAG, methodName + " encountered ServiceSpecificException " + e);
     }
diff --git a/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java b/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
index 05a21be4a3..0ab40acd72 100644
--- a/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
+++ b/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
@@ -298,8 +298,8 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
     // Set a two minute discover timeout to avoid STA scans from being blocked
     private static final int DISCOVER_TIMEOUT_S = 120;
 
-    // Set a 30 seconds timeout for USD service discovery and advertisement.
-    @VisibleForTesting static final int USD_BASED_SERVICE_ADVERTISEMENT_DISCOVERY_TIMEOUT_S = 30;
+    // Set a 120 seconds timeout for USD service discovery and advertisement.
+    @VisibleForTesting static final int USD_BASED_SERVICE_ADVERTISEMENT_DISCOVERY_TIMEOUT_S = 120;
 
     // Idle time after a peer is gone when the group is torn down
     private static final int GROUP_IDLE_TIME_S = 10;
@@ -4007,16 +4007,11 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                     }
                     case WifiP2pMonitor
                             .P2P_PROV_DISC_SHOW_PAIRING_BOOTSTRAPPING_PIN_OR_PASSPHRASE_EVENT: {
-                        // TODO Change this logic:
-                        // Move to UserAuthorizingNegotiationRequestState, display the PIN or
-                        // passphrase and request user to accept/reject.
                         if (processProvisionDiscoveryRequestForV2ConnectionOnP2pDevice(
                                 (WifiP2pProvDiscEvent) message.obj)) {
                             notifyP2pProvDiscShowPinRequest(getPinOrPassphraseFromSavedPeerConfig(),
                                     mSavedPeerConfig.deviceAddress);
-                            p2pConnectWithPinDisplay(mSavedPeerConfig,
-                                    P2P_CONNECT_TRIGGER_GROUP_NEG_REQ);
-                            smTransition(this, mGroupNegotiationState);
+                            smTransition(this, mUserAuthorizingNegotiationRequestState);
                         }
                         break;
                     }
@@ -4490,7 +4485,8 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                 if (mSavedPeerConfig.wps.setup == WpsInfo.PBC
                         || (mSavedPeerConfig.wps.setup != WpsInfo.INVALID
                         && TextUtils.isEmpty(mSavedPeerConfig.wps.pin))
-                        || isConfigForV2Connection(mSavedPeerConfig)) {
+                        || (isConfigForV2Connection(mSavedPeerConfig)
+                        && TextUtils.isEmpty(getPinOrPassphraseFromSavedPeerConfig()))) {
                     notifyInvitationReceived(
                             WifiP2pManager.ExternalApproverRequestListener
                                     .REQUEST_TYPE_NEGOTIATION);
@@ -4883,6 +4879,17 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                                 .GROUP_CREATION_FAILURE_REASON_PROVISION_DISCOVERY_FAILED);
                         smTransition(this, mInactiveState);
                         break;
+                    case WifiP2pManager.SET_CONNECTION_REQUEST_RESULT: {
+                        if (!handleSetConnectionResultForV2ConnectionInvitationSent(message)) {
+                            replyToMessage(message,
+                                    WifiP2pManager.SET_CONNECTION_REQUEST_RESULT_FAILED,
+                                    WifiP2pManager.ERROR);
+                            break;
+                        }
+                        replyToMessage(message,
+                                WifiP2pManager.SET_CONNECTION_REQUEST_RESULT_SUCCEEDED);
+                        break;
+                    }
                     default:
                         return NOT_HANDLED;
                 }
@@ -5204,39 +5211,38 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
 
             private void showFrequencyConflictDialog() {
                 Resources r = mContext.getResources();
-                WifiDialogManager.DialogHandle dialog = mWifiInjector.getWifiDialogManager()
-                        .createSimpleDialog(
-                                null /* title */,
-                                r.getString(R.string.wifi_p2p_frequency_conflict_message,
-                                        getDeviceName(mSavedPeerConfig.deviceAddress)),
-                                r.getString(R.string.dlg_ok),
-                                r.getString(R.string.decline),
-                                null /* neutralButtonText */,
-                                new WifiDialogManager.SimpleDialogCallback() {
-                                    @Override
-                                    public void onPositiveButtonClicked() {
-                                        sendMessage(DROP_WIFI_USER_ACCEPT);
-                                    }
+                WifiDialogManager.SimpleDialogCallback callback =
+                        new WifiDialogManager.SimpleDialogCallback() {
+                            @Override
+                            public void onPositiveButtonClicked() {
+                                sendMessage(DROP_WIFI_USER_ACCEPT);
+                            }
 
-                                    @Override
-                                    public void onNegativeButtonClicked() {
-                                        sendMessage(DROP_WIFI_USER_REJECT);
-                                    }
+                            @Override
+                            public void onNegativeButtonClicked() {
+                                sendMessage(DROP_WIFI_USER_REJECT);
+                            }
 
-                                    @Override
-                                    public void onNeutralButtonClicked() {
-                                        // Not used
-                                        sendMessage(DROP_WIFI_USER_REJECT);
-                                    }
+                            @Override
+                            public void onNeutralButtonClicked() {
+                                // Not used
+                                sendMessage(DROP_WIFI_USER_REJECT);
+                            }
 
-                                    @Override
-                                    public void onCancelled() {
-                                        sendMessage(DROP_WIFI_USER_REJECT);
-                                    }
-                                },
-                                new WifiThreadRunner(getHandler()));
-                mFrequencyConflictDialog = dialog;
-                dialog.launchDialog();
+                            @Override
+                            public void onCancelled() {
+                                sendMessage(DROP_WIFI_USER_REJECT);
+                            }
+                        };
+                mFrequencyConflictDialog = mWifiInjector.getWifiDialogManager()
+                        .createSimpleDialogBuilder()
+                        .setMessage(r.getString(R.string.wifi_p2p_frequency_conflict_message,
+                                        getDeviceName(mSavedPeerConfig.deviceAddress)))
+                        .setPositiveButtonText(r.getString(R.string.dlg_ok))
+                        .setNegativeButtonText(r.getString(R.string.decline))
+                        .setCallback(callback, new WifiThreadRunner(getHandler()))
+                        .build();
+                mFrequencyConflictDialog.launchDialog();
             }
 
             private void notifyFrequencyConflict() {
@@ -6961,6 +6967,7 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                         .setGroupClientIpProvisioningMode(
                                 GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL)
                         .setAuthorizeConnectionFromPeerEnabled(true)
+                        .enablePersistentMode(true)
                         .build();
                 if (provDisc.getVendorData() != null) {
                     mSavedPeerConfig.setVendorData(provDisc.getVendorData());
@@ -8748,6 +8755,7 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
             return true;
         }
 
+        @SuppressLint("NewApi")
         private boolean handleSetConnectionResult(@NonNull Message message,
                 @WifiP2pManager.ExternalApproverRequestListener.RequestType int requestType) {
             if (!handleSetConnectionResultCommon(message)) return false;
@@ -8762,10 +8770,15 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
             } else if (WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE
                             == message.arg1
                     && WifiP2pManager.ExternalApproverRequestListener.REQUEST_TYPE_NEGOTIATION
-                            == requestType
-                    && WpsInfo.KEYPAD == mSavedPeerConfig.wps.setup) {
+                            == requestType) {
+                String pinOrPassphrase = "";
+                if (WpsInfo.KEYPAD == mSavedPeerConfig.wps.setup) {
+                    pinOrPassphrase = mSavedPeerConfig.wps.pin;
+                } else if (isConfigForBootstrappingMethodDisplayPinOrPassphrase(mSavedPeerConfig)) {
+                    pinOrPassphrase = getPinOrPassphraseFromSavedPeerConfig();
+                }
                 detachExternalApproverFromPeer();
-                notifyP2pProvDiscShowPinRequest(mSavedPeerConfig.wps.pin,
+                notifyP2pProvDiscShowPinRequest(pinOrPassphrase,
                         mSavedPeerConfig.deviceAddress);
                 return true;
             }
@@ -8773,15 +8786,23 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
             if (WifiP2pManager.CONNECTION_REQUEST_ACCEPT == message.arg1) {
                 if (WifiP2pManager.ExternalApproverRequestListener.REQUEST_TYPE_NEGOTIATION
                         == requestType
-                        && WpsInfo.DISPLAY == mSavedPeerConfig.wps.setup) {
+                        && (WpsInfo.DISPLAY == mSavedPeerConfig.wps.setup
+                        || isConfigForBootstrappingMethodDisplayPinOrPassphrase(
+                                mSavedPeerConfig))) {
                     sendMessage(PEER_CONNECTION_USER_CONFIRM);
                 } else {
                     Bundle extras = message.getData().getBundle(
                             WifiP2pManager.EXTRA_PARAM_KEY_BUNDLE);
+                    // TODO Define an Extra for transporting pairing bootstrapping PIN/Passphrase
                     String pin = extras.getString(
                             WifiP2pManager.EXTRA_PARAM_KEY_WPS_PIN);
                     if (!TextUtils.isEmpty(pin)) {
-                        mSavedPeerConfig.wps.pin = pin;
+                        if (isConfigForBootstrappingMethodKeypadPinOrPassphrase(mSavedPeerConfig)) {
+                            mSavedPeerConfig.getPairingBootstrappingConfig()
+                                    .setPairingBootstrappingPassword(pin);
+                        } else {
+                            mSavedPeerConfig.wps.pin = pin;
+                        }
                     }
                     sendMessage(PEER_CONNECTION_USER_ACCEPT);
                 }
@@ -8812,6 +8833,32 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
             return false;
         }
 
+        private boolean handleSetConnectionResultForV2ConnectionInvitationSent(
+                @NonNull Message message) {
+            if (!handleSetConnectionResultCommon(message)) {
+                return false;
+            }
+
+            if (!isConfigForV2Connection(mSavedPeerConfig)) {
+                return false;
+            }
+
+            logd("handle connection result for P2P V2 Display pin/passphrase from the approver,"
+                    + " result= " + message.arg1);
+            // For deferring result, the approver should be removed first to avoid notifying
+            // the application again.
+            if (WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE == message.arg1
+                    && isConfigForBootstrappingMethodDisplayPinOrPassphrase(mSavedPeerConfig)) {
+                detachExternalApproverFromPeer();
+                notifyInvitationSent(getPinOrPassphraseFromSavedPeerConfig(),
+                        mSavedPeerConfig.deviceAddress);
+                return true;
+            }
+            Log.w(TAG, "Invalid connection result: " + message.arg1
+                    + ", config: " + mSavedPeerConfig);
+            return false;
+        }
+
         private boolean isFeatureSupported(long feature) {
             return (getSupportedFeatures() & feature) == feature;
         }
diff --git a/service/java/com/android/server/wifi/rtt/RttServiceImpl.java b/service/java/com/android/server/wifi/rtt/RttServiceImpl.java
index 10cbe18e11..f79d4b5ab6 100644
--- a/service/java/com/android/server/wifi/rtt/RttServiceImpl.java
+++ b/service/java/com/android/server/wifi/rtt/RttServiceImpl.java
@@ -84,6 +84,7 @@ import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.hal.WifiRttController;
 import com.android.server.wifi.proto.nano.WifiMetricsProto;
 import com.android.server.wifi.util.WifiPermissionsUtil;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import org.json.JSONException;
@@ -340,7 +341,7 @@ public class RttServiceImpl extends IWifiRttManager.Stub {
         mRttServiceSynchronized.mHandler.post(() -> {
             IntentFilter intentFilter = new IntentFilter();
             intentFilter.addAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED);
-            mContext.registerReceiver(new BroadcastReceiver() {
+            BroadcastReceiver idleModeChangeReceiver = new BroadcastReceiver() {
                 @Override
                 public void onReceive(Context context, Intent intent) {
                     String action = intent.getAction();
@@ -354,8 +355,14 @@ public class RttServiceImpl extends IWifiRttManager.Stub {
                             enableIfPossible();
                         }
                     }
-                }
-            }, intentFilter);
+                }};
+            if (Flags.monitorIntentForAllUsers()) {
+                mContext.registerReceiverForAllUsers(idleModeChangeReceiver,
+                        intentFilter, null, mRttServiceSynchronized.mHandler);
+            } else {
+                mContext.registerReceiver(idleModeChangeReceiver, intentFilter, null,
+                        mRttServiceSynchronized.mHandler);
+            }
 
             settingsConfigStore.registerChangeListener(
                     WIFI_VERBOSE_LOGGING_ENABLED,
diff --git a/service/java/com/android/server/wifi/util/InformationElementUtil.java b/service/java/com/android/server/wifi/util/InformationElementUtil.java
index 9ac19d6283..ca899be7f9 100644
--- a/service/java/com/android/server/wifi/util/InformationElementUtil.java
+++ b/service/java/com/android/server/wifi/util/InformationElementUtil.java
@@ -249,6 +249,9 @@ public class InformationElementUtil {
         Vsa vsa = new Vsa();
         if (ies != null) {
             for (InformationElement ie : ies) {
+                if (ie == null) {
+                    continue;
+                }
                 if (ie.id == InformationElement.EID_VSA) {
                     try {
                         vsa.from(ie);
diff --git a/service/java/com/android/server/wifi/util/WifiPermissionsUtil.java b/service/java/com/android/server/wifi/util/WifiPermissionsUtil.java
index 614b0df42d..a7e084805b 100644
--- a/service/java/com/android/server/wifi/util/WifiPermissionsUtil.java
+++ b/service/java/com/android/server/wifi/util/WifiPermissionsUtil.java
@@ -22,6 +22,7 @@ import static android.Manifest.permission.ENTER_CAR_MODE_PRIORITIZED;
 import static android.Manifest.permission.NEARBY_WIFI_DEVICES;
 import static android.Manifest.permission.RENOUNCE_PERMISSIONS;
 import static android.Manifest.permission.REQUEST_COMPANION_PROFILE_AUTOMOTIVE_PROJECTION;
+import static android.Manifest.permission.REQUEST_COMPANION_PROFILE_NEARBY_DEVICE_STREAMING;
 import static android.content.pm.PackageManager.GET_PERMISSIONS;
 import static android.content.pm.PackageManager.MATCH_UNINSTALLED_PACKAGES;
 
@@ -798,6 +799,15 @@ public class WifiPermissionsUtil {
                 == PackageManager.PERMISSION_GRANTED;
     }
 
+    /**
+     * Returns true if the |uid| holds REQUEST_COMPANION_PROFILE_NEARBY_DEVICE_STREAMING permission.
+     */
+    public boolean checkRequestCompanionProfileNearbyDeviceStreamingPermission(int uid) {
+        return mWifiPermissionsWrapper.getUidPermission(
+                REQUEST_COMPANION_PROFILE_NEARBY_DEVICE_STREAMING, uid)
+                == PackageManager.PERMISSION_GRANTED;
+    }
+
     /**
      * Returns true if the |uid| holds ENTER_CAR_MODE_PRIORITIZED permission.
      */
@@ -1126,6 +1136,9 @@ public class WifiPermissionsUtil {
     public boolean isSystem(String packageName, int uid) {
         long ident = Binder.clearCallingIdentity();
         try {
+            if (SdkLevel.isAtLeastT() && Process.isSdkSandboxUid(uid)) {
+                return false;
+            }
             ApplicationInfo info = mContext.getPackageManager().getApplicationInfoAsUser(
                     packageName, 0, UserHandle.getUserHandleForUid(uid));
             return (info.flags & APP_INFO_FLAGS_SYSTEM_APP) != 0;
@@ -1356,4 +1369,19 @@ public class WifiPermissionsUtil {
         return mContext.getPackageManager().checkSignatures(uid, Process.SYSTEM_UID)
                 == PackageManager.SIGNATURE_MATCH;
     }
+
+    /** Whether the uid1 and uid2 are from the same user */
+    public boolean areTwoAppsFromSameUser(int uid1, int uid2) {
+        long ident = Binder.clearCallingIdentity();
+        try {
+            UserHandle uid1UserHandle = UserHandle.getUserHandleForUid(uid1);
+            UserHandle uid2UserHandle = UserHandle.getUserHandleForUid(uid2);
+            if (uid1UserHandle != null) {
+                return uid1UserHandle.equals(uid2UserHandle);
+            }
+        } finally {
+            Binder.restoreCallingIdentity(ident);
+        }
+        return false;
+    }
 }
diff --git a/service/java/com/android/server/wifi/util/XmlUtil.java b/service/java/com/android/server/wifi/util/XmlUtil.java
index 3c07365957..6c07629401 100644
--- a/service/java/com/android/server/wifi/util/XmlUtil.java
+++ b/service/java/com/android/server/wifi/util/XmlUtil.java
@@ -406,6 +406,8 @@ public class XmlUtil {
         public static final String XML_TAG_DPP_CSIGN_KEY = "DppCSignKey";
         public static final String XML_TAG_DPP_NET_ACCESS_KEY = "DppNetAccessKey";
         public static final String XML_TAG_ENABLE_WIFI7 = "EnableWifi7";
+        public static final String XML_TAG_ALLOW_UPDATE_BY_OTHER_USERS =
+                "AllowedToUpdateByOtherUsers";
 
         /**
          * Write Wep Keys to the XML stream.
@@ -574,6 +576,7 @@ public class XmlUtil {
          * @param encryptionUtil Instance of {@link EncryptedDataXmlUtil}. Backup/restore stores
          *                       keys unencrypted.
          */
+        @SuppressLint("NewApi")
         public static void writeCommonElementsToXml(
                 XmlSerializer out, WifiConfiguration configuration,
                 @Nullable WifiConfigStoreEncryptionUtil encryptionUtil)
@@ -618,6 +621,11 @@ public class XmlUtil {
             XmlUtil.writeNextValue(out, XML_TAG_IS_REPEATER_ENABLED,
                     configuration.isRepeaterEnabled());
             XmlUtil.writeNextValue(out, XML_TAG_ENABLE_WIFI7, configuration.isWifi7Enabled());
+            if (Environment.isSdkNewerThanB()) {
+                XmlUtil.writeNextValue(out, XML_TAG_ALLOW_UPDATE_BY_OTHER_USERS,
+                        Flags.multiUserWifiEnhancement()
+                        ? configuration.isAllowedToUpdateByOtherUsers() : true /* default */);
+            }
             writeSecurityParamsListToXml(out, configuration);
             XmlUtil.writeNextValue(out, XML_TAG_SEND_DHCP_HOSTNAME,
                     configuration.isSendDhcpHostnameEnabled());
@@ -871,6 +879,7 @@ public class XmlUtil {
          * @return Pair<Config key, WifiConfiguration object> if parsing is successful,
          * null otherwise.
          */
+        @SuppressLint("NewApi")
         public static Pair<String, WifiConfiguration> parseFromXml(
                 XmlPullParser in, int outerTagDepth, boolean shouldExpectEncryptedCredentials,
                 @Nullable WifiConfigStoreEncryptionUtil encryptionUtil, boolean fromSuggestion)
@@ -1083,6 +1092,12 @@ public class XmlUtil {
                         case XML_TAG_ENABLE_WIFI7:
                             configuration.setWifi7Enabled((boolean) value);
                             break;
+                        case XML_TAG_ALLOW_UPDATE_BY_OTHER_USERS:
+                            if (Flags.multiUserWifiEnhancement() && Environment.isSdkNewerThanB()
+                                    && configuration.shared) {
+                                configuration.setAllowedToUpdateByOtherUsers((boolean) value);
+                            }
+                            break;
                         default:
                             Log.w(TAG, "Ignoring unknown value name found: " + valueName[0]);
                             break;
@@ -1979,6 +1994,7 @@ public class XmlUtil {
                 "PersistentRandomizedMacAddress";
         public static final String XML_TAG_MAX_CHANNEL_WIDTH = "MaxChannelWidth";
         public static final String XML_TAG_CLIENT_ISOLATION = "ClientIsolation";
+        public static final String XML_TAG_BAND_OPTIMIZATION = "BandOptimization";
 
 
         /**
@@ -2215,6 +2231,10 @@ public class XmlUtil {
                 XmlUtil.writeNextValue(out, XML_TAG_CLIENT_ISOLATION,
                         softApConfig.isClientIsolationEnabled());
             }
+            if (Flags.bandOptimizationControl() && Environment.isSdkNewerThanB()) {
+                XmlUtil.writeNextValue(out, XML_TAG_BAND_OPTIMIZATION,
+                        softApConfig.isBandOptimizationEnabled());
+            }
         } // End of writeSoftApConfigurationToXml
 
         /**
@@ -2376,6 +2396,12 @@ public class XmlUtil {
                                     softApConfigBuilder.setClientIsolationEnabled((boolean) value);
                                 }
                                 break;
+                            case XML_TAG_BAND_OPTIMIZATION:
+                                if (Flags.bandOptimizationControl()
+                                        && Environment.isSdkNewerThanB()) {
+                                    softApConfigBuilder.setBandOptimizationEnabled((boolean) value);
+                                }
+                                break;
                             default:
                                 Log.w(TAG, "Ignoring unknown value name " + valueName[0]);
                                 break;
diff --git a/service/proto/src/metrics.proto b/service/proto/src/metrics.proto
index 225cad81fb..75cddc4182 100644
--- a/service/proto/src/metrics.proto
+++ b/service/proto/src/metrics.proto
@@ -1481,6 +1481,9 @@ message StaEvent {
 
     // No credentials
     DISCONNECT_NO_CREDENTIALS = 20;
+
+    // Connection timed out
+    DISCONNECT_CONNECT_WATCHDOG_TIMER = 21;
   }
 
   // Authentication Failure reasons as reported through the API.
diff --git a/service/tests/wifitests/Android.bp b/service/tests/wifitests/Android.bp
index f0f9102a76..7be709dcec 100644
--- a/service/tests/wifitests/Android.bp
+++ b/service/tests/wifitests/Android.bp
@@ -45,7 +45,7 @@ android_test {
         "platform-compat-test-rules",
     ],
 
-    jarjar_rules: ":wifi-jarjar-rules",
+    jarjar_rules: ":merged_jarjar",
 
     sdk_version: "core_current",
     libs: [
@@ -464,9 +464,9 @@ android_test {
             "com.android.server.wifi.SupplicantStateTracker",
             "com.android.server.wifi.SupplicantStateTracker$*",
             "com.android.server.wifi.SupplicantStateTracker.**",
-            "com.android.server.wifi.SystemBuildProperties",
-            "com.android.server.wifi.SystemBuildProperties$*",
-            "com.android.server.wifi.SystemBuildProperties.**",
+            "com.android.server.wifi.BuildProperties",
+            "com.android.server.wifi.BuildProperties$*",
+            "com.android.server.wifi.BuildProperties.**",
             "com.android.server.wifi.SystemPropertyService",
             "com.android.server.wifi.SystemPropertyService$*",
             "com.android.server.wifi.SystemPropertyService.**",
@@ -1340,3 +1340,17 @@ android_test {
         ],
     },
 }
+
+genrule {
+    name: "merged_jarjar",
+    srcs: [
+        ":wifi-jarjar-rules",
+    ],
+    tool_files: [
+        "jarjar_rules.txt",
+    ],
+    out: [
+        "marged_jarjar_rules.txt",
+    ],
+    cmd: "cat $(in) $(locations jarjar_rules.txt) > $(out)",
+}
diff --git a/service/tests/wifitests/jarjar_rules.txt b/service/tests/wifitests/jarjar_rules.txt
new file mode 100644
index 0000000000..7d5c56b14b
--- /dev/null
+++ b/service/tests/wifitests/jarjar_rules.txt
@@ -0,0 +1 @@
+rule com.android.internal.hidden_from_bootclasspath.** com.android.wifi.x.@1
diff --git a/service/tests/wifitests/src/com/android/server/wifi/ActiveModeWardenTest.java b/service/tests/wifitests/src/com/android/server/wifi/ActiveModeWardenTest.java
index eab4ac329f..b743c3f984 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/ActiveModeWardenTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/ActiveModeWardenTest.java
@@ -306,7 +306,8 @@ public class ActiveModeWardenTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         verify(mWifiMetrics).noteWifiEnabledDuringBoot(false);
-        verify(mWifiMetrics, never()).reportWifiStateChanged(eq(true), anyBoolean(), eq(false));
+        verify(mWifiMetrics, never()).reportWifiStateChanged(eq(true), anyBoolean(), eq(false),
+                eq(Process.WIFI_UID));
         verify(mWifiGlobals).setD2dStaConcurrencySupported(false);
         verify(mWifiNative).registerStatusListener(mStatusListenerCaptor.capture());
         verify(mWifiNative).initialize();
@@ -1530,7 +1531,8 @@ public class ActiveModeWardenTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         verify(mWifiMetrics).noteWifiEnabledDuringBoot(true);
-        verify(mWifiMetrics).reportWifiStateChanged(eq(true), anyBoolean(), eq(false));
+        verify(mWifiMetrics).reportWifiStateChanged(eq(true), anyBoolean(), eq(false),
+                eq(Process.WIFI_UID));
 
         assertInEnabledState();
 
@@ -4370,14 +4372,29 @@ public class ActiveModeWardenTest extends WifiBaseTest {
         assertEquals(ROLE_CLIENT_PRIMARY, requestedClientModeManager.getValue().getRole());
 
         // mock requesting local only secondary, but with preference for secondary STA.
+        // Verify that if it's not possible to create a secondary STA, then the primary STA is
+        // given to the app with EnterCarModePrioritized permission
+        when(mWifiNative.isItPossibleToCreateStaIface(any())).thenReturn(false);
+        mActiveModeWarden.requestLocalOnlyClientModeManager(
+                externalRequestListener, TEST_WORKSOURCE, TEST_SSID_2, TEST_BSSID_2, false, true);
+        mLooper.dispatchAll();
+        // Verify primary is given to the externalRequestListener
+        verify(externalRequestListener, times(2)).onAnswer(requestedClientModeManager.capture());
+        verify(mWifiInjector, never()).makeClientModeManager(
+                any(), any(), eq(ROLE_CLIENT_LOCAL_ONLY), anyBoolean());
+        assertEquals(ROLE_CLIENT_PRIMARY, requestedClientModeManager.getValue().getRole());
+
+        // mock requesting local only secondary, but with preference for secondary STA.
+        // Create secondary STA is now possible.
         // This should bypass the enterCarMode permission check and still give secondary STA.
+        when(mWifiNative.isItPossibleToCreateStaIface(any())).thenReturn(true);
         mActiveModeWarden.requestLocalOnlyClientModeManager(
                 externalRequestListener, TEST_WORKSOURCE, TEST_SSID_2, TEST_BSSID_2, false, true);
         mLooper.dispatchAll();
         additionalClientListener.value.onStarted(additionalClientModeManager);
         mLooper.dispatchAll();
         // Verify secondary is given to the externalRequestListener
-        verify(externalRequestListener, times(2)).onAnswer(requestedClientModeManager.capture());
+        verify(externalRequestListener, times(3)).onAnswer(requestedClientModeManager.capture());
         verify(mWifiInjector).makeClientModeManager(
                 any(), any(), eq(ROLE_CLIENT_LOCAL_ONLY), anyBoolean());
         assertEquals(ROLE_CLIENT_LOCAL_ONLY, requestedClientModeManager.getValue().getRole());
diff --git a/service/tests/wifitests/src/com/android/server/wifi/ApplicationQosPolicyRequestHandlerTest.java b/service/tests/wifitests/src/com/android/server/wifi/ApplicationQosPolicyRequestHandlerTest.java
index 5342efbafd..521c963383 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/ApplicationQosPolicyRequestHandlerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/ApplicationQosPolicyRequestHandlerTest.java
@@ -68,7 +68,6 @@ public class ApplicationQosPolicyRequestHandlerTest {
     @Mock ActiveModeWarden mActiveModeWarden;
     @Mock WifiNative mWifiNative;
     @Mock HandlerThread mHandlerThread;
-    @Mock DeviceConfigFacade mDeviceConfigFacade;
     @Mock Context mContext;
     @Mock IListListener mIListListener;
     @Mock ClientModeManager mClientModeManager0;
@@ -86,7 +85,7 @@ public class ApplicationQosPolicyRequestHandlerTest {
 
     private class ApplicationQosPolicyRequestHandlerSpy extends ApplicationQosPolicyRequestHandler {
         ApplicationQosPolicyRequestHandlerSpy() {
-            super(mActiveModeWarden, mWifiNative, mHandlerThread, mDeviceConfigFacade, mContext);
+            super(mActiveModeWarden, mWifiNative, mHandlerThread, mContext);
         }
 
         @Override
diff --git a/service/tests/wifitests/src/com/android/server/wifi/CandidateScorerTest.java b/service/tests/wifitests/src/com/android/server/wifi/CandidateScorerTest.java
index fd3edcb2b7..c82c103f57 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/CandidateScorerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/CandidateScorerTest.java
@@ -336,6 +336,15 @@ public class CandidateScorerTest extends WifiBaseTest {
                                        .setCurrentNetwork(true)
                                        .setLastSelectionWeight(0.25)),
                 greaterThan(evaluate(mCandidate2.setScanRssi(-60))));
+
+        if (mExpectedExpId == ThroughputScorer.THROUGHPUT_SCORER_DEFAULT_EXPID) {
+            // Do not apply last selection bonus on carrier network that is disconnected
+            assertThat(evaluate(mCandidate1.setScanRssi(-80)
+                            .setCurrentNetwork(false)
+                            .setCarrierOrPrivileged(true)
+                            .setLastSelectionWeight(0.25)),
+                    lessThan(evaluate(mCandidate2.setScanRssi(-60))));
+        }
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/ClientModeImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/ClientModeImplTest.java
index 37ae9aa13e..2abb93bcca 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/ClientModeImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/ClientModeImplTest.java
@@ -44,10 +44,10 @@ import static com.android.server.wifi.ClientModeImpl.CMD_PRE_DHCP_ACTION;
 import static com.android.server.wifi.ClientModeImpl.CMD_PRE_DHCP_ACTION_COMPLETE;
 import static com.android.server.wifi.ClientModeImpl.CMD_UNWANTED_NETWORK;
 import static com.android.server.wifi.ClientModeImpl.WIFI_WORK_SOURCE;
+import static com.android.server.wifi.TestUtil.createCapabilityBitset;
 import static com.android.server.wifi.WifiBlocklistMonitor.REASON_APP_DISALLOW;
 import static com.android.server.wifi.WifiSettingsConfigStore.SECONDARY_WIFI_STA_FACTORY_MAC_ADDRESS;
 import static com.android.server.wifi.WifiSettingsConfigStore.WIFI_STA_FACTORY_MAC_ADDRESS;
-import static com.android.server.wifi.TestUtil.createCapabilityBitset;
 
 import static org.junit.Assert.assertArrayEquals;
 import static org.junit.Assert.assertEquals;
@@ -193,6 +193,7 @@ import com.android.server.wifi.util.ActionListenerWrapper;
 import com.android.server.wifi.util.NativeUtil;
 import com.android.server.wifi.util.RssiUtilTest;
 import com.android.server.wifi.util.WifiPermissionsUtil;
+import com.android.wifi.flags.FeatureFlags;
 import com.android.wifi.resources.R;
 
 import org.junit.After;
@@ -573,6 +574,7 @@ public class ClientModeImplTest extends WifiBaseTest {
     @Mock ThroughputPredictor mThroughputPredictor;
     @Mock ScanRequestProxy mScanRequestProxy;
     @Mock DeviceConfigFacade mDeviceConfigFacade;
+    @Mock FeatureFlags mFeatureFlags;
     @Mock Network mNetwork;
     @Mock ConcreteClientModeManager mClientModeManager;
     @Mock WifiScoreReport mWifiScoreReport;
@@ -743,6 +745,8 @@ public class ClientModeImplTest extends WifiBaseTest {
         when(mWifiInjector.getSsidTranslator()).thenReturn(mSsidTranslator);
         when(mWifiInjector.getWifiDeviceStateChangeManager())
                 .thenReturn(mWifiDeviceStateChangeManager);
+        when(mWifiInjector.getDeviceConfigFacade()).thenReturn(mDeviceConfigFacade);
+        when(mDeviceConfigFacade.getFeatureFlags()).thenReturn(mFeatureFlags);
         when(mWifiHandlerThread.getLooper()).thenReturn(mLooper.getLooper());
         when(mWifiNative.getDeviceWiphyCapabilities(any())).thenReturn(mDeviceWiphyCapabilities);
         if (Flags.getDeviceCrossAkmRoamingSupport() && SdkLevel.isAtLeastV()) {
@@ -3041,6 +3045,7 @@ public class ClientModeImplTest extends WifiBaseTest {
 
         WifiConfiguration config = new WifiConfiguration();
         config.SSID = TEST_SSID;
+        config.networkId = FRAMEWORK_NETWORK_ID;
         config.getNetworkSelectionStatus().setHasEverConnected(true);
         config.allowedKeyManagement.set(KeyMgmt.IEEE8021X);
         config.enterpriseConfig.setEapMethod(WifiEnterpriseConfig.Eap.SIM);
@@ -3057,6 +3062,8 @@ public class ClientModeImplTest extends WifiBaseTest {
         verify(mEapFailureNotifier).onEapFailure(
                 WifiNative.EAP_SIM_VENDOR_SPECIFIC_CERT_EXPIRED, config, true);
         verify(mWifiCarrierInfoManager).resetCarrierKeysForImsiEncryption(any());
+        verify(mWifiNative).removeNetworkCachedData(FRAMEWORK_NETWORK_ID);
+        verify(mWifiNative, times(2)).removeAllNetworks(WIFI_IFACE_NAME);
         verify(mDeviceConfigFacade).isAbnormalConnectionFailureBugreportEnabled();
         verify(mWifiScoreCard).detectAbnormalConnectionFailure(anyString());
         verify(mWifiDiagnostics, times(2)).takeBugReport(anyString(), anyString());
@@ -4025,6 +4032,25 @@ public class ClientModeImplTest extends WifiBaseTest {
                 any());
     }
 
+    @Test
+    public void testRssiIsUpdatedAfterSupplicantAssociates() throws Exception {
+        // Mock RSSI poll results to be updated when supplicant associates.
+        WifiSignalPollResults signalPollResults = new WifiSignalPollResults();
+        signalPollResults.addEntry(0, -42, 65, 54, sFreq);
+        when(mWifiNative.signalPoll(any())).thenReturn(signalPollResults);
+        triggerConnect();
+
+        mCmi.sendMessage(WifiMonitor.SUPPLICANT_STATE_CHANGE_EVENT, 0, 0,
+                new StateChangeResult(0, TEST_WIFI_SSID, TEST_BSSID_STR, sFreq,
+                        SupplicantState.ASSOCIATED));
+        mLooper.dispatchAll();
+
+        validateConnectionInfo();
+        // RSSI should be updated after supplicant associates.
+        assertEquals(signalPollResults.getRssi(), mWifiInfo.getRssi());
+        assertRssiChangeBroadcastSent(1);
+    }
+
     /**
      * Verify that RSSI and link layer stats polling works in connected mode
      */
@@ -4658,10 +4684,9 @@ public class ClientModeImplTest extends WifiBaseTest {
 
         mLooper.moveTimeForward(ClientModeImpl.CONNECTING_WATCHDOG_TIMEOUT_MS);
         mLooper.dispatchAll();
-        verify(mWifiBlocklistMonitor).handleBssidConnectionFailure(any(), any(),
-                eq(WifiBlocklistMonitor.REASON_FAILURE_NO_RESPONSE), anyInt());
-        verify(mWifiDiagnostics).reportConnectionEvent(
-                eq(WifiDiagnostics.CONNECTION_EVENT_TIMEOUT), any());
+        verify(mWifiMetrics).logStaEvent(eq(WIFI_IFACE_NAME),
+                eq(StaEvent.TYPE_FRAMEWORK_DISCONNECT),
+                eq(StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER));
     }
 
     @Test
@@ -4669,17 +4694,17 @@ public class ClientModeImplTest extends WifiBaseTest {
         connect();
         mLooper.moveTimeForward(ClientModeImpl.CONNECTING_WATCHDOG_TIMEOUT_MS);
         mLooper.dispatchAll();
-        verify(mWifiBlocklistMonitor, never()).handleBssidConnectionFailure(any(), any(),
-                anyInt(), anyInt());
-        verify(mWifiDiagnostics, never()).reportConnectionEvent(
-                eq(WifiDiagnostics.CONNECTION_EVENT_TIMEOUT), any());
+        verify(mWifiMetrics, never()).logStaEvent(eq(WIFI_IFACE_NAME),
+                eq(StaEvent.TYPE_FRAMEWORK_DISCONNECT),
+                eq(StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER));
     }
 
     private void verifyConnectionEventTimeoutDoesNotOccur() {
         mLooper.moveTimeForward(ClientModeImpl.CONNECTING_WATCHDOG_TIMEOUT_MS);
         mLooper.dispatchAll();
-        verify(mWifiDiagnostics, never()).reportConnectionEvent(
-                eq(WifiDiagnostics.CONNECTION_EVENT_TIMEOUT), any());
+        verify(mWifiMetrics, never()).logStaEvent(eq(WIFI_IFACE_NAME),
+                eq(StaEvent.TYPE_FRAMEWORK_DISCONNECT),
+                eq(StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER));
     }
 
     /**
@@ -5367,6 +5392,9 @@ public class ClientModeImplTest extends WifiBaseTest {
                 eq(WifiMetrics.ConnectionEvent.FAILURE_NONE), eq(mConnectedNetwork),
                 any(String.class));
         verify(mCmiMonitor).onInternetValidated(mClientModeManager);
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
         // BSSID different, record this connection.
         verify(mWifiMetrics).incrementNumBssidDifferentSelectionBetweenFrameworkAndFirmware();
         verifyConnectionEventTimeoutDoesNotOccur();
@@ -5647,6 +5675,10 @@ public class ClientModeImplTest extends WifiBaseTest {
                 NetworkAgent.VALIDATION_STATUS_NOT_VALID, mMockUri);
         mLooper.dispatchAll();
 
+        verify(mWifiMetrics, never())
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME),
+                        eq(NetworkAgent.VALIDATION_STATUS_NOT_VALID));
         // expect no disconnection
         verify(mWifiNative, never()).disconnect(WIFI_IFACE_NAME);
     }
@@ -5783,6 +5815,10 @@ public class ClientModeImplTest extends WifiBaseTest {
         // expect not disabled since no internet is expected on this network
         verify(mWifiConfigManager, never()).updateNetworkSelectionStatus(
                 FRAMEWORK_NETWORK_ID, DISABLED_NO_INTERNET_TEMPORARY);
+        verify(mWifiMetrics, never())
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME),
+                        eq(NetworkAgent.VALIDATION_STATUS_NOT_VALID));
     }
 
     /**
@@ -5880,6 +5916,9 @@ public class ClientModeImplTest extends WifiBaseTest {
                 FRAMEWORK_NETWORK_ID, DISABLED_NONE);
         verify(mWifiScoreCard).noteValidationSuccess(any());
         verify(mWifiBlocklistMonitor).handleNetworkValidationSuccess(TEST_BSSID_STR, TEST_SSID);
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
     }
 
     /**
@@ -5921,6 +5960,9 @@ public class ClientModeImplTest extends WifiBaseTest {
                 FRAMEWORK_NETWORK_ID, DISABLED_NONE);
         verify(mWifiScoreCard).noteValidationSuccess(any());
         verify(mWifiBlocklistMonitor).handleNetworkValidationSuccess(TEST_BSSID_STR, TEST_SSID);
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
 
         // Now that the network has been validated, link properties must not have a T&C URL anymore
         // and captive is set to false
@@ -8100,9 +8142,9 @@ public class ClientModeImplTest extends WifiBaseTest {
         // Simulate watchdog timeout and ensure we retuned to disconnected state.
         mLooper.moveTimeForward(ClientModeImpl.CONNECTING_WATCHDOG_TIMEOUT_MS + 5L);
         mLooper.dispatchAll();
-
-        verify(mWifiNative).disableNetwork(WIFI_IFACE_NAME);
-        assertEquals("DisconnectedState", mCmi.getCurrentState().getName());
+        verify(mWifiMetrics).logStaEvent(eq(WIFI_IFACE_NAME),
+                eq(StaEvent.TYPE_FRAMEWORK_DISCONNECT),
+                eq(StaEvent.DISCONNECT_CONNECT_WATCHDOG_TIMER));
     }
 
     @Test
@@ -9500,6 +9542,9 @@ public class ClientModeImplTest extends WifiBaseTest {
                 eq(connectedConfig.SSID), eq(allowlistSsids));
         verify(mWifiBlocklistMonitor).updateFirmwareRoamingConfiguration(
                 eq(new ArraySet<>(allowlistSsids)));
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
     }
 
     @Test
@@ -9610,6 +9655,9 @@ public class ClientModeImplTest extends WifiBaseTest {
         verify(mWifiConfigManager)
                 .setNetworkDefaultGwMacAddress(mConnectedNetwork.networkId, gatewayMac);
         verify(mWifiConfigManager, never()).updateLinkedNetworks(connectedConfig.networkId);
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
 
         // FT/SAE scan, do not update linked networks
         ScanResult ftSaeScan = new ScanResult();
@@ -9621,7 +9669,9 @@ public class ClientModeImplTest extends WifiBaseTest {
         verify(mWifiConfigManager)
                 .setNetworkDefaultGwMacAddress(mConnectedNetwork.networkId, gatewayMac);
         verify(mWifiConfigManager, never()).updateLinkedNetworks(connectedConfig.networkId);
-
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
         // Null scan, do not update linked networks
         mWifiNetworkAgentCallbackCaptor.getValue().onValidationStatus(
                 NetworkAgent.VALIDATION_STATUS_VALID, null /* captivePortalUrl */);
@@ -9629,6 +9679,9 @@ public class ClientModeImplTest extends WifiBaseTest {
         verify(mWifiConfigManager)
                 .setNetworkDefaultGwMacAddress(mConnectedNetwork.networkId, gatewayMac);
         verify(mWifiConfigManager, never()).updateLinkedNetworks(connectedConfig.networkId);
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
     }
 
     @Test
@@ -9700,6 +9753,9 @@ public class ClientModeImplTest extends WifiBaseTest {
                 eq(connectedConfig.SSID), eq(Collections.emptyList()));
         verify(mWifiBlocklistMonitor).updateFirmwareRoamingConfiguration(
                 eq(Collections.emptySet()));
+        verify(mWifiMetrics)
+                .reportWifiValidationResult(
+                        eq(WIFI_IFACE_NAME), eq(NetworkAgent.VALIDATION_STATUS_VALID));
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/ConnectionFailureNotifierTest.java b/service/tests/wifitests/src/com/android/server/wifi/ConnectionFailureNotifierTest.java
index 3376523dbc..50049af752 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/ConnectionFailureNotifierTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/ConnectionFailureNotifierTest.java
@@ -66,6 +66,7 @@ public class ConnectionFailureNotifierTest extends WifiBaseTest {
     @Mock private WifiDialogManager mWifiDialogManager;
     @Mock private ConnectionFailureNotificationBuilder mConnectionFailureNotificationBuilder;
     @Mock private Notification mNotification;
+    @Mock private WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
     @Mock private WifiDialogManager.DialogHandle mDialogHandle;
 
     private final ArgumentCaptor<BroadcastReceiver> mBroadCastReceiverCaptor =
@@ -82,8 +83,15 @@ public class ConnectionFailureNotifierTest extends WifiBaseTest {
         when(mContext.getResources()).thenReturn(mResources);
         when(mConnectionFailureNotificationBuilder
                 .buildNoMacRandomizationSupportNotification(any())).thenReturn(mNotification);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(mDialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
         mConnectionFailureNotifier = new ConnectionFailureNotifier(
                 mContext, mFrameworkFacade, mWifiConfigManager, mWifiConnectivityManager,
                 new Handler(mLooper.getLooper()), mWifiNotificationManager,
@@ -146,9 +154,8 @@ public class ConnectionFailureNotifierTest extends WifiBaseTest {
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
         ArgumentCaptor<String> messageCaptor = ArgumentCaptor.forClass(String.class);
         verify(mDialogHandle).launchDialog();
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), messageCaptor.capture(), any(), any(), any(),
-                dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setMessage(messageCaptor.capture());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         String message = messageCaptor.getValue();
         assertNotNull(message);
         assertTrue(message.contains(config.SSID));
@@ -186,8 +193,7 @@ public class ConnectionFailureNotifierTest extends WifiBaseTest {
         mBroadCastReceiverCaptor.getValue().onReceive(mContext, intent);
 
         // verify that the AlertDialog is not launched in this case
-        verify(mWifiDialogManager, never())
-                .createSimpleDialog(any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
 
         verify(mFrameworkFacade, never()).makeAlertDialogBuilder(any());
diff --git a/service/tests/wifitests/src/com/android/server/wifi/HalDeviceManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/HalDeviceManagerTest.java
index 3bb9e85c61..c457cded72 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/HalDeviceManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/HalDeviceManagerTest.java
@@ -194,6 +194,7 @@ public class HalDeviceManagerTest extends WifiBaseTest {
         when(mWorkSourceHelper2.getWorkSource()).thenReturn(TEST_WORKSOURCE_2);
         when(mWifiInjector.getSettingsConfigStore()).thenReturn(mWifiSettingsConfigStore);
         when(mWifiInjector.getDeviceConfigFacade()).thenReturn(mDeviceConfigFacade);
+        when(mDeviceConfigFacade.getFeatureFlags()).thenReturn(mFeatureFlags);
         when(mConcreteClientModeManager.getRole()).thenReturn(
                 ClientModeManager.ROLE_CLIENT_PRIMARY);
 
@@ -909,6 +910,26 @@ public class HalDeviceManagerTest extends WifiBaseTest {
         collector.checkThat("AP was not created", apIface, IsNull.notNullValue());
     }
 
+    /**
+     * Executes executeDisconnectedP2pTreatedAsOpportunisticAfterTimeout with flag is disabled.
+     */
+    @Test
+    public void testDisconnectedP2pTreatedAsOpportunisticAfterTimeoutWhenFlagDisabled()
+            throws Exception {
+        when(mFeatureFlags.monitorIntentForAllUsers()).thenReturn(false);
+        executeDisconnectedP2pTreatedAsOpportunisticAfterTimeout(false);
+    }
+
+    /**
+     * Executes executeDisconnectedP2pTreatedAsOpportunisticAfterTimeout with flag is enabled.
+     */
+    @Test
+    public void testDisconnectedP2pTreatedAsOpportunisticAfterTimeoutWhenFlagEnabled()
+            throws Exception {
+        when(mFeatureFlags.monitorIntentForAllUsers()).thenReturn(true);
+        executeDisconnectedP2pTreatedAsOpportunisticAfterTimeout(true);
+    }
+
     /**
      * Validate that disconnected P2P is treated as opportunistic and can be deleted by other
      * foreground apps after config_disconnectedP2pIfaceLowPriorityTimeoutMs.
@@ -919,8 +940,8 @@ public class HalDeviceManagerTest extends WifiBaseTest {
      * - advance clock to config_disconnectedP2pIfaceLowPriorityTimeoutMs
      * - create NAN (foreground app): should succeed
      */
-    @Test
-    public void testDisconnectedP2pTreatedAsOpportunisticAfterTimeout() throws Exception {
+    private void executeDisconnectedP2pTreatedAsOpportunisticAfterTimeout(
+            boolean isFlagMonitorIntentForAllUsersEnabled) throws Exception {
         assumeTrue(SdkLevel.isAtLeastT());
         when(mResources.getInteger(R.integer.config_disconnectedP2pIfaceLowPriorityTimeoutMs))
                 .thenReturn(1);
@@ -933,7 +954,13 @@ public class HalDeviceManagerTest extends WifiBaseTest {
         executeAndValidateStartupSequence();
         ArgumentCaptor<BroadcastReceiver> brCaptor =
                 ArgumentCaptor.forClass(BroadcastReceiver.class);
-        verify(mContext, atLeastOnce()).registerReceiver(brCaptor.capture(), any(), any(), any());
+        if (isFlagMonitorIntentForAllUsersEnabled) {
+            verify(mContext, atLeastOnce()).registerReceiverForAllUsers(
+                    brCaptor.capture(), any(), any(), any());
+        } else {
+            verify(mContext, atLeastOnce()).registerReceiver(
+                    brCaptor.capture(), any(), any(), any());
+        }
 
         // Create STA and P2P interface from privileged app: should succeed.
         WifiInterface staIface = validateInterfaceSequence(chipMock,
diff --git a/service/tests/wifitests/src/com/android/server/wifi/HostapdHalAidlImpTest.java b/service/tests/wifitests/src/com/android/server/wifi/HostapdHalAidlImpTest.java
index 59cf1f6f7e..0d07f196d2 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/HostapdHalAidlImpTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/HostapdHalAidlImpTest.java
@@ -1289,7 +1289,7 @@ public class HostapdHalAidlImpTest extends WifiBaseTest {
 
         // Trigger on failure from first instance again.
         mIHostapdCallback.onFailure(IFACE_NAME, TEST_AP_INSTANCE);
-        verify(mSoftApHalCallback, times(1)).onInstanceFailure(TEST_AP_INSTANCE);
+        verify(mSoftApHalCallback, times(2)).onInstanceFailure(TEST_AP_INSTANCE);
         verify(mSoftApHalCallback, never()).onFailure();
 
     }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/InsecureEapNetworkHandlerTest.java b/service/tests/wifitests/src/com/android/server/wifi/InsecureEapNetworkHandlerTest.java
index 3addabb430..6ab85b0362 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/InsecureEapNetworkHandlerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/InsecureEapNetworkHandlerTest.java
@@ -17,6 +17,7 @@
 package com.android.server.wifi;
 
 import static com.android.server.wifi.InsecureEapNetworkHandler.TOFU_ANONYMOUS_IDENTITY;
+import static com.android.server.wifi.InsecureEapNetworkHandler.createTofuDialogCertInfoList;
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
@@ -49,12 +50,14 @@ import android.os.Handler;
 import android.os.test.TestLooper;
 import android.text.TextUtils;
 import android.text.format.DateFormat;
+import android.util.Pair;
 
 import androidx.test.filters.SmallTest;
 
 import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.util.CertificateSubjectInfo;
+import com.android.wifi.flags.FeatureFlags;
 import com.android.wifi.resources.R;
 
 import org.junit.After;
@@ -322,6 +325,8 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
     @Mock FrameworkFacade mFrameworkFacade;
     @Mock WifiNotificationManager mWifiNotificationManager;
     @Mock WifiDialogManager mWifiDialogManager;
+    @Mock WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
+    @Mock FeatureFlags mFeatureFlags;
     @Mock InsecureEapNetworkHandler.InsecureEapNetworkHandlerCallbacks mCallbacks;
     @Mock(answer = Answers.RETURNS_DEEP_STUBS) private Notification.Builder mNotificationBuilder;
     @Mock private WifiDialogManager.DialogHandle mTofuAlertDialog;
@@ -369,6 +374,50 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
                 anyString()))
                 .thenAnswer((Answer<String>) invocation ->
                         "SHA-256 Fingerprint:\n" + invocation.getArguments()[1] + "\n\n");
+
+        // Updated TOFU dialog strings
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_title)))
+                .thenReturn("wifi_tofu_dialog2_title");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_message)))
+                .thenReturn("wifi_tofu_dialog2_message");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_negative_button)))
+                .thenReturn("wifi_tofu_dialog2_negative_button");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_positive_button)))
+                .thenReturn("wifi_tofu_dialog2_positive_button");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_server_name)))
+                .thenReturn("wifi_tofu_dialog2_list_label_server_name");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_issuer_name)))
+                .thenReturn("wifi_tofu_dialog2_list_label_issuer_name");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_validity_period)))
+                .thenReturn("wifi_tofu_dialog2_list_label_validity_period");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_content_validity_period),
+                any(), any()))
+                .thenReturn("wifi_tofu_dialog2_list_content_validity_period");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_sha256_fingerprint)))
+                .thenReturn("wifi_tofu_dialog2_list_label_sha256_fingerprint");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_sha1_fingerprint)))
+                .thenReturn("wifi_tofu_dialog2_list_label_sha1_fingerprint");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_subject_name_details)))
+                .thenReturn("wifi_tofu_dialog2_list_label_subject_name_details");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_issuer_name_details)))
+                .thenReturn("wifi_tofu_dialog2_list_label_issuer_name_details");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_version)))
+                .thenReturn("wifi_tofu_dialog2_list_label_version");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_serial_number)))
+                .thenReturn("wifi_tofu_dialog2_list_label_serial_number");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_public_key_algorithm)))
+                .thenReturn("wifi_tofu_dialog2_list_label_public_key_algorithm");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_public_key_size)))
+                .thenReturn("wifi_tofu_dialog2_list_label_public_key_size");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_content_public_key_size), any()))
+                .thenReturn("wifi_tofu_dialog2_list_content_public_key_size");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_public_key)))
+                .thenReturn("wifi_tofu_dialog2_list_label_public_key");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_signature_algorithm)))
+                .thenReturn("wifi_tofu_dialog2_list_label_signature_algorithm");
+        when(mContext.getString(eq(R.string.wifi_tofu_dialog2_list_label_signature)))
+                .thenReturn("wifi_tofu_dialog2_list_label_signature");
+
         when(mContext.getWifiOverlayApkPkgName()).thenReturn("test.com.android.wifi.resources");
         when(mContext.getResources()).thenReturn(mResources);
         when(mWifiDialogManager.createLegacySimpleDialogWithUrl(
@@ -377,6 +426,16 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
         when(mWifiDialogManager.createLegacySimpleDialog(
                 any(), any(), any(), any(), any(), any(), any()))
                 .thenReturn(mTofuAlertDialog);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mTofuAlertDialog);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setListItems(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
 
         when(mFrameworkFacade.makeNotificationBuilder(any(), any()))
                 .thenReturn(mNotificationBuilder);
@@ -638,7 +697,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
         mInsecureEapNetworkHandler.addPendingCertificate(config.networkId, 0, mockServerCert);
         verifyTrustOnFirstUseFlow(config, ACTION_ACCEPT, true,
                 true, false, null, mockServerCert.getCert(),
-                null);
+                null, false);
     }
 
     /**
@@ -672,7 +731,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
                 .thenReturn(getCertificate(TEST_GEN_CA2_CERT));
         verifyTrustOnFirstUseFlow(config, ACTION_ACCEPT, true,
                 true, false, mockCaCert.getCert(), mockServerCert.getCert(),
-                WifiConfigurationUtil.getSystemTrustStorePath());
+                WifiConfigurationUtil.getSystemTrustStorePath(), false);
     }
 
     private CertificateEventInfo generateMockCertEventInfo(int type) throws Exception {
@@ -738,6 +797,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
                 mFrameworkFacade,
                 mWifiNotificationManager,
                 mWifiDialogManager,
+                mFeatureFlags,
                 isTrustOnFirstUseSupported,
                 isInsecureEnterpriseConfigurationAllowed,
                 mCallbacks,
@@ -808,7 +868,33 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
 
         verifyTrustOnFirstUseFlow(config, ACTION_ACCEPT, isTrustOnFirstUseSupported,
                 isUserSelected, needUserApproval, mockCaCert.getCert(), mockServerCert.getCert(),
-                null);
+                null, false);
+    }
+
+    /**
+     * Verify Trust On First Use flow with a minimal cert chain using the updated TOFU dialog.
+     * - This network is selected by a user.
+     * - Accept the connection.
+     */
+    @Test
+    public void verifyTrustOnFirstUseAcceptWhenConnectByUserWithMinimalChainUpdatedDialog()
+            throws Exception {
+        assumeTrue(SdkLevel.isAtLeastT());
+        when(mFeatureFlags.updatedTofuDialog()).thenReturn(true);
+        boolean isAtLeastT = true, isTrustOnFirstUseSupported = true, isUserSelected = true;
+        boolean needUserApproval = true;
+
+        WifiConfiguration config = prepareWifiConfiguration(isAtLeastT);
+        setupTest(config, isAtLeastT, isTrustOnFirstUseSupported);
+
+        CertificateEventInfo mockCaCert = generateMockCertEventInfo(TEST_GEN_CA_CERT);
+        CertificateEventInfo mockServerCert = generateMockCertEventInfo(TEST_GEN_SERVER_CERT);
+        mInsecureEapNetworkHandler.addPendingCertificate(config.networkId, 1, mockCaCert);
+        mInsecureEapNetworkHandler.addPendingCertificate(config.networkId, 0, mockServerCert);
+
+        verifyTrustOnFirstUseFlow(config, ACTION_ACCEPT, isTrustOnFirstUseSupported,
+                isUserSelected, needUserApproval, mockCaCert.getCert(), mockServerCert.getCert(),
+                null, true);
     }
 
     /**
@@ -832,7 +918,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
 
         verifyTrustOnFirstUseFlow(config, ACTION_FORGET, isTrustOnFirstUseSupported,
                 isUserSelected, needUserApproval, mockSelfSignedCert.getCert(),
-                mockSelfSignedCert.getCert(), null);
+                mockSelfSignedCert.getCert(), null, false);
     }
 
     /**
@@ -998,6 +1084,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
                 mFrameworkFacade,
                 mWifiNotificationManager,
                 mWifiDialogManager,
+                mFeatureFlags,
                 true /* isTrustOnFirstUseSupported */,
                 false /* isInsecureEnterpriseConfigurationAllowed */,
                 mCallbacks,
@@ -1074,25 +1161,40 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
         }
         verifyTrustOnFirstUseFlow(config, action, isTrustOnFirstUseSupported,
                 isUserSelected, needUserApproval, mockCaCert.getCert(), mockServerCert.getCert(),
-                null);
+                null, false);
     }
 
     private void verifyTrustOnFirstUseFlow(WifiConfiguration config,
             int action, boolean isTrustOnFirstUseSupported, boolean isUserSelected,
             boolean needUserApproval, X509Certificate expectedCaCert,
-            X509Certificate expectedServerCert, String expectedCaPath) throws Exception {
+            X509Certificate expectedServerCert, String expectedCaPath,
+            boolean useUpdatedTofuDialog) throws Exception {
         mInsecureEapNetworkHandler.startUserApprovalIfNecessary(isUserSelected);
 
         ArgumentCaptor<String> dialogMessageCaptor = ArgumentCaptor.forClass(String.class);
         if (isUserSelected) {
             ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                     ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-            verify(mWifiDialogManager).createLegacySimpleDialogWithUrl(
-                    any(), dialogMessageCaptor.capture(), any(), anyInt(), anyInt(), any(), any(),
-                    any(), dialogCallbackCaptor.capture(), any());
+            ArgumentCaptor<List<Pair<String, String>>> dialogListCaptor =
+                    ArgumentCaptor.forClass(List.class);
+
+            if (useUpdatedTofuDialog) {
+                verify(mWifiDialogManager).createSimpleDialogBuilder();
+                verify(mDialogBuilder).setListItems(dialogListCaptor.capture());
+                verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
+            } else {
+                verify(mWifiDialogManager).createLegacySimpleDialogWithUrl(
+                        any(), dialogMessageCaptor.capture(), any(), anyInt(), anyInt(), any(),
+                        any(), any(), dialogCallbackCaptor.capture(), any());
+            }
             if (isTrustOnFirstUseSupported) {
-                assertTofuDialogMessage(expectedServerCert,
-                        dialogMessageCaptor.getValue());
+                if (useUpdatedTofuDialog) {
+                    assertEquals(createTofuDialogCertInfoList(mContext, expectedServerCert),
+                            dialogListCaptor.getValue());
+                } else {
+                    assertTofuDialogMessage(expectedServerCert,
+                            dialogMessageCaptor.getValue());
+                }
             }
             if (action == ACTION_ACCEPT) {
                 dialogCallbackCaptor.getValue().onPositiveButtonClicked();
@@ -1255,6 +1357,7 @@ public class InsecureEapNetworkHandlerTest extends WifiBaseTest {
                 mFrameworkFacade,
                 mWifiNotificationManager,
                 mWifiDialogManager,
+                mFeatureFlags,
                 true,
                 false,
                 mCallbacks,
diff --git a/service/tests/wifitests/src/com/android/server/wifi/InterfaceConflictManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/InterfaceConflictManagerTest.java
index 3e303b4a10..996d030d0b 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/InterfaceConflictManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/InterfaceConflictManagerTest.java
@@ -24,12 +24,13 @@ import static com.android.server.wifi.HalDeviceManager.HDM_CREATE_IFACE_P2P;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertTrue;
-import static org.mockito.ArgumentMatchers.eq;
 import static org.mockito.ArgumentMatchers.any;
 import static org.mockito.ArgumentMatchers.anyInt;
+import static org.mockito.ArgumentMatchers.eq;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
 import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.verifyNoMoreInteractions;
 import static org.mockito.Mockito.when;
 
 import android.content.BroadcastReceiver;
@@ -40,7 +41,6 @@ import android.net.ConnectivityManager;
 import android.net.NetworkInfo;
 import android.net.wifi.WifiContext;
 import android.net.wifi.p2p.WifiP2pManager;
-import android.os.Handler;
 import android.os.Message;
 import android.os.WorkSource;
 import android.os.test.TestLooper;
@@ -54,14 +54,17 @@ import com.android.internal.util.State;
 import com.android.internal.util.StateMachine;
 import com.android.server.wifi.util.WaitingState;
 import com.android.server.wifi.util.WorkSourceHelper;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.ArgumentCaptor;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
 import org.mockito.MockitoSession;
+import org.mockito.quality.Strictness;
 
 import java.util.Arrays;
 import java.util.Collections;
@@ -73,16 +76,19 @@ import java.util.Collections;
 public class InterfaceConflictManagerTest extends WifiBaseTest{
     private TestLooper mTestLooper;
     private InterfaceConflictManager mDut;
+    private MockitoSession mSession;
 
     @Mock WifiInjector mWifiInjector;
     @Mock WifiContext mWifiContext;
     @Mock Resources mResources;
     @Mock FrameworkFacade mFrameworkFacade;
     @Mock HalDeviceManager mHdm;
+    @Mock WifiThreadRunner mWifiThreadRunner;
     @Mock StateMachine mStateMachine;
     @Mock State mTargetState;
     @Mock WaitingState mWaitingState;
     @Mock WifiDialogManager mWifiDialogManager;
+    @Mock WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
     @Mock WifiDialogManager.DialogHandle mDialogHandle;
     @Mock LocalLog mLocalLog;
     @Mock WorkSourceHelper mWsHelper;
@@ -97,6 +103,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
     private static final String EXISTING_APP_NAME = "Existing App Name";
     private static final WorkSource EXISTING_WS =
             new WorkSource(EXISTING_UID, EXISTING_PACKAGE_NAME);
+    private static final int TEST_DIALOG_TIMEOUT_SECONDS = 300;
 
     ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> mCallbackCaptor =
             ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
@@ -107,19 +114,32 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
     @Before
     public void setup() throws Exception {
         MockitoAnnotations.initMocks(this);
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class)
+                .strictness(Strictness.LENIENT)
+                .startMocking();
         mTestLooper = new TestLooper();
 
         // enable user approval (needed for most tests)
         when(mWifiContext.getResources()).thenReturn(mResources);
         when(mResources.getBoolean(
                 R.bool.config_wifiUserApprovalRequiredForD2dInterfacePriority)).thenReturn(true);
+        when(mResources.getInteger(R.integer.config_wifiUserApprovalForD2dTimeoutSeconds))
+                .thenReturn(TEST_DIALOG_TIMEOUT_SECONDS);
 
         when(mFrameworkFacade.getAppName(any(), eq(TEST_PACKAGE_NAME), anyInt()))
                 .thenReturn(TEST_APP_NAME);
         when(mFrameworkFacade.getAppName(any(), eq(EXISTING_PACKAGE_NAME), anyInt()))
                 .thenReturn(EXISTING_APP_NAME);
-        when(mWifiDialogManager.createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any())).thenReturn(mDialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
 
         when(mWifiInjector.makeWsHelper(eq(TEST_WS))).thenReturn(mWsHelper);
         when(mWifiInjector.makeWsHelper(eq(EXISTING_WS))).thenReturn(mExistingWsHelper);
@@ -131,10 +151,14 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
         when(mExistingWsHelper.getWorkSource()).thenReturn(EXISTING_WS);
     }
 
+    @After
+    public void cleanUp() {
+        mSession.finishMocking();
+    }
+
     private void initInterfaceConflictManager() {
         mDut = new InterfaceConflictManager(mWifiInjector, mWifiContext, mFrameworkFacade, mHdm,
-                new WifiThreadRunner(new Handler(mTestLooper.getLooper())), mWifiDialogManager,
-                mLocalLog);
+                mWifiThreadRunner, mWifiDialogManager, mLocalLog);
         mDut.enableVerboseLogging(true);
         mDut.handleBootCompleted();
     }
@@ -156,8 +180,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         HalDeviceManager.HDM_CREATE_IFACE_NAN, TEST_WS, false));
 
         verify(mStateMachine, never()).transitionTo(mWaitingState);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
     }
 
@@ -179,8 +202,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         HalDeviceManager.HDM_CREATE_IFACE_NAN, TEST_WS, false));
 
         verify(mStateMachine, never()).transitionTo(mWaitingState);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
     }
 
@@ -197,8 +219,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         HalDeviceManager.HDM_CREATE_IFACE_NAN, TEST_WS, true));
 
         verify(mStateMachine, never()).transitionTo(mWaitingState);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
     }
 
@@ -222,8 +243,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine, never()).transitionTo(mWaitingState);
         verify(mStateMachine, never()).deferMessage(msg);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
 
         // can create interface w/o side effects
@@ -235,8 +255,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine, never()).transitionTo(mWaitingState);
         verify(mStateMachine, never()).deferMessage(msg);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
     }
 
@@ -261,8 +280,8 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine).transitionTo(mWaitingState);
         verify(mStateMachine).deferMessage(msg);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), mCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setCallback(mCallbackCaptor.capture(), any());
         verify(mDialogHandle).launchDialog();
 
         // user approve
@@ -275,8 +294,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
         verify(mDialogHandle, times(1)).launchDialog();
     }
 
@@ -301,8 +318,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine).transitionTo(mWaitingState);
         verify(mStateMachine).deferMessage(msg);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), mCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(mCallbackCaptor.capture(), any());
         verify(mDialogHandle).launchDialog();
 
         // user rejects
@@ -315,8 +331,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
         verify(mDialogHandle, times(1)).launchDialog();
     }
 
@@ -340,9 +354,8 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), mCallbackCaptor.capture(), any());
-        verify(mDialogHandle, times(1)).launchDialog();
+        verify(mDialogBuilder).setCallback(mCallbackCaptor.capture(), any());
+        verify(mDialogHandle).launchDialog();
 
         // user approve
         mCallbackCaptor.getValue().onPositiveButtonClicked();
@@ -354,9 +367,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
-        verify(mDialogHandle, times(1)).launchDialog();
 
         // Proceed with all deferred messages, since the created iface satisfies the request now.
         when(mHdm.reportImpactToCreateIface(eq(interfaceType), eq(false), eq(TEST_WS))).thenReturn(
@@ -376,8 +386,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                             false));
             verify(mStateMachine, times(1)).transitionTo(mWaitingState);
             verify(mStateMachine, never()).deferMessage(waitingMsg);
-            verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                    any(), any(), any(), any(), any(), any(), any());
             verify(mDialogHandle, times(1)).launchDialog();
 
             // Unexpected impact to create, launch the dialog again
@@ -390,8 +398,8 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                             false));
             verify(mStateMachine, times(2)).transitionTo(mWaitingState);
             verify(mStateMachine, times(1)).deferMessage(waitingMsg);
-            verify(mWifiDialogManager, times(2)).createSimpleDialog(
-                    any(), any(), any(), any(), any(), any(), any());
+            verify(mWifiDialogManager, times(2))
+                    .createSimpleDialogBuilder();
             verify(mDialogHandle, times(2)).launchDialog();
         } finally {
             session.finishMocking();
@@ -418,9 +426,8 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), mCallbackCaptor.capture(), any());
-        verify(mDialogHandle, times(1)).launchDialog();
+        verify(mDialogBuilder).setCallback(mCallbackCaptor.capture(), any());
+        verify(mDialogHandle).launchDialog();
 
         // user rejects
         mCallbackCaptor.getValue().onNegativeButtonClicked();
@@ -432,8 +439,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mWaitingState, mTargetState, interfaceType, TEST_WS, false));
         verify(mStateMachine, times(1)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(msg);
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
         verify(mDialogHandle, times(1)).launchDialog();
 
         // Reject all deferred messages
@@ -457,8 +462,6 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                             false));
             verify(mStateMachine, times(1)).transitionTo(mWaitingState);
             verify(mStateMachine, never()).deferMessage(waitingMsg);
-            verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                    any(), any(), any(), any(), any(), any(), any());
             verify(mDialogHandle, times(1)).launchDialog();
         } finally {
             session.finishMocking();
@@ -498,10 +501,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         mStateMachine, mWaitingState, mTargetState,
                         interfaceType, TEST_WS, false));
         verify(mStateMachine, never()).transitionTo(mWaitingState);
-        verify(mStateMachine, never()).deferMessage(msg);
-        verify(mWifiDialogManager, never()).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
-        verify(mDialogHandle, never()).launchDialog();
+        verifyNoMoreInteractions(mWifiDialogManager, mDialogBuilder, mDialogHandle);
     }
 
     @Test
@@ -538,8 +538,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine).transitionTo(mWaitingState);
         verify(mStateMachine).deferMessage(msg);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
         verify(mDialogHandle).launchDialog();
     }
 
@@ -565,8 +564,7 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine).transitionTo(mWaitingState);
         verify(mStateMachine).deferMessage(msg);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
         verify(mDialogHandle).launchDialog();
 
         // reset
@@ -584,11 +582,98 @@ public class InterfaceConflictManagerTest extends WifiBaseTest{
                         interfaceType, TEST_WS, false));
         verify(mStateMachine, times(2)).transitionTo(mWaitingState);
         verify(mStateMachine, times(1)).deferMessage(newMsg);
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any());
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
         verify(mDialogHandle, times(2)).launchDialog();
     }
 
+    /**
+     * Verify that the interface conflict dialog will cancel after the specified timeout, transition
+     * the waiting state machine to their target state, and reset InterfaceConflictManager to accept
+     * new requests.
+     */
+    @Test
+    public void testDialogTimeout() {
+        when(Flags.icmDialogTimeout()).thenReturn(true);
+        initInterfaceConflictManager();
+
+        int interfaceType = HalDeviceManager.HDM_CREATE_IFACE_P2P;
+        Message msg = Message.obtain();
+
+        // can create interface - but with side effects
+        when(mHdm.reportImpactToCreateIface(eq(interfaceType), eq(false), eq(TEST_WS))).thenReturn(
+                Arrays.asList(Pair.create(HalDeviceManager.HDM_CREATE_IFACE_NAN, EXISTING_WS)));
+
+        // send request
+        assertEquals(InterfaceConflictManager.ICM_SKIP_COMMAND_WAIT_FOR_USER,
+                mDut.manageInterfaceConflictForStateMachine("Some Tag", msg,
+                        mStateMachine, mWaitingState, mTargetState,
+                        interfaceType, TEST_WS, false));
+        verify(mStateMachine).transitionTo(mWaitingState);
+        verify(mStateMachine).deferMessage(msg);
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogHandle).launchDialog();
+        ArgumentCaptor<Runnable> runnableCaptor = ArgumentCaptor.forClass(Runnable.class);
+        verify(mWifiThreadRunner).postDelayed(runnableCaptor.capture(),
+                eq((long) TEST_DIALOG_TIMEOUT_SECONDS * 1000), any(), any());
+
+        // Emulate the dialog timing out.
+        runnableCaptor.getValue().run();
+
+        // State machine should have gone back to target
+        verify(mWaitingState).sendTransitionStateCommand(mTargetState);
+        // Dialog should have been dismissed
+        verify(mDialogHandle).dismissDialog();
+        // New request should launch dialog like normal.
+        Message newMsg = Message.obtain();
+        assertEquals(InterfaceConflictManager.ICM_SKIP_COMMAND_WAIT_FOR_USER,
+                mDut.manageInterfaceConflictForStateMachine("Some Tag", newMsg,
+                        mStateMachine, mWaitingState, mTargetState,
+                        interfaceType, TEST_WS, false));
+        verify(mStateMachine, times(2)).transitionTo(mWaitingState);
+        verify(mStateMachine, times(1)).deferMessage(newMsg);
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
+        verify(mDialogHandle, times(2)).launchDialog();
+    }
+
+    /**
+     * Verify that the interface conflict dialog timeout will be cleared if we get a response from
+     * the dialog.
+     */
+    @Test
+    public void testDialogTimeoutCancelled() {
+        when(Flags.icmDialogTimeout()).thenReturn(true);
+        initInterfaceConflictManager();
+
+        int interfaceType = HalDeviceManager.HDM_CREATE_IFACE_P2P;
+        Message msg = Message.obtain();
+
+        // can create interface - but with side effects
+        when(mHdm.reportImpactToCreateIface(eq(interfaceType), eq(false), eq(TEST_WS))).thenReturn(
+                Arrays.asList(Pair.create(HalDeviceManager.HDM_CREATE_IFACE_NAN, EXISTING_WS)));
+
+        // send request
+        assertEquals(InterfaceConflictManager.ICM_SKIP_COMMAND_WAIT_FOR_USER,
+                mDut.manageInterfaceConflictForStateMachine("Some Tag", msg,
+                        mStateMachine, mWaitingState, mTargetState,
+                        interfaceType, TEST_WS, false));
+        verify(mStateMachine).transitionTo(mWaitingState);
+        verify(mStateMachine).deferMessage(msg);
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
+                ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
+        verify(mDialogHandle).launchDialog();
+        ArgumentCaptor<Runnable> runnableCaptor = ArgumentCaptor.forClass(Runnable.class);
+        verify(mWifiThreadRunner).postDelayed(runnableCaptor.capture(),
+                eq((long) TEST_DIALOG_TIMEOUT_SECONDS * 1000), any(), any());
+
+        // Cancel the timeout by replying to the dialog.
+        dialogCallbackCaptor.getValue().onPositiveButtonClicked();
+
+        // State machine should have gone back to target
+        verify(mWifiThreadRunner).removeCallbacks(runnableCaptor.getValue());
+    }
+
     /**
      * Tests that
      * {@link InterfaceConflictManager#needsUserApprovalToDelete(int, WorkSourceHelper, int,
diff --git a/service/tests/wifitests/src/com/android/server/wifi/NetworkListStoreDataTest.java b/service/tests/wifitests/src/com/android/server/wifi/NetworkListStoreDataTest.java
index 06384c3138..c7fbee8c35 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/NetworkListStoreDataTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/NetworkListStoreDataTest.java
@@ -40,6 +40,7 @@ import android.net.MacAddress;
 import android.net.wifi.SecurityParams;
 import android.net.wifi.WifiConfiguration;
 import android.net.wifi.WifiEnterpriseConfig;
+import android.net.wifi.util.Environment;
 import android.net.wifi.util.ScanResultUtil;
 import android.util.Xml;
 
@@ -104,6 +105,7 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"0\" />\n"
@@ -195,6 +197,7 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"3\" />\n"
@@ -320,6 +323,7 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"4\" />\n"
@@ -403,6 +407,7 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"3\" />\n"
@@ -530,6 +535,7 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<boolean name=\"Trusted\" value=\"true\" />\n"
                     + "<null name=\"BSSID\" />\n"
                     + "<int name=\"Status\" value=\"2\" />\n"
@@ -681,19 +687,25 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         String openNetworkXml = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress());
         String eapNetworkXml = String.format(SINGLE_EAP_NETWORK_DATA_XML_STRING_FORMAT,
                 eapNetwork.getKey().replaceAll("\"", "&quot;"),
                 eapNetwork.SSID.replaceAll("\"", "&quot;"),
-                eapNetwork.shared, eapNetwork.creatorUid,
+                eapNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                eapNetwork.creatorUid,
                 eapNetwork.creatorName, eapNetwork.getRandomizedMacAddress(),
                 eapNetwork.enterpriseConfig.getDomainSuffixMatch(),
                 eapNetwork.enterpriseConfig.getCaPath());
         String saeNetworkXml = String.format(SINGLE_SAE_NETWORK_DATA_XML_STRING_FORMAT,
                 saeNetwork.getKey().replaceAll("\"", "&quot;"),
                 saeNetwork.SSID.replaceAll("\"", "&quot;"),
-                saeNetwork.shared, saeNetwork.creatorUid,
+                saeNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                saeNetwork.creatorUid,
                 saeNetwork.creatorName, saeNetwork.getRandomizedMacAddress());
         return (openNetworkXml + eapNetworkXml + saeNetworkXml).getBytes(StandardCharsets.UTF_8);
     }
@@ -852,7 +864,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         byte[] xmlData = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 "InvalidConfigKey",
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress())
             .getBytes(StandardCharsets.UTF_8);
         deserializeData(xmlData);
@@ -898,7 +912,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         byte[] xmlData = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress())
             .getBytes(StandardCharsets.UTF_8);
         List<WifiConfiguration> deserializedNetworks = deserializeData(xmlData);
@@ -926,7 +942,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         byte[] xmlData = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress())
             .getBytes(StandardCharsets.UTF_8);
         List<WifiConfiguration> deserializedNetworks = deserializeData(xmlData);
@@ -953,7 +971,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         byte[] xmlData = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress())
             .getBytes(StandardCharsets.UTF_8);
         List<WifiConfiguration> deserializedNetworks = deserializeData(xmlData);
@@ -974,7 +994,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         byte[] xmlData = String.format(SINGLE_OPEN_NETWORK_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid,
                 openNetwork.creatorName, openNetwork.getRandomizedMacAddress())
             .getBytes(StandardCharsets.UTF_8);
         List<WifiConfiguration> deserializedNetworks = deserializeData(xmlData);
@@ -1000,7 +1022,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
         String saeNetworkWithOpenAuthXml = String.format(SINGLE_SAE_NETWORK_DATA_XML_STRING_FORMAT,
                 saeNetwork.getKey().replaceAll("\"", "&quot;"),
                 saeNetwork.SSID.replaceAll("\"", "&quot;"),
-                saeNetwork.shared, saeNetwork.creatorUid,
+                saeNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                saeNetwork.creatorUid,
                 saeNetwork.creatorName, saeNetwork.getRandomizedMacAddress());
 
         List<WifiConfiguration> retrievedNetworkList =
@@ -1060,7 +1084,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                 invalidConfigKey,
                 pskNetwork.SSID.replaceAll("\"", "&quot;"),
                 pskNetwork.preSharedKey.replaceAll("\"", "&quot;"),
-                pskNetwork.shared, pskNetwork.creatorUid,
+                pskNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                pskNetwork.creatorUid,
                 pskNetwork.creatorName, pskNetwork.getRandomizedMacAddress())
                 .getBytes(StandardCharsets.UTF_8);
         List<WifiConfiguration> deserializedNetworks = deserializeData(xmlData);
@@ -1081,7 +1107,9 @@ public class NetworkListStoreDataTest extends WifiBaseTest {
                 SINGLE_LEGACY_WPA3_EAP_NETWORK_DATA_XML_STRING_FORMAT,
                 malformedNetworkKey.replaceAll("\"", "&quot;"),
                 wpa3EapNetwork.SSID.replaceAll("\"", "&quot;"),
-                wpa3EapNetwork.shared, wpa3EapNetwork.creatorUid,
+                wpa3EapNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                wpa3EapNetwork.creatorUid,
                 wpa3EapNetwork.creatorName, wpa3EapNetwork.getRandomizedMacAddress(),
                 wpa3EapNetwork.enterpriseConfig.getDomainSuffixMatch(),
                 wpa3EapNetwork.enterpriseConfig.getCaPath())
diff --git a/service/tests/wifitests/src/com/android/server/wifi/SarManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/SarManagerTest.java
index fe582e3521..ae19574a9a 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/SarManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/SarManagerTest.java
@@ -23,7 +23,10 @@ import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertNotNull;
 import static org.junit.Assert.assertTrue;
 import static org.mockito.Mockito.*;
+import static org.mockito.Mockito.validateMockitoUsage;
+import static org.mockito.Mockito.withSettings;
 
+import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.pm.ApplicationInfo;
 import android.net.wifi.WifiManager;
@@ -35,6 +38,8 @@ import android.telephony.TelephonyManager;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import org.junit.After;
@@ -44,6 +49,7 @@ import org.mockito.ArgumentCaptor;
 import org.mockito.InOrder;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 
 /**
  * unit tests for {@link com.android.server.wifi.SarManager}.
@@ -67,6 +73,7 @@ public class SarManagerTest extends WifiBaseTest {
     private MockResources mResources;
     private PhoneStateListener mPhoneStateListener;
     private SarInfo mSarInfo;
+    private MockitoSession mSession;
 
     @Mock private Context mContext;
     @Mock TelephonyManager mTelephonyManager;
@@ -81,6 +88,9 @@ public class SarManagerTest extends WifiBaseTest {
         mLooper = new TestLooper();
 
         MockitoAnnotations.initMocks(this);
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .startMocking();
 
         /* Default behavior is to return with success */
         when(mWifiNative.selectTxPowerScenario(any(SarInfo.class))).thenReturn(true);
@@ -100,6 +110,10 @@ public class SarManagerTest extends WifiBaseTest {
         mLooper = null;
         mContext = null;
         mResources = null;
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
     }
 
     /**
@@ -147,6 +161,17 @@ public class SarManagerTest extends WifiBaseTest {
         enableDebugLogs();
     }
 
+    @Test
+    public void testRegisterReceiverForAllUsersWhenFlagOn() throws Exception {
+        when(Flags.monitorIntentForAllUsers()).thenReturn(true);
+        createSarManager(true, false);
+        mLooper.dispatchAll();
+        verify(mContext).registerReceiverForAllUsers(any(BroadcastReceiver.class),
+                argThat(filter -> filter.hasAction(SarManager.STREAM_DEVICES_CHANGED_ACTION)),
+                eq(null), any());
+    }
+
+
     /**
      * Test that we do register the telephony call state listener on devices which do support
      * setting/resetting Tx power limit.
diff --git a/service/tests/wifitests/src/com/android/server/wifi/SoftApStoreDataTest.java b/service/tests/wifitests/src/com/android/server/wifi/SoftApStoreDataTest.java
index ebb0c67ecb..e1ca6d019f 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/SoftApStoreDataTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/SoftApStoreDataTest.java
@@ -118,6 +118,7 @@ public class SoftApStoreDataTest extends WifiBaseTest {
     private static final boolean TEST_USER_CONFIGURATION = false;
     // Use non default value true as test data
     private static final boolean TEST_CLIENT_ISOLATION = true;
+    private static final boolean TEST_BAND_OPTIMIZATION = false;
     private static final String TEST_TWO_VENDOR_ELEMENTS_HEX = "DD04AABBCCDDDD0401020304";
     private static final int TEST_MAX_CHANNEL_WIDTH = SoftApInfo.CHANNEL_WIDTH_40MHZ;
     private MockitoSession mSession;
@@ -300,6 +301,12 @@ public class SoftApStoreDataTest extends WifiBaseTest {
                     + "<boolean name=\"ClientIsolation\" value=\""
                     + TEST_CLIENT_ISOLATION + "\" />\n";
 
+    // TODO: Rename it once SDK name & version is lock
+    private static final String TEST_CONFIG_STRING_WITH_ALL_CONFIG_NEWER_THAN_B =
+            TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_B
+                    + "<boolean name=\"BandOptimization\" value=\""
+                    + TEST_BAND_OPTIMIZATION + "\" />\n";
+
     @Mock private Context mContext;
     @Mock SoftApStoreData.DataSource mDataSource;
     @Mock private WifiMigration.SettingsMigrationData mOemMigrationData;
@@ -339,6 +346,7 @@ public class SoftApStoreDataTest extends WifiBaseTest {
         when(Flags.softapConfigStoreMaxChannelWidth()).thenReturn(false);
         // Default flag is enabled.
         when(Flags.apIsolate()).thenReturn(true);
+        when(Flags.bandOptimizationControl()).thenReturn(true);
     }
 
     /**
@@ -449,9 +457,14 @@ public class SoftApStoreDataTest extends WifiBaseTest {
         if (Environment.isSdkAtLeastB()) {
             softApConfigBuilder.setClientIsolationEnabled(TEST_CLIENT_ISOLATION);
         }
+        if (Environment.isSdkNewerThanB()) {
+            softApConfigBuilder.setBandOptimizationEnabled(TEST_BAND_OPTIMIZATION);
+        }
         when(mDataSource.toSerialize()).thenReturn(softApConfigBuilder.build());
         byte[] actualData = serializeData();
-        if (Environment.isSdkAtLeastB()) {
+        if (Environment.isSdkNewerThanB()) {
+            assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_NEWER_THAN_B, new String(actualData));
+        } else if (Environment.isSdkAtLeastB()) {
             assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_B, new String(actualData));
         } else if (SdkLevel.isAtLeastT()) {
             assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_T, new String(actualData));
@@ -504,9 +517,14 @@ public class SoftApStoreDataTest extends WifiBaseTest {
         if (Environment.isSdkAtLeastB()) {
             softApConfigBuilder.setClientIsolationEnabled(TEST_CLIENT_ISOLATION);
         }
+        if (Environment.isSdkNewerThanB()) {
+            softApConfigBuilder.setBandOptimizationEnabled(TEST_BAND_OPTIMIZATION);
+        }
         when(mDataSource.toSerialize()).thenReturn(softApConfigBuilder.build());
         byte[] actualData = serializeData();
-        if (Environment.isSdkAtLeastB()) {
+        if (Environment.isSdkNewerThanB()) {
+            assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_NEWER_THAN_B, new String(actualData));
+        } else if (Environment.isSdkAtLeastB()) {
             assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_B, new String(actualData));
         } else if (SdkLevel.isAtLeastT()) {
             assertEquals(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_T, new String(actualData));
@@ -525,7 +543,9 @@ public class SoftApStoreDataTest extends WifiBaseTest {
      */
     @Test
     public void deserializeSoftAp() throws Exception {
-        if (Environment.isSdkAtLeastB()) {
+        if (Environment.isSdkNewerThanB()) {
+            deserializeData(TEST_CONFIG_STRING_WITH_ALL_CONFIG_NEWER_THAN_B.getBytes());
+        } else if (Environment.isSdkAtLeastB()) {
             deserializeData(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_B.getBytes());
         } else if (SdkLevel.isAtLeastT()) {
             deserializeData(TEST_CONFIG_STRING_WITH_ALL_CONFIG_IN_T.getBytes());
@@ -962,7 +982,7 @@ public class SoftApStoreDataTest extends WifiBaseTest {
      * @throws Exception when test fails it throws exception
      */
     @Test
-    public void testSerializeDeserializeSoftApWhenClientIsolationFalgDisabled() throws Exception {
+    public void testSerializeDeserializeSoftApWhenClientIsolationFlagDisabled() throws Exception {
         assumeTrue(Environment.isSdkAtLeastB());
         when(Flags.apIsolate()).thenReturn(false);
         SoftApConfiguration testSoftApConfig =
@@ -982,4 +1002,31 @@ public class SoftApStoreDataTest extends WifiBaseTest {
         // Keep default value false which does NOT equals test data (true)
         assertNotEquals(TEST_CLIENT_ISOLATION, softApConfig.isClientIsolationEnabled());
     }
+
+    /**
+     * Verify that the store data is serialized/deserialized when band optimization is disabled.
+     *
+     * @throws Exception when test fails it throws exception
+     */
+    @Test
+    public void testSerializeDeserializeSoftApWhenBandOptimizationFlagDisabled() throws Exception {
+        assumeTrue(Environment.isSdkNewerThanB());
+        when(Flags.bandOptimizationControl()).thenReturn(false);
+        SoftApConfiguration testSoftApConfig =
+                new SoftApConfiguration.Builder().setSsid(TEST_SSID)
+                .setBandOptimizationEnabled(TEST_BAND_OPTIMIZATION).build();
+        when(mDataSource.toSerialize()).thenReturn(testSoftApConfig);
+        byte[] actualData = serializeData();
+        String serializeDataString = new String(actualData);
+        assertFalse(serializeDataString.contains(
+                XmlUtil.SoftApConfigurationXmlUtil.XML_TAG_BAND_OPTIMIZATION));
+        deserializeData(TEST_CONFIG_STRING_WITH_ALL_CONFIG_NEWER_THAN_B.getBytes());
+        ArgumentCaptor<SoftApConfiguration> softapConfigCaptor =
+                ArgumentCaptor.forClass(SoftApConfiguration.class);
+        verify(mDataSource).fromDeserialized(softapConfigCaptor.capture());
+        SoftApConfiguration softApConfig = softapConfigCaptor.getValue();
+        assertNotNull(softApConfig);
+        // Keep default value false which does NOT equals test data (false)
+        assertNotEquals(TEST_BAND_OPTIMIZATION, softApConfig.isBandOptimizationEnabled());
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/SupplicantStaIfaceHalAidlImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/SupplicantStaIfaceHalAidlImplTest.java
index 28f4ea7939..85e6c27fe7 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/SupplicantStaIfaceHalAidlImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/SupplicantStaIfaceHalAidlImplTest.java
@@ -3460,4 +3460,35 @@ public class SupplicantStaIfaceHalAidlImplTest extends WifiBaseTest {
                 WifiMigration.KEYSTORE_MIGRATION_SUCCESS_MIGRATION_COMPLETE);
         assertTrue(mDut.mHasMigratedLegacyKeystoreAliases);
     }
+
+    /**
+     * Test that onDisconnected() event during the TOFU user notification doesn't send
+     * a broadcast authentication failure event.
+     */
+    @Test
+    public void testOnDisconnectedDuringTofuUserNotificationDoesntTriggerAuthFailure()
+            throws Exception {
+        WifiConfiguration config = new WifiConfiguration();
+        config.networkId = 1;
+        config.setSecurityParams(WifiConfiguration.SECURITY_TYPE_EAP);
+        config.getNetworkSelectionStatus().setCandidateSecurityParams(
+                SecurityParams.createSecurityParamsBySecurityType(
+                        WifiConfiguration.SECURITY_TYPE_EAP));
+        config.enterpriseConfig.enableTrustOnFirstUse(true);
+        setupMocksForConnectSequence(false);
+        executeAndValidateInitializationSequence();
+        assertTrue(mDut.connectToNetwork(WLAN0_IFACE_NAME, config));
+
+        mISupplicantStaIfaceCallback.onStateChanged(
+                StaIfaceCallbackState.ASSOCIATED,
+                NativeUtil.macAddressToByteArray(BSSID),
+                SUPPLICANT_NETWORK_ID,
+                NativeUtil.byteArrayFromArrayList(NativeUtil.decodeSsid(SUPPLICANT_SSID)), false);
+        mISupplicantStaIfaceCallback.onDisconnected(
+                NativeUtil.macAddressToByteArray(BSSID), true, 3);
+        verify(mWifiMonitor, never())
+                .broadcastAuthenticationFailureEvent(any(), anyInt(), anyInt(), any(), any());
+        verify(mWifiMonitor).broadcastNetworkDisconnectionEvent(
+                eq(WLAN0_IFACE_NAME), eq(true), eq(3), any(), eq(BSSID));
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/SupplicantStateTrackerTest.java b/service/tests/wifitests/src/com/android/server/wifi/SupplicantStateTrackerTest.java
index 39a0e26ea6..46f3ccf521 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/SupplicantStateTrackerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/SupplicantStateTrackerTest.java
@@ -21,6 +21,7 @@ import static org.mockito.Mockito.*;
 
 import android.content.Context;
 import android.content.Intent;
+import android.net.MacAddress;
 import android.net.wifi.SupplicantState;
 import android.net.wifi.WifiManager;
 import android.net.wifi.WifiSsid;
@@ -115,7 +116,6 @@ public class SupplicantStateTrackerTest extends WifiBaseTest {
     public void testAuthPassInSupplicantStateChangeIntent() {
         mSupplicantStateTracker.sendMessage(getSupplicantStateChangeMessage(0, WIFI_SSID,
                 BSSID, SupplicantState.AUTHENTICATING));
-        mSupplicantStateTracker.sendMessage(WifiMonitor.AUTHENTICATION_FAILURE_EVENT);
         mLooper.dispatchAll();
 
         verify(mBroadcastQueue).queueOrSendBroadcast(
@@ -135,7 +135,9 @@ public class SupplicantStateTrackerTest extends WifiBaseTest {
      */
     @Test
     public void testAuthFailedInSupplicantStateChangeIntent() {
-        mSupplicantStateTracker.sendMessage(WifiMonitor.AUTHENTICATION_FAILURE_EVENT);
+        mSupplicantStateTracker.sendMessage(WifiMonitor.AUTHENTICATION_FAILURE_EVENT,
+                new AuthenticationFailureEventInfo(SSID, MacAddress.fromString(BSSID),
+                        WifiManager.ERROR_AUTH_FAILURE_EAP_FAILURE, 2));
         mSupplicantStateTracker.sendMessage(getSupplicantStateChangeMessage(0, WIFI_SSID,
                 BSSID, SupplicantState.AUTHENTICATING));
         mLooper.dispatchAll();
@@ -160,7 +162,8 @@ public class SupplicantStateTrackerTest extends WifiBaseTest {
     @Test
     public void testReasonCodeInSupplicantStateChangeIntent() {
         mSupplicantStateTracker.sendMessage(WifiMonitor.AUTHENTICATION_FAILURE_EVENT,
-                WifiManager.ERROR_AUTH_FAILURE_WRONG_PSWD, -1);
+                new AuthenticationFailureEventInfo(SSID, MacAddress.fromString(BSSID),
+                        WifiManager.ERROR_AUTH_FAILURE_WRONG_PSWD, -1));
         mSupplicantStateTracker.sendMessage(getSupplicantStateChangeMessage(0, WIFI_SSID,
                 BSSID, SupplicantState.AUTHENTICATING));
         mLooper.dispatchAll();
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WakeupControllerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WakeupControllerTest.java
index a0cd6c653f..e87bc3fdf3 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WakeupControllerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WakeupControllerTest.java
@@ -41,6 +41,7 @@ import android.net.wifi.WifiScanner;
 import android.net.wifi.WifiSsid;
 import android.net.wifi.util.ScanResultUtil;
 import android.os.Handler;
+import android.os.Process;
 import android.os.test.TestLooper;
 import android.provider.Settings;
 
@@ -800,7 +801,7 @@ public class WakeupControllerTest extends WifiBaseTest {
         verify(mWakeupEvaluator).findViableNetwork(any(), any());
         verify(mWifiSettingsStore).handleWifiToggled(true /* wifiEnabled */);
         verify(mWifiWakeMetrics).recordWakeupEvent(1 /* numScans */);
-        verify(mWifiMetrics).reportWifiStateChanged(true, true, true);
+        verify(mWifiMetrics).reportWifiStateChanged(true, true, true, Process.WIFI_UID);
         verify(mLastCallerInfoManager).put(eq(WifiManager.API_WIFI_ENABLED), anyInt(), anyInt(),
                 anyInt(), eq("android_wifi_wake"), eq(true));
     }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiApConfigStoreTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiApConfigStoreTest.java
index b7b86871d0..1a8e4dbfaa 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiApConfigStoreTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiApConfigStoreTest.java
@@ -39,7 +39,9 @@ import static org.mockito.Mockito.anyInt;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.reset;
 import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.validateMockitoUsage;
 import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.withSettings;
 import static org.mockito.Mockito.when;
 
 import android.content.pm.ApplicationInfo;
@@ -58,14 +60,19 @@ import android.util.SparseArray;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.ArgumentCaptor;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
+import org.mockito.quality.Strictness;
 
 import java.util.ArrayList;
 import java.util.Arrays;
@@ -117,6 +124,7 @@ public class WifiApConfigStoreTest extends WifiBaseTest {
 
     private Random mRandom;
     private MockResourceCache mResources;
+    private MockitoSession mSession;
     @Mock private ApplicationInfo mMockApplInfo;
     @Mock private MacAddressUtil mMacAddressUtil;
     private SoftApStoreData.DataSource mDataStoreSource;
@@ -131,6 +139,11 @@ public class WifiApConfigStoreTest extends WifiBaseTest {
         mLooper = new TestLooper();
         mHandler = new Handler(mLooper.getLooper());
         MockitoAnnotations.initMocks(this);
+        // static mocking
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .strictness(Strictness.LENIENT)
+                .startMocking();
         mMockApplInfo.targetSdkVersion = Build.VERSION_CODES.P;
         when(mContext.getApplicationInfo()).thenReturn(mMockApplInfo);
         when(mWifiInjector.getSettingsConfigStore()).thenReturn(mWifiSettingsConfigStore);
@@ -175,6 +188,14 @@ public class WifiApConfigStoreTest extends WifiBaseTest {
                 R.bool.config_wifiSoftapAutoAppendLowerBandsToBandConfigurationEnabled, true);
     }
 
+    @After
+    public void cleanUp() throws Exception {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
+    }
+
     private void setupAllBandsSupported() {
         mResources.setBoolean(R.bool.config_wifi24ghzSupport, true);
         mResources.setBoolean(R.bool.config_wifiSoftap24ghzSupported, true);
@@ -582,7 +603,6 @@ public class WifiApConfigStoreTest extends WifiBaseTest {
      */
     @Test
     public void generateLocalOnlyHotspotConfigWhenOverlayConfigureTo5G() throws Exception {
-        //leslea
         when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_AUTOMOTIVE)).thenReturn(true);
         when(mSoftApCapability.getSupportedChannelList(SoftApConfiguration.BAND_5GHZ))
                 .thenReturn(new int[] {36});
@@ -1377,6 +1397,55 @@ public class WifiApConfigStoreTest extends WifiBaseTest {
         verifyApConfig(config6Gonly, store_disableAutoAppendBand.getApConfiguration());
     }
 
+    @Test
+    public void testBandOptimizationDisabled() throws Exception {
+        // Test when resource and flag are enabled
+        mResources.setBoolean(
+                R.bool.config_wifiSoftapAutoAppendLowerBandsToBandConfigurationEnabled,
+                true);
+        when(Flags.bandOptimizationControl()).thenReturn(true);
+        SoftApConfiguration config5Gonly = setupApConfig(
+                TEST_DEFAULT_HOTSPOT_SSID,        /* SSID */
+                "randomKey",                      /* preshared key */
+                SECURITY_TYPE_WPA2_PSK,           /* security type */
+                SoftApConfiguration.BAND_5GHZ,    /* AP band */
+                0,                                /* AP channel */
+                true                              /* Hidden SSID */);
+        SoftApConfiguration config5GonlyAndNoBandOptimization =
+                new SoftApConfiguration.Builder(config5Gonly)
+                        .setBandOptimizationEnabled(false)
+                        .build();
+        WifiApConfigStore store_disableAutoAppendBand = createWifiApConfigStore();
+        // Tethering test case
+        store_disableAutoAppendBand.setApConfiguration(config5GonlyAndNoBandOptimization);
+        verifyApConfig(config5GonlyAndNoBandOptimization,
+                store_disableAutoAppendBand.getApConfiguration());
+
+        SoftApConfiguration config6GonlyAndNoBandOptimization =
+                new SoftApConfiguration.Builder(config5Gonly)
+                .setBand(SoftApConfiguration.BAND_6GHZ)
+                .setBandOptimizationEnabled(false)
+                .build();
+
+        store_disableAutoAppendBand.setApConfiguration(config6GonlyAndNoBandOptimization);
+        verifyApConfig(config6GonlyAndNoBandOptimization,
+                store_disableAutoAppendBand.getApConfiguration());
+
+        // LOHS test case for android auto
+        when(mPackageManager.hasSystemFeature(PackageManager.FEATURE_AUTOMOTIVE)).thenReturn(true);
+        when(mSoftApCapability.getSupportedChannelList(SoftApConfiguration.BAND_5GHZ))
+                .thenReturn(new int[] {36});
+        mResources.setBoolean(R.bool.config_wifi_local_only_hotspot_5ghz, true);
+        SoftApConfiguration config = store_disableAutoAppendBand
+                .generateLocalOnlyHotspotConfig(mContext, config5GonlyAndNoBandOptimization,
+                        mSoftApCapability, true);
+        assertThat(config.getBand()).isEqualTo(SoftApConfiguration.BAND_5GHZ);
+
+        // verify that the config passes the validateApWifiConfiguration check
+        assertTrue(WifiApConfigStore.validateApWifiConfiguration(config, true, mContext,
+                mWifiNative));
+    }
+
     @Test
     public void testForceApBandChannel() throws Exception {
         int testBand = SoftApConfiguration.BAND_5GHZ; // Not default
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiBackupRestoreTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiBackupRestoreTest.java
index 481c8a5a4c..e8aa857b10 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiBackupRestoreTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiBackupRestoreTest.java
@@ -17,21 +17,29 @@
 package com.android.server.wifi;
 
 import static org.junit.Assert.*;
+import static org.junit.Assume.assumeTrue;
 import static org.mockito.Mockito.*;
+import static org.mockito.Mockito.validateMockitoUsage;
+import static org.mockito.Mockito.withSettings;
 
 import android.net.IpConfiguration;
 import android.net.wifi.WifiConfiguration;
+import android.net.wifi.util.Environment;
 import android.os.Process;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.server.wifi.util.WifiPermissionsUtil;
+import com.android.wifi.flags.Flags;
 
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
+import org.mockito.quality.Strictness;
 
 import java.io.ByteArrayOutputStream;
 import java.io.DataOutputStream;
@@ -126,139 +134,9 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
                     + "</NetworkList>\n"
                     + "</WifiBackupData>\n";
 
-    private static final String WIFI_BACKUP_DATA_V1_0 =
-            "<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n"
-                    + "<WifiBackupData>\n"
-                    + "<float name=\"Version\" value=\"1.0\" />\n"
-                    + "<NetworkList>\n"
-                    + "<Network>\n"
-                    + "<WifiConfiguration>\n"
-                    + "<string name=\"ConfigKey\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;NONE</string>\n"
-                    + "<string name=\"SSID\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;</string>\n"
-                    + "<null name=\"BSSID\" />\n"
-                    + "<null name=\"PreSharedKey\" />\n"
-                    + "<null name=\"WEPKeys\" />\n"
-                    + "<int name=\"WEPTxKeyIndex\" value=\"0\" />\n"
-                    + "<boolean name=\"HiddenSSID\" value=\"false\" />\n"
-                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedProtocols\" num=\"1\">03</byte-array>\n"
-                    + "<byte-array name=\"AllowedAuthAlgos\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
-                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n"
-                    + "<boolean name=\"Shared\" value=\"true\" />\n"
-                    + "</WifiConfiguration>\n"
-                    + "<IpConfiguration>\n"
-                    + "<string name=\"IpAssignment\">DHCP</string>\n"
-                    + "<string name=\"ProxySettings\">NONE</string>\n"
-                    + "</IpConfiguration>\n"
-                    + "</Network>\n"
-                    + "</NetworkList>\n"
-                    + "</WifiBackupData>\n";
-
-    private static final String WIFI_BACKUP_DATA_V1_1 =
-            "<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n"
-                    + "<WifiBackupData>\n"
-                    + "<float name=\"Version\" value=\"1.1\" />\n"
-                    + "<NetworkList>\n"
-                    + "<Network>\n"
-                    + "<WifiConfiguration>\n"
-                    + "<string name=\"ConfigKey\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;NONE</string>\n"
-                    + "<string name=\"SSID\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;</string>\n"
-                    + "<null name=\"BSSID\" />\n"
-                    + "<null name=\"PreSharedKey\" />\n"
-                    + "<null name=\"WEPKeys\" />\n"
-                    + "<int name=\"WEPTxKeyIndex\" value=\"0\" />\n"
-                    + "<boolean name=\"HiddenSSID\" value=\"false\" />\n"
-                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedProtocols\" num=\"1\">03</byte-array>\n"
-                    + "<byte-array name=\"AllowedAuthAlgos\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
-                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n"
-                    + "<boolean name=\"Shared\" value=\"true\" />\n"
-                    + "<int name=\"MeteredOverride\" value=\"1\" />\n"
-                    + "</WifiConfiguration>\n"
-                    + "<IpConfiguration>\n"
-                    + "<string name=\"IpAssignment\">DHCP</string>\n"
-                    + "<string name=\"ProxySettings\">NONE</string>\n"
-                    + "</IpConfiguration>\n"
-                    + "</Network>\n"
-                    + "</NetworkList>\n"
-                    + "</WifiBackupData>\n";
-
-    private static final String WIFI_BACKUP_DATA_V1_2 =
-            "<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n"
-                    + "<WifiBackupData>\n"
-                    + "<float name=\"Version\" value=\"1.2\" />\n"
-                    + "<NetworkList>\n"
-                    + "<Network>\n"
-                    + "<WifiConfiguration>\n"
-                    + "<string name=\"ConfigKey\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;NONE</string>\n"
-                    + "<string name=\"SSID\">&quot;" + WifiConfigurationTestUtil.TEST_SSID
-                        + "&quot;</string>\n"
-                    + "<null name=\"PreSharedKey\" />\n"
-                    + "<null name=\"WEPKeys\" />\n"
-                    + "<int name=\"WEPTxKeyIndex\" value=\"0\" />\n"
-                    + "<boolean name=\"HiddenSSID\" value=\"false\" />\n"
-                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedProtocols\" num=\"1\">03</byte-array>\n"
-                    + "<byte-array name=\"AllowedAuthAlgos\" num=\"1\">01</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
-                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupMgmtCiphers\" num=\"0\"></byte-array>\n"
-                    + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n"
-                    + "<boolean name=\"Shared\" value=\"true\" />\n"
-                    + "<boolean name=\"AutoJoinEnabled\" value=\"false\" />\n"
-                    + "<int name=\"MeteredOverride\" value=\"1\" />\n"
-                    + "</WifiConfiguration>\n"
-                    + "<IpConfiguration>\n"
-                    + "<string name=\"IpAssignment\">DHCP</string>\n"
-                    + "<string name=\"ProxySettings\">NONE</string>\n"
-                    + "</IpConfiguration>\n"
-                    + "</Network>\n"
-                    + "</NetworkList>\n"
-                    + "</WifiBackupData>\n";
-
-    private static final String WIFI_BACKUP_DATA_V1_3 =
-            "<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n"
-                    + "<WifiBackupData>\n"
-                    + "<float name=\"Version\" value=\"1.3\" />\n"
-                    + "<NetworkList>\n"
-                    + "<Network>\n"
-                    + "<WifiConfiguration>\n"
-                    + "<string name=\"ConfigKey\">&quot;"
-                    + WifiConfigurationTestUtil.TEST_SSID
-                    + "&quot;WPA_PSK</string>\n"
-                    + "<string name=\"SSID\">&quot;"
-                    + WifiConfigurationTestUtil.TEST_SSID
-                    + "&quot;</string>\n"
-                    + "<null name=\"PreSharedKey\" />\n"
-                    + "<null name=\"WEPKeys\" />\n"
-                    + "<int name=\"WEPTxKeyIndex\" value=\"0\" />\n"
-                    + "<boolean name=\"HiddenSSID\" value=\"false\" />\n"
-                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">02</byte-array>\n"
-                    + "<byte-array name=\"AllowedProtocols\" num=\"1\">03</byte-array>\n"
-                    + "<byte-array name=\"AllowedAuthAlgos\" num=\"0\"></byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
-                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupMgmtCiphers\" num=\"0\"></byte-array>\n"
-                    + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n"
-                    + "<boolean name=\"Shared\" value=\"true\" />\n"
-                    + "<boolean name=\"AutoJoinEnabled\" value=\"false\" />\n"
-                    + "<int name=\"Priority\" value=\"0\" />\n"
-                    + "<int name=\"DeletionPriority\" value=\"0\" />\n"
-                    + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
-                    + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
-                    + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
-                    + "<SecurityParamsList>\n"
+    @SuppressWarnings("StringConcatToTextBlock")
+    private static final String WIFI_BACKUP_DATA_SECURITYPARAMSLIST =
+                    "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"2\" />\n"
                     + "<boolean name=\"IsEnabled\" value=\"true\" />\n"
@@ -267,25 +145,36 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
                     + "<boolean name=\"IsAddedByAutoUpgrade\" value=\"false\" />\n"
                     + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n"
                     + "</SecurityParams>\n"
-                    + "</SecurityParamsList>\n"
-                    + "<boolean name=\"SendDhcpHostname\" value=\"true\" />\n"
-                    + "<int name=\"MeteredOverride\" value=\"1\" />\n"
-                    + "</WifiConfiguration>\n"
-                    + "<IpConfiguration>\n"
+                    + "</SecurityParamsList>\n";
+
+    @SuppressWarnings("StringConcatToTextBlock")
+    private static final String WIFI_BACKUP_DATA_IPCONFIGURATION =
+                    "<IpConfiguration>\n"
                     + "<string name=\"IpAssignment\">DHCP</string>\n"
                     + "<string name=\"ProxySettings\">NONE</string>\n"
-                    + "</IpConfiguration>\n"
-                    + "</Network>\n"
-                    + "</NetworkList>\n"
-                    + "</WifiBackupData>\n";
+                    + "</IpConfiguration>\n";
+
+    @Mock WifiPermissionsUtil mWifiPermissionsUtil;
+    private WifiBackupRestore mWifiBackupRestore;
+    private MockitoSession mSession;
+    private boolean mCheckDump = true;
 
-    private static final String WIFI_BACKUP_DATA_V1_4 =
+    @SuppressWarnings("StringConcatToTextBlock")
+    private String generateBackupDataFromVersion(int version) {
+        if (version < 0) {
+            return null;
+        }
+        StringBuilder backupDataStringBuilder = new StringBuilder();
+        backupDataStringBuilder.append(
             "<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n"
                     + "<WifiBackupData>\n"
-                    + "<float name=\"Version\" value=\"1.4\" />\n"
+                    + "<float name=\"Version\" value=\"1.");
+        // Update version here
+        backupDataStringBuilder.append(version + "\" />\n"
                     + "<NetworkList>\n"
-                    + "<Network>\n"
-                    + "<WifiConfiguration>\n"
+                    + "<Network>\n");
+        backupDataStringBuilder.append(
+                    "<WifiConfiguration>\n"
                     + "<string name=\"ConfigKey\">&quot;"
                     + WifiConfigurationTestUtil.TEST_SSID
                     + "&quot;WPA_PSK</string>\n"
@@ -296,48 +185,79 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
                     + "<null name=\"WEPKeys\" />\n"
                     + "<int name=\"WEPTxKeyIndex\" value=\"0\" />\n"
                     + "<boolean name=\"HiddenSSID\" value=\"false\" />\n"
-                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">02</byte-array>\n"
-                    + "<byte-array name=\"AllowedProtocols\" num=\"1\">03</byte-array>\n"
-                    + "<byte-array name=\"AllowedAuthAlgos\" num=\"0\"></byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
-                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n"
-                    + "<byte-array name=\"AllowedGroupMgmtCiphers\" num=\"0\"></byte-array>\n"
-                    + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n"
-                    + "<boolean name=\"Shared\" value=\"true\" />\n"
-                    + "<boolean name=\"AutoJoinEnabled\" value=\"false\" />\n"
-                    + "<int name=\"Priority\" value=\"0\" />\n"
+                    + "<boolean name=\"RequirePMF\" value=\"false\" />\n");
+        backupDataStringBuilder.append(
+                    "<byte-array name=\"AllowedKeyMgmt\" num=\"1\">")
+                    .append(version >= 3 ? "02" : "01")
+                    .append("</byte-array>\n")
+                    .append("<byte-array name=\"AllowedProtocols\" num=\"1\">")
+                    .append("03</byte-array>\n");
+        backupDataStringBuilder.append(
+                "<byte-array name=\"AllowedAuthAlgos\" num=\"")
+                .append(version >= 3 ? "0" : "1")
+                .append("\">")
+                .append(version >= 3 ? "" : "01")
+                .append("</byte-array>\n");
+        backupDataStringBuilder.append(
+                    "<byte-array name=\"AllowedGroupCiphers\" num=\"1\">0f</byte-array>\n"
+                    + "<byte-array name=\"AllowedPairwiseCiphers\" num=\"1\">06</byte-array>\n");
+        if (version >= 2) {
+            backupDataStringBuilder.append(
+                    "<byte-array name=\"AllowedGroupMgmtCiphers\" num=\"0\"></byte-array>\n"
+                    + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n");
+        }
+        backupDataStringBuilder.append(
+                    "<boolean name=\"Shared\" value=\"true\" />\n");
+        if (version >= 2) {
+            backupDataStringBuilder.append(
+                    "<boolean name=\"AutoJoinEnabled\" value=\"false\" />\n");
+        }
+        if (version >= 3) {
+            backupDataStringBuilder.append(
+                    "<int name=\"Priority\" value=\"0\" />\n"
                     + "<int name=\"DeletionPriority\" value=\"0\" />\n"
-                    + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
-                    + "<boolean name=\"RepeaterEnabled\" value=\"true\" />\n"
-                    + "<boolean name=\"EnableWifi7\" value=\"false\" />\n"
-                    + "<SecurityParamsList>\n"
-                    + "<SecurityParams>\n"
-                    + "<int name=\"SecurityType\" value=\"2\" />\n"
-                    + "<boolean name=\"IsEnabled\" value=\"true\" />\n"
-                    + "<boolean name=\"SaeIsH2eOnlyMode\" value=\"false\" />\n"
-                    + "<boolean name=\"SaeIsPkOnlyMode\" value=\"false\" />\n"
-                    + "<boolean name=\"IsAddedByAutoUpgrade\" value=\"false\" />\n"
-                    + "<byte-array name=\"AllowedSuiteBCiphers\" num=\"0\"></byte-array>\n"
-                    + "</SecurityParams>\n"
-                    + "</SecurityParamsList>\n"
-                    + "<boolean name=\"SendDhcpHostname\" value=\"false\" />\n"
-                    + "<int name=\"MeteredOverride\" value=\"1\" />\n"
-                    + "</WifiConfiguration>\n"
-                    + "<IpConfiguration>\n"
-                    + "<string name=\"IpAssignment\">DHCP</string>\n"
-                    + "<string name=\"ProxySettings\">NONE</string>\n"
-                    + "</IpConfiguration>\n"
+                    + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n");
+        }
+        if (version >= 4) {
+            backupDataStringBuilder.append(
+                    "<boolean name=\"RepeaterEnabled\" value=\"true\" />\n"
+                    + "<boolean name=\"EnableWifi7\" value=\"false\" />\n");
+        }
+        if (version >= 5) {
+            backupDataStringBuilder.append(
+                    "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"false\" />\n");
+        }
+        if (version >= 3) {
+            backupDataStringBuilder.append(WIFI_BACKUP_DATA_SECURITYPARAMSLIST);
+        }
+        if (version == 3) {
+            backupDataStringBuilder.append(
+                    "<boolean name=\"SendDhcpHostname\" value=\"true\" />\n");
+        } else if (version >= 4) {
+            backupDataStringBuilder.append(
+                    "<boolean name=\"SendDhcpHostname\" value=\"false\" />\n");
+        }
+        if (version >= 1) {
+            backupDataStringBuilder.append(
+                    "<int name=\"MeteredOverride\" value=\"1\" />\n");
+        }
+        backupDataStringBuilder.append(
+                    "</WifiConfiguration>\n"
+                    + WIFI_BACKUP_DATA_IPCONFIGURATION
                     + "</Network>\n"
                     + "</NetworkList>\n"
-                    + "</WifiBackupData>\n";
-    @Mock WifiPermissionsUtil mWifiPermissionsUtil;
-    private WifiBackupRestore mWifiBackupRestore;
-    private boolean mCheckDump = true;
+                    + "</WifiBackupData>\n");
+        return backupDataStringBuilder.toString();
+    }
 
     @Before
     public void setUp() throws Exception {
         MockitoAnnotations.initMocks(this);
+        // static mocking
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .strictness(Strictness.LENIENT)
+                .startMocking();
         when(mWifiPermissionsUtil.checkConfigOverridePermission(anyInt())).thenReturn(true);
         mWifiBackupRestore = new WifiBackupRestore(mWifiPermissionsUtil);
         // Enable verbose logging before tests to check the backup data dumps.
@@ -346,6 +266,10 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
 
     @After
     public void cleanUp() throws Exception {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
         if (mCheckDump) {
             StringWriter stringWriter = new StringWriter();
             mWifiBackupRestore.dump(
@@ -1154,7 +1078,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         List<WifiConfiguration> configurations = new ArrayList<>();
         configurations.add(createNetworkForConfigurationWithV1_0Data());
 
-        byte[] backupData = WIFI_BACKUP_DATA_V1_0.getBytes();
+        byte[] backupData = generateBackupDataFromVersion(0).getBytes();
         List<WifiConfiguration> retrievedConfigurations =
                 mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
         WifiConfigurationTestUtil.assertConfigurationsEqualForBackup(
@@ -1169,7 +1093,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         List<WifiConfiguration> configurations = new ArrayList<>();
         configurations.add(createNetworkForConfigurationWithV1_1Data());
 
-        byte[] backupData = WIFI_BACKUP_DATA_V1_1.getBytes();
+        byte[] backupData = generateBackupDataFromVersion(1).getBytes();
         List<WifiConfiguration> retrievedConfigurations =
                 mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
         WifiConfigurationTestUtil.assertConfigurationsEqualForBackup(
@@ -1184,7 +1108,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         List<WifiConfiguration> configurations = new ArrayList<>();
         configurations.add(createNetworkForConfigurationWithV1_2Data());
 
-        byte[] backupData = WIFI_BACKUP_DATA_V1_2.getBytes();
+        byte[] backupData = generateBackupDataFromVersion(2).getBytes();
         List<WifiConfiguration> retrievedConfigurations =
                 mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
         WifiConfigurationTestUtil.assertConfigurationsEqualForBackup(
@@ -1199,7 +1123,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         List<WifiConfiguration> configurations = new ArrayList<>();
         configurations.add(createNetworkForConfigurationWithV1_3Data());
 
-        byte[] backupData = WIFI_BACKUP_DATA_V1_3.getBytes();
+        byte[] backupData = generateBackupDataFromVersion(3).getBytes();
         List<WifiConfiguration> retrievedConfigurations =
                 mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
 
@@ -1215,7 +1139,27 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         List<WifiConfiguration> configurations = new ArrayList<>();
         configurations.add(createNetworkForConfigurationWithV1_4Data());
 
-        byte[] backupData = WIFI_BACKUP_DATA_V1_4.getBytes();
+        byte[] backupData = generateBackupDataFromVersion(4).getBytes();
+        List<WifiConfiguration> retrievedConfigurations =
+                mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
+
+        WifiConfigurationTestUtil.assertConfigurationsEqualForBackup(
+                configurations, retrievedConfigurations);
+    }
+
+    /**
+     * Verify that restoring of configuration from a 1.5 version backup data.
+     */
+    @Test
+    public void testRestoreFromV1_5BackupData() {
+        mCheckDump = false; // for skip case
+        assumeTrue(Environment.isSdkNewerThanB());
+        mCheckDump = true;
+        when(Flags.multiUserWifiEnhancement()).thenReturn(true);
+        List<WifiConfiguration> configurations = new ArrayList<>();
+        configurations.add(createNetworkForConfigurationWithV1_5Data());
+        String wifiBackupDataV5 = generateBackupDataFromVersion(5);
+        byte[] backupData = wifiBackupDataV5.getBytes();
         List<WifiConfiguration> retrievedConfigurations =
                 mWifiBackupRestore.retrieveConfigurationsFromBackupData(backupData);
 
@@ -1225,14 +1169,14 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         // Also, assert in the reverse direction to ensure the serialization logic matches.
         // Note: This will stop working when we bump up the version. Then we'll need to copy
         // the below assert to the test for the latest version.
-        assertEquals(WIFI_BACKUP_DATA_V1_4,
+        assertEquals(wifiBackupDataV5,
                 new String(mWifiBackupRestore.retrieveBackupDataFromConfigurations(
                         retrievedConfigurations)));
     }
 
     /**
      * Creates correct WiFiConfiguration that should be parsed out of
-     * {@link #WIFI_BACKUP_DATA_V1_0} configuration which contains 1.0 version backup.
+     * configuration which contains 1.0 version backup.
      */
     private static WifiConfiguration createNetworkForConfigurationWithV1_0Data() {
         final WifiConfiguration config = new WifiConfiguration();
@@ -1262,7 +1206,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
 
     /**
      * Creates correct WiFiConfiguration that should be parsed out of
-     * {@link #WIFI_BACKUP_DATA_V1_1} configuration which contains 1.1 version backup.
+     * configuration which contains 1.1 version backup.
      */
     private static WifiConfiguration createNetworkForConfigurationWithV1_1Data() {
         final WifiConfiguration config = createNetworkForConfigurationWithV1_0Data();
@@ -1272,7 +1216,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
 
     /**
      * Creates correct WiFiConfiguration that should be parsed out of
-     * {@link #WIFI_BACKUP_DATA_V1_1} configuration which contains 1.2 version backup.
+     * configuration which contains 1.2 version backup.
      */
     private static WifiConfiguration createNetworkForConfigurationWithV1_2Data() {
         final WifiConfiguration config = createNetworkForConfigurationWithV1_1Data();
@@ -1282,7 +1226,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
 
     /**
      * Creates correct WiFiConfiguration that should be parsed out of
-     * {@link #WIFI_BACKUP_DATA_V1_3} configuration which contains 1.3 version backup.
+     * configuration which contains 1.3 version backup.
      */
     private static WifiConfiguration createNetworkForConfigurationWithV1_3Data() {
         final WifiConfiguration config = createNetworkForConfigurationWithV1_2Data();
@@ -1293,7 +1237,7 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
 
     /**
      * Creates correct WiFiConfiguration that should be parsed out of
-     * {@link #WIFI_BACKUP_DATA_V1_4} configuration which contains 1.4 version backup.
+     * configuration which contains 1.4 version backup.
      */
     private static WifiConfiguration createNetworkForConfigurationWithV1_4Data() {
         final WifiConfiguration config = createNetworkForConfigurationWithV1_3Data();
@@ -1304,6 +1248,18 @@ public class WifiBackupRestoreTest extends WifiBaseTest {
         return config;
     }
 
+    /**
+     * Creates correct WiFiConfiguration that should be parsed out of
+     * configuration which contains 1.5 version backup.
+     */
+    private static WifiConfiguration createNetworkForConfigurationWithV1_5Data() {
+        final WifiConfiguration config = createNetworkForConfigurationWithV1_4Data();
+        // Use non-default value for testing.
+        config.shared = true; // make sure that it is a shared network.
+        config.setAllowedToUpdateByOtherUsers(false);
+        return config;
+    }
+
     /**
      * Helper method to write a list of networks in wpa_supplicant.conf format to the output stream.
      */
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiBlocklistMonitorTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiBlocklistMonitorTest.java
index 8b243e6dd8..3add836ff4 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiBlocklistMonitorTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiBlocklistMonitorTest.java
@@ -1198,12 +1198,13 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
 
         // Simulate both TEST_BSSID_1 and TEST_BSSID_2 improving RSSI, but only TEST_BSSID_2 should
         // be removed from blocklist.
-        List<ScanDetail> enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI);
-        assertEquals(0, enabledDetails.size());
+        List<Integer> enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI);
+        assertEquals(0, enabledNetworks.size());
         assertEquals(3, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
 
-        enabledDetails = simulateRssiUpdate(TEST_BSSID_2, TEST_GOOD_RSSI);
-        assertEquals(1, enabledDetails.size());
+        enabledNetworks = simulateRssiUpdate(TEST_BSSID_2, TEST_GOOD_RSSI);
+        assertEquals(1, enabledNetworks.size());
+        assertEquals(config.networkId, (int) enabledNetworks.get(0));
         assertEquals(2, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
     }
 
@@ -1228,8 +1229,9 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_3));
 
         // verify TEST_BSSID_1 is removed from the blocklist after RSSI improves
-        List<ScanDetail> enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
-        assertEquals(1, enabledDetails.size());
+        List<Integer> enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
+        assertEquals(1, enabledNetworks.size());
+        assertEquals(config.networkId, (int) enabledNetworks.get(0));
         assertEquals(0, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
     }
 
@@ -1283,7 +1285,7 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
         assertEquals(0, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
     }
 
-    private List<ScanDetail> simulateRssiUpdate(String bssid, int rssi) {
+    private List<Integer> simulateRssiUpdate(String bssid, int rssi) {
         ScanDetail scanDetail = mock(ScanDetail.class);
         ScanResult scanResult = mock(ScanResult.class);
         scanResult.BSSID = bssid;
@@ -1309,14 +1311,15 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
 
         // verify the blocklist is not cleared when the rssi improvement is not large enough.
-        List<ScanDetail> enabledDetails =
+        List<Integer> enabledNetworks =
                 simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI - 1);
-        assertTrue(enabledDetails.isEmpty());
+        assertTrue(enabledNetworks.isEmpty());
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
 
         // verify TEST_BSSID_1 is removed from the blocklist after RSSI improves
-        enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
-        assertEquals(1, enabledDetails.size());
+        enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
+        assertEquals(1, enabledNetworks.size());
+        assertEquals(config.networkId, (int) enabledNetworks.get(0));
         assertEquals(0, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
     }
 
@@ -1335,8 +1338,9 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
 
         // verify TEST_BSSID_1 is not removed from blocklist
-        List<ScanDetail> enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI);
-        assertEquals(1, enabledDetails.size());
+        List<Integer> enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI);
+        assertEquals(1, enabledNetworks.size());
+        assertEquals(config.networkId, (int) enabledNetworks.get(0));
         assertEquals(0, mWifiBlocklistMonitor.updateAndGetBssidBlocklist().size());
     }
 
@@ -1355,8 +1359,8 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
 
         // verify TEST_BSSID_1 is not removed from blocklist
-        List<ScanDetail> enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI - 1);
-        assertTrue(enabledDetails.isEmpty());
+        List<Integer> enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_GOOD_RSSI - 1);
+        assertTrue(enabledNetworks.isEmpty());
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
     }
 
@@ -1373,8 +1377,8 @@ public class WifiBlocklistMonitorTest extends WifiBaseTest {
                 TEST_SUFFICIENT_RSSI - MIN_RSSI_DIFF_TO_UNBLOCK_BSSID);
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
 
-        List<ScanDetail> enabledDetails = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
-        assertTrue(enabledDetails.isEmpty());
+        List<Integer> enabledNetworks = simulateRssiUpdate(TEST_BSSID_1, TEST_SUFFICIENT_RSSI);
+        assertTrue(enabledNetworks.isEmpty());
         assertTrue(mWifiBlocklistMonitor.updateAndGetBssidBlocklist().contains(TEST_BSSID_1));
     }
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiCarrierInfoManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiCarrierInfoManagerTest.java
index 2c629de390..4ca456f5f5 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiCarrierInfoManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiCarrierInfoManagerTest.java
@@ -169,6 +169,7 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
     @Mock Notification.Builder mNotificationBuilder;
     @Mock Notification mNotification;
     @Mock WifiDialogManager mWifiDialogManager;
+    @Mock WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
     @Mock WifiDialogManager.DialogHandle mDialogHandle;
     @Mock
     WifiCarrierInfoManager.OnImsiProtectedOrUserApprovedListener mListener;
@@ -220,8 +221,15 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
         when(mNotificationBuilder.addAction(any())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.setTimeoutAfter(anyLong())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.build()).thenReturn(mNotification);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(mDialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
         when(mWifiInjector.makeWifiCarrierInfoStoreManagerData(any()))
                 .thenReturn(mWifiCarrierInfoStoreManagerData);
         when(mWifiInjector.getWifiConfigManager()).thenReturn(mWifiConfigManager);
@@ -1994,8 +2002,7 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
         // Simulate user clicking on disallow in the dialog.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onNegativeButtonClicked();
         ArgumentCaptor<Intent> intentCaptor = ArgumentCaptor.forClass(Intent.class);
         verify(mContext).sendBroadcast(intentCaptor.capture(), any(), any());
@@ -2034,8 +2041,7 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
         // Simulate user dismissing the dialog via home/back button.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onCancelled();
         ArgumentCaptor<Intent> intentCaptor = ArgumentCaptor.forClass(Intent.class);
         verify(mContext).sendBroadcast(intentCaptor.capture(), any(), any());
@@ -2083,8 +2089,7 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
         // Simulate user clicking on allow in the dialog.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onPositiveButtonClicked();
         ArgumentCaptor<Intent> intentCaptor = ArgumentCaptor.forClass(Intent.class);
         verify(mContext).sendBroadcast(intentCaptor.capture(), any(), any());
@@ -2232,8 +2237,7 @@ public class WifiCarrierInfoManagerTest extends WifiBaseTest {
     private void validateUserApprovalDialog(String... anyOfExpectedAppNames) {
         verify(mDialogHandle, atLeastOnce()).launchDialog();
         ArgumentCaptor<String> messageCaptor = ArgumentCaptor.forClass(String.class);
-        verify(mWifiDialogManager, atLeastOnce()).createSimpleDialog(
-                any(), messageCaptor.capture(), any(), any(), any(), any(), any());
+        verify(mDialogBuilder).setMessage(messageCaptor.capture());
         String message = messageCaptor.getValue();
         assertNotNull(message);
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigManagerTest.java
index 3d25fdada6..709b8fd171 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigManagerTest.java
@@ -78,6 +78,7 @@ import android.net.wifi.WifiInfo;
 import android.net.wifi.WifiManager;
 import android.net.wifi.WifiScanner;
 import android.net.wifi.WifiSsid;
+import android.net.wifi.util.Environment;
 import android.os.Handler;
 import android.os.Process;
 import android.os.UserHandle;
@@ -339,6 +340,7 @@ public class WifiConfigManagerTest extends WifiBaseTest {
         when(mPackageManager.getPackagesHoldingPermissions(any(String[].class), anyInt()))
                 .thenReturn(Collections.emptyList());
         when(mWifiInjector.getDeviceConfigFacade()).thenReturn(mDeviceConfigFacade);
+        when(mDeviceConfigFacade.getFeatureFlags()).thenReturn(mFeatureFlags);
         mWifiCarrierInfoManager = spy(new WifiCarrierInfoManager(mTelephonyManager,
                 mSubscriptionManager, mWifiInjector, mock(FrameworkFacade.class),
                 wifiContext, mock(WifiConfigStore.class), mock(Handler.class),
@@ -8510,7 +8512,6 @@ public class WifiConfigManagerTest extends WifiBaseTest {
      */
     @Test
     public void testConfiguredNetworkWithPassword() {
-
         NetworkSelectionStatus.Builder builder = new NetworkSelectionStatus.Builder();
         NetworkSelectionStatus networkSelectionStatus = builder.build();
         SecurityParams params = SecurityParams.createSecurityParamsBySecurityType(
@@ -8532,4 +8533,33 @@ public class WifiConfigManagerTest extends WifiBaseTest {
         // Test there is no network with TEST_SSID and FT_PSK
         assertNull(wifiConfig);
     }
+
+    /**
+     * Verify that the other user can't update (enable/disable network) and remove this network.
+     * but admin is allowed to remove it.
+     */
+    @Test
+    public void testConfigOnlyCanBeUpdatedByCreatorUser() {
+        assumeTrue(Environment.isSdkNewerThanB());
+        when(mFeatureFlags.multiUserWifiEnhancement()).thenReturn(true);
+        when(mWifiPermissionsUtil.areTwoAppsFromSameUser(anyInt(), anyInt())).thenReturn(false);
+        // Adding a network which disallow other user to edit it.
+        WifiConfiguration openNetwork = WifiConfigurationTestUtil.createOpenNetwork();
+        openNetwork.setAllowedToUpdateByOtherUsers(false);
+        assertFalse(openNetwork.isAllowedToUpdateByOtherUsers());
+        verifyAddNetworkToWifiConfigManager(openNetwork);
+        assertFalse(mWifiConfigManager.enableNetwork(
+                openNetwork.networkId, false, TEST_UPDATE_UID, TEST_CREATOR_NAME));
+        assertFalse(mWifiConfigManager.disableNetwork(
+                openNetwork.networkId, TEST_UPDATE_UID, TEST_CREATOR_NAME));
+        assertFalse(mWifiConfigManager.removeNetwork(
+                openNetwork.networkId, TEST_UPDATE_UID, TEST_CREATOR_NAME));
+        // Now switch the user to user 2 and user 2 is admin
+        when(mUserManager.isForegroundUserAdmin()).thenReturn(true);
+        mWifiConfigManager.handleUserSwitch(TEST_DEFAULT_USER + 1);
+        mWifiConfigManager.handleUserUnlock(TEST_DEFAULT_USER + 1);
+        // Current user is admin and allow to remove a network.
+        assertTrue(mWifiConfigManager.removeNetwork(
+                openNetwork.networkId, TEST_UPDATE_UID, TEST_CREATOR_NAME));
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigStoreTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigStoreTest.java
index 2c4080a8db..1a4e8b5970 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigStoreTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigStoreTest.java
@@ -26,6 +26,7 @@ import android.content.pm.PackageManager;
 import android.net.MacAddress;
 import android.net.wifi.WifiConfiguration;
 import android.net.wifi.WifiMigration;
+import android.net.wifi.util.Environment;
 import android.net.wifi.util.HexEncoding;
 import android.os.UserHandle;
 import android.os.test.TestLooper;
@@ -106,6 +107,7 @@ public class WifiConfigStoreTest extends WifiBaseTest {
                     + "<int name=\"NumRebootsSinceLastUse\" value=\"0\" />\n"
                     + "<boolean name=\"RepeaterEnabled\" value=\"false\" />\n"
                     + "<boolean name=\"EnableWifi7\" value=\"true\" />\n"
+                    + "%s" // String after EnableWifi7 before SecurityParamsList
                     + "<SecurityParamsList>\n"
                     + "<SecurityParams>\n"
                     + "<int name=\"SecurityType\" value=\"0\" />\n"
@@ -495,7 +497,9 @@ public class WifiConfigStoreTest extends WifiBaseTest {
         String xmlString = String.format(TEST_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid, openNetwork.creatorName,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid, openNetwork.creatorName,
                 openNetwork.getRandomizedMacAddress(), openNetwork.subscriptionId);
         byte[] xmlBytes = xmlString.getBytes(StandardCharsets.UTF_8);
         mUserStore.storeRawDataToWrite(xmlBytes);
@@ -533,7 +537,9 @@ public class WifiConfigStoreTest extends WifiBaseTest {
         String xmlString = String.format(TEST_DATA_XML_STRING_FORMAT,
                 openNetwork.getKey().replaceAll("\"", "&quot;"),
                 openNetwork.SSID.replaceAll("\"", "&quot;"),
-                openNetwork.shared, openNetwork.creatorUid, openNetwork.creatorName,
+                openNetwork.shared, Environment.isSdkNewerThanB()
+                        ? "<boolean name=\"AllowedToUpdateByOtherUsers\" value=\"true\" />\n" : "",
+                openNetwork.creatorUid, openNetwork.creatorName,
                 openNetwork.getRandomizedMacAddress(), openNetwork.subscriptionId);
 
         mWifiConfigStore.write();
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigurationTestUtil.java b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigurationTestUtil.java
index 8d29edb679..883f56f0f1 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiConfigurationTestUtil.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiConfigurationTestUtil.java
@@ -29,6 +29,7 @@ import android.net.wifi.WifiConfiguration;
 import android.net.wifi.WifiConfiguration.NetworkSelectionStatus;
 import android.net.wifi.WifiEnterpriseConfig;
 import android.net.wifi.WifiSsid;
+import android.net.wifi.util.Environment;
 import android.text.TextUtils;
 
 import com.android.modules.utils.build.SdkLevel;
@@ -736,6 +737,10 @@ public class WifiConfigurationTestUtil {
             assertEquals(expected.shared, actual.shared);
         }
         assertEquals(expected.getIpConfiguration(), actual.getIpConfiguration());
+        if (Environment.isSdkNewerThanB()) {
+            assertEquals(expected.isAllowedToUpdateByOtherUsers(),
+                    actual.isAllowedToUpdateByOtherUsers());
+        }
     }
 
 
@@ -803,6 +808,10 @@ public class WifiConfigurationTestUtil {
         if (SdkLevel.isAtLeastV()) {
             assertEquals(expected.getVendorData(), actual.getVendorData());
         }
+        if (Environment.isSdkNewerThanB()) {
+            assertEquals(expected.isAllowedToUpdateByOtherUsers(),
+                    actual.isAllowedToUpdateByOtherUsers());
+        }
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiConnectivityManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiConnectivityManagerTest.java
index 996c2be2b3..f2e7775b7a 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiConnectivityManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiConnectivityManagerTest.java
@@ -223,8 +223,15 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
                 (Answer<List<WifiSsid>>) invocation -> Arrays.asList(invocation.getArgument(0),
                         WifiSsid.fromString(UNTRANSLATED_HEX_SSID))
         );
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(mDialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
     }
 
     private void setUpResources(MockResources resources) {
@@ -329,6 +336,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
     @Mock private WifiCountryCode mWifiCountryCode;
     @Mock private DppManager mDppManager;
     @Mock private WifiDialogManager mWifiDialogManager;
+    @Mock private WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
     @Mock private WifiDialogManager.DialogHandle mDialogHandle;
     @Mock private WifiInjector mWifiInjector;
     @Mock private HalDeviceManager mHalDeviceManager;
@@ -1556,7 +1564,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
                 targetConfig.networkId, Process.WIFI_UID, targetBssid);
         verify(mSecondaryClientModeManager, times(2)).enableRoaming(false);
         verify(mActiveModeWarden, times(2)).requestSecondaryLongLivedClientModeManager(
-                any(), any(), any(), any());
+                any(), any(), any(), eq(targetBssid));
 
         // Simulate connection failing on the secondary
         clearInvocations(mSecondaryClientModeManager, mPrimaryClientModeManager, mWifiNS);
@@ -4315,8 +4323,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify we started the connection without the dialog.
-        verify(mWifiDialogManager, never()).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager, never()).createSimpleDialogBuilder();
         verify(mDialogHandle, never()).launchDialog();
         verify(mPrimaryClientModeManager).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4346,8 +4353,8 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mDialogHandle).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4384,8 +4391,8 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mDialogHandle).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4400,8 +4407,6 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         // Trigger another scan and verify we don't show any more dialogs.
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
         verify(mDialogHandle, times(1)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4414,8 +4419,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         when(mPrimaryClientModeManager.getConnectedWifiConfiguration()).thenReturn(config);
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
         verify(mDialogHandle, times(2)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4445,8 +4449,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mDialogHandle).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4454,9 +4459,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         // Same candidate should not refresh the dialog
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
-        verify(mDialogHandle).launchDialog();
+        verify(mDialogHandle, times(1)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
 
@@ -4465,8 +4468,8 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
         verify(mDialogHandle).dismissDialog();
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
+        verify(mDialogBuilder, times(2)).build();
         verify(mDialogHandle, times(2)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4501,8 +4504,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mDialogHandle).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4515,9 +4519,7 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         // Dialog should not come up again while it's disabled.
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
-        verify(mDialogHandle).launchDialog();
+        verify(mDialogHandle, times(1)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
 
@@ -4526,8 +4528,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
         verify(mDialogHandle).dismissDialog();
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
+        verify(mDialogBuilder, times(2)).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder, times(2)).build();
         verify(mDialogHandle, times(2)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4557,9 +4560,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
-        verify(mDialogHandle).launchDialog();
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
 
@@ -4595,8 +4598,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).build();
         verify(mDialogHandle).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4611,8 +4615,6 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         // Trigger another scan and verify we don't show any more dialogs.
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
         verify(mDialogHandle, times(1)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4626,8 +4628,9 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
                 new WifiNetworkSelectionConfig.Builder().build());
         mWifiScanner.startScan(settings, scanListener);
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mWifiDialogManager, times(2)).createSimpleDialogBuilder();
+        verify(mDialogBuilder, times(2)).setCallback(mSimpleDialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder, times(2)).build();
         verify(mDialogHandle, times(2)).launchDialog();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
@@ -4657,9 +4660,8 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         mLooper.dispatchAll();
 
         // Verify dialog was launched, and we haven't started the connection.
-        verify(mWifiDialogManager).createSimpleDialog(any(), any(), any(), any(), any(),
-                mSimpleDialogCallbackCaptor.capture(), any());
-        verify(mDialogHandle).launchDialog();
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).build();
         verify(mPrimaryClientModeManager, never()).startConnectToNetwork(
                 CANDIDATE_NETWORK_ID, Process.WIFI_UID, CANDIDATE_BSSID);
 
@@ -4756,10 +4758,10 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         WifiConfiguration disabledConfig = WifiConfigurationTestUtil.createPskNetwork();
         disabledConfig.getNetworkSelectionStatus().setNetworkSelectionStatus(
                 WifiConfiguration.NetworkSelectionStatus.NETWORK_SELECTION_TEMPORARY_DISABLED);
-        List<ScanDetail> mockScanDetails = new ArrayList<>();
-        mockScanDetails.add(mock(ScanDetail.class));
-        when(mWifiBlocklistMonitor.tryEnablingBlockedBssids(any())).thenReturn(mockScanDetails);
-        when(mWifiConfigManager.getSavedNetworkForScanDetail(any())).thenReturn(
+        List<Integer> mockNetworkIds = new ArrayList<>();
+        mockNetworkIds.add(disabledConfig.networkId);
+        when(mWifiBlocklistMonitor.tryEnablingBlockedBssids(any())).thenReturn(mockNetworkIds);
+        when(mWifiConfigManager.getConfiguredNetwork(disabledConfig.networkId)).thenReturn(
                 disabledConfig);
 
         InOrder inOrder = inOrder(mWifiBlocklistMonitor, mWifiConfigManager);
@@ -4786,10 +4788,10 @@ public class WifiConnectivityManagerTest extends WifiBaseTest {
         WifiConfiguration disabledConfig = WifiConfigurationTestUtil.createPskNetwork();
         disabledConfig.getNetworkSelectionStatus().setNetworkSelectionStatus(
                 WifiConfiguration.NetworkSelectionStatus.NETWORK_SELECTION_PERMANENTLY_DISABLED);
-        List<ScanDetail> mockScanDetails = new ArrayList<>();
-        mockScanDetails.add(mock(ScanDetail.class));
-        when(mWifiBlocklistMonitor.tryEnablingBlockedBssids(any())).thenReturn(mockScanDetails);
-        when(mWifiConfigManager.getSavedNetworkForScanDetail(any())).thenReturn(
+        List<Integer> mockNetworkIds = new ArrayList<>();
+        mockNetworkIds.add(disabledConfig.networkId);
+        when(mWifiBlocklistMonitor.tryEnablingBlockedBssids(any())).thenReturn(mockNetworkIds);
+        when(mWifiConfigManager.getConfiguredNetwork(disabledConfig.networkId)).thenReturn(
                 disabledConfig);
 
         InOrder inOrder = inOrder(mWifiBlocklistMonitor, mWifiConfigManager);
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiCountryCodeTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiCountryCodeTest.java
index 6aa996e7c5..1b6b90a8dc 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiCountryCodeTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiCountryCodeTest.java
@@ -742,6 +742,16 @@ public class WifiCountryCodeTest extends WifiBaseTest {
         assertEquals(TEST_COUNTRY_CODE_2, mWifiCountryCode.getCountryCode());
     }
 
+    @Test
+    public void testUpdateountryCodeGenericEnabledAndWifiDisabled() {
+        mResourceCache.setBoolean(R.bool.config_wifiUpdateCountryCodeFromScanResultGeneric, true);
+        mWifiCountryCode.updateCountryCodeFromScanResults(mScanDetails);
+        mModeChangeCallbackCaptor.getValue().onActiveModeManagerRemoved(mClientModeManager);
+
+        assertEquals(mDefaultCountryCode, mWifiCountryCode.getCountryCode());
+    }
+
+
     @Test
     public void testUpdateCountryCodeGenericWithTelephonyCountryCode() {
         when(mTelephonyManager.getNetworkCountryIso()).thenReturn(TEST_COUNTRY_CODE_2);
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiDeviceStateChangeManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiDeviceStateChangeManagerTest.java
index 394e4ff334..6b8a4cda06 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiDeviceStateChangeManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiDeviceStateChangeManagerTest.java
@@ -61,13 +61,13 @@ public class WifiDeviceStateChangeManagerTest extends WifiBaseTest {
 
     @Captor ArgumentCaptor<BroadcastReceiver> mBroadcastReceiverCaptor;
     private TestLooper mLooper;
-    private Handler mHandler;
     private WifiDeviceStateChangeManagerSpy mWifiDeviceStateChangeManager;
     private boolean mIsAapmApiFlagEnabled = false;
+    private WifiThreadRunner mWifiTheadRunner;
 
     class WifiDeviceStateChangeManagerSpy extends WifiDeviceStateChangeManager {
         WifiDeviceStateChangeManagerSpy() {
-            super(mContext, mHandler, mWifiInjector);
+            super(mContext, mWifiTheadRunner, mWifiInjector);
         }
 
         @Override
@@ -84,7 +84,8 @@ public class WifiDeviceStateChangeManagerTest extends WifiBaseTest {
         when(mDeviceConfigFacade.getFeatureFlags()).thenReturn(mFeatureFlags);
         when(mPowerManager.isInteractive()).thenReturn(true);
         mLooper = new TestLooper();
-        mHandler = new Handler(mLooper.getLooper());
+        Handler handler = new Handler(mLooper.getLooper());
+        mWifiTheadRunner = new WifiThreadRunner(handler);
         mWifiDeviceStateChangeManager = new WifiDeviceStateChangeManagerSpy();
     }
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiDialogManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiDialogManagerTest.java
index 362fc6aab8..18afb64874 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiDialogManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiDialogManagerTest.java
@@ -44,6 +44,7 @@ import android.net.wifi.WifiContext;
 import android.net.wifi.WifiManager;
 import android.os.Bundle;
 import android.os.UserHandle;
+import android.util.Pair;
 import android.view.Display;
 import android.view.Window;
 import android.view.WindowManager;
@@ -65,6 +66,10 @@ import org.mockito.Captor;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
 
+import java.util.ArrayList;
+import java.util.Iterator;
+import java.util.List;
+
 /**
  * Unit tests for {@link WifiDialogManager}.
  */
@@ -72,6 +77,18 @@ import org.mockito.MockitoAnnotations;
 public class WifiDialogManagerTest extends WifiBaseTest {
     private static final String TEST_TITLE = "Title";
     private static final String TEST_MESSAGE = "Message";
+    private static final List<String> TEST_LIST_LABELS = List.of("Label1", "Label2", "Label3");
+    private static final List<String> TEST_LIST_CONTENTS =
+            List.of("Content1", "Content2", "Content3");
+    private static final List<Pair<String, String>> TEST_LIST;
+    static {
+        TEST_LIST = new ArrayList<>();
+        Iterator<String> labelIter = TEST_LIST_LABELS.iterator();
+        Iterator<String> contentIter = TEST_LIST_CONTENTS.iterator();
+        while (labelIter.hasNext()) {
+            TEST_LIST.add(new Pair(labelIter.next(), contentIter.next()));
+        }
+    }
     private static final String TEST_POSITIVE_BUTTON_TEXT = "Yes";
     private static final String TEST_NEGATIVE_BUTTON_TEXT = "No";
     private static final String TEST_NEUTRAL_BUTTON_TEXT = "Maybe";
@@ -200,6 +217,8 @@ public class WifiDialogManagerTest extends WifiBaseTest {
             @NonNull Intent launchIntent,
             @Nullable String expectedTitle,
             @Nullable String expectedMessage,
+            @Nullable List<String> expectedListLabels,
+            @Nullable List<String> expectedListContents,
             @Nullable String expectedPositiveButtonText,
             @Nullable String expectedNegativeButtonText,
             @Nullable String expectedNeutralButtonText) {
@@ -222,6 +241,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         assertThat(launchIntent.hasExtra(WifiManager.EXTRA_DIALOG_MESSAGE)).isTrue();
         assertThat(launchIntent.getStringExtra(WifiManager.EXTRA_DIALOG_MESSAGE))
                 .isEqualTo(expectedMessage);
+        assertThat(launchIntent.hasExtra(WifiManager.EXTRA_DIALOG_LIST_LABELS)).isTrue();
+        assertThat(launchIntent.getStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_LABELS))
+                .isEqualTo(expectedListLabels);
+        assertThat(launchIntent.hasExtra(WifiManager.EXTRA_DIALOG_LIST_CONTENTS)).isTrue();
+        assertThat(launchIntent.getStringArrayListExtra(WifiManager.EXTRA_DIALOG_LIST_CONTENTS))
+                .isEqualTo(expectedListContents);
         assertThat(launchIntent.hasExtra(WifiManager.EXTRA_DIALOG_POSITIVE_BUTTON_TEXT)).isTrue();
         assertThat(launchIntent.getStringExtra(WifiManager.EXTRA_DIALOG_POSITIVE_BUTTON_TEXT))
                 .isEqualTo(expectedPositiveButtonText);
@@ -234,6 +259,22 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         return dialogId;
     }
 
+    /**
+     * Creates a simple dialog with a callback and callback runner.
+     */
+    public DialogHandle createTestSimpleDialog(
+            SimpleDialogCallback callback, WifiThreadRunner callbackThreadRunner) {
+        return mDialogManager.createSimpleDialogBuilder()
+                .setTitle(TEST_TITLE)
+                .setMessage(TEST_MESSAGE)
+                .setListItems(TEST_LIST)
+                .setPositiveButtonText(TEST_POSITIVE_BUTTON_TEXT)
+                .setNegativeButtonText(TEST_NEGATIVE_BUTTON_TEXT)
+                .setNeutralButtonText(TEST_NEUTRAL_BUTTON_TEXT)
+                .setCallback(callback, callbackThreadRunner)
+                .build();
+    }
+
     /**
      * Verifies that launching a simple dialog will result in the correct callback methods invoked
      * when a response is received.
@@ -245,13 +286,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         WifiThreadRunner callbackThreadRunner = mock(WifiThreadRunner.class);
 
         // Positive
-        DialogHandle dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        DialogHandle dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         Intent intent = verifyStartActivityAsUser(1, mWifiContext);
         int dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
         mDialogManager.replyToSimpleDialog(dialogId, WifiManager.DIALOG_REPLY_POSITIVE);
         dispatchMockWifiThreadRunner(callbackThreadRunner);
         verify(callback, times(1)).onPositiveButtonClicked();
@@ -268,13 +308,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verify(callback, times(0)).onCancelled();
 
         // Negative
-        dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(2, mWifiContext);
         dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
         mDialogManager.replyToSimpleDialog(dialogId, WifiManager.DIALOG_REPLY_NEGATIVE);
         dispatchMockWifiThreadRunner(callbackThreadRunner);
         verify(callback, times(1)).onPositiveButtonClicked();
@@ -283,13 +322,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verify(callback, times(0)).onCancelled();
 
         // Neutral
-        dialogHandle = mDialogManager.createSimpleDialog(
-                TEST_TITLE, TEST_MESSAGE, TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT,
-                TEST_NEUTRAL_BUTTON_TEXT, callback, callbackThreadRunner);
+        dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(3, mWifiContext);
         dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
         mDialogManager.replyToSimpleDialog(dialogId, WifiManager.DIALOG_REPLY_NEUTRAL);
         dispatchMockWifiThreadRunner(callbackThreadRunner);
         verify(callback, times(1)).onPositiveButtonClicked();
@@ -298,13 +336,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verify(callback, times(0)).onCancelled();
 
         // Cancelled
-        dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(4, mWifiContext);
         dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
         mDialogManager.replyToSimpleDialog(dialogId, WifiManager.DIALOG_REPLY_CANCELLED);
         dispatchMockWifiThreadRunner(callbackThreadRunner);
         verify(callback, times(1)).onPositiveButtonClicked();
@@ -325,13 +362,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
 
 
         // Launch and dismiss dialog.
-        DialogHandle dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        DialogHandle dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         Intent intent = verifyStartActivityAsUser(1, mWifiContext);
         int dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
         dismissDialogSynchronous(dialogHandle, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(2, mWifiContext);
         verifyDismissIntent(intent);
@@ -347,13 +383,12 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verifyStartActivityAsUser(2, mWifiContext);
 
         // Launch dialog again
-        dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(3, mWifiContext);
         dialogId = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
 
         // Callback should receive replies to the corresponding dialogId now.
         mDialogManager.replyToSimpleDialog(dialogId, WifiManager.DIALOG_REPLY_POSITIVE);
@@ -372,23 +407,21 @@ public class WifiDialogManagerTest extends WifiBaseTest {
 
         // Launch Dialog1
         SimpleDialogCallback callback1 = mock(SimpleDialogCallback.class);
-        DialogHandle dialogHandle1 = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback1, callbackThreadRunner);
+        DialogHandle dialogHandle1 = createTestSimpleDialog(callback1, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle1, mWifiThreadRunner);
         Intent intent = verifyStartActivityAsUser(1, mWifiContext);
         int dialogId1 = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
 
         // Launch Dialog2
         SimpleDialogCallback callback2 = mock(SimpleDialogCallback.class);
-        DialogHandle dialogHandle2 = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback2, callbackThreadRunner);
+        DialogHandle dialogHandle2 = createTestSimpleDialog(callback2, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle2, mWifiThreadRunner);
         intent = verifyStartActivityAsUser(2, mWifiContext);
         int dialogId2 = verifySimpleDialogLaunchIntent(intent, TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
+                TEST_LIST_LABELS, TEST_LIST_CONTENTS, TEST_POSITIVE_BUTTON_TEXT,
+                TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT);
 
         // callback1 notified
         mDialogManager.replyToSimpleDialog(dialogId1, WifiManager.DIALOG_REPLY_POSITIVE);
@@ -429,9 +462,7 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         when(window.getAttributes()).thenReturn(layoutParams);
         when(dialog.getWindow()).thenReturn(window);
         when(mFrameworkFacade.makeAlertDialogBuilder(any())).thenReturn(builder);
-        DialogHandle dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        DialogHandle dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
 
         ArgumentCaptor<DialogInterface.OnClickListener> positiveButtonListenerCaptor =
@@ -453,7 +484,8 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verify(builder).setNeutralButton(eq(TEST_NEUTRAL_BUTTON_TEXT),
                 neutralButtonListenerCaptor.capture());
         verify(builder).setOnCancelListener(cancelListenerCaptor.capture());
-        verify(mWifiThreadRunner, never()).postDelayed(any(Runnable.class), anyInt(), anyString());
+        verify(mWifiThreadRunner, never()).postDelayed(any(Runnable.class), anyInt(), anyString(),
+                any());
 
         // Positive
         positiveButtonListenerCaptor.getValue().onClick(dialog, DialogInterface.BUTTON_POSITIVE);
@@ -484,9 +516,7 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         WifiThreadRunner callbackThreadRunner = mock(WifiThreadRunner.class);
 
 
-        DialogHandle dialogHandle = mDialogManager.createSimpleDialog(TEST_TITLE, TEST_MESSAGE,
-                TEST_POSITIVE_BUTTON_TEXT, TEST_NEGATIVE_BUTTON_TEXT, TEST_NEUTRAL_BUTTON_TEXT,
-                callback, callbackThreadRunner);
+        DialogHandle dialogHandle = createTestSimpleDialog(callback, callbackThreadRunner);
         launchDialogSynchronous(dialogHandle, mWifiThreadRunner);
 
         verify(mWifiContext, never()).startActivityAsUser(any(), eq(UserHandle.CURRENT));
@@ -542,7 +572,8 @@ public class WifiDialogManagerTest extends WifiBaseTest {
         verify(builder).setNeutralButton(eq(TEST_NEUTRAL_BUTTON_TEXT),
                 neutralButtonListenerCaptor.capture());
         verify(builder).setOnCancelListener(cancelListenerCaptor.capture());
-        verify(mWifiThreadRunner, never()).postDelayed(any(Runnable.class), anyInt(), anyString());
+        verify(mWifiThreadRunner, never()).postDelayed(any(Runnable.class), anyInt(), anyString(),
+                any());
 
         // Positive
         positiveButtonListenerCaptor.getValue().onClick(dialog, DialogInterface.BUTTON_POSITIVE);
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiLinkLayerStatsTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiLinkLayerStatsTest.java
index a07a2938f9..eff96e0aca 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiLinkLayerStatsTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiLinkLayerStatsTest.java
@@ -251,4 +251,10 @@ public class WifiLinkLayerStatsTest extends WifiBaseTest {
         assertEquals(0.0, mWifiInfo.getSuccessfulTxPacketsPerSecond(), 0.0001);
         assertEquals(0.0, mWifiInfo.getSuccessfulRxPacketsPerSecond(), 0.0001);
     }
+
+    @Test
+    public void testAggregateLinkLayerStatsWithNullOrEmptyLinks() throws Exception {
+        // No exception
+        mWifiLinkLayerStats.aggregateLinkLayerStats();
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiLockManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiLockManagerTest.java
index cbdf1e80e0..f7374edf1d 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiLockManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiLockManagerTest.java
@@ -39,7 +39,10 @@ import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
 import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.verifyNoInteractions;
+import static org.mockito.Mockito.verifyNoMoreInteractions;
 import static org.mockito.Mockito.when;
+import static org.mockito.Mockito.withSettings;
 
 import android.app.ActivityManager;
 import android.content.Context;
@@ -56,10 +59,13 @@ import android.os.test.TestLooper;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.util.WifiPermissionsUtil;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.ArgumentCaptor;
@@ -67,6 +73,7 @@ import org.mockito.Captor;
 import org.mockito.InOrder;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 
 import java.io.PrintWriter;
 import java.io.StringWriter;
@@ -90,6 +97,7 @@ public class WifiLockManagerTest extends WifiBaseTest {
     private ActivityManager.OnUidImportanceListener mUidImportanceListener;
 
     WifiLockManager mWifiLockManager;
+    MockitoSession mSession;
     @Mock Clock mClock;
     @Mock BatteryStatsManager mBatteryStats;
     @Mock IBinder mBinder;
@@ -108,7 +116,7 @@ public class WifiLockManagerTest extends WifiBaseTest {
     @Mock WifiPermissionsUtil mWifiPermissionsUtil;
     @Mock WifiDeviceStateChangeManager mWifiDeviceStateChangeManager;
     TestLooper mLooper;
-    Handler mHandler;
+    private WifiThreadRunner mWifiThreadRunner;
 
     @Captor
     ArgumentCaptor<WifiDeviceStateChangeManager.StateChangeCallback>
@@ -129,8 +137,13 @@ public class WifiLockManagerTest extends WifiBaseTest {
                 .addNode(DEFAULT_TEST_UID_2, "tag2");
 
         MockitoAnnotations.initMocks(this);
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .startMocking();
+
         mLooper = new TestLooper();
-        mHandler = new Handler(mLooper.getLooper());
+        Handler handler = new Handler(mLooper.getLooper());
+        mWifiThreadRunner = new WifiThreadRunner(handler);
         when(mContext.getSystemService(Context.ACTIVITY_SERVICE)).thenReturn(mActivityManager);
         when(mContext.getSystemService(ActivityManager.class)).thenReturn(mActivityManager);
         when(mContext.getSystemService(PowerManager.class)).thenReturn(mPowerManager);
@@ -146,6 +159,7 @@ public class WifiLockManagerTest extends WifiBaseTest {
         when(mContext.getResources()).thenReturn(mResources);
         when(mResources.getBoolean(
                 R.bool.config_wifiLowLatencyLockDisableChipPowerSave)).thenReturn(true);
+        when(Flags.wifiLockActivatedByP2pOrAware()).thenReturn(true);
 
         mWifiLockManager =
                 new WifiLockManager(
@@ -153,7 +167,7 @@ public class WifiLockManagerTest extends WifiBaseTest {
                         mBatteryStats,
                         mActiveModeWarden,
                         mFrameworkFacade,
-                        mHandler,
+                        mWifiThreadRunner,
                         mClock,
                         mWifiMetrics,
                         mDeviceConfigFacade,
@@ -163,6 +177,13 @@ public class WifiLockManagerTest extends WifiBaseTest {
                 .registerStateChangeCallback(mStateChangeCallbackArgumentCaptor.capture());
     }
 
+    @After
+    public void cleanUp() {
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
+    }
+
     private void acquireWifiLockSuccessful(int lockMode, String tag, IBinder binder, WorkSource ws)
             throws Exception {
         ArgumentCaptor<IBinder.DeathRecipient> deathRecipient =
@@ -968,11 +989,11 @@ public class WifiLockManagerTest extends WifiBaseTest {
     }
 
     /**
-     * Test if an exempted foreground app acquires a low-latency lock, and screen is off,
-     * then that lock becomes effective.
+     * Test that if an Android Auto exempted foreground app acquires a low-latency lock,
+     * and the screen is off, then that lock becomes effective.
      */
     @Test
-    public void testForegroundAppAcquireLowLatencyScreenOffExemption() throws Exception {
+    public void testForegroundAppAcquireLowLatencyScreenOffAutoExemption() throws Exception {
         // Set screen off, and app is foreground
         setScreenState(false);
         when(mWifiPermissionsUtil.checkRequestCompanionProfileAutomotiveProjectionPermission(
@@ -987,6 +1008,27 @@ public class WifiLockManagerTest extends WifiBaseTest {
                 mWifiLockManager.getStrongestLockMode());
     }
 
+    /**
+     * Test that if a nearby-streaming exempted foreground app acquires a low-latency lock,
+     * and the screen is off, then that lock becomes effective.
+     */
+    @Test
+    public void testForegroundAppAcquireLowLatencyScreenOffNearbyStreamExemption()
+            throws Exception {
+        // Set screen off and app is in the foreground
+        setScreenState(false);
+        when(mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(
+                anyInt())).thenReturn(true);
+        when(mActivityManager.getUidImportance(anyInt())).thenReturn(
+                ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND);
+        // Acquire the lock.
+        acquireWifiLockSuccessful(WifiManager.WIFI_MODE_FULL_LOW_LATENCY, "",
+                mBinder, mWorkSource);
+        // Check for low latency.
+        assertEquals(WifiManager.WIFI_MODE_FULL_LOW_LATENCY,
+                mWifiLockManager.getStrongestLockMode());
+    }
+
     /**
      * Test if an app in background acquires a low-latency lock, and screen is on,
      * then that lock becomes ineffective.
@@ -1006,11 +1048,11 @@ public class WifiLockManagerTest extends WifiBaseTest {
     }
 
     /**
-     * Test if an exempted app not in foreground acquires a low-latency lock, and screen is on,
-     * then that lock becomes effective.
+     * Test that if an Android Auto exempted app not in foreground acquires a low-latency lock,
+     * and the screen is on, then that lock becomes effective.
      */
     @Test
-    public void testBackgroundAppAcquireLowLatencyScreenOnExemption() throws Exception {
+    public void testBackgroundAppAcquireLowLatencyScreenOnAutoExemption() throws Exception {
         // Set screen on, and app is foreground service.
         setScreenState(true);
         when(mWifiPermissionsUtil.checkRequestCompanionProfileAutomotiveProjectionPermission(
@@ -1025,6 +1067,26 @@ public class WifiLockManagerTest extends WifiBaseTest {
                 mWifiLockManager.getStrongestLockMode());
     }
 
+    /**
+     * Test that if a nearby-streaming exempted app with a low priority acquires a low-latency lock,
+     * and screen is on, then that lock becomes effective.
+     */
+    @Test
+    public void testBackgroundAppAcquireLowLatencyScreenOnNearbyStreamExemption() throws Exception {
+        // Set screen on and app is background service.
+        setScreenState(true);
+        when(mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(
+                anyInt())).thenReturn(true);
+        when(mActivityManager.getUidImportance(anyInt())).thenReturn(
+                ActivityManager.RunningAppProcessInfo.IMPORTANCE_SERVICE);
+        // Acquire the lock.
+        acquireWifiLockSuccessful(WifiManager.WIFI_MODE_FULL_LOW_LATENCY, "",
+                mBinder, mWorkSource);
+        // Check for low latency.
+        assertEquals(WifiManager.WIFI_MODE_FULL_LOW_LATENCY,
+                mWifiLockManager.getStrongestLockMode());
+    }
+
     /**
      * Test when acquiring a low-latency lock from a foreground app, and screen is on, then,
      * WifiLockManager calls to enable low-latency mechanism for devices supporting this.
@@ -2244,4 +2306,90 @@ public class WifiLockManagerTest extends WifiBaseTest {
         verify(mBatteryStats, times(numReports)).reportFullWifiLockAcquiredFromSource(mWorkSource);
         verify(mBatteryStats, times(numReports)).reportFullWifiLockReleasedFromSource(mWorkSource);
     }
+
+    /**
+     * Test that connection state changes are handled correctly when both D2D-allowed and
+     * non D2D-allowed apps hold a WifiLock.
+     */
+    @Test
+    public void testConnectionStateChangeWithD2dAndNonD2dAllowedApps() throws Exception {
+        // Setup two apps, where only App 1 has the nearby streaming permission (which
+        // allows D2D connections to satisfy its connection requirement).
+        IBinder d2dAllowedBinder = mock(IBinder.class);
+        WorkSource d2dAllowedWs = new WorkSource(DEFAULT_TEST_UID_1);
+        IBinder nonD2dAllowedBinder = mock(IBinder.class);
+        WorkSource nonD2dAllowedWs = new WorkSource(DEFAULT_TEST_UID_2);
+        when(mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(
+                DEFAULT_TEST_UID_1)).thenReturn(true);
+        when(mWifiPermissionsUtil.checkRequestCompanionProfileNearbyDeviceStreamingPermission(
+                DEFAULT_TEST_UID_2)).thenReturn(false);
+
+        // Screen is on and both apps are in the foreground.
+        setScreenState(true);
+        when(mActivityManager.getUidImportance(anyInt())).thenReturn(
+                ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND);
+
+        // When no connections are active, low-latency mode should not be enabled by either app.
+        assertTrue(mWifiLockManager.acquireWifiLock(WifiManager.WIFI_MODE_FULL_LOW_LATENCY, "",
+                d2dAllowedBinder, d2dAllowedWs));
+        assertTrue(mWifiLockManager.acquireWifiLock(WifiManager.WIFI_MODE_FULL_LOW_LATENCY, "",
+                nonD2dAllowedBinder, nonD2dAllowedWs));
+        assertEquals(WifiManager.WIFI_MODE_NO_LOCKS_HELD,
+                mWifiLockManager.getStrongestLockMode());
+        verifyNoInteractions(mBatteryStats);
+
+        // Starting a STA connection should affect blaming for both apps.
+        mWifiLockManager.updateWifiClientConnected(mClientModeManager, true);
+        verify(mBatteryStats).reportFullWifiLockAcquiredFromSource(d2dAllowedWs);
+        verify(mBatteryStats).reportFullWifiLockAcquiredFromSource(nonD2dAllowedWs);
+
+        // Starting a P2P connection should not affect blaming for any app.
+        mWifiLockManager.updateP2pConnected(true);
+        verifyNoMoreInteractions(mBatteryStats);
+
+        // Ending the STA connection should only affect blaming for the non D2D-allowed app.
+        mWifiLockManager.updateWifiClientConnected(mClientModeManager, false);
+        verify(mBatteryStats).reportFullWifiLockReleasedFromSource(nonD2dAllowedWs);
+        verify(mBatteryStats, never()).reportFullWifiLockReleasedFromSource(d2dAllowedWs);
+
+        // Ending the P2P connection should only affect blaming for the D2D-allowed app.
+        mWifiLockManager.updateP2pConnected(false);
+        verify(mBatteryStats).reportFullWifiLockReleasedFromSource(d2dAllowedWs);
+        verifyNoMoreInteractions(mBatteryStats);
+    }
+
+    /**
+     * Test that D2D connections do not count toward the connection requirement
+     * for non D2D-allowed apps, when a screen state change occurs.
+     */
+    @Test
+    public void testScreenStateChangeWithMultipleConnectionTypes() throws Exception {
+        // Acquire lock when app is in the foreground, screen is off, and P2P connection is active.
+        setScreenState(false);
+        mWifiLockManager.updateP2pConnected(true);
+        when(mActivityManager.getUidImportance(DEFAULT_TEST_UID_1)).thenReturn(
+                ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND);
+        assertTrue(mWifiLockManager.acquireWifiLock(WifiManager.WIFI_MODE_FULL_LOW_LATENCY, "",
+                mBinder, mWorkSource));
+
+        // Low-latency should be disabled and the app should not be blamed.
+        assertEquals(WifiManager.WIFI_MODE_NO_LOCKS_HELD,
+                mWifiLockManager.getStrongestLockMode());
+        verifyNoInteractions(mBatteryStats);
+
+        // Enabling the screen should not update the blame, since the P2P connection
+        // does not satisfy this app's connection requirement.
+        setScreenState(true);
+        assertEquals(WifiManager.WIFI_MODE_NO_LOCKS_HELD,
+                mWifiLockManager.getStrongestLockMode());
+        verifyNoInteractions(mBatteryStats);
+
+        // Starting a STA connection and restarting the screen should update the blame.
+        setScreenState(false);
+        mWifiLockManager.updateWifiClientConnected(mClientModeManager, true);
+        setScreenState(true);
+        assertEquals(WifiManager.WIFI_MODE_FULL_LOW_LATENCY,
+                mWifiLockManager.getStrongestLockMode());
+        verify(mBatteryStats).reportFullWifiLockAcquiredFromSource(mWorkSource);
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiMetricsTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiMetricsTest.java
index 1e9c381554..20e08f09e9 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiMetricsTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiMetricsTest.java
@@ -2556,7 +2556,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(false),
                 eq(1), eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(),
                 anyInt(), anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ),
-                eq(WIFI_CONNECTING_DURATION_MS), eq(WIFI_CONNECTING_DURATION_MS + 1)));
+                eq(WIFI_CONNECTING_DURATION_MS), eq(WIFI_CONNECTING_DURATION_MS + 1), eq(0)));
     }
 
     /**
@@ -6261,7 +6261,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED), anyBoolean(), anyInt(), anyInt(),
                 anyInt(), anyInt(), anyInt(), anyInt(), anyBoolean(), anyInt(), anyBoolean(),
                 anyBoolean(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(),
-                eq(TEST_UID), anyInt(), anyLong(), anyLong()),
+                eq(TEST_UID), anyInt(), anyLong(), anyLong(), eq(0)),
                 times(0));
     }
 
@@ -6277,7 +6277,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED), anyBoolean(), anyInt(), anyInt(),
                 anyInt(), anyInt(), anyInt(), anyInt(), anyBoolean(), anyInt(), anyBoolean(),
                 anyBoolean(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(),
-                eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()),
+                eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)),
                 times(0));
     }
 
@@ -6310,7 +6310,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(0), eq(true), eq(false), eq(1), eq(TEST_CONNECTION_FAILURE_STATUS_CODE),
                 anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), eq(TEST_UID),
                 eq(TEST_CANDIDATE_FREQ),
-                eq(WIFI_CONNECTING_DURATION_MS), eq(WIFI_CONNECTING_DURATION_MS)),
+                eq(WIFI_CONNECTING_DURATION_MS), eq(WIFI_CONNECTING_DURATION_MS), eq(0)),
                 times(1));
     }
 
@@ -6347,7 +6347,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(true),
                 eq(0),  eq(true), eq(true), eq(1), eq(TEST_CONNECTION_FAILURE_STATUS_CODE),
                 anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), eq(TEST_UID),
-                eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()),
+                eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)),
                 times(1));
     }
 
@@ -6363,7 +6363,9 @@ public class WifiMetricsTest extends WifiBaseTest {
                 WifiMetricsProto.ConnectionEvent.AUTH_FAILURE_NONE, TEST_CANDIDATE_FREQ,
                 TEST_CONNECTION_FAILURE_STATUS_CODE);
 
-        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, 0, 0, 0, 0);
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME,
+                WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__DISCONNECT_NEW_CONNECTION_USER,
+                0, 0, 0);
 
         ExtendedMockito.verify(() -> WifiStatsLog.write(
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED), anyBoolean(),
@@ -6371,7 +6373,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__AUTOCONNECT_BOOT),
                 anyBoolean(), anyInt(), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)));
 
         mWifiMetrics.startConnectionEvent(TEST_IFACE_NAME, createComplexWifiConfig(),
                 "RED", WifiMetricsProto.ConnectionEvent.ROAM_ENTERPRISE, false,
@@ -6383,7 +6385,9 @@ public class WifiMetricsTest extends WifiBaseTest {
                 WifiMetricsProto.ConnectionEvent.AUTH_FAILURE_NONE, TEST_CANDIDATE_FREQ,
                 TEST_CONNECTION_FAILURE_STATUS_CODE);
 
-        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, 0, 0, 0, 0);
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME,
+                WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__DISCONNECT_NEW_CONNECTION_OTHERS, // NOLINT
+                0, 0, 0);
 
         ExtendedMockito.verify(() -> WifiStatsLog.write(
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED), anyBoolean(),
@@ -6391,7 +6395,8 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__RECONNECT_SAME_NETWORK),
                 anyBoolean(), anyInt(), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(
+                        WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__DISCONNECT_NEW_CONNECTION_USER))); // NOLINT
 
         WifiConfiguration configOtherNetwork = createComplexWifiConfig();
         configOtherNetwork.networkId = 21;
@@ -6417,7 +6422,8 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__AUTOCONNECT_CONFIGURED_NETWORK),
                 anyBoolean(), anyInt(), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(
+                        WifiStatsLog.WIFI_DISCONNECT_REPORTED__FAILURE_CODE__DISCONNECT_NEW_CONNECTION_OTHERS))); // NOLINT
 
         WifiConfiguration config = createComplexWifiConfig();
         config.networkId = 42;
@@ -6440,7 +6446,71 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__MANUAL),
                 anyBoolean(), anyInt(), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)));
+    }
+
+    @Test
+    public void testWifiDisconnectAtomEmittedOnDisconnectFromMultipleStations() {
+        // start connect on 2 different interfaces
+        mWifiMetrics.startConnectionEvent(TEST_IFACE_NAME, createComplexWifiConfig(),
+                "BSSID1", WifiMetricsProto.ConnectionEvent.ROAM_ENTERPRISE, false,
+                WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_PRIMARY, TEST_UID);
+        mWifiMetrics.startConnectionEvent(TEST_IFACE_NAME2, createComplexWifiConfig(),
+                "BSSID2", WifiMetricsProto.ConnectionEvent.ROAM_ENTERPRISE, false,
+                WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_LOCAL_ONLY,
+                TEST_UID);
+
+        // connection establish for both interfaces at same time (1000)
+        long connectionEndTimeMs = 1000;
+        when(mClock.getElapsedSinceBootMillis()).thenReturn(connectionEndTimeMs);
+        mWifiMetrics.endConnectionEvent(TEST_IFACE_NAME,
+                WifiMetrics.ConnectionEvent.FAILURE_NONE,
+                WifiMetricsProto.ConnectionEvent.HLF_NONE,
+                WifiMetricsProto.ConnectionEvent.AUTH_FAILURE_NONE, TEST_CANDIDATE_FREQ,
+                TEST_CONNECTION_FAILURE_STATUS_CODE);
+        mWifiMetrics.endConnectionEvent(TEST_IFACE_NAME2,
+                WifiMetrics.ConnectionEvent.FAILURE_NONE,
+                WifiMetricsProto.ConnectionEvent.HLF_NONE,
+                WifiMetricsProto.ConnectionEvent.AUTH_FAILURE_NONE, TEST_CANDIDATE_FREQ,
+                TEST_CONNECTION_FAILURE_STATUS_CODE);
+
+        // disconnect for TEST_IFACE_NAME at 2000
+        long wifiDisconnectTimeMs1 = 2000;
+        when(mClock.getElapsedSinceBootMillis()).thenReturn(wifiDisconnectTimeMs1);
+        int linkSpeed = 100;
+        int reason = 42;
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, reason, TEST_CANDIDATE_LEVEL,
+                linkSpeed, 0);
+        ExtendedMockito.verify(() -> WifiStatsLog.write(
+                eq(WifiStatsLog.WIFI_DISCONNECT_REPORTED),
+                eq((int) (wifiDisconnectTimeMs1 - connectionEndTimeMs) / 1000),
+                eq(reason),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__BAND__BAND_2G),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__AUTH_TYPE__AUTH_TYPE_WPA2_PSK),
+                eq(TEST_CANDIDATE_LEVEL),
+                eq(linkSpeed),
+                eq((int) wifiDisconnectTimeMs1 / 1000),
+                eq((int) (wifiDisconnectTimeMs1 - connectionEndTimeMs) / 1000),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_PRIMARY),
+                anyInt(), anyInt(), anyInt(), anyInt(), anyInt()));
+
+        // disconnect for TEST_IFACE_NAME2 at 5000
+        long wifiDisconnectTimeMs2 = 5000;
+        when(mClock.getElapsedSinceBootMillis()).thenReturn(wifiDisconnectTimeMs2);
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME2, reason, TEST_CANDIDATE_LEVEL,
+                linkSpeed, 0);
+        ExtendedMockito.verify(() -> WifiStatsLog.write(
+                eq(WifiStatsLog.WIFI_DISCONNECT_REPORTED),
+                eq((int) (wifiDisconnectTimeMs2 - connectionEndTimeMs) / 1000),
+                eq(reason),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__BAND__BAND_2G),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__AUTH_TYPE__AUTH_TYPE_WPA2_PSK),
+                eq(TEST_CANDIDATE_LEVEL),
+                eq(linkSpeed),
+                eq((int) wifiDisconnectTimeMs2 / 1000),
+                eq((int) (wifiDisconnectTimeMs2 - connectionEndTimeMs) / 1000),
+                eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__ROLE__ROLE_CLIENT_LOCAL_ONLY),
+                anyInt(), anyInt(), anyInt(), anyInt(), anyInt()));
     }
 
     @Test
@@ -6461,9 +6531,20 @@ public class WifiMetricsTest extends WifiBaseTest {
         when(mClock.getElapsedSinceBootMillis()).thenReturn(wifiDisconnectTimeMs);
         int linkSpeed = 100;
         int reason = 42;
-        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, reason, TEST_CANDIDATE_LEVEL,
+
+        // Disconnect reported on another interface will not log session from the connected
+        // interface
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME2, reason, TEST_CANDIDATE_LEVEL,
                 linkSpeed, 0);
+        ExtendedMockito.verify(() -> WifiStatsLog.write(
+                eq(WifiStatsLog.WIFI_DISCONNECT_REPORTED),
+                anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(),
+                anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt(), anyInt()),
+                times(0));
 
+        // Disconnect on the connected interface triggers logging
+        mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, reason, TEST_CANDIDATE_LEVEL,
+                linkSpeed, 0);
         ExtendedMockito.verify(() -> WifiStatsLog.write(
                 eq(WifiStatsLog.WIFI_DISCONNECT_REPORTED),
                 eq((int) (wifiDisconnectTimeMs - connectionEndTimeMs) / 1000),
@@ -6601,7 +6682,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__AUTOCONNECT_BOOT),
                 anyBoolean(), eq(10), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)));
 
         mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, 0, 0, 0, 0);
 
@@ -6623,7 +6704,7 @@ public class WifiMetricsTest extends WifiBaseTest {
                 eq(WifiStatsLog.WIFI_CONNECTION_RESULT_REPORTED__TRIGGER__RECONNECT_SAME_NETWORK),
                 anyBoolean(), eq(20), anyBoolean(), anyBoolean(), anyInt(),
                 eq(TEST_CONNECTION_FAILURE_STATUS_CODE), anyInt(), anyInt(), anyInt(), anyInt(),
-                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong()));
+                anyInt(), eq(TEST_UID), eq(TEST_CANDIDATE_FREQ), anyLong(), anyLong(), eq(0)));
 
         mWifiMetrics.reportNetworkDisconnect(TEST_IFACE_NAME, 0, 0, 0, 0);
     }
@@ -7061,9 +7142,9 @@ public class WifiMetricsTest extends WifiBaseTest {
 
     @Test
     public void testWifiStateChanged() throws Exception {
-        mWifiMetrics.reportWifiStateChanged(true, true, false);
+        mWifiMetrics.reportWifiStateChanged(true, true, false, 1010);
         ExtendedMockito.verify(() -> WifiStatsLog.write(
-                WifiStatsLog.WIFI_STATE_CHANGED, true, true, false));
+                WifiStatsLog.WIFI_STATE_CHANGED, true, true, false, 1010));
     }
 
     @Test
@@ -7428,10 +7509,6 @@ public class WifiMetricsTest extends WifiBaseTest {
         when(mWifiDataStall.isThroughputSufficient()).thenReturn(false);
         when(mClock.getElapsedSinceBootMillis()).thenReturn((long) 10000);
 
-        WifiMetrics.ConnectionEvent connectionEvent = mWifiMetrics.new ConnectionEvent();
-        WifiMetrics.SessionData currentSession =
-                new WifiMetrics.SessionData(connectionEvent, "", (long) 1000, 0, 0);
-        mWifiMetrics.mCurrentSession = currentSession;
         mWifiMetrics.mLastScreenOffTimeMillis = 1000;
         mWifiMetrics.mLastIgnoredPollTimeMillis = 3000;
 
@@ -7461,11 +7538,6 @@ public class WifiMetricsTest extends WifiBaseTest {
         mWifiMetrics.setIsExternalWifiScorerOn(true, TEST_UID);
         when(mWifiDataStall.isThroughputSufficient()).thenReturn(false);
         when(mClock.getElapsedSinceBootMillis()).thenReturn((long) 10000);
-
-        WifiMetrics.ConnectionEvent connectionEvent = mWifiMetrics.new ConnectionEvent();
-        WifiMetrics.SessionData currentSession =
-                new WifiMetrics.SessionData(connectionEvent, "", (long) 1000, 0, 0);
-        mWifiMetrics.mCurrentSession = currentSession;
         mWifiMetrics.mLastScreenOffTimeMillis = 1000;
         mWifiMetrics.mLastIgnoredPollTimeMillis = 3000;
 
@@ -7508,11 +7580,6 @@ public class WifiMetricsTest extends WifiBaseTest {
     public void logScorerPredictionResult_notDefaultPollingInterval() {
         when(mWifiDataStall.isThroughputSufficient()).thenReturn(false);
         when(mClock.getElapsedSinceBootMillis()).thenReturn((long) 10000);
-
-        WifiMetrics.ConnectionEvent connectionEvent = mWifiMetrics.new ConnectionEvent();
-        WifiMetrics.SessionData currentSession =
-                new WifiMetrics.SessionData(connectionEvent, "", (long) 1000, 0, 0);
-        mWifiMetrics.mCurrentSession = currentSession;
         mWifiMetrics.mLastScreenOffTimeMillis = 1000;
         mWifiMetrics.mLastIgnoredPollTimeMillis = 3000;
 
@@ -7541,11 +7608,6 @@ public class WifiMetricsTest extends WifiBaseTest {
     public void logScorerPredictionResult_withUnusableEvent() {
         when(mWifiDataStall.isThroughputSufficient()).thenReturn(false);
         when(mClock.getElapsedSinceBootMillis()).thenReturn((long) 10000);
-
-        WifiMetrics.ConnectionEvent connectionEvent = mWifiMetrics.new ConnectionEvent();
-        WifiMetrics.SessionData currentSession =
-                new WifiMetrics.SessionData(connectionEvent, "", (long) 1000, 0, 0);
-        mWifiMetrics.mCurrentSession = currentSession;
         mWifiMetrics.mLastScreenOffTimeMillis = 1000;
         mWifiMetrics.mLastIgnoredPollTimeMillis = 3000;
 
@@ -7576,11 +7638,6 @@ public class WifiMetricsTest extends WifiBaseTest {
     public void logScorerPredictionResult_wifiSufficient() {
         when(mWifiDataStall.isThroughputSufficient()).thenReturn(true);
         when(mClock.getElapsedSinceBootMillis()).thenReturn((long) 10000);
-
-        WifiMetrics.ConnectionEvent connectionEvent = mWifiMetrics.new ConnectionEvent();
-        WifiMetrics.SessionData currentSession =
-                new WifiMetrics.SessionData(connectionEvent, "", (long) 1000, 0, 0);
-        mWifiMetrics.mCurrentSession = currentSession;
         mWifiMetrics.mLastScreenOffTimeMillis = 1000;
         mWifiMetrics.mLastIgnoredPollTimeMillis = 3000;
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiMulticastLockManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiMulticastLockManagerTest.java
index 8ce4a8d191..306dc7bea0 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiMulticastLockManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiMulticastLockManagerTest.java
@@ -90,7 +90,6 @@ public class WifiMulticastLockManagerTest extends WifiBaseTest {
                 .thenReturn(mFilterController2);
         when(mClientModeManager2.getRole()).thenReturn(ROLE_CLIENT_SECONDARY_TRANSIENT);
 
-        when(mActiveModeWarden.getPrimaryClientModeManager()).thenReturn(mClientModeManager);
         when(mContext.getSystemService(ActivityManager.class)).thenReturn(mActivityManager);
         mManager = new WifiMulticastLockManager(mActiveModeWarden, mBatteryStats,
                 mLooper.getLooper(), mContext, mClock, mWifiMetrics, mWifiPermissionsUtil);
@@ -99,6 +98,7 @@ public class WifiMulticastLockManagerTest extends WifiBaseTest {
                 mPrimaryChangedCallbackCaptor.capture());
         verify(mActivityManager).addOnUidImportanceListener(
                 mUidImportanceListenerCaptor.capture(), anyInt());
+        mPrimaryChangedCallbackCaptor.getValue().onChange(null, mClientModeManager);
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSelectorTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSelectorTest.java
index 191d7d007e..e7b6e8fce8 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSelectorTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSelectorTest.java
@@ -1454,6 +1454,50 @@ public class WifiNetworkSelectorTest extends WifiBaseTest {
         WifiConfigurationTestUtil.assertConfigurationEqual(userChoice, candidate);
     }
 
+    /**
+     * Verify connect choice does not trigger when below MINIMUM_CONNECT_CHOICE_RSSI
+     */
+    @Test
+    public void testUserConnectChoiceDoesNotOverrideWhenRssiLowerThanThreshold() {
+        String[] ssids = {"\"test1\"", "\"test2\""};
+        String[] bssids = {"6c:f3:7f:ae:8c:f3", "6c:f3:7f:ae:8c:f4"};
+        int[] freqs = {2437, 5180};
+        String[] caps = {"[WPA2-PSK][ESS]", "[WPA2-PSK][ESS]"};
+        int observedUserChoiceRssi = WifiNetworkSelector.MINIMUM_CONNECT_CHOICE_RSSI - 10;
+        int[] levels = {mThresholdMinimumRssi2G + RSSI_BUMP, observedUserChoiceRssi};
+        int[] securities = {SECURITY_PSK, SECURITY_PSK};
+        ScanDetailsAndWifiConfigs scanDetailsAndConfigs =
+                WifiNetworkSelectorTestUtil.setupScanDetailsAndConfigStore(ssids, bssids,
+                        freqs, caps, levels, securities, mWifiConfigManager, mClock);
+        List<ScanDetail> scanDetails = scanDetailsAndConfigs.getScanDetails();
+        WifiConfiguration[] wifiConfigs = scanDetailsAndConfigs.getWifiConfigs();
+        HashSet<String> blocklist = new HashSet<>();
+
+        // PlaceholderNominator should select the first network in the list.
+        WifiConfiguration networkSelectorChoice = wifiConfigs[0];
+        networkSelectorChoice.getNetworkSelectionStatus()
+                .setSeenInLastQualifiedNetworkSelection(true);
+
+        // verify user choice is not selected because it does not meet the minimum threshold
+        WifiConfiguration userChoice = wifiConfigs[1];
+        userChoice.getNetworkSelectionStatus().setCandidate(scanDetails.get(1).getScanResult());
+        userChoice.getNetworkSelectionStatus().setConnectChoice(null);
+        networkSelectorChoice.getNetworkSelectionStatus()
+                .setConnectChoice(userChoice.getProfileKey());
+        networkSelectorChoice.getNetworkSelectionStatus()
+                .setConnectChoiceRssi(observedUserChoiceRssi
+                        + mScoringParams.getEstimateRssiErrorMargin());
+        assertEquals(observedUserChoiceRssi,
+                userChoice.getNetworkSelectionStatus().getCandidate().level);
+        List<WifiCandidates.Candidate> candidates = mWifiNetworkSelector.getCandidatesFromScan(
+                scanDetails, blocklist,
+                Arrays.asList(new ClientModeManagerState(TEST_IFACE_NAME, false, true, mWifiInfo,
+                        false, ROLE_CLIENT_PRIMARY)),
+                false, true, true, Collections.emptySet(), false, 0);
+        WifiConfiguration candidate = mWifiNetworkSelector.selectNetwork(candidates);
+        WifiConfigurationTestUtil.assertConfigurationEqual(networkSelectorChoice, candidate);
+    }
+
     /**
      * Verify NetworkSelectionStatus#setConnectChoiceRssi(int rssi) causes the user connect choice
      * logic to ignore connect choice networks with RSSI lower than the threshold set.
@@ -1464,7 +1508,7 @@ public class WifiNetworkSelectorTest extends WifiBaseTest {
         String[] bssids = {"6c:f3:7f:ae:8c:f3", "6c:f3:7f:ae:8c:f4"};
         int[] freqs = {2437, 5180};
         String[] caps = {"[WPA2-PSK][ESS]", "[WPA2-PSK][ESS]"};
-        int observedUserChoiceRssi = mThresholdMinimumRssi5G + RSSI_BUMP;
+        int observedUserChoiceRssi = WifiNetworkSelector.MINIMUM_CONNECT_CHOICE_RSSI;
         int[] levels = {mThresholdMinimumRssi2G + RSSI_BUMP, observedUserChoiceRssi};
         int[] securities = {SECURITY_PSK, SECURITY_PSK};
         ScanDetailsAndWifiConfigs scanDetailsAndConfigs =
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSuggestionsManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSuggestionsManagerTest.java
index 346cc96d93..8fb9b21751 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSuggestionsManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiNetworkSuggestionsManagerTest.java
@@ -186,6 +186,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
     private @Mock ActivityManager mActivityManager;
     private @Mock WifiScoreCard mWifiScoreCard;
     private @Mock WifiKeyStore mWifiKeyStore;
+    private @Mock WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
     private @Mock WifiDialogManager.DialogHandle mDialogHandle;
     private @Mock Notification.Builder mNotificationBuilder;
     private @Mock Notification mNotification;
@@ -195,6 +196,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
     private @Mock WifiGlobals mWifiGlobals;
     private @Mock SsidTranslator mSsidTranslator;
     private @Mock Clock mClock;
+    private @Mock BuildProperties mBuildProperties;
     private MockitoSession mStaticMockSession = null;
     private TestLooper mLooper;
     private final ArgumentCaptor<AppOpsManager.OnOpChangedListener> mAppOpChangedListenerCaptor =
@@ -236,6 +238,8 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
         when(mWifiInjector.getWifiNotificationManager()).thenReturn(mWifiNotificationManager);
         when(mWifiInjector.getWifiDialogManager()).thenReturn(mWifiDialogManager);
         when(mWifiInjector.getSsidTranslator()).thenReturn(mSsidTranslator);
+        when(mWifiInjector.getBuildProperties()).thenReturn(mBuildProperties);
+        when(mBuildProperties.isUserBuild()).thenReturn(true);
         when(mNotificationBuilder.setSmallIcon(any())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.setTicker(any())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.setContentTitle(any())).thenReturn(mNotificationBuilder);
@@ -247,8 +251,15 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
         when(mNotificationBuilder.addAction(any())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.setTimeoutAfter(anyLong())).thenReturn(mNotificationBuilder);
         when(mNotificationBuilder.build()).thenReturn(mNotification);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(mDialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
         when(mFrameworkFacade.makeNotificationBuilder(any(), anyString()))
                 .thenReturn(mNotificationBuilder);
         when(mFrameworkFacade.getBroadcast(any(), anyInt(), any(), anyInt()))
@@ -2824,8 +2835,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
         // Simulate user clicking on allow in the dialog.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onPositiveButtonClicked();
 
         // Verify config store interactions.
@@ -2864,8 +2874,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
         // Simulate user clicking on disallow in the dialog.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onNegativeButtonClicked();
         // Ensure we turn off CHANGE_WIFI_STATE app-ops.
         verify(mAppOpsManager).setMode(
@@ -2923,8 +2932,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
         // Simulate user dismissing the dialog via home/back button.
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> dialogCallbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager).createSimpleDialog(
-                any(), any(), any(), any(), any(), dialogCallbackCaptor.capture(), any());
+        verify(mDialogBuilder).setCallback(dialogCallbackCaptor.capture(), any());
         dialogCallbackCaptor.getValue().onCancelled();
         mLooper.dispatchAll();
 
@@ -3109,8 +3117,7 @@ public class WifiNetworkSuggestionsManagerTest extends WifiBaseTest {
     private void validateUserApprovalDialog(String... anyOfExpectedAppNames) {
         verify(mDialogHandle, atLeastOnce()).launchDialog();
         ArgumentCaptor<String> messageCaptor = ArgumentCaptor.forClass(String.class);
-        verify(mWifiDialogManager, atLeastOnce()).createSimpleDialog(
-                any(), messageCaptor.capture(), any(), any(), any(), any(), any());
+        verify(mDialogBuilder, atLeastOnce()).setMessage(messageCaptor.capture());
         String message = messageCaptor.getValue();
         assertNotNull(message);
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiServiceImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiServiceImplTest.java
index 0b6181aa89..e60bb3ad0b 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiServiceImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiServiceImplTest.java
@@ -168,6 +168,7 @@ import android.net.wifi.IOnWifiActivityEnergyInfoListener;
 import android.net.wifi.IOnWifiDriverCountryCodeChangedListener;
 import android.net.wifi.IOnWifiUsabilityStatsListener;
 import android.net.wifi.IPnoScanResultsCallback;
+import android.net.wifi.IPrivilegedConfiguredNetworksListener;
 import android.net.wifi.IScanResultsCallback;
 import android.net.wifi.ISoftApCallback;
 import android.net.wifi.IStringListener;
@@ -922,11 +923,13 @@ public class WifiServiceImplTest extends WifiBaseTest {
         verify(mWifiConnectivityManager).setAutoJoinEnabledExternal(true, false);
         inorder.verify(mWifiMetrics).logUserActionEvent(UserActionEvent.EVENT_TOGGLE_WIFI_ON);
         inorder.verify(mWifiMetrics).incrementNumWifiToggles(eq(true), eq(true));
-        inorder.verify(mWifiMetrics).reportWifiStateChanged(true, false, false);
+        inorder.verify(mWifiMetrics).reportWifiStateChanged(true, false, false,
+                Binder.getCallingUid());
         inorder.verify(mWifiMetrics).logUserActionEvent(eq(UserActionEvent.EVENT_TOGGLE_WIFI_OFF),
                 anyInt());
         inorder.verify(mWifiMetrics).incrementNumWifiToggles(eq(true), eq(false));
-        inorder.verify(mWifiMetrics).reportWifiStateChanged(false, false, false);
+        inorder.verify(mWifiMetrics).reportWifiStateChanged(false, false, false,
+                Binder.getCallingUid());
         verify(mLastCallerInfoManager).put(eq(WifiManager.API_WIFI_ENABLED), anyInt(),
                 anyInt(), anyInt(), anyString(), eq(false));
     }
@@ -948,9 +951,11 @@ public class WifiServiceImplTest extends WifiBaseTest {
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, false));
         inorder.verify(mWifiMetrics).incrementNumWifiToggles(eq(false), eq(true));
-        inorder.verify(mWifiMetrics).reportWifiStateChanged(true, true, false);
+        inorder.verify(mWifiMetrics).reportWifiStateChanged(true, true, false,
+                Binder.getCallingUid());
         inorder.verify(mWifiMetrics).incrementNumWifiToggles(eq(false), eq(false));
-        inorder.verify(mWifiMetrics).reportWifiStateChanged(false, true, false);
+        inorder.verify(mWifiMetrics).reportWifiStateChanged(false, true, false,
+                Binder.getCallingUid());
     }
 
     /**
@@ -969,7 +974,7 @@ public class WifiServiceImplTest extends WifiBaseTest {
         assertFalse(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, false));
         verify(mWifiMetrics, never()).incrementNumWifiToggles(anyBoolean(), anyBoolean());
         verify(mWifiMetrics, never()).reportWifiStateChanged(anyBoolean(), anyBoolean(),
-                anyBoolean());
+                anyBoolean(), anyInt());
     }
 
     /**
@@ -1242,22 +1247,29 @@ public class WifiServiceImplTest extends WifiBaseTest {
 
         // Launch dialog
         WifiDialogManager.DialogHandle dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
+        WifiDialogManager.SimpleDialogBuilder dialogBuilder =
+                mock(WifiDialogManager.SimpleDialogBuilder.class);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(dialogBuilder);
+        when(dialogBuilder.setTitle(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessage(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setPositiveButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNegativeButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNeutralButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setCallback(any(), any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.build()).thenReturn(dialogHandle);
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> callbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         verify(mActiveModeWarden, times(0)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                eq(title),
-                eq(message),
-                eq(positiveButtonText),
-                eq(negativeButtonText),
-                eq(null),
-                callbackCaptor.capture(),
-                any());
+        verify(dialogBuilder).setTitle(eq(title));
+        verify(dialogBuilder).setMessage(eq(message));
+        verify(dialogBuilder).setPositiveButtonText(eq(positiveButtonText));
+        verify(dialogBuilder).setNegativeButtonText(eq(negativeButtonText));
+        verify(dialogBuilder).setCallback(callbackCaptor.capture(), any());
+        verify(dialogBuilder).build();
         verify(dialogHandle).launchDialog();
 
         // Verify extra call to setWifiEnabled won't launch a new dialog
@@ -1265,14 +1277,6 @@ public class WifiServiceImplTest extends WifiBaseTest {
         verify(mActiveModeWarden, times(0)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
         mLooper.dispatchAll();
-        verify(mWifiDialogManager, times(1)).createSimpleDialog(
-                eq(title),
-                eq(message),
-                eq(positiveButtonText),
-                eq(negativeButtonText),
-                eq(null),
-                callbackCaptor.capture(),
-                any());
 
         // Verify the negative reply does not enable wifi
         callbackCaptor.getValue().onNegativeButtonClicked();
@@ -1280,81 +1284,43 @@ public class WifiServiceImplTest extends WifiBaseTest {
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
 
         // Verify the cancel reply does not enable wifi.
-        dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         mLooper.dispatchAll();
         verify(mActiveModeWarden, times(0)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
-        callbackCaptor =
-                ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager, times(2)).createSimpleDialog(
-                eq(title),
-                eq(message),
-                eq(positiveButtonText),
-                eq(negativeButtonText),
-                eq(null),
-                callbackCaptor.capture(),
-                any());
-        verify(dialogHandle).launchDialog();
+        callbackCaptor = ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
+        verify(dialogBuilder, times(2)).setCallback(callbackCaptor.capture(), any());
+        verify(dialogHandle, times(2)).launchDialog();
         callbackCaptor.getValue().onCancelled();
         verify(mActiveModeWarden, times(0)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
 
         // Verify the positive reply will enable wifi.
-        dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         mLooper.dispatchAll();
         verify(mActiveModeWarden, times(0)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
-        callbackCaptor =
-                ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager, times(3)).createSimpleDialog(
-                eq(title),
-                eq(message),
-                eq(positiveButtonText),
-                eq(negativeButtonText),
-                eq(null),
-                callbackCaptor.capture(),
-                any());
-        verify(dialogHandle).launchDialog();
+        callbackCaptor = ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
+        verify(dialogBuilder, times(3)).setCallback(callbackCaptor.capture(), any());
+        verify(dialogHandle, times(3)).launchDialog();
         callbackCaptor.getValue().onPositiveButtonClicked();
         verify(mActiveModeWarden, times(1)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
 
         // Verify disabling wifi works without dialog.
         when(mSettingsStore.handleWifiToggled(eq(false))).thenReturn(true);
-        dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, false));
         mLooper.dispatchAll();
         verify(mActiveModeWarden, times(2)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
-        verify(dialogHandle, never()).launchDialog();
+        verifyNoMoreInteractions(dialogHandle);
 
         // Verify wifi becoming enabled will dismiss any outstanding dialogs.
-        dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         mLooper.dispatchAll();
         verify(mActiveModeWarden, times(2)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
-        callbackCaptor =
-                ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
-        verify(mWifiDialogManager, times(4)).createSimpleDialog(
-                eq(title),
-                eq(message),
-                eq(positiveButtonText),
-                eq(negativeButtonText),
-                eq(null),
-                callbackCaptor.capture(),
-                any());
-        verify(dialogHandle).launchDialog();
+        verify(dialogHandle, times(4)).launchDialog();
         when(mWifiPermissionsUtil.isSystem(anyString(), anyInt())).thenReturn(true);
         // Enabled by privileged app
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
@@ -1362,18 +1328,16 @@ public class WifiServiceImplTest extends WifiBaseTest {
         verify(mActiveModeWarden, times(3)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
         verify(dialogHandle).dismissDialog();
+        verifyNoMoreInteractions(dialogHandle);
 
         // Verify wifi already enabled will not trigger dialog.
         when(mWifiPermissionsUtil.isSystem(anyString(), anyInt())).thenReturn(false);
-        dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(any(), any(), any(), any(), any(), any(), any()))
-                .thenReturn(dialogHandle);
         when(mActiveModeWarden.getWifiState()).thenReturn(WifiManager.WIFI_STATE_ENABLED);
         assertTrue(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         mLooper.dispatchAll();
         verify(mActiveModeWarden, times(3)).wifiToggled(
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
-        verify(dialogHandle, never()).launchDialog();
+        verifyNoMoreInteractions(dialogHandle);
     }
 
     /**
@@ -2241,6 +2205,141 @@ public class WifiServiceImplTest extends WifiBaseTest {
                 eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
     }
 
+    /**
+     * Verify hotspot cannot be started with BSSID set if the caller does not have permission.
+     */
+    @Test
+    public void testStartTetheredHotspotRequestWithBssidAndNoPermission() {
+        assumeTrue(SdkLevel.isAtLeastB());
+        when(mContext.checkPermission(any(), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_DENIED);
+        mLooper.startAutoDispatch();
+        SoftApConfiguration softApConfig = new SoftApConfiguration.Builder()
+                .setSsid("TestAp")
+                .setBssid(MacAddress.fromString("aa:22:33:aa:bb:cc"))
+                .setPassphrase("Password", SoftApConfiguration.SECURITY_TYPE_WPA2_PSK)
+                .setBand(SoftApConfiguration.BAND_2GHZ)
+                .build();
+        TetheringManager.TetheringRequest request = new TetheringManager.TetheringRequest.Builder(
+                TetheringManager.TETHERING_WIFI).setSoftApConfiguration(softApConfig).build();
+
+        mWifiServiceImpl.startTetheredHotspotRequest(request, mClientSoftApCallback,
+                TEST_PACKAGE_NAME);
+
+        verify(mActiveModeWarden, never()).startSoftAp(any(),
+                eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
+    }
+
+    /**
+     * Verify caller with NETWORK_SETTINGS can start hotspot with BSSID set.
+     */
+    @Test
+    public void testStartTetheredHotspotRequestWithBssidAndNetworkSettingsPermission() {
+        assumeTrue(SdkLevel.isAtLeastB());
+        when(mContext.checkPermission(any(), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_DENIED);
+        when(mContext.checkPermission(eq(Manifest.permission.NETWORK_SETTINGS), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_GRANTED);
+        mLooper.startAutoDispatch();
+        SoftApConfiguration softApConfig = new SoftApConfiguration.Builder()
+                .setSsid("TestAp")
+                .setBssid(MacAddress.fromString("aa:22:33:aa:bb:cc"))
+                .setPassphrase("Password", SoftApConfiguration.SECURITY_TYPE_WPA2_PSK)
+                .setBand(SoftApConfiguration.BAND_2GHZ)
+                .build();
+        TetheringManager.TetheringRequest request = new TetheringManager.TetheringRequest.Builder(
+                TetheringManager.TETHERING_WIFI).setSoftApConfiguration(softApConfig).build();
+
+        mWifiServiceImpl.startTetheredHotspotRequest(request, mClientSoftApCallback,
+                TEST_PACKAGE_NAME);
+
+        verify(mActiveModeWarden).startSoftAp(any(),
+                eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
+    }
+
+    /**
+     * Verify caller with NETWORK_SETUP_WIZARD can start hotspot with BSSID set.
+     */
+    @Test
+    public void testStartTetheredHotspotRequestWithBssidAndSetupWizardPermission() {
+        assumeTrue(SdkLevel.isAtLeastB());
+        when(mContext.checkPermission(any(), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_DENIED);
+        when(mContext.checkPermission(eq(Manifest.permission.NETWORK_SETUP_WIZARD), anyInt(),
+                anyInt()))
+                .thenReturn(PackageManager.PERMISSION_GRANTED);
+        mLooper.startAutoDispatch();
+        SoftApConfiguration softApConfig = new SoftApConfiguration.Builder()
+                .setSsid("TestAp")
+                .setBssid(MacAddress.fromString("aa:22:33:aa:bb:cc"))
+                .setPassphrase("Password", SoftApConfiguration.SECURITY_TYPE_WPA2_PSK)
+                .setBand(SoftApConfiguration.BAND_2GHZ)
+                .build();
+        TetheringManager.TetheringRequest request = new TetheringManager.TetheringRequest.Builder(
+                TetheringManager.TETHERING_WIFI).setSoftApConfiguration(softApConfig).build();
+
+        mWifiServiceImpl.startTetheredHotspotRequest(request, mClientSoftApCallback,
+                TEST_PACKAGE_NAME);
+
+        verify(mActiveModeWarden).startSoftAp(any(),
+                eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
+    }
+
+    /**
+     * Verify caller with NETWORK_STACK can start hotspot with BSSID set.
+     */
+    @Test
+    public void testStartTetheredHotspotRequestWithBssidAndNetworkStackPermission() {
+        assumeTrue(SdkLevel.isAtLeastB());
+        when(mContext.checkPermission(any(), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_DENIED);
+        when(mContext.checkPermission(eq(Manifest.permission.NETWORK_STACK), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_GRANTED);
+        mLooper.startAutoDispatch();
+        SoftApConfiguration softApConfig = new SoftApConfiguration.Builder()
+                .setSsid("TestAp")
+                .setBssid(MacAddress.fromString("aa:22:33:aa:bb:cc"))
+                .setPassphrase("Password", SoftApConfiguration.SECURITY_TYPE_WPA2_PSK)
+                .setBand(SoftApConfiguration.BAND_2GHZ)
+                .build();
+        TetheringManager.TetheringRequest request = new TetheringManager.TetheringRequest.Builder(
+                TetheringManager.TETHERING_WIFI).setSoftApConfiguration(softApConfig).build();
+
+        mWifiServiceImpl.startTetheredHotspotRequest(request, mClientSoftApCallback,
+                TEST_PACKAGE_NAME);
+
+        verify(mActiveModeWarden).startSoftAp(any(),
+                eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
+    }
+
+    /**
+     * Verify caller with MAINLINE_NETWORK_STACK can start hotspot with BSSID set.
+     */
+    @Test
+    public void testStartTetheredHotspotRequestWithBssidAndMainlineNetworkStackPermission() {
+        assumeTrue(SdkLevel.isAtLeastB());
+        when(mContext.checkPermission(any(), anyInt(), anyInt()))
+                .thenReturn(PackageManager.PERMISSION_DENIED);
+        when(mContext.checkPermission(eq(NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK), anyInt(),
+                anyInt()))
+                .thenReturn(PackageManager.PERMISSION_GRANTED);
+        mLooper.startAutoDispatch();
+        SoftApConfiguration softApConfig = new SoftApConfiguration.Builder()
+                .setSsid("TestAp")
+                .setBssid(MacAddress.fromString("aa:22:33:aa:bb:cc"))
+                .setPassphrase("Password", SoftApConfiguration.SECURITY_TYPE_WPA2_PSK)
+                .setBand(SoftApConfiguration.BAND_2GHZ)
+                .build();
+        TetheringManager.TetheringRequest request = new TetheringManager.TetheringRequest.Builder(
+                TetheringManager.TETHERING_WIFI).setSoftApConfiguration(softApConfig).build();
+
+        mWifiServiceImpl.startTetheredHotspotRequest(request, mClientSoftApCallback,
+                TEST_PACKAGE_NAME);
+
+        verify(mActiveModeWarden).startSoftAp(any(),
+                eq(new WorkSource(Binder.getCallingUid(), TEST_PACKAGE_NAME)));
+    }
+
     /**
      * Verify caller with proper permission and valid config does start softap.
      */
@@ -9712,6 +9811,8 @@ public class WifiServiceImplTest extends WifiBaseTest {
     @Test
     public void testSetCarrierNetworkOffloadEnabledWithoutPermissionThrowsException()
             throws Exception {
+        when(mContext.checkPermission(eq(android.Manifest.permission.NETWORK_CARRIER_PROVISIONING),
+            anyInt(), anyInt())).thenReturn(PackageManager.PERMISSION_DENIED);
         try {
             mWifiServiceImpl.setCarrierNetworkOffloadEnabled(10, true, true);
             fail();
@@ -9719,8 +9820,19 @@ public class WifiServiceImplTest extends WifiBaseTest {
     }
 
     @Test
-    public void testSetCarrierNetworkOffloadEnabled() throws Exception {
+    public void testSetCarrierNetworkOffloadEnabledWithSettingsPerm() throws Exception {
         when(mContext.checkPermission(eq(android.Manifest.permission.NETWORK_SETTINGS),
+            anyInt(), anyInt())).thenReturn(PackageManager.PERMISSION_GRANTED);
+        mWifiServiceImpl.setCarrierNetworkOffloadEnabled(10, true, true);
+        verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(10, true, true);
+
+        mWifiServiceImpl.setCarrierNetworkOffloadEnabled(5, false, false);
+        verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(5, false, false);
+    }
+
+    @Test
+    public void testSetCarrierNetworkOffloadEnabledWithSetupWizardPerm() throws Exception {
+        when(mContext.checkPermission(eq(android.Manifest.permission.NETWORK_SETUP_WIZARD),
                 anyInt(), anyInt())).thenReturn(PackageManager.PERMISSION_GRANTED);
         mWifiServiceImpl.setCarrierNetworkOffloadEnabled(10, true, true);
         verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(10, true, true);
@@ -9729,6 +9841,17 @@ public class WifiServiceImplTest extends WifiBaseTest {
         verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(5, false, false);
     }
 
+    @Test
+    public void testSetCarrierNetworkOffloadEnabledWithCarrierProvisioningPerm() throws Exception {
+        when(mContext.checkPermission(eq(android.Manifest.permission.NETWORK_CARRIER_PROVISIONING),
+            anyInt(), anyInt())).thenReturn(PackageManager.PERMISSION_GRANTED);
+        mWifiServiceImpl.setCarrierNetworkOffloadEnabled(10, true, true);
+        verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(10, true, true);
+
+        mWifiServiceImpl.setCarrierNetworkOffloadEnabled(5, false, false);
+        verify(mWifiCarrierInfoManager).setCarrierNetworkOffloadEnabled(5, false, false);
+    }
+
     @Test
     public void testIsCarrierNetworkOffloadEnabled() throws Exception {
         when(mWifiCarrierInfoManager.isCarrierNetworkOffloadEnabled(10, true)).thenReturn(true);
@@ -11699,6 +11822,10 @@ public class WifiServiceImplTest extends WifiBaseTest {
 
     @Test
     public void testTetheredSoftApTrackerWhenCountryCodeChanged() throws Exception {
+        when(mWifiSettingsConfigStore.get(WifiSettingsConfigStore.WIFI_SOFT_AP_COUNTRY_CODE))
+                .thenReturn(TEST_COUNTRY_CODE);
+        when(mWifiSettingsConfigStore.get(WifiSettingsConfigStore.WIFI_AVAILABLE_SOFT_AP_FREQS_MHZ))
+                .thenReturn("[2452]" /* Channel 9 */);
         mWifiServiceImpl.handleBootCompleted();
         mLooper.dispatchAll();
 
@@ -11751,6 +11878,21 @@ public class WifiServiceImplTest extends WifiBaseTest {
                 .getSupportedChannelList(SoftApConfiguration.BAND_2GHZ).length);
         verify(mWifiNative, times(2)).getUsableChannels(eq(WifiScanner.WIFI_BAND_24_GHZ), anyInt(),
                 anyInt());
+
+        // Country code update back to original while HAL still not started
+        mWifiServiceImpl.mCountryCodeTracker.onCountryCodeChangePending(TEST_COUNTRY_CODE);
+        mLooper.dispatchAll();
+        if (SdkLevel.isAtLeastT()) {
+            verify(mIOnWifiDriverCountryCodeChangedListener, never())
+                    .onDriverCountryCodeChanged(TEST_NEW_COUNTRY_CODE);
+        }
+        verify(mClientSoftApCallback, times(2))
+                .onCapabilityChanged(capabilityArgumentCaptor.capture());
+        // The supported channels in soft AP capability were restored.
+        assertEquals(1, capabilityArgumentCaptor.getValue()
+                .getSupportedChannelList(SoftApConfiguration.BAND_2GHZ).length);
+        assertEquals(9, capabilityArgumentCaptor.getValue()
+                .getSupportedChannelList(SoftApConfiguration.BAND_2GHZ)[0]);
     }
 
     /**
@@ -11768,7 +11910,7 @@ public class WifiServiceImplTest extends WifiBaseTest {
         assertFalse(mWifiServiceImpl.setWifiEnabled(TEST_PACKAGE_NAME, true));
         verify(mWifiMetrics, never()).incrementNumWifiToggles(anyBoolean(), anyBoolean());
         verify(mWifiMetrics, never()).reportWifiStateChanged(anyBoolean(), anyBoolean(),
-                anyBoolean());
+                anyBoolean(), anyInt());
 
         assertFalse(mWifiServiceImpl.disconnect(TEST_PACKAGE_NAME));
         assertFalse(mWifiServiceImpl.reconnect(TEST_PACKAGE_NAME));
@@ -12450,11 +12592,10 @@ public class WifiServiceImplTest extends WifiBaseTest {
         mLooper.dispatchAll();
         verify(mContext).registerReceiver(mBroadcastReceiverCaptor.capture(),
                 argThat((IntentFilter filter) ->
-                        filter.hasAction(ACTION_SHUTDOWN)),
-                isNull(),
-                any(Handler.class));
+                        filter.hasAction(ACTION_SHUTDOWN)));
         Intent intent = new Intent(ACTION_SHUTDOWN);
         mBroadcastReceiverCaptor.getValue().onReceive(mContext, intent);
+        mLooper.dispatchAll();
         verify(mActiveModeWarden).notifyShuttingDown();
         verify(mWifiScoreCard).resetAllConnectionStates();
         verify(mWifiConfigManager).writeDataToStorage();
@@ -13405,4 +13546,56 @@ public class WifiServiceImplTest extends WifiBaseTest {
         verify(mRequestInfo, never()).unlinkDeathRecipient();
         stopAutoDispatchWithDispatchAllBeforeStopAndIgnoreExceptions(mLooper);
     }
+
+    /**
+     * Test that query privileged network list.
+     */
+    @Test
+    public void testQueryPrivilegedConfiguredNetworks() throws Exception {
+        assumeTrue(SdkLevel.isAtLeastS());
+        IPrivilegedConfiguredNetworksListener listener =
+                mock(IPrivilegedConfiguredNetworksListener.class);
+        doThrow(new SecurityException()).when(mContext)
+                .enforceCallingOrSelfPermission(
+                        eq(android.Manifest.permission.READ_WIFI_CREDENTIAL), eq("WifiService"));
+        assertThrows("No read credential permission should trigger exception",
+                SecurityException.class,
+                () -> mWifiServiceImpl.queryPrivilegedConfiguredNetworks(listener,
+                mExtras));
+
+        doNothing().when(mContext)
+                .enforceCallingOrSelfPermission(
+                        eq(android.Manifest.permission.READ_WIFI_CREDENTIAL), eq("WifiService"));
+        doThrow(new SecurityException()).when(mWifiPermissionsUtil).enforceNearbyDevicesPermission(
+                any(), anyBoolean(), any());
+        assertThrows("No nearby permission should trigger exception",
+                SecurityException.class,
+                () -> mWifiServiceImpl.queryPrivilegedConfiguredNetworks(listener,
+                mExtras));
+        // Test with permission
+        InOrder inOrder = inOrder(listener);
+        doNothing().when(mWifiPermissionsUtil).enforceNearbyDevicesPermission(
+                any(), anyBoolean(), any());
+        when(mWifiConfigManager.getConfiguredNetworksWithPasswords())
+                .thenReturn(null);
+        mLooper.startAutoDispatch();
+        mWifiServiceImpl.queryPrivilegedConfiguredNetworks(listener,
+                mExtras);
+        stopAutoDispatchWithDispatchAllBeforeStopAndIgnoreExceptions(mLooper);
+        inOrder.verify(listener).onResult(eq(null), anyString());
+
+        when(mWifiConfigManager.getConfiguredNetworksWithPasswords())
+                .thenReturn(TEST_WIFI_CONFIGURATION_LIST);
+        ArgumentCaptor<ParceledListSlice<WifiConfiguration>> configListCaptor =
+                ArgumentCaptor.forClass(ParceledListSlice.class);
+        mLooper.startAutoDispatch();
+        mWifiServiceImpl.queryPrivilegedConfiguredNetworks(listener,
+                mExtras);
+        stopAutoDispatchWithDispatchAllBeforeStopAndIgnoreExceptions(mLooper);
+        verify(listener).onResult(configListCaptor.capture(), eq(""));
+
+        WifiConfigurationTestUtil.assertConfigurationsEqualForBackup(
+                TEST_WIFI_CONFIGURATION_LIST, configListCaptor.getValue().getList());
+    }
 }
+
diff --git a/service/tests/wifitests/src/com/android/server/wifi/WifiShellCommandTest.java b/service/tests/wifitests/src/com/android/server/wifi/WifiShellCommandTest.java
index d972c23fe4..aeb61d0b60 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/WifiShellCommandTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/WifiShellCommandTest.java
@@ -51,6 +51,8 @@ import static org.mockito.Mockito.when;
 import android.net.ConnectivityManager;
 import android.net.MacAddress;
 import android.net.NetworkRequest;
+import android.net.TetheringManager;
+import android.net.TetheringManager.TetheringRequest;
 import android.net.wifi.SoftApConfiguration;
 import android.net.wifi.SupplicantState;
 import android.net.wifi.WifiAvailableChannel;
@@ -106,12 +108,17 @@ public class WifiShellCommandTest extends WifiBaseTest {
     @Mock WifiServiceImpl mWifiService;
     @Mock WifiContext mContext;
     @Mock ConnectivityManager mConnectivityManager;
+    @Mock TetheringManager mTetheringManager;
     @Mock WifiCarrierInfoManager mWifiCarrierInfoManager;
     @Mock WifiNetworkFactory mWifiNetworkFactory;
     @Mock WifiGlobals mWifiGlobals;
     @Mock ScanRequestProxy mScanRequestProxy;
     @Mock WifiDiagnostics mWifiDiagnostics;
     @Mock DeviceConfigFacade mDeviceConfig;
+    @Mock WifiDialogManager mWifiDialogManager;
+    @Mock WifiDialogManager.SimpleDialogBuilder mDialogBuilder;
+    @Mock WifiDialogManager.DialogHandle mDialogHandle;
+    @Mock WifiDialogManager.DialogHandle mLegacyDialogHandle;
     @Mock WifiScanner mWifiScanner;
     WifiShellCommand mWifiShellCommand;
     TestLooper mLooper;
@@ -138,8 +145,21 @@ public class WifiShellCommandTest extends WifiBaseTest {
         when(mWifiInjector.getWifiNetworkFactory()).thenReturn(mWifiNetworkFactory);
         when(mWifiInjector.getScanRequestProxy()).thenReturn(mScanRequestProxy);
         when(mContext.getSystemService(ConnectivityManager.class)).thenReturn(mConnectivityManager);
+        when(mContext.getSystemService(TetheringManager.class)).thenReturn(mTetheringManager);
         when(mWifiInjector.getWifiDiagnostics()).thenReturn(mWifiDiagnostics);
         when(mWifiInjector.getDeviceConfigFacade()).thenReturn(mDeviceConfig);
+        when(mWifiInjector.getWifiDialogManager()).thenReturn(mWifiDialogManager);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(mDialogBuilder);
+        when(mWifiDialogManager.createLegacySimpleDialogWithUrl(any(), any(), any(), anyInt(),
+                anyInt(), any(), any(), any(), any(), any())).thenReturn(mLegacyDialogHandle);
+        when(mDialogBuilder.build()).thenReturn(mDialogHandle);
+        when(mDialogBuilder.setTitle(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessage(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setPositiveButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNegativeButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setNeutralButtonText(any())).thenReturn(mDialogBuilder);
+        when(mDialogBuilder.setCallback(any(), any())).thenReturn(mDialogBuilder);
         when(mContext.getSystemService(WifiScanner.class)).thenReturn(mWifiScanner);
         when(mScanRequestProxy.getScanResults()).thenReturn(new ArrayList<>());
 
@@ -568,16 +588,26 @@ public class WifiShellCommandTest extends WifiBaseTest {
         mWifiShellCommand.exec(
                 new Binder(), new FileDescriptor(), new FileDescriptor(), new FileDescriptor(),
                 new String[]{"start-softap", "ap1", "wpa2", "xyzabc321", "-b", "5"});
-        ArgumentCaptor<SoftApConfiguration> softApConfigurationCaptor = ArgumentCaptor.forClass(
-                SoftApConfiguration.class);
-        verify(mWifiService).startTetheredHotspot(
-                softApConfigurationCaptor.capture(), eq(SHELL_PACKAGE_NAME));
+        final SoftApConfiguration softApConfig;
+        if (SdkLevel.isAtLeastB()) {
+            ArgumentCaptor<TetheringRequest> requestCaptor =
+                    ArgumentCaptor.forClass(TetheringRequest.class);
+            verify(mTetheringManager).startTethering(requestCaptor.capture(), any(), any());
+            softApConfig = requestCaptor.getValue().getSoftApConfiguration();
+        } else {
+            ArgumentCaptor<SoftApConfiguration> softApConfigurationCaptor = ArgumentCaptor.forClass(
+                    SoftApConfiguration.class);
+            verify(mWifiService).startTetheredHotspot(
+                    softApConfigurationCaptor.capture(), eq(SHELL_PACKAGE_NAME));
+            softApConfig = softApConfigurationCaptor.getValue();
+        }
+
         assertEquals(SoftApConfiguration.BAND_5GHZ,
-                softApConfigurationCaptor.getValue().getBand());
+                softApConfig.getBand());
         assertEquals(SoftApConfiguration.SECURITY_TYPE_WPA2_PSK,
-                softApConfigurationCaptor.getValue().getSecurityType());
-        assertEquals("ap1", softApConfigurationCaptor.getValue().getWifiSsid().getUtf8Text());
-        assertEquals("xyzabc321", softApConfigurationCaptor.getValue().getPassphrase());
+                softApConfig.getSecurityType());
+        assertEquals("ap1", softApConfig.getWifiSsid().getUtf8Text());
+        assertEquals("xyzabc321", softApConfig.getPassphrase());
     }
 
     @Test
@@ -1120,4 +1150,77 @@ public class WifiShellCommandTest extends WifiBaseTest {
                 wifiSsidCaptor.capture(), eq(ROAMING_MODE_AGGRESSIVE), eq(SHELL_PACKAGE_NAME));
         assertEquals("\"hello world\"", wifiSsidCaptor.getValue().toString());
     }
+
+    @Test
+    public void testLaunchDialogSimpleArgs() {
+        BinderUtil.setUid(Process.ROOT_UID);
+        final String title = "title";
+        final String message = "message";
+        final String url = "www.google.com";
+        final int urlStart = 0;
+        final int urlEnd = message.length();
+        final String positive = "positive";
+        final String negative = "negative";
+        final String neutral = "neutral";
+
+        mWifiShellCommand.exec(
+                new Binder(), new FileDescriptor(), new FileDescriptor(), new FileDescriptor(),
+                new String[] {
+                        "launch-dialog-simple",
+                        "-t", title,
+                        "-m", message,
+                        "-l", url, String.valueOf(urlStart), String.valueOf(urlEnd),
+                        "-y", positive,
+                        "-n", negative,
+                        "-x", neutral,
+                        "-c", "0"
+                });
+        verify(mWifiDialogManager).createSimpleDialogBuilder();
+        verify(mDialogBuilder).setTitle(title);
+        verify(mDialogBuilder).setMessage(message);
+        verify(mDialogBuilder).setMessageUrl(url, urlStart, urlEnd);
+        verify(mDialogBuilder).setPositiveButtonText(positive);
+        verify(mDialogBuilder).setNegativeButtonText(negative);
+        verify(mDialogBuilder).setNeutralButtonText(neutral);
+        verify(mDialogBuilder).build();
+        verify(mDialogHandle).launchDialog();
+    }
+
+    @Test
+    public void testLaunchDialogSimpleLegacyArgs() {
+        BinderUtil.setUid(Process.ROOT_UID);
+        final String title = "title";
+        final String message = "message";
+        final String url = "www.google.com";
+        final int urlStart = 0;
+        final int urlEnd = message.length();
+        final String positive = "positive";
+        final String negative = "negative";
+        final String neutral = "neutral";
+
+        mWifiShellCommand.exec(
+                new Binder(), new FileDescriptor(), new FileDescriptor(), new FileDescriptor(),
+                new String[] {
+                        "launch-dialog-simple-legacy",
+                        "-t", title,
+                        "-m", message,
+                        "-l", url, String.valueOf(urlStart), String.valueOf(urlEnd),
+                        "-y", positive,
+                        "-n", negative,
+                        "-x", neutral,
+                        "-c", "0"
+                });
+        verify(mWifiDialogManager).createLegacySimpleDialogWithUrl(
+                eq(title),
+                eq(message),
+                eq(url),
+                eq(urlStart),
+                eq(urlEnd),
+                eq(positive),
+                eq(negative),
+                eq(neutral),
+                any(),
+                any());
+        verify(mLegacyDialogHandle).launchDialog();
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareDataPathStateManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareDataPathStateManagerTest.java
index 681db5b3d2..b61074f2a4 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareDataPathStateManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareDataPathStateManagerTest.java
@@ -99,6 +99,7 @@ import com.android.server.wifi.MockResources;
 import com.android.server.wifi.WifiBaseTest;
 import com.android.server.wifi.WifiGlobals;
 import com.android.server.wifi.WifiInjector;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.aware.WifiAwareDataPathStateManager.WifiAwareNetworkAgent;
 import com.android.server.wifi.hal.WifiNanIface.NanDataPathChannelCfg;
@@ -154,6 +155,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
     @Mock private ConnectivityManager mMockCm;
     @Mock private NetdWrapper mMockNetdWrapper;
     @Mock private InterfaceConflictManager mInterfaceConflictManager;
+    @Mock private WifiLockManager mWifiLockManager;
     @Mock private WifiAwareDataPathStateManager.NetworkInterfaceWrapper mMockNetworkInterface;
     @Mock private IWifiAwareEventCallback mMockCallback;
     @Mock IWifiAwareDiscoverySessionCallback mMockSessionCallback;
@@ -233,7 +235,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         mDut.setNative(mMockNativeManager, mMockNative);
         mDut.start(mMockContext, mMockLooper.getLooper(), mAwareMetricsMock,
                 mWifiPermissionsUtil, mPermissionsWrapperMock, mClock, mMockNetdWrapper,
-                mInterfaceConflictManager);
+                mInterfaceConflictManager, mWifiLockManager);
         mDut.startLate();
         mDut.enableVerboseLogging(true, true , true);
         mMockLooper.dispatchAll();
@@ -546,7 +548,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 ArgumentCaptor.forClass(WifiAwareNetworkAgent.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         NetworkRequest[] nrs = new NetworkRequest[3];
@@ -608,6 +610,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                     eq(false), anyInt(), anyLong(), anyInt(), anyInt());
             inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
             WifiAwareNetworkInfo netInfo =
                     (WifiAwareNetworkInfo) agentBinders[i].mDataPathCapabilities.getTransportInfo();
             assertArrayEquals(MacAddress.fromBytes(
@@ -640,13 +643,17 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             mDut.onDataPathEndNotification(ndpId + i);
             mMockLooper.dispatchAll();
 
-            if (index++ == endOrder.length - 1) {
+            // Some data path is established until the last one is ended
+            boolean isAnyDataPathEstablished = index++ != endOrder.length - 1;
+            if (!isAnyDataPathEstablished) {
                 inOrder.verify(mMockNetdWrapper).setInterfaceDown(anyString());
             }
             inOrderM.verify(mAwareMetricsMock).recordNdpSessionDuration(anyLong());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(isAnyDataPathEstablished);
         }
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
-        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper);
+        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper,
+                mWifiLockManager);
     }
 
     /**
@@ -672,7 +679,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         ArgumentCaptor<WifiAwareNetworkAgent> agentCaptor =
                 ArgumentCaptor.forClass(WifiAwareNetworkAgent.class);
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         // (1) initialize all clients
@@ -742,6 +749,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                 eq(true), anyInt(), anyLong(), anyInt(), anyInt());
         inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+        inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
         WifiAwareNetworkInfo netInfo =
                 (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                         .getTransportInfo();
@@ -801,9 +809,10 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
 
         inOrder.verify(mMockNetdWrapper).setInterfaceDown(anyString());
         inOrderM.verify(mAwareMetricsMock).recordNdpSessionDuration(anyLong());
+        inOrder.verify(mWifiLockManager).updateAwareConnected(eq(false));
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mMockCallback, mMockSessionCallback,
-                mAwareMetricsMock, mMockNetdWrapper);
+                mAwareMetricsMock, mMockNetdWrapper, mWifiLockManager);
     }
 
     /**
@@ -825,7 +834,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 WifiAwareNetworkAgent.class);
 
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         // (1) initialize all clients
@@ -875,6 +884,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                         eq(true), anyInt(), anyLong(), anyInt(), anyInt());
                 inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+                inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
                 WifiAwareNetworkInfo netInfo =
                         (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                                 .getTransportInfo();
@@ -893,7 +903,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         assertEquals("Number of unique interface names", numNdis, interfaces.size());
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mMockCallback, mMockSessionCallback,
-                mAwareMetricsMock, mMockNetdWrapper);
+                mAwareMetricsMock, mMockNetdWrapper, mWifiLockManager);
     }
 
     /**
@@ -917,7 +927,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 WifiAwareNetworkAgent.class);
 
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         // (1) initialize all clients
@@ -969,6 +979,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                     eq(true), anyInt(), anyLong(), anyInt(), anyInt());
             inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
             WifiAwareNetworkInfo netInfo =
                     (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                             .getTransportInfo();
@@ -984,7 +995,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         assertEquals("Number of unique interface names", 1, interfaces.size());
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mMockCallback, mMockSessionCallback,
-                mAwareMetricsMock, mMockNetdWrapper);
+                mAwareMetricsMock, mMockNetdWrapper, mWifiLockManager);
     }
 
     /**
@@ -1006,7 +1017,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 WifiAwareNetworkAgent.class);
 
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         // (1) initialize all clients
@@ -1061,6 +1072,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                         eq(true), anyInt(), anyLong(), anyInt(), anyInt());
                 inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+                inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
                 WifiAwareNetworkInfo netInfo =
                         (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                                 .getTransportInfo();
@@ -1079,7 +1091,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         assertEquals("Number of unique interface names", numNdis, interfaces.size());
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mMockCallback, mMockSessionCallback,
-                mAwareMetricsMock, mMockNetdWrapper);
+                mAwareMetricsMock, mMockNetdWrapper, mWifiLockManager);
     }
 
     /**
@@ -1104,7 +1116,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 WifiAwareNetworkAgent.class);
 
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         // (1) initialize all clients
@@ -1161,6 +1173,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                     eq(true), anyInt(), anyLong(), anyInt(), anyInt());
             inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
             WifiAwareNetworkInfo netInfo =
                     (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                             .getTransportInfo();
@@ -1199,7 +1212,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         verifyRequestDeclaredUnfullfillable(nr);
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mMockCallback, mMockSessionCallback,
-                mAwareMetricsMock, mMockNetdWrapper);
+                mAwareMetricsMock, mMockNetdWrapper, mWifiLockManager);
     }
 
     /*
@@ -1723,7 +1736,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 ArgumentCaptor.forClass(WifiAwareNetworkAgent.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
         WifiAwareNetworkAgent networkAgent = null;
 
@@ -1846,6 +1859,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                         eq(useDirect), anyInt(), anyLong(), anyInt(), anyInt());
                 inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+                inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
                 WifiAwareNetworkInfo netInfo =
                         (WifiAwareNetworkInfo) networkAgent.mDataPathCapabilities
                                 .getTransportInfo();
@@ -1892,10 +1906,11 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             mMockLooper.dispatchAll();
             inOrder.verify(mMockNetdWrapper).setInterfaceDown(anyString());
             inOrderM.verify(mAwareMetricsMock).recordNdpSessionDuration(anyLong());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(false));
         }
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
         verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper,
-                mMockNetworkInterface);
+                mMockNetworkInterface, mWifiLockManager);
     }
 
     private void testDataPathResponderUtility(boolean useDirect, boolean provideMac,
@@ -1916,7 +1931,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 ArgumentCaptor.forClass(WifiAwareNetworkAgent.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
         InOrder inOrder = inOrder(mMockNative, mMockCm, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockContext);
+                mMockNetdWrapper, mMockNetworkInterface, mMockContext, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         if (providePmk) {
@@ -1975,6 +1990,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                     eq(useDirect), anyInt(), anyLong(), anyInt(), anyInt());
             inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
             WifiAwareNetworkInfo netInfo =
                     (WifiAwareNetworkInfo) agentCaptor.getValue().mDataPathCapabilities
                             .getTransportInfo();
@@ -2021,9 +2037,11 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
 
             inOrder.verify(mMockNetdWrapper).setInterfaceDown(anyString());
             inOrderM.verify(mAwareMetricsMock).recordNdpSessionDuration(anyLong());
+            inOrder.verify(mWifiLockManager).updateAwareConnected(eq(false));
         }
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
-        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper);
+        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper,
+                mWifiLockManager);
     }
 
     private NetworkRequest getSessionNetworkRequest(int clientId, int sessionId,
@@ -2239,13 +2257,6 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
             collector.checkThat("factory name", "WIFI_AWARE_FACTORY",
                     equalTo(networkProviderCaptor.getValue().getName()));
 
-            // (1) get capabilities
-            mDut.queryCapabilities();
-            mMockLooper.dispatchAll();
-            inOrder.verify(mMockNative).getCapabilities(transactionId.capture());
-            mDut.onCapabilitiesUpdateResponse(transactionId.getValue(), capabilities);
-            mMockLooper.dispatchAll();
-
             // (2) enable usage
             mDut.enableUsage();
             mMockLooper.dispatchAll();
@@ -2270,6 +2281,9 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 any(),  eq(6), eq(TEST_FEATURE_ID));
 
         if (startUpSequence) {
+            inOrder.verify(mMockNative).getCapabilities(transactionId.capture());
+            mDut.onCapabilitiesUpdateResponse(transactionId.getValue(), capabilities);
+            mMockLooper.dispatchAll();
             for (int i = 0; i < maxNdiInterfaces; ++i) {
                 inOrder.verify(mMockNative).createAwareNetworkInterface(transactionId.capture(),
                         strCaptor.capture());
@@ -2422,12 +2436,11 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         int ndpId = 2;
         List<Integer> successNdpIds = new ArrayList<>();
 
-
         ArgumentCaptor<WifiAwareNetworkAgent> agentCaptor =
                 ArgumentCaptor.forClass(WifiAwareNetworkAgent.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
         InOrder inOrder = inOrder(mMockNative, mMockCallback, mMockSessionCallback,
-                mMockNetdWrapper, mMockNetworkInterface, mMockCm);
+                mMockNetdWrapper, mMockNetworkInterface, mMockCm, mWifiLockManager);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         if (providePmk) {
@@ -2490,6 +2503,7 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
                 inOrderM.verify(mAwareMetricsMock).recordNdpStatus(eq(NanStatusCode.SUCCESS),
                         eq(false), anyInt(), anyLong(), anyInt(), anyInt());
                 inOrderM.verify(mAwareMetricsMock).recordNdpCreation(anyInt(), any(), any());
+                inOrder.verify(mWifiLockManager).updateAwareConnected(eq(true));
                 assertEquals(successNdpIds.size(), mDut.mDataPathMgr.getNumOfNdps());
 
                 firstSuccess = false;
@@ -2516,7 +2530,6 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         inOrderM.verify(mAwareMetricsMock).recordNdpSessionDuration(anyLong());
         assertEquals(successNdpIds.size(), mDut.mDataPathMgr.getNumOfNdps());
 
-
         // (5) end data-path (unless didn't get confirmation)
         Message endNetworkMsg = Message.obtain();
         endNetworkMsg.what = NetworkFactory.CMD_CANCEL_REQUEST;
@@ -2533,7 +2546,9 @@ public class WifiAwareDataPathStateManagerTest extends WifiBaseTest {
         }
         inOrder.verify(mMockNetdWrapper).setInterfaceDown(anyString());
         verify(mAwareMetricsMock, atLeastOnce()).reportAwareInstantModeEnabled(anyBoolean());
-        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper);
+        verify(mWifiLockManager, atLeastOnce()).updateAwareConnected(anyBoolean());
+        verifyNoMoreInteractions(mMockNative, mAwareMetricsMock, mMockNetdWrapper,
+                mWifiLockManager);
     }
 
     @Test
diff --git a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareServiceImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareServiceImplTest.java
index 0e06d031a7..5a0c41a0ab 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareServiceImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareServiceImplTest.java
@@ -75,6 +75,7 @@ import com.android.server.wifi.InterfaceConflictManager;
 import com.android.server.wifi.MockResources;
 import com.android.server.wifi.WifiBaseTest;
 import com.android.server.wifi.WifiInjector;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.util.NetdWrapper;
 import com.android.server.wifi.util.WifiPermissionsUtil;
@@ -130,6 +131,7 @@ public class WifiAwareServiceImplTest extends WifiBaseTest {
     @Mock private WifiPermissionsWrapper mPermissionsWrapperMock;
     @Mock private WifiSettingsConfigStore mWifiSettingsConfigStore;
     @Mock private InterfaceConflictManager mInterfaceConflictManager;
+    @Mock private WifiLockManager mWifiLockManager;
     @Mock private DeviceConfigFacade mDeviceConfigFacade;
     @Mock private WifiInjector mWifiInjector;
     @Mock private LocalLog mLocalLog;
@@ -202,11 +204,11 @@ public class WifiAwareServiceImplTest extends WifiBaseTest {
                 mWifiSettingsConfigStore,
                 mock(WifiAwareNativeManager.class), mock(WifiAwareNativeApi.class),
                 mock(WifiAwareNativeCallback.class), mock(NetdWrapper.class),
-                mInterfaceConflictManager);
+                mInterfaceConflictManager, mWifiLockManager);
         mMockLooper.dispatchAll();
         verify(mAwareStateManagerMock).start(eq(mContextMock), any(), eq(mAwareMetricsMock),
                 eq(mWifiPermissionsUtil), eq(mPermissionsWrapperMock), any(), any(),
-                eq(mInterfaceConflictManager));
+                eq(mInterfaceConflictManager), eq(mWifiLockManager));
     }
 
     @After
diff --git a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareStateManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareStateManagerTest.java
index a4ebf7b185..946429d26b 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareStateManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/aware/WifiAwareStateManagerTest.java
@@ -116,6 +116,7 @@ import com.android.server.wifi.MockResources;
 import com.android.server.wifi.WifiBaseTest;
 import com.android.server.wifi.WifiGlobals;
 import com.android.server.wifi.WifiInjector;
+import com.android.server.wifi.WifiLockManager;
 import com.android.server.wifi.WifiNative;
 import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.WifiThreadRunner;
@@ -172,6 +173,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
     @Mock private WifiPermissionsUtil mWifiPermissionsUtil;
     @Mock private WifiPermissionsWrapper mPermissionsWrapperMock;
     @Mock private InterfaceConflictManager mInterfaceConflictManager;
+    @Mock private WifiLockManager mWifiLockManager;
     TestAlarmManager mAlarmManager;
     @Mock private PowerManager mMockPowerManager;
     @Mock private WifiManager mMockWifiManager;
@@ -276,7 +278,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
         mDut.setNative(mMockNativeManager, mMockNative);
         mDut.start(mMockContext, mMockLooper.getLooper(), mAwareMetricsMock,
                 mWifiPermissionsUtil, mPermissionsWrapperMock, new Clock(),
-                mock(NetdWrapper.class), mInterfaceConflictManager);
+                mock(NetdWrapper.class), mInterfaceConflictManager, mWifiLockManager);
         verify(mMockContext, never()).registerReceiver(any(), any(IntentFilter.class));
         mDut.startLate();
         mDut.enableVerboseLogging(true, true, true);
@@ -1391,7 +1393,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
         IWifiAwareDiscoverySessionCallback mockSessionCallback = mock(
                 IWifiAwareDiscoverySessionCallback.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
-        InOrder inOrder = inOrder(mockCallback, mockSessionCallback, mMockNative);
+        InOrder inOrder = inOrder(mMockContext, mockCallback, mockSessionCallback, mMockNative);
         InOrder inOrderM = inOrder(mAwareMetricsMock);
 
         mDut.enableUsage();
@@ -1430,6 +1432,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
         inOrder.verify(mockSessionCallback).onSessionTerminated(anyInt());
         inOrder.verify(mMockNative).stopPublish(transactionId.capture(), eq(publishId));
         inOrder.verify(mockCallback).onAttachTerminate();
+        validateCorrectAwareResourcesChangeBroadcast(inOrder);
         inOrder.verify(mMockNative).disable(transactionId.capture());
 
         inOrderM.verify(mAwareMetricsMock).recordDiscoverySession(eq(uid), any());
@@ -1738,7 +1741,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
         IWifiAwareDiscoverySessionCallback mockSessionCallback = mock(
                 IWifiAwareDiscoverySessionCallback.class);
         ArgumentCaptor<Short> transactionId = ArgumentCaptor.forClass(Short.class);
-        InOrder inOrder = inOrder(mockCallback, mockSessionCallback, mMockNative);
+        InOrder inOrder = inOrder(mMockContext, mockCallback, mockSessionCallback, mMockNative);
 
         mDut.enableUsage();
         mMockLooper.dispatchAll();
@@ -1772,6 +1775,7 @@ public class WifiAwareStateManagerTest extends WifiBaseTest {
         inOrder.verify(mockSessionCallback).onSessionTerminated(anyInt());
         inOrder.verify(mMockNative).stopSubscribe((short) 0, subscribeId);
         inOrder.verify(mockCallback).onAttachTerminate();
+        validateCorrectAwareResourcesChangeBroadcast(inOrder);
         inOrder.verify(mMockNative).disable(anyShort());
 
         validateInternalClientInfoCleanedUp(clientId);
diff --git a/service/tests/wifitests/src/com/android/server/wifi/coex/CoexManagerTest.java b/service/tests/wifitests/src/com/android/server/wifi/coex/CoexManagerTest.java
index 1cf0754257..481a30f50a 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/coex/CoexManagerTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/coex/CoexManagerTest.java
@@ -37,8 +37,10 @@ import static org.mockito.ArgumentMatchers.eq;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.validateMockitoUsage;
 import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
+import static org.mockito.Mockito.withSettings;
 
 import android.content.BroadcastReceiver;
 import android.content.Context;
@@ -63,11 +65,14 @@ import android.telephony.TelephonyManager;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.WifiBaseTest;
 import com.android.server.wifi.WifiNative;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Rule;
 import org.junit.Test;
@@ -75,6 +80,7 @@ import org.junit.rules.TemporaryFolder;
 import org.mockito.ArgumentCaptor;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 
 import java.io.BufferedReader;
 import java.io.File;
@@ -104,6 +110,7 @@ public class CoexManagerTest extends WifiBaseTest {
     private static final String FILEPATH_LTE_7_INTERMOD = "assets/coex_lte_7_intermod.xml";
 
     private TestLooper mTestLooper;
+    private MockitoSession mSession;
 
     @Mock private Context mMockContext;
     @Mock private Resources mMockResources;
@@ -179,6 +186,9 @@ public class CoexManagerTest extends WifiBaseTest {
     public void setUp() throws Exception {
         assumeTrue(SdkLevel.isAtLeastS());
         MockitoAnnotations.initMocks(this);
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .startMocking();
         when(mMockContext.getResources()).thenReturn(mMockResources);
         when(mMockResources.getBoolean(R.bool.config_wifiDefaultCoexAlgorithmEnabled))
                 .thenReturn(true);
@@ -196,6 +206,17 @@ public class CoexManagerTest extends WifiBaseTest {
                 .KEY_AVOID_5GHZ_WIFI_DIRECT_FOR_LAA_BOOL, true);
     }
 
+    /**
+     * Called after each test
+     */
+    @After
+    public void cleanup() {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
+    }
+
     /**
      * Verifies that setCoexUnsafeChannels(Set, int) sets values returned in the getter methods
      * getCoexUnsafeChannels() and getCoexRestrictions().
@@ -740,10 +761,28 @@ public class CoexManagerTest extends WifiBaseTest {
     }
 
     /**
-     * Verifies that carrier configs changing will update the unsafe channels
+     * Verifies that carrier configs changing will update the unsafe channels when flag is disabled.
      */
     @Test
-    public void testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannels() {
+    public void testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannels_whenNoFlag() {
+        when(Flags.monitorIntentForAllUsers()).thenReturn(false);
+        testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannels(false);
+    }
+
+    /**
+     * Verifies that carrier configs changing will update the unsafe channels when flag is enabled.
+     */
+    @Test
+    public void testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannelsWhenFlagged() {
+        when(Flags.monitorIntentForAllUsers()).thenReturn(true);
+        testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannels(true);
+    }
+
+    /**
+     * Verifies that carrier configs changing will update the unsafe channels
+     */
+    private void testGetCoexUnsafeChannels_carrierConfigsChanged_updatesUnsafeChannels(
+            boolean isFlagMonitorIntentForAllUsersEnabled) {
         // Start with no restrictions in the carrier config
         when(mMockCarrierConfigManager.getConfigForSubId(0)).thenReturn(mUnrestrictedBundle);
         final TelephonyManager telephonyManager = setUpSubIdMocks(0);
@@ -755,8 +794,13 @@ public class CoexManagerTest extends WifiBaseTest {
                 ArgumentCaptor.forClass(CoexManager.CoexTelephonyCallback.class);
         verify(telephonyManager).registerTelephonyCallback(
                 any(Executor.class), telephonyCallbackCaptor.capture());
-        verify(mMockContext).registerReceiver(mBroadcastReceiverCaptor.capture(),
-                any(IntentFilter.class), eq(null), any(Handler.class));
+        if (isFlagMonitorIntentForAllUsersEnabled) {
+            verify(mMockContext).registerReceiverForAllUsers(mBroadcastReceiverCaptor.capture(),
+                    any(IntentFilter.class), eq(null), any(Handler.class));
+        } else {
+            verify(mMockContext).registerReceiver(mBroadcastReceiverCaptor.capture(),
+                    any(IntentFilter.class), eq(null), any(Handler.class));
+        }
         telephonyCallbackCaptor.getValue().onPhysicalChannelConfigChanged(Arrays.asList(
                 createMockPhysicalChannelConfig(
                         NETWORK_TYPE_LTE, AccessNetworkConstants.EutranBand.BAND_46,
@@ -1042,4 +1086,100 @@ public class CoexManagerTest extends WifiBaseTest {
                 new CoexUnsafeChannel(WIFI_BAND_24_GHZ, 9),
                 new CoexUnsafeChannel(WIFI_BAND_24_GHZ, 10));
     }
+
+    /**
+     * Verifies that unsafe channels are cleared if the radio turns off.
+     */
+    @Test
+    public void testOnRadioPowerStateChanged_radioTurnsOff_unsafeChannelsAreCleared()
+            throws Exception {
+        // Mock LTE Band 40 neighboring interference.
+        when(mMockResources.getString(R.string.config_wifiCoexTableFilepath))
+                .thenReturn(createFileFromResource(FILEPATH_LTE_40_NEIGHBORING).getCanonicalPath());
+        final TelephonyManager telephonyManager = setUpSubIdMocks(0);
+        CoexManager coexManager = createCoexManager();
+        verify(mMockSubscriptionManager).addOnSubscriptionsChangedListener(
+                any(), mCoexSubscriptionsListenerCaptor.capture());
+        mCoexSubscriptionsListenerCaptor.getValue().onSubscriptionsChanged();
+        final ArgumentCaptor<CoexManager.CoexTelephonyCallback> telephonyCallbackCaptor =
+                ArgumentCaptor.forClass(CoexManager.CoexTelephonyCallback.class);
+        verify(telephonyManager).registerTelephonyCallback(any(Executor.class),
+                telephonyCallbackCaptor.capture());
+        telephonyCallbackCaptor.getValue().onPhysicalChannelConfigChanged(Arrays.asList(
+                createMockPhysicalChannelConfig(NETWORK_TYPE_LTE, 40, 2399_900, 10_000, 0, 0)
+        ));
+        assertThat(coexManager.getCoexUnsafeChannels()).isNotEmpty();
+
+        // Mock radio turning off
+        telephonyCallbackCaptor.getValue().onRadioPowerStateChanged(
+                TelephonyManager.RADIO_POWER_OFF);
+
+        assertThat(coexManager.getCoexUnsafeChannels()).isEmpty();
+    }
+
+    /**
+     * Verifies that onPhysicalChannelConfigChanged is ignored if the radio is off.
+     */
+    @Test
+    public void testOnRadioPowerStateChanged_radioTurnsOff_pccChangeIgnored() throws Exception {
+        // Mock LTE Band 40 neighboring interference.
+        when(mMockResources.getString(R.string.config_wifiCoexTableFilepath))
+                .thenReturn(createFileFromResource(FILEPATH_LTE_40_NEIGHBORING).getCanonicalPath());
+        final TelephonyManager telephonyManager = setUpSubIdMocks(0);
+        CoexManager coexManager = createCoexManager();
+        verify(mMockSubscriptionManager).addOnSubscriptionsChangedListener(
+                any(), mCoexSubscriptionsListenerCaptor.capture());
+        mCoexSubscriptionsListenerCaptor.getValue().onSubscriptionsChanged();
+        final ArgumentCaptor<CoexManager.CoexTelephonyCallback> telephonyCallbackCaptor =
+                ArgumentCaptor.forClass(CoexManager.CoexTelephonyCallback.class);
+        verify(telephonyManager).registerTelephonyCallback(any(Executor.class),
+                telephonyCallbackCaptor.capture());
+        // Mock radio turning off
+        telephonyCallbackCaptor.getValue().onRadioPowerStateChanged(
+                TelephonyManager.RADIO_POWER_OFF);
+        assertThat(coexManager.getCoexUnsafeChannels()).isEmpty();
+
+        // Mock non-empty physical channel config.
+        telephonyCallbackCaptor.getValue().onPhysicalChannelConfigChanged(Arrays.asList(
+                createMockPhysicalChannelConfig(NETWORK_TYPE_LTE, 40, 2399_900, 10_000, 0, 0)
+        ));
+
+        // Unsafe channels should be empty since we ignored the physical channel config change.
+        assertThat(coexManager.getCoexUnsafeChannels()).isEmpty();
+    }
+
+
+    /**
+     * Verifies that onPhysicalChannelConfigChanged is ignored if the radio is off.
+     */
+    @Test
+    public void testOnRadioPowerStateChanged_radioTurnsBackOn_pccChangeProcessed()
+            throws Exception {
+        // Mock LTE Band 40 neighboring interference.
+        when(mMockResources.getString(R.string.config_wifiCoexTableFilepath))
+                .thenReturn(createFileFromResource(FILEPATH_LTE_40_NEIGHBORING).getCanonicalPath());
+        final TelephonyManager telephonyManager = setUpSubIdMocks(0);
+        CoexManager coexManager = createCoexManager();
+        verify(mMockSubscriptionManager).addOnSubscriptionsChangedListener(
+                any(), mCoexSubscriptionsListenerCaptor.capture());
+        mCoexSubscriptionsListenerCaptor.getValue().onSubscriptionsChanged();
+        final ArgumentCaptor<CoexManager.CoexTelephonyCallback> telephonyCallbackCaptor =
+                ArgumentCaptor.forClass(CoexManager.CoexTelephonyCallback.class);
+        verify(telephonyManager).registerTelephonyCallback(any(Executor.class),
+                telephonyCallbackCaptor.capture());
+        // Mock radio turning off and back on
+        telephonyCallbackCaptor.getValue().onRadioPowerStateChanged(
+                TelephonyManager.RADIO_POWER_OFF);
+        telephonyCallbackCaptor.getValue().onRadioPowerStateChanged(
+                TelephonyManager.RADIO_POWER_ON);
+        assertThat(coexManager.getCoexUnsafeChannels()).isEmpty();
+
+        // Mock non-empty physical channel config.
+        telephonyCallbackCaptor.getValue().onPhysicalChannelConfigChanged(Arrays.asList(
+                createMockPhysicalChannelConfig(NETWORK_TYPE_LTE, 40, 2399_900, 10_000, 0, 0)
+        ));
+
+        // Unsafe channels should not be empty since the PCC change was processed.
+        assertThat(coexManager.getCoexUnsafeChannels()).isNotEmpty();
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/hal/WifiNanIfaceAidlImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/hal/WifiNanIfaceAidlImplTest.java
index d633b57b8e..aef22b0970 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/hal/WifiNanIfaceAidlImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/hal/WifiNanIfaceAidlImplTest.java
@@ -18,6 +18,7 @@ package com.android.server.wifi.hal;
 
 import static android.hardware.wifi.V1_0.NanCipherSuiteType.SHARED_KEY_128_MASK;
 import static android.hardware.wifi.V1_0.NanCipherSuiteType.SHARED_KEY_256_MASK;
+import static android.net.wifi.aware.AwarePairingConfig.PAIRING_BOOTSTRAPPING_OPPORTUNISTIC;
 import static android.net.wifi.aware.Characteristics.WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_128;
 import static android.net.wifi.aware.Characteristics.WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_256;
 import static android.net.wifi.aware.Characteristics.WIFI_AWARE_CIPHER_SUITE_NCS_SK_128;
@@ -30,6 +31,7 @@ import static org.hamcrest.core.IsEqual.equalTo;
 import static org.junit.Assert.assertArrayEquals;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertTrue;
+import static org.junit.Assume.assumeTrue;
 import static org.mockito.ArgumentMatchers.eq;
 import static org.mockito.Mockito.times;
 import static org.mockito.Mockito.verify;
@@ -53,10 +55,12 @@ import android.hardware.wifi.NanRespondToPairingIndicationRequest;
 import android.hardware.wifi.NanSubscribeRequest;
 import android.net.MacAddress;
 import android.net.wifi.OuiKeyedData;
+import android.net.wifi.aware.AwarePairingConfig;
 import android.net.wifi.aware.ConfigRequest;
 import android.net.wifi.aware.PublishConfig;
 import android.net.wifi.aware.SubscribeConfig;
 import android.net.wifi.aware.WifiAwareDataPathSecurityConfig;
+import android.net.wifi.util.Environment;
 import android.os.PersistableBundle;
 import android.os.RemoteException;
 import android.util.Pair;
@@ -133,6 +137,7 @@ public class WifiNanIfaceAidlImplTest extends WifiBaseTest {
         byte pid = 34;
         int minDistanceMm = 100;
         int maxDistanceMm = 555;
+        int periodicRangingInterval = SubscribeConfig.PERIODIC_RANGING_INTERVAL_512TU;
         short minDistanceCm = (short) (minDistanceMm / 10);
         short maxDistanceCm = (short) (maxDistanceMm / 10);
         List<OuiKeyedData> frameworkVendorData = generateFrameworkOuiKeyedDataList(5);
@@ -167,6 +172,14 @@ public class WifiNanIfaceAidlImplTest extends WifiBaseTest {
                     .setVendorData(frameworkVendorData)
                     .build();
         }
+        SubscribeConfig subWithPeriodicRanging = null;
+        if (Environment.isSdkAtLeastB()) {
+            subWithPeriodicRanging = new SubscribeConfig.Builder()
+                   .setServiceName("XXX")
+                   .setPeriodicRangingEnabled(true)
+                   .setPeriodicRangingInterval(periodicRangingInterval)
+                   .build();
+        }
 
         int numPublishExpected = 2;
         int numSubscribeExpected = 4;
@@ -183,6 +196,12 @@ public class WifiNanIfaceAidlImplTest extends WifiBaseTest {
             assertTrue(mDut.subscribe(tid, pid, subWithVendorData, null));
             numPublishExpected += 1;
             numSubscribeExpected += 1;
+
+        }
+
+        if (Environment.isSdkAtLeastB()) {
+            assertTrue(mDut.subscribe(tid, pid, subWithPeriodicRanging, null));
+            numSubscribeExpected += 1;
         }
 
         verify(mIWifiNanIfaceMock, times(numPublishExpected))
@@ -257,6 +276,43 @@ public class WifiNanIfaceAidlImplTest extends WifiBaseTest {
             assertTrue(compareHalOuiKeyedDataList(halVendorData, halPubReq.vendorData));
             assertTrue(compareHalOuiKeyedDataList(halVendorData, halSubReq.vendorData));
         }
+
+        // subPeriodicRanging
+        if (Environment.isSdkAtLeastB()) {
+            halSubReq = subCaptor.getAllValues().get(5);
+            collector.checkThat("subDefault.baseConfigs.sessionId", pid,
+                    equalTo(halSubReq.baseConfigs.sessionId));
+            collector.checkThat("subDefault.baseConfigs.rangingIntervalMs", periodicRangingInterval,
+                    equalTo(halSubReq.baseConfigs.rangingIntervalMs));
+        }
+    }
+
+    @Test
+    public void testPairingSettings() throws RemoteException {
+        assumeTrue(SdkLevel.isAtLeastU());
+        short tid = 250;
+        byte pid = 34;
+        AwarePairingConfig awarePairingConfig = new AwarePairingConfig.Builder()
+                .setPairingCacheEnabled(true)
+                .setPairingSetupEnabled(true)
+                .setPairingVerificationEnabled(true)
+                .setBootstrappingMethods(PAIRING_BOOTSTRAPPING_OPPORTUNISTIC)
+                .setSupportedCipherSuites(WIFI_AWARE_CIPHER_SUITE_NCS_PK_PASN_128)
+                .build();
+        PublishConfig config = new PublishConfig.Builder()
+                .setServiceName("XXX")
+                .setPairingConfig(awarePairingConfig)
+                .build();
+        ArgumentCaptor<NanPublishRequest> pubCaptor = ArgumentCaptor.forClass(
+                NanPublishRequest.class);
+        assertTrue(mDut.publish(tid, pid, config, null));
+        verify(mIWifiNanIfaceMock)
+                .startPublishRequest(eq((char) tid), pubCaptor.capture());
+        NanPublishRequest halPubReq = pubCaptor.getValue();
+        assertEquals(NanDataPathSecurityType.PASSPHRASE,
+                halPubReq.baseConfigs.securityConfig.securityType);
+        assertEquals(NanCipherSuiteType.PUBLIC_KEY_PASN_128_MASK,
+                halPubReq.baseConfigs.securityConfig.cipherType);
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/mainline_supplicant/MainlineSupplicantTest.java b/service/tests/wifitests/src/com/android/server/wifi/mainline_supplicant/MainlineSupplicantTest.java
index 2312fc6c33..3395670959 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/mainline_supplicant/MainlineSupplicantTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/mainline_supplicant/MainlineSupplicantTest.java
@@ -21,23 +21,28 @@ import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertNotNull;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeTrue;
+import static org.mockito.ArgumentMatchers.anyByte;
 import static org.mockito.ArgumentMatchers.anyInt;
 import static org.mockito.ArgumentMatchers.anyString;
+import static org.mockito.ArgumentMatchers.eq;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
 import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
 
+import android.net.wifi.WifiContext;
 import android.net.wifi.usd.PublishConfig;
 import android.net.wifi.usd.SubscribeConfig;
 import android.net.wifi.util.Environment;
+import android.net.wifi.util.WifiResourceCache;
 import android.os.Handler;
 import android.os.IBinder;
 import android.os.test.TestLooper;
 import android.system.wifi.mainline_supplicant.IMainlineSupplicant;
 import android.system.wifi.mainline_supplicant.IStaInterface;
 
+import com.android.server.wifi.WifiGlobals;
 import com.android.server.wifi.WifiNative;
 import com.android.server.wifi.WifiThreadRunner;
 
@@ -47,6 +52,9 @@ import org.mockito.ArgumentCaptor;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
 
+import java.io.PrintWriter;
+import java.io.StringWriter;
+
 /**
  * Unit tests for {@link MainlineSupplicant}.
  */
@@ -58,6 +66,9 @@ public class MainlineSupplicantTest {
     private @Mock IBinder mIBinderMock;
     private @Mock WifiNative.SupplicantDeathEventHandler mFrameworkDeathHandler;
     private @Mock IStaInterface mIStaInterface;
+    private @Mock WifiContext mContext;
+    private @Mock WifiResourceCache mResourceCache;
+    private @Mock WifiGlobals mWifiGlobals;
     private MainlineSupplicantSpy mDut;
     private TestLooper mLooper = new TestLooper();
 
@@ -67,7 +78,7 @@ public class MainlineSupplicantTest {
     // Spy version of this class allows us to override methods for testing.
     private class MainlineSupplicantSpy extends MainlineSupplicant {
         MainlineSupplicantSpy() {
-            super(new WifiThreadRunner(new Handler(mLooper.getLooper())));
+            super(new WifiThreadRunner(new Handler(mLooper.getLooper())), mContext, mWifiGlobals);
         }
 
         @Override
@@ -82,6 +93,7 @@ public class MainlineSupplicantTest {
         MockitoAnnotations.initMocks(this);
         when(mIMainlineSupplicantMock.asBinder()).thenReturn(mIBinderMock);
         when(mIMainlineSupplicantMock.addStaInterface(anyString())).thenReturn(mIStaInterface);
+        when(mContext.getResourceCache()).thenReturn(mResourceCache);
         mDut = new MainlineSupplicantSpy();
     }
 
@@ -214,4 +226,39 @@ public class MainlineSupplicantTest {
                 MainlineSupplicant.frameworkToHalUsdSubscribeConfig(frameworkConfig);
         verifyUsdBaseConfigDefaultValues(aidlConfig.baseConfig);
     }
+
+    /**
+     * Verify that the dump method properly tracks the active interfaces.
+     */
+    @Test
+    public void testDumpActiveInterfaces() throws Exception {
+        validateServiceStart();
+        StringWriter sw = new StringWriter();
+        PrintWriter pw = new PrintWriter(sw);
+
+        // Interface has not been added, so the interface name should not be in the dump.
+        mDut.dump(pw);
+        assertFalse(sw.toString().contains(IFACE_NAME));
+
+        // Interface name should appear in the dump after it has been added.
+        assertTrue(mDut.addStaInterface(IFACE_NAME));
+        mDut.dump(pw);
+        assertTrue(sw.toString().contains(IFACE_NAME));
+    }
+
+    /**
+     * Verify that the debug parameters are set both when the service is started, and also
+     * when the verbose logging parameters are updated.
+     */
+    @Test
+    public void testSetDebugParams() throws Exception {
+        // Validate call when service is started.
+        when(mWifiGlobals.getShowKeyVerboseLoggingModeEnabled()).thenReturn(true);
+        validateServiceStart();
+        verify(mIMainlineSupplicantMock, times(1)).setDebugParams(anyByte(), eq(false));
+
+        // Validate call when enableVerboseLogging is called.
+        mDut.enableVerboseLogging(true, true);
+        verify(mIMainlineSupplicantMock, times(1)).setDebugParams(anyByte(), eq(true));
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/p2p/SupplicantP2pIfaceHalAidlImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/p2p/SupplicantP2pIfaceHalAidlImplTest.java
index 142eb27de2..dcd259d9fe 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/p2p/SupplicantP2pIfaceHalAidlImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/p2p/SupplicantP2pIfaceHalAidlImplTest.java
@@ -2826,6 +2826,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
                         NativeUtil.macAddressFromByteArray(macAddress)))
                 .setPairingBootstrappingConfig(pairingBootstrappingConfig)
                 .setAuthorizeConnectionFromPeerEnabled(authorize)
+                .enablePersistentMode(true)
                 .build();
         config.groupOwnerIntent = WifiP2pServiceImpl.DEFAULT_GROUP_OWNER_INTENT;
         return config;
@@ -3237,6 +3238,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(0, aidlConnectInfo.frequencyMHz);
         assertFalse(aidlConnectInfo.authorizeConnectionFromPeer);
         assertNull(aidlConnectInfo.groupInterfaceName);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3268,6 +3270,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(0, aidlConnectInfo.frequencyMHz);
         assertFalse(aidlConnectInfo.authorizeConnectionFromPeer);
         assertNull(aidlConnectInfo.groupInterfaceName);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3296,6 +3299,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(P2pPairingBootstrappingMethodMask.BOOTSTRAPPING_DISPLAY_PASSPHRASE,
                 aidlConnectInfo.pairingBootstrappingMethod);
         assertEquals("abed", aidlConnectInfo.password);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3325,6 +3329,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(P2pPairingBootstrappingMethodMask.BOOTSTRAPPING_KEYPAD_PINCODE,
                 aidlConnectInfo.pairingBootstrappingMethod);
         assertEquals("1234", aidlConnectInfo.password);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3354,6 +3359,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(P2pPairingBootstrappingMethodMask.BOOTSTRAPPING_KEYPAD_PASSPHRASE,
                 aidlConnectInfo.pairingBootstrappingMethod);
         assertEquals("abed", aidlConnectInfo.password);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3383,6 +3389,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
         assertEquals(P2pPairingBootstrappingMethodMask.BOOTSTRAPPING_OUT_OF_BAND,
                 aidlConnectInfo.pairingBootstrappingMethod);
         assertEquals("abed", aidlConnectInfo.password);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
@@ -3413,6 +3420,7 @@ public class SupplicantP2pIfaceHalAidlImplTest extends WifiBaseTest {
                 aidlConnectInfo.pairingBootstrappingMethod);
         assertEquals(TEST_GROUP_INTERFACE_NAME, aidlConnectInfo.groupInterfaceName);
         assertTrue(aidlConnectInfo.authorizeConnectionFromPeer);
+        assertTrue(aidlConnectInfo.persistent);
     }
 
     /**
diff --git a/service/tests/wifitests/src/com/android/server/wifi/p2p/WifiP2pServiceImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/p2p/WifiP2pServiceImplTest.java
index dd1e7a9937..fe4ff21f11 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/p2p/WifiP2pServiceImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/p2p/WifiP2pServiceImplTest.java
@@ -42,6 +42,7 @@ import static org.junit.Assert.assertNotNull;
 import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertThrows;
 import static org.junit.Assert.assertTrue;
+import static org.junit.Assert.fail;
 import static org.junit.Assume.assumeFalse;
 import static org.junit.Assume.assumeTrue;
 import static org.mockito.ArgumentMatchers.argThat;
@@ -1619,6 +1620,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         when(mLayoutInflater.inflate(anyInt(), any(), anyBoolean())).thenReturn(mView);
         when(mView.findViewById(eq(R.id.name))).thenReturn(mock(TextView.class));
         when(mView.findViewById(eq(R.id.value))).thenReturn(mock(TextView.class));
+        when(mView.findViewById(eq(R.id.enter_pin_section))).thenReturn(mock(TextView.class));
         when(mView.findViewById(eq(R.id.info))).thenReturn(mock(ViewGroup.class));
         ArrayList<InetAddress> p2pInetAddresses = new ArrayList<>();
         p2pInetAddresses.add(InetAddresses.parseNumericAddress(P2P_GO_IP));
@@ -1714,6 +1716,40 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         sendNegotiationRequestEvent(config);
     }
 
+    /**
+     * Mock Provision Discovery Event for V2 connection.
+     */
+    private void mockProvisioningDiscoveryEventForV2Connection(int pdEventId)
+            throws Exception {
+        mockPeersList();
+        WifiP2pProvDiscEvent pdEvent = createWifiP2pProvDiscEventForV2Connection(pdEventId,
+                true);
+        sendSimpleMsg(null,
+                convertPdEventIdToWifiP2pMonitorEventForV2Connection(pdEventId),
+                pdEvent);
+    }
+
+    private int convertPdEventIdToWifiP2pMonitorEventForV2Connection(int pdEventId)
+            throws Exception {
+        switch (pdEventId) {
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_OPPORTUNISTIC_REQ:
+                return WifiP2pMonitor.P2P_PROV_DISC_PAIRING_BOOTSTRAPPING_OPPORTUNISTIC_REQ_EVENT;
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_OPPORTUNISTIC_RSP:
+                return WifiP2pMonitor.P2P_PROV_DISC_PAIRING_BOOTSTRAPPING_OPPORTUNISTIC_RSP_EVENT;
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_ENTER_PIN:
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_ENTER_PASSPHRASE:
+                return WifiP2pMonitor
+                        .P2P_PROV_DISC_ENTER_PAIRING_BOOTSTRAPPING_PIN_OR_PASSPHRASE_EVENT;
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PIN:
+            case WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PASSPHRASE:
+                return WifiP2pMonitor
+                        .P2P_PROV_DISC_SHOW_PAIRING_BOOTSTRAPPING_PIN_OR_PASSPHRASE_EVENT;
+            default:
+                fail("Unexpected pdEvent for V2 connection: " + pdEventId);
+                return 0;
+        }
+    }
+
     /** Mock enter the user authorizing invite request state. */
     private void mockEnterUserAuthorizingInviteRequestState() throws Exception {
         mockPeersList();
@@ -3697,8 +3733,18 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         AsyncChannel wifiChannel = mAsyncChannel;
         sendChannelHalfConnectedEvent(mClientMessenger, wifiChannel);
         WifiDialogManager.DialogHandle dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any())).thenReturn(dialogHandle);
+        WifiDialogManager.SimpleDialogBuilder dialogBuilder =
+                mock(WifiDialogManager.SimpleDialogBuilder.class);
+        when(dialogBuilder.build()).thenReturn(dialogHandle);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(dialogBuilder);
+        when(dialogBuilder.setTitle(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessage(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setPositiveButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNegativeButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNeutralButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setCallback(any(), any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.build()).thenReturn(dialogHandle);
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> callbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
 
@@ -3716,8 +3762,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
             verify(mAlertDialogBuilder).setPositiveButton(any(), clickListener.capture());
             clickListener.getValue().onClick(mAlertDialog, DialogInterface.BUTTON_POSITIVE);
         } else {
-            verify(mWifiDialogManager).createSimpleDialog(
-                    any(), any(), any(), any(), any(), callbackCaptor.capture(), any());
+            verify(dialogBuilder).setCallback(callbackCaptor.capture(), any());
             verify(dialogHandle).launchDialog();
             callbackCaptor.getValue().onPositiveButtonClicked();
         }
@@ -3766,8 +3811,17 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         AsyncChannel wifiChannel = mock(AsyncChannel.class);
         sendChannelHalfConnectedEvent(mClientMessenger, wifiChannel);
         WifiDialogManager.DialogHandle dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any())).thenReturn(dialogHandle);
+        WifiDialogManager.SimpleDialogBuilder dialogBuilder =
+                mock(WifiDialogManager.SimpleDialogBuilder.class);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(dialogBuilder);
+        when(dialogBuilder.setTitle(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessage(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setPositiveButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNegativeButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNeutralButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setCallback(any(), any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.build()).thenReturn(dialogHandle);
         ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> callbackCaptor =
                 ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
 
@@ -3785,11 +3839,9 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
             verify(mAlertDialogBuilder).setNegativeButton(any(), clickListener.capture());
             clickListener.getValue().onClick(mAlertDialog, DialogInterface.BUTTON_NEGATIVE);
         } else {
-            verify(mWifiDialogManager).createSimpleDialog(
-                    any(), any(), any(), any(), any(), callbackCaptor.capture(), any());
+            verify(dialogBuilder).setCallback(callbackCaptor.capture(), any());
             verify(dialogHandle).launchDialog();
             callbackCaptor.getValue().onNegativeButtonClicked();
-
         }
         mLooper.dispatchAll();
         verify(mWifiP2pMetrics).endConnectionEvent(P2pConnectionEvent.CLF_USER_REJECT);
@@ -3805,10 +3857,17 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         AsyncChannel wifiChannel = mock(AsyncChannel.class);
         sendChannelHalfConnectedEvent(mClientMessenger, wifiChannel);
         WifiDialogManager.DialogHandle dialogHandle = mock(WifiDialogManager.DialogHandle.class);
-        when(mWifiDialogManager.createSimpleDialog(
-                any(), any(), any(), any(), any(), any(), any())).thenReturn(dialogHandle);
-        ArgumentCaptor<WifiDialogManager.SimpleDialogCallback> callbackCaptor =
-                ArgumentCaptor.forClass(WifiDialogManager.SimpleDialogCallback.class);
+        WifiDialogManager.SimpleDialogBuilder dialogBuilder =
+                mock(WifiDialogManager.SimpleDialogBuilder.class);
+        when(mWifiDialogManager.createSimpleDialogBuilder()).thenReturn(dialogBuilder);
+        when(dialogBuilder.setTitle(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessage(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setPositiveButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNegativeButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setNeutralButtonText(any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setMessageUrl(any(), anyInt(), anyInt())).thenReturn(dialogBuilder);
+        when(dialogBuilder.setCallback(any(), any())).thenReturn(dialogBuilder);
+        when(dialogBuilder.build()).thenReturn(dialogHandle);
 
         mockEnterGroupNegotiationState();
         mockPeersList();
@@ -3828,8 +3887,6 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
             verify(mAlertDialog).show();
             verify(mAlertDialog).dismiss();
         } else {
-            verify(mWifiDialogManager).createSimpleDialog(
-                    any(), any(), any(), any(), any(), callbackCaptor.capture(), any());
             verify(dialogHandle).launchDialog();
             verify(dialogHandle).dismissDialog();
         }
@@ -7193,8 +7250,9 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
     private void verifySetConnectionRequestResult(MacAddress addr,
             boolean hasApprover,
             boolean hasPermission, boolean shouldSucceed,
-            int wpsType, int result) throws Exception {
+            int wpsType, int pdEventId, int result) throws Exception {
         Binder binder = new Binder();
+        MacAddress deviceMacAddress;
 
         forceP2pEnabled(mClient1);
         mockPeersList();
@@ -7203,14 +7261,23 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
             verifyAddExternalApprover(binder, true, true, addr);
         }
 
-        mockEnterUserAuthorizingNegotiationRequestState(wpsType);
+        if (wpsType != WpsInfo.INVALID) {
+            mockEnterUserAuthorizingNegotiationRequestState(wpsType);
+            deviceMacAddress = MacAddress.fromString(mTestWifiP2pDevice.deviceAddress);
+        } else if (pdEventId != 0) {
+            mockProvisioningDiscoveryEventForV2Connection(pdEventId);
+            deviceMacAddress = MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress);
+        } else {
+            fail("wpsType and pdEventId cannot both be INVALID.");
+            return;
+        }
 
         when(mWifiPermissionsUtil.checkManageWifiNetworkSelectionPermission(anyInt()))
                 .thenReturn(hasPermission);
         when(mWifiPermissionsUtil.checkNearbyDevicesPermission(any(), anyBoolean(), any()))
                 .thenReturn(hasPermission);
         sendSetConnectionRequestResultMsg(mClientMessenger,
-                MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
+                deviceMacAddress,
                 result, binder);
         if (shouldSucceed) {
             // There are 4 replies:
@@ -7247,7 +7314,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
         verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
                 hasApprover, hasPermission, shouldSucceed,
-                WpsInfo.PBC, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+                WpsInfo.PBC, 0, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
     }
 
     /**
@@ -7259,7 +7326,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
         verifySetConnectionRequestResult(MacAddress.BROADCAST_ADDRESS,
                 hasApprover, hasPermission, shouldSucceed,
-                WpsInfo.PBC, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+                WpsInfo.PBC, 0, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
     }
 
     /**
@@ -7289,6 +7356,19 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         verify(mWifiNative, never()).p2pStopFind();
     }
 
+    /**
+     * Verify sunny scenario for setConnectionRequestResult enter pin event.
+     */
+    @Test
+    public void testSetConnectionRequestResultSuccessEnterPin() throws Exception {
+        assumeTrue(SdkLevel.isAtLeastS());
+        boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
+        verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
+                hasApprover, hasPermission, shouldSucceed,
+                WpsInfo.KEYPAD, 0, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+        verify(mWifiNative).p2pConnect(any(), anyBoolean());
+    }
+
     private void verifyMultiApproverMatch(List<MacAddress> addresses, MacAddress expectedMatch)
             throws Exception {
         when(mWifiPermissionsUtil.checkManageWifiNetworkSelectionPermission(anyInt()))
@@ -7371,7 +7451,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         boolean hasApprover = true, hasPermission = false, shouldSucceed = false;
         verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
                 hasApprover, hasPermission, shouldSucceed,
-                WpsInfo.PBC, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+                WpsInfo.PBC, 0, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
     }
 
     /**
@@ -7383,7 +7463,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         boolean hasApprover = false, hasPermission = true, shouldSucceed = false;
         verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
                 hasApprover, hasPermission, shouldSucceed,
-                WpsInfo.PBC, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+                WpsInfo.PBC, 0, WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
     }
 
     /** Verify the failure scenario for setConnectionRequestResult without a saved peer config. */
@@ -7416,7 +7496,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
         verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
                 hasApprover, hasPermission, shouldSucceed,
-                WpsInfo.KEYPAD, WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE);
+                WpsInfo.KEYPAD, 0, WifiP2pManager.CONNECTION_REQUEST_DEFER_TO_SERVICE);
     }
 
     /**
@@ -8656,6 +8736,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertEquals(config.deviceAddress, mTestWifiP2pV2Device.deviceAddress);
         assertEquals(GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL,
                 config.getGroupClientIpProvisioningMode());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8697,6 +8778,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertEquals(config.deviceAddress, mTestWifiP2pV2Device.deviceAddress);
         assertEquals(GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL,
                 config.getGroupClientIpProvisioningMode());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8739,6 +8821,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertEquals(config.deviceAddress, mTestWifiP2pV2Device.deviceAddress);
         assertEquals(GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL,
                 config.getGroupClientIpProvisioningMode());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
 
@@ -8772,8 +8855,8 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertTrue(pincode.matches("\\d{8}"));
         verify(mDialogHandle).launchDialog();
 
-
-        // Framework is expected to send connect as soon as the PIN is Displayed
+        // Framework is expected to send connect if user accepts the connection request.
+        sendSimpleMsg(null, WifiP2pServiceImpl.PEER_CONNECTION_USER_ACCEPT);
         verify(mWifiNative, times(1)).p2pConnect(configCaptor.capture(),
                 eq(false));
         WifiP2pConfig config = configCaptor.getValue();
@@ -8786,6 +8869,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
         assertEquals(GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL,
                 config.getGroupClientIpProvisioningMode());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8818,7 +8902,8 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         verify(mDialogHandle).launchDialog();
 
 
-        // Framework is expected to send connect as soon as the Passphrase is Displayed
+        // Framework is expected to send connect if user accepts the connection request.
+        sendSimpleMsg(null, WifiP2pServiceImpl.PEER_CONNECTION_USER_ACCEPT);
         verify(mWifiNative, times(1)).p2pConnect(configCaptor.capture(),
                 eq(false));
         WifiP2pConfig config = configCaptor.getValue();
@@ -8831,6 +8916,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
         assertEquals(GROUP_CLIENT_IP_PROVISIONING_MODE_IPV6_LINK_LOCAL,
                 config.getGroupClientIpProvisioningMode());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8869,6 +8955,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
                         .PAIRING_BOOTSTRAPPING_METHOD_OPPORTUNISTIC,
                 config.getPairingBootstrappingConfig().getPairingBootstrappingMethod());
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8909,6 +8996,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
                         .PAIRING_BOOTSTRAPPING_METHOD_KEYPAD_PINCODE,
                 config.getPairingBootstrappingConfig().getPairingBootstrappingMethod());
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8948,6 +9036,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
                         .PAIRING_BOOTSTRAPPING_METHOD_KEYPAD_PASSPHRASE,
                 config.getPairingBootstrappingConfig().getPairingBootstrappingMethod());
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -8992,6 +9081,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertEquals(pincode,
                 config.getPairingBootstrappingConfig().getPairingBootstrappingPassword());
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -9036,6 +9126,7 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         assertEquals(passphrase,
                 config.getPairingBootstrappingConfig().getPairingBootstrappingPassword());
         assertTrue(config.isAuthorizeConnectionFromPeerEnabled());
+        assertEquals(WifiP2pGroup.NETWORK_ID_PERSISTENT, config.netId);
     }
 
     /**
@@ -9267,4 +9358,178 @@ public class WifiP2pServiceImplTest extends WifiBaseTest {
         verify(mWifiNative).p2pProvisionDiscovery(any());
         verify(mWifiNative, never()).p2pReinvoke(anyInt(), any(), anyInt());
     }
+
+    /**
+     * Test setConnectionRequestResult for pairing bootstrapping method: Opportunistic.
+     */
+    @Test
+    public void testSetConnectionRequestResultSuccessOpportunistic() throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
+        verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                hasApprover, hasPermission, shouldSucceed,
+                WpsInfo.INVALID, WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_OPPORTUNISTIC_REQ,
+                WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+        verify(mWifiNative).p2pConnect(any(), anyBoolean());
+    }
+
+    /**
+     * Test setConnectionRequestResult for pairing bootstrapping method: Display pincode.
+     */
+    @Test
+    public void testSetConnectionRequestResultSuccessDisplayPinCode() throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
+        verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                hasApprover, hasPermission, shouldSucceed,
+                WpsInfo.INVALID, WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PIN,
+                WifiP2pManager.CONNECTION_REQUEST_ACCEPT);
+        verify(mWifiNative).p2pConnect(any(), anyBoolean());
+    }
+
+    /**
+     * Test setConnectionRequestResult with response as defer show pin to service for pairing
+     * bootstrapping method: Display pincode.
+     */
+    @Test
+    public void testSetConnectionRequestResultDeferDisplayPinCodeToFramework() throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
+        verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                hasApprover, hasPermission, shouldSucceed,
+                WpsInfo.INVALID, WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PIN,
+                WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE);
+        // Expect isPinRequested to false for displaying the pincode
+        verify(mWifiDialogManager).createP2pInvitationReceivedDialog(
+                any(), eq(false), any(), anyInt(), anyInt(), any(), any());
+        verify(mDialogHandle).launchDialog();
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+    }
+
+    /**
+     * Test setConnectionRequestResult with response as defer to service for pairing
+     * bootstrapping method: keypad pincode.
+     */
+    @Test
+    public void testSetConnectionRequestResultDeferEnterPinCodeToFramework() throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        boolean hasApprover = true, hasPermission = true, shouldSucceed = true;
+        verifySetConnectionRequestResult(MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                hasApprover, hasPermission, shouldSucceed,
+                WpsInfo.INVALID, WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_ENTER_PIN,
+                WifiP2pManager.CONNECTION_REQUEST_DEFER_TO_SERVICE);
+        // Expect isPinRequested to true for entering the pincode
+        verify(mWifiDialogManager).createP2pInvitationReceivedDialog(
+                any(), eq(true), any(), anyInt(), anyInt(), any(), any());
+        verify(mDialogHandle).launchDialog();
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+    }
+
+    /**
+     * Test setConnectionRequestResult on initiating device with response as defer show pin to
+     * service for pairing bootstrapping method: Display pincode.
+     */
+    @Test
+    public void testSetConnectionRequestResultDeferDisplayPinCodeToFrameworkOnInitiatorSuccess()
+            throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        forceP2pEnabled(mClient1);
+        Binder binder = new Binder();
+        verifyAddExternalApprover(binder, true, true,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress));
+
+        createTestP2pV2PeerConfig(WifiP2pPairingBootstrappingConfig
+                        .PAIRING_BOOTSTRAPPING_METHOD_DISPLAY_PINCODE, "",
+                false);
+        mockEnterProvisionDiscoveryState(mTestWifiP2pV2PeerConfig);
+
+        WifiP2pProvDiscEvent pdEvent = createWifiP2pProvDiscEventForV2Connection(
+                WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PIN, true);
+        sendSimpleMsg(null,
+                WifiP2pMonitor.P2P_PROV_DISC_SHOW_PAIRING_BOOTSTRAPPING_PIN_OR_PASSPHRASE_EVENT,
+                pdEvent);
+
+        sendSetConnectionRequestResultMsg(mClientMessenger,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE, binder);
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+        verify(mWifiDialogManager).createP2pInvitationSentDialog(
+                any(), any(),
+                eq(Display.DEFAULT_DISPLAY));
+    }
+
+    /**
+     * Test setConnectionRequestResult on initiating device with response code
+     * CONNECTION_REQUEST_ACCEPT, CONNECTION_REQUEST_REJECT & CONNECTION_REQUEST_DEFER_TO_SERVICE
+     * are not handled in provision discovery state.
+     */
+    @Test
+    public void testShouldIgnoreSetConnectionRequestResultWhenInProvisionDiscoveryState()
+            throws Exception {
+        assumeTrue(Environment.isSdkAtLeastB());
+        forceP2pEnabled(mClient1);
+        Binder binder = new Binder();
+        verifyAddExternalApprover(binder, true, true,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress));
+
+        createTestP2pV2PeerConfig(WifiP2pPairingBootstrappingConfig
+                        .PAIRING_BOOTSTRAPPING_METHOD_DISPLAY_PINCODE, "",
+                false);
+        mockEnterProvisionDiscoveryState(mTestWifiP2pV2PeerConfig);
+
+        WifiP2pProvDiscEvent pdEvent = createWifiP2pProvDiscEventForV2Connection(
+                WifiP2pProvDiscEvent.PAIRING_BOOTSTRAPPING_SHOW_PIN, true);
+        sendSimpleMsg(null,
+                WifiP2pMonitor.P2P_PROV_DISC_SHOW_PAIRING_BOOTSTRAPPING_PIN_OR_PASSPHRASE_EVENT,
+                pdEvent);
+
+        sendSetConnectionRequestResultMsg(mClientMessenger,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                WifiP2pManager.CONNECTION_REQUEST_ACCEPT, binder);
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+        verify(mWifiDialogManager, never()).createP2pInvitationSentDialog(
+                any(), any(),
+                eq(Display.DEFAULT_DISPLAY));
+
+        sendSetConnectionRequestResultMsg(mClientMessenger,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                WifiP2pManager.CONNECTION_REQUEST_REJECT, binder);
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+        verify(mWifiDialogManager, never()).createP2pInvitationSentDialog(
+                any(), any(),
+                eq(Display.DEFAULT_DISPLAY));
+
+        sendSetConnectionRequestResultMsg(mClientMessenger,
+                MacAddress.fromString(mTestWifiP2pV2Device.deviceAddress),
+                WifiP2pManager.CONNECTION_REQUEST_DEFER_TO_SERVICE, binder);
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+        verify(mWifiDialogManager, never()).createP2pInvitationSentDialog(
+                any(), any(),
+                eq(Display.DEFAULT_DISPLAY));
+    }
+
+    /**
+     * Test setConnectionRequestResult with WPS configuration is not handled in
+     * ProvisionDiscoveryState.
+     */
+    @Test
+    public void testSetConnectionRequestResultWithWpsConfigInProvisionDiscoveryStateIsNotHandled()
+            throws Exception {
+        assumeTrue(SdkLevel.isAtLeastS());
+        forceP2pEnabled(mClient1);
+        Binder binder = new Binder();
+        mTestWifiP2pPeerConfig.wps.setup = WpsInfo.DISPLAY;
+        verifyAddExternalApprover(binder, true, true,
+                MacAddress.fromString(mTestWifiP2pDevice.deviceAddress));
+
+        mockEnterProvisionDiscoveryState();
+
+        sendSetConnectionRequestResultMsg(mClientMessenger,
+                MacAddress.fromString(mTestWifiP2pDevice.deviceAddress),
+                WifiP2pManager.CONNECTION_REQUEST_DEFER_SHOW_PIN_TO_SERVICE, binder);
+        verify(mWifiNative, never()).p2pConnect(any(), anyBoolean());
+        verify(mWifiDialogManager, never()).createP2pInvitationSentDialog(
+                any(), any(),
+                eq(Display.DEFAULT_DISPLAY));
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/rtt/RttServiceImplTest.java b/service/tests/wifitests/src/com/android/server/wifi/rtt/RttServiceImplTest.java
index e63c67512f..381b00a351 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/rtt/RttServiceImplTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/rtt/RttServiceImplTest.java
@@ -42,9 +42,11 @@ import static org.mockito.Mockito.inOrder;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.validateMockitoUsage;
 import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.verifyNoMoreInteractions;
 import static org.mockito.Mockito.when;
+import static org.mockito.Mockito.withSettings;
 
 import android.app.ActivityManager;
 import android.app.AlarmManager;
@@ -84,6 +86,7 @@ import android.util.Pair;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.Clock;
 import com.android.server.wifi.HalDeviceManager;
@@ -95,6 +98,7 @@ import com.android.server.wifi.WifiSettingsConfigStore;
 import com.android.server.wifi.hal.WifiRttController;
 import com.android.server.wifi.proto.nano.WifiMetricsProto;
 import com.android.server.wifi.util.WifiPermissionsUtil;
+import com.android.wifi.flags.Flags;
 import com.android.wifi.resources.R;
 
 import org.junit.After;
@@ -104,6 +108,7 @@ import org.mockito.ArgumentCaptor;
 import org.mockito.InOrder;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 
 import java.util.ArrayList;
 import java.util.HashSet;
@@ -127,6 +132,7 @@ public class RttServiceImplTest extends WifiBaseTest {
     private BroadcastReceiver mPowerBcastReceiver;
     private BroadcastReceiver mLocationModeReceiver;
     private MockResources mMockResources = new MockResources();
+    private MockitoSession mSession;
 
     private final String mPackageName = "some.package.name.for.rtt.app";
     private final String mFeatureId = "some.feature.name.for.rtt.app";
@@ -214,7 +220,6 @@ public class RttServiceImplTest extends WifiBaseTest {
     @Before
     public void setUp() throws Exception {
         MockitoAnnotations.initMocks(this);
-
         mDut = new RttServiceImplSpy(mockContext);
         mDut.fakeUid = mDefaultUid;
         mMockLooper = new TestLooper();
@@ -265,7 +270,8 @@ public class RttServiceImplTest extends WifiBaseTest {
         ArgumentCaptor<BroadcastReceiver> bcastRxCaptor = ArgumentCaptor.forClass(
                 BroadcastReceiver.class);
         verify(mockContext).registerReceiver(bcastRxCaptor.capture(),
-                argThat(filter -> filter.hasAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED)));
+                argThat(filter -> filter.hasAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED)),
+                eq(null), any(Handler.class));
         verify(mockContext).registerReceiverForAllUsers(bcastRxCaptor.capture(),
                 argThat(filter -> filter.hasAction(LocationManager.MODE_CHANGED_ACTION)),
                 eq(null), any(Handler.class));
@@ -284,6 +290,10 @@ public class RttServiceImplTest extends WifiBaseTest {
 
     @After
     public void tearDown() throws Exception {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
         assertEquals("Binder links != unlinks to death (size)",
                 mBinderLinkToDeathCounter.mUniqueExecs.size(),
                 mBinderUnlinkToDeathCounter.mUniqueExecs.size());
@@ -291,6 +301,21 @@ public class RttServiceImplTest extends WifiBaseTest {
                 mBinderUnlinkToDeathCounter.mUniqueExecs);
     }
 
+    @Test
+    public void testRegisterReceiverForAllUsersWhenFlagOn() throws Exception {
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .startMocking();
+        when(Flags.monitorIntentForAllUsers()).thenReturn(true);
+        mDut.start(mMockLooper.getLooper(), mockClock, mockAwareManager, mockMetrics,
+                mockPermissionUtil, mWifiSettingsConfigStore, mockHalDeviceManager,
+                mWifiConfigManager, mSsidTranslator);
+        mMockLooper.dispatchAll();
+        verify(mockContext).registerReceiver(any(BroadcastReceiver.class),
+                argThat(filter -> filter.hasAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED)),
+                eq(null), any(Handler.class));
+    }
+
     /**
      * Validate that we react correctly (i.e. enable/disable RTT availability) when
      * notified that the RTT controller has disappeared and appeared.
diff --git a/service/tests/wifitests/src/com/android/server/wifi/util/InformationElementUtilTest.java b/service/tests/wifitests/src/com/android/server/wifi/util/InformationElementUtilTest.java
index 0c6dfe15ce..8acf6d6c6e 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/util/InformationElementUtilTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/util/InformationElementUtilTest.java
@@ -2952,5 +2952,12 @@ public class InformationElementUtilTest extends WifiBaseTest {
         assertTrue(rsnxe.isSecureHeLtfSupported());
     }
 
+    /**
+     * Test no exception with null IE when calling getHS2VendorSpecificIE.
+     */
+    @Test
+    public void testGetHS2VendorSpecificIEWithNullIE() {
+        InformationElementUtil.getHS2VendorSpecificIE(new InformationElement[] {null});
+    }
 }
 
diff --git a/service/tests/wifitests/src/com/android/server/wifi/util/WifiPermissionsUtilTest.java b/service/tests/wifitests/src/com/android/server/wifi/util/WifiPermissionsUtilTest.java
index 947b45b7bf..3a923e01a7 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/util/WifiPermissionsUtilTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/util/WifiPermissionsUtilTest.java
@@ -17,8 +17,11 @@
 package com.android.server.wifi.util;
 
 import static android.Manifest.permission.ACCESS_FINE_LOCATION;
+import static android.Manifest.permission.NETWORK_CARRIER_PROVISIONING;
 import static android.Manifest.permission.NEARBY_WIFI_DEVICES;
 import static android.Manifest.permission.RENOUNCE_PERMISSIONS;
+import static android.Manifest.permission.REQUEST_COMPANION_PROFILE_AUTOMOTIVE_PROJECTION;
+import static android.Manifest.permission.REQUEST_COMPANION_PROFILE_NEARBY_DEVICE_STREAMING;
 import static android.content.pm.PackageManager.GET_PERMISSIONS;
 import static android.content.pm.PackageManager.MATCH_UNINSTALLED_PACKAGES;
 
@@ -36,8 +39,10 @@ import static org.mockito.Mockito.doThrow;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
 import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.validateMockitoUsage;
 import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
+import static org.mockito.Mockito.withSettings;
 
 import android.Manifest;
 import android.app.AppOpsManager;
@@ -65,6 +70,7 @@ import android.util.ArraySet;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.server.wifi.BinderUtil;
 import com.android.server.wifi.FakeWifiLog;
@@ -73,14 +79,17 @@ import com.android.server.wifi.WifiBaseTest;
 import com.android.server.wifi.WifiInjector;
 import com.android.wifi.resources.R;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.JUnit4;
 import org.mockito.Mock;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 import org.mockito.Spy;
 import org.mockito.invocation.InvocationOnMock;
+import org.mockito.quality.Strictness;
 import org.mockito.stubbing.Answer;
 
 import java.util.Arrays;
@@ -112,6 +121,8 @@ public class WifiPermissionsUtilTest extends WifiBaseTest {
     @Spy private FakeWifiLog mWifiLog;
     @Mock private Context mUserContext;
 
+    private MockitoSession mSession;
+
     private static final String TEST_WIFI_STACK_APK_NAME = "com.android.wifi";
     private static final String TEST_PACKAGE_NAME = "com.google.somePackage";
     private static final String TEST_FEATURE_ID = "com.google.someFeature";
@@ -166,6 +177,14 @@ public class WifiPermissionsUtilTest extends WifiBaseTest {
         setupMockInterface();
     }
 
+    @After
+    public void cleanUp() throws Exception {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
+    }
+
     /**
      * Verify we return true when the UID does have the override config permission
      */
@@ -1887,6 +1906,8 @@ public class WifiPermissionsUtilTest extends WifiBaseTest {
     @Test
     public void testIsGuestUser() throws Exception {
         when(mMockContext.createContextAsUser(any(), anyInt())).thenReturn(mUserContext);
+        when(mUserContext.getSystemService(UserManager.class)).thenReturn(null);
+        when(mMockUserManager.isGuestUser()).thenReturn(true);
         when(mUserContext.getSystemService(UserManager.class)).thenReturn(mMockUserManager);
         when(mMockUserManager.isGuestUser()).thenReturn(true);
         setupTestCase();
@@ -1991,4 +2012,73 @@ public class WifiPermissionsUtilTest extends WifiBaseTest {
                 .thenReturn(PackageManager.SIGNATURE_NO_MATCH);
         assertFalse(codeUnderTest.isSignedWithPlatformKey(TEST_CALLING_UID));
     }
+
+    /**
+     * Test checkRequestCompanionProfileAutomotiveProjectionPermission
+     */
+    @Test
+    public void testCheckRequestCompanionProfileAutomotiveProjectionPermission()
+             throws Exception {
+        setupTestCase();
+        WifiPermissionsUtil codeUnderTest = new WifiPermissionsUtil(mMockPermissionsWrapper,
+                mMockContext, mMockUserManager, mWifiInjector);
+        codeUnderTest.checkRequestCompanionProfileAutomotiveProjectionPermission(TEST_CALLING_UID);
+        verify(mMockPermissionsWrapper).getUidPermission(
+                eq(REQUEST_COMPANION_PROFILE_AUTOMOTIVE_PROJECTION),
+                eq(TEST_CALLING_UID));
+    }
+
+    /**
+     * Test checkRequestCompanionProfileNearbyDeviceStreamingPermission
+     */
+    @Test
+    public void testCheckRequestCompanionProfileNearbyDeviceStreamingPermission()
+             throws Exception {
+        setupTestCase();
+        WifiPermissionsUtil codeUnderTest = new WifiPermissionsUtil(mMockPermissionsWrapper,
+                mMockContext, mMockUserManager, mWifiInjector);
+        codeUnderTest.checkRequestCompanionProfileNearbyDeviceStreamingPermission(TEST_CALLING_UID);
+        verify(mMockPermissionsWrapper).getUidPermission(
+                eq(REQUEST_COMPANION_PROFILE_NEARBY_DEVICE_STREAMING),
+                eq(TEST_CALLING_UID));
+    }
+
+    /**
+     * Test checkNetworkCarrierProvisioningPermission
+     */
+    @Test
+    public void testCheckNetworkCarrierProvisioningPermission()
+             throws Exception {
+        setupTestCase();
+        WifiPermissionsUtil codeUnderTest = new WifiPermissionsUtil(mMockPermissionsWrapper,
+                mMockContext, mMockUserManager, mWifiInjector);
+        codeUnderTest.checkNetworkCarrierProvisioningPermission(TEST_CALLING_UID);
+        verify(mMockPermissionsWrapper).getUidPermission(eq(NETWORK_CARRIER_PROVISIONING),
+                eq(TEST_CALLING_UID));
+    }
+
+    /**
+     * Test areTwoAppsFromSameUser
+     */
+    @Test
+    public void testAreTwoAppsFromSameUser()
+             throws Exception {
+        // static mocking
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(UserHandle.class, withSettings().lenient())
+                .strictness(Strictness.LENIENT)
+                .startMocking();
+        setupTestCase();
+        WifiPermissionsUtil codeUnderTest = new WifiPermissionsUtil(mMockPermissionsWrapper,
+                mMockContext, mMockUserManager, mWifiInjector);
+        int otherCallingUid = TEST_CALLING_UID + 1;
+        UserHandle testUserHandle = mock(UserHandle.class);
+        when(UserHandle.getUserHandleForUid(anyInt())).thenReturn(null);
+        // No UserHandle
+        assertFalse(codeUnderTest.areTwoAppsFromSameUser(TEST_CALLING_UID, otherCallingUid));
+        // Same UserHandle
+        when(UserHandle.getUserHandleForUid(eq(TEST_CALLING_UID))).thenReturn(testUserHandle);
+        when(UserHandle.getUserHandleForUid(eq(otherCallingUid))).thenReturn(testUserHandle);
+        assertTrue(codeUnderTest.areTwoAppsFromSameUser(TEST_CALLING_UID, otherCallingUid));
+    }
 }
diff --git a/service/tests/wifitests/src/com/android/server/wifi/util/XmlUtilTest.java b/service/tests/wifitests/src/com/android/server/wifi/util/XmlUtilTest.java
index 389686ee77..34db19d440 100644
--- a/service/tests/wifitests/src/com/android/server/wifi/util/XmlUtilTest.java
+++ b/service/tests/wifitests/src/com/android/server/wifi/util/XmlUtilTest.java
@@ -23,19 +23,23 @@ import static org.junit.Assert.assertTrue;
 import static org.junit.Assume.assumeTrue;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.never;
+import static org.mockito.Mockito.validateMockitoUsage;
 import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
+import static org.mockito.Mockito.withSettings;
 
 import android.net.IpConfiguration;
 import android.net.MacAddress;
 import android.net.wifi.WifiConfiguration;
 import android.net.wifi.WifiConfiguration.NetworkSelectionStatus;
 import android.net.wifi.WifiEnterpriseConfig;
+import android.net.wifi.util.Environment;
 import android.util.Pair;
 import android.util.Xml;
 
 import androidx.test.filters.SmallTest;
 
+import com.android.dx.mockito.inline.extended.ExtendedMockito;
 import com.android.internal.util.FastXmlSerializer;
 import com.android.modules.utils.build.SdkLevel;
 import com.android.net.module.util.MacAddressUtils;
@@ -46,10 +50,13 @@ import com.android.server.wifi.util.XmlUtil.IpConfigurationXmlUtil;
 import com.android.server.wifi.util.XmlUtil.NetworkSelectionStatusXmlUtil;
 import com.android.server.wifi.util.XmlUtil.WifiConfigurationXmlUtil;
 import com.android.server.wifi.util.XmlUtil.WifiEnterpriseConfigXmlUtil;
+import com.android.wifi.flags.Flags;
 
+import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.MockitoAnnotations;
+import org.mockito.MockitoSession;
 import org.xmlpull.v1.XmlPullParser;
 import org.xmlpull.v1.XmlPullParserException;
 import org.xmlpull.v1.XmlSerializer;
@@ -93,9 +100,25 @@ public class XmlUtilTest extends WifiBaseTest {
     private static final String ANONYMOUS_IDENTITY = "aaa@bbb.cc.ddd";
     private WifiConfigStoreEncryptionUtil mWifiConfigStoreEncryptionUtil = null;
 
+    private MockitoSession mSession;
+
     @Before
     public void setUp() throws Exception {
         MockitoAnnotations.initMocks(this);
+        mSession = ExtendedMockito.mockitoSession()
+                .mockStatic(Flags.class, withSettings().lenient())
+                .startMocking();
+    }
+
+    /**
+     * Called after each test
+     */
+    @After
+    public void cleanup() {
+        validateMockitoUsage();
+        if (mSession != null) {
+            mSession.finishMocking();
+        }
     }
 
     /**
@@ -983,4 +1006,20 @@ public class XmlUtilTest extends WifiBaseTest {
         config.setVendorData(OuiKeyedDataUtil.createTestOuiKeyedDataList(10));
         serializeDeserializeWifiConfiguration(config);
     }
+
+    /**
+     * Verify that the vendor data field is serialized and deserialized correctly
+     * when provided.
+     */
+    @Test
+    public void testWifiConfigurationWithAllowedToUpdateByOtherUsers() throws Exception {
+        assumeTrue(Environment.isSdkNewerThanB());
+        WifiConfiguration config = WifiConfigurationTestUtil.createOpenNetwork();
+        when(Flags.multiUserWifiEnhancement()).thenReturn(false);
+        config.setAllowedToUpdateByOtherUsers(true);
+        serializeDeserializeWifiConfiguration(config);
+        when(Flags.multiUserWifiEnhancement()).thenReturn(true);
+        config.setAllowedToUpdateByOtherUsers(false);
+        serializeDeserializeWifiConfiguration(config);
+    }
 }
diff --git a/service/wifi.rc b/service/wifi.rc
index eceee0ae09..f60cebc0a7 100644
--- a/service/wifi.rc
+++ b/service/wifi.rc
@@ -27,12 +27,6 @@ on fs
 
 on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
    # Create trace buffer, and set basic configuration.
-   mkdir /sys/kernel/debug/tracing/instances/wifi 711
-   restorecon_recursive /sys/kernel/debug/tracing/instances/wifi
-   write /sys/kernel/debug/tracing/instances/wifi/tracing_on 0
-   write /sys/kernel/debug/tracing/instances/wifi/buffer_size_kb 1
-   write /sys/kernel/debug/tracing/instances/wifi/trace_options disable_on_free
-
    mkdir /sys/kernel/tracing/instances/wifi 711
    restorecon_recursive /sys/kernel/tracing/instances/wifi
    write /sys/kernel/tracing/instances/wifi/tracing_on 0
@@ -41,17 +35,8 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
 
    # Enable cfg80211 events for connection and key management events.
    # - Events are not actually logged until WifiService writes "1" to
-   #   /sys/kernel/debug/tracing/instances/wifi/tracing_on.
+   #   /sys/kernel/tracing/instances/wifi/tracing_on.
    # - WifiService is responsible for turning tracing off and on.
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_auth/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_connect/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_key/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_default_mgmt_key/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/cfg80211/rdev_set_rekey_data/enable 1
-
    write /sys/kernel/tracing/instances/wifi/events/cfg80211/cfg80211_gtk_rekey_notify/enable 1
    write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_add_key/enable 1
    write /sys/kernel/tracing/instances/wifi/events/cfg80211/rdev_assoc/enable 1
@@ -63,15 +48,9 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
 
    # Enable datapath events for Wifi.
    # - Events are not actually logged until WifiService writes "1" to
-   #   /sys/kernel/debug/tracing/instances/wifi/tracing_on.
+   #   /sys/kernel/tracing/instances/wifi/tracing_on.
    # - WifiService will ensure that tracing is turned back off,
    #   when a connection attempt ends (whether in success or failure)
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_queue/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_rx/enable 1
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/netif_receive_skb/enable 1
-
    write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface:-wlan0}
    write /sys/kernel/tracing/instances/wifi/events/net/net_dev_queue/enable 1
    write /sys/kernel/tracing/instances/wifi/events/net/net_dev_xmit/enable 1
@@ -80,13 +59,6 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
 
    # Set DAC to allow system to enable/disable, and read wifi trace
    # events.
-   chown system /sys/kernel/debug/tracing/instances/wifi/tracing_on
-   chown system /sys/kernel/debug/tracing/instances/wifi/free_buffer
-   chown system /sys/kernel/debug/tracing/instances/wifi/trace
-   chmod 200 /sys/kernel/debug/tracing/instances/wifi/tracing_on
-   chmod 400 /sys/kernel/debug/tracing/instances/wifi/free_buffer
-   chmod 600 /sys/kernel/debug/tracing/instances/wifi/trace
-
    chown system /sys/kernel/tracing/instances/wifi/tracing_on
    chown system /sys/kernel/tracing/instances/wifi/free_buffer
    chown system /sys/kernel/tracing/instances/wifi/trace
@@ -97,5 +69,4 @@ on property:sys.boot_completed=1 && property:sys.wifitracing.started=0
 
 on property:sys.boot_completed=1 && property:wifi.interface=* && property:sys.wifitracing.started=1
    # Override default value.
-   write /sys/kernel/debug/tracing/instances/wifi/events/net/filter name==${wifi.interface}
    write /sys/kernel/tracing/instances/wifi/events/net/filter name==${wifi.interface}
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/AndroidManifest.xml b/tests/hostsidetests/multidevices/com.google.snippet.wifi/AndroidManifest.xml
index 719d3fe6cb..0063a1105e 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/AndroidManifest.xml
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/AndroidManifest.xml
@@ -35,4 +35,4 @@
   <instrumentation
       android:name="com.google.android.mobly.snippet.SnippetRunner"
       android:targetPackage="com.google.snippet.wifi"/>
-</manifest>
\ No newline at end of file
+</manifest>
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiJsonConverter.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiJsonConverter.java
index 47c408268d..723da9a2f3 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiJsonConverter.java
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiJsonConverter.java
@@ -17,6 +17,7 @@
 package com.google.snippet.wifi;
 
 import android.net.wifi.SoftApConfiguration;
+import android.net.wifi.WifiConfiguration;
 
 import com.google.gson.Gson;
 import com.google.gson.GsonBuilder;
@@ -59,6 +60,9 @@ public final class WifiJsonConverter {
         if (object instanceof SoftApConfiguration) {
             return serializeSoftApConfiguration((SoftApConfiguration) object);
         }
+        if (object instanceof WifiConfiguration) {
+            return serializeWifiConfiguration((WifiConfiguration) object);
+        }
 
         // By default, depends on Gson to serialize correctly.
         return new JSONObject(GSON.toJson(object));
@@ -71,5 +75,21 @@ public final class WifiJsonConverter {
         return result;
     }
 
-    private WifiJsonConverter() {}
+    private static JSONObject serializeWifiConfiguration(WifiConfiguration data)
+            throws JSONException {
+        JSONObject result = new JSONObject();
+        result.put("networkId", data.networkId);
+        result.put("Status", WifiConfiguration.Status.strings[data.status]);
+        result.put("BSSID", trimQuotationMarks(data.BSSID));
+        result.put("SSID", trimQuotationMarks(data.SSID));
+        result.put("HOME-PROVIDER-NETWORK", data.isHomeProviderNetwork);
+        result.put("PRIO", data.priority);
+        result.put("HIDDEN", data.hiddenSSID);
+        result.put("PMF", data.requirePmf);
+        result.put("CarrierId", data.carrierId);
+        result.put("SubscriptionId", data.subscriptionId);
+        return result;
+    }
+
+    private WifiJsonConverter() { }
 }
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiManagerSnippet.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiManagerSnippet.java
index 3a0ce0d57b..33d63708c1 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiManagerSnippet.java
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiManagerSnippet.java
@@ -18,48 +18,78 @@ package com.google.snippet.wifi;
 
 import static android.net.wifi.DeauthenticationReasonCode.REASON_UNKNOWN;
 
+import static java.util.concurrent.TimeUnit.SECONDS;
+
+import android.content.BroadcastReceiver;
 import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
+import android.net.ConnectivityManager;
+import android.net.NetworkInfo;
+import android.net.NetworkInfo.DetailedState;
+import android.net.wifi.ScanResult;
 import android.net.wifi.SoftApConfiguration;
 import android.net.wifi.SoftApInfo;
+import android.net.wifi.SupplicantState;
 import android.net.wifi.WifiClient;
 import android.net.wifi.WifiConfiguration;
+import android.net.wifi.WifiInfo;
 import android.net.wifi.WifiManager;
+import android.net.wifi.WifiScanner;
+import android.net.wifi.WifiScanner.ScanData;
 import android.os.Handler;
 import android.os.HandlerThread;
+import android.os.SystemClock;
 import android.util.Log;
 
 import androidx.annotation.NonNull;
 import androidx.test.platform.app.InstrumentationRegistry;
 
 import com.android.compatibility.common.util.PollingCheck;
+import com.android.compatibility.common.util.ShellIdentityUtils;
 import com.android.wifi.flags.Flags;
 
 import com.google.android.mobly.snippet.Snippet;
+import com.google.android.mobly.snippet.bundled.utils.JsonDeserializer;
+import com.google.android.mobly.snippet.bundled.utils.Utils;
 import com.google.android.mobly.snippet.event.EventCache;
 import com.google.android.mobly.snippet.event.SnippetEvent;
 import com.google.android.mobly.snippet.rpc.AsyncRpc;
 import com.google.android.mobly.snippet.rpc.Rpc;
+import com.google.snippet.wifi.softap.WifiSapJsonDeserializer;
 
 import org.json.JSONException;
 import org.json.JSONObject;
 
+import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.List;
+import java.util.Locale;
+import java.util.concurrent.CountDownLatch;
 import java.util.concurrent.TimeUnit;
+import java.util.concurrent.TimeoutException;
+
 
-/** Snippet class for WifiManager. */
-public class WifiManagerSnippet implements Snippet {
+/**
+ * Snippet class for WifiManager.
+ */
+public class WifiManagerSnippet extends WifiShellPermissionSnippet implements Snippet {
 
     private static final String TAG = "WifiManagerSnippet";
     private static final long POLLING_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(10);
+    private static final int CONNECT_TIMEOUT_IN_SEC = 90;
 
+    private final Context mContext;
     private final WifiManager mWifiManager;
     private final Handler mHandler;
     private final Object mLock = new Object();
-
     private WifiManagerSnippet.SnippetSoftApCallback mSoftApCallback;
     private WifiManager.LocalOnlyHotspotReservation mLocalOnlyHotspotReservation;
+    private BroadcastReceiver mWifiStateReceiver;
 
-    /** Callback to listen in and verify events to SoftAp. */
+    /**
+     * Callback to listen in and verify events to SoftAp.
+     */
     private static class SnippetSoftApCallback implements WifiManager.SoftApCallback {
         private final String mCallbackId;
 
@@ -103,7 +133,9 @@ public class WifiManagerSnippet implements Snippet {
         }
     }
 
-    /** Callback class to get the results of local hotspot start. */
+    /**
+     * Callback class to get the results of local hotspot start.
+     */
     private class SnippetLocalOnlyHotspotCallback extends WifiManager.LocalOnlyHotspotCallback {
         private final String mCallbackId;
 
@@ -121,18 +153,17 @@ public class WifiManagerSnippet implements Snippet {
             SnippetEvent event = new SnippetEvent(mCallbackId, "onStarted");
             event.getData().putString("ssid",
                     WifiJsonConverter.trimQuotationMarks(
-                            currentConfiguration.getWifiSsid().toString()));
-            event.getData()
-                    .putString(
-                            "passphrase",
-                            currentConfiguration.getPassphrase());
+                        currentConfiguration.getWifiSsid().toString()));
+            event.getData().putString(
+                    "passphrase",
+                    currentConfiguration.getPassphrase());
             EventCache.getInstance().postEvent(event);
         }
     }
 
     public WifiManagerSnippet() {
-        Context context = InstrumentationRegistry.getInstrumentation().getTargetContext();
-        mWifiManager = context.getSystemService(WifiManager.class);
+        mContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
+        mWifiManager = mContext.getSystemService(WifiManager.class);
         HandlerThread handlerThread = new HandlerThread(getClass().getSimpleName());
         handlerThread.start();
         mHandler = new Handler(handlerThread.getLooper());
@@ -178,7 +209,6 @@ public class WifiManagerSnippet implements Snippet {
         }
     }
 
-
     /**
      * Registers a callback for local-only hotspot.
      *
@@ -285,4 +315,350 @@ public class WifiManagerSnippet implements Snippet {
         }
         return true;
     }
+
+    /**
+     * Enable/Disable the Auto join global.
+     */
+    @Rpc(description = "Call to enable/disable auto join global")
+    public void wifiAllowAutojoinGlobal(boolean enable) {
+        ShellIdentityUtils.invokeWithShellPermissions(
+                () -> mWifiManager.allowAutojoinGlobal(enable));
+    }
+
+    /**
+     * Set SoftAp Configuration with SoftApConfiguration.
+     */
+    @Rpc(description = "Set SoftAp Configuration.")
+    public boolean wifiSetWifiApConfiguration(JSONObject configJson)
+            throws JSONException, Throwable {
+        SoftApConfiguration.Builder builder = new SoftApConfiguration.Builder();
+        return executeWithShellPermission(
+            () -> mWifiManager.setSoftApConfiguration(
+                WifiSapJsonDeserializer.jsonToSoftApConfiguration(configJson, builder)),
+                 "android.permission.NETWORK_SETTINGS");
+    }
+
+    @AsyncRpc(description = "Start track for WiFi supplicant state change.")
+    public void wifiStartTrackForStateChange(String callbackId) {
+        IntentFilter filter = new IntentFilter(mWifiManager.NETWORK_STATE_CHANGED_ACTION);
+        filter.addAction(mWifiManager.SUPPLICANT_STATE_CHANGED_ACTION);
+        filter.addAction(mWifiManager.SUPPLICANT_CONNECTION_CHANGE_ACTION);
+        filter.addAction(mWifiManager.WIFI_STATE_CHANGED_ACTION);
+
+        mWifiStateReceiver = new WifiSupplicantStateReceiver(callbackId);
+        mContext.registerReceiver(mWifiStateReceiver, filter);
+    }
+
+    @Rpc(description = "Stop track for WfFi supplicant state change.")
+    public void wifiStopTrackForStateChange() {
+
+        mContext.unregisterReceiver(mWifiStateReceiver);
+    }
+
+    /**
+     * Register a receiver for WiFi supplicant state change event.
+     */
+    public class WifiSupplicantStateReceiver extends BroadcastReceiver {
+        private final String mCallbackId;
+        private final EventCache mEventCache = EventCache.getInstance();
+
+        public WifiSupplicantStateReceiver(String mCallbackId) {
+            this.mCallbackId = mCallbackId;
+        }
+
+        @Override
+        public void onReceive(Context ctx, Intent intent) {
+            String action = intent.getAction();
+            if (action.equals(mWifiManager.NETWORK_STATE_CHANGED_ACTION)) {
+                Log.d(TAG, "debug> Wifi network state changed.");
+                NetworkInfo nInfo = intent.getParcelableExtra(mWifiManager.EXTRA_NETWORK_INFO);
+                Log.d(TAG, "debug> NetworkInfo " + nInfo);
+                // If network info is of type wifi, send wifi events.
+                if (nInfo.getType() == ConnectivityManager.TYPE_WIFI) {
+                    if (nInfo.getDetailedState().equals(DetailedState.DISCONNECTED)) {
+                        String eventName = "WifiNetworkDisconnected";
+                        SnippetEvent event = new SnippetEvent(mCallbackId, eventName);
+                        mEventCache.postEvent(event);
+                        Log.d(TAG, "debug> NetworkCallback State changed called for " + eventName);
+                    } else if (nInfo.getDetailedState().equals(DetailedState.CONNECTED)) {
+                        String eventName = "WifiNetworkConnected";
+                        WifiInfo currentConnectionInfo = getConnectionInfo();
+                        SnippetEvent event = new SnippetEvent(mCallbackId, eventName);
+                        event.getData().putString("SSID",
+                                WifiJsonConverter.trimQuotationMarks(
+                                    currentConnectionInfo.getSSID()));
+                        Log.d(TAG, "debug> connection info=" + currentConnectionInfo.getSSID());
+                        mEventCache.postEvent(event);
+                        Log.d(TAG, "debug> NetworkCallback State changed called for " + eventName);
+                        Log.d(TAG, "debug> network info=" + nInfo);
+                        Log.d(TAG, "debug> connection info=" + currentConnectionInfo);
+                    }
+                }
+            } else if (action.equals(mWifiManager.WIFI_STATE_CHANGED_ACTION)) {
+                SnippetEvent event = new SnippetEvent(mCallbackId, "WifiStateChanged");
+                int state = intent.getIntExtra(
+                        mWifiManager.EXTRA_WIFI_STATE, mWifiManager.WIFI_STATE_DISABLED);
+                Log.d(TAG, "Wifi state changed to " + state);
+                boolean enabled;
+                if (state == mWifiManager.WIFI_STATE_DISABLED) {
+                    enabled = false;
+                } else if (state == mWifiManager.WIFI_STATE_ENABLED) {
+                    enabled = true;
+                } else {
+                    // we only care about enabled/disabled.
+                    Log.v(TAG, "Ignoring intermediate wifi state change event...");
+                    return;
+                }
+                event.getData().putBoolean("enabled", enabled);
+                mEventCache.postEvent(event);
+            }
+        }
+    }
+
+    private WifiInfo getConnectionInfo() {
+        return executeWithShellPermission(mWifiManager::getConnectionInfo);
+    }
+
+    private static class WifiActionListener implements WifiManager.ActionListener {
+        private final CountDownLatch mLatch;
+        WifiActionListener(CountDownLatch latch) {
+            this.mLatch = latch;
+        }
+
+        @Override
+        public void onSuccess() {
+            Log.d(TAG, "debug> WifiActionListener onSuccess callback is triggered.");
+            mLatch.countDown();
+        }
+
+        @Override
+        public void onFailure(int reason) {
+            Log.d(TAG, "debug> WifiActionListener onFailure callback is triggered.");
+            throw new RuntimeException(
+                "WifiActionListener onFailure callback is triggered: " + reason, null);
+        }
+    }
+    private boolean latchWrapper(CountDownLatch latch, Runnable runnable, int timeoutSec) {
+        runnable.run();
+        try {
+            Log.d(TAG, "Latch wrapper waits till operation is done.");
+            return latch.await(timeoutSec, SECONDS);
+        } catch (InterruptedException e) {
+            Log.e(TAG, "Latch wrapper gets interrupted.", e);
+            return false;
+        }
+    }
+
+    /**
+     * Forget a wifi network by networkId.
+     */
+    @Rpc(description = "Forget a wifi network by networkId")
+    public void wifiForgetNetwork(Integer networkId) {
+        Log.d(TAG, "debug> networkdId: " + networkId);
+
+        CountDownLatch latch = new CountDownLatch(1);
+        WifiActionListener listener =  new WifiActionListener(latch);
+        executeWithShellPermission(
+                () -> latchWrapper(latch, () -> mWifiManager.forget(networkId, listener), 10));
+    }
+
+    @Rpc(description = "Checks Wifi state. True if Wifi is enabled.")
+    public Boolean wifiCheckState() {
+        return mWifiManager.getWifiState() == WifiManager.WIFI_STATE_ENABLED;
+    }
+
+    /**
+     * Adds a WiFi network.
+     *
+     * @param configJson {@link JSONObject} network config
+     */
+    @Rpc(description = "Add network Configuration.")
+    public Integer wifiAddNetwork(JSONObject configJson) throws JSONException, Throwable {
+        return wifiAddOrUpdateNetwork(configJson);
+    }
+
+    /**
+     * Adds or updates a WiFi network.
+     *
+     * @param configJson {@link JSONObject} network config
+     */
+    @Rpc(description = "Add or update a WiFi network.")
+    public Integer wifiAddOrUpdateNetwork(JSONObject configJson) throws JSONException, Throwable {
+        WifiConfiguration wifiNetworkConfig = JsonDeserializer.jsonToWifiConfig(configJson);
+        return executeWithShellPermission(
+            () -> mWifiManager.addNetwork(wifiNetworkConfig));
+    }
+
+    @Rpc(description = "Enable/disable auto join for a network.")
+    public void wifiEnableAutojoin(int netId, boolean enableAutojoin) {
+        // invoke signature-protected `allowAutojoin` API via reflection
+        executeWithShellPermission(() -> mWifiManager.allowAutojoin(netId, enableAutojoin));
+    }
+
+    @Rpc(description = "Resets all WifiManager settings.")
+    public void wifiFactoryReset() {
+        executeWithShellPermission(() -> mWifiManager.factoryReset());
+    }
+
+    /**
+     * Returns the WiFi connection standard.
+     *
+     * @return WiFi connection standard
+     */
+    @Rpc(description = "Get the WiFi connection standard, e.g. 802.11N, 802.11AC etc.")
+    public Integer wifiGetConnectionStandard() {
+        return executeWithShellPermission(
+            () -> mWifiManager.getConnectionInfo().getWifiStandard());
+    }
+
+    @Rpc(description = "Check if wifi scanner is supported on this device.")
+    public Boolean wifiIsScannerSupported() {
+        return executeWithShellPermission(() -> mWifiManager.isWifiScannerSupported());
+    }
+
+    @Rpc(description = "Enable a configured network."
+            + " Initiate a connection if disableOthers is true, True if the operation succeeded.")
+    public Boolean
+            wifiEnableNetwork(Integer netId, Boolean disableOthers) {
+        return executeWithShellPermission(() -> mWifiManager.enableNetwork(netId, disableOthers));
+    }
+
+    /**
+     * Stop WifisetScanThrottleEnabled.
+     */
+    @Rpc(description = "Stop WifisetScanThrottleEnabled.")
+    public void wifiSetScanThrottleDisable() {
+        ShellIdentityUtils.invokeWithShellPermissions(
+                () -> mWifiManager.setScanThrottleEnabled(false));
+    }
+
+    /**
+     * Scan listener passed to WiFiScanner APIs.
+     *
+     * <p>With different types of events triggered when executing WiFiScanner APIs, corresponding
+     * method will be invoked. The method and its caller leverage latch to achieve synchronized
+     * call.
+     */
+    private static class WifiScanListener implements WifiScanner.ScanListener {
+        private static final int STATE_NONE = 0;
+        private static final int STATE_CMD_SUCCESS = 1;
+        private static final int STATE_CMD_FAILURE = 2;
+        private static final int STATE_SCAN_SUCCESS = 3;
+
+        private int mState;
+        private CountDownLatch mLatch;
+        private long mStartTime;
+        private long mEndTime;
+        private List<ScanResult> mResult;
+
+        void reset(CountDownLatch latch) {
+            this.mState = STATE_NONE;
+            this.mLatch = latch;
+            this.mStartTime = SystemClock.elapsedRealtime();
+            this.mEndTime = 0;
+            this.mResult = new ArrayList<ScanResult>();
+        }
+
+        @Override
+        public void onSuccess() {
+            Log.d(TAG, "WifiScanListener onSuccess callback.");
+            this.mState = STATE_CMD_SUCCESS;
+            this.mLatch.countDown();
+        }
+
+        @Override
+        public void onFailure(int reason, String description) {
+            Log.d(TAG, "WifiScanListener onFailure callback.");
+            this.mState = STATE_CMD_FAILURE;
+            this.mLatch.countDown();
+        }
+
+        @Override
+        public void onPeriodChanged(int periodInMs) {
+            Log.d(TAG, "WifiScanListener onPeriodChanged callback.");
+        }
+
+        @Override
+        public void onResults(ScanData[] results) {
+            Log.d(TAG, "WifiScanListener onResults callback.");
+            this.mState = STATE_SCAN_SUCCESS;
+            this.mEndTime = SystemClock.elapsedRealtime();
+            for (ScanData scanData : results) {
+                this.mResult.addAll(Arrays.asList(scanData.getResults()));
+            }
+        }
+
+        @Override
+        public void onFullResult(ScanResult fullScanResult) {
+            Log.d(TAG, "WifiScanListener onFullResult callback.");
+        }
+    }
+    private static class WifiManagerSnippetException extends Exception {
+
+        WifiManagerSnippetException(String msg, Throwable err) {
+            super(msg, err);
+        }
+    }
+
+    /**
+     * Connects to the network with the given configuration.
+     *
+     * @param jsonConfig {@link JSONObject} of WiFi connection parameters.
+     * @throws Throwable
+     */
+    @Rpc(description = "Connect to the network with the given configuration.")
+    public void wifiConnecting(JSONObject jsonConfig) throws Throwable {
+        Log.d(TAG, "Got network config: " + jsonConfig);
+        WifiConfiguration wifiConfig = JsonDeserializer.jsonToWifiConfig(jsonConfig);
+        CountDownLatch latch = new CountDownLatch(1);
+        WifiInfo connectionInfo = getConnectionInfo();
+        if (connectionInfo.getNetworkId() != -1
+                && connectionInfo.getSSID().equals(wifiConfig.SSID)
+                && connectionInfo.getSupplicantState().equals(SupplicantState.COMPLETED)) {
+            if (wifiConfig.BSSID == null
+                    || wifiConfig
+                    .BSSID
+                    .toLowerCase(Locale.getDefault())
+                    .equals(connectionInfo.getBSSID().toLowerCase(Locale.getDefault()))) {
+                Log.d(TAG,
+                        "Network "
+                        + connectionInfo.getSSID()
+                        + " is already connected. ConnectionInfo: "
+                        + connectionInfo);
+                return;
+            }
+        }
+
+        WifiActionListener listener = new WifiActionListener(latch);
+
+        executeWithShellPermission(
+                () -> {
+                mWifiManager.connect(wifiConfig, listener);
+                try {
+                    if (!latch.await(10, SECONDS)) {
+                        throw new TimeoutException("WiFi connection timeouts.");
+                    }
+                } catch (Exception e) {
+                    throw new RuntimeException("WiFi connection fails.", e);
+                }
+            });
+
+        if (!Utils.waitUntil(
+                () -> {
+                    WifiInfo currentConnectionInfo = getConnectionInfo();
+                    return currentConnectionInfo.getNetworkId() != -1
+                        && currentConnectionInfo.getSSID().equals(wifiConfig.SSID)
+                        && currentConnectionInfo.getSupplicantState().equals(
+                            SupplicantState.COMPLETED);
+                },
+                CONNECT_TIMEOUT_IN_SEC)) {
+            throw new WifiManagerSnippetException(
+                "Failed to connect to '"
+                    + jsonConfig
+                    + "', timeout! Current connection: '"
+                    + getConnectionInfo().getSSID()
+                    + "'",
+                null);
+        }
+    }
 }
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiShellPermissionSnippet.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiShellPermissionSnippet.java
new file mode 100644
index 0000000000..c388b0699e
--- /dev/null
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/WifiShellPermissionSnippet.java
@@ -0,0 +1,98 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.snippet.wifi;
+
+import android.app.UiAutomation;
+import android.os.RemoteException;
+
+import androidx.test.platform.app.InstrumentationRegistry;
+
+import java.util.concurrent.Callable;
+
+/**
+ * Superclass to be extended by all WiFi Mobly snippets.
+ *
+ * <p>This class collects functionality commonly used in snippets.
+ */
+public class WifiShellPermissionSnippet {
+    public WifiShellPermissionSnippet() { }
+
+    /**
+     * Adopts the specified shell permissions.
+     *
+     * @param permissions The permissions to grant (if empty all permissions will be granted).
+     */
+    public void adoptShellPermission(String... permissions) throws RemoteException {
+        // Reuse an UiAutomation instance if there is an existing one; otherwise, get one.
+        UiAutomation uia = InstrumentationRegistry.getInstrumentation().getUiAutomation();
+        if (permissions.length == 0) {
+            uia.adoptShellPermissionIdentity();
+        } else {
+            uia.adoptShellPermissionIdentity(permissions);
+        }
+    }
+
+    public void dropShellPermission() {
+        UiAutomation uia = InstrumentationRegistry.getInstrumentation().getUiAutomation();
+        uia.dropShellPermissionIdentity();
+    }
+
+    /**
+     * Executes a method with a non-void return type with permission escalation.
+     *
+     * <p>Adopts the specified shell permissions, executes the {@link Callable} passed to it, then
+     * drops the permissions and returns the invocation result.
+     *
+     * <p>Sample usage: {@code boolean ret = executeWithShellPermission(
+     * () -> { return doSomething();});}
+     *
+     * @param callable the {@link Callable} to execute
+     * @param permissions the permissions to grant (if empty all permissions will be granted)
+     * @return the callable execution result
+     */
+    public <T> T executeWithShellPermission(Callable<T> callable, String... permissions) {
+        try {
+            adoptShellPermission(permissions);
+            return callable.call();
+        } catch (Exception e) {
+            throw new RuntimeException("executeWithShellPermission failed", e);
+        } finally {
+            dropShellPermission();
+        }
+    }
+    /**
+     * Executes a method with a void return type with permission escalation.
+     *
+     * <p>Adopts the specified shell permissions, executes the {@link Runnable} passed to it, then
+     * drops the permissions.
+     *
+     * <p>Sample usage: {@code executeWithShellPermission(() -> { doSomething(); });}
+     *
+     * @param runnable the {@link Runnable} to execute
+     * @param permissions the permissions to grant (if empty all permissions will be granted)
+     */
+    public void executeWithShellPermission(Runnable runnable, String... permissions) {
+        try {
+            adoptShellPermission(permissions);
+            runnable.run();
+        } catch (Exception e) {
+            throw new RuntimeException("executeWithShellPermission failed", e);
+        } finally {
+            dropShellPermission();
+        }
+    }
+}
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/aware/ConnectivityManagerSnippet.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/aware/ConnectivityManagerSnippet.java
index 37fa4110c5..78d4a5115c 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/aware/ConnectivityManagerSnippet.java
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/aware/ConnectivityManagerSnippet.java
@@ -17,9 +17,9 @@ package com.google.snippet.wifi.aware;
 
 import android.content.Context;
 import android.net.ConnectivityManager;
+import android.net.LinkProperties;
 import android.net.Network;
 import android.net.NetworkCapabilities;
-import android.net.LinkProperties;
 import android.net.NetworkRequest;
 import android.net.TransportInfo;
 import android.net.wifi.aware.WifiAwareChannelInfo;
@@ -40,23 +40,25 @@ import org.json.JSONException;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.OutputStream;
+import java.net.Inet4Address;
 import java.net.Inet6Address;
 import java.net.InetAddress;
 import java.net.NetworkInterface;
 import java.net.ServerSocket;
-import java.net.SocketException;
 import java.net.Socket;
+import java.net.SocketException;
 import java.nio.charset.StandardCharsets;
 import java.util.ArrayList;
+import java.util.Enumeration;
 import java.util.List;
 import java.util.concurrent.ConcurrentHashMap;
-import java.util.Enumeration;
+
 
 public class ConnectivityManagerSnippet implements Snippet {
     private static final String EVENT_KEY_CB_NAME = "callbackName";
     private static final String EVENT_KEY_NETWORK = "network";
     private static final String EVENT_KEY_NETWORK_CAP = "networkCapabilities";
-    private static final String EVENT_KEY_NETWORK_INTERFACE ="interfaceName";
+    private static final String EVENT_KEY_NETWORK_INTERFACE = "interfaceName";
     private static final String EVENT_KEY_TRANSPORT_INFO_CLASS = "transportInfoClassName";
     private static final String EVENT_KEY_TRANSPORT_INFO_CHANNEL_IN_MHZ = "channelInMhz";
     private static final int CLOSE_SOCKET_TIMEOUT = 15 * 1000;
@@ -68,9 +70,9 @@ public class ConnectivityManagerSnippet implements Snippet {
     private final ConnectivityManager mConnectivityManager;
 
     private final ConcurrentHashMap<String, ServerSocket> mServerSockets =
-            new ConcurrentHashMap<>();
+                  new ConcurrentHashMap<>();
     private final ConcurrentHashMap<String, NetworkCallback> mNetworkCallBacks =
-            new ConcurrentHashMap<>();
+                  new ConcurrentHashMap<>();
     private final ConcurrentHashMap<String, Socket> mSockets = new ConcurrentHashMap<>();
     private final ConcurrentHashMap<String, OutputStream> mOutputStreams =
             new ConcurrentHashMap<>();
@@ -92,18 +94,17 @@ public class ConnectivityManagerSnippet implements Snippet {
         mConnectivityManager = mContext.getSystemService(ConnectivityManager.class);
         if (mConnectivityManager == null) {
             throw new ConnectivityManagerSnippetException(
-                    "ConnectivityManager not " + "available.");
+                "ConnectivityManager not "
+                + "available.");
         }
     }
 
     public class NetworkCallback extends ConnectivityManager.NetworkCallback {
 
-
         String mCallBackId;
         Network mNetWork;
         NetworkCapabilities mNetworkCapabilities;
 
-
         NetworkCallback(String callBackId) {
             mCallBackId = callBackId;
         }
@@ -132,8 +133,7 @@ public class ConnectivityManagerSnippet implements Snippet {
             }
             if (networkCapabilities.getTransportInfo() instanceof WifiAwareNetworkInfo) {
                 WifiAwareNetworkInfo
-                        newWorkInfo =
-                        (WifiAwareNetworkInfo) networkCapabilities.getTransportInfo();
+                        newWorkInfo = (WifiAwareNetworkInfo) networkCapabilities.getTransportInfo();
                 List<WifiAwareChannelInfo> channelInfoList = newWorkInfo.getChannelInfoList();
                 ArrayList<Integer> channelFrequencies = new ArrayList<>();
                 if (!channelInfoList.isEmpty()) {
@@ -142,8 +142,7 @@ public class ConnectivityManagerSnippet implements Snippet {
                     }
                 }
                 event.getData().putIntegerArrayList(
-                    EVENT_KEY_TRANSPORT_INFO_CHANNEL_IN_MHZ, channelFrequencies
-                );
+                        EVENT_KEY_TRANSPORT_INFO_CHANNEL_IN_MHZ, channelFrequencies);
                 String ipv6 = newWorkInfo.getPeerIpv6Addr().toString();
                 if (ipv6.charAt(0) == '/') {
                     ipv6 = ipv6.substring(1);
@@ -155,7 +154,7 @@ public class ConnectivityManagerSnippet implements Snippet {
                 }
                 if (newWorkInfo.getTransportProtocol() != -1) {
                     event.getData().putInt("aware_transport_protocol",
-                    newWorkInfo.getTransportProtocol());
+                            newWorkInfo.getTransportProtocol());
                 }
             }
             EventCache.getInstance().postEvent(event);
@@ -163,13 +162,13 @@ public class ConnectivityManagerSnippet implements Snippet {
 
         @Override
         public void onLinkPropertiesChanged(Network network,
-               LinkProperties linkProperties) {
+                LinkProperties linkProperties) {
             Log.v("NetworkCallback onLinkPropertiesChanged");
             SnippetEvent event = new SnippetEvent(mCallBackId, "NetworkCallback");
             event.getData().putString(EVENT_KEY_CB_NAME, "onLinkPropertiesChanged");
             event.getData().putParcelable(EVENT_KEY_NETWORK, network);
             event.getData().putString(EVENT_KEY_NETWORK_INTERFACE,
-                   linkProperties.getInterfaceName());
+                    linkProperties.getInterfaceName());
             EventCache.getInstance().postEvent(event);
         }
 
@@ -224,6 +223,32 @@ public class ConnectivityManagerSnippet implements Snippet {
 
         return inet6Address.getHostAddress();
     }
+
+    /**
+     * Returns the IPv4 address of an interface.
+     *
+     * @param ifaceName the name of the interface
+     * @return the IPv4 address of the interface
+     */
+    // @Nullable
+    @Rpc(description = "Get the IPv4 address of an interface.")
+    public List<String> connectivityGetIPv4Addresses(String ifaceName) {
+        Enumeration<InetAddress> inetAddresses = getInetAddrsForInterface(ifaceName);
+        if (inetAddresses == null) {
+            return null;
+        }
+
+        List<String> inetAddrs = new ArrayList<>();
+        while (inetAddresses.hasMoreElements()) {
+            InetAddress addr = inetAddresses.nextElement();
+            if (addr instanceof Inet4Address) {
+                Inet4Address inet4Address = (Inet4Address) addr;
+                inetAddrs.add(inet4Address.getHostAddress());
+            }
+        }
+        return inetAddrs;
+    }
+
     /**
      * Requests a network with the specified network request and sets a callback for network
      * events.
@@ -286,7 +311,7 @@ public class ConnectivityManagerSnippet implements Snippet {
         serverSocket.setSoTimeout(ACCEPT_TIMEOUT);
         if (mSocketThreads.get(callbackId) != null) {
             throw new ConnectivityManagerSnippetException(
-                    "Server socket thread is already running.");
+                "Server socket thread is already running.");
         }
         Thread socketThread = new Thread(() -> {
             try {
@@ -337,7 +362,7 @@ public class ConnectivityManagerSnippet implements Snippet {
 
             try {
                 connectivityCloseServerSocket(sessionId);
-                thread.join(CLOSE_SOCKET_TIMEOUT);  // Wait for the thread to terminate
+                thread.join(CLOSE_SOCKET_TIMEOUT); // Wait for the thread to terminate
                 if (thread.isAlive()) {
                     throw new RuntimeException("Server socket thread did not terminate in time");
                 }
@@ -369,7 +394,7 @@ public class ConnectivityManagerSnippet implements Snippet {
         int bytesReadLength = inputStream.read(buffer, 0, len); // Read up to len bytes
         if (bytesReadLength == -1) { // End of stream reached unexpectedly
             throw new ConnectivityManagerSnippetException(
-                    "End of stream reached before reading expected bytes.");
+                "End of stream reached before reading expected bytes.");
         }
         // Convert the bytes read to a String
         String receiveStrMsg = new String(buffer, 0, bytesReadLength, StandardCharsets.UTF_8);
@@ -393,8 +418,6 @@ public class ConnectivityManagerSnippet implements Snippet {
         outputStream.write(bytes, 0, bytes.length);
         outputStream.flush();
         return true;
-
-
     }
 
     /**
@@ -409,7 +432,6 @@ public class ConnectivityManagerSnippet implements Snippet {
             socket.close();
         }
         mSockets.remove(sessionId);
-
     }
 
     /**
@@ -439,8 +461,6 @@ public class ConnectivityManagerSnippet implements Snippet {
             outputStream.close();
         }
         mOutputStreams.remove(sessionId);
-
-
     }
 
     /**
@@ -462,8 +482,8 @@ public class ConnectivityManagerSnippet implements Snippet {
         OutputStream outputStream = mOutputStreams.get(sessionId);
         if (outputStream == null) {
             throw new ConnectivityManagerSnippetException("Output stream is not created.Please "
-                    + "call connectivityCreateSocketOverWiFiAware() or "
-                    + "connectivityServerSocketAccept() first.");
+                + "call connectivityCreateSocketOverWiFiAware() or "
+                + "connectivityServerSocketAccept() first.");
         }
     }
 
@@ -471,8 +491,8 @@ public class ConnectivityManagerSnippet implements Snippet {
         InputStream inputStream = mInputStreams.get(sessionId);
         if (inputStream == null) {
             throw new ConnectivityManagerSnippetException("Input stream is not created.Please "
-                    + "call connectivityCreateSocketOverWiFiAware() or "
-                    + "connectivityServerSocketAccept() first.");
+                + "call connectivityCreateSocketOverWiFiAware() or "
+                + "connectivityServerSocketAccept() first.");
         }
     }
 
@@ -494,8 +514,10 @@ public class ConnectivityManagerSnippet implements Snippet {
         Socket socket = mSockets.get(sessionId);
         if (socket != null) {
             throw new ConnectivityManagerSnippetException("Socket is already created"
-                    + ".Please call connectivityCloseSocket(String sessionId) or "
-                    + "connectivityStopAcceptThread" + "(String sessionId) " + "to release first.");
+                + ".Please call connectivityCloseSocket(String sessionId) or "
+                + "connectivityStopAcceptThread"
+                + "(String sessionId) "
+                + "to release first.");
         }
 
         checkNetworkCapabilities(networkCapabilities);
@@ -516,11 +538,10 @@ public class ConnectivityManagerSnippet implements Snippet {
             int transportProtocol = peerAwareInfo.getTransportProtocol();
             if (transportProtocol != TRANSPORT_PROTOCOL_TCP) {
                 throw new ConnectivityManagerSnippetException(
-                        "Only support TCP transport protocol.");
+                    "Only support TCP transport protocol.");
             }
         }
 
-
         Socket createSocket = netWork.getSocketFactory().createSocket(peerIpv6Addr, peerPort);
         createSocket.setSoTimeout(SOCKET_SO_TIMEOUT);
         mSockets.put(sessionId, createSocket);
@@ -528,14 +549,12 @@ public class ConnectivityManagerSnippet implements Snippet {
         mOutputStreams.put(sessionId, createSocket.getOutputStream());
     }
 
-
     private NetworkCallback getNetWorkCallbackBySessionId(String sessionId)
             throws ConnectivityManagerSnippetException {
         NetworkCallback callback = mNetworkCallBacks.get(sessionId);
         if (callback == null) {
             throw new ConnectivityManagerSnippetException("Network callback is not created.Please "
-                    + "call connectivityRequestNetwork() first.");
-
+                + "call connectivityRequestNetwork() first.");
         }
         return callback;
     }
@@ -571,7 +590,7 @@ public class ConnectivityManagerSnippet implements Snippet {
     private void checkServerSocket(String sessionId) throws ConnectivityManagerSnippetException {
         if (mServerSockets.get(sessionId) == null) {
             throw new ConnectivityManagerSnippetException("Server socket is not created"
-                    + ".Please call connectivityInitServerSocket() first.");
+                + ".Please call connectivityInitServerSocket() first.");
         }
     }
 
@@ -657,4 +676,9 @@ public class ConnectivityManagerSnippet implements Snippet {
         }
         mInputStreams.clear();
     }
+
+    @Rpc(description = "Check if tethering supported or not.True if tethering is supported.")
+    public boolean connectivityIsTetheringSupported() {
+        return mConnectivityManager.isTetheringSupported();
+    }
 }
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/direct/WifiP2pManagerSnippet.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/direct/WifiP2pManagerSnippet.java
index 3bf57c246a..c8a3b8239a 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/direct/WifiP2pManagerSnippet.java
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/direct/WifiP2pManagerSnippet.java
@@ -135,6 +135,7 @@ public class WifiP2pManagerSnippet implements Snippet {
         mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION);
         mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION);
         mIntentFilter.addAction(WifiP2pManager.WIFI_P2P_THIS_DEVICE_CHANGED_ACTION);
+        mIntentFilter.setPriority(999);
 
         mServiceRequests = new HashMap<Integer, WifiP2pServiceRequest>();
     }
@@ -332,16 +333,18 @@ public class WifiP2pManagerSnippet implements Snippet {
      */
     @Rpc(description = "Accept p2p connection invitation through clicking on UI.")
     public void wifiP2pAcceptInvitation(String deviceName) throws WifiP2pManagerException {
-        if (!mUiDevice.wait(Until.hasObject(By.text("Invitation to connect")),
+        Pattern titlePattern = Pattern.compile("(Invitation to connect|Device connection)");
+        if (!mUiDevice.wait(Until.hasObject(By.text(titlePattern)),
                 UI_ACTION_LONG_TIMEOUT_MS)) {
             throw new WifiP2pManagerException(
                     "Expected connect invitation did not occur within timeout.");
         }
-        if (!mUiDevice.wait(Until.hasObject(By.text(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
+        if (!mUiDevice.wait(
+                Until.hasObject(By.textContains(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
             throw new WifiP2pManagerException(
                     "The connect invitation is not triggered by expected peer device.");
         }
-        Pattern pattern = Pattern.compile("(ACCEPT|OK|Accept)");
+        Pattern pattern = Pattern.compile("(ACCEPT|OK|Accept|Connect)");
         if (!mUiDevice.wait(Until.hasObject(By.text(pattern).clazz(Button.class)),
                 UI_ACTION_SHORT_TIMEOUT_MS)) {
             throw new WifiP2pManagerException("Accept button did not occur within timeout.");
@@ -364,30 +367,16 @@ public class WifiP2pManagerSnippet implements Snippet {
      */
     @Rpc(description = "Get p2p connect PIN code after calling wifiP2pConnect with WPS PIN.")
     public String wifiP2pGetPinCode(String deviceName) throws Throwable {
-        // Wait for the 'Invitation sent' dialog to appear
-        if (!mUiDevice.wait(Until.hasObject(By.text("Invitation sent")),
-                UI_ACTION_LONG_TIMEOUT_MS)) {
-            throw new WifiP2pManagerException(
-                    "Invitation sent dialog did not appear within timeout.");
-        }
-        if (!mUiDevice.wait(Until.hasObject(By.text(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
+        // Wait for the PIN code dialog to get PIN coce
+        String pinCode = waitForPinCode();
+        Log.d("Retrieved PIN code: " + pinCode);
+        // Check device name
+        if (!mUiDevice.wait(
+                Until.hasObject(By.textContains(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
             throw new WifiP2pManagerException(
                     "The connect invitation is not triggered by expected peer device.");
         }
-        // Find the UI lement with text='PIN:'
-        UiObject2 pinLabel = mUiDevice.findObject(By.text("PIN:"));
-        if (pinLabel == null) {
-            throw new WifiP2pManagerException("PIN label not found.");
-        }
-        // Get the sibling UI element that contains the PIN code. Use regex pattern "\d+" as PIN
-        // code must be composed entirely of numbers.
-        Pattern pattern = Pattern.compile("\\d+");
-        UiObject2 pinValue = pinLabel.getParent().findObject(By.text(pattern));
-        if (pinValue == null) {
-            throw new WifiP2pManagerException("Failed to find Pin code UI element.");
-        }
-        String pinCode = pinValue.getText();
-        Log.d("Retrieved PIN code: " + pinCode);
+
         // Click 'OK' to close the PIN code alert
         UiObject2 okButton = mUiDevice.findObject(By.text("OK").clazz(Button.class));
         if (okButton == null) {
@@ -399,6 +388,38 @@ public class WifiP2pManagerSnippet implements Snippet {
         return pinCode;
     }
 
+    private String waitForPinCode() throws WifiP2pManagerException {
+        // First try finding PIN code by resource ID.
+        Pattern resPattern = Pattern.compile(".*:id/wifi_p2p_dialog2_display_pin");
+        if (mUiDevice.wait(Until.hasObject(By.res(resPattern)), UI_ACTION_LONG_TIMEOUT_MS)) {
+            UiObject2 pinLabel = mUiDevice.findObject(By.res(resPattern));
+            Log.d("pinLabel = " + pinLabel);
+            return pinLabel.getText();
+        }
+
+        // If not found, try finding PIN code by text match.
+        Pattern titlePattern = Pattern.compile(
+                "(Invitation sent|Invitation to connect|Device connection)");
+        if (mUiDevice.wait(Until.hasObject(By.text(titlePattern)), UI_ACTION_SHORT_TIMEOUT_MS)) {
+            // Find the UI lement with text='PIN:'
+            UiObject2 pinLabel = mUiDevice.findObject(By.text("PIN:"));
+            if (pinLabel == null) {
+                throw new WifiP2pManagerException("PIN label not found.");
+            }
+            Log.d("pinLabel = " + pinLabel);
+            // Get the sibling UI element that contains the PIN code. Use regex pattern "\d+" as PIN
+            // code must be composed entirely of numbers.
+            Pattern pattern = Pattern.compile("\\d+");
+            UiObject2 pinValue = pinLabel.getParent().findObject(By.text(pattern));
+            if (pinValue == null) {
+                throw new WifiP2pManagerException("Failed to find Pin code UI element.");
+            }
+            return pinValue.getText();
+        }
+        throw new WifiP2pManagerException(
+                "The dialog to get PIN code did not appear within timeout.");
+    }
+
     /**
      * Get p2p connect PIN code after calling {@link #wifiP2pConnect(JSONObject,Integer)} with
      * WPS PIN.
@@ -409,33 +430,18 @@ public class WifiP2pManagerSnippet implements Snippet {
      */
     @Rpc(description = "Get p2p connect PIN code after calling wifiP2pConnect with WPS PIN.")
     public String wifiP2pGetKeypadPinCode(String deviceName) throws Throwable {
-        // Wait for the 'Invitation sent' dialog to appear
-        if (!mUiDevice.wait(Until.hasObject(By.text("Invitation to connect")),
-                UI_ACTION_LONG_TIMEOUT_MS)) {
-            throw new WifiP2pManagerException(
-                    "Invitation sent dialog did not appear within timeout.");
-        }
-        if (!mUiDevice.wait(Until.hasObject(By.text(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
+        // Wait for the 'Invitation sent' dialog to appear and get PIN coce
+        String pinCode = waitForPinCode();
+        Log.d("Retrieved PIN code: " + pinCode);
+        // Check device name.
+        if (!mUiDevice.wait(
+                Until.hasObject(By.textContains(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
             throw new WifiP2pManagerException(
                     "The connect invitation is not triggered by expected peer device.");
         }
-        // Find the UI lement with text='PIN:'
-        UiObject2 pinLabel = mUiDevice.findObject(By.text("PIN:"));
-        if (pinLabel == null) {
-            throw new WifiP2pManagerException("PIN label not found.");
-        }
-        Log.d("pinLabel = " + pinLabel);
-        // Get the sibling UI element that contains the PIN code. Use regex pattern "\d+" as PIN
-        // code must be composed entirely of numbers.
-        Pattern pattern = Pattern.compile("\\d+");
-        UiObject2 pinValue = pinLabel.getParent().findObject(By.text(pattern));
-        if (pinValue == null) {
-            throw new WifiP2pManagerException("Failed to find Pin code UI element.");
-        }
-        String pinCode = pinValue.getText();
-        Log.d("Retrieved PIN code: " + pinCode);
         // Click 'OK' to close the PIN code alert
-        UiObject2 okButton = mUiDevice.findObject(By.text("Accept").clazz(Button.class));
+        Pattern pattern = Pattern.compile("(Accept|Connect)");
+        UiObject2 okButton = mUiDevice.findObject(By.text(pattern).clazz(Button.class));
         if (okButton == null) {
             throw new WifiP2pManagerException(
                     "OK button not found in the p2p connection invitation pop-up window.");
@@ -454,26 +460,16 @@ public class WifiP2pManagerSnippet implements Snippet {
      */
     @Rpc(description = "Enter the PIN code to accept a P2P connection invitation.")
     public void wifiP2pEnterPin(String pinCode, String deviceName) throws WifiP2pManagerException {
-        // Wait for the 'Invitation to connect' dialog to appear
-        if (!mUiDevice.wait(Until.hasObject(By.textContains("Invitation to connect")),
-                UI_ACTION_LONG_TIMEOUT_MS)) {
+        waitAndEnterPinCode(pinCode);
+        // Check device name
+        if (!mUiDevice.wait(
+                Until.hasObject(By.textContains(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
             throw new WifiP2pManagerException(
-                    "Invitation to connect dialog did not appear within timeout.");
-        }
-        if (!mUiDevice.wait(Until.hasObject(By.text(deviceName)), UI_ACTION_SHORT_TIMEOUT_MS)) {
-            throw new WifiP2pManagerException(
-                    "The connect invitation is not triggered by expected peer device.");
-        }
-        // Find the PIN entry field
-        UiObject2 pinEntryField = mUiDevice.findObject(By.focused(true));
-        if (pinEntryField == null) {
-            throw new WifiP2pManagerException("PIN entry field not found.");
+                "The connect invitation is not triggered by expected peer device.");
         }
-        // Enter the PIN code
-        pinEntryField.setText(pinCode);
-        Log.d("Entered PIN code: " + pinCode);
         // Accept the invitation
-        Pattern acceptPattern = Pattern.compile("(ACCEPT|OK|Accept)", Pattern.CASE_INSENSITIVE);
+        Pattern acceptPattern = Pattern.compile(
+                "(ACCEPT|OK|Accept|Connect)", Pattern.CASE_INSENSITIVE);
         UiObject2 acceptButton = mUiDevice.findObject(By.clazz(Button.class).text(acceptPattern));
         if (acceptButton == null) {
             throw new WifiP2pManagerException(
@@ -483,6 +479,35 @@ public class WifiP2pManagerSnippet implements Snippet {
         Log.d("Accepted the connection.");
     }
 
+    private void waitAndEnterPinCode(String pinCode) throws WifiP2pManagerException {
+        // First try finding input box by resource ID.
+        // "wifi_p2p_wps_pin" is a legacy resource ID.
+        // "wifi_p2p_dialog2_enter_pin" is the latest resource ID.
+        Pattern resPattern = Pattern.compile(".*:id/(wifi_p2p_dialog2_enter_pin|wifi_p2p_wps_pin)");
+        if (mUiDevice.wait(Until.hasObject(By.res(resPattern)), UI_ACTION_LONG_TIMEOUT_MS)) {
+            UiObject2 pinEntryField = mUiDevice.findObject(By.res(resPattern));
+            pinEntryField.setText(pinCode);
+            Log.d("Entered PIN code: " + pinCode);
+            return;
+        }
+
+        // If not found, try finding input box by text match.
+        Pattern titlePattern = Pattern.compile("(Invitation to connect|Device connection)");
+        if (mUiDevice.wait(Until.hasObject(By.text(titlePattern)), UI_ACTION_SHORT_TIMEOUT_MS)) {
+            // Find the PIN entry field
+            UiObject2 pinEntryField = mUiDevice.findObject(By.focused(true));
+            if (pinEntryField == null) {
+                throw new WifiP2pManagerException("PIN entry field not found.");
+            }
+            // Enter the PIN code
+            pinEntryField.setText(pinCode);
+            Log.d("Entered PIN code: " + pinCode);
+            return;
+        }
+        throw new WifiP2pManagerException(
+                "The dialog to enter PIN code did not appear within timeout.");
+    }
+
     /**
      * Remove the current p2p group.
      *
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/TetheringManagerSnippet.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/TetheringManagerSnippet.java
index ce1bc5f61e..dbbd0f3124 100644
--- a/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/TetheringManagerSnippet.java
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/TetheringManagerSnippet.java
@@ -16,11 +16,18 @@
 
 package com.google.snippet.wifi.softap;
 
+import static java.util.concurrent.TimeUnit.SECONDS;
+
+import android.content.BroadcastReceiver;
 import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
 import android.net.TetheringManager;
 import android.net.TetheringManager.TetheringRequest;
+import android.net.wifi.WifiManager;
 import android.os.Handler;
 import android.os.HandlerThread;
+import android.os.RemoteException;
 import android.util.Log;
 
 import androidx.test.platform.app.InstrumentationRegistry;
@@ -30,18 +37,30 @@ import com.google.android.mobly.snippet.event.EventCache;
 import com.google.android.mobly.snippet.event.SnippetEvent;
 import com.google.android.mobly.snippet.rpc.AsyncRpc;
 import com.google.android.mobly.snippet.rpc.Rpc;
+import com.google.snippet.wifi.WifiShellPermissionSnippet;
 
-/** Snippet class for TetheringManager. */
-public class TetheringManagerSnippet implements Snippet {
-    private static final String TAG = "TetheringManagerSnippet";
+import java.util.ArrayList;
+import java.util.concurrent.CountDownLatch;
+import java.util.concurrent.Executor;
+import java.util.concurrent.Executors;
 
+/**
+ * Snippet class for TetheringManager.
+ */
+public class TetheringManagerSnippet extends WifiShellPermissionSnippet implements Snippet {
+    private static final String TAG = "TetheringManagerSnippet";
+    private final Context mContext;
+    private final EventCache mEventCache = EventCache.getInstance();
     private final TetheringManager mTetheringManager;
     private final Handler mHandler;
+    private TetherStateChangedReceiver mTetherChangedReceiver;
 
 
-    /** Callback class to get the results of tethering start. */
-    private static class SnippetStartTetheringCallback implements
-            TetheringManager.StartTetheringCallback {
+    /**
+     * Callback class to get the results of tethering start.
+     */
+    private static class SnippetStartTetheringCallback
+            implements TetheringManager.StartTetheringCallback {
         private final String mCallbackId;
 
         SnippetStartTetheringCallback(String callbackId) {
@@ -65,8 +84,8 @@ public class TetheringManagerSnippet implements Snippet {
     }
 
     public TetheringManagerSnippet() {
-        Context context = InstrumentationRegistry.getInstrumentation().getTargetContext();
-        mTetheringManager = context.getSystemService(TetheringManager.class);
+        mContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
+        mTetheringManager = mContext.getSystemService(TetheringManager.class);
         HandlerThread handlerThread = new HandlerThread(getClass().getSimpleName());
         handlerThread.start();
         mHandler = new Handler(handlerThread.getLooper());
@@ -90,7 +109,114 @@ public class TetheringManagerSnippet implements Snippet {
      * Stop tethering.
      */
     @Rpc(description = "Call to stop tethering.")
-    public void tetheringStopTethering() {
+    public void tetheringStopTethering() throws RemoteException {
+
+        adoptShellPermission();
         mTetheringManager.stopTethering(TetheringManager.TETHERING_WIFI);
     }
+
+    /*
+     * Start wifi tethering.
+     */
+    @Rpc(description = "Call to start tethering with a provisioning check if needed")
+    public void tetheringStartTetheringWithProvisioning(Integer type, Boolean showProvisioningUi)
+            throws RemoteException {
+        Log.d(TAG, "startTethering for type: " + type + " showProvUi: " + showProvisioningUi);
+        final CountDownLatch latch = new CountDownLatch(1);
+        TetherStartCallback tetherCallback = new TetherStartCallback(latch);
+        Executor executor = Executors.newSingleThreadScheduledExecutor();
+
+        TetheringRequest request =
+                new TetheringRequest.Builder(type).setShouldShowEntitlementUi(
+                        showProvisioningUi).build();
+        try {
+            adoptShellPermission();
+            mTetheringManager.startTethering(request, executor, tetherCallback);
+            latch.await(10, SECONDS);
+        } catch (InterruptedException | RemoteException e) {
+            Log.e(TAG, "tetheringStartTetheringWithProvisioning fails: " + e);
+        } finally {
+            dropShellPermission();
+        }
+    }
+
+    /**
+     * Callback class to get the results of tethering start.
+     */
+    private static class TetherStartCallback implements TetheringManager.StartTetheringCallback {
+        private final CountDownLatch mLatch;
+
+        TetherStartCallback(CountDownLatch latch) {
+            this.mLatch = latch;
+        }
+
+        @Override
+        public void onTetheringStarted() {
+            Log.d(TAG, "TetherStartCallback onTetheringStarted callback is triggered.");
+            mLatch.countDown();
+        }
+
+        @Override
+        public void onTetheringFailed(final int error) {
+            Log.d(
+                    TAG,
+                    "TetherStartCallback onTetheringFailed callback is triggered: error " + error);
+        }
+    }
+
+    static class TetherStateChangedReceiver extends BroadcastReceiver {
+        private final String mCallbackId;
+
+        TetherStateChangedReceiver(String callbackId) {
+            this.mCallbackId = callbackId;
+        }
+        @Override
+        public void onReceive(Context c, Intent intent) {
+            Log.v(TAG, "TetherStateChangedReceiver onReceive");
+            String action = intent.getAction();
+            if (WifiManager.WIFI_AP_STATE_CHANGED_ACTION.equals(action)) {
+                SnippetEvent event = new SnippetEvent(mCallbackId, "TetherStateChangedReceiver");
+                event.getData().putString("callbackName", "WifiManagerApStateChanged");
+                Log.d(TAG, "Wifi AP state changed.");
+                int state = intent.getIntExtra(WifiManager.EXTRA_WIFI_AP_STATE,
+                        WifiManager.WIFI_AP_STATE_FAILED);
+                if (state == WifiManager.WIFI_AP_STATE_ENABLED) {
+                    event.getData().putString("status", "WifiManagerApEnabled");
+                } else if (state == WifiManager.WIFI_AP_STATE_DISABLED) {
+                    event.getData().putString("status", "WifiManagerApDisabled");
+                }
+                EventCache.getInstance().postEvent(event);
+            } else if (TetheringManager.ACTION_TETHER_STATE_CHANGED.equals(action)) {
+                Log.d(TAG, "Tether state changed.");
+                ArrayList<String> available = intent.getStringArrayListExtra(
+                        TetheringManager.EXTRA_AVAILABLE_TETHER);
+                ArrayList<String> active = intent.getStringArrayListExtra(
+                        TetheringManager.EXTRA_ACTIVE_TETHER);
+                ArrayList<String> errored = intent.getStringArrayListExtra(
+                        TetheringManager.EXTRA_ERRORED_TETHER);
+                SnippetEvent event = new SnippetEvent(mCallbackId, "TetherStateChangedReceiver");
+                event.getData().putString("callbackName", "TetherStateChanged");
+                event.getData().putStringArrayList("AVAILABLE_TETHER", available);
+                event.getData().putStringArrayList("ACTIVE_TETHER", active);
+                event.getData().putStringArrayList("ERRORED_TETHER", errored);
+                EventCache.getInstance().postEvent(event);
+            }
+        }
+    }
+
+    @AsyncRpc(description = "Start listening for tether state change related broadcasts.")
+    public void tetheringStartTrackingTetherStateChange(String callbackId) {
+        mTetherChangedReceiver = new TetherStateChangedReceiver(callbackId);
+        IntentFilter mTetherFilter = new IntentFilter(WifiManager.WIFI_AP_STATE_CHANGED_ACTION);
+        mTetherFilter.addAction(TetheringManager.ACTION_TETHER_STATE_CHANGED);
+        mContext.registerReceiver(mTetherChangedReceiver, mTetherFilter);
+    }
+
+    @Rpc(description = "Stop listening for wifi state change related broadcasts.")
+    public void tetheringStopTrackingTetherStateChange() {
+        if (mTetherChangedReceiver != null) {
+            mContext.unregisterReceiver(mTetherChangedReceiver);
+            mTetherChangedReceiver = null;
+        }
+    }
 }
diff --git a/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/WifiSapJsonDeserializer.java b/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/WifiSapJsonDeserializer.java
new file mode 100644
index 0000000000..35314a1dcc
--- /dev/null
+++ b/tests/hostsidetests/multidevices/com.google.snippet.wifi/softap/WifiSapJsonDeserializer.java
@@ -0,0 +1,158 @@
+/*
+ * Copyright (C) 2024 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.google.snippet.wifi.softap;
+
+import android.net.MacAddress;
+import android.net.wifi.SoftApConfiguration;
+import android.text.TextUtils;
+
+import com.android.modules.utils.build.SdkLevel;
+
+import org.json.JSONArray;
+import org.json.JSONException;
+import org.json.JSONObject;
+
+import java.util.ArrayList;
+import java.util.List;
+
+
+/**
+ * Deserializes JSONObject into data objects defined in Wi-Fi Aware API.
+ */
+public class WifiSapJsonDeserializer {
+
+    private WifiSapJsonDeserializer() {}
+
+    private static int[] convertJSONArrayToIntArray(JSONArray jArray) throws JSONException {
+        if (jArray == null) {
+            return null;
+        }
+        int[] iArray = new int[jArray.length()];
+        for (int i = 0; i < jArray.length(); i++) {
+            iArray[i] = jArray.getInt(i);
+        }
+        return iArray;
+    }
+    /**
+     * Converts JSON object to {@link SoftApConfiguration}.
+     *
+     * @param configJson corresponding to SoftApConfiguration in
+     * @param configBuilder    builder to build the SoftApConfiguration
+     * @return SoftApConfiguration object
+     */
+    public static SoftApConfiguration jsonToSoftApConfiguration(
+            JSONObject configJson, SoftApConfiguration.Builder configBuilder) throws JSONException {
+        if (configJson == null) {
+            return configBuilder.build();
+        }
+        if (configJson.has("SSID")) {
+            configBuilder.setSsid(configJson.getString("SSID"));
+        }
+        if (configJson.has("password")) {
+            String pwd = configJson.getString("password");
+            // Check if new security type SAE (WPA3) is present. Default to PSK
+            if (configJson.has("security")) {
+                String securityType = configJson.getString("security");
+                if (TextUtils.equals(securityType, "WPA2_PSK")) {
+                    configBuilder.setPassphrase(pwd, SoftApConfiguration.SECURITY_TYPE_WPA2_PSK);
+                } else if (TextUtils.equals(securityType, "WPA3_SAE_TRANSITION")) {
+                    configBuilder.setPassphrase(pwd,
+                            SoftApConfiguration.SECURITY_TYPE_WPA3_SAE_TRANSITION);
+                } else if (TextUtils.equals(securityType, "WPA3_SAE")) {
+                    configBuilder.setPassphrase(pwd, SoftApConfiguration.SECURITY_TYPE_WPA3_SAE);
+                }
+            } else {
+                configBuilder.setPassphrase(pwd, SoftApConfiguration.SECURITY_TYPE_WPA2_PSK);
+            }
+        }
+        if (configJson.has("BSSID")) {
+            configBuilder.setBssid(MacAddress.fromString(configJson.getString("BSSID")));
+        }
+        if (configJson.has("hiddenSSID")) {
+            configBuilder.setHiddenSsid(configJson.getBoolean("hiddenSSID"));
+        }
+        if (configJson.has("apBand")) {
+            configBuilder.setBand(configJson.getInt("apBand"));
+        }
+        if (configJson.has("apChannel") && configJson.has("apBand")) {
+            configBuilder.setChannel(configJson.getInt("apChannel"), configJson.getInt("apBand"));
+        }
+
+        if (configJson.has("MaxNumberOfClients")) {
+            configBuilder.setMaxNumberOfClients(configJson.getInt("MaxNumberOfClients"));
+        }
+
+        if (configJson.has("ShutdownTimeoutMillis")) {
+            configBuilder.setShutdownTimeoutMillis(configJson.getLong("ShutdownTimeoutMillis"));
+        }
+
+        if (configJson.has("AutoShutdownEnabled")) {
+            configBuilder.setAutoShutdownEnabled(configJson.getBoolean("AutoShutdownEnabled"));
+        }
+
+        if (configJson.has("ClientControlByUserEnabled")) {
+            configBuilder.setClientControlByUserEnabled(
+                    configJson.getBoolean("ClientControlByUserEnabled"));
+        }
+
+        List allowedClientList = new ArrayList<>();
+        if (configJson.has("AllowedClientList")) {
+            JSONArray allowedList = configJson.getJSONArray("AllowedClientList");
+            for (int i = 0; i < allowedList.length(); i++) {
+                allowedClientList.add(MacAddress.fromString(allowedList.getString(i)));
+            }
+        }
+
+        List blockedClientList = new ArrayList<>();
+        if (configJson.has("BlockedClientList")) {
+            JSONArray blockedList = configJson.getJSONArray("BlockedClientList");
+            for (int j = 0; j < blockedList.length(); j++) {
+                blockedClientList.add(MacAddress.fromString(blockedList.getString(j)));
+            }
+        }
+
+        configBuilder.setAllowedClientList(allowedClientList);
+        configBuilder.setBlockedClientList(blockedClientList);
+
+        if (SdkLevel.isAtLeastS()) {
+            if (configJson.has("apBands")) {
+                JSONArray jBands = configJson.getJSONArray("apBands");
+                int[] bands = convertJSONArrayToIntArray(jBands);
+                configBuilder.setBands(bands);
+            }
+            if (configJson.has("MacRandomizationSetting")) {
+                configBuilder.setMacRandomizationSetting(
+                        configJson.getInt("MacRandomizationSetting"));
+            }
+
+            if (configJson.has("BridgedModeOpportunisticShutdownEnabled")) {
+                configBuilder.setBridgedModeOpportunisticShutdownEnabled(
+                        configJson.getBoolean("BridgedModeOpportunisticShutdownEnabled"));
+            }
+
+            if (configJson.has("Ieee80211axEnabled")) {
+                configBuilder.setIeee80211axEnabled(configJson.getBoolean("Ieee80211axEnabled"));
+            }
+
+            if (configJson.has("mClientIsolationEnabled")) {
+                configBuilder.setClientIsolationEnabled(
+                        configJson.getBoolean("mClientIsolationEnabled"));
+            }
+        }
+        return configBuilder.build();
+    }
+}
diff --git a/tests/hostsidetests/multidevices/test/Android.bp b/tests/hostsidetests/multidevices/test/Android.bp
index 3d3ef73ee5..41f9bf7022 100644
--- a/tests/hostsidetests/multidevices/test/Android.bp
+++ b/tests/hostsidetests/multidevices/test/Android.bp
@@ -170,3 +170,53 @@ python_test_host {
         "cts-v-host",
     ],
 }
+
+python_library_host {
+    name: "wifi_sap_lib_utils",
+    srcs: ["softap/integration/wifi_sap_lib_utils.py"],
+
+}
+
+python_test_host {
+    name: "WifiSapTest",
+    main: "softap/integration/wifi_sap_test.py",
+    srcs: ["softap/integration/wifi_sap_test.py"],
+    libs: [
+        "mobly",
+        "wifi_test_utils",
+        "wifi_softap_constants",
+        "wifi_sap_lib_utils",
+        "aware_lib_utils",
+        "platform-test-py-annotations",
+    ],
+    device_common_data: [":wifi_mobly_snippet"],
+    test_options: {
+        unit_test: false,
+        runner: "mobly",
+    },
+    test_suites: [
+        "general-tests",
+    ],
+}
+
+python_test_host {
+    name: "WifiSoftApThreeDevicesTest",
+    main: "softap/integration/wifi_sap_three_devices_test.py",
+    srcs: ["softap/integration/wifi_sap_three_devices_test.py"],
+    libs: [
+        "mobly",
+        "wifi_test_utils",
+        "wifi_softap_constants",
+        "wifi_sap_lib_utils",
+        "aware_lib_utils",
+        "platform-test-py-annotations",
+    ],
+    device_common_data: [":wifi_mobly_snippet"],
+    test_options: {
+        unit_test: false,
+        runner: "mobly",
+    },
+    test_suites: [
+        "general-tests",
+    ],
+}
diff --git a/tests/hostsidetests/multidevices/test/direct/group_owner_negotiation_test.py b/tests/hostsidetests/multidevices/test/direct/group_owner_negotiation_test.py
index d2dabd3367..a4c8484d8b 100644
--- a/tests/hostsidetests/multidevices/test/direct/group_owner_negotiation_test.py
+++ b/tests/hostsidetests/multidevices/test/direct/group_owner_negotiation_test.py
@@ -51,12 +51,9 @@ class GroupOwnerNegotiationTest(base_test.BaseTestClass):
 
     def _setup_device(self, ad: android_device.AndroidDevice) -> None:
         ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
-        wifi_test_utils.set_screen_on_and_unlock(ad)
         wifi_test_utils.enable_wifi_verbose_logging(ad)
-        # Clear all saved Wi-Fi networks.
-        ad.wifi.wifiDisable()
-        ad.wifi.wifiClearConfiguredNetworks()
-        ad.wifi.wifiEnable()
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        wifi_test_utils.restart_wifi_and_disable_connection_scan(ad)
 
     @ApiTest([
         'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pConfig, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
@@ -160,9 +157,15 @@ class GroupOwnerNegotiationTest(base_test.BaseTestClass):
             raise_on_exception=True,
         )
 
+    def teardown_class(self):
+        utils.concurrent_exec(
+            wifi_test_utils.restore_wifi_auto_join,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+
     def on_fail(self, record: records.TestResult) -> None:
-        logging.info('Collecting bugreports...')
-        android_device.take_bug_reports(
+        wifi_test_utils.take_bug_reports(
             self.ads, destination=self.current_test_info.output_path
         )
 
diff --git a/tests/hostsidetests/multidevices/test/direct/group_owner_test.py b/tests/hostsidetests/multidevices/test/direct/group_owner_test.py
index f8221f1aae..9324258a72 100644
--- a/tests/hostsidetests/multidevices/test/direct/group_owner_test.py
+++ b/tests/hostsidetests/multidevices/test/direct/group_owner_test.py
@@ -19,7 +19,6 @@ from collections.abc import Sequence
 import dataclasses
 import datetime
 import logging
-import time
 
 from android.platform.test.annotations import ApiTest
 from mobly import asserts
@@ -57,12 +56,9 @@ class GroupOwnerTest(base_test.BaseTestClass):
 
     def _setup_device(self, ad: android_device.AndroidDevice) -> None:
         ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
-        wifi_test_utils.set_screen_on_and_unlock(ad)
         wifi_test_utils.enable_wifi_verbose_logging(ad)
-        # Clear all saved Wi-Fi networks.
-        ad.wifi.wifiDisable()
-        ad.wifi.wifiClearConfiguredNetworks()
-        ad.wifi.wifiEnable()
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        wifi_test_utils.restart_wifi_and_disable_connection_scan(ad)
 
     @ApiTest([
         'android.net.wifi.p2p.WifiP2pManager#createGroup(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pConfig, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
@@ -85,11 +81,6 @@ class GroupOwnerTest(base_test.BaseTestClass):
           7. Remove the p2p group on the requester. Verify both devices show
              connection stopped status.
         """
-        # This is a temporary workaround to avoid p2p service discovery
-        # conflicts previous wifi scan or p2p operations. Without sleeping,
-        # p2p service discovery process has a high failure rate.
-        time.sleep(10)
-
         # Step 1. Initialize Wi-Fi p2p on both group owner and client.
         logging.info('Initializing Wi-Fi p2p.')
         group_owner = p2p_utils.setup_wifi_p2p(self.group_owner_ad)
@@ -149,10 +140,6 @@ class GroupOwnerTest(base_test.BaseTestClass):
         7. Remove the p2p group on the requester. Verify both devices show
            connection stopped status.
         """
-        # This is a temporary workaround to avoid p2p service discovery
-        # conflicts previous wifi scan or p2p operations. Without sleeping,
-        # p2p service discovery process has a high failure rate.
-        time.sleep(10)
 
         # Step 1. Initialize Wi-Fi p2p on both group owner and client.
         logging.info('Initializing Wi-Fi p2p.')
@@ -256,9 +243,15 @@ class GroupOwnerTest(base_test.BaseTestClass):
             raise_on_exception=True,
         )
 
+    def teardown_class(self):
+        utils.concurrent_exec(
+            wifi_test_utils.restore_wifi_auto_join,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+
     def on_fail(self, record: records.TestResult) -> None:
-        logging.info('Collecting bugreports...')
-        android_device.take_bug_reports(
+        wifi_test_utils.take_bug_reports(
             self.ads, destination=self.current_test_info.output_path
         )
 
diff --git a/tests/hostsidetests/multidevices/test/direct/group_owner_with_config_test.py b/tests/hostsidetests/multidevices/test/direct/group_owner_with_config_test.py
index 664216fb5e..83f6182d89 100644
--- a/tests/hostsidetests/multidevices/test/direct/group_owner_with_config_test.py
+++ b/tests/hostsidetests/multidevices/test/direct/group_owner_with_config_test.py
@@ -79,12 +79,9 @@ class GroupOwnerWithConfigTest(base_test.BaseTestClass):
 
     def _setup_device(self, ad: android_device.AndroidDevice) -> None:
         ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
-        wifi_test_utils.set_screen_on_and_unlock(ad)
         wifi_test_utils.enable_wifi_verbose_logging(ad)
-        # Clear all saved Wi-Fi networks.
-        ad.wifi.wifiDisable()
-        ad.wifi.wifiClearConfiguredNetworks()
-        ad.wifi.wifiEnable()
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        wifi_test_utils.restart_wifi_and_disable_connection_scan(ad)
 
     @ApiTest([
         'android.net.wifi.p2p.WifiP2pManager#createGroup(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pConfig, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
@@ -201,9 +198,15 @@ class GroupOwnerWithConfigTest(base_test.BaseTestClass):
             raise_on_exception=True,
         )
 
+    def teardown_class(self):
+        utils.concurrent_exec(
+            wifi_test_utils.restore_wifi_auto_join,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+
     def on_fail(self, record: records.TestResult) -> None:
-        logging.info('Collecting bugreports...')
-        android_device.take_bug_reports(
+        wifi_test_utils.take_bug_reports(
             self.ads, destination=self.current_test_info.output_path
         )
 
diff --git a/tests/hostsidetests/multidevices/test/direct/integration/Android.bp b/tests/hostsidetests/multidevices/test/direct/integration/Android.bp
index 6ee454d34a..a987d83ead 100644
--- a/tests/hostsidetests/multidevices/test/direct/integration/Android.bp
+++ b/tests/hostsidetests/multidevices/test/direct/integration/Android.bp
@@ -22,6 +22,33 @@ python_library_host {
     srcs: ["wifi_p2p_lib.py"],
 }
 
+python_test_host {
+    name: "WifiP2pCountryTestCases",
+    main: "wifi_p2p_country_test.py",
+    srcs: [
+        "wifi_p2p_country_test.py",
+    ],
+    libs: [
+        "mobly",
+        "wifi_direct_constants",
+        "wifi_direct_test_utils",
+        "wifi_p2p_lib",
+        "wifi_test_utils",
+        "platform-test-py-annotations",
+    ],
+    device_common_data: [":wifi_mobly_snippet"],
+    test_options: {
+        unit_test: false,
+        tags: ["mobly"],
+    },
+    test_suites: ["general-tests"],
+    version: {
+        py3: {
+            embedded_launcher: true,
+        },
+    },
+}
+
 python_test_host {
     name: "WifiP2pGroupTestCases",
     main: "wifi_p2p_group_test.py",
@@ -44,6 +71,33 @@ python_test_host {
     test_suites: ["general-tests"],
 }
 
+python_test_host {
+    name: "WifiP2pLocalServiceTestCases",
+    main: "wifi_p2p_local_service_test.py",
+    srcs: [
+        "wifi_p2p_local_service_test.py",
+    ],
+    libs: [
+        "mobly",
+        "wifi_direct_constants",
+        "wifi_direct_test_utils",
+        "wifi_p2p_lib",
+        "wifi_test_utils",
+        "platform-test-py-annotations",
+    ],
+    device_common_data: [":wifi_mobly_snippet"],
+    test_options: {
+        unit_test: false,
+        tags: ["mobly"],
+    },
+    test_suites: ["general-tests"],
+    version: {
+        py3: {
+            embedded_launcher: true,
+        },
+    },
+}
+
 python_test_host {
     name: "WifiP2pManagerTestCases",
     main: "wifi_p2p_manager_test.py",
diff --git a/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_country_test.py b/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_country_test.py
new file mode 100644
index 0000000000..4d5d7930bb
--- /dev/null
+++ b/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_country_test.py
@@ -0,0 +1,271 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+# Lint as: python3
+
+from collections.abc import Sequence
+import logging
+import time
+
+from android.platform.test.annotations import ApiTest
+from mobly import asserts
+from mobly import base_test
+from mobly import records
+from mobly import test_runner
+from mobly import utils
+from mobly.controllers import android_device
+import wifi_test_utils
+import wifi_p2p_lib as wp2putils
+
+
+from direct import constants
+from direct import p2p_utils
+
+
+_DEFAULT_FUNCTION_SWITCH_TIME = 10
+
+class WifiP2pCountryTestCases(base_test.BaseTestClass):
+    """P2p negotiation with country test."""
+
+    ads: Sequence[android_device.AndroidDevice]
+    group_owner_ad: android_device.AndroidDevice
+    client_ad: android_device.AndroidDevice
+
+    def setup_class(self) -> None:
+        self.ads = self.register_controller(android_device, min_number=2)
+        utils.concurrent_exec(
+            self._setup_device,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+        self.group_owner_ad, self.client_ad, *_ = self.ads
+        self.group_owner_ad.debug_tag = (
+            f'{self.group_owner_ad.serial}(Group Owner)'
+        )
+        self.client_ad.debug_tag = f'{self.client_ad.serial}(Client)'
+
+    def _setup_device(self, ad: android_device.AndroidDevice) -> None:
+        ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        # Clear all saved Wi-Fi networks.
+        ad.wifi.wifiDisable()
+        ad.wifi.wifiClearConfiguredNetworks()
+        ad.wifi.wifiEnable()
+
+    def set_wifi_country_code(
+        self,
+        ad: android_device.AndroidDevice,
+        country_code: str):
+        """Sets the wifi country code on the device.
+
+        Args:
+            ad: An AndroidDevice object.
+            country_code: 2 letter ISO country code
+
+        Raises:
+            An RpcException if unable to set the country code.
+        """
+        try:
+            ad.adb.shell('cmd wifi force-country-code enabled %s' % country_code)
+        except android_device.adb.AdbError as e:
+            ad.log.error(f"Failed to set country code: {e}")
+            ad.droid.wifiSetCountryCode(constants.CountryCode.US)
+
+    def p2p_connect_ping_and_reconnect_country(self, psk, country):
+        """Verify the p2p connect via pbc/display functionality.
+
+        Steps:
+        1. Request the connection which include discover the target device
+        2. check which dut is GO and which dut is GC
+        3. connection check via ping from GC to GO
+        4. disconnect
+        5. Trigger connect again from GO for reconnect test.
+        6. GO trigger disconnect
+        7. Trigger connect again from GC for reconnect test.
+        8. GC trigger disconnect
+
+        Args:
+            psk: Connect via pbc/display
+            country: CountryCode String.
+
+        """
+        go_dut = self.ads[0]
+        gc_dut = self.ads[1]
+
+        self.set_wifi_country_code(go_dut , country)
+        self.set_wifi_country_code(gc_dut , country)
+        group_owner = p2p_utils.setup_wifi_p2p(go_dut)
+        client = p2p_utils.setup_wifi_p2p(gc_dut)
+        requester_peer_p2p_device = p2p_utils.discover_p2p_peer(
+            group_owner, client
+            )
+        wp2putils.p2p_connect(group_owner, client, False, psk)
+        if wp2putils.is_go(self.ads[0]) :
+            client_dut = self.ads[1]
+        else:
+            client_dut = self.ads[0]
+        logging.info('Client is : %s', client_dut.serial)
+        go_ip = wp2putils.p2p_go_ip(client_dut)
+        wp2putils.p2p_connection_ping_test(client_dut, go_ip)
+        p2p_utils.remove_group_and_verify_disconnected(
+            group_owner, client, is_group_negotiation=False
+            )
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.p2p_connect(client, group_owner, True,  psk)
+        p2p_utils.remove_group_and_verify_disconnected(
+            group_owner, client, is_group_negotiation=False
+            )
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.p2p_connect(group_owner, client, True, psk)
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_US(self) -> None:
+
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'US')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_JP(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'JP')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_DE(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'DE')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_AU(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'AU')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_TW(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'TW')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_pbc_and_ping_and_reconnect_GB(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.PBC, 'GB')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_display_and_ping_and_reconnect_US(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'US')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_display_and_ping_and_reconnect_JP(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'JP')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_display_and_ping_and_reconnect_DE(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'DE')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_display_and_ping_and_reconnect_AU(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'AU')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+
+    def test_p2p_connect_via_display_and_ping_and_reconnect_TW(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'TW')
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#requestConnectionInfo(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener listener)',
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.WifiP2pConfig config, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+    def test_p2p_connect_via_display_and_ping_and_reconnect_GB(self) -> None:
+        self.p2p_connect_ping_and_reconnect_country(constants.WpsInfo.DISPLAY, 'GB')
+
+
+    def _teardown_device(self, ad: android_device.AndroidDevice):
+        p2p_utils.teardown_wifi_p2p(ad)
+
+    def teardown_test(self) -> None:
+        utils.concurrent_exec(
+            self._teardown_device,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+
+    def on_fail(self, record: records.TestResult) -> None:
+        logging.info('Collecting bugreports...')
+        android_device.take_bug_reports(
+            self.ads, destination=self.current_test_info.output_path
+        )
+
+
+if __name__ == '__main__':
+    test_runner.main()
diff --git a/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_local_service_test.py b/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_local_service_test.py
new file mode 100644
index 0000000000..3b7e213990
--- /dev/null
+++ b/tests/hostsidetests/multidevices/test/direct/integration/wifi_p2p_local_service_test.py
@@ -0,0 +1,204 @@
+#  Copyright (C) 2025 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+# Lint as: python3
+"""ACTS Wifi P2p Local Service Test reimplemented in Mobly."""
+
+from collections.abc import Sequence
+import datetime
+import logging
+import time
+
+from android.platform.test.annotations import ApiTest
+from direct import constants
+from direct import p2p_utils
+from mobly import base_test
+from mobly import records
+from mobly import test_runner
+from mobly import utils
+from mobly.controllers import android_device
+import wifi_p2p_lib as wp2putils
+import wifi_test_utils
+
+
+_DEFAULT_TIMEOUT = datetime.timedelta(seconds=30)
+DEFAULT_SLEEPTIME = 5
+_DEFAULT_FUNCTION_SWITCH_TIME = 10
+_DEFAULT_GROUP_CLIENT_LOST_TIME = 60
+
+_WIFI_DIRECT_SNIPPET_KEY = 'wifi_direct_mobly_snippet'
+
+P2P_CONNECT_NEGOTIATION = 0
+P2P_CONNECT_JOIN = 1
+P2P_CONNECT_INVITATION = 2
+
+WPS_PBC = wp2putils.WifiP2PEnums.WpsInfo.WIFI_WPS_INFO_PBC
+WPS_DISPLAY = wp2putils.WifiP2PEnums.WpsInfo.WIFI_WPS_INFO_DISPLAY
+WPS_KEYPAD = wp2putils.WifiP2PEnums.WpsInfo.WIFI_WPS_INFO_KEYPAD
+
+
+class WifiP2pLocalServiceTest(base_test.BaseTestClass):
+    """Tests Wi-Fi Direct between 2 Android devices."""
+
+    ads: Sequence[android_device.AndroidDevice]
+    group_owner_ad: android_device.AndroidDevice
+    client_ad: android_device.AndroidDevice
+    network_name = 'DIRECT-xy-Hello'
+    passphrase = 'P2pWorld1234'
+    group_band = '2'
+
+    def setup_class(self) -> None:
+        super().setup_class()
+        self.ads = self.register_controller(android_device, min_number=2)
+        utils.concurrent_exec(
+            self._setup_device,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+        self.group_owner_ad, self.client_ad, *_ = self.ads
+        self.group_owner_ad.debug_tag = (
+            f'{self.group_owner_ad.serial}(Group Owner)'
+        )
+        self.client_ad.debug_tag = f'{self.client_ad.serial}(Client)'
+
+    def _setup_device(self, ad: android_device.AndroidDevice) -> None:
+        ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        # Clear all saved Wi-Fi networks.
+        ad.wifi.wifiDisable()
+        ad.wifi.wifiClearConfiguredNetworks()
+        ad.wifi.wifiEnable()
+
+    def _teardown_wifi_p2p(self, ad: android_device.AndroidDevice):
+        try:
+            p2p_utils.teardown_wifi_p2p(ad)
+        finally:
+            ad.services.create_output_excerpts_all(self.current_test_info)
+
+    def teardown_test(self) -> None:
+        utils.concurrent_exec(
+            self._teardown_wifi_p2p,
+            param_list=[[ad] for ad in (self.group_owner_ad, self.client_ad)],
+            raise_on_exception=True,
+        )
+
+    def on_fail(self, record: records.TestResult) -> None:
+        logging.info('Collecting bugreports...')
+        android_device.take_bug_reports(
+            self.ads, destination=self.current_test_info.output_path
+        )
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pConfig, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
+            'android.net.wifi.p2p.WifiP2pManager#discoverPeers(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
+            'android.net.wifi.p2p.nsd.WifiP2pUpnpServiceRequestnew#Instance()',
+            'android.net.wifi.p2p.nsd.WifiP2pUpnpServiceRequest#newInstance(String search_target)',
+            'android.net.wifi.p2p.WifiP2pManager#addServiceRequest(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.nsd.WifiP2pServiceRequest req, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+    def test_p2p_upnp_service(self):
+        """Verify the p2p discovery functionality.
+
+        Steps:
+        1. dut1 add local Upnp service
+        2. dut2 register Upnp Service listener
+        3. Check dut2 peer list if it only included dut1
+        4. Setup p2p upnp local service request with different query string
+        5. Check p2p upnp local servier query result is expect or not
+        6. Test different query string and check query result
+        Note: Step 2 - Step 5 should reference function
+              request_service_and_check_result
+        """
+        logging.info('Add local Upnp Service')
+        # Initialize Wi-Fi p2p on both group owner and client.
+        group_owner = p2p_utils.setup_wifi_p2p(self.group_owner_ad)
+        client = p2p_utils.setup_wifi_p2p(self.client_ad)
+        wp2putils.create_p2p_local_service(self.group_owner_ad,
+                                           wp2putils.P2P_LOCAL_SERVICE_UPNP)
+        wp2putils.request_service_and_check_result(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_UPNP, None, None)
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.request_service_and_check_result(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_UPNP, 'ssdp:all', None)
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.request_service_and_check_result(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_UPNP, 'upnp:rootdevice', None)
+
+    @ApiTest(
+        apis=[
+            'android.net.wifi.p2p.WifiP2pManager#connect(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pConfig, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
+            'android.net.wifi.p2p.WifiP2pManager#discoverPeers(android.net.wifi.p2p.WifiP2pManager.Channel, android.net.wifi.p2p.WifiP2pManager.ActionListener)',
+            'android.net.wifi.p2p.nsd.WifiP2pDnsSdServiceRequest#newInstance()',
+            'android.net.wifi.p2p.nsd.WifiP2pDnsSdServiceRequest#newInstance(String serviceType)',
+            'android.net.wifi.p2p.nsd.WifiP2pDnsSdServiceRequest#newInstance(String instanceName, String serviceType)',
+            'android.net.wifi.p2p.WifiP2pManager#addServiceRequest(android.net.wifi.p2p.WifiP2pManager.Channel channel, android.net.wifi.p2p.nsd.WifiP2pServiceRequest req, android.net.wifi.p2p.WifiP2pManager.ActionListener listener)',
+        ]
+    )
+    def test_p2p_bonjour_service(self):
+        """Verify the p2p discovery functionality.
+
+        Steps:
+        1. dut1 add local bonjour service - IPP and AFP
+        2. dut2 register bonjour Service listener - dnssd and dnssd_txrecord
+        3. Check dut2 peer list if it only included dut1
+        4. Setup p2p bonjour local service request with different query string
+        5. Check p2p bonjour local servier query result is expect or not
+        6. Test different query string and check query result
+        Note: Step 2 - Step 5 should reference function
+              request_service_and_check_result_with_retry
+        """
+        logging.info(
+            'Add local bonjour service to %s', self.group_owner_ad.serial
+        )
+        group_owner = p2p_utils.setup_wifi_p2p(self.group_owner_ad)
+        client = p2p_utils.setup_wifi_p2p(self.client_ad)
+        wp2putils.create_p2p_local_service(self.group_owner_ad,
+                                           wp2putils.P2P_LOCAL_SERVICE_IPP)
+        wp2putils.create_p2p_local_service(self.group_owner_ad,
+                                           wp2putils.P2P_LOCAL_SERVICE_AFP)
+
+        wp2putils.request_service_and_check_result_with_retry(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_BONJOUR, None, None)
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.request_service_and_check_result_with_retry(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_BONJOUR, '_ipp._tcp', None)
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.request_service_and_check_result_with_retry(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_BONJOUR, '_ipp._tcp', 'MyPrinter')
+        time.sleep(_DEFAULT_FUNCTION_SWITCH_TIME)
+        wp2putils.request_service_and_check_result_with_retry(
+            group_owner, client, wp2putils.WifiP2PEnums.WifiP2pServiceInfo.
+            WIFI_P2P_SERVICE_TYPE_BONJOUR, '_afpovertcp._tcp', 'Example')
+
+if __name__ == '__main__':
+  test_runner.main()
diff --git a/tests/hostsidetests/multidevices/test/direct/p2p_utils.py b/tests/hostsidetests/multidevices/test/direct/p2p_utils.py
index 72495cf0be..7802e8f4e5 100644
--- a/tests/hostsidetests/multidevices/test/direct/p2p_utils.py
+++ b/tests/hostsidetests/multidevices/test/direct/p2p_utils.py
@@ -28,8 +28,6 @@ from direct import constants
 
 _DEFAULT_TIMEOUT = datetime.timedelta(seconds=45)
 _GROUP_OWNER_DISCOVERY_TIMEOUT = datetime.timedelta(seconds=60)
-_DEFAULT_UI_RESPONSE_TIME = datetime.timedelta(seconds=2)
-
 
 @dataclasses.dataclass
 class DeviceState:
@@ -334,27 +332,22 @@ def p2p_connect(
     requester.ad.log.info('Sent P2P connect invitation to responder.')
     # Connect with WPS config requires user inetraction through UI.
     if config.wps_setup == constants.WpsInfo.PBC:
-        time.sleep(_DEFAULT_UI_RESPONSE_TIME.total_seconds())
         responder.ad.wifi.wifiP2pAcceptInvitation(
             requester.p2p_device.device_name
         )
         responder.ad.log.info('Accepted connect invitation.')
     elif config.wps_setup == constants.WpsInfo.DISPLAY:
-        time.sleep(_DEFAULT_UI_RESPONSE_TIME.total_seconds())
         pin = requester.ad.wifi.wifiP2pGetPinCode(
             responder.p2p_device.device_name
         )
         requester.ad.log.info('p2p connection PIN code: %s', pin)
-        time.sleep(_DEFAULT_UI_RESPONSE_TIME.total_seconds())
         responder.ad.wifi.wifiP2pEnterPin(pin, requester.p2p_device.device_name)
         responder.ad.log.info('Enetered PIN code.')
     elif config.wps_setup == constants.WpsInfo.KEYPAD:
-        time.sleep(_DEFAULT_UI_RESPONSE_TIME.total_seconds())
         pin = responder.ad.wifi.wifiP2pGetKeypadPinCode(
             requester.p2p_device.device_name
         )
         responder.ad.log.info('p2p connection Keypad PIN code: %s', pin)
-        time.sleep(_DEFAULT_UI_RESPONSE_TIME.total_seconds())
         requester.ad.wifi.wifiP2pEnterPin(pin, responder.p2p_device.device_name)
         requester.ad.log.info('Enetered Keypad PIN code.')
     elif config.wps_setup is not None:
diff --git a/tests/hostsidetests/multidevices/test/direct/service_discovery_test.py b/tests/hostsidetests/multidevices/test/direct/service_discovery_test.py
index 4f0bbe1f25..1f5aaae93d 100644
--- a/tests/hostsidetests/multidevices/test/direct/service_discovery_test.py
+++ b/tests/hostsidetests/multidevices/test/direct/service_discovery_test.py
@@ -69,12 +69,9 @@ class ServiceDiscoveryTest(base_test.BaseTestClass):
 
     def _setup_device(self, ad: android_device.AndroidDevice) -> None:
         ad.load_snippet('wifi', constants.WIFI_SNIPPET_PACKAGE_NAME)
-        wifi_test_utils.set_screen_on_and_unlock(ad)
         wifi_test_utils.enable_wifi_verbose_logging(ad)
-        # Clear all saved Wi-Fi networks.
-        ad.wifi.wifiDisable()
-        ad.wifi.wifiClearConfiguredNetworks()
-        ad.wifi.wifiEnable()
+        wifi_test_utils.set_screen_on_and_unlock(ad)
+        wifi_test_utils.restart_wifi_and_disable_connection_scan(ad)
 
     def test_search_all_services_01(self) -> None:
         """Searches all p2p services with API
@@ -621,9 +618,15 @@ class ServiceDiscoveryTest(base_test.BaseTestClass):
             raise_on_exception=False,
         )
 
+    def teardown_class(self):
+        utils.concurrent_exec(
+            wifi_test_utils.restore_wifi_auto_join,
+            param_list=[[ad] for ad in self.ads],
+            raise_on_exception=True,
+        )
+
     def on_fail(self, record: records.TestResult) -> None:
-        logging.info('Collecting bugreports...')
-        android_device.take_bug_reports(
+        wifi_test_utils.take_bug_reports(
             self.ads, destination=self.current_test_info.output_path
         )
 
diff --git a/tests/hostsidetests/multidevices/test/softap/AndroidTest.xml b/tests/hostsidetests/multidevices/test/softap/AndroidTest.xml
index 26ddcdd877..0641231caf 100644
--- a/tests/hostsidetests/multidevices/test/softap/AndroidTest.xml
+++ b/tests/hostsidetests/multidevices/test/softap/AndroidTest.xml
@@ -34,4 +34,4 @@
 
     <option name="mobly_pkg" key="file" value="CtsWifiSoftApTestCases" />
     <option name="build_apk" key="file" value="wifi_mobly_snippet.apk" />
-</configuration>
\ No newline at end of file
+</configuration>
diff --git a/tests/hostsidetests/multidevices/test/softap/constants.py b/tests/hostsidetests/multidevices/test/softap/constants.py
index 535b30c109..7e3b2ddf51 100644
--- a/tests/hostsidetests/multidevices/test/softap/constants.py
+++ b/tests/hostsidetests/multidevices/test/softap/constants.py
@@ -24,6 +24,8 @@ CALLBACK_TIMEOUT = datetime.timedelta(seconds=10)
 # Wi-Fi scan result interval
 WIFI_SCAN_INTERVAL_SEC = datetime.timedelta(seconds=5)
 
+# WiFi standards
+WIFI_STANDARD_11AX = 6
 
 @enum.unique
 class LocalOnlyHotspotCallbackEventName(enum.StrEnum):
@@ -85,3 +87,105 @@ class SoftApOnClientsDisconnectedDataKey(enum.StrEnum):
 
   DISCONNECTED_CLIENTS_COUNT = 'disconnectedClientsCount'
   CLIENT_MAC_ADDRESS = 'clientMacAddress'
+
+
+class WifiEnums():
+    # All Wifi channels to frequencies lookup.
+    freq_to_channel = {
+        2412: 1,
+        2417: 2,
+        2422: 3,
+        2427: 4,
+        2432: 5,
+        2437: 6,
+        2442: 7,
+        2447: 8,
+        2452: 9,
+        2457: 10,
+        2462: 11,
+        2467: 12,
+        2472: 13,
+        2484: 14,
+        4915: 183,
+        4920: 184,
+        4925: 185,
+        4935: 187,
+        4940: 188,
+        4945: 189,
+        4960: 192,
+        4980: 196,
+        5035: 7,
+        5040: 8,
+        5045: 9,
+        5055: 11,
+        5060: 12,
+        5080: 16,
+        5170: 34,
+        5180: 36,
+        5190: 38,
+        5200: 40,
+        5210: 42,
+        5220: 44,
+        5230: 46,
+        5240: 48,
+        5260: 52,
+        5280: 56,
+        5300: 60,
+        5320: 64,
+        5500: 100,
+        5520: 104,
+        5540: 108,
+        5560: 112,
+        5580: 116,
+        5600: 120,
+        5620: 124,
+        5640: 128,
+        5660: 132,
+        5680: 136,
+        5700: 140,
+        5745: 149,
+        5765: 153,
+        5785: 157,
+        5795: 159,
+        5805: 161,
+        5825: 165,
+        }
+
+@enum.unique
+class WiFiTethering(enum.StrEnum):
+    SSID_KEY = "SSID"  # Used for Wifi & SoftAp
+    SSID_PATTERN_KEY = "ssidPattern"
+    NETID_KEY = "network_id"
+    BSSID_KEY = "BSSID"  # Used for Wifi & SoftAp
+    BSSID_PATTERN_KEY = "bssidPattern"
+    PWD_KEY = "password"  # Used for Wifi & SoftAp
+    frequency_key = "frequency"
+    HIDDEN_KEY = "hiddenSSID"  # Used for Wifi & SoftAp
+    IS_APP_INTERACTION_REQUIRED = "isAppInteractionRequired"
+    IS_USER_INTERACTION_REQUIRED = "isUserInteractionRequired"
+    IS_SUGGESTION_METERED = "isMetered"
+    PRIORITY = "priority"
+    SECURITY = "security"  # Used for Wifi & SoftAp
+
+    # Used for SoftAp
+    AP_BAND_KEY = "apBand"
+    AP_CHANNEL_KEY = "apChannel"
+    AP_BANDS_KEY = "apBands"
+    AP_CLIENT_ISOLATION_ENABLE = "mClientIsolationEnabled"
+
+@enum.unique
+class WiFiHotspotBand(enum.IntEnum):
+    """WiFi hotspot band code."""
+    WIFI_CONFIG_SOFTAP_BAND_2G = 1
+    WIFI_CONFIG_SOFTAP_BAND_5G = 2
+    WIFI_CONFIG_SOFTAP_BAND_2G_5G = 3
+    WIFI_CONFIG_SOFTAP_BAND_6G = 4
+    WIFI_CONFIG_SOFTAP_BAND_2G_6G = 5
+    WIFI_CONFIG_SOFTAP_BAND_5G_6G = 6
+    WIFI_CONFIG_SOFTAP_BAND_ANY = 7
+
+class SoftApSecurityType():
+  OPEN = "NONE"
+  WPA2 = "WPA2_PSK"
+  WPA3_SAE_TRANSITION = "WPA3_SAE_TRANSITION"
+  WPA3_SAE = "WPA3_SAE"
\ No newline at end of file
diff --git a/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_lib_utils.py b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_lib_utils.py
new file mode 100644
index 0000000000..33408bdca6
--- /dev/null
+++ b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_lib_utils.py
@@ -0,0 +1,442 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+# Lint as: python3
+
+import time
+import logging
+import enum
+
+from mobly.controllers import android_device
+from mobly.controllers.android_device_lib import callback_handler_v2
+from mobly import asserts
+from mobly.snippet import errors
+from mobly import utils
+from softap import constants
+from queue import Empty
+from mobly.controllers.android_device_lib import adb
+
+
+_CALLBACK_NAME = "callbackName"
+_CALLBACK_TIMEOUT = constants.CALLBACK_TIMEOUT.total_seconds()
+_WIFI_SCAN_INTERVAL_SEC = constants.WIFI_SCAN_INTERVAL_SEC.total_seconds()
+
+def match_networks(target_params, networks):
+    """Finds the WiFi networks that match a given set of parameters in a list
+    of WiFi networks.
+
+    To be considered a match, the network should contain every key-value pair
+    of target_params
+
+    Args:
+        target_params:
+        A dict with 1 or more key-value pairs representing a Wi-Fi network.
+        E.g. { 'SSID': 'wh_ap1_5g', 'BSSID': '30:b5:c2:33:e4:47' }
+        networks: A list of dict objects representing WiFi networks.
+
+    Returns:
+        The networks that match the target parameters.
+    """
+    results = []
+    asserts.assert_true(target_params,
+                        "Expected networks object 'target_params' is empty")
+    for n in networks:
+        add_network = 1
+        for k, v in target_params.items():
+            if k not in n:
+                add_network = 0
+                break
+            if n[k] != v:
+                add_network = 0
+                break
+        if add_network:
+            results.append(n)
+    return results
+
+def start_wifi_connection_scan_and_check_for_network(
+    ad: android_device.AndroidDevice,
+    network_ssid: str,
+    max_tries: int=3):
+    """
+    Start connectivity scans & checks if the |network_ssid| is seen in
+    scan results. The method performs a max of |max_tries| connectivity scans
+    to find the network.
+
+    Args:
+        ad: An AndroidDevice object.
+        network_ssid: SSID of the network we are looking for.
+        max_tries: Number of scans to try.
+    Returns:
+        True: if network_ssid status is expected in scan results.
+        False: if network_ssid status is expected in scan results.
+    """
+    for num_tries in range(max_tries):
+        scanned_results = ad.wifi.wifiScanAndGetResults()
+        ad.wifi.wifiSetScanThrottleDisable()
+        scanned_ssids = sorted(
+            [scan_result['SSID'] for scan_result in scanned_results]
+            )
+        if network_ssid in scanned_ssids:
+            return True
+        else:
+            if (num_tries + 1) == max_tries:
+                break
+            time.sleep(_WIFI_SCAN_INTERVAL_SEC)
+            continue
+    return False
+
+def start_wifi_connection_scan_and_ensure_network_found(
+    ad, network_ssid, max_tries=3):
+    """
+    Start connectivity scans & ensure the |network_ssid| is seen in
+    scan results. The method performs a max of |max_tries| connectivity scans
+    to find the network.
+    This method asserts on failure!
+
+    Args:
+        ad: An AndroidDevice object.
+        network_ssid: SSID of the network we are looking for.
+        max_tries: Number of scans to try.
+    """
+    logging.info("Starting scans to ensure %s is present", network_ssid)
+    assert_msg = "Failed to find " + network_ssid + " in scan results" \
+        " after " + str(max_tries) + " tries"
+    asserts.assert_true(
+        start_wifi_connection_scan_and_check_for_network(
+      ad, network_ssid, max_tries), assert_msg)
+
+def create_softap_config():
+    """Create a softap config with random ssid and password."""
+    ap_ssid = "softap_" + utils.rand_ascii_str(8)
+    ap_password = utils.rand_ascii_str(8)
+    logging.info("softap setup: %s %s", ap_ssid, ap_password)
+    config = {
+        constants.WiFiTethering.SSID_KEY: ap_ssid,
+        constants.WiFiTethering.PWD_KEY: ap_password,
+    }
+    return config
+
+def start_wifi_tethering(ad: android_device.AndroidDevice,
+                         ssid: str,
+                         password: str,
+                         band: str=None,
+                         hidden:  bool = False,
+                         security: str =None,
+                         cIsolatEnabled:  bool = False):
+    """Starts wifi tethering on an android_device.
+
+    Args:
+        ad: android_device to start wifi tethering on.
+        ssid: The SSID the soft AP should broadcast.
+        password: The password the soft AP should use.
+        band: The band the soft AP should be set on. It should be either
+            WifiEnums.WIFI_CONFIG_APBAND_2G or WifiEnums.WIFI_CONFIG_APBAND_5G.
+        hidden: boolean to indicate if the AP needs to be hidden or not.
+        security: security type of softap.
+
+    Returns:
+        No return value.
+        Error checks in this function will raise test failure signals
+    """
+    config = {constants.WiFiTethering.SSID_KEY: ssid}
+    if password:
+        config[constants.WiFiTethering.PWD_KEY] = password
+    if band:
+        config[constants.WiFiTethering.AP_BAND_KEY] = band
+    if hidden:
+        config[constants.WiFiTethering.HIDDEN_KEY] = hidden
+    if security:
+        config[constants.WiFiTethering.SECURITY] = security
+    if cIsolatEnabled:
+        config[constants.WiFiTethering.AP_CLIENT_ISOLATION_ENABLE] = cIsolatEnabled
+
+    asserts.assert_true(ad.wifi.wifiSetWifiApConfiguration(config),
+                        "Failed to update WifiAp Configuration")
+    handler_state = ad.wifi.tetheringStartTrackingTetherStateChange()
+    handler_tethering = ad.wifi.tetheringStartTetheringWithProvisioning(0, False)
+    time.sleep(_WIFI_SCAN_INTERVAL_SEC)
+    try:
+        result_receiver = handler_state.waitAndGet('TetherStateChangedReceiver')
+        callback_name = result_receiver.data["callbackName"]
+        ad.log.info('StateChanged callback_name: %s', callback_name)
+        logging.info("result_receiver %s", result_receiver)
+        ad.log.debug("Tethering started successfully.")
+    except Exception:
+        msg = "Failed to receive confirmation of wifi tethering starting"
+        asserts.fail(msg)
+    finally:
+      ad.wifi.tetheringStopTrackingTetherStateChange()
+
+
+def start_wifi_connection_scan_and_ensure_network_not_found(
+    ad, network_ssid, max_tries=2):
+    """
+    Start connectivity scans & ensure the |network_ssid| is not seen in
+    scan results. The method performs a max of |max_tries| connectivity scans
+    to find the network.
+    This method asserts on failure!
+
+    Args:
+        ad: An AndroidDevice object.
+        network_ssid: SSID of the network we are looking for.
+        max_tries: Number of scans to try.
+    """
+    ad.log.info("Starting scans to ensure %s is not present", network_ssid)
+    assert_msg = "Found " + network_ssid + " in scan results" \
+        " after " + str(max_tries) + " tries"
+
+    asserts.assert_false(
+        start_wifi_connection_scan_and_check_for_network(
+            ad, network_ssid, max_tries), assert_msg)
+
+def wait_for_wifi_state(ad, state):
+    """Toggles the state of wifi.
+
+    TestFailure signals are raised when something goes wrong.
+
+    Args:
+        ad: An AndroidDevice object.
+        state: Wifi state to wait for.
+    """
+    if state == ad.wifi.wifiCheckState():
+        # Check if the state is already achieved, so we don't wait for the
+        # state change event by mistake.
+        return
+    state_handler = ad.wifi.wifiStartTrackForStateChange()
+    fail_msg = "Device did not transition to Wi-Fi state to %s on %s." % (
+        state, ad.serial)
+    try:
+        state_handler.waitAndGet(event_name="WifiNetworkConnected",
+                                 timeout=10)
+    except Empty:
+        asserts.assert_equal(state, ad.wifi.wifiCheckState(), fail_msg)
+    finally:
+        ad.wifi.wifiStopTrackForStateChange()
+
+
+def adb_shell_ping(ad, count=4, dest_ip="www.google.com"):
+    """
+    Executes a ping command via adb shell and determines its success.
+
+    Args:
+        ad: The AndroidDevice object (Mobly's ad instance).
+        count: The number of ping packets to send. Default is 4.
+        dest_ip: The IP address or hostname to ping.
+
+    Returns:
+        True if the ping was successful (0% packet loss), False otherwise.
+    Raises:
+        AssertionError: If ad.adb.shell returns an empty result, which indicates a critical issue.
+    """
+    ping_cmd = f"ping -c {count} {dest_ip}"
+    results = "" # Initialize results outside the try block
+
+    for attempt in range(2): # Allow for one retry
+        try:
+            ad.log.info(f"Attempt {attempt + 1}: Pinging {dest_ip} from {ad.serial} with command: '{ping_cmd}'")
+            results = ad.adb.shell(ping_cmd)
+            ad.log.info(f"Ping results (Attempt {attempt + 1}): {results}")
+
+            if not results:
+                # If adb.shell returns empty, it's usually a serious issue.
+                # It might not even raise AdbError in some edge cases.
+                ad.log.error("adb.shell returned empty ping results.")
+                # This should probably be an immediate failure rather than trying to parse
+                asserts.fail("ping empty results - seems like a critical failure")
+                return False # Or raise a more specific exception if needed
+
+            # Check for success indicators in the ping output
+            # Common success indicators: "0% packet loss", "received, 0% packet loss"
+            if "0% packet loss".encode('utf-8') in results or "received, 0% packet loss".encode('utf-8') in results:
+                ad.log.info(f"Ping to {dest_ip} succeeded.")
+                return True
+            else:
+                # Ping command ran, but indicated packet loss or other issues.
+                ad.log.warning(f"Ping to {dest_ip} failed with packet loss or other errors. Output: {results}")
+                # If this is the last attempt, return False
+                if attempt == 1: # This means it failed on the second attempt too
+                    return False
+                # If not the last attempt, fall through to retry
+                time.sleep(1) # Wait before retrying
+
+        except adb.AdbError as e:
+            ad.log.error(f"Attempt {attempt + 1}: AdbError during ping to {dest_ip}: {e}")
+            # If this is the last attempt, return False
+            if attempt == 1:
+                return False
+            # If not the last attempt, sleep and then retry
+            time.sleep(1)
+
+    # If the loop finishes without returning True (meaning both attempts failed)
+    ad.log.error(f"Ping to {dest_ip} failed after {2} attempts.")
+    return False
+
+def verify_11ax_softap(dut, dut_client, wifi6_supported_models):
+    """Verify 11ax SoftAp if devices support it.
+
+    Check if both DUT and DUT client supports 11ax, then SoftAp turns on
+    with 11ax mode and DUT client can connect to it.
+
+    Args:
+      dut: Softap device.
+      dut_client: Client connecting to softap.
+      wifi6_supported_models: List of device models supporting 11ax.
+    """
+    if dut.model in wifi6_supported_models and dut_client.model in wifi6_supported_models:
+        logging.info(
+            "Verifying 11ax softap. DUT model: %s, DUT Client model: %s",
+            dut.model, dut_client.model)
+        asserts.assert_true(
+            dut_client.wifi.wifiGetConnectionStandard() ==
+            constants.WIFI_STANDARD_11AX,
+            "DUT failed to start SoftAp in 11ax.")
+
+
+def reset_wifi(ad: android_device.AndroidDevice):
+    """Clears all saved Wi-Fi networks on a device.
+
+    This will turn Wi-Fi on.
+
+    Args:
+        ad: An AndroidDevice object.
+    """
+    networks = ad.wifi.wifiGetConfiguredNetworks()
+    ad.log.info('Configured Networks = %s', networks)
+    if not networks:
+        return
+    removed = []
+    for net in networks:
+        if net['networkId'] not in removed:
+           ad.wifi.wifiForgetNetwork(net['networkId'])
+           removed.append(net['networkId'])
+        else:
+           continue
+    # Check again to see if there's any network left.
+    asserts.assert_true(
+        not ad.wifi.wifiGetConfiguredNetworks(),
+        "Failed to remove these Wi-Fi network Lists: %s" % networks)
+
+def _wifi_connect(ad: android_device.AndroidDevice,
+                  network: dict,
+                  num_of_tries=1,
+                  check_connectivity=True):
+
+    """Connect an Android device to a wifi network.
+
+    Initiate connection to a wifi network, wait for the "connected" event, then
+    confirm the connected ssid is the one requested.
+
+    This will directly fail a test if anything goes wrong.
+
+    Args:
+        ad: android_device object to initiate connection on.
+        network: A dictionary representing the network to connect to. The
+                 dictionary must have the key "SSID".
+        num_of_tries: An integer that is the number of times to try before
+                      delaring failure. Default is 1.
+    """
+    asserts.assert_true(
+      constants.WiFiTethering.SSID_KEY in network,
+      "Key '%s' must be present in network definition." % constants.WiFiTethering.SSID_KEY)
+    state_handler = ad.wifi.wifiStartTrackForStateChange()
+    expected_ssid = network[constants.WiFiTethering.SSID_KEY]
+    ad.log.info("Starting connection process to %s", expected_ssid)
+    ad.wifi.wifiConnecting(network)
+    try:
+      results = state_handler.waitAndGet(event_name="WifiNetworkConnected",
+                                         timeout=10)
+      ad.log.info("Connected to Wi-Fi network %s.",
+                  results.data[constants.WiFiTethering.SSID_KEY])
+      asserts.assert_equal(
+        expected_ssid,
+        results.data[constants.WiFiTethering.SSID_KEY],
+        f'{ad} Need to connect to expected ssid {expected_ssid}.',
+        )
+      results = state_handler.waitAndGet(event_name="WifiStateChanged",
+                                         timeout=10)
+      ad.log.info("Wifi state = %s", results.data['enabled'])
+      asserts.assert_true(results.data['enabled'] , "Wifi State is not correct.")
+    except Exception as error:
+      ad.log.error("Failed to connect to %s with error %s", expected_ssid,
+                     error)
+    finally:
+      ad.wifi.wifiStopTrackForStateChange()
+
+def _stop_tethering(ad: android_device.AndroidDevice) -> bool:
+    """Stops any ongoing tethering sessions on the android device.
+
+    Args:
+      ad: The Android device object.
+
+    Returns:
+      True if tethering is disabled successfully, False otherwise.
+    """
+    if not ad.wifi.wifiIsApEnabled():
+      return True
+    ad.wifi.tetheringStopTethering()
+    return ad.wifi.wifiWaitForTetheringDisabled()
+
+def start_wifi_tethering_saved_config(ad: android_device.AndroidDevice):
+    """ Turn on wifi hotspot with a config that is already saved """
+    handler_state = ad.wifi.tetheringStartTrackingTetherStateChange()
+    handler_tethering = ad.wifi.tetheringStartTetheringWithProvisioning(0, False)
+    time.sleep(_WIFI_SCAN_INTERVAL_SEC)
+    try:
+        result_receiver = handler_state.waitAndGet('TetherStateChangedReceiver')
+        callback_name = result_receiver.data["callbackName"]
+        ad.log.info('StateChanged callback_name: %s', callback_name)
+        ad.log.debug("Tethering started successfully.")
+    except Exception:
+        msg = "Failed to receive confirmation of wifi tethering starting"
+        asserts.fail(msg)
+    finally:
+      ad.wifi.tetheringStopTrackingTetherStateChange()
+
+def connect_to_wifi_network(ad, network, assert_on_fail=True,
+                            check_connectivity=True, hidden=False,
+                            num_of_scan_tries=3,
+                            num_of_connect_tries=3):
+    """Connection logic for open and psk wifi networks.
+        Args:
+            ad: AndroidDevice to use for connection
+            network: network info of the network to connect to
+            assert_on_fail: If true, errors from wifi_connect will raise
+                            test failure signals.
+            hidden: Is the Wifi network hidden.
+            num_of_scan_tries: The number of times to try scan
+                           interface before declaring failure.
+            num_of_connect_tries: The number of times to try
+                              connect wifi before declaring failure.
+    """
+    if hidden:
+        start_wifi_connection_scan_and_ensure_network_not_found(
+            ad,
+            network[constants.WiFiTethering.SSID_KEY],
+            max_tries=num_of_scan_tries)
+    else:
+        start_wifi_connection_scan_and_ensure_network_found(
+            ad,
+            network[constants.WiFiTethering.SSID_KEY],
+            max_tries=num_of_scan_tries)
+    config = {
+      "SSID": network[constants.WiFiTethering.SSID_KEY],
+      "password": network[constants.WiFiTethering.PWD_KEY],
+      }
+    if hidden:
+        config[constants.WiFiTethering.HIDDEN_KEY] = True
+        ret = ad.wifi.wifiAddNetwork(config)
+        asserts.assert_true(ret != -1, "Add network %r failed" % config)
+        ad.wifi.wifiEnableNetwork(ret, 0)
+
+    _wifi_connect(ad, config, check_connectivity=check_connectivity)
\ No newline at end of file
diff --git a/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_test.py b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_test.py
new file mode 100644
index 0000000000..88fac2c268
--- /dev/null
+++ b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_test.py
@@ -0,0 +1,1319 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+# Lint as: python3
+import logging
+import time
+
+
+from android.platform.test.annotations import ApiTest
+from mobly import asserts
+from mobly import base_test
+from mobly import test_runner
+from mobly import utils
+from mobly.controllers import android_device
+from mobly.controllers.android_device_lib import callback_handler_v2
+from aware import aware_lib_utils as autils
+from softap import constants
+import wifi_test_utils
+from mobly.controllers.android_device_lib import adb
+from softap.integration import wifi_sap_lib_utils as sutils
+
+
+DBS_SUPPORTED_MODELS =  ["komodo"]
+STA_CONCURRENCY_SUPPORTED_MODELS  =["komodo", "caiman"]
+WIFI6_MODELS =  ["komodo"]
+
+WAIT_REBOOT_SEC = 20
+
+class WifiSoftApTest(base_test.BaseTestClass):
+  """SoftAp test class.
+
+  Attributes:
+    host: Android device providing Wi-Fi hotspot
+    client: Android device connecting to host provided hotspot
+  """
+
+  def setup_class(self) -> None:
+    self.ads = self.register_controller(android_device, min_number=2)
+    self.host = self.ads[0]
+    self.client = self.ads[1]
+
+
+    utils.concurrent_exec(
+        self._setup_device,
+        param_list=[[ad] for ad in self.ads],
+        raise_on_exception=True,
+    )
+
+    asserts.abort_class_if(
+        not self.host.wifi.wifiIsPortableHotspotSupported(),
+        'Hotspot is not supported on host, abort remaining tests.',
+    )
+
+  def _setup_device(self, ad: android_device.AndroidDevice) -> None:
+    ad.load_snippet('wifi', 'com.google.snippet.wifi')
+    sutils._stop_tethering(ad)
+    wifi_test_utils.enable_wifi_verbose_logging(ad)
+    wifi_test_utils.set_screen_on_and_unlock(ad)
+
+    self.AP_IFACE = 'wlan0'
+    if ad.model in DBS_SUPPORTED_MODELS:
+      self.AP_IFACE = 'wlan1'
+    if ad.model in STA_CONCURRENCY_SUPPORTED_MODELS:
+      self.AP_IFACE = 'wlan2'
+
+  def setup_test(self):
+    for ad in self.ads:
+      if not ad.wifi.wifiIsEnabled():
+        ad.wifi.wifiEnable()
+      sutils._stop_tethering(self.host)
+
+  def on_fail(self, record):
+    logging.info('Collecting bugreports...')
+    android_device.take_bug_reports(
+      ads=[self.host, self.client],
+      test_name=record.test_name,
+      begin_time=record.begin_time,
+      destination=self.current_test_info.output_path
+        )
+
+  def teardown_test(self):
+    for ad in self.ads:
+      sutils._stop_tethering(self.host)
+      ad.wifi.wifiClearConfiguredNetworks()
+      ad.wifi.wifiDisableAllSavedNetworks()
+      ad.wifi.wifiEnable()
+      if ad.is_adb_root:
+        autils.set_airplane_mode(self.host, False)
+
+  def teardown_class(self):
+    for ad in self.ads:
+      ad.wifi.wifiDisableAllSavedNetworks()
+      ad.wifi.wifiClearConfiguredNetworks()
+      ad.wifi.wifiEnable()
+      ad.wifi.wifiFactoryReset()
+
+
+  def confirm_softap_in_scan_results(self, ap_ssid):
+    """Confirm the ap started by wifi tethering is seen in scan results.
+
+        Args:
+            ap_ssid: SSID of the ap we are looking for.
+    """
+    sutils.start_wifi_connection_scan_and_check_for_network(
+      self.client, ap_ssid)
+
+  def validate_ping_between_softap_and_client(self, config):
+    """Test ping between softap and its client.
+
+        Connect one android device to the wifi hotspot.
+        Verify they can ping each other.
+
+        Args:
+            config: wifi network config with SSID, password
+    """
+    config = {
+      "SSID": config[constants.WiFiTethering.SSID_KEY],
+      "password": config[constants.WiFiTethering.PWD_KEY],
+      }
+    sutils._wifi_connect(self.client, config, check_connectivity=False)
+    host_ip = self.host.wifi.connectivityGetIPv4Addresses(self.AP_IFACE)[0]
+    client_ip = self.client.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    sutils.verify_11ax_softap(self.host, self.client, WIFI6_MODELS)
+    self.client.log.info("Try to ping %s" % host_ip)
+    asserts.assert_true(
+      sutils.adb_shell_ping(self.client, count=10, dest_ip=host_ip),
+      "%s ping %s failed" % (self.client.serial, host_ip))
+    self.host.log.info("Try to ping %s" % client_ip)
+    asserts.assert_true(
+      sutils.adb_shell_ping(self.host, count=10, dest_ip=client_ip),
+      "%s ping %s failed" % (self.host.serial, client_ip))
+
+  def validate_full_tether_startup(self,
+                                  band=None,
+                                  hidden=False,
+                                  test_ping=False,
+                                  security=None):
+
+    """Test full startup of wifi tethering.
+
+        This test case performs the following steps:
+        1. Reports the current WiFi state of the host device.
+        2. Attempts to switch the host device to WiFi Access Point (AP) mode,
+          configuring the SoftAP with provided or default settings.
+        3. Verifies that the SoftAP is successfully activated on the host device.
+        4. Shuts down the WiFi tethering (disables SoftAP) on the host device.
+        5. Verifies that the WiFi state on the host device has returned to its
+          previous state before tethering was enabled.
+
+        Args:
+            band (str, optional):
+              The Wi-Fi band to use for tethering (e.g., "2.4GHz",
+              "5GHz"). Defaults to None,which might use a default
+              or let the system decide.
+            hidden (bool, optional):
+              A boolean indicating whether the SoftAP network
+              should be hidden (not broadcast its SSID). Defaults to False.
+            test_ping (bool, optional):
+              A boolean indicating whether to perform a ping test between
+                the SoftAP host and a connected client. Requires a client
+                device to be associated with `self.client`. Defaults to False.
+            security (str, optional):
+              The security protocol to use for the SoftAP (e.g., "WPA2_PSK").
+                Defaults to None, which might use a default or open network.
+    """
+
+    initial_wifi_state = self.host.wifi.wifiCheckState()
+    #Skip for sim state check
+    self.host.log.info("current state: %s", initial_wifi_state)
+    config = sutils.create_softap_config()
+    sutils.start_wifi_tethering(self.host,
+                                config[constants.WiFiTethering.SSID_KEY],
+                                config[constants.WiFiTethering.PWD_KEY],
+                                band,
+                                hidden,
+                                security)
+    if hidden:
+      # First ensure it's not seen in scan results.
+      # If the network is hidden, it should be saved on the client to be
+      # seen in scan results.
+      sutils.start_wifi_connection_scan_and_ensure_network_not_found(
+        self.client, config[constants.WiFiTethering.SSID_KEY])
+      config[constants.WiFiTethering.HIDDEN_KEY] = True
+      ret = self.client.wifi.wifiAddNetwork(config)
+      asserts.assert_true(ret != -1, "Add network %r failed" % config)
+      self.client.wifi.wifiEnableNetwork(ret, 0)
+    self.confirm_softap_in_scan_results(config[constants.WiFiTethering.SSID_KEY])
+    if test_ping:
+      self.validate_ping_between_softap_and_client(config)
+    sutils._stop_tethering(self.host)
+    asserts.assert_false(self.host.wifi.wifiIsApEnabled(),
+                        "SoftAp is still reported as running")
+    if initial_wifi_state:
+      sutils.wait_for_wifi_state(self.host, True)
+    elif self.host.wifi.wifiCheckState():
+      asserts.fail("Wifi was disabled before softap and now it is enabled")
+
+  def validate_softap_after_reboot(self, band, security, hidden=False):
+    config = sutils.create_softap_config()
+    softap_config = config.copy()
+    softap_config[constants.WiFiTethering.AP_BAND_KEY] = band
+    softap_config[constants.WiFiTethering.SECURITY] = security
+    if hidden:
+      softap_config[constants.WiFiTethering.HIDDEN_KEY] = hidden
+    asserts.assert_true(
+      self.host.wifi.wifiSetWifiApConfiguration(softap_config),
+      "Failed to update WifiAp Configuration")
+    logging.info("StartTracking...")
+    self.host.wifi.tetheringStartTrackingTetherStateChange()
+    time.sleep(WAIT_REBOOT_SEC)
+    logging.info("start reboot...")
+    with self.host.handle_reboot():
+        self.host.reboot()
+        self.host.log.info("DUT rebooted successfully")
+        time.sleep(WAIT_REBOOT_SEC)
+    sutils.start_wifi_tethering_saved_config(self.host)
+    sutils.connect_to_wifi_network(self.client,softap_config, hidden=hidden)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      ]
+  )
+
+  def test_check_wifi_tethering_supported(self):
+    """Test check for wifi tethering support.
+      1. Call method to check if wifi hotspot is supported
+        """
+    hotspot_supported = self.host.wifi.wifiIsPortableHotspotSupported()
+    tethering_supported = self.host.wifi.connectivityIsTetheringSupported()
+    logging.info(
+      "IsPortableHotspotSupported: %s, IsTetheringSupported %s." % (
+        hotspot_supported, tethering_supported))
+    asserts.assert_true(
+      hotspot_supported,
+      "DUT should support wifi tethering but is reporting false.")
+    asserts.assert_true(
+      tethering_supported,
+      "DUT should also support wifi tethering when called from"
+      +" ConnectivityManager")
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup(self):
+
+    """Test full startup of wifi tethering in default band.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup()
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G(self):
+    """Test full startup of wifi tethering in 2G band.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+      5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G(self):
+    """Test full startup of wifi tethering in 5G band.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_auto(self):
+    """Test full startup of wifi tethering in 5G band.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_hidden(self):
+    """Test full startup of wifi tethering in 2G band using hidden AP.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_hidden(self):
+    """Test full startup of wifi tethering in 5G band using hidden AP.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_auto_hidden(self):
+    """Test full startup of wifi tethering in auto-band using hidden AP.
+
+        1. Report current state.
+        2. Switch to AP mode.
+        3. verify SoftAP active.
+        4. Shutdown wifi tethering.
+        5. verify back to previous mode.
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_wpa3(self):
+    """Test full startup of softap in default band and wpa3 security.
+
+        Steps:
+        1. Configure softap in default band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                        "DUT does not support WPA3 softAp")
+
+    self.validate_full_tether_startup(
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_wpa3(self):
+    """Test full startup of softap in 2G band and wpa3 security.
+
+        Steps:
+        1. Configure softap in 2G band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                    "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_wpa3(self):
+    """Test full startup of softap in 5G band and wpa3 security.
+
+        Steps:
+        1. Configure softap in 5G band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                    "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_wpa3(self):
+    """Test full startup of softap in 5G band and wpa3 security.
+
+        Steps:
+        1. Configure softap in 5G band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                    "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_hidden_wpa3(self):
+    """Test full startup of hidden softap in default band and wpa3 security.
+
+        Steps:
+        1. Configure hidden softap in default band and wpa3 security.
+      2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      hidden=True,
+      security=constants.SoftApSecurityType.WPA3_SAE
+      )
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_hidden_wpa3(self):
+    """Test full startup of hidden softap in 2G band and wpa3 security.
+
+        Steps:
+        1. Configure hidden softap in 2G band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      hidden=True,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_hidden_wpa3(self):
+    """Test full startup of hidden softap in 5G band and wpa3 security.
+
+        Steps:
+        1. Configure hidden softap in 5G band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      hidden=True,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_auto_hidden_wpa3(self):
+    """Test full startup of hidden softap in auto band and wpa3 security.
+
+        Steps:
+        1. Configure hidden softap in auto band and wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G,
+      hidden=True,
+      security=constants.SoftApSecurityType.WPA3_SAE)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_wpa2_wpa3(self):
+    """Test full startup of softap in default band and wpa2/wpa3 security.
+
+        Steps:
+        1. Configure softap in default band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+
+    self.validate_full_tether_startup(
+      security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_wpa2_wpa3(self):
+    """Test full startup of softap in 2G band and wpa2/wpa3 security.
+
+        Steps:
+        1. Configure softap in default band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_wpa2_wpa3(self):
+    """Test full startup of softap in 5G band and wpa2/wpa3 security.
+
+        Steps:
+        1. Configure softap in default band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_auto_wpa2_wpa3(self):
+    """Test full startup of softap in auto band and wpa2/wpa3 security.
+
+        Steps:
+        1. Configure softap in default band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G,
+      security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_hidden_wpa2_wpa3(self):
+    """Test full startup of hidden softap in 2G band and wpa2/wpa3.
+
+        Steps:
+        1. Configure hidden softap in 2G band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+       constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+       hidden=True,
+       security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_hidden_wpa2_wpa3(self):
+    """Test full startup of hidden softap in 5G band and wpa2/wpa3.
+
+        Steps:
+        1. Configure hidden softap in 5G band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      hidden=True,
+      security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_auto_hidden_wpa2_wpa3(self):
+    """Test full startup of hidden softap in auto band and wpa2/wpa3.
+
+        Steps:
+        1. Configure hidden softap in auto band and wpa2/wpa3 security.
+        2. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_full_tether_startup(
+       constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G,
+       hidden=True,
+       security=constants.SoftApSecurityType.WPA3_SAE_TRANSITION)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_with_airplane_mode_on(self):
+    """Test full startup of wifi tethering in 2G band with
+        airplane mode on.
+
+        1. Turn on airplane mode.
+        2. Report current state.
+        3. Switch to AP mode.
+        4. verify SoftAP active.
+        5. Shutdown wifi tethering.
+        6. verify back to previous mode.
+        7. Turn off airplane mode.
+    """
+    asserts.skip_if(
+      not self.host.is_adb_root,
+      "APM toggle needs Android device(s) with root permission")
+    self.host.log.debug("Toggling Airplane mode ON.")
+    autils.set_airplane_mode(self.host, True)
+    asserts.assert_true(autils._get_airplane_mode(self.host),
+                        "Can not turn on airplane mode: %s" % self.host.serial)
+    if not self.host.wifi.wifiIsEnabled():
+      self.host.wifi.wifiEnable()
+    self.validate_full_tether_startup(
+      band=constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_2G_one_client_ping_softap(self):
+    """Device can connect to 2G hotspot and ping test.
+
+        Steps:
+        1. Turn on DUT's 2G softap
+        2. Client connects to the softap
+        3. Client and DUT ping each other
+    """
+    self.validate_full_tether_startup(
+      band=constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      test_ping=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_full_tether_startup_5G_one_client_ping_softap(self):
+    """Device can connect to 5G hotspot and ping test.
+
+        Steps:
+        1. Turn on DUT's 5G softap
+        2. Client connects to the softap
+        3. Client and DUT ping each other
+    """
+    self.validate_full_tether_startup(
+      band=constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      test_ping=True)
+
+  def test_softap_wpa3_2g_after_reboot(self):
+
+    """Test full startup of softap in 2G band, wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 2G band and wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      constants.SoftApSecurityType.WPA3_SAE,
+      False)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa3_5g_after_reboot(self):
+    """Test full startup of softap in 5G band, wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 5G band and wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      constants.SoftApSecurityType.WPA3_SAE,
+      False)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa2_wpa3_2g_after_reboot(self):
+
+    """Test full startup of softap in 2G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 2G band and wpa2/wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      constants.SoftApSecurityType.WPA3_SAE_TRANSITION,
+      False)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa2_wpa3_5g_after_reboot(self):
+
+    """Test full startup of softap in 2G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 5G band and wpa2/wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      constants.SoftApSecurityType.WPA3_SAE_TRANSITION,
+      False)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa3_2g_hidden_after_reboot(self):
+
+    """Test full startup of softap in 2G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 2G band and wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      constants.SoftApSecurityType.WPA3_SAE,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa3_5g_hidden_after_reboot(self):
+
+    """Test full startup of softap in 5G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 5G band and wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      constants.SoftApSecurityType.WPA3_SAE,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa2_wpa3_2g_hidden_after_reboot(self):
+
+    """Test full startup of softap in 2G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 2G band and wpa2/wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G,
+      constants.SoftApSecurityType.WPA3_SAE_TRANSITION,
+      hidden=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_wpa2_wpa3_5g_hidden_after_reboot(self):
+
+    """Test full startup of softap in 5G band, wpa2/wpa3 security after reboot.
+
+        Steps:
+        1. Save softap in 5G band and wpa2/wpa3 security.
+        2. Reboot device and start softap.
+        3. Verify dut client connects to the softap.
+    """
+    for self.ad in self.ads:
+      asserts.skip_if(self.ad.model not in STA_CONCURRENCY_SUPPORTED_MODELS,
+                      "DUT does not support WPA3 softAp")
+    self.validate_softap_after_reboot(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G,
+      constants.SoftApSecurityType.WPA3_SAE_TRANSITION,
+      hidden=True)
+
+if __name__ == '__main__':
+
+  test_runner.main()
diff --git a/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_three_devices_test.py b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_three_devices_test.py
new file mode 100644
index 0000000000..748d902751
--- /dev/null
+++ b/tests/hostsidetests/multidevices/test/softap/integration/wifi_sap_three_devices_test.py
@@ -0,0 +1,415 @@
+#  Copyright (C) 2024 The Android Open Source Project
+#
+#  Licensed under the Apache License, Version 2.0 (the "License");
+#  you may not use this file except in compliance with the License.
+#  You may obtain a copy of the License at
+#
+#       http://www.apache.org/licenses/LICENSE-2.0
+#
+#  Unless required by applicable law or agreed to in writing, software
+#  distributed under the License is distributed on an "AS IS" BASIS,
+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+#  See the License for the specific language governing permissions and
+#  limitations under the License.
+
+# Lint as: python3
+import logging
+
+
+from android.platform.test.annotations import ApiTest
+from mobly import asserts
+from mobly import base_test
+from mobly import test_runner
+from mobly import utils
+from mobly.controllers import android_device
+from mobly.controllers.android_device_lib import callback_handler_v2
+from aware import aware_lib_utils as autils
+from softap import constants
+import wifi_test_utils
+from mobly.controllers.android_device_lib import adb
+from softap.integration import wifi_sap_lib_utils as sutils
+
+
+DBS_SUPPORTED_MODELS =  ["komodo"]
+STA_CONCURRENCY_SUPPORTED_MODELS  =["komodo", "caiman"]
+WIFI6_MODELS =  ["komodo"]
+
+class WifiSoftApThreeDevicesTest(base_test.BaseTestClass):
+  """SoftAp with multi-devices test class.
+
+  Attributes:
+    host: Android device providing Wi-Fi hotspot
+    client: Android device connecting to host provided hotspot
+  """
+
+  def setup_class(self) -> None:
+    self.ads = self.register_controller(android_device, min_number=3)
+    self.host = self.ads[0]
+    self.client = self.ads[1]
+
+
+    utils.concurrent_exec(
+        self._setup_device,
+        param_list=[[ad] for ad in self.ads],
+        raise_on_exception=True,
+    )
+
+    asserts.abort_class_if(
+        not self.host.wifi.wifiIsPortableHotspotSupported(),
+        'Hotspot is not supported on host, abort remaining tests.',
+    )
+
+  def _setup_device(self, ad: android_device.AndroidDevice) -> None:
+    ad.load_snippet('wifi', 'com.google.snippet.wifi')
+    sutils._stop_tethering(ad)
+    wifi_test_utils.enable_wifi_verbose_logging(ad)
+    wifi_test_utils.set_screen_on_and_unlock(ad)
+
+    self.AP_IFACE = 'wlan0'
+    if ad.model in DBS_SUPPORTED_MODELS:
+      self.AP_IFACE = 'wlan1'
+    if ad.model in STA_CONCURRENCY_SUPPORTED_MODELS:
+      self.AP_IFACE = 'wlan2'
+
+  def setup_test(self):
+    for ad in self.ads:
+      if not ad.wifi.wifiIsEnabled():
+        ad.wifi.wifiEnable()
+      sutils._stop_tethering(self.host)
+
+  def on_fail(self, record):
+    logging.info('Collecting bugreports...')
+    android_device.take_bug_reports(
+      ads=[self.host, self.client],
+      test_name=record.test_name,
+      begin_time=record.begin_time,
+      destination=self.current_test_info.output_path
+        )
+
+  def teardown_test(self):
+    for ad in self.ads:
+      sutils._stop_tethering(self.host)
+      ad.wifi.wifiClearConfiguredNetworks()
+      ad.wifi.wifiDisableAllSavedNetworks()
+      ad.wifi.wifiEnable()
+      if ad.is_adb_root:
+        autils.set_airplane_mode(self.host, False)
+
+  def teardown_class(self):
+    for ad in self.ads:
+      ad.wifi.wifiDisableAllSavedNetworks()
+      ad.wifi.wifiClearConfiguredNetworks()
+      ad.wifi.wifiEnable()
+      ad.wifi.wifiFactoryReset()
+
+
+  def confirm_softap_in_scan_results(self, ap_ssid):
+    """Confirm the ap started by wifi tethering is seen in scan results.
+
+        Args:
+            ap_ssid: SSID of the ap we are looking for.
+    """
+    sutils.start_wifi_connection_scan_and_check_for_network(
+      self.client, ap_ssid)
+
+  def validate_ping_between_softap_and_client(self, config):
+    """Test ping between softap and its client.
+
+        Connect one android device to the wifi hotspot.
+        Verify they can ping each other.
+
+        Args:
+            config: wifi network config with SSID, password
+    """
+    config = {
+      "SSID": config[constants.WiFiTethering.SSID_KEY],
+      "password": config[constants.WiFiTethering.PWD_KEY],
+      }
+    sutils._wifi_connect(self.client, config, check_connectivity=False)
+    host_ip = self.host.wifi.connectivityGetIPv4Addresses(self.AP_IFACE)[0]
+    client_ip = self.client.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    sutils.verify_11ax_softap(self.host, self.client, WIFI6_MODELS)
+    self.client.log.info("Try to ping %s" % host_ip)
+    asserts.assert_true(
+      sutils.adb_shell_ping(self.client, count=10, dest_ip=host_ip),
+      "%s ping %s failed" % (self.client.serial, host_ip))
+    self.host.log.info("Try to ping %s" % client_ip)
+    asserts.assert_true(
+      sutils.adb_shell_ping(self.host, count=10, dest_ip=client_ip),
+      "%s ping %s failed" % (self.host.serial, client_ip))
+
+  def validate_full_tether_startup(self, band=None, hidden=False,
+                                     test_ping=False, test_clients=None,
+                                     security=None,
+                                     cIsolatEnabled=False):
+
+    """Test full startup of wifi tethering.
+
+        This test case performs the following steps:
+        1. Reports the current WiFi state of the host device.
+        2. Attempts to switch the host device to WiFi Access Point (AP) mode,
+          configuring the SoftAP with provided or default settings.
+        3. Verifies that the SoftAP is successfully activated on the host device.
+        4. Shuts down the WiFi tethering (disables SoftAP) on the host device.
+        5. Verifies that the WiFi state on the host device has returned to its
+          previous state before tethering was enabled.
+
+        Args:
+            band (str, optional):
+              The Wi-Fi band to use for tethering (e.g., "2.4GHz",
+              "5GHz"). Defaults to None,which might use a default
+              or let the system decide.
+            hidden (bool, optional):
+              A boolean indicating whether the SoftAP network
+              should be hidden (not broadcast its SSID). Defaults to False.
+            test_ping (bool, optional):
+              A boolean indicating whether to perform a ping test between
+                the SoftAP host and a connected client. Requires a client
+                device to be associated with `self.client`. Defaults to False.
+            test_clients (bool, optional):
+              A boolean indicating whether to perform a ping test between
+                two connected client devices. Requires at least
+                two client devices to be associated with `self.ads
+                (excluding the host). Defaults to None.
+            security (str, optional):
+              The security protocol to use for the SoftAP (e.g., "WPA2_PSK").
+                Defaults to None, which might use a default or open network.
+            cIsolatEnabled(bool, optional):
+              A boolean indicating whether the SoftAP network of
+                clientIsolationEnabled setting. Defaults to False.
+    """
+
+    initial_wifi_state = self.host.wifi.wifiCheckState()
+    self.host.log.info("current state: %s", initial_wifi_state)
+    config = sutils.create_softap_config()
+    sutils.start_wifi_tethering(self.host,
+                                config[constants.WiFiTethering.SSID_KEY],
+                                config[constants.WiFiTethering.PWD_KEY],
+                                band,
+                                hidden,
+                                security,
+                                cIsolatEnabled)
+    if hidden:
+      # First ensure it's not seen in scan results.
+      # If the network is hidden, it should be saved on the client to be
+      # seen in scan results.
+      sutils.start_wifi_connection_scan_and_ensure_network_not_found(
+        self.client, config[constants.WiFiTethering.SSID_KEY])
+      config[constants.WiFiTethering.HIDDEN_KEY] = True
+      ret = self.client.wifi.wifiAddNetwork(config)
+      asserts.assert_true(ret != -1, "Add network %r failed" % config)
+      self.client.wifi.wifiEnableNetwork(ret, 0)
+    self.confirm_softap_in_scan_results(config[constants.WiFiTethering.SSID_KEY])
+    if test_ping:
+      self.validate_ping_between_softap_and_client(config)
+    if test_clients:
+      if len(self.ads) > 2:
+        self.validate_ping_between_two_clients(config)
+    if cIsolatEnabled:
+      if len(self.ads) > 2:
+        self.validate_isolation_between_two_clients(config)
+    sutils._stop_tethering(self.host)
+    asserts.assert_false(self.host.wifi.wifiIsApEnabled(),
+                         "SoftAp is still reported as running")
+    if initial_wifi_state:
+      sutils.wait_for_wifi_state(self.host, True)
+    elif self.host.wifi.wifiCheckState():
+      asserts.fail("Wifi was disabled before softap and now it is enabled")
+
+  def validate_ping_between_two_clients(self, config):
+    """Test ping between softap's clients.
+
+        Connect two android device to the wifi hotspot.
+        Verify the clients can ping each other.
+
+        Args:
+            config: wifi network config with SSID, password
+    """
+    ad1 = self.client
+    ad2 = self.ads[2]
+    sutils._wifi_connect(ad1, config, check_connectivity=False)
+    sutils._wifi_connect(ad2, config, check_connectivity=False)
+    ad1_ip = ad1.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    ad2_ip = ad2.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    ad1.log.info("Try to ping test from %s to %s" % (ad1.serial,ad2_ip))
+    asserts.assert_true(
+      sutils.adb_shell_ping(ad1, count=10, dest_ip=ad2_ip),
+      "%s ping %s failed" % (ad1.serial, ad2_ip))
+    ad2.log.info("Try to ping test from %s to %s" % (ad2.serial,ad1_ip))
+    asserts.assert_true(
+      sutils.adb_shell_ping(ad2, count=10, dest_ip=ad1_ip),
+      "%s ping %s failed" % (ad2.serial, ad1_ip))
+
+  def validate_isolation_between_two_clients(self, config):
+    """Test ping between softap's clients, expecting them NOT to ping each other.
+    Connect two Android devices to the Wi-Fi hotspot.
+    Verify the clients CANNOT ping each other (due to isolation).
+
+    Args:
+      config: Wi-Fi network config with SSID, password
+    """
+    ad1 = self.client
+    ad2 = self.ads[2]
+    sutils._wifi_connect(ad1, config, check_connectivity=False)
+    sutils._wifi_connect(ad2, config, check_connectivity=False)
+    ad1_ip = ad1.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    ad2_ip = ad2.wifi.connectivityGetIPv4Addresses('wlan0')[0]
+    ad1.log.info("Try to ping test from %s to %s" % (ad1.serial,ad2_ip))
+    asserts.assert_false(
+      sutils.adb_shell_ping(ad1, count=10, dest_ip=ad2_ip),
+      "%s ping %s successfully, isolation setting failed" % (ad1.serial, ad2_ip))
+    ad2.log.info("Try to ping test from %s to %s" % (ad2.serial,ad1_ip))
+    asserts.assert_false(
+      sutils.adb_shell_ping(ad2, count=10, dest_ip=ad1_ip),
+      "%s ping %s successfully, isolation setting failed" % (ad2.serial, ad1_ip))
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_2G_two_clients_ping_each_other(self):
+
+    """Test for 2G hotspot with 2 clients
+
+        1. Turn on 2G hotspot
+        2. Two clients connect to the hotspot
+        3. Two clients ping each other
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G, test_clients=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration(SoftApConfiguration.Builder())',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_5G_two_clients_ping_each_other(self):
+    """Test for 5G hotspot with 2 clients
+
+        1. Turn on 5G hotspot
+        2. Two clients connect to the hotspot
+        3. Two clients can't ping each other
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G, test_clients=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration('+
+      'SoftApConfiguration.Builder()#setClientIsolationEnabled(true)',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_2G_two_clients_isolation_each_other(self):
+
+    """Test for 2G hotspot with 2 clients
+
+        1. Turn on 2G hotspot
+        2. Two clients connect to the hotspot
+        3. Two clients can't ping each other
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G, cIsolatEnabled=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration('+
+      'SoftApConfiguration.Builder()#setClientIsolationEnabled(true)',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_5G_two_clients_isolation_each_other(self):
+
+    """Test for 2G hotspot with 2 clients
+
+        1. Turn on 2G hotspot
+        2. Two clients connect to the hotspot
+        3. Two clients can't ping each other
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_5G, cIsolatEnabled=True)
+
+  @ApiTest(
+    apis=[
+      'android.net.wifi.WifiManager#isPortableHotspotSupported()',
+      'android.net.ConnectivityManage#isTetheringSupported()',
+      'android.net.wifi.WifiManager.getWifiState()',
+      'android.net.wifi.WifiManager.setSoftApConfiguration('+
+      'SoftApConfiguration.Builder()#setClientIsolationEnabled(true)',
+      'android.net.TetheringManage.startTethering(int type,'+
+      ' @NonNull final Executor executor,final StartTetheringCallback callback)',
+      'android.net.wifi.WifiManager.SCAN_RESULTS_AVAILABLE_ACTION',
+      'android.net.wifi.WifiManager.startScan()',
+      'android.net.wifi.WifiManager.getScanResults()',
+      'android.net.wifi.WifiManager.addNetwork(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.enableNetwork(netId, disableOthers)',
+      'android.net.wifi.WifiManager.connect(android.net.wifi.WifiConfiguration(json))',
+      'android.net.wifi.WifiManager.getConnectionInfo().getWifiStandard()',
+      ]
+  )
+
+  def test_softap_auto_two_clients_isolation_each_other(self):
+
+    """Test for auto-band hotspot with 2 clients
+
+        1. Turn on auto-band hotspot
+        2. Two clients connect to the hotspot
+        3. Two clients ping each other
+    """
+    self.validate_full_tether_startup(
+      constants.WiFiHotspotBand.WIFI_CONFIG_SOFTAP_BAND_2G_5G, cIsolatEnabled=True)
+
+if __name__ == '__main__':
+  test_runner.main()
+
diff --git a/tests/hostsidetests/multidevices/test/wifi_test_utils.py b/tests/hostsidetests/multidevices/test/wifi_test_utils.py
index 1dd17c0836..ca2f9a417f 100644
--- a/tests/hostsidetests/multidevices/test/wifi_test_utils.py
+++ b/tests/hostsidetests/multidevices/test/wifi_test_utils.py
@@ -11,6 +11,8 @@
 #  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 #  See the License for the specific language governing permissions and
 #  limitations under the License.
+import logging
+import time
 
 from mobly.controllers import android_device
 
@@ -21,11 +23,24 @@ def set_screen_on_and_unlock(ad: android_device.AndroidDevice):
     Args:
         ad: AndroidDevice instance.
     """
-    ad.adb.shell("svc power stayon true")
     ad.adb.shell("input keyevent KEYCODE_WAKEUP")
     ad.adb.shell("wm dismiss-keyguard")
-
+    ad.adb.shell("svc power stayon true")
 
 def enable_wifi_verbose_logging(ad: android_device.AndroidDevice):
     """Sets the Wi-Fi verbose logging developer option to Enable."""
     ad.adb.shell('cmd wifi set-verbose-logging enabled')
+
+def take_bug_reports(ads, test_name=None, begin_time=None, destination=None):
+    logging.info('Collecting bugreports...')
+    android_device.take_bug_reports(ads, destination)
+
+def restart_wifi_and_disable_connection_scan(ad: android_device.AndroidDevice):
+    ad.wifi.wifiDisableAllSavedNetworks()
+    ad.wifi.wifiDisable()
+    ad.wifi.wifiEnable()
+    ad.wifi.wifiAllowAutojoinGlobal(False)
+
+def restore_wifi_auto_join(ad: android_device.AndroidDevice):
+    ad.wifi.wifiEnableAllSavedNetworks()
+    ad.wifi.wifiAllowAutojoinGlobal(True)
\ No newline at end of file
```

